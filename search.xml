<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Blog æ­å»º</title>
      <link href="/2024/Tools/HexoNextUsage/"/>
      <url>/2024/Tools/HexoNextUsage/</url>
      
        <content type="html"><![CDATA[<h1 id="å®‰è£…-hexo">å®‰è£… hexo</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br></pre></td></tr></tbody></table></figure><h1 id="å®‰è£…ä¾èµ–">å®‰è£…ä¾èµ–</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ pandoc æ¸²æŸ“å™¨</span></span><br><span class="line">npm un hexo-renderer-marked</span><br><span class="line">npm i hexo-renderer-pandoc</span><br><span class="line"></span><br><span class="line">npm un hexo-renderer-pandoc</span><br><span class="line">npm i hexo-renderer-markdown-it-plus</span><br><span class="line"></span><br><span class="line">npm install hexo-deployer-git</span><br><span class="line">sudo apt-get install pandoc</span><br><span class="line"></span><br><span class="line">npm install prism</span><br><span class="line"></span><br><span class="line"><span class="comment"># rss</span></span><br><span class="line">npm install hexo-generator-feed</span><br></pre></td></tr></tbody></table></figure><p>å¸è½½ hexo é»˜è®¤ markdown æ¸²æŸ“å™¨ï¼Œå®‰è£… pandoc markdown æ¸²æŸ“å™¨ã€‚hexo é»˜è®¤çš„ markdown æ¸²æŸ“å™¨ä¸æ”¯æŒ Mathjaxï¼Œä¸æ”¯æŒæ’ä»¶æ‰©å±•ï¼Œä¸æ”¯æŒ emoji è¡¨æƒ…ã€‚pandoc markdown æ¸²æŸ“å™¨æ”¯æŒ Mathjax è¯­æ³•ï¼Œä¸ä»…å¯ä»¥æ¸²æŸ“ markdownï¼Œè¿˜æ”¯æŒ textileï¼ŒreStructedText å’Œè®¸å¤šå…¶ä»–æ ¼å¼ï¼Œä»ç„¶ä¸æ”¯æŒ emoji è¡¨æƒ…ã€‚</p><p>æ­¤å¤–è¿˜æœ‰å…¶ä»– markdown æ¸²æŸ“å™¨ï¼Œhexo-renderer-markdown-it æ”¯æŒ Mathjax è¯­æ³•ï¼ˆæ”¯æŒä¸å¤ªå¥½ï¼‰ï¼Œæ”¯æŒ Markdown ä»¥åŠ CommonMark è¯­æ³•ï¼Œæ¸²æŸ“é€Ÿåº¦æ¯” hexo-renderer-marked å¿«ï¼Œæ”¯æŒæ’ä»¶é…ç½®ï¼Œæ”¯æŒæ ‡é¢˜å¸¦å®‰å…¨çš„ id ä¿¡æ¯ï¼Œæ”¯æŒè„šæ³¨ï¼ˆä¸Šæ ‡ï¼Œä¸‹æ ‡ï¼Œä¸‹åˆ’çº¿ï¼‰ã€‚ hexo-renderer-markdown-it-plus æ”¯æŒ Katex æ’ä»¶å¹¶é»˜è®¤å¯ç”¨ï¼Œé»˜è®¤å¯ç”¨æ’ä»¶åˆ—è¡¨ï¼šmarkdown-it-emojiï¼Œmarkdown-it-subï¼Œmarkdown-it-supï¼Œmarkdown-it-deflistï¼Œmarkdown-it-abbrï¼Œmarkdown-it-footnoteï¼Œmarkdown-it-insï¼Œmarkdown-it-markï¼Œ<span class="citation" data-cites="iktakahiro/markdown-it-katex">@iktakahiro/markdown-it-katex</span>ï¼Œmarkdown-it-toc-and-anchorã€‚</p><p>è¿™é‡Œè¦åæ§½ä¸€ä¸‹å„ç‰ˆæœ¬çš„ markdown æ¸²æŸ“å™¨ï¼Œå¯¹ latex è¯­æ³•çš„æ”¯æŒçœŸæ˜¯ä¸€è¨€éš¾å°½ï¼Œpandoc ç”¨äº†ä¸€æ®µæ—¶é—´å‘ç°æŸäº›ç‰¹æ€§ä¸æ”¯æŒæ‰“ç®—æ¢ä¸€ä¸ªï¼Œç„¶å latex å…¬å¼å„ç§å´©ï¼ŒğŸ˜”æ¯ç­å§ã€‚</p><span id="more"></span><h1 id="plugin">Plugin</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœç´¢</span></span><br><span class="line">npm install hexo-generator-search --save</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—æ•°ç»Ÿè®¡</span></span><br><span class="line">npm i --save hexo-wordcount</span><br><span class="line">npm install hexo-word-counter</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  emoji è¡¨æƒ…æ”¯æŒ</span></span><br><span class="line">npm install hexo-filter-github-emojis</span><br><span class="line"></span><br><span class="line">npm i remark-prism</span><br></pre></td></tr></tbody></table></figure><h1 id="æ–‡ç« åŠ å¯†">æ–‡ç« åŠ å¯†</h1><h2 id="å®‰è£…-hexo-blog-encrypt-æ’ä»¶">å®‰è£… hexo-blog-encrypt æ’ä»¶</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-blog-encrypt</span><br></pre></td></tr></tbody></table></figure><h2 id="ç”¨æ³•">ç”¨æ³•</h2><h3 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line"><span class="built_in">date</span>: 2016-03-30 21:18:02</span><br><span class="line">password: hello</span><br><span class="line">---</span><br></pre></td></tr></tbody></table></figure><h3 id="é«˜çº§è®¾ç½®">é«˜çº§è®¾ç½®</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line"><span class="built_in">date</span>: 2016-03-30 21:12:21</span><br><span class="line">password: hello</span><br><span class="line">abstract: Here<span class="string">'s something encrypted, password is required to continue reading.</span></span><br><span class="line"><span class="string">message: Hey, password is required here.</span></span><br><span class="line"><span class="string">wrong_pass_message: Oh, this is an invalid password. Check and try again, please.</span></span><br><span class="line"><span class="string">---</span></span><br></pre></td></tr></tbody></table></figure><ul><li>abstractï¼šç”¨äºè®¾ç½®åŠ å¯†æ–‡ç« æ˜¾ç¤ºçš„æ‘˜è¦</li><li>messageï¼šè¾“å…¥å¯†ç æç¤º</li><li>wrong_pass_message: è¾“å…¥é”™è¯¯æç¤º</li></ul><h1 id="å¦‚æœ-deploy-å¤±è´¥åˆ™">å¦‚æœ deploy å¤±è´¥åˆ™</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf .deploy_git</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></tbody></table></figure><h1 id="å¦‚ä½•å†™-blog">å¦‚ä½•å†™ Blog</h1><h2 id="åˆ†ç±»">åˆ†ç±»</h2><p>æœ€å¤§çš„é—®é¢˜æ˜¯ä¸€ç¯‡æ–‡ç« åªèƒ½å¤„äºä¸€ä¸ªåˆ†ç±»ï¼Œä½†æ˜¯æˆ‘çš„ä¸€ç¯‡ ISP æ–‡ç« æ—¢å±äºé©±åŠ¨åˆå±äº Imageï¼Œè¿˜å±äºç®—æ³•ç›®å½•ï¼Œè¿™ä¸ªæ—¶å€™è¿™ç¯‡æ–‡ç« åˆ°åº•è¯¥æ”¾åˆ°å“ªé‡Œï¼Ÿ ä¸ºæ­¤æˆ‘èŠ±äº†å¤§é‡æ—¶é—´æ¥é‡æ–°åˆ†ç±»ï¼Œä½†æ˜¯æœ‰äº›ä¸œè¥¿å§‹ç»ˆæœ‰äº¤å‰ï¼Œæˆ‘æ˜¯æ—¢è¦åˆè¦ï¼Œemmï¼ï¼ï¼ä¸ºæ­¤æˆ‘æ‰¾åˆ°äº† MECE åˆ†ç±»æ³•ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Share/blog1.png"></p><h2 id="æ ‡ç­¾">æ ‡ç­¾</h2><p>æ ‡ç­¾ç›¸æ¯”äºåˆ†ç±»æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œä¸€ä¸ªäº‹ç‰©å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ã€‚åœ¨<strong>åˆç†ä½¿ç”¨æ ‡ç­¾</strong>ä¹‹å‰ä¸€ç›´è§‰å¾—æ ‡ç­¾æ˜¯é›¶æ•£çš„ï¼Œæ²¡æœ‰ä½“ç³»ï¼Œä½†å®é™…ä¸Šæ ‡ç­¾å¯ä»¥æ¯”åˆ†ç±»æ›´ä½“ç³»ã€‚åªè¦æ ‡ç­¾åšå¥½ç®¡ç†è¿™å°±æ˜¯ä¸€ä¸ªå¿«é€Ÿç´¢å¼•ï¼Œä¸”æ˜¯ä¸€ä¸ªç½‘çŠ¶ç»„ç»‡ï¼Œé¡ºç€è¿™ä¸ªæ ‡ç­¾æ‰¾åˆ°åŒä¸€ç‰‡æ–‡ç« çš„å…¶ä»–æ ‡ç­¾é¡ºç€è¿™ä¸ªæ ‡ç­¾å†æ‰¾åˆ°å…¶ä»–æ–‡ç« è¿™ç§ç½‘ç«™ç»„ç»‡å½¢å¼æ˜¯éå¸¸é«˜æ•ˆçš„ã€‚</p><p>åˆšæ‰è¯´åˆ°åˆç†ä½¿ç”¨æ ‡ç­¾ï¼Œå¦‚æœä¸åˆç†ä½¿ç”¨å°±ä¼šé€ æˆå¾ˆå¤šè‹¥å…³è”æ€§ï¼Œä¾‹å¦‚æŸç¯‡ USB æ–‡ç« æåˆ°ç¡¬ circuitã€æåˆ° phyã€æåˆ° OTGã€æåˆ° Controllerï¼›ä½†æ˜¯é€šç¯‡ä¸»è¦æ˜¯è®² phyï¼Œé‚£ circuitã€otgã€controller è¦ä¸è¦æ‰“ä¸Šæ ‡ç­¾å‘¢ï¼Ÿæ‰“ä¸Šå¯èƒ½ä¼šå¤§é‡å­¤ç«‹æ ‡ç­¾ï¼Œå¯èƒ½ otg è¿™ä¸ªæ ‡ç­¾åªä¼šæœ‰è¿™ä¸€ç¯‡å¯¹åº”çš„æ–‡ç« ï¼Œè€Œè¿™ä¸€ç¯‡åˆä¸æ˜¯ä¸“é—¨å†™ otg çš„ï¼Œå€˜è‹¥è¿™æ ·çš„æ ‡ç­¾å¯¹åº”å¾ˆå¤šæ–‡ç« ï¼Œæ¯ä¸€ç¯‡éƒ½ä¸æ˜¯ä¸»è¦çš„æ–‡ç« é‚£æ˜¯ä¸æ˜¯åœ¨æ£€ç´¢çš„æ—¶å€™å°±å¾ˆæŠ“ç‹‚å‘¢ã€‚</p><p>æ ‡ç­¾è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“æ–‡ç« æ•°é‡è¾¾åˆ°å‡ ç™¾ç¯‡çš„æ—¶å€™ï¼Œæ ‡ç­¾çš„æ•°é‡æœ¬èº«å¯èƒ½éå¸¸åºå¤§ã€å¯èƒ½å­˜åœ¨å¤§é‡æ ‡ç­¾åªå¯¹åº”éå¸¸å°‘çš„æ–‡ç« æˆ–è€…åªæœ‰ä¸€ç¯‡æ–‡ç« çš„æƒ…å†µï¼Œæˆ–è€…ä¸€ä¸ªæ ‡ç­¾å¯¹åº”å‡ åç”šè‡³ä¸Šç™¾ç¯‡çš„æ–‡ç« ã€‚</p><h2 id="æ€è·¯">æ€è·¯</h2><p>æˆ‘çš„åšæ³•å¾ˆç®€å•ï¼Œå°†ä¹‹å‰çš„ç›®å½•å‰éƒ¨æ ‡ç­¾åŒ–ï¼Œå¯¹äºçº ç»“ä¸€ç¯‡æ–‡ç« è¯¥æ”¾åˆ°å“ªä¸ªç›®å½•ä¸‹è¿™ä¸ªéš¾é¢˜ï¼Œç›´æ¥æ‰“ä¸Šä¸¤ä¸ªæ ‡ç­¾ã€‚ åˆ†ç±»å¯ä»¥è®©ä½ å¯¹çŸ¥è¯†ä½“ç³»æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œä»–ä¸€å®šç¨‹åº¦ä¸Šä»£è¡¨äº†ä½ çš„æ€è€ƒè¿‡ç¨‹ï¼Œæˆ‘ç”šè‡³æœ‰è¿‡ä¸€ä¸ªæç«¯çš„æƒ³æ³•å»æ‰åˆ†ç±»ï¼Œå› ä¸ºæˆ‘æ›¾ç»çœŸçš„åœ¨ç»™æ–‡ç« åˆ†ç±»ä¸Šç¡ä¸ç€è§‰çš„ï¼Œä½†æ˜¯æˆ‘ä¹Ÿç»å†è¿‡äº†æ ‡ç­¾æ»¡å¤©é£çš„çš„çª˜å¢ƒï¼Œæœ€ç»ˆè¿˜æ˜¯æ‰“ç®—ä¿ç•™åˆ†ç±»ã€‚</p><h2 id="æ€è€ƒ">æ€è€ƒ</h2><p>æˆ‘è®¤ä¸ºæ ‡ç­¾ä¼˜äºåˆ†ç±»çš„ç‚¹åœ¨äºï¼Œæ ‡ç­¾å¯ä»¥æ˜¯å¤šç»´åº¦çš„æ‰å¹³åŒ–åˆ†ç±»ï¼Œç±»å¦‚æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡å…³äº IMU çš„æ–‡ç« ï¼Œå¯¹äºåˆ†ç±»ï¼Œä½ å¯ä»¥ç½®äºç®—æ³•ç›®å½•ä¸‹ï¼Œè¿™ä¸ªæ˜¯åœ¨ç¼–ç¨‹ã€ç®—æ³•è¿™ä¸ªç»´åº¦ä¸‹çš„ï¼Œä¹Ÿçº ç»“äºæ”¾åœ¨ Sensor ç›®å½•ä¸‹ï¼ŒIMU å±äºä¸€ä¸ªä¼ æ„Ÿå™¨ï¼Œè¿™ä¸ªæ˜¯æ”¾åˆ° Sensorã€MCUã€MPU è¿™äº›å…·è±¡å®ç‰©ç»´åº¦ä¸‹çš„åˆ†ç±»ï¼Œä»–è¿˜å¯ä»¥æ”¾åœ¨é˜²æŠ–ç›®å½•ä¸‹ï¼Œåœ¨é˜²æŠ–çš„äº‹ä»¶é‡Œä»–æ˜¯è‡³å…³é‡è¦çš„ä¸€ä¸ªè§’è‰²ï¼Œè¿™ä¸ªæ˜¯æ”¾åˆ°å›¾åƒã€éŸ³é¢‘ã€ç½‘ç»œè¿™äº›å­¦ç§‘é¢†åŸŸåˆ†ç±»ç»´åº¦ä¸‹çš„ã€‚å› æ­¤åˆ†ç±»è¿˜æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯ä¸å¿…æ˜¯å”¯ä¸€çš„äº†ï¼Œä¹Ÿå°±æ˜¯åœ¨ä½ å¿ƒä¸­ä¾ç„¶æ˜¯å­˜åœ¨åˆ†ç±»çš„ï¼Œè€Œä¸”ä¸æ˜¯ä¸€ä¸ªåˆ†ç±»ï¼Œæ˜¯ä»å¤šç»´åº¦è¿›è¡Œåˆ†ç±»ï¼Œä¸€ç¯‡æ–‡ç« åŒæ—¶å­˜åœ¨ä¸åŒç»´åº¦çš„ä¸åŒåˆ†ç±»ä¸‹ã€‚è€Œè¿™äº›ä¸åŒç»´åº¦ä¸‹çš„ç›®å½•å°±æ˜¯æ ‡ç­¾ï¼Œè¿™æ ·æ ‡ç­¾ä¸ä¼šå‡ºç°çˆ†ç‚¸ï¼Œä¹Ÿä¸ä¼šå‡ºç°åŒä¸€ä¸ªæ ‡ç­¾å´å†™äº†ä¸åŒåå­—çš„é—®é¢˜ï¼Œä¾‹å¦‚ RTOS æ ‡ç­¾è¢«æ‰“æˆ UCOSã€RT-Threadã€Zephyr ç­‰ä¸åŒå½¢å¼çš„æ ‡ç­¾ã€‚</p><p>å›è¿‡å¤´æ¥çœ‹ï¼Œåˆ†ç±»æ˜¯åŠé€€å†™æ–‡ç« çš„éšœç¢å—ï¼Œæˆ‘è§‰å¾—æœªå¿…ï¼Œæ ‡ç­¾æœ¬è´¨ä¸Šä¹Ÿæ˜¯éœ€è¦å»ºç«‹ç›®å½•çš„ï¼Œè€Œä¸”æ˜¯æ›´å¤šç»´åº¦ä¸Šçš„åˆ†ç±»ï¼Œå…¶å®æ ‡ç­¾æ¯”åˆ†ç±»æ›´éš¾ï¼Œåˆ†ç±»åšä¸å¥½é¡¶å¤šæ˜¯å­˜åœ¨ä¸€äº›æ­§ä¹‰é—®é¢˜ï¼Œæ–‡ç« æ²¡æœ‰æŒ‚åˆ°æŸäº›åº”è¯¥è¢«æŒ‚åˆ°çš„ç›®å½•ä¸‹ï¼Œå› ä¸ºä»–åªèƒ½åœ¨åˆ†ç±»ä¸­å‡ºç°ä¸€æ¬¡ã€‚</p><h2 id="å…³äºåŒé“¾">å…³äºåŒé“¾</h2><p>...</p><h1 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h1><p><span class="exturl" data-url="aHR0cHM6Ly9idWd3ei5jb20vMjAxOS8wOS8xNy9oZXhvLW1hcmtkb3duLXJlbmRlcmVyLyMxLTQlRTMlODAlODFoZXhvLXJlbmRlcmVyLW1hcmtkb3duLWl0">https://bugwz.com/2019/09/17/hexo-markdown-renderer/#1-4%E3%80%81hexo-renderer-markdown-it<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Share </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NAS æœ‰è¶£çš„ Docker æ¨è</title>
      <link href="/2024/Tools/NasDockerUsage/"/>
      <url>/2024/Tools/NasDockerUsage/</url>
      
        <content type="html"><![CDATA[<p>å·²è¿ç§»åˆ°notion pageï¼Œè¯·è®¿é—®:<span class="exturl" data-url="aHR0cHM6Ly9jYXJseWxlbGl1Lm5vdGlvbi5zaXRlL0RvY2tlci1WaWV3LTBkYjhmNmM0YzU3MjQxYjJhYjdlOThhN2M5ODY2MGE3">NAS æœ‰è¶£çš„ Docker æ¨è<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Share </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆä¹ï¼‰UAC å¸¸è§é—®é¢˜</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACCommonIssue/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACCommonIssue/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¿®æ”¹uacé…ç½®å‚æ•°åæ— æ³•æ­£å¸¸é€šä¿¡">ä¿®æ”¹UACé…ç½®å‚æ•°åæ— æ³•æ­£å¸¸é€šä¿¡</h1><p>å¦‚æœä¿®æ”¹äº†UACçš„é…ç½®åå‡ºç°UACæ— æ³•æ­£å¸¸é€šä¿¡çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è®¾å¤‡çš„idVendorå’ŒidProductæ¥è§£å†³ï¼Œåªæœ‰è®¾å¤‡çš„idVendorå’ŒidProductå‘ç”Ÿæ”¹å˜Windowsæ‰ä¼šé‡æ–°è¯»å–è®¾å¤‡çš„é…ç½®æè¿°ç¬¦ã€‚</p><span id="more"></span><h1 id="kernel-5.4å†…æ ¸é…ç½®æŸäº›å‚æ•°åuacé€šä¿¡å¼‚å¸¸">Kernel 5.4å†…æ ¸é…ç½®æŸäº›å‚æ•°åUACé€šä¿¡å¼‚å¸¸</h1><p>ä¾‹å¦‚åœ¨44100é‡‡æ ·ç‡ã€4channelã€32bitå‚æ•°ä¸‹Deviceåˆ°Hostç«¯é€šä¿¡å¼‚å¸¸ï¼Œè€ŒHostç«¯åˆ°Deviceç«¯é€šä¿¡æ­£å¸¸ã€‚ é—®é¢˜çš„åŸå› æ˜¯ç”±äºLinuxçš„UACé©±åŠ¨è®¡ç®—çš„æ¯æ¬¡ä¼ è¾“çš„usbåŒ…å¤§å°ä¸æ­£ç¡®ï¼Œå¯¼è‡´USBä¼ è¾“æ ¼å¼ä¸åŒ¹é…å‡ºç°äº†é€šä¿¡å¼‚å¸¸ã€‚è¯¦ç»†åŸå› å¦‚ä¸‹ï¼š</p><ul><li>è¯¥å‚æ•°ä¸‹æ¯ç§’é’Ÿçš„æ•°æ®é‡ä¸º44100 * 4 * 4 = 705600</li><li>USBæ¯ç§’ä¼ è¾“ä¸€åƒä¸ªåŒ…ï¼Œåˆ™æ¯ä¸ªåŒ…çš„å¤§å°ä¸º 705600 / 1000 = 705.6</li><li>Linuxä¸‹UACé©±åŠ¨çš„åšæ³•æ˜¯æ¯æ¬¡ä¼ è¾“705å­—èŠ‚æ•°æ®ï¼Œå½“ä½™æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™ä¼ è¾“705+16=721å­—èŠ‚ï¼Œç„¶åä¾æ¬¡å¾ªç¯ä¸‹å»ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯705ä¸æ˜¯frameså¤§å°çš„æ•´æ•°å€ï¼Œå³705 / (4 * 4) = 44.0625,é‚£ä¹ˆUSBæ¯æ¬¡ä¼ è¾“çš„æ•°æ®ä¸èƒ½å®Œå…¨é€åˆ°å£°å¡ï¼Œè¦ç­‰ä¸‹ä¸€æ¬¡çš„æ•°æ®åˆ°æ¥åæ‹¼æˆä¸€ä¸ªå®Œæ•´çš„frameæ‰èƒ½é€åˆ°å£°å¡ï¼Œè¿™æ ·æ˜¾ç„¶æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œä¸”ä¼šé€ æˆæ›´å¤§çš„å»¶è¿Ÿ</li><li>Windowsçš„åšæ³•æ˜¯æ¯æ¬¡ä¼ è¾“704å­—èŠ‚ï¼Œç„¶åå‰©ä½™çš„æ•°æ®ç§¯æ”’åˆ°ä¸€å¸§çš„æ•°æ®é‡åä¸‹æ¬¡ä¼ è¾“704 + ï¼ˆ4 * 4ï¼‰= 720å­—èŠ‚</li><li>å¯ä»¥çœ‹åˆ°Linuxå’ŒWindowsæ¯æ¬¡ä¼ è¾“å’Œæ¥æ”¶çš„å¤§å°éƒ½ä¸ä¸€æ ·ï¼Œå¯¼è‡´äº†ä¸¤åˆ™æ— æ³•æ­£å¸¸é€šä¿¡ï¼Œæ˜¾ç„¶Linuxçš„è®¡ç®—æ–¹æ³•æ˜¯é”™è¯¯çš„ï¼ŒLinuxé©±åŠ¨ä¸­ä¹Ÿæ²¡æœ‰è‡ªå·±æ‹¼æ¥æ•°æ®çš„é€»è¾‘ï¼Œè¿™ä¸ªå°±æ˜¯Linuxä¸‹è®¡ç®—usbåŒ…å¤§å°çš„ä¸€ä¸ªBugã€‚</li></ul><p>Linuxä¸Šæ¸¸ç¤¾åŒºå·²ç»å‘ç°å¹¶è§£å†³äº†è¿™ä¸ªBugï¼Œæœ€ç»ˆè®¡ç®—åˆ°çš„å¤§å°ä¸Windowsçš„å¤§å°ç›¸åŒï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><span class="math display">\[pkt\_size = frame\_size * \frac{sampling\_rate}{1000} \]</span></p><p>å³å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt_size = frame_size * (sampling_rate / <span class="number">1000</span>) <span class="comment">// 704 = 16 * (44100 / 1000) = 16 * 44</span></span><br></pre></td></tr></tbody></table></figure><h1 id="uac1-æ— æ³•æ”¯æŒ48k4channel32bité—®é¢˜">UAC1 æ— æ³•æ”¯æŒ48Kã€4channelã€32bité—®é¢˜</h1><p>drivers/usb/gadget/function/u_uac1.hï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define UAC1_OUT_EP_MAX_PACKET_SIZE200</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œé—²ç½®äº†usbæ¯ä¸ªåŒ…çš„å¤§å°ä¸èƒ½è¶…è¿‡200å­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸€ä¸‹æ•°æ®é‡ï¼š</p><p>å¯¹äº48Kã€4channelã€32bitæ¯ç§’é’Ÿçš„æ•°æ®é‡ä¸ºï¼š48000_4_4 = 768,000Byte</p><p>USBæ¯ç§’å‘é€1000æ¬¡æ•°æ®ï¼Œæ¯æ¬¡æœ€å¤§3ä¸ªæ•°æ®åŒ…ï¼Œåˆ™æ¯ä¸ªåŒ…å¤§å°éœ€è¦768000 / 1000 / 3 = 256ã€‚è¿™é‡Œçš„å®å®šä¹‰å°†æ¯ä¸ªåŒ…çš„å¤§å°é™åˆ¶åœ¨200äº†ï¼Œåˆ™å¸¦å®½ä¸å¤Ÿï¼Œéœ€è¦æ”¾å¼€è¿™ä¸ªé™åˆ¶ï¼Œå°†å®å¤§å°æ”¹ä¸º1023å°±å¯ä»¥äº†ã€‚</p><p>ğŸ’¡ é©±åŠ¨ä¸­ä¸ºä»€ä¹ˆé»˜è®¤è®¾ç½®ä¸º200å‘¢ï¼Œå…¶å®æ˜¯ä¸ºäº†ä¿è¯usbä½é€Ÿè®¾å¤‡å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰è®¾ç½®è¿™ä¹ˆä½çš„ï¼Œå¯¹äºusbä½é€Ÿè®¾å¤‡1.5Mbit/s = 1.5 * 1024 *1024 / 8 / 1000 = 196.å¦‚æœusbæ”¯æŒå…¨é€Ÿæˆ–è€…é«˜é€Ÿå¯ä»¥å°†è¿™ä¸ªé™åˆ¶æ”¾å¼€ã€‚</p><h1 id="uac2æ— æ³•æ”¯æŒå¤§äº192k4channel32bitå‚æ•°é—®é¢˜">UAC2æ— æ³•æ”¯æŒå¤§äº192Kã€4channelã€32bitå‚æ•°é—®é¢˜</h1><p>drivers/usb/gadget/function/f_uac2.c:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static struct usb_endpoint_descriptor hs_epout_desc = {</span><br><span class="line">.bLength = USB_DT_ENDPOINT_SIZE,</span><br><span class="line">.bDescriptorType = USB_DT_ENDPOINT,</span><br><span class="line">.bmAttributes = USB_ENDPOINT_XFER_ISOC | USB_ENDPOINT_SYNC_ADAPTIVE,</span><br><span class="line">/* .wMaxPacketSize = DYNAMIC */</span><br><span class="line">.bInterval = 4,</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line">static struct usb_endpoint_descriptor hs_epin_desc = {</span><br><span class="line">.bLength = USB_DT_ENDPOINT_SIZE,</span><br><span class="line">.bDescriptorType = USB_DT_ENDPOINT,</span><br><span class="line">.bmAttributes = USB_ENDPOINT_XFER_ISOC | USB_ENDPOINT_SYNC_SYNC,</span><br><span class="line">/* .wMaxPacketSize = DYNAMIC */</span><br><span class="line">.bInterval = 4,</span><br><span class="line">};</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡ŒbIntervalæ˜¯æ§åˆ¶UACå‘åŒ…é¢‘ç‡çš„ï¼ŒUSBå…¨é€Ÿæ€»çº¿1mså‘é€ä¸€æ¬¡æ•°æ®ï¼ŒUSBé«˜é€Ÿæ€»çº¿å¯ä»¥125uså‘é€ä¸€æ¬¡æ•°æ®ï¼Œè¿™é‡Œçš„bIntervalå°±æ˜¯ç”¨æ¥æ§åˆ¶UACå¤šä¹…å‘é€ä¸€æ¬¡æ•°æ®çš„ï¼Œå¦‚æœbInterval=1ï¼Œåˆ™UACæ•°æ®åŒ…çš„é—´éš”å°±æ˜¯<span class="math inline">\(125us * 2^{1-1}\)</span>å¦‚æœbInterval=4åˆ™UACå‘é€é—´éš”ä¸º<span class="math inline">\(125us * 2^{4-1}=1ms\)</span>ã€‚é©±åŠ¨ä¸­é»˜è®¤æ˜¯1mså‘é€ä¸€æ¬¡æ•°æ®ï¼Œåˆ™æœ€å¤§çš„æ•°æ®é‡å°±æ˜¯1000 * 1024 * 3 = 3072000 = 192K * 4channel * 4Byteã€‚</p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦å°†bIntervalæ”¹ä¸º1å³å¯ã€‚</p><p>ğŸ’¡ bInterval=1å…·æœ‰æ›´ä½çš„å»¶è¿Ÿï¼Œæ›´å¤§çš„å¸¦å®½ï¼Œä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†åœºæ™¯æ²¡å¿…è¦è®¾ç½®è¿™ä¹ˆé«˜çš„é¢‘ç‡ï¼Œ1mså°±å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚</p><h1 id="å„ç³»ç»ŸuacéŸ³é‡è°ƒèŠ‚æ”¯æŒæƒ…å†µ">å„ç³»ç»ŸUACéŸ³é‡è°ƒèŠ‚æ”¯æŒæƒ…å†µ</h1><table><thead><tr class="header"><th></th><th>Windows10/11</th><th>Android 11ï¼ˆåŸºäºä¸€åŠ 6ï¼‰</th><th>ios</th><th>Macos</th></tr></thead><tbody><tr class="odd"><td>UAC1 Disable FU</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>ä¸æ”¯æŒè°ƒèŠ‚éŸ³é‡ï¼ˆéŸ³é‡æ»‘å—å˜ç°ä¸å¯æ‹–åŠ¨ï¼‰</td><td>åŒiosï¼ˆæœªåšéªŒè¯ï¼‰</td></tr><tr class="even"><td>UAC1 Enable FU</td><td>æ”¯æŒæ§åˆ¶éŸ³é‡ï¼›ä¸æ”¯æŒåŒæ­¥è®¾å¤‡éŸ³é‡</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>æ”¯æŒæ§åˆ¶éŸ³é‡ï¼›æ”¯æŒåŒæ­¥è®¾å¤‡éŸ³é‡</td><td>åŒiosï¼ˆæœªåšéªŒè¯ï¼‰</td></tr><tr class="odd"><td>UAC2 Disable FU</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>ä¸æ”¯æŒè°ƒèŠ‚éŸ³é‡ï¼ˆéŸ³é‡æ»‘å—å˜ç°ä¸å¯æ‹–åŠ¨ï¼‰</td><td>åŒiosï¼ˆæœªåšéªŒè¯ï¼‰</td></tr><tr class="even"><td>UAC2 Enable FU</td><td>æ”¯æŒæ§åˆ¶éŸ³é‡ï¼›æ”¯æŒåŒæ­¥è®¾å¤‡éŸ³é‡</td><td>é€šè¿‡è°ƒèŠ‚éŸ³é¢‘æ•°æ®å¹…å€¼è°ƒèŠ‚éŸ³é‡</td><td>æ”¯æŒæ§åˆ¶éŸ³é‡ï¼›æ”¯æŒåŒæ­¥è®¾å¤‡éŸ³é‡</td><td>åŒiosï¼ˆæœªåšéªŒè¯ï¼‰</td></tr></tbody></table><p>ğŸ’¡ 1. ç½‘ä¸ŠæŸ¥åˆ°çš„ä¿¡æ¯æ˜¯Android 14æ”¯æŒFeature Unitï¼Œä½†æ˜¯åœ¨æˆ‘çš„ä¸€åŠ 6ï¼ˆAndroid11ï¼‰ä¸ŠéªŒè¯æ˜¯ä¸æ”¯æŒFUçš„ 2. macosåº”è¯¥ä¸iosä¸€è‡´ï¼Œæœªä½œéªŒè¯</p><h1 id="å…³äºwindowsç³»ç»Ÿuac1å¯¹fuæ”¯æŒæƒ…å†µçš„ç–‘é—®">å…³äºwindowsç³»ç»ŸUAC1å¯¹FUæ”¯æŒæƒ…å†µçš„ç–‘é—®</h1><p>Windows çš„UAC2å¯¹Functionçš„æ”¯æŒæƒ…å†µæœ‰æ˜ç¡®è¯´æ˜ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uac1.png"></p><p>UAC2çš„Feature Unitæ˜¯æ˜ç¡®æ”¯æŒInterruptçš„ã€‚ä½†æ˜¯æ²¡æœ‰æŸ¥åˆ°UAC1å¯¹Functionçš„æ”¯æŒæƒ…å†µã€‚å®é™…æµ‹è¯•å‘ç°Windowsæ˜¯å¯ä»¥æ­£ç¡®è¯†åˆ«Feature unitç«¯ç‚¹æè¿°ç¬¦çš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uac2.png"></p><p>è¿™é‡Œé¢çš„ä¿¡æ¯ä¸Specé‡Œéƒ½èƒ½ä¸€ä¸€å¯¹åº”ä¸Šï¼Œç«¯ç‚¹æè¿°ç¬¦æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯æµ‹è¯•å‘ç°Windowsä¸ä¼šå»è¯»å–Interruptç«¯ç‚¹æ•°æ®ï¼ŒæŠ“åŒ…å‘ç°æ²¡æœ‰ä»»ä½•è¯¥ç«¯ç‚¹çš„è¯»å–æ“ä½œï¼Œé‚£ä¹ˆå®æµ‹å¾—åˆ°çš„UAC1å¯¹Featureæ”¯æŒæƒ…å†µæ˜¯ï¼š</p><ul><li>æ”¯æŒï¼š<ul><li>GET CUR</li><li>SET CUR</li><li>GET RANGE</li></ul></li><li>ä¸æ”¯æŒï¼š<ul><li>Interrupt</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆå…«ï¼‰PPM è¯„ä¼°</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACASYNCPPM/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACASYNCPPM/</url>
      
        <content type="html"><![CDATA[<h1 id="usb-sofç»Ÿè®¡æ–¹æ³•">USB sofç»Ÿè®¡æ–¹æ³•</h1><h2 id="æ‰“æ—¶é—´æˆ³æ–¹å¼">æ‰“æ—¶é—´æˆ³æ–¹å¼</h2><ol type="1"><li><strong>ktime_get_raw_ns()</strong> Linuxæ ‡å‡†æ¥å£ã€‚</li><li><strong>meson_timestamp()</strong> Amlogicå®ç°çš„ç¡¬ä»¶å®šæ—¶å™¨æ¥å£ã€‚</li></ol><h2 id="sofæ‰“æ—¶é—´æˆ³çš„æ—¶æœº">sofæ‰“æ—¶é—´æˆ³çš„æ—¶æœº</h2><ol type="1"><li>ç›´æ¥åœ¨SOFä¸­æ–­handleé‡Œæ‰“æ—¶é—´æˆ³ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°ä¸€ä¸ªfifoé‡Œã€‚</li><li>é€šè¿‡ä¸€ä¸ªhrtimerï¼Œä¸»åŠ¨æŸ¥è¯¢SOFä¸­æ–­å¯„å­˜å™¨æŸ¥çœ‹æ˜¯å¦æœ‰SOFåŒ…ï¼Œå¦‚æœæœ‰SOFåŒ…åˆ™æ‰“ä¸Šæ—¶é—´æˆ³ä¿å­˜åˆ°fifoé‡Œã€‚</li></ol><h2 id="sofæ—¶é—´æˆ³å¯¼å‡ºåˆ°åº”ç”¨å±‚">sofæ—¶é—´æˆ³å¯¼å‡ºåˆ°åº”ç”¨å±‚</h2><p>é€šè¿‡seq fileåˆ›å»ºä¸€ä¸ªprocï¼ˆ/proc/sof_tsï¼‰æ–‡ä»¶ï¼Œåº”ç”¨é€šè¿‡è¯»å–è¯¥æ–‡ä»¶æ¥è·å–sofæ—¶é—´æˆ³ã€‚</p><span id="more"></span><h1 id="usb-sofç»Ÿè®¡æ•°æ®æ–¹æ¡ˆéªŒè¯">USB sofç»Ÿè®¡æ•°æ®æ–¹æ¡ˆéªŒè¯</h1><h2 id="ä¸­æ–­handleé‡Œç”¨ktime_get_raw_nsæ‰“æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®">ä¸­æ–­handleé‡Œç”¨ktime_get_raw_ns()æ‰“æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®</h2><p><strong>æ•°æ®ï¼š</strong><br>| æ ·æœ¬æ•°é‡ | å¹³å‡å€¼ï¼ˆnsï¼‰ | æœ€å°å€¼ï¼ˆnsï¼‰ | æœ€å¤§å€¼ï¼ˆnsï¼‰ | æ–¹å·® | æ ‡å‡†å·® | | --- | --- | --- | --- | --- | --- | | 8192 | 125001.0327 | 94125 | 156125 | 2281694.791 | 1510.5279 |</p><p><strong>sofé—´éš”å›¾è¡¨ï¼š</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof1.png"></p><p><strong>ç»Ÿè®¡ç›´æ–¹å›¾(124-126us)ï¼š</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof2.png"></p><p>ä¸Šå›¾åœ¨124us-126usä¹‹é—´çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä¸¤å¤´åˆ†åˆ«æ˜¯ä½äº124uså’Œé«˜äº126usçš„æ¦‚ç‡ã€‚ä½äº124usçš„æ¦‚ç‡ä¸º3.0%ï¼Œé«˜äº126usçš„æ¦‚ç‡ä¸º2.8%.</p><p><strong>ç»Ÿè®¡ç›´æ–¹å›¾(120-130us)ï¼š</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof3.png"></p><p>ä¸Šå›¾å°†ç›´æ–¹å›¾ç»Ÿè®¡å£å¾„æ”¾å¤§åˆ°120us-130usï¼Œé‚£ä¹ˆä½äº120usçš„æ¦‚ç‡ä¸º1.1%ï¼Œé«˜äº130usçš„æ¦‚ç‡ä¸º1.2%.</p><p>é€šè¿‡ä»¥ä¸Šæ•°æ®æ¥çœ‹ï¼Œæ²¡æœ‰ä½¿ç”¨hrtimeræ•è·sofçš„å¿…è¦ï¼Œç›´æ¥åœ¨ä¸­æ–­handleré‡Œæ•è·å¾—åˆ°çš„æ•°æ®ç²¾åº¦å®Œå…¨è¶³å¤Ÿè¯„ä¼°ppmäº†ï¼Œæ•´ä½“æ•°æ®åˆ†å¸ƒç¬¦åˆé«˜æ–¯å™ªå£°åˆ†å¸ƒæ›²çº¿ï¼Œå¯ä»¥é…åˆä¸€å®šçš„æ¶ˆé™¤é«˜æ–¯å™ªå£°çš„æ»¤æ³¢ç®—æ³•å¾—åˆ°æ›´ä¸ºç¨³å®šçš„æ•°æ®ã€‚</p><h2 id="ä¸­æ–­handleé‡Œç”¨meson_timestampæ‰“æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®">ä¸­æ–­handleé‡Œç”¨meson_timestamp()æ‰“æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®</h2><p><strong>æ•°æ®ï¼š</strong></p><table><thead><tr class="header"><th>æ ·æœ¬æ•°é‡</th><th>å¹³å‡å€¼ï¼ˆnsï¼‰</th><th>æœ€å°å€¼ï¼ˆnsï¼‰</th><th>æœ€å¤§å€¼ï¼ˆnsï¼‰</th><th>æ–¹å·®</th><th>æ ‡å‡†å·®</th></tr></thead><tbody><tr class="odd"><td>8192</td><td>125000.8546</td><td>111000</td><td>141000</td><td>1501036.994</td><td>1225.168</td></tr></tbody></table><p><strong>sofé—´éš”å›¾è¡¨</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof4.png"></p><p><strong>sofç›´æ–¹å›¾ï¼š</strong></p><p>ç”±äºmeson_timestampçš„ç²¾åº¦åªåˆ°usï¼Œå› æ­¤åªç»Ÿè®¡120us-130usä¹‹é—´çš„æ¦‚ç‡ï¼šå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof5.png"></p><p>å…¶ä¸­ä½äº120usçš„æ¦‚ç‡ä¸º1.2%ï¼Œé«˜äº130usçš„æ¦‚ç‡ä¸º0.78%ã€‚</p><h2 id="ç»“è®º">ç»“è®º</h2><ul><li>ç»Ÿè®¡æ–¹å¼å¯ä»¥ç›´æ¥åœ¨ä¸­æ–­handleé‡Œæ‰“å°æ—¶é—´æˆ³</li><li>è·å–æ—¶é—´æˆ³æ¥å£meson_timestamp()æ•°æ®æ›´ç¨³å®šä¸€äº›ï¼Œä½†å·®åˆ«ä¸å¤§ï¼Œè¿™é‡Œç›´æ¥é‡‡ç”¨Linuxæ ‡å‡†å‡½æ•°ktime_get_raw_ns()è·å–æ—¶é—´æˆ³</li></ul><h1 id="æ»¤æ³¢">æ»¤æ³¢</h1><p>å‰é¢ç¡®å®šäº†åœ¨sofä¸­æ–­handleé‡Œé€šè¿‡ktime_get_raw_ns()è·å–sofæ—¶é—´æˆ³ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°fifoé‡Œï¼Œåº”ç”¨å±‚é€šè¿‡/proc/sof_tsæ–‡ä»¶è¯»å–fifoé‡Œçš„æ—¶é—´æˆ³ã€‚ä¸‹é¢æ˜¯å¯¹æ•°æ®è¿›è¡Œå¤„ç†çš„æ–¹æ³•ï¼š</p><p><strong>å®éªŒä¸€ï¼šæ— ä¸­å€¼æ»¤æ³¢ï¼Œå¡å°”æ›¼æ»¤æ³¢å™¨err_integralä¸kalman_filter_err_integralå¯¹æ¯”ï¼Œkalmanå‚æ•°Q=0.01ï¼ŒR=1</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof6.png"></p><p><strong>æ”¾å¤§ç»†èŠ‚</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof7.png"></p><p>æ»¤æ³¢åæ•°æ®ä»ç„¶å­˜åœ¨è¾ƒå¤§çš„æ³¢åŠ¨ï¼Œè¿™ä¸ªæ³¢åŠ¨ä¸»è¦æ˜¯ç”±ä¸€äº›çªå˜å¾ˆå¤§çš„å€¼å¼•å…¥çš„ï¼Œæƒ³è¦å¾—åˆ°æ›´åŠ å¹³æ»‘çš„æ•°æ®ï¼Œå¯ä»¥å…ˆç”¨ä¸­å€¼æ»¤æ³¢å™¨å°†è¿™äº›æå€¼ç‡é™¤æ‰ã€‚</p><p><strong>å®éªŒäºŒï¼šåŠ å…¥ä¸­å€¼æ»¤æ³¢å™¨ï¼ˆerr_integralä¸kalman_filter_err_integralå’Œkalman_filter_err_integralå¯¹æ¯”ï¼Œä¸­å€¼æ»¤æ³¢çª—å£å¤§å°100ä¸ªsampleï¼Œkalmanå‚æ•°Q=0.01ï¼ŒR=1ï¼‰</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof8.png"></p><p><strong>æ”¾å¤§çœ‹ç»†èŠ‚</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof9.png"></p><p>å¯ä»¥çœ‹åˆ°ç»è¿‡ä¸­å€¼æ»¤æ³¢å™¨åæ¯›åˆºåŸºæœ¬ä¸Šéƒ½å»æ‰äº†ï¼Œä½†æ˜¯æ•°æ®è¿˜æ˜¯ä¸å¤Ÿå¹³æ»‘ï¼Œå†åŠ å…¥karmanæ»¤æ³¢å™¨åæ•°æ®å°±å¾ˆå¹³æ»‘äº†.</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯ç»è¿‡kalmanæ»¤æ³¢åå¾—åˆ°çš„ppmå€¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof10.png"></p><p>èŒƒå›´åœ¨7.56-7.64ppmï¼Œåœ¨ç»è¿‡ä¸€å®šçš„æ—¶é—´åkalmanç³»æ•°åŸºæœ¬æ”¶æ•›å®Œæ¯•ï¼Œæ•°æ®é‡ä¹Ÿç´¯è®¡åˆ°ä¸€å®šç¨‹åº¦åppmåŸºæœ¬ç¨³å®šåœ¨7.6-7.62ppmä¹‹é—´ã€‚</p><h1 id="issue">Issue</h1><p>æµ‹è¯•ä¸­å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„USBä¸€èˆ¬è·‘åœ¨é«˜é€Ÿæ¨¡å¼ä¸‹ï¼Œåœ¨é«˜é€Ÿæ¨¡å¼ä¸‹æ˜¯æ¯125usä¸€ä¸ªsofä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯åœ¨å¼€å¯sofä¸­æ–­åarm coreä¼šæ¯ç§’å¤šæ¥æ”¶8000æ¬¡usbæ§åˆ¶å™¨å‘æ¥çš„ä¸­æ–­ï¼Œè¿™ä¸ªä¸­æ–­æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä¼šé¢‘ç¹è§¦å‘usbä¸­æ–­è¿‡äºé¢‘ç¹çš„checkçš„ã€‚ å¯ä»¥å°è¯•åœ¨ISOä¼ è¾“çš„æ•°æ®ä¸­æ–­ä¸­æ‰“å°æ—¶é—´æˆ³ï¼Œç†è®ºä¸Šè¿™ç§æ–¹å¼å­˜åœ¨æ›´å¤§çš„æ³¢åŠ¨æ€§ï¼Œéœ€è¦éªŒè¯æ•°æ®æ˜¯å¦å¯ç”¨ã€‚</p><h1 id="isoä¸­æ–­ç»Ÿè®¡">ISOä¸­æ–­ç»Ÿè®¡</h1><p>ä¸‹å›¾æ˜¯ä»¥1msä¸ºåŸºå‡†ç»Ÿè®¡çš„isoä¸­æ–­ç´¯è®¡è¯¯å·®ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof11.png"></p><p>ä¸‹å›¾æ˜¯é€šè¿‡ä¸Šå›¾çš„kalmanæ»¤æ³¢æ›²çº¿è®¡ç®—çš„ppmæ›²çº¿ï¼šèŒƒå›´åœ¨6.1-6.5ä¹‹é—´ï¼Œå…¶ä¸­æ³¢åŠ¨æœ€å¤§çš„åœ¨äºæœ‰ä¸€æ®µè¿ç»­æ—¶é—´çš„åå·®æ¸¸èµ°ï¼Œä½†æ˜¯ç»è¿‡æ»¤æ³¢åé€ æˆppmçš„åå·®ä¹Ÿåœ¨0.5ppä»¥å†…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof13.png"></p><p>æ»¤æ³¢å’Œæœªæ»¤æ³¢ppmå€¼å¯¹æ¯”ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof14.png"></p><p>å…¶å®åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå°†ç»Ÿè®¡æ—¶é•¿æ‹‰åˆ°è¶³å¤Ÿé•¿ï¼Œä¸é‡‡ç”¨æ»¤æ³¢ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚å°†ç»Ÿè®¡æ—¶é•¿æ‹‰é•¿åˆ°10åˆ†é’Ÿä»¥ä¸Šï¼Œè¯¯å·®ä¹ŸåŸºæœ¬ä¸Šä¸ä¼šå¾ˆå¤§ã€‚é‡‡ç”¨æ»¤æ³¢çš„ç®—æ³•çš„å¥½å¤„æ˜¯åŸºæœ¬ä¸Š2åˆ†é’Ÿä»¥å†…å°±å¯ä»¥å¾—åˆ°å¾ˆé«˜ç²¾åº¦çš„å€¼äº†ã€‚</p><p><strong>ç»“è®º</strong><br>åœ¨sofä¸­æ–­é‡Œè·å–æ—¶é—´æˆ³pipelineæ›´çŸ­ï¼Œå¼•å…¥çš„è¯¯å·®æ›´å°ï¼Œç²¾åº¦æ›´é«˜ï¼Œä½†æ˜¯å¼€å¯sofä¸­æ–­åusbçš„ä¸­æ–­ä¼šè¿‡äºé¢‘ç¹ï¼Œä¸åˆ©äºusbçš„ç¨³å®šæ€§ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œç›´æ¥ç»Ÿè®¡usb isoä¼ è¾“ä¸­æ–­ä¸ä¼šå¸¦æ¥é¢å¤–çš„ä¸­æ–­å¼€é”€ï¼Œç‰ºç‰²çš„æ˜¯ppmè¯„ä¼°ç²¾åº¦ã€‚å¯¹äºæˆ‘ä»¬çš„å…¬ç‰ˆæ¥è®²åŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨Â±20ppmçš„æ™¶æŒ¯ï¼Œæ³¢åŠ¨åœ¨1ä¸ªppmä»¥å†…åŸºæœ¬ä¸Šæ˜¯å¯ç”¨æ¥å—çš„ã€‚</p><h1 id="æœ€ç»ˆçš„ç®—æ³•">æœ€ç»ˆçš„ç®—æ³•</h1><ol type="1"><li>é€šè¿‡procæ–‡ä»¶ç³»ç»Ÿè·å–sofçš„timestamp</li><li>è®¡ç®—ä¸¤ä¸ªæ—¶é—´æˆ³ä¹‹é—´çš„é—´éš”ï¼ŒæœŸæœ›æ˜¯1ms</li><li>å°†è¯¥æ—¶é—´æˆ³ä¸1msåšå·®ï¼Œè¿›è¡Œç§¯åˆ†ï¼Œå¾—åˆ°ç´¯è®¡è¯¯å·®err_integral</li><li>å¯¹ç´¯è®¡è¯¯å·®è¿›è¡Œä¸­å€¼æ»¤æ³¢å¾—åˆ°median_filter_err_integralä¸­å€¼æ»¤æ³¢åçš„ç´¯è®¡è¯¯å·®</li><li>å¯¹ä¸­å€¼æ»¤æ³¢çš„ç»“æœè¿›è¡Œkalmanæ»¤æ³¢å¾—åˆ°kalman_filter_err_integral</li></ol><h1 id="æ•°æ®éªŒè¯">æ•°æ®éªŒè¯</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/sof15.png"></p><p>æˆ‘ä»¬å¯ç”¨é€šè¿‡ç¤ºæ³¢å™¨æˆ–è€…é¢‘è°±ä»ªæ¥æµ‹é‡æ™¶æŒ¯çš„çœŸå®ppmå€¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸Šé¢ç®—æ³•è¯„ä¼°å‡ºçš„ä¸æ˜¯è®¾å¤‡çš„çœŸå®ppmå€¼ï¼Œè€Œæ˜¯ä»¥pcçš„æ—¶é’Ÿä¸ºåŸºå‡†ï¼Œdeviceçš„æ—¶é’Ÿç›¸å¯¹äºpcæ—¶é’Ÿçš„ppmå€¼ã€‚æˆ‘ä»¬æƒ³è¦éªŒè¯ç®—æ³•çš„ç²¾åº¦å°±éœ€è¦åŒæ—¶æµ‹é‡pcå’Œdeviceå„è‡ªçš„ppmï¼Œç„¶åå†è®¡ç®—å¾—åˆ°deviceç›¸å¯¹äºpcçš„ç›¸å¯¹ppmå€¼ã€‚ ç”±äºpcçš„ppmæˆ‘ä»¬ä¸å¤ªå¥½è·å–ï¼Œå› æ­¤è¿™é‡Œé€šè¿‡æµ‹é‡ä¸¤å°deviceçš„ppmå€¼ï¼Œç„¶åç”¨æˆ‘ä»¬çš„é¢ç®—æ³•è¯„ä¼°å‡ºä¸¤ä¸ªdeviceçš„ç›¸å¯¹äºpcçš„ppmå€¼ï¼Œçœ‹ä¸¤åˆ™ä¹‹é—´çš„å·®å€¼æ˜¯å¦ç›¸åŒæ¥éªŒè¯ç®—æ³•çš„å‡†ç¡®æ€§ã€‚è¿™é‡Œé€šè¿‡é¢‘è°±ä»ªæµ‹é‡å¾—åˆ°çš„ä¸¤å°è®¾å¤‡çš„ppmå€¼åˆ†åˆ«æ˜¯ï¼š</p><p>DeviceAï¼š24.000135Mhzï¼Œppm=ï¼ˆ24.000135 - 24ï¼‰/24 * 1000000 = 5.62ppm DeviceBï¼š23.999953Mhzï¼Œppm = ï¼ˆ23.999953 - 24ï¼‰/24 * 1000000 = -1.9ppm</p><p>ä¸¤ä¸ªè®¾å¤‡çš„ppmå·®å€¼ä¸ºï¼š5.62+1.9 = 7.52ppm æˆ‘ä»¬ç®—æ³•è¯„ä¼°å¾—åˆ°çš„DeviceAç›¸å¯¹äºpcçš„ppmä¸º7.7ppmã€‚DeviceBç›¸å¯¹äºpcçš„ppmä¸º1.6ppmï¼Œä¸¤è€…ä¹‹é—´çš„å·®å€¼ä¸º6.1ppmã€‚ è¿™é‡Œç®—æ³•å¾—åˆ°çš„ppmç›¸è¾ƒäºé¢‘è°±ä»ªå¾—åˆ°çš„æ•°æ®å·®æœ‰1.42ppmã€‚ æˆ‘ä»¬æŠŠç®—æ³•çš„æ—¶é—´çº¿æ‹‰é•¿DeviceAç›¸å¯¹äºpcçš„ppmåŸºæœ¬åœ¨7.4-8.4ä¹‹é—´æ¥å›éœ‡è¡ï¼ŒDeviceBç›¸å¯¹äºpcçš„ppmåœ¨1.2-1.9ä¹‹é—´æ¥å›éœ‡è¡ï¼Œè€Œä¸”ppmå€¼ä¼šå—æ¸©åº¦éšç€æ—¶é—´çš„æ¨ç§»ä¹Ÿä¼šåœ¨ä¸€ä¸ªå°èŒƒå›´å†…æ¥å›éœ‡è¡ï¼Œå› æ­¤è¯„ä¼°çš„æ•°æ®å¯ä»¥è®¤ä¸ºç²¾åº¦åœ¨2ppmä»¥å†…ã€‚</p><h1 id="æœ€å">æœ€å</h1><p>å¦‚æœDeviceç›¸å¯¹äºpcçš„ppmåœ¨10ä»¥ä¸Šæ˜¯å¯ä»¥é‡‡å–ä¸€å®šçš„è¡¥å¿æªæ–½çš„ï¼Œå¦‚æœDeviceç›¸å¯¹äºpcçš„ppmåœ¨5ä»¥å†…ï¼Œè¡¥å¿çš„æ„ä¹‰å°±ä¸å¤§äº†ï¼Œå®¢æˆ·è½¯ä»¶å¯ä»¥é€šè¿‡è¯„ä¼°ppmå¤§å°åˆ¤æ–­ä¸‹èŒƒå›´ï¼Œå¦‚æœè¯„ä¼°å‡ºæ¥åœ¨10ä»¥ä¸Šå¯ä»¥é‡‡å–ä¸€äº›æªæ–½æ¥è¡¥å¿ppmï¼Œæ¯”å¦‚è°ƒèŠ‚clkæˆ–è€…è°ƒèŠ‚fifoã€‚ å¯¹äºA1ï¼Œç”±äºæ—¶é’Ÿåˆ†é¢‘å¯¼è‡´çš„é‡‡æ ·ç‡ä¸æ˜¯æ•´æ•°ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡asyncæœºåˆ¶æ¥è§£å†³ï¼Œppmç›¸å¯¹äºclkçš„åˆ†é¢‘ä¸å‡†ç¡®æ€§å°±å¤ªå°äº†ï¼Œæ²¡å¿…è¦è¿›è¡Œppmè¯„ä¼°ã€‚A4ã€A5åˆ†é¢‘å¾—åˆ°çš„ppmæ˜¯æ•´æ•°ï¼Œå¯ä»¥ç”¨ppm estimateæ¥è¯„ä¼°å¹¶åšä¸€å®šçš„è¡¥å¿ã€‚å½“ç„¶ç›´æ¥ç”¨asyncä¹Ÿå¯ä»¥ã€‚ä½†æ˜¯A4ã€A5ç”¨çš„CRGçš„usbæ§åˆ¶å™¨ï¼Œç«¯ç‚¹æ•°é‡åªæœ‰3å¯¹ï¼Œuac+FU+Async Feedbackå°±æŠŠ3å¯¹ç”¨å®Œäº†ï¼Œå…¶ä»–usbåŠŸèƒ½éƒ½å¾—å…³é—­äº†ã€‚éœ€è¦æ ¹æ®éœ€æ±‚æ¥å†³å®šé‡‡ç”¨å“ªç§æ–¹æ¡ˆäº†ã€‚</p><h1 id="tips">Tips</h1><p>excelä¸­æ–¹å·®å‡½æ•°ï¼šVARPA() excelä¸­æ ‡å‡†å·®å‡½æ•°ï¼šSTDEVPA()</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆä¸ƒï¼‰Async Feedback</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACASYNCFeedback/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACASYNCFeedback/</url>
      
        <content type="html"><![CDATA[<h1 id="buffer-ç»Ÿè®¡">buffer ç»Ÿè®¡</h1><p>é‡‡æ ·é—´éš” 1msã€é‡‡æ · buffer é‡Œçš„æ•°æ®é•¿åº¦ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AudioBufferUsage.png"></p><span id="more"></span><p>å¯ä»¥çœ‹åˆ°æ•´ä½“ä¸Š buffer é‡Œçš„æ•°æ®æ˜¯ä¸æ–­å¢å¤šçš„ï¼Œå°†å…¶æ”¾å¤§å¯ä»¥çœ‹ä¸‹ç»†èŠ‚ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AudioBufferUsageZoomOut.png"></p><p>ç¬¦åˆæ•°æ®å˜åŒ–è§„å¾‹ï¼Œusb ä¼šæ¯éš” 1ms å¾€ buffer é‡Œæ”¾ä¸€æ¬¡æ•°æ®ï¼Œaudiobridge ä¼šæ¯ period_size é—´éš”å°†æ•°æ®å‘ç»™ dspï¼ˆbuffer é‡Œçš„æ•°æ®ä¼šçªç„¶å‡å°‘ï¼Œè¿™é‡Œæ˜¯ 1024 ä¸ª period_sizeï¼‰ï¼Œç„¶åç”±äº tdmb çš„å®é™…é‡‡æ ·ç‡è¦ä½ä¸€äº›ï¼Œå› æ­¤æ¯éš”ä¸€æ®µæ—¶é—´ä¼šå‡ºç°åªæœ‰ usb æ•°æ®ä¼ è¾“è¿‡æ¥ï¼Œè€Œ audiobridge ä¸ä¼šå°†æ•°æ®é€åˆ° dsp çš„æƒ…å†µå‘ç”Ÿï¼Œè¿™æ ·å°±é€ æˆäº† buffer é‡Œçš„æ•°æ®ä¸æ–­ç´¯è®¡ã€‚</p><p>è¿™é‡Œå…¶å®å¯ä»¥é€šè¿‡æ¯æ¬¡åªé‡‡æ · audiobridge å‘é€å®Œæ•°æ®çš„æ—¶åˆ»çš„ buffer å¤§å°ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ•°æ®é‡‡æ ·çš„æ¬¡æ•°åŒæ—¶è¿˜èƒ½é‡‡æ ·åˆ°å±€éƒ¨æ•°æ®æœ€å°å€¼ã€‚ï¼Œå¦‚ä¸‹å›¾è¿™æ ·çš„ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AudioBufferUsageSMALL.png"></p><p>æ”¹ç”¨è¿™ç§æ–¹å¼é‡‡æ ·å¾—åˆ°çš„æ•°æ®æ›²çº¿å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AudioBufferUsageSMALLZoomout.png"></p><h1 id="async-åé¦ˆé˜ˆå€¼è®¾å®š">Async åé¦ˆé˜ˆå€¼è®¾å®š</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AsyncFeedbackWatermark.png"></p><h1 id="async-åé¦ˆ-srate-ç»™-host-åç»Ÿè®¡çš„æ•°æ®">Async åé¦ˆ srate ç»™ host åç»Ÿè®¡çš„æ•°æ®</h1><p>é€šè¿‡è®¾ç½®é˜ˆå€¼æ¥è°ƒæ•´ uac çš„ feedback é€Ÿç‡ï¼Œå¾—åˆ° buffer é‡Œçš„æ•°æ®é•¿åº¦æ›²çº¿å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AsyncFeedbackresult.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API</title>
      <link href="/2024/LinuxDriver/LinuxDriverBaseDMA-API/"/>
      <url>/2024/LinuxDriver/LinuxDriverBaseDMA-API/</url>
      
        <content type="html"><![CDATA[<h1 id="there-are-two-types-of-dma-mappings">ğŸ˜Š There are two types of DMA mappings</h1><p>Consistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that the device and the CPU can access the data in parallel and will see updates made by each other without any explicit software flushing.</p><p>Streaming DMAï¼ˆéœ€è¦è½¯ä»¶æ¥ç»´æŠ¤ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped for one DMA transfer, unmapped right after it (unless you use dma_sync_* below) and for which hardware can optimize for sequential accesses.</p><span id="more"></span><h1 id="dma-direction">ğŸ˜„ DMA Direction:</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma1.png"></p><p>The interfaces described in subsequent portions of this document take a DMA direction argument, which is an integer and takes on one of the following values:</p><ul><li>DMA_BIDIRECTIONAL</li><li>DMA_TO_DEVICE</li><li>DMA_FROM_DEVICE</li><li>DMA_NONE</li></ul><p>You should provide the exact DMA direction if you know it.</p><p>DMA_TO_DEVICE means "from main memory to the device". DMA_FROM_DEVICE means "from the device to main memory". It is the direction in which the data moves during the DMA transfer.</p><p>You are <em>strongly</em> encouraged to specify this as precisely as you possibly can.</p><p>If you absolutely cannot know the direction of the DMA transfer, specify DMA_BIDIRECTIONAL. It means that the DMA can go in either direction. The platform guarantees that you may legally specify this, and that it will work, but this may be at the cost of performance for example.</p><p>The value DMA_NONE is to be used for debugging(DMA_NONE ç”¨äºè°ƒè¯•ï¼‰. One can hold this in a data structure before you come to know the precise direction, and this will help catch cases where your direction tracking logic has failed to set things up properly.</p><p>Another advantage of specifying this value precisely (outside of potential platform-specific optimizations of such) is for debugging. Some platforms actually have a write permission boolean which DMA mappings can be marked with, much like page protections in the user program address space. Such platforms can and do report errors in the kernel logs when the DMA controller hardware detects violation of the permission setting.</p><p>Only streaming mappings specify a direction, consistent mappings implicitly have a direction attribute setting of DMA_BIDIRECTIONAL.</p><p>For Networking drivers, it's a rather simple affair. For transmit packets, map/unmap them with the DMA_TO_DEVICE direction specifier. For receive packets, just the opposite, map/unmap them with the DMA_FROM_DEVICE direction specifier.</p><h1 id="dma_sync_single_for_devicecpu-api">ğŸ˜‹ dma_sync_single_for_device/cpu API</h1><p><em>è°ƒç”¨æ ˆï¼š</em></p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dma_sync_single_for_device/cpu</span><br><span class="line">    --&gt;dma_direct_sync_single_for_device/cpu</span><br><span class="line">        --&gt;arch_sync_dma_for_device/cpu</span><br><span class="line">            --&gt;_dma_map_area/__dma_unmap_area --&gt; dcache_clean_poc/dcache_inval_poc</span><br></pre></td></tr></tbody></table></figure><h2 id="stuck_out_tongue_winking_eye-å¯¹äº-linux-upstream-ç¤¾åŒº"><span class="github-emoji"><span>ğŸ˜œ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹äº Linux upstream ç¤¾åŒº</h2><h3 id="kernel-5.x">kernel 5.x</h3><p>arch_sync_dma_for_device å…¨éƒ¨æ‰§è¡Œ clean cache arch_sync_dma_for_device å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ invalid cache</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma2.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma3.png"></p><h3 id="kernel-6.x">kernel 6.x</h3><p>åœ¨ arch_sync_dma_for_device ä¸­ direction è¢«å¿½ç•¥æ‰ï¼Œæ‰§è¡Œ dcache_clean_poc(clean cache) åœ¨ arch_sync_dma_for_cpu ä¸­ dir ä¸º DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œ dcache_inval_pocï¼ˆinvalid cacheï¼‰</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma4.png"></p><h2 id="å¯¹äº-google-ç¤¾åŒº">å¯¹äº Google ç¤¾åŒº</h2><h3 id="kernel-5.x-1">kernel 5.x</h3><p>__dma_map_area(): å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å…ˆæ‰§è¡Œä¸€ä¸ª fluah æ“ä½œï¼Œç„¶åæ‰§è¡Œ clean cacheï¼Œå¦‚æœ direction ä¸æ˜¯ DMA_FROM_DEVICE åˆ™åªæ‰§è¡Œ clean cache __dma_unmap_area(): å¦‚æœ direction ç­‰äº DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ__dma_inv_area(invalid cache) <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma5.png"></p><h3 id="kernel-6.x-1">kernel 6.x</h3><p>for_device å¿½ç•¥ directionã€å…¨éƒ¨ direction æ‰§è¡Œ clean cache for_cpu å¿½ç•¥ DMA_TO_DEVICE, å…¶ä»– direction æ‰§è¡Œ invalid cache <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/dma6.png"></p><h2 id="æ€»ç»“">æ€»ç»“</h2><h3 id="linux-upstream">Linux upstream</h3><p><em>kernel 5.x:</em></p><p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache</p><p><em>kernel 6.x:</em></p><p>åŒ kernel 5.x é€»è¾‘ä¸€è‡´ï¼Œåªæ˜¯æ”¹äº†ä¸‹ api åç§°</p><h3 id="google-ç¤¾åŒº">Google ç¤¾åŒº</h3><p><em>kernel 5.x:</em></p><p>dma_sync_single_for_deviceï¼š å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å¤šæ‰§è¡Œä¸€ä¸ª flush cacheï¼Œå…¨éƒ¨ direction éƒ½ä¼šæ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cacheï¼ˆåŒ linux upstream é€»è¾‘ä¸€è‡´ï¼‰</p><p><em>kernel 6.x:</em></p><p>åŒ linux upstream é€»è¾‘ä¸€è‡´</p><p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache</p><h1 id="qa">ğŸ¦ QA</h1><p><strong>Qï¼š</strong> åœ¨ cache å’Œ ddr ä¸­çš„æ•°æ®ä¸€è‡´åï¼ŒDMA å°† device æ•°æ®æ¬è¿åˆ° ddr åï¼ˆcache ä¸ ddr ä¸ä¸€æ ·ï¼‰å¦‚æœè°ƒç”¨ flush æ¥å£ï¼Œflush å…ˆåš clean æ“ä½œä¼šä¸ä¼šå°† cache ä¸­çš„æ•°æ®å†™å› DDR.<br><strong>Aï¼š</strong> ä¸ä¼šã€‚clean æ“ä½œæ˜¯æ£€æŸ¥ dirty æ ‡å¿—ä½ï¼Œåœ¨ç¡¬ä»¶æ”¹å†™è¿‡ç¨‹ä¸­ dirty æ ‡å¿—ä½ä¸€ç›´æ˜¯ 0ï¼ˆé dirtyï¼‰ï¼Œæ‰€ä»¥æ­¤æ—¶ flush æ“ä½œä¸­çš„ clean æ“ä½œåªæ˜¯æ£€æŸ¥ä¸€é dirty bit, ä¹‹ååš invalid æ“ä½œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">ğŸ­ å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux Documentã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I/O</title>
      <link href="/2024/LinuxDriver/LinuxDriverBaseDeviceIO/"/>
      <url>/2024/LinuxDriver/LinuxDriverBaseDeviceIO/</url>
      
        <content type="html"><![CDATA[<h1 id="memory-mapped-io">Memory Mapped IO</h1><h2 id="getting-access-to-the-device">Getting Access to the Device</h2><p>This address should not be used directly. Instead, to get an address suitable for passing to the accessor functions described below, you should call ioremap(). An address suitable for accessing the device will be returned to you.</p><p>After you've finished using the device (say, in your module's exit routine), call iounmap() in order to return the address space to the kernel. Most architectures allocate new address space each time you call ioremap(), and they can run out unless you call iounmap().</p><span id="more"></span><h2 id="accessing-the-device">Accessing the device</h2><p>The part of the interface most used by drivers is reading and writing memory-mapped registers on the device. Linux provides interfaces to read and write 8-bit, 16-bit, 32-bit and 64-bit quantities. Due to a historical accident, these are named byte, word, long and quad accesses. Both read and write accesses are supported; there is no prefetch support at this time.</p><p>The functions are named readb(), readw(), readl(), readq(), readb_relaxed(), readw_relaxed(), readl_relaxed(), readq_relaxed(), writeb(), writew(), writel() and writeq().</p><p>Some devices (such as framebuffers) would like to use larger transfers than 8 bytes at a time. For these devices, the memcpy_toio(), memcpy_fromio() and memset_io() functions are provided. Do not use memset or memcpy on IO addresses; they are not guaranteed to copy data in order.</p><p>The read and write functions are defined to be ordered. That is the compiler is not permitted to reorder the I/O sequence. When the ordering can be compiler optimised, you can use __readb() and friends to indicate the relaxed ordering. Use this with care.</p><h1 id="port-space-accesses">Port Space Accesses</h1><h2 id="port-space-explained">Port Space Explained</h2><p>Another form of IO commonly supported is Port Space. This is a range of addresses separate to the normal memory address space. Access to these addresses is generally not as fast as accesses to the memory mapped addresses, and it also has a potentially smaller address space.</p><p>Unlike memory mapped IO, no preparation is required to access port space.</p><h2 id="accessing-port-space">Accessing Port Space</h2><p>Accesses to this space are provided through a set of functions which allow 8-bit, 16-bit and 32-bit accesses; also known as byte, word and long. These functions are inb(), inw(),inl(), outb(), outw() and outl().</p><p>Some variants are provided for these functions. Some devices require that accesses to their ports are slowed down. This functionality is provided by appending a _p to the end of the function. There are also equivalents to memcpy. The ins() and outs() functions copy bytes, words or longs to the given port.</p><h1 id="iomem-pointer-tokens">__iomem pointer tokens</h1><p>The data type for an MMIO address is an __iomem qualified pointer, such as void __iomem *reg. On most architectures it is a regular pointer that points to a virtual memory address and can be offset or dereferenced, but in portable code, it must only be passed from and to functions that explicitly operated on an __iomem token, in particular the ioremap() and readl()/writel() functions. The 'sparse' semantic code checker can be used to verify that this is done correctly.</p><p>While on most architectures, ioremap() creates a page table entry for an uncached virtual address pointing to the physical MMIO address, some architectures require special instructions for MMIO, and the __iomem pointer just encodes the physical address or an offsettable cookie that is interpreted by readl()/writel().</p><h1 id="differences-between-io-access-functions">Differences between I/O access functions</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readq(), readl(), readw(), readb(), writeq(), writel(), writew(), writeb()</span><br></pre></td></tr></tbody></table></figure><p>These are the most generic accessors, providing serialization against other MMIO accesses and DMA accesses as well as fixed endianness for accessing little-endian PCI devices and on-chip peripherals. Portable device drivers should generally use these for any access to __iomem pointers.</p><p>Note that posted writes are not strictly ordered against a spinlock, see Documentation/driver-api/io_ordering.rst.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readq_relaxed(), readl_relaxed(), readw_relaxed(), readb_relaxed(),</span><br><span class="line">writeq_relaxed(), writel_relaxed(), writew_relaxed(), writeb_relaxed()</span><br></pre></td></tr></tbody></table></figure><p>On architectures that require an expensive barrier for serializing against DMA, these "relaxed" versions of the MMIO accessors only serialize against each other, but contain a less expensive barrier operation. A device driver might use these in a particularly performance sensitive fast path, with a comment that explains why the usage in a specific location is safe without the extra barriers.</p><p>See memory-barriers.txt for a more detailed discussion on the precise ordering guarantees of the non-relaxed and relaxed versions.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioread64(), ioread32(), ioread16(), ioread8(),</span><br><span class="line">iowrite64(), iowrite32(), iowrite16(), iowrite8()</span><br></pre></td></tr></tbody></table></figure><p>These are an alternative to the normal readl()/writel() functions, with almost identical behavior, but they can also operate on __iomem tokens returned for mapping PCI I/O space with pci_iomap() or ioport_map(). On architectures that require special instructions for I/O port access, this adds a small overhead for an indirect function call implemented in lib/iomap.c, while on other architectures, these are simply aliases.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioread64be(), ioread32be(), ioread16be()</span><br><span class="line">iowrite64be(), iowrite32be(), iowrite16be()</span><br></pre></td></tr></tbody></table></figure><p>These behave in the same way as the ioread32()/iowrite32() family, but with reversed byte order, for accessing devices with big-endian MMIO registers.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hi_lo_readq(), lo_hi_readq(), hi_lo_readq_relaxed(), lo_hi_readq_relaxed(),</span><br><span class="line">ioread64_lo_hi(), ioread64_hi_lo(), ioread64be_lo_hi(), ioread64be_hi_lo(),</span><br><span class="line">hi_lo_writeq(), lo_hi_writeq(), hi_lo_writeq_relaxed(), lo_hi_writeq_relaxed(),</span><br><span class="line">iowrite64_lo_hi(), iowrite64_hi_lo(), iowrite64be_lo_hi(), iowrite64be_hi_lo()</span><br></pre></td></tr></tbody></table></figure><p>Some device drivers have 64-bit registers that cannot be accessed atomically on 32-bit architectures but allow two consecutive 32-bit accesses instead. Since it depends on the particular device which of the two halves has to be accessed first, a helper is provided for each combination of 64-bit accessors with either low/high or high/low word ordering. A device driver must include either &lt;linux/io-64-nonatomic-lo-hi.h&gt; or &lt;linux/io-64-nonatomic-hi-lo.h&gt; to get the function definitions along with helpers that redirect the normal readq()/writeq() to them on architectures that do not provide 64-bit access natively.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__raw_readq(), __raw_readl(), __raw_readw(), __raw_readb(),</span><br><span class="line">__raw_writeq(), __raw_writel(), __raw_writew(), __raw_writeb()</span><br></pre></td></tr></tbody></table></figure><p>These are low-level MMIO accessors without barriers or byteorder changes and architecture specific behavior. Accesses are usually atomic in the sense that a four-byte __raw_readl() does not get split into individual byte loads, but multiple consecutive accesses can be combined on the bus. In portable code, it is only safe to use these to access memory behind a device bus but not MMIO registers, as there are no ordering guarantees with regard to other MMIO accesses or even spinlocks. The byte order is generally the same as for normal memory, so unlike the other functions, these can be used to copy data between kernel memory and device memory.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inl(), inw(), inb(), outl(), outw(), outb()</span><br></pre></td></tr></tbody></table></figure><p>PCI I/O port resources traditionally require separate helpers as they are implemented using special instructions on the x86 architecture. On most other architectures, these are mapped to readl()/writel() style accessors internally, usually pointing to a fixed area in virtual memory. Instead of an __iomem pointer, the address is a 32-bit integer token to identify a port number. PCI requires I/O port access to be non-posted, meaning that an outb() must complete before the following code executes, while a normal writeb() may still be in progress. On architectures that correctly implement this, I/O port access is therefore ordered against spinlocks. Many non-x86 PCI host bridge implementations and CPU architectures however fail to implement non-posted I/O space on PCI, so they can end up being posted on such hardware.</p><p>In some architectures, the I/O port number space has a 1:1 mapping to __iomem pointers, but this is not recommended and device drivers should not rely on that for portability. Similarly, an I/O port number as described in a PCI base address register may not correspond to the port number as seen by a device driver. Portable drivers need to read the port number for the resource provided by the kernel.</p><p>There are no direct 64-bit I/O port accessors, but pci_iomap() in combination with ioread64/iowrite64 can be used instead.</p><h1 id="device-memory-mapping-modes">Device memory mapping modes</h1><p>Some architectures support multiple modes for mapping device memory. ioremap_*() variants provide a common abstraction around these architecture-specific modes, with a shared set of semantics.</p><p>ioremap() is the most common mapping type, and is applicable to typical device memory (e.g. I/O registers). Other modes can offer weaker or stronger guarantees, if supported by the architecture. From most to least common, they are as follows:</p><h2 id="ioremap">ioremap()</h2><ul><li><p>Uncachedï¼ˆæ— ç¼“å­˜ï¼‰ï¼š</p><p>CPU-side caches are bypassed, and all reads and writes are handled directly by the device</p></li><li><p>No speculative operationsï¼ˆæ— é¢„æµ‹æ‰§è¡Œï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æ— ä¹±åºæ‰§è¡Œï¼‰ï¼š</p><p>the CPU may not issue a read or write to this memory, unless the instruction that does so has been reached in committed program flow.</p></li><li><p>No reorderingï¼ˆæ— é‡æ’åºï¼Œå¯ä»¥ç†è§£ä¸ºåŠ äº†å¼ºå†…å­˜å±éšœæŒ‡ä»¤ï¼‰ï¼š</p><p>The CPU may not reorder accesses to this memory mapping with respect to each other. On some architectures, this relies on barriers in readl_relaxed()/writel_relaxed().</p></li><li><p>No repetitionï¼š</p><p>The CPU may not issue multiple reads or writes for a single program instruction.</p></li><li><p>No write-combiningï¼ˆæ— å†™åˆå¹¶ï¼Œcache çš„ä¸€ç§ç­–ç•¥ï¼‰ï¼š</p><p>Each I/O operation results in one discrete read or write being issued to the device, and multiple writes are not combined into larger writes. This may or may not be enforced when using __raw I/O accessors or pointer dereferences.</p></li><li><p>Non-executableï¼š</p><p>The CPU is not allowed to speculate instruction execution from this memory (it probably goes without saying, but you're also not allowed to jump into device memory).</p></li></ul><h2 id="ioremap_wc">ioremap_wc()</h2><p>Maps I/O memory as normal memory with write combining. Unlike ioremap(),</p><ul><li>The CPU may speculatively issue reads from the device that the program didn't actually execute, and may choose to basically read whatever it wants.<br></li><li>The CPU may reorder operations as long as the result is consistent from the program's point of view.<br></li><li>The CPU may write to the same location multiple times, even when the program issued a single write.<br></li><li>The CPU may combine several writes into a single larger write.</li></ul><p>This mode is typically used for video framebuffers, where it can increase performance of writes. It can also be used for other blocks of memory in devices (e.g. buffers or shared memory), but care must be taken as accesses are not guaranteed to be ordered with respect to normal ioremap() MMIO register accesses without explicit barriers.</p><p>On a PCI bus, it is usually safe to use ioremap_wc() on MMIO areas marked as IORESOURCE_PREFETCH, but it may not be used on those without the flag. For on-chip devices, there is no corresponding flag, but a driver can use ioremap_wc() on a device that is known to be safe.</p><h2 id="ioremap_wt">ioremap_wt()</h2><p>Maps I/O memory as normal memory with write-through caching. Like ioremap_wc(), but also</p><p>The CPU may cache writes issued to and reads from the device, and serve reads from that cache.</p><p>This mode is sometimes used for video framebuffers, where drivers still expect writes to reach the device in a timely manner (and not be stuck in the CPU cache), but reads may be served from the cache for efficiency. However, it is rarely useful these days, as framebuffer drivers usually perform writes only, for which ioremap_wc() is more efficient (as it doesn't needlessly trash the cache). Most drivers should not use this.</p><h2 id="ioremap_np">ioremap_np()</h2><p>å°±åƒ ioremap() ä¸€æ ·ï¼Œä½†æ˜ç¡®è¯·æ±‚éå‘å¸ƒå†™è¯­ä¹‰ã€‚ioremap_np() æ˜ç¡®è¯·æ±‚éå‘å¸ƒè¯­ä¹‰ï¼Œè¿™æ„å‘³ç€å†™å…¥æŒ‡ä»¤å°†ä¸ä¼šåœ¨è®¾å¤‡æ¥æ”¶åˆ°å†™å…¥æ•°æ®ä¹‹å‰å®Œæˆã€‚è£¸çš„ ioremap_np() ä»…åœ¨æŸäº›æ¶æ„ä¸Šå¯ç”¨ï¼›åœ¨å…¶ä»–æ¶æ„ä¸Šï¼Œå®ƒå§‹ç»ˆè¿”å› NULLã€‚é©±åŠ¨ç¨‹åºé€šå¸¸ä¸åº”ä½¿ç”¨å®ƒã€‚</p><h2 id="ioremap_uc">ioremap_uc()</h2><p>å®ƒä¹Ÿå°†å†…å­˜æ ‡è®°ä¸ºéç¼“å­˜ï¼Œå¯ç§»æ¤é©±åŠ¨ç¨‹åºåº”é¿å…ä½¿ç”¨ ioremap_uc()ã€‚</p><h2 id="ioremap_cacheå°†-io-å†…å­˜å½“ä½œæ™®é€š-ram-ä½¿ç”¨æ”¯æŒ-cache">ioremap_cache()ï¼ˆå°† I/O å†…å­˜å½“ä½œæ™®é€š RAM ä½¿ç”¨ï¼Œæ”¯æŒ cacheï¼‰</h2><p>ioremap_cache() effectively maps I/O memory as normal RAM. CPU write-back caches can be used, and the CPU is free to treat the device as if it were a block of RAM.</p><h1 id="architecture-example">Architecture example</h1><p>Here is how the above modes map to memory attribute settings on the ARM64 architecture:</p><table style="width:97%;"><colgroup><col style="width: 34%"><col style="width: 62%"></colgroup><tbody><tr class="odd"><td>API</td><td>Memory region type and cacheability</td></tr><tr class="even"><td>ioremap_np()</td><td>Device-nGnRnE</td></tr><tr class="odd"><td>ioremap()</td><td>Device-nGnRE</td></tr><tr class="even"><td>ioremap_uc()</td><td>(not implemented)</td></tr><tr class="odd"><td>ioremap_wc()</td><td>Normal-Non Cacheable</td></tr><tr class="even"><td>ioremap_wt()</td><td>(not implemented; fallback to ioremap)</td></tr><tr class="odd"><td>ioremap_cache()</td><td>Normal-Write-Back Cacheable</td></tr></tbody></table><p>è¯´æ˜ï¼šARM64 å°†å†…å­˜åˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯ Device ç±»å‹ã€ä¸€ç§æ˜¯ Normal</p><p>å¯¹äº Device å†…å­˜æœ‰ï¼š</p><ul><li><p>Gathering æˆ–è€… non Gathering (G or nG)ï¼š</p><p>è¿™ä¸ªç‰¹æ€§è¡¨ç¤ºå¯¹å¤šä¸ª memory çš„è®¿é—®æ˜¯å¦å¯ä»¥åˆå¹¶ï¼Œå¦‚æœæ˜¯ nGï¼Œè¡¨ç¤ºå¤„ç†å™¨å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»£ç ä¸­å†…å­˜è®¿é—®æ¥è¿›è¡Œï¼Œä¸èƒ½æŠŠä¸¤æ¬¡è®¿é—®åˆå¹¶æˆä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼šä»£ç ä¸­æœ‰ 2 æ¬¡å¯¹åŒæ ·çš„ä¸€ä¸ªåœ°å€çš„è¯»è®¿é—®ï¼Œé‚£ä¹ˆå¤„ç†å™¨å¿…é¡»ä¸¥æ ¼è¿›è¡Œä¸¤æ¬¡ read transactionã€‚</p></li><li><p>Re-ordering (R or nR)ï¼š</p><p>è¿™ä¸ªç‰¹æ€§ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å…è®¸å¤„ç†å™¨å¯¹å†…å­˜è®¿é—®æŒ‡ä»¤è¿›è¡Œé‡æ’ã€‚nR è¡¨ç¤ºå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ program orderã€‚</p></li><li><p>Early Write Acknowledgement (E or nE)ï¼š</p><p>PE è®¿é—® memory æ˜¯æœ‰é—®æœ‰ç­”çš„ï¼ˆæ›´ä¸“ä¸šçš„æœ¯è¯­å«åš transactionï¼‰ï¼Œå¯¹äº write è€Œè¨€ï¼ŒPE éœ€è¦ write ack æ“ä½œä»¥ä¾¿ç¡®å®šå®Œæˆä¸€ä¸ª write transactionã€‚ä¸ºäº†åŠ å¿«å†™çš„é€Ÿåº¦ï¼Œç³»ç»Ÿçš„ä¸­é—´ç¯èŠ‚å¯èƒ½ä¼šè®¾å®šä¸€äº› write bufferã€‚nE è¡¨ç¤ºå†™æ“ä½œçš„ ack å¿…é¡»æ¥è‡ªæœ€ç»ˆçš„ç›®çš„åœ°è€Œä¸æ˜¯ä¸­é—´çš„ write bufferã€‚</p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux Documentã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆå…­ï¼‰UAC åŒæ­¥æ–¹å¼</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACASYNC/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACASYNC/</url>
      
        <content type="html"><![CDATA[<h1 id="åŒæ­¥é—®é¢˜åŸå› ">åŒæ­¥é—®é¢˜åŸå› </h1><h2 id="usb-isochronous-ä¼ è¾“åè®®æ— é—®é¢˜">USB Isochronous ä¼ è¾“ï¼ˆåè®®æ— é—®é¢˜ï¼‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB_Transfer.png"></p><h2 id="isochronous-transfer-åŒæ­¥é—®é¢˜">Isochronous Transfer åŒæ­¥é—®é¢˜</h2><p>ç”µè„‘æ’­æ”¾å™¨æ’­æ”¾éŸ³ä¹æ—¶ï¼šæ˜¯æŒ‰ä¸€ä¸ªå›ºå®šçš„é€Ÿç‡ï¼Œæ¯”å¦‚ 44.1KHZï¼Œç”µè„‘å†…æœ‰ä¸€ä¸ªæ™¶æŒ¯ï¼Œå¯åˆ†é¢‘å‡ºä¸€ä¸ª 44.1KHZï¼Œè¿›è¡ŒéŸ³ä¹æ’­æ”¾ï¼Œå‘ç»™ USB çš„æ•°æ®æµé€Ÿç‡å›ºå®šã€‚USB å£°å¡è‡ªå·±å¾—æœ‰ä¸€ä¸ªæ™¶æŒ¯æ‰èƒ½å·¥ä½œï¼Œå®ƒä¹Ÿå¯åˆ†é¢‘å‡ºä¸€ä¸ª 44.1KHZï¼Œä¾›ç»™ I2S ä¿¡å·æˆ– DACã€‚</p><p>é—®é¢˜æ¥äº†ï¼Œæ™¶æŒ¯æ˜¯æœ‰è¯¯å·®çš„ï¼Œè¿™ä¸¤ä¸ª 44.1KHZ ä¸å¯èƒ½å®Œå…¨ä¸€æ¨¡ä¸€æ ·ï¼Œç”µè„‘å¯èƒ½æ˜¯ 44.100KHZï¼ŒUSB å£°å¡å¯èƒ½æ˜¯ 44.098KHZï¼Œè¯¯å·®çº¦ 50ppmï¼Œå¾ˆæ­£å¸¸çš„æƒ…å†µã€‚è™½ç„¶å£°å¡æ™¶æŒ¯åˆ†é¢‘å‡ºæ¥æ˜¯ 44.098KHZï¼Œä½†å£°å¡è®¤ä¸ºå®ƒå°±æ˜¯å·¥ä½œåœ¨ 44.100KHZ ä¸‹ã€‚å¥½å§ï¼Œå¦‚æœäºŒè€…æ—¶é’Ÿç‹¬ç«‹è¿è¡Œï¼Œé‚£ä¹ˆ 1 ä¸ªå°æ—¶ä¼šè¯¯å·® 0.2 ç§’ï¼Œä¼šå‡ºç°ä¸åŒæ­¥ï¼ å³ç”µè„‘æ’­äº† 1 ä¸ªå°æ—¶çš„æ•°æ®ï¼ŒUSB å£°å¡å®é™…æ˜¯æ— æ³•æ’­å®Œçš„ï¼Œè¦å¤š 0.2 ç§’æ‰èƒ½æ’­å®Œã€‚ å¦‚æœå£°å¡ä¹Ÿè¦ 1 å°æ—¶æ’­å®Œï¼Œé‚£è¿™ 1 å°æ—¶å°±éœ€è¦ä¸¢æ‰ 0.2 ç§’çš„æ•°æ®ã€‚</p><p>æ‰€ä»¥äºŒè€…çš„æ—¶é’Ÿå¿…é¡»è¦åŒæ­¥ä¸€è‡´æ‰è¡Œï¼Œè¿™å°±æ˜¯ UAC åŒæ­¥é—®é¢˜çš„åŸå› ï¼Œå› æ­¤ USB éŸ³é¢‘è§„å®šäº†ä¸€æ˜¯é‡‡ç”¨â€œç­‰æ—¶ä¼ è¾“æ¨¡å¼â€ï¼ŒäºŒæ˜¯è®¾å¤‡éœ€è¦æŒ‡å®šä¸º 3 ç§åŒæ­¥æ–¹å¼ä¹‹ä¸€ï¼šåŒæ­¥ï¼ˆsynchronousï¼‰ï¼Œé€‚åº”ï¼ˆadaptiveï¼‰ï¼Œå¼‚æ­¥ï¼ˆasynchronousï¼‰ã€‚</p><span id="more"></span><p>ä»¥ä¸Šæ‘˜è‡ª <span class="exturl" data-url="aHR0cDovL2Jicy5lcmppLm5ldC9mb3J1bS5waHA/bW9kPXZpZXd0aHJlYWQmdGlkPTIwNzY2NzQmcGFnZT0x">http://bbs.erji.net/forum.php?mod=viewthread&amp;tid=2076674&amp;page=1<i class="fa fa-external-link-alt"></i></span></p><h1 id="usb-éŸ³é¢‘å£°å¡çš„æ—¶é’ŸåŒæ­¥æ–¹å¼">USB éŸ³é¢‘å£°å¡çš„æ—¶é’ŸåŒæ­¥æ–¹å¼</h1><h2 id="usb-çš„-isochronous-æ¨¡å¼">USB çš„ isochronous æ¨¡å¼</h2><p>USB éŸ³é¢‘å£°å¡é‡‡ç”¨ isochronousâ€œç­‰æ—¶ä¼ è¾“æ¨¡å¼â€ï¼Œèƒ½ä¿è¯å®æ—¶ä¼ è¾“æ•°æ®ï¼Œä½†é”™è¯¯å®¹å¿ï¼Œå‡ºé”™ä¸é‡ä¼ ã€‚å®ƒæ˜¯å®æ—¶ä¼ è¾“ï¼Œæ‰€ä»¥ USB ç”µè„‘ç«¯å‘å‡ºå¤šå°‘é€Ÿç‡çš„æ•°æ®ï¼ŒUSB æ¥æ”¶ç«¯ï¼ˆUSB å£°å¡ï¼‰å°±å¾—æ¥æ”¶å¤šå°‘é€Ÿç‡ã€‚æ¯”å¦‚ç”µè„‘å‘é€ 44.1KHZ çš„ï¼Œå£°å¡å°±æ¥æ”¶ 44.1KHZã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/UAC_SyncMethod.png"></p><h3 id="asynchronous">Asynchronous</h3><p>cannot synchronize to SOF or any other clock in the USB domainã€‚</p><p><em>Sourceï¼š</em> Provides implicit feedforward(data stream)ï¼ŒFree running Fs</p><p><em>Sinkï¼š</em> Provides explicit feedback (isochronous pipe)ï¼ŒFree running Fs</p><p>Asynchronous sink endpoints must provide explicit feedback information to an adaptive driver.</p><blockquote><p>Asynchronousï¼šè¦æ±‚ Sink ä¸»åŠ¨æä¾› data rate ä¿¡æ¯ï¼Œå¯¹ä¿¡æ¯å¦‚ä½•ä½¿ç”¨æ²¡åšè§„èŒƒè¦æ±‚ï¼ŒSource å’Œ Sink éƒ½å„è‡ªæŒ‰ç…§è‡ªå·±çš„é€Ÿç‡è¿è¡Œï¼ŒéŸ³é¢‘è´¨é‡æ˜¯æœ€å¥½çš„</p></blockquote><h3 id="synchronous">Synchronous</h3><p>Sourceï¼šUses implicit feedback(SOF)ï¼Œ Fs locked to SOF</p><p>Sinkï¼š Uses implicit feedback(SOF) Fs locked to SOF</p><p><em>Sourceï¼š</em> its sample clock from SOF and produces a fixed number of audio samples every USB (micro)frameï¼Œ</p><p><em>Sinkï¼š</em> its sample clock from SOF and consumes a fixed number of samples every USB (micro)frame.</p><blockquote><p>Synchronousï¼šSource å’Œ Sink éƒ½ä¸ SOF åŒæ­¥ï¼Œè¿™æ ·å¯¼è‡´ Source å’Œ Sink çš„ clk éƒ½ä¸å¤Ÿç¨³å®šï¼ŒéŸ³é¢‘è´¨é‡ä¼šå—åˆ°å½±å“ï¼Œä½†æ˜¯ Source å’Œ Sink éƒ½æ— éœ€æä¾› feedback ä¿¡æ¯ï¼Œå…¼å®¹æ€§æœ€å¥½</p></blockquote><h3 id="adaptive">Adaptive</h3><p>Sourceï¼šUses explicit feedback(isochronous pipe) ï¼ŒFs locked to sink</p><p><em>Sinkï¼š</em> Uses implicitfeedforward (data stream)ï¼Œ Fs locked to data flow</p><p><em>Sourceï¼š</em> Adaptive source endpoints produce data at a rate that is controlled by the data sinkã€‚</p><p>Sinkï¼šThe sink provides feedback to the sourceï¼Œthe data rate information is embedded in the data streamã€‚The average number of samples received during a certain averaging time determines the instantaneous data rate</p><p>conditionï¼šSink Device contains a fully adaptive sample rate converter (SRC)</p><blockquote><p>Adaptiveï¼šä½¿ç”¨ Sink æä¾›çš„ feedback ä¿¡æ¯ï¼ˆæ˜ç¡®è¦æ±‚ Sink æä¾› data rate ä¿¡æ¯ï¼‰ï¼Œè°ƒæ•´è‡ªå·±çš„ clk å¯¹é½ Sink</p></blockquote><h3 id="feedback">Feedback</h3><p><em>ASYNCï¼š</em> An asynchronous sink must provide explicit feedback to the host by indicating accurately what its desired data rate (Ff) is, relative to the USB (micro)frame frequencyã€‚This allows the host to continuously adjust the number of samples sent to the sink so that neither underflow or overflow of the data buffer occurs</p><p><em>ADAPTIVEï¼š</em> An adaptive source must receive explicit feedback from the host so that it can accurately generate the number of samples required by the host.</p><p><em>Ff:</em> the desired data rate</p><p><em>Fs:</em> actual sampling rate, è‡³å°‘éœ€è¦ 1s çš„æµ‹é‡æ—¶é—´ Tmeasï¼ˆå•ä½æ˜¯å¸§æ•°ï¼‰ã€‚å•ä½æ˜¯å¸§æ•°ï¼Œå¯¹äºå…¨é€Ÿè®¾å¤‡ 1ms ä¸€å¸§ï¼Œé‚£ä¹ˆ 1s å°±éœ€è¦ 1000 å¸§ï¼ˆFs&gt;=1000ï¼‰ï¼Œè€Œå¯¹äºé«˜é€Ÿè®¾å¤‡ï¼Œ125us ä¸€å¸§ (Fsâ‰¥8000).</p><p><em>Fmï¼š</em> é€šå¸¸ Fs æ˜¯ç”± master clock Fm åˆ†é¢‘å¾—åˆ°ï¼š</p><p><span class="math display">\[F_m = F_s * 2^P\]</span></p><p>å› æ­¤å¯ä»¥åˆ©ç”¨ Fm æ¥ç¼©çŸ­æµ‹é‡æ—¶é—´ Tmeas:</p><p><span class="math display">\[T_{meas} = \frac{2^K}{2^P} = 2^{K-P}\]</span></p><p>è¿™æ ·æµ‹é‡ Fs çš„æ—¶é—´å°±é™ä½ä¸º <span class="math inline">\(2^(K-P)\)</span> å¸§æ—¶é—´äº†ã€‚</p><p>å¯¹äºå…¨é€Ÿè®¾å¤‡ï¼ŒFs éœ€è¦ä½¿ç”¨å®šç‚¹æ•° 10.10ï¼ˆK=10ï¼‰æ ¼å¼ï¼Œéœ€è¦ 3 å­—èŠ‚ï¼Œè°ƒæ•´ä¸º 10.14 å®šç‚¹æ•°æ¥è¡¨ç¤º</p><p>å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼ŒFs éœ€è¦ä½¿ç”¨å®šç‚¹æ•° 12.13ï¼ˆK=13ï¼‰æ ¼å¼ï¼Œéœ€è¦ 4 å­—èŠ‚ï¼Œè°ƒæ•´ä¸º 16.16 å®šç‚¹æ•°æ¥è¡¨ç¤º</p><p>å¯¹ P çš„è¦æ±‚ï¼š</p><ul><li>P must be in the range [0,K]</li><li>P å°½é‡å¤§ä¸€äº›ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ Tmeas æµ‹è¯•æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å‡å°‘ç¼“å­˜å¤§å°</li><li>P åº”è¯¥å°äº Kï¼Œä¿è¯è‡³å°‘ä¸¤å¸§å–å¹³å‡æ¥å‡å°‘æŠ–åŠ¨ï¼Œæµ‹é‡æ›´å¹³æ»‘</li><li>P ä¸è¦ä¸º 0ï¼Œä¿è¯åœ¨ Ff ä¸¢å¤±çš„æƒ…å†µä¸‹å¯ä»¥ç”¨æ›´ä¸ºè¿‘çš„ Fs æ¥ä»£æ›¿ï¼Œå‡å°è¯¯å·®ç›¸é‚»æ•°æ®ç›¸ä¼¼æ€§</li></ul><h3 id="implicit-feedback">Implicit Feedback</h3><p>æœ‰äº›æ—¶å€™ï¼Œå¯ä»¥é¿å… explicit å®ç°ä¸€ä¸ª feedback endpointï¼Œå¦‚æœè®¾å¤‡å®ç°äº†ä¸€ç»„ isochronous data endpointsï¼Œä¸”ï¼š</p><ul><li>All the endpoints in the group are synchronized (i.e. use sample clocks that are derived from a common master clock)</li><li>The group contains one or more isochronous data endpoints in one direction that normally would need explicit feedback</li><li>The group contains at least one isochronous data endpoint in the opposite direction</li></ul><p>åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œè®¾å¤‡å¯ä»¥ä¸ explicit feedback endpoint.</p><p>æœ‰ä»¥ä¸‹å¯èƒ½çš„æƒ…å†µï¼š</p><ul><li>One or more asynchronous sink endpoints are accompanied by an asynchronous source endpoint. The data rate on the source endpoint can be used as implicit feedback information to adjust the data rate on the sink endpoint(s).</li><li>One or more adaptive source endpoints are accompanied by an adaptive sink endpoint. The source endpoint can adjust its data rate based on the data rate received by the sink endpoint</li></ul><h1 id="è§£å†³-5.x-ä»¥å‰çš„å†…æ ¸åœ¨-windows10-ç³»ç»Ÿä¸‹æ— æ³•è¯†åˆ«-uac2-çš„é—®é¢˜">è§£å†³ 5.x ä»¥å‰çš„å†…æ ¸åœ¨ Windows10 ç³»ç»Ÿä¸‹æ— æ³•è¯†åˆ« UAC2 çš„é—®é¢˜</h1><h2 id="uac-ç«¯ç‚¹æè¿°ç¬¦">UAC ç«¯ç‚¹æè¿°ç¬¦</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">ENDPOIN_DESCRIPTOR_STRUCT</span> </span></span><br><span class="line"><span class="class">{</span> </span><br><span class="line">    BYTE bLength;           <span class="comment">//è®¾å¤‡æè¿°ç¬¦çš„å­—èŠ‚æ•°å¤§å°ï¼Œä¸º 0x7 </span></span><br><span class="line">    BYTE bDescriptorType;   <span class="comment">//æè¿°ç¬¦ç±»å‹ç¼–å·ï¼Œä¸º 0x05</span></span><br><span class="line">    BYTE bEndpointAddress;  <span class="comment">//ç«¯ç‚¹åœ°å€åŠè¾“å…¥è¾“å‡ºå±æ€§ </span></span><br><span class="line">    BYTE bmAttribute;       <span class="comment">//ç«¯ç‚¹çš„ä¼ è¾“ç±»å‹å±æ€§ </span></span><br><span class="line">    WORD wMaxPacketSize;    <span class="comment">//ç«¯ç‚¹æ”¶ã€å‘çš„æœ€å¤§åŒ…çš„å¤§å° </span></span><br><span class="line">    BYTE bInterval;         <span class="comment">//ä¸»æœºæŸ¥è¯¢ç«¯ç‚¹çš„æ—¶é—´é—´éš” </span></span><br><span class="line">} ENDPOIN_DESCRIPTOR_STRUCT ï¼›</span><br></pre></td></tr></tbody></table></figure><ul><li>bLength : æè¿°ç¬¦å¤§å°ï¼å›ºå®šä¸º 0x07ï¼</li><li>bDescriptorType : ç«¯ç‚¹æè¿°ç¬¦ç±»å‹ï¼å›ºå®šä¸º 0x05ï¼</li><li>bEndpointAddress : USB è®¾å¤‡çš„ç«¯ç‚¹åœ°å€ï¼Bit7ï¼Œæ–¹å‘ï¼Œå¯¹äºæ§åˆ¶ç«¯ç‚¹å¯ä»¥å¿½ç•¥ï¼Œ1/0:IN/OUTï¼Bit6-4ï¼Œä¿ç•™ï¼BIt3-0ï¼šç«¯ç‚¹å·ï¼</li><li>bmAttributes : ç«¯ç‚¹å±æ€§ï¼Bit7-2ï¼Œä¿ç•™ï¼ˆåŒæ­¥æœ‰å®šä¹‰ï¼‰ï¼BIt1-0ï¼š00 æ§åˆ¶ï¼Œ01 åŒæ­¥ï¼Œ02 æ‰¹é‡ï¼Œ03 ä¸­æ–­ï¼ å½“ä¸ºåŒæ­¥ä¼ è¾“æ—¶ï¼ŒbEndpointType çš„ bit3-2 çš„å€¼ä¸åŒä»£è¡¨çš„å«ä¹‰ä¸åŒï¼š00ï¼šæ— åŒæ­¥ï¼Œ01ï¼šå¼‚æ­¥ï¼Œ10ï¼šé€‚é…ï¼Œ11ï¼šåŒæ­¥ï¼›BIT5:4 å«ä¹‰ 00: è¡¨ç¤ºæ•°æ®ç«¯ç‚¹ï¼Œ01ï¼šè¡¨ç¤ºåé¦ˆç«¯ç‚¹ Feedback endpointï¼Œ10ï¼šè¡¨ç¤ºéšå¼åé¦ˆæ•°æ®ç«¯ç‚¹ Implicit feedback Data endpointï¼Œ11: ä¿ç•™</li><li><p>wMaxPacketSize : æœ¬ç«¯ç‚¹æ¥æ”¶æˆ–å‘é€çš„æœ€å¤§ä¿¡æ¯åŒ…å¤§å°ï¼</p><ul><li><p>USB2.0 æ—¶ï¼š å¯¹äºåŒæ­¥ç«¯ç‚¹ï¼Œæ­¤å€¼ç”¨äºæŒ‡ç¤ºä¸»æœºåœ¨è°ƒåº¦ä¸­ä¿ç•™çš„æ€»çº¿æ—¶é—´ï¼Œè¿™æ˜¯æ¯ï¼ˆå¾®ï¼‰å¸§æ•°æ®æœ‰æ•ˆè´Ÿè½½æ‰€éœ€çš„æ—¶é—´ï¼Œæœ‰æ•ˆè´Ÿè½½æ—¶é—´å°±æ˜¯å‘é€ä¸€å¸§æ•°æ®éœ€è¦å ç”¨çš„æ€»çº¿æ—¶é—´ï¼Œåœ¨å®é™…æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œç®¡é“å®é™…ä½¿ç”¨çš„å¸¦å®½å¯èƒ½æ¯”ä¿ç•™çš„å¸¦å®½å°‘ï¼Œå¤§å®¶æƒ³æƒ³ï¼Œå¦‚æœå®é™…ä½¿ç”¨çš„å¸¦å®½æ¯”ä¿ç•™çš„è¿˜å¤šï¼Œé‚£å°±ä¸¢æ•°äº†ï¼›</p><p>å¯¹äºå…¶ç±»å‹çš„ç«¯ç‚¹ï¼Œbit10~bit0 æŒ‡å®šæœ€å¤§æ•°æ®åŒ…å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼›</p><p>bit12~bit11 å¯¹äºé«˜é€Ÿä¼ è¾“çš„åŒæ­¥å’Œä¸­æ–­ç«¯ç‚¹æœ‰æ•ˆï¼šbit12~bit11 å¯æŒ‡å®šæ¯ä¸ªå¾®å¸§çš„é¢å¤–é€šä¿¡æ¬¡æ•°ï¼Œè¿™é‡Œå¤§å®¶ä¸€å®šè¦çŸ¥é“æ˜¯åœ¨é«˜é€Ÿä¼ è¾“ä¸­ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡è¶…æ—¶æ—¶ï¼Œåœ¨ä¸€ä¸ªå¾®å¸§æ—¶é—´å†…é‡ä¼ çš„æ¬¡æ•°ï¼Œå¦‚æœè®¾ç½®ä¸º 00bï¼ˆNoneï¼‰ï¼Œåˆ™è¡¨ç¤ºåœ¨ä¸€ä¸ªå¾®å¸§å†…åªä¼ è¾“ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸è¿›è¡Œé¢å¤–çš„è¶…æ—¶é‡ä¼ ï¼Œå¦‚æœè®¾ç½®ä¸º 01bï¼Œåˆ™è¡¨ç¤ºåœ¨ä¸€ä¸ªå¾®å¸§å†…å¯ä»¥ä¼ è¾“ä¸¤æ¬¡äº‹åŠ¡ï¼Œæœ‰ä¸€æ¬¡é¢å¤–çš„é‡ä¼ æœºä¼šï¼Œä»ä¸‹é¢å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªå¾®å¸§æœ€å¤šå¯ä»¥æœ‰ä¸¤æ¬¡é‡ä¼ äº‹åŠ¡çš„æœºä¼šï¼Œå¦‚æœå¾®å¸§ç»“æŸäº†è¿˜æ˜¯å¤±è´¥ï¼Œå°±éœ€è¦ç­‰åˆ°ä¸‹ä¸€ä¸ªå¾®å¸§ç»§ç»­å‘é€è¯¥äº‹åŠ¡ï¼›</p></li><li><p>USB3.0 æ—¶ï¼š wMaxPacketSize è¡¨ç¤ºåŒ…çš„å¤§å°ã€‚å¯¹äº bulk ä¸º 1024ï¼Œè€Œå¯¹äºåŒæ­¥ä¼ è¾“ï¼Œå¯ä»¥ä¸º 0~1024 æˆ– 1024ã€‚</p></li></ul></li><li>bInterval : è½®è¯¢æ•°æ®ä¼ é€ç«¯ç‚¹çš„æ—¶é—´é—´éš”ï¼å¯¹äºæ‰¹é‡ä¼ é€å’Œæ§åˆ¶ä¼ é€çš„ç«¯ç‚¹å¿½ç•¥ï¼å¯¹äºåŒæ­¥ä¼ é€çš„ç«¯ç‚¹ï¼Œå¿…é¡»ä¸ºï¼‘ï¼Œå¯¹äºä¸­æ–­ä¼ é€çš„ç«¯ç‚¹ï¼ŒèŒƒå›´ä¸º 1-255ï¼<ul><li>å¯¹äºå…¨é€Ÿ/é«˜é€ŸåŒæ­¥ç«¯ç‚¹ï¼Œæ­¤å€¼å¿…é¡»åœ¨ 1 åˆ° 16 ä¹‹é—´ã€‚bInterval å€¼ç”¨ä½œ 2 çš„æŒ‡æ•°ï¼Œä¾‹å¦‚ bInterval ä¸º 4ï¼Œè¡¨ç¤ºå‘¨æœŸä¸º 8 ä¸ªå•ä½ï¼›</li><li>å¯¹äºå…¨é€Ÿ/ä½é€Ÿä¸­æ–­ç«¯ç‚¹ï¼Œè¯¥å­—æ®µçš„å€¼å¯ä»¥æ˜¯ 1 åˆ° 255ï¼Œä¹Ÿå°±æ˜¯ä¸»æœºå¤šå°‘ ms ç»™è®¾å¤‡å‘ä¸€æ¬¡æ•°æ®è¯·æ±‚ï¼›</li><li>å¯¹äºé«˜é€Ÿä¸­æ–­ç«¯ç‚¹ï¼Œä½¿ç”¨ bInterval å€¼ä½œä¸º 2 çš„æŒ‡æ•°ï¼Œä¾‹å¦‚ bInterval ä¸º 4 è¡¨ç¤ºå‘¨æœŸä¸º 8ã€‚è¿™ä¸ªå€¼å¿…é¡»åœ¨ 1 åˆ° 16 ä¹‹é—´ï¼›</li><li>å¯¹äºé«˜é€Ÿæ‰¹é‡/æ§åˆ¶è¾“å‡ºç«¯ç‚¹ï¼ŒbInterval å¿…é¡»æŒ‡å®šç«¯ç‚¹çš„æœ€å¤§ NAK é€Ÿç‡ã€‚å€¼ 0 è¡¨ç¤ºç«¯ç‚¹æ°¸ä¸ NAKã€‚å…¶å®ƒå€¼è¡¨ç¤ºæ¯ä¸ªå¾®å¸§çš„ bInterval*125us æ—¶é—´æœ€å¤š 1 ä¸ª NAKã€‚è¿™ä¸ªå€¼çš„èŒƒå›´å¿…é¡»åœ¨ 0 åˆ° 255 ä¹‹é—´ï¼›<ul><li>00 = None (1 transaction per microframe)</li><li>01 = 1 additional (2 per microframe)</li><li>10 = 2 additional (3 per microframe)</li><li>11 = Reserved</li><li>å…¶å®ƒä½é»˜è®¤ä¸º 0ï¼Œ</li></ul></li><li>å¯¹äºå…¨é€Ÿ/ä½é€Ÿæ‰¹é‡/æ§åˆ¶è¾“å‡ºç«¯ç‚¹ï¼Œæ­¤å€¼æ— æ„ä¹‰ï¼Œå¯ä»¥ä»»æ„æŒ‡å®šã€‚</li></ul></li></ul><p>ä»¥ fs_epout_desc ä¸ºä¾‹æè¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* STD AS ISO OUT Endpoint */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_endpoint_descriptor</span> <span class="title">fs_epout_desc</span> =</span> {</span><br><span class="line">  .bLength = USB_DT_ENDPOINT_SIZE,    <span class="comment">//#define USB_DT_ENDPOINT_SIZE7</span></span><br><span class="line">  .bDescriptorType = USB_DT_ENDPOINT, <span class="comment">//#define USB_DT_ENDPOINT0x05</span></span><br><span class="line"></span><br><span class="line">  .bEndpointAddress = USB_DIR_OUT,    <span class="comment">// #define USB_DIR_OUT0/* to device */</span></span><br><span class="line">  <span class="comment">// #define USB_ENDPOINT_XFER_ISOC1 /* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line">    <span class="comment">// #define USB_ENDPOINT_SYNC_ADAPTIVE(2 &lt;&lt; 2) /* é€‚é… */</span></span><br><span class="line">  .bmAttributes = USB_ENDPOINT_XFER_ISOC | USB_ENDPOINT_SYNC_ADAPTIVE, </span><br><span class="line">  <span class="comment">/* The USB limits the maximum data payload size to 1,023 bytes for each full-speed isochronous endpoint.</span></span><br><span class="line"><span class="comment">High-speed endpoints are allowed up to 1024-byte data payloads. */</span></span><br><span class="line">  .wMaxPacketSize = cpu_to_le16(<span class="number">1023</span>),</span><br><span class="line">  .bInterval = <span class="number">1</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><em>IN å’Œ OUT éƒ½æ˜¯ç›¸å¯¹äº USB Host è®¾å¤‡æ¥è®²çš„ï¼š</em></p><p><strong>å¯¹äº OUT Endpoint ä¸æ”¯æŒ ASYNC åšå¦‚ä¸‹è¯´æ˜ï¼š</strong></p><ul><li>ASYNC æ¨¡å¼ä¸‹éœ€è¦ Sink è®¾å¤‡ Provides explicit feedbackï¼Œè€Œå¯¹äº OUT Endpointï¼ŒSink è®¾å¤‡æ˜¯æˆ‘ä»¬çš„ä¸»æœºï¼Œè¿™è¯´æ˜æˆ‘ä»¬çš„è®¾å¤‡ä¸æ”¯æŒ feedback</li></ul><p><strong>å¯¹äº IN EndPointï¼Œæµ‹è¯•å‘ç°æ”¯æŒ ASYNC åšå¦‚ä¸‹è¯´æ˜ï¼š</strong></p><ul><li>ASYNC æ¨¡å¼ä¸‹éœ€è¦ Sink è®¾å¤‡ Provides explicit feedbackï¼Œè€Œå¯¹äº IN Endpointï¼ŒSink è®¾å¤‡æ˜¯æµ‹è¯•çš„ Windows10 ç³»ç»Ÿï¼Œè¯´æ˜ Windows10ï¼ˆåŸºäºæˆ‘çš„æµ‹è¯•ç‰ˆæœ¬ï¼‰æ˜¯æ”¯æŒ feedback</li></ul><p><em>ç»“è®ºï¼š</em><br>Windows çš„ UAC2 æ˜¯æ”¯æŒ Feedback çš„ï¼Œè€Œæˆ‘ä»¬çš„ç³»ç»Ÿä¸æ”¯æŒï¼Œé‚£ä¹ˆå°† OUT Endpoint æ”¹æˆ ADAPTIVE æ¨¡å¼ç¬¦åˆ USB isochronous ä¼ è¾“è§„èŒƒï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬è®¾å¤‡æ²¡æœ‰å®ç° feedbackï¼Œæœ‰æ²¡æœ‰åˆ©ç”¨åˆ° Host æä¾›çš„ feedback ä¿¡æ¯å¾…éªŒè¯ã€‚åŒç† OUT Endpoint æ”¹æˆ ADAPTIVE æ¨¡å¼ï¼Œé‚£ä¹ˆ IN EndPoint å°±å¯ä»¥ä¿æŒä¸º ASYNCï¼Œå› ä¸ºè¿™éƒ½è¦æ±‚ Host ç«¯æä¾› feedbackã€‚å½“ç„¶å…¨éƒ¨æ”¹æˆ SYNC æ¨¡å¼ä¹Ÿå¯ä»¥è·å¾—å¾ˆå¥½çš„å…¼å®¹æ€§ï¼Œä½†æ˜¯ä¼šé€ æˆ Source å’Œ Sink çš„ clk æŠ–åŠ¨ã€‚ è¿˜æœ‰å¦å¤–ä¸€ç§åšæ³•ï¼Œæˆ‘çœ‹åˆ° Linux6.x é©±åŠ¨é‡Œå·²ç»æ”¯æŒ feedback äº†ï¼Œç§»æ¤è¿‡æ¥ Device ç«¯å°±æ”¯æŒä¸‰ç§åŒæ­¥æ–¹å¼äº†ã€‚</p><p>fs_epout_desc ç«¯ç‚¹ä¼šç”± USB_ENDPOINT_SYNC_ASYNC æ”¹æˆ USB_ENDPOINT_SYNC_ADAPTIVEï¼Œæœ€æ–°çš„ 6.x å†…æ ¸ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ feedback æ¥å†³å®šç”¨å“ªä¸ªåŒæ­¥æ¨¡å¼ï¼Œå¦‚æœæ”¯æŒ feedback å°±ç”¨ USB_ENDPOINT_SYNC_ASYNCï¼Œå¦‚æœä¸æ”¯æŒ feedback å°±ç”¨ USB_ENDPOINT_SYNC_ADAPTIVEã€‚å®é™…ä¸Šç”¨ USB_ENDPOINT_SYNC_SYNC ä¹Ÿèƒ½å¤Ÿåœ¨ windows ä¸Šè¯†åˆ«ã€‚ fs_epin_desc ç«¯ç‚¹ï¼šç”± USB_ENDPOINT_SYNC_ASYNC æ”¹æˆ USB_ENDPOINT_SYNC_SYNCã€‚</p><h1 id="æ€»ç»“">æ€»ç»“</h1><table><colgroup><col style="width: 25%"><col style="width: 25%"><col style="width: 25%"><col style="width: 25%"></colgroup><thead><tr class="header"><th></th><th>å®ç°æ–¹å¼</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr class="odd"><td>SYNC</td><td>Source å’Œ Sink å„è‡ªè¿è¡Œåœ¨è‡ªå·±çš„ Clock ä¸‹ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰ä»»ä½•åé¦ˆï¼ŒSource åªç®¡å‘ï¼ŒSink åªç®¡æ”¶</td><td>ç®€å•</td><td>è¿è¡Œæ—¶é—´ä¹…äº†ç”±äºä¸¤åˆ™çš„ clock ä¸åŒ¹é…ä¼šå¯¼è‡´ hw buffer æº¢å‡ºæˆ–è€…ä¸ºç©ºå¯¼è‡´ xrun é—®é¢˜</td></tr><tr class="even"><td>ADAPTIVE</td><td>Source æä¾›è‡ªå·±çš„ srate ä¿¡æ¯ç»™ Sinkï¼ŒSink å¯ä»¥è‡ªå·±è°ƒèŠ‚ Clock æˆ–è€…å…¶ä»–æ–¹å¼åŒ¹é… Source çš„ Clock</td><td>æä¾›äº†ä¸€ç§åŒ¹é… Clock çš„æ–¹å¼ï¼Œå¯ä»¥è§£å†³ xrun é—®é¢˜äº†</td><td>ç”±äº Source ç«¯å‘é€é¢‘ç‡å’Œå¤§å°å›ºå®šï¼Œåªèƒ½ Device ç«¯é è°ƒèŠ‚ Clock æ¥è§£å†³ xrunï¼Œè°ƒèŠ‚ clock ä¼šå½±å“éŸ³è´¨</td></tr><tr class="odd"><td>ASYNC</td><td>Sink æä¾›è‡ªå·±çš„ srate ç»™ Sourceï¼ŒSource é€šè¿‡è°ƒèŠ‚æ¯ä¸ª USB åŒ…å¤§å°æ¥åŒ¹é… Sink çš„ Clock</td><td>æä¾›äº†åŒ¹é… clock çš„æ–¹å¼ï¼Œè§£å†³äº† xrun é—®é¢˜</td><td></td></tr><tr class="even"><td>Sink ä¸éœ€è¦è°ƒèŠ‚ clockï¼ŒéŸ³è´¨ä¸ä¼šå—åˆ°ä»»ä½•å½±å“ï¼Œå®Œç¾</td><td>æ— </td><td></td><td></td></tr></tbody></table><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆäº”ï¼‰Feature Unit</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACFU/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACFU/</url>
      
        <content type="html"><![CDATA[<h1 id="éŸ³é‡åŸºæœ¬æ¦‚å¿µ">éŸ³é‡åŸºæœ¬æ¦‚å¿µ</h1><h3 id="å£°å­¦ä¸­çš„åˆ†è´"><strong>å£°å­¦ä¸­çš„åˆ†è´</strong></h3><p>å› ä¸ºäººè€³çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯¹å£°éŸ³çš„å¤§å°æ„ŸçŸ¥å‘ˆå¯¹æ•°å…³ç³»ã€‚æ‰€ä»¥æˆ‘ä»¬é€šå¸¸ç”¨åˆ†è´æè¿°å£°éŸ³å¤§å°ï¼Œåˆ†è´ï¼ˆdecibelï¼‰æ˜¯é‡åº¦ä¸¤ä¸ªç›¸åŒå•ä½ä¹‹æ•°é‡æ¯”ä¾‹çš„å•ä½ï¼Œä¸»è¦ç”¨äºåº¦é‡å£°éŸ³å¼ºåº¦ï¼Œå¸¸ç”¨ dB è¡¨ç¤ºã€‚å£°å­¦ä¸­ï¼Œå£°éŸ³çš„å¼ºåº¦å®šä¹‰ä¸ºå£°å‹ã€‚è®¡ç®—åˆ†è´å€¼æ—¶é‡‡ç”¨ 20 å¾®å¸•æ–¯å¡ä¸ºå‚è€ƒå€¼ï¼ˆé€šå¸¸è¢«è®¤ä¸ºæ˜¯äººç±»çš„æœ€å°‘å¬è§‰å“åº”å€¼ï¼Œå¤§çº¦æ˜¯ 3 ç±³ä»¥å¤–é£è¡Œçš„èšŠå­å£°éŸ³ï¼‰ã€‚è¿™ä¸€å‚è€ƒå€¼æ˜¯äººç±»å¯¹å£°éŸ³èƒ½å¤Ÿæ„ŸçŸ¥çš„ <span class="exturl" data-url="aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/cT0lRTklOTglODglRTUlODAlQkMmc3BtPTEwMDEuMjEwMS4zMDAxLjcwMjA=">é˜ˆå€¼<i class="fa fa-external-link-alt"></i></span> ä¸‹é™ã€‚å£°å‹æ˜¯åœºé‡ï¼Œå› æ­¤ä½¿ç”¨å£°å‹è®¡ç®—åˆ†è´æ—¶ä½¿ç”¨ä¸‹è¿°ç‰ˆæœ¬çš„å…¬å¼ï¼š</p><p><span class="math display">\[L_p = 20log_{10}(\frac{p_{rms}}{p_{ref}})dB\]</span></p><p>å…¶ä¸­çš„ pref æ˜¯æ ‡å‡†å‚è€ƒå£°å‹å€¼ 20 å¾®å¸•ã€‚</p><h3 id="åˆ†è´å£°éŸ³å˜åŒ–èŒƒå›´"><strong>åˆ†è´å£°éŸ³å˜åŒ–èŒƒå›´</strong></h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—ä¸¤ä¸ªå£°éŸ³ä¹‹é—´çš„åŠ¨æ€èŒƒå›´ï¼Œå•ä½ä¸ºåˆ†è´ï¼š</p><p><span class="math display">\[dB = 20 * log(A1 / A2)\]</span></p><p>å…¶ä¸­ A1 å’Œ A2 æ˜¯ä¸¤ä¸ªå£°éŸ³çš„æŒ¯å¹…ï¼Œåœ¨ç¨‹åºä¸­è¡¨ç¤ºæ¯ä¸ªå£°éŸ³æ ·æœ¬çš„å¤§å°ã€‚å£°éŸ³é‡‡æ ·å¤§å°ï¼ˆä¹Ÿå°±æ˜¯é‡åŒ–æ·±åº¦ï¼‰ä¸º 1bit æ—¶ï¼ŒåŠ¨æ€èŒƒå›´ä¸º 0ï¼Œå› ä¸ºåªå¯èƒ½æœ‰ä¸€ä¸ªæŒ¯å¹…ã€‚é‡‡æ ·å¤§å°ä¸º 8bit ä¹Ÿå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œæœ€å¤§æŒ¯å¹…æ˜¯æœ€å°æŒ¯å¹…çš„ 256 å€ã€‚å› æ­¤ï¼ŒåŠ¨æ€èŒƒå›´æ˜¯ 48 åˆ†è´ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[dB = 20 * log(256)\]</span></p><p>48 åˆ†è´çš„åŠ¨æ€èŒƒå›´å¤§çº¦æ˜¯ä¸€ä¸ªå®‰é™æˆ¿é—´å’Œä¸€å°è¿è¡Œç€ç”µåŠ¨å‰²è‰æœºä¹‹é—´çš„åŒºåˆ«ã€‚å¦‚æœå°†å£°éŸ³é‡‡æ ·å¤§å°å¢åŠ ä¸€å€åˆ° 16bitï¼Œäº§ç”Ÿçš„åŠ¨æ€èŒƒå›´åˆ™ä¸º 96 åˆ†è´ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[dB = 20 * log(65536)\]</span></p><p>è¿™éå¸¸æ¥è¿‘å¬åŠ›æœ€ä½é˜ˆå€¼å’Œäº§ç”Ÿç—›æ„Ÿä¹‹é—´çš„åŒºåˆ«ï¼Œè¿™ä¸ªèŒƒå›´è¢«è®¤ä¸ºéå¸¸é€‚åˆè¿˜åŸéŸ³ä¹ã€‚</p><p><strong>éŸ³é‡æ»‘å—ä¸å£°éŸ³å¢å¹…å¤§å°çº¿æ€§å˜åŒ–</strong></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/fu1.png"></p><span id="more"></span><p>ä¸Šè¿°å·¦å›¾ä¸­ï¼ŒéŸ³é‡æ»‘å—ä½ç½®ä¸å£°éŸ³æŒ¯å¹…ä¸ºçº¿æ€§å¢é•¿å…³ç³»ï¼Œå³å›¾æ˜¯æˆ‘ä»¬äººè€³æ„Ÿå—çš„éŸ³é‡å¤§å°ä¸æ»‘å—ä½ç½®å…³ç³»ã€‚å¯çŸ¥ï¼Œåœ¨å·¦ä¾§ç§»åŠ¨ç›¸åŒè·ç¦»çš„æ»‘å—ï¼Œæ„ŸçŸ¥åˆ°çš„å£°éŸ³å˜åŒ–èŒƒå›´å¾ˆå¤§ï¼Œåœ¨å³ä¾§æ¥è¿‘å£°éŸ³æœ€å¤§å€¼ç§»åŠ¨ç›¸åŒè·ç¦»æ»‘å—ï¼Œæ„ŸçŸ¥åˆ°çš„å£°éŸ³å¤§å°å˜åŒ–å°±å¾ˆå°äº†ã€‚</p><h2 id="windows-éŸ³é‡æ»‘å—ä¸å£°éŸ³-db-è½¬æ¢å…³ç³»">Windows éŸ³é‡æ»‘å—ä¸å£°éŸ³ DB è½¬æ¢å…³ç³»</h2><p>å¯å‚è€ƒå¦‚ä¸‹é“¾æ¥ï¼š</p><p><span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL3dpbmRvd3MtaGFyZHdhcmUvZHJpdmVycy9hdWRpby9kZWZhdWx0LWF1ZGlvLXZvbHVtZS1zZXR0aW5ncw==">é»˜è®¤çš„éŸ³é¢‘éŸ³é‡è®¾ç½® - Windows drivers<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/fu2.png"></p><p>Linux ä¸­é»˜è®¤çš„é…ç½®æ˜¯-100db åˆ° 0dbï¼Œè€Œ windows ä¸­çš„éŸ³é‡èŒƒå›´å¯¹åº”çš„æ˜¯-96db-0dbï¼ˆDevice æ”¶åˆ°çš„ volume å°†æ˜¯-96db-0db è€Œä¸ä¼šæ”¶åˆ°-100dbï¼‰ï¼Œè€Œç”¨æˆ·å¯è°ƒçš„æ»‘å—æ˜¯ä» 0-100 çš„èŒƒå›´å€¼ã€‚å®æµ‹ UAC ä¸­è°ƒèŠ‚æ»‘å—å‘é€ç»™ Device çš„éŸ³é‡å€¼å¦‚ä¸‹ï¼ˆå•ä½æ˜¯åˆ†è´ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/fu3.png"></p><h1 id="feature-åŠŸèƒ½å®ç°"><strong>Feature åŠŸèƒ½å®ç°</strong></h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/fu4.png"></p><p>çº¢è‰²æ¡†ä¸­å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„å†…å®¹ï¼ŒUAC Spec é‡Œè¯´æ˜äº†é€šè¿‡æè¿°ç¬¦æ¥è¡¨ç¤ºä¸€ä¸ª Function Tologry å…³ç³»ï¼Œåªè¦åˆ©ç”¨æè¿°ç¬¦å°†è¿™ä¸ªå…³ç³»æè¿°æ¸…æ¥šï¼ŒHost ç«¯å°±çŸ¥é“ Device æ”¯æŒ Feature Unitï¼Œé‚£ä¹ˆ Host åœ¨è°ƒèŠ‚éŸ³é‡çš„æ—¶å€™å°±ä¼šé€šè¿‡ Request æ¥å£è¯·æ±‚è·å¾—è®¾å¤‡çš„ volume å’Œ mute ä»¥åŠé€šè¿‡ Setup æ¥å£æ¥è®¾ç½® Volume å’Œ Muteã€‚è¿™ä¸ªå…³ç³»çš„æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AMLOGIC_MODIFY</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USB_CONFIGFS_UAC_FEATURE_UNIT</span></span><br><span class="line"><span class="keyword">if</span> (FUIN_EN(opts)) {</span><br><span class="line">usb_in_ot_desc.bSourceID = in_feature_unit_desc-&gt;bUnitID;</span><br><span class="line">in_feature_unit_desc-&gt;bSourceID = io_in_it_desc.bTerminalID;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">usb_in_ot_desc.bSourceID = io_in_it_desc.bTerminalID;</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">usb_in_ot_desc.bSourceID = io_in_it_desc.bTerminalID;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AMLOGIC_MODIFY</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USB_CONFIGFS_UAC_FEATURE_UNIT</span></span><br><span class="line"><span class="keyword">if</span> (FUOUT_EN(opts)) {</span><br><span class="line">io_out_ot_desc.bSourceID = out_feature_unit_desc-&gt;bUnitID;</span><br><span class="line">out_feature_unit_desc-&gt;bSourceID = usb_out_it_desc.bTerminalID;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">io_out_ot_desc.bSourceID = usb_out_it_desc.bTerminalID;</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">io_out_ot_desc.bSourceID = usb_out_it_desc.bTerminalID;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç®€å•æè¿°ä¸€ä¸‹å°±æ˜¯å°† feature unit æè¿°ç¬¦æ’å…¥ Input Terminalï¼ˆITï¼‰å’Œ Output Terminalï¼ˆOTï¼‰ä¹‹é—´ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">as_in_hdr_desc</span><br><span class="line">|</span><br><span class="line">io_in_it_desc -&gt; in_feature_unit_desc -&gt; usb_in_ot_desc</span><br><span class="line">usb_out_it_desc -&gt; out_feature_unit_desc -&gt; io_out_ot_desc</span><br><span class="line">|</span><br><span class="line">as_out_hdr_desc</span><br></pre></td></tr></tbody></table></figure><p>ç„¶ååªéœ€è¦åœ¨ usb function é‡Œçš„ setup å›è°ƒé‡Œè¯†åˆ« bRequestType å’Œ bRequest æ¥åˆ¤æ–­æ˜¯è®¾ç½®é‡‡æ ·ç‡è¿˜æ˜¯è®¾ç½® mute æˆ–è€…æ˜¯è®¾ç½® volume æ¥åšç›¸åº”çš„å¤„ç†ï¼ˆå­˜å‚¨ volume å€¼å’Œé€šè¿‡ snd_ctl_notify é€šçŸ¥ alsa çš„ kcontrol volume ä»¥åŠå‘ç”Ÿå˜åŒ–ï¼‰å°±å¯ä»¥äº†ã€‚</p><p>åŒæ—¶å¦‚æœ device è¦ä¸»åŠ¨é€šçŸ¥ Host ç«¯ Attributes å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦å®ç°ä¸€ä¸ª interrupt endpointï¼Œç„¶åé€šè¿‡è¿™ä¸ªä¸­æ–­ç«¯ç‚¹é€šçŸ¥ Host å˜åŒ–ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">w_index = unit_id &lt;&lt; <span class="number">8</span> | uac2-&gt;ac_intf;</span><br><span class="line">w_value = cs &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">msg-&gt;bInfo = <span class="number">0</span>; <span class="comment">/* Non-vendor, interface interrupt */</span></span><br><span class="line">msg-&gt;bAttribute = UAC2_CS_CUR;</span><br><span class="line">msg-&gt;wIndex = cpu_to_le16(w_index);</span><br><span class="line">msg-&gt;wValue = cpu_to_le16(w_value);</span><br><span class="line"></span><br><span class="line">req-&gt;length = <span class="keyword">sizeof</span>(*msg);</span><br><span class="line">req-&gt;buf = msg;</span><br><span class="line">req-&gt;context = agdev;</span><br><span class="line">req-&gt;complete = afunc_notify_complete;</span><br><span class="line"></span><br><span class="line">ret = usb_ep_queue(uac2-&gt;int_ep, req, GFP_ATOMIC);</span><br></pre></td></tr></tbody></table></figure><h1 id="feature-unit-vs-hid">Feature Unit VS HID</h1><h3 id="binding-between-physical-buttons-and-audio-controls"><strong>Binding between Physical Buttons and Audio Controls</strong></h3><p>å¤§å¤šæ•°åŒ…å«éŸ³é¢‘åŠŸèƒ½çš„è®¾å¤‡ä¹Ÿä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª frontpanel buttonsï¼Œç”¨äºæ§åˆ¶è®¾å¤‡å†…æŸäº›æ–¹é¢çš„éŸ³é¢‘åŠŸèƒ½ã€‚æœ€æ˜æ˜¾çš„ä¾‹å­æ˜¯å¤šåª’ä½“æ‰¬å£°å™¨å‰é¢çš„éŸ³é‡æ§åˆ¶æŒ‰é’®ã€‚ç”±äºéŸ³é¢‘åŠŸèƒ½å¯èƒ½åŒ…å«è®¸å¤šç›¸åŒç±»å‹çš„éŸ³é¢‘æ§ä»¶ï¼Œå› æ­¤éœ€è¦å°†ç‰©ç†æ§ä»¶ï¼ˆæŒ‰é’®ã€æ—‹é’®ã€æ»‘å—ã€ç‚¹åŠ¨ç­‰ï¼‰ç»‘å®šåˆ°éŸ³é¢‘åŠŸèƒ½ä¸­çš„ç‰¹å®šéŸ³é¢‘æ§ä»¶ã€‚ æœ¬è§„èŒƒæä¾›äº†ä¸¤ç§äº’æ–¥çš„æ–¹æ³•æ¥æä¾›è¿™ç§ç»‘å®šï¼š</p><ul><li>ç‰©ç†æŒ‰é’®å®ç°ä¸º HID æ§ä»¶</li><li>ç‰©ç†æŒ‰é’®æ˜¯éŸ³é¢‘æ§åˆ¶çš„é›†æˆéƒ¨åˆ†</li></ul><p>ç¦æ­¢å¯¹åŒä¸€ä¸ªç‰©ç†æŒ‰é’®å®ç°è¿™ä¸¤ç§æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå…è®¸å¯¹æŸäº› frontpanel buttons ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå¯¹å…¶ä½™ frontpanel buttons ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚å¼ºçƒˆå»ºè®®ä¸ä½¿ç”¨ä¸Šè¿°ä¸¤ç§æ–¹æ³•å®ç°å‰é¢æ¿æŒ‰é’®ï¼Œå³å¯¹ä¸»æœºè½¯ä»¶ä¸å¯è§ä¸”ä»…å…·æœ‰å±€éƒ¨æ•ˆæœçš„æŒ‰é’®ã€‚</p><h3 id="physical-button-is-a-hid-control"><strong>Physical button is a HID Control</strong></h3><p>HID æ˜¯ USB è®¾å¤‡ä¸­çš„ä¸€ç§è®¾å¤‡ç±»å‹ï¼Œä»–ä¸ UAC ä¹‹é—´å¹¶æ²¡æœ‰ç›´æ¥çš„å…³è”æ€§ï¼Œä¸¤è€…æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œåªæ˜¯ HID è®¾å¤‡åŒ…æ‹¬é¼ æ ‡ã€é”®ç›˜ã€é¥æ†ç­‰å…·æœ‰é€šè¿‡ USB æ§åˆ¶ host çš„å£°éŸ³çš„è®¾å¤‡ï¼Œå¯ä»¥é€šè¿‡å®ç°è¿™äº›è®¾å¤‡çš„æè¿°ç¬¦å®ç°å¯¹ host çš„éŸ³é‡æ§åˆ¶ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨æ¥æ§åˆ¶ UAC çš„éŸ³é‡ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç‰©ç†æŒ‰é”®ä¸éŸ³é¢‘åŠŸèƒ½å®Œå…¨åˆ†ç¦»ï¼Œå¹¶åœ¨è®¾å¤‡çš„ HID æ¥å£å†…å®ç°ã€‚éŸ³é¢‘åŠŸèƒ½ç”šè‡³ä¸çŸ¥é“æŒ‰é’®çš„å­˜åœ¨ã€‚æŒ‰é’®çš„ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½é€šè¿‡ HID æŠ¥å‘Šä¼ é€ç»™ä¸»æœºè½¯ä»¶ã€‚ç„¶åç”±ä¸»æœºè½¯ä»¶æ¥è§£é‡ŠæŒ‰é’®çŠ¶æ€çš„å˜åŒ–ï¼Œå¹¶ä»é‚£é‡Œè·å¾—å¯¹éŸ³é¢‘åŠŸèƒ½è¦é‡‡å–çš„é€‚å½“è¡ŒåŠ¨ã€‚å› æ­¤ï¼Œç»‘å®šè´£ä»»å®Œå…¨å±äºåº”ç”¨ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè½¯ä»¶ã€‚å°½ç®¡æ­¤æ–¹æ³•æä¾›äº†å¹¿æ³›çš„çµæ´»æ€§ä½†å®ƒä¹Ÿç»™è½¯ä»¶å¸¦æ¥äº†æä¾›æ­£ç¡®ç»‘å®šçš„è´Ÿæ‹…ã€‚</p><h3 id="physical-button-is-integral-part-of-the-audio-control"><strong>Physical button is Integral Part of the Audio Control</strong></h3><p>è€Œ Feature Unit æ˜¯ UAC æ ‡å‡†é‡Œå®šä¹‰çš„ç‰¹æ€§å•å…ƒï¼ŒåŠŸèƒ½æ›´å¼ºå¤§å¯ä»¥å®ç°å¯¹æ¯ä¸ªé€»è¾‘é€šé“æä¾›éŸ³é¢‘æ§åˆ¶ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº mute å’Œ volumeã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç‰©ç†æŒ‰é”®ç›´æ¥ä¸å®é™…çš„éŸ³é¢‘æ§åˆ¶äº¤äº’ã€‚æŒ‰é’®çŠ¶æ€æ›´æ”¹ä¸ä¼šæŠ¥å‘Šç»™ä¸»æœºè½¯ä»¶ã€‚ç›¸åï¼Œç”±æŒ‰é’®æ“ä½œå¼•èµ·çš„éŸ³é¢‘æ§åˆ¶çš„çŠ¶æ€å˜åŒ–é€šè¿‡éŸ³é¢‘æ§åˆ¶ä¸­æ–­æœºåˆ¶æŠ¥å‘Šç»™ä¸»æœºè½¯ä»¶ã€‚å› æ­¤ï¼Œç‰©ç†æŒ‰é’®å’Œ Audio æ§ä»¶ä¹‹é—´çš„ç»‘å®šéå¸¸ç›´æ¥ï¼Œå®Œå…¨ç”±è®¾å¤‡çš„è®¾è®¡å†³å®šã€‚å°½ç®¡ä¸å¤ªçµæ´»ï¼Œä½†è¯¥æ–¹æ³•æä¾›äº†ä¸€ç§éå¸¸æ¸…æ™°å’Œç›´æ¥çš„æ–¹å¼æ¥æ‰§è¡Œç»‘å®šã€‚</p><h1 id="æµ‹è¯•éªŒè¯">æµ‹è¯•éªŒè¯</h1><h2 id="host-è°ƒèŠ‚éŸ³é‡">Host è°ƒèŠ‚éŸ³é‡</h2><p>åœ¨ pc ä¸Šè°ƒèŠ‚éŸ³é‡ï¼ŒHost ä¼šé€šè¿‡ ep0 ç«¯ç‚¹ç»™ Device å‘é€éŸ³é‡å€¼ï¼Œå…¶å¯¹åº”å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒDevice ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åä¼šå­˜å‚¨è¯¥éŸ³é‡å€¼ç„¶åé€šçŸ¥ç”¨æˆ·å±‚ volume change è¿™ä¸ªæ¶ˆæ¯ï¼Œç”¨æˆ·å°±å¯ä»¥çŸ¥é“ Host ä¿®æ”¹äº† uac çš„éŸ³é‡ï¼Œç„¶åå¯ä»¥é€šè¿‡ç›¸å…³æ¥å£è·å–æ›´æ”¹åçš„éŸ³é‡å€¼ã€‚ç„¶åå…·ä½“çš„è¡Œä¸ºå®Œå…¨ç”±ç”¨æˆ·å†³å®šã€‚ä¾‹å¦‚è¿™é‡Œä»¥è®¾å¤‡æ‰§è¡Œ arecord -Dhw:2,0 -r 48000 -c 2 -f S16_LE | aplay -Dhw:0,1 -c 2 -r 48000 -f S16_LE ä¸ºä¾‹ï¼Œarecord å½•åˆ¶ uac çš„éŸ³é¢‘ç„¶åé€šè¿‡ç®¡é“ aplay åˆ° TDMB è®¾å¤‡ã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å–å’Œè®¾ç½®éŸ³é‡ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å– uac å£°å¡çš„éŸ³é‡</span></span><br><span class="line">amixer -c 2 cget numid=4,iface=MIXER,name=<span class="string">'PCM Capture Volume'</span></span><br><span class="line"><span class="comment"># è®¾ç½® tdmb çš„éŸ³é‡</span></span><br><span class="line">amixer -c 0 cset numid=13,iface=MIXER,name=<span class="string">'5707_B Master Volume'</span> xxx</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç§æ–¹å¼éå¸¸çµæ´»ï¼Œä¸”å±æ€§çš„å˜åŒ–ä»¥åŠå¯¹å˜åŒ–çš„æ“ä½œå®Œå…¨ç”±åº”ç”¨ç¨‹åºæ§åˆ¶ã€‚</p><h2 id="device-ä¸»åŠ¨è°ƒèŠ‚éŸ³é‡">Device ä¸»åŠ¨è°ƒèŠ‚éŸ³é‡</h2><p>ä¹‹å‰å¦‚æœæ˜¯é€šè¿‡æŒ‰é”®è°ƒèŠ‚éŸ³é‡é‚£ä¹ˆæ˜¯é€šè¿‡ HID é©±åŠ¨ç¨‹åºé€šçŸ¥ Host å»è°ƒèŠ‚éŸ³é‡ï¼Œç°åœ¨æœ‰äº† Feature Unit ä¹‹åä¾¿ä¸å†éœ€è¦ HID æ¥åŒæ­¥ Device å’Œ Host çš„éŸ³é‡äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡è®¾ç½® uac å£°å¡çš„éŸ³é‡ç„¶å Feature Unit ä¼šé€šè¿‡ä¸­æ–­ç«¯ç‚¹å°† volume æŠ¥å‘Šç»™ Hostã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ amixer è®¾ç½® UAC å£°å¡çš„éŸ³é‡ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amixer -c 2 cset numid=4,iface=MIXER,name=<span class="string">'PCM Capture Volume'</span> 100</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆä¼šåœ¨ windows ä¸Šçœ‹åˆ°ç³»ç»Ÿçš„éŸ³é‡æ¡è·Ÿç€å‘ç”Ÿå˜åŒ–ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆå››ï¼‰HID</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACHID/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACHID/</url>
      
        <content type="html"><![CDATA[<h1 id="hid-ç›¸å…³æ¦‚å¿µ">HID ç›¸å…³æ¦‚å¿µ</h1><p>æŠ¥è¡¨æè¿°ç¬¦ç”±æè¿° HID è®¾å¤‡çš„æ•°æ®é¡¹ç›®ï¼ˆItemï¼‰ç»„æˆï¼ŒItem çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ˆé¡¹ç›®å‰ç¼€ï¼‰ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼Œ<strong>å³é¡¹ç›®ç±»å‹ï¼ˆitem typeï¼‰ã€é¡¹ç›®æ ‡ç­¾ï¼ˆitem tagï¼‰å’Œé¡¹ç›®é•¿åº¦ï¼ˆitem sizeï¼‰ã€‚</strong></p><p>HID çš„é¡¹ç›®æœ‰çŸ­é¡¹ç›®å’Œé•¿é¡¹ç›®ä¸¤ç§ï¼Œå…¶ä¸­çŸ­é¡¹ç›®çš„æ ¼å¼å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid1.png"></p><span id="more"></span><ul><li><em>bSize å®šä¹‰ short Item çš„æ•°æ®å­—èŠ‚æ•°ï¼Œä¸º 0ã€1ã€2ã€3 æ—¶ Data éƒ¨åˆ†çš„å­—èŠ‚æ•°åˆ†åˆ«ä¸º 0ã€1ã€2ã€4 ä¸ªå­—èŠ‚</em></li><li><em>bType æ˜¯ short Item çš„ç±»å‹ï¼Œä¸º 0ã€1ã€2 æ—¶åˆ†åˆ«ä¸º Mainã€Global å’Œ Local ç±»å‹</em></li><li>bTag æ˜¯ Item æ ‡å¿—ï¼Œæœ‰ Inputã€Outputã€Collectionã€Usage Pageã€Usage ç­‰</li></ul><p>é•¿é¡¹ç›®å¯ä»¥æºå¸¦è¾ƒå¤šçš„æ•°æ®ï¼Œå…¶æ ¼å¼å¦‚ä¸‹å›¾ï¼ˆç”¨çš„å°‘ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid2.png"></p><ul><li><em>item ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºä¸Šå›¾ä¸­çš„ç‰¹å®šå€¼æ—¶è¡¨æ˜è¯¥é¡¹ç›®æ˜¯ä¸€ä¸ªé•¿é¡¹ç›®</em></li><li><em>bDataSize è¯´æ˜ Data éƒ¨åˆ†çš„å­—èŠ‚æ•°</em></li><li><em>bLongItemTag åœ¨ HID è§„èŒƒä¸­æ²¡æœ‰å®šä¹‰</em></li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid3.png"></p><p>ä¸‹é¢ä»¥ 0x05, 0x0c ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹ï¼š</p><p>0x05ï¼ˆ0b00000101ï¼‰å…¶ä¸­ bit2-3 ä»£è¡¨ short item çš„ typeï¼Œ1 ä»£è¡¨çš„æ˜¯ global é¡¹ç›®ï¼Œæœ€åä¸¤ä½ä»£è¡¨æ•°æ®é•¿åº¦æ˜¯ 1Byteï¼Œé€šè¿‡æŸ¥è¡¨å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ª** USAGE_PAGE** itemï¼Œè€Œåé¢çš„ 0x0c ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡æŸ¥è¡¨äº†è§£åˆ°æ˜¯ Consumer</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid4.png"></p><p>å…¶ä»–é…ç½®ä¾æ¬¡ç±»æ¨å°±å¯ä»¥äº†ã€‚</p><h1 id="é…ç½®-configfs">é…ç½® configfs</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># HID</span><br><span class="line">echo <span class="string">"hid"</span> &gt; strings/<span class="number">0x409</span>/configuration</span><br><span class="line">mkdir functions/hid<span class="number">.0</span></span><br><span class="line">echo <span class="number">1</span> &gt; functions/hid<span class="number">.0</span>/protocol</span><br><span class="line">echo <span class="number">1</span> &gt; functions/hid<span class="number">.0</span>/subclass</span><br><span class="line">echo <span class="number">8</span> &gt; functions/hid<span class="number">.0</span>/report_length</span><br><span class="line">echo -ne <span class="string">"\x05\x0c\x09\x01\xa1\x01\x09\xe9\x09\xea\x09\xe2\x09\xcd\x15\x00\x25\x01\x95\x04\x75\x01\x81\x02\x75\x04\x95\x01\x81\x03\xc0"</span> &gt; functions/hid<span class="number">.0</span>/report_desc</span><br><span class="line">ln -s functions/hid<span class="number">.0</span> configs/amlogic<span class="number">.1</span>/hid<span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure><h1 id="æŠ¥å‘Šæè¿°ç¬¦ç»“æ„">æŠ¥å‘Šæè¿°ç¬¦ç»“æ„</h1><p>å…³äºæŠ¥å‘Šæè¿°ç¬¦åšå¦‚ä¸‹è§£æï¼š</p><ul><li>0x05, 0x0c // USAGE_PAGE (Consumer Page)</li><li>0x09, 0x01 // USAGE (Consumer Control)</li><li>0xa1, 0x01 //COLLECTION (Application)</li><li>0x09, 0xe9 //USAGE (Volume Increment)</li><li>0x09, 0xea //USAGE (Volume Decrement)</li><li>0x09, 0xe2 //USAGE (Mute)</li><li>0x09, 0xcd //USAGE (Play/Pause)</li><li>0x15, 0x00 //LOGICAL_MINIMUM (0)</li><li>0x25, 0x01 //LOGICAL_MAXIMUM (1)</li><li>0x95, 0x04 //REPORT_COUNT (4)</li><li>0x75, 0x01 //REPORT_SIZE (1)</li><li>0x81, 0x02 //INPUT (Data,Var,Abs)</li><li>0x75, 0x04 //REPORT_SIZE (4)</li><li>0x95, 0x01 //REPORT_COUNT (1)</li><li>0x81, 0x03 //INPUT (Cnst,Var,Abs)</li><li>0xc0 //END_COLLECTION</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid5.png"></p><h3 id="consumer-page-0x0c"><strong>Consumer Page (0x0C)</strong></h3><h3 id="volume-decrementvolume-incrementmuteplay">Volume Decrementã€Volume Incrementã€Muteã€Play</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid6.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid7.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid8.png"></p><h1 id="éªŒè¯">éªŒè¯</h1><p>åœ¨è®¾å¤‡ç«¯æ‰§è¡Œ uac_hid command å¯ä»¥çœ‹åˆ° windows çš„éŸ³é‡æœ‰å‘ç”Ÿå˜åŒ–å°±è¯´æ˜ uac hid åŠŸèƒ½æ­£å¸¸</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/hid9.png"></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cudXNiemguY29tL2FydGljbGUvZGV0YWlsLTQ4Lmh0bWw=">HID æŠ¥è¡¨æè¿°ç¬¦/æŠ¥å‘Šæè¿°ç¬¦ - USB ä¸­æ–‡ç½‘<i class="fa fa-external-link-alt"></i></span></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆä¸‰ï¼‰Spec-Interrupt</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACSpecInterrupt/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACSpecInterrupt/</url>
      
        <content type="html"><![CDATA[<h1 id="interrupts"><strong>Interrupts</strong></h1><p>ä¸­æ–­ç”¨äºé€šçŸ¥ host éŸ³é¢‘åŠŸèƒ½çš„å½“å‰çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ã€‚æœ¬è§„èŒƒç›®å‰å®šä¹‰äº†ä¸¤ç§ä¸åŒç±»å‹çš„ä¸­æ–­ï¼š</p><ul><li>Memory Change: æŸäº›å†…éƒ¨å®ä½“çš„å†…å­˜ä½ç½®å·²æ›´æ–°ã€‚å¯ä»¥é€šçŸ¥ä¸»æœºè½¯ä»¶ï¼Œä»¥ä¾¿é‡‡å–é€‚å½“çš„è¡ŒåŠ¨ã€‚</li><li>Control Change: éŸ³é¢‘å‡½æ•°å†…éƒ¨çš„æŸäº›å¯å¯»å€æ§ä»¶æ›´æ”¹äº†å…¶ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§å€¼</li></ul><p>æ—¶é’Ÿå®ä½“ã€å•å…ƒæˆ–ç»ˆç«¯å†…éƒ¨çš„éŸ³é¢‘æ§ä»¶å¯ä»¥æ˜¯ä¸­æ–­çš„æºã€‚åŒæ ·ï¼ŒAudioControl æ¥å£ä¸­çš„ä»»ä½•å¯å¯»å€ Control æˆ–ä»»ä½• AudioStreaming æ¥å£éƒ½å¯ä»¥ç”Ÿæˆä¸­æ–­ã€‚æœ€åæ‰€æœ‰ä¸éŸ³é¢‘ç«¯ç‚¹ç›¸å…³çš„å¯å¯»å€æ§ä»¶éƒ½å¯èƒ½æ˜¯ä¸­æ–­çš„æºã€‚</p><p>éŸ³é¢‘åŠŸèƒ½çš„çŠ¶æ€å˜åŒ–é€šå¸¸æ˜¯ç”±å‘ç”Ÿçš„ç‰¹å®šäº‹ä»¶å¼•èµ·çš„ã€‚äº‹ä»¶å¯ä»¥æ˜¯ç”¨æˆ·å‘èµ·çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯è®¾å¤‡å‘èµ·çš„ã€‚ç”¨æˆ·å‘èµ·çš„æ’å­”æ’å…¥æˆ–ç§»é™¤æ˜¯ç”¨æˆ·å‘èµ·äº‹ä»¶çš„å…¸å‹ç¤ºä¾‹ã€‚ä¸»æœºå¯ä»¥åˆ‡æ¢é€‰æ‹©å™¨æˆ–æ··éŸ³å™¨ï¼Œä»¥ä¾¿ä»åˆšåˆšæ’å…¥çš„è®¾å¤‡ ï¼ˆä¾‹å¦‚è€³æœºï¼‰æ’­æ”¾éŸ³é¢‘ï¼Œå¹¶åœæ­¢ä»å½“å‰è®¾å¤‡ï¼ˆä¾‹å¦‚æ‰¬å£°å™¨ï¼‰ æ’­æ”¾éŸ³é¢‘ã€‚è®¾å¤‡å¯åŠ¨äº‹ä»¶çš„ç¤ºä¾‹å¦‚ä¸‹ï¼šä¸€ä¸ªå¤–éƒ¨è®¾å¤‡ ï¼ˆä¾‹å¦‚ A/V æ¥æ”¶å™¨å¯ä»¥åœ¨å…¶å…‰å­¦æ•°å­—è¾“å‡ºä¸Šä» PCM è½¬æ¢ä¸º AC-3 ç¼–ç æ•°æ®ï¼Œè¿™å–å†³äºå½“å‰æ­£åœ¨æ’­æ”¾çš„ææ–™å¦‚æœæ­¤è®¾å¤‡è¿æ¥åˆ°å…·æœ‰è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½çš„éŸ³é¢‘åŠŸèƒ½çš„å…‰å­¦æ•°å­—è¾“å…¥ï¼Œåˆ™è¯¥éŸ³é¢‘åŠŸèƒ½ä¸Šçš„æ¥å£å¯èƒ½éœ€è¦é‡æ–°é…ç½®ï¼ˆä¾‹å¦‚ï¼Œå¯åŠ¨ AC-3 è§£ç è¿‡ç¨‹ï¼‰ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–æ¥å£çš„æ ¼å¼å‘ç”ŸæŸäº›å˜åŒ–ï¼Œç”šè‡³å˜å¾—ä¸å¯ç”¨ã€‚è®¾å¤‡å¯ä»¥å‘å‡ºä¸­æ–­ï¼Œè®©ä¸»æœºçŸ¥é“éŸ³é¢‘åŠŸèƒ½éœ€è¦é‡æ–°é…ç½®ã€‚</p><span id="more"></span><h1 id="interrupt-data-message"><strong>Interrupt Data Message</strong></h1><p>å®é™…çš„ä¸­æ–­ç±»å‹ï¼ˆå†…å­˜æ›´æ”¹æˆ–æ§åˆ¶æ›´æ”¹ï¼‰åŠå…¶å‘èµ·è€…é€šè¿‡ä¸­æ–­ç«¯ç‚¹å‘é€çš„ä¸­æ–­æ•°æ®æ¶ˆæ¯ä¼ é€’ç»™ä¸»æœºã€‚ç„¶åï¼Œä¸»æœºè´Ÿè´£é€šè¿‡è·å–å†…å­˜è¯·æ±‚æˆ–ç¬¬ 5.2 èŠ‚â€œç±»ç‰¹å®šè¯·æ±‚â€ä¸­å®šä¹‰çš„è·å–æ§åˆ¶è¯·æ±‚ä¹‹ä¸€æ¥æŸ¥è¯¢éŸ³é¢‘åŠŸèƒ½ï¼Œä»¥è·å¾—å…³äºä¸­æ–­åŸå› çš„æ›´è¯¦ç»†ä¿¡æ¯ã€‚</p><p>ä¸­æ–­è¢«è®¤ä¸ºæ˜¯â€œedge-triggeredâ€ç±»å‹ï¼Œè¿™æ„å‘³ç€å½“äº‹ä»¶å‘ç”Ÿæ—¶å°±ä¼šç”Ÿæˆä¸­æ–­ï¼Œä½†æ˜¯ Host ä¸éœ€è¦é‡‡å–ç‰¹å®šçš„æ“ä½œæ¥æ¸…é™¤ä¸­æ–­æ¡ä»¶ã€‚å½“ Host å“åº”ä¸­æ–­å‘å‡ºè·å–è¯·æ±‚æ—¶ï¼Œå°†è¿”å›æ§ä»¶å±æ€§çš„æœ€æ–°å€¼ã€‚</p><p>ä¸­æ–­æ•°æ®æ¶ˆæ¯çš„é•¿åº¦å§‹ç»ˆä¸º 6 ä¸ªå­—èŠ‚ã€‚æ‰€æœ‰ä¸­æ–­æ•°æ®æ¶ˆæ¯éƒ½éœ€è¦ç¬¬ä¸€ä¸ª bInfo å­—æ®µã€‚å®ƒåŒ…å« D0 ä¸­çš„ä¿¡æ¯ï¼Œè¡¨æ˜è¿™æ˜¯ç‰¹å®šäºä¾›åº”å•†çš„ä¸­æ–­ï¼ˆD0 = 0b1ï¼‰è¿˜æ˜¯ç‰¹å®šäºç±»çš„ä¸­æ–­ï¼ˆD0 = 0b0ï¼‰ã€‚ä½ D1 è¡¨ç¤ºä¸­æ–­æ˜¯æ¥è‡ªæ¥å£ï¼ˆD1 = 0b0ï¼‰è¿˜æ˜¯æ¥è‡ªç«¯ç‚¹ï¼ˆD1 = 0b1ï¼‰ã€‚bInfo å­—æ®µçš„ä½ D7..2 è¢«ä¿ç•™ä¸ºå°†æ¥çš„æ‰©å±•ï¼Œå¹¶ä¸”å¿…é¡»è®¾ç½®ä¸ºé›¶ã€‚å¯¹äºç‰¹å®šäºä¾›åº”å•†çš„ä¸­æ–­ï¼Œå°†ä¸ä¼šå¯¹ä¸­æ–­æ¶ˆæ¯çš„å…¶ä½™éƒ¨åˆ†çš„å¸ƒå±€è¿›è¡Œå®šä¹‰ã€‚å¯¹äºç‰¹å®šäºç±»çš„ä¸­æ–­ï¼Œå…¶å¸ƒå±€å®šä¹‰å¦‚ä¸‹ã€‚</p><p>å½“ä¸­æ–­æ¥è‡ªæ¥å£ä¸­çš„å®ä½“ï¼ˆbInfo å­—æ®µä¸­çš„ D1=0b0ï¼‰æ—¶ï¼ŒwIndex å­—æ®µæŒ‡å®šä½å­—èŠ‚å’Œå®ä½“ IDï¼ˆæ—¶é’Ÿå®ä½“ IDã€å•å…ƒ IDã€ç»ˆç«¯ IDã€ç¼–ç å™¨ ID æˆ–è§£ç å™¨ IDï¼‰ä¸­çš„æ¥å£ã€‚ä¸ºäº†æŒ‡ç¤ºæ¥å£æœ¬èº«ï¼Œå¿…é¡»åœ¨é«˜å­—èŠ‚ä¸­æŒ‡å®šå®ä½“ IDã€‚</p><p>å½“ä¸­æ–­æ¥è‡ªä¸€ä¸ªç«¯ç‚¹ï¼ˆbInfo å­—æ®µä¸­çš„ D1=0b1ï¼‰æ—¶ï¼ŒwIndex å­—æ®µæŒ‡å®šè¦ä»¥ä½å­—èŠ‚å¤„ç†çš„ç«¯ç‚¹å’Œä»¥é«˜å­—èŠ‚å¤„ç†çš„é›¶ç«¯ç‚¹ã€‚</p><p>wValue å­—æ®µçš„è§£é‡Šç”± wIndex å­—æ®µä¸­çš„å€¼é™å®šã€‚wValue å­—æ®µçš„å¸ƒå±€æ ¹æ®åœ°å€çš„å®ä½“è€Œå˜åŒ–ã€‚å¯¹äºæ¯ä¸ªæ”¯æŒçš„ Gat value æ§åˆ¶è¯·æ±‚ï¼ŒwValue å­—æ®µéµå¾ªç¬¬ 5 èŠ‚â€œè¯·æ±‚â€ä¸­æ¦‚è¿°çš„å®Œå…¨ç›¸åŒçš„è§„åˆ™ã€‚wValue å­—æ®µè¿”å›é«˜å­—èŠ‚ä¸­çš„æ§åˆ¶é€‰æ‹©å™¨ï¼ˆCSï¼‰å’Œä½å­—èŠ‚ä¸­çš„é€šé“å·ï¼ˆCNï¼‰ã€‚æ§åˆ¶é€‰æ‹©å™¨å’Œé€šé“å·ï¼ˆCNï¼‰ä¸€èµ·å‡†ç¡®åœ°æŒ‡ç¤ºå“ªä¸ªæ§åˆ¶äº§ç”Ÿä¸­æ–­çš„ã€‚å¦‚æœä¸€ä¸ªæ§åˆ¶æ˜¯é€šé“ç‹¬ç«‹çš„ï¼Œåˆ™æ§åˆ¶è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªä¸»æ§åˆ¶ï¼Œå¹¶è¿”å›è™šæ‹Ÿä¿¡é“é›¶ä»¥æŒ‡ç¤ºå®ƒï¼ˆCN = 0ï¼‰ã€‚</p><p>ä¸Šé¢æœ‰ä¸¤ä¸ªä¾‹å¤–ã€‚ç¬¬ä¸€ä¸ªæ˜¯å½“æ··åˆå™¨å•å…ƒæ§åˆ¶è¯·æ±‚è¿”å›é«˜å­—èŠ‚ä¸­çš„ CS = MU_MIXER_CONTROL æ—¶ã€‚ç„¶åä»¥ä½å­—èŠ‚è¿”å›æ··åˆå™¨æ§åˆ¶å·ï¼ˆMCNï¼‰ã€‚ç¬¬äºŒä¸ªæ˜¯å†…å­˜è¯·æ±‚ï¼Œå…¶ä¸­ wValue å­—æ®µæŒ‡å®šä¸€ä¸ªåŸºäºé›¶çš„åç§»å€¼ï¼Œè¯¥å€¼è¡¨ç¤ºç”Ÿæˆä¸­æ–­çš„å®ä½“çš„å†…å­˜ç©ºé—´ä¸­çš„ä½ç½®çš„åœ°å€ã€‚å¦‚æœåç§»å€¼ä¸ºé›¶ï¼Œåˆ™è¡¨ç¤ºå¤šä¸ªå†…å­˜ä½ç½®å¯èƒ½å‘ç”Ÿäº†æ›´æ”¹ï¼Œéœ€è¦æ£€æŸ¥æ•´ä¸ªå†…å­˜ç©ºé—´</p><p><strong>bAttribute </strong>å­—æ®µåŒ…å«ä¸€ä¸ªå¸¸é‡ï¼Œç”¨æ¥æ ‡è¯†è¢«å¯»å€çš„æ§ä»¶æˆ–å®ä½“çš„å“ªä¸ªå±æ€§å¯¼è‡´äº†ä¸­æ–­ã€‚å¯èƒ½çš„å±æ€§åŒ…æ‹¬ï¼š</p><ul><li>Current setting attribute (CUR)</li><li>Range attribute (RANGE)</li><li>Memory space attribute (MEM)</li></ul><p>å½“æ²¡æœ‰æŒ‚èµ·çš„ä¸­æ–­æ—¶ï¼Œä¸­æ–­ç«¯ç‚¹åœ¨è½®è¯¢æ—¶å¿…é¡»ä¸º NAKã€‚ä¸‹è¡¨æŒ‡å®šäº†å½“ D0 = 0b0 æ—¶ï¼Œä¸­æ–­æ¶ˆæ¯çš„æ ¼å¼ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac15.png"></p><h1 id="interrupt-sources"><strong>Interrupt Sources</strong></h1><p>éŸ³é¢‘åŠŸèƒ½çš„å¯å¯»å€å®ä½“å†…çš„ä»»ä½•æ§åˆ¶éƒ½å¯ä»¥æ˜¯ä¸­æ–­çš„æºã€‚ä¸­æ–­æ¶ˆæ¯åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯æ¥ç¡®å®šç©¶ç«Ÿæ˜¯å“ªä¸ªæ§åˆ¶å¯¼è‡´äº†ä¸­æ–­ã€‚ç„¶åï¼Œä¸»æœºå¯ä»¥å‘å‡ºæ­£å¸¸çš„æ§åˆ¶è¯·æ±‚ï¼Œä»¥è¿›ä¸€æ­¥ç¡®å®šä¸­æ–­çš„åŸå› ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆäºŒï¼‰Spec-Requests</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACSpecRequests/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACSpecRequests/</url>
      
        <content type="html"><![CDATA[<h1 id="standard-requests"><strong>Standard Requests</strong></h1><p>éŸ³é¢‘è®¾å¤‡ç±»æ”¯æŒ USB è§„èŒƒçš„ç¬¬ 9 èŠ‚â€œUSB è®¾å¤‡æ¡†æ¶â€ä¸­æè¿°çš„æ ‡å‡†è¯·æ±‚ã€‚éŸ³é¢‘è®¾å¤‡ç±»å¯¹æ ‡å‡†è¯·æ±‚çš„å€¼æ²¡æœ‰æå‡ºç‰¹å®šçš„è¦æ±‚ã€‚</p><h1 id="class-specific-requests"><strong>Class-Specific Requests</strong></h1><p>ç‰¹å®šäºç±»çš„è¯·æ±‚ç”¨äºè®¾ç½®å’Œè·å–ä¸éŸ³é¢‘ç›¸å…³çš„æ§ä»¶ã€‚è¿™äº›æ§åˆ¶å™¨ä¸»è¦åˆ†ä¸ºä¸¤ç»„ï¼šé‚£äº›æ“çºµéŸ³é¢‘åŠŸèƒ½çš„æ§åˆ¶å™¨ï¼Œå¦‚éŸ³é‡ï¼ŒéŸ³è°ƒï¼Œé€‰æ‹©å™¨çš„ä½ç½®ç­‰ã€‚ä»¥åŠé‚£äº›å½±å“ç­‰æ—¶ç»ˆç‚¹ä¸Šçš„æ•°æ®ä¼ è¾“çš„æ•°æ®ï¼Œæ¯”å¦‚å½“å‰çš„é‡‡æ ·é¢‘ç‡ã€‚</p><ul><li><p><strong>AudioControl Requests</strong></p><p>å¯¹éŸ³é¢‘åŠŸèƒ½çš„æ§åˆ¶æ˜¯é€šè¿‡æ“ä½œåµŒå…¥åœ¨éŸ³é¢‘åŠŸèƒ½çš„å®ä½“ä¸­çš„å•ä¸ªæ§ä»¶çš„å±æ€§æ¥æ‰§è¡Œçš„ã€‚ç‰¹å®šäºç±»çš„éŸ³é¢‘æ§ä»¶æ¥å£æè¿°ç¬¦åŒ…å«ä¸€ç»„å®ä½“æè¿°ç¬¦ï¼Œæ¯ä¸ªæè¿°ç¬¦æŒ‡ç¤ºå®ä½“ä¸­å­˜åœ¨å“ªäº›æ§ä»¶ã€‚éŸ³é¢‘æ§åˆ¶è¯·æ±‚æ€»æ˜¯æŒ‡å‘éŸ³é¢‘åŠŸèƒ½çš„å•ä¸ªéŸ³é¢‘æ§åˆ¶æ¥å£ã€‚è¯·æ±‚åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼ˆå®ä½“ IDã€æ§åˆ¶é€‰æ‹©å™¨å’Œé€šé“å·ï¼‰ï¼Œä»¥ä¾¿éŸ³é¢‘åŠŸèƒ½å†³å®šå¿…é¡»è·¯ç”±ç‰¹å®šè¯·æ±‚çš„ä½ç½®ã€‚åŒæ ·çš„è¯·æ±‚å¸ƒå±€ä¹Ÿå¯ç”¨äºç‰¹å®šäºä¾›åº”å•†çš„å¯¹æ‰©å±•å•å…ƒçš„è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œæœ¬è§„èŒƒä¸åŒ…æ‹¬å®ƒä»¬</p></li><li><p><strong>AudioStreaming Requests</strong></p><p>å¯¹éŸ³é¢‘æµæ¥å£çš„ç±»ç‰¹å®šè¡Œä¸ºçš„æ§åˆ¶æ˜¯é€šè¿‡æ“ä½œæ¥å£æ§åˆ¶æˆ–ç«¯ç‚¹æ§åˆ¶æ¥æ‰§è¡Œçš„ã€‚å®ƒä»¬å¯ä»¥æ˜¯ç‰¹å®šäºç±»çš„ï¼ˆå¦‚æœ¬è§„èŒƒä¸­å®šä¹‰çš„ï¼‰æˆ–ç‰¹å®šäºä¾›åº”å•†çš„ã€‚å¯¹äºä»»ä½•ä¸€ç§æƒ…å†µï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯·æ±‚å¸ƒå±€ã€‚éŸ³é¢‘æµè¯·æ±‚è¢«å®šå‘åˆ°æ§ä»¶æ‰€åœ¨çš„æ”¶ä»¶äººã€‚è¿™å¯ä»¥æ˜¯æ¥å£æˆ–å®ƒå…³è”çš„ç­‰æ—¶ç«¯ç‚¹ã€‚</p></li></ul><p>éŸ³é¢‘è®¾å¤‡ç±»æ”¯æŒä¸€ä¸ªé™„åŠ çš„ç‰¹å®šäºç±»çš„è¯·æ±‚ï¼š</p><ul><li><p><strong>Memory Requests</strong></p><p>éŸ³é¢‘åŠŸèƒ½ä¸­çš„æ¯ä¸ªå¯å¯»å€å®ä½“ï¼ˆæ—¶é’Ÿå®ä½“ã€ç»ˆç«¯ã€å•å…ƒã€æ¥å£å’Œç«¯ç‚¹ï¼‰éƒ½å¯ä»¥å…¬å¼€ä¸€ä¸ªå†…å­˜æ˜ å°„æ¥å£ï¼Œä»è€Œæä¾›é€šç”¨åœ°æ“ä½œå®ä½“çš„æ–¹æ³•ã€‚ç‰¹å®šäºä¾›åº”å•†çš„æ§åˆ¶å®ç°å¯ä»¥åŸºäºè¿™ç§ç±»å‹çš„è¯·æ±‚ã€‚</p></li></ul><p>åŸåˆ™ä¸Šï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯å¯é€‰çš„ã€‚å¦‚æœéŸ³é¢‘åŠŸèƒ½ä¸æ”¯æŒæŸä¸ªè¯·æ±‚ï¼Œåˆ™å¿…é¡»é€šè¿‡åœ¨å‘è¯¥åŠŸèƒ½å‘å‡ºè¯·æ±‚æ—¶åœæ­¢æ§åˆ¶ç®¡é“æ¥è¡¨æ˜è¿™ä¸€ç‚¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ”¯æŒæŸä¸ªé›†åˆè¯·æ±‚ï¼Œåˆ™ä¹Ÿå¿…é¡»æ”¯æŒå…³è”çš„ Get è¯·æ±‚ã€‚å¯ä»¥æ”¯æŒè·å–è¯·æ±‚ï¼Œè€Œä¸æ”¯æŒå…³è”çš„é›†åˆè¯·æ±‚ã€‚å¦‚æœæ”¯æŒä¸­æ–­ï¼Œé‚£ä¹ˆå°±å¿…é¡»å®ç°æ‰€æœ‰å¿…è¦çš„ Get è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚éœ€è¦ä»éŸ³é¢‘åŠŸèƒ½ä¸­æ£€ç´¢é€‚å½“çš„ä¿¡æ¯ï¼Œä»¥å“åº”è¿™äº›ä¸­æ–­</p><span id="more"></span><h2 id="control-attributes"><strong>Control Attributes</strong></h2><p>å®ä½“ä¸­çš„æ¯ä¸ªæ§ä»¶éƒ½å¯ä»¥å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸å…¶å…³è”çš„å±æ€§ã€‚æ§ä»¶å½“å‰å®šä¹‰çš„å±æ€§åŒ…æ‹¬ï¼š</p><ul><li>Current setting attribute (CUR)</li><li>Range attribute (RANGE)</li></ul><p>CUR å±æ€§ç”¨äºæ“ä½œæ§ä»¶çš„å½“å‰å®é™…è®¾ç½®ã€‚èŒƒå›´å±æ€§æä¾›äº†å…³äºæ§åˆ¶å¯¹ CUR çš„å…è®¸è®¾ç½®æ‰€æ–½åŠ çš„é™åˆ¶çš„ä¿¡æ¯å±æ€§ã€‚èŒƒå›´å±æ€§å®é™…ä¸Šæ˜¯ç”±ä¸€ä¸ªå­å±æ€§æ•°ç»„ç»„æˆçš„ã€‚å­å±æ€§ä¸ºæœ€å°å€¼ï¼ˆMINï¼‰ã€æœ€å¤§å€¼ï¼ˆMAXï¼‰å’Œåˆ†è¾¨ç‡ï¼ˆRESï¼‰ã€‚å®ƒä»¬æ€»æ˜¯ä»¥ [MINï¼ŒMAXï¼ŒRES] å½¢å¼çš„ä¸‰è”ä½“è¿›è¡Œæ“ä½œï¼Œä¸èƒ½å•ç‹¬è®¿é—®æˆ–ä¿®æ”¹ã€‚èŒƒå›´å±æ€§æ”¯æŒè¿™äº›ä¸‰è”ä½“çš„æ•°ç»„ï¼Œä»¥ä¾¿èƒ½å¤Ÿå‡†ç¡®åœ°æŠ¥å‘Šä¸€ä¸ªæ§ä»¶çš„ä¸è¿ç»­çš„å¤šä¸ªå­èŒƒå›´ã€‚æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŒ…å«æ§ä»¶æ‰€æ”¯æŒçš„å­èŒƒå›´çš„æ•°é‡ã€‚æ•°ç»„ä¸­çš„åç»­ä¸‰è”ä½“å…ƒç´ å¯¹åº”äºæ¯ä¸ªå­èŒƒå›´ã€‚å­èŒƒå›´å¿…é¡»æŒ‰å‡åºæ’åˆ—ï¼ˆä»è¾ƒä½å€¼åˆ°è¾ƒé«˜å€¼ï¼‰ã€‚å•ä¸ªå­èŒƒå›´ä¸èƒ½é‡å ï¼ˆå³å‰ä¸€ä¸ªå­é›†çš„æœ€å¤§å€¼ä¸èƒ½ç­‰äºä¸‹ä¸€ä¸ªå­èŒƒå›´çš„æœ€å°å€¼ï¼‰ã€‚å¦‚æœä¸€ä¸ªå­é›†åªåŒ…å«ä¸€ä¸ªå€¼ï¼Œåˆ™å¯¹åº”çš„ä¸‰å€¼ç»„å¿…é¡»åŒæ—¶åŒ…å«å…¶ MIN å’Œ MAX å­å±æ€§çš„è¯¥å€¼ï¼Œå¹¶ä¸” RES å­å±æ€§å¿…é¡»è®¾ç½®ä¸ºé›¶</p><p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªï¼ˆå‡è®¾çš„ï¼‰volume æ§åˆ¶ï¼Œå®ƒå¯ä»¥ä¸ºå…¶ CUR å±æ€§è·å–ä»¥ä¸‹å€¼ï¼š</p><ul><li>-âˆ dB</li><li>-70 dB to -40 dB in steps of 3 dB</li><li>-40 dB to -20 dB in steps of 2 dB</li><li>-20 dB to 0 dB in steps of 1 dB</li></ul><p>èŒƒå›´å±æ€§çš„ä¸€ä¸ªå¯èƒ½çš„å¸ƒå±€æ˜¯ï¼š</p><p>RANGE(0) = 3 RANGE(1) = [-70, -40, 3] RANGE(2) = [-38, -20, 2] RANGE(3) = [-19, 0, 1]</p><p>è¡¨ç¤ºç›¸åŒæ§ä»¶çš„å¦ä¸€ç§æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>RANGE(0) = 3 RANGE(1) = [-70, -43, 3] RANGE(2) = [-40, -22, 2] RANGE(3) = [-20, 0, 1]</p><p>å®ƒæ˜¯ç”±è®¾è®¡è€…æ¥é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è¡¨ç¤ºæ–¹å¼çš„ã€‚è™½ç„¶å¯ä»¥å°†ä¸€ä¸ªèŒƒå›´è¡¨ç¤ºä¸ºæ„æˆè¯¥èŒƒå›´çš„ç¦»æ•£å€¼ï¼Œä½†éå¸¸ä¸é¼“åŠ±ä½¿ç”¨è¿™ç§è¡¨ç¤ºã€‚</p><h2 id="control-request-layout"><strong>Control Request Layout</strong></h2><p>éŸ³é¢‘è®¾å¤‡ç±»å®šä¹‰çš„è¯·æ±‚å¸ƒå±€ä¸¥æ ¼éµå¾ª USB è§„èŒƒä¸­å®šä¹‰çš„æ ‡å‡†è¯·æ±‚å¸ƒå±€ã€‚è¯¥è¯·æ±‚ç”¨äºè®¾ç½®æˆ–è·å–éŸ³é¢‘åŠŸèƒ½çš„å®ä½“å†…çš„æ§ä»¶çš„å±æ€§ã€‚ä¸‹è¡¨è¯¦ç»†è¯´æ˜äº†è¯·æ±‚çš„å¸ƒå±€ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac6.png"></p><p>Bit D7 of the <strong>bmRequestType</strong> field specifies whether this is a Set request (D7 = 0b0) or a Get request</p><p>(D7 = 0b1). It is a class-specific request (D6..5 = 0b01), directed to either an interface (AudioControl or</p><p>AudioStreaming) of the audio function (D4..0 = 0b00001) or the isochronous endpoint of an</p><p>AudioStreaming interface (D4..0 = 0b00010).</p><p>bReset å­—æ®µåŒ…å«ä¸€ä¸ªå¸¸é‡ï¼Œæ ‡è¯†è¦æ“ä½œçš„æ§ä»¶çš„å“ªä¸ªå±æ€§ã€‚æ§ä»¶çš„å¯èƒ½å±æ€§åŒ…æ‹¬ï¼š</p><ul><li>Current setting attribute (CUR)</li><li>Range attribute (RANGE)</li></ul><p>å¦‚æœå¯»å€çš„æ§ä»¶ä¸æ”¯æŒä¿®æ”¹æŸä¸ªå±æ€§ï¼Œåˆ™åœ¨å°è¯•ä¿®æ”¹è¯¥å±æ€§æ—¶ï¼Œæ§åˆ¶ç®¡é“å¿…é¡»æŒ‡ç¤ºå¤±é€Ÿã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒSet è¯·æ±‚åªæ”¯æŒ CUR å±æ€§ã€‚ä½†æ˜¯ï¼Œæ­¤è§„èŒƒå¹¶ä¸é˜»æ­¢è®¾è®¡è€…ä½¿èŒƒå›´å±æ€§å¯ç¼–ç¨‹ã€‚æœ‰å…³è¯·æ±‚å¸¸é‡çš„åˆ—è¡¨ï¼Œè¯·å‚è§é™„å½• A.14ï¼Œâ€œéŸ³é¢‘ç±»åˆ«ç‰¹å®šçš„è¯·æ±‚ä»£ç â€ã€‚</p><p>ä½œä¸ºä¸€èˆ¬è§„åˆ™ï¼Œå½“è®¾ç½®äº†ä¸€ä¸ªå±æ€§å€¼æ—¶ï¼Œä¸€ä¸ªæ§ä»¶å°†è‡ªåŠ¨å°†ä¼ é€’çš„å€¼è°ƒæ•´åˆ°æœ€æ¥è¿‘çš„å¯ç”¨æœ‰æ•ˆå€¼ã€‚è¿™ä¸ªå€¼å¯ä»¥é€šè¿‡åç»­çš„è·å–æ§åˆ¶è¯·æ±‚æ¥æ£€ç´¢ã€‚</p><p>ä¸Šé¢è¿™ä¸ªè§„åˆ™çš„å”¯ä¸€ä¾‹å¤–æ˜¯å¤åˆ¶ä¿æŠ¤æ§åˆ¶ã€‚å½“å¤åˆ¶ä¿æŠ¤æ§åˆ¶ä¸èƒ½å‡†ç¡®åœ°æ»¡è¶³â€œè®¾ç½®â€è¯·æ±‚æ—¶ï¼Œæ§åˆ¶ç®¡é“å¿…é¡»æŒ‡ç¤ºä¸€ä¸ª stallã€‚</p><p>wValue å­—æ®µæŒ‡å®šé«˜å­—èŠ‚ä¸­çš„æ§åˆ¶é€‰æ‹©å™¨ï¼ˆCSï¼‰ï¼Œä»¥åŠä½å­—èŠ‚ä¸­çš„é€šé“å·ï¼ˆCNï¼‰ã€‚æ§åˆ¶é€‰æ‹©å™¨æŒ‡ç¤ºæ­¤è¯·æ±‚æ­£åœ¨æ“ä½œçš„æ§åˆ¶ç±»å‹ã€‚é€šé“å·ï¼ˆCNï¼‰è¡¨ç¤ºè¦å½±å“é›†ç¾¤çš„å“ªä¸ªé€»è¾‘é€šé“ã€‚å¦‚æœä¸€ä¸ªæ§åˆ¶æ˜¯é€šé“ç‹¬ç«‹çš„ï¼Œåˆ™æ§åˆ¶è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªä¸»æ§åˆ¶ï¼Œè™šæ‹Ÿä¿¡é“é›¶è¢«ç”¨æ¥è§£å†³å®ƒï¼ˆCN = 0ï¼‰ã€‚å¦‚æœè¯·æ±‚ä¸ºè¯¥å•å…ƒæŒ‡å®šäº†æœªçŸ¥æˆ–ä¸æ”¯æŒçš„ CS æˆ– CNï¼Œåˆ™æ§åˆ¶ç®¡é“å¿…é¡»æŒ‡ç¤º stallã€‚</p><p>ä¸Šé¢ä¹Ÿæœ‰ä¸€ä¸ªä¾‹å¤–ã€‚å¦‚æœæ··éŸ³å™¨å•å…ƒæ§åˆ¶è¯·æ±‚æƒ³è¦å¤„ç†ä¸€ä¸ªæ··éŸ³å™¨æ§åˆ¶ï¼Œå®ƒå°†åœ¨é«˜å­—èŠ‚ä¸­æŒ‡å®š CS = MU_MIXER_CONTROL ä¸ºæ§åˆ¶é€‰æ‹©å™¨ï¼Œåœ¨ä½å­—èŠ‚ä¸­æŒ‡å®šæ··éŸ³å™¨æ§åˆ¶å·ï¼ˆMCNï¼‰ã€‚</p><p>å½“è¯·æ±‚å¤„ç†æ¥å£ï¼ˆbmRequestType=0b00100001 æˆ– 10100001ï¼‰ä¸­çš„å®ä½“æ—¶ï¼ŒwIndex å­—æ®µæŒ‡å®š Interface ç”±ä½å­—èŠ‚å’Œå®ä½“ IDï¼ˆæ—¶é’Ÿå®ä½“ IDã€å•å…ƒ IDã€ç»ˆç«¯ IDã€ç¼–ç å™¨ ID æˆ–è§£ç å™¨ IDï¼‰ã€‚è¦å¯»å€æ¥å£æœ¬èº«ï¼Œå¿…é¡»åœ¨é«˜å­—èŠ‚ä¸­æŒ‡å®šä¸€ä¸ªä¸ºé›¶çš„å®ä½“ IDã€‚</p><p>å½“è¯·æ±‚å¯»ç«¯ç‚¹ï¼ˆbmRequestType=0b00100010 æˆ– 10100010ï¼‰æ—¶ï¼ŒwIndex å­—æ®µæŒ‡å®š Endpoint ç”±ä½å­—èŠ‚å¯»å€ï¼Œé«˜å­—èŠ‚ä¸º 0ã€‚</p><p>wIndex ä¸­çš„å€¼å¿…é¡»é€‚ç”¨äº recipientã€‚åªèƒ½å¤„ç†éŸ³é¢‘åŠŸèƒ½æˆ–éŸ³é¢‘æµåª’ä½“æ¥å£ä¸­çš„ç°æœ‰å®ä½“ï¼Œå¹¶ä¸”åªèƒ½ä½¿ç”¨é€‚å½“çš„æ¥å£æˆ–ç«¯ç‚¹ç¼–å·ã€‚å¦‚æœè¯·æ±‚æŒ‡å®šäº†æœªçŸ¥æˆ–éå®ä½“ ID æˆ–æœªçŸ¥çš„æ¥å£æˆ–ç«¯ç‚¹ç¼–å·ï¼Œåˆ™æ§åˆ¶ç®¡é“å¿…é¡»æŒ‡ç¤º stallã€‚</p><p>Set è¯·æ±‚çš„å®é™…å‚æ•°åœ¨æ§åˆ¶ä¼ è¾“çš„æ•°æ®é˜¶æ®µä¸­ä¼ é€’ã€‚å‚æ•°å—çš„é•¿åº¦åœ¨è¯·æ±‚çš„ wLength å­—æ®µä¸­è¡¨ç¤ºã€‚å‚æ•°å—çš„å¸ƒå±€ç”± bRequest å’Œ wIndex å­—æ®µé™å®šã€‚æœ‰å…³æ‰€æœ‰å¯èƒ½çš„å®ä½“çš„å‚æ•°å—å¸ƒå±€çš„è¯¦ç»†æè¿°ï¼Œè¯·å‚é˜…ä»¥ä¸‹éƒ¨åˆ†ã€‚</p><p>Get è¯·æ±‚çš„å®é™…å‚æ•°å°†åœ¨æ§åˆ¶ä¼ è¾“çš„æ•°æ®é˜¶æ®µä¸­è¿”å›ã€‚è¦è¿”å›çš„å‚æ•°å—çš„é•¿åº¦åœ¨è¯·æ±‚çš„ wLength å­—æ®µä¸­è¡¨ç¤ºã€‚å¦‚æœå‚æ•°å—æ¯” wLength å­—æ®µä¸­æŒ‡ç¤ºçš„é•¿åº¦æ›´é•¿ï¼Œåˆ™åªè¿”å›å‚æ•°å—çš„åˆå§‹å­—èŠ‚ã€‚å¦‚æœå‚æ•°å—å°äº wLength å­—æ®µä¸­æ‰€æŒ‡ç¤ºçš„å€¼ï¼Œåˆ™è¯¥è®¾å¤‡åœ¨è¯·æ±‚è¿›ä¸€æ­¥çš„æ•°æ®æ—¶ï¼Œé€šè¿‡å‘é€ä¸€ä¸ªè¾ƒçŸ­çš„æ•°æ®åŒ…æ¥è¡¨ç¤ºæ§åˆ¶ä¼ è¾“çš„ç»“æŸã€‚å‚æ•°å—çš„å¸ƒå±€ç”± bRequest å’Œ wIndex å­—æ®µé™å®šã€‚æœ‰å…³æ‰€æœ‰å¯èƒ½çš„å®ä½“çš„å‚æ•°å—å¸ƒå±€çš„è¯¦ç»†æè¿°ï¼Œè¯·å‚é˜…ä»¥ä¸‹éƒ¨åˆ†ã€‚</p><h2 id="control-request-parameter-block-layout"><strong>Control Request Parameter Block Layout</strong></h2><p>é™¤äº†å°‘æ•°ä¾‹å¤–æƒ…å†µå¤–ï¼Œå‡ ä¹æ‰€æœ‰çš„æ§åˆ¶è¯·æ±‚åœ¨é›†åˆæˆ–è·å–è¯·æ±‚æœŸé—´éƒ½æ“ä½œå•ä¸ªæ§åˆ¶å‚æ•°ã€‚å¯¹äºè¿™äº›è¯·æ±‚ï¼Œå¯èƒ½çš„å‚æ•°å—å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œè¿™å–å†³äºæ§ä»¶çš„ CUR å±æ€§çš„å­—èŠ‚å¤§å°ã€‚ä¸€ä¸ª CUR å±æ€§çš„å¤§å°å¯ä»¥æ˜¯ä¸€ä¸ª 1Byte ä¸€ä¸ª wordï¼ˆ2 å­—èŠ‚ï¼‰æˆ–ä¸€ä¸ª double wordï¼ˆ4 å­—èŠ‚ï¼‰ã€‚ä»¥ä¸‹æ®µè½æŒ‡å®šäº†è¿™ä¸‰ä¸ªç±»åˆ«çš„ CUR å’ŒèŒƒå›´å‚æ•°å—çš„å¸ƒå±€</p><p>å¯¹äºé‚£äº›ä½¿ç”¨åå·®å‚æ•°å—å¸ƒå±€çš„è¯·æ±‚ï¼Œå®é™…å¸ƒå±€å°†åœ¨ç›¸å…³éƒ¨åˆ†ä¸­æ˜ç¡®å®šä¹‰</p><h3 id="layout-1-parameter-block"><strong>Layout 1 Parameter Block</strong></h3><p>æ§ä»¶çš„ 1 å­—èŠ‚å¤§å°çš„ CUR å±æ€§çš„å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac7.png"></p><p>è¯¥æ§ä»¶çš„èŒƒå›´å±æ€§çš„å…³è”å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac8.png"></p><h3 id="layout-2-parameter-block"><strong>Layout 2 Parameter Block</strong></h3><p>æ§ä»¶çš„ 2 å­—èŠ‚å¤§å°çš„ CUR å±æ€§çš„å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac9.png"></p><p>è¯¥æ§ä»¶çš„èŒƒå›´å±æ€§çš„å…³è”å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac10.png"></p><h3 id="layout-3-parameter-block"><strong>Layout 3 Parameter Block</strong></h3><p>æ§ä»¶çš„ 4 å­—èŠ‚å¤§å°çš„ CUR å±æ€§çš„å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac11.png"> è¯¥æ§ä»¶çš„èŒƒå›´å±æ€§çš„å…³è”å‚æ•°å—å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac12.png"></p><h2 id="common-controls"><strong>Common Controls</strong></h2><p>ä»¥ä¸‹éƒ¨åˆ†æè¿°äº†ä¸€äº›å¯ä»¥å‡ºç°åœ¨å¤šä¸ªå®ä½“ç±»å‹ä¸­çš„æ§ä»¶ã€‚è¿™é‡Œåªå¯¹å®ƒä»¬è¿›è¡Œäº†æè¿°ä¸€æ¬¡ï¼Œå¹¶ä¸”ä¸ºæ‰€æœ‰å¯ä»¥åŒ…å«ä»»ä½•è¿™äº›æ§ä»¶çš„å®ä½“æä¾›äº†å¯¹è¿™äº›æ§ä»¶æè¿°çš„å¼•ç”¨</p><h3 id="enable-control"><strong>Enable Control</strong></h3><p>å¯ç”¨æ§ä»¶ç”¨äºå¯ç”¨å®ä½“çš„åŠŸèƒ½æˆ–å®Œå…¨ç»•è¿‡è¯¥å®ä½“ã€‚åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå°†å‡å®šä¸ºé»˜è®¤è¡Œä¸ºã€‚å¯ç”¨æ§ä»¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚â€œå¯ç”¨æ§ä»¶ CURâ€å±æ€§çš„å€¼å¯ä»¥ä¸º TRUE æˆ– FALSEã€‚â€œæ§åˆ¶é€‰æ‹©å™¨â€å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_ENABLE_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 1ï¼ˆå‚è§ç¬¬ 5.2.3.1 èŠ‚ï¼Œâ€œå¸ƒå±€ 1 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="mode-select-control"><strong>Mode Select Control</strong></h3><p>æ¨¡å¼é€‰æ‹©æ§ä»¶ç”¨äºæ›´æ”¹å®ä½“çš„è¡Œä¸ºã€‚æ¨¡å¼é€‰æ‹©æ§ä»¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚CUR å±æ€§çš„æœ‰æ•ˆèŒƒå›´æ˜¯ä» 1 åˆ°å®ä½“æ”¯æŒçš„æ¨¡å¼æ•°ï¼ˆé€šè¿‡å®ä½“æè¿°ç¬¦çš„ bNrModes å­—æ®µæŠ¥å‘Šï¼‰ã€‚â€œæ§åˆ¶é€‰æ‹©å™¨â€å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_MODE_SELECT_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 1ï¼ˆå‚è§ç¬¬ 5.2.3.1 èŠ‚ï¼Œâ€œå¸ƒå±€ 1 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="cluster-control"><strong>Cluster Control</strong></h3><p>é›†ç¾¤æ§åˆ¶ç”¨äºä»å®ä½“ä¸­æ£€ç´¢å½“å‰çš„é€»è¾‘éŸ³é¢‘é€šé“é›†ç¾¤æè¿°ç¬¦ã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚é›†ç¾¤æ§ä»¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚CUR å±æ€§è¿”å›ä¸€ä¸ªæè¿°ç¬¦ï¼Œå®ƒæŒ‰ç…§ç¬¬ 4.1 èŠ‚â€œéŸ³é¢‘é€šé“é›†ç¾¤æè¿°ç¬¦â€ä¸­å®šä¹‰çš„æ ¼å¼åŒ–ã€‚â€œæ§åˆ¶é€‰æ‹©å™¨â€å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_CLUSTER_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚ç¾¤é›†æ§åˆ¶çš„ CUR å±æ€§çš„å‚æ•°å—å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac13.png"></p><h3 id="underflow-control"><strong>Underflow Control</strong></h3><p>Underflow Control ç”¨äºæŒ‡ç¤ºè‡ªä¸Šæ¬¡è·å– Underflow è¯·æ±‚ä»¥æ¥åœ¨å®ä½“ä¸­å‡ºç°çš„è®¡ç®— Underflow æƒ…å†µã€‚å½“è¯•å›¾ä¸ºä¸€ä¸ªæ— ç¬¦å·å˜é‡èµ‹å€¼ä¸€ä¸ªè´Ÿå€¼æ—¶ï¼Œå°±ä¼šå‡ºç°è®¡ç®—æ¬ æµã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚å“åº” Get è¯·æ±‚å°†è¿”å› CUR å±æ€§ï¼Œç„¶åæ¸…é™¤å…¶å€¼ã€‚Underflow æ§åˆ¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚Underflow æ§åˆ¶ CUR å±æ€§çš„å€¼å¿…é¡»ä¸º TRUEï¼ˆå‘ç”Ÿ Underflow æ¡ä»¶ï¼‰æˆ– falseï¼ˆæ­£å¸¸ï¼‰ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_UNDERFLOW_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µè¡¨ç¤ºæ‰€éœ€çš„é€šé“ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 1ï¼ˆå‚è§ç¬¬ 5.2.3.1 èŠ‚ï¼Œâ€œå¸ƒå±€ 1 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="overflow-control"><strong>Overflow Control</strong></h3><p>æº¢å‡ºæ§åˆ¶ç”¨äºæŒ‡ç¤ºè‡ªä¸Šæ¬¡è·å–æº¢å‡ºè¯·æ±‚ä»¥æ¥åœ¨å®ä½“å†…å‡ºç°çš„è®¡ç®—æº¢å‡ºæƒ…å†µã€‚å½“ä¸€ä¸ªå€¼å¤ªæ­£æˆ–å¤ªè´Ÿï¼Œåœ¨æœ‰ç¬¦å·è®¡ç®—åæ— æ³•è¡¨ç¤ºï¼Œä»¥åŠå½“å®ƒåœ¨æ— ç¬¦å·è®¡ç®—åè¡¨ç¤ºå¾—å¤ªæ­£æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè®¡ç®—æº¢å‡ºã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚å“åº” Get è¯·æ±‚å°†è¿”å› CUR å±æ€§ï¼Œç„¶åæ¸…é™¤å…¶å€¼ã€‚æº¢å‡ºæ§åˆ¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚æº¢å‡ºæ§åˆ¶ CUR å±æ€§çš„å€¼å¿…é¡»ä¸º TRUEï¼ˆå‘ç”Ÿæº¢å‡ºæƒ…å†µï¼‰æˆ– falseï¼ˆæ­£å¸¸ï¼‰ã€‚</p><h3 id="encoder-error-control"><strong>Encoder Error Control</strong></h3><p>ç¼–ç å™¨é”™è¯¯æ§åˆ¶ç”¨äºæŒ‡ç¤ºè‡ªä¸Šä¸€æ¬¡è·å–ç¼–ç å™¨é”™è¯¯è¯·æ±‚ä»¥æ¥ï¼Œç¼–ç å™¨ä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªé”™è¯¯æ¡ä»¶ã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚å“åº” Get è¯·æ±‚å°†è¿”å› CUR å±æ€§ï¼Œç„¶åæ¸…é™¤å…¶å€¼ã€‚ç¼–ç å™¨é”™è¯¯æ§åˆ¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚CUR å±æ€§çš„è®¾ç½®èŒƒå›´å¯ä»¥ä»-32768ï¼ˆ0x8000ï¼‰åˆ° 32767ï¼ˆ0x7FFFï¼‰ï¼Œæ­¥éª¤ä¸º 1ï¼ˆ0x0001ï¼‰ã€‚å€¼ 0 è¡¨ç¤ºä¸å­˜åœ¨é”™è¯¯çš„æƒ…å†µã€‚æ‰€æœ‰å…¶ä»–å€¼éƒ½è¡¨æ˜å­˜åœ¨ä¸€ä¸ªé”™è¯¯æ¡ä»¶ã€‚</p><p>æœ¬è§„èŒƒå®šä¹‰äº†è®¸å¤šå¯èƒ½å‡ºç°çš„é”™è¯¯ä»£ç ã€‚è¡¨ 5-9â€œé”™è¯¯ä»£ç â€åˆ—ä¸¾äº†é”™è¯¯ä»£ç åŠå…¶è¯´æ˜ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac14.png"></p><h3 id="decoder-error-control"><strong>Decoder Error Control</strong></h3><p>è§£ç å™¨é”™è¯¯æ§åˆ¶ç”¨äºæŒ‡ç¤ºè‡ªä¸Šä¸€æ¬¡è·å–è§£ç å™¨é”™è¯¯è¯·æ±‚ä»¥æ¥ï¼Œè§£ç å™¨ä¸­å­˜åœ¨çš„é”™è¯¯æ¡ä»¶ã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚å“åº” Get è¯·æ±‚å°†è¿”å› CUR å±æ€§ï¼Œç„¶åæ¸…é™¤å…¶å€¼ã€‚è§£ç å™¨é”™è¯¯æ§åˆ¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚CUR å±æ€§çš„è®¾ç½®èŒƒå›´å¯ä»¥ä»-32768ï¼ˆ0x8000ï¼‰åˆ° 32767ï¼ˆ0x7FFFï¼‰ï¼Œæ­¥éª¤ä¸º 1ï¼ˆ0x0001ï¼‰ã€‚å€¼ 0 è¡¨ç¤ºä¸å­˜åœ¨é”™è¯¯çš„æƒ…å†µã€‚æ‰€æœ‰å…¶ä»–å€¼éƒ½è¡¨æ˜å­˜åœ¨ä¸€ä¸ªé”™è¯¯æ¡ä»¶ã€‚æœ¬è§„èŒƒå®šä¹‰äº†è®¸å¤šå¯èƒ½å‡ºç°çš„é”™è¯¯ä»£ç ã€‚è¡¨ 5-9â€œé”™è¯¯ä»£ç â€åˆ—ä¸¾äº†é”™è¯¯ä»£ç åŠå…¶è¯´æ˜ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_DECODER_ERROR_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 2ï¼ˆå‚è§ç¬¬ 5.2.3.2 èŠ‚ï¼Œâ€œå¸ƒå±€ 2 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="latency-control"><strong>Latency Control</strong></h3><p>éŸ³é¢‘åŠŸèƒ½å¿…é¡»ä¸æ”¯æŒæ­¤æ§åˆ¶ï¼ˆç‰¹å®šç±»éŸ³é¢‘æ§åˆ¶æ¥å£æè¿°ç¬¦çš„ bm æ§åˆ¶å­—æ®µä¸­çš„ D1..0=0b00ï¼‰æˆ–æ”¯æŒéŸ³é¢‘åŠŸèƒ½å†…çš„æ¯ä¸ªç»ˆç«¯å’Œå•å…ƒçš„åªè¯»æ§åˆ¶ï¼ˆç‰¹å®šç±»éŸ³é¢‘æ§åˆ¶æ¥å£æè¿°ç¬¦çš„ bm æ§åˆ¶å­—æ®µä¸­çš„ D1..0=0b01ï¼‰ã€‚ç»ˆç«¯å»¶è¿Ÿå¿…é¡»åŒ…æ‹¬ç”± A/D æˆ– D/A è½¬æ¢å™¨ã€ç¼–ç å™¨ã€è§£ç å™¨ç­‰å¼•èµ·çš„æ‰€æœ‰å»¶è¿Ÿã€‚å»¶è¿Ÿæ§åˆ¶ç”¨äºå‡†ç¡®æŠ¥å‘Šè¢«å€å®ä½“äº§ç”Ÿçš„ä»¥çº³ç§’è¡¨ç¤ºçš„å»¶è¿Ÿã€‚æ­¤æ§ä»¶ä»…æ”¯æŒ Get è¯·æ±‚ï¼ˆåªè¯»ï¼‰ã€‚å»¶è¿Ÿæ§ä»¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚CUR å±æ€§çš„è®¾ç½®èŒƒå›´å¯ä»¥ä» 0 nsï¼ˆ0x00000000ï¼‰åˆ° 4,294,967,295nsï¼ˆ0x FFFFFFFFï¼‰ï¼Œæ­¥éª¤ä¸º 1 nsï¼ˆ0x00000001ï¼‰ã€‚â€œæ§åˆ¶é€‰æ‹©å™¨â€å­—æ®µå¿…é¡»è®¾ç½®ä¸º XX_LATENCY_CONTROLï¼ˆå…¶ä¸­ XX å¿…é¡»ç”±ç‰¹å®šå®ä½“çš„é€‚å½“çš„åŒå­—æ¯ç¼©å†™æ›¿æ¢ï¼‰ï¼Œå¹¶ä¸”â€œé€šé“å·â€å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 3ï¼ˆå‚è§ç¬¬ 5.2.3.3 èŠ‚ï¼Œâ€œå¸ƒå±€ 3 å‚æ•°å—â€ï¼‰ã€‚</p><h2 id="audiocontrol-requests"><strong>AudioControl Requests</strong></h2><p>ä»¥ä¸‹éƒ¨åˆ†æè¿°äº†å¯ç”¨äºæ“ä½œéŸ³é¢‘åŠŸèƒ½é€šè¿‡å…¶å®ä½“å…¬å¼€çš„éŸ³é¢‘æ§åˆ¶çš„å¯èƒ½è¯·æ±‚ã€‚é›†åˆå’Œ Get è¯·æ±‚éƒ½ä½¿ç”¨ç›¸åŒçš„å‚æ•°å—å¸ƒå±€ã€‚</p><h3 id="clock-source-control-request"><strong>Clock Source Control Request</strong></h3><p>æ­¤è¯·æ±‚ç”¨äºæ“ä½œéŸ³é¢‘åŠŸèƒ½çš„æ—¶é’Ÿæºå®ä½“å†…çš„æ§ä»¶ã€‚è¯·æ±‚çš„ç¡®åˆ‡å¸ƒå±€åœ¨ç¬¬ 5.2.2 èŠ‚â€œæ§åˆ¶è¯·æ±‚å¸ƒå±€â€ä¸­å®šä¹‰ã€‚ä»¥ä¸‹å„æ®µè¯¦ç»†æè¿°äº†æ—¶é’Ÿæºå®ä½“å¯ä»¥åˆå¹¶çš„æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶é¡¹ã€‚å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œéƒ½æŒ‡å®šå—æ”¯æŒçš„å±æ€§åŠå…¶å€¼èŒƒå›´ã€‚æ­¤å¤–ï¼Œè¿˜åˆ—å‡ºäº†é€‚å½“çš„æ§åˆ¶é€‰æ‹©å™¨å€¼å’Œå‚æ•°å—çš„å¸ƒå±€ç±»å‹ã€‚æ§åˆ¶é€‰æ‹©å™¨ä»£ç åœ¨é™„å½• A.17.1ï¼Œâ€œæ—¶é’Ÿæºæ§åˆ¶é€‰æ‹©å™¨â€ä¸­å®šä¹‰ã€‚</p><h3 id="sampling-frequency-control"><strong>Sampling Frequency Control</strong></h3><p>é‡‡æ ·é¢‘ç‡æ§åˆ¶ç”¨äºæ“çºµç”±æ—¶é’Ÿæºå®ä½“äº§ç”Ÿçš„æ—¶é’Ÿä¿¡å·çš„å®é™…é‡‡æ ·é¢‘ç‡ã€‚é‡‡æ ·é¢‘ç‡æ§åˆ¶å¿…é¡»æ”¯æŒ CUR å’ŒèŒƒå›´ï¼ˆMINã€MAXã€RESï¼‰å±æ€§ã€‚CURã€MINã€MAX å’Œ RES å±æ€§çš„è®¾ç½®èŒƒå›´å¯ä»¥ä» 0Hzï¼ˆ0x000000000ï¼‰åˆ° 4,294,967,295Hzï¼ˆ0x FFFFFFFFï¼‰ï¼Œæ­¥éª¤ä¸º 1 Hzï¼ˆ0x00000001ï¼‰ã€‚æ³¨ï¼šå¯ä»¥ä½¿ç”¨ 5.2.1 èŠ‚â€œæ§åˆ¶å±æ€§â€ä¸­è§£é‡Šçš„æ–¹æ³•çš„ç¦»æ•£åˆ—è¡¨æ¥è¡¨ç¤ºã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ—¶é’Ÿæºå®ä½“è¡¨ç¤ºä¸€ä¸ªåŸºäºå•ä¸€å›ºå®šé¢‘ç‡çš„æ™¶ä½“æŒ¯è¡å™¨çš„å‘ç”Ÿå™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸æ”¯æŒè®¾ç½®è¯·æ±‚ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º CS_SAM_FREQ_CONTROLï¼Œé€šé“å·å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 3ï¼ˆå‚è§ç¬¬ 5.2.3.3.3 èŠ‚â€œå¸ƒå±€ 3 å‚æ•°å—â€ï¼‰</p><h3 id="clock-validity-control"><strong>Clock Validity Control</strong></h3><p>æ—¶é’Ÿæœ‰æ•ˆæ€§æ§åˆ¶ç”¨äºæŒ‡ç¤ºç”±æ—¶é’Ÿæºå®ä½“äº§ç”Ÿçš„æ—¶é’Ÿä¿¡å·æ˜¯å¦æœ‰æ•ˆï¼ˆç¨³å®šå’Œå¯é ï¼‰ã€‚æ­¤æ§ä»¶åªæ”¯æŒ Get è¯·æ±‚ã€‚æ—¶é’Ÿæœ‰æ•ˆæ€§æ§åˆ¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚æ—¶é’Ÿæœ‰æ•ˆæ€§æ§åˆ¶ CUR å±æ€§çš„å€¼å¿…é¡»ä¸º TRUEï¼ˆæ—¶é’Ÿæœ‰æ•ˆï¼‰æˆ– falseï¼ˆæ—¶é’Ÿæ— æ•ˆï¼‰ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º CS_CLOCK_VALID_CONTROLï¼Œé€šé“å·å­—æ®µå¿…é¡»è®¾ç½®ä¸ºé›¶ï¼ˆä¸»æ§åˆ¶ï¼‰ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 1ï¼ˆå‚è§ç¬¬ 5.2.3.1 èŠ‚ï¼Œâ€œå¸ƒå±€ 1 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="clock-selector-control-request"><strong>Clock Selector Control Request</strong></h3><p>æ­¤è¯·æ±‚ç”¨äºæ“ä½œéŸ³é¢‘åŠŸèƒ½çš„æ—¶é’Ÿé€‰æ‹©å™¨å®ä½“å†…çš„æ§åˆ¶ã€‚è¯·æ±‚çš„ç¡®åˆ‡å¸ƒå±€åœ¨ç¬¬ 5.2.2 èŠ‚â€œæ§åˆ¶è¯·æ±‚å¸ƒå±€â€ä¸­å®šä¹‰ã€‚ä»¥ä¸‹æ®µè½è¯¦ç»†æè¿°äº†æ—¶é’Ÿé€‰æ‹©å™¨å®ä½“å¯ä»¥åˆå¹¶çš„æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶é¡¹ã€‚å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œéƒ½æŒ‡å®šäº†å—æ”¯æŒçš„å±æ€§åŠå…¶å€¼èŒƒå›´ã€‚æ­¤å¤–ï¼Œè¿˜åˆ—å‡ºäº†é€‚å½“çš„æ§åˆ¶é€‰æ‹©å™¨å€¼å’Œå‚æ•°å—çš„å¸ƒå±€ç±»å‹ã€‚æ§åˆ¶é€‰æ‹©å™¨ä»£ç åœ¨é™„å½• A.17.2ï¼Œâ€œæ—¶é’Ÿé€‰æ‹©å™¨æ§åˆ¶é€‰æ‹©å™¨â€ä¸­éƒ½æœ‰å®šä¹‰ã€‚</p><ul><li><strong>Clock Selector Control</strong></li><li><strong>Clock Multiplier Control Request</strong><ul><li><strong>Numerator Control</strong></li><li><strong>Denominator Control</strong></li></ul></li></ul><h3 id="terminal-control-request"><strong>Terminal Control Request</strong></h3><p>æ­¤è¯·æ±‚ç”¨äºæ“ä½œéŸ³é¢‘åŠŸèƒ½çš„ç»ˆç«¯å†…çš„æ§ä»¶ã€‚è¯·æ±‚çš„ç¡®åˆ‡å¸ƒå±€åœ¨ç¬¬ 5.2.2 èŠ‚â€œæ§åˆ¶è¯·æ±‚å¸ƒå±€â€ä¸­å®šä¹‰ã€‚ä»¥ä¸‹å„æ®µè¯¦ç»†æè¿°äº†ç»ˆç«¯å¯ä»¥åŒ…å«çš„æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶ä»¶ã€‚å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œéƒ½æŒ‡å®šäº†å—æ”¯æŒçš„å±æ€§åŠå…¶å€¼èŒƒå›´ã€‚æ­¤å¤–ï¼Œè¿˜åˆ—å‡ºäº†é€‚å½“çš„æ§åˆ¶é€‰æ‹©å™¨å€¼å’Œå‚æ•°å—çš„å¸ƒå±€ç±»å‹ã€‚æ§åˆ¶é€‰æ‹©å™¨ä»£ç çš„å®šä¹‰è§é™„å½• A.17.4ï¼Œâ€œç»ˆç«¯æ§åˆ¶é€‰æ‹©å™¨â€</p><p>â€¦</p><h2 id="feature-unit-control-request"><strong>Feature Unit Control Request</strong></h2><p>æ­¤è¯·æ±‚ç”¨äºæ“ä½œéŸ³é¢‘åŠŸèƒ½çš„ç‰¹å¾å•å…ƒå†…çš„æ§åˆ¶ã€‚è¯·æ±‚çš„ç¡®åˆ‡å¸ƒå±€åœ¨ç¬¬ 5.2.2 èŠ‚â€œæ§åˆ¶è¯·æ±‚å¸ƒå±€â€ä¸­å®šä¹‰ã€‚ä»¥ä¸‹å„æ®µè¯¦ç»†æè¿°äº†ç‰¹æ€§å•å…ƒå¯ä»¥åˆå¹¶çš„æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶ä»¶ã€‚å¯¹äºæ¯ä¸ªæ§ä»¶ï¼Œéƒ½æŒ‡å®šäº†å—æ”¯æŒçš„å±æ€§åŠå…¶å€¼èŒƒå›´ã€‚æ­¤å¤–ï¼Œè¿˜åˆ—å‡ºäº†é€‚å½“çš„æ§åˆ¶é€‰æ‹©å™¨å€¼å’Œå‚æ•°å—çš„å¸ƒå±€ç±»å‹ã€‚æ§åˆ¶é€‰æ‹©å™¨ä»£ç çš„å®šä¹‰è§é™„å½• A.17.7ï¼Œâ€œç‰¹å¾å•å…ƒæ§åˆ¶é€‰æ‹©å™¨ã€‚</p><h3 id="mute-control"><strong>Mute Control</strong></h3><p>é™éŸ³æ§ä»¶æ˜¯åŠŸèƒ½å•å…ƒçš„æ„å»ºæ¨¡å—ä¹‹ä¸€ã€‚é™éŸ³æ§ä»¶å¿…é¡»åªæœ‰ CUR å±æ€§ã€‚â€œé™éŸ³æ§ä»¶ CURâ€å±æ€§çš„å€¼å¿…é¡»ä¸º TRUEï¼ˆé™éŸ³ï¼‰æˆ– falseï¼ˆéé™éŸ³ï¼‰ã€‚é€šè¿‡è®¾ç½®/è·å–ç‰¹å¾å•å…ƒå†…çš„ç‰¹å®šé™éŸ³æ§åˆ¶è¯·æ±‚çš„å•å…ƒ ID å’Œé€šé“å·å­—æ®µè¿›è¡Œå¤„ç†ã€‚é€šé“å·å­—æ®µçš„æœ‰æ•ˆèŒƒå›´æ˜¯ä»é›¶ï¼ˆâ€œä¸»â€é€šé“ï¼‰åˆ°éŸ³é¢‘é€šé“é›†ç¾¤ä¸­çš„é€»è¾‘é€šé“æ•°ç›®ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º FU_MUTE_CONTROLï¼Œå¹¶ä¸”é€šé“å·å­—æ®µæŒ‡ç¤ºæ‰€éœ€çš„é€šé“ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 1ï¼ˆå‚è§ç¬¬ 5.2.3.1 èŠ‚ï¼Œâ€œå¸ƒå±€ 1 å‚æ•°å—â€ï¼‰ã€‚</p><h3 id="volume-control"><strong>Volume Control</strong></h3><p>éŸ³é‡æ§åˆ¶æ˜¯åŠŸèƒ½å•å…ƒçš„æ„å»ºæ¨¡å—ä¹‹ä¸€ã€‚volume æ§åˆ¶å¿…é¡»æ”¯æŒ CUR å’ŒèŒƒå›´ï¼ˆMINã€MAXã€RESï¼‰å±æ€§ã€‚CURã€MIN å’Œ MAX å±æ€§çš„è®¾ç½®èŒƒå›´å¯ä»¥ä»+127.9961 dBï¼ˆ0x7FFFï¼‰åˆ°-127.9961 dBï¼ˆ0x8001ï¼‰ï¼Œæ­¥éª¤ä¸º 1/256 dB æˆ– 0.00390625 dBï¼ˆ0x0001ï¼‰ã€‚RES å±æ€§çš„è®¾ç½®åªèƒ½ä¸ºæ­£å€¼ï¼Œä¸”èŒƒå›´ä» 1/256 dBï¼ˆ0x0001ï¼‰åˆ°+127.9961 dBï¼ˆ0x7FFFï¼‰ã€‚æ­¤å¤–ï¼Œå¿…é¡»å§‹ç»ˆå®ç°è¡¨ç¤ºæ²‰é»˜ï¼ˆå³-âˆdBï¼‰çš„ä»£ç  0x8000ã€‚ä½†æ˜¯ï¼Œæ°¸è¿œä¸èƒ½å°†å…¶æŠ¥å‘Šä¸º MIN å±æ€§å€¼ã€‚</p><p>é€šè¿‡è®¾ç½®/è·å–ç‰¹å¾å•å…ƒæ§åˆ¶è¯·æ±‚ä¸­çš„å•å…ƒ ID å’Œé€šé“å·å­—æ®µæ¥å¤„ç†ç‰¹å¾å•å…ƒå†…çš„ç‰¹å®šå·æ§åˆ¶ã€‚é€šé“å·å­—æ®µçš„æœ‰æ•ˆèŒƒå›´æ˜¯ä»é›¶ï¼ˆâ€œä¸»â€é€šé“ï¼‰åˆ°éŸ³é¢‘é€šé“é›†ç¾¤ä¸­çš„é€»è¾‘é€šé“æ•°ç›®ã€‚æ§åˆ¶é€‰æ‹©å™¨å­—æ®µå¿…é¡»è®¾ç½®ä¸º FU_VOLUME_CONTROLï¼Œâ€œé€šé“å·â€å­—æ®µæŒ‡ç¤ºæ‰€éœ€çš„é€šé“ã€‚æ­¤æ§åˆ¶è¯·æ±‚çš„å‚æ•°å—ä½¿ç”¨å¸ƒå±€ 2ï¼ˆå‚è§ç¬¬ 5.2.3.2 èŠ‚ï¼Œâ€œå¸ƒå±€ 2 å‚æ•°å—â€ï¼‰ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆä¸€ï¼‰Spec-Functional Characteristics</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACSpecFunctionalCharacteristics/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACSpecFunctionalCharacteristics/</url>
      
        <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1><p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒéŸ³é¢‘åŠŸèƒ½ä¸ä½œä¸ºç‹¬ç«‹è®¾å¤‡å­˜åœ¨ã€‚å®ƒæ˜¯ä¸€ç§èƒ½åŠ›ï¼Œä¸å…¶ä»–åŠŸèƒ½ä¸€èµ·æ„æˆäº†ä¸€ä¸ªâ€œå¤åˆâ€è®¾å¤‡ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ DVD-ROM æ’­æ”¾å™¨å°±æ˜¯éŸ³é¢‘ã€æ•°æ®å­˜å‚¨å’Œä¼ è¾“æ§åˆ¶åŠŸèƒ½çš„é›†åˆã€‚éŸ³é¢‘åŠŸèƒ½å› æ­¤ä½äºè®¾å¤‡ç±»å±‚æ¬¡ç»“æ„ä¸­çš„æ¥å£çº§åˆ«ã€‚å®ƒç”±å¤šä¸ªæ¥å£ç»„æˆï¼Œå…±åŒå®ç°éŸ³é¢‘åŠŸèƒ½çš„æ¥å£ã€‚</p><p>éŸ³é¢‘åŠŸèƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªâ€œclosed boxâ€ï¼Œå…·æœ‰éå¸¸ç‹¬ç‰¹çš„å’Œå®šä¹‰è‰¯å¥½çš„æ¥å£åˆ° outside worldã€‚éŸ³é¢‘åŠŸèƒ½é€šè¿‡å®ƒä»¬çš„éŸ³é¢‘æ¥å£è¿›è¡Œå¯»å€ã€‚æ¯ä¸ªéŸ³é¢‘åŠŸèƒ½éƒ½å¿…é¡»æœ‰ä¸€ä¸ª AudioControl æ¥å£å¯ä»¥æœ‰ 0 ä¸ªæˆ–å¤šä¸ª AudioStreaming å’Œ 0 ä¸ªæˆ–å¤šä¸ª MIDI Streaming æ¥å£ã€‚AudioControlï¼ˆACï¼‰æ¥å£ç”¨äºè®¿é—® function çš„éŸ³é¢‘æ§ä»¶ï¼Œè€Œ AudioStreaming (AS) æ¥å£ç”¨äºå°†éŸ³é¢‘æµä¼ å…¥å’Œä¼ å‡º functionã€‚ MIDI streaming (MS) æ¥å£å¯ç”¨äºå°† midi æ•°æ®æµä¼ è¾“åˆ°å’Œè¾“å‡ºéŸ³é¢‘åŠŸèƒ½ã€‚å•ä¸ª AudioControl æ¥å£ä»¥åŠå±äºåŒä¸€éŸ³é¢‘åŠŸèƒ½çš„ AudioStreaming å’Œ MIDI Streaming æ¥å£çš„é›†åˆç§°ä¸º Audio Interface Collectionï¼ˆAICï¼‰ã€‚ä¸€ä¸ªè®¾å¤‡å¯ä»¥åŒæ—¶æ¿€æ´»å¤šä¸ªéŸ³é¢‘æ¥å£é›†åˆï¼ˆAICï¼‰ã€‚è¿™äº›é›†åˆç”¨äºæ§åˆ¶ä½äºåŒä¸€ composite device ä¸­çš„å¤šä¸ªç‹¬ç«‹éŸ³é¢‘åŠŸèƒ½ã€‚é€šè¿‡æ ‡å‡† USB æ¥å£å…³è”æœºåˆ¶æ¥æè¿°éŸ³é¢‘æ¥å£é›†åˆï¼Œé€šè¿‡æ¥å£å…³è”æè¿°ç¬¦ (IAD) æ¥è¡¨ç¤ºæ¥å£ç»‘å®šã€‚</p><p>æ³¨ï¼šæ‰€æœ‰ä¸ MIDI ç›¸å…³çš„ä¿¡æ¯è¢«åˆ†ç»„åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡æ¡£ä¸­ï¼ŒMIDI è®¾å¤‡çš„é€šç”¨ä¸²è¡Œæ€»çº¿è®¾å¤‡ç±»å®šä¹‰è¢«è®¤ä¸ºæ˜¯æœ¬è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæœ¬æ–‡æ¡£çš„å…¶ä½™éƒ¨åˆ†å°†ä¸å†æåŠ MIDI Streaming æ¥å£åŠå…¶ç»†èŠ‚ã€‚ ä¸‹å›¾è¯´æ˜äº†è¿™ä¸ªæ¦‚å¿µï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac1.png"></p><span id="more"></span><p>æ‰€æœ‰ä¸ç›´æ¥å½±å“éŸ³é¢‘æ„ŸçŸ¥ï¼ˆå¦‚éŸ³é‡ï¼‰ çš„æ§åˆ¶å‚æ•°ç›¸å…³çš„åŠŸèƒ½éƒ½ä½äºä¸­å¤®çŸ©å½¢å†…ï¼Œå¹¶ä»…é€šè¿‡ AudioControl æ¥å£è¿›è¡Œæ§åˆ¶ã€‚é€šè¿‡å•ç‹¬çš„ AudioStreaming æ¥å£å¤„ç†ä¸éŸ³é¢‘åŠŸèƒ½ä¹‹é—´çš„æµåª’ä½“é€šä¿¡ã€‚AudioStreaming æ¥å£ä¸»è¦ç”¨äºåœ¨ Audio function å’Œ outside world ä¹‹é—´ä¼ è¾“éŸ³é¢‘æ•°æ®ã€‚ä½†æ˜¯ï¼Œæ‰€æœ‰ä¸æµè¡Œä¸ºå…·ä½“ç›¸å…³çš„æ§åˆ¶æ•°æ®ä¹Ÿé€šè¿‡ AudioStreaming æ¥å£è¿›è¡Œä¼ è¾“ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰€æœ‰ç”¨äºå½±å“è§£ç å™¨æˆ–ç¼–ç å™¨è¿‡ç¨‹çš„æ§åˆ¶æ•°æ®ï¼Œå¯èƒ½é©»ç•™åœ¨å®é™…æµç«¯ç‚¹å’ŒéŸ³é¢‘åŠŸèƒ½ä¹‹é—´ï¼ˆä¾‹å¦‚ï¼Œä» AC-3 ç¼–ç æµåˆ° 5.1 ç‰©ç†éŸ³é¢‘é€šé“çš„è½¬æ¢ï¼‰ é€šè¿‡ AudioStreaming æ¥å£ä¼ é€ã€‚</p><p>è¯·æ³¨æ„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒAudiostreaming æ¥å£ä»…ç”¨äºæ‰§è¡Œ controlling functionsï¼Œè€Œä¸ä¼šé€šè¿‡è¯¥æ¥å£ä¼ è¾“å®é™…æ•°æ®ã€‚ä¸ S/PDIF è¿æ¥å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ã€‚è™½ç„¶å®é™…çš„éŸ³é¢‘æ•°æ®æ˜¯ä»å¤–éƒ¨è¾“å…¥çš„ ï¼ˆä¸æ˜¯é€šè¿‡ USB)ï¼Œä½†å¯èƒ½éœ€è¦æ§åˆ¶ S/PDIF è¿æ¥çš„ aspectsã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒS/PDIF è¿æ¥ç”± AudioStreaming æ¥å£è¡¨ç¤ºï¼Œè¿™æ ·å®ƒå°±å¯ä»¥é€šè¿‡ USB å¯»å€ã€‚</p><p>è¿˜è¦æ³¨æ„çš„æ˜¯ï¼ŒAudioStreaming æ¥å£å’ŒéŸ³é¢‘åŠŸèƒ½ä¹‹é—´çš„è¿æ¥ä¸æ˜¯â€œsolidâ€ã€‚è¿™æ ·åšçš„åŸå› æ˜¯å½“ä» audio function å†…éƒ¨çœ‹æ—¶ï¼Œæ¯ä¸ªè¿›å…¥æˆ–ç¦»å¼€éŸ³é¢‘å‡½æ•°çš„éŸ³é¢‘æµéƒ½ç”±ä¸€ä¸ªç§°ä¸º Terminal çš„ç‰¹æ®Šå¯¹è±¡è¡¨ç¤ºï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚Terminal æ¦‚å¿µæŠ½è±¡äº†éŸ³é¢‘åŠŸèƒ½å†…éƒ¨çš„å®é™… Audio Streaming æ¥å£ï¼Œå¹¶æä¾›äº†è¿æ¥çš„é€»è¾‘è§†å›¾ï¼Œè€Œä¸æ˜¯ç‰©ç†è§†å›¾ã€‚è¿™ç§æŠ½è±¡å…è®¸éŸ³é¢‘å‡½æ•°ä¸­çš„éŸ³é¢‘é€šé“è¢«è§†ä¸ºä¸å†å…·æœ‰ä¸ä¹‹ç›¸å…³çš„ç‰©ç†ç‰¹æ€§çš„é€»è¾‘â€œéŸ³é¢‘é€šé“â€ã€‚ ï¼ˆæ¨¡æ‹Ÿé‡ä¸æ•°å­—ã€æ ¼å¼ã€é‡‡æ ·ç‡ã€ä½åˆ†è¾¨ç‡ç­‰ï¼‰ã€‚</p><h1 id="audio-interface-collection">Audio Interface Collection</h1><p>åœ¨ USB ä¸Šï¼ŒéŸ³é¢‘åŠŸèƒ½å®Œå…¨ç”±å…¶æ¥å£å®šä¹‰ã€‚ä¸€ä¸ªéŸ³é¢‘å‡½æ•°æœ‰ä¸€ä¸ª AudioControl æ¥å£å’Œé›¶ä¸ªæˆ–å¤šä¸ª AudioStreaming æ¥å£ï¼Œå®ƒä»¬ç»„æˆä¸€ä¸ªéŸ³é¢‘æ¥å£é›†åˆã€‚æ ‡å‡†çš„ USB æ¥å£å…³è”æœºåˆ¶ç”¨äºæè¿°éŸ³é¢‘æ¥å£é›†åˆï¼Œå³å°†è¿™äº›æ¥å£ç»‘å®šåœ¨ä¸€èµ·ã€‚æ¥å£å…³è”é€šè¿‡æ ‡å‡† USB æ¥å£å…³è”æè¿°ç¬¦ (IAD) è¡¨ç¤ºã€‚æ¯ä¸ªæ¥å£å…³è”æè¿°ç¬¦éƒ½æœ‰ä¸€ä¸ª FunctionClassã€FunctionSubClass å’Œ FunctionProtocol å­—æ®µï¼Œå®ƒä»¬å…±åŒæ ‡è¯†ç”±å…³è”è¡¨ç¤ºçš„å‡½æ•°ã€‚ä»¥ä¸‹æ®µè½å®šä¹‰éŸ³é¢‘è®¾å¤‡ç±»çš„è¿™äº›å­—æ®µã€‚</p><h2 id="audio-function-class">Audio Function Class</h2><p>æ¥å£å…³è”è¢«åˆ†é…äº†ä¸€ä¸ª Function Class codeã€‚è¯¥è§„èŒƒè¦æ±‚å‡½æ•°ç±»ä»£ç ä¸éŸ³é¢‘æ¥å£ç±»ä»£ç ç›¸åŒã€‚éŸ³é¢‘å‡½æ•°ç±»ä»£ç ç”±æœ¬è§„èŒƒæŒ‡å®šã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§é™„å½• A.1â€œéŸ³é¢‘å‡½æ•°ç±»ä»£ç </p><h2 id="audio-function-subclass">Audio Function Subclass</h2><p>éŸ³é¢‘å‡½æ•°ç±»åˆ†ä¸ºå‡½æ•°å­ç±»ã€‚æ­¤æ—¶ï¼ŒFunction SubClass ä»£ç æœªè¢«ä½¿ç”¨ï¼Œå¿…é¡»è®¾ç½®ä¸º FUNCTIONSUBCLASSUNDEFINED åˆ†é…çš„ä»£ç å¯ä»¥åœ¨æœ¬è§„èŒƒçš„ A.2â€œéŸ³é¢‘åŠŸèƒ½å­ç±»ä»£ç â€ä¸­æ‰¾åˆ°ã€‚</p><h2 id="audio-function-protocol">Audio Function Protocol</h2><p>éŸ³é¢‘å‡½æ•°ç±»å’Œå­ç±»å¯ä»¥ç”±å‡½æ•°åè®®ä»£ç è¿›ä¸€æ­¥é™å®šã€‚å‡½æ•°åè®®ä»£ç ç”¨äºåæ˜ æœ¬è§„èŒƒçš„å½“å‰ç‰ˆæœ¬ï¼Œä»¥ä¾¿æšä¸¾è½¯ä»¶å¯ä»¥å†³å®šéœ€è¦å®ä¾‹åŒ–å“ªäº›é©±åŠ¨ç¨‹åºç‰ˆæœ¬ æŒ‡å®šçš„åè®®ä»£ç å¯ä»¥åœ¨æœ¬è§„èŒƒçš„é™„å½• A.3â€œéŸ³é¢‘åŠŸèƒ½åè®®ä»£ç â€ä¸­æ‰¾åˆ°ã€‚</p><h1 id="audio-interface-class">Audio Interface Class</h1><p>éŸ³é¢‘æ¥å£ç±»å°†æ‰€æœ‰å¯ä»¥ä¸ USB å…¼å®¹çš„éŸ³é¢‘æ•°æ®æµäº¤äº’çš„åŠŸèƒ½åˆ†ç»„ã€‚åœ¨æ¨¡æ‹Ÿå’Œæ•°å­—éŸ³é¢‘åŸŸä¹‹é—´è½¬æ¢çš„æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥æ˜¯æ­¤ç±»çš„ä¸€éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œé‚£äº›å°†ç¬¦åˆ USB çš„éŸ³é¢‘æ•°æ®æµè½¬æ¢æˆå…¶ä»–ç¬¦åˆ USB çš„éŸ³é¢‘æ•°æ®æµçš„å‡½æ•°ä¹Ÿå±äºæ­¤ç±»ã€‚å³ä½¿æ˜¯é€šè¿‡ USB æ§åˆ¶çš„æ¨¡æ‹ŸéŸ³é¢‘åŠŸèƒ½ä¹Ÿå±äºæ­¤ç±»ã€‚</p><p>äº‹å®ä¸Šï¼Œè¦ä½¿éŸ³é¢‘å‡½æ•°æˆä¸ºæ­¤ç±»çš„ä¸€éƒ¨åˆ†ï¼Œå”¯ä¸€çš„è¦æ±‚æ˜¯å®ƒå…¬å¼€ä¸€ä¸ª AudioControl æ¥å£ã€‚è™½ç„¶éŸ³é¢‘æ¥å£ç±»ä¸­çš„å¤§å¤šæ•°å‡½æ•°å°†æ”¯æŒä¸€ä¸ªæˆ–å¤šä¸ªå¯é€‰çš„ AudioStreaming æ¥å£ï¼Œç”¨äºæ¶ˆè´¹æˆ–äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ªç­‰æ—¶éŸ³é¢‘æ•°æ®æµï¼Œä½†ä¸è¯¥å‡½æ•°çš„è¿›ä¸€æ­¥äº¤äº’æ˜¯å¼ºåˆ¶æ€§çš„ã€‚</p><p>éŸ³é¢‘æ¥å£ç±»ä»£ç ç”± USB åˆ†é…ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§é™„å½• A.4â€œéŸ³é¢‘æ¥å£ç±»ä»£ç â€</p><h1 id="audio-interface-subclass">Audio Interface Subclass</h1><p>éŸ³é¢‘æ¥å£ç±»åˆ†ä¸ºå­ç±»ã€‚æ‰€æœ‰éŸ³é¢‘åŠŸèƒ½éƒ½æ˜¯æŸä¸ªæ¥å£å­ç±»çš„ä¸€éƒ¨åˆ†ã€‚æœ¬è§„èŒƒä¸­ç›®å‰å®šä¹‰äº†ä»¥ä¸‹ä¸‰ä¸ªæ¥å£å­ç±»ï¼š</p><ul><li>AudioControl Interface Subclass</li><li>AudioStreaming Interface Subclass</li><li>MIDIStreaming Interface Subclass</li></ul><p>æŒ‡å®šçš„ä»£ç å¯ä»¥åœ¨æœ¬è§„èŒƒçš„é™„å½• A.5â€œéŸ³é¢‘æ¥å£å­ç±»ä»£ç â€ä¸­æ‰¾åˆ°ã€‚</p><h1 id="audio-interface-protocol">Audio Interface Protocol</h1><p>éŸ³é¢‘æ¥å£ç±»å’Œå­ç±»å¯ä»¥ç”±æ¥å£åè®®ä»£ç è¿›ä¸€æ­¥é™å®šã€‚æ¥å£åè®®ä»£ç ç”¨äºåæ˜ æœ¬è§„èŒƒçš„å½“å‰ç‰ˆæœ¬ã€‚æŒ‡å®šä»£ç å¯ä»¥åœ¨é™„å½• A.6â€œéŸ³é¢‘æ¥å£åè®®ä»£ç â€ä¸­æ‰¾åˆ°ã€‚</p><h1 id="audio-function-category">Audio Function Category</h1><p>éŸ³é¢‘åŠŸèƒ½ç±»åˆ«æŒ‡ç¤ºéŸ³é¢‘åŠŸèƒ½çš„ä¸»è¦é¢„æœŸç”¨é€”ã€‚æœ¬è§„èŒƒä¸­ç›®å‰å®šä¹‰äº†ä»¥ä¸‹åŠŸèƒ½ç±»åˆ«ï¼š</p><ul><li>Desktop Speaker: åœ¨å°å‹ç¯å¢ƒä¸­è®¾ç½®çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ‰¬å£°å™¨ï¼Œä¸»è¦ä¾›ä¸€ä¸ªäººä½¿ç”¨çš„éŸ³é¢‘ã€‚</li><li>Home Theater: åœ¨ä¸­ç­‰å¤§å°çš„ç¯å¢ƒä¸­è®¾ç½®å¤šä¸ªæ‰¬å£°å™¨ï¼Œä»¥æä¾›æ¯”æ¡Œé¢æ‰¬å£°å™¨è®¾ç½®æ›´å¤§çš„éŸ³é¢‘ç”µå¹³ï¼Œå¹¶æ—¨åœ¨è®©å¤šäººæ¸…æ¥šåœ°å¬åˆ°ã€‚</li><li>Microphone: ä¸€ç§è£…ç½®ï¼Œè®¾ç½®æˆä»å¯å¬çš„æ¥æºå½•åˆ¶éŸ³é¢‘ã€‚</li><li>Headset: å…·æœ‰è‡³å°‘ä¸€ä¸ªæ‰¬å£°å™¨å’Œè‡³å°‘ä¸€ä¸ªéº¦å…‹é£çš„è®¾å¤‡ï¼Œä»¥æä¾›ä¸ªäººéŸ³é¢‘æ’­æ”¾å’Œè¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚</li><li>Telephone: ä¹Ÿè¿æ¥åˆ°ç”µè¯ç³»ç»Ÿï¼ˆä¾‹å¦‚ POTã€PBXã€VolP) çš„è€³æœºæˆ–æ‰‹æŒè®¾å¤‡ï¼Œèƒ½å¤Ÿæ‹¨æ‰“å’Œæ¥å¬ç”µè¯</li><li>Converter: å…è®¸éŸ³é¢‘ä»ä¸€ç§ç”µæˆ–å…‰æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§ç”µæˆ–å…‰æ ¼å¼ï¼Œæˆ–å°†éŸ³é¢‘æ•°æ®ä»ä¸€ç§ç¼–ç æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§ç¼–ç æ ¼å¼ ï¼ˆä¾‹å¦‚ AC-3 è½¬æ¢ä¸º PCM ç­‰ï¼‰çš„è®¾å¤‡ã€‚</li><li>Voice/Sound recorder: è‡³å°‘æœ‰ä¸€ä¸ªéº¦å…‹é£å’Œè‡³å°‘ä¸€ä¸ªæ‰¬å£°å™¨çš„è®¾å¤‡ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯è‡³å°‘åœ¨æŸäº›æ—¶å€™ç‹¬ç«‹äºä¸»æœºæ¥è®°å½•å’Œå­˜å‚¨å£°éŸ³æºå¹¶æ’­æ”¾å…¶è®°å½•çš„å†…å®¹ã€‚</li><li>I/O Box: è®¾è®¡ç”¨äºæä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå¯èƒ½ä¸åŒçš„ç”µæ°”å’Œå…‰å­¦è¾“å…¥å’Œè¾“å‡ºä»¥è¿æ¥åˆ°å…¶ä»–è®¾å¤‡çš„è®¾å¤‡</li><li>Musical Instrument: å¦‚é’¢ç´ã€å‰ä»–ã€åˆæˆå™¨ã€é¼“æœºç­‰ã€‚</li><li>Pro-Audio: éŸ³é¢‘æ¶ˆè´¹è€…é€šå¸¸ä¸ä½¿ç”¨çš„è®¾å¤‡ï¼Œä¾‹å¦‚ç¼–è¾‘è®¾å¤‡ã€å¤šè½¨å½•éŸ³è®¾å¤‡ç­‰</li><li>Audio/Video: æ¥è‡ªåŒæ—¶æä¾›è§†é¢‘çš„è®¾å¤‡çš„éŸ³é¢‘ï¼ŒæœŸæœ›éŸ³é¢‘ä¸è§†é¢‘ç´§å¯†è€¦åˆï¼Œä¾‹å¦‚ä¾¿æºå¼æ‘„åƒæœºã€DVD æ’­æ”¾å™¨ç”µè§†æœºç­‰ã€‚</li><li>Control Panel: ç”¨äºæ§åˆ¶é€šè¿‡éŸ³é¢‘è®¾å¤‡ç³»ç»Ÿçš„éŸ³é¢‘æµçš„è®¾å¤‡ï¼Œå¦‚æ··éŸ³å™¨é¢æ¿ã€‚</li><li>Other: ä»»ä½•å™¨æ¢°ï¼Œå…¶ä¸»è¦ç”¨é€”ä¸ä¸Šè¿°æè¿°æœ‰è¶³å¤Ÿçš„ä¸åŒï¼Œä»¥è‡³äºè¢«è®¤ä¸ºæ˜¯ä¸€ç§å®Œå…¨ä¸åŒå½¢å¼çš„å™¨æ¢°</li></ul><p>æŒ‡å®šçš„ä»£ç å¯åœ¨æœ¬è§„èŒƒé™„å½• A.7â€œéŸ³é¢‘åŠŸèƒ½ç±»åˆ«ä»£ç â€ä¸­æ‰¾åˆ°ã€‚</p><h1 id="clock-domains">Clock Domains</h1><p>æ—¶é’ŸåŸŸè¢«å®šä¹‰ä¸ºä¸€ä¸ªåŒºåŸŸï¼Œåœ¨è¯¥åŒºåŸŸå†…æ‰€æœ‰é‡‡æ ·æ—¶é’Ÿéƒ½æ¥è‡ªåŒä¸€ä¸ªä¸»æ—¶é’Ÿã€‚å› æ­¤ï¼Œåœ¨åŒä¸€æ—¶é’ŸåŸŸå†…ï¼Œæ‰€æœ‰é‡‡æ ·æ—¶é’Ÿæ˜¯åŒæ­¥çš„ï¼Œå®ƒä»¬çš„æ—¶åºå…³ç³»æ˜¯æ’å®šçš„ã€‚ç„¶è€Œï¼Œé‡‡æ ·æ—¶é’Ÿå¯ä»¥åœ¨ä¸åŒçš„é‡‡æ ·é¢‘ç‡ã€‚ä¸»æ—¶é’Ÿå¯ä»¥é€šè¿‡è®¸å¤šä¸åŒçš„æ–¹å¼äº§ç”Ÿã€‚å†…éƒ¨æ™¶ä½“å¯ä»¥æ˜¯ä¸»æ—¶é’Ÿï¼Œå¯ä»¥ä½¿ç”¨ USB å¸§èµ·å§‹ (SOF) ï¼Œæˆ–è€…ç”šè‡³å¯ä»¥ä½¿ç”¨å¤–éƒ¨æä¾›çš„æ—¶é’Ÿä½œä¸ºä¸»æ—¶é’Ÿã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒåŒä¸€éŸ³é¢‘åŠŸèƒ½ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªä¸åŒçš„æ—¶é’ŸåŸŸã€‚</p><h1 id="audio-synchronization-types">Audio Synchronization Types</h1><p>AudioStreaming æ¥å£ä¸­ä½¿ç”¨çš„æ¯ä¸ªåŒæ­¥éŸ³é¢‘ç«¯ç‚¹éƒ½å±äº USB è§„èŒƒç¬¬ 5 èŠ‚ä¸­å®šä¹‰çš„åŒæ­¥ç±»å‹ã€‚ä»¥ä¸‹å„èŠ‚ç®€è¦ä»‹ç»å¯èƒ½çš„åŒæ­¥ç±»å‹ã€‚</p><h1 id="inter-channel-synchronization">Inter Channel Synchronization</h1><p>å¤„ç†éŸ³é¢‘ï¼ˆå°¤å…¶æ˜¯ 3-D éŸ³é¢‘ï¼‰ æ—¶çš„ä¸€ä¸ªé‡è¦é—®é¢˜æ˜¯ä¸åŒç‰©ç†éŸ³é¢‘é€šé“ä¹‹é—´çš„ç›¸ä½å…³ç³»ã€‚</p><p>ä¸ºäº†å‘ä¸»æœºæä¾›ä¸€ä¸ªå¯ç®¡ç†çš„ç›¸ä½æ¨¡å‹ï¼Œéœ€è¦ä¸€ä¸ªéŸ³é¢‘åŠŸèƒ½æ¥æŠ¥å‘Šæ¯ä¸ª Audiostreaming æ¥å£çš„å†…éƒ¨å»¶è¿Ÿã€‚è¿™ç§å»¶è¿Ÿä»¥ï¼ˆå¾®ï¼‰å¸§æ•°è¡¨ç¤ºï¼Œè¿™æ˜¯ç”±äºéŸ³é¢‘åŠŸèƒ½å¿…é¡»ç¼“å†²è‡³å°‘ä¸€ä¸ªï¼ˆå¾®ï¼‰å¸§çš„é‡‡æ ·å€¼ï¼Œä»¥æœ‰æ•ˆåœ°æ¶ˆé™¤ï¼ˆå¾®ï¼‰å¸§å†…çš„æ•°æ®åŒ…æŠ–åŠ¨ã€‚æ­¤å¤–ï¼Œä¸€äº›éŸ³é¢‘å‡½æ•°å°†å¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼Œå› ä¸ºå®ƒä»¬éœ€è¦æ—¶é—´æ¥æ­£ç¡®åœ°è§£é‡Šå’Œå¤„ç†éŸ³é¢‘æ•°æ®æµï¼ˆä¾‹å¦‚ï¼Œå‹ç¼©å’Œè§£å‹ç¼©ï¼‰ã€‚</p><h1 id="audio-function-topology">Audio Function Topology</h1><p>ä¸ºäº†èƒ½å¤Ÿæ“ä½œéŸ³é¢‘åŠŸèƒ½çš„ç‰©ç†å±æ€§ï¼Œå®ƒçš„åŠŸèƒ½å¿…é¡»è¢«åˆ’åˆ†ä¸ºå¯å¯»å€çš„å®ä½“ã€‚ä¸¤ç§ç±»å‹çš„è¿™ç§é€šç”¨å®ä½“è¢«è¯†åˆ«ï¼Œå¹¶è¢«ç§°ä¸º Unit å’Œ Terminalsã€‚æ­¤å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ç§ç‰¹æ®Šç±»å‹çš„å®ä½“è¿™äº›å®ä½“è¢«ç§°ä¸º Clock Entitiesï¼Œå®ƒä»¬ç”¨äºæè¿°å’Œæ“ä½œéŸ³é¢‘å‡½æ•°å†…éƒ¨çš„æ—¶é’Ÿä¿¡å·ã€‚</p><p>Unit æä¾›äº†åŸºæœ¬çš„ building blocks æ¥å……åˆ†æè¿°å¤§å¤šæ•°éŸ³é¢‘åŠŸèƒ½ã€‚éŸ³é¢‘åŠŸèƒ½æ˜¯é€šè¿‡è¿æ¥è¿™äº› Unit ä¸­çš„å‡ ä¸ªæ¥æ„å»ºçš„ã€‚ä¸€ä¸ª Unit æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥ Pins å’Œä¸€ä¸ªè¾“å‡º Pinï¼Œå…¶ä¸­æ¯ä¸ª Pins ä»£è¡¨éŸ³é¢‘åŠŸèƒ½å†…çš„é€»è¾‘éŸ³é¢‘é€šé“ç°‡ï¼ˆè¯·å‚è§ç¬¬ 3.13.1 èŠ‚"éŸ³é¢‘é€šé“ç°‡â€ã€‹ã€‚æ ¹æ®æ‰€éœ€çš„æ‹“æ‰‘ç»“æ„ï¼ŒUnit é€šè¿‡è¿æ¥å…¶ I/0 Pins è¿æ¥åœ¨ä¸€èµ·ã€‚è¯·æ³¨æ„ï¼Œå°†ä¸€ä¸ªå®ä½“çš„è¾“å‡º Pins è¿æ¥åˆ°ä½äºä¸åŒå…¶ä»–å®ä½“ä¸Šçš„å¤šä¸ªè¾“å…¥ Pins æ˜¯å®Œå…¨åˆæ³•çš„ï¼Œæœ‰æ•ˆåœ°åˆ›å»ºäº†ä¸€ä¸ªä¸€å¯¹å¤šè¿æ¥ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜å¼•å…¥äº† Terminals çš„æ¦‚å¿µã€‚æœ‰ä¸¤ç§ç±»å‹çš„ Terminalsã€‚Input Terminals (IT) æ˜¯è¡¨ç¤ºéŸ³é¢‘åŠŸèƒ½å†…éƒ¨éŸ³é¢‘é€šé“çš„èµ·ç‚¹çš„å®ä½“ã€‚Output Terminals (OT) è¡¨ç¤ºéŸ³é¢‘é€šé“çš„ç»“æŸç‚¹ã€‚ä»éŸ³é¢‘åŠŸèƒ½çš„è§’åº¦æ¥çœ‹ USB ç«¯ç‚¹æ˜¯è¾“å…¥æˆ–è¾“å‡ºç«¯å­çš„å…¸å‹ç¤ºä¾‹ã€‚å®ƒæˆ–è€…å‘éŸ³é¢‘åŠŸèƒ½ (IT) æä¾›æ•°æ®æµï¼Œæˆ–è€…æ¶ˆè€—æ¥è‡ªéŸ³é¢‘åŠŸèƒ½ (OT) çš„æ•°æ®æµã€‚</p><p>ä¸€ä¸ª Unit çš„è¾“å…¥ Pins ç¼–å·ä» 1 å¼€å§‹åˆ° Unit ä¸Šçš„è¾“å…¥ Pins æ€»æ•°ã€‚è¾“å‡º Pins å·å§‹ç»ˆä¸º 1ã€‚Input Terminals åªæœ‰ä¸€ä¸ªè¾“å‡º Pinsï¼Œå…¶æ•°é‡æ€»æ˜¯ä¸€ä¸ªã€‚Output Terminals åªæœ‰ä¸€ä¸ªè¾“å…¥ Pins æ°¸è¿œéƒ½æ˜¯ 1ã€‚</p><p>éŸ³é¢‘åŠŸèƒ½ä¸­çš„æ¯ä¸ª Unit éƒ½ç”±å…¶å…³è”çš„å•å…ƒæè¿°ç¬¦ (UD) å®Œæ•´æè¿°ã€‚å•å…ƒæè¿°ç¬¦åŒ…å«è¯†åˆ«å’Œæè¿° Unit æ‰€éœ€çš„æ‰€æœ‰å­—æ®µã€‚åŒæ ·ï¼ŒéŸ³é¢‘å‡½æ•°ä¸­çš„æ¯ä¸ª Terminals éƒ½æœ‰ä¸€ä¸ª Terminals æè¿°ç¬¦ (TD)ã€‚æ­¤å¤–ï¼Œè¿™äº›æè¿°ç¬¦è¿˜æä¾›äº†æœ‰å…³éŸ³é¢‘åŠŸèƒ½çš„æ‹“æ‰‘ç»“æ„çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚å®ƒä»¬å……åˆ†æè¿°äº† Terminals å’Œ Unit æ˜¯å¦‚ä½•ç›¸äº’è¿æ¥çš„ã€‚</p><p>æœ¬è§„èŒƒæè¿°äº†ä»¥ä¸‹å…«ç§ä¸åŒç±»å‹çš„æ ‡å‡† Unit å’Œ Terminalsï¼Œè¢«è®¤ä¸ºè¶³ä»¥ä»£è¡¨å½“ä»Šå’Œä¸ä¹…çš„å°†æ¥å¯ç”¨çš„å¤§å¤šæ•°éŸ³é¢‘åŠŸèƒ½ï¼š</p><ul><li>Input Terminal (IT)</li><li>Output Terminal (OT)</li><li>Mixer Unit (MU)</li><li>Selector Unit (SU)</li><li>Feature Unit (FU)</li><li>Sampling Rate Converter Unit</li><li>Effect Unit (EU)</li><li>Processing Unit (PU)</li><li>Extension Unit (XU)</li></ul><p>é™¤äº† Unit å’Œ Terminals ä¹‹å¤–ï¼Œè¿˜å¼•å…¥äº†æ—¶é’Ÿå®ä½“çš„æ¦‚å¿µã€‚æœ¬è§„èŒƒå®šä¹‰äº†ä¸‰ç§ç±»å‹çš„æ—¶é’Ÿå®ä½“ï¼š</p><ul><li>Clock Source (CS)</li><li>Clock Selector (CX)</li><li>Clock Multiplier (CM)</li></ul><p>æ—¶é’Ÿæºä¸ºéŸ³é¢‘åŠŸèƒ½çš„å…¨éƒ¨æˆ–éƒ¨åˆ†æä¾›ä¸€å®šçš„é‡‡æ ·æ—¶é’Ÿé¢‘ç‡ã€‚æ—¶é’Ÿæºå¯ä»¥ä»£è¡¨ä¸€ä¸ªå†…éƒ¨é‡‡æ ·é¢‘ç‡å‘ç”Ÿå™¨ï¼Œä½†ä¹Ÿå¯ä»¥ä»£è¡¨ä¸€ä¸ªå¤–éƒ¨é‡‡æ ·æ—¶é’Ÿä¿¡å·è¾“å…¥åˆ°éŸ³é¢‘åŠŸèƒ½ã€‚ æ—¶é’Ÿæºæœ‰ä¸€ä¸ªæ—¶é’Ÿè¾“å‡º Pinsï¼Œè¯¥ Pins æºå¸¦ç”±æ—¶é’Ÿæºè¡¨ç¤ºçš„é‡‡æ ·æ—¶é’Ÿä¿¡å·ã€‚æ—¶é’Ÿè¾“å‡º Pins æ•°å§‹ç»ˆä¸º 1ã€‚æ—¶é’Ÿé€‰æ‹©å™¨ç”¨äºåœ¨éŸ³é¢‘åŠŸèƒ½å†…éƒ¨å¯èƒ½æä¾›çš„å¤šä¸ªé‡‡æ ·æ—¶é’Ÿä¿¡å·ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚å®ƒæœ‰å¤šä¸ªæ—¶é’Ÿè¾“å…¥ Pins å’Œä¸€ä¸ªæ—¶é’Ÿè¾“å‡º Pinsã€‚æ—¶é’Ÿè¾“å…¥ Pins çš„ç¼–å·ä» 1 åˆ°æ—¶é’Ÿé€‰æ‹©å™¨ä¸Šæ—¶é’Ÿè¾“å…¥ Pins çš„æ€»æ•°ã€‚</p><p>æ—¶é’Ÿ Multiplier ç”¨äºåœ¨å…¶å•ä¸ªæ—¶é’Ÿè¾“å…¥å¼•è„šå¤„è·å¾—ä¸æ—¶é’Ÿä¿¡å·é¢‘ç‡ä¸åŒçš„æ–°æ—¶é’Ÿä¿¡å·ã€‚å®ƒé€šè¿‡å°†æ—¶é’Ÿä¿¡å·é¢‘ç‡ä¹˜ä»¥åˆ†å­ Pï¼Œå†é™¤ä»¥åˆ†æ¯ Q. å¯¹äºç»™å®šçš„æ—¶é’Ÿ Multiplierï¼ŒP å’Œ Q å€¼æ˜¯å›ºå®šçš„ã€‚ä¿è¯æ–°çš„æ—¶é’Ÿä¿¡å·ä¸è¾“å…¥æ—¶é’Ÿä¿¡å·åŒæ­¥ã€‚æ—¶é’Ÿ Multiplier æœ‰ä¸€ä¸ªè¾“å…¥ Pins å’Œä¸€ä¸ªè¾“å‡º Pinsï¼Œå®ƒä»¬çš„æ•°å­—æ€»æ˜¯ä¸€ä¸ªã€‚</p><p>é€šè¿‡ä½¿ç”¨æ—¶é’Ÿæºã€æ—¶é’Ÿé€‰æ‹©å™¨å’Œæ—¶é’Ÿ Multiplier å®ä½“çš„ç»„åˆï¼Œå¯ä»¥å°†æœ€å¤æ‚çš„æ—¶é’Ÿç³»ç»Ÿè¡¨ç¤ºå‡ºæ¥ï¼Œå¹¶å°†å…¶æš´éœ²åœ¨ä¸»æœºè½¯ä»¶ä¸­ã€‚</p><p>æ—¶é’Ÿè¾“å…¥å’Œè¾“å‡º Pins ä¸ä¸ºå•å…ƒå’Œç«¯å­å®šä¹‰çš„è¾“å…¥å’Œè¾“å‡º Pins æœ‰æœ¬è´¨çš„åŒºåˆ«ã€‚æ—¶é’Ÿ Pins åªæºå¸¦æ—¶é’Ÿä¿¡å·ï¼Œå› æ­¤ä¸èƒ½è¿æ¥åˆ° unit æˆ– Terminals è¾“å…¥å’Œè¾“å‡º Pinsã€‚å®ƒä»¬ä»…ç”¨äºè¡¨ç¤ºæ—¶é’Ÿç”µè·¯æ‹“æ‰‘ã€‚ æ¯ä¸ªè¾“å…¥å’Œè¾“å‡º Terminals å…·æœ‰è¿æ¥åˆ°æ—¶é’Ÿå®ä½“çš„æ—¶é’Ÿè¾“å‡º Pins å’Œå•ä¸ªæ—¶é’Ÿè¾“å…¥ Pinsã€‚æ—¶é’Ÿè¾“å‡º Pins æ‰€æºå¸¦çš„æ—¶é’Ÿä¿¡å·å†³å®šäº† Terminals æ‰€ä»£è¡¨çš„ç¡¬ä»¶å·¥ä½œçš„é‡‡æ ·é¢‘ç‡ã€‚ æ¯ä¸ªé‡‡æ ·é€Ÿç‡è½¬æ¢å™¨å•å…ƒæœ‰ä¸¤ä¸ªæ—¶é’Ÿè¾“å…¥ Pinsï¼Œé€šå¸¸è¿æ¥åˆ°ä¸¤ä¸ªä¸åŒæ—¶é’Ÿå®ä½“çš„æ—¶é’Ÿè¾“å‡º Pinsã€‚è¿™äº›æ—¶é’Ÿè¾“å‡º Pins æºå¸¦çš„æ—¶é’Ÿä¿¡å·å†³å®šé‡‡æ ·ç‡è½¬æ¢å•å…ƒè½¬æ¢çš„é‡‡æ ·é¢‘ç‡ã€‚</p><p>æ¯ä¸ªæ—¶é’Ÿå®ä½“ç”±æ—¶é’Ÿå®ä½“æè¿°ç¬¦ (CED) æè¿°ã€‚æ—¶é’Ÿå®ä½“æè¿°ç¬¦åŒ…å«è¯†åˆ«å’Œæè¿°æ—¶é’Ÿå®ä½“çš„æ‰€æœ‰å¿…è¦å­—æ®µã€‚ æè¿°ç¬¦å°†åœ¨æœ¬æ–‡æ¡£ç¬¬ 4 èŠ‚â€œæè¿°ç¬¦â€ä¸­è¿›ä¸€æ­¥è¯¦ç»†ä»‹ç»ã€‚å•å…ƒæè¿°ç¬¦ã€ç»ˆç«¯æè¿°ç¬¦å’Œæ—¶é’Ÿå®ä½“æè¿°ç¬¦çš„é›†åˆä¸ºä¸»æœºæä¾›äº†éŸ³é¢‘åŠŸèƒ½çš„å®Œæ•´æè¿°ã€‚æ­¤ä¿¡æ¯é€šå¸¸åœ¨æšä¸¾æ—¶ä»è®¾å¤‡ä¸­æ£€ç´¢ã€‚é€šè¿‡è§£ææè¿°ç¬¦ï¼Œé€šç”¨éŸ³é¢‘é©±åŠ¨ç¨‹åºåº”è¯¥èƒ½å¤Ÿå®Œå…¨æ§åˆ¶éŸ³é¢‘åŠŸèƒ½ï¼ˆæ‰©å±•å•å…ƒè¡¨ç¤ºçš„åŠŸèƒ½é™¤å¤–ï¼‰ã€‚</p><p>å®Œæ•´çš„éŸ³é¢‘åŠŸèƒ½æè¿°ç¬¦é›†ä»…æä¾›éŸ³é¢‘åŠŸèƒ½çš„é™æ€åˆå§‹æè¿°ã€‚åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè®¸å¤šäº‹ä»¶ï¼Œè¿«ä½¿éŸ³é¢‘åŠŸèƒ½æ”¹å˜å…¶çŠ¶æ€ã€‚å¿…é¡»å°†è¿™äº›æ›´æ”¹é€šçŸ¥ä¸»æœºè½¯ä»¶ï¼Œä»¥ä¾¿å§‹ç»ˆä¸éŸ³é¢‘åŠŸèƒ½ä¿æŒâ€åŒæ­¥â€ä¸€ä¸ªå¹¿æ³›çš„ä¸­æ–­æœºåˆ¶å·²ç»åˆ°ä½ï¼Œä»¥æŠ¥å‘Šä»»ä½•å’Œæ‰€æœ‰çš„çŠ¶æ€å˜åŒ–çš„ä¸»æœºè½¯ä»¶ã€‚</p><p>å¦‚å›¾ 3-2 æ‰€ç¤ºï¼Œâ€œéŸ³é¢‘å†…éƒ¨åŠŸèƒ½â€è¯´æ˜äº†ä¸Šé¢å®šä¹‰çš„æ¦‚å¿µã€‚ä½¿ç”¨è¿›ä¸€æ­¥å®šä¹‰çš„å›¾æ ‡ç¬¦å·ï¼Œå®ƒæè¿°äº†ä¸€ä¸ªå‡æƒ³çš„åŒ…å« 16 ä¸ªå®ä½“çš„éŸ³é¢‘åŠŸèƒ½ï¼š3 ä¸ªè¾“å…¥ç«¯å­ã€5 ä¸ªå•å…ƒã€3 ä¸ªè¾“å‡ºç«¯å­ã€2 ä¸ªæ—¶é’Ÿæºã€1 ä¸ªæ—¶é’Ÿé€‰æ‹©å™¨å’Œ 2 ä¸ªæ—¶é’Ÿ Multiplierã€‚æ¯ä¸ªå®ä½“éƒ½æœ‰å…¶å”¯ä¸€çš„ IDï¼ˆä» 1 åˆ° 16) å’Œæè¿°ç¬¦ï¼Œè¯¥æè¿°ç¬¦å……åˆ†æè¿°äº†å®ä½“çš„åŠŸèƒ½ä»¥åŠè¯¥ç‰¹å®šå®ä½“å¦‚ä½•è¿æ¥åˆ°éŸ³é¢‘åŠŸèƒ½çš„æ•´ä½“æ‹“æ‰‘ä¸­ã€‚</p><p>è¾“å…¥ç«¯å­ 1(IT1) å¯ä»¥è¡¨ç¤ºç”¨äºå°†éŸ³é¢‘ä»ä¸»æœºæµå¼ä¼ è¾“åˆ°éŸ³é¢‘è®¾å¤‡çš„ USBOUT ç«¯ç‚¹ï¼›IT2 å¯ä»¥æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„è¡¨ç¤ºéŸ³é¢‘è®¾å¤‡ä¸Šçš„ Line-IN è¿æ¥å™¨ï¼›IT3 å¯ä»¥æ˜¯éŸ³é¢‘è®¾å¤‡ä¸Šçš„æ¨¡æ‹Ÿéº¦å…‹é£è¾“å…¥è¿æ¥å™¨ã€‚é€‰æ‹©å™¨å•å…ƒ 4(SU4) åœ¨æ¥è‡ªä¸»æœºçš„éŸ³é¢‘å’Œ Line in è¿æ¥å™¨ä¸Šçš„éŸ³é¢‘ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ç‰¹å¾å•å…ƒ 5(FU 5) è¢«ç”¨æ¥æ§åˆ¶éŸ³é¢‘ ï¼ˆéŸ³é‡ï¼Œä½éŸ³ï¼Œé«˜éŸ³Â·Â·.)ï¼Œç„¶åå°†å…¶æä¾›ç»™è¾“å‡ºç«¯å­ 9(OT9)ã€‚ OT9 å¯ä»¥æ˜¯éŸ³é¢‘è®¾å¤‡ä¸Šçš„è€³æœºè¾“å‡ºæ’å­”çš„è¡¨ç¤ºã€‚</p><p>(USB OUTã€Line In å’Œ MicIn) è¿æ¥åˆ°æ··éŸ³å™¨å•å…ƒ 6 (MU 6)ã€‚ç„¶åï¼Œæ··éŸ³å™¨çš„è¾“å‡ºè¢«é€å…¥å¤„ç†å•å…ƒ 7 (PU 7)ï¼Œå®ƒå¯ä»¥å¯¹æ··éŸ³æ‰§è¡Œä¸€äº›éŸ³é¢‘å¤„ç†ç®—æ³•ã€‚ç»“æœåˆè¢«å‘é€åˆ° FU8ï¼Œåœ¨é‚£é‡Œå¯¹éŸ³é¢‘ ï¼ˆéŸ³é‡ã€‚..) è¿›è¡Œä¸€äº›æœ€åçš„è°ƒæ•´ã€‚FU 8 ä¸ OT10 å’Œ OT11 ç›¸è¿ã€‚OT10 å¯ä»¥è¡¨ç¤ºé›†æˆåˆ°éŸ³é¢‘è®¾å¤‡ä¸­çš„æ‰¬å£°å™¨ï¼ŒOT11 å¯ä»¥è¡¨ç¤ºç”¨äºå°†å¤„ç†åçš„éŸ³é¢‘å‘é€åˆ°ä¸»æœºä»¥è¿›è¡Œå½•åˆ¶çš„ USBIN ç«¯ç‚¹ã€‚</p><p>æ—¶é’Ÿæº 12(CS12) å¯ä»¥è¡¨ç¤ºå†…éƒ¨é‡‡æ ·é¢‘ç‡å‘ç”Ÿå™¨ï¼Œä¾‹å¦‚ä»¥ 96 kHz è¿è¡Œã€‚æ—¶é’Ÿæº 15(CS15) å¯ä»¥æ˜¯å¤–éƒ¨ä¸»é‡‡æ ·æ—¶é’Ÿè¾“å…¥çš„è¡¨ç¤ºï¼Œå…¶å¯ä»¥ç”¨äºå°†è®¾å¤‡åŒæ­¥åˆ°å¤–éƒ¨æºã€‚æ—¶é’Ÿé€‰æ‹©å™¨ 13(CS13) å¯åœ¨ä¸¤ä¸ªå¯ç”¨æ—¶é’Ÿæºä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚CS13 çš„è¾“å‡ºä¸º IT1 IT2 IT3ã€OT10 å’Œ OT11 æä¾› 96kHz çš„é‡‡æ ·é¢‘ç‡ã€‚æ—¶é’Ÿ Multiplier CM14 è¿›ä¸€æ­¥å°†è¯¥æ—¶é’Ÿä¿¡å·ä¹˜ä»¥ 0.5ï¼Œä¸º OT9 æä¾› 48kHz çš„é‡‡æ ·é¢‘ç‡ä»¥é©±åŠ¨è€³æœºã€‚ç”±äºéŸ³é¢‘åŠŸèƒ½ä¸­ä½¿ç”¨çš„æ‰€æœ‰é‡‡æ ·é¢‘ç‡å§‹ç»ˆæ¥è‡ªå•ä¸ªä¸»æ—¶é’Ÿï¼ˆå†…éƒ¨æˆ–å¤–éƒ¨ï¼‰ï¼Œå› æ­¤éŸ³é¢‘åŠŸèƒ½ä¸­çš„æ‰€æœ‰éŸ³é¢‘æµéƒ½æ˜¯åŒæ­¥çš„ã€‚</p><p>æœ‰å…³æè¿°ç¬¦å†…å®¹çš„è¿›ä¸€æ­¥è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æœ¬æ–‡æ¡£çš„ç¬¬ 4 èŠ‚â€œæè¿°ç¬¦â€</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac2.png"></p><p>åœ¨å®ä½“å†…éƒ¨ï¼Œé€šè¿‡éŸ³é¢‘æ§ä»¶è¿›ä¸€æ­¥æè¿°åŠŸèƒ½ã€‚æ§ä»¶é€šå¸¸æä¾›å¯¹ç‰¹å®šéŸ³é¢‘æˆ–æ—¶é’Ÿå±æ€§çš„è®¿é—®ã€‚æ¯ä¸ª Control éƒ½æœ‰ä¸€ç»„å±æ€§ï¼Œè¿™äº›å±æ€§å¯ä»¥è¢«æ“ä½œï¼Œæˆ–è€…æä¾›æœ‰å…³æ§ä»¶è¡Œä¸ºçš„é™„åŠ ä¿¡æ¯ã€‚æ§ä»¶å¯ä»¥å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š</p><ul><li>Current setting attribute</li><li>Range attribute triplet consisting of: â€¢ Minimum setting attribute â€¢ Maximum setting attribute â€¢ Resolution attribute</li></ul><p>ä¾‹å¦‚ï¼Œè€ƒè™‘è¦å¯¹å•å…ƒå†…çš„éŸ³é‡æ§åˆ¶ã€‚é€šè¿‡å‘å‡ºé€‚å½“çš„ Get è¯·æ±‚ï¼Œä¸»æœºè½¯ä»¶å¯ä»¥è·å¾—éŸ³é‡æ§åˆ¶çš„å±æ€§å€¼ï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨å®ƒä»¬åœ¨å±æ…•ä¸Šæ­£ç¡®æ˜¾ç¤ºæ§åˆ¶ã€‚è®¾ç½®éŸ³é‡æ§åˆ¶çš„å½“å‰å±æ€§å…è®¸ä¸»æœºè½¯ä»¶æ›´æ”¹éŸ³é‡æ§åˆ¶çš„éŸ³é‡è®¾ç½®ã€‚ æ­¤å¤–ï¼ŒéŸ³é¢‘å‡½æ•°ä¸­çš„æ¯ä¸ªå®ä½“éƒ½å¯ä»¥å…·æœ‰å†…å­˜ç©ºé—´å±æ€§ã€‚è¯¥å±æ€§å¯é€‰åœ°æä¾›å¯¹ Entity çš„å†…éƒ¨å†…å­˜ç©ºé—´çš„é€šç”¨è®¿é—®ã€‚è¿™å¯ä»¥ç”¨äºé€šè¿‡ä¸€èˆ¬æä¾›çš„è®¿é—®æ¥å®ç°ç‰¹å®šäºä¾›åº”å•†çš„å®ä½“æ§åˆ¶ã€‚</p><h2 id="audio-channel-cluster">Audio Channel Cluster</h2><p>éŸ³é¢‘é€šé“ç°‡æ˜¯ä¸€ç»„æ‰¿è½½ç´§å¯†ç›¸å…³çš„åŒæ­¥éŸ³é¢‘ä¿¡æ¯çš„éŸ³é¢‘é€šé“ã€‚åœ¨éŸ³é¢‘åŠŸèƒ½å†…éƒ¨ï¼Œå®Œå…¨æŠ½è±¡äº†é€šè¿‡ç»ˆç«¯å’Œå•å…ƒä¹‹é—´çš„è¿æ¥ä¼ è¾“çš„éŸ³é¢‘æ•°æ®çš„å®é™…ç‰©ç†è¡¨ç¤ºå½¢å¼ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªéŸ³é¢‘é€šé“è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé€»è¾‘é€šé“ä»¥åŠè¯¥é€šé“çš„æ‰€æœ‰ç‰©ç†å±æ€§ï¼ˆä½å®½ã€ä½åˆ†è¾¨ç‡ç­‰ï¼‰ã€‚</p><p>é›†ç¾¤ä¸­çš„é€šé“ç¼–å·ä»é€šé“ 1 å¼€å§‹ï¼Œä¸€ç›´åˆ°é›†ç¾¤ä¸­çš„é€šé“æ•°ã€‚è™šæ‹Ÿé€šé“é›¶æ˜¯ç”¨æ¥è§£å†³ä¸€ä¸ªå•ä½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰çš„ä¸»æ§åˆ¶ï¼Œæœ‰æ•ˆåœ°å½±å“æ‰€æœ‰çš„æ¸ é“ã€‚æ³¨æ„ä¸»æ§åˆ¶ ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰å¿…é¡»ä¸æ¯é€šé“æ§åˆ¶åˆ†å¼€æ¥å®ç°ã€‚æ›´æ”¹ä¸»æ§ä»¶çš„è®¾ç½®ä¸ä¼šå½±å“ä»»ä½•å•ä¸ªé€šé“æ§ä»¶çš„è®¾ç½®ã€‚éŸ³é¢‘é€šé“ç¾¤é›†ä¸­ç‹¬ç«‹é€šé“çš„æœ€å¤§æ•°é‡é™åˆ¶ä¸º 255ï¼ˆé€šé“é›¶ç”¨äºå¼•ç”¨ä¸»é€šé“ï¼‰ã€‚ åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒéŸ³é¢‘é›†ç¾¤ä¸­çš„æ¯ä¸ªé€šé“éƒ½ä¸ä¾¦å¬ç©ºé—´ä¸­çš„æŸä¸ªä½ç½®ç›¸å…³è”ã€‚è¿™æ–¹é¢çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹æ˜¯åŒ…å«å·¦å³éŸ³é¢‘é€šé“çš„ç¾¤é›†ã€‚ä¸ºäº†èƒ½å¤Ÿä»¥å¯ç®¡ç†çš„æ–¹å¼æè¿°æ›´å¤æ‚çš„æƒ…å†µï¼Œæœ¬è§„èŒƒå¯¹éŸ³é¢‘é€šé“ç°‡ä¸­é€šé“çš„é¡ºåºæ–½åŠ äº†ä¸€äº›é™åˆ¶å’Œçº¦æŸã€‚ ä¸ºäº†æ”¯æŒåœ¨è¿æ¥ä¸ŠæµåŠ¨çš„ä¿¡æ¯ä¸èƒ½è¢«è§£é‡Šä¸ºé€»è¾‘éŸ³é¢‘é€šé“çš„é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œæœ¬è§„èŒƒå®šä¹‰äº†ä¸€ä¸ªé¢å¤–çš„è™šæ‹Ÿç©ºé—´ä½ç½®ï¼Œç§°ä¸ºåŸå§‹æ•°æ®ã€‚æ­¤ç©ºé—´ä½ç½®ä¸æœ¬è§„èŒƒä¸­å®šä¹‰çš„æ‰€æœ‰å…¶ä»–ç©ºé—´ä½ç½®ç›¸äº’æ’æ–¥ã€‚å®ƒä¸èƒ½ä¸å…¶ä»–ç©ºé—´ä½ç½®å…±å­˜äºåŒä¸€é›†ç¾¤ä¸­ï¼Œå…¶ä½¿ç”¨å—åˆ°å¾ˆå¤§çš„é™åˆ¶ã€‚å®ƒåªèƒ½ç”¨äºä¸æ“ä½œéŸ³é¢‘å†…å®¹çš„å®ä½“ä¹‹é—´çš„è¿æ¥ã€‚è¿™äº›å®ä½“åªèƒ½æ˜¯è¾“å…¥ç«¯å­å’Œè¾“å‡ºç«¯å­ã€‚ç¦æ­¢å¯¹åŸå§‹æ•°æ®è™šæ‹Ÿç©ºé—´ä½ç½®çš„æ‰€æœ‰å…¶ä»–ä½¿ç”¨ã€‚ æœ‰ 28 ä¸ªé¢„å®šä¹‰çš„ç©ºé—´ä½ç½® (27+1 ä¸ªè™šæ‹Ÿï¼‰:</p><ul><li>Front Left - FL</li><li>Front Right - FR</li><li>Front Center - FC</li><li>Low Frequency Effects - LFE</li><li>Back Left - BL</li><li>Back Right - BR</li><li>Front Left of Center - FLC</li><li>Front Right of Center - FRC</li><li>Back Center - BC</li><li>Side Left - SL</li><li>Side Right - SR</li><li>Top Center - TC</li><li>Top Front Left - TFL</li><li>Top Front Center - TFC</li><li>Top Front Right - TFR</li><li>Top Back Left - TBL</li><li>Top Back Center - TBC</li><li>Top Back Right â€“ TBR</li><li>Top Front Left of Center â€“ TFLC</li><li>Top Front Right of C</li><li>Left Low Freque</li><li>Right Low Frequen</li><li>Top Side Left â€“ TSL</li><li>Top Side Right â€“ TSR</li><li>Bottom Center â€“ BC</li><li>Back Left of Center â€“ BLC</li><li>Back Right of Center â€“ BRC</li><li>Raw Data â€“ RD</li></ul><p>å¦‚æœéŸ³é¢‘é€šé“ç°‡ä¸­å­˜åœ¨ä¸æŸäº›å…ˆå‰å®šä¹‰çš„ç©ºé—´ä½ç½®ç›¸å¯¹åº”çš„é€šé“ï¼Œåˆ™å®ƒä»¬å¿…é¡»æŒ‰ç…§ä¸Šè¿°åˆ—è¡¨ä¸­æŒ‡å®šçš„é¡ºåºå‡ºç°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç¾¤é›†åŒ…å«å‰å·¦ã€å‰å³å’Œ LFE é€šé“ï¼Œåˆ™é€šé“ 1 æ˜¯å‰å·¦ï¼Œé€šé“ 2 æ˜¯å‰å³ï¼Œé€šé“ 3 æ˜¯ LFEã€‚</p><p>éŸ³é¢‘é€šé“ç¾¤é›†ä»…å…·æœ‰ä¸¤ä¸ªå±æ€§</p><ul><li>ç¾¤é›†ä¸­çš„éŸ³é¢‘é€šé“æ•°</li><li>ç¾¤é›†ä¸­æ¯ä¸ªéŸ³é¢‘é€šé“çš„ç©ºé—´ä½ç½®ï¼Œå¯ä»¥æ˜¯é¢„å®šä¹‰çš„ ï¼ˆå‰å·¦ã€å‰å³ã€åå·¦ã€LFE ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„ã€‚ æ³¨ï¼šè‡ªå®šä¹‰ä¹Ÿå¯ç”¨äºæŒ‡å®šä¸ä»»ä½•ç©ºé—´ä½ç½®ä¸ç›´æ¥ç›¸å…³çš„é€šé“åˆ†é…ã€‚ä¸€ä¸ªç®€å•çš„é€šé“æšä¸¾æ¨¡å¼ï¼ˆé€šé“ 1ã€é€šé“ 2 ç­‰ï¼‰ å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ã€‚</li></ul><p>æ¯ä¸ªéŸ³é¢‘é€šé“ç¾¤é›†éƒ½æœ‰ä¸€ä¸ªç¾¤é›†æè¿°ç¬¦ (CD)ï¼Œå®ƒå®Œå…¨æè¿°äº†ç¾¤é›†ã€‚ æœ¬è§„èŒƒä¸­ä½¿ç”¨äº†ä¸¤ç§ç±»å‹çš„éŸ³é¢‘é€šé“é›†ç¾¤ï¼š</p><ul><li>é€»è¾‘éŸ³é¢‘é€šé“ç°‡æè¿°éŸ³é¢‘åŠŸèƒ½ ï¼ˆå°é—­æ¡†ï¼‰å†…çš„éŸ³é¢‘æ•°æ®ï¼Œå…¶ä¸­éŸ³é¢‘é€šé“è¢«è§†ä¸ºé€»è¾‘æ¦‚å¿µã€‚</li><li>ç‰©ç†éŸ³é¢‘é€šé“ç°‡æè¿° AudioStreaming æ¥å£ä¸­çš„éŸ³é¢‘æ•°æ®ï¼Œè¯¥æ¥å£å¤„ç†éŸ³é¢‘æµä¸­çš„å®é™…ç‰©ç†éŸ³é¢‘é€šé“ï¼ˆç¦»æ•£æˆ–ç¼–ç ï¼‰ã€‚</li></ul><h2 id="mapping-between-physical-and-logical-audio-channel-clusters">Mapping between Physical and Logical Audio Channel Clusters</h2><p>AudioStreaming ç•Œé¢å¯ä»¥æœ‰å¤šä¸ªå¤‡ç”¨è®¾ç½®ï¼Œæ¯ä¸ªè®¾ç½®ä»£è¡¨ç•Œé¢çš„ä¸åŒâ€œæ“ä½œæ¨¡å¼â€ã€‚ä¾‹å¦‚ï¼Œè¡¨ç¤ºå¤–éƒ¨ S/PDIF è¿æ¥çš„ AudioStreaming æ¥å£å¯ä»¥æœ‰ä¸€ä¸ªå¤‡ç”¨è®¾ç½®ï¼Œç”¨äº S/PDIF è¿æ¥æºå¸¦ Stereo PCM æ•°æ®æ—¶ ï¼ˆä¸¤ä¸ªé€šé“ï¼‰å’Œå¦ä¸€ä¸ªå¤‡ç”¨è®¾ç½®ï¼Œå½“ AC-3 ç¼–ç çš„ä¿¡æ¯é€šè¿‡ S/PDIF è¿æ¥ (6 ä¸ªé€šé“ï¼‰ä¼ é€æ—¶ä½¿ç”¨ã€‚å› æ­¤ï¼Œä»ä¸€ä¸ªå¤‡ç”¨è®¾ç½®åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå¯ä»¥æœ‰æ•ˆåœ°æ›´æ”¹æ¥å£ä¸­å®é™…éŸ³é¢‘é€šé“çš„æ•°é‡ï¼Œè¿˜å¯èƒ½æ›´æ”¹è¿™äº›é€šé“çš„ç©ºé—´ä½ç½®ã€‚ AudioStreaming æ¥å£ä¸éŸ³é¢‘å‡½æ•°ä¸­ç›¸åº”çš„ Terminal ä¹‹é—´å­˜åœ¨ä¸€å¯¹ä¸€å…³ç³»ã€‚ä½†æ˜¯ï¼ŒAudioStreaming ç•Œé¢å¯ä»¥æœ‰å¤šä¸ªå¤‡ç”¨è®¾ç½®ï¼Œæ¯ä¸ªå¤‡ç”¨è®¾ç½®å…·æœ‰ä¸åŒçš„ç‰©ç†éŸ³é¢‘é€šé“ç¾¤é›†å¿…é¡»èƒ½å¤Ÿå°†æ¯ä¸ªç‰©ç†éŸ³é¢‘é€šé“ç°‡æ˜ å°„åˆ°é€šè¿‡ç›¸åº”ç»ˆç«¯æ˜¾ç¤ºçš„å•ä¸ªé€»è¾‘éŸ³é¢‘é€šé“ç°‡ä¸Šã€‚å› æ­¤ï¼Œé€»è¾‘éŸ³é¢‘é€šé“ç¾¤é›†æœ¬è´¨ä¸Šæ˜¯åŠ¨æ€çš„ï¼Œå¹¶ä¸”åœ¨ä¸º AudioStreaming æ¥å£é€‰æ‹©ä¸åŒçš„å¤‡ç”¨è®¾ç½®æ—¶å¯èƒ½ä¼šå‘ç”Ÿæ›´æ”¹ã€‚å½“å‰çš„é€»è¾‘éŸ³é¢‘é€šé“é›†ç¾¤å¯ä»¥é€šè¿‡ç»ˆç«¯ä¸Šçš„è·å–é›†ç¾¤æ§åˆ¶è¯·æ±‚ï¼ˆå¦‚æœå®ç°çš„è¯ï¼‰æ¥æ£€ç´¢ã€‚æˆ–è€…ï¼Œä¸»æœºè½¯ä»¶å¯ä»¥è·Ÿè¸ªå½“å‰å¤„äºæ´»åŠ¨çŠ¶æ€çš„å¤‡ç”¨è®¾ç½®ï¼Œå¹¶ä»è¯¥å¤‡ç”¨è®¾ç½®ä¸­æ£€ç´¢ç‰©ç†éŸ³é¢‘é€šé“ç°‡æè¿°ï¼Œå¹¶å°†å…¶ç”¨ä½œé€»è¾‘é€šé“ç°‡å®šä¹‰ã€‚</p><h2 id="input-terminal">Input Terminal</h2><p>è¾“å…¥ç«¯å­ (IT) ç”¨äºéŸ³é¢‘åŠŸèƒ½çš„â€œoutside worldâ€å’ŒéŸ³é¢‘åŠŸèƒ½ä¸­çš„å…¶ä»–å•å…ƒä¹‹é—´çš„æ¥å£ã€‚å®ƒä½œä¸ºéŸ³é¢‘ä¿¡æ¯æµå…¥éŸ³é¢‘åŠŸèƒ½çš„å®¹å™¨ã€‚</p><p>è¾“å…¥ç«¯å­å¯ä»¥ä»£è¡¨é™¤ USB OUT ç«¯ç‚¹ä¹‹å¤–çš„éŸ³é¢‘åŠŸèƒ½çš„è¾“å…¥ï¼ŒéŸ³é¢‘è®¾å¤‡ä¸Šçš„ Line in è¿æ¥å™¨å°±æ˜¯æ­¤ç±»é USB è¾“å…¥çš„ç¤ºä¾‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœéŸ³é¢‘æµé€šè¿‡ USB OUT ç«¯ç‚¹è¿›å…¥éŸ³é¢‘åŠŸèƒ½ï¼Œåˆ™åŒ…å«è¯¥ç«¯ç‚¹çš„ AudioStreaming æ¥å£ä¸å…¶å…³è”çš„è¾“å…¥ç«¯å­ä¹‹é—´å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ç‰¹å®šäºç±»çš„æ¥å£æè¿°ç¬¦åŒ…å«ä¸€ä¸ªå­—æ®µï¼Œè¯¥å­—æ®µä¿å­˜å¯¹æ­¤è¾“å…¥ç»ˆç«¯çš„ç›´æ¥å¼•ç”¨ã€‚ä¸»æœºéœ€è¦åŒæ—¶ä½¿ç”¨éŸ³é¢‘æµæ¥å£å’Œç«¯ç‚¹æè¿°ç¬¦ä»¥åŠè¾“å…¥ç»ˆç«¯æè¿°ç¬¦ï¼Œä»¥å……åˆ†äº†è§£è¾“å…¥ç»ˆç«¯çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚ä¸æµç›¸å…³çš„å‚æ•°å­˜å‚¨åœ¨ AudioStreaming æè¿°ç¬¦ä¸­ã€‚æ§åˆ¶ç›¸å…³å‚æ•°å­˜å‚¨åœ¨ Terminal Deserintor ä¸­ã€‚</p><p>ä»ä¼ å…¥çš„ï¼ˆå¯èƒ½æ˜¯ç¼–ç çš„ï¼‰éŸ³é¢‘æµåˆ°é€»è¾‘éŸ³é¢‘é€šé“çš„è½¬æ¢è¿‡ç¨‹æ€»æ˜¯æ¶‰åŠåˆ°æŸç§è§£ç å¼•æ“ã€‚æœ¬è§„èŒƒå®šä¹‰äº†å‡ ç§ç±»å‹çš„è§£ç ï¼ˆå‚è§ç¬¬ 3.14 èŠ‚â€œç¼–ç å™¨å’Œè§£ç å™¨â€)ã€‚è¿™äº›è§£ç ç±»å‹çš„èŒƒå›´ä»ç›¸å½“çç¢çš„è§£ç æ–¹æ¡ˆï¼Œå¦‚å°†äº¤é”™çš„ç«‹ä½“å£° 16 ä½ PCM æ•°æ®è½¬æ¢ä¸ºå·¦å’Œå³é€»è¾‘é€šé“ï¼Œåˆ°éå¸¸å¤æ‚çš„æ–¹æ¡ˆï¼Œå¦‚å°† MPEG-27.1 ç¼–ç çš„éŸ³é¢‘æµè½¬æ¢ä¸ºå·¦å‰ï¼Œå‰å·¦ä¸­å¿ƒï¼Œå‰ä¸­å¿ƒï¼Œå‰å³ä¸­å¿ƒå‰å³ï¼Œåå·¦ï¼Œåå³å’Œä½é¢‘æ•ˆæœé€»è¾‘é€šé“ã€‚ è§£ç å¼•æ“è¢«è®¤ä¸ºæ˜¯å®ä½“çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå®é™…ä¸Šæ¥æ”¶ç¼–ç çš„éŸ³é¢‘æ•°æ®æµï¼ˆç±»ä¼¼äº USBAudiostreaming æ¥å£ï¼‰ã€‚å› æ­¤ï¼Œè§£ç ç±»å‹éšå«åœ¨ bmFormats å€¼ä¸­ï¼Œè¯¥å€¼ä½äºç‰¹å®šäºç±»çš„ AudioStreaming æ¥å£æè¿°ç¬¦ä¸­ã€‚ç‰¹å®šäºè§£ç å¼•æ“çš„è¯·æ±‚å¿…é¡»æŒ‡å‘ Audiostreaming æ¥å£ã€‚ç›¸å…³è”çš„è¾“å…¥ç«¯åœ¨é€»è¾‘ä¿¡é“è¢«è§£ç åå¤„ç†å®ƒä»¬ã€‚</p><p>è¾“å…¥ç«¯å­å…·æœ‰å•ä¸ªæ—¶é’Ÿè¾“å…¥ Pinsã€‚è¯¥ Pins ä¸Šçš„æ—¶é’Ÿä¿¡å·ç”¨ä½œç”±è¯¥è¾“å…¥ç«¯å­è¡¨ç¤ºçš„æ‰€æœ‰åº•å±‚ç¡¬ä»¶çš„é‡‡æ ·æ—¶é’Ÿã€‚åœ¨è¾“å…¥ç«¯å­æè¿°ç¬¦ä¸­æœ‰ä¸€ä¸ªå­—æ®µå”¯ä¸€æ ‡è¯†è¾“å…¥ç«¯å­æ‰€è¿æ¥çš„æ—¶é’Ÿå®ä½“ã€‚è¾“å…¥ç«¯å­çš„ç¬¦å·å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac3.png"></p><h2 id="output-terminal">Output Terminal</h2><p>è¾“å‡ºç»ˆç«¯ (OT) ç”¨äºéŸ³é¢‘åŠŸèƒ½å†…éƒ¨çš„å•å…ƒä¸â€œoutside worldâ€ä¹‹é—´çš„æ¥å£ã€‚å®ƒä½œä¸ºéŸ³é¢‘ä¿¡æ¯çš„å‡ºå£ï¼Œæµå‡ºéŸ³é¢‘åŠŸèƒ½ã€‚å®ƒçš„åŠŸèƒ½æ˜¯åœ¨è¾“å‡ºéŸ³é¢‘æ•°æ®ä»åŸå§‹ç‹¬ç«‹çš„é€»è¾‘é€šé“æ­£ç¡®æ‰“åŒ…åˆ°è¾“å‡ºéŸ³é¢‘æµï¼ˆç¼–ç è¿‡ç¨‹ï¼‰ ä¹‹å‰ï¼Œè¡¨ç¤ºè¾“å‡ºéŸ³é¢‘æ•°æ®çš„æ¥æ”¶å™¨ã€‚éŸ³é¢‘é€šé“ç¾¤é›†é€šè¿‡å•ä¸ªè¾“å…¥ Pins è¿›å…¥è¾“å‡ºç«¯å­ã€‚</p><p>è¾“å‡ºç«¯å­å¯ä»¥è¡¨ç¤ºé™¤ USB IN ç«¯ç‚¹ä¹‹å¤–çš„éŸ³é¢‘ Function çš„è¾“å‡ºã€‚å†…ç½®äºéŸ³é¢‘è®¾å¤‡æˆ– Line Out è¿æ¥å™¨ä¸­çš„æ‰¬å£°å™¨å°±æ˜¯è¿™ç§é USB è¾“å‡ºçš„ç¤ºä¾‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœéŸ³é¢‘æµé€šè¿‡ USB IN ç«¯ç‚¹ç¦»å¼€éŸ³é¢‘ Functionï¼Œåˆ™åŒ…å«æ­¤ç«¯ç‚¹çš„ Audiostreaming æ¥å£ä¸å…¶å…³è”çš„è¾“å‡ºç«¯å­ä¹‹é—´å­˜åœ¨ä¸€å¯¹ä¸€å…³ç³»ã€‚ç‰¹å®šäºç±»çš„æ¥å£æè¿°ç¬¦åŒ…å«ä¸€ä¸ªå­—æ®µï¼Œè¯¥å­—æ®µä¿å­˜å¯¹æ­¤è¾“å‡ºç»ˆç«¯çš„ç›´æ¥å¼•ç”¨ã€‚ä¸»æœºéœ€è¦åŒæ—¶ä½¿ç”¨ AudioStreaming æ¥å£å’Œç«¯ç‚¹æè¿°ç¬¦ä»¥åŠè¾“å‡ºç»ˆç«¯æè¿°ç¬¦ï¼Œä»¥å……åˆ†äº†è§£è¾“å‡ºç»ˆç«¯çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚ä¸æµç›¸å…³çš„å‚æ•°å­˜å‚¨åœ¨ Audiostreaming æè¿°ç¬¦ä¸­æ§ä»¶ç›¸å…³çš„å‚æ•°å­˜å‚¨åœ¨ Terminal æè¿°ç¬¦ä¸­ã€‚</p><p>ä»ä¼ å…¥çš„é€»è¾‘éŸ³é¢‘é€šé“åˆ°å¯èƒ½ç¼–ç çš„éŸ³é¢‘æµçš„è½¬æ¢è¿‡ç¨‹æ€»æ˜¯æ¶‰åŠåˆ°æŸç§ç¼–ç å¼•æ“ã€‚æœ¬è§„èŒƒå®šä¹‰äº†å‡ ç§ç±»å‹çš„ç¼–ç  ï¼ˆè§ç¬¬ 3.14 èŠ‚â€œç¼–ç å™¨å’Œè§£ç å™¨â€)ï¼ŒèŒƒå›´ä»ç®€å•çš„åˆ°éå¸¸å¤æ‚çš„æ–¹æ¡ˆã€‚ç¼–ç å¼•æ“è¢«è®¤ä¸ºæ˜¯å®ä½“çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå®é™…ä¸Šä¼ è¾“ç¼–ç çš„éŸ³é¢‘æ•°æ®æµï¼ˆç±»ä¼¼äº USBAudiostreaming æ¥å£ï¼‰ã€‚å› æ­¤ï¼Œç¼–ç ç±»å‹éšå«åœ¨ bmFormats å€¼ä¸­ï¼Œè¯¥å€¼ä½äºç‰¹å®šäºç±»çš„ AudioStreaming æ¥å£æè¿°ç¬¦ä¸­ã€‚ç‰¹å®šäºç¼–ç å¼•æ“çš„è¯·æ±‚å¿…é¡»æ˜¯æŒ‡å‘ AudioStreaming æ¥å£ã€‚ç›¸å…³è”çš„è¾“å‡ºç»ˆç«¯åœ¨ç¼–ç ä¹‹å‰å¤„ç†é€»è¾‘é€šé“</p><p>è¾“å‡ºç«¯å­å…·æœ‰å•ä¸ªæ—¶é’Ÿè¾“å…¥å¼•è„šã€‚è¯¥å¼•è„šä¸Šçš„æ—¶é’Ÿä¿¡å·ç”¨ä½œç”±è¯¥è¾“å‡ºç«¯å­è¡¨ç¤ºçš„æ‰€æœ‰åº•å±‚ç¡¬ä»¶çš„é‡‡æ ·æ—¶é’Ÿã€‚åœ¨è¾“å‡ºç»ˆç«¯æè¿°ç¬¦ä¸­æœ‰ä¸€ä¸ªå­—æ®µï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†è¾“å‡ºç»ˆç«¯è¿æ¥åˆ°çš„æ—¶é’Ÿå®ä½“è¾“å‡ºç«¯å­çš„ç¬¦å·å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac4.png"></p><h2 id="feature-unit">Feature Unit</h2><p>ç‰¹å¾å•å…ƒ (FU) æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤šé€šé“å¤„ç†å•å…ƒï¼Œå®ƒæä¾›å¯¹ä¼ å…¥é€»è¾‘é€šé“ä¸Šçš„å¤šä¸ªå•å‚æ•°éŸ³é¢‘æ§ä»¶çš„åŸºæœ¬æ“ä½œã€‚å¯¹äºæ¯ä¸ªé€»è¾‘é€šé“ï¼ŒåŠŸèƒ½å•å…ƒå¯é€‰åœ°ä¸ºä»¥ä¸‹åŠŸèƒ½æä¾›éŸ³é¢‘æ§åˆ¶ï¼š</p><ul><li>Mute</li><li>Volume</li><li>Tone Control(Bass, Mid, Treble)ï¼ˆéŸ³è°ƒæ§åˆ¶ï¼‰</li><li>Graphic Equalizerï¼ˆå›¾åƒå‡è¡¡å™¨ï¼‰</li><li>Automatic Gain Controlï¼ˆè‡ªåŠ¨å¢ç›Šæ§åˆ¶ï¼‰</li><li>Delay</li><li>Bass Boostï¼ˆä½éŸ³å¢å¼ºï¼‰</li><li>Loudnessï¼ˆå“åº¦ï¼‰</li><li>Input Gain</li><li>Input Gain Pad</li><li>Phase Inverterï¼ˆåç›¸å™¨ï¼‰</li></ul><p>æ­¤å¤–ï¼ŒåŠŸèƒ½å•å…ƒå¯é€‰æ‹©æä¾›ä¸Šè¿°éŸ³é¢‘æ§åˆ¶ï¼Œä½†ç°åœ¨å¯åŒæ—¶å½±å“é›†ç¾¤çš„æ‰€æœ‰é€šé“ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å®ç°â€œä¸»â€æ§ä»¶ã€‚ä¸»æ§åˆ¶åœ¨å„ä¸ªé€šé“æ§åˆ¶ä¹‹åçº§è”ã€‚æ­¤è®¾ç½®åœ¨å¤šé€šé“ç³»ç»Ÿä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå…¶ä¸­å•ä¸ªé€šé“æ§ä»¶å¯ç”¨äºé€šé“å¹³è¡¡ï¼Œä¸»æ§ä»¶å¯ç”¨äºæ•´ä½“è®¾ç½®ã€‚é›†ç¾¤ä¸­çš„é€»è¾‘ä¿¡é“çš„ç¼–å·ä» 1 åˆ°é›†ç¾¤ä¸­ä¿¡é“çš„æ€»æ•°ã€‚ä¸»é€šé“çš„é€šé“å·ä¸ºé›¶ï¼Œå®é™…ä¸Šæ€»æ˜¯å­˜åœ¨çš„ã€‚</p><p>ç‰¹å¾å•å…ƒæè¿°ç¬¦æŠ¥å‘Šäº†ç‰¹å¾å•å…ƒä¸­æ¯ä¸ªé€šé“å’Œä¸»é€šé“çš„æ§åˆ¶ã€‚æ‰€æœ‰å•å…ƒä¸­çš„é€»è¾‘é€šé“éƒ½å®Œå…¨ç‹¬ç«‹ï¼Œç‰¹å¾å•å…ƒå†…çš„é€šé“ä¹‹é—´ä¸å­˜åœ¨äº¤å‰è€¦åˆã€‚é€»è¾‘è¾“å‡ºé€šé“å’Œè¾“å…¥é€šé“ä¸€æ ·å¤šã€‚è¿™äº›è¢«ç»„åˆæˆä¸€ä¸ªéŸ³é¢‘é€šé“ç°‡ï¼Œé€šè¿‡ä¸€ä¸ªè¾“å…¥å¼•è„šè¿›å…¥åŠŸèƒ½å•å…ƒï¼Œå¹¶é€šè¿‡ä¸€ä¸ªè¾“å‡ºå¼•è„šç¦»å¼€å•å…ƒã€‚ç‰¹å¾å•å…ƒçš„ç¬¦å·å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/uac5.png"></p><h2 id="feature-unit-ä¸-hid-å¯¹æ¯”">Feature Unit ä¸ HID å¯¹æ¯”</h2><h3 id="binding-between-physical-buttons-and-audio-controls"><strong>Binding between Physical Buttons and Audio Controls</strong></h3><p>å¤§å¤šæ•°åŒ…å«éŸ³é¢‘åŠŸèƒ½çš„è®¾å¤‡ä¹Ÿä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª frontpanel buttonsï¼Œç”¨äºæ§åˆ¶è®¾å¤‡å†…éŸ³é¢‘åŠŸèƒ½çš„æŸäº›æ–¹é¢ã€‚æœ€æ˜æ˜¾çš„ä¾‹å­æ˜¯å¤šåª’ä½“æ‰¬å£°å™¨å‰é¢çš„éŸ³é‡æ§åˆ¶æŒ‰é’®ã€‚ç”±äºéŸ³é¢‘åŠŸèƒ½å¯èƒ½åŒ…å«è®¸å¤šç›¸åŒç±»å‹çš„éŸ³é¢‘æ§ä»¶ï¼Œå› æ­¤éœ€è¦å°†ç‰©ç†æ§ä»¶ï¼ˆæŒ‰é’®ã€æ—‹é’®ã€æ»‘å—ã€ç‚¹åŠ¨ç­‰ï¼‰ç»‘å®šåˆ°éŸ³é¢‘åŠŸèƒ½ä¸­çš„ç‰¹å®šéŸ³é¢‘æ§ä»¶ã€‚ æœ¬è§„èŒƒæä¾›äº†ä¸¤ç§äº’æ–¥çš„æ–¹æ³•æ¥æä¾›è¿™ç§ç»‘å®šï¼š</p><ul><li>ç‰©ç†æŒ‰é’®å®ç°ä¸º HID æ§ä»¶</li><li>ç‰©ç†æŒ‰é’®æ˜¯éŸ³é¢‘æ§åˆ¶çš„é›†æˆéƒ¨åˆ†</li></ul><p>ç¦æ­¢å¯¹åŒä¸€ä¸ªç‰©ç†æŒ‰é’®å®ç°è¿™ä¸¤ç§æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå…è®¸å¯¹æŸäº› frontpanel buttons ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå¯¹å…¶ä½™ frontpanel buttons ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚å¼ºçƒˆå»ºè®®ä¸ä½¿ç”¨ä¸Šè¿°ä¸¤ç§æ–¹æ³•å®ç°å‰é¢æ¿æŒ‰é’®ï¼Œå³å¯¹ä¸»æœºè½¯ä»¶ä¸å¯è§ä¸”ä»…å…·æœ‰å±€éƒ¨æ•ˆæœçš„æŒ‰é’®ã€‚</p><h3 id="physical-button-is-a-hid-control"><strong>Physical button is a HID Control</strong></h3><p>HID æ˜¯ USB è®¾å¤‡ä¸­çš„ä¸€ç§è®¾å¤‡ç±»å‹ï¼Œä»–ä¸ UAC ä¹‹é—´å¹¶æ²¡æœ‰ç›´æ¥çš„å…³è”æ€§ï¼Œä¸¤è€…æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œåªæ˜¯ HID è®¾å¤‡åŒ…æ‹¬é¼ æ ‡ã€é”®ç›˜ã€é¥æ†ç­‰å…·æœ‰é€šè¿‡ USB æ§åˆ¶ host çš„å£°éŸ³çš„è®¾å¤‡ï¼Œå¯ä»¥é€šè¿‡å®ç°è¿™äº›è®¾å¤‡çš„æè¿°ç¬¦å®ç°å¯¹ host çš„éŸ³é‡æ§åˆ¶ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨æ¥æ§åˆ¶ UAC çš„éŸ³é‡ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç‰©ç†æŒ‰é”®ä¸éŸ³é¢‘åŠŸèƒ½å®Œå…¨åˆ†ç¦»ï¼Œå¹¶åœ¨è®¾å¤‡çš„ HID æ¥å£å†…å®ç°ã€‚éŸ³é¢‘åŠŸèƒ½ç”šè‡³ä¸çŸ¥é“æŒ‰é’®çš„å­˜åœ¨ã€‚æŒ‰é’®çš„ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½é€šè¿‡ HID æŠ¥å‘Šä¼ é€ç»™ä¸»æœºè½¯ä»¶ã€‚ç„¶åç”±ä¸»æœºè½¯ä»¶æ¥è§£é‡ŠæŒ‰é’®çŠ¶æ€çš„å˜åŒ–ï¼Œå¹¶ä»é‚£é‡Œè·å¾—å¯¹éŸ³é¢‘åŠŸèƒ½è¦é‡‡å–çš„é€‚å½“è¡ŒåŠ¨ã€‚å› æ­¤ï¼Œç»‘å®šè´£ä»»å®Œå…¨å±äºåº”ç”¨ç¨‹åºæˆ–æ“ä½œç³»ç»Ÿè½¯ä»¶ã€‚å°½ç®¡æ­¤æ–¹æ³•æä¾›äº†å¹¿æ³›çš„çµæ´»æ€§ä½†å®ƒä¹Ÿç»™è½¯ä»¶å¸¦æ¥äº†æä¾›æ­£ç¡®ç»‘å®šçš„è´Ÿæ‹…ã€‚</p><h3 id="physical-button-is-integral-part-of-the-audio-control"><strong>Physical button is Integral Part of the Audio Control</strong></h3><p>è€Œ Feature Unit æ˜¯ UAC æ ‡å‡†é‡Œå®šä¹‰çš„ç‰¹æ€§å•å…ƒï¼ŒåŠŸèƒ½æ›´å¼ºå¤§å¯ä»¥å®ç°å¯¹æ¯ä¸ªé€»è¾‘é€šé“æä¾›éŸ³é¢‘æ§åˆ¶ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº mute å’Œ volumeã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç‰©ç†æŒ‰é”®ç›´æ¥ä¸å®é™…çš„éŸ³é¢‘æ§åˆ¶äº¤äº’ã€‚æŒ‰é’®çŠ¶æ€æ›´æ”¹ä¸ä¼šæŠ¥å‘Šç»™ä¸»æœºè½¯ä»¶ã€‚ç›¸åï¼Œç”±æŒ‰é’®æ“ä½œå¼•èµ·çš„éŸ³é¢‘æ§åˆ¶çš„çŠ¶æ€å˜åŒ–é€šè¿‡éŸ³é¢‘æ§åˆ¶ä¸­æ–­æœºåˆ¶æŠ¥å‘Šç»™ä¸»æœºè½¯ä»¶ã€‚å› æ­¤ï¼Œç‰©ç†æŒ‰é’®å’Œ Audio æ§ä»¶ä¹‹é—´çš„ç»‘å®šéå¸¸ç›´æ¥ï¼Œå®Œå…¨ç”±è®¾å¤‡çš„è®¾è®¡å†³å®šã€‚å°½ç®¡ä¸å¤ªçµæ´»ï¼Œä½†è¯¥æ–¹æ³•æä¾›äº†ä¸€ç§éå¸¸æ¸…æ™°å’Œç›´æ¥çš„æ–¹å¼æ¥æ‰§è¡Œç»‘å®šã€‚</p><h1 id="encoders-and-decoders"><strong>Encoders and Decoders</strong></h1><p>æ¯å½“éŸ³é¢‘æ•°æ®æµè¿›å…¥æˆ–ç¦»å¼€éŸ³é¢‘ Function æ—¶ï¼Œéƒ½æ¶‰åŠåˆ°æŸç§è§£ç æˆ–ç¼–ç è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥æ˜¯ç›¸å½“çç¢çš„ï¼ˆäº¤ç»‡æˆ–è§£äº¤ç»‡æ ·æœ¬ï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç›¸å½“å¤æ‚çš„ã€‚</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸»æœºè½¯ä»¶å’Œç¼–ç æˆ–è§£ç è¿‡ç¨‹ä¹‹é—´çš„äº¤äº’æ˜¯å¿…è¦çš„ã€‚æ­¤æ—¶å®šä¹‰äº†äº”ä¸ªè¿™ç§ç±»å‹çš„ç¼–ç å™¨å’Œè§£ç å™¨è¿›ç¨‹ï¼š</p><ul><li>MPEG Encoder and Decoder</li><li>AC-3 Encoder and Decoder</li><li>Windows Media Audio (WMA) Encoder and Decoder</li><li>DTS Encoder and Decoder</li><li>OTHER Encoder and Decoder</li></ul><p>è¿™äº›è¿›ç¨‹å„è‡ªå®šä¹‰äº†ç‰¹å®šçš„æ§ä»¶ï¼Œå…è®¸æ“çºµæˆ–ç›‘è§†ç¼–ç å™¨æˆ–è§£ç å™¨è¿›ç¨‹çš„å†…éƒ¨çŠ¶æ€ã€‚è¿™äº›æ§ä»¶æ˜¯é€šè¿‡ç¼–ç å™¨æˆ–è§£ç å™¨æ‰€å±çš„ AudioStreaming æ¥å£å¯»å€çš„ã€‚</p><h1 id="copy-protection"><strong>Copy Protection</strong></h1><p>ç”±äºéŸ³é¢‘è®¾å¤‡ç±»ä¸»è¦å¤„ç†æ•°å­—éŸ³é¢‘æµï¼Œå› æ­¤ä¸èƒ½å¿½è§†ä¿æŠ¤è¿™äº›é€šå¸¸å—ç‰ˆæƒä¿æŠ¤çš„æµçš„é—®é¢˜ã€‚å› æ­¤ï¼Œæœ¬è§„èŒƒæä¾›äº†ä¿å­˜ä»»ä½•å¯ç”¨çš„ç‰ˆæƒä¿¡æ¯çš„æ–¹æ³•ã€‚ç„¶è€Œï¼Œç®¡ç†æ•´ä¸ªéŸ³é¢‘åŠŸèƒ½çš„å¤åˆ¶ä¿æŠ¤ä¿¡æ¯æµæ˜¯ä¸»æœºè½¯ä»¶çš„è´£ä»»ã€‚ æ¯å½“æ•°å­—éŸ³é¢‘æµè¿›å…¥æˆ–ç¦»å¼€éŸ³é¢‘åŠŸèƒ½æ—¶ï¼Œå¤åˆ¶ä¿æŠ¤é—®é¢˜å°±ä¼šå‡ºç°ã€‚å› æ­¤ï¼Œå¤åˆ¶ä¿æŠ¤æœºåˆ¶æ˜¯åœ¨éŸ³é¢‘åŠŸèƒ½çš„ç»ˆç«¯çº§å®ç°çš„ã€‚è¿›å…¥éŸ³é¢‘åŠŸèƒ½çš„æµå¯ä»¥ä¼´éšç€ç‰¹å®šçš„ä¿¡æ¯ï¼Œæè¿°è¯¥éŸ³é¢‘æµçš„å¤åˆ¶ä¿æŠ¤çº§åˆ«ã€‚åŒæ ·ï¼Œå¦‚æœç¡¬ä»¶å…è®¸çš„è¯ï¼Œç¦»å¼€éŸ³é¢‘åŠŸèƒ½çš„æµåº”è¯¥ä¼´éšç€é€‚å½“çš„å¤åˆ¶ä¿æŠ¤ä¿¡æ¯ã€‚è¯¥è§„èŒƒæä¾›äº†ä¸¤ä¸ªä¸“ç”¨è¯·æ±‚ï¼Œå¯ç”¨äºç®¡ç†å¤åˆ¶ä¿æŠ¤æœºåˆ¶ã€‚ GetCopy Protect è¯·æ±‚å¯ç”¨äºä»è¾“å…¥ç«¯æ£€ç´¢å¤åˆ¶ä¿æŠ¤ä¿¡æ¯ï¼Œè€Œ Set Copy Protect è¯·æ±‚å¯ç”¨äºé¢„è®¾è¾“å‡ºç«¯çš„å¤åˆ¶ä¿æŠ¤çº§åˆ«ã€‚ æœ¬è§„èŒƒæä¾›äº†ä¸‰ä¸ªçº§åˆ«çš„æ‹·è´è®¸å¯ï¼Œç±»ä¼¼äº CGMSï¼ˆæ‹·è´ç”Ÿæˆç®¡ç†ç³»ç»Ÿï¼‰å’Œ SCMS ï¼ˆä¸²è¡Œæ‹·è´ç®¡ç†ç³»ç»Ÿï¼‰ã€‚</p><ul><li>Level 0: ä¸å—é™åˆ¶åœ°å…è®¸å¤åˆ¶ã€‚è¯¥ææ–™è¦ä¹ˆæ²¡æœ‰ç‰ˆæƒï¼Œè¦ä¹ˆæ²¡æœ‰ä¸»å¼ ç‰ˆæƒã€‚</li><li>Level 1: å¯ä»¥åˆ¶ä½œä¸€ä¸ªå‰¯æœ¬ã€‚ææ–™å—ç‰ˆæƒä¿æŠ¤ï¼Œä¸ºåŸåˆ›ã€‚</li><li>Level 2: ææ–™å—ç‰ˆæƒä¿æŠ¤ï¼Œä¸å…è®¸æ•°å­—æ‹·è´</li></ul><h1 id="operational-model"><strong>Operational Model</strong></h1><p>ä¸€ä¸ªè®¾å¤‡å¯ä»¥æ”¯æŒå¤šç§é…ç½®ã€‚åœ¨æ¯ä¸ªé…ç½®ä¸­å¯ä»¥æœ‰å¤šä¸ªæ¥å£ï¼Œæ¯ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¤‡ç”¨è®¾ç½®è¿™äº›æ¥å£å¯ä»¥å±äºåŒä¸€ä¸ªå¤åˆè®¾å¤‡ä¸­å…±å­˜çš„ä¸åŒåŠŸèƒ½ã€‚ç”šè‡³å‡ ä¸ªç‹¬ç«‹çš„éŸ³é¢‘åŠŸèƒ½å¯ä»¥å­˜åœ¨äºåŒä¸€ä¸ªè®¾å¤‡ä¸­ã€‚å±äºåŒä¸€éŸ³é¢‘åŠŸèƒ½çš„æ¥å£è¢«åˆ†ç»„åˆ°éŸ³é¢‘æ¥å£é›†åˆä¸­ã€‚å¦‚æœè®¾å¤‡åŒ…å«å¤šä¸ªç‹¬ç«‹çš„éŸ³é¢‘åŠŸèƒ½ï¼Œåˆ™å¿…é¡»æœ‰å¤šä¸ªéŸ³é¢‘æ¥å£é›†åˆï¼Œæ¯ä¸ªæ¥å£é›†åˆéƒ½æä¾›å¯¹å…¶ç›¸å…³éŸ³é¢‘åŠŸèƒ½çš„å®Œå…¨è®¿é—®æƒé™ã€‚</p><p>ä»¥å¤åˆè®¾å¤‡ä¸ºä¾‹ï¼Œè€ƒè™‘é…å¤‡å†…ç½®ç«‹ä½“å£°æ‰¬å£°å™¨ç³»ç»Ÿçš„ PC ç›‘è§†å™¨ã€‚è¿™æ ·çš„è®¾å¤‡å¯ä»¥é…ç½®ä¸ºå…·æœ‰ä¸€ä¸ªå¤„ç†é…ç½®å’Œæ§åˆ¶è®¾å¤‡çš„ç›‘è§†å™¨éƒ¨åˆ†çš„æ¥å£ (HID ç±»ï¼‰ï¼Œè€Œå…¶ä»–ä¸¤ä¸ªæ¥å£çš„é›†åˆå¤„ç†å…¶éŸ³é¢‘æ–¹é¢å…¶ä¸­ä¹‹ä¸€ï¼ŒAudioControl æ¥å£ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶å†…éƒ¨å·¥ä½œçš„ Function ï¼ˆéŸ³é‡æ§åˆ¶ç­‰ï¼‰ã€‚è€Œå¦ä¸€ä¸ª AudioStreaming æ¥å£ï¼Œå¤„ç†æ•°æ®æµé‡ï¼Œå‘é€åˆ°ç›‘è§†å™¨çš„éŸ³é¢‘å­ç³»ç»Ÿã€‚</p><p>AudioStreaming æ¥å£å¯ä»¥é…ç½®ä¸ºåœ¨å•å£°é“æ¨¡å¼ä¸‹å·¥ä½œï¼ˆå¯é€‰è®¾ç½® x) å…¶ä¸­åªæœ‰ä¸€ä¸ªå•å£°é“æ•°æ®æµè¢«å‘é€åˆ°éŸ³é¢‘åŠŸèƒ½ã€‚æ¥æ”¶è¾“å…¥ç»ˆç«¯å¯ä»¥å°†éŸ³é¢‘æµå¤åˆ¶åˆ°ä¸¤ä¸ªé€»è¾‘é€šé“ä¸­ï¼Œç„¶ååœ¨ä¸¤ä¸ªæ‰¬å£°å™¨ä¸Šå†ç°ã€‚ä»æ¥å£çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ ·çš„è®¾ç½®é™¤äº† AudioControl æ¥å£ä¸­çš„å¼ºåˆ¶æ§åˆ¶ç«¯ç‚¹å’Œå¯é€‰ä¸­æ–­ç«¯ç‚¹ä¹‹å¤–ï¼Œè¿˜éœ€è¦éŸ³é¢‘æµæ¥å£ä¸­çš„ä¸€ä¸ªç­‰æ—¶ç«¯ç‚¹æ¥æ¥æ”¶å•éŸ³é¢‘æ•°æ®æµã€‚</p><p>åŒæ ·çš„ç³»ç»Ÿå¯ä»¥ç”¨æ¥æ’­æ”¾ç«‹ä½“å£°éŸ³é¢‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¿…é¡»é€‰æ‹©ç«‹ä½“å£°éŸ³é¢‘æµæ¥å£ï¼ˆå¤‡ç”¨è®¾ç½® y)ã€‚è¯¥æ¥å£è¿˜åŒ…å«ä¸€ä¸ªåŒæ­¥ç«¯ç‚¹ï¼Œè¯¥ç«¯ç‚¹ç°åœ¨æ¥æ”¶äº¤é”™å‰å·¦å’Œå‰å³é€šé“é‡‡æ ·çš„æ•°æ®æµã€‚æ¥æ”¶è¾“å…¥ Terminal ç°åœ¨å°†æµæ‹†åˆ†ä¸ºå‰å·¦å’Œå‰å³é€»è¾‘é€šé“ã€‚AudioControl æ¥å£å¤‡ç”¨è®¾ç½®ä¿æŒä¸å˜ã€‚ å¦‚æœä¸Šé¢çš„ AudioStreaming æ¥å£æ˜¯ä¸€ä¸ªå¼‚æ­¥æ¥æ”¶å™¨ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ä¸€ä¸ªé¢å¤–çš„ç­‰æ—¶åé¦ˆç«¯ç‚¹ã€‚ å¦‚å‰æ‰€è¿°ï¼ŒéŸ³é¢‘åŠŸèƒ½ä½äºè®¾å¤‡ç±»å±‚æ¬¡ç»“æ„ä¸­çš„æ¥å£çº§åˆ«ã€‚ä»¥ä¸‹å„èŠ‚æè¿°äº†éŸ³é¢‘æ¥å£é›†åˆï¼Œå…¶ä¸­åŒ…å«å•ä¸ª AudioControl æ¥å£å’Œå¯é€‰ AudioStreaming æ¥å£ï¼Œä»¥åŠç”¨äºéŸ³é¢‘åŠŸèƒ½æ§åˆ¶å’ŒéŸ³é¢‘æ•°æ®æµä¼ è¾“çš„ç›¸å…³ç«¯ç‚¹ã€‚</p><h2 id="audiocontrol-interface"><strong>AudioControl Interface</strong></h2><p>ä¸ºäº†æ§åˆ¶ç‰¹å®šéŸ³é¢‘å‡½æ•°çš„åŠŸèƒ½è¡Œä¸ºï¼Œä¸»æœºå¯ä»¥æ“çºµéŸ³é¢‘å‡½æ•°ä¸­çš„æ—¶é’Ÿå®ä½“ã€å•ä½å’Œç»ˆç«¯ã€‚è¦ä½¿è¿™äº›å¯¹è±¡å¯è®¿é—®ï¼ŒéŸ³é¢‘å‡½æ•°å¿…é¡»å…¬å¼€ä¸€ä¸ª AudioControl æ¥å£ã€‚æ­¤æ¥å£å¯ä»¥åŒ…å«ä»¥ä¸‹ç«¯ç‚¹</p><ul><li>ç”¨äºæ“çºµæ—¶é’Ÿå®ä½“ã€å•å…ƒå’Œç»ˆç«¯è®¾ç½®ä»¥åŠæ£€ç´¢éŸ³é¢‘åŠŸèƒ½çŠ¶æ€çš„æ§åˆ¶ç«¯ç‚¹ã€‚æ­¤ç«¯ç‚¹æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œé»˜è®¤ç«¯ç‚¹ 0 ç”¨äºæ­¤ç›®çš„</li><li>ä¸­æ–­ç«¯ç‚¹ã€‚æ­¤ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼Œä½†éå¸¸æœ‰ç”¨ï¼Œåº”åœ¨é™¤æœ€ç®€å•çš„éŸ³é¢‘è®¾å¤‡å¤–çš„æ‰€æœ‰è®¾å¤‡ä¸Šå®ç°ï¼Œä»¥ä¾¿åœ¨éŸ³é¢‘åŠŸèƒ½çš„è¡Œä¸ºå‘ç”Ÿä»»ä½•å˜åŒ–æ—¶ï¼Œä¸»æœºè½¯ä»¶å¯ä»¥éšæ—¶æ”¶åˆ°é€šçŸ¥</li></ul><p>AudioControl æ¥å£æ˜¯è®¿é—®éŸ³é¢‘ Function å†…éƒ¨æ„ä»¶çš„å•ä¸€å…¥å£ç‚¹ã€‚æ‰€æœ‰ä¸éŸ³é¢‘åŠŸèƒ½çš„æ—¶é’Ÿå®ä½“ã€å•å…ƒæˆ–ç»ˆç«¯å†…çš„æŸäº›éŸ³é¢‘æ§ä»¶çš„æ“ä½œæœ‰å…³çš„è¯·æ±‚éƒ½å¿…é¡»æŒ‡å‘éŸ³é¢‘åŠŸèƒ½çš„éŸ³é¢‘æ§ä»¶æ¥å£ã€‚åŒæ ·ï¼Œæ‰€æœ‰ä¸éŸ³é¢‘å‡½æ•°å†…éƒ¨ç›¸å…³çš„æè¿°ç¬¦éƒ½æ˜¯ç‰¹å®šäºç±»çš„ AudioControl æ¥å£æè¿°ç¬¦çš„ä¸€éƒ¨åˆ†ã€‚éŸ³é¢‘åŠŸèƒ½çš„ AudioControl æ¥å£åªèƒ½æ”¯æŒå•ä¸ªå¤‡ç”¨è®¾ç½® ã€‚</p><h2 id="control-endpoint"><strong>Control Endpoint</strong></h2><p>éŸ³é¢‘æ¥å£ç±»ä½¿ç”¨ç«¯ç‚¹ 0ï¼ˆé»˜è®¤ç®¡é“ï¼‰ä½œä¸ºä½¿ç”¨ç‰¹å®šäºç±»çš„è¯·æ±‚æ§åˆ¶éŸ³é¢‘åŠŸèƒ½çš„æ ‡å‡†æ–¹å¼ã€‚è¿™äº›è¯·æ±‚æ€»æ˜¯æŒ‡å‘ç»„æˆéŸ³é¢‘ Function çš„å•å…ƒæˆ–ç»ˆç«¯ä¹‹ä¸€ã€‚è¿™äº›è¯·æ±‚çš„æ ¼å¼å’Œå†…å®¹å°†åœ¨æœ¬æ–‡ä»¶ä¸­è¿›ä¸€æ­¥è¯¦è¿°ã€‚</p><h2 id="interrupt-endpoint"><strong>Interrupt Endpoint</strong></h2><p>USB AudioControl æ¥å£å¯æ”¯æŒå¯é€‰ä¸­æ–­ç«¯ç‚¹ï¼Œä»¥é€šçŸ¥ä¸»æœºéŸ³é¢‘åŠŸèƒ½å†…ä¸åŒå¯å¯»å€å®ä½“ï¼ˆæ—¶é’Ÿå®ä½“ã€ç«¯å­ã€å•å…ƒã€æ¥å£å’Œç«¯ç‚¹ï¼‰ ä¸Šå‘ç”Ÿçš„åŠ¨æ€å˜åŒ–ã€‚ä¸­æ–­ç«¯ç‚¹è¢«æ•´ä¸ªéŸ³é¢‘æ¥å£é›†åˆç”¨æ¥å‘ä¸»æœºä¼ é€’æ›´æ”¹ä¿¡æ¯ã€‚å®ƒè¢«è®¤ä¸ºæ˜¯ AudioControl æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒæ˜¯ Collection çš„é”šç‚¹æ¥å£ã€‚</p><h2 id="audiostreaming-interface"><strong>AudioStreaming Interface</strong></h2><p>AudioStreaming æ¥å£ç”¨äºåœ¨ä¸»æœºå’ŒéŸ³é¢‘ Function ä¹‹é—´äº¤æ¢æ•°å­—éŸ³é¢‘æ•°æ®æµã€‚å®ƒä»¬æ˜¯å¯é€‰çš„ï¼Œä¸€ä¸ªéŸ³é¢‘ Function å¯ä»¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªä¸ä¹‹å…³è”çš„ AudioStreaming æ¥å£ï¼Œæ¯ä¸ªæ¥å£éƒ½å¯èƒ½æºå¸¦ä¸åŒæ€§è´¨å’Œæ ¼å¼çš„æ•°æ®ã€‚æ¯ä¸ª AudioStreaming æ¥å£æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªåŒæ­¥æ•°æ®ç«¯ç‚¹ã€‚è¿™ç§æ„é€ ä¿è¯äº† Audiostreaming æ¥å£å’Œä¸ç«¯ç‚¹ç›¸å…³çš„å•ä¸ªéŸ³é¢‘æ•°æ®æµä¹‹é—´çš„ä¸€å¯¹ä¸€å…³ç³»ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒåŒæ­¥æ•°æ®ç«¯ç‚¹ä¼´éšç€ä¸€ä¸ªç›¸å…³çš„åŒæ­¥æ˜¾å¼åé¦ˆç«¯ç‚¹ï¼Œä»¥å®ç°åŒæ­¥ã€‚ç­‰æ—¶æ•°æ®ç«¯ç‚¹åŠå…¶å…³è”çš„åé¦ˆç«¯ç‚¹å¿…é¡»éµå¾ª USB è§„èŒƒç¬¬ 9.6.6 èŠ‚ç«¯ç‚¹"ä¸­è§„å®šçš„ç«¯ç‚¹ç¼–å·æ–¹æ¡ˆã€‚</p><p>AudioStreaming Interface å¯ä»¥å…·æœ‰å¤‡ç”¨è®¾ç½®ï¼Œå¯ç”¨äºæ›´æ”¹ Interface å’ŒåŸºç¡€ç«¯ç‚¹çš„æŸäº›ç‰¹æ€§ã€‚â€œ Alternate Settingsâ€çš„å…¸å‹ç”¨é€”æ˜¯æä¾›ä¸€ç§åœ¨ active Audiostreaming interface ä¸Šæ›´æ”¹å­å¸§å¤§å°/æˆ–é€šé“æ•°çš„æ–¹æ³•ã€‚æ¯å½“ Audiostreaming æ¥å£éœ€è¦åŒæ­¥æ•°æ®ç«¯ç‚¹æ—¶ï¼Œå®ƒå¿…é¡»è‡³å°‘æä¾› 0 å¸¦å®½è¦æ±‚ï¼ˆæœªå®šä¹‰åŒæ­¥æ•°æ®ç«¯ç‚¹ï¼‰çš„é»˜è®¤å¤‡ç”¨è®¾ç½® ï¼ˆå¤‡ç”¨è®¾ç½® 0) å’ŒåŒ…å«å®é™…åŒæ­¥æ•°æ®ç«¯ç‚¹çš„é™„åŠ å¤‡ç”¨è®¾ç½®ã€‚</p><p>éŸ³é¢‘æµæ¥å£æœ¬è´¨ä¸Šæ˜¯ç”¨æ¥ä¸ºä¸»æœºè½¯ä»¶ï¼ˆé©±åŠ¨ç¨‹åºï¼‰æä¾›ä¸€ä¸ªæ¥å…¥ç‚¹æ¥æ“ä½œå®ƒæ‰€ä»£è¡¨çš„ç‰©ç†æ¥å£çš„è¡Œä¸ºã€‚å› æ­¤ï¼Œç”šè‡³å¤–éƒ¨è¿æ¥åˆ°éŸ³é¢‘åŠŸèƒ½ (S/PDIF æ¥å£ï¼Œ analog input ç­‰ï¼‰å¯ä»¥ç”¨éŸ³é¢‘æµæ¥å£æ¥è¡¨ç¤ºï¼Œè¿™æ ·ä¸»æœºè½¯ä»¶å°±å¯ä»¥æ§åˆ¶è¿™äº›è¿æ¥çš„æŸäº›æ–¹é¢ã€‚è¿™ç§ç±»å‹çš„éŸ³é¢‘æµæ¥å£æ²¡æœ‰å…³è”çš„ USB ç«¯ç‚¹ã€‚ç›¸å…³çš„éŸ³é¢‘æ•°æ®æµä¸ä½¿ç”¨ USB ä½œä¸ºä¼ è¾“ä»‹è´¨ã€‚</p><p>å¯¹äºåœ¨ä»»ä½• AudioStreaming æ¥å£ä¸­å®šä¹‰çš„æ¯ä¸ªåŒæ­¥ OUT æˆ– IN ç«¯ç‚¹ï¼Œå¿…é¡»åœ¨ audio å‡½ Function ä¸­å®šä¹‰ç›¸åº”çš„è¾“å…¥æˆ–è¾“å‡ºç«¯å­ã€‚ä¸ºäº†è®©ä¸»æœºå®Œå…¨ç†è§£è¿æ¥çš„æ€§è´¨å’Œè¡Œä¸ºï¼Œå®ƒå¿…é¡»è€ƒè™‘ä¸æ¥å£å’Œç«¯ç‚¹ç›¸å…³çš„æè¿°ç¬¦ä»¥åŠä¸ç»ˆç«¯ç›¸å…³çš„æè¿°ç¬¦ã€‚</p><h2 id="isochronous-audio-data-stream-endpoint"><strong>Isochronous Audio Data Stream Endpoint</strong></h2><p>é€šå¸¸ï¼Œç”±ç­‰æ—¶éŸ³é¢‘æ•°æ®ç«¯ç‚¹å¤„ç†çš„æ•°æ®æµä¸ä¸€å®šç›´æ¥æ˜ å°„åˆ°éŸ³é¢‘åŠŸèƒ½ä¸­å­˜åœ¨çš„é€»è¾‘é€šé“ã€‚ä½œä¸ºç¤ºä¾‹ï¼Œè€ƒè™‘å¤šä¸ªé€»è¾‘éŸ³é¢‘é€šé“è¢«å‹ç¼©æˆå•ä¸ªæ•°æ®æµ (AC-3ã€WMA...) çš„æƒ…å†µã€‚è¿™ç§æ•°æ®æµçš„æ ¼å¼å¯ä»¥å®Œå…¨ä¸åŒäºé€»è¾‘é€šé“çš„åŸå§‹æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œ640 Kbits/s AC-35.1 éŸ³é¢‘ï¼Œè€Œä¸æ˜¯ 6 é€šé“ 16 ä½ 44.1 kHz éŸ³é¢‘ï¼‰ã€‚å› æ­¤ï¼Œä¸ºäº†æ­£ç¡®åœ°æè¿°ç«¯ç‚¹çº§çš„æ•°æ®ä¼ è¾“ï¼Œé€»è¾‘ä¿¡é“çš„æ¦‚å¿µè¢«éŸ³é¢‘æ•°æ®æµçš„æ¦‚å¿µæ‰€å–ä»£ã€‚ åŒ…å« OUT ç«¯ç‚¹çš„ AudioStreaming æ¥å£è´Ÿè´£åœ¨éŸ³é¢‘æ•°æ®æµå’ŒåµŒå…¥å¼é€»è¾‘é€šé“ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œç„¶åå°†æ•°æ®ç§»äº¤ç»™è¾“å…¥ç»ˆç«¯ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™ç§è½¬æ¢è¿‡ç¨‹æ¶‰åŠåˆ°æŸç§å½¢å¼çš„è§£ç ã€‚åŒæ ·ï¼ŒåŒ…å« IN ç«¯ç‚¹çš„ AudioStreaming æ¥å£å¿…é¡»å°†è¾“å‡ºç»ˆç«¯çš„é€»è¾‘é€šé“è½¬æ¢ä¸ºéŸ³é¢‘æ•°æ®æµï¼Œé€šå¸¸ä½¿ç”¨æŸç§å½¢å¼çš„ç¼–ç ã€‚å¦‚æœè§£ç æˆ–ç¼–ç è¿‡ç¨‹å…¬å¼€å½±å“ç¼–ç æˆ–è§£ç çš„æ§ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡ AudioStreaming æ¥å£è®¿é—®è¿™äº›æ§ä»¶ã€‚</p><p>æ— æ³•å°†æ§åˆ¶éŸ³é¢‘åŠŸèƒ½ä¸­å­˜åœ¨çš„å±æ€§ï¼ˆå¦‚éŸ³é‡æˆ–é™éŸ³ï¼‰çš„è¯·æ±‚å‘é€åˆ° Audiostreaming æ¥å£ä¸­çš„ç«¯ç‚¹ã€‚AudioStreaming æ¥å£å¯¹éŸ³é¢‘æ•°æ®æµè¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”ä¸çŸ¥é“å®ƒæœ€ç»ˆæœåŠ¡çš„é€»è¾‘é€šé“æ•°ã€‚ç›¸åï¼Œè¿™äº›è¯·æ±‚å¿…é¡»é€šè¿‡ AudioControl æ¥å£æŒ‡å‘æ­£ç¡®çš„éŸ³é¢‘åŠŸèƒ½å•å…ƒæˆ–ç»ˆç«¯ã€‚ å¦‚å·²ç»æåˆ°çš„ï¼ŒAudioStreaming æ¥å£å¯ä»¥å…·æœ‰é›¶ä¸ªæˆ–ä¸€ä¸ªç­‰æ—¶éŸ³é¢‘æ•°æ®ç«¯ç‚¹ã€‚å¦‚æœå¿…é¡»åœ¨ä¸»æœºå’ŒéŸ³é¢‘åŠŸèƒ½ä¹‹é—´é€šä¿¡å¤šä¸ªåŒæ­¥éŸ³é¢‘é€šé“ï¼Œåˆ™å¿…é¡»é€šè¿‡äº¤ç»‡å„ä¸ªéŸ³é¢‘æ•°æ®å°†å®ƒä»¬èšé›†åˆ°ä¸€ä¸ªç‰©ç†éŸ³é¢‘é€šé“ç°‡ä¸­ï¼Œç„¶åå°†ç»“æœå®šå‘åˆ°å•ä¸ªç«¯ç‚¹ã€‚ å¦‚æœä¸€ä¸ªéŸ³é¢‘åŠŸèƒ½éœ€è¦å¤šä¸ªé›†ç¾¤æ‰èƒ½è¿è¡Œï¼Œåˆ™æ¯ä¸ªé›†ç¾¤ä¼šå®šå‘åˆ°ä¸€ä¸ªå•ç‹¬çš„ AudioStreaming æ¥å£çš„ç«¯ç‚¹ï¼Œè¯¥æ¥å£å±äºåŒä¸€ä¸ª Audiolnterface Collection ï¼ˆæ‰€æœ‰é›†ç¾¤éƒ½æœåŠ¡äºåŒä¸€ä¸ªéŸ³é¢‘åŠŸèƒ½ï¼‰ã€‚</p><h2 id="isochronous-feedback-endpoint"><strong>Isochronous Feedback Endpoint</strong></h2><p>å¯¹äºè‡ªé€‚åº”éŸ³é¢‘æºç«¯ç‚¹å’Œå¼‚æ­¥éŸ³é¢‘æ¥æ”¶ç«¯ç‚¹ï¼Œéœ€è¦æ˜¾å¼åŒæ­¥æœºåˆ¶æ¥ä¿æŒä¼ è¾“è¿‡ç¨‹ä¸­çš„åŒæ­¥ã€‚æœ‰å…³åŒæ­¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ USB è§„èŒƒä¸­çš„ç¬¬ 5 èŠ‚â€USB æ•°æ®æµæ¨¡å‹â€ã€‚æ ¼å¼çš„å…·ä½“ä¿¡æ¯ï¼Œè¯·å‚é˜…å…³äºç»è¿‡åé¦ˆç®¡é“çš„æ•°æ®ï¼Œè¯·å‚è§ USB è§„èŒƒä¸­çš„ç¬¬ 5.12.4.2 èŠ‚â€åé¦ˆ"å’Œç¬¬ 9.6.6 èŠ‚"ç«¯ç‚¹â€</p><h2 id="audio-data-format"><strong>Audio Data Format</strong></h2><p>ç”¨äºé€šè¿‡ USB ä¼ è¾“éŸ³é¢‘æ•°æ®çš„æ ¼å¼å®Œå…¨ç”±ç‰¹å®šäºç±»çš„æ¥å£æè¿°ç¬¦çš„ bFormatType å’Œ bmFormats å­—æ®µä¸­çš„ä»£ç å†³å®šã€‚å¯¹äºæ¯ä¸ªå®šä¹‰çš„æ ¼å¼ç±»å‹ï¼Œéœ€è¦ä¸€ä¸ªæ ¼å¼ç±»å‹æè¿°ç¬¦æ¥å®Œæ•´æè¿°æ ¼å¼ã€‚æœ‰å…³å·²å®šä¹‰çš„æ ¼å¼ç±»å‹ä»¥åŠç›¸å…³æ•°æ®æ ¼å¼å’Œæè¿°ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§å•ç‹¬çš„æ–‡æ¡£ USB éŸ³é¢‘æ•°æ®æ ¼å¼è¯¥æ–‡æ¡£è¢«è®¤ä¸ºæ˜¯æœ¬è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚åˆ¶é€ å•†å¿…é¡»å……åˆ†è®°å½•ç‰¹å®šäºä¾›åº”å•†çš„åè®®ã€‚</p><h1 id="clock-model"><strong>Clock Model</strong></h1><p>æ—¶é’Ÿå®ä½“æä¾›äº†ä¸€ç§æ–¹æ³•æ¥å‡†ç¡®åœ°æè¿°æ•´ä¸ªéŸ³é¢‘åŠŸèƒ½ä¸­é‡‡æ ·æ—¶é’Ÿä¿¡å·çš„ä½¿ç”¨å’Œåˆ†å¸ƒéŸ³é¢‘åŠŸèƒ½å†…éƒ¨çš„é‡‡æ ·é¢‘ç‡åªèƒ½é€šè¿‡ä¸æ—¶é’Ÿæºå®ä½“å†…éƒ¨çš„é‡‡æ ·é¢‘ç‡æ§åˆ¶ç›´æ¥äº¤äº’æ¥å½±å“ã€‚é‡‡æ ·é¢‘ç‡æ§åˆ¶èŒƒå›´å±æ€§ä¸ºä¸»æœºè½¯ä»¶æä¾›äº†å¿…è¦çš„ä¿¡æ¯ï¼Œä»¥ç¡®å®šä»€ä¹ˆæ ·çš„é‡‡æ ·é¢‘ç‡æ§åˆ¶ï¼ˆä»¥åŠå› æ­¤ç›¸å…³è”çš„æ—¶é’ŸåŸŸï¼‰ æ”¯æŒã€‚ æ”¹å˜é‡‡æ ·é¢‘ç‡çš„å‰¯ä½œç”¨å¯èƒ½æ˜¯æŸäº›éŸ³é¢‘æµæ¥å£å¯èƒ½éœ€è¦åˆ‡æ¢åˆ°ä¸åŒçš„å¤‡ç”¨è®¾ç½®ï¼Œä»¥æ”¯æŒæ–°é‡‡æ ·é¢‘ç‡æ‰€éœ€çš„å¸¦å®½ã€‚æ­¤è§„èŒƒä¸å…è®¸ AudioStreaming æ¥å£è‡ªè¡Œä»ä¸€ä¸ªå¤‡ç”¨è®¾ç½®åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå¤‡ç”¨è®¾ç½®ï¼Œé™¤éæ›´æ”¹ä¸ºå¤‡ç”¨è®¾ç½®é›¶ï¼Œè¿™æ˜¯ç©ºé—²è®¾ç½®ã€‚ç›¸åï¼Œå½“éŸ³é¢‘åŠŸèƒ½æ£€æµ‹åˆ°å®ƒä¸å†æ”¯æŒ AudioStreaming æ¥å£ä¸Šçš„æŸä¸ªå¤‡ç”¨è®¾ç½®æ—¶ï¼Œå®ƒå¿…é¡»åœ¨è¯¥æ¥å£ä¸Šåˆ‡æ¢åˆ°å¤‡ç”¨è®¾ç½®é›¶ï¼Œå¹¶é€šè¿‡æ´»åŠ¨å¤‡ç”¨è®¾ç½®æ§åˆ¶ä¸­æ–­å‘ä¸»æœºè½¯ä»¶æŠ¥å‘Šæ›´æ”¹ã€‚ ç„¶åï¼Œä¸»æœºå¯ä»¥é€šè¿‡ GET æœ‰æ•ˆçš„å¤‡ç”¨è®¾ç½®æ§åˆ¶è¯·æ±‚æ¥æŸ¥è¯¢æ¥å£çš„æ–°çš„æœ‰æ•ˆçš„å¤‡ç”¨è®¾ç½®ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„é€‰æ‹©ã€‚ æ³¨ï¼šè‹¥è¦å°† AudioStreaming æ¥å£ä¸­çš„å¤‡ç”¨è®¾ç½®æ•°é‡ä¿æŒåœ¨æœ€ä½æ°´å¹³ï¼Œå»ºè®®ä¸è¦ä¸ºæ¯ä¸ªæ”¯æŒçš„é‡‡æ ·é¢‘ç‡æä¾›å•ç‹¬çš„å¤‡ç”¨è®¾ç½®ã€‚ç›¸åï¼Œå¦‚æœä¸»æœºè½¯ä»¶èƒ½å¤Ÿå›æ”¶å¸¦å®½å³ä½¿æ˜¯åŒæ­¥ä¼ è¾“ï¼‰ï¼Œæä¾›ä¸€ä¸ªæ´»åŠ¨å¤‡ç”¨è®¾ç½®å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚æˆ–è€…ï¼Œåªéœ€å‡ ä¸ªæ´»åŠ¨å¤‡ç”¨è®¾ç½®ï¼ˆä¸­ç­‰å¸¦å®½ï¼Œé«˜å¸¦å®½ï¼‰ å°±è¶³ä»¥æä¾›åˆç†çš„å¸¦å®½æ§åˆ¶ã€‚ éŸ³é¢‘æµå¯ä»¥é€šè¿‡ä½¿ç”¨é‡‡æ ·ç‡è½¬æ¢å™¨ä»ä¸€ä¸ªæ—¶é’ŸåŸŸæ¡¥æ¥åˆ°å¦ä¸€ä¸ªæ—¶é’ŸåŸŸã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB OTG</title>
      <link href="/2024/LinuxDriver/LinuxUSBOTG/"/>
      <url>/2024/LinuxDriver/LinuxUSBOTG/</url>
      
        <content type="html"><![CDATA[<h1 id="otgæ¥å£ä¸è½¬æ¢å™¨">OTGæ¥å£ä¸è½¬æ¢å™¨</h1><p>OTGæ˜¯"On The Go"çš„è‹±æ–‡ç¼©å†™ï¼Œå­—é¢ä¸Šå¯ä»¥ç†è§£ä¸ºâ€œå®‰ä¸Šå³å¯ç”¨â€ã€‚USBä¼ è¾“æ˜¯ä¸»ä»ç»“æ„ï¼Œä¸€åˆ‡USBä¼ è¾“éƒ½æœ‰Hostå‘èµ·ã€‚æ¯”å¦‚åœ¨å¼€å‘æ¿ä¸Šå¯ä»¥æ’å…¥Uç›˜ï¼Œè¿™æ—¶å¼€å‘æ¿ä½œä¸ºUSB Hostã€‚ä½†æ˜¯å¼€å‘æ¿è¦è·ŸPCé€šä¿¡ï¼Œå¼€å‘æ¿å°±è¦ä½œä¸ºUSB Deviceã€‚å¼€å‘æ¿è¦ä½œä¸ºUSB Hostã€USB Deviceä¸¤ç§è§’è‰²ï¼Œå¯ä»¥ä½¿ç”¨OTGæ’å£ï¼šå®ƒå¯ä»¥æ ¹æ®ç¡¬ä»¶ç”µè·¯è‡ªåŠ¨è¯†åˆ«è‡ªå·±çš„è§’è‰²ï¼Œåˆ‡æ¢ä¸ºUSB Hostæˆ–USB Deivceã€‚</p><p>OTGæ’å£æœ‰å¤šç§å½¢æ€ï¼Œå¸¸ç”¨çš„æœ‰Micro USBã€Type Cï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG1.png"></p><span id="more"></span><h2 id="micro-usb">Micro USB</h2><p>å¯¹äºMicro USBæ’åº§ï¼Œå®ƒæœ‰5æ¡å¼•è„šï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG2.png"></p><p>å¼•è„šä½œç”¨å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th>å¼•è„šå</th><th>ä½œç”¨</th></tr></thead><tbody><tr class="odd"><td>VBUS</td><td>ä½œä¸ºHostæ—¶ï¼Œå¯¹å¤–ä¾›ç”µä½œä¸ºDeviceæ—¶ï¼Œæ¥æ”¶å¤–éƒ¨è¾“å…¥çš„ç”µæº</td></tr><tr class="even"><td>DM</td><td>æ•°æ®ä¿¡å·</td></tr><tr class="odd"><td>DP</td><td>æ•°æ®ä¿¡å·</td></tr><tr class="even"><td>ID</td><td>åˆ†è¾¨è‡ªå·±è§’è‰²çš„å¼•è„šï¼š1ï¼šä½œä¸ºDevice0ï¼šä½œä¸ºHost</td></tr><tr class="odd"><td>GND</td><td>åœ°çº¿</td></tr></tbody></table><p>å¼€å‘æ¿ä½œä¸ºUSB Deviceæ—¶è·ŸPCä¸Šçš„USBç›¸è¿ï¼ŒPCçš„USBæ¥å£åªæœ‰VBUSã€DMã€DPã€GNDï¼Œæ‰€ä»¥å¼€å‘æ¿çš„IDå¼•è„šè·ŸPCçš„USBå£å¹¶æ— è¿æ¥ï¼Œå®ƒè¢«æ¿å­ä¸Šçš„ä¸Šæ‹‰ç”µé˜»æ‹‰é«˜ã€‚</p><p>å¼€å‘æ¿ä½œä¸ºUSB Hostæ—¶ï¼Œéœ€è¦æ¥å…¥ä¸€ä¸ª"OTGè½¬æ¢å™¨"ï¼Œå¦‚ä¸‹å›¾é»‘è‰²çš„è½¬æ¢å™¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG3.png" alt="OTG3.png"></p><p>OTGè½¬æ¢å™¨çš„å†…éƒ¨ç”µè·¯å¾ˆç®€å•(å‚è€ƒï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cubHVsaWFuLmNuL25ld3Mvb3RnX2dvbmduZW5nX2ppZXhpLWNuLmh0bWw=">https://www.lulian.cn/news/otg_gongneng_jiexi-cn.html<i class="fa fa-external-link-alt"></i></span>)ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG4.png"></p><p>è¿™ä¸ªè½¬æ¢å™¨æ’å…¥å¼€å‘æ¿çš„OTGå£ä¹‹åï¼ŒOTGå£ä¸Šçš„IDå¼•è„šå°±è¢«æ‹‰ä½ï¼Œè½¯ä»¶è½¬æ¢ä¸ºUSB Hostã€‚</p><h2 id="type-c">Type C</h2><p>Type Cæ’åº§é‡Œé¢æœ‰ä¸¤ç»„å®Œå…¨ä¸€æ ·çš„ä¿¡å·ï¼ŒType Cæ•°æ®çº¿æ— è®ºæ­£æ’ã€åæ’ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG5.png" alt="OTG5.png"></p><p>Type Cæ’åº§æœ‰å¦‚ä¸‹ä¿¡å·(å‚è€ƒï¼š<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3NjU5MDE0L2FydGljbGUvZGV0YWlscy8xMjQ0NzkxMjU=">https://blog.csdn.net/qq_37659014/article/details/124479125<i class="fa fa-external-link-alt"></i></span>)ï¼Œåœ¨USB2.0åè®®é‡Œæˆ‘ä»¬åªå…³å¿ƒçº¢æ¡†é‡Œçš„ä¿¡å·ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG6.png"></p><p>å¼€å‘æ¿ä½œä¸ºUSB Deviceæ—¶è·ŸPCä¸Šçš„USBç›¸è¿ï¼ŒPCçš„USBæ¥å£åªæœ‰VBUSã€DMã€DPã€GNDï¼Œæ‰€ä»¥å¼€å‘æ¿çš„CC1ã€CC2å¼•è„šè·ŸPCçš„USBå£å¹¶æ— è¿æ¥ï¼Œå®ƒè¢«æ¿å­ä¸Šçš„ä¸Šæ‹‰ç”µé˜»æ‹‰é«˜ã€‚</p><p>å¼€å‘æ¿ä½œä¸ºUSB Hostæ—¶ï¼Œéœ€è¦æ¥å…¥ä¸€ä¸ª"OTGè½¬æ¢å™¨"ï¼Œå¦‚ä¸‹å›¾é»‘è‰²çš„è½¬æ¢å™¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG7.png"></p><p>å¦‚æœä¸è€ƒè™‘å…¼å®¹USB 3.0åè®®ï¼Œä¸Šè¿°è½¬æ¢å™¨çš„ç”µè·¯å›¾å¾ˆç®€å•ï¼ŒæŠŠType Cæ’å¤´é‡Œé¢çš„CCå¼•è„šè¿æ¥5.1Kæ¬§å§†ç”µé˜»åˆ°GNDå³å¯ã€‚</p><h1 id="otgæ¥å£ç”µè·¯">OTGæ¥å£ç”µè·¯</h1><p>å¼€å‘æ¿ä¸Šçš„OTGæ¥å£éœ€è¦å®ç°ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li>æ£€æµ‹IDå¼•è„š(ä½¿ç”¨Type Cæ¥å£çš„è¯æ˜¯CC1ã€CC2å¼•è„š)ï¼Œå¼•å…¥ä¸»æ§èŠ¯ç‰‡ï¼šè½¯ä»¶æ ¹æ®å®ƒè®¾ç½®USBæ§åˆ¶å™¨çš„è§’è‰²(Hostæˆ–Device)</li><li>æ ¹æ®IDå¼•è„š(æˆ–è€…CC1ã€CC2)å†³å®šVBUSæ˜¯å¦è¾“å‡ºç”µæºï¼šç¡¬ä»¶ç”µè·¯è‡ªåŠ¨å®ç°</li></ul><h2 id="micro-usb-1">Micro USB</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG9.png"></p><h2 id="type-c-1">Type C</h2><p>å¦‚æœä¸è€ƒè™‘å…¼å®¹USB 3.0åè®®ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç²¾ç®€ç”µè·¯ï¼šCC1ã€CC2ä½œä¸ºIDå¼•è„šã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG10.png"></p><p>å¦‚æœè¦å…¼å®¹USB 3.0åè®®ï¼Œåˆ™éœ€è¦åŠ å…¥ä¸“ç”¨çš„èŠ¯ç‰‡ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/OTG11.png"></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UACï¼ˆé›¶ï¼‰UAC Topology</title>
      <link href="/2024/LinuxDriver/LinuxUSBUACTopology/"/>
      <url>/2024/LinuxDriver/LinuxUSBUACTopology/</url>
      
        <content type="html"><![CDATA[<h1 id="uac-æ‹“æ‰‘ç»“æ„">UAC æ‹“æ‰‘ç»“æ„</h1><p>UAC è§„èŒƒæè¿°äº†ä»¥ä¸‹ç±»å‹çš„æ ‡å‡†å•å…ƒå’Œç»ˆç«¯ï¼Œè¿™äº›å•å…ƒå’Œç»ˆç«¯è¢«è®¤ä¸ºè¶³ä»¥ä»£è¡¨å½“å‰å’Œè¿‘æœŸå¯ç”¨çš„å¤§å¤šæ•°è§†é¢‘åŠŸèƒ½ï¼š</p><ul><li>è¾“å…¥ç»ˆç«¯ - Input Terminal (IT)</li><li>è¾“å‡ºç»ˆç«¯ - Output Terminal (OT)</li><li>æ··éŸ³å™¨å•å…ƒ - Mixer Unit (MU)</li><li>é€‰æ‹©å™¨å•å…ƒ - Selector Unit (SU)</li><li>ç‰¹æ€§å•å…ƒ - Feature Unit (FU)</li><li>é‡‡æ ·é€Ÿç‡è½¬æ¢å•å…ƒ - Sampling Rate Converter Unit (RU)</li><li>ç‰¹æ•ˆå•å…ƒ - Effect Unit (EU)</li><li>å¤„ç†å•å…ƒ (PU) - Processing Unit (PU)</li><li>æ‰©å±•å•å…ƒ (XU) - Extension Unit (XU)</li></ul><p>é™¤äº†å•å…ƒå’Œç»ˆç«¯å¤–ï¼Œè¿˜å¼•å…¥äº†æ—¶é’Ÿå®ä½“çš„æ¦‚å¿µã€‚å®šä¹‰äº†ä¸‰ç§ç±»å‹çš„æ—¶é’Ÿå®ä½“</p><ul><li>æ—¶é’Ÿæº - Clock Source (CS)</li><li>æ—¶é’Ÿé€‰æ‹©å™¨ - Clock Selector (CX)</li><li>æ—¶é’Ÿå€é¢‘å™¨ - Clock Multiplier (CM)</li></ul><span id="more"></span><h1 id="uac-è®¾å¤‡æ‹“æ‰‘ç»“æ„">UAC è®¾å¤‡æ‹“æ‰‘ç»“æ„</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uac5.png"></p><p>æ§ä»¶é€šå¸¸æä¾›å¯¹ç‰¹å®šçš„éŸ³é¢‘æˆ–æ—¶é’Ÿå±æ€§ã€‚æ¯ä¸ªæ§ä»¶éƒ½æœ‰ä¸€ç»„å¯ä»¥æ“ä½œæˆ–æ˜¾ç¤ºçš„å±æ€§ã€‚</p><p>æœ‰å…³æ§ä»¶è¡Œä¸ºçš„å…¶ä»–ä¿¡æ¯ã€‚æ§ä»¶å¯ä»¥å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š</p><ul><li>ç”µæµè®¾ç½®å±æ€§</li><li>èŒƒå›´å±æ€§ä¸‰å…ƒç»„åŒ…æ‹¬ï¼š<ul><li>æœ€å°è®¾ç½®å±æ€§</li><li>æœ€å¤§è®¾ç½®å±æ€§</li><li>åˆ†è¾¨ç‡å±æ€§</li></ul></li><li>ä¸­æ–­å¯ç”¨å±æ€§</li></ul><p>ä¾‹å¦‚ï¼Œè€ƒè™‘è¦ç´ å•å…ƒå†…çš„éŸ³é‡æ§åˆ¶ã€‚é€šè¿‡å‘å‡ºé€‚å½“çš„ Get è¯·æ±‚ï¼Œä¸»æœºè½¯ä»¶å¯ä»¥è·å–éŸ³é‡æ§åˆ¶çš„å±æ€§å€¼ï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨å®ƒä»¬æ¥æ­£ç¡®æ˜¾ç¤ºæ§åˆ¶ã€‚è®¾ç½®éŸ³é‡æ§åˆ¶çš„å½“å‰å±æ€§å…è®¸ä¸»æœºè½¯ä»¶æ›´æ”¹éŸ³é‡éŸ³é‡è®¾ç½®æ§åˆ¶ã€‚</p><p>å¦å¤–ï¼ŒéŸ³é¢‘åŠŸèƒ½ä¸­çš„æ¯ä¸ªå®ä½“éƒ½å¯ä»¥æœ‰ä¸€ä¸ªå†…å­˜ç©ºé—´å±æ€§ã€‚æ­¤å±æ€§æä¾›å¯¹å®ä½“å†…éƒ¨å†…å­˜ç©ºé—´çš„é€šç”¨è®¿é—®ã€‚</p><h1 id="uac-éŸ³é¢‘æ§åˆ¶">UAC éŸ³é¢‘æ§åˆ¶</h1><p>ä¸€ä¸ª USB è®¾å¤‡å¯èƒ½åŒ…å«å¤šä¸ªé…ç½®ã€‚åƒæ‰‹æœºä¸€æ ·ï¼Œå½“æ‰‹æœºé€šè¿‡ USB çº¿ç¼†æ¥å…¥ PC æœºåï¼Œä¼šå¼¹å‡ºä¸€ä¸ªé€‰æ‹©å¯¹è¯æ¡†ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uac6.png"></p><p>è®©ç”¨æˆ·é€‰æ‹©ã€‚å½“ç„¶ä¸€ä¸ª USB è®¾å¤‡åªèƒ½å·¥ä½œåœ¨ä¸€ç§é…ç½®æè¿°ç¬¦ä¸‹ã€‚</p><p>å¯¹äºæ¯ä¸€ä¸ª USB é…ç½®æè¿°ç¬¦ï¼Œå¯èƒ½å«æœ‰å¤šä¸ª USB æ¥å£æè¿°æè¿°ç¬¦ï¼ŒåŒæ—¶è¿™äº›æ¥å£æè¿°ç¬¦å¯èƒ½æ¯ä¸ªæ¥å£æè¿°ç¬¦åˆåŒ…å«å¤šä¸ªè½¬æ¢æ¥å£æè¿°ç¬¦ã€‚</p><p>è¿™äº›æ¥å£æè¿°ç¬¦å¯èƒ½æ¯ä¸€ä¸ªæ¥å£æè¿°ç¬¦å®ç°çš„æ˜¯ä¸åŒçš„ç‹¬ç«‹çš„åŠŸèƒ½æˆ–è€…å¤šä¸ªæ¥å£æè¿°ç¬¦ç»„åˆå®ç°ä¸€äº›è®¾å¤‡åŠŸèƒ½ã€‚ åœ¨å®é™…çš„è®¾å¤‡å·¥ä½œä¸­ï¼Œå¯èƒ½åˆå› ä¸ºå·¥ä½œçŠ¶æ€çš„ä¸åŒï¼Œè¿™äº›æ¥å£æè¿°ç¬¦è¿›è¡Œè½¬æ¢æ¥å£çš„åˆ‡æ¢ã€‚</p><h1 id="uac-éŸ³é¢‘è®¾å¤‡çš„æ¥å£çš„åˆ†ç±»">UAC éŸ³é¢‘è®¾å¤‡çš„æ¥å£çš„åˆ†ç±»</h1><p>è¿™äº›æ¥å£é…åˆå®ç°çš„ UAC è®¾å¤‡æ¥å£ï¼Œåˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«å«åš UAC éŸ³é¢‘æ§åˆ¶æ¥å£å’Œ UAC éŸ³é¢‘æµæ¥å£ã€‚</p><ul><li>UAC éŸ³é¢‘æ§åˆ¶æ¥å£ï¼šç”¨äºå®ç° UAC éŸ³é¢‘æ§åˆ¶æ¥å£åŠæ‹“æ‰‘ç»“æ„çš„æšä¸¾</li><li>UAC éŸ³é¢‘æµæ¥å£ï¼šç”¨äºéŸ³é¢‘æ•°æ®æµçš„ä¼ è¾“</li></ul><h2 id="uac-éŸ³é¢‘æ§åˆ¶æ¥å£">UAC éŸ³é¢‘æ§åˆ¶æ¥å£</h2><p>ä¸ºäº†æ§åˆ¶ç‰¹å®šéŸ³é¢‘åŠŸèƒ½çš„åŠŸèƒ½è¡Œä¸ºï¼Œä¸»æœºå¯ä»¥æ“çºµæ—¶é’Ÿå®ä½“ã€å•å…ƒä»¥åŠéŸ³é¢‘åŠŸèƒ½å†…éƒ¨çš„ç»ˆç«¯ã€‚ä¸ºäº†ä½¿è¿™äº›å¯¹è±¡å¯è®¿é—®ï¼ŒéŸ³é¢‘åŠŸèƒ½åº”æä¾›å•éŸ³é¢‘æ§åˆ¶æ¥å£ã€‚æ­¤æ¥å£å¯ä»¥åŒ…å«ä»¥ä¸‹ç«¯ç‚¹ï¼š</p><ul><li>æ§åˆ¶ç«¯ç‚¹ï¼Œç”¨äºæ“ä½œæ—¶é’Ÿå®ä½“ã€å•å…ƒå’Œç»ˆç«¯è®¾ç½®ä»¥åŠæ£€ç´¢ç³»ç»ŸçŠ¶æ€éŸ³é¢‘åŠŸèƒ½ã€‚æ­¤ç«¯ç‚¹æ˜¯å¿…éœ€çš„ï¼Œé»˜è®¤ç«¯ç‚¹ 0 ç”¨äºæ­¤ç›®çš„ã€‚</li><li>ä¸­æ–­ç«¯ç‚¹ã€‚ä¸­æ–­ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼Œå¦‚æœè®¾å¤‡éœ€è¦é€šçŸ¥ä¸»æœºéŸ³é¢‘åŠŸèƒ½è¡Œä¸ºå˜åŒ–ã€‚</li></ul><p>éŸ³é¢‘æ§åˆ¶æ¥å£æ˜¯è®¿é—®éŸ³é¢‘åŠŸèƒ½å†…éƒ¨çš„æƒŸä¸€å…¥å£ã€‚æ‰€æœ‰è¦æ±‚ä¸éŸ³é¢‘åŠŸèƒ½çš„æ—¶é’Ÿå®ä½“ã€å•å…ƒæˆ–å†…éƒ¨éŸ³é¢‘æ§ä»¶çš„æ“ä½œæœ‰å…³ç»ˆç«¯åº”æŒ‡å‘éŸ³é¢‘åŠŸèƒ½çš„éŸ³é¢‘æ§åˆ¶æ¥å£ã€‚æ‰€æœ‰ä¸éŸ³é¢‘åŠŸèƒ½çš„æè¿°ç¬¦éƒ½æ˜¯éŸ³é¢‘æ§åˆ¶æ¥å£æè¿°ç¬¦çš„ä¸€éƒ¨åˆ†ã€‚éŸ³é¢‘æ§åˆ¶æ¥å£çš„è½¬æ¢æ¥å£ AlternateSetting åªèƒ½ä¸º 0ã€‚</p><h3 id="uac-éŸ³é¢‘æ§åˆ¶æ¥å£ä¸­çš„éŸ³é¢‘æ§åˆ¶ç«¯ç‚¹">UAC éŸ³é¢‘æ§åˆ¶æ¥å£ä¸­çš„éŸ³é¢‘æ§åˆ¶ç«¯ç‚¹</h3><p>éŸ³é¢‘æ§åˆ¶ç«¯ç‚¹ä½¿ç”¨é»˜è®¤çš„ USB ç«¯ç‚¹ 0 æ¥è¿›è¡Œ UAV éŸ³é¢‘çš„åŠŸèƒ½æ§åˆ¶ã€‚å®ç°æ–¹å¼æ˜¯ UAC é€šè¿‡ç«¯ç‚¹ 0 å‘é€ USB ç‰¹å®šç±»è¯·æ±‚ã€‚</p><h3 id="uac-éŸ³é¢‘æ§åˆ¶æ¥å£ä¸­çš„éŸ³é¢‘ä¸­æ–­ç«¯ç‚¹">UAC éŸ³é¢‘æ§åˆ¶æ¥å£ä¸­çš„éŸ³é¢‘ä¸­æ–­ç«¯ç‚¹</h3><p>UAC éŸ³é¢‘ä¸­æ–­ç«¯ç‚¹æ˜¯å¯é€‰çš„ã€‚é€šè¿‡æ­¤ä¸­æ–­ç«¯ç‚¹å¯ä»¥å‘ä¸»æœºä¸ŠæŠ¥åŠ¨æ€ä¸­æ–­çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯æ¥æºäºå¯å¯»å€å®ä½“ï¼ˆæ—¶é’Ÿå®ä½“ã€ç»ˆç«¯ã€å•å…ƒã€æ¥å£å’Œç«¯ç‚¹ï¼‰ã€‚</p><p>ä¸­æ–­æ§åˆ¶ç«¯ç‚¹è¿”å›çš„æ•°æ®é•¿åº¦ä¸º 2 å­—èŠ‚ï¼Œåˆ†åˆ«ä¸º bStatusType å’Œ bOriginatorã€‚</p><ul><li>bStatusType çš„ D7 ä½æ ‡è¯†ä¸­æ–­æ˜¯å¦æŒ‚èµ·ï¼ŒD6 ç”¨äºæ ‡è¯†æ˜¯å¦æ˜¯å›ºä»¶å†…å­˜å˜åŒ–ä¸­æ–­ï¼ˆé€šè¿‡ Get Memory ç‰¹å®šç±»è¯·ç¤ºæ¸…é™¤ï¼‰ï¼ŒD4,D5 ä¿ç•™ä¸º 0ï¼ŒD0-D3 ä¸º 0 è¡¨ç¤ºæ˜¯ä¸­æ–­æ¥æºäºéŸ³é¢‘æ§åˆ¶æ¥å£ï¼Œä¸º 1 è¡¨ç¤ºä¸­æ–­æ¥æºäºéŸ³é¢‘æµæ¥å£ï¼Œä¸º 2 è¡¨ç¤ºä¸­æ–­æ¥æºäºéŸ³é¢‘æµæ¥å£ç«¯ç‚¹ï¼Œå€¼ 3-15 ä¿ç•™ã€‚</li><li>bOriginatorï¼šæ ¹æ®ä¸­æ–­çš„æ¥åŸäºç”¨æ ‡è¯†ä¸­æ–­æºçš„ ID æˆ–ç«¯ç‚¹åœ°å€ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uac7.png"></p><h2 id="uac-éŸ³é¢‘æµæ¥å£">UAC éŸ³é¢‘æµæ¥å£</h2><p>UAC éŸ³é¢‘æµæ¥å£ç”¨äºä¼ è¾“éŸ³é¢‘æµæ•°æ®ã€‚ä¸€ä¸ª UAC éŸ³é¢‘è®¾å¤‡å¯ä»¥æœ‰å¤šä¸ªéŸ³é¢‘æµæ¥å£ï¼Œæ¯ä¸ªéŸ³é¢‘æµæ¥å£å¯ä»¥ä¼ è¾“ä¸åŒçš„éŸ³é¢‘æ•°æ®æ ¼å¼ã€‚æ¯ä¸€ä¸ªéŸ³é¢‘æµæ¥å£åªèƒ½æœ‰ä¸€ä¸ªç­‰æ—¶ä¼ è¾“ç«¯ç‚¹ï¼Œè¿™æ ·ä¿è¯çš„æ˜¯æ•°æ®çš„ä¼ è¾“ä¸ç«¯ç‚¹ç›¸å…³ã€‚</p><p>éŸ³é¢‘æµæ¥å£åŒ…å«è½¬æ¢æ¥å£è¿›è¡ŒéŸ³é¢‘æµçš„åˆ‡æ¢ã€‚ä½†è‡³å°‘åŒ…å«ä¸€ä¸ªè½¬æ¢æ¥å£ä¸º 0 çš„é›¶å¸¦å®½å³ä¸ä¼ è¾“éŸ³é¢‘æµæ¥å£å’Œä¸€ä¸ªåŒ…å«å®é™…ä¼ è¾“æ•°æ®çš„è½¬æ¢æ¥å£ 1ã€‚</p><h2 id="uac-éŸ³é¢‘å…¶å®ƒæ§åˆ¶">UAC éŸ³é¢‘å…¶å®ƒæ§åˆ¶</h2><ul><li>æ—¶é’Ÿæ§åˆ¶</li><li>ç”µæºåŸŸæ§åˆ¶</li><li>æŒ‰é’®æ§åˆ¶ï¼šåˆ†ä¸ºé€šè¿‡ HID æ¥å£å®ç°å’ŒéŸ³å“æ§åˆ¶çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹<br>ã€ŠUAC2 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆä¹ï¼‰è™šæ‹Ÿå£°å¡ Latency</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAVCardLatency/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAVCardLatency/</url>
      
        <content type="html"><![CDATA[<h1 id="æµ‹è¯•æ–¹æ³•">æµ‹è¯•æ–¹æ³•</h1><ul><li>ä¸¤å—æ¿å­ä¹‹é—´é€šè¿‡ I2S é€šä¿¡ï¼Œå…¶ä¸­ä¸€å—æ¿å­é…ç½®ä¸º Slave å¦ä¸€å—æ¿å­ä¸º Master</li><li><p>Master æ¿ç«¯æ‰§è¡Œ arecord | aplay æˆ–è€… gstream å‘½ä»¤ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arecord -Dhw:2,0 -r 44100 -c 8 -f S32_LE | aplay -Dhw:2,0 -c 8 -r 44100 -f S32_LE</span><br><span class="line">gst-launch-1.0 alsasrc device=device_input_split ! alsasink device=device_output <span class="built_in">sync</span>=<span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li>Slave é€šè¿‡ aplay æ’­æ”¾ä¸€æ®µ wav æ–‡ä»¶</li><li><p>é€šè¿‡ç¤ºæ³¢å™¨æŠ“å– Master æ¿çš„ I2S è¾“å…¥å’Œè¾“å‡ºç«¯çš„æ³¢å½¢é—´éš”æ¥æµ‹é‡è™šæ‹Ÿå£°å¡çš„ Latency</p></li></ul><span id="more"></span><h1 id="datastream">DataStream</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/alsa_latency.png"></p><p>ä¸Šå›¾å°±æ˜¯ arecord | aplayï¼ˆæ²¡æœ‰ä½¿ç”¨æ’ä»¶ï¼‰ æ•´ä¸ªè™šæ‹Ÿå£°å¡çš„æ•°æ®æµï¼Œå…¶ä¸­å»¶è¿Ÿæœ€å¤§çš„éƒ¨åˆ†å°±æ˜¯çº¢è‰²æ¡†ä¸­çš„ç¼“å­˜ã€‚</p><p>èµ° USB é€šè·¯çš„ latencyï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/vsoundCardUSBLatency.png"></p><h1 id="å¢å¤§-buffer-size-ä¸ºä»€ä¹ˆä¼šå¢å¤§-latency">å¢å¤§ Buffer Size ä¸ºä»€ä¹ˆä¼šå¢å¤§ latencyï¼Ÿ</h1><p>aplay é€šè¿‡è°ƒç”¨ snd_pcm_write å†™æ•°æ®ç»™é©±åŠ¨ï¼Œalsa lib ä¸­ snd_pcm_write æœ‰å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_snd_pcm_writei(pcm, buffer, size)</span><br><span class="line">--&gt;pcm-&gt;fast_ops-&gt;writei(pcm-&gt;fast_op_arg, buffer, size)</span><br><span class="line">--&gt;snd_pcm_hw_writei</span><br><span class="line">--&gt;ioctl(fd, SNDRV_PCM_IOCTL_WRITEI_FRAMES, &amp;xferi)</span><br></pre></td></tr></tbody></table></figure><p>alsa lib é€šè¿‡ ioctl ç³»ç»Ÿè°ƒç”¨åˆ°å†…æ ¸ï¼Œæ‰“å° snd_pcm_write å†…æ ¸è°ƒç”¨æ ˆï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   14.513126@2]  Call trace:</span><br><span class="line">[   14.513472@2]  [ffffffc0201cbb20+  96][&lt;ffffffe610095490&gt;] dump_backtrace+0x0/0x188</span><br><span class="line">[   14.514417@2]  [ffffffc0201cbb80+  32][&lt;ffffffe61009563c&gt;] show_stack+0x24/0x30</span><br><span class="line">[   14.515329@2]  [ffffffc0201cbba0+  64][&lt;ffffffe611010068&gt;] dump_stack+0xc8/0xf0</span><br><span class="line">[   14.516240@2]  [ffffffc0201cbbe0+ 208][&lt;ffffffe610cc4d14&gt;] __snd_pcm_lib_xfer+0x834/0x850</span><br><span class="line">[   14.517257@2]  [ffffffc0201cbcb0+  80][&lt;ffffffe610cb9a34&gt;] snd_pcm_ioctl_xferi_compat+0x14c/0x260</span><br><span class="line">[   14.518360@2]  [ffffffc0201cbd00+ 208][&lt;ffffffe610cbd66c&gt;] snd_pcm_ioctl_compat+0x10c/0xdb8</span><br><span class="line">[   14.519405@2]  [ffffffc0201cbdd0+ 144][&lt;ffffffe610323754&gt;] __arm64_compat_sys_ioctl+0x16c/0x1220</span><br><span class="line">[   14.520496@2]  [ffffffc0201cbe60+  64][&lt;ffffffe61009ee28&gt;] el0_svc_common.constprop.3+0x90/0x1b0</span><br><span class="line">[   14.521589@2]  [ffffffc0201cbea0+ 336][&lt;ffffffe61009f014&gt;] el0_svc_compat_handler+0x2c/0x38</span><br><span class="line">[   14.522630@2]  [ffffffc0201cbff0+   0][&lt;ffffffe610083d5c&gt;] el0_svc_compat+0x8/0x2c</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>æ•´ç†ä¸€ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/alsa_latency1.png"></p><p>å†…æ ¸ä¸­é€šè¿‡ Ioctl ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆè°ƒç”¨åˆ°__snd_pcm_lib_xfer å‡½æ•°ï¼Œç„¶åå‘ç°è¯¥æ•°æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/alsa_latency2.png"></p><p>å¦‚æœæ˜¯ playback æµï¼Œä¸”çŠ¶æ€ä¸º parpareï¼Œå½“ runtimeâ†’dma_area é‡Œçš„æ•°æ®å¤§äºç­‰äº runtimeâ†’start_thresholdï¼ŒçŠ¶æ€æ‰ä¼šåˆ‡æ¢åˆ° runningã€‚é€šè¿‡æ‰“å° log å‘ç°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[   14.571395@0]  playback : buffer_size : 2048 dma size : 65536 start_threshold : 2048 stop_threshold : 2048</span><br><span class="line">[   14.572960@2]  capture : buffer_size : 2048 dma size : 65536 start_threshold : 1 stop_threshold : 2048</span><br></pre></td></tr></tbody></table></figure><p>playback çš„ runtimeâ†’start_threshold è·Ÿ buffer_size ä¸€æ ·å¤§ï¼Œä¹Ÿå°±æ˜¯ playback ä¼šå…ˆç¼“å­˜ buffer_size ä¸ª frame çš„æ•°æ®ç„¶åå†å¼€å§‹æ’­æ”¾ï¼Œè¿™æ ·ä¼šå¯¼è‡´ latency éšç€ buffer_size çš„å˜å¤§è€Œå˜å¤§äº†ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxzYS1wcm9qZWN0Lm9yZy9hbHNhLWRvYy9hbHNhLWxpYi9wY21fcGx1Z2lucy5odG1s">https://www.alsa-project.org/alsa-doc/alsa-lib/pcm_plugins.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9hbHNhLm9wZW5zcmMub3JnL0FMU0FfcGx1Z2lucw==">https://alsa.opensrc.org/ALSA_plugins<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…æ ¸è°ƒè¯•ï¼ˆä¸‰ï¼‰VM å‚æ•°è°ƒè¯•</title>
      <link href="/2024/LinuxKernel/LinuxKernelDebugVM/"/>
      <url>/2024/LinuxKernel/LinuxKernelDebugVM/</url>
      
        <content type="html"><![CDATA[<h1 id="vm-å‚æ•°è¯´æ˜">vm å‚æ•°è¯´æ˜</h1><p>Currently, these files are in /proc/sys/vm: <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vm.png"></p><span id="more"></span><ul><li><p>admin_reserve_kbytesï¼š<strong>ç³»ç»Ÿä¸­åº”ä¸ºç”¨æˆ·ä¿ç•™çš„å¯ç”¨å†…å­˜é‡</strong>ã€‚</p><p>é»˜è®¤ (3% of free pages, 8MB)ã€‚è¿™åº”è¯¥è¶³ä»¥è®© admin ç™»å½•å¹¶ç»ˆæ­¢è¿›ç¨‹ã€‚è¿™ä¸ªå€¼çš„è®¾ç½®ï¼Œæœ€å¥½ä¿è¯ç³»ç»Ÿè¶³å¤Ÿè¿è¡Œ sshd or login + bash (or some other shell) + top (or ps, kill, etc.)</p></li><li>block_dumpï¼š<strong>å½“è®¾ç½®ä¸ºéé›¶å€¼æ—¶ï¼Œblock_dump å¯ç”¨å— I/O è°ƒè¯•</strong>ã€‚</li><li><p>compact_memoryï¼šå‹ç¼©å†…å­˜ã€‚</p><p>ä»…å½“è®¾ç½® CONFIG_COMPACTION æ—¶å¯ç”¨ã€‚ å½“å†™å…¥ 1 æ—¶ï¼Œæ‰€æœ‰åŒºåŸŸéƒ½ä¼šè¢«å‹ç¼©ï¼Œä»¥ä¾¿å¯ä»¥æ›´å¥½çš„æä¾›è¿ç»­å†…å­˜ã€‚ è¿™åœ¨åˆ†é…å¤§é¡µé¢æ—¶å¯èƒ½å¾ˆé‡è¦ï¼Œå°½ç®¡è¿›ç¨‹ä¹Ÿä¼šæ ¹æ®éœ€è¦ç›´æ¥å‹ç¼©å†…å­˜ã€‚</p></li><li>compact_unevictable_allowedï¼šå‹ç¼©æ—¶æ£€æŸ¥ lruã€‚</li><li>dirty_background_bytesï¼šå¦‚æœ dirty é¡µå¤§äºè¿™ä¸ªå€¼ï¼Œå†…æ ¸åå°çº¿ç¨‹å¼€å§‹å·¥ä½œï¼Œå°† dirty å†…å­˜å†™å›åˆ° flashã€‚</li><li>dirty_background_ratioï¼šdirty_background_bytes æ˜¯ dirty_background_ratio çš„å¯¹åº”é¡¹ï¼Œ ä¸€æ¬¡åªèƒ½æŒ‡å®šå…¶ä¸­ä¹‹ä¸€ã€‚dirty_background_ratio æ˜¯æŒ‰ç…§æ€»å¯ç”¨å†…å­˜çš„ç™¾åˆ†æ¯”ï¼ˆç©ºé—²é¡µå’Œå¯å›æ”¶é¡µçš„æ€»å¯ç”¨å†…å­˜çš„ç™¾åˆ†æ¯”ï¼‰æ¥è®¾ç½®çš„ï¼Œæ€»å¯ç”¨å†…å­˜ä¸ç­‰äºæ€»ç³»ç»Ÿå†…å­˜ã€‚</li><li>dirty_bytesï¼šç³»ç»Ÿ dirty å†…å­˜è¶…è¿‡è¯¥å€¼æ—¶ï¼Œå†™æ–‡ä»¶çš„ process ä¼šå¼€å§‹å›å†™ dirty å†…å­˜åˆ° flashã€‚dirty_bytes å…è®¸çš„æœ€å°å€¼æ˜¯ä¸¤é¡µï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼› ä»»ä½•ä½äºæ­¤é™åˆ¶çš„å€¼éƒ½å°†è¢«å¿½ç•¥ï¼Œæ—§çš„é…ç½®å°†è¢«ä¿ç•™ã€‚</li><li>dirty_ratioï¼šdirty_bytes æ˜¯ dirty_ratio çš„å¯¹åº”é¡¹ï¼Œä¸€æ¬¡åªèƒ½æŒ‡å®šå…¶ä¸­ä¹‹ä¸€ã€‚æŒ‰ç…§ç©ºé—²é¡µå’Œå¯å›æ”¶é¡µçš„æ€»å¯ç”¨å†…å­˜çš„ç™¾åˆ†æ¯”æ¥è®¾ç½®ã€‚</li><li><p>dirty_expire_centisecsï¼šæ­¤å‚æ•°å®šä¹‰ dirty page å¤šä¹…å¿…é¡»åˆ·å…¥ flashï¼Œä»–ä»¥ç™¾åˆ†ä¹‹ä¸€ç§’æ¥è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºè¡¨ç¤º 30sï¼Œå¦‚æœ dirty page è¶…è¿‡ 30s æ²¡æœ‰è¢«å†™å…¥ flashï¼Œé‚£ä¹ˆä¸‹æ¬¡ flusher thread è¢«è°ƒåº¦çš„æ—¶å€™è¯¥é¡µå°†å›å†™åˆ° flashã€‚</p></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm <span class="comment"># cat dirty_expire_centisecs</span></span><br><span class="line">3000</span><br></pre></td></tr></tbody></table></figure><ul><li>dirtytime_expire_secondsï¼šæ­¤å¯è°ƒå‚æ•°ç”¨äºå®šä¹‰ dirty inode ä½•æ—¶è¶³å¤Ÿ dirtyï¼Œè¶…è¿‡è¿™ä¸ªå€¼å†…æ ¸ flusher thread è¿›è¡Œå†™å›ã€‚</li><li>dirty_writeback_centisecsï¼šæ˜¯ç”¨æ¥è¡¨ç¤ºå†…æ ¸æ£€æŸ¥ dirty page çš„è¿è¡Œé—´éš”ï¼Œå•ä½æ˜¯ç§’çš„ç™¾åˆ†ä¹‹ä¸€ï¼Œä¸&nbsp;<code>dirty_expire_centisecs</code>&nbsp;é…åˆèµ·æ¥ä½¿ç”¨ã€‚</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm <span class="comment"># cat dirty_writeback_centisecs</span></span><br><span class="line">500</span><br></pre></td></tr></tbody></table></figure><ul><li><p>drop_caches:</p><p>Writing to this will cause the kernel to drop clean caches, as well as reclaimable slab objects like dentries and inodes. Once dropped, their memory becomes free</p><ul><li>To free pagecache::</li></ul><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></tbody></table></figure><p></p><p>pagecache æ˜¯å·²ç»å’Œå¤–éƒ¨ç£ç›˜åŒæ­¥è¿‡çš„éƒ¨åˆ†ï¼Œæ—¢ç„¶å·²ç»åŒæ­¥è¿‡äº†ï¼Œç›´æ¥ä¸¢å¼ƒå³å¯ï¼Œä¸‹æ¬¡è¦ç”¨å†ä»ç£ç›˜ä¸Šæ‹·è´å›æ¥å°±å¯ä»¥äº†ï¼Œå¦‚æœè¦ clean æ›´å¤šéœ€è¦å…ˆæ‰§è¡Œ sync</p><ul><li>To free reclaimable slab objects (includes dentries and inodes)::</li></ul><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></tbody></table></figure><p></p><p>slab objects åŒ…æ‹¬ includes dentries and inodesã€‚å¯¹äºç£ç›˜æ–‡ä»¶ç³»ç»Ÿï¼Œå†…å­˜ inode å­˜åœ¨ flash ä¸­ï¼Œå› æ­¤åŒ page cache ä¸€æ ·ï¼Œè¾ƒæ˜“åœ¨å†…å­˜ä¸­é‡å»ºï¼Œé‡Šæ”¾çš„ä»£ä»·è¾ƒä½ã€‚dentry è™½ç„¶åœ¨ç£ç›˜ä¸Šæ²¡æœ‰ç›´æ¥å¯¹åº”çš„ç»“æ„ï¼Œä½†ä¹Ÿå¯æ ¹æ®æ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½• inode çš„ä¿¡æ¯è¿›è¡Œé‡å»º</p><ul><li>To free slab objects and pagecache::</li></ul><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™æ˜¯ä¸€ä¸ªéç ´åæ€§æ“ä½œï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½• dirty objectsã€‚ è¦å¢åŠ æ­¤æ“ä½œé‡Šæ”¾çš„å¯¹è±¡æ•°é‡ï¼Œç”¨æˆ·å¯ä»¥åœ¨å†™å…¥ /proc/sys/vm/drop_caches ä¹‹å‰è¿è¡Œâ€œsyncâ€ã€‚ è¿™å°†æœ€å¤§é™åº¦åœ°å‡å°‘ç³»ç»Ÿä¸Šè„å¯¹è±¡çš„æ•°é‡ï¼Œå¹¶åˆ›å»ºæ›´å¤šè¦åˆ é™¤çš„å€™é€‰å¯¹è±¡ã€‚</p><p>è¯¥æ–‡ä»¶ä¸æ˜¯æ§åˆ¶å„ç§å†…æ ¸ç¼“å­˜ï¼ˆç´¢å¼•èŠ‚ç‚¹ã€ç›®å½•é¡¹ã€é¡µé¢ç¼“å­˜ç­‰ï¼‰å¢é•¿çš„æ‰‹æ®µã€‚å½“ç³»ç»Ÿä¸Šçš„å…¶ä»–åœ°æ–¹éœ€è¦å†…å­˜æ—¶ï¼Œè¿™äº›å¯¹è±¡ä¼šç”±å†…æ ¸è‡ªåŠ¨å›æ”¶ã€‚</p><p>ä½¿ç”¨æ­¤æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚ ç”±äºå®ƒä¼šä¸¢å¼ƒç¼“å­˜çš„å¯¹è±¡ï¼Œå› æ­¤å¯èƒ½ä¼šèŠ±è´¹å¤§é‡ I/O å’Œ CPU æ¥é‡æ–°åˆ›å»ºåˆ é™¤çš„å¯¹è±¡ï¼Œå°¤å…¶æ˜¯åœ¨å¤§é‡ä½¿ç”¨å®ƒä»¬çš„æƒ…å†µä¸‹ã€‚ å› æ­¤ï¼Œä¸å»ºè®®åœ¨æµ‹è¯•æˆ–è°ƒè¯•ç¯å¢ƒä¹‹å¤–ä½¿ç”¨ã€‚</p><p>To disable them, echo 4 (bit 2) into drop_caches.</p></li><li>extfrag_thresholdï¼šè¯¥å‚æ•°å½±å“å†…æ ¸æ˜¯å¦å‹ç¼©å†…å­˜æˆ–ç›´æ¥å›æ”¶ä»¥æ»¡è¶³é«˜é˜¶åˆ†é…ï¼Œè¯¥å€¼è®¾ç½®å¾—è¶Šå°ï¼Œè¶Šå€¾å‘äºè¿›è¡Œå†…å­˜æ•´ç†ï¼Œé»˜è®¤å€¼ 500</li><li>highmem_is_dirtyableï¼šè¯¥å‚æ•°æ§åˆ¶æ˜¯å¦è€ƒè™‘å¯¹é«˜ç«¯å†…å­˜è¿›è¡Œ dirty å†™å…¥é™åˆ¶ã€‚é»˜è®¤ä¸º 0ï¼Œå³åœ¨è®¡ç®— dirty_ratio å’Œ dirty_background_ratio çš„æ—¶å€™åªè€ƒè™‘ low memã€‚å½“æ‰“å¼€ä¹‹åæ‰ä¼šå°† highmem ä¹Ÿè®¡ç®—åœ¨å†…</li><li>hugetlb_shm_groupï¼šåŒ…å«å…è®¸ä½¿ç”¨ hugetlb é¡µè¡¨åˆ›å»º SysV å…±äº«å†…å­˜æ®µçš„ç»„ ID</li><li>laptop_modeï¼šç¬”è®°æœ¬ç”µè„‘æ¨¡å¼</li><li>legacy_va_layoutï¼š</li><li><p>lowmem_reserve_ratioï¼šlowmem_reserve_ratio æ˜¯é˜²æ­¢ highmem å†…å­˜åœ¨ä¸å……è£•æƒ…å†µä¸‹ï¼Œè¿‡åº¦å€Ÿç”¨ä½ç«¯å†…å­˜ã€‚lowmem_reserve_ratio å†³å®šäº†æ¯ä¸ª zone ä¿ç•™å¤šå°‘æ•°ç›®çš„é¡µé¢ã€‚lowmem_reserve_ratio ä¸­å®šä¹‰äº†ä¸åŒ zone çš„é¢„ç•™æ¯”ä¾‹ï¼Œå€¼è¶Šå¤§ä¿ç•™æ¯”ä¾‹è¶Šå°ã€‚å¦‚ï¼ŒDMA ä¸º 1/256ï¼ŒNORMAL ä¸º 1/32ã€‚</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm <span class="comment"># cat /proc/sys/vm/lowmem_reserve_ratio</span></span><br><span class="line">256     32      0</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>ç¬¬ä¸€ä¸ªæ˜¯ normal zone çš„ä¿æŠ¤ç‡ï¼Œä¼šä¿æŠ¤è¯¥ zone çš„ 1/256 çš„å†…å­˜</li><li>ç¬¬äºŒä¸ªæ˜¯ dma zone æˆ– dma32 zone çš„ä¿æŠ¤ç‡ï¼Œ 1/32</li><li>ç¬¬ä¸‰ä¸ªæ˜¯å…¶ä»– 0</li></ul></li><li>max_map_count: åŒ…å«é™åˆ¶ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰çš„ VMA çš„æ•°é‡ï¼Œé»˜è®¤ 65530</li><li>memory_failure_early_kill: æ§åˆ¶å½“å‘ç”Ÿå†…æ ¸æ— æ³•å¤„ç†çš„å†…å­˜é”™è¯¯æ—¶ï¼Œè¯¥å¦‚ä½•ç»ˆæ­¢è¿›ç¨‹<ul><li>1ï¼šä¸€æ—¦æ£€æµ‹åˆ°æŸåï¼Œæ€æ­»æ‰€æœ‰æŸåçš„è¿›ç¨‹å’Œä¸å¯é‡æ–°åŠ è½½é¡µé¢çš„æ‰€å±è¿›ç¨‹ã€‚è¯·æ³¨æ„ï¼ŒæŸäº›ç±»å‹çš„é¡µé¢ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œä¾‹å¦‚å†…æ ¸å†…éƒ¨åˆ†é…çš„æ•°æ®æˆ–äº¤æ¢ç¼“å­˜ï¼Œä½†é€‚ç”¨äºå¤§å¤šæ•°ç”¨æˆ·é¡µé¢</li><li>0ï¼šä»æ‰€æœ‰è¿›ç¨‹ä¸­å–æ¶ˆæŸåé¡µçš„æ˜ å°„ï¼Œåªæ€æ­»ä¸€ä¸ªè¯•å›¾è®¿é—®å®ƒçš„è¿›ç¨‹</li></ul></li><li>memory_failure_recoveryï¼šå¯ç”¨å†…å­˜æ•…éšœæ¢å¤<ul><li>1: Attempt recovery</li><li>0: Always panic on a memory failure</li></ul></li><li><p>min_free_kbytesï¼šæœ€å°‘ä¿ç•™çš„å­—èŠ‚æ•°ï¼Œç”¨äºè®¡ç®— zone çš„ä½æ°´ä½å€¼</p><p>è¿™ç”¨äºå¼ºåˆ¶ Linux VM ä¿æŒæœ€å°‘çš„å¯ç”¨å­—èŠ‚æ•°ã€‚ VM ä½¿ç”¨æ­¤æ•°å­—æ¥è®¡ç®—ç³»ç»Ÿä¸­æ¯ä¸ª lowmem åŒºåŸŸçš„ watermark [WMARK_MIN] å€¼ã€‚æ¯ä¸ª lowmem åŒºåŸŸæ ¹æ®å…¶å¤§å°æŒ‰æ¯”ä¾‹è·å–ä¸€äº›ä¿ç•™çš„ç©ºé—²é¡µé¢</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm <span class="comment"># cat min_free_kbytes</span></span><br><span class="line">3987</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœæ‚¨å°†å…¶è®¾ç½®ä¸ºä½äº 1024KBï¼Œåœ¨é«˜è´Ÿè½½ä¸‹å®¹æ˜“å‡ºç°æ­»é”ã€‚è®¾ç½®å¾—å¤ªé«˜ä¼šå¯¼è‡´æœºå™¨å®¹æ˜“ OOMã€‚</p></li><li><p>min_slab_ratioï¼šThis is available only on NUMA kernels.</p><p>æ¯ä¸ªåŒºåŸŸä¸­æ€»é¡µæ•°çš„ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¶…è¿‡è¯¥ç™¾åˆ†æ¯”çš„ page éƒ½æ˜¯å¯å›æ”¶çš„ï¼Œåˆ™å›æ”¶è¯¥ zoneï¼Œé»˜è®¤å€¼ 5</p></li><li><p>min_unmapped_ratioï¼šThis is available only on NUMA kernels.</p><p>ä»…å½“è¶…è¿‡æ­¤ç™¾åˆ†æ¯”çš„é¡µé¢å¤„äº zone_reclaim_mode å…è®¸å›æ”¶çš„çŠ¶æ€æ—¶ï¼Œæ‰ä¼šå‘ç”ŸåŒºåŸŸå›æ”¶ã€‚é»˜è®¤å€¼ 1</p></li><li>mmap_min_addrï¼šæ§åˆ¶ç€ç”¨æˆ·è¿›ç¨‹ mmap èƒ½å¤Ÿæ˜ å°„çš„æœ€ä½å†…å­˜åœ°å€</li><li><p>mmap_rnd_bitsï¼š</p><p>è¯¥å€¼å¯ç”¨äºé€‰æ‹©ç”¨äºç¡®å®š vma åŒºåŸŸåŸºåœ°å€çš„éšæœºåç§»é‡çš„ä½æ•°ï¼Œè¿™äº›åç§»é‡æ˜¯ç”±æ”¯æŒè°ƒæ•´åœ°å€ç©ºé—´éšæœºåŒ–çš„æ¶æ„ä¸Šçš„ mmap åˆ†é…äº§ç”Ÿçš„ã€‚ è¯¥å€¼å°†å—åˆ°æ¶æ„æ”¯æŒçš„æœ€å°å’Œæœ€å¤§å€¼çš„é™åˆ¶ã€‚</p></li><li><p>mmap_rnd_compat_bits<strong>ï¼š</strong></p><p>è¯¥å€¼å¯ç”¨äºé€‰æ‹©ä½æ•°ï¼Œç”¨äºç¡®å®š vma åŒºåŸŸåŸºåœ°å€çš„éšæœºåç§»é‡ï¼Œè¿™äº›åç§»é‡æ˜¯åœ¨æ”¯æŒè°ƒæ•´åœ°å€ç©ºé—´éšæœºåŒ–çš„ä½“ç³»ç»“æ„ä¸Šä»¥å…¼å®¹æ¨¡å¼è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„ mmap åˆ†é…äº§ç”Ÿçš„ã€‚è¯¥å€¼å°†å—åˆ°æ¶æ„æ”¯æŒçš„æœ€å°å’Œæœ€å¤§å€¼çš„é™åˆ¶</p></li><li>nr_hugepages<strong>ï¼š</strong>Change the minimum size of the hugepage pool.</li><li>nr_overcommit_hugepages&nbsp;<strong>ï¼š</strong>å¯ä»¥è¿‡é‡ä½¿ç”¨çš„å¤§é¡µï¼Œæœ€å¤§å€¼=nr_hugepages + nr_overcommit_hugepages</li><li>nr_trim_pagesï¼šä»…é€‚ç”¨äº NOMMU å†…æ ¸</li><li>numa_zonelist_orderï¼šå·²åºŸå¼ƒ</li><li>oom_dump_tasksï¼šå…è®¸åœ¨å†…æ ¸æ‰§è¡Œ OOM ç»ˆæ­¢æ—¶ç”Ÿæˆç³»ç»ŸèŒƒå›´çš„ Task è½¬å‚¨ï¼ˆä¸åŒ…æ‹¬å†…æ ¸çº¿ç¨‹ï¼‰ï¼Œå¹¶åŒ…æ‹¬ pidã€uidã€tgidã€vm å¤§å°ã€rssã€pgtables_bytesã€swapentsã€oom_score_adj åˆ†æ•°å’Œåç§°ç­‰ä¿¡æ¯</li><li>oom_kill_allocating_taskï¼š<ul><li>é 0ï¼š&nbsp;OOM åªä¼šç»ˆæ­¢è§¦å‘å†…å­˜ä¸è¶³çš„ä»»åŠ¡ã€‚è¿™é¿å…äº†æ˜‚è´µçš„ä»»åŠ¡åˆ—è¡¨æ‰«æ</li><li>0ï¼šOOM å°†æ‰«ææ•´ä¸ªä»»åŠ¡åˆ—è¡¨å¹¶æ ¹æ® heuristics kill taskã€‚è¿™é€šå¸¸ä¼šé€‰æ‹©ä¸€ä¸ªæµæ°“å†…å­˜å ç”¨ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡åœ¨è¢«æ€æ­»æ—¶ä¼šé‡Šæ”¾å¤§é‡å†…å­˜</li></ul></li><li><p>overcommit_kbytesï¼šovercommit_kbytes æ˜¯ overcommit_ratio çš„å¯¹åº”é¡¹ï¼Œä¸€æ¬¡åªèƒ½æŒ‡å®šå…¶ä¸­ä¹‹ä¸€ï¼Œè¿™é‡Œæ˜¯é…ç½®å…è®¸ç”³è¯·å¤šå°‘ K è¶…å‡ºçš„å†…å­˜</p><p>å½“ overcommit_memory è®¾ç½®ä¸º 2 æ—¶ï¼Œæäº¤çš„åœ°å€ç©ºé—´ä¸å…è®¸è¶…è¿‡ swap åŠ ä¸Šæ­¤ç‰©ç† RAM é‡</p></li><li>overcommit_memoryï¼šæ˜¯å¦å…è®¸ç”³è¯·è¿‡åº¦å¯ç”¨å†…å­˜çš„å†…å­˜<ul><li>å½“æ­¤æ ‡å¿—ä¸º 0 æ—¶ï¼Œå†…æ ¸ä¼šå°†ç”¨æˆ·ç©ºé—´å†…å­˜è¯·æ±‚å¤§å°ä¸æ€»å†…å­˜åŠ ä¸Šäº¤æ¢åˆ†åŒºå¤§å°è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶æ‹’ç»æ˜æ˜¾çš„è¿‡åº¦ä½¿ç”¨</li><li>å½“æ­¤æ ‡å¿—ä¸º 1 æ—¶ï¼Œå†…æ ¸å‡è£…å§‹ç»ˆæœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œç›´åˆ°å®é™…è€—å°½ä¸ºæ­¢</li><li>å½“æ­¤æ ‡å¿—ä¸º 2 æ—¶ï¼Œå†…æ ¸ä½¿ç”¨â€œnever overcommitâ€ç­–ç•¥æ¥å°è¯•é˜²æ­¢ä»»ä½•å†…å­˜è¿‡åº¦ä½¿ç”¨ï¼Œè¯·æ³¨æ„ï¼Œuser_reserve_kbytes ä¼šå½±å“æ­¤ç­–ç•¥ã€‚</li></ul></li><li>overcommit_ratioï¼šå½“ overcommit_memory è®¾ç½®ä¸º 2 æ—¶ï¼Œæäº¤çš„åœ°å€ç©ºé—´ä¸å…è®¸è¶…è¿‡ swap åŠ ä¸Šç‰©ç† RAM çš„æ­¤ç™¾åˆ†æ¯”</li><li>page-clusterï¼šä» swap å•æ¬¡è¯»å…¥çš„è¿ç»­é¡µï¼ˆä¸ page cache readahead äº’æ–¥ï¼‰</li><li>panic_on_oomï¼šç”¨æˆ–ç¦ç”¨å†…å­˜ä¸è¶³åŠŸèƒ½çš„ panic<ul><li>0ï¼Œå†…æ ¸å°†æ€æ­»ä¸€äº›æ¶æ„è¿›ç¨‹ï¼Œç§°ä¸º oom_killerã€‚é€šå¸¸ï¼Œoom_killer å¯ä»¥æ€æ­»æ¶æ„è¿›ç¨‹ï¼Œç³»ç»Ÿå°†ç»§ç»­å­˜åœ¨</li><li>1ï¼Œåˆ™å½“å‘ç”Ÿå†…å­˜ä¸è¶³æ—¶å†…æ ¸ä¼šå‘ç”Ÿ Panicã€‚ç„¶è€Œï¼Œå¦‚æœæŸä¸ªè¿›ç¨‹é€šè¿‡ mempolicy/cpusets é™åˆ¶ä½¿ç”¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¿™äº›èŠ‚ç‚¹å˜æˆå†…å­˜è€—å°½çŠ¶æ€ï¼Œåˆ™è¯¥è¿›ç¨‹å¯èƒ½ä¼šè¢« oom-killer æ€æ­»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿææ…Œã€‚å› ä¸ºå…¶ä»–èŠ‚ç‚¹çš„å†…å­˜å¯èƒ½æ˜¯ç©ºé—²çš„ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿæ€»ä½“çŠ¶æ€å¯èƒ½è¿˜ä¸æ˜¯è‡´å‘½çš„</li><li>2ï¼Œå³ä½¿å‡ºç°ä¸Šè¿°æƒ…å†µï¼Œå†…æ ¸ä¹Ÿä¼šå¼ºåˆ¶å‘ç”Ÿ Panic</li></ul></li><li>percpu_pagelist_fractionï¼šè¿™æ˜¯æ¯ä¸ªåŒºåŸŸä¸­å¯ä»¥å­˜å‚¨åˆ°æ¯ä¸ª cpu é¡µé¢åˆ—è¡¨ä¸­çš„é¡µé¢æ¯”ä¾‹ã€‚å®ƒæ˜¯æ ¹æ®åœ¨çº¿ CPU æ•°é‡åˆ’åˆ†çš„ä¸Šé™ã€‚æœ€å°å€¼ä¸º 8ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸å…è®¸æ¯ä¸ªåŒºåŸŸä¸­è¶…è¿‡ 1/8 çš„é¡µé¢å­˜å‚¨åœ¨æ¯ä¸ª cpu é¡µé¢åˆ—è¡¨ä¸­</li><li>stat_intervalï¼šå¤šå°‘ s æ›´æ–°ä¸€æ¬¡ vm ä¿¡æ¯ï¼Œé»˜è®¤æ˜¯ 1</li><li>stat_refreshï¼šä»»ä½•è¯»å†™è¯¥æ–‡ä»¶ï¼Œéƒ½ä¼šå¯¼è‡´ vm ä¿¡æ¯ç«‹åˆ»æ›´æ–°</li><li>numa_statï¼šå…è®¸è¿è¡Œæ—¶é…ç½® numa ç»Ÿè®¡ä¿¡æ¯</li><li>swappinessï¼šio å’Œæ–‡ä»¶ cache çš„æƒé‡ï¼ŒèŒƒå›´åœ¨ 0-200ï¼Œå½“=100 æ—¶è¡¨ç¤ºç­‰é¢ï¼Œå€¼è¶Šå°è¡¨ç¤º IO ä»£ä»·è¶Šæ˜‚è´µï¼Œå†…æ ¸æ›´å€¾å‘äºæ–‡ä»¶ cacheï¼Œé»˜è®¤å€¼ 60</li><li>unprivileged_userfaultfd&nbsp;ï¼šæ§åˆ¶ç”¨æˆ·æ˜¯å¦å¯ä»¥ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ã€‚å°†å…¶è®¾ç½®ä¸º 1 ä»¥å…è®¸éç‰¹æƒç”¨æˆ·ä¸å—ä»»ä½•é™åˆ¶åœ°ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ã€‚å°†å…¶è®¾ç½®ä¸º 0 ä»¥é™åˆ¶éç‰¹æƒç”¨æˆ·ä»…åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹å¤„ç†é¡µé¢é”™è¯¯</li><li>user_reserve_kbytesï¼šovercommit_memory = 2 çš„æ—¶ï¼Œç”¨æˆ·è¿›ç¨‹é¢„ç•™å¤šå°‘ç©ºé—²å†…å­˜ã€‚é»˜è®¤ 3%ã€‚å¦‚æœå°†å…¶å‡å°‘åˆ°é›¶ï¼Œåˆ™ç”¨æˆ·å°†è¢«å…è®¸ä½¿ç”¨å•ä¸ªè¿›ç¨‹åˆ†é…æ‰€æœ‰å¯ç”¨å†…å­˜ï¼Œå‡å» admin_reserve_kbytesã€‚ä»»ä½•åç»­å°è¯•æ‰§è¡Œå‘½ä»¤éƒ½å°†å¯¼è‡´â€œfork: Cannot allocate memoryâ€</li><li>vfs_cache_pressureï¼šæ§åˆ¶å†…æ ¸å›æ”¶ cache å’Œ inode çš„è¶‹åŠ¿ï¼Œé»˜è®¤æ˜¯ 100ï¼Œå†…æ ¸ä»¥å…¬å¹³çš„é€Ÿç‡å›æ”¶ cache å’Œ inodeï¼›=0ï¼Œå³å†…æ ¸ä»ä¸å›æ”¶ cache å’Œ inodeï¼›&gt;100ï¼Œå†…æ ¸æ›´å€¾å‘å›æ”¶ cache å’Œ inode</li><li>watermark_boost_factorï¼šæ§åˆ¶å†…å­˜ç¢ç‰‡æ—¶çš„å›æ”¶çº§åˆ«ï¼Œåˆ†æ¯æ˜¯ 10000ï¼Œé»˜è®¤å€¼æ˜¯ 15000ï¼Œå³å›æ”¶ 150%çš„é«˜æ°´ä½çº¿çš„é¡µ</li><li>watermark_scale_factorï¼šswap çº¿ç¨‹è¢«å”¤é†’åè¦é‡Šæ”¾å¤šå°‘å†…å­˜ï¼Œåˆ†æ¯æ˜¯ 10000ï¼Œæœ€å°å€¼æ˜¯ 10ï¼Œæœ€å¤§å€¼æ˜¯ 3000ã€‚å³æ¯æ¬¡è¢«å”¤é†’éƒ½ä¼šé‡Šæ”¾ç³»ç»Ÿå¯ç”¨å†…å­˜çš„ 0.1%-30%</li><li>zone_reclaim_modeï¼šzone çš„ä¼šå›æ”¶æ¨¡å¼ï¼Œé»˜è®¤å…³é—­<ul><li>0ï¼šä¸åœ¨ zone å›æ”¶ï¼Œä»å…¶ä»– zone å›æ”¶å†…å­˜</li><li>1ï¼šæ‰“å¼€ zone å›æ”¶</li><li>2ï¼šå°†è„é¡µæ¢å‡º</li><li>4ï¼šå›æ”¶äº¤æ¢é¡µ</li></ul></li></ul><h1 id="ç”¨æˆ·è¿›ç¨‹å› ä¸ºå›å†™æ•°æ®å¯¼è‡´è¿è¡Œå¡é¡¿">ç”¨æˆ·è¿›ç¨‹å› ä¸ºå›å†™æ•°æ®å¯¼è‡´è¿è¡Œå¡é¡¿</h1><p>æˆ‘ä»¬çŸ¥é“åˆ· dirty æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ linux å†…æ ¸çº¿ç¨‹å¼‚æ­¥åˆ· dirty æ•°æ®ï¼Œå¦ä¸€ç§æ˜¯ç”±å†™æ•°æ®çš„çº¿ç¨‹è‡ªå·±åˆ·ï¼ˆç”¨æˆ·çº¿ç¨‹è‡ªå·±åˆ· dirty æ•°æ®çš„æ—¶å€™å°±å¹²ä¸äº†å…¶ä»–äº‹æƒ…å¯¼è‡´çº¿ç¨‹å¡é¡¿ï¼‰ã€‚å¯¹äº video æˆ–è€… audio åº”ç”¨éƒ½ä¼šæ¯”è¾ƒå¸¸é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œç®€å•èµ·è§ï¼Œä»¥ä¸€ä¸ª audio ä¾‹å­æ¥è¯´æ˜ï¼š</p><p>å¯¹äº 48kã€8channelã€32bit çš„é‡‡æ ·å‚æ•°æ¥è¯´æ˜ï¼Œåˆ™æ¯ç§’é‡‡æ ·çš„æ•°æ®é‡ä¸º 48000<em>8</em>4=1536000/1024/1024=1.46M</p><p>ç”±äºæ•°æ®é‡æ˜¯å¯ä»¥ç²¾ç¡®è®¡ç®—çš„ï¼Œè¿™é‡Œä¸»è¦è°ƒèŠ‚ dirty_background_bytesã€dirty_bytes å’Œ dirty_expire_centisecs è¿™ä¸‰ä¸ªå‚æ•°ã€‚</p><p>è°ƒå‚æ•°åŸåˆ™å¦‚ä¸‹ï¼š</p><ul><li>å°½å¯èƒ½çš„è§¦å‘ dirty_background_bytes é˜ˆå€¼è€Œä¸è§¦å‘ dirty_bytes</li><li>å°½å¯èƒ½çš„åˆ©ç”¨ç©ºé—²å†…å­˜åšç¼“å­˜ï¼Œé¿å…é¢‘ç¹åˆ· dirty æ•°æ®</li></ul><p>åœ¨ä»¥ä¸Šä¸¤ä¸ªåŸåˆ™ä¸‹æˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹è°ƒæ•´ï¼š</p><p>æŸ¥çœ‹å½“å‰ dirty ç›¸å…³å‚æ•°</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># sysctl -a | grep "dirty"</span></span><br><span class="line">kernel.osrelease = 5.4.242-09263-g35630c03e7d6-dirty</span><br><span class="line">vm.dirty_background_bytes = 0</span><br><span class="line">vm.dirty_background_ratio = 10</span><br><span class="line">vm.dirty_bytes = 0</span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br><span class="line">vm.dirty_ratio = 20</span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br><span class="line">vm.dirtytime_expire_seconds = 43200</span><br></pre></td></tr></tbody></table></figure><ul><li>dirty_expire_centisecs é»˜è®¤å€¼ä¸º 3000ï¼Œæ˜¯æŒ‰ç…§ç™¾åˆ†ä¹‹ä¸€ç§’æ¥è¡¨ç¤ºçš„ï¼Œä¹Ÿå°±æ˜¯ 30sï¼Œä»£è¡¨ 30s ä¼šæ£€æŸ¥ä¸€æ¬¡çœ‹ dirty æ•°æ®æ˜¯å¦è¶…è¿‡ç›¸å…³é˜ˆå€¼ï¼Œå¦‚æœè¶…è¿‡åˆ™æ‰§è¡Œåˆ· dirty æ•°æ®æ“ä½œï¼Œè¿™ä¸ªå€¼ä¸è¦è®¾ç½®å¤ªå°ï¼Œå¯ä»¥å…ˆä¿æŒä¸å˜</li><li>dirty_background_bytesï¼šä»£è¡¨ dirty æ•°æ®è¶…è¿‡è¿™ä¸ªå€¼å°±ä¼šå”¤é†’å†…æ ¸çº¿ç¨‹å›å†™ dirty pageï¼Œ30s å†…ä¼šç”Ÿæˆ 1536000*30=46080000 å­—èŠ‚æ•°æ®ï¼Œé‚£ä¹ˆä¿é™©èµ·è§ dirty_background_bytes å¯ä»¥å°äº 46080000 1-2M</li><li>dirty_bytesï¼šä»£è¡¨ dirty æ•°æ®è¶…è¿‡è¿™ä¸ªå€¼ï¼Œç”¨æˆ·çº¿ç¨‹å°†åœä¸‹æ­£åœ¨å¹²çš„äº‹æƒ…å»å›å†™ dirty pageï¼Œè¿™æ ·å°±å¯¼è‡´ç”¨æˆ·çº¿ç¨‹å¡é¡¿ï¼Œé‚£ä¹ˆè§£å†³åŠæ³•å°±æ˜¯ä¸è¦è®©ç”¨æˆ·çº¿ç¨‹ä¸»åŠ¨å›å†™ dirty æ•°æ®ï¼Œè¯¥å€¼åº”è¯¥è®¾ç½®ä¸ºå¤§äº 46080000ï¼Œè¿™æ ·æ°¸è¿œå…ˆè§¦å‘å†…æ ¸çº¿ç¨‹åˆ· dirty æ•°æ®ï¼Œç”¨æˆ·çº¿ç¨‹å°±ä¸éœ€è¦ä¸»åŠ¨å›å†™ dirty æ•°æ®äº†</li><li>å½“ç„¶å¦‚æœå†…å­˜ç´§å¼ ï¼Œè¿™ä¸ªæ—¶å€™è¦è€ƒè™‘é™ä½ dirty_expire_centisecs äº†ï¼Œæé«˜å†…æ ¸å›å†™çº¿ç¨‹è¿è¡Œé¢‘ç‡</li></ul><h1 id="ä¸ºä»€ä¹ˆ-drop_caches-å-cache-å€¼å¹¶æœªå‡å°‘">ä¸ºä»€ä¹ˆ drop_caches å cache å€¼å¹¶æœªå‡å°‘</h1><p>å› ä¸ºè¿™ç§æ–¹å¼åªèƒ½æ¸…ç©º page cache ä¸­"clean"çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å·²ç»å’Œå¤–éƒ¨ç£ç›˜åŒæ­¥è¿‡çš„éƒ¨åˆ†ã€‚è€Œé’ˆå¯¹åŒ¿åé¡µï¼Œå†…å­˜æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„æ–‡ä»¶ï¼Œå¦‚æœæƒ³è¦å›æ”¶è¿™éƒ¨åˆ†å†…å­˜å°±éœ€è¦æ·»åŠ  swap åˆ†åŒºï¼Œå¦‚æœç³»ç»Ÿä¸­æœ‰å¤§é‡çš„ä½¿ç”¨åŒ¿åé¡µçš„æƒ…å†µæƒ³è¦å›æ”¶æ›´å¤šçš„å†…å­˜åº”è¯¥æ·»åŠ  swap åˆ†åŒºã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux Documentã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆå…«ï¼‰Alsa Plugin</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAPlugin/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAPlugin/</url>
      
        <content type="html"><![CDATA[<h1 id="pcm-digital-audio-plugins">PCM (digital audio) plugins</h1><p>PCM plugins extends functionality and features of PCM devices. The plugins take care about various sample conversions, sample copying among channels and so on.</p><span id="more"></span><h1 id="plugin-hw">Plugin: hw</h1><p>This plugin communicates directly with the ALSA kernel driver. It is a raw communication without any conversions. The emulation of mmap access can be optionally enabled, but expect worse latency in the case.</p><p>The nonblock option specifies whether the device is opened in a non-blocking manner. Note that the blocking behavior for read/write access won't be changed by this option. This influences only on the blocking behavior at opening the device. If you would like to keep the compatibility with the older ALSA stuff, turn this option off.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">    <span class="built_in">type</span> hw         <span class="comment"># Kernel PCM</span></span><br><span class="line">    card INT/STR        <span class="comment"># Card name (string) or number (integer)</span></span><br><span class="line">    [device INT]        <span class="comment"># Device number (default 0)</span></span><br><span class="line">    [subdevice INT]     <span class="comment"># Subdevice number (default -1: first available)</span></span><br><span class="line">    [sync_ptr_ioctl BOOL]   <span class="comment"># Use SYNC_PTR ioctl rather than the direct mmap access for control structures</span></span><br><span class="line">    [nonblock BOOL]     <span class="comment"># Force non-blocking open mode</span></span><br><span class="line">    [format STR]        <span class="comment"># Restrict only to the given format</span></span><br><span class="line">    [channels INT]      <span class="comment"># Restrict only to the given channels</span></span><br><span class="line">    [rate INT]      <span class="comment"># Restrict only to the given rate</span></span><br><span class="line">    [chmap MAP]     <span class="comment"># Override channel maps; MAP is a string array</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Example:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pcm.!default{</span><br><span class="line">    <span class="built_in">type</span> hw</span><br><span class="line">    card 0</span><br><span class="line">    device 1</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ctl.!default{</span><br><span class="line">    <span class="built_in">type</span> hw</span><br><span class="line">    card 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">pcm.microphone {</span><br><span class="line">    <span class="built_in">type</span> hw</span><br><span class="line">    card 0</span><br><span class="line">    device 2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">pcm.avs_input {</span><br><span class="line">    <span class="built_in">type</span> hw</span><br><span class="line">    card 0</span><br><span class="line">    device 4</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç»™ hw:0,1 è®¾å¤‡é‡å‘½åä¸º default</p><p>Testï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aplay -D default test.wav</span><br></pre></td></tr></tbody></table></figure><h1 id="slave-definition">Slave definition</h1><p>The slave plugin can be specified directly with a string or the definition can be entered inside a compound configuration node. Some restrictions can be also specified (like static rate or count of channels).</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pcm_slave.NAME {</span><br><span class="line">    pcm STR     <span class="comment"># PCM name</span></span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    pcm { }     <span class="comment"># PCM definition</span></span><br><span class="line">    format STR  <span class="comment"># Format or "unchanged"</span></span><br><span class="line">    channels INT    <span class="comment"># Count of channels or "unchanged" string</span></span><br><span class="line">    rate INT    <span class="comment"># Rate in Hz or "unchanged" string</span></span><br><span class="line">    period_time INT <span class="comment"># Period time in us or "unchanged" string</span></span><br><span class="line">    buffer_time INT <span class="comment"># Buffer time in us or "unchanged" string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Example:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pcm_slave.slave_rate44100Hz {</span><br><span class="line">    pcm <span class="string">"hw:0,0"</span></span><br><span class="line">    rate 44100</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">pcm.rate44100Hz {</span><br><span class="line">    <span class="built_in">type</span> plug</span><br><span class="line">    slave slave_rate44100Hz</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>The equivalent configuration (in one compound):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pcm.rate44100Hz {</span><br><span class="line">    <span class="built_in">type</span> plug</span><br><span class="line">    slave {</span><br><span class="line">        pcm <span class="string">"hw:0,0"</span></span><br><span class="line">        rate 44100</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>å°† hw:0,0 å£°å¡çš„é‡‡æ ·é¢‘ç‡è½¬æ¢ä¸º 44100hzã€‚</strong></p><p>Testï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aplay -D rate44100Hz test.wav</span><br></pre></td></tr></tbody></table></figure><h1 id="plugin-rate">Plugin: Rate</h1><p>This plugin converts a stream rate. The input and output formats must be linear.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">    <span class="built_in">type</span> rate               <span class="comment"># Rate PCM</span></span><br><span class="line">        slave STR               <span class="comment"># Slave name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        slave {                 <span class="comment"># Slave definition</span></span><br><span class="line">                pcm STR         <span class="comment"># Slave PCM name</span></span><br><span class="line">                <span class="comment"># or</span></span><br><span class="line">                pcm { }         <span class="comment"># Slave PCM definition</span></span><br><span class="line">                rate INT        <span class="comment"># Slave rate</span></span><br><span class="line">                [format STR]    <span class="comment"># Slave format</span></span><br><span class="line">        }</span><br><span class="line">    converter STR           <span class="comment"># optional</span></span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    converter [ STR1 STR2 ... ] <span class="comment"># optional</span></span><br><span class="line">                <span class="comment"># Converter type, default is taken from</span></span><br><span class="line">                <span class="comment"># defaults.pcm.rate_converter</span></span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    converter {     <span class="comment"># optional</span></span><br><span class="line">        name STR    <span class="comment"># Convertor type</span></span><br><span class="line">        xxx yyy     <span class="comment"># optional convertor-specific configuration</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="plugin-route-volume">Plugin: Route &amp; Volume</h1><p>This plugin converts channels and applies volume during the conversion. The format and rate must match for both of them.</p><p>SCHANNEL can be a channel name instead of a number (e g FL, LFE). If so, a matching channel map will be selected for the slave.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">        <span class="built_in">type</span> route              <span class="comment"># Route &amp; Volume conversion PCM</span></span><br><span class="line">        slave STR               <span class="comment"># Slave name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        slave {                 <span class="comment"># Slave definition</span></span><br><span class="line">                pcm STR         <span class="comment"># Slave PCM name</span></span><br><span class="line">                <span class="comment"># or</span></span><br><span class="line">                pcm { }         <span class="comment"># Slave PCM definition</span></span><br><span class="line">                [format STR]    <span class="comment"># Slave format</span></span><br><span class="line">                [channels INT]  <span class="comment"># Slave channels</span></span><br><span class="line">        }</span><br><span class="line">        ttable {                <span class="comment"># Transfer table (bi-dimensional compound of cchannels * schannels numbers)</span></span><br><span class="line">                CCHANNEL {</span><br><span class="line">                        SCHANNEL REAL   <span class="comment"># route value (0.0 - 1.0)</span></span><br><span class="line">                }</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="automatic-conversion-plugin">Automatic conversion plugin</h1><p>This plugin converts channels, rate and format on request.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">        <span class="built_in">type</span> plug               <span class="comment"># Automatic conversion PCM</span></span><br><span class="line">        slave STR               <span class="comment"># Slave name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        slave {                 <span class="comment"># Slave definition</span></span><br><span class="line">                pcm STR         <span class="comment"># Slave PCM name</span></span><br><span class="line">                <span class="comment"># or</span></span><br><span class="line">                pcm { }         <span class="comment"># Slave PCM definition</span></span><br><span class="line">        [format STR]    <span class="comment"># Slave format (default nearest) or "unchanged"</span></span><br><span class="line">        [channels INT]  <span class="comment"># Slave channels (default nearest) or "unchanged"</span></span><br><span class="line">        [rate INT]  <span class="comment"># Slave rate (default nearest) or "unchanged"</span></span><br><span class="line">        }</span><br><span class="line">    route_policy STR    <span class="comment"># route policy for automatic ttable generation</span></span><br><span class="line">                <span class="comment"># STR can be 'default', 'average', 'copy', 'duplicate'</span></span><br><span class="line">                <span class="comment"># average: result is average of input channels</span></span><br><span class="line">                <span class="comment"># copy: only first channels are copied to destination</span></span><br><span class="line">                <span class="comment"># duplicate: duplicate first set of channels</span></span><br><span class="line">                <span class="comment"># default: copy policy, except for mono capture - sum</span></span><br><span class="line">    ttable {        <span class="comment"># Transfer table (bi-dimensional compound of cchannels * schannels numbers)</span></span><br><span class="line">        CCHANNEL {</span><br><span class="line">            SCHANNEL REAL   <span class="comment"># route value (0.0 - 1.0)</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    rate_converter STR  <span class="comment"># type of rate converter</span></span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    rate_converter [ STR1 STR2 ... ]</span><br><span class="line">                <span class="comment"># type of rate converter</span></span><br><span class="line">                <span class="comment"># default value is taken from defaults.pcm.rate_converter</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Exampleï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcm.nfbtout {</span><br><span class="line">        <span class="built_in">type</span> plug</span><br><span class="line">        slave {</span><br><span class="line">                pcm <span class="string">"hw:1,0"</span></span><br><span class="line">                rate 8000</span><br><span class="line">                channels 2</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="plugin-multiple-streams-to-one">Plugin: Multiple streams to One</h1><p>This plugin converts multiple streams to one.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">        <span class="built_in">type</span> multi              <span class="comment"># Multiple streams conversion PCM</span></span><br><span class="line">        slaves {        <span class="comment"># Slaves definition</span></span><br><span class="line">        ID STR      <span class="comment"># Slave PCM name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        ID {</span><br><span class="line">            pcm STR     <span class="comment"># Slave PCM name</span></span><br><span class="line">            <span class="comment"># or</span></span><br><span class="line">            pcm { }     <span class="comment"># Slave PCM definition</span></span><br><span class="line">            channels INT    <span class="comment"># Slave channels</span></span><br><span class="line">        }</span><br><span class="line">    bindings {      <span class="comment"># Bindings table</span></span><br><span class="line">        N {</span><br><span class="line">            slave STR   <span class="comment"># Slave key</span></span><br><span class="line">            channel INT <span class="comment"># Slave channel</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    [master INT]        <span class="comment"># Define the master slave</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>For example, to bind two PCM streams with two-channel stereo (hw:0,0 and hw:0,1) as one 4-channel stereo PCM stream, define like this:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pcm.quad {</span><br><span class="line">    <span class="built_in">type</span> multi</span><br><span class="line"> </span><br><span class="line">    slaves.a.pcm <span class="string">"hw:0,0"</span></span><br><span class="line">    slaves.a.channels 2</span><br><span class="line">    slaves.b.pcm <span class="string">"hw:0,1"</span></span><br><span class="line">    slaves.b.channels 2</span><br><span class="line"> </span><br><span class="line">    bindings.0.slave a</span><br><span class="line">    bindings.0.channel 0</span><br><span class="line">    bindings.1.slave a</span><br><span class="line">    bindings.1.channel 1</span><br><span class="line">    bindings.2.slave b</span><br><span class="line">    bindings.2.channel 0</span><br><span class="line">    bindings.3.slave b</span><br><span class="line">    bindings.3.channel 1</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Note that the resultant pcm "quad" is not in the interleaved format but in the "complex" format. Hence, it's not accessible by applications which can handle only the interleaved (or the non-interleaved) format. In such a case, wrap this PCM with&nbsp;route&nbsp;or&nbsp;plug&nbsp;plugin.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pcm.quad2 {</span><br><span class="line">    <span class="built_in">type</span> route</span><br><span class="line">    slave.pcm <span class="string">"quad"</span></span><br><span class="line">    ttable.0.0 1</span><br><span class="line">    ttable.1.1 1</span><br><span class="line">    ttable.2.2 1</span><br><span class="line">    ttable.3.3 1</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="plugin-dmix">Plugin: dmix</h1><p>This plugin provides direct mixing of multiple streams. The resolution for 32-bit mixing is only 24-bit. The low significant byte is filled with zeros. The extra 8 bits are used for the saturation.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">    <span class="built_in">type</span> dmix       <span class="comment"># Direct mix</span></span><br><span class="line">    ipc_key INT     <span class="comment"># unique IPC key</span></span><br><span class="line">    ipc_key_add_uid BOOL    <span class="comment"># add current uid to unique IPC key</span></span><br><span class="line">    ipc_perm INT        <span class="comment"># IPC permissions (octal, default 0600)</span></span><br><span class="line">    hw_ptr_alignment STR    <span class="comment"># Slave application and hw pointer alignment type</span></span><br><span class="line">                <span class="comment"># STR can be one of the below strings :</span></span><br><span class="line">                <span class="comment"># no</span></span><br><span class="line">                <span class="comment"># roundup</span></span><br><span class="line">                <span class="comment"># rounddown</span></span><br><span class="line">                <span class="comment"># auto (default)</span></span><br><span class="line">    slave STR</span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    slave {         <span class="comment"># Slave definition</span></span><br><span class="line">        pcm STR     <span class="comment"># slave PCM name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        pcm { }     <span class="comment"># slave PCM definition</span></span><br><span class="line">        format STR  <span class="comment"># format definition</span></span><br><span class="line">        rate INT    <span class="comment"># rate definition</span></span><br><span class="line">        channels INT</span><br><span class="line">        period_time INT <span class="comment"># in usec</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        period_size INT <span class="comment"># in bytes</span></span><br><span class="line">        buffer_time INT <span class="comment"># in usec</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        buffer_size INT <span class="comment"># in bytes</span></span><br><span class="line">        periods INT <span class="comment"># when buffer_size or buffer_time is not specified</span></span><br><span class="line">    }</span><br><span class="line">    bindings {      <span class="comment"># note: this is client independent!!!</span></span><br><span class="line">        N INT       <span class="comment"># maps slave channel to client channel N</span></span><br><span class="line">    }</span><br><span class="line">    slowptr BOOL        <span class="comment"># slow but more precise pointer updates</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ipc_key å¿…é¡»æ˜¯æ•´æ•°å½¢å¼çš„å”¯ä¸€ ipc keyã€‚å¯¹äºæ¯ä¸ªä¸åŒçš„ dmix å®šä¹‰ï¼Œè¿™ä¸ªæ•°å­—å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå› ä¸ºå…±äº«å†…å­˜æ˜¯ç”¨è¿™ä¸ª key åˆ›å»ºçš„ã€‚å½“ ipc_key_add_uid è®¾ç½®ä¸º true æ—¶ï¼Œuid å€¼å°†æ·»åŠ åˆ° ipc_key è®¾ç½®ä¸­ã€‚è¿™æ ·å¯ä»¥é¿å…åŒä¸€ä¸ª IPC å¯†é’¥ä¸ä¸åŒç”¨æˆ·åŒæ—¶å‘ç”Ÿå†²çªã€‚</p><p>hw_ptr_alignment è¿™ä¸ªé…ç½®é»˜è®¤æ˜¯ auto</p><p>An example configuration for setting 44100 Hz,&nbsp;<code>S32_LE</code>&nbsp;format as the slave PCM of "hw:0" is like below:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pcm.dmix_44 {</span><br><span class="line">    <span class="built_in">type</span> dmix</span><br><span class="line">    ipc_key 321456  <span class="comment"># any unique value</span></span><br><span class="line">    ipc_key_add_uid <span class="literal">true</span></span><br><span class="line">    slave {</span><br><span class="line">        pcm <span class="string">"hw:0"</span></span><br><span class="line">        format S32_LE</span><br><span class="line">        rate 44100</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Testï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aplay -Dplug:dmix_44 foo_48k.wav</span><br></pre></td></tr></tbody></table></figure><h1 id="plugin-dsnoop">Plugin: dsnoop</h1><p>æ­¤æ’ä»¶å°†ä¸€ä¸ª capture æµæ‹†åˆ†ä¸ºå¤šä¸ªã€‚å®ƒçš„å·¥ä½œæ–¹å¼ä¸ dmix æ’ä»¶ç›¸åï¼Œä»å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯»å–å…±äº«æ•è·ç¼“å†²åŒºã€‚ä»¥ä¸‹å‚æ•°çš„å«ä¹‰ä¸ dmix æ’ä»¶å‡ ä¹ç›¸åŒã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pcm.name {</span><br><span class="line">    <span class="built_in">type</span> dsnoop     <span class="comment"># Direct snoop</span></span><br><span class="line">    ipc_key INT     <span class="comment"># unique IPC key</span></span><br><span class="line">    ipc_key_add_uid BOOL    <span class="comment"># add current uid to unique IPC key</span></span><br><span class="line">    ipc_perm INT        <span class="comment"># IPC permissions (octal, default 0600)</span></span><br><span class="line">    slave STR</span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    slave {         <span class="comment"># Slave definition</span></span><br><span class="line">        pcm STR     <span class="comment"># slave PCM name</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        pcm { }     <span class="comment"># slave PCM definition</span></span><br><span class="line">        format STR  <span class="comment"># format definition</span></span><br><span class="line">        rate INT    <span class="comment"># rate definition</span></span><br><span class="line">        channels INT</span><br><span class="line">        period_time INT <span class="comment"># in usec</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        period_size INT <span class="comment"># in bytes</span></span><br><span class="line">        buffer_time INT <span class="comment"># in usec</span></span><br><span class="line">        <span class="comment"># or</span></span><br><span class="line">        buffer_size INT <span class="comment"># in bytes</span></span><br><span class="line">        periods INT <span class="comment"># when buffer_size or buffer_time is not specified</span></span><br><span class="line">    }</span><br><span class="line">    bindings {      <span class="comment"># note: this is client independent!!!</span></span><br><span class="line">        N INT       <span class="comment"># maps slave channel to client channel N</span></span><br><span class="line">    }</span><br><span class="line">    slowptr BOOL        <span class="comment"># slow but more precise pointer updates</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="open-æµç¨‹">Open æµç¨‹</h1><p>ä¸‹é¢ä»¥ dsnoop æ’ä»¶ä¸ºä¾‹æ¢³ç†ä¸‹ alsa-lib ä½¿ç”¨æ’ä»¶çš„æµç¨‹ï¼Œè¯¦ç»†å¦‚ä¸‹ï¼š</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkYjA5N2E1YTQ4YmMwMjc2ODg4MzNk">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/snd_pcm_dsnoop_open.png"></p><ul><li>è§£æé…ç½®æ–‡ä»¶å¹¶ç”Ÿæˆé…ç½®æ ‘</li><li>æ‰“å¼€å®é™…è®¾å¤‡ï¼Œé€šè¿‡ mmap æ˜ å°„é©±åŠ¨ä¸­çš„æ§åˆ¶ä¿¡æ¯å’Œ buffer</li></ul><h1 id="read-æµç¨‹">Read æµç¨‹</h1><p>ä»¥ä¸‹æ˜¯ read æµç¨‹ï¼Œwrite æµç¨‹ä¸å†åˆ—å‡ºæ¥äº†ã€‚</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkYjA5YWM5YTM0M2QzZTg5OWQ5MTgy">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/snd_pcm_readi.png"></p><ul><li>memcopy é©±åŠ¨ DMA buffer ä¸­çš„æ•°æ®</li><li>hw_ptr æ•°æ®æŒ‡é’ˆçš„ sync</li></ul><p>å¯ä»¥çœ‹åˆ° alsa plug æ”¯æŒå¤šè¿›ç¨‹ï¼Œå¯ä»¥å¤šä¸ªè¿›ç¨‹æ‰“å¼€åŒä¸€ä¸ª slave å£°å¡ï¼Œå¤šè¿›ç¨‹é—´é€šè¿‡ä¿¡å·é‡åŒæ­¥ã€‚ å¦‚æœè¦è‡ªå·±åˆ›å»ºä¸€ä¸ªå£°å¡ï¼ŒåŒæ—¶è®©åˆ›å»ºçš„å£°å¡æ”¯æŒ pluginï¼Œé‚£ä¹ˆæœ€å¥½ä¸è¦ä½¿ç”¨ appl_ptr å’Œä¾èµ– appl_ptr çš„ apiã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxzYS1wcm9qZWN0Lm9yZy9hbHNhLWRvYy9hbHNhLWxpYi9wY21fcGx1Z2lucy5odG1s">https://www.alsa-project.org/alsa-doc/alsa-lib/pcm_plugins.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9hbHNhLm9wZW5zcmMub3JnL0FMU0FfcGx1Z2lucw==">https://alsa.opensrc.org/ALSA_plugins<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆå…­ï¼‰å£°å¡åˆ›å»ºæµç¨‹</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSACreateSoundCard/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSACreateSoundCard/</url>
      
        <content type="html"><![CDATA[<h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YzA2ZjYwZTNlNzQwNmUyMDNmMzkz">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/ALSA_Struct1.png"></p><span id="more"></span><ul><li>snd_card: æ˜¯æœ€é¡¶å±‚æ•°æ®ç»“æ„ï¼Œé€šè¿‡é“¾è¡¨æŒ‚è½½è¯¥ sound card çš„æ‰€æœ‰è®¾å¤‡ snd_deviceã€‚</li><li>snd_pcm: æŒ‚åœ¨ snd_card ä¸‹é¢çš„ä¸€ä¸ª snd_deviceã€‚</li><li>snd_pcm_str: ä»£è¡¨ playback stream å’Œ capture streamã€‚</li><li>snd_pcm_substream: æ˜¯ pcm ä¸­é—´å±‚çš„æ ¸å¿ƒï¼Œç»å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯åœ¨ substream ä¸­å¤„ç†ï¼Œå°¤å…¶æ˜¯ä»–çš„ opsï¼ˆsnd_pcm_opsï¼‰å­—æ®µï¼Œè®¸å¤š user ç©ºé—´çš„åº”ç”¨ç¨‹åºé€šè¿‡ alsa-lib å¯¹é©±åŠ¨ç¨‹åºçš„è¯·æ±‚éƒ½æ˜¯ç”±è¯¥ç»“æ„ä¸­çš„å‡½æ•°å¤„ç†ã€‚å®ƒçš„ runtime å­—æ®µåˆ™æŒ‡å‘ snd_pcm_runtime ç»“æ„ï¼Œsnd_pcm_runtime è®°å½•è¿™ substream çš„ä¸€äº›é‡è¦çš„è½¯ä»¶å’Œç¡¬ä»¶è¿è¡Œç¯å¢ƒå’Œå‚æ•°ã€‚</li><li>snd_pcm_ops: åˆ›å»ºå£°å¡éœ€è¦æä¾›çš„å›è°ƒã€‚</li><li>snd_pcm_runtime: è¿è¡Œæ—¶å‚æ•°ï¼ŒåŒ…æ‹¬ sample rateã€channelã€format ç­‰å‚æ•°ï¼Œä»¥åŠ buffer ç›¸å…³ä¿¡æ¯ã€‚</li><li>snd_pcm_harward: ç¡¬ä»¶ç›¸å…³å‚æ•°ï¼Œåˆ›å»ºå£°å¡éœ€è¦æä¾›ç›¸å…³å‚æ•°ã€‚</li></ul><h1 id="hw-buffer">HW Buffer</h1><p>å½“ app åœ¨è°ƒç”¨ snd_pcm_writei æ—¶ï¼Œalsa core å°† app ä¼ æ¥çš„æ•°æ®æ¬åˆ° HW bufferï¼ˆå³ DMA bufferï¼‰ä¸­ï¼Œalsa driver ä» HW buffer ä¸­è¯»å–æ•°æ®ä¼ è¾“åˆ°ç¡¬ä»¶æ’­æ”¾ã€‚</p><p>ALSA buffer æ˜¯é‡‡ç”¨ ring buffer æ¥å®ç°çš„ã€‚ring buffer æœ‰å¤šä¸ª HW buffer ç»„æˆã€‚HW buffer ä¸€èˆ¬æ˜¯åœ¨ alsa driver çš„ hw_params å‡½æ•°ä¸­åˆ†é…çš„ä¸€å—å¤§å°ä¸º buffer size çš„ DMA buffer. ä¹‹æ‰€ä»¥é‡‡ç”¨å¤šä¸ª HW buffer æ¥ç»„æˆ ring buffer, æ˜¯é˜²æ­¢è¯»å†™æŒ‡é’ˆçš„å‰åä½ç½®é¢‘ç¹çš„äº’æ¢ï¼ˆå³å†™æŒ‡é’ˆåˆ°è¾¾ HW buffer è¾¹ç•Œæ—¶ï¼Œå°±è¦å›åˆ° HW buffer èµ·å§‹ç‚¹ï¼‰ã€‚</p><p>ring buffer = n * HW buffer. é€šå¸¸è¿™ä¸ª n æ¯”è¾ƒå¤§ï¼Œåœ¨æ•°æ®è¯»å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘ä¼šå‡ºç°è¯»å†™æŒ‡é’ˆäº’æ¢çš„æƒ…å†µã€‚ä¸‹å›¾æ˜¯ ALSA buffer çš„å®ç°ä»¥åŠè¯»å†™æŒ‡é’ˆæ›´æ–°çš„æ–¹æ³•ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/hw_buffer.png"></p><ul><li>hw_ptr_base: æ˜¯å½“å‰ HW buffer åœ¨ Ring buffer ä¸­çš„èµ·å§‹ä½ç½®ã€‚å½“è¯»æŒ‡é’ˆåˆ°è¾¾ HW buffer å°¾éƒ¨æ—¶ï¼Œhw_ptr_base æŒ‰ buffer size ç§»åŠ¨ã€‚</li><li>hw_ptr: å³ HW buffer çš„è¯»æŒ‡é’ˆã€‚alsa driver å°†æ•°æ®ä» HW buffer ä¸­è¯»èµ°å¹¶é€åˆ°å£°å¡ç¡¬ä»¶æ—¶ï¼Œhw_ptr å°±ä¼šç§»åŠ¨åˆ°æ–°ä½ç½®ã€‚</li><li>appl_ptr: å³ HW buffer çš„å†™æŒ‡é’ˆã€‚app åœ¨è°ƒç”¨ snd_pcm_write å†™æ•°æ®ï¼Œalsa core å°†æ•°æ® copy åˆ° HW buffer åï¼Œappl_ptr å°±æ›´æ–°ã€‚</li><li>boundary: å³ Ring buffer è¾¹ç•Œã€‚</li><li>hw_ofs: æ˜¯è¯»æŒ‡é’ˆåœ¨å½“å‰ HW buffer ä¸­çš„ä½ç½®ã€‚ç”± alsa driver çš„ pointer() è¿”å›ã€‚</li><li>appl_ofs: æ˜¯å†™æŒ‡é’ˆåœ¨å½“å‰ HW buffer ä¸­çš„ä½ç½®ã€‚</li></ul><p>hw_ptr çš„æ›´æ–°æ˜¯é€šè¿‡è°ƒç”¨ snd_pcm_update_hw_ptr() å®Œæˆã€‚æ­¤å‡½æ•°åœ¨ app å†™æ•°æ®æ—¶ä¼šè°ƒç”¨ï¼Œä¹Ÿä¼šåœ¨ç¡¬ä»¶ä¸­æ–­æ—¶é€šè¿‡ snd_pcm_peroid_elapsed è°ƒç”¨</p><h1 id="æµç¨‹">æµç¨‹</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YmMwYzUxZTA4NTMwNmQ3NDJlYzkz">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/snd_card_register1.png"></p><ul><li>åˆ†é…å¹¶è®¾ç½® snd_card æ•°æ®ç»“æ„</li><li>åˆ›å»º snd_pcm instance</li><li>è®¾ç½® snd_pcm_ops ç»“æ„ä½“æˆå‘˜</li><li>åˆ†é… DMA å†…å­˜</li><li>æ³¨å†Œå£°å¡</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆä¸ƒï¼‰XRUN</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAXRUN/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAXRUN/</url>
      
        <content type="html"><![CDATA[<p>XRUN æ˜¯ç¼“å†²åŒºä¸è¶³æˆ–æº¢å‡ºï¼ŒX ä»£è¡¨ä¸è¶³æˆ–æº¢å‡ºã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œéƒ½è¡¨æ˜ç³»ç»Ÿé€Ÿåº¦ä¸å¤Ÿå¿«ï¼Œæœªèƒ½åŠæ—¶å¤„ç†æ¥è‡ª ALSA éŸ³é¢‘ç¼“å†²åŒºçš„æ•°æ®ï¼Œå› æ­¤ä¸¢å¤±äº†ä¸€äº›æ•°æ®ã€‚å½“æˆ‘ä»¬ä»¥éå¸¸å°çš„ç¼“å†²åŒºå¤§å°è¿è¡Œæ—¶ï¼Œå£°å¡åº”è¯¥éå¸¸å¿«åœ°å¤„ç†ä¼ å…¥ç¼“å†²åŒºçš„æ•°æ®ï¼Œå¦åˆ™å°±æº¢å‡º overrun äº†ã€‚æœ‰äº›èŠ¯ç‰‡æ— æ³•é€‚åº”è¾ƒå°çš„ç¼“å†²åŒºå¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å¢åŠ ç¼“å†²åŒºé•¿åº¦ä»¥å‡è½»å£°éŸ³èŠ¯ç‰‡çš„å·¥ä½œé‡ã€‚é€šå¸¸ï¼Œxruns å¯ä»¥å¬åˆ°çˆ†è£‚å£°æˆ–çˆ†è£‚å£°ã€‚</p><span id="more"></span><blockquote><p>åœ¨å½•éŸ³ä¾‹å­ä¸­ï¼Œå¦‚æœåº”ç”¨ç¨‹åºè¯»å–æ•°æ®ä¸å¤Ÿå¿«ï¼Œå¾ªç¯ç¼“å­˜åŒºå°†ä¼šè¢«æ–°çš„æ•°æ®è¦†ç›–ã€‚è¿™ç§æ•°æ®çš„ä¸¢å¤±è¢«ç§°ä¸º"over run" åœ¨å›æ”¾ä¾‹å­ä¸­ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå†™å…¥æ•°æ®åˆ°ç¼“å­˜åŒºä¸­çš„é€Ÿåº¦ä¸å¤Ÿå¿«ï¼Œç¼“å­˜åŒºå°†ä¼š"é¥¿æ­»"ã€‚è¿™æ ·çš„é”™è¯¯è¢«ç§°ä¸º"under run"</p></blockquote><h1 id="proc">/Proc</h1><p>ALSA æä¾›äº†ä¸€ç§é€šè¿‡ proc è®°å½•å’Œè°ƒè¯• xrun çš„æ–¹æ³•ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers  ---&gt;  &lt;*&gt; Sound card support  ---&gt;  &lt;*&gt;   Advanced Linux Sound Architecture  ---&gt; [*]   Sound Proc FS Support</span><br><span class="line"></span><br><span class="line">Device Drivers  ---&gt;  &lt;*&gt; Sound card support  ---&gt;  &lt;*&gt;   Advanced Linux Sound Architecture  ---&gt; [*]   Debug  ---&gt;  [*]     Enable PCM ring buffer overrun/underrun debugging</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/alsa_debug_config.png"></p><h1 id="procasoundcardpcm0pxrun_debug">/proc/asound/card#/pcm0p/xrun_debug</h1><p>å°†â€œ#â€æ›¿æ¢ä¸º card numberã€‚è¯¥ proc æ–‡ä»¶å¯ä»¥å¯ç”¨å„ç§è°ƒè¯•å·¥å…·ã€‚å¿…é¡»åœ¨å†…æ ¸ä¸­å¯ç”¨ CONFIG_SND_PCM_XRUN_DEBUGã€CONFIG_SND_VERBOSE_PROCFSã€CONFIG_SND_DEBUG é€‰é¡¹ï¼ˆå¦‚æœ xrun_debug proc æ–‡ä»¶å­˜åœ¨ - è¯¥åŠŸèƒ½å·²å¯ç”¨ï¼‰</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1   Basic debugging - show xruns <span class="keyword">in</span> ksyslog interface</span><br><span class="line">2   Dump stack - dump stack <span class="keyword">for</span> basic debugging</span><br><span class="line">4   Jiffies check - compare the position with kernel jiffies (a <span class="built_in">sort</span> of in-kernel monotonic clock),</span><br><span class="line">    show what<span class="string">'s changed when basic debugging is enabled</span></span><br><span class="line"><span class="string">8   Dump positions on each period update call</span></span><br><span class="line"><span class="string">16  Dump positions on each hardware pointer update call</span></span><br><span class="line"><span class="string">32  Enable logging of last 10 ring buffer positions</span></span><br><span class="line"><span class="string">64  Show the last 10 ring buffer position only once (when first error situation occured)</span></span><br></pre></td></tr></tbody></table></figure><p>To enable more features just do sum values of above (for example 1+2=3).</p><p>Some good value combinations:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable basic debugging and dump stack</span></span><br><span class="line"><span class="comment"># Usefull to just see, if PCM stream is stopped for a reason (usually wrong audio process timing from scheduler)</span></span><br><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable basic debugging and dump stack, check hardware pointer on the period update</span></span><br><span class="line"><span class="comment"># Usefull to just see, if PCM stream is stopped for a reason (usually wrong audio process timing from scheduler)</span></span><br><span class="line"><span class="comment"># And to check the values from driver</span></span><br><span class="line"><span class="built_in">echo</span> 11 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable basic debugging and dump stack, check hardware pointer on all updates</span></span><br><span class="line"><span class="comment"># Usefull to just see, if PCM stream is stopped for a reason (usually wrong audio process timing from scheduler)</span></span><br><span class="line"><span class="comment"># And to do the exact check the values from driver</span></span><br><span class="line"><span class="built_in">echo</span> 27 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable basic debugging, do jiffies check and enable one shot dump of last 10 ring buffer positions</span></span><br><span class="line"><span class="comment"># Usefull, when the position is broken only after some of time (to reduce ksyslog messages)</span></span><br><span class="line"><span class="built_in">echo</span> 101 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable basic debugging, do jiffies check and dump position on each period and hardware pointer update calls</span></span><br><span class="line"><span class="comment"># Usefull when the lowlevel (specific) hardware driver is somehow broken</span></span><br><span class="line"><span class="built_in">echo</span> 29 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨è¿›å…¥ XRUN çŠ¶æ€æ—¶ä¼šåœæ­¢ DMA ä¼ è¾“ï¼Œç›´åˆ°æœ‰ available ç©ºé—´å¯å†™å…¥ï¼ˆoverrun æ—¶ï¼‰ï¼Œæˆ–è€…ç›´åˆ°æœ‰æ•°æ®å†™å…¥ï¼ˆunderrun æ—¶ï¼‰ã€‚ ä½†æ˜¯ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡é…ç½® silence_threshold æ¥ç»§ç»­æ’­æ”¾ç¼“å†²åŒºçš„é‡å¤çš„éŸ³é¢‘æ•°æ®æˆ–é™éŸ³æ•°æ®ï¼ˆsilence_size ä¸ºå¡«å……çš„å¤§å°ï¼‰ï¼Œå½“ç©ºä½™ç©ºé—´è¶…è¿‡ silence threshold æ—¶ï¼Œå°± hardware buffer å†™å…¥ silenceã€‚</p><h1 id="trace">Trace</h1><ol type="1"><li><p>åœ¨ menuconfig ä¸­å¼€å¯ä»¥ä¸‹é€‰é¡¹ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers  </span><br><span class="line">---&gt;  &lt;*&gt; Sound card support  </span><br><span class="line">---&gt;  &lt;*&gt;   Advanced Linux Sound Architecture  </span><br><span class="line">---&gt; [*]   Sound Proc FS Support</span><br><span class="line"></span><br><span class="line">Device Drivers  </span><br><span class="line">---&gt;  &lt;*&gt; Sound card support  </span><br><span class="line">---&gt;  &lt;*&gt;   Advanced Linux Sound Architecture  </span><br><span class="line">---&gt; [*]   Debug  </span><br><span class="line">---&gt;  [*]     Enable PCM ring buffer overrun/underrun debugging</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>åœ¨è®¾å¤‡ä¸­æŒ‚åœ¨ debugfs å’Œä½¿èƒ½ audio ç›¸å…³ trace</p></li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mount -t debugfs none /sys/kernel/debug/</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /sys/kernel/debug/tracing/events/snd_pcm/hwptr/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /sys/kernel/debug/tracing/events/snd_pcm/applptr/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/snd_pcm/xrun/enable</span><br></pre></td></tr></tbody></table></figure><ol start="3" type="1"><li>æ‰§è¡Œ arecordï¼Œå‡ºç° xrun åï¼š</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br></pre></td></tr></tbody></table></figure><ol start="4" type="1"><li>ä»¥ä¸‹æ˜¯æ‰§è¡Œ</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arecord -Dhw:2,0 -r 44100 -c 8 -f S32_LE  /data/record.wav</span><br></pre></td></tr></tbody></table></figure><p>å¤ç°åˆ°çš„ä¸€æ¬¡ xrun é—®é¢˜ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/xrun_trace.png"></p><p>è¿™é‡Œ hwptr çš„ old å°±æ˜¯ hwptr æŒ‡é’ˆï¼Œapplptr çš„ current å°±æ˜¯ applptr æŒ‡é’ˆä½ç½®ï¼Œå¯ä»¥çœ‹åˆ°å‘ç”Ÿ xrun å‰é¢ hwptr=2781184ï¼Œapplyptr=2779136ã€‚ç³»ç»Ÿä¸­ buffer_size = 2048ï¼ˆframesï¼‰, è€Œè¿™é‡Œ hwptr æŒ‡é’ˆé¢†å…ˆ applptr æŒ‡é’ˆ 2048 ä¸ª frameï¼Œè¯´æ˜ runtime é‡Œçš„ dma buffer å·²ç»æ»¡äº†ï¼ˆoverrunï¼‰ï¼Œåº”ç”¨æ²¡æœ‰åŠæ—¶å–èµ°æ•°æ®ã€‚ä¸‹ä¸€æ­¥å°±å¯ä»¥åˆ†æåº”ç”¨ä¸ºä»€ä¹ˆæ²¡æœ‰åŠæ—¶å–èµ°æ•°æ®äº†ã€‚</p><h1 id="å…³äº-hw-buffer">å…³äº HW Buffer</h1><p>å½“ app åœ¨è°ƒç”¨ snd_pcm_writei æ—¶ï¼Œalsa core å°† app ä¼ æ¥çš„æ•°æ®æ¬åˆ° HW bufferï¼ˆå³ DMA bufferï¼‰ä¸­ï¼Œalsa driver ä» HW buffer ä¸­è¯»å–æ•°æ®ä¼ è¾“åˆ°ç¡¬ä»¶æ’­æ”¾ã€‚</p><p>ALSA buffer æ˜¯é‡‡ç”¨ ring buffer æ¥å®ç°çš„ã€‚ring buffer æœ‰å¤šä¸ª HW buffer ç»„æˆã€‚</p><p>HW buffer ä¸€èˆ¬æ˜¯åœ¨ alsa driver çš„ hw_params å‡½æ•°ä¸­åˆ†é…çš„ä¸€å—å¤§å°ä¸º buffer size ä¸ª frames çš„ DMA buffer.</p><p>ä¹‹æ‰€ä»¥é‡‡ç”¨å¤šä¸ª HW buffer æ¥ç»„æˆ ring buffer, æ˜¯é˜²æ­¢è¯»å†™æŒ‡é’ˆçš„å‰åä½ç½®é¢‘ç¹çš„äº’æ¢ï¼ˆå³å†™æŒ‡é’ˆåˆ°è¾¾ HW buffer è¾¹ç•Œæ—¶ï¼Œå°±è¦å›åˆ° HW buffer èµ·å§‹ç‚¹ï¼‰ã€‚</p><p>ring buffer = n * HW buffer. é€šå¸¸è¿™ä¸ª n æ¯”è¾ƒå¤§ï¼Œåœ¨æ•°æ®è¯»å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘ä¼šå‡ºç°è¯»å†™æŒ‡é’ˆäº’æ¢çš„æƒ…å†µã€‚</p><p>ä¸‹å›¾æ˜¯ ALSA buffer çš„å®ç°ä»¥åŠè¯»å†™æŒ‡é’ˆæ›´æ–°çš„æ–¹æ³•ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/hw_buffer.png"></p><ul><li>hw_ptr_base æ˜¯å½“å‰ HW buffer åœ¨ Ring buffer ä¸­çš„èµ·å§‹ä½ç½®ã€‚å½“è¯»æŒ‡é’ˆåˆ°è¾¾ HW buffer å°¾éƒ¨æ—¶ï¼Œhw_ptr_base æŒ‰ buffer size ç§»åŠ¨</li><li>hw_ptr å³ HW buffer çš„ driver æ“ä½œæŒ‡é’ˆ</li><li>appl_ptr å³ HW buffer çš„åº”ç”¨æ“ä½œæŒ‡é’ˆ</li><li>boundary å³ Ring buffer è¾¹ç•Œã€‚</li><li>hw_ofs æ˜¯ driver æŒ‡é’ˆåœ¨å½“å‰ HW buffer ä¸­çš„ä½ç½®ã€‚ç”± alsa driver çš„ pointer() è¿”å›</li><li>appl_ofs æ˜¯åº”ç”¨æ“ä½œæŒ‡é’ˆåœ¨å½“å‰ HW buffer ä¸­çš„ä½ç½®</li><li>hw_ptr çš„æ›´æ–°æ˜¯é€šè¿‡è°ƒç”¨ snd_pcm_update_hw_ptr0 å®Œæˆã€‚æ­¤å‡½æ•°åœ¨ app å†™æ•°æ®æ—¶ä¼šè°ƒç”¨ï¼Œä¹Ÿä¼šåœ¨ç¡¬ä»¶ä¸­æ–­æ—¶é€šè¿‡ snd_pcm_peroid_elapsed è°ƒç”¨</li></ul><h1 id="å®éªŒ">å®éªŒ</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arecord -Dhw:2,0 -c 8 -r 44100 -f S32_LE /dev/null</span><br><span class="line">arecord -Dhw:2,0 -r 44100 -c 8 -f S32_LE | aplay -Dhw:2,0 -c 8 -r 44100 -f S32_LE</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½ä¸ä¼šå‡ºç° overrunï¼Œè¿™ç§ä¸€èˆ¬éƒ½æ˜¯ IO æ€§èƒ½é—®é¢˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/vm.png"></p><p>cat meminfo èŠ‚ç‚¹ï¼Œå‘ç°ç³»ç»Ÿä¼šåœ¨ç¼“å­˜ 41M å·¦å³çš„æ—¶å€™è¿›è¡Œåˆ· dirty pageã€‚</p><p>å¯¹äº 44100 é‡‡æ ·ç‡ã€8channelã€32bit ä½æ·±ï¼Œæ¯ç§’é’Ÿäº§ç”Ÿçš„æ•°æ®é‡ä¸º 44100<em>8</em>4Byte = 1411200Byte = 1.345MByte</p><p>å¯ä»¥é€šè¿‡ä¿®æ”¹åˆ· dirty page çš„é¢‘ç‡æ¥é™ä½å‡ºç° overrun çš„æ¦‚ç‡ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 7056000 &gt; /proc/sys/vm/dirty_background_bytes</span><br><span class="line"><span class="built_in">echo</span> 70560000 &gt; /proc/sys/vm/dirty_bytes</span><br><span class="line"><span class="built_in">echo</span> 2000 &gt; /proc/sys/vm/dirty_expire_centisecs</span><br><span class="line"><span class="built_in">echo</span> 500 &gt; /proc/sys/vm/dirty_writeback_centisecs</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹æˆè¿™æ ·å¤§æ¦‚ 5s å·¦å³åˆ·ä¸€æ¬¡æ•°æ®ï¼Œè¿™æ · overrun æ¦‚ç‡å¤§å¤§é™ä½ã€‚</p><h1 id="å¸¸è§åŸå› ">å¸¸è§åŸå› </h1><ul><li>Linux CFSï¼ˆå®Œå…¨å…¬å¹³çš„è°ƒåº¦ç¨‹åºï¼‰</li><li>å…·æœ‰ SCHED_FIFO è°ƒåº¦çš„é«˜ä¼˜å…ˆçº§çº¿ç¨‹</li><li>ä¼˜å…ˆçº§å€’ç½®</li><li>é•¿æ—¶é—´è°ƒåº¦å»¶è¿Ÿ</li><li>é•¿æ—¶é—´è¿è¡Œçš„ä¸­æ–­å¤„ç†ç¨‹åº</li><li>é•¿æ—¶é—´ä¸­æ–­ç¦ç”¨</li><li>ç”µæºç®¡ç†</li><li>å®‰å…¨å†…æ ¸</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9jb3JlL2F1ZGlvL2xhdGVuY3kvY29udHJpYj9obD16aC1jbg==">https://source.android.com/docs/core/audio/latency/contrib?hl=zh-cn<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxzYS1wcm9qZWN0Lm9yZy93aWtpL1hSVU5fRGVidWc=">https://www.alsa-project.org/wiki/XRUN_Debug<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆäº”ï¼‰Machine é©±åŠ¨</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAMachineDriver/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAMachineDriver/</url>
      
        <content type="html"><![CDATA[<p>ASoC æ¶æ„çš„è®¾è®¡æ–¹å¼æ˜¯å¹³å°å’Œç¼–è§£ç å™¨ç±»é©±åŠ¨ç¨‹åºå¿…é¡»ç»‘å®šåœ¨ä¸€èµ·æ‰èƒ½æ„å»ºéŸ³é¢‘è®¾å¤‡ã€‚è¿™ç§ç»‘å®šå¯ä»¥åœ¨æ‰€è°“çš„æœºå™¨é©±åŠ¨ç¨‹åºæˆ–è®¾å¤‡æ ‘ä¸­å®Œæˆï¼Œæ¯ä¸€ä¸ªæœºå™¨é©±åŠ¨ç¨‹åºå’Œè®¾å¤‡æ ‘éƒ½æ˜¯ä¸ç‰¹å®šæœºå™¨ç›¸å…³çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœºå™¨é©±åŠ¨ç¨‹åºé’ˆå¯¹ç‰¹å®šç³»ç»Ÿï¼Œå¹¶ä¸”ä¸åŒçš„æ¿å¡éœ€è¦ä¸åŒçš„æœºå™¨é©±åŠ¨ç¨‹åºã€‚</p><span id="more"></span><h1 id="machine-é©±åŠ¨ç¨‹åºå¼€å‘æµç¨‹">Machine é©±åŠ¨ç¨‹åºå¼€å‘æµç¨‹</h1><p>ä¸€èˆ¬æ¥è¯´ï¼Œæœºå™¨é©±åŠ¨ç¨‹åºçš„èŒè´£åŒ…æ‹¬ä»¥ä¸‹å†…å®¹</p><ul><li>ä½¿ç”¨é€‚å½“çš„ CPU å’Œç¼–è§£ç å™¨ DAI å¡«å…… struct snd_soc_dai_link ç»“æ„ä½“</li><li>ç‰©ç†ç¼–è§£ç å™¨æ—¶é’Ÿè®¾ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰å’Œç¼–è§£ç å™¨åˆå§‹åŒ–ä¸»/ä»é…ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</li><li>å®šä¹‰ DAPM widget ä»¥è·¯ç”±ç‰©ç†ç¼–è§£ç å™¨å†…éƒ¨å¹¶æ ¹æ®éœ€è¦å®Œæˆ DAPM è·¯å¾„</li><li>æ ¹æ®éœ€è¦å°†è¿è¡Œæ—¶é‡‡æ ·é¢‘ç‡ä¼ æ’­åˆ°å„ä¸ªç¼–è§£ç å™¨é©±åŠ¨ç¨‹åº</li></ul><p>é‰´äºæ­¤ï¼Œæœºå™¨ç±»é©±åŠ¨ç¨‹åºçš„å¼€å‘å¯æ‰§è¡Œä»¥ä¸‹æµç¨‹ã€‚</p><ul><li>ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºæ³¨å†Œç»„ä»¶é©±åŠ¨ç¨‹åºã€DAI é©±åŠ¨ç¨‹åºä»¥åŠå®ƒä»¬çš„æ“ä½œå‡½æ•°</li><li>å¹³å°é©±åŠ¨ç¨‹åºæ³¨å†Œç»„ä»¶é©±åŠ¨ç¨‹åºã€PCM é©±åŠ¨ç¨‹åºã€CPU DAI é©±åŠ¨ç¨‹åºå’Œå®ƒä»¬çš„æ“ä½œå‡½æ•°ï¼Œå¹¶æ ¹æ®éœ€è¦è®¾ç½®å›æ”¾å’Œé‡‡é›†æ“ä½œ</li><li>æœºå™¨å±‚åœ¨ç¼–è§£ç å™¨å’Œ CPU ä¹‹é—´åˆ›å»º DAI é“¾æ¥å¹¶æ³¨å†Œå£°å¡å’Œ PCM è®¾å¤‡</li></ul><p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†æœºå™¨ç±»é©±åŠ¨ç¨‹åºçš„å¼€å‘æµç¨‹ï¼Œæ¥ä¸‹æ¥ä»æ­¥éª¤ (1) å¼€å§‹å±•å¼€å™è¿°ï¼Œè¿™åŒ…æ‹¬å¡«å…… DAI é“¾æ¥ã€‚</p><h2 id="dai-é“¾æ¥">DAI é“¾æ¥</h2><p>DAI é“¾æ¥æ˜¯ CPU å’Œç¼–è§£ç å™¨ DAI ä¹‹é—´é“¾æ¥çš„é€»è¾‘è¡¨ç¤ºã€‚å®ƒåœ¨ Kemmel ä¸­ä½¿ç”¨ struct snd_soc_dai_link è¡¨ç¤ºï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> {</span></span><br><span class="line"><span class="comment">/* config - must be set by machine driver */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;<span class="comment">/* Codec name */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *stream_name;<span class="comment">/* Stream name */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * You MAY specify the link's CPU-side device, either by device name,</span></span><br><span class="line"><span class="comment"> * or by DT/OF node, but not both. If this information is omitted,</span></span><br><span class="line"><span class="comment"> * the CPU-side DAI is matched using .cpu_dai_name only, which hence</span></span><br><span class="line"><span class="comment"> * must be globally unique. These fields are currently typically used</span></span><br><span class="line"><span class="comment"> * only for codec to codec links, or systems using device tree.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * You MAY specify the DAI name of the CPU DAI. If this information is</span></span><br><span class="line"><span class="comment"> * omitted, the CPU-side DAI is matched using .cpu_name/.cpu_of_node</span></span><br><span class="line"><span class="comment"> * only, which only works well when that device exposes a single DAI.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">cpus</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_cpus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * You MUST specify the link's codec, either by device name, or by</span></span><br><span class="line"><span class="comment"> * DT/OF node, but not both.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* You MUST specify the DAI name within the codec */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">codecs</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_codecs;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * You MAY specify the link's platform/PCM/DMA driver, either by</span></span><br><span class="line"><span class="comment"> * device name, or by DT/OF node, but not both. Some forms of link</span></span><br><span class="line"><span class="comment"> * do not need a platform. In such case, platforms are not mandatory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link_component</span> *<span class="title">platforms</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_platforms;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> id;<span class="comment">/* optional ID for machine driver link identification */</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> *<span class="title">params</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_params;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dai_fmt;           <span class="comment">/* format to set on init */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_dpcm_trigger</span> <span class="title">trigger</span>[2];</span> <span class="comment">/* trigger type for DPCM */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* codec/machine specific init - e.g. add machine controls */</span></span><br><span class="line"><span class="type">int</span> (*init)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* optional hw_params re-writing for BE and FE sync */</span></span><br><span class="line"><span class="type">int</span> (*be_hw_params_fixup)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd,</span><br><span class="line"><span class="keyword">struct</span> snd_pcm_hw_params *params);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* machine stream operations */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_compr_ops</span> *<span class="title">compr_ops</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark this pcm with non atomic ops */</span></span><br><span class="line"><span class="type">bool</span> nonatomic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* For unidirectional dai links */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> playback_only:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> capture_only:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Keep DAI active over suspend */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ignore_suspend:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Symmetry requirements */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_samplebits:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not create a PCM for this DAI link (Backend link) */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> no_pcm:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This DAI link can route to other DAI links at runtime (Frontend)*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dynamic:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DPCM capture and Playback support */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dpcm_capture:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dpcm_playback:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DPCM used FE &amp; BE merged format */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dpcm_merged_format:<span class="number">1</span>;</span><br><span class="line"><span class="comment">/* DPCM used FE &amp; BE merged channel */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dpcm_merged_chan:<span class="number">1</span>;</span><br><span class="line"><span class="comment">/* DPCM used FE &amp; BE merged rate */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dpcm_merged_rate:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pmdown_time is ignored at stop */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ignore_pmdown_time:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not create a PCM for this DAI link (Backend link) */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ignore:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">/* DAI link list of the soc card */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span> <span class="comment">/* For topology */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ­¤é“¾æ¥æ˜¯åœ¨æœºå™¨é©±åŠ¨ç¨‹åºä¸­è®¾ç½®çš„ã€‚å®ƒåº”è¯¥æŒ‡å®š cpu daiã€codec dai å’Œä½¿ç”¨çš„å¹³å°ã€‚åœ¨è®¾ç½®å®Œæˆä¹‹åï¼ŒDAI é“¾æ¥å°†è¢«è¾“é€åˆ°è¡¨ç¤ºå£°å¡çš„ struct snd_soc_cardã€‚struct snd_soc_dai_link ç»“æ„ä½“ä¸­çš„å…ƒç´ è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>name: è¿™æ˜¯ä»»æ„é€‰æ‹©çš„ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•å†…</li><li>codec_dai_name: è¿™å¿…é¡»ä¸ç¼–è§£ç å™¨èŠ¯ç‰‡é©±åŠ¨ç¨‹åºä¸­çš„ snd_soc_dai_driver.name å­—æ®µç›¸åŒ¹é…ã€‚ç¼–è§£ç å™¨å¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª DAIã€‚å¼€å‘äººå‘˜å¯å‚è€ƒç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºæ¥è¯†åˆ« DAI åç§°</li><li>cpu_dai_name: è¯¥åç§°å¿…é¡»ä¸ CPU DAI é©±åŠ¨ç¨‹åºä¸­çš„ snd_soc_dai_driver.name å­—æ®µç›¸åŒ¹é…</li><li>stream_name: è¿™æ˜¯è¯¥é“¾æ¥çš„æµåç§°</li><li>init: è¿™æ˜¯ DAI é“¾æ¥åˆå§‹åŒ–å›è°ƒå‡½æ•°ã€‚å®ƒé€šå¸¸ç”¨äºæ·»åŠ ä¸ DAI é“¾æ¥ç›¸å…³çš„ widget æˆ–å…¶ä»–ç±»å‹çš„ä¸€æ¬¡æ€§è®¾ç½®</li><li>dai_fmt: è¿™åº”è¯¥ä½¿ç”¨æ”¯æŒçš„æ ¼å¼å’Œæ—¶é’Ÿé…ç½®è¿›è¡Œè®¾ç½®ï¼ŒåŒæ—¶å¯¹äº CPU å’Œ CODEC DAI é©±åŠ¨ç¨‹åºæ¥è¯´åº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚ç¨åå°†ä»‹ç»è¯¥å­—æ®µçš„å¯èƒ½ä½æ ‡å¿—</li><li>ops: è¯¥å­—æ®µå±äº struct snd_soc_ops ç±»å‹ã€‚å®ƒåº”è¯¥ä¸ DAI é“¾æ¥çš„æœºå™¨çº§ PCM æ“ä½œä¸€èµ·è®¾ç½®ï¼ŒåŒ…æ‹¬ startupã€hw_paramsã€prepareã€triggerã€hw_freeã€shutdown ç­‰ã€‚ç¨åå°†è¯¦ç»†ä»‹ç»è¯¥å­—æ®µ</li><li>codec_name: å¦‚æœå·²ç»è®¾ç½®ï¼Œåˆ™è¿™åº”è¯¥æ˜¯ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºçš„åç§°ï¼Œå¦‚ platform_driver.driver.name æˆ– i2c_driver.driver.name</li><li>codec_of_node: è¿™æ˜¯ä¸ç¼–è§£ç å™¨å…³è”çš„è®¾å¤‡æ ‘èŠ‚ç‚¹</li><li>cpu_name: å¦‚æœå·²ç»è®¾ç½®ï¼Œåˆ™è¿™åº”è¯¥æ˜¯ CPU DAI é©±åŠ¨ç¨‹åº CPU çš„åç§°</li><li>cpu_of_node: è¿™æ˜¯ä¸ CPU DAI å…³è”çš„è®¾å¤‡æ ‘èŠ‚</li><li>platform_namme æˆ– platform_of_node: è¿™æ˜¯å¯¹æä¾› DMA åŠŸèƒ½çš„å¹³å°èŠ‚ç‚¹çš„åç§°æˆ– DT èŠ‚ç‚¹å¼•ç”¨</li><li>playback_only å’Œ capture_only: ä»…åœ¨å•å‘é“¾æ¥çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œå¦‚ SPDIFã€‚å¦‚æœè¿™æ˜¯ä¸€ä¸ªä»…è¾“å‡ºé“¾æ¥ï¼ˆä»…å›æ”¾ï¼‰ï¼Œåˆ™ playback_only å’Œ capture_only å¿…é¡»åˆ†åˆ«è®¾ç½®ä¸º true å’Œ falseã€‚è€Œå¯¹äºä»…è¾“å…¥é“¾æ¥ï¼Œåˆ™åº”ä½¿ç”¨ç›¸åçš„å€¼ã€‚</li></ul><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ã€‚cpu_of_node å’Œã€‚platform_of_node æ˜¯ç›¸åŒçš„ï¼Œå› ä¸º CPU DAI é©±åŠ¨ç¨‹åºå’Œ DMA PCM é©±åŠ¨ç¨‹åºæ˜¯ç”±åŒä¸€è®¾å¤‡å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¿…é¡»é€šè¿‡åç§°æˆ– of_node æŒ‡å®šé“¾æ¥çš„ç¼–è§£ç å™¨ï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤è€…ã€‚ä½ å¿…é¡»å¯¹ CPU å’Œå¹³å°æ‰§è¡Œç›¸åŒæ“ä½œã€‚ä½†æ˜¯ï¼Œå¿…é¡»è‡³å°‘æŒ‡å®š CPU DAI åç§°æˆ– CPU è®¾å¤‡åç§°/èŠ‚ç‚¹ä¹‹ä¸€ã€‚</p><h2 id="è·å–-cpu-å’Œç¼–è§£ç å™¨èŠ‚ç‚¹">è·å– CPU å’Œç¼–è§£ç å™¨èŠ‚ç‚¹</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sound {</span><br><span class="line">        compatible = <span class="string">"fsl,imx6ul-evk-wm8960"</span>,</span><br><span class="line">                 <span class="string">"fsl,imx-audio-wm8960"</span>;</span><br><span class="line">        model = <span class="string">"wm8960-audio"</span>;</span><br><span class="line">        cpu-dai = &lt;&amp;sai2&gt;;</span><br><span class="line">        audio-codec = &lt;&amp;codec&gt;;</span><br><span class="line">        asrc-controller = &lt;&amp;asrc&gt;;</span><br><span class="line">        codec-master;</span><br><span class="line">        gpr = &lt;&amp;gpr <span class="number">4</span> <span class="number">0x100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line">        hp-det = &lt;<span class="number">3</span> <span class="number">0</span>&gt;;</span><br><span class="line">        <span class="comment">/*hp-det-gpios = &lt;&amp;gpio5 4 0&gt;;</span></span><br><span class="line"><span class="comment">        mic-det-gpios = &lt;&amp;gpio5 4 0&gt;;*/</span></span><br><span class="line">        audio-routing =</span><br><span class="line">            <span class="string">"Headphone Jack"</span>, <span class="string">"HP_L"</span>,</span><br><span class="line">            <span class="string">"Headphone Jack"</span>, <span class="string">"HP_R"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_LP"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_LN"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_RP"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_RN"</span>,</span><br><span class="line">            <span class="string">"LINPUT2"</span>, <span class="string">"Mic Jack"</span>,</span><br><span class="line">            <span class="string">"LINPUT3"</span>, <span class="string">"Mic Jack"</span>,</span><br><span class="line">            <span class="string">"RINPUT1"</span>, <span class="string">"Main MIC"</span>,</span><br><span class="line">            <span class="string">"RINPUT2"</span>, <span class="string">"Main MIC"</span>,  </span><br><span class="line">            <span class="string">"Mic Jack"</span>, <span class="string">"MICB"</span>,</span><br><span class="line">            <span class="string">"Main MIC"</span>, <span class="string">"MICB"</span>,</span><br><span class="line">            <span class="string">"CPU-Playback"</span>, <span class="string">"ASRC-Playback"</span>,</span><br><span class="line">            <span class="string">"Playback"</span>, <span class="string">"CPU-Playback"</span>,</span><br><span class="line">            <span class="string">"ASRC-Capture"</span>, <span class="string">"CPU-Capture"</span>,</span><br><span class="line">            <span class="string">"CPU-Capture"</span>, <span class="string">"Capture"</span>;</span><br><span class="line">            status = <span class="string">"okay"</span>;</span><br><span class="line">    };</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šè¿°æœºå™¨èŠ‚ç‚¹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¼–è§£ç å™¨å’Œ CPU åˆ†åˆ«é€šè¿‡ audio-codec å’Œ cpu-dai å±æ€§ä¼ é€’ï¼Œä¼ é€’çš„æ–¹æ³•æ˜¯å¼•ç”¨å®ƒä»¬çš„ phandleã€‚ åªè¦æœºå™¨é©±åŠ¨ç¨‹åºæ˜¯ç”±å¼€å‘äººå‘˜è‡ªå·±ç¼–å†™çš„ï¼Œé‚£ä¹ˆè¿™äº›å±æ€§åç§°å°±ä¸ä¼šæ˜¯æ ‡å‡†åŒ–çš„ï¼ˆå½“ç„¶ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ simple-card æœºå™¨é©±åŠ¨ç¨‹åºï¼Œåˆ™åˆå¦å½“åˆ«è®ºï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€äº›é¢„å®šä¹‰çš„åç§°ï¼‰ã€‚åœ¨æœºå™¨é©±åŠ¨ç¨‹åºä¸­ï¼Œä½ å°†çœ‹åˆ°ä»¥ä¸‹ç±»ä¼¼å†…å®¹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">imx_wm8960_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">cpu_np</span>, *<span class="title">codec_np</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">cpu_pdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_priv</span> *<span class="title">priv</span> =</span> &amp;card_priv;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">codec_dev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx_wm8960_data</span> *<span class="title">data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">asrc_pdev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">asrc_np</span>;</span></span><br><span class="line">u32 width;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">priv-&gt;pdev = pdev;</span><br><span class="line"></span><br><span class="line">cpu_np = of_parse_phandle(pdev-&gt;dev.of_node, <span class="string">"cpu-dai"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!cpu_np) {</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">"cpu dai phandle missing or invalid\n"</span>);</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">codec_np = of_parse_phandle(pdev-&gt;dev.of_node, <span class="string">"audio-codec"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!codec_np) {</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">"phandle missing or invalid\n"</span>);</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line">}</span><br><span class="line">    [...]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°ä»£ç ç‰‡æ®µä½¿ç”¨äº† of_parse_phandle() æ¥è·å–èŠ‚ç‚¹å¼•ç”¨ã€‚</p><h1 id="machine-è·¯ç”±">Machine è·¯ç”±</h1><h2 id="ç¼–è§£ç å™¨å¼•è„š">ç¼–è§£ç å™¨å¼•è„š</h2><p>ç¼–è§£ç å™¨å¼•è„š (codec pin) å¯ä»¥è¿æ¥åˆ°æ¿å¡æ¥å£ (board connector)ã€‚å¯ç”¨çš„ç¼–è§£ç å™¨å¼•è„šåœ¨ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºä¸­ä½¿ç”¨ SND_SOC_DAPM_INPUT å’Œ SND_SOC_DAPM_OUTPUT å®å®šä¹‰ã€‚å¯ä»¥åœ¨ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºä¸­ä½¿ç”¨ grep å‘½ä»¤æœç´¢è¿™äº›å®ï¼Œä»¥æ‰¾åˆ°å¯ç”¨çš„å¼•è„šã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> <span class="title">wm8960_dapm_widgets</span>[] =</span> {</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT1"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT1"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT2"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT2"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT3"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT3"</span>),</span><br><span class="line"></span><br><span class="line">    [...]</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_LP"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_LN"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"HP_L"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"HP_R"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_RP"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_RN"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"OUT3"</span>),</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›å¼•è„šå¦‚ä½•è¿æ¥åˆ°æ¿å¡ã€‚</p><h2 id="æ¿å¡æ¥å£">æ¿å¡æ¥å£</h2><p>æ¿å¡æ¥å£ (board connector) åœ¨æœºå™¨é©±åŠ¨ç¨‹åºä¸­å®šä¹‰ï¼Œå…¶ä½äº struct snd_soc_card çš„ struct snd_soc_dapm_widget éƒ¨åˆ†ä¸­ã€‚ å¤§å¤šæ•°æ—¶å€™ï¼Œè¿™äº›æ¿å¡æ¥å£æ˜¯è™šæ‹Ÿçš„ã€‚å®ƒä»¬åªæ˜¯ä¸ç¼–è§£ç å™¨å¼•è„šï¼ˆè¿™æ˜¯çœŸå®çš„ï¼‰è¿æ¥çš„é€»è¾‘è¡¨ç¤ºã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> <span class="title">imx_wm8960_dapm_widgets</span>[] =</span> {</span><br><span class="line">SND_SOC_DAPM_HP(<span class="string">"Headphone Jack"</span>, <span class="literal">NULL</span>),</span><br><span class="line">SND_SOC_DAPM_SPK(<span class="string">"Ext Spk"</span>, <span class="literal">NULL</span>),</span><br><span class="line">SND_SOC_DAPM_MIC(<span class="string">"Mic Jack"</span>, <span class="literal">NULL</span>),</span><br><span class="line">SND_SOC_DAPM_MIC(<span class="string">"Main MIC"</span>, <span class="literal">NULL</span>),</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†è¿™ä¸ªæ¥å£è¿æ¥åˆ°ç¼–è§£ç å™¨å¼•è„šã€‚</p><h2 id="æœºå™¨è·¯ç”±">æœºå™¨è·¯ç”±</h2><h3 id="è®¾å¤‡æ ‘è·¯ç”±">è®¾å¤‡æ ‘è·¯ç”±</h3><p>å³å‰é¢åˆ—å‡ºçš„ï¼Œè¿™é‡Œå†åˆ—ä»¥ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sound {</span><br><span class="line">        compatible = <span class="string">"fsl,imx6ul-evk-wm8960"</span>,</span><br><span class="line">                 <span class="string">"fsl,imx-audio-wm8960"</span>;</span><br><span class="line">        model = <span class="string">"wm8960-audio"</span>;</span><br><span class="line">        cpu-dai = &lt;&amp;sai2&gt;;</span><br><span class="line">        audio-codec = &lt;&amp;codec&gt;;</span><br><span class="line">        asrc-controller = &lt;&amp;asrc&gt;;</span><br><span class="line">        codec-master;</span><br><span class="line">        gpr = &lt;&amp;gpr <span class="number">4</span> <span class="number">0x100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line">        hp-det = &lt;<span class="number">3</span> <span class="number">0</span>&gt;;</span><br><span class="line">        <span class="comment">/*hp-det-gpios = &lt;&amp;gpio5 4 0&gt;;</span></span><br><span class="line"><span class="comment">        mic-det-gpios = &lt;&amp;gpio5 4 0&gt;;*/</span></span><br><span class="line">        audio-routing =</span><br><span class="line">            <span class="string">"Headphone Jack"</span>, <span class="string">"HP_L"</span>,</span><br><span class="line">            <span class="string">"Headphone Jack"</span>, <span class="string">"HP_R"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_LP"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_LN"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_RP"</span>,</span><br><span class="line">            <span class="string">"Ext Spk"</span>, <span class="string">"SPK_RN"</span>,</span><br><span class="line">            <span class="string">"LINPUT2"</span>, <span class="string">"Mic Jack"</span>,</span><br><span class="line">            <span class="string">"LINPUT3"</span>, <span class="string">"Mic Jack"</span>,</span><br><span class="line">            <span class="string">"RINPUT1"</span>, <span class="string">"Main MIC"</span>,</span><br><span class="line">            <span class="string">"RINPUT2"</span>, <span class="string">"Main MIC"</span>,  </span><br><span class="line">            <span class="string">"Mic Jack"</span>, <span class="string">"MICB"</span>,</span><br><span class="line">            <span class="string">"Main MIC"</span>, <span class="string">"MICB"</span>,</span><br><span class="line">            <span class="string">"CPU-Playback"</span>, <span class="string">"ASRC-Playback"</span>,</span><br><span class="line">            <span class="string">"Playback"</span>, <span class="string">"CPU-Playback"</span>,</span><br><span class="line">            <span class="string">"ASRC-Capture"</span>, <span class="string">"CPU-Capture"</span>,</span><br><span class="line">            <span class="string">"CPU-Capture"</span>, <span class="string">"Capture"</span>;</span><br><span class="line">            status = <span class="string">"okay"</span>;</span><br><span class="line">    };</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‡ªè®¾å¤‡æ ‘çš„è·¯ç”±æœŸæœ›ä»¥æŸç§æ ¼å¼ç»™å‡ºéŸ³é¢‘æ˜ å°„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¡ç›®è¢«è§£æä¸ºå­—ç¬¦ä¸²å¯¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿æ¥çš„æ¥æ”¶æ–¹ï¼Œç¬¬äºŒä¸ªæ˜¯è¿æ¥çš„æºã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›è¿æ¥è¢«å…·ä½“åŒ–ä¸ºç¼–è§£ç å™¨å¼•è„šå’Œæ¿å¡æ¥å£çš„æ˜ å°„ã€‚æºå’Œæ¥æ”¶æ–¹çš„æœ‰æ•ˆåç§°å–å†³äºç¡¬ä»¶ç»‘å®šï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>ç¼–è§£ç å™¨ï¼šä½¿ç”¨åç§°å®šä¹‰å¼•è„š</li><li>æœºå™¨ï¼šä½¿ç”¨åç§°å®šä¹‰æ¥å£æˆ–æ’å­” (jack)</li></ul><h3 id="é™æ€è·¯ç”±">é™æ€è·¯ç”±</h3><p>é™æ€è·¯ç”±åŒ…æ‹¬ä»æœºå™¨é©±åŠ¨ç¨‹åºå®šä¹‰ä¸€ä¸ª DAPM è·¯ç”±æ˜ å°„å¹¶å°†å…¶ç›´æ¥åˆ†é…ç»™å£°å¡ï¼Œå½“ç„¶ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å¦‚æœä¸é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œå°±æ— æ³•æ›´æ”¹è·¯ç”±ã€‚è¿™é‡Œä¸å†åšè¿‡å¤šè¯´æ˜äº†ã€‚</p><h1 id="æ—¶é’Ÿä¸æ ¼å¼æ³¨æ„äº‹é¡¹">æ—¶é’Ÿä¸æ ¼å¼æ³¨æ„äº‹é¡¹</h1><h2 id="æ—¶é’Ÿå’Œæ ¼å¼è®¾ç½®è¾…åŠ©å‡½æ•°">æ—¶é’Ÿå’Œæ ¼å¼è®¾ç½®è¾…åŠ©å‡½æ•°</h2><p>ASoC æ ¸å¿ƒæä¾›äº†è¾…åŠ©å‡½æ•°æ¥æ›´æ”¹è¿™äº›é…ç½®ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">snd_soc_dai_set_fmt</span><span class="params">(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">unsigned</span> <span class="type">int</span> fmt)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">snd_soc_dai_set_pll</span><span class="params">(<span class="keyword">struct</span> snd_soc_dai *dai,</span></span><br><span class="line"><span class="params"><span class="type">int</span> pll_id, <span class="type">int</span> source, <span class="type">unsigned</span> <span class="type">int</span> freq_in, <span class="type">unsigned</span> <span class="type">int</span> freq_out)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">snd_soc_dai_set_sysclk</span><span class="params">(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> clk_id,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> freq, <span class="type">int</span> dir)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">snd_soc_dai_set_clkdiv</span><span class="params">(<span class="keyword">struct</span> snd_soc_dai *dai,</span></span><br><span class="line"><span class="params"><span class="type">int</span> div_id, <span class="type">int</span> div)</span>;</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šé¢çš„è¾…åŠ©å‡½æ•°åˆ—è¡¨ä¸­ï¼Œå„å­—æ®µè§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>snd_soc_dai_set_fmt å¯ä¸ºæ—¶é’Ÿä¸»ä»å…³ç³»ã€éŸ³é¢‘æ ¼å¼å’Œä¿¡å·åè½¬ç­‰è®¾ç½® DAI æ ¼å¼</li><li>snd_soc_dai_set_pll å¯é…ç½®æ—¶é’Ÿ PIL</li><li>snd_soc_dai_set_sysckk å¯é…ç½®æ—¶é’Ÿæº</li><li>snd_soc_dai_set_clkdiv å¯é…ç½®æ—¶é’Ÿåˆ†é¢‘å™¨</li></ul><p>è¿™äº›è¾…åŠ©å‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†åœ¨åº•å±‚ DAI çš„é©±åŠ¨ç¨‹åºæ“ä½œä¸­è°ƒç”¨é€‚å½“çš„å›è°ƒå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ CPU DAI è°ƒç”¨ snd_soc_dai_set_fmt() è¾…åŠ©å‡½æ•°æ—¶ï¼Œå°†ä¼šè°ƒç”¨æ­¤ CPU DAI çš„ dai-&gt;driver-&gt;ops-&gt;set_fmt å›è°ƒå‡½æ•°ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»å¯ä»¥åˆ†é…ç»™ DAI æˆ– dai_link.fommat å­—æ®µçš„æ ¼å¼/æ ‡å¿—çš„å®é™…åˆ—è¡¨ã€‚å®ƒå¯ä»¥åˆ†ä¸ºæ ¼å¼ã€æ—¶é’Ÿæºå’Œæ—¶é’Ÿåˆ†é¢‘å™¨ 3 ç±»ã€‚</p><h3 id="æ ¼å¼">æ ¼å¼</h3><h4 id="æ—¶é’Ÿä¸»ä»å…³ç³»">æ—¶é’Ÿä¸»ä»å…³ç³»</h4><p>ä¸æ—¶é’Ÿä¸»ä»å…³ç³»ç›¸å…³çš„æ ‡å¿—åŒ…æ‹¬ä»¥ä¸‹ 3 éƒ¨åˆ†ï¼š</p><ul><li>SND_SOC_DAIFMT_CBM_CFM:CPU æ˜¯ä½æ—¶é’Ÿ (bit clock) å’Œå¸§åŒæ­¥ (firamesync) çš„ä»å± (slave)ã€‚è¿™ä¹Ÿæ„å‘³ç€ç¼–è§£ç å™¨æ˜¯ä¸¤è€…çš„ä¸»æ§ (master)</li><li>SND_SOC_DAIFMT_CBS_CFS:CPU æ˜¯ä½æ—¶é’Ÿå’Œå¸§åŒæ­¥çš„ä¸»æ§ã€‚è¿™ä¹Ÿæ„å‘³ç€ç¼–è§£ç å™¨æ˜¯ä¸¤è€…çš„ä»å±</li><li>SND_SOC_DAIFMT_CBM_CFS:CPU æ˜¯ä½æ—¶é’Ÿçš„ä»å±å’Œå¸§åŒæ­¥çš„ä¸»æ§ã€‚è¿™ä¹Ÿæ„å‘³ç€ç¼–è§£ç å™¨æ˜¯å‰è€…çš„ä¸»æ§å’Œåè€…çš„ä»å±</li></ul><h4 id="éŸ³é¢‘æ ¼å¼">éŸ³é¢‘æ ¼å¼</h4><p>ä¸éŸ³é¢‘æ ¼å¼ç›¸å…³çš„æ ‡å¿—åŒ…æ‹¬ä»¥ä¸‹ 9 éƒ¨åˆ†</p><ul><li>SND_SOC_DAIFMT_DSP_A: å¸§åŒæ­¥ä¸º 1 ä½æ—¶é’Ÿå®½åº¦ï¼Œ1 ä½å»¶è¿Ÿ</li><li>SND_SOC_DAIFMT_DSP_B: å¸§åŒæ­¥ä¸º 1 ä½æ—¶é’Ÿå®½åº¦ï¼Œ0 ä½å»¶è¿Ÿã€‚æ­¤æ ¼å¼å¯ç”¨äº TDM åè®®</li><li>SND_SOC_DAIFMT_I2S: å¸§åŒæ­¥ä¸º 1 ä¸ªéŸ³é¢‘å­—å®½ï¼Œ1 ä½å»¶è¿Ÿï¼ŒI2S æ¨¡å¼</li><li>SND_SOC_DAIEMT_RIGHT_J: å³å¯¹é½æ¨¡å¼</li><li>SND_SOC_DAIFMT_LEFT_J: å·¦å¯¹é½æ¨¡å¼</li><li>SND_SOC_DATFMT_DSP_A: å¸§åŒæ­¥ä¸º 1 ä½æ—¶é’Ÿå®½åº¦ï¼Œ1 ä½å»¶è¿Ÿ</li><li>SND_SOC_DAIFMT_AC97: AC97 æ¨¡å¼</li><li>SND_SOC_DAIFMT_PDM: è„‰å†²å¯†åº¦è°ƒåˆ¶ (pulse density modulationï¼ŒPDM)</li><li>SND_SOC_DAIFMT_DSP_B: å¸§åŒæ­¥ä¸º 1 ä½æ—¶é’Ÿå®½åº¦ï¼Œ1 ä½å»¶è¿Ÿ</li></ul><h4 id="ä¿¡å·åè½¬">ä¿¡å·åè½¬</h4><p>ä¸ä¿¡å·åè½¬ (signal inversion) ç›¸å…³çš„æ ‡å¿—åŒ…æ‹¬ä»¥ä¸‹ 4 éƒ¨åˆ†ï¼š</p><ul><li>SND_SOC_DAIEMT_NB_NF: æ­£å¸¸ä½æ—¶é’Ÿ (normal bit clock)ï¼Œæ­£å¸¸å¸§åŒæ­¥ (nonmal fame sync)ã€‚CPU å‘é€å™¨åœ¨ä½æ—¶é’Ÿçš„ä¸‹é™æ²¿ç§»å‡ºæ•°æ®ï¼Œæ¥æ”¶æ–¹åœ¨ä¸Šå‡æ²¿é‡‡æ ·æ•°æ®ã€‚CPU å¸§åŒæ­¥å‘ç”Ÿå™¨åœ¨å¸§åŒæ­¥çš„ä¸Šå‡æ²¿å¯åŠ¨å¸§ã€‚CPU ä¾§çš„ I2S æ¨èä½¿ç”¨è¯¥å‚æ•°</li><li>SND_SOC_DAIFMT_NB_FF: æ­£å¸¸ä½æ—¶é’Ÿï¼Œåè½¬å¸§åŒæ­¥ã€‚CPU å‘é€å™¨åœ¨ä½æ—¶é’Ÿçš„ä¸‹é™æ²¿ç§»å‡ºæ•°æ®ï¼Œæ¥æ”¶æ–¹åœ¨ä¸Šå‡æ²¿é‡‡æ ·æ•°æ®ã€‚CPU å¸§åŒæ­¥å‘ç”Ÿå™¨åœ¨å¸§åŒæ­¥çš„ä¸‹é™æ²¿å¯åŠ¨å¸§</li><li>SND_SOC_DAIFMT_IB_NF: åè½¬ä½æ—¶é’Ÿï¼Œæ­£å¸¸å¸§åŒæ­¥ã€‚CPU å‘é€å™¨åœ¨ä½æ—¶é’Ÿçš„ä¸Šå‡æ²¿ç§»å‡ºæ•°æ®ï¼Œæ¥æ”¶æ–¹åœ¨ä¸‹é™æ²¿é‡‡æ ·æ•°æ®ã€‚CPU å¸§åŒæ­¥å‘ç”Ÿå™¨åœ¨å¸§åŒæ­¥çš„ä¸Šå‡æ²¿å¯åŠ¨å¸§</li><li>SND_SOC_DAIEMT_IB_F: åè½¬ä½æ—¶é’Ÿï¼Œåè½¬å¸§åŒæ­¥ã€‚CPU å‘é€å™¨åœ¨ä½æ—¶é’Ÿçš„ä¸Šå‡æ²¿ç§»å‡ºæ•°æ®ï¼Œæ¥æ”¶æ–¹åœ¨ä¸‹é™æ²¿é‡‡æ ·æ•°æ®ã€‚CPU å¸§åŒæ­¥å‘ç”Ÿå™¨åœ¨å¸§åŒæ­¥çš„ä¸‹é™æ²¿å¯åŠ¨å¸§ã€‚æ­¤é…ç½®å¯ç”¨äº PCM æ¨¡å¼ï¼ˆå¦‚è“ç‰™æˆ–åŸºäºè°ƒåˆ¶è§£è°ƒå™¨çš„éŸ³é¢‘èŠ¯ç‰‡ï¼‰</li></ul><h3 id="æ—¶é’Ÿæº">æ—¶é’Ÿæº</h3><p>æ—¶é’Ÿæºå¯é€šè¿‡ snd_soc_dai_set_sysclk() è¾…åŠ©å‡½æ•°é…ç½®ã€‚ä»¥ä¸‹æ˜¯è®© ALSA çŸ¥é“ä½¿ç”¨å“ªä¸ªæ—¶é’Ÿçš„æ–¹å‘å‚æ•°ã€‚</p><ul><li>SND_SOC_CLOCK_IN: è¿™æ„å‘³ç€å°†å†…éƒ¨æ—¶é’Ÿç”¨äºç³»ç»Ÿæ—¶é’Ÿ</li><li>SND_SOC_CLOCK_OUT: è¿™æ„å‘³ç€å°†å¤–éƒ¨æ—¶é’Ÿç”¨äºç³»ç»Ÿæ—¶é’Ÿ</li></ul><h3 id="æ—¶é’Ÿåˆ†é¢‘å™¨">æ—¶é’Ÿåˆ†é¢‘å™¨</h3><p>æ—¶é’Ÿåˆ†é¢‘å™¨ï¼š(clock divider) å¯ä»¥é€šè¿‡ snd_soc_dai_set_clkdiv() è¾…åŠ©å‡½æ•°é…ç½®</p><h1 id="machine-åˆå§‹åŒ–æµç¨‹">Machine åˆå§‹åŒ–æµç¨‹</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkMzQyMjYwMTM0NTQ0MmQ3OTI3Mzg0">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/Machine_Init.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆå››ï¼‰Platform é©±åŠ¨</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAPlatformDriver/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAPlatformDriver/</url>
      
        <content type="html"><![CDATA[<p>å¹³å°é©±åŠ¨ç¨‹åºå¯ä»¥æ³¨å†Œ PCM é©±åŠ¨ç¨‹åºã€CPU DAI é©±åŠ¨ç¨‹åºåŠå…¶æ“ä½œå‡½æ•°ï¼Œä¸º PCM ç»„ä»¶é¢„åˆ†é…ç¼“å†²åŒºï¼Œå¹¶æ ¹æ®éœ€è¦è®¾ç½®å›æ”¾å’Œé‡‡é›†æ“ä½œã€‚æ¢è¨€ä¹‹ï¼Œå¹³å°é©±åŠ¨ç¨‹åºåŒ…å«è¯¥å¹³å°çš„éŸ³é¢‘å¼•æ“å’ŒéŸ³é¢‘æ¥å£é©±åŠ¨ç¨‹åºï¼ˆå¦‚ I2Sã€AC97 å’Œ PCMï¼‰ã€‚</p><p>å¹³å°é©±åŠ¨ç¨‹åºä»¥æ„æˆå¹³å°çš„ SoC ä¸ºç›®æ ‡ã€‚å®ƒæ¶‰åŠå¹³å°çš„ DMAï¼ˆå³éŸ³é¢‘æ•°æ®åœ¨ SoC ä¸­çš„æ¯ä¸ªå—ä¹‹é—´å¦‚ä½•ä¼ è¾“ï¼‰å’Œ CPU DAIï¼ˆå³ CPU å‘ç¼–è§£ç å™¨å‘é€éŸ³é¢‘æ•°æ®çš„è·¯å¾„æˆ– CPU ä»ç¼–è§£ç å™¨è·å¾—éŸ³é¢‘æ•°æ®çš„è·¯å¾„ï¼‰ã€‚</p><p>å¹³å°é©±åŠ¨ç¨‹åºæœ‰ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ä½“ï¼šstructsnd_soc_component_driver å’Œ structsnd_soc_dai_driverã€‚å‰è€…è´Ÿè´£ DMA æ•°æ®ç®¡ç†ï¼Œåè€…è´Ÿè´£ DAI çš„å‚æ•°é…ç½®ã€‚å½“ç„¶ï¼Œå‰æ–‡åœ¨è®¨è®ºç¼–è§£ç å™¨ç±»é©±åŠ¨ç¨‹åºæ—¶å·²ç»æè¿°è¿‡è¿™ä¸¤ç§æ•°æ®ç»“æ„ä½“ï¼Œå› æ­¤ï¼Œæœ¬èŠ‚å°†ä»…ä»‹ç»ä¸å¹³å°ä»£ç ç›¸å…³çš„é™„åŠ æ¦‚å¿µã€‚</p><span id="more"></span><h1 id="cpu-dai-é©±åŠ¨ç¨‹åº">CPU DAI é©±åŠ¨ç¨‹åº</h1><p>åœ¨å¹³å°ä¾§ï¼Œå¤§éƒ¨åˆ†å·¥ä½œéƒ½å¯ä»¥ç”± core å®Œæˆï¼Œå°¤å…¶æ˜¯ä¸ DMA ç›¸å…³çš„å·¥ä½œã€‚å› æ­¤ï¼ŒCPU DAI é©±åŠ¨ç¨‹åºé€šå¸¸åªæä¾›ç»„ä»¶é©±åŠ¨ç¨‹åºç»“æ„ä¸­çš„æ¥å£åç§°ï¼Œè€Œè®© core å®Œæˆå…¶ä½™çš„å·¥ä½œã€‚ä»¥ä¸‹æ˜¯ STM SPDIF é©±åŠ¨ç¨‹åºçš„ç¤ºä¾‹ï¼Œå®ƒåœ¨<code>sound/soc/stm/stm32_spdif.c</code>ä¸­å®ç°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> <span class="title">stm32_spdifrx_pcm_dai_ops</span> =</span> {</span><br><span class="line">.startup= stm32_spdifrx_startup,</span><br><span class="line">.hw_params= stm32_spdifrx_hw_params,</span><br><span class="line">.trigger= stm32_spdifrx_trigger,</span><br><span class="line">.shutdown= stm32_spdifrx_shutdown,</span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> <span class="title">stm32_spdifrx_dai</span>[] =</span> {</span><br><span class="line">{</span><br><span class="line">.probe = stm32_spdifrx_dai_probe,</span><br><span class="line">.capture = {</span><br><span class="line">.stream_name = <span class="string">"CPU-Capture"</span>,</span><br><span class="line">.channels_min = <span class="number">1</span>,</span><br><span class="line">.channels_max = <span class="number">2</span>,</span><br><span class="line">.rates = SNDRV_PCM_RATE_8000_192000,</span><br><span class="line">.formats = SNDRV_PCM_FMTBIT_S32_LE |</span><br><span class="line">   SNDRV_PCM_FMTBIT_S16_LE,</span><br><span class="line">},</span><br><span class="line">.ops = &amp;stm32_spdifrx_pcm_dai_ops,</span><br><span class="line">}</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> <span class="title">stm32_spdifrx_component</span> =</span> {</span><br><span class="line">.name = <span class="string">"stm32-spdifrx"</span>,</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">stm32_spdifrx_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    ret = snd_dmaengine_pcm_register(&amp;pdev-&gt;dev, pcm_config, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (ret) {</span><br><span class="line"><span class="keyword">if</span> (ret != -EPROBE_DEFER)</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">"PCM DMA register error %d\n"</span>, ret);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line">ret = snd_soc_register_component(&amp;pdev-&gt;dev,</span><br><span class="line"> &amp;stm32_spdifrx_component,</span><br><span class="line"> stm32_spdifrx_dai,</span><br><span class="line"> ARRAY_SIZE(stm32_spdifrx_dai));</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ snd_soc_component_driver åªæä¾›äº† name ä¿¡æ¯ï¼Œä»¶é©±åŠ¨ç¨‹åºå’Œ DAI é©±åŠ¨ç¨‹åºéƒ½å’Œå¾€å¸¸ä¸€æ ·é€šè¿‡ snd_soc_register_component() æ³¨å†Œã€‚ struct snd_soc_dai_driver å¿…é¡»æ ¹æ®å®é™…çš„ DAI å±æ€§è®¾ç½®ï¼Œå¦‚æœéœ€è¦ï¼Œåº”è¯¥è®¾ç½® dai_opsã€‚å½“ç„¶ï¼Œè¯¥è®¾ç½®çš„å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”± snd_dmaengine_pcm_register() å®Œæˆçš„ï¼Œå®ƒå°†æ ¹æ®æä¾›çš„è®¾ç½®ç»„ä»¶é©±åŠ¨ç¨‹åºçš„ PCM æ“ä½œã€‚</p><h1 id="platform-dma-é©±åŠ¨ç¨‹åº">Platform DMA é©±åŠ¨ç¨‹åº</h1><p>åœ¨å£°éŸ³ç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬æœ‰å¤šç§ç±»å‹çš„è®¾å¤‡ï¼šPCMã€MIDIã€æ··éŸ³å™¨ã€éŸ³åºå™¨ã€è®¡æ—¶å™¨ç­‰ã€‚è¿™é‡Œçš„ PCM æŒ‡çš„æ˜¯è„‰å†²ç¼–ç è°ƒåˆ¶ï¼ˆpulse code modulationï¼‰ï¼Œå³å¯¹è¿ç»­å˜åŒ–çš„æ¨¡æ‹Ÿä¿¡å·è¿›è¡Œé‡‡æ ·ã€é‡åŒ–å’Œç¼–ç ä»¥äº§ç”Ÿæ•°å­—ä¿¡å·ã€‚ä½†è¦æ³¨æ„ï¼Œè¿™é‡Œå®ƒæ˜¯æŒ‡å¤„ç†åŸºäºé‡‡æ ·çš„æ•°å­—éŸ³é¢‘çš„è®¾å¤‡ï¼Œè€Œä¸æ˜¯ MIDI ç­‰ã€‚PCM å±‚ï¼ˆALSA æ ¸å¿ƒçš„ä¸€éƒ¨åˆ†ï¼‰è´Ÿè´£å®Œæˆæ‰€æœ‰æ•°å­—éŸ³é¢‘å·¥ä½œï¼Œä¾‹å¦‚ï¼Œå‡†å¤‡æ¿å¡ä»¥è¿›è¡Œé‡‡é›†æˆ–å›æ”¾ã€å¯åŠ¨ä¸è®¾å¤‡ä¹‹é—´çš„ä¼ è¾“ç­‰ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœä½ æƒ³å›æ”¾æˆ–é‡‡é›†å£°éŸ³ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦ä¸€ä¸ª PCM è®¾å¤‡ã€‚</p><p>PCM é©±åŠ¨ç¨‹åºé€šè¿‡è¦†ç›–ç”± struct snd_pcm_ops ç»“æ„ä½“å…¬å¼€çš„å‡½æ•°æŒ‡é’ˆæ¥å¸®åŠ©æ‰§è¡Œ DMA æ“ä½œã€‚å®ƒä¸å¹³å°æ— å…³ï¼Œä»…ä¸ SOC DMA å¼•æ“ä¸Šæ¸¸ API äº¤äº’ã€‚ç„¶åï¼ŒDMA å¼•æ“ä¸ç‰¹å®šäºå¹³å°çš„ DMA é©±åŠ¨ç¨‹åºäº¤äº’ä»¥è·å¾—æ­£ç¡®çš„ DMA è®¾ç½®ã€‚struct snd_pcm_ops æ˜¯ä¸€ä¸ªåŒ…å«ä¸€ç»„å›è°ƒå‡½æ•°çš„ç»“æ„ä½“ï¼Œè¿™äº›å›è°ƒå‡½æ•°ä¸æœ‰å…³ PCM æ¥å£çš„ä¸åŒäº‹ä»¶ç›¸å…³ã€‚åœ¨å¤„ç† ASoCï¼ˆä¸æ˜¯çº¯ç²¹çš„ ALSAï¼‰æ—¶ï¼Œåªè¦ä½ ä½¿ç”¨é€šç”¨ PCM DMA å¼•æ“æ¡†æ¶ï¼Œå°±æ°¸è¿œä¸éœ€è¦æŒ‰åŸæ ·å®ä¾‹åŒ–æ­¤ç»“æ„ä½“ã€‚æ ¸å¿ƒä¼šä¸ºä½ å®Œæˆè¿™é¡¹å·¥ä½œã€‚</p><h1 id="éŸ³é¢‘-dma-æ¥å£">éŸ³é¢‘ DMA æ¥å£</h1><p>éŸ³é¢‘ DMA é©±åŠ¨ç¨‹åºé€šè¿‡ snd_dmaengine_pcm_register() æ³¨å†Œã€‚æ­¤å‡½æ•°å¯ä»¥ä¸ºè®¾å¤‡æ³¨å†Œä¸€ä¸ª struct snd_dmaengine_pcm_configã€‚ä¸‹é¢æ˜¯å®ƒçš„åŸå‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * snd_dmaengine_pcm_register - Register a dmaengine based PCM device</span></span><br><span class="line"><span class="comment"> * @dev: The parent device for the PCM device</span></span><br><span class="line"><span class="comment"> * @config: Platform specific PCM configuration</span></span><br><span class="line"><span class="comment"> * @flags: Platform specific quirks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">snd_dmaengine_pcm_register</span><span class="params">(<span class="keyword">struct</span> device *dev,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> snd_dmaengine_pcm_config *config, <span class="type">unsigned</span> <span class="type">int</span> flags)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>dev æ˜¯ PCM è®¾å¤‡çš„çˆ¶è®¾å¤‡ï¼Œé€šå¸¸æ˜¯&amp;pdev-&gt;dev<br></li><li>config æ˜¯ç‰¹å®šäºå¹³å°çš„ PCM é…ç½®ï¼Œå…¶ç±»å‹ä¸º struct snd_dmaengine_pcm_configã€‚ä¸‹æ–‡å°†è¯¦ç»†ä»‹ç»è¿™ä¸ªç»“æ„ä½“<br></li><li><p>flags è¡¨ç¤ºæè¿°å¦‚ä½•å¤„ç† DMA é€šé“çš„é™„åŠ æ ‡å¿—ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒå–å€¼ä¸º 0ã€‚ä½†æ˜¯ï¼Œå…¶å¯èƒ½çš„å€¼å·²åœ¨ include/sound/dmaengine_pcm.h ä¸­å®šä¹‰å¹¶ä¸”å‡ä»¥ SND_DMAENGINE_ä¸ºå‰ç¼€ã€‚ç»å¸¸ä½¿ç”¨çš„æ ‡å¿—åŒ…æ‹¬ä»¥ä¸‹ 3 ä¸ª</p><ul><li>SND_DMAENGINE_PCM_FLAG_COMPAT /* è¡¨ç¤ºå°†ä½¿ç”¨è‡ªå®šä¹‰å›è°ƒå‡½æ•°æ¥è¯·æ±‚é€šé“ */</li><li>SND_DMAENGINE_PCM_FLAG_NO_DT /* è¦æ±‚æ ¸å¿ƒä¸è¦å°è¯•é€šè¿‡è®¾å¤‡æ ‘ï¼ˆDTï¼‰è¯·æ±‚ DMA é€šé“ */</li><li>SND_DMAENGINE_PCM_FLAG_HALF_DUPLEX /* ç¤º PCM æ˜¯åŠåŒå·¥ï¼ˆhalf-duplexï¼‰çš„ï¼ŒDMA é€šé“åœ¨é‡‡é›†å’Œå›æ”¾ä¹‹é—´å…±äº« */</li></ul></li></ul><p>åœ¨æ³¨å†Œä¹‹åï¼Œé€šç”¨ PCM DMA å¼•æ“æ¡†æ¶å°†æ„å»ºåˆé€‚çš„ snd_pcm_ops å¹¶è®¾ç½®ç»„ä»¶é©±åŠ¨ç¨‹åºçš„ã€‚ops å­—æ®µã€‚</p><p>Linux ä¸­ç»å…¸çš„ DMA æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>dma_request_channel: ç”¨äºåˆ†é… slave é€šé“ï¼ˆslave channelï¼‰</li><li>dmaengine_slave_config: è®¾ç½®ä¸ slave é€šé“å’Œæ§åˆ¶å™¨ç›¸å…³å‚æ•°</li><li>dma_prep_xxx: è·å–äº‹åŠ¡çš„æè¿°ç¬¦</li><li>dma_cookie = dmaengine_submit(tx): æäº¤äº‹åŠ¡å¹¶æŠ“å– DMA cookie</li><li>dma_async_issue_pending(chan): å¼€å§‹ä¼ è¾“å¹¶ç­‰å¾…å›è°ƒå‡½æ•°é€šçŸ¥</li></ul><p>åœ¨ ASOC ä¸­ï¼Œè®¾å¤‡æ ‘ç”¨äºå°† DMA é€šé“æ˜ å°„åˆ° PCM è®¾å¤‡ã€‚ snd_dmaengine_pcm_registerï¼ˆï¼‰å¯ä»¥é€šè¿‡ dmaengine_pcm_request_chan_ofï¼ˆï¼‰è¯·æ±‚ DMA é€šé“ï¼Œä¸ºäº†æ‰§è¡Œä¸Šè¿°å‰ 3 ä¸ªæ­¥éª¤ï¼Œéœ€è¦ä¸º PCM DMA å¼•æ“æ ¸å¿ƒæä¾›é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å¡«å…… struct snd_dmaengine_pcm_config æ¥å®Œæˆã€‚åä¸¤æ­¥ç”± PCM DMA å¼•æ“æ ¸å¿ƒé€æ˜å¤„ç†ã€‚</p><p>struct snd_dmaengine_pcm_config ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_dmaengine_pcm_config</span> {</span></span><br><span class="line"><span class="type">int</span> (*prepare_slave_config)(<span class="keyword">struct</span> snd_pcm_substream *substream,</span><br><span class="line"><span class="keyword">struct</span> snd_pcm_hw_params *params,</span><br><span class="line"><span class="keyword">struct</span> dma_slave_config *slave_config);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_chan</span> *(*<span class="title">compat_request_channel</span>)(</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_runtime</span> *<span class="title">rtd</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>);</span></span><br><span class="line"><span class="type">int</span> (*process)(<span class="keyword">struct</span> snd_pcm_substream *substream,</span><br><span class="line">       <span class="type">int</span> channel, <span class="type">unsigned</span> <span class="type">long</span> hwoff,</span><br><span class="line">       <span class="type">void</span> *buf, <span class="type">unsigned</span> <span class="type">long</span> bytes);</span><br><span class="line">dma_filter_fn compat_filter_fn;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dma_dev</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *chan_names[SNDRV_PCM_STREAM_LAST + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_hardware</span> *<span class="title">pcm_hardware</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> prealloc_buffer_size;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¯¥ç»“æ„ä½“ä¸»è¦å¤„ç† DMA é€šé“ç®¡ç†ã€ç¼“å†²åŒºç®¡ç†å’Œé€šé“é…ç½®ï¼Œå…·ä½“å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>prepare_slave_config: ç”¨äºä¸º PCM å­æµå¡«å…… DMA slave_configã€‚å®ƒå°†ä» PCM é©±åŠ¨ç¨‹åºçš„ hwparams å›è°ƒå‡½æ•°ä¸­è°ƒç”¨ã€‚</li><li>compat_request_channelï¼šç”¨äºä¸ºä¸ä½¿ç”¨è®¾å¤‡æ ‘çš„ platform è¯·æ±‚ DMA channelã€‚å¦‚æœè®¾ç½®äº†å®ƒï¼Œåˆ™ã€‚compat_filter_fn å°†è¢«å¿½ç•¥</li><li>compat_filter_fnï¼šå½“ä¸ºä¸ä½¿ç”¨è®¾å¤‡æ ‘çš„ platform è¯·æ±‚ DMA é€šé“æ—¶ï¼Œå®ƒå‘æŒ¥è¿‡æ»¤åŠŸèƒ½ï¼Œè¿‡æ»¤çš„å‚æ•°å°†æ˜¯ DAI çš„ DMA æ•°æ®</li><li>dma_devï¼šå…è®¸ä¸ºæ³¨å†Œ PCM é©±åŠ¨ç¨‹åºçš„è®¾å¤‡ä»¥å¤–çš„è®¾å¤‡è¯·æ±‚ DMA é€šé“ï¼Œå¦‚æœè®¾ç½®äº†å®ƒï¼Œåˆ™å°†åœ¨æ­¤è®¾å¤‡è€Œä¸æ˜¯ DAI è®¾å¤‡ä¸Šè¯·æ±‚ DMA é€šé“</li><li>chan_namesï¼šè¿™æ˜¯è¯·æ±‚é‡‡é›†/å›æ”¾ DMA é€šé“æ—¶ä½¿ç”¨çš„åç§°æ•°ç»„ï¼Œå¦‚æœè®¾å¤‡æœ‰å¤šä¸ªé€šé“ï¼Œåˆ™æ¯ä¸ªé€šé“å…·æœ‰ä¸åŒçš„ DMA é€šé“åç§°</li><li>pcm_hardwareï¼šæè¿°äº† PCM ç¡¬ä»¶åŠŸèƒ½</li><li>prealloc_buffer_sizeï¼šè¡¨ç¤ºé¢„åˆ†é…éŸ³é¢‘ç¼“å†²åŒºçš„å¤§å°</li></ul><p>PCM DMA é…ç½®å¯èƒ½ä¸ä¼šæä¾›æ³¨å†Œ APIï¼ˆå¯èƒ½æ˜¯ NULLï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½ åº”è¯¥é€šè¿‡ snd_soc_dai_init_dma_dataï¼ˆï¼‰æä¾›é‡‡é›†å’Œå›æ”¾ DAI DMA é€šé“é…ç½®ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå…¶ä»–å…ƒç´ å°†ä»ç³»ç»Ÿæ ¸å¿ƒæ´¾ç”Ÿã€‚</p><h1 id="æµç¨‹æ¢³ç†">æµç¨‹æ¢³ç†</h1><p>æ•°æ®æµç¨‹æ¡†å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/ASOC_Playback_Stream.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒéŸ³é¢‘æ•°æ®ä»ç”¨æˆ·å¤åˆ¶åˆ° DMA ç¼“å†²åŒºï¼Œç„¶åï¼ŒDMA äº‹åŠ¡å°†æ•°æ®ç§»åŠ¨åˆ°å¹³å°éŸ³é¢‘ TxFIF, ç”±äºå®ƒä¸ç¼–è§£ç å™¨çš„é“¾æ¥ï¼ˆé€šè¿‡å®ƒä»¬å„è‡ªçš„ DAI), è¿™äº›æ•°æ®å°†è¢«å‘é€åˆ°ç¼–è§£ç å™¨ï¼Œä»¥é€šè¿‡æ‰¬å£°å™¨å›æ”¾éŸ³é¢‘ã€‚é‡‡é›†æ“ä½œæµåˆ™ç›¸åï¼Œåªæ˜¯æ‰¬å£°å™¨è¢«éº¦å…‹é£å–ä»£ã€‚</p><p>ç›¸å…³å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkMmViMDIyOGJmMWQwMGQwOGM3NzVm">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/stm32_i2s_probe.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆä¸‰ï¼‰ç¼–è§£ç å™¨ç±»é©±åŠ¨å®ä¾‹</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAEncClassInstance/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAEncClassInstance/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œä»¥ Wolfson å…¬å¸çš„ç¼–è§£ç èŠ¯ç‰‡ WM8960 ä¸ºä¾‹æ¥è¯´æ˜ä¸Šç¯‡ä»‹ç»çš„ç›¸å…³å†…å®¹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/wm8960_framework.png"></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/wm8960_mixer_list.png"></p><span id="more"></span><h1 id="å®šä¹‰-widget-æ‰€éœ€çš„-dapm-kcontrol">å®šä¹‰ widget æ‰€éœ€çš„ DAPM Kcontrol</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">wm8960_loutput_mixer</span>[] =</span> {</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"PCM Playback Switch"</span>, WM8960_LOUTMIX, <span class="number">8</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"LINPUT3 Switch"</span>, WM8960_LOUTMIX, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"Boost Bypass Switch"</span>, WM8960_BYPASS1, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">wm8960_routput_mixer</span>[] =</span> {</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"PCM Playback Switch"</span>, WM8960_ROUTMIX, <span class="number">8</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"RINPUT3 Switch"</span>, WM8960_ROUTMIX, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"Boost Bypass Switch"</span>, WM8960_BYPASS2, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">wm8960_mono_out</span>[] =</span> {</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"Left Switch"</span>, WM8960_MONOMIX1, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    SOC_DAPM_SINGLE(<span class="string">"Right Switch"</span>, WM8960_MONOMIX2, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­å®šä¹‰äº†å·¦å³è¾“å‡ºé€šé“çš„æ··éŸ³å™¨æ§ä»¶ï¼Œä»¥åŠå•å£°é“è¾“å‡ºæ··éŸ³å™¨ï¼šwm8960_loutput_mixerã€wm8960_routput_mixerã€wm8960_mono_outã€‚</p><h1 id="å®šä¹‰çœŸå®çš„-widgetåŒ…æ‹¬-damp-æ§ä»¶">å®šä¹‰çœŸå®çš„ widgetï¼ŒåŒ…æ‹¬ DAMP æ§ä»¶</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> <span class="title">wm8960_dapm_widgets</span>[] =</span> {</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT1"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT1"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT2"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT2"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"LINPUT3"</span>),</span><br><span class="line">    SND_SOC_DAPM_INPUT(<span class="string">"RINPUT3"</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_SUPPLY(<span class="string">"MICB"</span>, WM8960_POWER1, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Left Boost Mixer"</span>, WM8960_POWER1, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">       wm8960_lin_boost, ARRAY_SIZE(wm8960_lin_boost)),</span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Right Boost Mixer"</span>, WM8960_POWER1, <span class="number">4</span>, <span class="number">0</span>,</span><br><span class="line">       wm8960_rin_boost, ARRAY_SIZE(wm8960_rin_boost)),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Left Input Mixer"</span>, WM8960_POWER3, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">       wm8960_lin, ARRAY_SIZE(wm8960_lin)),</span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Right Input Mixer"</span>, WM8960_POWER3, <span class="number">4</span>, <span class="number">0</span>,</span><br><span class="line">       wm8960_rin, ARRAY_SIZE(wm8960_rin)),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_ADC(<span class="string">"Left ADC"</span>, <span class="string">"Capture"</span>, WM8960_POWER1, <span class="number">3</span>, <span class="number">0</span>),</span><br><span class="line">    SND_SOC_DAPM_ADC(<span class="string">"Right ADC"</span>, <span class="string">"Capture"</span>, WM8960_POWER1, <span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_DAC(<span class="string">"Left DAC"</span>, <span class="string">"Playback"</span>, WM8960_POWER2, <span class="number">8</span>, <span class="number">0</span>),</span><br><span class="line">    SND_SOC_DAPM_DAC(<span class="string">"Right DAC"</span>, <span class="string">"Playback"</span>, WM8960_POWER2, <span class="number">7</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Left Output Mixer"</span>, WM8960_POWER3, <span class="number">3</span>, <span class="number">0</span>,</span><br><span class="line">    &amp;wm8960_loutput_mixer[<span class="number">0</span>],</span><br><span class="line">    ARRAY_SIZE(wm8960_loutput_mixer)),</span><br><span class="line">    SND_SOC_DAPM_MIXER(<span class="string">"Right Output Mixer"</span>, WM8960_POWER3, <span class="number">2</span>, <span class="number">0</span>,</span><br><span class="line">    &amp;wm8960_routput_mixer[<span class="number">0</span>],</span><br><span class="line">    ARRAY_SIZE(wm8960_routput_mixer)),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"LOUT1 PGA"</span>, WM8960_POWER2, <span class="number">6</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"ROUT1 PGA"</span>, WM8960_POWER2, <span class="number">5</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"Left Speaker PGA"</span>, WM8960_POWER2, <span class="number">4</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"Right Speaker PGA"</span>, WM8960_POWER2, <span class="number">3</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"Right Speaker Output"</span>, WM8960_CLASSD1, <span class="number">7</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">    SND_SOC_DAPM_PGA(<span class="string">"Left Speaker Output"</span>, WM8960_CLASSD1, <span class="number">6</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_LP"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_LN"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"HP_L"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"HP_R"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_RP"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"SPK_RN"</span>),</span><br><span class="line">    SND_SOC_DAPM_OUTPUT(<span class="string">"OUT3"</span>),</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ä¸€æ­¥ä¸­ä¸ºå·¦å³å£°é“é€‰æ‹©å™¨å®šä¹‰äº†ä¸€ä¸ª MUX widgetï¼Œä»–ä»¬æ˜¯ Left Output Mixerã€Right Output Mixer å’Œ Mono Output Mixerã€‚ æˆ‘ä»¬è¿˜ä¸ºæ¯ä¸ªæ‰¬å£°å™¨å®šä¹‰äº†ä¸€ä¸ªæ··éŸ³å™¨ widgetï¼šSPK_LPã€SPK_LNã€HP_Lã€HP_Rã€SPK_RPã€SPK_RNã€OUT3ã€‚å…·ä½“çš„æ··éŸ³å™¨æ§åˆ¶ç”± wm8960_loutput_mixerã€wm8960_routput_mixerã€wm8960_mono_out æ¥å®Œæˆï¼Œè¿™ä¸‰ä¸ª widget éƒ½å…·æœ‰ power å±æ€§ï¼Œå› æ­¤ï¼Œå½“è¿™äº› widget ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªä½äºä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘è·¯å¾„æ—¶ï¼ŒDAPM æ¡†æ¶å¯ä»¥é€šè¿‡å…¶å„è‡ªçš„å¯„å­˜å™¨çš„ç¬¬ 7 å’Œç¬¬ 8 ä½æ¥æ§åˆ¶ç”µæºçŠ¶æ€ã€‚</p><h1 id="å®šä¹‰-widget-çš„è¿æ¥è·¯å¾„">å®šä¹‰ widget çš„è¿æ¥è·¯å¾„</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> <span class="title">audio_paths</span>[] =</span> {</span><br><span class="line">{ <span class="string">"Left Boost Mixer"</span>, <span class="string">"LINPUT1 Switch"</span>, <span class="string">"LINPUT1"</span> },</span><br><span class="line">{ <span class="string">"Left Boost Mixer"</span>, <span class="string">"LINPUT2 Switch"</span>, <span class="string">"LINPUT2"</span> },</span><br><span class="line">{ <span class="string">"Left Boost Mixer"</span>, <span class="string">"LINPUT3 Switch"</span>, <span class="string">"LINPUT3"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Left Input Mixer"</span>, <span class="string">"Boost Switch"</span>, <span class="string">"Left Boost Mixer"</span> },</span><br><span class="line">{ <span class="string">"Left Input Mixer"</span>, <span class="string">"Boost Switch"</span>, <span class="string">"LINPUT1"</span> },  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">{ <span class="string">"Left Input Mixer"</span>, <span class="literal">NULL</span>, <span class="string">"LINPUT2"</span> },</span><br><span class="line">{ <span class="string">"Left Input Mixer"</span>, <span class="literal">NULL</span>, <span class="string">"LINPUT3"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Right Boost Mixer"</span>, <span class="string">"RINPUT1 Switch"</span>, <span class="string">"RINPUT1"</span> },</span><br><span class="line">{ <span class="string">"Right Boost Mixer"</span>, <span class="string">"RINPUT2 Switch"</span>, <span class="string">"RINPUT2"</span> },</span><br><span class="line">{ <span class="string">"Right Boost Mixer"</span>, <span class="string">"RINPUT3 Switch"</span>, <span class="string">"RINPUT3"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Right Input Mixer"</span>, <span class="string">"Boost Switch"</span>, <span class="string">"Right Boost Mixer"</span> },</span><br><span class="line">{ <span class="string">"Right Input Mixer"</span>, <span class="string">"Boost Switch"</span>, <span class="string">"RINPUT1"</span> },  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">{ <span class="string">"Right Input Mixer"</span>, <span class="literal">NULL</span>, <span class="string">"RINPUT2"</span> },</span><br><span class="line">{ <span class="string">"Right Input Mixer"</span>, <span class="literal">NULL</span>, <span class="string">"RINPUT3"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Left ADC"</span>, <span class="literal">NULL</span>, <span class="string">"Left Input Mixer"</span> },</span><br><span class="line">{ <span class="string">"Right ADC"</span>, <span class="literal">NULL</span>, <span class="string">"Right Input Mixer"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Left Output Mixer"</span>, <span class="string">"LINPUT3 Switch"</span>, <span class="string">"LINPUT3"</span> },</span><br><span class="line">{ <span class="string">"Left Output Mixer"</span>, <span class="string">"Boost Bypass Switch"</span>, <span class="string">"Left Boost Mixer"</span> },</span><br><span class="line">{ <span class="string">"Left Output Mixer"</span>, <span class="string">"PCM Playback Switch"</span>, <span class="string">"Left DAC"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Right Output Mixer"</span>, <span class="string">"RINPUT3 Switch"</span>, <span class="string">"RINPUT3"</span> },</span><br><span class="line">{ <span class="string">"Right Output Mixer"</span>, <span class="string">"Boost Bypass Switch"</span>, <span class="string">"Right Boost Mixer"</span> },</span><br><span class="line">{ <span class="string">"Right Output Mixer"</span>, <span class="string">"PCM Playback Switch"</span>, <span class="string">"Right DAC"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"LOUT1 PGA"</span>, <span class="literal">NULL</span>, <span class="string">"Left Output Mixer"</span> },</span><br><span class="line">{ <span class="string">"ROUT1 PGA"</span>, <span class="literal">NULL</span>, <span class="string">"Right Output Mixer"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"HP_L"</span>, <span class="literal">NULL</span>, <span class="string">"LOUT1 PGA"</span> },</span><br><span class="line">{ <span class="string">"HP_R"</span>, <span class="literal">NULL</span>, <span class="string">"ROUT1 PGA"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Left Speaker PGA"</span>, <span class="literal">NULL</span>, <span class="string">"Left Output Mixer"</span> },</span><br><span class="line">{ <span class="string">"Right Speaker PGA"</span>, <span class="literal">NULL</span>, <span class="string">"Right Output Mixer"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"Left Speaker Output"</span>, <span class="literal">NULL</span>, <span class="string">"Left Speaker PGA"</span> },</span><br><span class="line">{ <span class="string">"Right Speaker Output"</span>, <span class="literal">NULL</span>, <span class="string">"Right Speaker PGA"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"SPK_LN"</span>, <span class="literal">NULL</span>, <span class="string">"Left Speaker Output"</span> },</span><br><span class="line">{ <span class="string">"SPK_LP"</span>, <span class="literal">NULL</span>, <span class="string">"Left Speaker Output"</span> },</span><br><span class="line">{ <span class="string">"SPK_RN"</span>, <span class="literal">NULL</span>, <span class="string">"Right Speaker Output"</span> },</span><br><span class="line">{ <span class="string">"SPK_RP"</span>, <span class="literal">NULL</span>, <span class="string">"Right Speaker Output"</span> },</span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> <span class="title">audio_paths_out3</span>[] =</span> {</span><br><span class="line">{ <span class="string">"Mono Output Mixer"</span>, <span class="string">"Left Switch"</span>, <span class="string">"Left Output Mixer"</span> },</span><br><span class="line">{ <span class="string">"Mono Output Mixer"</span>, <span class="string">"Right Switch"</span>, <span class="string">"Right Output Mixer"</span> },</span><br><span class="line"></span><br><span class="line">{ <span class="string">"OUT3"</span>, <span class="literal">NULL</span>, <span class="string">"Mono Output Mixer"</span>, }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡è¿™ä¸€æ­¥çš„å®šä¹‰æˆ‘ä»¬çŸ¥é“ Left output Mux å’Œ Right output Mux æœ‰ä¸‰ä¸ªè¾“å…¥å¼•è„šï¼Œåˆ†åˆ«æ˜¯ Boost Bypass Switchã€LINPUT3 Switchã€PCM Playback Switchã€‚Mono Output Mixer åªæœ‰ä¸¤ä¸ªè¾“å…¥å¼•è„šï¼ŒLeft Switchã€Right Switchï¼Œæ‰€ä»¥ï¼Œä¸Šè¿°å®šä¹‰çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>Left Boost Mixer é€šè¿‡ Boost Bypass Switch è¿æ¥åˆ° Left Output Mixer</li><li>Left DAC é€šè¿‡ PCM Playback Switch è¿æ¥åˆ° Left Output Mixer</li><li>LINPUT3 é€šè¿‡ LINPUT3 Switch è¿æ¥åˆ° Left Output Mixer</li><li>Left Output Mixer è¿æ¥åˆ° LOUT1 PGAï¼Œä½†æ˜¯æ­¤é“¾æ¥æ²¡æœ‰å¼€å…³æ§åˆ¶</li><li>Right xxx åŒç†è¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾å‡ºæ¥äº†</li></ul><h1 id="åœ¨ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºçš„-probe-å›è°ƒå‡½æ•°ä¸­æ³¨å†Œ-widget-å’Œè·¯å¾„">åœ¨ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºçš„ probe å›è°ƒå‡½æ•°ä¸­æ³¨å†Œ widget å’Œè·¯å¾„</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">wm8960_add_widgets</span><span class="params">(<span class="keyword">struct</span> snd_soc_component *component)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wm8960_priv</span> *<span class="title">wm8960</span> =</span> snd_soc_component_get_drvdata(component);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wm8960_data</span> *<span class="title">pdata</span> =</span> &amp;wm8960-&gt;pdata;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span> =</span> snd_soc_component_get_dapm(component);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line"></span><br><span class="line">snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets,</span><br><span class="line">  ARRAY_SIZE(wm8960_dapm_widgets));</span><br><span class="line"></span><br><span class="line">snd_soc_dapm_add_routes(dapm, audio_paths, ARRAY_SIZE(audio_paths));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In capless mode OUT3 is used to provide VMID for the</span></span><br><span class="line"><span class="comment"> * headphone outputs, otherwise it is used as a mono mixer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (pdata &amp;&amp; pdata-&gt;capless) {</span><br><span class="line">snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets_capless,</span><br><span class="line">  ARRAY_SIZE(wm8960_dapm_widgets_capless));</span><br><span class="line"></span><br><span class="line">snd_soc_dapm_add_routes(dapm, audio_paths_capless,</span><br><span class="line">ARRAY_SIZE(audio_paths_capless));</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets_out3,</span><br><span class="line">  ARRAY_SIZE(wm8960_dapm_widgets_out3));</span><br><span class="line"></span><br><span class="line">snd_soc_dapm_add_routes(dapm, audio_paths_out3,</span><br><span class="line">ARRAY_SIZE(audio_paths_out3));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We need to power up the headphone output stage out of</span></span><br><span class="line"><span class="comment"> * sequence for capless mode.  To save scanning the widget</span></span><br><span class="line"><span class="comment"> * list each time to find the desired power state do so now</span></span><br><span class="line"><span class="comment"> * and save the result.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_for_each_entry(w, &amp;component-&gt;card-&gt;widgets, <span class="built_in">list</span>) {</span><br><span class="line"><span class="keyword">if</span> (w-&gt;dapm != dapm)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">"LOUT1 PGA"</span>) == <span class="number">0</span>)</span><br><span class="line">wm8960-&gt;lout1 = w;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">"ROUT1 PGA"</span>) == <span class="number">0</span>)</span><br><span class="line">wm8960-&gt;rout1 = w;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">"OUT3 VMID"</span>) == <span class="number">0</span>)</span><br><span class="line">wm8960-&gt;out3 = w;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">wm8960_probe</span><span class="params">(<span class="keyword">struct</span> snd_soc_component *component)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">wm8960_add_widgets(component);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ machine é©±åŠ¨ç¨‹åº probe åˆ°è¿™ä¸ªç¼–è§£ç æ—¶ï¼Œå°±ä¼šè°ƒç”¨ç¼–è§£ç å™¨ç»„ä»¶çš„ probe å›è°ƒå‡½æ•° wm8960_probeï¼Œä»¥å®Œæˆç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºçš„åˆå§‹åŒ–ã€‚ç¼–è§£ç å™¨éœ€è¦ç»‘å®šåˆ° platform é©±åŠ¨ç¨‹åºæ‰èƒ½å‘æŒ¥ä½œç”¨ï¼Œè¿™æ˜¯åé¢è¦ä»‹ç»çš„å†…å®¹ã€‚</p><h1 id="æµç¨‹">æµç¨‹</h1><p>ç”±äºå‡½æ•°è°ƒç”¨æ ˆå¾ˆæ·±ï¼Œæ²¡æœ‰åŠæ³•ä¸€ä¸€åˆ—å‡ºï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªæ€ç»´å¯¼å›¾æ¥å°†å„å‡½æ•°è°ƒç”¨å…³ç³»åˆ—å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ã€‚</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkMmI2MjQ5MmU0OWMzYWI1OWFlYjcx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/wm8960_i2c_probe.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆäºŒï¼‰ç¼–è§£ç å™¨ç±»é©±åŠ¨ç›¸å…³æ¦‚å¿µ</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSAEncClass/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSAEncClass/</url>
      
        <content type="html"><![CDATA[<p>ç¼–è§£ç å™¨ç±»é©±åŠ¨ç¨‹åºæ˜¯æœ€åŸºæœ¬çš„ï¼Œä»–å®ç°çš„ä»£ç åº”è¯¥åˆ©ç”¨ç¼–è§£ç å™¨è®¾å¤‡å¹¶å…¬å¼€å…¶ç¡¬ä»¶å±æ€§ï¼Œä»¥ä¾¿ amixer ç­‰ç”¨æˆ·ç©ºé—´å·¥å…·å¯ä»¥ä½¿ç”¨å®ƒã€‚</p><p>ç”±äºé©±åŠ¨ç¨‹åºé’ˆå¯¹ç‰¹å®šçš„ç¼–è§£ç å™¨ï¼Œå› æ­¤å®ƒåº”è¯¥åŒ…å«éŸ³é¢‘æ§åˆ¶ã€éŸ³é¢‘æ¥å£åŠŸèƒ½ã€ç¼–è§£ç å™¨ DAPM å®šä¹‰å’Œ I/O åŠŸèƒ½ï¼Œæ¯ä¸ªç¼–è§£ç å™¨å¿…é¡»æ»¡è¶³ï¼š</p><ul><li>é€šè¿‡å®šä¹‰ DAI å’Œ PCM é…ç½®æ¥æä¾›ä¸å…¶ä»–æ¨¡å—çš„æ¥å£</li><li>æä¾›ç¼–è§£ç å™¨æ§åˆ¶ I/O hookï¼ˆä½¿ç”¨ I2Cã€SPI çš„ APIï¼‰</li><li>æ ¹æ®ç”¨æˆ·ç©ºé—´çš„éœ€è¦ï¼Œå…¬å¼€å…¶ä»–å†…æ ¸æ§ä»¶ï¼ˆKernel controlï¼ŒKcontrolï¼‰ä»¥åŠ¨æ€æ§åˆ¶æ¨¡å—è¡Œä¸º</li><li>å®šä¹‰ DAPM widgetï¼Œä¸ºåŠ¨æ€ç”µæºåˆ‡æ¢å»ºç«‹ DAPM è·¯ç”±ï¼Œå¹¶æä¾› DAC æ•°å­—é™éŸ³æ§åˆ¶ï¼ˆoptionï¼‰</li></ul><span id="more"></span><h1 id="component">Component</h1><p>åŒ…å«ç¼–è§£ç å™¨çš„è·¯ç”±ã€widgetã€æ§ä»¶é‡‘é¢ä¸€ç»„ç¼–è§£ç å™¨ç›¸å…³å‡½æ•°å›è°ƒæŒ‡é’ˆï¼Œä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ª dai é©±åŠ¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* component interface */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_component_driver</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Default control and setup, added after probe() is run */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">controls</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_controls;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">dapm_widgets</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_dapm_widgets;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> *<span class="title">dapm_routes</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> num_dapm_routes;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*probe)(<span class="keyword">struct</span> snd_soc_component *component);</span><br><span class="line"><span class="type">void</span> (*remove)(<span class="keyword">struct</span> snd_soc_component *component);</span><br><span class="line"><span class="type">int</span> (*suspend)(<span class="keyword">struct</span> snd_soc_component *component);</span><br><span class="line"><span class="type">int</span> (*resume)(<span class="keyword">struct</span> snd_soc_component *component);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*read)</span><span class="params">(<span class="keyword">struct</span> snd_soc_component *component,</span></span><br><span class="line"><span class="params">     <span class="type">unsigned</span> <span class="type">int</span> reg)</span>;</span><br><span class="line"><span class="type">int</span> (*write)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line">     <span class="type">unsigned</span> <span class="type">int</span> reg, <span class="type">unsigned</span> <span class="type">int</span> val);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pcm creation and destruction */</span></span><br><span class="line"><span class="type">int</span> (*pcm_new)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd);</span><br><span class="line"><span class="type">void</span> (*pcm_free)(<span class="keyword">struct</span> snd_pcm *pcm);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* component wide operations */</span></span><br><span class="line"><span class="type">int</span> (*set_sysclk)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line">  <span class="type">int</span> clk_id, <span class="type">int</span> source, <span class="type">unsigned</span> <span class="type">int</span> freq, <span class="type">int</span> dir);</span><br><span class="line"><span class="type">int</span> (*set_pll)(<span class="keyword">struct</span> snd_soc_component *component, <span class="type">int</span> pll_id,</span><br><span class="line">       <span class="type">int</span> source, <span class="type">unsigned</span> <span class="type">int</span> freq_in, <span class="type">unsigned</span> <span class="type">int</span> freq_out);</span><br><span class="line"><span class="type">int</span> (*set_jack)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_jack *jack,  <span class="type">void</span> *data);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DT */</span></span><br><span class="line"><span class="type">int</span> (*of_xlate_dai_name)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line"> <span class="keyword">struct</span> of_phandle_args *args,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> **dai_name);</span><br><span class="line"><span class="type">int</span> (*of_xlate_dai_id)(<span class="keyword">struct</span> snd_soc_component *comment,</span><br><span class="line">       <span class="keyword">struct</span> device_node *endpoint);</span><br><span class="line"><span class="type">void</span> (*seq_notifier)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line">     <span class="keyword">enum</span> snd_soc_dapm_type type, <span class="type">int</span> subseq);</span><br><span class="line"><span class="type">int</span> (*stream_event)(<span class="keyword">struct</span> snd_soc_component *component, <span class="type">int</span> event);</span><br><span class="line"><span class="type">int</span> (*set_bias_level)(<span class="keyword">struct</span> snd_soc_component *component,</span><br><span class="line">      <span class="keyword">enum</span> snd_soc_bias_level level);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_compr_ops</span> *<span class="title">compr_ops</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line"><span class="type">int</span> probe_order;</span><br><span class="line"><span class="type">int</span> remove_order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * signal if the module handling the component should not be removed</span></span><br><span class="line"><span class="comment"> * if a pcm is open. Setting this would prevent the module</span></span><br><span class="line"><span class="comment"> * refcount being incremented in probe() but allow it be incremented</span></span><br><span class="line"><span class="comment"> * when a pcm is opened and decremented when it is closed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> module_get_upon_open:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bits */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> idle_bias_on:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> suspend_bias_off:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> use_pmdown_time:<span class="number">1</span>; <span class="comment">/* care pmdown_time at stop */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> endianness:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> non_legacy_dai_naming:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* this component uses topology and ignore machine driver FEs */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *ignore_machine;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *topology_name_prefix;</span><br><span class="line"><span class="type">int</span> (*be_hw_params_fixup)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd,</span><br><span class="line">  <span class="keyword">struct</span> snd_pcm_hw_params *params);</span><br><span class="line"><span class="type">bool</span> use_dai_pcm_id;<span class="comment">/* use DAI link PCM ID as PCM device number */</span></span><br><span class="line"><span class="type">int</span> be_pcm_base;<span class="comment">/* base device ID for all BE PCMs */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>name: æ­¤ç»„ä»¶çš„åç§°å¯¹äºç¼–è§£ç å™¨å’Œ platform æ¥è¯´éƒ½æ˜¯å¿…é¡»çš„ï¼Œplatform å¯èƒ½ä¸éœ€è¦å…¶ä»–å­—æ®µ</li><li>probeï¼šç»„ä»¶é©±åŠ¨ probe å‡½æ•°ï¼Œç»„ä»¶ probe å‡½æ•°ï¼Œå½“ç»„ä»¶é©±åŠ¨è¢« mechine é©±åŠ¨ probe åˆ°æ—¶ï¼ˆå®é™…ä¸Šæ˜¯å½“ machine é©±åŠ¨å‘ ASOC core æ³¨å†Œä¸€ä¸ªç”±è¯¥ç»„ä»¶ç»„æˆçš„ card æ—¶ï¼‰æ‰§è¡Œï¼Œå¿…è¦æ—¶å®Œæˆç»„ä»¶åˆå§‹åŒ–</li><li>controlï¼šæ§åˆ¶æ¥å£æŒ‡é’ˆï¼Œå¦‚æ§åˆ¶éŸ³é‡ï¼Œé€šé“é€‰æ‹©ç­‰ï¼Œä¸»è¦ç”¨äºç¼–è§£ç å™¨</li><li>set_pll: è®¾ç½®é”ç›¸ç¯çš„å‡½æ•°æŒ‡é’ˆ</li><li>readï¼šè¯»å–ç¼–è§£ç å™¨å¯„å­˜å™¨çš„å‡½æ•°</li><li>writeï¼šå†™å…¥ç¼–è§£ç å™¨å¯„å­˜å™¨çš„å‡½æ•°</li><li>dapm_widget: dapm çš„ widget æŒ‡é’ˆ</li><li>dapm_routes: dapm è·¯ç”±æŒ‡é’ˆ</li><li>opsï¼š platform DMA ç›¸å…³å›è°ƒ</li></ul><p>æ­¤ç»“æ„ä½“åŒæ—¶æŠ½è±¡ç¼–è§£ç å™¨å’Œ Platform æœºå™¨ DAI é©±åŠ¨ç¨‹åº</p><h1 id="dai">DAI</h1><p>ç¼–è§£ç é©±åŠ¨ç¨‹åºåŒ…æ‹¬ç¼–è§£ç è®¾å¤‡æœ¬èº«å’Œ DAI ç»„ä»¶ï¼Œä»–ä»¬åœ¨ä¸ platform ç»‘å®šæ—¶ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_driver</span> {</span></span><br><span class="line"><span class="comment">/* DAI description */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> id;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> base;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* DAI driver callbacks */</span></span><br><span class="line"><span class="type">int</span> (*probe)(<span class="keyword">struct</span> snd_soc_dai *dai);</span><br><span class="line"><span class="type">int</span> (*remove)(<span class="keyword">struct</span> snd_soc_dai *dai);</span><br><span class="line"><span class="type">int</span> (*suspend)(<span class="keyword">struct</span> snd_soc_dai *dai);</span><br><span class="line"><span class="type">int</span> (*resume)(<span class="keyword">struct</span> snd_soc_dai *dai);</span><br><span class="line"><span class="comment">/* compress dai */</span></span><br><span class="line"><span class="type">int</span> (*compress_new)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd, <span class="type">int</span> num);</span><br><span class="line"><span class="comment">/* Optional Callback used at pcm creation*/</span></span><br><span class="line"><span class="type">int</span> (*pcm_new)(<span class="keyword">struct</span> snd_soc_pcm_runtime *rtd,</span><br><span class="line">       <span class="keyword">struct</span> snd_soc_dai *dai);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ops */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_cdai_ops</span> *<span class="title">cops</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* DAI capabilities */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">capture</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_pcm_stream</span> <span class="title">playback</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_rates:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_channels:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> symmetric_samplebits:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> bus_control:<span class="number">1</span>; <span class="comment">/* DAI is also used for the control bus */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* probe ordering - for components with runtime dependencies */</span></span><br><span class="line"><span class="type">int</span> probe_order;</span><br><span class="line"><span class="type">int</span> remove_order;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>name: DAI æ¥å£åç§°</li><li>probeï¼šdai probe å‡½æ•°ï¼Œå½“ machine é©±åŠ¨ç¨‹åº probe åˆ°è¯¥ dai é©±åŠ¨ç¨‹åºæ‰€å±çš„ç»„ä»¶é©±åŠ¨ç¨‹åºæ—¶ï¼ˆå®é™…æ˜¯ machine é©±åŠ¨ç¨‹åºå‘ ASOC core æ³¨å†Œ card æ—¶ï¼‰æ‰§è¡Œ</li><li>opsï¼šæä¾›ç”¨äºé…ç½®å’Œæ§åˆ¶ DAI çš„å›è°ƒå‡½æ•°</li><li>captureï¼šå®ƒè¡¨ç¤ºéŸ³é¢‘é‡‡é›†çš„ç¡¬ä»¶å‚æ•°ï¼ŒåŒ…æ‹¬é€šé“æ•°ã€rateã€format ç­‰</li><li>playbackï¼šå®ƒè¡¨ç¤ºéŸ³é¢‘å›æ”¾çš„ç¡¬ä»¶å‚æ•°ï¼ŒåŒ…æ‹¬é€šé“æ•°ã€rateã€format ç­‰</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_ops</span> {</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAI clocking configuration, all optional.</span></span><br><span class="line"><span class="comment"> * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*set_sysclk)(<span class="keyword">struct</span> snd_soc_dai *dai,</span><br><span class="line"><span class="type">int</span> clk_id, <span class="type">unsigned</span> <span class="type">int</span> freq, <span class="type">int</span> dir);</span><br><span class="line"><span class="type">int</span> (*set_pll)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> pll_id, <span class="type">int</span> source,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> freq_in, <span class="type">unsigned</span> <span class="type">int</span> freq_out);</span><br><span class="line"><span class="type">int</span> (*set_clkdiv)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> div_id, <span class="type">int</span> div);</span><br><span class="line"><span class="type">int</span> (*set_bclk_ratio)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">unsigned</span> <span class="type">int</span> ratio);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAI format configuration</span></span><br><span class="line"><span class="comment"> * Called by soc_card drivers, normally in their hw_params.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*set_fmt)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">unsigned</span> <span class="type">int</span> fmt);</span><br><span class="line"><span class="type">int</span> (*xlate_tdm_slot_mask)(<span class="type">unsigned</span> <span class="type">int</span> slots,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> *tx_mask, <span class="type">unsigned</span> <span class="type">int</span> *rx_mask);</span><br><span class="line"><span class="type">int</span> (*set_tdm_slot)(<span class="keyword">struct</span> snd_soc_dai *dai,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> tx_mask, <span class="type">unsigned</span> <span class="type">int</span> rx_mask,</span><br><span class="line"><span class="type">int</span> slots, <span class="type">int</span> slot_width);</span><br><span class="line"><span class="type">int</span> (*set_channel_map)(<span class="keyword">struct</span> snd_soc_dai *dai,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> tx_num, <span class="type">unsigned</span> <span class="type">int</span> *tx_slot,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> rx_num, <span class="type">unsigned</span> <span class="type">int</span> *rx_slot);</span><br><span class="line"><span class="type">int</span> (*get_channel_map)(<span class="keyword">struct</span> snd_soc_dai *dai,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> *tx_num, <span class="type">unsigned</span> <span class="type">int</span> *tx_slot,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> *rx_num, <span class="type">unsigned</span> <span class="type">int</span> *rx_slot);</span><br><span class="line"><span class="type">int</span> (*set_tristate)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> tristate);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*set_sdw_stream)(<span class="keyword">struct</span> snd_soc_dai *dai,</span><br><span class="line"><span class="type">void</span> *stream, <span class="type">int</span> direction);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAI digital mute - optional.</span></span><br><span class="line"><span class="comment"> * Called by soc-core to minimise any pops.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*digital_mute)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> mute);</span><br><span class="line"><span class="type">int</span> (*mute_stream)(<span class="keyword">struct</span> snd_soc_dai *dai, <span class="type">int</span> mute, <span class="type">int</span> stream);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ALSA PCM audio operations - all optional.</span></span><br><span class="line"><span class="comment"> * Called by soc-core during audio PCM operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*startup)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="type">int</span> (*hw_params)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_pcm_hw_params *, <span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="type">int</span> (*hw_free)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="type">int</span> (*prepare)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Commands passed to the trigger function are not necessarily</span></span><br><span class="line"><span class="comment"> * compatible with the current state of the dai. For example this</span></span><br><span class="line"><span class="comment"> * sequence of commands is possible: START STOP STOP.</span></span><br><span class="line"><span class="comment"> * So do not unconditionally use refcounting functions in the trigger</span></span><br><span class="line"><span class="comment"> * function, e.g. clk_enable/disable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*trigger)(<span class="keyword">struct</span> snd_pcm_substream *, <span class="type">int</span>,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="type">int</span> (*bespoke_trigger)(<span class="keyword">struct</span> snd_pcm_substream *, <span class="type">int</span>,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For hardware based FIFO caused delay reporting.</span></span><br><span class="line"><span class="comment"> * Optional.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">snd_pcm_sframes_t</span> (*delay)(<span class="keyword">struct</span> snd_pcm_substream *,</span><br><span class="line"><span class="keyword">struct</span> snd_soc_dai *);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><strong>ç¬¬ä¸€ç±»ï¼šæ—¶é’Ÿé…ç½®å›è°ƒå‡½æ•°</strong></p><ul><li>set_sysclk: è®¾ç½® DAI çš„ä¸»æ—¶é’Ÿ</li><li>set_pll: è®¾ç½® PLL å‡½æ•°</li><li>set_clkdiv: è®¾ç½®æ—¶é’Ÿåˆ†é¢‘å€¼</li></ul><p><strong>ç¬¬äºŒç±»ï¼šDAI çš„æ ¼å¼é…ç½®å‡½æ•°</strong></p><ul><li>set_fmt: è®¾ç½® DAI çš„æ ¼å¼</li><li>set_tdm_slot: è®¾ç½® TDM çš„æ—¶éš™</li><li>set_channel_map: é€šé“ TDM çš„æ˜ å°„è®¾ç½® machine é©±åŠ¨é€šè¿‡ snd_soc_dai_set_channel_map è°ƒç”¨</li><li>set_tristate: è®¾ç½® DAI å¼•è„šçš„çŠ¶æ€ï¼Œåœ¨äºå…¶ä»– DAI å¹¶è¡Œä½¿ç”¨åŒä¸€å¼•è„šæ—¶éœ€è¦ä½¿ç”¨è¯¥çŠ¶æ€</li></ul><p><strong>ç¬¬ä¸‰ç±»ï¼šæ™®é€šçš„æ ‡å‡†å‰ç«¯</strong></p><ul><li>startupï¼šæ‰“å¼€é‡‡é›†/å›æ”¾è®¾å¤‡æ—¶ï¼Œåœ¨æ‰“å¼€ PCM å­æµæ—¶ç”± ALSA è°ƒç”¨</li><li>hw_paramsï¼šè®¾ç½®éŸ³é¢‘æµæ—¶è°ƒç”¨</li><li>prepareï¼šå½“ PCM å‡†å¤‡å¥½æ—¶è°ƒç”¨</li><li>triggerï¼š PCM å¯åŠ¨ã€åœæ­¢ã€æš‚åœæ—¶è°ƒç”¨</li></ul><h1 id="control">Control</h1><p>ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºé€šå¸¸éœ€è¦å…¬å¼€ä¸€äº›å¯ä»¥ä»ç”¨æˆ·ç©ºé—´æ›´æ”¹çš„ç¼–è§£ç å™¨å±æ€§ï¼Œè¿™äº›å°±æ˜¯ç¼–è§£ç å™¨æ§ä»¶ï¼ˆcontrolï¼‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> {</span></span><br><span class="line"><span class="type">snd_ctl_elem_iface_t</span> iface;<span class="comment">/* interface identifier */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> device;<span class="comment">/* device/client number */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> subdevice;<span class="comment">/* subdevice (substream) number */</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *name;<span class="comment">/* ASCII name of item */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> index;<span class="comment">/* index of item */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> access;<span class="comment">/* access rights */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> count;<span class="comment">/* count of same elements */</span></span><br><span class="line"><span class="type">snd_kcontrol_info_t</span> *info;</span><br><span class="line"><span class="type">snd_kcontrol_get_t</span> *get;</span><br><span class="line"><span class="type">snd_kcontrol_put_t</span> *put;</span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="type">snd_kcontrol_tlv_rw_t</span> *c;</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> *p;</span><br><span class="line">} tlv;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private_value;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>iface : æ§ä»¶ç±»å‹ å¯èƒ½æ˜¯ç®€å•å¼€å…³æ§ä»¶ã€ç«‹ä½“å£°æ§ä»¶ï¼ˆStereoï¼‰ã€æ··éŸ³å™¨ï¼ˆMIXERï¼‰ã€MUX æ§ä»¶ç­‰</li><li>nameï¼š æ§ä»¶åç§°ï¼Œå‘½ååŒ…å«æºï¼ˆMasterã€PCMã€CDã€Lineï¼‰ã€æ–¹å‘ï¼ˆplaybackã€captureã€Bypassï¼‰ä»¥åŠåŠŸèƒ½ï¼ˆswitchã€volumeã€route ç­‰ï¼‰</li><li>access : æ§ä»¶è®¿é—®æƒé™ï¼ŒREADã€WRITEã€VOLATILE ç­‰</li><li>get : è¯»å–æ§ä»¶çš„å½“å‰å€¼å¹¶è¿”å›ç»™ç”¨æˆ·ç©ºé—´</li><li>put : æŒ‰ç…§åº”ç”¨ç¨‹åºè¦æ±‚è®¾ç½®æ§ä»¶å€¼</li><li>tlv : ä¸ºæ§ä»¶æä¾›å…ƒæ•°æ®ï¼Œæœ‰äº›æ··éŸ³å™¨æ§ä»¶éœ€è¦ä»¥åˆ†è´ï¼ˆdbï¼‰ä¸ºå•ä½æä¾›ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ DECLARE_TLV_xxx å®å®šä¹‰ä¸€äº›åŒ…å«è¿™äº›ä¿¡æ¯çš„å˜é‡ï¼Œç„¶åå°†æ§åˆ¶ tlv.p å­—æ®µæŒ‡å‘çš„å˜é‡ï¼Œtlv æ˜¯ç±»å‹-é•¿åº¦-å€¼ï¼ˆtype-length-valueï¼‰æ˜¯ä¸€ç§ç¼–ç æ–¹æ¡ˆã€‚</li></ul><h2 id="è®¾ç½®å¼€å…³æ§ä»¶">è®¾ç½®å¼€å…³æ§ä»¶</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOC_SINGLE(xname, reg,shift.max,invert)</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç§ç±»å‹çš„æ§ä»¶åªæœ‰ä¸€ä¸ªè®¾ç½®ï¼Œä¸€èˆ¬ç”¨äºç»„ä»¶å¼€å…³</p><h2 id="è®¾ç½®å¸¦æœ‰éŸ³é‡çº§åˆ«çš„å¼€å…³">è®¾ç½®å¸¦æœ‰éŸ³é‡çº§åˆ«çš„å¼€å…³</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOC_SINGLE_TLV(name, reg,shift.max,invert,tlv_array)</span><br></pre></td></tr></tbody></table></figure><p>ç”¨äºå®šä¹‰å…·æœ‰å¢ç›Šçš„æ§ä»¶ï¼Œå¦‚éŸ³é‡æ§ä»¶ã€EQ å‡è¡¡å™¨ç­‰</p><h2 id="ç«‹ä½“å£°æ§ä»¶">ç«‹ä½“å£°æ§ä»¶</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOC_DOUBLE_R(xname, reg_left,reg_right,xshift,xmax,xinvert)</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸€ä¸ªå¯„å­˜å™¨ä¸­æ§åˆ¶ä¸¤ä¸ªç›¸ä¼¼çš„å˜é‡ï¼Œå› æ­¤å¯ä»¥åŒæ—¶æ§åˆ¶å·¦å³å£°é“</p><h2 id="å¸¦éŸ³é‡çº§åˆ«çš„ç«‹ä½“å£°æ§ä»¶">å¸¦éŸ³é‡çº§åˆ«çš„ç«‹ä½“å£°æ§ä»¶</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOC_DOUBLE_R_TLV(xname, reg_left,reg_right,xshift,xmax,xinvert,tlv_array)</span><br></pre></td></tr></tbody></table></figure><h2 id="æ··éŸ³å™¨æ§ä»¶">æ··éŸ³å™¨æ§ä»¶</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SOC_SINGLE(<span class="string">"Input Switch"</span>, WM8960_SPEAKER_MIXER,<span class="number">7</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">SOC_SINGLE(<span class="string">"Output Switch"</span>, WM8960_SPEAKER_MIXER,<span class="number">3</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">SOC_SINGLE(<span class="string">"DAC Switch"</span>, WM8960_SPEAKER_MIXER,<span class="number">6</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br></pre></td></tr></tbody></table></figure><h1 id="dapmdynamic-audio-power-management">DAPM(dynamic audio power management)</h1><h2 id="widget">widget</h2><p>æ™®é€š kcontrol å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>è‡ªæˆ‘æè¿°ï¼Œæ— æ³•æè¿°æ¯ä¸ª kcontrol ä¹‹é—´çš„å…³ç³»</li><li>ç¼ºä¹ç”µæºç®¡ç†æœºåˆ¶</li><li>ç¼ºä¹å“åº”å›æ”¾ã€åœæ­¢ã€å¼€æœºã€å…³æœºç­‰éŸ³é¢‘äº‹ä»¶çš„æ—¶é—´å¤„ç†æœºåˆ¶</li><li>ç¼ºå°‘çˆ†éŸ³é˜²æ­¢æœºåˆ¶</li><li>æ— æ³•è‡ªåŠ¨å…³é—­éŸ³é¢‘è·¯å¾„ä¸­æ¶‰åŠçš„æ‰€æœ‰æ§ä»¶</li></ul><p>ä¸ºè§£å†³ä»¥ä¸Šé—®é¢˜ï¼ŒDAPM å¼•å…¥ widgetï¼Œwidget æ˜¯ kcontrol çš„è¿›ä¸€æ­¥å‡çº§å’Œå°è£…ã€‚ </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">snd_soc_dapm_type</span> <span class="title">id</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;<span class="comment">/* widget name */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *sname;<span class="comment">/* stream name */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *priv;<span class="comment">/* widget specific data */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">regulator</span> *<span class="title">regulator</span>;</span><span class="comment">/* attached regulator */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">pinctrl</span>;</span><span class="comment">/* attached pinctrl */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dapm control */</span></span><br><span class="line"><span class="type">int</span> reg;<span class="comment">/* negative reg = no direct dapm */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shift;<span class="comment">/* bits to shift */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mask;<span class="comment">/* non-shifted mask */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> on_val;<span class="comment">/* on state value */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> off_val;<span class="comment">/* off state value */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> power:<span class="number">1</span>;<span class="comment">/* block power status */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> active:<span class="number">1</span>;<span class="comment">/* active stream on DAC, ADC's */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> connected:<span class="number">1</span>;<span class="comment">/* connected codec pin */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> new:<span class="number">1</span>;<span class="comment">/* cnew complete */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> force:<span class="number">1</span>;<span class="comment">/* force state */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ignore_suspend:<span class="number">1</span>;         <span class="comment">/* kept enabled over suspend */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> new_power:<span class="number">1</span>;<span class="comment">/* power from this run */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> power_checked:<span class="number">1</span>;<span class="comment">/* power checked this run */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> is_supply:<span class="number">1</span>;<span class="comment">/* Widget is a supply type widget */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> is_ep:<span class="number">2</span>;<span class="comment">/* Widget is a endpoint type widget */</span></span><br><span class="line"><span class="type">int</span> subseq;<span class="comment">/* sort within widget type */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*power_check)(<span class="keyword">struct</span> snd_soc_dapm_widget *w);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* external events */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> event_flags;<span class="comment">/* flags to specify event types */</span></span><br><span class="line"><span class="type">int</span> (*event)(<span class="keyword">struct</span> snd_soc_dapm_widget*, <span class="keyword">struct</span> snd_kcontrol *, <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* kcontrols that relate to this widget */</span></span><br><span class="line"><span class="type">int</span> num_kcontrols;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">kcontrol_news</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> **<span class="title">kcontrols</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* widget input and output edges */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">edges</span>[2];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* used during DAPM updates */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">work_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">power_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dirty</span>;</span></span><br><span class="line"><span class="type">int</span> endpoints[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> channel;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>id: widget ç±»å‹ï¼Œå¦‚ snd_soc_dapm_outputã€snd_soc_dapm_mixer ç­‰</li><li>name:widget åç§°</li><li>shift å’Œ maskï¼šç”¨äºæ§åˆ¶ widget çš„ç”µæºçŠ¶æ€ï¼Œå¯¹åº”å¯„å­˜å™¨åœ°å€ reg</li><li>on_val å’Œ off_valï¼šè¡¨ç¤ºæ›´æ”¹ widget å½“å‰ç”µæºçŠ¶æ€çš„å€¼</li><li>eventï¼šè¡¨ç¤º DAPM äº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°æŒ‡é’ˆ</li><li>kcontrol_newsï¼šç»„æˆè¯¥ kcontrol çš„æ§ä»¶æ•°ç»„</li><li>dirtyï¼šå½“ widget çŠ¶æ€æ”¹å˜æ—¶ï¼Œdirty ç”¨äºå°†è¿™ä¸ª widget æ’å…¥åˆ° dirty åˆ—è¡¨ä¸­ï¼Œç„¶åæ‰«ææ•´ä¸ªåˆ—è¡¨æ‰§è¡Œæ•´ä¸ªè·¯å¾„çš„æ›´æ–°</li></ul><h2 id="å®šä¹‰-widget">å®šä¹‰ widget</h2><p>æœ‰å¾ˆå¤šå®å®šä¹‰æ¥å®šä¹‰ widget æ§ä»¶ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>ç¼–è§£ç åŸŸï¼šå¦‚ VREF å’Œ VMIDï¼Œå¯ä»¥æä¾›å‚è€ƒç”µå‹ widget</li><li>platform/machine domainï¼šéœ€è¦ç‰©ç†è¿æ¥çš„ platfoem æˆ–æ¿å¡çš„è¾“å…¥è¾“å‡ºæ¥å£ï¼Œå¦‚è€³æœºã€æ‰¬å£°å™¨ã€éº¦å…‹é£ç­‰</li><li>éŸ³é¢‘è·¯å¾„åŸŸï¼šæŒ‡åœ¨ç¼–è§£ç å™¨ä¸­æ§åˆ¶éŸ³é¢‘è·¯å¾„çš„ MUXã€Mixer å’Œå…¶ä»– widget</li><li>éŸ³é¢‘æµåŸŸï¼šå¤„ç†éŸ³é¢‘æµæ•°æ®ï¼Œå¦‚ ADCã€DAC ç­‰</li></ul><h2 id="è·¯å¾„çš„æ¦‚å¿µ--widget-ä¹‹é—´çš„è¿æ¥å™¨">è·¯å¾„çš„æ¦‚å¿µ--widget ä¹‹é—´çš„è¿æ¥å™¨</h2><p>ç”± struct snd_soc_dapm_path ç»“æ„ä½“è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“è¡¨ç¤ºä¸¤ä¸ª widget ä¹‹é—´çš„è¿æ¥ï¼Œä»–çš„ source å­—æ®µæŒ‡å‘è¿æ¥çš„å¼€å§‹ widgetï¼Œè€Œ sink å­—æ®µåˆ™æŒ‡å‘è¿æ¥åˆ°è¾¾çš„ widgetã€‚æ‰€æœ‰è¾“å…¥ç«¯ç‚¹çš„ snd_soc_dapm_path è¿æ¥åˆ° list_node[SND_SOC_DAPM_DIR_IN] åˆ—è¡¨ä¸­ï¼Œæ‰€æœ‰è¾“å‡ºç«¯ç‚¹çš„ snd_soc_dapm_path è¿æ¥åˆ° list_node[SND_SOC_DAPM_DIR_OUT] åˆ—è¡¨ä¸­ã€‚</p><h2 id="è·¯ç”±çš„æ¦‚å¿µ--widget-äº’è”">è·¯ç”±çš„æ¦‚å¿µ--widget äº’è”</h2><p>ä¸ºäº†ä¸æƒ³å¤„ç† pathï¼Œå¼•å…¥ route æ¦‚å¿µï¼Œè·¯ç”±è‡³å°‘åŒ…æ‹¬ï¼Œèµ·å§‹ widgetï¼Œè·³çº¿è·¯å¾„ jumper path å’Œæ¥æ”¶æ–¹ widger ç»„æˆï¼Œä½¿ç”¨ struct snd_soc_dapm_route è¡¨ç¤ºã€‚ </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *sink;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *control;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *source;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Note: currently only supported for links where source is a supply */</span></span><br><span class="line"><span class="type">int</span> (*connected)(<span class="keyword">struct</span> snd_soc_dapm_widget *source,</span><br><span class="line"> <span class="keyword">struct</span> snd_soc_dapm_widget *sink);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dobj</span> <span class="title">dobj</span>;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>sink: æŒ‡å‘åˆ°è¾¾ widget çš„åç§°ä¸²</li><li>sourceï¼šæŒ‡å‘èµ·å§‹ widget çš„åç§°ä¸²</li><li>controlï¼šæŒ‡å‘è´Ÿè´£æ§åˆ¶è¿æ¥çš„ kcontrol åç§°ä¸²</li><li>connectedï¼šå®šä¹‰äº†è‡ªå®šä¹‰è¿æ¥æ£€æŸ¥çš„å›è°ƒå‡½æ•°</li></ul><p>source é€šè¿‡ kcontrol è¿æ¥åˆ° sinkï¼Œå¯ä»¥è°ƒç”¨ connected æ£€æŸ¥è¿æ¥çŠ¶æ€</p><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>å‰é¢åˆ—å‡ºäº†ä¸€äº›å…³é”®æ•°æ®ç»“æ„ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šå…¶ä»–å…³é”®æ•°æ®ç»“æ„ï¼Œä»¥åŠå„æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»æ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œä¸‹é¢åªé€šè¿‡ä¸€å‰¯å›¾ç‰‡æ¥å°†ç›¸å…³æ•°æ®ç»“æ„ä»¥åŠä»–ä»¬ä¹‹é—´çš„å…³ç³»åˆ—å‡ºæ¥ã€‚</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjVkMmI0ZjdlYTRjMTcwMjJmYzY0YzQx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/asoc_codec.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ ALSAï¼ˆä¸€ï¼‰æ¦‚è¿°</title>
      <link href="/2024/LinuxDriver/LinuxAudioALSASummer/"/>
      <url>/2024/LinuxDriver/LinuxAudioALSASummer/</url>
      
        <content type="html"><![CDATA[<h1 id="asoc">ASOC</h1><p>ALSA æ˜¯ä¸ºæ¡Œé¢è®¡ç®—æœºè€Œè®¾è®¡çš„ï¼Œæ²¡æœ‰è€ƒè™‘åµŒå…¥å¼è®¾å¤‡çš„é™åˆ¶ï¼Œåœ¨å¤„ç†åµŒå…¥å¼è®¾å¤‡æ—¶ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå¦‚ä¸‹ï¼š</p><ul><li>ç¼–è§£ç å™¨å’Œ CPU ä¹‹é—´çš„è€¦åˆå¤ªå¼ºï¼Œå¯¼è‡´ä»£ç ç§»æ¤å›°éš¾ã€‚</li><li>æ²¡æœ‰å¤„ç†ç”¨æˆ·éŸ³é¢‘ç›¸å…³è¡Œä¸ºé€šçŸ¥çš„æ ‡å‡†æ–¹æ³•ï¼Œåœ¨ç§»åŠ¨åœºæ™¯ä¸­ï¼Œç”¨æˆ·çš„ç›¸å…³éŸ³é¢‘æ“ä½œå¾ˆé¢‘ç¹ã€‚</li><li>åœ¨æœ€åˆçš„ ALSA è®¾ç½®ä¸­æ²¡æœ‰è€ƒè™‘ PM æœºåˆ¶ã€‚</li></ul><p>ASOC å°±æ˜¯ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜è€Œäº§ç”Ÿçš„ã€‚ALSAï¼ˆALSA system on chipï¼Œ ASOCï¼‰å±‚çš„ç›®çš„æ˜¯ä¸ºåµŒå…¥å¼å¤„ç†å™¨å’Œå„ç§ç¼–è§£ç å™¨æä¾›æ›´å¥½çš„ ALSA æ”¯æŒã€‚ASOC å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>ç‹¬ç«‹çš„ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åºã€‚</li><li>æ›´æ–¹ä¾¿çš„é…ç½® CPU å’Œç¼–è§£ç å™¨åŠ¨æ€éŸ³é¢‘ç”µæºç®¡ç†ï¼ˆdynamic audio power managementï¼Œ DAPMï¼‰ä¹‹é—´çš„éŸ³é¢‘æ•°æ®æ¥å£ã€‚</li><li>å‡å°‘å¼¹å‡ºå’Œç‚¹å‡»æ“ä½œï¼Œå¹¶å¢åŠ ä¸å¹³å°ç›¸å…³çš„æ§ä»¶ã€‚</li></ul><span id="more"></span><p>ä¸ºäº†å®ç°ä¸Šè¿°åŠŸèƒ½ï¼ŒASoC å°†åµŒå…¥å¼éŸ³é¢‘ç³»ç»Ÿåˆ’åˆ†ä¸º 3 ä¸ªå¯é‡ç”¨çš„ç»„ä»¶é©±åŠ¨ç¨‹åºï¼Œå³æœºå™¨ç±»ï¼ˆmachine classï¼‰ã€å¹³å°ç±»ï¼ˆplatform classï¼‰å’Œç¼–è§£ç å™¨ç±»ï¼ˆcodecï¼‰ã€‚å…¶ä¸­ï¼Œå¹³å°ç±»å’Œç¼–è§£ç å™¨ç±»æ˜¯è·¨å¹³å°ï¼ˆcross-platformï¼‰çš„ï¼Œè€Œæœºå™¨ç±»æ˜¯æ¿çº§çš„ï¼ˆboard-specificï¼‰ã€‚</p><h1 id="asoc-æ•°å­—éŸ³é¢‘æ¥å£">ASoC æ•°å­—éŸ³é¢‘æ¥å£</h1><p>æ•°å­—éŸ³é¢‘æ¥å£ï¼ˆdigital audio interfaceï¼ŒDAIï¼‰æ˜¯ä¸€ç§æ€»çº¿æ§åˆ¶å™¨ï¼Œå®ƒå¯ä»¥å°†éŸ³é¢‘æ•°æ®ä»ä¸€ç«¯ï¼ˆå¦‚ SoCï¼‰ä¼ é€åˆ°å¦ä¸€ç«¯ï¼ˆç¼–è§£ç å™¨ï¼‰ã€‚ASoC å½“å‰æ”¯æŒ SoC æ§åˆ¶å™¨å’Œä¾¿æºå¼éŸ³é¢‘ç¼–è§£ç å™¨ä¸Šçš„å¤§å¤šæ•° DAIï¼Œå¦‚ AC97ã€I2Sã€PCMã€S/PDIF å’Œ TDMã€‚</p><h2 id="i2s">I2S</h2><p>I2S å…¨ç§° Inter-IC Sond Busï¼Œæ˜¯é£åˆ©æµ¦åœ¨ 1986 å¹´å®šä¹‰ (1996 å¹´ä¿®è®¢ï¼‰çš„æ•°å­—éŸ³é¢‘ä¼ è¾“æ ‡å‡†ï¼Œç”¨äºæ•°å­—éŸ³é¢‘æ•°æ®åœ¨ç³»ç»Ÿå†…éƒ¨å™¨ä»¶ä¹‹é—´ä¼ è¾“ï¼Œä¾‹å¦‚ç¼–è§£ç å™¨ Codecã€DSPã€æ•°å­—è¾“å…¥/è¾“å‡ºæ¥å£ã€ADCã€DAC å’Œæ•°å­—æ»¤æ³¢å™¨ç­‰ã€‚ å¯¹äº I2S çš„æ•°å­—æ¥å£å®šä¹‰ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰ä»åœ°å€æˆ–è€…ä»è®¾å¤‡çš„æ¦‚å¿µï¼Œåœ¨ I2S æ€»çº¿ä¸Šï¼Œåªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªä¸»è®¾å¤‡å’Œå‘é€è®¾å¤‡ã€‚åœ¨ I2S ç³»ç»Ÿä¸­ï¼Œæä¾›æ—¶é’Ÿï¼ˆSCKï¼‰çš„è®¾å¤‡ä¸ºä¸»è®¾å¤‡ï¼Œå…¶å¸¸è§çš„ç³»ç»Ÿæ¡†å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/iis.png"></p><p>åœ¨ I2S ä¼ è¾“åè®®ä¸­ï¼Œæ•°æ®ä¿¡å·ã€æ—¶é’Ÿä¿¡å·ä»¥åŠæ§åˆ¶ä¿¡å·æ˜¯åˆ†å¼€ä¼ è¾“çš„ã€‚I2S åè®®åªå®šä¹‰ä¸‰æ ¹ä¿¡å·çº¿ï¼šæ—¶é’Ÿä¿¡å· SCKã€æ•°æ®ä¿¡å· SD å’Œå·¦å³å£°é“é€‰æ‹©ä¿¡å· WSã€‚</p><ul><li><p>SCLKï¼š<br>æ—¶é’Ÿä¿¡å·ï¼šæ¨¡å—å†…çš„åŒæ­¥ä¿¡å·ï¼Œä¸»æ¨¡å¼æ—¶ç”±æ¨¡å—å†…éƒ¨è‡ªå·±äº§ç”Ÿï¼Œä»æ¨¡å¼ç”±å¤–éƒ¨æä¾›</p></li><li><p>SDï¼š<br>æ•°æ®ä¿¡å·ï¼šåœ¨ WS å˜åŒ–åçš„ç¬¬ä¸€ä¸ª SCK è„‰å†²ï¼Œå…ˆä¼ è¾“æœ€é«˜ä½ï¼ˆMSB, Most Significant Bitï¼‰ã€‚å…ˆä¼ é€ MSB æ˜¯å› ä¸ºå‘é€è®¾å¤‡å’Œæ¥æ”¶è®¾å¤‡çš„å­—é•¿å¯èƒ½ä¸åŒ</p></li><li><p>WSï¼š<br>å·¦å³å£°é“é€‰æ‹©ä¿¡å· Word Select:WSï¼0ï¼Œè¡¨ç¤ºé€‰æ‹©å·¦å£°é“ï¼›WSï¼1ï¼Œè¡¨ç¤ºé€‰æ‹©å³å£°é“ã€‚WS ä¹Ÿç§°å¸§æ—¶é’Ÿï¼Œå³ LRCLK/Left Right Clockã€‚WS é¢‘ç‡ç­‰äºå£°éŸ³çš„é‡‡æ ·ç‡</p></li></ul><!--more--><p>å…¶æ•°æ®ä¼ è¾“çš„æ–¹å¼å¦‚ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/iis_format.png"></p><h2 id="pcmtdm">PCM/TDM</h2><p>PCM = Pulse Code Modulation æ˜¯é€šè¿‡ç­‰æ—¶é—´éš”ï¼ˆå³é‡‡æ ·ç‡æ—¶é’Ÿå‘¨æœŸï¼‰é‡‡æ ·å°†æ¨¡æ‹Ÿä¿¡å·æ•°å­—åŒ–çš„æ–¹æ³•ã€‚ä¸‹å›¾æ˜¯ 4bit é‡‡æ ·é€Ÿç‡çš„ PCM æ•°æ®é‡åŒ–ç¤ºæ„å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/pcm.png"></p><p>PCM æ¥å£å¸¸ç”¨äºæ¿çº§éŸ³é¢‘æ•°å­—ä¿¡å·çš„ä¼ è¾“ï¼Œä¸ I2S ç±»ä¼¼ï¼Œå…¶å® I2S ä¹Ÿæ˜¯ PCM çš„ä¸€ç§ç‰¹ä¾‹æ¥å£ï¼Œåªä¸è¿‡ï¼ŒI2S çš„é€Ÿç‡ä¼šæ›´é«˜ï¼Œæ¯”è¾ƒé€‚ç”¨äºä¼ éŸ³ä¹ã€‚è€Œ PCM é€šå¸¸ç”¨äº AP å¤„ç†å™¨ä¸é€šä¿¡ MODEM ä¹‹é—´çš„è¯­è¨€æ•°æ®ä¼ è¾“ï¼ˆå°±æ˜¯åŒå‘æ‰“ç”µè¯æ•°æ®ï¼‰ï¼Œå¯¹äº I2S åªèƒ½ä¼  2 ä¸ªå£°é“çš„æ•°æ®ï¼Œè€Œ PCM å¯ä»¥ä¼ å¤šè¾¾ 16 è·¯æ•°æ®ï¼Œé‡‡ç”¨æ—¶åˆ†å¤ç”¨çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ TDMã€‚å…¶æ¥å£ä¸ I2S ç±»ä¼¼ï¼Œç”µè·¯ä¿¡å·ä¸ºï¼š</p><ul><li>PCM_CLK æ•°æ®æ—¶é’Ÿä¿¡å·</li><li>PCM_SYNC å¸§åŒæ­¥æ—¶é’Ÿä¿¡å·</li><li>PCM_IN æ¥æ”¶æ•°æ®ä¿¡å·</li><li>PCM_OUT å‘é€æ•°æ®ä¿¡å·</li></ul><h2 id="pdm">PDM</h2><p>PDM(Pulse Density Modulation) æ˜¯ä¸€ç§æ•°å­—ä¿¡å·è¡¨ç¤ºæ¨¡æ‹Ÿä¿¡å·çš„è°ƒåˆ¶æ–¹æ³•ï¼Œå£°éŸ³é€šè¿‡ä¼ æ„Ÿå™¨è·å¾—æ¨¡æ‹Ÿä¿¡å·ï¼Œç»è¿‡ ADï¼Œå¾—åˆ°éŸ³é¢‘æ•°å­—ä¿¡å·ï¼Œç„¶åç»è¿‡ PDM è„‰å†²è½¬æ¢æˆæ•°å­—ä¿¡å·ã€‚PDM ä½¿ç”¨è¿œé«˜äº PCM é‡‡æ ·ç‡çš„æ—¶é’Ÿé‡‡ç”¨è°ƒåˆ¶æ¨¡æ‹Ÿåˆ†é‡ï¼Œåªæœ‰ 1 ä½è¾“å‡ºï¼Œè¦ä¹ˆæ˜¯ 0ï¼Œè¦ä¹ˆæ˜¯ 1ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/pdm.png"></p><p>PDM æ–¹å¼çš„é€»è¾‘ç›¸å¯¹å¤æ‚ï¼Œä½†åªéœ€è¦ä¸¤æ ¹çº¿ï¼Œæ—¶é’Ÿå’Œæ•°æ®ã€‚å¯¹äºä¸‹å›¾ï¼Œä¸»è®¾å¤‡ä¸ºä¸¤ä¸ªä»è®¾å¤‡æä¾›æ—¶é’Ÿï¼Œåˆ†åˆ«åœ¨æ—¶é’Ÿçš„ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿è§¦å‘é€‰æ‹© Source 1/2 ä½œä¸ºæ•°æ®è¾“å…¥ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/pdm_source.png"></p><p>PDM åœ¨è¯¸å¦‚æ‰‹æœºå’Œå¹³æ¿ç­‰å¯¹äºç©ºé—´é™åˆ¶ä¸¥æ ¼çš„åœºåˆæœ‰ç€å¹¿æ³›çš„åº”ç”¨å‰æ™¯ã€‚åœ¨æ•°å­—éº¦å…‹é£é¢†åŸŸï¼Œåº”ç”¨æœ€å¹¿çš„å°±æ˜¯ PDM æ¥å£ï¼Œå…¶æ¬¡ä¸º I2S æ¥å£ã€‚</p><h2 id="spdif">S/PDIF</h2><p>S/PDIF çš„å…¨ç§°æ˜¯ Sony/Philips Digital Interface Formatï¼Œç”±äºè¢«å¹¿æ³›é‡‡ç”¨ï¼Œå®ƒæˆä¸ºäº‹å®ä¸Šçš„æ°‘ç”¨æ•°å­—éŸ³é¢‘æ ¼å¼æ ‡å‡†ï¼Œå¤§é‡çš„æ¶ˆè´¹ç±»éŸ³é¢‘æ•°å­—äº§å“å¦‚æ°‘ç”¨ CD æœºã€DATã€MD æœºã€è®¡ç®—æœºå£°å¡æ•°å­—å£ç­‰éƒ½æ”¯æŒ S/PDIFï¼Œåœ¨ä¸å°‘ä¸“ä¸šè®¾å¤‡ä¸Šä¹Ÿæœ‰è¯¥æ ‡å‡†çš„æ¥å£ã€‚å°±ä¼ è¾“æ–¹å¼è€Œè¨€ï¼ŒSPDIF åˆ†ä¸ºè¾“å‡ºï¼ˆSPDIF OUTï¼‰å’Œè¾“å…¥ï¼ˆSPDIF INï¼‰ä¸¤ç§ã€‚</p><h1 id="asoc-å­å…ƒç´ ">ASOC å­å…ƒç´ </h1><ul><li>å¹³å°ï¼ˆplatformï¼‰ï¼šè¿™æ˜¯æŒ‡ SoC çš„éŸ³é¢‘ DMA å¼•æ“ï¼Œå¦‚ i.MXã€Rockchip å’Œ STM32ã€‚å¹³å°ç±»é©±åŠ¨ç¨‹åºå¯ä»¥ç»†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå¦‚ä¸‹æ‰€è¿°ï¼š<ul><li>CPU DAI é©±åŠ¨ç¨‹åºï¼šåœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œå®ƒé€šå¸¸æ˜¯æŒ‡ CPU çš„éŸ³é¢‘æ€»çº¿æ§åˆ¶å™¨ï¼Œå¦‚ã€I2Sã€S/PDIFã€AC97 å’Œ PCM æ€»çº¿æ§åˆ¶å™¨ï¼Œæœ‰æ—¶å¯èƒ½ä¼šé›†æˆåˆ°ä¸€ä¸ªæ›´å¤§çš„æ¨¡å—ä¸­ï¼Œå³ä¸²è¡ŒéŸ³é¢‘æ¥å£ï¼ˆserialaudiointerfaceï¼ŒSAï¼‰</li><li>PCM DMA é©±åŠ¨ç¨‹åºï¼šPCM é©±åŠ¨ç¨‹åºä¸å¹³å°æ— å…³ï¼Œä»…ä¸ SOCDMA å¼•æ“ä¸Šæ¸¸ API äº¤äº’</li></ul></li><li><p>ç¼–è§£ç å™¨ï¼ˆcodecï¼‰ï¼šé™¤äº†ç¼–è§£ç åŠŸèƒ½å¤–è¿˜åŒ…æ‹¬ AIFã€DACã€ADCã€Mixerã€PGAã€Lin-inã€Lin-outã€‚ä¸€äº›é«˜ç«¯èŠ¯ç‰‡è¿˜å…·æœ‰å›å£°æ¶ˆé™¤ã€å™ªå£°æŠ‘åˆ¶å’Œå…¶ä»–ç»„ä»¶ã€‚</p></li><li><p>æœºå™¨ï¼ˆmachineï¼‰ï¼šç³»ç»Ÿçº§è¡¨ç¤ºï¼Œé“¾æ¥ä¸¤ä¸ªéŸ³é¢‘æ¥å£ï¼ˆcpu_dai å’Œ codec daiï¼‰ï¼Œè¯¥é“¾æ¥åœ¨å†…æ ¸é€šè¿‡ struct snd_soc_dai_link å®ä¾‹æŠ½è±¡å‡ºæ¥ã€‚</p></li></ul><h1 id="æ¡†æ¶">æ¡†æ¶</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Audio/ALSA_Framework1.png"></p><ul><li><p>alsa-utilsï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ ALSA å®ç”¨ç¨‹åºåŒ…ç”± Linux ç¤¾åŒºæä¾›ï¼ŒåŒ…å« ALSA é¡¹ç›®çš„å‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼ˆaplayã€arecordã€amixerã€alsamixer ...ï¼‰ã€‚</p></li><li><p>alsa-libï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ ALSA åº“åŒ…å«éœ€è¦è®¿é—® ALSA å£°éŸ³æ¥å£çš„ç¨‹åºï¼ˆä¾‹å¦‚ alsa-utils ç¨‹åºï¼‰ä½¿ç”¨çš„ ALSA åº“ã€‚ALSA åº“åœ¨å†…æ ¸æ¨¡å—æä¾›çš„éŸ³é¢‘è®¾å¤‡ä¸Šæä¾›äº†ä¸€å®šç¨‹åº¦çš„æŠ½è±¡ï¼Œä¾‹å¦‚ PCM å’Œæ§åˆ¶æŠ½è±¡ ã€‚</p></li><li><p>ALSA Frameworkï¼ˆå†…æ ¸ç©ºé—´ï¼‰ ALSA æ ¸å¿ƒæä¾›äº†ä¸€ä¸ª API æ¥å®ç°éŸ³é¢‘é©±åŠ¨ç¨‹åºå’Œ PCM/æ§åˆ¶æ¥å£ï¼Œä»¥åœ¨ç”¨æˆ·ç©ºé—´ä¸Šå…¬å¼€éŸ³é¢‘è®¾å¤‡ã€‚PCM æ¥å£å¤„ç†æ•°æ®æµå’Œæ§åˆ¶ã€‚è¯¥ç•Œé¢ç®¡ç† ALSA é©±åŠ¨ç¨‹åºå¯¼å‡ºçš„æ§ä»¶ï¼ˆéŸ³é¢‘è·¯å¾„ã€éŸ³é‡ã€‚..ï¼‰ã€‚</p></li><li><p>ASoC Frameworkï¼ˆå†…æ ¸ç©ºé—´ï¼‰ ALSA ç‰‡ä¸Šç³»ç»Ÿ ( ASoC ) å±‚çš„ç›®æ ‡æ˜¯æ”¹è¿› ALSA å¯¹åµŒå…¥å¼ç‰‡ä¸Šç³»ç»Ÿå¤„ç†å™¨å’ŒéŸ³é¢‘ç¼–è§£ç å™¨çš„æ”¯æŒã€‚ASoC æ¡†æ¶æä¾›äº†ä¸€ä¸ª DMA å¼•æ“ï¼Œå®ƒä¸ DMA æ¡†æ¶è¿æ¥ä»¥å¤„ç†éŸ³é¢‘æ ·æœ¬çš„ä¼ è¾“ã€‚ASoC è¿˜é€šè¿‡ DAPM é©±åŠ¨ç¨‹åºæ”¯æŒéŸ³é¢‘è·¯å¾„çš„åŠ¨æ€ç”µæºç®¡ç†ã€‚ASoC å……å½“ ALSA é©±åŠ¨ç¨‹åºï¼Œå®ƒå°†åµŒå…¥å¼éŸ³é¢‘ç³»ç»Ÿåˆ†ä¸ºä¸‰ç§ç±»å‹çš„ç‹¬ç«‹äºå¹³å°çš„é©±åŠ¨ç¨‹åºï¼šCPU DAIã€ç¼–è§£ç å™¨å’Œæœºå™¨é©±åŠ¨ç¨‹åºã€‚</p></li><li>ASoC driverï¼ˆå†…æ ¸ç©ºé—´ï¼‰ ASoC é©±åŠ¨ç¨‹åºå…è®¸ä¸º ASoC é©±åŠ¨ç¨‹åºç±»å®ç°ç¡¬ä»¶ç›¸å…³ä»£ç  ï¼š<ul><li>ç¼–è§£ç å™¨é©±åŠ¨ç¨‹åº</li><li>CPU DAI é©±åŠ¨ç¨‹åº</li><li>æœºå™¨é©±åŠ¨ç¨‹åº</li></ul></li></ul><h1 id="debug">Debug</h1><h2 id="procfs-filesystem">Procfs filesystem</h2><ul><li>List PCM audio devices:</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/asound/pcm</span><br></pre></td></tr></tbody></table></figure><ul><li>Get hardware parameters of a PCM audio device (device "0" of card "0" here):</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/asound/card0/pcm0p/sub0/hw_params</span><br></pre></td></tr></tbody></table></figure><h2 id="debugfs-filesystem">Debugfs filesystem</h2><ul><li>List DAIs</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/asoc/dais</span><br></pre></td></tr></tbody></table></figure><ul><li>List DAPMs of "xxx.audio-controller" CPU DAI of "STM32MP1-EV" soundcard</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /sys/kernel/debug/asoc/STM32MP1-EV/xxx.audio-controller/dapm</span><br></pre></td></tr></tbody></table></figure><h2 id="how-to-trace">How to trace</h2><h3 id="dynamic-traces">Dynamic traces</h3><p>ALSA framework and driver debug traces can be added to the kernel logs by using the dynamic debug mechanism.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">'file stm32_sai.c +p; file stm32_sai_sub.c +p'</span> &gt; /sys/kernel/debug/dynamic_debug/control; </span><br><span class="line">$ dmesg -n8;</span><br></pre></td></tr></tbody></table></figure><h3 id="tracing-filesystem">Tracing filesystem</h3><h4 id="activate-dapm-traces">Activate DAPM traces</h4><ul><li>Enable trace</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'1'</span> &gt; /sys/kernel/debug/tracing/events/asoc/enable</span><br></pre></td></tr></tbody></table></figure><ul><li>Check log</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br></pre></td></tr></tbody></table></figure><h4 id="activate-pcm-hardware-parameter-traces">Activate PCM hardware parameter traces</h4><ul><li>Enable trace</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'1'</span> &gt; /sys/kernel/debug/tracing/events/snd_pcm/enable</span><br></pre></td></tr></tbody></table></figure><ul><li>Check log</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br></pre></td></tr></tbody></table></figure><h4 id="activate-pcm-buffer-state-traces">Activate PCM buffer state traces</h4><p>Prerequisite: the CONFIG_FUNCTION_TRACER, CONFIG_SND_DEBUG, CONFIG_SND_DEBUG_VERBOSE and SND_PCM_XRUN_DEBUG configurations must first be enabled in the Linux kernel configuration</p><ul><li>Set XRUN trace verbosity</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/asound/card0/pcm0p/xrun_debug</span><br></pre></td></tr></tbody></table></figure><ul><li>Enable trace</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'1'</span> &gt; /sys/kernel/debug/tracing/events/snd_pcm/enable</span><br></pre></td></tr></tbody></table></figure><ul><li>Check log</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzYvYXJ0aWNsZS9kZXRhaWxzLzk4MDQwOTg1P3NwbT0xMDAxLjIwMTQuMzAwMS41NTAx">https://blog.csdn.net/u012489236/article/details/98040985?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzYvYXJ0aWNsZS9kZXRhaWxzLzk4MDY4MTIyP3NwbT0xMDAxLjIwMTQuMzAwMS41NTAx">https://blog.csdn.net/u012489236/article/details/98068122?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzYvYXJ0aWNsZS9kZXRhaWxzLzk4MDc5MTc2P3NwbT0xMDAxLjIwMTQuMzAwMS41NTAx">https://blog.csdn.net/u012489236/article/details/98079176?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘-çº¦ç¿°-é©¬å¾·å¥¥ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Audio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Audio </tag>
            
            <tag> ALSA </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB å­ç³»ç»Ÿï¼ˆå››ï¼‰USB Gadget é©±åŠ¨</title>
      <link href="/2023/LinuxDriver/LinuxUSBGadgetDriver/"/>
      <url>/2023/LinuxDriver/LinuxUSBGadgetDriver/</url>
      
        <content type="html"><![CDATA[<p>USB æ§åˆ¶å™¨å¯ä»¥å‘ˆç°å‡ºä¸¤ç§ä¸åŒçš„çŠ¶æ€ã€‚USB æ§åˆ¶å™¨ä½œä¸º Host æ—¶ï¼Œç§°ä¸º USB ä¸»æœºæ§åˆ¶å™¨ï¼Œä½¿ç”¨ USB ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ã€‚USB æ§åˆ¶å™¨ä½œä¸º Device æ—¶ï¼Œç§°ä¸º USB è®¾å¤‡æ§åˆ¶å™¨ï¼Œä½¿ç”¨ UDCï¼ˆusb device controllerï¼‰é©±åŠ¨ã€‚</p><p>USB æ§åˆ¶å™¨ä½œä¸º Device æ—¶ï¼Œæœ€ä¸Šå±‚çš„æ˜¯ Gadget Function é©±åŠ¨ï¼Œä»£è¡¨äº†å…·ä½“è®¾å¤‡çš„é©±åŠ¨ï¼Œå¦‚ U ç›˜ã€USB ä¸²å£ã€USB è™šæ‹Ÿç½‘å¡ã€UAC é©±åŠ¨ã€‚Composite å±‚æ˜¯ä¸€ä¸ªå¯é€‰çš„ä¸­é—´å±‚ï¼Œå¯é€šè¿‡ä¸€ç§é…ç½®æˆ–å¤šç§é…ç½®é«˜æ•ˆçš„æ”¯æŒå¤šç§åŠŸèƒ½çš„è®¾å¤‡ï¼Œç®€åŒ–äº† USB å¤åˆè®¾å¤‡é©±åŠ¨çš„å¼€å‘ã€‚ç›®å‰æœ€æµè¡Œçš„æ˜¯ä½¿ç”¨åŸºäº Composite å’Œ configfs å®ç°çš„ USB gadget configfsï¼Œå¯åœ¨ç”¨æˆ·ç©ºé—´çµæ´»çš„é…ç½® USB è®¾å¤‡ã€‚UDC é©±åŠ¨ç›´æ¥è®¿é—®ç¡¬ä»¶ï¼Œæ§åˆ¶ USB è®¾å¤‡ä¸ USB ä¸»æœºä¹‹é—´çš„é€šä¿¡ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Framework.png"></p><span id="more"></span><h1 id="busdevicedriveræ¨¡å‹">Bus/Device/Driveræ¨¡å‹</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/usbDriver.png"></p><ul><li>"USBæ¥å£"æ˜¯é€»è¾‘ä¸Šçš„USBè®¾å¤‡ï¼Œæˆ‘ä»¬ç¼–å†™çš„usb_driveré©±åŠ¨ç¨‹åºï¼Œæ”¯æŒçš„æ˜¯"USBæ¥å£"ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/usbDriver1.png"></li><li>USBæ§åˆ¶å™¨æˆ–Hubè¯†åˆ«å‡ºUSBè®¾å¤‡åï¼Œä¼šåˆ›å»ºã€æ³¨å†Œusb_deive</li><li>usb_deviceè¢«"drivers.c"é©±åŠ¨è®¤é¢†åï¼Œä¼šé€‰æ‹©ã€è®¾ç½®æŸä¸ªé…ç½®</li><li>è¿™ä¸ªé…ç½®ä¸‹é¢çš„æ¥å£ï¼Œéƒ½ä¼šåˆ†é…ã€è®¾ç½®ã€æ³¨å†Œä¸€ä¸ªusb_interface</li><li>å·¦è¾¹çš„usb_driverå’Œå³è¾¹çš„usb_interfaceå¦‚æœåŒ¹é…ï¼Œåˆ™è°ƒç”¨usb_driver.probe</li></ul><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>ä»¥ UAC ä¸ºä¾‹æ¥è¯´æ˜ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/UAC-Struct.png"></p><ul><li><p>usb_configurationï¼š ä»£è¡¨ä¸€ä¸ª gadget é…ç½®</p></li><li><p>usb_composite_devï¼š å®ƒé‡Œé¢æ±‡é›†æœ‰å„ç±»æè¿°ç¬¦ï¼Œå†…åµŒ gadget å¯¹è±¡ï¼Œä»¥åŠ usb è®¾å¤‡çš„ä¸€äº›é…ç½®å’Œè¯·æ±‚ï¼Œæœ‰ä¸€ä¸ª usb_funciton é“¾è¡¨ï¼ˆå®ç°æ•°æ®ä¼ è¾“ï¼‰ï¼Œä¸»è¦ç”¨äºåˆå§‹åŒ–ã€‚</p></li><li><p>usb_composite_driverï¼š è®¾å¤‡é©±åŠ¨çš„å…¥å£ï¼Œç”¨æ¥ç®¡ç†è®¾å¤‡é…ç½®ä¿¡æ¯ï¼Œä¿å­˜è®¾å¤‡æè¿°ç¬¦ã€‚</p></li><li><p>usb_gadget_driverï¼š æä¾›ä¸€ä¸ªé€šç”¨çš„ usb gadget driver æ¨¡æ¿ï¼Œå‘ä¸‹æ³¨å†Œåˆ° udc, å‘ä¸Šç»™ functions driver æä¾› bind å›è°ƒç­‰ã€‚</p></li></ul><h1 id="ä»£ç é€»è¾‘">ä»£ç é€»è¾‘</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/UAC-Driver.png"></p><p>UAC é©±åŠ¨æ¡†æ¶å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸»è¦å„å…¥å£å‡½æ•°ä»¥åŠå„å±‚ç›¸å…³å‡½æ•°æµç¨‹éƒ½åˆ—å‡ºæ¥äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±è¿½è¸ªä»£ç æŸ¥çœ‹ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWV0LWNoaW5hLmNvbS9tcC9hNTUzMTAuaHRtbA==">https://www.eet-china.com/mp/a55310.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTEwMzc1OTMvYXJ0aWNsZS9kZXRhaWxzLzEyMDMzODk2OT9zcG09MTAwMS4yMDE0LjMwMDEuNTUwMg==">https://blog.csdn.net/u011037593/article/details/120338969?spm=1001.2014.3001.5502<i class="fa fa-external-link-alt"></i></span><br>ã€ŠéŸ¦ä¸œå±±è€å¸ˆç›¸å…³è¯¾ç¨‹ã€‹<br>ã€Šåœˆåœˆæ•™ä½ ç© USBã€‹<br>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB å­ç³»ç»Ÿï¼ˆä¸‰ï¼‰USB è®¾å¤‡æè¿°ç¬¦</title>
      <link href="/2023/LinuxDriver/LinuxUSBDeviceDescriptor/"/>
      <url>/2023/LinuxDriver/LinuxUSBDeviceDescriptor/</url>
      
        <content type="html"><![CDATA[<h1 id="æ ‡å‡†è®¾å¤‡è¯·æ±‚">æ ‡å‡†è®¾å¤‡è¯·æ±‚</h1><h2 id="setup-äº‹åŠ¡çš„æ•°æ®æ ¼å¼">SETUP äº‹åŠ¡çš„æ•°æ®æ ¼å¼</h2><p>Host ä½¿ç”¨æ§åˆ¶ä¼ è¾“æ¥è¯†åˆ«è®¾å¤‡ã€è®¾ç½®è®¾å¤‡åœ°å€ã€å¯åŠ¨è®¾å¤‡çš„æŸäº›ç‰¹æ€§ï¼Œå¯¹äºæ§åˆ¶ä¼ è¾“ï¼Œå®ƒé¦–å…ˆå‘å‡º"setup äº‹åŠ¡"ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description3.png"></p><span id="more"></span><p>åœ¨"setup äº‹åŠ¡"ä¸­ï¼Œ</p><ul><li>SETUP ä»¤ç‰ŒåŒ…ï¼šç”¨æ¥é€šçŸ¥è®¾å¤‡ï¼Œ"è¦å¼€å§‹ä¼ è¾“äº†"ã€‚</li><li>DATA0 æ•°æ®åŒ…ï¼šå®ƒå«æœ‰å›ºå®šçš„æ ¼å¼ï¼Œç”¨æ¥å‘Šè¯‰è®¾å¤‡"æ˜¯è¯»è¿˜æ˜¯å†™"ã€"è¯»ä»€ä¹ˆ"ã€"å†™ä»€ä¹ˆ"ã€‚</li></ul><p>Hos é€šè¿‡ DATA0 æ•°æ®åŒ…å‘é€ 8 å­—èŠ‚æ•°æ®ç»™è®¾å¤‡ï¼Œå®ƒçš„æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description4.png"></p><h2 id="æ ‡å‡†è®¾å¤‡è¯·æ±‚-1">æ ‡å‡†è®¾å¤‡è¯·æ±‚</h2><p>æ§åˆ¶ä¼ è¾“çš„å»ºç«‹äº‹åŠ¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ ¼å¼çš„æ•°æ®ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description5.png"></p><p>ä¸Šè¡¨ä¸­å„ä¸ª"å®"å–å€¼å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description6.png"></p><h2 id="è®¾å¤‡é…ç½®æ¥å£ç«¯ç‚¹">è®¾å¤‡/é…ç½®/æ¥å£/ç«¯ç‚¹</h2><p>åœ¨ SETUP äº‹åŠ¡çš„æ•°æ®é‡Œï¼Œè¡¨ç¤ºäº†è¦è®¿é—®çš„æ˜¯ä»€ä¹ˆï¼šDeviceï¼ŸInterfaceï¼ŸEndpointï¼Ÿ</p><p>å¯¹äºä¸€ä¸ª USB è®¾å¤‡ï¼Œå®ƒå¯ä»¥å¤šç§é…ç½® (Configuration)ã€‚æ¯”å¦‚ 4G ä¸Šç½‘å¡å°±æœ‰ 2 ç§é…ç½®ï¼šU ç›˜ã€ä¸Šç½‘å¡ã€‚ç¬¬ 1 æ¬¡æŠŠ 4G ä¸Šç½‘å¡æ’å…¥ç”µè„‘æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª U ç›˜ï¼Œå¯ä»¥å®‰è£…é‡Œé¢çš„ç¨‹åºã€‚è£…å¥½ç¨‹åºåï¼ŒæŠŠå®ƒå†æ¬¡æ’å…¥ç”µè„‘ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªä¸Šç½‘å¡ã€‚é©±åŠ¨ç¨‹åºå¯ä»¥é€‰æ‹©è®©å®ƒå·¥ä½œäºå“ªç§é…ç½®ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ç§é…ç½®ã€‚å¤§å¤šæ•°çš„ USB è®¾å¤‡åªæœ‰ä¸€ç§é…ç½®ã€‚</p><p>ä¸€ä¸ªé…ç½®ä¸‹ï¼Œå¯ä»¥æœ‰å¤šä¸ªæ¥å£ (Interface)ï¼Œæ¥å£ç­‰åŒäºåŠŸèƒ½ (Function)ã€‚æ¯”å¦‚ USB è€³æœºæœ‰ä¸¤ä¸ªæ¥å£ï¼ˆåŠŸèƒ½ï¼‰ï¼šå£°éŸ³æ”¶å‘ã€æŒ‰é”®æ§åˆ¶ã€‚</p><p>ä¸€ä¸ªæ¥å£ï¼Œå¯èƒ½æœ‰å¤šä¸ªè®¾ç½® (Setting)ï¼Œæ¯”å¦‚é»˜è®¤è®¾ç½®ä¸‹å®ƒä½¿ç”¨è¾ƒä½çš„å¸¦å®½ï¼Œå¯ä»¥é€‰æ‹©å…¶ä»–è®¾ç½®ä»¥ä½¿ç”¨æ›´é«˜å¸¦å®½ã€‚</p><p>ä¸€ä¸ªæ¥å£ï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªç«¯ç‚¹ (Endpoint) ç»„æˆã€‚ç«¯ç‚¹ 0 å±äºæ•´ä¸ªè®¾å¤‡çš„ï¼Œç«¯ç‚¹ 0 æ˜¯åŒå‘çš„ã€‚æ¥å£è¿˜å¯ä»¥æœ‰å…¶ä»–ç«¯ç‚¹ï¼Œè¿™äº›ç«¯ç‚¹æ˜¯å•å‘çš„ï¼Œè¦ä¹ˆæ˜¯æ‰¹é‡ (Bulk) ç«¯ç‚¹ã€è¦ä¹ˆæ˜¯ä¸­æ–­ (Interrupt) ç«¯ç‚¹ã€è¦ä¹ˆæ˜¯åŒæ­¥ (Isochronous) ç«¯ç‚¹ã€‚</p><h1 id="æè¿°ç¬¦">æè¿°ç¬¦</h1><p>ä½¿ç”¨æè¿°ç¬¦ (Descriptors) æè¿°è®¾å¤‡ã€é…ç½®ã€æ¥å£å’Œç«¯ç‚¹ï¼Œæœ‰è®¾å¤‡æè¿°ç¬¦ã€é…ç½®æè¿°ç¬¦ã€æ¥å£æè¿°ç¬¦ã€ç«¯ç‚¹æè¿°ç¬¦ã€‚æ‰€è°“æè¿°ç¬¦ï¼Œå°±æ˜¯ä¸€äº›æ ¼å¼åŒ–çš„æ•°æ®ï¼Œç”¨æ¥æè¿°ä¿¡æ¯ã€‚</p><p>ä¸€ä¸ª USB è®¾å¤‡ï¼Œ</p><ul><li>åªæœ‰ä¸€ä¸ªè®¾å¤‡æè¿°ç¬¦ï¼šç”¨æ¥è¡¨ç¤ºè®¾å¤‡çš„ IDã€å®ƒæœ‰å¤šå°‘ä¸ªé…ç½®ã€å®ƒçš„ç«¯ç‚¹ 0 ä¸€æ¬¡æœ€å¤§èƒ½ä¼ è¾“å¤šå°‘å­—èŠ‚æ•°æ®ã€‚</li><li>å¯èƒ½æœ‰å¤šä¸ªé…ç½®æè¿°ç¬¦ï¼šç”¨æ¥è¡¨ç¤ºå®ƒæœ‰å¤šå°‘ä¸ªæ¥å£ã€ä¾›ç”µæ–¹å¼ã€æœ€å¤§ç”µæµã€‚</li><li>ä¸€ä¸ªé…ç½®æè¿°ç¬¦ä¸‹é¢ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ¥å£æè¿°ç¬¦ï¼šç”¨æ¥è¡¨ç¤ºå®ƒæ˜¯å“ªç±»æ¥å£ã€æœ‰å‡ ä¸ªè®¾ç½® (Setting)ã€æœ‰å‡ ä¸ªç«¯ç‚¹ã€‚</li><li>ä¸€ä¸ªæ¥å£æè¿°ç¬¦ç¬¦ä¸‹é¢ï¼Œå¯èƒ½æœ‰å¤šä¸ªç«¯ç‚¹æè¿°ç¬¦ï¼šç”¨æ¥è¡¨ç¤ºç«¯ç‚¹å·ã€æ–¹å‘ (IN/OUT)ã€ç±»å‹ï¼ˆæ‰¹é‡/ä¸­æ–­/åŒæ­¥ï¼‰ã€‚</li></ul><p>è¿˜æœ‰ä¸€äº›å­—ç¬¦ä¸²æè¿°ç¬¦ (String descriptors)ï¼Œå®ƒç”¨å¯è¯»çš„æ–‡å­—æ¥æè¿°è®¾å¤‡ï¼Œæ˜¯å¯é€‰çš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description7.png"></p><h2 id="è®¾å¤‡æè¿°ç¬¦">è®¾å¤‡æè¿°ç¬¦</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description8.png"></p><h2 id="é…ç½®æè¿°ç¬¦">é…ç½®æè¿°ç¬¦</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description9.png"></p><h2 id="æ¥å£æè¿°ç¬¦">æ¥å£æè¿°ç¬¦</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description10.png"></p><h2 id="ç«¯ç‚¹æè¿°ç¬¦">ç«¯ç‚¹æè¿°ç¬¦</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description11.png"></p><h1 id="è®¾å¤‡æšä¸¾è¿‡ç¨‹ç¤ºä¾‹">è®¾å¤‡æšä¸¾è¿‡ç¨‹ç¤ºä¾‹</h1><p>ä½¿ç”¨"usbprotocolsuite"æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°è®¾å¤‡çš„æšä¸¾è¿‡ç¨‹ï¼š</p><ul><li><p>ä½¿ç”¨æ§åˆ¶ä¼ è¾“ï¼Œè¯»å–è®¾å¤‡ä¿¡æ¯ï¼ˆè®¾å¤‡æè¿°ç¬¦ï¼‰ï¼šç¬¬ä¸€æ¬¡è¯»å–æ—¶ï¼Œå®ƒåªéœ€è¦å¾—åˆ° 8 å­—èŠ‚æ•°æ®ï¼Œå› ä¸ºç¬¬ 8 ä¸ªæ•°æ®è¡¨ç¤ºç«¯ç‚¹ 0 èƒ½ä¼ è¾“çš„æœ€å¤§æ•°æ®é•¿åº¦ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description12.png"></p></li><li><p>Host åˆ†é…åœ°å€ç»™è®¾å¤‡ï¼Œç„¶åæŠŠæ–°åœ°å€å‘ç»™è®¾å¤‡ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description13.png"></p></li><li><p>ä½¿ç”¨æ–°åœ°å€ï¼Œé‡æ–°è¯»å–è®¾å¤‡æè¿°ç¬¦ï¼Œè®¾å¤‡æè¿°ç¬¦é•¿åº¦æ˜¯ 18ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description14.png"></p></li><li><p>è¯»å–é…ç½®æè¿°ç¬¦ï¼šå®ƒä¼ å…¥çš„é•¿åº¦æ˜¯ 255ï¼Œæƒ³ä¸€æ¬¡æ€§æŠŠå½“å‰é…ç½®æè¿°ç¬¦ã€å®ƒä¸‹é¢çš„æ¥å£æè¿°ç¬¦ã€ç«¯ç‚¹æè¿°ç¬¦å…¨éƒ¨è¯»å‡ºæ¥ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description15.png"></p></li><li><p>è¯»å–å­—ç¬¦æè¿°ç¬¦ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description16.png"></p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠéŸ¦ä¸œå±±è€å¸ˆç›¸å…³è¯¾ç¨‹ã€‹<br>ã€Šåœˆåœˆæ•™ä½ ç© USBã€‹<br>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB å­ç³»ç»Ÿï¼ˆäºŒï¼‰USB åè®®å±‚æ•°æ®æ ¼å¼</title>
      <link href="/2023/LinuxDriver/LinuxUSBProtoFormat/"/>
      <url>/2023/LinuxDriver/LinuxUSBProtoFormat/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¡¬ä»¶æ‹“æ‰‘ç»“æ„">ç¡¬ä»¶æ‹“æ‰‘ç»“æ„</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol1.png"></p><ul><li>compound device ï¼šå¤šä¸ªè®¾å¤‡ç»„åˆèµ·æ¥ï¼Œé€šè¿‡ HUB è·Ÿ Host ç›¸è¿</li><li>composite device ï¼šä¸€ä¸ªç‰©ç†è®¾å¤‡æœ‰å¤šä¸ªé€»è¾‘è®¾å¤‡ (multiple interfaces)</li></ul><span id="more"></span><p>åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥ Hub çš„å­˜åœ¨ï¼Œç¡¬ä»¶æ‹“æ‰‘å›¾ç®€åŒ–å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol2.png"></p><p>ä¸€ä¸ªç‰©ç†è®¾å¤‡é‡Œé¢å¯èƒ½æœ‰å¤šä¸ªé€»è¾‘è®¾å¤‡ï¼ŒHos å¯ä»¥å¤–æ¥å¤šä¸ªé€»è¾‘è®¾å¤‡ï¼Œç¡¬ä»¶æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol3.png"></p><h1 id="åè®®å±‚">åè®®å±‚</h1><ul><li>å¯»å€è®¾å¤‡é˜¶æ®µï¼šUSB ç³»ç»Ÿæ˜¯ä¸€ä¸ª Host å¯¹åº”å¤šä¸ªè®¾å¤‡ï¼Œè¦ä¼ è¾“æ•°æ®é¦–å…ˆè¦é€šçŸ¥è®¾å¤‡<ul><li>å‘å‡º IN ä»¤ç‰ŒåŒ…ï¼šè¡¨ç¤ºæƒ³è¯»æ•°æ®ï¼Œé‡Œé¢å«æœ‰è®¾å¤‡åœ°å€</li><li>å‘å‡º OUT ä»¤ç‰ŒåŒ…ï¼šè¡¨ç¤ºæƒ³å†™æ•°æ®ï¼Œé‡Œé¢å«æœ‰è®¾å¤‡åœ°å€</li></ul></li><li>æ•°æ®ä¼ è¾“é˜¶æ®µ<ul><li>Host æƒ³è¯»æ•°æ®ï¼šå‘å‡º IN ä»¤ç‰ŒåŒ…åè¯»å–æ•°æ®åŒ…</li><li>Host æƒ³å‘å‡ºæ•°æ®ï¼šå‘å‡º OUT ä»¤ç‰ŒåŒ…åå‘å‡ºæ•°æ®åŒ…</li></ul></li><li>æ•°æ®ç¡®è®¤é˜¶æ®µ<ul><li>Host è¯»æ•°æ®ï¼Œè®¾å¤‡å¯èƒ½æœªå°±ç»ªï¼Œå°±ä¼šå›åº” NAK åŒ…</li><li>Host å†™æ•°æ®ï¼Œå®ƒå‘å‡ºæ•°æ®åï¼Œè®¾å¤‡æ­£ç¡®æ¥æ”¶äº†ï¼Œå°±å›å¤ ACK åŒ…</li></ul></li></ul><h2 id="sync-åŸŸ">SYNC åŸŸ</h2><p>Host å‘å‡º SOP ä¿¡å·åï¼Œå°±ä¼šå‘å‡º SYNC ä¿¡å·ï¼ˆå‰ä¸€èŠ‚çš„é‚£ä¸ª K-J-K-J-K-J-K ä¿¡å·ï¼‰ï¼šå®ƒæ˜¯ä¸€ç³»åˆ—çš„ã€æœ€å¤§ä¼ è¾“é¢‘ç‡çš„è„‰å†²ï¼Œæ¥æ”¶æ–¹ä½¿ç”¨å®ƒæ¥åŒæ­¥æ•°æ®ã€‚å¯¹äºä½é€Ÿ/å…¨é€Ÿè®¾å¤‡ï¼ŒSYNC ä¿¡å·æ˜¯ 8 ä½æ•°æ®ï¼ˆä»å·¦åˆ°å³æ˜¯ 00000001)ï¼›å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼ŒSYNC ä¿¡å·æ˜¯ 32 ä½æ•°æ®ï¼ˆä»å·¦åˆ°å³æ˜¯ 00000000000000000000000000000001)ã€‚ä½¿ç”¨ NRZI ç¼–ç æ—¶ï¼Œå‰é¢æ¯ä¸ª"0"éƒ½å¯¹åº”ä¸€ä¸ªè·³å˜ã€‚</p><p>åœ¨å¾ˆå¤šæ–‡æ¡£é‡Œï¼ŒæŠŠ SOP å’Œ SYNC ç»Ÿä¸€ç§°ä¸º"SYNC"ã€‚</p><h2 id="åŒ…æ ¼å¼">åŒ…æ ¼å¼</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol4.png"></p><p>USB æ€»çº¿ä¸Šä¼ è¾“çš„æ•°æ®ä»¥åŒ…ä¸ºå•ä½ã€‚USB åŒ…é‡Œå«æœ‰å“ªäº›å†…å®¹ ("åŸŸ")ï¼Ÿ</p><ul><li>SOPï¼šç”¨æ¥è¡¨ç¤ºåŒ…çš„èµ·å§‹</li><li>SYNCï¼šç”¨æ¥åŒæ­¥æ—¶é’Ÿ</li><li>PIDï¼šè¡¨ç¤ºåŒ…çš„ç±»å‹</li><li>åœ°å€ï¼šåœ¨ USB ç¡¬ä»¶ä½“ç³»ä¸­ï¼Œä¸€ä¸ª Host å¯¹åº”å¤šä¸ª Logical Deviceï¼Œé‚£ä¹ˆ Host å‘å‡ºçš„åŒ…ï¼Œå¦‚ä½•ç¡®å®šå‘ç»™è°ï¼Ÿ<ul><li>å‘ç»™æ‰€æœ‰è®¾å¤‡ï¼šåŒ…é‡Œä¸å«æœ‰è®¾å¤‡åœ°å€</li><li>å‘ç»™æŸä¸ªè®¾å¤‡ï¼šåŒ…é‡Œå«æœ‰è®¾å¤‡åœ°å€ã€ç«¯ç‚¹å·</li></ul></li><li>å¸§å·ã€æ•°æ®ç­‰è·Ÿ PID ç›¸å…³çš„å†…å®¹</li><li>CRC æ ¡éªŒç </li></ul><p>å‘èµ·ä¸€æ¬¡å®Œæ•´çš„ä¼ è¾“ï¼Œå¯èƒ½æ¶‰åŠå¤šä¸ªåŒ…ã€‚é‚£ä¹ˆï¼Œç¬¬ 1 ä¸ªåŒ…é‡Œå«æœ‰è®¾å¤‡åœ°å€ã€ç«¯ç‚¹å·ï¼Œåç»­çš„åŒ…å°±æ²¡å¿…è¦åŒ…å«è®¾å¤‡åœ°å€ã€ç«¯ç‚¹å·ã€‚</p><h2 id="pid-åŸŸ">PID åŸŸ</h2><p>æ³¨æ„ï¼šæ‰€æœ‰çš„ USB æ–‡æ¡£æåˆ°çš„"è¾“å…¥"ã€"è¾“å‡º"ï¼Œéƒ½æ˜¯åŸºäº Host çš„è§’åº¦ï¼Œ"è¾“å‡º"è¡¨ç¤ºä» Host è¾“å‡ºåˆ°è®¾å¤‡ï¼Œ"è¾“å…¥"è¡¨ç¤º Host ä»è®¾å¤‡å¾—åˆ°æ•°æ®ã€‚</p><p>æœ‰å“ªäº› USB åŒ…ï¼Ÿæ ¹æ®åŒ…æ•°æ®é‡Œçš„ PID çš„ bit1, bit0 å¯ä»¥åˆ†ä¸º 4 ç±»ï¼š</p><ul><li>ä»¤ç‰ŒåŒ… (Token)ï¼š01B</li><li>æ•°æ®åŒ… (Data)ï¼š11B</li><li>æ¡æ‰‹åŒ… (Handshake)ï¼š10B</li><li>ç‰¹æ®ŠåŒ… (Special)ï¼š00B</li></ul><p>PID æœ‰ 4 ä½ï¼Œä½¿ç”¨ bit1,bit0 ç¡®å®šåˆ†ç±»ï¼Œä½¿ç”¨ bit3,bit2 è¿›ä¸€æ­¥ç»†åˆ†ã€‚å¦‚ä¸‹è¡¨ï¼ˆæ¥è‡ªã€Šåœˆåœˆæ•™ä½ ç© USBã€‹) æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol5.png"></p><p>åœ¨ USB åŒ…ä¸­ï¼ŒPID åŸŸä½¿ç”¨ 8 ä½æ¥è¡¨ç¤ºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol6.png"></p><p>å‰ 4 ä½è¡¨ç¤º PIDï¼Œå 4 ä½æ˜¯å¯¹åº”ä½çš„å–åã€‚æ¥æ”¶æ–¹å‘ç°å 4 ä½ä¸æ˜¯å‰ 4 ä½çš„å–åçš„è¯ï¼Œå°±è®¤ä¸ºå‘ç”Ÿäº†é”™è¯¯ã€‚</p><h2 id="ä»¤ç‰ŒåŒ…-token">ä»¤ç‰ŒåŒ… (Token)</h2><p>ä»¤ç‰Œç±»çš„ PIDï¼Œèµ·"é€šçŸ¥ä½œç”¨"ï¼ŒSOF ä»¤ç‰ŒåŒ…è¢«ç”¨æ¥é€šçŸ¥æ‰€æœ‰è®¾å¤‡ï¼ŒOUT/IN/SETUP ä»¤ç‰ŒåŒ…è¢«ç”¨æ¥é€šçŸ¥æŸä¸ªè®¾å¤‡ã€‚</p><p>å¯¹äº OUTã€INã€SETUP ä»¤ç‰ŒåŒ…ï¼Œå®ƒä»¬éƒ½æ˜¯è¦é€šçŸ¥åˆ°å…·ä½“çš„è®¾å¤‡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol7.png"></p><p>USB è®¾å¤‡çš„åœ°å€æœ‰ 7 ä½ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol8.png"></p><p>å¯¹äº SOF åŒ…ï¼Œè‹±æ–‡åä¸º"Start-of-Frame marker and frame number"ã€‚å¯¹äº USB å…¨é€Ÿè®¾å¤‡ï¼ŒHost æ¯ 1ms äº§ç”Ÿä¸€ä¸ªå¸§ï¼›å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼Œæ¯ 125us äº§ç”Ÿä¸€ä¸ªå¾®å¸§ï¼Œ1 å¸§é‡Œæœ‰ 8 ä¸ªå¾®å¸§ã€‚Host ä¼šå¯¹å½“å‰å¸§å·è¿›è¡Œç´¯åŠ è®¡æ•°ï¼Œåœ¨æ¯å¸§æˆ–æ¯å¾®å¸§å¼€å§‹æ—¶ï¼Œé€šè¿‡ SOF ä»¤ç‰ŒåŒ…å‘é€å¸§å·ã€‚å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼Œæ¯ 1 æ¯«ç§’é‡Œæœ‰ 8 ä¸ªå¾®å¸§ï¼Œè¿™ 8 ä¸ªå¾®å¸§çš„å¸§å·æ˜¯ä¸€æ ·çš„ï¼Œæ¯ 125us å‘é€ä¸€ä¸ª SOF ä»¤ç‰ŒåŒ…ã€‚</p><p>SOF ä»¤ç‰ŒåŒ…æ ¼å¼å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol9.png"></p><h2 id="æ•°æ®åŒ…">æ•°æ®åŒ…</h2><p>Host ä½¿ç”¨ OUTã€INã€SETUP æ¥é€šçŸ¥è®¾å¤‡è¦ä¼ è¾“æ•°æ®äº†ï¼Œæ•°æ®é€šè¿‡"æ•°æ®åŒ…"è¿›è¡Œä¼ è¾“ã€‚</p><p>æ•°æ®åŒ…ä¹Ÿæœ‰ 4 ç§ç±»å‹ï¼šDATA0ã€DATA1ã€DATA2ã€MDATAã€‚å…¶ä¸­ DATA2ã€MDATA åœ¨é«˜é€Ÿè®¾å¤‡ä¸­ä½¿ç”¨ã€‚</p><p>Host å’Œè®¾å¤‡éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„æ•°æ®åŒ…åˆ‡æ¢æœºåˆ¶ï¼Œå½“æ•°æ®åŒ…æˆåŠŸå‘é€æˆ–è€…æ¥æ”¶æ—¶ï¼Œæ•°æ®åŒ…ç±»å‹åˆ‡æ¢ã€‚å½“æ£€æµ‹åˆ°å¯¹æ–¹ä½¿ç”¨çš„æ•°æ®åŒ…ç±»å‹ä¸å¯¹æ—¶ï¼ŒUSB ç³»ç»Ÿè®¤ä¸ºå‘ç”Ÿäº†é”™è¯¯ã€‚</p><ul><li>Host å‘é€ DATA0 ç»™è®¾å¤‡ï¼Œè®¾å¤‡è¿”å› ACK è¡¨ç¤ºæˆåŠŸæ¥æ”¶ï¼Œè®¾å¤‡æœŸå¾…ä¸‹ä¸€ä¸ªæ•°æ®æ˜¯ DATA1</li><li>ä½†æ˜¯ Host æ²¡æœ‰æ¥æ”¶åˆ° ACKï¼ŒHost è®¤ä¸ºæ•°æ®æ²¡æœ‰å‘é€æˆåŠŸï¼ŒHost ç»§ç»­ä½¿ç”¨ DATA0 å‘é€ä¸Šä¸€æ¬¡çš„æ•°æ®</li><li>è®¾å¤‡å†æ¬¡æ¥æ”¶åˆ° DATA0 æ•°æ®åŒ…ï¼Œå®ƒå°±çŸ¥é“ï¼šè¿™æ˜¯é‡ä¼ çš„æ•°æ®åŒ…</li></ul><p>æ•°æ®åŒ…æ ¼å¼å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol10.png"></p><p>å¯¹äºå…¨é€Ÿè®¾å¤‡ï¼Œæ•°æ®åŒ…ä¸­çš„æ•°æ®åšå¤§æ˜¯ 1023 å­—èŠ‚ï¼›å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼Œæ•°æ®åŒ…ä¸­çš„æ•°æ®åšå¤§æ˜¯ 1024 å­—èŠ‚ã€‚</p><h2 id="æ¡æ‰‹åŒ…">æ¡æ‰‹åŒ…</h2><p>æ¡æ‰‹åŒ…æœ‰ 4 ç±»ï¼šACKã€NAKã€STALLã€NYET</p><ul><li>ACKï¼šæ•°æ®æ¥æ”¶æ–¹ç”¨æ¥å›å¤å‘é€æ–¹ï¼Œè¡¨ç¤ºæ­£ç¡®æ¥æ”¶åˆ°äº†æ•°æ®å¹¶ä¸”æœ‰è¶³å¤Ÿçš„ç©ºé—´ä¿å­˜æ•°æ®</li><li>NAKï¼šHost å‘é€æ•°æ®ç»™è®¾å¤‡æ—¶ï¼Œè®¾å¤‡å¯ä»¥å›åº” NAK è¡¨ç¤º"æˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œæ²¡åŠæ³•æ¥æ”¶æ•°æ®"ï¼›Host æƒ³è¯»å–è®¾å¤‡çš„æ•°æ®æ—¶ï¼Œè®¾å¤‡å¯ä»¥å›å¤ NAK è¡¨ç¤º"æˆ‘æ²¡æœ‰æ•°æ®ç»™ä½ "</li><li>STALLï¼šè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯ï¼Œæ¯”å¦‚è®¾å¤‡æ— æ³•æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼ˆä¸æ”¯æŒè¯¥ç«¯ç‚¹ç­‰ï¼‰ã€ç«¯ç‚¹å·²ç»æŒ‚èµ·ã€‚è®¾å¤‡è¿”å› STALL åï¼Œéœ€è¦ä¸»æœºè¿›è¡Œå¹²é¢„æ‰èƒ½æ¥è§¦ STALL çŠ¶æ€</li><li>NYETï¼šä»…é€‚ç”¨äºé«˜é€Ÿè®¾å¤‡ã€‚Host å¯ä»¥å‘å‡º PING åŒ…ç”¨æ¥ç¡®è®¤è®¾å¤‡æœ‰æ•°æ®ï¼Œè®¾å¤‡å¯ä»¥å›åº” NYET è¡¨ç¤º"è¿˜æ²¡å‘¢"ã€‚Hub ä¹Ÿå¯ä»¥å›åº” NYET è¡¨ç¤ºä½é€Ÿ/å…¨é€Ÿä¼ è¾“è¿˜æ²¡å®Œç»“</li></ul><h1 id="ä¼ è¾“ç»†èŠ‚">ä¼ è¾“ç»†èŠ‚</h1><h2 id="äº‹åŠ¡-transaction-å’Œä¼ è¾“-transfer">äº‹åŠ¡ (Transaction) å’Œä¼ è¾“ (Transfer)</h2><p>USB ä¼ è¾“çš„åŸºæœ¬å•ä½æ˜¯åŒ… (Packet)ï¼ŒåŒ…çš„ç±»å‹ç”± PID è¡¨ç¤ºã€‚ä¸€ä¸ªå•çº¯çš„åŒ…ï¼Œæ˜¯æ— æ³•ä¼ è¾“å®Œæ•´çš„æ•°æ®çš„ã€‚å®Œæ•´çš„æ•°æ®ä¼ è¾“ï¼Œéœ€è¦æ¶‰åŠå¤šä¸ªåŒ…ï¼šä»¤ç‰ŒåŒ…ã€æ•°æ®åŒ…ã€æ¡æ‰‹åŒ…ã€‚è¿™ä¸ªå®Œæ•´çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼Œè¢«ç§°ä¸ºäº‹åŠ¡ (Transaction)ã€‚æœ‰äº›äº‹åŠ¡éœ€è¦æ¡æ‰‹åŒ…ï¼Œæœ‰äº›äº‹åŠ¡ä¸éœ€è¦æ¡æ‰‹åŒ…ã€‚</p><p>æœ‰å››ç±»** Transaction**ï¼š<br>- æ‰¹é‡äº‹åŠ¡ï¼šç”¨æ¥ä¼ è¾“å¤§é‡çš„æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®æ€§æœ‰ä¿è¯ï¼Œæ—¶æ•ˆæ²¡æœ‰ä¿è¯ - ä¸­æ–­äº‹åŠ¡ï¼šç”¨æ¥ä¼ è¾“å‘¨æœŸæ€§çš„ã€å°é‡çš„æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®æ€§å’Œæ—¶æ•ˆéƒ½æœ‰ä¿è¯ - å®æ—¶äº‹åŠ¡ï¼šç”¨æ¥ä¼ è¾“å®æ—¶æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®æ€§æ²¡æœ‰ä¿è¯ï¼Œæ—¶æ•ˆæœ‰ä¿è¯ - å»ºç«‹äº‹åŠ¡ï¼šè·Ÿæ‰¹é‡äº‹åŠ¡ç±»ä¼¼ï¼Œåªä¸è¿‡ä»¤ç‰ŒåŒ…æ˜¯ SETUP ä»¤ç‰ŒåŒ…</p><p>æœ‰å››ç±»ä¼ è¾“ (Transfer)ï¼š<br>- æ‰¹é‡ä¼ è¾“ï¼šå°±æ˜¯ä½¿ç”¨æ‰¹é‡äº‹åŠ¡å®ç°æ•°æ®ä¼ è¾“ï¼Œæ¯”å¦‚ U ç›˜ - ä¸­æ–­ä¼ è¾“ï¼šå°±æ˜¯ä½¿ç”¨ä¸­æ–­äº‹åŠ¡å®ç°æ•°æ®ä¼ è¾“ï¼Œæ¯”å¦‚é¼ æ ‡ - å®æ—¶ä¼ è¾“ï¼šå°±æ˜¯ä½¿ç”¨å®æ—¶äº‹åŠ¡å®ç°æ•°æ®ä¼ è¾“ï¼Œæ¯”å¦‚æ‘„åƒå¤´ - æ§åˆ¶ä¼ è¾“ï¼šç”±å»ºç«‹äº‹åŠ¡ã€æ‰¹é‡äº‹åŠ¡ç»„æˆï¼Œæ‰€æœ‰çš„ USB è®¾å¤‡éƒ½å¿…é¡»æ”¯æŒæ§åˆ¶ä¼ è¾“ï¼Œç”¨äº"è¯†åˆ«/æšä¸¾"</p><p>Filedã€Packerã€Transactionã€Transfer ä¹‹é—´çš„å…³ç³»ï¼š<br>- BIT ç»„æˆåŸŸ (Field) - åŸŸç»„æˆåŒ… (Packet) - åŒ…ç»„æˆäº‹åŠ¡ (Transaction) - äº‹åŠ¡ç»„æˆä¼ è¾“ (Transfer)</p><p>ä»¥ Isochronous TransFer ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¡¨ç¤ºäº†ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB_Transfer.png"></p><h2 id="è¿‡ç¨‹-stage-å’Œé˜¶æ®µ-phase">è¿‡ç¨‹ (stage) å’Œé˜¶æ®µ (phase)</h2><p>äº‹åŠ¡ï¼ˆ<strong>Transaction</strong>ï¼‰ç”±å¤šä¸ªåŒ…ç»„æˆï¼Œæ¯”å¦‚ Host è¦å‘é€æ•°æ®ç»™è®¾å¤‡ï¼Œè¿™å°±ä¼šæ¶‰åŠå¾ˆå¤šä¸ªåŒ…ï¼š</p><ul><li>Host å‘å‡º OUT ä»¤ç‰ŒåŒ…ï¼Œè¡¨ç¤ºè¦å‘æ•°æ®ç»™å“ªä¸ªè®¾å¤‡</li><li>Host å‘å‡º DATA æ•°æ®åŒ…</li><li>è®¾å¤‡æ”¶åˆ°æ•°æ®åï¼Œå›åº” ACK åŒ…</li></ul><p>è¿™ä¸ªå®Œæ•´çš„äº‹åŠ¡æ¶‰åŠ 3 ä¸ªåŒ… (Packet)ï¼Œåˆ†ä¸º 3 ä¸ªé˜¶æ®µ (Phase)ï¼š</p><ul><li>ä»¤ç‰Œé˜¶æ®µ (Token phase)ï¼šç”±ä»¤ç‰ŒåŒ…å®ç°</li><li>æ•°æ®é˜¶æ®µ (Data phase)ï¼šç”±æ•°æ®åŒ…å®ç°</li><li>æ¡æ‰‹é˜¶æ®µ (Handshake phase)ï¼šç”±æ¡æ‰‹åŒ…å®ç°</li></ul><p>äº‹åŠ¡ç”±åŒ…ç»„æˆï¼Œè¿™äº›åŒ…åˆ†åˆ«å¤„äº 3 ä¸ªé˜¶æ®µ (phase)ï¼šä»¤ç‰Œé˜¶æ®µï¼Œæ•°æ®é˜¶æ®µï¼Œæ¡æ‰‹é˜¶æ®µã€‚</p><p>å¯¹äºæ‰¹é‡ä¼ è¾“ã€ä¸­æ–­ä¼ è¾“ã€å®æ—¶ä¼ è¾“ï¼Œå®ƒä»¬åˆ†åˆ«ç”±ä¸€ä¸ªäº‹åŠ¡ç»„æˆï¼Œä¸å†ç»†åˆ†ä¸ºè‹¥å¹²ä¸ªè¿‡ç¨‹ã€‚</p><p>ä½†æ˜¯æ§åˆ¶ä¼ è¾“ç”±å¤šä¸ªäº‹åŠ¡ç»„æˆï¼Œè¿™äº›äº‹åŠ¡åˆ†åˆ«å¤„äº 3 ä¸ªè¿‡ç¨‹ï¼šå»ºç«‹è¿‡ç¨‹ (stage)ã€æ•°æ®è¿‡ç¨‹ (stage)ã€çŠ¶æ€è¿‡ç¨‹ (stage)ã€‚</p><p>æ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><ul><li>æ§åˆ¶ä¼ è¾“ç”±å¤šä¸ªè¿‡ç¨‹ (stage) ç»„æˆï¼Œæ¯ä¸ªè¿‡ç¨‹ç”±ä¸€ä¸ªäº‹åŠ¡æ¥å®ç°</li><li>æ¯ä¸ªäº‹åŠ¡ç”±å¤šä¸ªé˜¶æ®µ (phase) ç»„æˆï¼Œæ¯ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªåŒ…æ¥å®ç°</li></ul><h2 id="æ‰¹é‡ä¼ è¾“">æ‰¹é‡ä¼ è¾“</h2><p>æ‰¹é‡ä¼ è¾“ç”¨æ‰¹é‡äº‹åŠ¡æ¥å®ç°ï¼Œç”¨äºä¼ è¾“å¤§é‡çš„æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®æ€§æœ‰ä¿è¯ï¼Œæ—¶æ•ˆæ²¡æœ‰ä¿è¯ã€‚</p><p>æ‰¹é‡äº‹åŠ¡ç”± 3 ä¸ªé˜¶æ®µ (phase) ç»„æˆï¼šä»¤ç‰Œé˜¶æ®µã€æ•°æ®é˜¶æ®µã€æ¡æ‰‹é˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œå«æœ‰ SOPã€SYNCã€PIDã€EOPã€‚</p><p>ä¸‹å›¾ä¸­å„ä¸ªçŸ©å½¢æ¡†å°±å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„åŒ…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol11.png"></p><p>ã€Šåœˆåœˆæ•™ä½ ç© USBã€‹ä¸­æœ‰è¯¦ç»†çš„ç¤ºä¾‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol12.png"></p><h2 id="ä¸­æ–­ä¼ è¾“">ä¸­æ–­ä¼ è¾“</h2><p>ä¸­æ–­ä¼ è¾“ç”¨ä¸­æ–­äº‹åŠ¡æ¥å®ç°ï¼Œç”¨äºä¼ è¾“å°é‡çš„ã€å‘¨æœŸæ€§çš„æ•°æ®ï¼Œæ•°æ®çš„æ­£ç¡®æ€§å’Œæ—¶æ•ˆéƒ½æœ‰ä¿è¯ã€‚</p><p>ä¸­æ–­äº‹åŠ¡ç”± 3 ä¸ªé˜¶æ®µ (phase) ç»„æˆï¼šä»¤ç‰Œé˜¶æ®µã€æ•°æ®é˜¶æ®µã€æ¡æ‰‹é˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œå«æœ‰ SOPã€SYNCã€PIDã€EOPã€‚</p><p>ä¸‹å›¾ä¸­å„ä¸ªçŸ©å½¢æ¡†å°±å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„åŒ…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol13.png"></p><p>ä¸­æ–­äº‹åŠ¡è·Ÿæ‰¹é‡äº‹åŠ¡éå¸¸ç±»ä¼¼ï¼ŒHost ä½¿ç”¨å®ƒæ¥å‘¨æœŸæ€§åœ°è¯»æ•°æ®ã€å†™æ•°æ®ã€‚</p><p>ä»¥é¼ æ ‡ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦åŠæ—¶è·å¾—é¼ æ ‡çš„æ•°æ®ï¼Œä¸åŠæ—¶çš„è¯ä½ ä¼šæ„Ÿè§‰é¼ æ ‡å¾ˆè¿Ÿé’ã€‚ä½†æ˜¯ USB åè®®ä¸­å¹¶æ²¡æœ‰ä¸­æ–­åŠŸèƒ½ï¼Œå®ƒä½¿ç”¨"å‘¨æœŸæ€§çš„è¯»ã€å†™"æ¥å®ç°åŠæ—¶æ€§ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>Host æ¯éš” n æ¯«ç§’å‘å‡ºä¸€ä¸ª IN ä»¤ç‰ŒåŒ…</li><li>é¼ æ ‡æœ‰æ•°æ®çš„è¯ï¼Œå‘å‡º DATA0 æˆ– DATA1 æ•°æ®åŒ…ç»™ Hostï¼›é¼ æ ‡æ²¡æœ‰æ•°æ®çš„è¯ï¼Œå‘å‡º NAK ç»™ Host</li></ul><p>ä¸­æ–­äº‹åŠ¡çš„ä¼˜å…ˆçº§æ¯”æ‰¹é‡äº‹åŠ¡æ›´é«˜ï¼Œå®ƒè¦æ±‚å®æ—¶æ€§ï¼Œè€Œæ‰¹é‡äº‹åŠ¡ä¸è¦æ±‚å®æ—¶æ€§ã€‚</p><h2 id="å®æ—¶ä¼ è¾“">å®æ—¶ä¼ è¾“</h2><p>å®æ—¶ä¼ è¾“ç”¨å®æ—¶äº‹åŠ¡æ¥å®ç°ï¼Œç”¨äºä¼ è¾“å®æ—¶æ•°æ®ï¼Œå¯¹æ•°æ®çš„æ­£ç¡®æ€§æ²¡æœ‰è¦æ±‚ã€‚</p><p>å®æ—¶äº‹åŠ¡ç”± 2 ä¸ªé˜¶æ®µ (phase) ç»„æˆï¼šä»¤ç‰Œé˜¶æ®µã€æ•°æ®é˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œå«æœ‰ SOPã€SYNCã€PIDã€EOPã€‚</p><p>ä¸‹å›¾ä¸­å„ä¸ªçŸ©å½¢æ¡†å°±å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„åŒ…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol14.png"></p><p>å®æ—¶äº‹åŠ¡è·Ÿä¸­æ–­äº‹åŠ¡éå¸¸ç±»ä¼¼ï¼ŒHost ä¹Ÿä¼šå‘¨æœŸæ€§çš„å‘èµ·å®æ—¶äº‹åŠ¡ï¼Œä¸»è¦åŒºåˆ«åœ¨äºï¼š</p><ul><li>å®æ—¶äº‹åŠ¡ä¸è¦æ±‚å‡†ç¡®æ€§ï¼Œæ²¡æœ‰æ¡æ‰‹é˜¶æ®µ</li><li>å®æ—¶äº‹åŠ¡ä¼ è¾“çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œä¸­æ–­äº‹åŠ¡ä¼ è¾“çš„æ•°æ®é‡æ¯”è¾ƒå°</li></ul><h2 id="æ§åˆ¶ä¼ è¾“">æ§åˆ¶ä¼ è¾“</h2><p>åœ¨ä½¿ç”¨æ‰¹é‡ä¼ è¾“æ—¶ï¼Œä½¿ç”¨ IN ä»¤ç‰ŒåŒ…æˆ– OUT ä»¤ç‰ŒåŒ…è¡¨ç¤ºæ•°æ®ä¼ è¾“æ–¹å‘ã€‚</p><p>æ§åˆ¶ä¼ è¾“çš„ä»¤ç‰ŒåŒ…æ°¸è¿œæ˜¯ SETUPï¼Œæ€ä¹ˆåˆ†è¾¨æ˜¯è¯»æ•°æ®ï¼Œè¿˜æ˜¯å†™æ•°æ®ï¼Ÿå‘å‡º SETUP ä»¤ç‰ŒåŒ…åï¼Œè¿˜è¦å‘å‡º DATA0 æ•°æ®åŒ…ï¼Œæ ¹æ®æ•°æ®çš„å†…å®¹æ¥ç¡®å®šåç»­æ˜¯è¯»æ•°æ®ï¼Œè¿˜æ˜¯å†™æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º"å»ºç«‹äº‹åŠ¡"(SETUP Transaction)ã€‚</p><p>ä½†æ˜¯æ§åˆ¶ä¼ è¾“ç”±å¤šä¸ªäº‹åŠ¡ç»„æˆï¼Œè¿™äº›äº‹åŠ¡åˆ†åˆ«å¤„äº 3 ä¸ªè¿‡ç¨‹ï¼šå»ºç«‹è¿‡ç¨‹ (stage)ã€æ•°æ®è¿‡ç¨‹ (stage)ã€çŠ¶æ€è¿‡ç¨‹ (stage)ã€‚</p><ul><li>å»ºç«‹è¿‡ç¨‹ (stage)ï¼Œä½¿ç”¨ SETUP äº‹åŠ¡ï¼šHost å‘å‡º SETUP ä»¤ç‰ŒåŒ…ã€DATA0 æ•°æ®åŒ…ã€å¾—åˆ° ACK æ¡æ‰‹åŒ…</li><li>æ•°æ®è¿‡ç¨‹ (stage)ï¼Œä½¿ç”¨æ‰¹é‡äº‹åŠ¡ï¼š<ul><li>å¯¹äºè¾“å‡ºï¼šHost å‘å‡º OUT ä»¤ç‰ŒåŒ…ï¼Œå‘å‡º DATA0ã€DATA1 æ•°æ®åŒ…ã€å¾—åˆ° ACK æ¡æ‰‹åŒ…</li><li>å¯¹äºè¾“å…¥ï¼šHost å‘å‡º IN ä»¤ç‰ŒåŒ…ï¼Œè¯»åˆ° DATA0ã€DATA1 æ•°æ®åŒ…ã€å‘å‡º ACK æ¡æ‰‹åŒ…</li></ul></li><li>çŠ¶æ€è¿‡ç¨‹ (stage)ï¼Œä½¿ç”¨æ‰¹é‡äº‹åŠ¡ï¼š<ul><li>å¯¹äºè¾“å‡ºï¼šHost å‘å‡º IN ä»¤ç‰ŒåŒ…ï¼Œè¯»åˆ° DATA1 æ•°æ®åŒ…ï¼Œå‘å‡º ACK æ¡æ‰‹åŒ…</li><li>å¯¹äºè¾“å…¥ï¼šHost å‘å‡º OUT ä»¤ç‰ŒåŒ…ï¼Œå‘å‡º DATA1 æ•°æ®åŒ…ï¼Œç­‰å¾… ACK æ¡æ‰‹åŒ…</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol15.png"></p><p>ä¸Šå›¾ä¸­çš„æ¯ä¸€ä¸ªæ–¹æ¡†ï¼Œéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡ï¼Œå«æœ‰ï¼šToken Packetã€Data Packetã€Handshake Packetã€‚</p><h1 id="æŠ“åŒ…">æŠ“åŒ…</h1><p>å®‰è£…"usbprotocolsuite"åï¼Œå¯ä»¥åœ¨æ–‡æ¡£ç›®å½•é‡Œæ‰¾æ‰“å¾ˆå¤šç¤ºç¨‹åºï¼ˆåç¼€åä¸º usb)ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol16.png"></p><p>ä½¿ç”¨"usbprotocolsuite"æ‰“å¼€è¿™äº›æ–‡ä»¶ï¼Œå³å¯ä½“éªŒ USB æ•°æ®ä¼ è¾“ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Protol17.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠéŸ¦ä¸œå±±è€å¸ˆç›¸å…³è¯¾ç¨‹ã€‹<br>ã€Šåœˆåœˆæ•™ä½ ç© USBã€‹ ã€ŠUSB2.0 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>USB å­ç³»ç»Ÿï¼ˆä¸€ï¼‰USB ç”µå™¨ç‰¹æ€§</title>
      <link href="/2023/LinuxDriver/LinuxUSBEletrictFeature/"/>
      <url>/2023/LinuxDriver/LinuxUSBEletrictFeature/</url>
      
        <content type="html"><![CDATA[<p>USB 2.0 åè®®æ”¯æŒ 3 ç§é€Ÿç‡ï¼šä½é€Ÿ (Low Speedï¼Œ1.5Mbps)ã€å…¨é€Ÿ (Full Speed, 12Mbps)ã€é«˜é€Ÿ (High Speed, 480Mbps)ã€‚</p><p>USB Hubã€USB è®¾å¤‡ï¼Œä¹Ÿåˆ†ä¸ºä½é€Ÿã€å…¨é€Ÿã€é«˜é€Ÿä¸‰ç§ç±»å‹ã€‚ä¸€ä¸ª USB è®¾å¤‡ï¼Œå¯èƒ½å…¼å®¹ä½é€Ÿã€å…¨é€Ÿï¼Œå¯èƒ½å…¼å®¹å…¨é€Ÿã€é«˜é€Ÿï¼Œä½†æ˜¯ä¸ä¼šåŒæ—¶å…¼å®¹ä½é€Ÿã€é«˜é€Ÿã€‚</p><span id="more"></span><h1 id="usb-è®¾å¤‡çŠ¶æ€åˆ‡æ¢å›¾">USB è®¾å¤‡çŠ¶æ€åˆ‡æ¢å›¾</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-eletrict-feature.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-description2.png"></p><ul><li>è¿æ¥ (Attached)ï¼šUSB è®¾å¤‡åœ¨å·²è¿æ¥åˆ° USBï¼Œä½†è¿˜æ²¡æœ‰ä¸Šç”µçš„æ—¶å€™å¤„äºè¿æ¥çŠ¶æ€ã€‚</li><li>ä¸Šç”µ (Powered)ï¼šUSB è®¾å¤‡åœ¨å·²è¿æ¥åˆ° USBï¼Œå¹¶ä¸”å·²ç»ä¸Šç”µï¼Œä½†è¿˜æ²¡æœ‰è¢«å¤ä½çš„æ—¶å€™ï¼Œå¤„äºä¸Šç”µçŠ¶æ€ã€‚ USB è®¾å¤‡çš„ç”µæºè·å–åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡å¤–éƒ¨ç”µæºè¿›è¡Œè·å–ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡è®¾å¤‡æ‰€è¿æ¥çš„é›†çº¿å™¨ (hub) å¤„è·å¾—ç”µæºã€‚é€šè¿‡å¤–éƒ¨ä¾›ç”µçš„ USB è®¾å¤‡è¢«ç§°ä¸ºè‡ªä¾›ç”µ (self-powered) è®¾å¤‡ã€‚å°½ç®¡è‡ªä¾›ç”µè®¾å¤‡åœ¨è¿æ¥åˆ° USB ä¹‹å‰å¯èƒ½å·²ç»æœ‰äº†ç”µæºï¼Œä½†åœ¨è¿æ¥åˆ° USB å¹¶ä¸” VBUS è¢«åº”ç”¨åˆ°è®¾å¤‡ä¹‹å‰ï¼Œå®ƒä»¬ä¸è¢«è®¤ä¸ºæ˜¯å¤„äºä¸Šç”µçŠ¶æ€ã€‚USB è®¾å¤‡å¯ä»¥åŒæ—¶æ”¯æŒè‡ªä¾›ç”µå’Œæ€»çº¿ä¾›ç”µ (bus-powered) çš„é…ç½®ã€‚æŸäº›è®¾å¤‡é…ç½®æ”¯æŒä»»ä¸€ç”µæºï¼Œå…¶ä»–è®¾å¤‡é…ç½®å¯èƒ½åªæœ‰åœ¨è®¾å¤‡æ˜¯è‡ªä¾›ç”µçš„æƒ…å†µä¸‹æ‰å¯ç”¨ã€‚è®¾å¤‡é€šè¿‡é…ç½®æè¿°ç¬¦ (configuration descriptor) æŠ¥å‘Šå…¶ç”µæºèƒ½åŠ› (power source capability)ã€‚å½“å‰ç”µæºä½œä¸ºè®¾å¤‡çŠ¶æ€çš„ä¸€éƒ¨åˆ†è¿›è¡ŒæŠ¥å‘Šã€‚</li><li>é»˜è®¤ (Default)ï¼šUSB è®¾å¤‡åœ¨å·²è¿æ¥åˆ° USBï¼Œä¸”å·²ç»ä¸Šç”µï¼Œå¹¶å·²ç»å¤ä½ï¼Œä½†è¿˜æ²¡æœ‰åˆ†é…å”¯ä¸€çš„åœ°å€æ—¶ï¼Œå¤„äºé»˜è®¤çŠ¶æ€ï¼Œè®¾å¤‡å“åº”é»˜è®¤åœ°å€ã€‚ å½“å¤ä½è¿‡ç¨‹å®Œæˆåï¼ŒUSB è®¾å¤‡ä»¥æ­£ç¡®çš„é€Ÿåº¦è¿è¡Œï¼ˆå³ä½é€Ÿ low-speed/å…¨é€Ÿ full-speed/é«˜é€Ÿ high-speedï¼‰ã€‚ä½é€Ÿå’Œå…¨é€Ÿçš„é€Ÿåº¦é€‰æ‹©ç”±è®¾å¤‡ç«¯ç»ˆç«¯ç”µé˜»å†³å®šã€‚ä½œä¸ºå¤ä½è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œèƒ½å¤Ÿé«˜é€Ÿè¿è¡Œçš„è®¾å¤‡å†³å®šæ˜¯å¦ä»¥é«˜é€Ÿè¿è¡Œã€‚</li><li>åœ°å€ (Address)ï¼šUSB è®¾å¤‡åœ¨å·²è¿æ¥åˆ° USBï¼Œä¸”å·²ç»ä¸Šç”µå’Œå¤ä½ï¼Œå¹¶å·²åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„è®¾å¤‡åœ°å€ï¼Œä½†è¿˜æ²¡æœ‰è¢«é…ç½®æ—¶ï¼Œå¤„äºåœ°å€çŠ¶æ€ã€‚ åœ¨å®Œæˆ Set Address è¯·æ±‚åï¼Œå¦‚æœæŒ‡å®šçš„åœ°å€æ˜¯ä¸ªéé›¶åœ°å€ï¼Œåˆ™è®¾å¤‡è¿›å…¥åœ°å€çŠ¶æ€ï¼›å¦åˆ™ï¼Œè®¾å¤‡å°†ä¿æŒå¤„äºé»˜è®¤çŠ¶æ€ã€‚</li><li>é…ç½® (Configured)ï¼šUSB è®¾å¤‡å·²è¿æ¥åˆ° USBï¼Œå·²ä¸Šç”µå’Œå¤ä½ï¼Œå·²åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„è®¾å¤‡åœ°å€ï¼Œå¹¶ä¸”å·²é…ç½®ï¼Œä¸”æœªæŒ‚èµ·ï¼Œå¤„äºé…ç½®çŠ¶æ€ã€‚ é…ç½®è®¾å¤‡æˆ–æ”¹å˜å¤‡ç”¨è®¾ç½®ï¼Œä¼šå¯¼è‡´ä¸å—å½±å“æ¥å£ä¸­çš„ç«¯ç‚¹ç›¸å…³çš„æ‰€æœ‰çŠ¶æ€å’Œé…ç½®å€¼è¢«è®¾ç½®ä¸ºå…¶é»˜è®¤å€¼ã€‚è¿™åŒ…æ‹¬ä»»ä½•ä½¿ç”¨æ•°æ®åˆ‡æ¢ (data toggle) çš„ç«¯ç‚¹å°†å…¶æ•°æ®åˆ‡æ¢ (data toggle) é‡ç½®æˆå€¼ DATA0ã€‚</li><li>æŒ‚èµ· (Suspended)ï¼šUSB è®¾å¤‡åœ¨å·²è¿æ¥åˆ° USBï¼Œä¸”å·²ä¸Šç”µï¼Œå¹¶ä¸” 3ms å†…æœªçœ‹åˆ°æ€»çº¿æ´»åŠ¨æ—¶ï¼ŒUSB è®¾å¤‡ä¼šè¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚</li></ul><h1 id="ç¡¬ä»¶çº¿è·¯">ç¡¬ä»¶çº¿è·¯</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-interface.png"></p><p>USB è¿æ¥æ¶‰åŠ Hub Port å’Œ USB è®¾å¤‡ï¼Œç¡¬ä»¶è¿æ¥å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Hub-Device.png"></p><h1 id="usb-æ€»çº¿ä¿¡å·">USB æ€»çº¿ä¿¡å·</h1><p>USB è¿æ¥çº¿æœ‰ 4 æ¡ï¼š5Vã€D+ã€D-ã€GNDã€‚æ•°æ®çº¿ D+ã€D-ï¼Œåªèƒ½è¡¨ç¤º 4 ç§çŠ¶æ€ã€‚USB åè®®ä¸­ï¼Œå¾ˆå·§å¦™åœ°ä½¿ç”¨è¿™ä¸¤æ¡çº¿è·¯å®ç°äº†ä¿¡å· 1ã€ä¿¡å· 0ã€SE0 çŠ¶æ€ã€SE1 çŠ¶æ€ã€J çŠ¶æ€ã€K çŠ¶æ€ã€ç©ºé—² IDLEã€å¼€å§‹ SOPã€ç»“æŸ EOPã€å¤ä½ Resetã€Suspend ä¿¡å·ã€Resume ä¿¡å·ã€SYNC ä¿¡å·ã€Connect ä¿¡å·ã€Disconnect ä¿¡å·ç­‰ã€‚</p><p><strong>ä½é€Ÿ/å…¨é€Ÿä¿¡å·ç”µå¹³</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Low-Full-speed-signal.png"></p><p><strong>é«˜é€Ÿä¿¡å·ç”µå¹³</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-High-speed-signal.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-High-speed-signal1.png"></p><p><strong>æ•°æ®ä¿¡å·</strong><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-data-signal-packer.png"></p><ul><li>Reset ä¿¡å·ï¼š<ul><li>ä¸»æœºæ‹‰ä½ä¸¤æ ¹ä¿¡å·çº¿ï¼ˆSE0 çŠ¶æ€ï¼‰å¹¶ä¿æŒ 10ms</li><li>USB è®¾å¤‡çœ‹åˆ° Reset ä¿¡å·åï¼Œéœ€è¦å‡†å¤‡æ¥æ”¶"SetAddress()"è¯·æ±‚ï¼›å¦‚æœå®ƒä¸èƒ½å›åº”è¿™ä¸ªè¯·æ±‚ï¼Œå°±æ˜¯"ä¸èƒ½è¯†åˆ«çš„è®¾å¤‡"</li></ul></li><li>Suspend ä¿¡å·ï¼š<ul><li>æ€»çº¿ 3ms ä»¥ä¸Šçš„ IDLE çŠ¶æ€ï¼Œåˆ™è®¾å¤‡ä¼šè®¤ä¸ºä¸»æœºå‘èµ·äº†ä¸€æ¬¡æŒ‚èµ·æ“ä½œ</li></ul></li><li>Resume ä¿¡å·ï¼š<ul><li>Resume ä¿¡å·å¯ä»¥ç”± USB ä¸»æœºå‘èµ·ï¼Œä¹Ÿå¯ä»¥ç”± USB è®¾å¤‡æœ¬èº«è§¦å‘ï¼Œä½†æ˜¯åªæœ‰ USB ä¸»æœºå¯ä»¥ç»“æŸ Resume ä¿¡å·</li><li>ä¸»æœºåœ¨æŒ‚èµ·è®¾å¤‡åå¯é€šè¿‡ç¿»è½¬æ•°æ®çº¿ä¸Šçš„ææ€§å¹¶ä¿æŒ 20ms æ¥å”¤é†’è®¾å¤‡ï¼Œå¹¶ä»¥ä½é€Ÿ EOP ä¿¡å·ç»“å°¾</li><li>å¦‚æœè®¾å¤‡æ”¯æŒè¿œç¨‹å”¤é†’ï¼Œè®¾å¤‡å¯å‘ä¸»æœºå‘èµ·è¿œç¨‹å”¤é†’è¯·æ±‚ï¼Œå‰ææ˜¯è®¾å¤‡å·²è¿›å…¥ idle çŠ¶æ€è‡³å°‘ 5msï¼Œè®¾å¤‡ä¼šé©±åŠ¨æ€»çº¿è¿›å…¥ K çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾ï¼ŒK çŠ¶æ€å¿…é¡»ç»´æŒ 1ms-15ms ä¹‹å†…ï¼Œæ­¤ä¿¡å·ä¼šåœ¨ 1ms å†…è¢«ä¸»æœºæ¥ç®¡ï¼Œä¸»æœºä¼šç»§ç»­é©±åŠ¨å”¤é†’ä¿¡å·ç›´åˆ° 20msï¼Œå¹¶ä»¥ä½é€Ÿ EOP ä¿¡å·ç»“å°¾</li></ul></li><li>SYNC ä¿¡å·ï¼š<ul><li>ä½é€Ÿè®¾å¤‡çš„ SYNC ä¿¡å·ï¼Œ3 ä¸ª KJ çŠ¶æ€çš„åˆ‡æ¢ï¼Œåè·Ÿéš 2 ä½æ—¶é—´çš„ K çŠ¶æ€ï¼Œå®Œæˆä¸€æ¬¡åŒæ­¥ä¿¡å·çš„å‘é€ Idle-K-J-K-J-K-J-K-K</li><li>é«˜é€Ÿæ¨¡å¼ä¸­çš„ SYNC æ ¼å¼ä¸ºï¼šKJKJKJKJ KJKJKJKJ KJKJKJKJ KJKJKJKKï¼Œå³ 15 å¯¹ KJï¼Œå¤–åŠ  2 ä¸ª K</li></ul></li><li><p>Connect ä¿¡å·ï¼š<br>Hub ç«¯å£çš„ D+ã€D-éƒ½æœ‰ 15K çš„ä¸‹æ‹‰ç”µé˜»ï¼Œå¹³æ—¶ä¸ºä½ç”µå¹³ã€‚å…¨é€Ÿè®¾å¤‡å†…éƒ¨çš„ D+æœ‰ 1.5K çš„ä¸Šæ‹‰ç”µé˜»ï¼Œä½é€Ÿè®¾å¤‡å†…éƒ¨çš„ D-æœ‰ 1.5K çš„ä¸Šæ‹‰ç”µé˜»ï¼Œè¿æ¥åˆ° Hub åä¼šå¯¼è‡´ Hub çš„ D+æˆ– D-ç”µå¹³å˜åŒ–ï¼ŒHub æ ¹æ®å˜åŒ–çš„å¼•è„šåˆ†è¾¨æ¥è¿›æ¥çš„æ˜¯å…¨é€Ÿè®¾å¤‡è¿˜æ˜¯ä½é€Ÿè®¾å¤‡ã€‚</p><p>é«˜é€Ÿè®¾å¤‡ä¸€å¼€å§‹ä¹Ÿæ˜¯ä½œä¸ºå…¨é€Ÿè®¾å¤‡è¢«è¯†åˆ«çš„ã€‚</p><p>å…¨é€Ÿè®¾å¤‡ã€é«˜é€Ÿè®¾å¤‡è¿æ¥æ—¶ï¼ŒD+å¼•è„šçš„ç”µå¹³ç”±ä½å˜é«˜ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-High-speed-connected.png"></p><p>ä½é€Ÿè®¾å¤‡è¿æ¥æ—¶ï¼ŒD-å¼•è„šçš„ç”µå¹³ç”±ä½å˜é«˜ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Low-speed-connected.png"></p></li><li><p>Disconnect ä¿¡å·ï¼š<br>å¯¹äºä½é€Ÿã€å…¨é€Ÿè®¾å¤‡ï¼Œæ¥åˆ° Hub æ—¶å¯¼è‡´ D-æˆ– D+å¼•è„šå˜ä¸ºé«˜ç”µå¹³ï¼Œæ–­å¼€è®¾å¤‡åï¼ŒD-æˆ– D+å¼•è„šå˜ä¸ºä½ç”µå¹³ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-disconnected-low-speed.png"></p><p>å¯¹äºé«˜é€Ÿè®¾å¤‡ï¼Œå®ƒå…ˆä½œä¸ºå…¨é€Ÿè®¾å¤‡è¢«è¯†åˆ«å‡ºæ¥ï¼Œç„¶åå†è¢«è¯†åˆ«ä¸ºé«˜é€Ÿè®¾å¤‡ã€‚å·¥ä½œäºé«˜é€Ÿæ¨¡å¼æ—¶ï¼ŒD+çš„ä¸Šæ‹‰ç”µé˜»æ˜¯æ–­å¼€çš„ï¼Œæ‰€ä»¥å¯¹äºå·¥ä½œäºé«˜é€Ÿæ¨¡å¼çš„ USB è®¾å¤‡ï¼Œæ— æ³•é€šè¿‡ D+çš„å¼•è„šç”µå¹³å˜åŒ–ç›‘æµ‹åˆ°å®ƒå·²ç»æ–­å¼€ã€‚</p><p>å·¥ä½œäºé«˜é€Ÿæ¨¡å¼çš„è®¾å¤‡ï¼ŒD+ã€D-ä¸¤è¾¹æœ‰ 45 æ¬§å§†çš„ä¸‹æ‹‰ç”µé˜»ï¼Œç”¨æ¥æ¶ˆé™¤åå°„ä¿¡å·ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Disconnected-full-speed.png"></p><p>å½“æ–­å¼€é«˜é€Ÿè®¾å¤‡åï¼ŒHub å‘å‡ºä¿¡å·ï¼Œå¾—åˆ°çš„åå°„ä¿¡å·æ— æ³•è¡°å‡ï¼ŒHub ç›‘æµ‹åˆ°è¿™äº›ä¿¡å·åå°±çŸ¥é“é«˜é€Ÿè®¾å¤‡å·²ç»æ–­å¼€ï¼Œå†…éƒ¨ç”µè·¯å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Disconnected-full-speed1.png"></p></li><li>SOP ä¿¡å· (Start Of Packet)ï¼š<ul><li>ä½é€Ÿè®¾å¤‡ SOP ä¿¡å·ï¼šæ€»çº¿ä» IDLE çŠ¶æ€ï¼ˆJ çŠ¶æ€ï¼šå·®åˆ† 0ï¼‰åˆ‡åˆ° K çŠ¶æ€ï¼ˆå·®åˆ† 1ï¼‰ï¼Œå³å¯å®Œæˆä½é€Ÿ SOP ä¿¡å·çš„å‘é€</li><li>å…¨é€Ÿè®¾å¤‡ SOP ä¿¡å·ï¼šæ€»çº¿ä» IDLE çŠ¶æ€ï¼ˆJ çŠ¶æ€ï¼šå·®åˆ† 1ï¼‰åˆ‡åˆ° K çŠ¶æ€ï¼ˆå·®åˆ† 0ï¼‰ï¼Œå³å¯å®Œæˆå…¨é€Ÿ SOP ä¿¡å·çš„å‘é€ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-sop-signal.png"></li></ul></li><li>EOP ç»“æŸåŒ…ï¼ˆEnd of Packetï¼‰ï¼š<ul><li>å…¨é€Ÿæˆ–ä½é€Ÿè®¾å¤‡çš„ç»“æŸåŒ…ï¼šSE0 çŠ¶æ€ç”¨äºå‘ä¿¡å·é€šçŸ¥åˆ†ç»„ç»“æŸï¼ˆEOPï¼‰ã€‚ é€šè¿‡å°† D +å’Œ D-é©±åŠ¨åˆ° SE0 çŠ¶æ€ä¸¤ä½æ—¶é—´ï¼Œç„¶åå°†çº¿è·¯é©±åŠ¨åˆ° J çŠ¶æ€ä¸€ä½æ—¶é—´æ¥å‘ä¿¡å·é€šçŸ¥ EOPã€‚ ä» SE0 åˆ° J çŠ¶æ€çš„è½¬æ¢å®šä¹‰äº†æ¥æ”¶å™¨å¤„çš„åˆ†ç»„çš„ç»“æŸã€‚ J çŠ¶æ€è¢«ç½®ä½ä¸€ä¸ªä½æ—¶é—´ï¼Œç„¶å D +å’Œ D-è¾“å‡ºé©±åŠ¨å™¨éƒ½å¤„äºé«˜é˜»æ€ã€‚ æ€»çº¿ç»ˆç«¯ç”µé˜»å°†æ€»çº¿ä¿æŒåœ¨ç©ºé—²çŠ¶æ€<br></li><li>é«˜é€Ÿè®¾å¤‡çš„ EOP: åœ¨é«˜é€Ÿä¿¡å·ä¸­ï¼Œä»¥ä» EOP ä¹‹å‰çš„æœ€åä¸€ä¸ªç¬¦å·åˆ°ç›¸åç¬¦å·çš„è½¬æ¢å¼€å§‹ã€‚è¿™ä¸ªç›¸åçš„ç¬¦å·æ˜¯ EOP æ¨¡å¼ä¸­çš„ç¬¬ä¸€ä¸ªç¬¦å·å¯¹äº SOF ä»¥å¤–çš„é«˜é€Ÿæ•°æ®åŒ…ã€‚æ•…æ„ç”Ÿæˆä½å¡«å……é”™è¯¯ä»¥æŒ‡ç¤º EOPã€‚éœ€è¦æ¥æ”¶å™¨å°†ä»»ä½•ä½é”™è¯¯è§£é‡Šä¸º EOPã€‚å‘é€çš„ EOP å®šç•Œç¬¦å¿…é¡»æ˜¯æ²¡æœ‰ä½å¡«å……çš„ NRZ å­—èŠ‚ 01111111ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ EOP å­—æ®µä¹‹å‰çš„æœ€åä¸€ä¸ªç¬¦å·æ˜¯ Jï¼Œåˆ™è¿™å°†å¯¼è‡´ EOP ä¸º KKKKKKKKã€‚å¯¹äºé«˜é€Ÿ SOFï¼Œä¼ è¾“çš„ EOP åˆ†éš”ç¬¦éœ€è¦ 5 ä¸ª NRZ å­—èŠ‚è€Œä¸éœ€è¦å¡«å……æ¯”ç‰¹ï¼Œç”± 01111111 11111111 11111111 11111111 11111111 ç»„æˆã€‚å› æ­¤ï¼Œå¦‚æœ EOP å­—æ®µä¹‹å‰çš„æœ€åä¸€ä½æ˜¯ Jï¼Œè¿™å°†å¯¼è‡´çº¿è·¯ä¸Šæœ‰ 40 ä¸ª K çŠ¶æ€ï¼Œçº¿è·¯å¿…é¡»è¿”å›åˆ°é«˜é€Ÿç©ºé—²çŠ¶æ€ã€‚é¢å¤–çš„ EOP é•¿åº¦å¯¹æ¥æ”¶å™¨æ²¡æœ‰æ„ä¹‰ï¼Œå®ƒç”¨äºæ–­å¼€æ£€æµ‹<br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-eop-signal.png"></li></ul></li></ul><h1 id="nrzi-ä¸ä½å¡«å……">NRZI ä¸ä½å¡«å……</h1><p>å‚è€ƒæ–‡ç« ï¼š<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NjAwMTg5OTM=">USB çš„ NRZI ä¿¡å·æ ¼å¼<i class="fa fa-external-link-alt"></i></span><br>NRZIï¼šNon Return Zero Inverted Codeï¼Œåå‘ä¸å½’é›¶ç¼–ç ã€‚NRZI çš„ç¼–ç æ–¹ä½ä¸ºï¼šå¯¹äºæ•°æ® 0ï¼Œæ³¢å½¢ç¿»è½¬ï¼›å¯¹äºæ•°æ® 1ï¼Œæ³¢å½¢ä¸å˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-NRZI1.png"></p><p>ä½¿ç”¨ NRZIï¼Œå‘é€ç«¯å¯ä»¥å¾ˆå·§å¦™åœ°æŠŠ"æ—¶é’Ÿé¢‘ç‡"å‘Šè¯‰æ¥æ”¶ç«¯ï¼šåªè¦ä¼ è¾“è¿ç»­çš„æ•°æ® 0 å³å¯ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œä½é€Ÿ/å…¨é€Ÿåè®®ä¸­"Sync Pattern"çš„åŸå§‹æ•°æ®æ˜¯"00000001"ï¼Œæ¥æ”¶ç«¯ä»å‰é¢çš„ 7 ä¸ª 0 æ³¢å½¢å°±å¯ä»¥ç®—å‡º"æ—¶é’Ÿé¢‘ç‡"ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-NRZI2.png"></p><p>NRZI æ•°æ®æ ¼å¼å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>ä½¿ç”¨ NRZI æ—¶ï¼Œå¦‚æœä¼ è¾“çš„æ•°æ®æ€»æ˜¯"1"ï¼Œä¼šå¯¼è‡´æ³¢å½¢ç»´æŒä¸å˜ã€‚å¦‚æœç”µå¹³é•¿æ—¶é—´ç»´æŒä¸å˜ï¼Œæ¯”å¦‚ä¼ è¾“ 100 ä½ 1 æ—¶ï¼Œå¦‚æœæ¥æ”¶æ–¹ç¨æœ‰åå·®ï¼Œå°±å¯èƒ½è®¤ä¸ºæ¥æ”¶åˆ°äº† 99 ä½ 1ã€101 ä½ 1ã€‚è€Œ USB ä¸­é‡‡ç”¨äº† Bit-Stuffing ä½å¡«å……å¤„ç†ï¼Œå³åœ¨è¿ç»­å‘é€ 6 ä¸ª 1 åé¢ä¼šæ’å…¥ 1 ä¸ª 0ï¼Œå¼ºåˆ¶ç¿»è½¬å‘é€ä¿¡å·ï¼Œä»è€Œè®©æ¥æ”¶æ–¹è°ƒæ•´é¢‘ç‡ï¼ŒåŒæ­¥æ¥æ”¶ã€‚è€Œæ¥æ”¶æ–¹åœ¨æ¥æ”¶æ—¶åªè¦æ¥æ”¶åˆ°è¿ç»­çš„ 6 ä¸ª 1 åï¼Œç›´æ¥å°†åé¢çš„ 0 åˆ é™¤å³å¯æ¢å¤æ•°æ®çš„åŸè²Œã€‚</p><h1 id="è®¾å¤‡é€Ÿç‡è¯†åˆ«">è®¾å¤‡é€Ÿç‡è¯†åˆ«</h1><h2 id="ä½é€Ÿå…¨é€Ÿ">ä½é€Ÿ/å…¨é€Ÿ</h2><p>Hub ç«¯å£çš„ D+ã€D-éƒ½æœ‰ 15K çš„ä¸‹æ‹‰ç”µé˜»ï¼Œå¹³æ—¶ä¸ºä½ç”µå¹³ã€‚å…¨é€Ÿè®¾å¤‡å†…éƒ¨çš„ D+æœ‰ 1.5K çš„ä¸Šæ‹‰ç”µé˜»ï¼Œä½é€Ÿè®¾å¤‡å†…éƒ¨çš„ D-æœ‰ 1.5K çš„ä¸Šæ‹‰ç”µé˜»ï¼Œè¿æ¥åˆ° Hub åä¼šå¯¼è‡´ Hub çš„ D+æˆ– D-ç”µå¹³å˜åŒ–ï¼ŒHub æ ¹æ®å˜åŒ–çš„å¼•è„šåˆ†è¾¨æ¥è¿›æ¥çš„æ˜¯å…¨é€Ÿè®¾å¤‡è¿˜æ˜¯ä½é€Ÿè®¾å¤‡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-Low-speed-cable-and-resistor-connections.png"></p><h2 id="é«˜é€Ÿ">é«˜é€Ÿ</h2><p>é«˜é€Ÿè®¾å¤‡å¿…å®šå…¼å®¹å…¨é€Ÿæ¨¡å¼ï¼Œæ‰€ä»¥é«˜é€Ÿè®¾å¤‡å†…éƒ¨ D+ä¹Ÿæœ‰ 1.5K çš„ä¸Šæ‹‰ç”µé˜»ï¼Œåªä¸è¿‡è¿™ä¸ªç”µé˜»æ˜¯å¯ä»¥æ–­å¼€çš„ï¼šå·¥ä½œäºé«˜é€Ÿæ¨¡å¼æ—¶è¦æ–­å¼€å®ƒã€‚</p><p>é«˜é€Ÿè®¾å¤‡é¦–å…ˆä½œä¸ºå…¨é€Ÿè®¾å¤‡è¢«è¯†åˆ«å‡ºæ¥ï¼Œç„¶å Hub å¦‚ä½•ç¡®å®šå®ƒæ˜¯å¦æ”¯æŒé«˜é€Ÿæ¨¡å¼ï¼Ÿ</p><p>Hub ç«¯å£å¦‚ä½•ç›‘æµ‹ä¸€ä¸ªæ–°æ’å…¥çš„ USB è®¾å¤‡èƒ½å¦å·¥ä½œäºé«˜é€Ÿæ¨¡å¼ï¼Ÿæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å¯¹äºä½é€Ÿè®¾å¤‡ï¼ŒHub ç«¯å£ä¸ä¼šç›‘æµ‹å®ƒèƒ½å¦å·¥ä½œäºé«˜é€Ÿæ¨¡å¼ã€‚ä½é€Ÿè®¾å¤‡ä¸èƒ½å…¼å®¹é«˜é€Ÿæ¨¡å¼ã€‚</li><li>Hub ç«¯å£å‘å‡º SE0 ä¿¡å·ï¼ˆ10msï¼‰ï¼Œè¿™å°±æ˜¯å¤ä½ä¿¡å·ã€‚</li><li>USB è®¾å¤‡ç›‘æµ‹åˆ° SE0 ä¿¡å·åï¼Œä¼šå‘å‡º"a high-speed detection handshake"ä¿¡å·è¡¨ç¤ºè‡ªå·±èƒ½æ”¯æŒé«˜é€Ÿæ¨¡å¼ï¼Œè¿™å¯ä»¥ç»†åˆ†ä¸ºä¸€ä¸‹ 3 ç§æƒ…æ™¯ã€‚<ul><li>å¦‚æœ USB è®¾å¤‡åŸæ¥å¤„äº"suspend"çŠ¶æ€ï¼Œå®ƒæ£€æµ‹åˆ° SE0 ä¿¡å·åï¼Œå°±å‘å‡º"a high-speed detection handshake"ä¿¡å·</li><li>å¦‚æœ USB è®¾å¤‡åŸæ¥å¤„äº"non-suspend"çŠ¶æ€ï¼Œå¹¶ä¸”å¤„äºå…¨é€Ÿæ¨¡å¼ï¼Œå®ƒæ£€æµ‹åˆ° SE0 ä¿¡å·åï¼Œå°±å‘å‡º"a high-speed detection handshake"ä¿¡å·ã€‚è¿™ä¸ªæƒ…æ™¯ï¼Œå°±æ˜¯ä¸€ä¸ªè®¾å¤‡åˆšæ’åˆ° Hub ç«¯å£æ—¶çš„æƒ…å†µï¼Œå®ƒä¸€å¼€å§‹å·¥ä½œäºå…¨é€Ÿæ¨¡å¼</li><li>å¦‚æœ USB è®¾å¤‡åŸæ¥å¤„äº"non-suspend"çŠ¶æ€ï¼Œå¹¶ä¸”å¤„äºé«˜é€Ÿæ¨¡å¼ï¼Œå®ƒä¼šåˆ‡æ¢å›åˆ°å…¨é€Ÿæ¨¡å¼ï¼ˆé‡æ–°è¿æ¥ D+çš„ä¸Šæ‹‰ç”µé˜»ï¼‰ï¼Œç„¶åå‘å‡º"a high-speed detection handshake"ä¿¡å·</li></ul></li></ul><p>"a high-speed detection handshake"ä¿¡å·ï¼Œå°±æ˜¯"é«˜é€Ÿè®¾å¤‡ç›‘æµ‹æ¡æ‰‹ä¿¡å·"ï¼Œæ—¢ç„¶æ˜¯æ¡æ‰‹ä¿¡å·ï¼Œè‡ªç„¶æ˜¯æœ‰æ¥æœ‰å›ï¼š</p><ul><li>USB è®¾å¤‡ç»´æŒ D+çš„ä¸Šæ‹‰ç”µé˜»ï¼Œå‘å‡º"Chirp K "ä¿¡å·ï¼Œè¡¨ç¤ºè‡ªå·±èƒ½æ”¯æŒé«˜é€Ÿæ¨¡å¼ã€‚</li><li>å¦‚æœ Hub æ²¡ç›‘æµ‹åˆ°"Chirp K "ä¿¡å·ï¼Œå®ƒå°±çŸ¥é“è¿™ä¸ªè®¾å¤‡ä¸æ”¯æŒé«˜é€Ÿæ¨¡å¼ã€‚</li><li>å¦‚æœ Hub ç›‘æµ‹åˆ°"Chirp K "ä¿¡å·åï¼Œå¦‚æœ Hub èƒ½æ”¯æŒé«˜é€Ÿæ¨¡å¼ï¼Œå°±å‘å‡ºä¸€ç³»åˆ—çš„"Chirp K"ã€"Chirp J"ä¿¡å·ï¼Œè¿™æ˜¯ç”¨æ¥é€šçŸ¥ USB è®¾å¤‡ï¼šHub ä¹Ÿèƒ½æ”¯æŒé«˜é€Ÿæ¨¡å¼ã€‚å‘å‡ºä¸€ç³»åˆ—çš„"Chirp K"ã€"Chirp J"ä¿¡å·åï¼ŒHub ç»§ç»­ç»´æŒ SE0 ä¿¡å·ç›´åˆ° 10msã€‚</li><li>USB è®¾å¤‡å‘å‡º"Chirp K "ä¿¡å·åï¼Œå°±ç­‰å¾… Hub å›åº”ä¸€ç³»åˆ—çš„"Chirp K"ã€"Chirp J"ä¿¡å·ã€‚<ul><li>æ”¶åˆ°ä¸€ç³»åˆ—çš„"Chirp K"ã€"Chirp J"ä¿¡å·ï¼šUSB è®¾å¤‡ç«¯å£ D+çš„ä¸Šæ‹‰ç”µé˜»ï¼Œä½¿èƒ½é«˜é€Ÿæ¨¡å¼</li><li>æ²¡æœ‰æ”¶åˆ°ä¸€ç³»åˆ—çš„"Chirp K"ã€"Chirp J"ä¿¡å·ï¼šUSB è®¾å¤‡è½¬å…¥å…¨é€Ÿæ¨¡å¼</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/USB/USB-High-speed-cable-and-resistor-connections.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaWFpcGFuMTMxNC9hcnRpY2xlL2RldGFpbHMvMTEzNjM5OTEx">https://blog.csdn.net/weiaipan1314/article/details/113639911<i class="fa fa-external-link-alt"></i></span><br>ã€ŠéŸ¦ä¸œå±±è€å¸ˆç›¸å…³è¯¾ç¨‹ã€‹<br>ã€ŠUSB2.0 åè®®è§„èŒƒã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP YUV åŸŸä¹‹ CEï¼ˆContrast Enhancementï¼‰</title>
      <link href="/2023/Camera/CameraISPYUVCE/"/>
      <url>/2023/Camera/CameraISPYUVCE/</url>
      
        <content type="html"><![CDATA[<h1 id="ç›¸å…³æ¦‚å¿µ">ç›¸å…³æ¦‚å¿µ</h1><h2 id="ç›´æ–¹å›¾-histogram">ç›´æ–¹å›¾ Histogram</h2><p>åœ¨åˆ†æå›¾åƒæ•°æ®çš„ç»Ÿè®¡ç‰¹æ€§æ—¶ï¼Œæœ‰æ—¶å¯ä»¥æŠ›å¼ƒå›¾åƒçš„è‰²åº¦åˆ†é‡ï¼Œåªè€ƒå¯Ÿå›¾åƒçš„äº®åº¦åˆ†é‡ï¼Œæ­¤æ—¶å¯ä»¥å¼•å…¥å›¾åƒçš„äº®åº¦ç›´æ–¹å›¾ï¼ˆLuminance Histogramï¼‰ï¼Œä»¥å¸¸ç”¨çš„ 8 ä½ç²¾åº¦å›¾åƒä¸ºä¾‹ï¼Œç›´æ–¹å›¾çš„ X è½´ä¸º 0~255ï¼Œå…± 256 ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶åˆšå¥½è¦†ç›– 1 ä¸ªåƒç´ å€¼ï¼Œç›´æ–¹å›¾çš„ Y è½´è¡¨ç¤ºæ¯ä¸ªæ¡¶ç››çº³äº†å¤šå°‘ä¸ªåƒç´ ã€‚æ‰€æœ‰æ¡¶ä¸­ç››çº³çš„åƒç´ æ•°åŠ åˆ°ä¸€èµ·åº”ç­‰äºå›¾åƒçš„æ€»åƒç´ æ•°ã€‚</p><span id="more"></span><p>åœ¨åˆ†æç”»é¢çš„äº®æš—ç‰¹å¾ï¼Œäººä»¬ç»å¸¸æŠŠäº®åº¦åŒºé—´å®šæ€§åœ°åˆ’åˆ†æˆæš—è°ƒã€é˜´å½±ã€ä¸­è°ƒã€äº®è°ƒã€é«˜å…‰ç­‰å‡ ä¸ªåŒºåŸŸï¼Œå„åŒºåŸŸçš„è¾¹ç•Œåˆ™å¯ä»¥æ ¹æ®åº”ç”¨ç‰¹ç‚¹çµæ´»æŒæ¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce1.png"></p><p>å½“éœ€è¦åˆ†æå›¾åƒçš„é¢œè‰²ç‰¹æ€§æ—¶ï¼Œå¯ä»¥å¼•å…¥é€šé“ç›´æ–¹å›¾ï¼ˆChannel Histogramï¼‰ï¼Œåˆ†åˆ«å¯¹ R/G/B ä¸‰ä¸ªé¢œè‰²é€šé“è¿›è¡Œç›´æ–¹å›¾ç»Ÿè®¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce2.png"></p><h2 id="å¯¹æ¯”åº¦-contrast">å¯¹æ¯”åº¦ Contrast</h2><p>å›¾åƒå¯¹æ¯”åº¦æŒ‡çš„æ˜¯ä¸€å¹…å›¾åƒä¸­æœ€äº®çš„ç™½å’Œæœ€æš—çš„é»‘ä¹‹é—´ç°åº¦åå·®çš„å¤§å°ã€‚å·®å¼‚è¶Šå¤§ä»£è¡¨å¯¹æ¯”è¶Šå¤§ï¼Œå¦åˆ™å¯¹æ¯”è¶Šå°ã€‚ä¸€ç§å¸¸ç”¨çš„å®šé‡åº¦é‡æ–¹æ³•æ˜¯ Michelson å¯¹æ¯”åº¦ï¼Œå®šä¹‰ä¸º</p><p><span class="math display">\[C_M = \frac{I_{Max} - I_{Min}}{I_{Max} + I_{Min}}\]</span></p><p>å½“ä¸€å¹…å›¾åƒæœ€ç™½å’Œæœ€é»‘åƒç´ ç°åº¦éƒ½æ˜¯ 128 æ—¶ï¼Œå›¾åƒå¯¹æ¯”åº¦æœ€ä½ï¼ŒC=0ã€‚ å½“ä¸€å¹…å›¾åƒæœ€ç™½åƒç´ ç°åº¦=255ï¼Œæœ€é»‘åƒç´ ç°åº¦=0 æ—¶ï¼Œå›¾åƒå¯¹æ¯”åº¦æœ€é«˜ï¼ŒC=1.0ã€‚</p><h2 id="å¯¹æ¯”åº¦æ‹‰ä¼¸-contrast-stretching">å¯¹æ¯”åº¦æ‹‰ä¼¸ Contrast Stretching</h2><p>æ—¢ç„¶ææ¸…æ¥šäº†å›¾åƒä¸é€šé€çš„åŸå› ï¼Œå°±å¾ˆå®¹é€šè¿‡æ•°å­¦çš„æ–¹æ³•å°†ä¸€ä¸ªä½å¯¹æ¯”åº¦å›¾åƒå¤„ç†å¾—æ›´é€šé€ä¸€äº›ã€‚ä¸€ç±»ç®€å•æœ‰æ•ˆçš„å¤„ç†æ–¹æ³•å«åšå¯¹æ¯”åº¦æ‹‰ä¼¸ï¼ˆContrast Stretchingï¼‰ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯ç”¨ä¸€ä¸ªä¸‹å›¾æ‰€ç¤ºåˆ†æ®µçº¿æ€§å‡½æ•°ï¼ˆPiece-Wise Linear, PWL Functionï¼‰å¯¹åƒç´ äº®åº¦è¿›è¡Œæ˜ å°„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce3.png"></p><p>è¿™ç§æ–¹æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å¯¹å¾ˆå¤šä½å¯¹æ¯”åº¦å›¾åƒèƒ½å¤Ÿæ”¶åˆ°ç›¸å½“å¥½çš„æ•ˆæœã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce4.png"></p><p>å¯¹æ¯”åº¦æ‹‰ä¼¸çš„å±€é™ï¼šå¯¹æ¯”åº¦æ‹‰ä¼¸é€‚åˆå¤„ç†ä½åŠ¨æ€ï¼ˆLDRï¼‰å›¾åƒï¼Œè¿™ç±»å›¾åƒçš„ç‰¹ç‚¹æ˜¯å¯¹æ¯”åº¦ä½ï¼Œç›´æ–¹å›¾çš„è·¨åº¦è¾ƒå°ï¼Œå­˜åœ¨å‘ä¸¤ææ‹‰ä¼¸çš„ç©ºé—´ã€‚å¯¹äºé«˜åŠ¨æ€ï¼ˆHDRï¼‰å›¾åƒï¼Œç›´æ–¹å›¾è·¨åº¦å·²ç»å¾ˆå¤§ï¼Œå¯¹æ¯”åº¦æ‹‰ä¼¸æ²¡æœ‰æ“ä½œçš„ç©ºé—´ã€‚</p><h1 id="ç›´æ–¹å›¾å‡è¡¡åŒ–-histogram-equalization">ç›´æ–¹å›¾å‡è¡¡åŒ– Histogram Equalization</h1><p>ç›´æ–¹å›¾å‡è¡¡åŒ–è¢«è®¤ä¸ºæ˜¯æå‡å›¾åƒå¯¹æ¯”åº¦æœ€ä¸ºæœ‰æ•ˆçš„æ–¹æ³•ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ç”¨æ•°å­¦æ–¹æ³•é‡æ–°è°ƒæ•´åƒç´ çš„äº®åº¦åˆ†å¸ƒï¼Œä½¿è°ƒæ•´åçš„ç›´æ–¹å›¾å…·æœ‰æœ€å¤§çš„åŠ¨æ€èŒƒå›´ï¼Œæ¯ä¸ªæ¡¶ï¼ˆbin/bucketï¼‰ç››çº³çš„åƒç´ æ•°é‡å‡ ä¹ç›¸ç­‰ã€‚</p><p>ç”¨æ•°å­¦è¯­è¨€æè¿°ï¼Œå‡è®¾å‡è¡¡å‰ç›´æ–¹å›¾çš„åƒç´ å¯†åº¦å‡½æ•°ä¸º p(x)ï¼Œæ¯ä¸ªæ¡¶çš„å®½åº¦ä¸º dxï¼Œåˆ™æ¯ä¸ªæ¡¶çš„åƒç´ æ•°é‡ä¸º p(x)dxã€‚å‡è®¾å‡è¡¡ååƒç´ å¯†åº¦å‡½æ•°ä¸º p(y)ï¼Œä¸” p(y) ä¸ºå¸¸æ•°ï¼Œä¸å¦¨å– 1ã€‚</p><p>ç›´æ–¹å›¾å‡è¡¡çš„æ–¹æ³•æ˜¯ dy=p(x)dxï¼Œæ„ä¹‰æ˜¯å°†æºç›´æ–¹å›¾ dx å®½åº¦æ‰€ç››çº³çš„ p(x)dx ä¸ªåƒç´ æ˜ å°„åˆ°ç›®æ ‡ç›´æ–¹å›¾çš„ dy å®½åº¦ä¸­ï¼Œæ˜ å°„å‰ååƒç´ æ•°é‡ä¸å˜ï¼Œå¯†åº¦å‘ç”Ÿå˜åŒ–ï¼Œæ„ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce5.png"></p><p>æ˜¾ç„¶ç›´æ–¹å›¾å‡è¡¡å‰åå›¾åƒçš„æ€»åƒç´ æ•°é‡åº”ä¿æŒä¸å˜ï¼Œæ‰€ä»¥æœ‰çº¦æŸæ–¹ç¨‹</p><p><span class="math display">\[\int_{0}^{1}  p(x)dx = \int_{0}^{1} dy = 1\]</span></p><p>æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æ±‚è§£ x ä¸ y çš„æ˜ å°„å‡½æ•° y=f(x)ï¼Œè¿™ä¸ªçš„é—®é¢˜å¹¶ä¸å›°éš¾ï¼Œ</p><p><span class="math display">\[y = f(x) = \int_{0}^{x}p(u)du = P(x) - P(0) = P(x) \]</span></p><p>è¿™ä¸ªå…¬å¼å¯ä»¥ç†è§£ä¸ºï¼Œx å¯¹åº”çš„ y å€¼æ˜¯åŸå›¾ä¸Š 0~x è¿™äº›åƒç´ çš„æ¦‚ç‡ä¹‹å’Œã€‚åŸå›¾ä¸­æœ€å¤§çš„ x å¯¹åº” y=1ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce6.png"></p><p>ä¸‹é¢ä¸€ç»„å›¾æ˜¾ç¤ºäº†ç›´æ–¹å›¾å‡è¡¡æ”¹å–„å›¾åƒå¯¹æ¯”åº¦çš„æ•ˆæœã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce7.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce8.png"></p><p>ä¸‹å›¾æ˜¯å¯¹ç›´æ–¹å›¾æ‹‰ä¼¸å’Œå‡è¡¡ä¸¤ç§æ–¹æ³•çš„æ•ˆæœåšæ¯”è¾ƒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce9.png"></p><h1 id="ç›´æ–¹å›¾å‡è¡¡çš„å±€é™">ç›´æ–¹å›¾å‡è¡¡çš„å±€é™</h1><p>æœ´ç´ çš„ç›´æ–¹å›¾å‡è¡¡ç®—æ³•å¯¹æ•´å¹…å›¾åƒçš„åƒç´ ä½¿ç”¨ç›¸åŒçš„å˜æ¢å…¬å¼ï¼Œå½“å›¾åƒåƒç´ å€¼åˆ†å¸ƒæ¯”è¾ƒå‡è¡¡æ—¶æ•ˆæœè¾ƒå¥½ã€‚å¦‚æœå›¾åƒçš„é¢œè‰²æ¯”è¾ƒé›†ä¸­ï¼Œæ¯”å¦‚å­˜åœ¨æ˜æ˜¾çš„æš—åŒºæˆ–äº®åŒºï¼Œåˆ™è¿™äº›åŒºåŸŸçš„å¤„ç†æ•ˆæœä¼šä¸å¤ªç†æƒ³ã€‚</p><h2 id="åˆ†è‰²é—®é¢˜">åˆ†è‰²é—®é¢˜</h2><p>å½“åŸå›¾çš„ç›´æ–¹å›¾æ¯”è¾ƒé›†ä¸­æ—¶ï¼Œè¿™æ„å‘³ç€åŸå›¾å®é™…ä¸Šåªå‡ºç°äº†å°‘æ•°å‡ ä¸ªé¢œè‰²å€¼ï¼Œå¦‚æœå¯¹åŸå›¾è¿›è¡Œæ‹‰ä¼¸æ“ä½œï¼Œåˆ™è¿™äº›é¢œè‰²ä¹‹é—´çš„è·ç¦»å°±ä¼šå˜å¤§ï¼Œç›´æ–¹å›¾ä¸Šç•™ä¸‹äº†æ›´å¤šæ¦‚ç‡ä¸º 0 çš„ç©ºæ´ï¼Œè¿™æ ·ï¼ŒåŸæœ¬æ¯”è¾ƒæ¥è¿‘çš„é¢œè‰²åœ¨æ‹‰ä¼¸åçš„å›¾ä¸Šä¼šå‡ºç°æ˜¾è‘—çš„å·®å¼‚ï¼Œå›¾åƒå‡ºç°é¢œè‰²åˆ†å±‚ç°è±¡ï¼ˆbandingï¼‰ï¼Œæˆ–è€…å«åˆ†è‰²ç°è±¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce10.png"></p><h2 id="å¯¹é½é—®é¢˜">å¯¹é½é—®é¢˜</h2><p>ç›´æ–¹å›¾å‡è¡¡çš„ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯æŠŠåŸå›¾ä¸­æœ€äº®çš„åƒç´ å¯¹é½åˆ°é¢„è®¾çš„æœ€å¤§å€¼ï¼ˆæ¯”å¦‚ 8bit å›¾æ˜¯ 255ï¼‰ã€‚å½“åŸå›¾ä¸­é¢œè‰²æ¯”è¾ƒä¸°å¯Œæ—¶ï¼Œè¿™ä¸ªæ“ä½œä¸€èˆ¬é—®é¢˜ä¸å¤§ã€‚ä½†æ˜¯ä¹Ÿä¼šæœ‰æœ‰ä¸€äº›æ¯”è¾ƒæç«¯çš„æƒ…å†µï¼Œæ¯”å¦‚åŸå›¾ä¸­æ‰€æœ‰åƒç´ éƒ½æ˜¯ä¸€ä¸ªå€¼ï¼ˆä¾‹å¦‚ 8ï¼Œè¿™å¯¹åº”ä¸€å¹…çº¯é»‘çš„å›¾åƒï¼Œå¤šåŠæ˜¯æ‹æ‘„äºå¤œé—´ï¼‰ï¼Œåˆ™å‡è¡¡ä¹‹åæ‰€æœ‰åƒç´ éƒ½è¢«æ˜ å°„åˆ° 255ï¼Œå›¾åƒå˜æˆäº†çº¯ç™½çš„ã€‚äºæ˜¯ï¼Œç›´æ–¹å›¾å‡è¡¡ç›¸å½“äºæ— è„‘æ”¹å˜äº†åŸå›¾çš„è‰²è°ƒï¼Œè€Œä¸ç®¡è¿™ç§æ”¹å˜æ˜¯å¦åˆç†ã€‚</p><h2 id="å™ªå£°é—®é¢˜">å™ªå£°é—®é¢˜</h2><p>ç›´æ–¹å›¾å‡è¡¡ç®—æ³•ä¸€ç§å¸¸è§çš„é—®é¢˜æ˜¯æ”¾å¤§æš—åŒºçš„å™ªå£°ï¼Œå…¶æ ¹æºä¹Ÿæ˜¯å¯¹é½é—®é¢˜ã€‚å¦‚æœä¸€ä¸ªåŒºåŸŸçš„åƒç´ åˆ†å¸ƒå¤§ä½“æ˜¯å‡åŒ€çš„ï¼Œä½†æ˜¯å›¾åƒä¸­å¸¦æœ‰ä¸€äº›å™ªå£°ï¼Œåˆ™ HE å˜æ¢å‡½æ•°ä¼šæŠŠåŸå›¾ä¸­å¾ˆçª„çš„ x å€¼åˆ†å¸ƒæ˜ å°„åˆ°æ•´ä¸ª y å€¼ç©ºé—´ï¼Œè¿™åŒæ—¶ä¹Ÿå°±æ”¾å¤§äº†åŸå›¾ä¸­çš„å™ªå£°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce11.png"></p><h1 id="è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡-adaptive-histogram-equalizationahe">è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡ Adaptive Histogram Equalizationï¼ˆAHE)</h1><p>å‚è€ƒäººç±»è§†è§‰çš„å±€éƒ¨æ€§åŸç†ï¼Œäººä»¬æå‡ºäº†è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡ç®—æ³•ï¼ˆAHEï¼‰ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯å°†å›¾åƒåˆ†æˆè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆtileï¼‰ï¼Œæ¯”å¦‚ 8x8=64 ä¸ª tileï¼Œç›´æ–¹å›¾å‡è¡¡çš„åŸºæœ¬å•ä½ä¸å†æ˜¯æ•´ä¸ªå›¾åƒï¼Œè€Œæ˜¯å¯¹æ¯ä¸ªå°åŒºåŸŸåšç›´æ–¹å›¾å‡è¡¡ã€‚AHE æ›´é€‚åˆäºç”¨æ¥æ”¹å–„å›¾åƒçš„å±€éƒ¨å¯¹æ¯”åº¦ï¼Œä»¥åŠå¢å¼ºå›¾åƒè¾¹ç¼˜ä¿¡æ¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§£å†³ç›´æ–¹å›¾å‡è¡¡ä¼šæ”¾å¤§å›¾åƒå™ªå£°çš„é—®é¢˜ã€‚</p><h2 id="é™åˆ¶å¯¹æ¯”åº¦è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡-clahe">é™åˆ¶å¯¹æ¯”åº¦è‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡ CLAHE</h2><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå¦‚æœåŸå›¾ä¸­æŸäº›é¢œè‰²çš„é¢‘ç‡å¤ªé«˜ï¼ŒæŒ¤å äº†å…¶å®ƒé¢œè‰²çš„æœºä¼šï¼Œå‡è¡¡åçš„å›¾åƒå°±ä¼šå‡ºç°é¢œè‰²åˆ†å±‚ã€è‰²è°ƒå¼‚å¸¸ã€å™ªå£°è¿‡å¤§ç­‰æ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ã€‚</p><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œä¸€ä¸ªæ˜¾ç„¶çš„æ€è·¯å°±æ˜¯æŸæœ‰ä½™è€Œè¡¥ä¸è¶³ï¼Œæˆ–è€…å«å‰Šå³°å¡«è°·ï¼ŒæŠŠæˆ‘ä»¬è®¤ä¸ºå¤šä½™çš„æ¦‚ç‡å¹³å‡åˆ†æ‘Šç»™å…¶å®ƒåƒç´ ï¼Œä½¿äº®åº¦å¢ç›Šç›¸å¯¹å‡åŒ€åœ°æ•£å¸ƒåˆ°æ‰€æœ‰åƒç´ ä¸Šï¼Œè€Œä¸æ˜¯è®©æŸä¸€ä¸ªé¢œè‰²çªç„¶åœ°å¯¹é½åˆ°æœ€å¤§äº®åº¦ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce12.png"></p><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯è®¾è®¡çš„ç®—æ³•å°±æ˜¯ Contrast Limited Adaptive Histogram Equalizationã€‚</p><p>å›å¤´å†æ¥åˆ†æé‚£ä¸ªé»‘å›¾åƒè¢«å¯¹é½åˆ°å…¨ç™½çš„ä¾‹å­ã€‚å¦‚æœç”¨ CLAHE æ¥å¤„ç†è¿™ä¸ªé»‘å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ‹è„‘è¢‹è§„å®šç›´æ–¹å›¾æ¯ä¸ª bin çš„é¢‘æ•°ä¸èƒ½è¶…è¿‡æ€»åƒç´ æ•°çš„ 50%ï¼Œè¶…è¿‡çš„éƒ¨åˆ†è¦è¢«å‡æ‘Šåˆ°å„ä¸ª bin ä¸­ã€‚æ ¹æ®è¿™ä¸ªè§„å®šï¼Œåƒç´  x=8 è¢«æ˜ å°„æˆ</p><p>y=P(8)=0.5*255=128.</p><p>CLAHE æŠŠ x=8 çš„é¢‘æ•°å¼ºåˆ¶åˆ†ç»™äº†å…¶å®ƒ X å€¼ï¼Œä½†æ˜¯ç”±äºåŸå›¾ä¸­å¹¶ä¸å­˜åœ¨æ‰€è°“çš„å…¶å®ƒ X å€¼ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†é¢‘æ•°å®é™…ä¸Šå°±æµªè´¹äº†ï¼Œç›®æ ‡å›¾ä¸­é™¤äº† 128 ä¹‹å¤–ï¼Œæ ¹æœ¬ä¸ä¼šå‡ºç°åˆ«çš„åƒç´ å€¼ã€‚</p><p>ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œç”±äº CLAHE äººä¸ºå‰Šå‡äº†æœ€äº®åƒç´ çš„é¢‘æ•°ï¼Œæ‰€ä»¥ CLAHE å›¾çš„äº®åŒºå¾—åˆ°äº†æŠ‘åˆ¶ï¼Œè€Œæš—åŒºçš„äº®åº¦å¾—åˆ°äº†æ˜æ˜¾çš„æå‡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce13.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ce14.png"></p><p>å¦‚æœä»”ç»†åˆ†æå›¾åƒè´¨é‡çš„è¯ï¼Œè¿™ä¸ªå›¾çš„ç»¿æ¤æ•ˆæœå…¶å®å¹¶ä¸å¥½ï¼Œç»¿å¾—å¾ˆä¸è‡ªç„¶ï¼Œå¯èƒ½è¿˜ä¸å¦‚åŸå›¾çš„æ•ˆæœã€‚å…¶å®åŸå›¾çš„ä¸»è¦é—®é¢˜æ˜¯äº®éƒ¨å¯¹æ¯”åº¦ä¸è¶³ï¼Œéœ€è¦æ‹‰ä¼¸ï¼Œè€Œæš—éƒ¨çš„ç›´æ–¹å›¾åˆ†å¸ƒæ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ï¼Œä¸è°ƒæ•´ä¹Ÿå¯ä»¥ã€‚</p><p>ä»è¿™ä¸ªä¾‹å­æˆ‘ä»¬å‘ç°ï¼Œè¢«å¼ºåˆ¶è£æ‰çš„é¢‘æ•°è¯¥å¦‚ä½•åˆ†é…ä»ç„¶æ˜¯ä¸€ä¸ªå¯ä»¥è®¨è®ºçš„è¯é¢˜ã€‚æœ‰çš„æ—¶å€™å¯èƒ½ç›´æ¥ä¸¢å¼ƒäº†ä¼šæ¯”è¾ƒå¥½ï¼Œå¦‚æœèˆä¸å¾—ä¸¢ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä¼˜å…ˆåˆ†é…ç»™ç¦»æœ¬ä¸»æ¯”è¾ƒè¿‘çš„åƒç´ ã€‚</p><p>å½“ç„¶ï¼Œå•çº¯åœ°é™åˆ¶åƒç´ é¢‘æ•°æ— åŠ©äºè§£å†³é¢œè‰²æ•°é‡ä¸å¤Ÿå¯¼è‡´çš„åˆ†è‰²é—®é¢˜ã€‚å¦‚æœéœ€è¦æ”¹å–„åˆ†è‰²é—®é¢˜ï¼Œåˆ™è¿˜è¦å¼•å…¥æŠ–è‰²ï¼ˆditherï¼‰ä¹‹ç±»çš„æœºåˆ¶ï¼Œè®©åŸæœ¬ä¸€ä¸ªé¢œè‰²éšæœºåœ°æŠ–åŠ¨å˜æˆä¸€äº›ç›¸è¿‘çš„é¢œè‰²ï¼Œä»¥å¡«è¡¥ç›´æ–¹å›¾ä¸­çš„ç©ºæ´ã€‚ä»è§†è§‰æ•ˆæœä¸Šçœ‹ï¼ŒæŠ–è‰²ç›¸å¯¹äºåœ¨å›¾åƒä¸­ä¸»åŠ¨æ·»åŠ å™ªå£°ï¼Œè€Œå™ªå£°ä¼šæ¨¡ç³Šä¸¤å±‚é¢œè‰²ä¹‹é—´çš„è¾¹ç•Œï¼Œèµ·åˆ°å¹³æ»‘è¿‡æ¸¡çš„ä½œç”¨ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNTAzODE5Mzc=">https://zhuanlan.zhihu.com/p/150381937<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP YUV åŸŸä¹‹ HueAndSaturation</title>
      <link href="/2023/Camera/CameraISPYUVHueAndSaturation/"/>
      <url>/2023/Camera/CameraISPYUVHueAndSaturation/</url>
      
        <content type="html"><![CDATA[<h1 id="è‰²è°ƒ-hue">è‰²è°ƒ Hue</h1><h2 id="hue-çš„å®šä¹‰">hue çš„å®šä¹‰</h2><p>hue å¯ä»¥ç†è§£ä¸ºå ä¸»å¯¼åœ°ä½çš„çº¯è‰²é¢œè‰²ï¼Œæˆ–ä¸¤ç§çº¯è‰²é¢œè‰²çš„ç»„åˆã€‚ç®€å•æ¥è¯´ï¼Œhue å°±æ˜¯é¢œè‰²çš„â€œåå­—â€ï¼Œäººä»¬æœ€å¸¸ç”¨é»„è‰²ã€æ©™è‰²ç­‰æ¦‚å¿µæ¥æè¿°ä¸€ä¸ªé¢œè‰²ã€‚ Hue is the color portion of the model, expressed as a number from 0 to 360 degrees. <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/hue1.png"></p><span id="more"></span><ul><li>Red: 0 and 60 degreesã€‚</li><li>Yellow: 61 and 120 degreesã€‚</li><li>Green: 121 and 180 degreesã€‚</li><li>Cyan: 181 and 240 degreesã€‚</li><li>Blue: 241 and 300 degreesã€‚</li><li>Magenta: 301 and 360 degreesã€‚</li></ul><h2 id="è‰²è°ƒæ’å¸¸-hue-constancy">è‰²è°ƒæ’å¸¸ Hue constancy</h2><p>æè¿°ä¸€ä¸ªé¢œè‰²çš„ä¸‰ä¸ªå‚æ•°æ˜¯ hue, lightness, chroma (saturation)ã€‚</p><p>è‰²è°ƒæ’å¸¸æ˜¯æŒ‡ï¼Œå½“é¢œè‰²çš„ lightness/saturation æ”¹å˜æ—¶ï¼Œè‰²è°ƒçš„æ„ŸçŸ¥ï¼ˆsensationï¼‰ä¿æŒä¸å˜ã€‚å¦åˆ™å°±æ˜¯å‘ç”Ÿäº†è‰²è°ƒæ¼‚ç§»ï¼ˆhue shiftï¼‰ã€‚</p><p>Tint = åœ¨ç™½è‰²ï¼ˆæˆ–é«˜äº®ç™½å…‰ï¼‰ä¸­åŠ å…¥çº¯è‰²ã€‚</p><p>Tone = åœ¨ç°è‰²ï¼ˆæˆ–ä¸­ç­‰ç™½å…‰ï¼‰ä¸­åŠ å…¥çº¯è‰²ã€‚</p><p>Shade = åœ¨é»‘è‰²ï¼ˆæˆ–æ— å…‰ï¼‰ä¸­åŠ å…¥çº¯è‰²ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/hue3.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/hue4.png"></p><h2 id="hsv-ç©ºé—´">HSV ç©ºé—´</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/hsv1.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/hsv2.png"></p><h1 id="saturation">Saturation</h1><p>è‰²é¥±å’Œåº¦æ˜¯æŒ‡å½©è‰²çš„çº¯åº¦ï¼Œå³é¢œè‰²æºå…¥ç™½å…‰çš„ç¨‹åº¦ï¼Œæˆ–æŒ‡é¢œè‰²çš„æ·±æµ…ç¨‹åº¦ã€‚æŸå½©è‰²æºå…¥çš„ç™½å…‰è¶Šå¤šï¼Œå…¶è‰²é¥±å’Œåº¦å°±è¶Šä½ï¼›æºå…¥çš„ç™½å…‰è¶Šå°‘ï¼Œå…¶è‰²é¥±å’Œåº¦å°±è¶Šé«˜ã€‚ä¸æºå…¥ç™½å…‰ï¼Œå³ç™½å…‰ä¸ºé›¶ï¼Œåˆ™å…¶è‰²é¥±å’Œåº¦ä¸º 100 % ; å…¨ä¸ºç™½å…‰ï¼Œåˆ™å…¶è‰²é¥±å’Œåº¦ä¸ºé›¶ã€‚</p><p>YCbCr ä¸æ˜¯ä¸€ç§ç»å¯¹è‰²å½©ç©ºé—´ï¼Œæ˜¯ YUV å‹ç¼©å’Œåç§»çš„ç‰ˆæœ¬ã€‚YCbCr çš„ Y ä¸ YUV ä¸­çš„ Y å«ä¹‰ä¸€è‡´ï¼ŒCb å’Œ Cr ä¸ UV åŒæ ·éƒ½æŒ‡è‰²å½©ï¼ŒCb æŒ‡è“è‰²è‰²åº¦ï¼ŒCr æŒ‡çº¢è‰²è‰²åº¦ã€‚åœ¨åº”ç”¨ä¸Šå¾ˆå¹¿æ³›ï¼ŒJPEGã€MPEGã€DVDã€æ‘„å½±æœºã€æ•°ä½ç”µè§†ç­‰çš†é‡‡æ­¤ä¸€æ ¼å¼ã€‚å› æ­¤ä¸€èˆ¬ä¿—ç§°çš„ YUV å¤§å¤šæ˜¯æŒ‡ YCbCrã€‚</p><p>åœ¨ YCbCr ç©ºé—´æ¥çœ‹ï¼ŒCb å’Œ Cr ç­‰äº 128 æ—¶é¥±å’Œåº¦ä¸º 0ï¼Œå›¾åƒç­‰æ•ˆäºç°åº¦å›¾ã€‚|Cr-128|å’Œ|Cr-128|è¶Šå¤§åˆ™é¥±å’Œåº¦ä¹Ÿè¶Šå¤§ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼Œ</p><p><span class="math display">\[f(cb, s) = (cb - 128) * s + 128\]</span></p><p><span class="math display">\[f(cr, s) = (cr - 128) * s + 128\]</span></p><p>å…¶ä¸­ s å³ä¸ºé¥±å’Œåº¦ç³»æ•°ï¼Œä¸€èˆ¬å¯ä»¥å– 0~2ï¼Œå³å…è®¸ä¸€å®šç¨‹åº¦çš„è¿‡é¥±å’Œä»¥å¢åŠ é¢œè‰²çš„é²œè‰³åº¦ã€‚</p><p>è®ºä¸Šé¥±å’Œåº¦è°ƒæ•´ä¹Ÿå¯ä»¥åˆå¹¶åœ¨ CCM æˆ– CSC çŸ©é˜µä¸­ï¼Œå³é¥±å’Œåº¦è°ƒæ•´ä¸é¢œè‰²æ ¡æ­£ (CC) å’Œè‰²å½©ç©ºé—´å˜æ¢ (CSC) åŒæ­¥å®Œæˆï¼Œæ‰€ä»¥åœ¨ä¸€äº› ISP è®¾è®¡ä¸­å¹¶ä¸å•ç‹¬æä¾›è°ƒæ•´é¥±å’Œåº¦çš„æ­¥éª¤ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯èƒ½å¤ŸèŠ‚çœä¸€ä¸ªå¤„ç†æ­¥éª¤ï¼Œå‡å°‘ä¸€ä¸ªå™ªå£°æ¥æºã€‚</p><p>åˆå¹¶ CCMã€CSC å’Œé¥±å’Œåº¦çš„æœ€ç»ˆå˜æ¢çŸ©é˜µçš„è¿‡ç¨‹å¦‚ä¸‹ï¼Œ</p><p><span class="math display">\[\begin{pmatrix}Y \\Cb' \\Cr'\end{pmatrix} = \begin{pmatrix}1  &amp; 0 &amp; 0 \\0  &amp; s &amp; 0\\0  &amp; 0 &amp; s\end{pmatrix}\begin{pmatrix}Y \\Cb \\Cr\end{pmatrix} \]</span></p><p><span class="math display">\[\begin{pmatrix}Y \\Cb' \\Cr'\end{pmatrix} = \begin{pmatrix}1  &amp; 0 &amp; 0 \\0  &amp; s &amp; 0\\0  &amp; 0 &amp; s\end{pmatrix} \cdotC \cdot M \cdot \begin{pmatrix}R \\G \\B\end{pmatrix} \]</span></p><p><span class="math display">\[\begin{pmatrix}Y \\Cb' \\Cr'\end{pmatrix} = D \cdot \begin{pmatrix}R \\G \\B\end{pmatrix} \]</span></p><p>å…¶ä¸­ Cb,Cr å‡å·²è°ƒæ•´ä¸ºä¸­å¿ƒå€¼ä½äº 0ï¼ŒC æ˜¯ä» RGB ç©ºé—´å˜æ¢åˆ° YCbCr ç©ºé—´çš„å˜æ¢çŸ©é˜µï¼ŒM ä¸º CCM çŸ©é˜µï¼Œè€Œ D å°±æ˜¯åˆå¹¶äº†é¥±å’Œåº¦å’Œ CCM çš„è‰²å½©è¿˜åŸçŸ©é˜µã€‚å½“ç³»ç»Ÿéœ€è¦è°ƒæ•´é¥±å’Œåº¦æˆ– CCM æ—¶ï¼Œæ§åˆ¶è½¯ä»¶ä¼šæ ¹æ®å½“å‰çš„é¥±å’Œåº¦å’Œ CCM å‚æ•°é‡æ–°è®¡ç®—è‰²å½©è¿˜åŸçŸ©é˜µã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgzMjM2Ng==">https://zhuanlan.zhihu.com/p/98832366<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgzMzAzOA==">https://zhuanlan.zhihu.com/p/98833038<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDUxNzg1MTQ=">https://zhuanlan.zhihu.com/p/145178514<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP YUV åŸŸä¹‹ EdgeEnhancement</title>
      <link href="/2023/Camera/CameraISPYUVEdgeEnhancement/"/>
      <url>/2023/Camera/CameraISPYUVEdgeEnhancement/</url>
      
        <content type="html"><![CDATA[<h1 id="retinex-ç†è®º">Retinex ç†è®º</h1><p>Retinex è¿™ä¸ªè¯ç”± Retina å’Œ Cortex ä¸¤ä¸ªå•è¯ç»„æˆã€‚åœ¨ Retinex ç†è®ºä¸­ï¼Œç‰©ä½“çš„é¢œè‰²æ˜¯ç”±ç‰©ä½“å¯¹é•¿æ³¢ã€ä¸­æ³¢å’ŒçŸ­æ³¢å…‰çº¿çš„åå°„èƒ½åŠ›å†³å®šçš„ï¼Œè€Œä¸æ˜¯ç”±åå°„å…‰å¼ºåº¦çš„ç»å¯¹å€¼å†³å®šçš„ï¼Œå¹¶ä¸”ç‰©ä½“çš„è‰²å½©ä¸å—å…‰ç…§éå‡æ€§çš„å½±å“ï¼Œå…·æœ‰ä¸€è‡´æ€§ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ee1.png"></p><span id="more"></span><p>åœ¨ Retinex ç†è®ºä¸­ï¼Œäººçœ¼å¾—åˆ°çš„å›¾åƒæ•°æ®å–å†³äºå…¥å°„å…‰å’Œç‰©ä½“è¡¨é¢å¯¹å…¥å°„å…‰çš„åå°„ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒI(x,y) æ˜¯æˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„å›¾åƒæ•°æ®ï¼Œå…ˆæ˜¯ç”±å…¥å°„å…‰ç…§å°„ï¼Œç„¶åç»ç”±ç‰©ä½“åå°„è¿›å…¥æˆåƒç³»ç»Ÿï¼Œæœ€ç»ˆå½¢æˆæˆ‘ä»¬æ‰€çœ‹åˆ°çš„å›¾åƒã€‚è¯¥è¿‡ç¨‹å¯ä»¥ç”¨å…¬å¼è¡¨ç¤ºï¼š</p><p><span class="math display">\[I(x,y) = R(x,y) \cdot  L(x,y)\]</span></p><p>å…¶ä¸­ï¼ŒI(x,y) ä»£è¡¨è¢«è§‚å¯Ÿæˆ–ç…§ç›¸æœºæ¥æ”¶åˆ°çš„å›¾åƒä¿¡å·ï¼›L(x,y) ä»£è¡¨ç¯å¢ƒå…‰çš„ç…§å°„åˆ†é‡ ï¼›R(x,y) è¡¨ç¤ºæºå¸¦å›¾åƒç»†èŠ‚ä¿¡æ¯çš„ç›®æ ‡ç‰©ä½“çš„åå°„åˆ†é‡ã€‚å°†è¯¥å¼å­ä¸¤è¾¹å–å¯¹æ•°ï¼Œå¯ä»¥å¾—åˆ°ç‰©ä½“åŸæœ¬çš„ä¿¡æ¯ï¼š</p><p><span class="math display">\[log[I(x,y)] = log[R(x,y)] - log[L(x,y)]\]</span></p><p>åœ¨å›¾åƒå¤„ç†é¢†åŸŸï¼Œå¸¸å°†è¯¥ç†è®ºç”¨äºå›¾åƒå¢å¼ºï¼Œä¸ºäº†å¾—åˆ°æˆåƒæ›´å¥½çš„å›¾ç‰‡ã€‚è¿™æ—¶ï¼ŒR(x,y) è¡¨ç¤ºä¸ºå›¾åƒå¢å¼ºå¾—åˆ°åçš„å›¾åƒï¼ŒI(x,y) ä¸ºåŸå§‹çš„å›¾åƒã€‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­ L(x,y) å¸¸ä¸º I(x,y) é«˜é€šæ»¤æ³¢ä¹‹åçš„ç»“æœï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–æ»¤æ³¢çš„æ–¹æ³•ï¼Œæ¯”å¦‚ä¸­å€¼æ»¤æ³¢ï¼Œå‡å€¼æ»¤æ³¢ç­‰ç­‰ã€‚</p><h1 id="ssr-ç®—æ³•">SSR ç®—æ³•</h1><p>SSR (Singal Scale Retinex)ï¼Œå³å•å°ºåº¦è§†ç½‘è†œç®—æ³•æ˜¯ Retinex ç®—æ³•ä¸­æœ€åŸºç¡€çš„ä¸€ä¸ªç®—æ³•ã€‚è¿ç”¨çš„å°±æ˜¯ä¸Šé¢çš„æ–¹æ³•ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>è¾“å…¥åŸå§‹å›¾åƒ I(x,y) å’Œæ»¤æ³¢çš„åŠå¾„èŒƒå›´ sigmaã€‚</li><li>è®¡ç®—åŸå§‹å›¾åƒ I(x,y) é«˜æ–¯æ»¤æ³¢åçš„ç»“æœï¼Œå¾—åˆ° L(x,y)ã€‚</li><li>æŒ‰ç…§å…¬å¼è®¡ç®—ï¼Œå¾—åˆ° Log[R(x,y)]ã€‚</li><li>å°†å¾—åˆ°çš„ç»“æœé‡åŒ–ä¸º [0, 255] èŒƒå›´çš„åƒç´ å€¼ï¼Œç„¶åè¾“å‡ºç»“æœå›¾åƒã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ€åä¸€æ­¥é‡åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸æ˜¯å°† Log[R(x,y)] è¿›è¡Œ Exp åŒ–å¾—åˆ° R(x,y) çš„ç»“æœï¼Œè€Œæ˜¯ç›´æ¥å°† Log[R(x,y)] çš„ç»“æœç›´æ¥ç”¨å¦‚ä¸‹å…¬å¼è¿›è¡Œé‡åŒ–ï¼š</p><p><span class="math display">\[R(x,y) = \frac{Value - Min}{Max - Min} * 255\]</span></p><p>å°†è¿‡ç¨‹æ•´åˆåœ¨ä¸€èµ·å°±æ˜¯å¦‚ä¸‹è¿‡ç¨‹ï¼š</p><p><span class="math display">\[R_{SSR_i}(x,y,\delta) = log(I_i(x,y)) - log(I_i(x,y) * G(x,y, \delta))\]</span></p><p>G(x,y) ä»£è¡¨é«˜æ–¯æ ¸ï¼ŒRetinex ç®—æ³•æ˜¯å»æ‰å…‰ç…§çš„å½±å“ï¼Œè¿˜åŸå›¾åƒçš„æœ¬æ¥é¢ç›®ã€‚</p><h1 id="msr-ç®—æ³•">MSR ç®—æ³•</h1><p>MSR æ˜¯åœ¨ SSR åŸºç¡€ä¸Šå‘å±•æ¥çš„ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥åŒæ—¶ä¿æŒå›¾åƒé«˜ä¿çœŸåº¦ä¸å¯¹å›¾åƒçš„åŠ¨æ€èŒƒå›´è¿›è¡Œå‹ç¼©çš„åŒæ—¶ï¼ŒMSR ä¹Ÿå¯å®ç°è‰²å½©å¢å¼ºã€é¢œè‰²æ’å¸¸æ€§ã€å±€éƒ¨åŠ¨æ€èŒƒå›´å‹ç¼©ã€å…¨å±€åŠ¨æ€èŒƒå›´å‹ç¼©ï¼Œä¹Ÿå¯ä»¥ç”¨äº X å…‰å›¾åƒå¢å¼ºã€‚</p><p>ä¸ºäº†å¾—åˆ°æ›´å¥½çš„æ•ˆæœï¼Œäººä»¬åˆå¼€å‘å‡ºæ‰€è°“çš„å¤šå°ºåº¦è§†ç½‘è†œå¢å¼ºç®—æ³•ï¼ˆMSRï¼Œ Multi-Scale Retinexï¼‰ï¼Œæœ€ä¸ºç»å…¸çš„å°±æ˜¯ 3 å°ºåº¦çš„ï¼Œå¤§ã€ä¸­ã€å°ï¼Œæ—¢èƒ½å®ç°å›¾åƒåŠ¨æ€èŒƒå›´çš„å‹ç¼©ï¼Œåˆèƒ½ä¿æŒè‰²æ„Ÿçš„ä¸€è‡´æ€§è¾ƒå¥½ã€‚åŒå•å°ºåº¦ç›¸æ¯”ï¼Œè¯¥ç®—æ³•æœ‰åœ¨è®¡ç®— Log[R(x,y)] çš„å€¼æ—¶æ­¥éª¤æœ‰æ‰€ä¸åŒï¼š</p><ul><li>éœ€è¦å¯¹åŸå§‹å›¾åƒè¿›è¡Œæ¯ä¸ªå°ºåº¦çš„é«˜æ–¯æ¨¡ç³Šï¼Œå¾—åˆ°æ¨¡ç³Šåçš„å›¾åƒ Li(x,y), å…¶ä¸­å°æ ‡ i è¡¨ç¤ºå°ºåº¦æ•°ã€‚</li><li>å¯¹æ¯ä¸ªå°ºåº¦ä¸‹è¿›è¡Œç´¯åŠ è®¡ç®—ã€‚</li></ul><p>å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span class="math display">\[R_{MSR}(x,y,\delta) = \sum_{k=1}^{n}w_kR_{SSR_k}(x,y,\delta_k)   \]</span></p><p>å…¶ä¸­ n æ˜¯å°ºåº¦çš„æ•°é‡ï¼Œ<span class="math inline">\(\delta = {\delta 1,\delta 2,...\delta n}\)</span> æ˜¯é«˜æ–¯æ¨¡ç³Šç³»æ•°çš„å‘é‡ï¼Œ<span class="math inline">\(w_k\)</span> æ˜¯ä¸ç¬¬ k ä¸ªå°ºåº¦ç›¸å…³çš„æƒé‡ï¼Œå…¶ä¸­ <span class="math inline">\(w_1 + w_2 + ... w_n = 1\)</span></p><h1 id="msrcr-ç®—æ³•">MSRCR ç®—æ³•</h1><p>ç”±äº R æ˜¯å¯¹æ•°åŸŸçš„è¾“å‡ºï¼Œè¦è½¬æ¢ä¸ºæ•°å­—å›¾åƒï¼Œå¿…é¡»å°†ä»–ä»¬é‡åŒ–ä¸º [0,255] çš„æ•°å­—å›¾åƒèŒƒç•´ï¼Œå…³äºè¿™ä¸ªé‡åŒ–çš„ç®—æ³•ï¼Œæœ‰è¿™æä¸ºé‡è¦çš„æ„ä¹‰ï¼Œä»–çš„å¥½åç›´æ¥å†³å®šäº†æœ€ç»ˆè¾“å‡ºçš„å›¾åƒçš„å“è´¨ã€‚ç›®å‰ï¼Œç»“åˆä¸Šè¿°æ–‡ç« ä¸­æå‡ºçš„ä¸€äº›è¿‡ç¨‹ï¼Œæœ‰ 4 ç§æ–¹å¼è¿›è¡Œå¤„ç†ï¼š</p><ul><li><p>ç›´æ¥çº¿æ€§é‡åŒ–ï¼Œå³é‡‡ç”¨ä¸‹å¼è¿›è¡Œå¤„ç†ã€‚ <span class="math display">\[  R_{MSRCR_i}(x,y) = \frac{R_{MSRCR_i}(x,y) - Min(R_{MSRCR_i}(x,y))}{Max(R_{MSRCR_i}(x,y)) -  Min(R_{MSRCR_i}(x,y))} * 255  \]</span></p></li><li><p>åœ¨ç»å…¸çš„ MSRCR æ–‡ç« ã€ŠA Multiscale Retinex for Bridging the Gap Between Color Images and the Human Observation of Scenesã€‹ä¸­æå‡ºçš„ Canonical Gain/set ç®—æ³•ã€‚ <span class="math display">\[ R_{MSRCR_i}(x,y) = G[R_{MSRCR_i}(x,y) - b] \]</span> å…¶ä¸­ G å’Œ b ä¸ºç»éªŒå‚æ•°ã€‚</p></li><li><p>ç§æ–¹å¼çš„å¤„ç†ç±»ä¼¼äº Photoshop ä¸­çš„è‡ªåŠ¨è‰²é˜¶ï¼Œä»–æŠŠæ•°æ®æŒ‰ç…§ä¸€å®šçš„ç™¾åˆ†æ¯”å»é™¤æœ€å°å’Œæœ€å¤§çš„éƒ¨åˆ†ï¼Œç„¶åä¸­é—´çš„éƒ¨åˆ†é‡æ–°çº¿æ€§é‡åŒ–åˆ° 0 å’Œ 255 ä¹‹é—´ã€‚</p></li></ul><p>åœ¨ç”¨ç¬¬äºŒç§æˆ–ç¬¬ä¸‰ç§æ–¹å¼å¤„ç†æ—¶ï¼Œæœ€å¥½è¿˜éœ€è¦æœ‰ä¸ª Color Restoration çš„è¿‡ç¨‹ï¼Œå› ä¸ºå¦‚æœç›´æ¥å¯¹ MSR å¤„ç†çš„ç»“æœè¿›è¡Œé‡åŒ–ï¼Œå¾—åˆ°çš„å›¾åƒå¾€å¾€æ•´ä½“åç°åº¦ï¼Œè¿™æ˜¯ç”±äºåŸå§‹çš„å½©è‰²å€¼ç»è¿‡ log å¤„ç†åçš„æ•°æ®èŒƒå›´å°±æ¯”è¾ƒå°äº†ï¼Œè¿™æ ·å„é€šé“ä¹‹é—´çš„å·®å¼‚ä¹Ÿå¾ˆå°ï¼Œè€Œä¹‹åçš„çº¿æ€§é‡åŒ–æ¯” log æ›²çº¿è¦å¹³æ»‘å¾ˆå¤šï¼Œå› æ­¤æ•´ä½“å°±ä¸§å¤±äº†å½©è‰²ã€‚è®ºæ–‡ä¸­æå‡ºäº†ä¿®æ­£æ–¹å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[I_{i}^{'}(x,y) = \frac{I_{i}(x,y)}{ {\textstyle \sum_{j=1}^{S}} I_{j}(x,y)} \]</span></p><p><span class="math display">\[C_i(x,y) = \beta log[\alpha I_{i}^{'}(x,y)]\]</span></p><p><span class="math display">\[R_{MSRCR_i}(x,y) = C_i(x,y)R_{MSR_i}(x,y)\]</span></p><p>å¯¹äºä¸€äº›åŸå§‹å›¾åƒ HUE è¾ƒä¸ºåˆç†çš„å›¾ï¼Œå¦‚æœç”¨ç»å…¸çš„ MSRCR ç®—æ³•ï¼Œä¼šå¯¼è‡´å¤„ç†åçš„å›¾å®¹æ˜“åè‰²ï¼Œä¸Šè¿°è®ºæ–‡æå‡ºäº†å¯¹å›¾åƒçš„ Intensity æ•°æ®è¿›è¡Œ Retinex å¤„ç†ï¼Œç„¶åå†æŠŠæ•°æ®æ ¹æ®åŸå§‹çš„ RGB çš„æ¯”ä¾‹æ˜ å°„åˆ°æ¯ä¸ªé€šé“ï¼Œè¿™æ ·å°±èƒ½åœ¨ä¿ç•™åŸå§‹é¢œè‰²åˆ†å¸ƒçš„åŸºç¡€ä¸Šå¢å¼ºå›¾åƒï¼Œæ–‡ç« ä¸­ç§°å…¶ä¸º MSRCPã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x6MDQ5OS9hcnRpY2xlL2RldGFpbHMvODExNTQ5Mzc=">https://blog.csdn.net/lz0499/article/details/81154937<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNDIyMzY0">https://cloud.tencent.com/developer/article/1422364<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vSW1hZ2VzaG9wL2FyY2hpdmUvMjAxMy8wNC8xNy8zMDI2ODgxLmh0bWw=">https://www.cnblogs.com/Imageshop/archive/2013/04/17/3026881.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP Raw åŸŸä¹‹ BayerDemosaic</title>
      <link href="/2023/Camera/CameraISPRawBayerDemosaic/"/>
      <url>/2023/Camera/CameraISPRawBayerDemosaic/</url>
      
        <content type="html"><![CDATA[<h1 id="bayer-demosaic-æ¦‚è¿°">Bayer Demosaic æ¦‚è¿°</h1><p>RAW åŸŸçš„æœ€åä¸€æ­¥å¤„ç†æ˜¯ Demosaicï¼Œå°†åƒç´ ä» RAW åŸŸå˜æ¢åˆ° RGB åŸŸè¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„å¤„ç†ã€‚Demosaic ç®—æ³•çš„ä¸»è¦éš¾ç‚¹åœ¨äºï¼ŒRAW åŸŸçš„ä»»ä½•ä¸€ä¸ªåƒç‚¹ï¼ˆphotositeï¼‰åªåŒ…å«ä¸€ä¸ªçœŸå®çš„é‡‡æ ·å€¼ï¼Œè€Œæ„æˆåƒç´ ï¼ˆR,G,Bï¼‰çš„å…¶å®ƒä¸¤ä¸ªå€¼éœ€è¦ä»å‘¨å›´åƒç‚¹ä¸­é¢„æµ‹å¾—åˆ°ã€‚æ—¢ç„¶æ˜¯é¢„æµ‹ï¼Œå°±ä¸€å®šä¼šå‘ç”Ÿé¢„æµ‹ä¸å‡†çš„æƒ…å†µï¼Œè¿™æ˜¯ä¸å¯é¿å…çš„ï¼Œè€Œé¢„æµ‹ä¸å‡†ä¼šå¸¦æ¥å¤šç§è´Ÿé¢å½±å“ï¼ŒåŒ…æ‹¬æ‹‰é“¾æ•ˆåº”ï¼ˆzipper artifactsï¼‰ï¼Œè¾¹ç¼˜æ¨¡ç³Šï¼Œé¢œè‰²è¯¯å·®ç­‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline18.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline19.png"></p><span id="more"></span><p>æ‰€ä»¥ Demosaic ç®—æ³•çš„ä¸»è¦æŒ‘æˆ˜å°±æ˜¯å°½é‡æé«˜ç®—æ³•çš„å‡†ç¡®æ€§ï¼Œå‡å°‘å›¾åƒè¾¹ç¼˜æŸå¤±å’Œé¢œè‰²è¯¯å·®ã€‚</p><p>Bayer æ ¼å¼å›¾åƒè‰²å½©æ¢å¤æ—¶æœ‰ä¸¤ç§æ€è·¯ï¼š</p><ul><li>æ— æ–¹å‘æ€§æ’å€¼ï¼šä¸åŠ è¾¹ç¼˜æ–¹å‘åˆ¤æ–­ï¼ˆæ€è·¯ï¼šä¸´è¿‘åƒç´ çš„å‡å€¼ï¼‰ï¼Œç›´æ¥åˆ©ç”¨å‘¨å›´åƒç´ ä¿¡æ¯æ¢å¤ã€‚</li><li>æœ‰æ–¹å‘æ€§æ’å€¼ï¼šå…ˆåˆ¤æ–­è¾¹ç¼˜æ–¹å‘ï¼Œå†åˆ©ç”¨å‘¨å›´åƒç´ ä¿¡æ¯æ¢å¤ã€‚</li></ul><p>Bayer æ ¼å¼å›¾åƒçš„ç»¿è‰²æˆåˆ†å æ¯”ä¾‹è¾ƒå¤šï¼Œä¿¡æ¯è¾ƒä¸°å¯Œï¼Œè‰²å½©æ¢å¤æ—¶æ­¥éª¤é€šå¸¸æ˜¯ï¼šaã€å…ˆæ¢å¤ G é€šé“ï¼›bã€å†åˆ©ç”¨ G é€šé“ä¿¡æ¯æ¢å¤ Rã€B é€šé“ã€‚</p><h1 id="cfa-åŒçº¿æ€§æ’å€¼">CFA åŒçº¿æ€§æ’å€¼</h1><h2 id="æ— è¾¹ç¼˜æ£€æµ‹">æ— è¾¹ç¼˜æ£€æµ‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/dm1.png"></p><ul><li><p>ç»¿è‰²åƒç´ ä¸Šçš„ Rï¼ŒB å€¼åˆ†åˆ«ç”±ç›¸é‚»çš„ 2 ä¸ª Rï¼ŒB åƒç´ çš„ç°åº¦æ±‚å¹³å‡å€¼å¾—åˆ°ã€‚ ä»¥è±¡ç´ ç‚¹ (2ï¼Œ3) ä¸ºä¾‹ï¼Œå³å·²çŸ¥ G23 è¯¥ç‚¹çš„ Rï¼ŒB å€¼è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š <span class="math display">\[  R_{23} = \frac{R_{13} + R_{33}}{2}  \]</span> B_{23} =  $$</p></li><li><p>çº¢ã€è“åƒç´ ä¸Šçš„ G å€¼ç”±ç›¸é‚»çš„ 4 ä¸ªç»¿è‰²åƒç´ æ±‚å¹³å‡å€¼å¾—åˆ°ã€‚ å¦‚å›¾ä¸­è±¡ç´ ç‚¹ (3ï¼Œ3) å’Œ (4ï¼Œ4)ï¼Œå³å·²çŸ¥ R33 å’Œ B44 è¿™ä¸¤ç‚¹çš„ç»¿è‰²åˆ†é‡å€¼è¡¨ç¤ºä¸º <span class="math display">\[  G_{33} = \frac{G_{23} + G_{43} + G_{32} + G_{34}}{4}  \]</span></p><p><span class="math display">\[  G_{44} = \frac{G_{34} + G_{54} + G_{43} + G_{45}}{4}  \]</span></p></li><li><p>çº¢è‰²åƒç´ ä¸Šçš„ B å€¼ç”±å¯¹è§’çº¿ä¸Šç›¸é‚»çš„ 4 ä¸ª B åƒç´ å¹³å‡å¾—åˆ°ã€‚è±¡ç´ ç‚¹ (3ï¼Œ3) ï¼ŒR33 çš„ B å€¼è¡¨ç¤ºä¸ºã€‚ <span class="math display">\[  B_{33} = \frac{B_{22} + B_{24} + B_{42} + B{44}}{4}  \]</span> è“è‰²åƒç´ ä¸Šçš„ R å€¼ç”±å¯¹è§’çº¿ä¸Šç›¸é‚»çš„ 4 ä¸ª R åƒç´ å¹³å‡å¾—åˆ°ã€‚è±¡ç´ ç‚¹ (4ï¼Œ4)ï¼ŒB44 çš„ R å€¼è¡¨ç¤ºä¸º <span class="math display">\[  R_{44} = \frac{R_{33} + R_{35} + R_{53} + R_{55}}{4}  \]</span></p></li></ul><p>è¾¹ç¼˜æ£€æµ‹ï¼Œç›´æ¥é‡‡ç”¨æœ€è¿‘ä¸´åŒè‰²åƒç´ çš„å‡å€¼æ±‚è§£ï¼Œå›¾åƒè¾¹ç¼˜ä¸å¤Ÿæ¸…æ™°ï¼Œç®—æ³•ç®€å•ã€‚</p><h2 id="åŸºäºè¾¹ç¼˜æ£€æµ‹å’Œè‰²å·®çš„-cfa-æ’å€¼hibbard-åŸç†">åŸºäºè¾¹ç¼˜æ£€æµ‹å’Œè‰²å·®çš„ CFA æ’å€¼ï¼šHibbard åŸç†</h2><p>G åˆ†é‡çš„æ¢å¤åŠ å…¥äº†ç›¸é‚» G é€šé“çš„ä¸€é˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ã€‚ä½¿ç”¨å‘¨å›´ G é€šé“å€¼ä¿¡æ¯ã€‚</p><ul><li><p>æ¢å¤é‡‡æ ·ç‚¹ R å’Œ B ç‚¹çš„ç»¿è‰²åˆ†é‡ï¼šä¾‹ B44ã€‚ æ¢¯åº¦å› å­ï¼šæ°´å¹³æ–¹å‘ H <span class="math display">\[  \alpha = \left | G_{43} - G_{45} \right |   \]</span> ç«–ç›´æ–¹å‘ Wï¼š <span class="math display">\[  \beta = \left | G_{34} - G_{54} \right |   \]</span> å˜åŒ–å°çš„æ–¹å‘å¯èƒ½æ˜¯è¾¹ç¼˜ï¼Œæ‰€ä»¥ G44 è¡¨ç¤ºå¦‚ä¸‹ï¼š <span class="math display">\[  G_{44} = \frac{G_{43} + G_{45}}{2} (\alpha &lt; \beta)  \]</span> G_{44} =  (&gt; ) <span class="math display">\[  G_{44} = \frac{G_{34} + G_{54} + G_{43} + G_{45}}{4} (\alpha = \beta)  \]</span></p></li><li><p>å¯¹ Rã€B åˆ†é‡æ’å€¼ã€‚åŸºæœ¬æ€æƒ³æ˜¯åœ¨å›¾ç‰‡çš„å°å¹³æ»‘åŒºåŸŸå†…ï¼Œè‰²å·®æ’å®šçš„ã€‚å‡è®¾åƒç´ ç‚¹ P(iï¼Œj) é‚»è¿‘çš„ä¸€ä¸ªåƒç´ ç‚¹æ˜¯ P(mï¼Œn) åˆ™æœ‰ï¼š <span class="math display">\[  R_{ij} - G_{ij} = R_{mn} - G_{mn} \\  B_{ij} - G_{ij} = B_{mn} - G_{mn}  \]</span> ä¾‹æ±‚ R åˆ†é‡ï¼š å¦‚å·²çŸ¥ G43ï¼Œçº¢è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  R_{43} = \frac{R_{33} + R_{35}}{2} - \frac{G_{33} + G_{35}}{2} + G_{43}  \]</span> å¦‚å·²çŸ¥ G34ï¼Œçº¢è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  R_{34} = \frac{R_{33} + R_{35}}{2} - \frac{G_{33} + G_{35}}{2} + G_{34}  \]</span> å¦‚å·²çŸ¥ B44ï¼Œçº¢è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  R_{44} = \frac{R_{33} + R_{35} + R_{53} + R_{55}}{4} - \frac{G_{33} + G_{35} + G_{53} + G_{55}}{4} + G_{44}  \]</span> ä¾‹æ±‚ B åˆ†é‡ï¼šå¦‚å·²çŸ¥ G43ï¼Œè“è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  B_{43} = \frac{B_{24} + B_{44}}{2} - \frac{G_{24} + G_{44}}{2} + G_{34}  \]</span> å¦‚å·²çŸ¥ R33ï¼Œè“è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  B_{33} = \frac{B_{22} + B_{24} + B_{42} + B_{44}}{4} - \frac{G_{22} + G_{24} + G_{42} + G_{44}}{4} + G_{33}  \]</span></p></li></ul><p>G é€šé“æœ‰è¾¹ç¼˜æ£€æµ‹é‡‡ç”¨ç›¸é‚» Gï¼Œæ¢å¤æ— è‰²å·®ã€è‰²åº¦ä¿¡æ¯ï¼ŒRã€B é€šé“æ— è¾¹ç¼˜æ£€æµ‹ï¼Œæ¢å¤é‡‡ç”¨è‰²å·®ä¿¡æ¯ã€‚æ•ˆæœæ¥è¿‘åŸå§‹å›¾ï¼Œç®—æ³•éš¾åº¦é€‚ä¸­ã€‚</p><h2 id="åŸºäºè¾¹ç¼˜æ£€æµ‹å’Œè‰²å·®çš„-cfa-æ’å€¼laroche-åŸç†">åŸºäºè¾¹ç¼˜æ£€æµ‹å’Œè‰²å·®çš„ CFA æ’å€¼ï¼šlaroche åŸç†</h2><p>G åˆ†é‡çš„æ¢å¤æ”¹ç”¨ç›¸é‚» R æˆ– B é€šé“çš„äºŒé˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ï¼›æ¢å¤æ—¶ä½¿ç”¨ç›¸é‚» G é€šé“ä¿¡æ¯ã€‚ Rã€B åˆ†é‡çš„æ¢å¤åŒ Hibbard ä½¿ç”¨è‰²å·®åŸç†ã€‚</p><ul><li><p>æ¢å¤é‡‡æ ·ç‚¹ R å’Œ B ç‚¹çš„ç»¿è‰²åˆ†é‡ï¼šä¾‹ B44ã€‚ æ¢¯åº¦å› å­ï¼šæ°´å¹³æ–¹å‘ Hï¼š <span class="math display">\[  \alpha = \left | 2 * B_{44} - B_{42} - B_{46} \right |   \]</span> ç«–ç›´æ–¹å‘ W: <span class="math display">\[  \beta = \left | 2 * B_{44} - B_{24} - B_{64} \right |   \]</span> å˜åŒ–å°çš„æ–¹å‘å¯èƒ½æ˜¯è¾¹ç¼˜ï¼Œæ‰€ä»¥ G44 è¡¨ç¤ºå¦‚ä¸‹ï¼š <span class="math display">\[  G_{44} = \frac{G_{43} + G_{45}}{2} (\alpha &lt; \beta)  \]</span></p><p><span class="math display">\[  G_{44} = \frac{G_{34} + G_{54}}{2}  (\alpha &gt; \beta)  \]</span></p><p><span class="math display">\[  G_{44} = \frac{G_{34} + G_{54} + G{43} + G_{45}}{4} (\alpha = \beta)  \]</span> å…¶ä»–åƒç´ æ’å€¼æ–¹æ³•åŒ Hibbardã€‚</p></li></ul><p>G é€šé“æœ‰è¾¹ç¼˜æ£€æµ‹é‡‡ç”¨ç›¸é‚» B è‰²åº¦ä¿¡æ¯ï¼Œæ¢å¤ç”¨å‡å€¼æ— è‰²å·®ä¿¡æ¯ã€è‰²åº¦ä¿¡æ¯ï¼ŒRã€B é€šé“æ— è¾¹ç¼˜æ£€æµ‹ï¼Œæ¢å¤é‡‡ç”¨è‰²å·®ä¿¡æ¯ã€‚æ•ˆæœæ¥è¿‘åŸå§‹å›¾ï¼Œç®—æ³•éš¾åº¦é€‚ä¸­ã€‚</p><h2 id="åŸºäºè¾¹ç¼˜è‰²åº¦å’Œè‰²å·®è‡ªé€‚åº”æ’å€¼">åŸºäºè¾¹ç¼˜ã€è‰²åº¦å’Œè‰²å·®è‡ªé€‚åº”æ’å€¼</h2><p>G åˆ†é‡çš„æ¢å¤æ”¹ç”¨ç›¸é‚» R æˆ– B çš„äºŒé˜¶å¾®åˆ†åŠ  G é€šé“çš„ä¸€é˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ï¼›Rã€B åˆ†é‡çš„æ¢å¤ä½¿ç”¨äº†è‰²å·®åŸç†ã€‚</p><ul><li><p>æ¢å¤ç»¿è‰²åˆ†é‡ Gã€‚ å·²çŸ¥ B44, æ°´å¹³æ–¹å‘æ¢¯åº¦å’Œè‰²åº¦ç®—å­ï¼š <span class="math display">\[  \alpha = \left | 2 * B_{44} - B_{42} - B_{46} \right |  + \left | G_{43} - G_{45} \right |   \]</span> å·²çŸ¥ B44, ç«–ç›´æ–¹å‘æ¢¯åº¦å’Œè‰²åº¦ç®—å­ï¼š <span class="math display">\[  \beta = \left | 2 * B_{44} - B_{24} - B_{64} \right |  + \left | G_{34} - G_{54} \right |   \]</span> G å€¼å…¬å¼ï¼š <span class="math display">\[  \begin{equation}  G_{44}= \begin{cases}\frac{G_{43}+G_{45}}{2}+\frac{2 * B_{44}-B_{42}-B_{46}}{4} &amp;   \alpha&lt;\beta \\ \frac{G_{34}+G_{54}}{2}+\frac{2 * B_{44}-B_{24}-B_{64}}{4} &amp; \alpha&gt;\beta     \\ \frac{G_{34}+G_{43}+G_{45}+G_{54}}{4}+\frac{4 * B_{44}-B_{24}-B_{42}-B_{46}-B_{64}}  {8} &amp; \alpha=\beta\end{cases}  \end{equation}  \]</span> å·²çŸ¥ R33, æ°´å¹³æ–¹å‘æ¢¯åº¦å’Œè‰²åº¦ç®—å­ï¼š <span class="math display">\[  \alpha = \left |  2* R_{33} - R_{31} - R_{35}   \right | +  \left |   G_{32} - G_{34}   \right |   \]</span> å·²çŸ¥ R33, ç«–ç›´æ–¹å‘æ¢¯åº¦å’Œè‰²åº¦ç®—å­ï¼š <span class="math display">\[  \beta = \left | 2 * R_{33} - R_{13} - R_{53}  \right |  + \left |   G_{23} - G_{43}   \right |   \]</span> G å€¼å…¬å¼ï¼š <span class="math display">\[  \begin{equation}  G_{33}= \begin{cases}\frac{G_{32}+G_{34}}{2}+\frac{ 2*R_{33} - R_{31} - R_{35}}{4} &amp;   \alpha&lt;\beta \\ \frac{G_{23}+G_{43}}{2}+\frac{2 * R_{33}-R_{13}-R_{53}}{4} &amp; \alpha&gt;\beta     \\ \frac{G_{32}+G_{34}+G_{23}+G_{43}}{4}+\frac{4 * R_{33}-R_{31}-R_{35}-R_{13}-R_{53}}  {8} &amp; \alpha=\beta\end{cases}  \end{equation}  \]</span></p></li><li><p>è‹¥å·²çŸ¥ R33ï¼Œæ±‚ B33ã€‚ B åˆ†é‡çš„æ¢å¤é‡‡ç”¨ç›¸é‚» G çš„äºŒé˜¶å¾®åˆ†åŠ  B é€šé“çš„ä¸€é˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ï¼›B åˆ†é‡çš„æ¢å¤ä½¿ç”¨äº†è‰²å·®åŸç† å…ˆæ±‚å¯¹è§’çº¿æ–¹å‘çš„æ¢¯åº¦å’Œè‰²åº¦ç®—å­ <span class="math display">\[  \alpha = \left |  2 * G_{33} - G_{24} - G{42}  \right |  + \left | B_{24 - B_{42}} \right |   \]</span> = | 2 * G_{33} - G_{22} - G_{44} | + | B_{22} - B_{44} | <span class="math display">\[  B åˆ†é‡è¡¨è¾¾å¼ï¼š  \]</span> <span class="math display">\[\begin{equation}  B_{33}= \begin{cases}\frac{B_{24}+B_{42}}{2} - \frac{G_{24}+G_{42}}{2} + G_{33} &amp;   \alpha&lt;\beta \\ \frac{B_{22}+B_{44}}{2} - \frac{G_{22} + G_{44}}{2} + G_{33} &amp;  \alpha&gt;\beta     \\ \frac{B_{22}+B_{24}+B_{42}+B_{44}}{4} - \frac{ G_{22}+G_{24}+G_{42}+G_{44}}  {4} + G_{33} &amp; \alpha=\beta\end{cases}  \end{equation}\]</span> $$</p></li><li><p>å·²çŸ¥ B44ï¼Œæ±‚ R44ã€‚ å…ˆæ±‚å¯¹è§’çº¿æ–¹å‘çš„æ¢¯åº¦å’Œè‰²åº¦ç®—å­ R åˆ†é‡çš„æ¢å¤é‡‡ç”¨ç›¸é‚» G çš„äºŒé˜¶å¾®åˆ†åŠ  R é€šé“çš„ä¸€é˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ï¼›R åˆ†é‡çš„æ¢å¤ä½¿ç”¨äº†è‰²å·®åŸç†ã€‚ <span class="math display">\[  \alpha = \left |  2 * G_{44} - G_{35} - G{53}  \right |  + \left | R_{35} - R_{53} \right |   \]</span> = | 2 * G_{44} - G_{33} - G_{55} | + | B_{33} - B_{55} | <span class="math display">\[  R åˆ†é‡è¡¨è¾¾å¼ï¼š  \]</span> <span class="math display">\[\begin{equation}  B_{44}= \begin{cases}\frac{R_{35}+R_{53}}{2} - \frac{G_{35}+G_{53}}{2} + G_{44} &amp;   \alpha&lt;\beta \\ \frac{R_{33}+R_{55}}{2} - \frac{G_{35} + G_{55}}{2} + G_{44} &amp;  \alpha&gt;\beta     \\ \frac{R_{35}+R_{53}+R_{33}+R_{55}}{4} - \frac{ G_{35}+G_{53}+G_{33}+G_{55}}  {4} + G_{44} &amp; \alpha=\beta\end{cases}  \end{equation}\]</span> $$</p></li><li><p>å¦‚å·²çŸ¥ G43ã€‚ çº¢è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  R_{43} = \frac{R_{33} + R_{53}}{2} - \frac{G_{33} + G_{53}}{2} + G_{43}  \]</span> è“è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  B_{43} = \frac{B_{42} + B_{44}}{2} - \frac{G_{42} + G_{44}}{2} + G_{43}  \]</span></p></li><li><p>å¦‚å·²çŸ¥ G34ã€‚ çº¢è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  R_{34} = \frac{R_{33} + R{35}}{2} -  \frac{G_{33} + G_{35}}{2} + G_{34}  \]</span> è“è‰²åˆ†é‡è¡¨è¾¾å¼ï¼š <span class="math display">\[  B_{34} = \frac{B_{24} + B_{44}}{2} - \frac{G_{24} + G_{44}}{2} + G_{34}  \]</span></p></li></ul><p>Rã€Gã€B é€šé“åˆ†åˆ«è¿›è¡Œäº†è¾¹ç¼˜æ£€æµ‹ï¼Œé¢œè‰²æ¢å¤æ—¶é‡‡ç”¨äº†è‰²å·®ä¿¡æ¯åŠå…¶ä»–é€šé“çš„ä¿¡æ¯ã€‚æ•ˆæœæ¥è¿‘åŸå§‹å›¾ï¼Œç®—æ³•éš¾åº¦è¾ƒå¤§ã€‚</p><h2 id="åŸºäºè¾¹ç¼˜è‰²åº¦å’Œè‰²å·®è‡ªé€‚åº”æ’å€¼ä¹‹æ ‡å¿—ä½å‡å°‘-false-color">åŸºäºè¾¹ç¼˜ã€è‰²åº¦å’Œè‰²å·®è‡ªé€‚åº”æ’å€¼ä¹‹æ ‡å¿—ä½ï¼šå‡å°‘ False color</h2><p>G åˆ†é‡çš„æ¢å¤æ”¹ç”¨ç›¸é‚» R æˆ– B çš„äºŒé˜¶å¾®åˆ†åŠ  G é€šé“çš„ä¸€é˜¶å¾®åˆ†æ–¹å‘åˆ¤æ–­å› å­ï¼›å¹¶é‡‡ç”¨æ ‡å¿—å› å­çš„ç»Ÿè®¡ï¼ŒRã€B åˆ†é‡çš„æ¢å¤ä½¿ç”¨äº†è‰²å·®åŸç†ã€‚</p><ul><li>å¯¹æ¯ä¸ªåƒç´ è®¡ç®—æ°´å¹³å’Œå‚ç›´æ–¹å‘æ¢¯åº¦å’Œè‰²åº¦ç®—å­ã€‚</li><li>æ¯”è¾ƒä¸¤ä¸ªæ–¹å‘çš„ç®—å­å¤§å°ï¼Œç”¨ 0 æˆ– 1 æ ‡è®°ã€‚</li><li>ç»Ÿè®¡å±€éƒ¨åŒºåŸŸå†…å¦‚ 3x3 çª—å£ç»Ÿè®¡é‚»åŸŸä¹ä¸ªä½ç½®çš„ flag ä¹‹å’Œå³ total_flagã€‚</li><li>è®¾ç½®é˜ˆå€¼ï¼Œåˆ¤æ–­è¯¥åƒç´ åœ¨å±€éƒ¨åŒºåŸŸå†…æœ€å¯èƒ½çš„æ–¹å‘ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/dm2.png"></p><p>å¯¹äºå›¾ (a): å·²çŸ¥ B5 æ°´å¹³æ–¹å‘æ–¹å‘ç®—å­ï¼š</p><p><span class="math display">\[G_{h} = \left |   G_4 - G_6  \right |  + \left |  2 * B_5 - B_3 - B_7  \right | \]</span></p><p>ç«–ç›´æ–¹å‘æ–¹å‘ç®—å­ï¼š <span class="math display">\[G_{v} = \left |   G_2 - G_8  \right |  + \left |  2 * B_5 - B_1 - B_9  \right | \]</span> æ–¹å‘æ¢¯åº¦ç®—å­éå›ºå®š æ ‡å¿—ä½ï¼š flag=1ï¼Œ<span class="math inline">\(G_h&lt;G_v\)</span> ; flag=0ï¼Œelse <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/dm3.png"></p><p>å¯¹äºå›¾ (b): å·²çŸ¥ G5ï¼ˆG43ï¼‰ æ°´å¹³æ–¹å‘æ–¹å‘ç®—å­ï¼š</p><p><span class="math display">\[G_h = \left | 2*G_5 - G_{12} - G_{13} \right |   + \left | G_1 - G_3   \right | + \left | G_7 - G_9   \right |\]</span></p><p>ç«–ç›´æ–¹å‘æ–¹å‘ç®—å­ï¼š <span class="math display">\[G_v = \left | 2*G_5 - G_{10} - G_{11} \right |   + \left | G_1 - G_7   \right | + \left | G_3 - G_9   \right |\]</span></p><p>æ ‡å¿—ä½ï¼š flag=1ï¼ŒGh&lt;Gv; flag=0ï¼Œelse å·²çŸ¥ G34 å’Œ R33ï¼Œflag è®¡ç®—æ–¹æ³•åŒç†ã€‚</p><p><strong>æ ¹æ®é˜ˆå€¼åˆ¤æ–­æ–¹å‘çš„æ–¹æ³•ï¼š</strong></p><p>å¯¹äº B å’Œ R ä½ç½®ï¼Œå– 3x3 çª—å£ï¼Œç»Ÿè®¡é‚»åŸŸä¹ä¸ªä½ç½®çš„ flag ä¹‹å’Œå³ total_flagï¼Œåœ¨ [0.9] ä¹‹é—´ï¼Œè¶Šå¤§æ°´å¹³æ–¹å‘è¾¹ç•Œå¯èƒ½æ€§è¶Šå¤§ï¼Œè¶Šå°ç«–ç›´æ–¹å‘ä¸ºè¾¹ç•Œå¯èƒ½æ€§è¶Šå¤§ã€‚</p><p>å– high_thresh å’Œ low_threshï¼Œåˆ¤æ–­è¾¹ç•Œæ–¹å‘ã€‚</p><p>total_flag &gt; = high_threshï¼Œæ°´å¹³æ–¹å‘å­˜åœ¨è¾¹ç•Œï¼Œæ’å€¼æ²¿æ°´å¹³æ–¹å‘è¿›è¡Œï¼›</p><p>total_flag =&lt; low_threshï¼Œç«–ç›´æ–¹å‘å­˜åœ¨è¾¹ç•Œï¼Œæ’å€¼æ²¿ç«–ç›´æ–¹å‘è¿›è¡Œï¼›</p><p>low_thresh &lt; total_flag &lt; high_threshï¼Œä¸ºå¹³æ»‘åŒºåŸŸï¼Œæ’å€¼åœ¨æ•´ä¸ªåŒºåŸŸè¿›è¡Œï¼›</p><p>ç»éªŒå€¼ï¼Œ high_thresh å’Œ low_thresh å– 7 å’Œ 3.</p><p>æ’å€¼æ–¹æ³•åŒä¸Šã€‚</p><blockquote><p>æœ‰å±€éƒ¨åŒºåŸŸå†…è¾¹ç¼˜æ–¹å‘çš„æ•´ä½“åˆ¤æ–­ï¼Œä½¿å¾—è¾¹ç¼˜æ–¹å‘åˆ¤æ–­æ›´åŠ å‡†ç¡®ã€‚</p></blockquote><p>CFA æ’å€¼ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›æ¯”è¾ƒç»å…¸çš„ç®—æ³•ï¼šåŸºäºè‰²æ¯”çš„ç®—æ³•ï¼›2003 å¹´æå‡ºçš„ Lu ç®—æ³•ï¼›åŸºäºæƒé‡çš„ CFA æ’å€¼ç®—æ³•ï¼›å» False color çš„æ”¹è¿›ç®—æ³•ï¼›å…¶ä»–ä¸€äº›åœ¨æ­¤åŸºç¡€ä¸Šæ”¹è¿›çš„ç®—æ³•ç­‰ç­‰</p><p><strong>æ’å€¼è¯„ä»·æ–¹æ³•ï¼š</strong> å–ä¸€å¼  RGB ä¸‰è‰²å›¾åƒï¼ŒæŒ‰ç…§ Bayer æ ¼å¼å–å‡ºå¯¹åº”çš„åƒç´ ï¼Œæ„æˆ Bayer æ ¼å¼å›¾ï¼Œç„¶åç»è¿‡ CFA æ’å€¼ç®—æ³•æ’å€¼å½¢æˆæ’å€¼åå›¾åƒã€‚</p><p>è¯„ä»·å‚æ•°ï¼š</p><ul><li>é¢œè‰²å‡æ–¹è¯¯å·®ï¼ˆCMSEï¼‰ï¼šæ’å€¼å‰ä¸æ’å€¼åå›¾åƒçš„å¯¹åº”åƒç´ é—´çš„å·®å€¼ï¼ˆç»å¯¹å€¼ï¼Œæ–¹å·®å€¼ï¼‰ä¹‹å’Œçš„å¹³å‡å€¼ã€‚è¶Šå°è¶Šé‡å»ºæ¥è¿‘åŸå›¾ï¼Œé‡å»ºè´¨é‡è¶Šé«˜ã€‚</li></ul><p><span class="math display">\[\begin{equation}C M S E=\frac{1}{3 H W} \sum_{k=R, G, B} \sum_{i=1}^H \sum_{j=1}^W\left(I_o(i, j) k-I_d(i, j) k\right)^2\end{equation}\]</span></p><ul><li>ä¾‹é¢œè‰²å³°å€¼ä¿¡å™ªæ¯”ï¼ˆColor Peak Signal to Noise Ratio ,CPSNRï¼‰ï¼šè¶Šå¤§è¶Šé‡å»ºæ¥è¿‘åŸå›¾ï¼Œé‡å»ºè´¨é‡è¶Šé«˜ã€‚</li></ul><p><span class="math display">\[CPSNR = 10 log_{10}(\frac{255^2}{CMSE})\]</span></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgyMDkyNw==">https://zhuanlan.zhihu.com/p/98820927<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MDYyNjYyMA==">https://zhuanlan.zhihu.com/p/40626620<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISPRaw åŸŸä¹‹ LSC</title>
      <link href="/2023/Camera/CameraISPRawLSC/"/>
      <url>/2023/Camera/CameraISPRawLSC/</url>
      
        <content type="html"><![CDATA[<h1 id="é•œå¤´é˜´å½±æ ¡æ­£-lsc">é•œå¤´é˜´å½±æ ¡æ­£ LSC</h1><p>é•œå¤´é˜´å½±æœ‰ä¸¤ç§è¡¨ç°å½¢å¼ï¼Œåˆ†åˆ«æ˜¯</p><ul><li>Luma shadingï¼Œåˆç§° vignettingï¼ŒæŒ‡ç”±äºé•œå¤´é€šå…‰é‡ä»ä¸­å¿ƒå‘è¾¹ç¼˜é€æ¸è¡°å‡å¯¼è‡´ç”»é¢è¾¹ç¼˜äº®åº¦å˜æš—çš„ç°è±¡ã€‚</li><li>Chroma shadingï¼ŒæŒ‡ç”±äºé•œå¤´å¯¹ä¸åŒæ³¢é•¿çš„å…‰çº¿æŠ˜å°„ç‡ä¸åŒå¼•èµ·ç„¦å¹³é¢ä½ç½®åˆ†ç¦»å¯¼è‡´å›¾åƒå‡ºç°ä¼ªå½©çš„ç°è±¡ã€‚</li></ul><span id="more"></span><h2 id="vignetting-åŸç†">Vignetting åŸç†</h2><p>ç”»é¢è¾¹ç¼˜é•œå¤´èƒ½é‡è¡°å‡ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline9.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç”±äºé•œå¤´ä¸­éƒ½ä¼šå­˜åœ¨å¤šå¤„å…‰é˜‘ï¼Œå½“å…¥å°„å…‰çº¿åç¦»å…‰è½´è§’åº¦è¾ƒå¤§æ—¶ï¼Œéƒ¨åˆ†å…‰çº¿å°±ä¼šè¢«å…‰é˜‘é®æŒ¡è€Œä¸èƒ½å‚ä¸æˆåƒï¼Œå› æ­¤è¶Šé è¿‘ sensor è¾¹ç¼˜çš„åƒç´ æ¥æ”¶åˆ°çš„æ›å…‰é‡å°±è¶Šä½ã€‚</p><p>è¾¹ç¼˜åƒç´ å¾®é€é•œå’Œæ„Ÿå…‰é¢çš„é”™ä½ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline10.png"></p><p>è¿™ä¸ªé—®é¢˜åœ¨æ‰‹æœº sensor ä¸Šé€šå¸¸ä¼šæ›´ä¸¥é‡ä¸€äº›ï¼Œå› æ­¤è®¾è®¡æ‰‹æœº sensor çš„å‚å®¶ä¼šé‡‡å–ä¸€äº›ç‰¹å®šçš„æ–¹æ³•å»ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ä¸€ç§å¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨å¾®é€é•œä¸Šåšæ–‡ç« ï¼Œå³ä»ä¸­å¿ƒåƒç´ å¼€å§‹ï¼Œå¾®é€é•œçš„å°ºå¯¸ç•¥å°äºæ„Ÿå…‰é¢çš„é¢ç§¯ä¸€ç‚¹ç‚¹ï¼Œè¿™æ ·è¶Šå¾€è¾¹ç¼˜å¾®é€é•œä¸æ„Ÿå…‰é¢ä¹‹é—´çš„é”™ä½å°±è¶Šå¤§ï¼Œåˆšå¥½å¯ä»¥è¡¥å¿å…¥å°„å…‰çº¿è§’åº¦å¢å¤§å¯¼è‡´çš„ç„¦ç‚¹åç§»ï¼Œä½¿å…‰çº¿å¯ä»¥æ›´å¥½åœ°èšç„¦åˆ°æ„Ÿå…‰é¢ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline11.png"></p><p>ä¸è¿‡æ·±å…¥ç ”ç©¶ä¼šå‘ç°ï¼Œè¿™ä¸ªè¡¥å¿åŠæ³•å…¶å®ä¹Ÿæ˜¯æœ‰å±€é™çš„ï¼Œå¦‚æœ sensor é‡‡ç”¨çš„æ˜¯ä¸‹å›¾å·¦æ‰€ç¤ºçš„ FSI å·¥è‰ºï¼ˆå‰ç…§å¼ï¼‰ï¼Œä»åƒç´ å¾®è§‚ç»“æ„æ¥çœ‹ï¼Œå½“å…¥å°„å…‰çº¿è§’åº¦æ¯”è¾ƒå¤§æ—¶ï¼Œä¼šæœ‰è¾ƒå¤šå…‰çº¿ä¸åƒç´ ä¸­çš„é‡‘å±å¸ƒçº¿å±‚å‘ç”Ÿå¸æ”¶ã€æ•£å°„ä»è€Œäº§ç”ŸæŸå¤±ï¼Œå•çº¯ç§»åŠ¨å¾®é€é•œçš„ä½ç½®å¹¶ä¸èƒ½æœ‰æ•ˆè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœåƒç´ é‡‡ç”¨çš„æ˜¯å³å›¾æ‰€ç¤ºçš„ BSI å·¥è‰ºï¼ˆèƒŒç…§å¼ï¼‰ï¼Œå› ä¸ºå¸ƒçº¿å±‚åœ¨ç¡…ç‰‡çš„å¦å¤–ä¸€ä¾§ï¼Œæ‰€ä»¥å…‰çº¿æŸå¤±ä¼šå°‘ï¼Œè¡¥å¿æ•ˆæœæ›´åŠ æœ‰æ•ˆã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline12.png"></p><p>Vigetting æ˜¯ç”±é•œå¤´å¼•èµ·çš„ç°è±¡ï¼Œæ‰€ä»¥ LSC æ ¡æ­£ä¹Ÿæ˜¯é’ˆå¯¹ç‰¹å®šé•œå¤´çš„ã€‚è‹¥æœäº§å“çš„é€‚é…é•œå¤´å‘ç”Ÿå˜åŒ–ï¼ŒåŸåˆ™ä¸Šéœ€è¦é‡æ–°è¿›è¡Œ LSC æ ¡æ­£ã€‚</p><p>å¦å¤–ï¼ŒVigetting ç°è±¡åœ¨ sensor é¶é¢è¾ƒå¤§ã€é•œå¤´ç„¦è·è¾ƒçŸ­æ—¶è¡¨ç°æ›´åŠ æ˜æ˜¾ã€‚é‡‡ç”¨éçƒé¢é•œå¤´é€šå¸¸å¯ä»¥æ”¹å–„ vignettingã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline13.png"></p><h2 id="chroma-shading-åŸç†">Chroma shading åŸç†</h2><p>é•œå¤´å¯¹ä¸åŒæ³¢é•¿çš„å…‰çº¿æŠ˜å°„ç‡ä¸åŒä¼šå¯¼è‡´è‰²å·®é—®é¢˜ï¼Œå³ä¸åŒæ³¢é•¿çš„ç„¦ç‚¹åœ¨ç©ºé—´ä¸Šä¸é‡åˆï¼Œå¯¼è‡´ç„¦å¹³é¢åˆ†è£‚ä¸ºä¸‰ä¸ªä¸å®Œå…¨é‡åˆçš„æ›²é¢ï¼Œè¿™ä¼šç ´åå›¾åƒçš„ç™½å¹³è¡¡ï¼Œä½¿å›¾åƒå‡ºç°ä¼ªå½©ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ® sensor æ‰€å¤„çš„å‰åä½ç½®ä¸åŒï¼Œä¼ªå½©å¯èƒ½åçº¢ä¹Ÿå¯èƒ½åè“ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline14.png"></p><p>Chroma shading ä¸€èˆ¬ä¸»è¦é€šè¿‡é•œå¤´é€‰å‹æ¥æ§åˆ¶å…¶å½±å“ã€‚å¦‚æœ ISP æ”¯æŒ chroma shading æ ¡æ­£ï¼Œåˆ™å¯ä»¥é€šè¿‡æ ‡å®šä¸‰ä¸ªé¢œè‰²å¹³é¢çš„å¢ç›Šæ¥ä¿®æ­£ã€‚ä¸ºäº†æ§åˆ¶æ ‡å®šè¡¨æ ¼çš„å­˜å‚¨ç©ºé—´ï¼Œé€šå¸¸åªæ ‡å®š MxN ä¸ªå…³é”®ç‚¹ï¼Œä»»æ„ä½ç½®å¤„çš„åƒç´ å¢ç›Šå¯ä»¥ä½¿ç”¨ç›¸é‚»å››ä¸ªæ ‡å®šå…³é”®ç‚¹é€šè¿‡åŒçº¿æ€§æ’å€¼çš„æ–¹æ³•åŠ¨æ€è®¡ç®—å¾—åˆ°ã€‚åœ¨ä¸€ä¸ªå…¸å‹çš„ ISP å®ç°ä¸­ï¼Œå¯ä»¥å– M=N=17 å³å¯å¾—åˆ°ä»¤äººæ»¡æ„çš„æ•ˆæœã€‚</p><h1 id="çŸ«æ­£æ–¹æ³•">çŸ«æ­£æ–¹æ³•</h1><p>LSC çš„æœ¬å€¼å°±æ˜¯èƒ½é‡æœ‰è¡°å‡ï¼Œåè¿‡æ¥ä¸ºäº†çŸ«æ­£å°±ç”¨è¯¥ç‚¹çš„åƒç´ å€¼ä¹˜ä»¥ä¸€ä¸ª gain å€¼ï¼Œè®©å…¶æ¢å¤åˆ°è¡°å‡å‰çš„çŠ¶æ€ï¼Œæ‰€ä»¥çŸ«æ­£çš„æœ¬è´¨å°±æ˜¯æ‰¾åˆ°è¿™ä¸ª gain å€¼ã€‚</p><p>ä»ç›®å‰çš„çŸ«æ­£æ–¹æ³•æ¥çœ‹ä¸ªäººè§‰å¾—å¯ä»¥åˆ†æˆä¸‰å¤§ç±»ï¼š</p><ul><li>å‚¨å­˜å¢ç›Šæ³•ã€‚</li><li>å¤šé¡¹å¼æ‹Ÿåˆæ³•ã€‚</li><li>è‡ªåŠ¨çŸ«æ­£æ³•ã€‚</li></ul><p>ç›®å‰æ–¹æ³• 1 å’Œæ–¹æ³• 2 æ˜¯ä½¿ç”¨æœ€å¤šçš„ã€‚</p><h2 id="å‚¨å­˜å¢ç›Šæ³•">å‚¨å­˜å¢ç›Šæ³•</h2><h3 id="radial-shading-correct">radial shading correct</h3><p>ä¸Šé¢æœ‰æåˆ°è¡°å‡ç¬¦åˆ cos(Î¸) çš„å››æ¬¡æ–¹è§„å¾‹ï¼Œè€ŒÎ¸åœ¨ä¸‰ç»´ç©ºé—´å¯¹å„ä¸ªæ–¹å‘æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥å„ä¸ªæ–¹å‘çš„è¡°å‡å¦‚ä¸‹å›¾ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lsc1.png"></p><p>å›¾ä¸­ç›¸åŒé¢œè‰²å¯ä»¥ç†è§£æˆäº®åº¦æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çº¢è‰²ä¸€åœˆåœˆçš„åƒç´ éœ€è¦çš„å¢ç›Šæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥ç”¨åŠå¾„ä¸ºå˜é‡æ¥æ±‚å‡ºä¸åŒåŠå¾„åƒç´ éœ€è¦çš„å¢ç›Šã€‚ç„¶åæŠŠåŠå¾„å¯¹åº”çš„å¢ç›Šå€¼å‚¨å­˜åœ¨å†…å­˜ä¸­ï¼Œåˆ°äº†è¦ç”¨çš„æ—¶å€™å†æ‹¿å‡ºæ¥ç”¨ï¼Œä»è€Œå®ŒæˆçŸ«æ­£ã€‚ä½†æ˜¯ä¸å¯èƒ½æŠŠæ‰€æœ‰åƒç´ çš„åŠå¾„éƒ½å­˜å‚¨èµ·æ¥ï¼Œæ‰€ä»¥å°±é€šè¿‡é‡‡æ ·çš„æ–¹å¼æå–ç‰¹å¾åŠå¾„çš„å¢ç›Šå­˜å‚¨åˆ°å†…å­˜ï¼Œç„¶åå…¶ä»–åŠå¾„å¯¹åº”çš„å¢ç›Šåœ¨çŸ«æ­£çš„æ—¶å€™é€šè¿‡æ’å€¼ç®—æ³•æ±‚å‡ºæ¥ã€‚è¿™ç§æ–¹å¼å¯¹å†…å­˜çš„ç¡¬ä»¶è¦æ±‚å°±ä½äº†ã€‚è¿™å°±æ˜¯ radial shading correctã€‚</p><h3 id="mesh-shading-correct">mesh shading correct</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lsc2.png"></p><p>å’ŒåŠå¾„ä¸åŒï¼Œè¿™ç§æ–¹å¼æ˜¯æŠŠæ•´å¹…å›¾åƒåˆ†æˆ n*n ä¸ªç½‘æ ¼ï¼Œç„¶åé’ˆå¯¹ç½‘æ ¼é¡¶ç‚¹æ±‚å‡ºçŸ«æ­£çš„å¢ç›Šï¼Œç„¶åæŠŠè¿™äº›é¡¶ç‚¹çš„å¢ç›Šå‚¨å­˜åˆ°å†…å­˜ä¸­ï¼ŒåŒç†å…¶ä»–çš„ç‚¹çš„å¢ç›Šä¹Ÿæ˜¯é€šè¿‡æ’å€¼çš„æ–¹å¼æ±‚å‡ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lsc3.png"></p><p>å¦‚å›¾æ˜¯ä¸Šå›¾åˆ†æˆç½‘æ ¼åï¼Œæ¯ä¸ªç½‘æ ¼äº®åº¦çš„åˆ†å¸ƒï¼Œå¯ä»¥çœ‹å‡ºå’Œ cos(Î¸) çš„å››æ¬¡æ–¹å¾ˆæ¥è¿‘ï¼Œç„¶åé’ˆå¯¹è¿™æ ·çš„ç½‘æ ¼äº®åº¦æ±‚å‡ºå¢ç›Šå¦‚ä¸‹å›¾ï¼Œåˆšå¥½å’Œäº®åº¦åˆ†å¸ƒç›¸å <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lsc4.png"></p><h2 id="å¤šé¡¹å¼æ‹Ÿåˆ">å¤šé¡¹å¼æ‹Ÿåˆ</h2><p>å¤šé¡¹å¼æ‹Ÿåˆçš„æ–¹å¼å°±æ˜¯ç”¨åŠå¾„ä¸ºé‡‡æ ·ç‚¹ï¼Œç„¶åæŠŠè¿™äº›é‡‡æ ·ç‚¹é€šè¿‡é«˜æ¬¡æ‹Ÿåˆçš„æ–¹å¼æ‹Ÿåˆæˆä¸€ä¸ªé«˜æ¬¡æ›²çº¿ï¼Œç„¶åæŠŠé«˜æ¬¡æ›²çº¿çš„å‚æ•°å‚¨å­˜èµ·æ¥ï¼Œç”¨çš„æ—¶å€™æŠŠåŠå¾„å¸¦å…¥å…¬å¼å°±èƒ½æ±‚å‡ºå¯¹åº”çš„ gain å€¼ç”¨äºçŸ«æ­£ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgyMDkyNw==">https://zhuanlan.zhihu.com/p/98820927<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODkzMzQyNjk=">https://zhuanlan.zhihu.com/p/389334269<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP Raw åŸŸä¹‹é™å™ª</title>
      <link href="/2023/Camera/CameraISPRawNoiseReduction/"/>
      <url>/2023/Camera/CameraISPRawNoiseReduction/</url>
      
        <content type="html"><![CDATA[<h1 id="raw-åŸŸé™å™ªçš„åŸå› ">Raw åŸŸé™å™ªçš„åŸå› </h1><h2 id="sensor-æœ¬èº«çš„å™ªå£°">Sensor æœ¬èº«çš„å™ªå£°</h2><p>Sensor è¾“å‡ºçš„ RAW å›¾åƒæœ¬èº«æ˜¯æºå¸¦äº†å™ªå£°çš„ï¼Œå‰é¢æåˆ°è¿‡ sensor å™ªå£°çš„ç§ç±»ä¸»è¦åŒ…æ‹¬çƒ­å™ªå£°ã€å…‰æ•£ç²’å™ªå£°ã€è¯»å‡ºå™ªå£°ã€å›ºå®šæ¨¡å¼å™ªå£°ç­‰ã€‚å½“ sensor æ¸©åº¦è¾ƒé«˜ã€å¢ç›Šè¾ƒå¤§ã€ç¯å¢ƒè¾ƒæš—çš„æƒ…å†µä¸‹å„ç§å™ªå£°ä¼šå˜å¾—æ›´åŠ æ˜æ˜¾ï¼Œæˆä¸ºå½±å“å›¾åƒè´¨é‡çš„ä¸»è¦å› ç´ ã€‚</p><span id="more"></span><h2 id="lsclens-shading-correction-å¯¹å™ªå£°çš„å½±å“">LSCï¼ˆLens shading correctionï¼‰ å¯¹å™ªå£°çš„å½±å“</h2><p>é™¤äº† Sensor å›¾åƒæœ¬èº«æºå¸¦çš„å™ªå£°ä¹‹å¤–ï¼Œå›¾åƒæ¯æ¬¡ä¼šç»è¿‡ ISP æ¨¡å—çš„å¤„ç†ä¹‹åéƒ½ä¼šå¼•å…¥ä¸€äº›æ–°çš„å™ªå£°ï¼Œæˆ–è€…å¯¹åŸæœ‰å™ªå£°è¿›è¡Œäº†æ”¾å¤§ã€‚ä»¥ LSC æ¨¡å—ä¸ºä¾‹ï¼ŒLSC æ ¡æ­£çš„å®è´¨æ˜¯åœ¨è¾“å…¥å›¾åƒä¸Šä¹˜ä»¥ä¸€ä¸ªä¸åƒç´ ä½ç½®æœ‰å…³çš„å¢ç›Šç³»æ•°ä»¥è¡¥å¿å…‰ä¿¡å·çš„è¡°å‡ï¼Œè€Œè¡¥å¿çš„è§„å¾‹æ˜¯è¶Šè¿œç¦»å›¾åƒä¸­å¿ƒçš„åœ°æ–¹å¢ç›Šè¶Šå¤§ã€‚ç”±äº ISP æ‰€ç”¨ä¹˜æ³•å™¨çš„ç²¾åº¦æ˜¯æœ‰é™çš„ï¼Œæ¯åšä¸€æ¬¡ä¹˜æ³•å°±ä¼šé‡æ–°å¼•å…¥ä¸€æ¬¡æˆªæ–­è¯¯å·®ï¼Œè¿™æ˜¯æ–°å¢çš„å™ªå£°æ¥æºï¼Œæ‰€ä»¥ç» LSC å¤„ç†åå›¾åƒçš„æ•´ä½“å™ªå£°æ°´å¹³ä¼šæœ‰æ‰€å¢åŠ ï¼Œè€Œä¸”åœ¨å›¾åƒçš„è¾¹ç¼˜å¤„è¡¨ç°ä¼šæ›´åŠ æ˜æ˜¾ï¼Œå…¸å‹çš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline16.png"></p><p>Shading å›ºç„¶æ˜¯ä¸å¥½çš„ï¼Œéœ€è¦æ ¡æ­£ï¼Œä½†æ˜¯ä¸ºäº†æ ¡æ­£ shading è€Œç»™å›¾åƒå¼•å…¥å™ªå£°åŒæ ·ä¹Ÿä¸å¥½çš„ï¼Œæ‰€ä»¥äººä»¬éœ€è¦æƒè¡¡åœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ ¡æ­£ shading èƒ½å¤Ÿæ”¶åˆ°æ»¡æ„çš„æ•ˆæœã€‚è¿™æ˜¯åœ¨ä¸»è§‚å›¾åƒè´¨é‡è°ƒè¯•é˜¶æ®µéœ€è¦è€ƒè™‘çš„é—®é¢˜ä¹‹ä¸€ã€‚</p><h2 id="æœ€å">æœ€å</h2><p>å™ªå£°åœ¨ ISP æµæ°´çº¿å„æ¨¡å—ä¸­ä¼šä¸æ–­äº§ç”Ÿã€ä¼ æ’­ã€æ”¾å¤§ã€æ”¹å˜ç»Ÿè®¡ç‰¹æ€§ï¼Œå¯¹å›¾åƒè´¨é‡çš„å½±å“ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”è¶Šæ¥è¶Šä¸å®¹æ˜“æ§åˆ¶ã€‚å› æ­¤å¤„ç†å™ªå£°çš„åŸºæœ¬åŸåˆ™æ˜¯è¶Šæ—©è¶Šå¥½ï¼Œéšæ—¶äº§ç”Ÿéšæ—¶å¤„ç†ï¼Œå°½å¯èƒ½å°†é—®é¢˜æ¶ˆç­åœ¨èŒèŠ½çŠ¶æ€ã€‚ç›®å‰ä¸»æµçš„ ISP äº§å“ä¸­ä¸€èˆ¬ä¼šé€‰æ‹©åœ¨ RAW åŸŸã€RGB åŸŸã€YUV åŸŸç­‰å¤šä¸ªç¯èŠ‚è®¾ç½®é™å™ªæ¨¡å—ä»¥æ§åˆ¶ä¸åŒç±»å‹å’Œç‰¹æ€§çš„å™ªå£°ã€‚åœ¨ YUV åŸŸé™å™ªçš„æ–¹æ³•å·²ç»å¾—åˆ°äº†å¹¿æ³›çš„ç ”ç©¶å¹¶ä¸”å‡ºç°äº†å¾ˆå¤šéå¸¸æœ‰æ•ˆçš„ç®—æ³•ï¼Œä½†æ˜¯åœ¨ RAW åŸŸè¿›è¡Œé™å™ªåˆ™å› ä¸º RAW æ•°æ®æœ¬èº«çš„ä¸€äº›ç‰¹ç‚¹è€Œå—åˆ°ä¸å°‘é™åˆ¶ã€‚ä¸»è¦çš„é™åˆ¶æ˜¯ RAW å›¾åƒä¸­ç›¸é‚»çš„åƒç´ ç‚¹åˆ†åˆ«éš¶å±äºä¸åŒçš„é¢œè‰²é€šé“ï¼Œæ‰€ä»¥ç›¸é‚»åƒç´ ä¹‹é—´çš„ç›¸å…³æ€§è¾ƒå¼±ï¼Œä¸å…·å¤‡ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„åƒç´ å¹³æ»‘æ€§ï¼Œæ‰€ä»¥å¾ˆå¤šåŸºäºç°åº¦å›¾åƒçš„é™å™ªç®—æ³•éƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ã€‚åˆå› ä¸º RAW æ•°æ®æ¯ä¸ªåƒç´ ç‚¹åªå«æœ‰ä¸€ä¸ªé¢œè‰²é€šé“çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¾ˆå¤šé’ˆå¯¹å½©è‰²å›¾åƒçš„é™å™ªç®—æ³•ä¹Ÿä¸é€‚ç”¨ã€‚</p><h1 id="é¢‘åŸŸæ»¤æ³¢å™¨">é¢‘åŸŸæ»¤æ³¢å™¨</h1><p>æ„æ³•åŠå¯¼ä½“çš„ç®—æ³•ä¸“å®¶ä»¬æå‡ºäº†ä¸€ç§åŸºäºé¢‘åŸŸå˜æ¢çš„æ–¹æ³•ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯å°†ä½¿ç”¨ 8x8 å¤§å°çš„ DCT å˜æ¢å°†å°å—å›¾åƒå˜æ¢åˆ°é¢‘åŸŸï¼Œç„¶åå¯¹é¢‘ç‡åˆ†é‡è¿›è¡Œåˆ†æï¼š</p><ul><li>å¦‚æœ DCT å˜æ¢åéé›¶ç³»æ•°å¾ˆå°‘ï¼Œä¸”èƒ½é‡é›†ä¸­åœ¨ä½é¢‘ï¼Œè¯´æ˜æ˜¯å¹³å¦åŒºåŸŸï¼Œåº”åŠ å¼ºé™å™ªåŠ›åº¦ã€‚</li><li>å¦‚æœä¸¤ä¸ªç›¸é‚»çš„ DCT å•å…ƒå…·å¤‡ç›¸åŒæˆ–ç›¸è¿‘çš„ç›´æµåˆ†é‡ï¼Œåˆ™è¯´æ˜æ˜¯å¹³å¦åŒºåŸŸï¼Œåº”åŠ å¼ºé™å™ªåŠ›åº¦ã€‚</li><li>å¦‚æœæŸä¸ªæ–¹å‘ï¼ˆæ°´å¹³ã€å‚ç›´ã€å¯¹è§’ï¼‰ä¸Šå­˜åœ¨æ˜æ˜¾å ä¼˜çš„ç³»æ•°ï¼Œåˆ™è¯´æ˜å­˜åœ¨å¼ºè¾¹ç¼˜ï¼Œåº”é¿å…é™å™ªã€‚</li><li>å¦‚æœæŸä¸¤ä¸ªæ–¹å‘ä¸Šå­˜åœ¨å ä¼˜çš„ç³»æ•°ï¼Œåˆ™è¯´æ˜å­˜åœ¨å¼±è¾¹ç¼˜ï¼Œåº”è¿›è¡Œä¸­ç­‰å¼ºåº¦çš„é™å™ªã€‚</li><li>å¦‚æœå¾ˆå¤šæ–¹å‘ä¸Šéƒ½æœ‰éé›¶çš„ç³»æ•°ï¼Œä½†åˆæ²¡æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ç³»æ•°ï¼Œæ­¤æ—¶å¯èƒ½æ˜¯çº¹ç†ä¸å™ªå£°å¹¶å­˜çš„æƒ…å†µï¼Œéœ€è¦ä¸€å®šå¼ºåº¦çš„æ»¤æ³¢ï¼Œå‰Šå¼±é«˜é¢‘æˆåˆ†ã€‚</li></ul><p>è¯¦ç»†å¯å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly93d3cucmVzZWFyY2hnYXRlLm5ldC9wdWJsaWNhdGlvbi8yMjA1MzkxMzdfQ2hyb21hX05vaXNlX1JlZHVjdGlvbl9pbl9EQ1RfRG9tYWluX1VzaW5nX1NvZnQtVGhyZXNob2xkaW5n">https://www.researchgate.net/publication/220539137_Chroma_Noise_Reduction_in_DCT_Domain_Using_Soft-Thresholding<i class="fa fa-external-link-alt"></i></span></p><h1 id="ç©ºåŸŸæ»¤æ³¢å™¨spatial-filter">ç©ºåŸŸæ»¤æ³¢å™¨ï¼ˆSpatial Filterï¼‰</h1><p>ç©ºåŸŸé™å™ªæ˜¯ä¸€ç§ 2D é™å™ªæ–¹æ³•ï¼Œå®ƒåªå¤„ç†ä¸€å¸§å›¾åƒå†…éƒ¨çš„å™ªå£°ï¼Œä¸»è¦æ–¹æ³•æ˜¯ä½¿ç”¨ç©ºåŸŸæ»¤æ³¢å™¨å¯¹å›¾åƒè¿›è¡Œæ»¤æ³¢ã€‚æ»¤æ³¢æ“ä½œé€šå¸¸æ˜¯é’ˆå¯¹ä»¥æŸä¸ªåƒç´ ä¸ºä¸­å¿ƒçš„æ»¤æ³¢çª—å£ä¸Šè¿›è¡Œçš„ï¼Œæ»¤æ³¢çª—å£çš„å¤§å°ä¸å…·ä½“çš„ç®—æ³•æœ‰å…³ï¼Œå¸¸ç”¨çš„å¤§å°æœ‰ 3x3ã€5x5ã€7x7 ç­‰å°ºå¯¸ã€‚æ»¤æ³¢æ“ä½œåœ¨æ•°å­¦ä¸Šç§°ä¸ºå·ç§¯ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªä¸æ»¤æ³¢çª—å£å¤§å°ä¸€è‡´çš„å·ç§¯æ ¸ï¼Œå·ç§¯æ ¸çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªæƒé‡ï¼Œä¸å¯¹åº”ä½ç½®çš„å›¾åƒåƒç´ å€¼ç›¸ä¹˜ï¼Œç„¶åæ‰€æœ‰ä¹˜ç§¯ç´¯åŠ åˆ°ä¸€èµ·å°±æ˜¯æ»¤æ³¢åçš„ç»“æœã€‚</p><p>å·ç§¯æ»¤æ³¢ç”¨å…¬å¼è¡¨ç¤ºæ˜¯ï¼Œ</p><p><span class="math display">\[g(x,y) = \sum_{s=-a}^{a}\sum_{t=-b}^{b}w(s,t)f(x+s,y+t)  \]</span></p><p>ä¸‹é¢æ˜¯å·ç§¯æ»¤æ³¢æ“ä½œçš„ç¤ºæ„å›¾ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline15.png"></p><ul><li>ç»å…¸ä½é€šæ»¤æ³¢å™¨ï¼Œå¦‚å‡å€¼æ»¤æ³¢ã€ä¸­å€¼æ»¤æ³¢ã€é«˜æ–¯æ»¤æ³¢ã€ç»´çº³æ»¤æ³¢ç­‰ã€‚è¿™ç±»æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒç®€å•ï¼Œå ç”¨èµ„æºå°‘ï¼Œé€Ÿåº¦å¿«ï¼Œç¼ºç‚¹æ˜¯æ»¤æ³¢å™¨æ˜¯å„å‘åŒæ€§çš„ï¼Œå®¹æ˜“ç ´åå›¾åƒä¸­çš„è¾¹ç¼˜ã€‚å¦å¤–ç”±äºæ²¡æœ‰è€ƒè™‘é¢œè‰²é€šé“ä¹‹é—´çš„ç›¸å…³æ€§æ‰€ä»¥ä¹Ÿå®¹æ˜“å¼•å…¥ä¼ªå½©ç­‰å™ªå£°ï¼Œè€Œäººçœ¼å¯¹è¿™ç§é¢œè‰²å™ªå£°æ˜¯æ¯”è¾ƒæ•æ„Ÿçš„ã€‚</li><li>æ”¹è¿›çš„ç»å…¸æ»¤æ³¢å™¨ï¼Œå¦‚ Eplison æ»¤æ³¢ã€åŒè¾¹æ»¤æ³¢ (bilateral filter)ï¼Œåœ¨ç»å…¸æ»¤æ³¢å™¨çš„åŸºç¡€ä¸Šå¢åŠ äº†é˜ˆå€¼æ£€æµ‹ç”¨äºåŒºåˆ†åŒç±»åƒç´ å’Œå¼‚ç±»åƒç´ ï¼ŒåŒç±»åƒç´ åˆ†é…è¾ƒå¤§çš„æ»¤æ³¢æƒé‡ï¼Œå¼‚ç±»åƒç´ åˆ™æƒé‡å¾ˆå°å› è€ŒåŸºæœ¬ä¸å‚ä¸æ»¤æ³¢ã€‚è¿™ç±»æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æœ‰æ•ˆåœ°ä¿æŠ¤å›¾åƒè¾¹ç¼˜ï¼Œå¤æ‚åº¦å¢åŠ ä¹Ÿä¸å¤§ï¼Œå…¶å®ƒç‰¹ç‚¹ä¸ç»å…¸æ»¤æ³¢å™¨åŸºæœ¬ç›¸åŒã€‚</li></ul><h1 id="æ—¶åŸŸé™å™ªtemporal">æ—¶åŸŸé™å™ªï¼ˆTemporalï¼‰</h1><p>æ—¶åŸŸé™å™ªæ˜¯ä¸€ç§ 3D é™å™ªæ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨å¤šå¸§å›¾åƒåœ¨æ—¶é—´ä¸Šçš„ç›¸å…³æ€§å®ç°é™å™ªã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr30.png"></p><p>ä¸€ç§æœ€ç®€å•çš„å®ç°æ–¹æ³•æ˜¯æ—¶åŸŸå‡å€¼æ»¤æ³¢ï¼Œå³å°†ç›¸é‚»å‡ å¸§å›¾åƒåšåŠ æƒå¹³å‡ã€‚ç”±äºç´¯åŠ åå™ªå£°çš„å¢é•¿é€Ÿåº¦ï¼ˆæ ¹å·å…³ç³»ï¼‰å°äºä¿¡å·çš„å¢é•¿é€Ÿåº¦ï¼ˆçº¿æ€§å…³ç³»ï¼‰ï¼Œæ‰€ä»¥å›¾åƒçš„ä¿¡å™ªæ¯”ä¼šæé«˜ã€‚è¿™ç§æ–¹æ³•çš„ä¸»è¦é—®é¢˜åœ¨äºåªé€‚åˆå¤„ç†é™æ€å›¾åƒï¼Œå¦‚æœç”»é¢ä¸­å­˜åœ¨è¿åŠ¨çš„ç‰©ä½“åˆ™ä¼šå‡ºç°ä¼ªå½±ï¼ˆghost effectï¼‰ã€‚</p><h2 id="è¿åŠ¨é€‚åº”é™å™ª-motion-adaptive-noise-filter">è¿åŠ¨é€‚åº”é™å™ª Motion Adaptive Noise Filter</h2><p>å¯¹åŸºæœ¬çš„æ—¶åŸŸé™å™ªè¿›è¡Œä¸€äº›æ”¹é€ å°±å¯ä»¥å¾—åˆ°ä¸€ç§è‡ªé€‚åº”é™å™ªç®—æ³•ã€‚å‡è®¾å›¾åƒä¸­åæ ‡ (x,y) å¤„çš„åƒç´ å€¼ä¸º P(x,y)ï¼Œ æ–°ä¸€å¸§ä¸­åŒä½ç½®åƒç´ å€¼ä¸º P'(x,y)ï¼Œå¦‚æœä¸¤ä¸ªåƒç´ å€¼çš„å·®å¼‚å°äºæŸé˜ˆå€¼ï¼Œå³|P'-P|&lt;thresholdï¼Œ åˆ™å¯ä»¥ç”¨ P ä»£æ›¿ P'ã€‚è¿™ç§æ–¹æ³•å¯¹é™æ­¢çš„å›¾åƒæ•ˆæœéå¸¸æ˜æ˜¾ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr31.png"></p><p>å‡è®¾ <span class="math inline">\(\hat{g}(i,j,k)\)</span> ä»£è¡¨æœ‰å™ªå£°çš„è§†é¢‘ä¿¡å·åºåˆ—ï¼Œå…¶ä¸­ (i,j) ä»£è¡¨åƒç´ åæ ‡ï¼Œk ä»£è¡¨æ—¶é—´åºåˆ—ï¼Œåˆ™ <span class="math inline">\(\hat{g}(i,j,k)\)</span> å¯ä»¥è¡¨ç¤ºä¸ºçœŸå®ä¿¡å· <span class="math inline">\(\hat{f} (i,j,k)\)</span> å’Œå™ªå£°ä¿¡å· <span class="math inline">\(\hat{n} (i,j,k)\)</span> çš„å åŠ å½¢å¼ï¼š</p><p><span class="math display">\[\hat{g}(i,j,k) = \hat{f}(i,j,k) + \hat{n}(i,j,k)\]</span></p><p>çœŸå®ä¿¡å· f (i,j,k) å½“ç„¶æ˜¯ä¸å¯èƒ½çŸ¥é“çš„ï¼Œåªèƒ½ç”¨æŸç§æ–¹æ³•å¯¹å…¶è¿›è¡Œä¼°è®¡ã€‚ä¸€ç§ç»å…¸çš„ä¼°è®¡æ–¹æ³•æ˜¯é‡‡ç”¨ä»¥ä¸‹éçº¿æ€§æ»¤æ³¢å™¨ï¼š</p><p><span class="math display">\[\hat{f} (k) = \hat{f}(k-1) + \alpha [\hat{g}(k) - \hat{f}(k-1)]\]</span></p><p>å…¶ä¸­ <span class="math inline">\(\hat{f}(k)\)</span> ä»£è¡¨ç¬¬ k å¸§å›¾åƒï¼Œå®ƒçš„æ¥æºæ˜¯åœ¨ç¬¬ k-1 å¸§å›¾åƒçš„åŸºç¡€ä¸Šå åŠ äº† g(k) ä¸ <span class="math inline">\(\hat{f}(k-1)\)</span> çš„å·®å€¼æˆåˆ†ï¼Œå³ <span class="math inline">\(âˆ†= Î±(k)|\hat{g}(k)-\hat{f}(k-1)|\)</span> ï¼Œå…¶ä¸­Î±(k) æ˜¯ä¸âˆ†ç›¸å…³è”çš„é˜»å°¼ç³»æ•°ã€‚</p><ul><li>å½“âˆ† &lt; thres0 æ—¶åˆ¤æ–­ä¸ºå™ªå£°ï¼Œé‡‡ç”¨Î±(k)=0ã€‚</li><li>å½“âˆ† &gt; thres1 æ—¶åˆ¤æ–­ä¸ºçœŸå®ä¿¡å·ï¼Œé‡‡ç”¨å–Î±(k)=1ã€‚</li><li>å½“ thres0 &lt; âˆ† &lt; thres1 æ—¶Î±(k) ä»‹äº 0 å’Œ 1 ä¹‹é—´ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr32.png"></p><p>å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•çš„å±€é™ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œä¸€æ–¹é¢é˜ˆå€¼çš„é€‰å–éœ€è¦èƒ½å¤Ÿæœ‰æ•ˆåœ°åŒºåˆ†å™ªå£°ä¸ç”»é¢å˜åŒ–ï¼Œè¿™æœ¬èº«ä¸æ˜¯ä¸€ä»¶å¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼›å¦ä¸€æ–¹é¢å½“åƒç´ å˜åŒ–è¶…è¿‡é˜ˆå€¼åæ­¤æ–¹æ³•å°±å¤±æ•ˆäº†ï¼Œå› æ­¤ç”»é¢å‰æ™¯éƒ¨åˆ†çš„å™ªå£°å¤„äºé€é¥æ³•å¤–çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</p><p>å› æ­¤ï¼Œä¸€ä¸ªç†æƒ³çš„æ»¤æ³¢å™¨åº”è¯¥åŒæ—¶æ»¡è¶³å‡ ä¸ªç‰¹å¾ï¼Œå³</p><ul><li>èƒ½å¤Ÿæœ‰æ•ˆåœ°åŒºåˆ†ç”»é¢çš„å‰æ™¯ï¼ˆè¿åŠ¨ç›®æ ‡ï¼‰å’ŒèƒŒæ™¯ï¼ˆä¸åŠ¨ç›®æ ‡ï¼‰ã€‚</li><li>å¯¹ç”»é¢ä¸­çš„å‰æ™¯åƒç´ è¿›è¡Œç©ºåŸŸé™å™ªã€‚</li><li>å¯¹ç”»é¢ä¸­çš„èƒŒæ™¯åƒç´ è¿›è¡Œæ—¶åŸŸé™å™ªã€‚</li></ul><h1 id="ç©ºåŸŸæ—¶åŸŸé™å™ªstnr">ç©ºåŸŸæ—¶åŸŸé™å™ªï¼ˆSTNRï¼‰</h1><p>STNR æ˜¯ä¸€ç§ 2D+3D é™å™ªæ–¹æ³•ï¼Œå®ƒé€šè¿‡ä¸€å¥—ç®—æ³•åˆ¤åˆ«ä¸€ä¸ªåƒç´ æ˜¯å±äºå‰æ™¯è¿˜æ˜¯èƒŒæ™¯ï¼Œè¢«åˆ¤å†³ä¸ºèƒŒæ™¯çš„åƒç´ å°†ä¼šå‚ä¸æ—¶åŸŸå¹³æ»‘ï¼Œè¢«åˆ¤å†³ä¸ºå‰æ™¯çš„åƒç´ å°†ä¼šå‚ä¸ç©ºåŸŸå¹³æ»‘ï¼Œè€Œåˆ¤å†³æ¡ä»¶åˆ™æ¯ä¸€å¸§éƒ½åœ¨åŠ¨æ€æ›´æ–°ï¼Œä»¥å°½å¯èƒ½ä¿è¯åˆ¤å†³å‡†ç¡®æ€§ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr33.png"></p><h2 id="å…‰æµæ³•-optical-flow">å…‰æµæ³• Optical Flow</h2><p>å‡è®¾å‰ä¸€å¸§æ—¶é—´ä¸º tï¼Œ åä¸€å¸§æ—¶é—´ä¸º t+Î´tã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ˆÎ´t å¾ˆå°ï¼Œåœ¨Î´t æ—¶é—´å†…å›¾åƒäº®åº¦ä¿æŒç¨³å®šï¼Œç‰©ä½“è¿åŠ¨é€Ÿåº¦ä¸å¤§ï¼Œå¹¶ä¸”ä¸ä¼šçªç„¶æ¶ˆå¤±æˆ–è¢«é®æŒ¡ï¼‰ï¼Œåˆ™å‰ä¸€å¸§ I çš„åƒç´ ç‚¹ I(x, y, z, t) åœ¨åä¸€å¸§ä¸­çš„ä½ç½®ä¸º I(x+Î´x, y+Î´y, z+Î´z, t+Î´t )ã€‚</p><p>å¦‚æœå‡å®šå›¾åƒäº®åº¦æ’å®šï¼Œå³å¯å¾—åˆ°å…‰æµæ³•çš„çº¦æŸæ–¹ç¨‹ï¼ˆconstraint equationï¼‰</p><p><span class="math display">\[I(x,y,z,t) = I(x+Î´x, y+Î´y, z+Î´z, t+Î´t )\]</span></p><p>è¿›ä¸€æ­¥å‡å®šå›¾åƒä¸­çš„ç‰©ä½“è¿åŠ¨é€Ÿåº¦ä¸å¤§ï¼Œåˆ™åä¸€å¸§å›¾åƒå¯ä»¥ç”¨å‰ä¸€å¸§å›¾åƒçš„æ³°å‹’å±•å¼€å½¢å¼è¡¨ç¤ºï¼ˆåªä¿ç•™ä¸€é˜¶è¿‘ä¼¼ï¼‰</p><p><span class="math display">\[I(x+Î´x, y+Î´y, z+Î´z, t+Î´t ) = I(x,y,z,t) + \frac{\mathrm{d} I}{\mathrm{d} x} Î´x + \frac{\mathrm{d} I}{\mathrm{d} y} Î´y + \frac{\mathrm{d} I}{\mathrm{d} z} Î´z + \frac{\mathrm{d} I}{\mathrm{d} t} Î´t\]</span></p><p>æ ¹æ®çº¦æŸæ–¹ç¨‹ï¼Œä¸Šå¼ä¸­åå¯¼æ•°ä¹‹å’Œåº”ä¸º 0ï¼Œå³</p><p><span class="math display">\[\frac{\mathrm{d} I}{\mathrm{d} x} V_x + \frac{\mathrm{d} I}{\mathrm{d} y} V_y + \frac{\mathrm{d} I}{\mathrm{d} z} V_z + \frac{\mathrm{d} I}{\mathrm{d} t} V_t = 0\]</span></p><p>å¯¹äºäºŒç»´å›¾åƒå¯å¿½ç•¥ z åˆ†é‡ï¼Œçº¦æŸæ–¹ç¨‹çš„æœ€ç»ˆå½¢å¼ä¸ºï¼š</p><p><span class="math display">\[I_x V_x + I_y V_y = - I_t\]</span></p><p>é€šå¸¸åœ¨ä¸€ä¸ªå°çª—å£å†…è¿›è¡Œå…‰æµè®¡ç®—ï¼Œé‡‡ç”¨æœ€å°äºŒä¹˜æ³•æ±‚å¾—è¯¥çª—å£å†…çš„å¹³å‡è¿åŠ¨å‘é‡ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œå°çª—å£å†…çš„åƒç´ åº”å…·æœ‰ä¸€è‡´çš„è¿åŠ¨å‘é‡ï¼Œå› æ­¤æ±‚å¾—çš„å¹³å‡å‘é‡å°±ä»£è¡¨ç€ç‰©ä½“çœŸå®çš„è¿åŠ¨æ–¹å‘ã€‚</p><h2 id="å—åŒ¹é…æ³•-block-matching">å—åŒ¹é…æ³• Block Matching</h2><p>å—åŒ¹é…çš„æ€æƒ³æ˜¯åœ¨å‚è€ƒå¸§ï¼ˆé€šå¸¸æ˜¯ä¸Šä¸€å¸§ï¼‰ä¸­çš„ä¸€ä¸ªå°èŒƒå›´å†…æœç´¢ä¸å½“å‰å— (block) æœ€åŒ¹é…çš„å—ï¼Œå¦‚æœç¡®å®èƒ½å¤Ÿæ‰¾åˆ°åˆ™è®¡ç®—å‡ºè¿åŠ¨å‘é‡ vã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr34.png"></p><p>æ‰€è°“â€œæœ€åŒ¹é…â€çš„å—å…¶å®å¯ä»¥æœ‰å¾ˆå¤šç§ä¸åŒçš„è¯„åˆ¤æ ‡å‡†ã€‚å¸¸ç”¨çš„æ ‡å‡†æœ‰ Mean Squared Error (MSE) ä»¥åŠ Mean Absolute Error (MAE) ç­‰ç®—æ³•ã€‚</p><p>æœç´¢åŒºåŸŸä¸€èˆ¬æ˜¯æ ¹æ®äº§å“çš„éœ€æ±‚å’Œè®¾è®¡çº¦æŸè€Œå®šï¼Œå¸¸ç”¨çš„æœ‰ 13x13ï¼Œ17x17 åƒç´ ç­‰ã€‚æœç´¢åŒºåŸŸè¶Šå¤§èƒ½å¤Ÿæ£€æµ‹çš„è¿åŠ¨é€Ÿåº¦è¶Šå¤§ï¼Œä½†æ˜¯æ‰€éœ€çš„ç®—åŠ›æˆæœ¬ä¹Ÿä¼šå‘ˆå¹³æ–¹å¢é•¿ã€‚</p><p>å½“å›¾åƒç§å­˜åœ¨é‡å¤çš„çº¹ç†æ¨¡å¼æ—¶ï¼Œå…‰æµæ³•å’Œå—åŒ¹é…æ³•éƒ½å®¹æ˜“å¤±æ•ˆã€‚åœ¨ä¸‹å›¾çš„ä¾‹å­ä¸­ï¼Œç»¿æ¡†æ‰€ç¤ºçš„å—çŠ¶çº¹ç†å’Œé»„æ¡†æ‰€ç¤ºçš„è¾¹ç¼˜çº¹ç†éƒ½å®¹æ˜“å¼•èµ·ç®—æ³•å¤±æ•ˆã€‚è€Œè“æ¡†æ‰€ç¤ºçš„å«ç›´è§’çš„å—åˆ™è¾ƒå®¹æ˜“è¢«ç®—æ³•æ­£ç¡®è¯†åˆ«ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/nr35.png"></p><h1 id="bm3d-ç®—æ³•">BM3D ç®—æ³•</h1><h2 id="åŸºç¡€ä¼°è®¡">åŸºç¡€ä¼°è®¡</h2><ul><li>å¯¹äºæ¯ä¸ªç›®æ ‡å›¾å—ï¼Œåœ¨é™„è¿‘å¯»æ‰¾æœ€å¤š MAXN1ï¼ˆè¶…å‚æ•°ï¼‰ä¸ªç›¸ä¼¼çš„å›¾å—ï¼Œä¸ºäº†é¿å…å™ªç‚¹çš„å½±å“ï¼Œå°†å›¾å—ç»è¿‡ 2D å˜æ¢ï¼ˆä»£ç ä¸­ä½¿ç”¨ DCT å˜æ¢ï¼‰åå†ç”¨æ¬§æ°è·ç¦»è¡¡é‡ç›¸ä¼¼ç¨‹åº¦ã€‚æŒ‰è·ç¦»ä»å°åˆ°å¤§æ’åºåå–æœ€å¤šå‰ MAXN1 ä¸ªã€‚å æˆä¸€ä¸ªä¸‰ç»´æ•°ç»„ã€‚</li></ul><p><span class="math display">\[\begin{equation}d\left(Z_{x_R}, Z_x\right)=\frac{\left\|\Upsilon^{\prime}\left(\mathcal{T}_{2 \mathrm{D}}^{\mathrm{ht}}\left(Z_{x_R}\right)\right)-\Upsilon^{\prime}\left(\mathcal{T}_{2 \mathrm{D}}^{\mathrm{ht}}\left(Z_x\right)\right)\right\|_2^2}{\left(N_1^{\mathrm{ht}}\right)^2}\end{equation}\]</span></p><ul><li>å¯¹ 3D æ•°ç»„çš„ç¬¬ä¸‰ç»´ï¼Œå³å›¾å—å èµ·æ¥åï¼Œæ¯ä¸ªå›¾å—åŒä¸€ä¸ªä½ç½®çš„åƒç´ ç‚¹æ„æˆçš„æ•°ç»„ï¼Œè¿›è¡Œ DCT å˜æ¢åï¼Œé‡‡ç”¨ç¡¬é˜ˆå€¼çš„æ–¹å¼å°†å°äºè¶…å‚æ•° <span class="math inline">\(\lambda_{3D}\)</span> çš„æˆåˆ†ç½®ä¸º 0ã€‚åŒæ—¶ç»Ÿè®¡éé›¶æˆåˆ†çš„æ•°é‡ä½œä¸ºåç»­æƒé‡çš„å‚è€ƒã€‚åå°†ç¬¬ä¸‰ç»´è¿›è¡Œé€†å˜æ¢ã€‚</li></ul><p><span class="math display">\[\begin{equation}\widehat{\mathbf{Y}}_{S_{x_R}^{\mathrm{ht}}}^{\mathrm{ht}}=\mathcal{T}_{3 \mathrm{D}}^{\mathrm{ht}^{-1}}\left(\Upsilon\left(\mathcal{T}_{3 \mathrm{D}}^{\mathrm{ht}}\left(\mathbf{Z}_{S_{x_R}^{\mathrm{ht}}}\right)\right)\right),\end{equation}\]</span></p><ul><li>å°†è¿™äº›å›¾å—é€†å˜æ¢åæ”¾å›åŸä½ï¼Œåˆ©ç”¨éé›¶æˆåˆ†æ•°é‡ç»Ÿè®¡å åŠ æƒé‡ï¼Œæœ€åå°†å æ”¾åçš„å›¾é™¤ä»¥æ¯ä¸ªç‚¹çš„æƒé‡å°±å¾—åˆ°åŸºç¡€ä¼°è®¡çš„å›¾åƒï¼Œæ­¤æ—¶å›¾åƒçš„å™ªç‚¹å¾—åˆ°äº†è¾ƒå¤§çš„å»é™¤ã€‚</li></ul><p><span class="math display">\[\begin{equation}\hat{y}^{\text {basic }}(x)=\frac{\sum_{x_R \in X} \sum_{x_m \in S_{x_R}^{\mathrm{ht}}} w_{x_R}^{\mathrm{ht}} \widehat{Y}_{x_m}^{\mathrm{ht}, x_R}(x)}{\sum_{x_R \in X} \sum_{x_m \in S_{x_R}^{\mathrm{ht}}} w_{x_R}^{\mathrm{ht}} \chi_{x_m}(x)}, \forall x \in X,\end{equation}\]</span></p><h2 id="æœ€ç»ˆä¼°è®¡">æœ€ç»ˆä¼°è®¡</h2><ul><li>ç”±äºåŸºç¡€ä¼°è®¡æå¤§åœ°æ¶ˆé™¤äº†å™ªç‚¹ï¼Œå¯¹äºå«å™ªåŸå›¾çš„æ¯ä¸ªç›®æ ‡å›¾å—ï¼Œå¯ä»¥ç›´æ¥ç”¨å¯¹åº”åŸºç¡€ä¼°è®¡å›¾å—çš„æ¬§æ°è·ç¦»è¡¡é‡ç›¸ä¼¼ç¨‹åº¦ã€‚æŒ‰è·ç¦»ä»å°åˆ°å¤§æ’åºåå–æœ€å¤šå‰ MAXN1 ä¸ªã€‚å°†åŸºç¡€ä¼°è®¡å›¾å—ã€å«å™ªåŸå›¾å›¾å—åˆ†åˆ«å æˆä¸¤ä¸ªä¸‰ç»´æ•°ç»„ã€‚</li></ul><p><span class="math display">\[\begin{equation}S_{x_R}^{\text {wie }}=\left\{x \in X: \frac{\left\|\widehat{Y}_{x_R}^{\text {basic }}-\widehat{Y}_x^{\text {basic }}\right\|_2^2}{\left(N_1^{\text {wie }}\right)^2}&lt;\tau_{\text {match }}^{\text {wie }}\right\} .\end{equation}\]</span></p><ul><li>å¯¹å«åŸºç¡€ä¼°è®¡ 3D æ•°ç»„çš„ç¬¬ä¸‰ç»´ï¼Œå³å›¾å—å èµ·æ¥åï¼Œæ¯ä¸ªå›¾å—åŒä¸€ä¸ªä½ç½®çš„åƒç´ ç‚¹æ„æˆçš„æ•°ç»„ï¼Œè¿›è¡Œ DCT å˜æ¢ï¼Œåˆ©ç”¨å¦‚ä¸‹å…¬å¼å¾—åˆ°ç³»æ•°ã€‚</li></ul><p><span class="math display">\[\begin{equation}\mathbf{W}_{S_{x_R}^{\text {wie }}}=\frac{\left|\mathcal{T}_{3 \mathrm{D}}^{\text {wie }}\left(\widehat{\mathbf{Y}}_{S_{x_R}^{\text {waic }}}^{\text {wasic }}\right)\right|^2}{\left|\mathcal{T}_{3 \mathrm{D}}^{\text {wie }}\left(\widehat{\mathbf{Y}}_{S_{x_R}^{\text {basic }}}^{\text {baic }}\right)\right|^2+\sigma^2}\end{equation}\]</span></p><ul><li>å°†ç³»æ•°ä¸å«å™ª 3D å›¾å—ç›¸ä¹˜æ”¾å›åŸå¤„ï¼Œæœ€ååšåŠ æƒå¹³å‡è°ƒæ•´å³å¯å¾—åˆ°æœ€ç»ˆä¼°è®¡å›¾ã€‚ç›¸å¯¹äºåŸºç¡€ä¼°è®¡å›¾ï¼Œè¿˜åŸäº†æ›´å¤šåŸå›¾çš„ç»†èŠ‚ã€‚</li></ul><p><span class="math display">\[\begin{equation}\widehat{\mathbf{Y}}_{S_{x_R}^{\text {wie }}}^{\text {wie }}=\mathcal{T}_{3 \mathrm{D}}^{\text {wie }^{-1}}\left(\mathbf{W}_{S_{x_R}^{\text {wie }}} \mathcal{T}_{3 \mathrm{D}}^{\text {wie }}\left(\mathbf{Z}_{S_{x_R}^{\text {wie }}}\right)\right)\end{equation}\]</span></p><h2 id="bm3d-ä»£ç å®ç°">BM3D ä»£ç å®ç°</h2><ul><li>BM3D å®˜ç½‘ï¼ŒMatlab å®ç° <span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWdlcy50dW5pLmZpL2ZvaS9HQ0YtQk0zRC8=">https://webpages.tuni.fi/foi/GCF-BM3D/<i class="fa fa-external-link-alt"></i></span>ã€‚</li><li>ä¸€ç¯‡ BM3D çš„å¿«é€Ÿå®ç°ï¼Œæä¾›äº†æºç  <span class="exturl" data-url="aHR0cHM6Ly93d3cuaXBvbC5pbS9wdWIvYXJ0LzIwMTIvbC1ibTNkLw==">https://www.ipol.im/pub/art/2012/l-bm3d/<i class="fa fa-external-link-alt"></i></span>ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgyMDkyNw==">https://zhuanlan.zhihu.com/p/98820927<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MzY1NDQyMTU=">https://zhuanlan.zhihu.com/p/536544215<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NjM5OTc4NA==">https://zhuanlan.zhihu.com/p/46399784<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuaXBvbC5pbS9wdWIvYXJ0LzIwMTIvbC1ibTNkLw==">https://www.ipol.im/pub/art/2012/l-bm3d/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWdlcy50dW5pLmZpL2ZvaS9HQ0YtQk0zRC8=">https://webpages.tuni.fi/foi/GCF-BM3D/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDI0MjM2MTU=">https://zhuanlan.zhihu.com/p/102423615<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP RGB åŸŸä¹‹ CCM</title>
      <link href="/2023/Camera/CameraISPRGBCCM/"/>
      <url>/2023/Camera/CameraISPRGBCCM/</url>
      
        <content type="html"><![CDATA[<h1 id="why">Whyï¼Ÿ</h1><p>æˆ‘ä»¬è‚‰çœ¼çš„å¯¹å…‰è°±çš„ RGB å“åº”æ›²çº¿å’Œ sensor çš„å“åº”æ›²çº¿æ˜¯ä¸åŒçš„ï¼› <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ccm1.png"></p><p>CCM ä¸€èˆ¬æ˜¯ 3x3 çŸ©é˜µå½¢å¼ï¼Œä¹Ÿæœ‰ 3x4 å½¢å¼çš„ï¼Œ3x4 å½¢å¼ä¸»è¦æ˜¯ç»™ rgb å„è‡ªåŠ ä¸€ä¸ª offset</p><p><span class="math display">\[\begin{bmatrix}R_{out} \\G_{out} \\B_{out} \end{bmatrix} = \begin{bmatrix}CC_{00}  &amp; CC_{01} &amp; CC_{02}\\CC_{10}  &amp; CC_{11} &amp; CC_{12}\\CC_{20}  &amp; CC_{21} &amp; CC_{22}\end{bmatrix} \ast  \begin{bmatrix}R_{in} \\G_{in} \\B_{in} \end{bmatrix}\]</span></p><p><span class="math display">\[\begin{bmatrix}R_{out} \\G_{out} \\B_{out} \end{bmatrix} = \begin{bmatrix}CC_{00}  &amp; CC_{01} &amp; CC_{02} &amp; OFFSET_r\\CC_{10}  &amp; CC_{11} &amp; CC_{12} &amp; OFFSET_g\\CC_{20}  &amp; CC_{21} &amp; CC_{22} &amp; OFFSET_b\end{bmatrix} \ast  \begin{bmatrix}R_{in} \\G_{in} \\B_{in} \end{bmatrix}\]</span></p><span id="more"></span><p>ä¸Šé¢çš„äººçœ¼ rgb å“åº”å’Œ sensor rgb å“åº”æ›²çº¿éƒ½æ˜¯éçº¿æ€§çš„ï¼Œæ‰€ä»¥æŒ‡æœ›é€šè¿‡ä¸€ä¸ª CCM çŸ©é˜µå°±å¾—åˆ°åŒ¹é…åº¦å¾ˆå¥½çš„æ˜ å°„å…³ç³»æ˜¯ä¸ç°å®çš„ã€‚ç°å®ä¸­ï¼Œå¾€å¾€ä¼šæ ‡å®šå¾ˆå¤šä¸ª CCMï¼ŒISP åœ¨è¿è¡Œçš„æ—¶å€™æ ¹æ®ç…§åº¦ï¼Œå…‰æºç­‰ç­‰å› ç´ ï¼Œé€‰æ‹©ä¸¤ä¸ªæœ€è¿‘çš„ CCM æ’å€¼å¾—åˆ°æœ€ç»ˆçš„ CCMï¼›</p><p>CCM æ¨¡å—åœ¨ apply awb gain åé¢ï¼Œå› æ­¤ 3x3 ä¸ªå€¼å­˜åœ¨çº¦æŸæ¡ä»¶ï¼š</p><p><span class="math display">\[CC_{00} + CC_{01} + CC_{02} = 1CC_{10} + CC_{11} + CC_{12} = 1CC_{20} + CC_{21} + CC_{22} = 1\]</span></p><p>ä¿è¯ç°ç‚¹ä¹Ÿå°±æ˜¯ r=g=b çš„ç‚¹ï¼Œç»è¿‡ CCM ä»¥åä»ç„¶ r=g=bï¼›</p><h1 id="æ ‡å®š-ccm-æ–¹æ³•">æ ‡å®š CCM æ–¹æ³•</h1><ul><li><p>ç”¨ camera æ‹ä¸€å¼ æŸä¸ªè‰²æ¸©ä¸‹çš„ 24 è‰²å¡ raw æ–‡ä»¶ï¼šæ³¨æ„ shading å½±å“ï¼Œæ‹è¿™ä¸ªè‰²å¡å æ•´ä¸ª sensor ä¸­é—´ä¸€å°éƒ¨åˆ†å°±å¯ä»¥ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ccm2.png"></p></li><li>raw æ–‡ä»¶é¢„å¤„ç†ã€‚ä¸»è¦åŒ…æ‹¬å‡ blcï¼Œæ ¹æ®ç¬¬ 4 è¡Œçš„ patchï¼Œè·å– awb gain å€¼ï¼Œä¹˜ä¸Šå»ï¼›è¿™æ ·å°±æ‹¿åˆ°äº†è¿™ä¸ªè‰²æ¸©ä¸‹ 24 ä¸ª patch çš„ rgb å€¼ã€‚</li><li><p>ç†æƒ³ rgb å€¼ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ccm3.png"></p></li></ul><p>è¿™æ˜¯è‰²å¡å‚å®¶æä¾›çš„ 24 ä¸ª patch çš„æ ‡å‡† rgb ç©ºé—´ä¸‹çš„ç†è®ºå€¼ï¼›æ‹¿åˆ°è¿™ä¸ªå€¼ä»¥åï¼Œéœ€è¦è¿›è¡Œå gamma å¤„ç†ï¼Œå› ä¸ºå‚å®¶æä¾›çš„æ˜¯ srgb çš„å€¼ï¼Œæ˜¯å¸¦äº† 2.2gamma çš„ï¼ŒISP çš„ CCM æ¨¡å—ä¸€èˆ¬æ˜¯åœ¨ gamma å‰é¢ï¼Œå› æ­¤è¦å¯¹ç†è®ºå€¼è¿›è¡Œå gamma å¤„ç†ï¼›</p><h1 id="æ ‡å®šç®—æ³•">æ ‡å®šç®—æ³•</h1><p>å·²çŸ¥ 100 ä¸ª raw rgb å€¼ï¼Œå·²çŸ¥å¯¹åº”çš„ç†è®º rgb å€¼ï¼›æ±‚ä¸€ä¸ª 3x3 çº¿æ€§å˜æ¢çŸ©é˜µï¼›è¿™ä¸ªçŸ©é˜µè¦ä½¿å¾—æ˜ å°„åçš„ rgb å€¼å°½å¯èƒ½çš„æ¥è¿‘ç†è®ºå€¼ï¼›</p><p>å€Ÿé‰´æ·±åº¦å­¦ä¹ çš„æ¢¯åº¦ä¸‹é™æ–¹æ³•ï¼Œå¯ä»¥å¿«é€Ÿå¾—åˆ° CCMï¼›å¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰ 100 ä¸ª patch çš„é‡è¦ç¨‹åº¦ï¼Œä½¿å¾—æŸäº› patch çš„è¯¯å·®éå¸¸å°ã€‚</p><p>å®šä¹‰æŸå¤±å’Œæ¢¯åº¦å‡½æ•°ï¼Œæµ‹é‡ rgb å€¼å¾—å·®å¼‚ï¼Œé‡‡ç”¨ L2 è·ç¦»ï¼›</p><p><span class="math display">\[L_i =  {\textstyle \sum_{n=1}^{18}} (CCM \ast RGB_{origin} - RGB_{standard})^2\]</span></p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight matlab"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">from mpl_toolkits.mplot3d import Axes3D</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import torch</span><br><span class="line"></span><br><span class="line">ccm = torch.tensor([[<span class="number">1655</span>, <span class="number">-442</span>, <span class="number">-189</span>], [<span class="number">-248</span>, <span class="number">1466</span>, <span class="number">-194</span>], [<span class="number">-48</span>, <span class="number">-770</span>, <span class="number">1842</span>]], dtype=torch.float32)</span><br><span class="line">rgb_data = torch.randint(<span class="number">0</span>, <span class="number">255</span>, (<span class="number">3</span>, <span class="number">100</span>))</span><br><span class="line">rgb_data = rgb_data.float()</span><br><span class="line"></span><br><span class="line">error_manual = torch.<span class="built_in">randn</span>((<span class="number">3</span>, <span class="number">100</span>)) * <span class="number">16</span></span><br><span class="line">rgb_target = ccm.mm(rgb_data)/<span class="number">1024.0</span></span><br><span class="line">rgb_target_error = rgb_target + error_manual</span><br><span class="line">ccm_calc1 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line">ccm_calc2 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line">ccm_calc3 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line">ccm_calc5 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line">ccm_calc6 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line">ccm_calc7 = torch.tensor([<span class="number">0.0</span>], dtype=torch.float32, requires_grad=True)</span><br><span class="line"></span><br><span class="line">def squared_loss(rgb_tmp, rgb_ideal):</span><br><span class="line">    <span class="keyword">return</span> torch.sum((rgb_tmp-rgb_ideal)**<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">def sgd(params, lr, batch_size):</span><br><span class="line">    <span class="keyword">for</span> param in params:</span><br><span class="line">        param.data -= lr * param.grad/batch_size;</span><br><span class="line"></span><br><span class="line">def net(ccm_calc1, ccm_calc2, ccm_calc3, ccm_calc5, ccm_calc6, ccm_calc7, rgb_data):</span><br><span class="line">    rgb_tmp = torch.zeros_like(rgb_data)</span><br><span class="line">    rgb_tmp[<span class="number">0</span>, :] = ((<span class="number">1024.0</span> - ccm_calc1 - ccm_calc2) * rgb_data[<span class="number">0</span>, :] + ccm_calc1 * rgb_data[<span class="number">1</span>, :] + ccm_calc2 * rgb_data[<span class="number">2</span>, :]) / <span class="number">1024.0</span></span><br><span class="line">    rgb_tmp[<span class="number">1</span>, :] = (ccm_calc3 * rgb_data[<span class="number">0</span>, :] + (<span class="number">1024.0</span> - ccm_calc3 - ccm_calc5) * rgb_data[<span class="number">1</span>, :] + ccm_calc5 * rgb_data[<span class="number">2</span>, :]) / <span class="number">1024.0</span></span><br><span class="line">    rgb_tmp[<span class="number">2</span>, :] = (ccm_calc6 * rgb_data[<span class="number">0</span>, :] + ccm_calc7 * rgb_data[<span class="number">1</span>, :] + (<span class="number">1024.0</span> - ccm_calc6 - ccm_calc7) * rgb_data[<span class="number">2</span>, :]) / <span class="number">1024.0</span></span><br><span class="line">    <span class="keyword">return</span> rgb_tmp</span><br><span class="line"></span><br><span class="line">lr = <span class="number">3</span></span><br><span class="line">num_epochs = <span class="number">100</span></span><br><span class="line"><span class="keyword">for</span> epoch in range(num_epochs):</span><br><span class="line">    l = squared_loss(net(ccm_calc1, ccm_calc2, ccm_calc3, ccm_calc5, ccm_calc6, ccm_calc7, rgb_data), rgb_target_error)</span><br><span class="line">    l.backward()</span><br><span class="line">    sgd([ccm_calc1, ccm_calc2, ccm_calc3, ccm_calc5, ccm_calc6, ccm_calc7], lr, <span class="number">100</span>)</span><br><span class="line">    ccm_calc1.grad.data.zero_()</span><br><span class="line">    ccm_calc2.grad.data.zero_()</span><br><span class="line">    ccm_calc3.grad.data.zero_()</span><br><span class="line">    ccm_calc5.grad.data.zero_()</span><br><span class="line">    ccm_calc6.grad.data.zero_()</span><br><span class="line">    ccm_calc7.grad.data.zero_()</span><br><span class="line">    print(<span class="string">'epoch %d, loss %f'</span><span class="comment">%(epoch, l))</span></span><br><span class="line"></span><br><span class="line">res = torch.tensor([[<span class="number">1024.0</span> - ccm_calc1 - ccm_calc2, ccm_calc1, ccm_calc2],</span><br><span class="line">                    [ccm_calc3, <span class="number">1024.0</span>-ccm_calc3-ccm_calc5, ccm_calc5],</span><br><span class="line">                    [ccm_calc6, ccm_calc7, <span class="number">1024.0</span>-ccm_calc6-ccm_calc7]], dtype=torch.float32)</span><br><span class="line">print(res);</span><br><span class="line"></span><br><span class="line">rgb_apply_ccm = res.mm(rgb_data)/<span class="number">1024.0</span></span><br><span class="line"></span><br><span class="line">fig1 = plt.<span class="built_in">figure</span>(<span class="number">1</span>)</span><br><span class="line">ax1 = fig1.add_subplot(<span class="number">111</span>, projection=<span class="string">'3d'</span>)</span><br><span class="line">fig2 = plt.<span class="built_in">figure</span>(<span class="number">2</span>)</span><br><span class="line">ax2 = fig2.add_subplot(<span class="number">111</span>, projection=<span class="string">'3d'</span>)</span><br><span class="line"></span><br><span class="line">x2 = rgb_data[<span class="number">0</span>]</span><br><span class="line">y2 = rgb_data[<span class="number">1</span>]</span><br><span class="line">z2 = rgb_data[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">ax1.<span class="built_in">scatter</span>(x2, y2, z2, marker=<span class="string">'*'</span>, c=<span class="string">'b'</span>, label=<span class="string">'origin RGB'</span>)</span><br><span class="line"></span><br><span class="line">ax1.set_xlim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax1.set_ylim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax1.set_zlim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax1.set_xlabel(<span class="string">'R'</span>)</span><br><span class="line">ax1.set_ylabel(<span class="string">'G'</span>)</span><br><span class="line">ax1.set_zlabel(<span class="string">'B'</span>)</span><br><span class="line"></span><br><span class="line">x3 = rgb_target[<span class="number">0</span>]</span><br><span class="line">y3 = rgb_target[<span class="number">1</span>]</span><br><span class="line">z3 = rgb_target[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">ax1.<span class="built_in">scatter</span>(x3, y3, z3, marker=<span class="string">'o'</span>, c=<span class="string">'c'</span>, label=<span class="string">'target rgb'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> in range(len(x3)):</span><br><span class="line">    ax1.<span class="built_in">plot</span>([x2[<span class="built_in">i</span>], x3[<span class="built_in">i</span>]], [y2[<span class="built_in">i</span>], y3[<span class="built_in">i</span>]], [z2[<span class="built_in">i</span>], z3[<span class="built_in">i</span>]], <span class="string">'k-.'</span>)</span><br><span class="line">ax1.<span class="built_in">legend</span>()</span><br><span class="line"></span><br><span class="line">ax2.set_xlim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax2.set_ylim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax2.set_zlim(<span class="number">-80</span>, <span class="number">360</span>)</span><br><span class="line">ax2.set_xlabel(<span class="string">'R'</span>)</span><br><span class="line">ax2.set_ylabel(<span class="string">'G'</span>)</span><br><span class="line">ax2.set_zlabel(<span class="string">'B'</span>)</span><br><span class="line">ax2.<span class="built_in">scatter</span>(x3, y3, z3, marker=<span class="string">'o'</span>, c=<span class="string">'c'</span>, label=<span class="string">'target rgb'</span>)</span><br><span class="line"></span><br><span class="line">x4 = rgb_apply_ccm[<span class="number">0</span>]</span><br><span class="line">y4 = rgb_apply_ccm[<span class="number">1</span>]</span><br><span class="line">z4 = rgb_apply_ccm[<span class="number">2</span>]</span><br><span class="line">ax2.<span class="built_in">scatter</span>(x4, y4, z4, marker=<span class="string">'^'</span>, c=<span class="string">'b'</span>, label=<span class="string">'apply ccm rgb'</span>)</span><br><span class="line">ax2.<span class="built_in">legend</span>()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></tbody></table></figure><p>å¯è§†åŒ–çœ‹ä¸€ä¸‹æ˜ å°„åçš„ç‚¹ä¸ç†è®ºç‚¹çš„è·ç¦»ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ccm4.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDg2MjY0ODA=">https://zhuanlan.zhihu.com/p/108626480<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP Raw åŸŸ AWB</title>
      <link href="/2023/Camera/CameraISPRawAWB/"/>
      <url>/2023/Camera/CameraISPRawAWB/</url>
      
        <content type="html"><![CDATA[<h1 id="é¢œè‰²æ’å¸¸ç†è®º">é¢œè‰²æ’å¸¸ç†è®º</h1><h2 id="äººç±»è§†è§‰ç‰¹æ€§">äººç±»è§†è§‰ç‰¹æ€§</h2><p>äººçœ¼ä¸­å­˜åœ¨ä¸€ç§æ„Ÿåº”äº®åº¦çš„æ†ç»†èƒï¼ˆrodï¼‰å’Œä¸‰ç§æ„Ÿåº”é¢œè‰²çš„è§†é”¥ä½“ç»†èƒï¼ˆconeï¼‰ã€‚é”¥ä½“ç»†é›†ä¸­åˆ†å¸ƒåœ¨è§†ç½‘è†œï¼ˆretinaï¼‰ä¸Šçš„ä¸­å¤®çªï¼ˆfovea centralisï¼‰åŒºåŸŸã€‚ä¸­å¤®çªä¹‹å¤–å…¨éƒ¨æ˜¯æ†ç»†èƒï¼Œæ€»æ•°çº¦æœ‰ 1200 ä¸‡ï¼Œä¸‰ç§è§†é”¥ä½“ç»†èƒç”¨ L,M,Sï¼ˆæˆ– R,G,Bï¼‰ç¬¦å·åŠ ä»¥åŒºåˆ†ï¼Œæ€»æ•°å¤§çº¦æœ‰ 600 ä¸‡ï½700 ä¸‡ï¼Œæ ¹æ®å®éªŒç»“æœåˆ†æï¼ŒL å  64%ï¼ŒM å  32%ï¼ŒS å  2%ã€‚</p><p>è¿™ä¸‰ç§è§†é”¥ç»†èƒåˆ†åˆ«æ„Ÿåº”ä¸åŒæ³¢é•¿èŒƒå›´ï¼ˆé¢‘æ®µï¼‰çš„å…‰åˆºæ¿€ï¼Œå“åº”çµæ•åº¦ä¹Ÿä¸åŒã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œæ„Ÿåº”è“å…‰çš„è§†é”¥ç»†èƒçµæ•åº¦æœ€ä½ï¼ˆç»†èƒæ•°é‡æœ€å°‘ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb1.png"></p><p>å¦‚æœåªéœ€è¦è€ƒè™‘å“åº”çš„æ³¢æ®µé—®é¢˜ï¼Œè€Œä¸éœ€è¦ç ”ç©¶çµæ•åº¦å·®å¼‚ï¼Œåˆ™ç»å¸¸ä½¿ç”¨ç”¨å½’ä¸€åŒ–å“åº”ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb2.png"></p><span id="more"></span><h2 id="é¢œè‰²æ’å¸¸ç†è®º-1">é¢œè‰²æ’å¸¸ç†è®º</h2><p>äººç±»è§†è§‰ç³»ç»Ÿï¼ˆHuman Visual System, HVSï¼‰èƒ½å¤Ÿåœ¨å„ç§ä¸åŒçš„å…‰ç…§æ¡ä»¶ä¸‹è¯†åˆ«ç‰©ä½“çš„é¢œè‰²ï¼Œè¿™ç§è‡ªåŠ¨æ’é™¤å…‰æºå½±å“çš„èƒ½åŠ›ç§°ä¸ºé¢œè‰²æ’å¸¸ï¼ˆcolor constancyï¼‰ã€‚</p><p>æ ¹æ®å¾·å›½ç”Ÿç†å­¦å®¶ Johannes von Kries äº 1902 å¹´æå‡ºçš„çŒœæƒ³ï¼Œé¢œè‰²æ’å¸¸ç°è±¡æ€»ç»“ä¸‹æ¥æœ‰å‡ ä¸ªè¦ç‚¹ï¼š</p><ul><li>è§†é”¥ç»†èƒä¼šæ ¹æ®å‘¨å›´ç¯å¢ƒå…‰çš„æƒ…å†µç‹¬ç«‹åœ°è°ƒæ•´é¢œè‰²é€šé“çš„æ•æ„Ÿåº¦ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœç¯å¢ƒå…‰ä¸­çš„é•¿æ³¢æ®µï¼ˆçº¢è‰²ï¼‰åŠŸç‡è¾ƒå¤§ï¼Œåˆ™æ„Ÿåº”é•¿æ³¢çš„ L è§†é”¥ç»†èƒçš„æ•æ„Ÿåº¦ä¼šä¸‹é™ï¼Œä½† M å’Œ S è§†é”¥ç»†èƒçš„æ•æ„Ÿåº¦åˆ™ä¸ä¼šéš L ç»†èƒåŒæ­¥å˜åŒ–ã€‚</li><li>åœ¨ä»»ä½•å…‰ç…§ä¸‹ï¼Œå½“ä¸‰ç§è§†é”¥ç»†èƒçš„å“åº”å‡è¾¾åˆ°å„è‡ªçš„æœ€å¤§å€¼æ—¶ï¼Œæ¿€å‘çš„çŸ¥è§‰éƒ½æ˜¯ç™½è‰²ï¼Œæ­¤æ—¶ä¸‰ç§è§†é”¥ç»†èƒçš„å“åº”ç»„åˆï¼ˆLw,Mw,Swï¼‰ç§°ä¸ºç™½åœºå“åº”ã€‚</li><li>å¦‚æœå…‰ç…§ç¯å¢ƒä¸åŒï¼Œç™½åœºå“åº”å€¼ä¹Ÿä¸åŒï¼Œå³ï¼ˆLw, Mw, Swï¼‰Î± â‰ ï¼ˆLw, Mw, Swï¼‰Î²ã€‚</li><li>äººç±»çŸ¥è§‰åˆ°çš„é¢œè‰²å–å†³äºä¸‰åˆºæ¿€å€¼ç›¸å¯¹äºç™½åœºå“åº”çš„æ¯”å€¼ï¼Œå¹¶éå®Œå…¨å–å†³äºä¸‰åˆºæ¿€å€¼æœ¬èº«ã€‚åœ¨ä¸åŒå…‰ç…§ä¸‹ï¼Œå¦‚æœä¸¤ä¸ªé¢œè‰²åœ¨è§†é”¥ç»†èƒä¸Šæ¿€å‘çš„æ¯”å€¼ï¼ˆä¸‰åˆºæ¿€å€¼/ç™½åœºå“åº”ï¼‰ç›¸åŒï¼Œåˆ™äº§ç”Ÿçš„é¢œè‰²çŸ¥è§‰ä¹Ÿï¼ˆåŸºæœ¬ï¼‰ç›¸åŒã€‚è¿™å°±ä¸ºé¢œè‰²æ’å¸¸æä¾›äº†å¯èƒ½ã€‚</li><li>è¦ç‚¹ 4 æ‰€æè¿°çš„æ¯”å€¼åœ¨ç°å®ä¸–ç•Œä¸­çš„å¯¹åº”ç‰©ï¼ˆcounterpartï¼‰å…¶å®å°±æ˜¯ç‰©ä½“è¡¨é¢å¯¹å…‰çº¿çš„åå°„ç‡ï¼ˆsurface reflectanceï¼‰ã€‚å¦‚æœä¸€ä¸ªç‰©ä½“è¡¨é¢å¯¹å…‰çº¿çš„åå°„ç‰¹æ€§ä¸éšå…‰ç…§æ¡ä»¶è€Œå˜åŒ–ï¼ˆé™¤äº†å˜è‰²é¾™å¤–å¤§å¤šæ•°ç‰©ä½“éƒ½æ»¡è¶³ï¼‰ï¼Œé‚£ä¹ˆè¯¥è¡¨é¢çš„å…‰äº®åº¦ä¸ç¯å¢ƒå…‰äº®åº¦çš„æ¯”å€¼ä¹Ÿæ’ç­‰ï¼Œæ•°å€¼ä¸Šç­‰äºè§†é”¥ç»†èƒçš„ä¸‰åˆºæ¿€å€¼ä¸ç™½åœºå“åº”çš„æ¯”å€¼ï¼Œå› æ­¤è¯¥è¡¨é¢åœ¨å„ç§å…‰ç…§ä¸‹æ¿€å‘çš„é¢œè‰²çŸ¥è§‰éƒ½ï¼ˆåŸºæœ¬ï¼‰ç›¸åŒã€‚è¿™å°±æ˜¯é¢œè‰²æ’å¸¸çš„åŸç†ã€‚</li></ul><p>äººç±»è§†è§‰å¯¹é¢œè‰²çš„åˆ†è¾¨èƒ½åŠ›æ˜¯å­˜åœ¨ä¸€å®šçš„ç²¾åº¦é™åˆ¶çš„ï¼Œå½“ä¸¤ä¸ªé¢œè‰²åœ¨è‰²åº¦å›¾ï¼ˆchromaticity diagramï¼‰ä¸Šçš„è·ç¦»å°äºé¢œè‰²å®½å®¹é‡æ—¶ï¼Œäººç±»å°†æ— æ³•åŒºåˆ†è¿™ä¸¤ä¸ªé¢œè‰²çš„å·®å¼‚ã€‚äººç±»å¯¹ä½è‰²æ¸©çš„é¢œè‰²è¡¨ç°å‡ºæ›´å°çš„é¢œè‰²å®½å®¹é‡ï¼Œå¯¹é«˜è‰²æ¸©çš„é¢œè‰²å®½å®¹é‡æ›´å¤§ï¼Œè¿™ä¸ªç°è±¡å¯¹ç™½å¹³è¡¡çš„ç²¾åº¦åšå‡ºäº†ä¸€å®šçš„çº¦æŸã€‚</p><p>åœ¨ç ”ç©¶ç™½å¹³è¡¡é—®é¢˜æ—¶ï¼Œæœ‰æ—¶ä¼šæŠŠé¢œè‰²å˜æ¢åˆ° HCL ç©ºé—´ï¼Œå…¶ä¸­ H ä»£è¡¨è‰²è°ƒ Hueï¼ŒC ä»£è¡¨è‰²æ¸©ï¼ŒL ä»£è¡¨äº®åº¦ Lumaã€‚åœ¨ CIE-1931 xyY è‰²åº¦å›¾ä¸Šï¼Œä¸­é—´å‘ä¸‹å‡¹çš„æ›²çº¿å«æ™®æœ—å…‹æ›²çº¿ï¼Œæè¿°é»‘ä½“ä½œä¸ºå…‰æºåœ¨å„ç§æ¸©åº¦ï¼ˆ0, +âˆï¼‰ä¸‹å‘ˆç°çš„é¢œè‰²ï¼Œè‰²æ¸©è¡¨å¾å…‰æºçš„å†·æš–å€¾å‘ï¼ˆåè“æˆ–åçº¢ï¼‰ã€‚åœ¨ç°å®ç”Ÿæ´»ä¸­å¾ˆå¤šäººé€ å…‰æºçš„å…‰è°±ä¸é»‘ä½“å…‰è°±å·®å¼‚å¾ˆå¤§ï¼Œå…‰æºé¢œè‰²å¸¸è½åœ¨æ™®æœ—å…‹æ›²çº¿ä¹‹å¤–ã€‚è‰²åº¦å›¾ä¸Šä¸æ™®æœ—å…‹æ›²çº¿ç›¸äº¤çš„ç›´çº¿ç§°ä¸ºç›¸å…³è‰²æ¸©çº¿ï¼ˆCCTï¼‰ï¼Œç”¨äºå®šä¹‰éé»‘ä½“å…‰æºçš„ç­‰æ•ˆè‰²æ¸©ï¼ŒåŒæ—¶ä¹Ÿè¡¨å¾å…‰æºçš„è‰²è°ƒå€¾å‘ï¼ˆåç»¿æˆ–åç´«ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb3.png"></p><p>ç™½å¹³è¡¡çš„ä½œç”¨å°±æ˜¯æ¨¡æ‹Ÿäººç±»çš„è‰²å½©æ’å¸¸èƒ½åŠ›ï¼Œåœ¨å›¾åƒä¸­å»é™¤å…‰æºå¼•èµ·çš„åè‰²ã€‚</p><h1 id="cie1931-è‰²åŸŸ">CIE1931 è‰²åŸŸ</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb4.png"></p><p>ä¸Šå›¾æ˜¯ç”± CIE å›½é™…ç…§æ˜å§”å‘˜äº 1931 å¹´å‘å¸ƒçš„ï¼Œå®ƒä»¬æ˜¯åœ¨ 20 ä¸–çºª 20 å¹´ä»£åæœŸç”± William David Wright å’Œ John Guild å°†å®éªŒç»“æœåˆå¹¶åˆ° CIE RGB è‰²å½©ç©ºé—´çš„è§„èŒƒä¸­ï¼Œä»ä¸­å¯¼å‡º CIE XYZ è‰²å½©ç©ºé—´ã€‚è‚‰çœ¼èƒ½å¤Ÿçœ‹åˆ°çš„è‰²å½©ç©ºé—´å°±æ˜¯è¿™äº›äº†ï¼Œä½†æ˜¯æ˜¾ç¤ºå™¨å¹¶æ²¡æœ‰è¿™ä¹ˆå¤§çš„ç©ºé—´ï¼Œå’Œäººçœ¼ç›¸æ¯”ï¼Œæ˜¾ç¤ºå™¨èƒ½å¤Ÿæ˜¾ç¤ºçš„è‰²åŸŸæ›´å°ã€‚</p><h2 id="srgb">sRGB</h2><p>sRGB æ˜¯æœ€æ—©æœŸçš„è‰²åŸŸæ ‡å‡†ä¹‹ä¸€ï¼Œè‡³ä»Šä»æœ‰éå¸¸é‡è¦çš„å½±å“åŠ›ã€‚å®ƒæ˜¯ç”±å½“æ—¶çš„å¾®è½¯ï¼ˆsoftwareï¼‰ä¸æƒ æ™®ï¼ˆHewlett-Packardï¼‰å…±åŒå®šåˆ¶äº 1996 å¹´ï¼Œå¹¶ä¸”å¾—åˆ°äº†æ¥è‡ªä¸šç•Œçš„ W3Cã€Exifã€Intelã€Pantoneã€Corel ä»¥åŠå…¶å®ƒè®¸å¤šä¸šç•Œå‚å•†çš„æ”¯æŒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb5.png"></p><p>ä¸Šå›¾çš„ä¸‰è§’å½¢å°±æ˜¯ sRGB çš„èŒƒå›´ï¼Œç›¸å½“äº CIE 1931 çš„ä¸€ä¸ªå­é›†ï¼Œè¦†ç›–é¢æ¯”è¾ƒå°ï¼Œå° s çš„æ„æ€æ˜¯ standardï¼Œæ ‡å‡†ã€‚ä¸è¿‡ç”±äº sRGB æ ‡å‡†å®šåˆ¶è¾ƒæ—©ï¼Œå¾ˆå¤šæŠ€æœ¯å’Œæ¦‚å¿µéƒ½ä¸æˆç†Ÿï¼Œ</p><p>sRGB è‰²å½©ç©ºé—´å¤§æ¦‚åªæœ‰å½“æ—¶ CIE è‰²åŸŸæ ‡å‡†çš„ 30%ï¼Œè‰²å½©è¿˜åŸåº¦ä¸é«˜ï¼Œè€Œä¸”è§‚å¯Ÿè‰²åŸŸèŒƒå›´ä½ å°±ä¼šå‘ç°ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼ŒsRGB å¯¹äºç»¿è‰²éƒ¨åˆ†è‰²åŸŸè¦†ç›–éå¸¸å°‘ã€‚è¿™ä¸ªå°±å¯¼è‡´ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å¯¹èŠ±è‰æ£®æ—ç­‰åœºæ™¯çš„è‰²å½©è¡¨ç°åŠ›ä¸è¶³ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œå®ƒå¯¹æ˜¾ç¤ºå™¨çš„è¦æ±‚ä¸é«˜ï¼Œæ‰€ä»¥ç°åœ¨å¸‚é¢ä¸Šå¤§å¤šæ•°æ˜¾ç¤ºå™¨éƒ½èƒ½è¾¾åˆ° sRGB100%ã€‚</p><p>å¯¹äºéœ€è¦åœ¨ sRGB æ ‡å‡†æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºçš„å›¾åƒï¼Œç™½å¹³è¡¡ç®—æ³•éœ€è¦å°†æ‹æ‘„åœºæ™¯è‰²æ¸©ä¸‹çš„ç™½è‰²æ˜ å°„ä¸º D65 è‰²æ¸©ä¸‹çš„ç™½è‰²ã€‚è¿™å°±ç›¸å½“äºå®ç°äº†äººç±»è§†è§‰çš„é¢œè‰²æ’å¸¸ç‰¹æ€§ã€‚ç™½å¹³è¡¡çš„ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€æ­¥æ˜¯å¯¹æ‹æ‘„åœºæ™¯è¿›è¡Œå…‰æºé¢œè‰²ä¼°è®¡ï¼ˆlight source color estimationï¼‰ï¼Œä¼°è®¡çš„ç»“æœå¯ä»¥ç”¨äºä¸‹ä¸€æ­¥çš„è‰²é€‚åº”ï¼ˆchromatic adaptationï¼‰ã€‚è‰²é€‚åº”çš„ä½œç”¨æ˜¯å»é™¤å›¾åƒçš„åè‰²ï¼ˆcolor castï¼‰ï¼Œä½¿åŸå§‹åœºæ™¯ä¸­çš„ç™½è‰²ç‰©ä½“åœ¨ D65 è‰²æ¸©ä¸‹ä»ç„¶æ˜¯ç™½è‰²ã€‚</p><h2 id="adobe-rgb">Adobe RGB</h2><p>Adobe RGB å°±æ˜¯ç”±å¤§åé¼é¼çš„ Adobe å…¬å¸æ‰€å‘å¸ƒçš„ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb5.png"></p><p>dobe RGB è‰²åŸŸå¯ä»¥è¯´æ˜¯ sRGB è‰²åŸŸçš„å‡çº§ç‰ˆï¼Œå› ä¸ºå®ƒä¸»è¦è§£å†³äº†å°åˆ·ä¸ç”µè„‘æ˜¾ç¤ºå™¨æ˜¾ç°é¢œè‰²ä¸åŒçš„é—®é¢˜ï¼Œå¹¶ä¸”æé«˜äº†åœ¨é’ç»¿è‰²ç³»ä¸Šçš„æ˜¾ç¤ºï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒå æ® CIE è‰²åŸŸè¾¾ 50%ä¹‹å¤šã€‚ç›®å‰ä¹Ÿåªæœ‰éƒ¨åˆ†é«˜ç«¯æ˜¾ç¤ºå™¨èƒ½å¤Ÿåšåˆ° 99%çš„ Adobe RGB è‰²åŸŸï¼ŒåŸºæœ¬éƒ½æ˜¯ç”¨åœ¨è®¾è®¡æ–¹é¢ã€‚</p><h2 id="dci-p3">DCI-P3</h2><p>DCI-P3 æ˜¯ä¸€æ¬¾æ›´åŠ æ³¨é‡äºè§†è§‰å†²å‡»ï¼Œè€Œä¸æ˜¯è‰²å½©å…¨é¢æ€§çš„è‰²åŸŸã€‚å¹¶ä¸”ç›¸å¯¹å…¶ä»–è‰²å½©æ ‡å‡†ï¼Œå®ƒæ‹¥æœ‰æ›´å¹¿é˜”çš„çº¢è‰²/ç»¿è‰²ç³»è‰²å½©èŒƒå›´ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb6.jpeg"></p><h1 id="ç™½å¹³è¡¡ç®—æ³•">ç™½å¹³è¡¡ç®—æ³•</h1><h2 id="ç°åº¦ä¸–ç•Œæ¨¡å‹gray-world-model-gw">ç°åº¦ä¸–ç•Œæ¨¡å‹ï¼ˆGray World model, GWï¼‰</h2><p>è¯¥æ¨¡å‹åŸºäºç°åº¦ä¸–ç•Œå‡è®¾ï¼Œè¯¥å‡è®¾è®¤ä¸ºï¼šå¯¹äºä¸€å¹…æœ‰ç€å¤§é‡è‰²å½©å˜åŒ–çš„å›¾åƒï¼ŒR,G, B ä¸‰ä¸ªåˆ†é‡çš„ç»Ÿè®¡å¹³å‡å€¼è¶‹äºåŒä¸€ç°åº¦å€¼ã€‚ ä»ç‰©ç†æ„ä¹‰ä¸Šè®²ï¼Œç°åº¦ä¸–ç•Œæ¨¡å‹å‡è®¾è‡ªç„¶ç•Œæ™¯ç‰©å¯¹äºå…‰çº¿çš„åå°„ç³»æ•°çš„å‡å€¼åœ¨æ€»ä½“ä¸Šæ˜¯ä¸ªå®šå€¼ï¼Œè¿™ä¸ªå®šå€¼è¿‘ä¼¼åœ°ä¸ºâ€œç°è‰²â€ã€‚ ä¾æ®ç°åº¦ä¸–ç•Œæ¨¡å‹å®ç°çš„ç™½å¹³è¡¡ç®—æ³•è®¤ä¸ºå›¾åƒä¸­ R,G,B åˆ†é‡çš„å¹³å‡å€¼å¦‚æœåç¦» 1:1:1 åˆ™ä¸€å®šæ˜¯å› ä¸ºç¯å¢ƒå…‰çº¿å˜åŒ–å¼•èµ·çš„ï¼Œç®—æ³•ä¼šæ®æ­¤å¯¹ R,G,B å¢ç›Šè¿›è¡Œåé¦ˆè°ƒèŠ‚ä»¥è¡¥å¿ç¯å¢ƒå…‰çš„å˜åŒ–ï¼Œä½¿ä¸‰ä¸ªåˆ†é‡çš„å¹³å‡å€¼é‡æ–°å›åˆ° 1:1:1ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­è¿™ä¸ªæ¨¡å‹çš„åŸºæœ¬å‡è®¾ç»å¸¸æ˜¯ä¸æˆç«‹çš„ï¼Œæ‰€ä»¥å®ç”¨çš„ç°åº¦ä¸–ç•Œæ¨¡å‹éƒ½ä¼šå¯¹åŸºæœ¬å‡è®¾åšå‡ºå„ç§ä¿®æ­£ä»¥é€‚åº”å‡è®¾å¤±æ•ˆçš„åœºæ™¯ã€‚ä¸€ç§ä¿®æ­£çš„æ–¹æ³•æ˜¯é™å®š RGB åˆ†é‡çš„å–å€¼èŒƒå›´ï¼ŒæŠ›å¼ƒåç¦»ç°è‰²å¤ªè¿œçš„åƒç´ ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œåƒç´ å€¼ï¼ˆR,G,Bï¼‰åªæœ‰æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½å‚ä¸ç™½å¹³è¡¡ä¼°è®¡ï¼š</p><ul><li>|B-G| &lt; a</li><li>|R-G| &lt; b</li><li>|B-G|+|R-G| &lt; c</li></ul><p>å…¶ä¸­ a, b, c ä¸ºå‚æ•°ï¼Œå¯ä»¥æ ¹æ®æ ‡å®šå¾—åˆ°ã€‚ä½¿ç”¨ a,b,c å¯ä»¥å›´æˆä¸‹å›¾æ‰€ç¤ºçš„ç”»çº¿åŒºåŸŸã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb7.png"></p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯æŠ›å¼ƒé™æ€çš„èƒŒæ™¯åƒç´ ï¼Œåªç»Ÿè®¡åŠ¨æ€çš„å‰æ™¯åƒç´ ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥è¿‡æ»¤å¤§èŒƒå›´å•è‰²èƒŒæ™¯å¯¹ç®—æ³•çš„å¹²æ‰°ï¼Œä½†æ˜¯å¯¹äºé¢ç§¯è¾ƒå¤§çš„å•è‰²è¿åŠ¨ç‰©ä½“åˆ™æ— èƒ½ä¸ºåŠ›ã€‚</p><h2 id="ç™½ç‚¹ç»Ÿè®¡æ¨¡å‹">ç™½ç‚¹ç»Ÿè®¡æ¨¡å‹</h2><p>è¯¥æ¨¡å‹å‡è®¾æ­£å¸¸çš„ç”»é¢ä¸­æ€»ä¼šå­˜åœ¨ä¸€äº›ç™½è‰²ï¼ˆç°è‰²ï¼‰åŒºåŸŸï¼Œè¿™äº›åŒºåŸŸåœ¨ä¸åŒå…‰ç…§æ¡ä»¶ä¸‹ä¼šè¡¨ç°å‡ºä¸åŒçš„ (R/G,B/G) æ¯”å€¼ã€‚åœ¨å®éªŒå®¤ç¯å¢ƒä¸‹å¯ä»¥äº‹å…ˆæ ‡å®šå‡ºå‚è€ƒç™½è‰²åœ¨ä¸åŒè‰²æ¸©ä¸‹çš„ (R/G,B/G) æ¯”å€¼ï¼Œå®é™…å·¥ä½œæ—¶ï¼ŒISP ç¡¬ä»¶å¯ä»¥å°†ç¬¦åˆç™½è‰²æ¯”å€¼å…³ç³»çš„åƒç´ åŒºåŸŸç­›é€‰å‡ºæ¥ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ï¼Œå¾—åˆ°æ‰€æœ‰ç™½è‰²çš„å¹³å‡æ¯”å€¼ï¼Œè‡ªåŠ¨ç™½å¹³è¡¡ç®—æ³•æ ¹æ®ç¡¬ä»¶æŠ¥å‘Šçš„å¹³å‡æ¯”å€¼åæ¨å½“å‰ç¯å¢ƒçš„è‰²æ¸©ï¼Œå¹¶æ ¹æ®é¢„æµ‹çš„ç¯å¢ƒè‰²æ¸©é€‰æ‹©åˆé€‚çš„ RGB å¢ç›Šå’Œå…¶å®ƒè‰²å½©æ§åˆ¶å‚æ•°ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç™½ç‚¹ç»Ÿè®¡æ¨¡å‹å¶å°”ä¹Ÿä¼šé‡åˆ°åŸºæœ¬å‡è®¾ä¸æˆç«‹çš„æƒ…å†µï¼Œä¸»è¦å­˜åœ¨äºç”»é¢äº®åº¦å¾ˆä½ï¼Œæˆ–è€…ä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„åœºæ™¯ã€‚ åœ¨ç™½ç‚¹ç»Ÿè®¡æ¨¡å‹ä¸­ï¼Œå¦‚ä½•å®šä¹‰ç™½è‰²åŒºåŸŸæ˜¯ä¸€ä¸ªä¸»è¦è¯¾é¢˜ï¼Œå›´ç»•è¿™ä¸ªè¯¾é¢˜è¡ç”Ÿäº†å¤šç§æ–¹æ³•ã€‚ä¸€ç§ç®€å•çš„åˆ¤æ®æ˜¯åœ¨ YUV ç©ºé—´ä¸ºé¢œè‰²è®¾ç½®ç»éªŒé˜ˆå€¼ï¼Œé€šè¿‡é˜ˆå€¼è¿‡æ»¤æ‰åç¦»ç°è‰²è¾ƒè¿œçš„åƒç´ ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb8.png"></p><p>æœ‰äººæå‡ºäº†ä¸€ç»„æ¨¡ç³Šè§„åˆ™ï¼ˆFuzzy Rules Modelï¼ŒFRMï¼‰ç”¨äºæ›´å¥½åœ°ç­›é€‰ç™½ç‚¹ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯ï¼Œ</p><ul><li>å¦‚æœåƒç´ çš„äº®åº¦ Y è¿‡å¤§æˆ–è¿‡å°ï¼Œåˆ™è¯¥åƒç´ æºå¸¦çš„è‰²åº¦ä¿¡æ¯è¾ƒå°‘ï¼Œåº”èµ‹äºˆè¾ƒå°çš„æƒé‡ã€‚</li><li>åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œäº®åº¦é«˜çš„åƒç´ æƒé‡åº”å¤§äºäº®åº¦ä½çš„åƒç´ ï¼Œå› ä¸ºäº®åº¦ä½çš„åƒç´ å—å™ªå£°å½±å“æ›´å¤§ã€‚</li><li>ç™½å¹³è¡¡ç»Ÿè®¡æ—¶é€šå¸¸ä¼šæŠŠå›¾åƒåˆ’åˆ†ä¸º MxN ä¸ªåˆ†åŒºï¼ˆzoneï¼‰ï¼Œå¦‚æœå¤šä¸ªç›¸é‚»åˆ†åŒºçš„é¢œè‰²å‡ ä¹ç›¸åŒï¼Œåº”èµ‹äºˆè¾ƒå°çš„æƒé‡ï¼Œé˜²æ­¢å•ä¸€ç‰©ä½“æƒé‡è¿‡å¤§å¼•å‘è¶…è°ƒã€‚</li><li>æœæŸé¢œè‰²çš„ Cb,Cr åˆ†é‡åŒæ—¶è½åœ¨-1.5~-0.5 åŒºé—´å†…ï¼Œåˆ™è¾ƒå¯èƒ½æ˜¯ç™½è‰²ï¼Œåº”èµ‹äºˆè¾ƒå¤§æƒé‡ã€‚</li></ul><p>å…¶å®ƒä¸€äº›ç®—æ³•åŸºäºä¸åŒçš„åŸç†å®ç°ç™½å¹³è¡¡ï¼Œå¦‚</p><ul><li>WP ç®—æ³•ï¼Œå‡è®¾åœºæ™¯ä¸­å­˜åœ¨ä¸€å—ç™½è‰²å—ï¼ˆWhite Patchï¼‰ï¼Œå®ƒå¯¹å„ä¸ªæ³¢æ®µçš„å…‰çº¿éƒ½è¿‘ä¹å®Œå…¨åå°„ï¼Œå› æ­¤æ˜¯å›¾åƒä¸­æœ€äº®çš„ç‚¹ï¼Œå…¶é¢œè‰²èƒ½å¤Ÿåæ˜ å…‰æºçš„å…‰è°±ç‰¹æ€§ï¼Œå‡­å€Ÿè¿™ä¸€ä¿¡æ¯å¯ä»¥åœ¨å›¾åƒä¸­å»é™¤å…‰æºçš„é¢œè‰²ã€‚</li><li>PRM ç®—æ³•ï¼Œä¸ WP ç®—æ³•åŸç†ç±»ä¼¼ï¼Œå‡è®¾å›¾åƒä¸­æœ€äº®çš„åƒç´ æºå¸¦äº†è¾ƒå¤šå…‰æºæœ¬èº«çš„ä¿¡æ¯ï¼Œæ˜¯ä¸»è¦çš„ç™½è‰²å‚è€ƒï¼Œç§°ä¸ºå®Œç¾åå°„æ¨¡å‹ï¼ˆPerfect Reflector Modelï¼‰ã€‚</li><li><p>SoG ç®—æ³•ï¼Œåˆ©ç”¨ç°é˜¶çš„ç‰¹æ€§ï¼ˆShades of Grayï¼‰ã€‚ Finlayson ç­‰äººå‘ç°ï¼Œç°åº¦ä¸–ç•Œæ¨¡å‹çš„æ•°å­¦æœ¬è´¨æ˜¯å–æ‰€æœ‰åƒç´ çš„ 1-èŒƒæ•°ï¼Œè€Œ WP æ¨¡å‹æœ¬è´¨æ˜¯å–æ‰€æœ‰åƒç´ çš„âˆ-èŒƒæ•°ã€‚å¦‚æœæ¨å¹¿èµ·æ¥å…¶å®å¯ä»¥ä¸€èˆ¬åœ°è€ƒå¯Ÿåƒç´ çš„ p-èŒƒæ•°ï¼Œä»è€Œæ‰¾åˆ°æœ€åˆé€‚çš„æ¨¡å‹ï¼Œè¿™å°±æ˜¯ SoG ç®—æ³•çš„åŸºæœ¬æ€æƒ³ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/awb9.png"></p></li><li>BP ç®—æ³•ï¼Œåˆ©ç”¨äº®åƒç´ çš„ç‰¹æ€§ï¼ˆBright Pixelsï¼‰ã€‚</li><li><p>GE ç®—æ³•ï¼Œæ”¹è¿›çš„ç°åº¦ä¸–ç•Œæ¨¡å‹ã€‚</p></li></ul><h1 id="ç™½å¹³è¡¡çš„è¯„ä»·æ ‡å‡†">ç™½å¹³è¡¡çš„è¯„ä»·æ ‡å‡†</h1><p>è‡ªåŠ¨ç™½å¹³è¡¡è°ƒæ•´çš„å…³é”®ç¯èŠ‚ï¼Œé¦–å…ˆæ˜¯è¦åŠæ—¶æ£€æµ‹å‡ºç¯å¢ƒå…‰è‰²æ¸©çš„å˜åŒ–ï¼Œå…¶æ¬¡æ˜¯è¦å¯¹ç¯å¢ƒè‰²æ¸©å˜åŒ–åŠæ—¶åšå‡ºå“åº”ã€‚é’ˆå¯¹è¿™ä¸€è¿‡ç¨‹å¯ä»¥æœ‰ä¸åŒçš„å®ç°æ–¹æ³•ï¼Œè€Œè¯„ä»·ä¸€ä¸ªç™½å¹³è¡¡ç®—æ³•çš„æ€§èƒ½é€šå¸¸æœ‰ä»¥ä¸‹å‡ ä¸ªç»´åº¦</p><ul><li>å‡†ç¡®æ€§ï¼Œè¡¡é‡æŒ‡æ ‡ä¸ºç™½å¹³è¡¡ç¨³å®šå 18 åº¦ç°å¡å®é™…é¢œè‰²ä¸ç†æƒ³é¢œè‰²ä¹‹é—´çš„è‰²å·®âˆ†Cï¼Œä¸€èˆ¬åº”åœ¨ 10 ä»¥å†…ã€‚</li><li>æ”¶æ•›é€Ÿåº¦ï¼Œä»åœºæ™¯åˆ‡æ¢åˆ°ç™½å¹³è¡¡ç¨³å®šæ‰€éœ€çš„æ—¶é—´ï¼Œä»¥å›¾åƒå¸§æ•°æ¥è¡¡é‡ï¼Œä¸€èˆ¬åº”è¯¥ 30 å¸§ä»¥å†…ã€‚</li><li>ç¨³å®šæ€§ï¼Œåœ¨è§†é¢‘åºåˆ—ä¸­ï¼Œç™½å¹³è¡¡åº”ä¿æŒç¨³å®šæˆ–å¹³æ»‘è¿‡æ¸¡ï¼Œä¸åº”å‡ºç°è·³å˜ã€æŒ¯è¡ç­‰å¼‚å¸¸ç°è±¡ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgzNTMwMA==">https://zhuanlan.zhihu.com/p/98835300<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNDgxNjIwNzA=">https://zhuanlan.zhihu.com/p/348162070<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> 3A </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP ä¹‹ AE</title>
      <link href="/2023/Camera/CameraISPAE/"/>
      <url>/2023/Camera/CameraISPAE/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªåŠ¨æ›å…‰auto-exposure">è‡ªåŠ¨æ›å…‰ï¼ˆAuto Exposureï¼‰</h1><h2 id="è‡ªåŠ¨æ›å…‰æµç¨‹">è‡ªåŠ¨æ›å…‰æµç¨‹</h2><ul><li>æ ¹æ® ISP ç¡¬ä»¶ç”Ÿæˆçš„å›¾åƒæ›å…‰ç»Ÿè®¡æ•°æ®è¯„ä¼°å½“å‰å›¾åƒçš„æ›å…‰è´¨é‡ã€‚ å‰ä¸»æµçš„ ISP ç¡¬ä»¶éƒ½ä¼šæä¾›å…³äºå›¾åƒçš„ç›´æ–¹å›¾ç»Ÿè®¡æ•°æ®ï¼ŒAE ç®—æ³•å¯ä»¥åˆ©ç”¨ç›´æ–¹å›¾çš„å‡å€¼æ¥åˆ¤æ–­å›¾åƒæ˜¯å¦æ›å…‰é€‚å½“ã€‚</li><li>å¦‚æœæ›å…‰è´¨é‡éœ€è¦è°ƒæ•´ï¼Œåˆ™æ ¹æ®å½“å‰çš„å·¥ä½œå‚æ•°å’Œç†æƒ³æ›å…‰ç›®æ ‡ç”Ÿæˆä¸‹ä¸€å¸§å›¾åƒçš„å·¥ä½œå‚æ•°ã€‚ ä¸»è¦è°ƒæ§å¯¹è±¡æ˜¯å…‰åœˆã€sensor ç§¯åˆ†æ—¶é—´ã€sensor å¢ç›Šï¼ˆåŒ…å«æ¨¡æ‹Ÿå¢ç›Šå’Œæ•°å­—å¢ç›Šï¼‰ã€ISP æ•°å­—å¢ç›Šè¿™å››ä¸ªå‚æ•°ã€‚</li><li>å°†æ–°çš„å·¥ä½œå‚æ•°å†™å…¥å„ç¡¬ä»¶è®¾å¤‡ï¼Œé©±åŠ¨å…‰åœˆã€sensor å¿«é—¨åŠå¢ç›Šåˆ°è¾¾æ–°çš„ä½ç½®ã€‚</li></ul><span id="more"></span><h2 id="æ›å…‰å€¼-ev">æ›å…‰å€¼ EV</h2><p>ç°åœ¨è¾ƒä¸ºæµè¡Œçš„æ˜¯ 1960 å¹´ä»£æå‡ºçš„ APEX æ›å…‰ç³»ç»Ÿã€‚APEX å…¨ç§°æ˜¯ The Additive System of Photographic Exposureï¼Œè¯¥ç³»ç»Ÿå®šä¹‰äº†ä¸€ä¸ªç»éªŒå…¬å¼ï¼ŒåŸºæœ¬å½¢å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\frac{t}{N^2} = \frac{K}{L_sS}\]</span></p><p>å…¶ä¸­ï¼št æ˜¯æ›å…‰æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼›N æ˜¯å…‰åœˆçš„ f-stop å€¼ï¼›Ls æ˜¯åœºæ™¯ç…§åº¦ï¼Œå¯ä»¥æ˜¯ä»»ä¸€é€‚å½“çš„å•ä½ï¼Œå¦‚ luxï¼›S æ˜¯ç›¸æœºæ•æ„Ÿåº¦ï¼Œå¯ä»¥ä½¿ç”¨ ISOï¼›K æ˜¯ç›¸æœºå‚å®¶æä¾›çš„ä¸å…·ä½“ç›¸æœºé…ç½®ç›¸å…³çš„ä¸€ä¸ªå¸¸æ•°ï¼Œä½¿ç”¨è¯¥å¸¸æ•°èƒ½å¤Ÿè·å¾—å‚å®¶è®¤ä¸ºæœ€ä½³çš„æ›å…‰æ•ˆæœã€‚</p><p>APEX æ›å…‰æ–¹ç¨‹æ€»ç»“äº†æ›å…‰æ—¶é—´ã€å…‰åœˆã€ç›¸æœºæ„Ÿåº¦ã€åœºæ™¯äº®åº¦ä¹‹é—´çš„å…³ç³»ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å®šä¹‰ä¸€ä¸ªæ›å…‰å€¼ ï¼ˆexposure valueï¼‰å‚æ•°ï¼Œä»£è¡¨èƒ½å¤Ÿç»™å‡ºåŒæ ·æ›å…‰çš„æ‰€æœ‰ç›¸æœºå…‰åœˆå¿«é—¨ç»„åˆã€‚å®ƒçš„å®šä¹‰æ˜¯ï¼š</p><p><span class="math display">\[EV = log_2 \frac{N^2}{t}\]</span></p><p>EV0 å¯¹åº”äº ISO100ï¼Œæ›å…‰æ—¶é—´ä¸º 1 ç§’ï¼Œå…‰åœˆä¸º f/1.0ï¼Œä»¥åŠä¸ä¹‹ç­‰æ•ˆçš„æ‰€æœ‰æ›å…‰ç»„åˆï¼Œè¿™äº›ç»„åˆå¯ä»¥ä½¿ 18%çš„ä¸­æ€§ç°å¡åœ¨æ‰€å¤„å…‰ç…§æ¡ä»¶ä¸‹è·å¾—åˆé€‚çš„æ›å…‰ã€‚å› æ­¤æ›å…‰å€¼ä¸»è¦ä½“ç°äº†æ‹æ‘„åœºæ™¯çš„äº®åº¦ï¼ŒåŒæ—¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿèƒ½åæ˜ ç›¸æœºçš„çµæ•åº¦ã€‚</p><p>æ›å…‰å€¼æ¯å¢åŠ  1 ç§°ä¸ºå¢åŠ ä¸€æŒ¡æ›å…‰ï¼Œä¹Ÿå°±æ˜¯å°†æ›å…‰é‡å‡åŠï¼Œæ¯”å¦‚å°†æ›å…‰æ—¶é—´æˆ–å…‰åœˆé¢ç§¯å‡åŠï¼Œå› æ­¤å¯ä»¥ä» EV0 å‡ºå‘ï¼ŒæŒ‰ç…§å…‰åœˆã€å¿«é—¨åŠ å€æˆ–å‡åŠçš„æ–¹å¼æ¨å¯¼å‡ºå…¶ä½™çš„æ›å…‰æ¡£ä½ï¼Œä¸€èˆ¬å¸¸ç”¨çš„æ¡£ä½åœ¨-6~20 ä¹‹é—´ã€‚</p><h2 id="æ›å…‰ä¸‰è§’å½¢-exposure-triangle">æ›å…‰ä¸‰è§’å½¢ Exposure Triangle</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ae1.png"></p><h1 id="ae-ç®—æ³•çš„ç­–ç•¥">AE ç®—æ³•çš„ç­–ç•¥</h1><p>AE ç®—æ³•çš„ç­–ç•¥ä¸»è¦åˆ†å…‰åœˆä¼˜å…ˆã€å¿«é—¨ä¼˜å…ˆã€å¢ç›Šä¼˜å…ˆã€‚</p><ul><li>å…‰åœˆä¼˜å…ˆç®—æ³•ä¼šä¼˜å…ˆè°ƒæ•´å…‰åœˆåˆ°åˆé€‚çš„ä½ç½®ã€‚å½“å…‰åœˆè°ƒæ•´åˆ°æé™åå†å¼€å§‹åˆ†é…æ›å…‰æ—¶é—´å’Œå¢ç›Šã€‚</li><li>å½“ camera å…‰åœˆä¸å¯è°ƒæ—¶ï¼ŒAE ç®—æ³•é€šå¸¸ä¼šä¼˜å…ˆåˆ†é…æ›å…‰æ—¶é—´ï¼Œå†åˆ†é… sensor å¢ç›Šå’Œ ISP å¢ç›Šã€‚</li><li>å¢ç›Šä¼˜å…ˆåˆ™æ˜¯ä¼˜å…ˆåˆ†é… sensor å¢ç›Šå’Œ ISP å¢ç›Šï¼Œå†åˆ†é…æ›å…‰æ—¶é—´ï¼Œé€‚åˆæ‹æ‘„è¿åŠ¨ç‰©ä½“çš„åœºæ™¯ã€‚</li></ul><p>å¢åŠ å…‰åœˆå¯ä»¥å¢å¤§ sensor æ”¶é›†å…‰ä¿¡å·çš„é¢ç§¯ï¼Œå¢åŠ æ›å…‰æ—¶é—´å¯ä»¥å»¶é•¿ sensor ç§¯ç´¯å…‰ä¿¡å·çš„æ—¶é—´ï¼Œè¿™ä¸¤ç§é€”å¾„éƒ½æœ‰åŠ©äºç§¯ç´¯ä¿¡å·ï¼Œæé«˜ä¿¡å™ªæ¯”ï¼Œæ‰€ä»¥ä¼šæé«˜å›¾åƒè´¨é‡ã€‚</p><p>sensor å¢ç›Šå®é™…ä¸Šå­˜åœ¨ä¸¤ç§å½¢å¼ï¼Œå³æ¨¡æ‹Ÿå¢ç›Šå’Œæ•°å­—å¢ç›Šã€‚æ¨¡æ‹Ÿå¢ç›Šåœ¨æ”¾å¤§ä¿¡å·çš„åŒæ—¶ä¼šç­‰æ¯”ä¾‹åœ°æ”¾å¤§å™ªå£°ï¼Œæ‰€ä»¥å¯¹æé«˜ä¿¡å™ªæ¯”æ²¡æœ‰å¥½å¤„ï¼Œä½†ä¹Ÿæ²¡æœ‰åå¤„ï¼Œå¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨ã€‚è€Œæ•°å­—å¢ç›Šç”±äºç²¾åº¦çš„é™åˆ¶ä¼šå¼•å…¥é‡åŒ–å™ªå£°ï¼Œä¸ä»…å¯¹æé«˜ä¿¡å™ªæ¯”æ²¡æœ‰å¥½å¤„ï¼Œåè€Œä¼šæœ‰æ¶åŒ–ä¿¡å™ªæ¯”ï¼Œé™ä½å›¾åƒè´¨é‡ï¼Œå› æ­¤éœ€è¦æ…ç”¨ã€‚</p><p>ISP å¢ç›Šæ˜¯çº¯æ•°å­—å¢ç›Šï¼Œå’Œ sensor æ•°å­—å¢ç›Šæ˜¯åŒæ ·çš„é“ç†ï¼Œæ‰€ä»¥é€šå¸¸å¾ˆå°‘ç”¨ã€‚</p><h1 id="æ›å…‰ç»Ÿè®¡">æ›å…‰ç»Ÿè®¡</h1><h2 id="æ›å…‰ç»Ÿè®¡åˆ†å·¥">æ›å…‰ç»Ÿè®¡åˆ†å·¥</h2><p>æ›å…‰ç»Ÿè®¡éœ€è¦å¯¹å›¾åƒä¸­çš„æ¯ä¸€ä¸ªåƒç´ è¿›è¡Œåˆ†ç±»å’Œè®¡ç®—ï¼Œæ¶‰åŠçš„è®¡ç®—é‡éå¸¸å¤§ï¼Œå¯¹æ—¶åºè¦æ±‚éå¸¸ä¸¥æ ¼ï¼Œæ‰€ä»¥è¿™ä¸ªå·¥ä½œåªèƒ½äº¤ç»™ç¡¬ä»¶æµæ°´çº¿å»åšï¼Œä¸é€‚åˆ CPU å¤„ç†ã€‚</p><p>AE ç®—æ³•ä¸­æ ¹æ®ç»Ÿè®¡æ•°æ®è¯„ä¼°å›¾åƒè´¨é‡ã€äº§ç”Ÿæ–°çš„æ§åˆ¶å‚æ•°çš„éƒ¨åˆ†åˆ™æœ‰é€»è¾‘æ¯”è¾ƒå¤æ‚ã€ç®—æ³•ç»å¸¸éœ€è¦å‡çº§ã€æ•°æ®ååé‡ä¸€èˆ¬ä¸å¤§ç­‰ç‰¹ç‚¹ï¼Œå› æ­¤éå¸¸é€‚åˆç”¨ CPU å¤„ç†ã€‚</p><h2 id="ae-ç»Ÿè®¡ç­–ç•¥">AE ç»Ÿè®¡ç­–ç•¥</h2><ul><li><strong>å…¨å±€ç»Ÿè®¡</strong> æ˜¯æŒ‡å°†å›¾åƒå…¨éƒ¨åƒç´ éƒ½ç»Ÿè®¡è¿›æ¥ï¼Œåƒç´ çš„æƒé‡å®Œå…¨ä¸€æ ·ã€‚</li><li><strong>ä¸­å¤®æƒé‡ç»Ÿè®¡</strong> æ˜¯æŒ‡åªç»Ÿè®¡å›¾åƒä¸­é—´éƒ¨åˆ†ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºäººä»¬å…³æ³¨çš„é‡ç‚¹é€šå¸¸éƒ½ä½äºå›¾åƒçš„ä¸­é—´éƒ¨åˆ†ï¼›é•œå¤´çš„æˆåƒæ•ˆæœä¹Ÿæ˜¯ä¸­å¤®éƒ¨åˆ†æ¸…æ™°åº¦æœ€é«˜ï¼Œè¶Šåˆ°è¾¹ç¼˜æ¸…æ™°åº¦è¶Šä½ã€‚</li><li><strong>ä¸­å¤®åŠ èƒŒæ™¯</strong> å›¾åƒä¸­é—´éƒ¨åˆ†å  50%æƒé‡ï¼Œå›¾åƒæ•´ä½“ä½œä¸ºèƒŒæ™¯å  50%æƒé‡ã€‚</li><li><strong>åŠ æƒå¹³å‡ç»Ÿè®¡</strong> æ˜¯æŒ‡å°†å›¾åƒåˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†ï¼Œå¦‚ 9 å®«æ ¼æˆ–è€… 13~15 ä¸ªåˆ†æ•£çš„æ›å…‰æ ¼ï¼Œæ¯ä¸€éƒ¨åˆ†èµ‹äºˆä¸åŒçš„æƒé‡ï¼Œé€šå¸¸ä¸­é—´éƒ¨åˆ†èµ‹äºˆè¾ƒå¤§æƒé‡ï¼Œç›¸åº”çš„è¾¹ç¼˜éƒ¨åˆ†åˆ™èµ‹äºˆè¾ƒå°çš„æƒé‡ã€‚</li><li><strong>ç”¨æˆ· ROI</strong> ç”¨æˆ·é€šè¿‡äººæœºç•Œé¢åˆ’å®šä¸€ä¸ªçª—å£ï¼ŒAE åªç»Ÿè®¡è¿™ä¸ªå›ºå®šçª—å£å†…çš„åƒç´ å€¼ã€‚</li></ul><h1 id="å…¸å‹-ae-ç®—æ³•">å…¸å‹ AE ç®—æ³•</h1><h2 id="åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</h2><p>å…¸å‹çš„ AE ç®—æ³•æ˜¯ä¸€ç§åŸºäºè´Ÿåé¦ˆåŸç†çš„ PID ç®—æ³•ã€‚ç®—æ³•çš„æ§åˆ¶å‚æ•°åˆ†æ®µå¯è°ƒï¼Œåœ¨ä¸åŒçš„åŒºé—´å†…ç®—æ³•çš„æ”¶æ•›é€Ÿåº¦ä¸åŒï¼Œä»¥æœŸåœ¨è¿‡æ¸¡å¹³æ»‘æ€§å’Œå¿«é€Ÿå“åº”ä¹‹é—´å–å¾—è¾ƒå¥½çš„å¹³è¡¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ae2.png"></p><ul><li>åœ¨å½“å‰æ›å…‰é‡ä¸ç›®æ ‡é‡å·®åˆ«åœ¨ range0 ä»¥å†…çš„æ—¶å€™ï¼Œè¯´æ˜å½“å‰æ›å…‰å·²ç»æ»¡è¶³è¦æ±‚ï¼Œä¸éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</li><li>å½“å·®åˆ«åœ¨ range1 çš„èŒƒå›´å†…æ—¶ï¼Œåˆ™è¯´æ˜å½“å‰æ›å…‰ä¸è¦æ±‚çš„å…‰ç…§æœ‰å·®åˆ«ï¼Œä½†å·®åˆ«ä¸å¤§ï¼Œåªéœ€è¦ç”¨è¾ƒå°çš„æ­¥é•¿æ¥è¿›è¡Œè°ƒèŠ‚å³å¯ã€‚</li><li>å½“å·®åˆ«åœ¨ range2 çš„æ—¶å€™ï¼Œåˆ™è¡¨æ˜å·®åˆ«è¾ƒå¤§ï¼Œéœ€è¦ç”¨è¾ƒå¤§æ­¥é•¿æ¥è¿›è¡Œè°ƒèŠ‚ã€‚</li></ul><h2 id="æ§åˆ¶å‚æ•°">æ§åˆ¶å‚æ•°</h2><ul><li><strong>å½“å‰å¸§çš„æ›å…‰é‡</strong> ç”± sensor æ›å…‰æ—¶é—´ã€sensor å¢ç›Šã€ISP å¢ç›Šç»„æˆ</li><li><strong>å¢ç›Šç³»æ•°</strong> g=target/measured, å…¶ä¸­ target ä¸ºç†æƒ³ç”»é¢äº®åº¦ï¼Œmeasured ä¸ºå½“å‰ç”»é¢äº®åº¦çš„å®æµ‹å€¼</li></ul><p>å› æ­¤ AE ç®—æ³•çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯è®¡ç®—æ­£ç¡®çš„ g å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°èƒ½å¤Ÿä½¿ç”»é¢å¾—åˆ°æ­£ç¡®çš„æ›å…‰ã€‚</p><h2 id="é˜»å°¼-damping">é˜»å°¼ (damping)</h2><p>å½“è®¡ç®—å‡ºæ­£ç¡®çš„ g å‚æ•°åï¼Œä¸€èˆ¬å¹¶ä¸ä¼šè®©å…¶ç«‹åˆ»åœ¨ä¸‹ä¸€å¸§å›¾åƒå°±ç”Ÿæ•ˆã€‚è¿™æ˜¯å› ä¸ºå¦‚æœå¢ç›Šå˜åŒ–è¾ƒå¤§ï¼Œå›¾åƒå°±ä¼šäº§ç”Ÿé—ªçƒï¼Œä¸»è§‚æ„Ÿå—ä¸å¥½ã€‚é€šå¸¸äººä»¬æ›´å–œæ¬¢ç”»é¢å¹³æ»‘è¿‡æ¸¡ï¼Œå› æ­¤æ¯å¸§å›¾åƒçš„å¢ç›Šå˜åŒ–ä¸å®œè¿‡å¤§ã€‚å®ç°å¹³æ»‘çš„æ–¹æ³•å°±æ˜¯ç»™æ–°çš„å‚æ•°äººä¸ºæ–½åŠ ä¸€ä¸ªé˜»å°¼ï¼Œä½¿å…¶ç¼“æ…¢åœ°å‘æ–°å‚æ•°è¿‡æ¸¡ã€‚ç”¨æ•°å­¦å…¬å¼æè¿°å°±æ˜¯ï¼š</p><p><span class="math display">\[g(n)= (1-s) * g(n-1) +s * g_{target}\]</span></p><h2 id="å‚æ•°åˆ†è§£">å‚æ•°åˆ†è§£</h2><p>å½“æ ¹æ®è·¯å¾„è§„åˆ’ç­–ç•¥è®¡ç®—å‡ºä¸‹ä¸€å¸§çš„ g å‚æ•°åï¼Œéœ€è¦éµå¾ªä¸€å®šçš„ç­–ç•¥å’Œçº¦æŸæŠŠ g å‚æ•°è¿›ä¸€æ­¥æ˜ å°„ä¸º sensor æ›å…‰æ—¶é—´ã€sensor å¢ç›Šã€ISP å¢ç›Šç­‰è®¾å¤‡æ§åˆ¶å‚æ•°ã€‚åˆ†è§£å‡ºæ¥çš„æ§åˆ¶å‚æ•°å¿…é¡»åŒæ­¥ç”Ÿæ•ˆæ‰èƒ½ä½¿ç”»é¢è·å¾—é¢„æœŸçš„æ›å…‰ã€‚å¦‚æœæŸä¸€é¡¹å‚æ•°æœªèƒ½ä¸å…¶ä»–å‡ é¡¹åŒæ­¥ç”Ÿæ•ˆï¼Œåˆ™ç”»é¢ä¼šå› ä¸ºçŸ­æš‚è¿‡äº®ã€è¿‡æš—ç­‰åŸå› å‡ºç°é—ªçƒï¼Œè¿™æ˜¯éœ€è¦é¿å…çš„ã€‚</p><p>æ‰€æœ‰å‚æ•°éƒ½éœ€è¦åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´çª—å£å†…ç”Ÿæ•ˆï¼Œå³å‰ä¸€å¸§å›¾åƒå·²ç»ç»“æŸï¼Œæ–°ä¸€å¸§å›¾åƒå°šæœªå¼€å§‹çš„è¿™æ®µæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ sensor çš„å‚ç›´æ¶ˆéšï¼ˆvertical blankingï¼‰çª—å£ï¼Œè¿™ä¸ªçª—å£æ—¶é—´å¾ˆçŸ­ï¼Œå…¸å‹å€¼åœ¨ 3~5 æ¯«ç§’å·¦å³ï¼Œæ›´çŸ­çš„å¯ä»¥åˆ° 1msï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ae3.png"></p><p>ç°åœ¨çš„ sensor ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œç¼“è§£é…ç½®å‚æ•°æ—¶é—´çª—å£è¿‡çŸ­çš„å‹åŠ›ï¼Œå¾€å¾€éƒ½æ”¯æŒä¸€ç»„å½±å­ï¼ˆshadowï¼‰å¯„å­˜å™¨ï¼Œéœ€è¦åŒæ­¥ç”Ÿæ•ˆçš„å‚æ•°ï¼ˆæ›å…‰æ—¶é—´å’Œå¢ç›Šï¼‰å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹å†™å…¥ shadow å¯„å­˜å™¨ï¼Œå½“ sensor å¼€å§‹æ•æ‰æ–°çš„ä¸€å¸§å›¾åƒä¹‹å‰ï¼Œä¼šè‡ªåŠ¨æŠŠ shadow å¯„å­˜å™¨çš„å†…å®¹åŒæ­¥åˆ°å®é™…ç”Ÿæ•ˆçš„å¯„å­˜å™¨ï¼Œè¿™æ ·å°±æŠŠå‡ ä¸ªæ¯«ç§’çš„æ—¶é—´çª—å£æ‰©å±•æˆä¸€å¸§æ—¶é—´ï¼Œæå¤§åœ°ç¼“è§£äº†ç”¨æˆ·å‹åŠ›ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/ae4.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ¡ˆä¸ºè½¯ä»¶äº‰å–åˆ°äº†ä¸€å¸§çš„ç¼“å†²æ—¶é—´ï¼Œä½†åŒæ—¶ä¹Ÿæ„å‘³ç€ç³»ç»Ÿçš„å“åº”å»¶è¿Ÿï¼ˆlatencyï¼‰å¢åŠ äº†ä¸€å¸§ã€‚</p><h1 id="ae-çš„å‘¼å¸æ•ˆåº”">AE çš„å‘¼å¸æ•ˆåº”</h1><ul><li><strong>å›¾åƒè´¨é‡å‘¼å¸</strong> å¦‚æœé€šè¿‡è°ƒæ•´å¢ç›Šé‚£ä¹ˆä¼šå¯¹å›¾åƒè´¨é‡äº§ç”Ÿå½±å“ã€‚</li><li><strong>äº®åº¦å‘¼å¸</strong> å‚æ•°è®¾è®¡ä¸åˆç†å¯èƒ½å‡ºç°äº®åº¦éœ‡è¡ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDAzNjk1Mjc=">https://zhuanlan.zhihu.com/p/100369527<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> 3A </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP ä¹‹ AF</title>
      <link href="/2023/Camera/CameraISPAF/"/>
      <url>/2023/Camera/CameraISPAF/</url>
      
        <content type="html"><![CDATA[<h1 id="å¯¹ç„¦å’Œå˜ç„¦">å¯¹ç„¦å’Œå˜ç„¦</h1><h2 id="å¯¹ç„¦">å¯¹ç„¦</h2><p>å¯¹ç„¦ï¼ˆèšç„¦ï¼‰å°±æ˜¯æŠŠæˆçš„åƒå‡†ç¡®çš„è½åœ¨ sensorï¼ˆcamera ä¼ æ„Ÿå™¨ï¼‰ä¸Šï¼Œå¯¹ç„¦æœ‰ä¸¤ç§ï¼šè‡ªåŠ¨å¯¹ç„¦ï¼Œæ‰‹åŠ¨å¯¹ç„¦ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lens1.png"></p><p>è™šçº¿æ˜¯ sensor çš„ä½ç½®ï¼Œå½“è™šçº¿è½åœ¨åƒçš„ä½ç½®ä¸Šå°±æ˜¯å¯¹ç„¦å®Œæˆã€‚</p><span id="more"></span><h2 id="å˜ç„¦">å˜ç„¦</h2><ul><li>å…‰å­¦å˜ç„¦ï¼šå°±æ˜¯æ”¹å˜é€é•œçš„ç„¦è·ã€‚ç”±äºæ”¹å˜äº†ç„¦è·ï¼Œè§†åœºè§’ä¹Ÿå°±å˜äº†ï¼Œå°±å¯ä»¥å®ç°æ‹‰è¿‘æ‹‰è¿œçš„åŠŸèƒ½ã€‚</li><li>æ•°ç å˜ç„¦ï¼šæ•°ç å˜ç„¦è¿‡çš„çš„å›¾åƒä¼šå‡ºç°å¤±çœŸï¼Œå› ä¸ºæ”¾å¤§çš„è¿‡ç¨‹ä¼šå¯¹å›¾åƒè¿›ç¨‹æ’å€¼ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lens2.png"></p><h1 id="åå·®å¯¹ç„¦-cdafcontrast-detection-auto-focus">åå·®å¯¹ç„¦ CDAF(Contrast Detection Auto Focus)</h1><p>å…‰è·¯ç»“æ„æ¯” PDAF ç®€å•å¾ˆå¤šã€‚å®ƒä¸éœ€è¦é¢å¤–çš„å…‰å­¦æ£±é•œï¼Œä¸éœ€è¦å¾®é€é•œï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„ç”µè·¯æ„é€ ã€‚å®ƒç”¨è½¯ä»¶ç®—æ³•ç›´æ¥åˆ†æ sensor æ•æ‰çš„ä¸»å›¾åƒå°±å¯ä»¥åˆ¤æ–­å›¾åƒæ˜¯å¦èšç„¦è‰¯å¥½ã€‚</p><h2 id="åŸç†">åŸç†</h2><p>CDAF å¯¹ä¸€ä¸ªå›¾åƒåºåˆ—è¿›è¡Œåˆ†æï¼Œæ‰¾åˆ°å¯¹æ¯”åº¦æœ€å¤§çš„ä¸€å¸§å›¾ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿå«åšæœ€å¤§å€¼æ³•ï¼ˆmaximum-seeking methodï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus1.png"></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus2.png"></p><p>æœ€å¤§å€¼æ³•çš„ä¼˜ç¼ºç‚¹éƒ½å¾ˆæ˜æ˜¾ã€‚å…¶ä¼˜ç‚¹æ˜¯ä»…éœ€è¦è€ƒè™‘èšç„¦ç‚¹é™„è¿‘ä¸€ä¸ªå°åŒºåŸŸçš„åƒç´ ï¼Œå› æ­¤è®¡ç®—å‹åŠ›æ¯”è¾ƒå°ï¼Œå¯¹äºæ‰‹æŒåº”ç”¨å¯ä»¥èŠ‚çœåŠŸè€—ã€‚å…¶ç¼ºç‚¹æ˜¯éœ€è¦æŠ“æ‹å¤šå¸§å›¾åƒã€‚å¦‚æœåªç»™ä¸€å¸§å›¾åƒï¼ŒCDAF ç®—æ³•æ— ä»çŸ¥æ™“å½“å‰å›¾åƒæ˜¯å¦èšç„¦è‰¯å¥½ï¼Œä¹Ÿä¸çŸ¥é“è·ç¦»ç†æƒ³çš„èšç„¦ä½ç½®è¿˜æœ‰å¤šè¿œï¼Œç”šè‡³ä¸çŸ¥é“æ­£ç¡®çš„æ–¹å‘æ˜¯ focus near è¿˜æ˜¯ focus farï¼ˆPDAF åˆ™åˆšå¥½å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ï¼‰ã€‚</p><h2 id="çˆ¬å¡ç®—æ³•">çˆ¬å¡ç®—æ³•</h2><p>è¯¥æ–¹æ³•è¦æ±‚æ¸…æ™°åº¦è¯„ä»·å‡½æ•°å…·æœ‰ä¸¥æ ¼çš„å•å³°æ€§ã€‚æœç´¢è¿‡ç¨‹ä¸­åªèƒ½é€šè¿‡çˆ¬å¡å’Œä¸‹å¡æ¥åˆ¤æ–­å‡ºå±±å³°çš„æ–¹å‘è€Œä¸èƒ½çœ‹åˆ°å±±å³°çš„å…¨è²Œï¼Œåªæœ‰å½“è¶Šè¿‡å±±å³°æ—¶æ‰èƒ½æ‰¾åˆ°å±±å³°ã€‚</p><p>ä¸ºäº†æé«˜èšç„¦æ˜¯é€Ÿåº¦ï¼Œåœ¨ cdaf ç®—æ³•ä¸­å°†å±±å¡åˆ’åˆ†ä¸º 3 ä¸ªä¸åŒçš„åŒºåŸŸï¼Œåˆ†åˆ«å¯¹åº”ç€å¹³å¦åŒºåŸŸï¼ˆflatï¼‰ï¼Œæ–œå¡åŒºåŸŸï¼ˆslopeï¼‰ï¼Œé™¡å¡åŒºåŸŸï¼ˆsteepï¼‰, ä¸åŒåŒºåŸŸå¯¹åº”ç€ä¸åŒçš„çˆ¬å¡æ­¥é•¿ï¼Œåœ¨å¹³å¦åŒºåŸŸé‡‡ç”¨å¤§æ­¥èµ°çš„æ–¹å¼ï¼Œéšç€å¡åº¦è¶Šæ¥è¶Šæ¥ï¼Œæ­¥é•¿è¶Šæ¥è¶Šå°ï¼Œä»¥è¾¾åˆ°å¿«é€Ÿç²¾ç¡®æœç´¢å±±å³°çš„ç›®çš„ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus10.png"></p><h2 id="æ»¤æ³¢å™¨çš„åº”ç”¨">æ»¤æ³¢å™¨çš„åº”ç”¨</h2><p>å›¾åƒè¶Šæ¸…æ™°ï¼Œè¯´æ˜å›¾åƒçš„é«˜é¢‘åˆ†é‡è¶Šå¤šï¼Œç”¨ä¸€æ¬¾æ»¤æ³¢å™¨ä¿ç•™å›¾åƒçš„é«˜é¢‘åˆ†é‡ï¼Œæ¥å¯¹æ¯”åˆ°åº•å“ªå¼ å›¾ç‰‡æ›´åŠ æ¸…æ™°ã€‚åŸºäºç¡¬ä»¶è®¾è®¡çš„æˆæœ¬è€ƒè™‘ï¼Œæ—©æœŸçš„è‡ªåŠ¨å¯¹ç„¦ç³»ç»Ÿéƒ½æ˜¯ç”¨ä¸€äº›å›ºå®šç³»æ•°é«˜é¢‘æå–ç®—å­æ¯”å¦‚ sobelï¼Œlaplace ç­‰ä½œä¸ºè¯„ä»·å‡½æ•°ã€‚</p><p>å› ä¸ºé•œå¤´ä»¥åŠæˆåƒç³»ç»Ÿçš„å…‰å­¦ç‰¹æ€§å·®åˆ«å¾ˆå¤§ï¼Œè¿™ç§å›ºå®šç³»æ•°é«˜é¢‘ç®—å­çš„ ISP è®¾è®¡ä¸èƒ½æ»¡è¶³è‡ªåŠ¨å¯¹ç„¦ç³»ç»Ÿçš„éœ€è¦ã€‚æ¯”å¦‚åœ¨ä½å¯¹æ¯”åº¦çš„æƒ…å½¢ä¸‹ï¼Œå›¾åƒç¼ºå°‘é«˜é¢‘æˆä»½ï¼Œå¦‚æœæ»¤æ³¢å™¨å°±ä¸èƒ½å¤Ÿæå–åˆ°è¶³å¤Ÿçš„å›¾åƒè¾¹ç¼˜çš„é«˜é¢‘æˆä»½ï¼Œè¿™æ ·å¯¹ç„¦ç®—æ³•å°±æ— æ³•æ‰¾åˆ°å³°å€¼ä»è€Œå®ç°å¯¹ç„¦äº†ã€‚æ‰€ä»¥åæ¥çš„è‡ªåŠ¨å¯¹ç„¦ç³»ç»Ÿè¯„ä»·å‡½æ•°é€æ¸é‡‡ç”¨å¯ä»¥è®¾å®šç³»æ•°çš„ FIR æˆ–è€… IIR æ»¤æ³¢å™¨ã€‚</p><h1 id="ç›¸ä½å¯¹ç„¦-pdafphase-detection-auto-focus">ç›¸ä½å¯¹ç„¦ PDAF(Phase Detection Auto Focus)</h1><p>éœ€è¦åœ¨ sensor ä¸Šè®¾è®¡ä¸€äº›ç‰¹åˆ«çš„å…‰å­¦ã€åƒç´ ã€ç”µè·¯ç­‰æ„é€ ä»¥æä¾›å…³äºèšç„¦çŠ¶æ€çš„æ•°æ®ã€‚è¿™äº›ç‰¹åˆ«çš„åƒç´ é€šå¸¸è¢«ç§°ä¸ºèšç„¦ç‚¹ï¼ˆAF pointsï¼‰ã€‚</p><h2 id="af-ç»„ä»¶">AF ç»„ä»¶</h2><p>ä¸€äº›ç›¸æœºï¼ˆå¸¸è§äºå•åï¼‰ä¼šè®¾è®¡ä¸€ä¸ªä¸“ç”¨çš„å…‰è·¯ï¼ˆAF ç»„ä»¶ï¼‰ç”¨äºæ£€æµ‹èšç„¦çŠ¶æ€ã€‚å…¸å‹çš„å…‰è·¯ç”±ä¸€ä¸ªåˆ†å…‰æ£±é•œï¼ˆbeam splitterï¼‰å’Œä¸¤ä¸ªå¾®é€é•œï¼ˆmicrolensï¼‰ç»„æˆï¼Œæ¯ä¸ªå¾®é€é•œåé¢ä¼šæœ‰ä¸€ä¸ªä¸“ç”¨çš„ AF sensorï¼ˆåŒ…å«è‹¥å¹²ä¸ªåƒç´ ï¼‰ç”¨äºæ£€æµ‹åƒç‚¹çš„ç²¾ç¡®ä½ç½®ã€‚å¦‚æœä¸€ä¸ªç‰©ç‚¹æ‰€å¯¹åº”çš„åƒç‚¹è½åœ¨åˆ†å…‰æ£±é•œçš„åˆé€‚ä½ç½®ä¸Šï¼Œåˆ™åƒç‚¹ä¼šå‡ºç°åœ¨ä¸¤ä¸ª AF sensor çš„ä¸­é—´ä½ç½®ï¼Œè¡¨ç¤ºèšç„¦è‰¯å¥½ï¼›å¦åˆ™å°±æ˜¯ too near æˆ–è€… too farï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus3.png"></p><p>ä¸€äº›å•åç›¸æœºçš„ AF åŠŸèƒ½é‡‡ç”¨äº†ç±»ä¼¼çš„åŸç†ï¼Œä½†å®ç°æ–¹å¼ç•¥æœ‰ä¸åŒã€‚å…¸å‹çš„å…‰è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus4.png"></p><h2 id="pd-sensor">PD sensor</h2><p>ä»¥ä¸Šçš„ AF æ–¹æ¡ˆé€šå¸¸ç”¨äºå•åç›¸æœºï¼Œä»¥ä¸“ç”¨ AF ç»„ä»¶çš„æ–¹å¼å‡ºç°ã€‚åœ¨å¾ˆå¤šå…¶å®ƒåº”ç”¨ä¸­ï¼ˆå¦‚æ‰‹æœºï¼‰å¾ˆéš¾æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³ä¸“ç”¨ AF ç»„ä»¶ï¼Œæ‰€ä»¥ç»å¸¸ä¼šé‡‡ç”¨å¦å¤–ä¸€ç§ PD åŸç†ï¼Œå³æŠŠä¸€éƒ¨åˆ†æˆåƒç”¨çš„åƒç´ ç”¨ä¸é€å…‰çš„æŒ¡ä½ä¸€åŠï¼ˆåˆ†æˆå·¦å’Œå³ä¸¤ç§ï¼‰ï¼Œè®¾è®¡æˆå¦‚ä¸‹æ‰€ç¤ºçš„ AF ç›¸ä½æ£€æµ‹åƒç´ ï¼Œ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus5.png"></p><p>è¿™ç§ç‰¹æ®Šçš„åƒç´ ä»¥ä¸€å®šå¯†åº¦å‡åŒ€åœ°åˆ†å¸ƒåœ¨åƒç´ çŸ©é˜µä¸­ï¼Œä¸º AF è½¯ä»¶æä¾›èšç„¦å‚è€ƒã€‚è€Œ AF çš„å·¥ä½œåŸç†ä¸ä¸‹èŠ‚å°†è¦ä»‹ç»çš„ DP åŸç†ç±»ä¼¼ã€‚</p><h2 id="dpaf">DPAF</h2><p>Dual Pixelï¼Œæ¯ä¸ªåƒç´ åˆ†æˆä¸¤ä¸ªå­åƒç´ ã€‚å¯¹ç„¦æ—¶ï¼Œä¸¤ç§åƒç´ å•ç‹¬è¾“å‡ºï¼Œå¾—åˆ° A åƒå’Œ B åƒï¼Œé€šè¿‡ Aã€B ä¹‹é—´çš„è·ç¦»åˆ¤æ–­å¤±ç„¦ç›¸ä½ã€‚æ­£å¼æ‹æ‘„æ—¶ Aã€B åƒç´ åˆå¹¶æˆä¸€ä½“ï¼Œè¾“å‡ºä¸€å¹…å›¾åƒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus6.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus7.png"></p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“å¯¹ç„¦ä¸è‰¯æ—¶ï¼ŒA åƒå’Œ B åƒæ•´ä½“ç›¸ä¼¼ï¼Œä½†ç©ºé—´ä¸Šå­˜åœ¨è‹¥å¹²ä¸ªåƒç´ çš„è·ç¦»ã€‚è€Œå¯¹ç„¦è‰¯å¥½æ—¶ï¼ŒA åƒå’Œ B åƒåº”å®Œå…¨é‡åˆã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus8.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/focus9.png"></p><p>PD sensor æ–¹æ¡ˆä½¿ç”¨å°‘é‡åƒç´ å¸®åŠ©å¯¹ç„¦ï¼Œå·¥è‰ºæ›´åŠ ç®€å•ï¼Œä½†æ˜¯ç”±äºä¿¡æ¯è¾ƒå°‘ï¼Œå¯¹ç„¦æ‰€éœ€çš„æ—¶é—´ä¼šæ›´ä¹…ã€‚DP sensor æ–¹æ¡ˆæ¯ä¸ªåƒç´ éƒ½æä¾›å¯¹ç„¦ä¿¡æ¯å› æ­¤é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å·¥è‰ºä¹Ÿæ›´åŠ å¤æ‚ï¼Œæˆæœ¬é€šå¸¸æ›´é«˜ä¸€äº›ã€‚</p><h1 id="æ¿€å…‰å¯¹ç„¦-ldaflaser-detection-auto-focus">æ¿€å…‰å¯¹ç„¦-LDAF(Laser Detection Auto Focus)</h1><p>æ¿€å…‰å¯¹ç„¦æ˜¯é€šè¿‡æ‘„åƒå¤´æ—è¾¹çš„çº¢å¤–æ¿€å…‰ä¼ æ„Ÿå™¨å‘è¢«æ‘„ç‰©ä½“å‘å°„ä½åŠŸç‡æ¿€å…‰ï¼Œç»è¿‡åå°„åè¢«ä¼ æ„Ÿå™¨æ¥æ”¶ï¼Œå¹¶è®¡ç®—å‡ºä¸è¢«æ‘„ç‰©ä½“ä¹‹é—´çš„è·ç¦»ã€‚ä¹‹åé•œé—´é©¬è¾¾ä¾¿ç›´æ¥å°†é•œç‰‡æ¨åˆ°ç›¸åº”ä½ç½®ï¼Œå®Œæˆå¯¹ç„¦ã€‚ å’Œç›¸ä½å¯¹ç„¦ä¸€æ ·ï¼ŒåŒæ ·æ˜¯ä¸€æ¬¡å®Œæˆã€‚ æ¿€å…‰å¯¹ç„¦æŠ€æœ¯å¯¹äºå¾®è·ã€å¼±å…‰ç¯å¢ƒä»¥åŠåå·®ä¸å¤Ÿæ˜æ˜¾çš„åŒºåŸŸï¼Œæ•ˆæœæ˜¾è‘—ï¼Œèƒ½å¤Ÿæœ‰æ•ˆæé«˜æ‰‹æœºåœ¨è¿™äº›æƒ…å†µä¸‹çš„å¯¹ç„¦æˆåŠŸç‡ï¼Œåªæ˜¯åœ¨å¯¹ç„¦é€Ÿåº¦ä¸Šï¼Œæ¿€å…‰å¯¹ç„¦æ¯”è¾ƒä¸€èˆ¬ã€‚è€Œåœ¨å…‰çº¿æ­£å¸¸çš„æ¡ä»¶ä¸‹ï¼Œæ¿€å…‰å¯¹ç„¦çš„é€Ÿåº¦å’Œç›¸ä½å¯¹ç„¦ä¸€æ ·éå¸¸ä¹‹å¿«ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDkwMDAwNTY=">https://zhuanlan.zhihu.com/p/109000056<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NzAyNjUzNzk=">https://zhuanlan.zhihu.com/p/470265379<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cucWlueGluZy54eXovcG9zdHMvNzIwYWQ1MWIv">https://www.qinxing.xyz/posts/720ad51b/<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> 3A </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISP ä¹‹ Pipeline</title>
      <link href="/2023/Camera/CameraPipeline/"/>
      <url>/2023/Camera/CameraPipeline/</url>
      
        <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯-isp">ä»€ä¹ˆæ˜¯ ISP</h1><p>ä¸»æµçš„ CMOS å’Œ CCD sensor å‡ ä¹éƒ½æ˜¯è¾“å‡º Bayer mosaic æ ¼å¼çš„ RAW æ•°æ®ï¼Œè¿™ç§æ•°æ®æ ¼å¼æ˜¯æ— æ³•ç›´æ¥è§‚çœ‹çš„ï¼Œå¿…é¡»è½¬æ¢æˆå¸¸è§çš„ RGB æˆ– YUV æ ¼å¼æ‰èƒ½è¢«ä¸»æµçš„å›¾åƒå¤„ç†è½¯ä»¶æ”¯æŒã€‚å¯¹äº camera äº§å“è€Œè¨€ï¼Œä¸€èˆ¬è¿˜éœ€è¦å°† RGB æˆ– YUV å›¾åƒè¿›ä¸€æ­¥è½¬æ¢æˆ JPEG æ ¼å¼ä»¥æ–¹ä¾¿è¿›è¡Œå­˜å‚¨ã€‚ä¸Šè¿°å›¾åƒå¤„ç†è¿‡ç¨‹ç»Ÿç§°å›¾åƒä¿¡å·å¤„ç†ï¼ˆImage Signal Processingï¼ŒISPï¼‰ï¼Œå¹¿ä¹‰çš„ ISP åŒ…å«äº† JPEG å’Œ H.264/265 å›¾åƒå‹ç¼©å¤„ç†ï¼Œè€Œç‹­ä¹‰çš„ ISP ä»…åŒ…æ‹¬ä» RAW æ ¼å¼å˜æ¢åˆ° RGB æˆ– YUV çš„å¤„ç†è¿‡ç¨‹ã€‚</p><span id="more"></span><p>ä¸€ä¸ªå…¸å‹çš„ ISP æµæ°´çº¿ç”±ä¸€ç³»åˆ—å¤„ç†æ¨¡å—ç»„æˆï¼Œè¿™äº›æ¨¡å—é¦–å°¾ç›¸è¿ï¼Œåœ¨å‡ ç™¾ MHz çš„æ—¶é’Ÿé©±åŠ¨ä¸‹åŒæ—¶é«˜é€Ÿè¿è½¬ï¼Œå›¾åƒæ•°æ®ä¸æ–­ä»ä¸€ä¸ªæ¨¡å—è½¬ç§»è‡³ä¸‹ä¸€ä¸ªæ¨¡å—ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰çš„ç®—æ³•å¤„ç†ï¼Œæœ€ç»ˆä»¥ YUV æˆ– RGB çš„å½¢å¼ä»æµæ°´çº¿çš„æœ«çº§æµå‡º ISPã€‚ä¸‹å›¾æ‰€ç¤ºçš„æ˜¯ä¸€ä¸ªæ”¯æŒå¸¸è§åŸºæœ¬åŠŸèƒ½çš„ ISP æµæ°´çº¿ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline1.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå›¾åƒæ•°æ®åœ¨ ISP å†…éƒ¨ç»å†äº†ä¸¤æ¬¡é¢œè‰²ç©ºé—´å˜æ¢ï¼Œç¬¬ä¸€æ¬¡å˜æ¢å‘ç”Ÿåœ¨ Demosaic æ¨¡å—ï¼Œå®ƒæŠŠåƒç´ ä»å³ RAW åŸŸå˜æ¢åˆ° RGB åŸŸï¼Œç¬¬äºŒæ¬¡å˜æ¢å‘ç”Ÿåœ¨ CSC æ¨¡å—ï¼Œå®ƒæŠŠåƒç´ ä» RGB å˜åˆ° YUV åŸŸã€‚ä¸‹è¡¨å¯¹ ISP å„æ¨¡å—çš„ä½œç”¨ç»™äºˆäº†ç®€è¦è¯´æ˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline2.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline3.png"></p><ul><li>DPC(Defective Pixel Correction) åç‚¹çŸ«æ­£ã€‚ å¦‚æœå›¾åƒä¸­å­˜åœ¨åç‚¹çš„è¯ï¼Œåœ¨è¿›è¡Œæ’å€¼å’Œæ»¤æ³¢å¤„ç†çš„æ—¶å€™ï¼Œä¼šå½±å“å‘¨å›´çš„åƒç´ ç‚¹ï¼Œå› æ­¤éœ€è¦åœ¨æ’å€¼å’Œæ»¤æ³¢ä¹‹å‰å¯¹åç‚¹è¿›è¡Œæ ¡æ­£ã€‚<ul><li>é™æ€åç‚¹æ ¡æ­£ï¼šé™æ€åç‚¹çš„æ ¡æ­£æ˜¯åŸºäºå·²æœ‰çš„é™æ€åç‚¹è¡¨ï¼Œæ¯”è¾ƒå½“å‰ç‚¹çš„åæ ‡æ˜¯å¦ä¸é™æ€åç‚¹è¡¨ä¸­çš„æŸä¸ªåæ ‡ä¸€è‡´ï¼Œè‹¥ä¸€è‡´åˆ™åˆ¤å®šä¸ºåç‚¹ï¼Œç„¶åå†è®¡ç®—æ ¡æ­£ç»“æœå¯¹å…¶è¿›è¡Œæ ¡æ­£ã€‚ï¼Œæ¯ä¸ª sensor çš„åç‚¹éƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦ sensor å‚å•†ç»™å‡ºæ¯ä¸ª sensor çš„é™æ€åç‚¹è¡¨ã€‚sensor çš„é™æ€åç‚¹è¡¨ä¸€æ—¦å†™å…¥å­˜å‚¨ï¼Œdpc æ¨¡å—ä¼šè‡ªåŠ¨æ›¿æ¢åç‚¹è¡¨ä¸­æ‰€ç¤ºåç‚¹ã€‚</li><li>åŠ¨æ€åç‚¹æ ¡æ­£ï¼šåŠ¨æ€åç‚¹çš„æ ¡æ­£å¯ä»¥å®æ—¶çš„æ£€æµ‹å’Œæ ¡æ­£ sensor çš„äº®ç‚¹ä¸æš—ç‚¹ï¼Œå¹¶ä¸”æ ¡æ­£çš„åç‚¹ä¸ªæ•°ä¸å—é™åˆ¶ã€‚</li></ul></li><li>BLC(Black Level Compensation) é»‘ç”µå¹³è¡¥å¿ çŸ«æ­£ã€‚ é»‘ç”µå¹³ï¼ˆBlack Level Correctionï¼‰ï¼šå³é»‘è‰²æ•°æ®çš„æœ€ä½ç”µå¹³å€¼ï¼Œé€šå¸¸æŒ‡æ„Ÿå…‰å›¾åƒæ•°æ®ä¸º 0 æ—¶å¯¹åº”çš„ sensor ä¿¡å·ç”µå¹³å€¼ã€‚å…¶åŸå› å¦‚ä¸‹ï¼š<ul><li>sensor å‚å®¶ä¸€èˆ¬ä¼šåœ¨ AD çš„è¾“å…¥ä¹‹å‰åŠ ä¸Šä¸€ä¸ªå›ºå®šçš„åç§»é‡ï¼Œä½¿è¾“å‡ºçš„ pixel value åœ¨ 5ï¼ˆéå›ºå®šï¼‰~255 ä¹‹é—´ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©æš—éƒ¨çš„ç»†èŠ‚å®Œå…¨ä¿ç•™ã€‚</li><li>sensor çš„ç”µè·¯æœ¬èº«ä¼šå­˜åœ¨æš—ç”µæµã€‚ çŸ«æ­£æ–¹æ³•ï¼š</li><li>ç›®å‰å¸‚åœºä¸Šä½¿ç”¨çš„ ISP ä¸€èˆ¬é‡‡ç”¨çš„æ–¹æ³•æ˜¯åœ¨ sensor è¾“å‡ºçš„å›¾åƒä¸Šå‡å»ä¸€ä¸ªå›ºå®šæ•°å€¼ã€‚</li><li>åˆ©ç”¨é»‘ç”µå¹³éšæ¸©åº¦å’Œ gain çš„æ¼‚ç§»æ›²çº¿ï¼Œåˆ©ç”¨ä¸€æ¬¡å‡½æ•°çš„æ–¹å¼è¿›è¡Œæ ¡æ­£ï¼Œä½†æ˜¯å¯¹äºä¸åŒ sensorï¼Œæ¼‚ç§»æ›²çº¿ä¸ä¸€æ ·ï¼Œå› æ­¤è¯¥æ–¹æ¡ˆæ²¡æœ‰ä½œä¸ºé€šç”¨æ–¹æ¡ˆã€‚</li></ul></li><li><p>LSC(Lens Shading Correction) é•œå¤´çŸ«æ­£ã€‚ ç”±äºé•œå¤´çš„åŸå› é€ æˆçš„æš—è§’è‰²æ•£ç­‰ç°è±¡éœ€è¦å¯¹å›¾åƒåšä¸€äº›çŸ«æ­£ï¼Œåæ–‡å†åšè¯¦ç»†ä»‹ç»ã€‚</p></li><li><p>NR(Noise Reduction) é™å™ªã€‚ raw åŸŸé™å™ªï¼Œç”±äº sensor è¾“å‡ºçš„æ•°æ®ä¼šå­˜åœ¨å„ç§å™ªå£°ï¼Œè€Œ raw åŸŸæ˜¯åœ¨åé è¿‘åŸå§‹æ•°æ®ä¸€ç«¯ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µåšé™å™ªå¯ä»¥å‡å°‘å™ªå£°åœ¨åç»­ç®—æ³•ä¸­æ”¾å¤§å’Œä¼ æ’­ï¼Œåæ–‡å†åšè¯¦ç»†ä»‹ç»ã€‚</p></li><li><p>AWB(Auto White Balance) è‡ªåŠ¨ç™½å¹³è¡¡ã€‚ è‡ªåŠ¨ç™½å¹³è¡¡ï¼Œç›‘æµ‹ç¯å¢ƒå…‰ï¼Œå°½å¯èƒ½è¿˜åŸç‰©ä½“æœ¬æ¥çš„é¢œè‰²ï¼Œåæ–‡å†åšè¯¦ç»†ä»‹ç»ã€‚</p></li><li><p>Bayer Demosaic å»é©¬èµ›å…‹ã€‚ raw æ•°æ®åªæœ‰åœ¨ CFA ä¸‹åªæœ‰ä¸€ä¸ªé¢œè‰²çš„äº®åº¦ä¿¡æ¯ï¼Œéœ€è¦æ ¹æ®å‘¨å›´çš„é¢œè‰²æ¥å·®å€¼å¾—åˆ° RGB é¢œè‰²ï¼Œè¿™æ˜¯ raw åŸŸæœ€åä¸€æ­¥ï¼Œç»è¿‡è¿™ä¸€æ­¥å›¾åƒå°±å˜æˆ RGB åŸŸäº†ã€‚</p></li><li>Gamma æ›²çº¿æ ¡æ­£ã€‚ sensor å¯¹å…‰çº¿çš„æ„ŸçŸ¥æ˜¯çº¿æ€§çš„ï¼Œè€Œäººçœ¼å¯¹ gamma çš„æ„ŸçŸ¥æ˜¯éçº¿æ€§çš„ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ˜ å°„ã€‚å…¶çŸ«æ­£æ–¹æ³•å¦‚ä¸‹ï¼š<ul><li><strong>LUT æ³•ï¼š</strong> æå‰æŠŠæ¯ä¸ªåƒç´ å€¼ç» gamma çŸ«æ­£åå¯¹åº”çš„å€¼æ±‚å‡ºæ¥ï¼Œç„¶åæŠŠè¿™äº›æ•°æ®ç›´æ¥å­˜å‚¨åˆ°ä¸€ä¸ªæ•°ä¸­ï¼Œåˆ°çŸ«æ­£çš„æ—¶å€™æ ¹æ®è¾“å…¥çš„å€¼å°±èƒ½ç›´æ¥é€šè¿‡æ•°ç»„ä¸‹æ ‡å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„çŸ«æ­£åçš„å€¼ï¼Œè¿™ç§æ–¹å¼æœ€å¤§çš„æœ‰ç‚¹å°±æ—¶å¿«ï¼Œå‡ ä¹ä¸æ¶ˆè€—ç¡¬ä»¶èµ„æºï¼Œå› ä¸ºå‡ ä¹ä¸ç”¨åšä»»ä½•è®¡ç®—çš„å¤„ç†ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼çš„å¼Šç«¯åœ¨äºéœ€è¦å¤§é‡çš„å†…å­˜æ¥å­˜å‚¨è¿™ä¹ˆè¿™ä¸ªè¡¨ã€‚</li><li><strong>çº¿æ€§æ’å€¼æ³•ï¼š</strong> çº¿æ€§æ’å€¼æ³•ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨ gamma æ›²çº¿ä¸Šæå–ä¸€äº›é‡‡æ ·ç‚¹ï¼Œç„¶åæŠŠé‡‡æ ·ç‚¹çš„è¾“å…¥è¾“å‡ºä½œä¸º xy å­˜å‚¨èµ·æ¥ï¼Œç„¶åçŸ«æ­£çš„æ—¶å€™å¦‚æœåœ¨é‡‡æ ·ç‚¹ä¸Šå°±æ¥ç›´æ¥è¾“å…¥çŸ«æ­£å€¼ï¼Œå¦‚æœä¸åœ¨ï¼Œé‚£ä¹ˆè‚¯å®šåœ¨æŸä¸¤ä¸ªé‡‡æ ·ç‚¹ä¹‹é—´ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°±å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªé‡‡æ ·ç‚¹çš„çº¿æ€§æ–¹ç¨‹æ±‚è§£å‡ºè¯¥ç‚¹çš„æ ¡æ­£å€¼ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¼šæœ‰ä¸€å®šçš„è¯¯å·®ï¼Œå› ä¸ºçº¿æ€§æ–¹ç¨‹å¹¶å¸ƒæ©é‚£ä¸ªå®Œå…¨æ‹Ÿåˆ gamma æ›²çº¿ã€‚</li></ul></li><li><p>CCM(Color Correction Matrix) é¢œè‰²æ ¡æ­£ã€‚ ç”±äºäººçœ¼å¯¹è‰²å½©çš„æ„ŸçŸ¥æ›²çº¿å’Œ sensor å¯¹è‰²å½©çš„æ„ŸçŸ¥æ›²çº¿ä¸åŒï¼Œä¸ºäº†æ›´ç¬¦åˆäººç±»çš„è§†è§‰éœ€è¦å¯¹ sensor è¾“å‡ºçš„è‰²å½©åšä¸€ä¸ªæ˜ å°„ï¼Œå°±æ˜¯ CCM æ¨¡å—åšçš„äº‹æƒ…ã€‚è¿™ä¸ªåæ–‡å†åšè¯¦ç»†ä»‹ç»ã€‚</p></li><li><p>CSC(Color Space Convert) è‰²å½©ç©ºé—´è½¬æ¢ã€‚ é¢œè‰²ç©ºé—´è½¬æ¢ï¼Œå¾ˆå¤šç®—æ³•éœ€è¦åŸºäº YUV æ ¼å¼æ¥åšï¼Œä¸”æœ€é‡è¦çš„ H264ã€H265 ç¼–è§£ç éƒ½æ˜¯åŸºäº YUV æ ¼å¼çš„ï¼ŒISP éœ€è¦å°†å›¾åƒç”± RGB åŸŸè½¬ YUV åŸŸï¼Œè€Œè¯¥æ¨¡å—å°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚</p></li><li><p>NR Luma(Noise Reduction forLuma) äº®åº¦é™å™ªã€‚ å¯¹ Y åˆ†é‡ï¼Œä¹Ÿå°±æ˜¯äº®åº¦ä¿¡æ¯åšé™å™ªå¤„ç†ï¼Œä¸€èˆ¬äº®åº¦è¶Šä½ä¿¡å™ªæ¯”è¶Šä½ã€‚é™å™ªæ–¹æ³•ä¸€èˆ¬å°±æ˜¯ä¸¤ç§åœ¨é¢‘åŸŸå’Œç©ºåŸŸé‡Œè¿›è¡Œé™å™ªï¼Œè€Œå¸¸ç”¨çš„ç®—æ³•å°±æ˜¯å°±æ˜¯è®¾è®¡ä¸€ä¸ªæ»¤æ³¢çª—å£ç„¶åå¯¹å›¾åƒè¿›è¡Œå·ç§¯è¿ç®—ã€‚</p></li><li><p>NR Chroma(Noise Reduction for Chroma) è‰²å½©é™å™ªã€‚ å¯¹ UV åˆ†é‡è¿›è¡Œé™å™ªå¤„ç†ï¼Œè¿™é‡Œçš„å™ªå£°ä¼šé€ æˆè‰²å½©çš„æ³¢åŠ¨ï¼Œåœ¨äº®åº¦å¾ˆä½çš„æƒ…å†µä¸‹å™ªå£°ä¼šå¾ˆå¤§ï¼Œé€ æˆè‰²å½©æ³¢åŠ¨æ¯”è¾ƒå¤§ã€‚</p></li><li><p>Edge Enhance è¾¹ç¼˜å¢å¼ºã€‚ ç”±äºä¹‹å‰çš„åŸŸä¸­ä¼šå¤šæ¬¡è¿›è¡Œé™å™ªå¤„ç†ï¼Œè€Œé™å™ªä¸å¯é¿å…çš„ä¼šå°†å›¾åƒä¸­ä¸€äº›ç»†èŠ‚ä¹Ÿæå¸¦ç€æ¶ˆé™¤äº†ï¼Œå¯¼è‡´å›¾åƒæ¨¡ç³Šã€‚ä¸ºäº†å°†å›¾åƒç»†èŠ‚è¿˜åŸï¼Œå‡å°‘å›¾åƒæŸå¤±ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå¢å¼ºï¼Œä½†æ˜¯ä¸èƒ½å†æ¬¡å¼•å…¥å™ªå£°ï¼Œå°±å‡ºç°äº† Edge Enhance è¾¹ç¼˜å¢å¼ºè¿™ç±»å¤„ç†æ¨¡å—ã€‚è¾¹ç¼˜å¢å¼ºå’Œæˆ‘ä»¬æ—¥å¸¸è¯´çš„é”åŒ– sharp æ˜¯æ¯”è¾ƒç›¸ä¼¼çš„ã€‚ä½†æ˜¯äºŒè€…ä¹Ÿæœ‰åŒºåˆ«ï¼šé”åŒ–é’ˆå¯¹å›¾åƒæ‰€æœ‰å†…å®¹å¢åŠ é”åˆ©åº¦ï¼Œè¾¹ç¼˜å¢å¼ºåªæ˜¯é’ˆå¯¹è¾¹ç¼˜ï¼Œé¿å…å™ªå£°ä¹Ÿä¼šé”åŒ–æ”¾å¤§ã€‚åæ–‡å†è¯¦ç»†ä»‹ç»ã€‚</p></li><li>Hue &amp; Saturation è‰²è°ƒé¥±å’Œåº¦æ§åˆ¶ã€‚<ul><li>é¥±å’Œåº¦ Saturation å°±æ˜¯è¯´è‰²å½©çš„é²œè‰³ç¨‹åº¦ã€‚åœ¨ YUV åŸŸä¸­ï¼ŒUã€V åˆ†é‡åˆ†åˆ«ä»£è¡¨è“å’Œçº¢åˆ†é‡ã€‚å½“ U=V=128 çš„æ—¶å€™ï¼Œè¡¨ç¤ºé¥±å’Œåº¦ä¸º 0ï¼›å½“|U-128|å’Œ|V-128|çš„å€¼è¶Šå¤§ï¼Œé¥±å’Œåº¦ä¹Ÿè¶Šå¤§ã€‚å½“ Uã€V åˆ†é‡çš„å·®å€¼ä¸ç³»æ•° s ç›¸ä¹˜ï¼Œå°±å¯ä»¥è°ƒæ•´é¥±å’Œåº¦å¹…åº¦ã€‚s=0 è¡¨ç¤ºç°åº¦ï¼Œs=1 è¡¨ç¤ºåŸå›¾ä¸è°ƒæ•´ï¼Œ0~1 ä¹‹é—´è¡¨ç¤ºé™ä½é¥±å’Œåº¦ï¼Œå¤§äº 1 è¡¨ç¤ºå¢åŠ é¥±å’Œåº¦ã€‚</li><li>Hue çš„æ„æ€æ˜¯è‰²è°ƒã€è‰²ç›¸ï¼Œè¡¨ç¤ºé¢œè‰²çš„ç›¸ä½è§’ã€‚ç®€å•ç†è§£å°±æ˜¯ï¼Œåœ¨ä¸€ä¸ªæ ‡å‡†åœ†ä¸­ï¼Œçº¢è‰²æ˜¯ 0Â°ï¼Œç»¿è‰²æ˜¯ 120Â°ã€è“è‰²æ˜¯ 240Â°ï¼Œä¸åŒåº¦æ•°è¡¨ç¤ºä¸åŒçš„é¢œè‰²ã€‚åæ–‡å†è¯¦ç»†ä»‹ç»ã€‚</li></ul></li><li>Contrast &amp; Brightness å¯¹æ¯”åº¦äº®åº¦æ§åˆ¶ã€‚<ul><li>Brightness äº®åº¦æ§åˆ¶æ˜¯ä¸€èˆ¬æ‘„åƒå¤´éƒ½ä¼šæœ‰çš„åŠŸèƒ½ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ§åˆ¶äº®åº¦æ¥æ”¹å˜å›¾ç‰‡æ•ˆæœã€‚</li><li>å¯¹æ¯”åº¦è°ƒèŠ‚ Contrast ä¹Ÿå«åšå¯¹æ¯”åº¦å¢å¼º Contrast Enhancementï¼Œå°±æ˜¯å¢å¼ºå›¾ç‰‡çš„å¯¹æ¯”åº¦ã€‚ç›®å‰å¯¹æ¯”åº¦å¢å¼ºä¸»è¦çš„ç®—æ³•æ˜¯ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼ˆHistogramï¼‰ï¼Œæ ¹æ®åŸå§‹å›¾åƒçš„äº®åº¦æ•°æ®è¿›è¡Œé‡æ–°åˆ†å¸ƒï¼Œä½¿å›¾ç‰‡çš„äº®åº¦åˆ†å¸ƒæ›´åŠ å‡åŒ€ åæ–‡å†è¯¦ç»†ä»‹ç»ã€‚</li></ul></li></ul><h1 id="isp-è¾“å…¥å›¾åƒçš„æ ¼å¼">ISP è¾“å…¥å›¾åƒçš„æ ¼å¼</h1><p>ç›®å‰ä¸»æµçš„ CMOS sensor å‡ ä¹éƒ½æ˜¯è¾“å‡º Bayer mosaic æ ¼å¼çš„ RAW æ•°æ®ã€‚Bayer æ ¼å¼å›¾ç‰‡æ˜¯ä¼Šå£«æ›¼Â·æŸ¯è¾¾å…¬å¸ç§‘å­¦å®¶ Bryce Bayerï¼ˆ1929 â€“2012ï¼‰å‘æ˜çš„ï¼Œæ‹œè€³é˜µåˆ—è¢«å¹¿æ³›è¿ç”¨ä¸æ•°å­—å›¾åƒå¤„ç†é¢†åŸŸã€‚</p><p>å¸¸ç”¨çš„ Bayer æ ¼å¼æœ‰ RGGB,ã€GRBGã€GBRG ç­‰å¤šç§ï¼Œå› æ­¤éœ€è¦æ­£ç¡®é…ç½® ISP ä»¥ååº” sensor çš„æ•°æ®æ ¼å¼ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline4.png"></p><p>RAW æ•°æ®çš„ç²¾åº¦å¸¸è§æœ‰ 8/10/12/14bit ç­‰è§„æ ¼ã€‚å®‰é˜²ç›‘æ§è¡Œä¸šè¾ƒå¤šä½¿ç”¨ 10/12bit ç²¾åº¦çš„ sensorï¼ŒåŒ»ç–—è¡Œä¸šåˆ™ä¸»è¦ä½¿ç”¨ 12bit ä»¥ä¸Šç²¾åº¦ sensorï¼Œå•åå’Œå¹¿ç”µè¡Œä¸šåˆ™ä¸»è¦ä½¿ç”¨ 14bit ç²¾åº¦ sensorã€‚å¯¹ä¸ä¸€äº›å¸¦å®½å’Œå­˜å‚¨èµ„æºç‰¹åˆ«ç´§å¼ çš„åœºåˆï¼Œæœ‰äº› sensor ä¼šæ”¯æŒå‹ç¼©è¡¨ç¤ºä»¥èŠ‚çº¦å¸¦å®½ RawCopmpressã€‚</p><h2 id="å›¾åƒæ¥å…¥-isp-çš„æ–¹å¼">å›¾åƒæ¥å…¥ ISP çš„æ–¹å¼</h2><ul><li>åœ¨çº¿æ¨¡å¼ï¼Œonline modeï¼Œsensor äº§ç”Ÿçš„å®æ—¶æ•°æ®å’Œæ—¶åºæ§åˆ¶ä¿¡å·ä»¥è¡Œä¸ºå•ä½é€å…¥ ISP è¿›è¡Œå¤„ç†ï¼Œå…·å¤‡ä½å»¶è¿Ÿ (low latency) çš„ä¼˜ç‚¹ã€‚</li><li>ç¦»çº¿æ¨¡å¼ï¼Œoffline modeï¼Œå¾…å¤„ç†çš„å›¾åƒä»¥å¸§ä¸ºå•ä½å­˜å‚¨äºç³»ç»Ÿå†…å­˜ï¼Œéœ€è¦å¤„ç†æ—¶ç”±ä¸€ä¸ªæ§åˆ¶é€»è¾‘é€šè¿‡ DMA ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œå¹¶æ·»åŠ æ¨¡æ‹Ÿ sensor è¡Œä¸ºçš„æ—¶åºæ§åˆ¶ä¿¡å·ï¼Œç„¶åé€ç»™ ISP è¿›è¡Œå¤„ç†ã€‚</li></ul><h2 id="è¡Œç¼“å†²-line-buffer">è¡Œç¼“å†² Line Buffer</h2><p>ä¸è®ºæ˜¯åœ¨çº¿æ¨¡å¼è¿˜æ˜¯ç¦»çº¿æ¨¡å¼ï¼ŒISP å¤„ç†å›¾åƒéƒ½æ˜¯ä»¥è¡Œä¸ºå•ä½çš„ï¼Œæ‰€ä»¥ ISP æ¨¡å—éƒ½ä¼šè®¾è®¡ä¸€ä¸ª line buffer å¯ä»¥ç¼“å­˜è‹¥å¹²è¡Œå›¾åƒã€‚é€šå¸¸è¿™ä¸ª line buffer çš„å¤§å°å°±å†³å®šäº†è¿™ä¸ª ISP æ‰€æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ª ISP çš„ line buffer å¯ä»¥å®¹çº³æ¯è¡Œ 2048 ä¸ªåƒç´ ï¼Œåˆ™å®ƒæ— æ³•æ”¯æŒè¶…è¿‡ 2k/1080p çš„åˆ†è¾¨ç‡è§„æ ¼ã€‚</p><h2 id="æ•°æ®å¯¹é½-alignment">æ•°æ®å¯¹é½ Alignment</h2><p>ISPã€CODEC ç­‰ç¡¬ä»¶å•å…ƒåœ¨å¤„ç†å›¾åƒæ—¶é€šå¸¸éƒ½ä¼šæœ‰ç²’åº¦ï¼ˆgranularityï¼‰è¦æ±‚ï¼Œå³å¿…é¡»å°† 8/16/32/64/128 ä¸ªåƒç´ ä½œä¸ºä¸€ç»„æ¥å¤„ç†ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ç¡¬ä»¶å¹¶è¡ŒåŒ–æ¥æé«˜ååç‡ã€‚è¿™ä¸ªéœ€æ±‚ç§°ä¸º ISP çš„æ•°æ®å¯¹é½ï¼ˆalignmentï¼‰éœ€æ±‚ï¼Œå¤šæ•° sensor éƒ½æ”¯æŒä¸€ä¸ª linesize å±æ€§ï¼Œä»¥ä¿è¯ sensor è¾“å‡ºçš„æ¯è¡Œæ•°æ®çš„å®½åº¦ç¬¦åˆ ISP çš„å¯¹é½è¦æ±‚ã€‚</p><h2 id="å›¾åƒå‹ç¼©">å›¾åƒå‹ç¼©</h2><p>4K åˆ†è¾¨ç‡çš„å›¾åƒæœ‰ 800W ä¸ªåƒç´ ï¼ŒRAW æ ¼å¼å  1600W å­—èŠ‚ï¼ŒYUV422 æ ¼å¼å  1200W å­—èŠ‚ï¼Œ8K åˆ†è¾¨ç‡ï¼Œä¹Ÿå°±æ˜¯ 7680x4320ï¼ŒRAW æ ¼å¼å  6600W å­—èŠ‚ã€‚</p><p>ä¸ºäº†å‡è½»ä¼ è¾“å¸¦å®½å’Œå­˜å‚¨çš„å‹åŠ›ï¼Œæ”¯æŒ 4K ä»¥ä¸Šçš„èŠ¯ç‰‡éƒ½ä¼šåœ¨ DMA ä¸Šè®¾è®¡ä¸€ä¸ªå‹ç¼©ç®—æ³•ã€‚å½“ DMA å‘å†…å­˜ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå®é™…è¿›å…¥å†…å­˜çš„æ˜¯å‹ç¼©åçš„æ•°æ®ã€‚å½“ DMA ä»å†…å­˜ä¸­è¯»å–æ•°æ®æ—¶ï¼Œç”¨æˆ·å¾—åˆ°çš„æ˜¯è§£å‹ç¼©åçš„æ•°æ®ã€‚</p><p>Arm å‡ºå”®çš„å›¾åƒå‹ç¼©æŠ€æœ¯å« AFBCï¼Œå³ Arm Frame Buffer Compressionï¼Œè¿™æ˜¯ä¸€ç§åŸºäºè„‰å†²ç¼–ç è°ƒåˆ¶ (Pulse Code Modulation,PCM) æŠ€æœ¯å®ç°çš„æ— æŸå‹ç¼©æŠ€æœ¯ï¼Œå…¸å‹æƒ…å†µä¸‹å¯ä»¥å®ç° 50% å·¦å³çš„å‹ç¼©ç‡ï¼Œå¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´å’Œä¼ è¾“å¸¦å®½ã€‚</p><h1 id="è‰²è°ƒæ˜ å°„-tone-mapping">è‰²è°ƒæ˜ å°„ Tone Mapping</h1><p>æ‘„åƒæœºæ‹æ‘„å®¤å¤–åœºæ™¯æ—¶ï¼Œæ™´æœ—å¤å¤©çš„å…‰ç…§åº¦å¯ä»¥è¾¾åˆ° 10 ä¸‡~20 ä¸‡ luxï¼Œç†è®ºä¸Šæ‹æ‘„è¿™ç§åœºæ™¯éœ€è¦æä¾›é«˜è¾¾ 5000ï¼š1 çš„åŠ¨æ€èŒƒå›´ï¼Œåœ¨æ‘„åƒæœºå†…éƒ¨åˆ™éœ€è¦ä½¿ç”¨è‡³å°‘ 13 ä½çš„æ•°æ®æ‰èƒ½è¡¨ç¤º 5000ï¼š1 çš„åŠ¨æ€èŒƒå›´ï¼Œåœ¨é€šç”¨ CPU æ¶æ„ä¸­ä½¿ç”¨ 16 ä½æ•´æ•°åˆ™æ›´åŠ æ–¹ä¾¿ã€‚ç”±äºæ•°æ®åœ¨å¤„ç†ç¯èŠ‚ç»å¸¸æ¶‰åŠé™¤æ³•ã€å¼€æ–¹ã€æŒ‡æ•°ç­‰æµ®ç‚¹è¿ç®—ï¼Œæ‰€ä»¥è¿˜éœ€è¦é¢„ç•™è‹¥å¹²ä¸ªå°æ•°ä½ä»¥ä¿æŒæµ®ç‚¹ç²¾åº¦ï¼Œ4 ä½äºŒè¿›åˆ¶å°æ•°å¯ä»¥æä¾› 0.0625 ç²¾åº¦ï¼Œ8 ä½äºŒè¿›åˆ¶å°æ•°å¯ä»¥æä¾› 0.0039 ç²¾åº¦ã€‚ä¸Šè¿°çš„ä¸»æµ ISP æ–¹æ¡ˆä¸­ä½¿ç”¨ 20 ä½æ•°æ®ã€‚</p><p>å½“å›¾åƒåœ¨æ˜¾ç¤ºè®¾å¤‡ä¸Šè¾“å‡ºæ—¶ï¼Œæ™®é€šçš„ LDR æ˜¾ç¤ºå™¨åªèƒ½æä¾› 256 çº§ç°åº¦ï¼ŒæŒ‰æ•°é‡çº§æ˜¯ 100:1 çš„åŠ¨æ€èŒƒå›´ã€‚ç¬¦åˆ HDR10 æ ‡å‡†çš„æ˜¾ç¤ºå™¨å¯ä»¥æä¾› 1000:1 çš„åŠ¨æ€èŒƒå›´ï¼Œå·²ç»å¯ä»¥è¾ƒå¥½åœ°è¿˜åŸè‡ªç„¶åœºæ™¯çš„åŠ¨æ€ã€‚å¦‚æœæ‘„åƒæœºçš„é€‚é…è¾“å‡ºè®¾å¤‡æ˜¯ LDR æ˜¾ç¤ºå™¨ï¼Œåˆ™æ‘„åƒæœºçš„ ISP å†…éƒ¨éœ€è¦å®Œæˆä» 5000:1 åˆ° 100:1 çš„åŠ¨æ€èŒƒå›´å‹ç¼©ã€‚</p><p>å½“ WDR æ¨¡å—å®Œæˆå¤šå¸§åˆæˆï¼ˆframe stitchï¼‰åï¼Œæ¥ä¸‹æ¥å°±éœ€è¦å¯¹æ•°æ®ä½å®½è¿›è¡Œå‹ç¼©ä»¥èŠ‚çº¦åç»­æ­¥éª¤çš„è®¡ç®—èµ„æºã€‚æ¯”è¾ƒåˆç†çš„åšæ³•æ˜¯é‡‡å–é€çº§å‹ç¼©ç­–ç•¥ï¼Œæ¯”å¦‚åœ¨ WDR æ¨¡å—å…ˆå‹ç¼©åˆ° 12 ä½ç²¾åº¦ï¼Œç»è¿‡ CCMã€Gamma ç­‰é¢œè‰²å¤„ç†åè¿›ä¸€æ­¥å‹ç¼©åˆ° 10 ä½ç²¾åº¦ï¼Œç»è¿‡ CSC æ¨¡å—åè¿›è¡Œæœ€åä¸€æ¬¡å‹ç¼©å¾—åˆ°æœ€ç»ˆçš„ 8 ä½ç²¾åº¦è¾“å‡ºã€‚</p><p>ä» 16/20 ä½ç²¾åº¦å‹ç¼©åˆ° 12 ä½ç²¾åº¦çš„è¿‡ç¨‹ç§°ä¸ºè‰²è°ƒæ˜ å°„ï¼Œè¿™ä¸€æ­¥éª¤çš„ä¸»è¦ä»»åŠ¡æ˜¯å‹ç¼©å›¾åƒçš„åŠ¨æ€èŒƒå›´ï¼Œå°† HDR å›¾åƒæ˜ å°„åˆ° LDR å›¾åƒï¼Œå¹¶å°½é‡ä¿è¯å›¾åƒç»†èŠ‚ä¸æŸå¤±ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline5.png"></p><p>è‰²è°ƒæ˜ å°„çš„æ–¹æ³•å¤§è‡´åˆ†ä¸ºä¸¤ç±» ï¼Œå³å…¨å±€ç®—æ³•å’Œå±€éƒ¨ç®—æ³•ã€‚</p><h2 id="å…¨å±€ç®—æ³•global-tone-mappinggtm">å…¨å±€ç®—æ³•ï¼ˆGlobal Tone Mappingï¼ŒGTMï¼‰</h2><p>å…¨å±€ç®—æ³•å¯ä»¥ç†è§£ä¸ºæ¯å¹…å›¾åƒæœ‰ä¸€ä¸ªé¢œè‰²æ˜ å°„è¡¨ï¼ŒGTM ç®—æ³•é€šè¿‡æŸ¥è¡¨çš„æ–¹æ³•æŠŠä¸€ä¸ªè¾“å…¥é¢œè‰²æ˜ å°„ä¸ºä¸€ä¸ªè¾“å‡ºé¢œè‰²ã€‚æœ‰äº›ç®—æ³•å¯¹æ‰€æœ‰å›¾åƒéƒ½ä½¿ç”¨å›ºå®šçš„è¡¨ï¼Œæœ‰äº›ç®—æ³•åˆ™æ˜¯é’ˆå¯¹æ¯ä¸€å¸§å›¾åƒåˆ›å»ºä¸åŒçš„è¡¨ã€‚</p><p>GTM ç®—æ³•ç‰¹ç‚¹ ï¼š</p><ul><li>ä»»æ„ç›¸åŒé¢œè‰²çš„åƒç´ ç‚¹ï¼Œåœ¨æ˜ å°„åï¼Œè¿˜æ˜¯ç›¸åŒçš„é¢œè‰²ã€‚</li><li>å…¨å±€ç®—æ³•ä¸€èˆ¬è¾ƒç®€å•ï¼Œé€Ÿåº¦å¿«ã€‚</li><li>å…¨å±€ç®—æ³•çš„æ€§èƒ½ä¸€èˆ¬åŠ£äºå±€éƒ¨æ–¹æ³•ã€‚</li></ul><p>å­˜åœ¨ç®—æ³• ï¼š ç›´æ–¹å›¾å‡è¡¡åŒ–ã€Gammaã€å¯¹æ•°æ ¡æ­£ã€ç›´æ–¹å›¾è§„å®šåŒ–ã€åˆ†æ®µç°åº¦å˜æ¢</p><p>ä¸€ç§åŸºäº Gamma çš„ç®—æ³•å«åš Academy Color Encoding Systemï¼ˆACESï¼‰ï¼Œå®ƒç”±ç¾å›½ç”µå½±è‰ºæœ¯ä¸ç§‘å­¦å­¦ä¼šæå‡ºï¼Œæœ‰äººè®¤ä¸ºè¿™æ˜¯ç›®å‰æœ€å¥½çš„ä¸€ç§ GTM ç®—æ³•ã€‚ACES æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€šç”¨çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œæ—¢å¯ä»¥æŠŠä¸åŒçš„è¾“å…¥è®¾å¤‡è½¬æˆ ACESï¼Œä¹Ÿå¯ä»¥æŠŠ ACES åœ¨ä¸åŒçš„æ˜¾ç¤ºè®¾å¤‡ä¸Šæ­£ç¡®åœ°æ˜¾ç¤ºã€‚ä¸ç®¡æ˜¯ LDR è¿˜æ˜¯ HDR éƒ½å¯ä»¥åœ¨ ACES é‡Œè¡¨è¾¾å‡ºæ¥ã€‚ACES çš„è½¬æ¢æ›²çº¿å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline6.png"></p><h2 id="å±€éƒ¨ç®—æ³•local-tone-mappingltm">å±€éƒ¨ç®—æ³•ï¼ˆLocal Tone Mappingï¼ŒLTMï¼‰</h2><p>äººçœ¼çš„æ„ŸçŸ¥ç‰¹æ€§å…·æœ‰å±€éƒ¨æ€§ç‰¹ç‚¹ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨æ™®é€šäººçœ¼çœ‹æ¥ä¸‹å›¾ä¸­çš„ A è‰²å—çš„äº®åº¦æ˜æ˜¾ä½äº B è‰²å—çš„äº®åº¦ã€‚è€Œäº‹å®çœŸç›¸æ˜¯ï¼Œè¿™ä¸¤ä¸ªè‰²å—çš„çœŸå®åƒç´ äº®åº¦æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œäººçœ¼æ„Ÿè§‰ B æ›´äº®ï¼Œä¸»è¦æ˜¯å› ä¸º B çš„å‘¨å›´æ˜¯æš—è‰²å—ï¼Œè€Œ A çš„å‘¨å›´æ˜¯äº®è‰²å—ï¼Œäººçš„çŸ¥è§‰ç³»ç»Ÿé’ˆå¯¹è¿™ç§åœºæ™¯è‡ªåŠ¨åšäº†å¯¹æ¯”åº¦æå‡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline7.png"></p><p>è¿™ç§ç°è±¡åœ¨æ€»ä½“ä¸Šå¯ä»¥å½’ç»“ä¸ºäººçš„çŸ¥è§‰æ’å¸¸ç‰¹æ€§ï¼Œå…·ä½“åœ°è¯´å°±æ˜¯äº®åº¦æ’å¸¸ç‰¹æ€§ã€‚ä¸‹å›¾æ˜¯å¦å¤–ä¸€ä¸ªäº®åº¦æ’å¸¸çš„ä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‰€æœ‰å°ç°è‰²å—çš„çœŸå®äº®åº¦éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å¦‚æœå‘¨å›´ç¯ç»•çš„é¢œè‰²ä¸åŒï¼Œäººå¯¹ç°è‰²å—çš„é¢œè‰²çŸ¥è§‰ä¹Ÿä¸ç›¸åŒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pipeline8.png"></p><p>å±€éƒ¨ç®—æ³•å€Ÿé‰´äº†äººçœ¼çš„çŸ¥è§‰åŸç†ï¼Œåœ¨æ˜ å°„ä¸€ä¸ªåƒç´ æ—¶ï¼Œä¸ä»…è€ƒè™‘è¯¥åƒç´ çš„ç»å¯¹å€¼ï¼Œè¿˜ä¼šè€ƒè™‘è¯¥åƒç´ å‘¨å›´åŒºåŸŸçš„å¹³å‡äº®åº¦å€¼ï¼Œå°†å¯¹æ¯”åº¦å¤§çš„åƒç´ æ˜ å°„ä¸ºé«˜äº®ï¼Œå¯¹æ¯”åº¦å°çš„åƒç´ æ˜ å°„ä¸ºä½äº®ï¼Œå¾€å¾€å¯ä»¥å–å¾—æ›´å¥½çš„æ•ˆæœã€‚</p><p>LTM ç®—æ³•ç‰¹ç‚¹ ï¼š</p><ul><li>æ˜ å°„å‰é¢œè‰²ç›¸åŒçš„åƒç´ ç‚¹ï¼Œæ˜ å°„åé¢œè‰²å¯èƒ½ä¸åŒã€‚</li><li>å±€éƒ¨ç®—æ³•ä¸€èˆ¬è¾ƒå…¨å±€æ–¹æ³•æ›´å¤æ‚ï¼Œé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚</li><li>å±€éƒ¨ç®—æ³•çš„æ€§èƒ½ä¸€èˆ¬ä¼˜äºå…¨å±€æ–¹æ³•ã€‚</li><li>ä¼šå‡ºç°å…‰æ™•ç­‰ç°è±¡ã€‚</li></ul><p>å­˜åœ¨ç®—æ³• ï¼š åˆ†å—ä¸­å€¼ç›´æ–¹å›¾ï¼ŒåŸºäº Retinex åŸç†çš„ç®—æ³•ç­‰</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85ODgyMDkyNw==">https://zhuanlan.zhihu.com/p/98820927<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zOTc4MTM0MTc=">https://zhuanlan.zhihu.com/p/397813417<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> ISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lens ä¹‹åƒå·®</title>
      <link href="/2023/Camera/CameraLensAberration/"/>
      <url>/2023/Camera/CameraLensAberration/</url>
      
        <content type="html"><![CDATA[<h1 id="å‡ ä½•åƒå·®geometrical-aberration">å‡ ä½•åƒå·®ï¼ˆGeometrical Aberrationï¼‰</h1><p>å‡ ä½•åƒå·®åˆ†æå•æ³¢é•¿å…‰çº¿åœ¨å…‰å­¦ç³»ç»Ÿï¼ˆé€é•œç»„ï¼‰ä¸­ï¼Œç”±äºé€é•œè¡¨é¢ä¸åŒä½ç½®ä¸ŠæŠ˜å…‰èƒ½åŠ›çš„å·®å¼‚é€ æˆçš„æˆåƒé¢ä¸Šï¼Œå…‰ç‚¹ä½ç½®äº§ç”Ÿåç¦»é€ æˆç‰©ã€åƒå…³ç³»ä¸å…±è½­çš„ç°è±¡ã€‚</p><span id="more"></span><h2 id="spherical-aberrationçƒå·®">Spherical aberrationï¼ˆçƒå·®ï¼‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/Aberration1.png"></p><p>å­”å¾„å¢å¤§åï¼Œè½´ä¸Šç‚¹å¤§å…‰çº¿å’Œè¿‘è½´å…‰çº¿åœ¨åƒç©ºé—´ä¸å…‰è½´äº¤ç‚¹ä½ç½®ä¸ä¸€è‡´ï¼Œå¼•èµ·çš„æ•ˆåº”å°±æ˜¯çƒå·®ã€‚</p><p>çƒé¢åƒå·®æ˜¯å‘ç”Ÿåœ¨ç»è¿‡é€é•œæŠ˜å°„æˆ–é¢é•œåå°„çš„å…‰çº¿ï¼Œæ¥è¿‘ä¸­å¿ƒä¸é è¿‘è¾¹ç¼˜çš„å…‰çº¿ä¸èƒ½å°†å½±åƒèšé›†åœ¨ä¸€ä¸ªç‚¹ä¸Šçš„ç°è±¡ã€‚å½“å¹³è¡Œçš„å…‰çº¿ç”±é•œç‰‡çš„è¾¹ç¼˜é€šè¿‡æ—¶ï¼Œå®ƒçš„ç„¦ç‚¹ä½ç½®æ¯”è¾ƒé è¿‘é•œç‰‡ï¼Œè€Œç”±é•œç‰‡çš„ä¸­å¤®é€šè¿‡çš„å…‰çº¿ï¼Œå®ƒçš„ç„¦ç‚¹ä½ç½®åˆ™è¾ƒè¿œç¦»é•œç‰‡ï¼ˆè¿™ç§æ²¿ç€å…‰è½´çš„ç„¦ç‚¹é”™å¼€çš„é‡ï¼Œç§°ä¸ºçºµå‘çƒé¢åƒå·®ï¼‰ã€‚å£å¾„æ„ˆå¤§çš„é•œå¤´ï¼Œè¿™ç§å€¾å‘æ„ˆæ˜æ˜¾ã€‚</p><ul><li>ç„¦ç‚¹éšç¦»è½´é«˜åº¦è€Œæ”¹å˜ã€‚</li><li>çƒå·®æ˜¯çƒé¢é•œçš„æœ¬æ€§ã€‚</li><li>é•œç‰‡ç»„åˆæˆ–éçƒé¢å¯å‡å°‘çƒå·®ã€‚</li></ul><p><strong>çŸ«æ­£</strong></p><ul><li>å‡¹å‡¸é€é•œè¡¥å¿æ³•ï¼šé‡‡ç”¨å¢åŠ é€é•œçš„æ–¹æ³•ï¼Œå¢åŠ å‡¹å‡¸é¢ï¼Œä»è€Œå‡å°çƒå·®çš„å¤§å°ã€‚</li><li>éçƒé¢é€é•œæ ¡æ­£ï¼šåˆ¶ä½œæˆæœ¬é«˜æ˜‚ã€‚</li></ul><h2 id="comaå½—å·®">Comaï¼ˆå½—å·®ï¼‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/Aberration2_1.png"></p><p>å½—å½¢åƒå·®ï¼Œåˆç§°å½—æ˜Ÿåƒå·®ï¼Œè¡¨ç¤ºä¸Šä¸‹å…‰çº¿å…³äºä¸»å…‰çº¿çš„ä¸å¯¹ç§°åº¦ï¼Œå³ï¼š</p><p><span class="math display">\[K_{T}^{'}  = y{'} - \frac{1}{2}(y_{A}^{'} + y_{B}^{'})\]</span></p><ul><li>ç„¦ç‚¹éšç¦»è½´é«˜åº¦è€Œæ”¹å˜ã€‚</li><li>è½´ä¸Šç‰©ç‚¹æ‰€å‘å‡ºå…‰çº¿ä¸ä¼šäº§ç”Ÿå½—å·®ã€‚</li><li>åƒçš„æ¸…æ™°åº¦ï¼Œä½¿æˆåƒçš„è´¨é‡é™ä½ã€‚</li></ul><p><strong>çŸ«æ­£</strong><br>å•ä¸€é€é•œæˆ–é€é•œç³»ç»Ÿçš„å½—å½¢åƒå·®ï¼Œå¯ä»¥ç»ç”±é€‰æ‹©é€‚å½“çš„é€é•œè¡¨é¢æ›²ç‡æœ‰æ•ˆçš„é™ä½ï¼ˆæŸäº›æƒ…å†µä¸‹å¯ä»¥è¢«æ¶ˆé™¤ï¼‰ä»¥åˆäºåº”ç”¨ã€‚ç›®å‰å‰Šå‡å½—å½¢åƒå·®æœ€æ™®éçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨éçƒé¢é•œã€‚ä½¿ç”¨å¯¹ç§°çš„ç»“æ„ï¼Œè¿™ç§æ–¹æ³•ä¸ä»…åªå¯¹å½—å·®æ ¡æ­£ï¼Œå¯¹è±¡æ•£ã€åœºæ›²ã€å’Œç•¸å˜çš„æ ¡æ­£ä½œç”¨ä¹Ÿéå¸¸æœ‰å¸®åŠ©ã€‚</p><h2 id="astigmatismåƒæ•£">Astigmatismï¼ˆåƒæ•£ï¼‰</h2><p>åœ¨æµ‹è¯•é•œå¤´æ—¶å¸¸ä¼šçœ‹ä¸­é—´åŠè¾¹ç¼˜çš„æˆåƒè´¨ç´ ï¼Œå‡ ä¹å¯ä»¥è‚¯å®šï¼Œè¶Šæ¥è¿‘è¾¹ç¼˜çš„å½±åƒè´¨ç´ éƒ½ä¼šä¸‹é™ï¼Œè¿™æ˜¯ç”±äºæ°´å¹³é¢å…‰çº¿å’Œå‚ç›´é¢å…‰çº¿èšç„¦åœ¨ä¸åŒç„¦ç‚¹ä¸Šæ‰€å¼•èµ·ã€‚</p><p>æ ¹æ®ç°ä»£ç‰©ç†å­¦åŸç†ï¼Œå…‰çº¿ä»¥æ³¢åŠ¨èƒ½é‡å½¢å¼ä¼ æ’­ï¼Œè€Œä¸”ç›¸å¯¹å…‰çº¿çš„ä¼ æ’­æ–¹å‘ï¼Œå…‰æ³¢éœ‡åŠ¨çš„æ–¹å‘æ˜¯å››æ–¹å…«é¢çš„ã€‚å¦‚æœç”¨å‘é‡ï¼ˆVectorï¼‰æ–¹å¼ç†è§£ï¼Œä¸€æŸå…‰çº¿å¯åˆ†ä¸ºæ°´å¹³æ–¹å‘éœ‡åŠ¨å’Œå‚ç›´çº¿æ–¹å‘éœ‡åŠ¨ä¸¤éƒ¨åˆ†ã€‚å½“å…‰çº¿ä»åç¦»ä¸­è½´çš„æ–œè§’åº¦å°„å…¥ï¼Œæœ‰æœºä¼šå‡ºç°æ°´å¹³é¢å…‰çº¿å’Œå‚ç›´é¢å…‰çº¿èšç„¦åœ¨ä¸»è½´ä¸åŒä½ç½®çš„è¯¯å·®ã€‚ä¸¤ä¸ªç„¦ç‚¹ä¹‹é—´æ‰€äº§ç”Ÿçš„å½±åƒä¼šå˜å¾—æ¨¡ç³Šï¼Œè¾¹ç¼˜åƒæ¸—å¼€ä¸€æ ·ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/Aberration3.jpg"></p><p>åç¦»ä¸­è½´è¿›å…¥é•œç‰‡çš„å…‰çº¿å¯åˆ†ä¸ºæ°´å¹³é¢å…‰çº¿ï¼ˆæ©™è‰²ï¼‰å’Œå‚ç›´é¢å…‰çº¿ï¼ˆç»¿è‰²ï¼‰ ï¼Œå„è‡ªçš„ç„¦ç‚¹å´åœ¨ä¸åŒä½ç½®ã€‚</p><ul><li>å…‰çº¿éå¯¹ç§°å°„å…¥é€é•œã€‚</li><li>å¹³è¡Œå’Œå‚ç›´é¢ä¸Šçš„ç„¦ç‚¹ä¸åŒã€‚</li><li>å­åˆèšç„¦é¢å’Œå¼§çŸ¢èšç„¦é¢é—´è·æ„ˆé•¿åƒæ•£æ„ˆä¸¥é‡ã€‚</li><li>åƒæ•£ä»…ä¸å…‰å­¦ç³»ç»Ÿçš„è§†åœºæœ‰å…³ï¼Œè§†åœºè¶Šå¤§ï¼Œåƒæ•£ç°è±¡è¶Šæ˜æ˜¾ã€‚</li><li>è‹¥æ˜¯å‘å…‰ç‚¹åœ¨é½æ˜ç‚¹æˆ–æ˜¯çƒå¿ƒä½ç½®ï¼Œæ— åƒæ•£ã€‚</li></ul><p><strong>çŸ«æ­£</strong></p><ul><li>å°†é•œå¤´æˆåƒåœˆè¦†ç›–çš„èŒƒå›´åŠ å¤§ï¼Œä½¿æˆåƒåœˆä¸­å¤®éƒ¨åˆ†è¦†ç›–æ„Ÿå…‰å…ƒä»¶ã€‚</li><li>é€‚å½“ç¼©å°é•œå¤´å…‰åœˆã€‚</li></ul><h2 id="petzral-curvaturefield-curvatureåœºæ›²">Petzral curvature/field curvatureï¼ˆåœºæ›²ï¼‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration4.png"></p><p>åƒåœºå¼¯æ›²ï¼Œç®€ç§°åœºæ›²ï¼Œæ˜¯å› é•œç‰‡ç¼ºé™·ï¼Œä½¿å‚ç›´äºä¸»å…‰è½´çš„ç‰©å¹³é¢ä¸Šå‘å‡ºçš„å…‰ç»é€é•œæˆåƒåï¼Œæ¸…æ™°çš„æœ€ä½³å®åƒé¢ä¸æ˜¯å¹³é¢è€Œæ˜¯ä¸€ä¸ªæ›²é¢çš„ä¸€ç§åƒå·®ã€‚1839 å¹´åŒˆç‰™åˆ©ç‰©ç†å­¦å®¶çº¦ç‘Ÿå¤«Â·ä½©å…¹ç“¦å°”ï¼ˆè‹±è¯­ï¼šJoseph Petzvalï¼‰æœ€å…ˆä»ç‰©ç†å­¦è§’åº¦é˜æ˜åƒåœºå¼¯æ›²çš„åŸç†ï¼Œä¸ºçºªå¿µä»–ï¼Œåƒåœºå¼¯æ›²ä¹Ÿç§°ä¸ºä½©å…¹ç“¦å°”åƒåœºå¼¯æ›²ã€‚</p><p>å½“ä¸€ç³»ç»Ÿçš„çƒå·®ã€æ…§å·®ã€åƒæ•£éƒ½ä¿®æ­£ä¸ºé›¶æ—¶ï¼Œç³»ç»Ÿç”±ä¸åŒè§’åº¦å…¥å°„æ‰€çœ‹åˆ°çš„ç„¦è·çš†ç›¸åŒï¼Œå› æ­¤æˆåƒé¢éå¹³å¦ï¼Œè€Œæ˜¯ä¸€å¼¯æ›²é¢ï¼Œç›¸å¯¹äºä¸€ä¸ªå¹³é¢çš„æ„Ÿå…‰å…ƒä»¶ï¼Œåˆ™ä¼šæ”¶åˆ°ä¸­é—´èšç„¦è€Œå‘¨å›´å¤±ç„¦ï¼Œå‘¨å›´èšç„¦ä¸­é—´å¤±ç„¦çš„å½±åƒã€‚</p><p>æ›²é¢æˆåƒé¢ä¼šä¸¥é‡å½±å“æ¥æ”¶é¢ä¸Šæˆåƒæ¸…æ™°åº¦ï¼Œä¼šé€ æˆæˆåƒçš„å±€éƒ¨æ¸…æ™°ã€å±€éƒ¨æ¨¡ç³Šçš„çŠ¶å†µã€‚ å¹¿è§’ã€é±¼çœ¼é•œå¤´ä¸»è¦ç›¸å·®ä¸ºåœºæ›²ï¼Œè€Œåœ¨é’ˆå¯¹åœºæ›²æ ¡æ­£çš„å¤§éƒ¨åˆ†ä¸“åˆ©ä¸­ï¼Œé€šå¸¸ä¹Ÿä¼šä¼´éšç€å¦ä¸€ç§åƒå·®çš„äº§ç”Ÿï¼šç•¸å˜ã€‚</p><p><strong>çŸ«æ­£</strong></p><ul><li>åˆ©ç”¨æ•£å…‰æ¥éƒ¨åˆ†æŠµæ¶ˆåƒåœºå¼¯æ›²ï¼›åä¹ä¸–çºªä¸­å¶çš„ä¸€äº›é•œå¤´å¤šç”¨æ­¤æ³•ï¼›ï¼ˆè¿‘ä»£ 24X36 æ¯«ç±³ç›¸æœºé•œå¤´ä¹Ÿç”¨æ­¤æ³•ï¼‰ã€‚</li><li>åˆ©ç”¨åšå¼¯æœˆå½¢é•œç‰‡ç»„ï¼Œå…¶ä¸¤ä¸ªå¤–é•œé¢çš„æ›²ç‡åŠå¾„å¤§æŠµç›¸åŒã€‚</li><li>åˆ©ç”¨ä¸€ç³»åˆ—äº’ç›¸éš”å¼€è¾ƒå¤§è·ç¦»çš„æ­£ã€è´Ÿé•œç‰‡ï¼Œä¸ºä½¿å…¶æ¶ˆè‰²å·®ï¼ŒåŠ¡å¿…å¤§å¤§åŠ å¼ºè´Ÿé•œç‰‡çš„åº¦æ•°ï¼Œè¿™å°±è‡ªç„¶å‡å°‘ä½©å…¹ç“¦å°”å’Œã€‚</li></ul><h2 id="distortionç•¸å˜">Distortionï¼ˆç•¸å˜ï¼‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration5.png"></p><p>ç”±ç†æƒ³å…‰å­¦ç³»ç»Ÿå¯¼å‡ºçš„ç†æƒ³åƒé«˜ <span class="math inline">\(\eta{'}\)</span> ä¸å®é™…ä¸»å…‰çº¿é«˜åº¦ <span class="math inline">\(y{'}\)</span> çš„å·®ç§°ä¸ºç•¸å˜ï¼ˆDistortionï¼‰ å¸¸ç”¨çš„æ˜¯ç›¸å¯¹ç•¸å˜ï¼š</p><p><span class="math display">\[DT = \frac{\eta{'} - y{'}}{\eta{'}} \times 100 \%\]</span></p><p>åœ¨ç›®è§†ç³»ç»Ÿä¸­ï¼Œå°äº 3%çš„ç•¸å˜ä¸æ˜“è§‰å¯Ÿï¼Œä½†æœºå™¨è§†è§‰å¯¹ç•¸å˜çš„è¦æ±‚æ¯”è¾ƒé«˜ã€‚</p><p>ç•¸å˜æŒ‰å…¶æ–¹å‘å¯åˆ†ä¸ºæ¡¶å½¢ç•¸å˜å’Œæ•å½¢ç•¸å˜ã€‚åœ¨æ‘„å½±ä¸­ï¼Œä¸€èˆ¬è®¤ä¸ºå¹¿è§’é•œå¤´å®¹æ˜“äº§ç”Ÿæ¡¶å½¢ç•¸å˜ï¼Œè€Œé•¿ç„¦é•œå¤´å®¹æ˜“äº§ç”Ÿæ•å½¢ç•¸å˜ã€‚</p><p><strong>åŒºåˆ†åœºæ›²å’Œç•¸å˜ï¼š</strong><br>å¯¹äºåœºæ›²æ¥è¯´ï¼Œå¦‚æœåƒé¢ä½äºè¿‘è½´ç„¦å¹³é¢ï¼Œåˆ™æ¨¡æ‹Ÿå¾—åˆ°çš„å›¾åƒä¸­å¿ƒåŒºåŸŸéå¸¸æ¸…æ™°ï¼Œè¾¹ç¼˜å¾ˆæ¨¡ç³Šï¼Œå¦‚æœå°†åƒé¢ç½®äºè¾¹ç¼˜è§†åœºç„¦ç‚¹å¤„ï¼Œå¯å¾—åˆ°è¾¹ç¼˜åŒºåŸŸéå¸¸æ¸…æ™°ï¼Œä¸­å¿ƒåŒºåŸŸæ¯”è¾ƒæ¨¡ç³Šçš„å›¾åƒã€‚å¯¹äºç•¸å˜æ¥è¯´ï¼Œè¾¹ç¼˜å’Œä¸­å¿ƒéƒ½å¾ˆæ¸…æ™°ï¼Œåªæ”¹å˜åƒçš„å½¢çŠ¶ã€‚</p><h1 id="è‰²æ•£åƒå·®chromatic-aberration">è‰²æ•£åƒå·®ï¼ˆChromatic Aberrationï¼‰</h1><p>åˆ†æçš„æ˜¯ç”±äºä¸åŒæ³¢é•¿çš„å…‰åœ¨é€é•œä»‹è´¨ä¸­çš„æŠ˜å°„ç‡ä¸åŒï¼Œé€ æˆæˆåƒé¢ä¸Šå…‰ç‚¹ä½ç½®äº§ç”Ÿåç¦»é€ æˆç‰©ã€åƒå…³ç³»ä¸å…±è½­çš„ç°è±¡ã€‚</p><h2 id="axial-colorè½´å‘è‰²å·®">Axial colorï¼ˆè½´å‘è‰²å·®ï¼‰</h2><p>è½´å‘è‰²å·®ï¼ŒæŒ‡ä¸åŒæ³¢é•¿çš„å…‰æŸé€šè¿‡é€é•œåç„¦ç‚¹ä½äºæ²¿è½´ä¸åŒä½ç½®ï¼Œå› ä¸ºå®ƒçš„å½¢æˆåŸå› åŒçƒå·®ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration6.png"></p><p>ç”±å¹³è¡Œå…‰çº¿äº§ç”Ÿçš„è‰²å·®ã€‚</p><h2 id="lateral-coloræ¨ªå‘è‰²å·®">Lateral colorï¼ˆæ¨ªå‘è‰²å·®ï¼‰</h2><p>æ–œå…‰çº¿äº§ç”Ÿçš„è‰²å·®ç§°æ”¾å¤§ç‡è‰²å·®ï¼ˆtransverse chromatic aberrationï¼‰ï¼Œåˆç§°å€ç‡è‰²å·®æˆ–æ¨ªå‘è‰²å·®ã€‚æ–œå…‰çº¿è¿›å…¥é•œå¤´ï¼Œå³ä½¿å‡è®¾è½´å‘è‰²å·®ä¸ºé›¶ï¼Œç”±äºè‰²å…‰ï¼ˆä¸åŒæ³¢é•¿çš„å…‰çº¿ï¼‰å½¢æˆçš„åƒå¤§å°ï¼ˆæ”¾å¤§ç‡ï¼‰ä¸åŒï¼Œè€Œäº§ç”Ÿçš„ç„¦ç‚¹ä¸ä¸€è‡´çš„ç°è±¡ã€‚ç”±äºæ³¢é•¿çš„ä¸åŒï¼Œåƒçš„å¤§å°å·®å¼‚ï¼Œåœ¨å½±åƒä¸Šäº§ç”Ÿè‰²çš„é”™ä½ï¼Œè¿™ç§é”™ä½ç§°æ”¾å¤§ç‡è‰²å·®ã€‚æ–œå…‰çº¿å³ä½¿é€šè¿‡çš„å…‰åœˆå­”å¾„ç¼©æˆå¾ˆå°çš„å…‰åœˆï¼Œæ”¾å¤§ç‡è‰²å·®ä¹Ÿä¸ä¼šå‡å°‘ã€‚</p><p>ç”±äºä¸åŒå…‰çº¿æ³¢é•¿çš„æŠ˜å°„ç‡ä¸åŒï¼Œå¯¼è‡´åƒå¹³é¢ä¸Šä¸åŒé¢œè‰²æ³¢é•¿çš„å…‰çº¿äº§ç”Ÿæ¨ªå‘è‰²æ•£ï¼Œå³ä¸åŒé¢œè‰²æœ‰ä¸åŒçš„æ”¾å¤§å€ç‡ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration9.png"></p><p>ä¸åŒäºçºµå‘è‰²å·®ï¼Œæ¨ªå‘è‰²å·®ä¸ä¼šå‡ºç°åœ¨å›¾åƒä¸­é—´ï¼Œä¸€èˆ¬å‡ºç°åœ¨å›¾åƒè¾¹ç¼˜é«˜å¯¹æ¯”åº¦çš„åŒºåŸŸã€‚é±¼çœ¼ã€å¹¿è§’å’Œä½è´¨é‡çš„é•œå¤´ç»å¸¸å‡ºç°è“ç´«è¾¹ç°è±¡ã€‚</p><h2 id="çŸ«æ­£">çŸ«æ­£</h2><ul><li><p>æŠµæ¶ˆè‰²æ•£å±æ€§çš„è¡å°„å…‰å­¦å™¨ä»¶å¯ä»¥ç”¨æ¥çŸ«æ­£è‰²å·® <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration7.png"></p></li><li><p>èƒ¶åˆé€é•œ Cemented achromat <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration8.png"></p></li><li><p>ç©ºæ°”å±‚åŒé€é•œ Air-spaced Achromate <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/aberration10.png"></p></li><li><p>å›¾åƒå¤„ç†ä¸­çš„æ¶ˆè‰²å·® æ¶ˆè‰²å·®çš„æ–¹æ³•é€šå¸¸ä¸ºç¼©æ”¾è¾¹ç¼˜é¢œè‰²é€šé“ï¼Œæˆ–å‡å»éƒ¨åˆ†ç¼©æ”¾åçš„è¾¹ç¼˜é€šé“ã€‚</p></li></ul><h1 id="æœ€å">æœ€å</h1><p>å½“ç„¶è¿˜æœ‰å¦å¤–ä¸€ç§åˆ†ç±»æ–¹æ³•ï¼šè½´ä¸Šåƒå·®ä¸è½´å¤–åƒå·®ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€Šè¿‘ä»£å…‰å­¦ç³»ç»Ÿè®¾è®¡æ¦‚è®ºã€‹ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLWhhbnMvJUU1JUJEJTk3JUU1JUJEJUEyJUU1JTgzJThGJUU1JUI3JUFF">https://www.wikiwand.com/zh-hans/%E5%BD%97%E5%BD%A2%E5%83%8F%E5%B7%AE<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLyVFNCVCRCVBOSVFNSU4NSVCOSVFNyU5MyVBNiVFNSVCMCU5NCVFNSU4MyU4RiVFNSU5QyVCQSVFNSVCQyVBRiVFNiU5QiVCMg==">https://www.wikiwand.com/zh/%E4%BD%A9%E5%85%B9%E7%93%A6%E5%B0%94%E5%83%8F%E5%9C%BA%E5%BC%AF%E6%9B%B2<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTk2NTI5MjU=">https://zhuanlan.zhihu.com/p/359652925<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLyVFNyU5NSVCOCVFOCVBRSU4QQ==">https://www.wikiwand.com/zh/%E7%95%B8%E8%AE%8A<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuZGNmZXZlci5jb20vbmV3cy92aWV3Z2xvc3NhcnkucGhwP2dsb3NzYXJ5X2lkPTQ3">https://www.dcfever.com/news/viewglossary.php?glossary_id=47<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9rYi5jb2xvcnNwYWNlLmNvbS5jbi9rYi8yMDIyLzA3LzE4LyVFNiVBOCVBQSVFNSU5MCU5MSVFOCU4OSVCMiVFNSVCNyVBRS8=">https://kb.colorspace.com.cn/kb/2022/07/18/%E6%A8%AA%E5%90%91%E8%89%B2%E5%B7%AE/<i class="fa fa-external-link-alt"></i></span><br>ã€Šè¿‘ä»£å…‰å­¦ç³»ç»Ÿè®¾è®¡æ¦‚è®ºã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Lens </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Lens </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lens ä¹‹ Vignetting</title>
      <link href="/2023/Camera/CameraLensVignetting/"/>
      <url>/2023/Camera/CameraLensVignetting/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªç„¶æš—è§’">è‡ªç„¶æš—è§’</h1><h2 id="åŸå› ">åŸå› </h2><p>å¯¹ç€äº®åº¦å‡åŒ€çš„æ™¯ç‰©ï¼Œå›¾åƒç”»é¢å››è§’æœ‰å˜æš—çš„ç°è±¡ï¼Œå«åšå¤±å…‰æˆ–æš—è§’ï¼ˆVignettingï¼‰ã€‚æš—è§’å¯¹äºä»»ä½•é•œå¤´éƒ½ä¸å¯é¿å…ï¼Œè¿™æ˜¯ç”±äºé•œå¤´å¯¹äºå…‰å­¦æŠ˜å°„ä¸å‡åŒ€é€ æˆçš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens20.png"></p><p><span class="math display">\[I_{A'} = \cos_{\alpha }^{4} I_{o'}\]</span></p><span id="more"></span><p>å…¶ä¸­ <span class="math inline">\(\alpha \equiv chief - ray - angle \equiv CRA\)</span> å³ä¸»å…‰çº¿è§’åº¦ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCRA é€šå¸¸é€‚ç”¨äº CMOS æˆ– CCD ä¹‹ç±»çš„ç”µå­å…ƒä»¶ï¼Œå¯¹äºä¼ ç»Ÿçš„èƒ¶ç‰‡åº•ç‰‡ä¸å¤ªå—æ­¤å‚æ•°å½±å“ï¼Œé€šå¸¸å…‰å­¦é•œå¤´ä¸­ï¼Œ $CRA20^{} $ ã€‚ å…¶ä¸­ç›¸å¯¹ç…§åº¦ï¼š</p><p><span class="math display">\[RI = \frac{I_{A'}}{I_{o'}} \]</span></p><p>è¿™æ˜¯ç”±äºå…‰çº¿å‡ºç³åï¼Œè½´ä¸Šä¸»å…‰çº¿åˆ°æˆåƒé¢çš„è·ç¦»çŸ­äºç¦»è½´ä¸»å…‰çº¿åˆ°æˆåƒé¢çš„è·ç¦»ï¼Œå¯¼è‡´åœ¨æˆåƒé¢ä¸Šä¸åŒä½ç½®å…‰çº¿å‘ˆç°å‡ºç›¸åº”çš„å¼ºåº¦è¡°å‡ï¼Œåœ¨æˆåƒé¢ä¸Šï¼Œä¼šå‡ºç°ä¸­é—´äº®å››å‘¨æš—çš„ç°è±¡ï¼Œç§°ä¹‹ä¸ºæš—è§’ï¼ˆè‡ªç„¶æš—è§’ï¼‰ä¸åŒè§†åœºçš„ç›¸å¯¹ç…§åº¦ï¼Œå³æ˜¯è¡¡é‡æš—è§’å¤§å°çš„å‚æ•°ã€‚åœ¨ç›¸åŒçš„ç‰©é¢äº®åº¦ä¸‹ï¼Œé€šè¿‡ RI ä¸è§†åœºè§’çš„å…³ç³»ï¼Œå³å¯å¯¹æˆåƒç›¸å¯¹ç…§åº¦è¿›è¡Œè¯„ä¼°ï¼Œå³ $RI - $ å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens21.png"></p><h2 id="è§£å†³">è§£å†³</h2><p>å¯ä»¥é€šè¿‡ Autoshading åŠŸèƒ½åœ¨ CCD æˆ–è€… CMOS ä¸­è°ƒæ•´ä¸åŒåƒç´ ä¿¡å·çš„å¢ç›Šå€¼ï¼Œå°†å‡åŒ€å…‰å¼ºç‰©é¢äº§ç”Ÿçš„å…‰å¼ºä¿¡å·åˆ†å¸ƒé€šè¿‡è°ƒæ•´ä¸åŒåƒç´ çš„å¢ç›Šå€¼ï¼Œæ ¡æ­£è‡³å‡åŒ€åˆ†å¸ƒçš„çŠ¶æ€ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ¶ˆé™¤è‡ªç„¶æš—è§’ã€‚ä»£ä»·å°±æ˜¯ï¼Œä¿¡å™ªæ¯”ç¨å¾®é™ä½æ‚ä¿¡å·å¢åŠ ã€‚æ‰€ä»¥åœ¨ Sensor çš„ datasheet ä¸­ï¼Œä¼šæœ‰ä¸»å…‰çº¿è§’ CRA ä¸å¾—å¤§äºæŸé¢„è®¾å€¼çš„å®šä¹‰ï¼Œé¿å…ç›¸å¯¹ç…§åº¦ RI è¶…è¿‡å¯è°ƒæ•´æ ¡æ­£çš„èŒƒå›´ã€‚</p><p>å½“ç„¶è¿˜æœ‰å°±æ˜¯ sensor å’Œé•œå¤´çš„ CRA éœ€è¦åŒ¹é…ã€‚</p><h1 id="å…‰å­¦æš—è§’">å…‰å­¦æš—è§’</h1><p>åœ¨å…‰å­¦ç³»ç»Ÿä¼˜åŒ–ä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens22.png"></p><p>å¦‚çº¢è‰²æ–¹æ¡†åœˆå‡ºæ¥çš„å…‰ç³ä½ç½®ï¼Œè½´ä¸Šè§†åœºï¼ˆ0Â°ï¼‰çš„ä¸»å…‰çº¿ã€è¾¹ç¼˜å…‰çº¿å¯ä»¥å¡«å……æ»¡æ•´ä¸ªå…‰ç³ï¼Œè€Œç¦»è½´è§’åº¦çš„è§†åœºï¼ˆ&gt;0Â°ï¼‰ï¼Œåˆ™ä¼šå‡ºç°è¾¹ç¼˜å…‰çº¿æ— æ³•å¡«æ»¡æ•´ä¸ªå…‰ç³çš„ç°è±¡ã€‚æˆ‘ä»¬å°†ç¦»è½´å…‰çº¿ç•¥å¾®å‘å…‰ç³è¾¹ç¼˜å¹³ç§»ä¸€ä¸‹ï¼Œå°±å¯å‘ç°è¿™æ˜¯ä¸ºä»€ä¹ˆï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens23.png"></p><p>ç”±äºç¦»è½´çš„ç‰©ç‚¹å‘å‡ºçš„å…‰çº¿è¶…å‡ºé•œç‰‡è¾¹ç¼˜çš„éƒ¨åˆ†ä¸è¢«ç³»ç»Ÿæ‰€æ¥æ”¶ï¼Œå³è¾¹ç¼˜å…‰çº¿å—é•œç‰‡å¤§å°æ‰€é™ä½¿è¯¥è§†åœºçš„å…‰çº¿æœªå æ»¡å…‰åœˆã€å…‰åœˆæ²¡æœ‰è¢«å……åˆ†åˆ©ç”¨ï¼Œä»è€Œé€ æˆè¯¥è§†åœºå…‰å¼ºå˜ä½ã€‚åæ˜ åœ¨å½±åƒä¸Šï¼Œå°±æ˜¯è¯¥è§†åœºæˆåƒçš„å…‰çº¿æ•°é‡å°‘ã€é€ æˆåƒç‚¹çš„å…‰å¼ºåä½ï¼Œäº§ç”Ÿå…‰å­¦æš—è§’ã€‚å…‰å­¦æš—è§’çš„æ•°å€¼å¤§å°ç”±ä¸»å…‰çº¿è§’åº¦ CRAï¼ˆè§†åœºè§’ï¼‰ä¸ç¦»è½´è¾¹ç¼˜è§†åœºçš„å…‰ç³ç›´å¾„ä¹‹æ¯”å®šä¹‰ï¼ˆç­‰æ•ˆäºè½´ä¸Šè§†åœºä¸è½´å¤–è§†åœºå‚ä¸æˆåƒçš„å…‰çº¿æ•°é‡ä¹‹æ¯”ï¼‰ï¼š</p><p><span class="math display">\[Optical Vignetting = \frac{D_{margin}}{D_{center}}  = \frac{D_{\alpha  = 0}}{D_{\alpha _{Max}}} \]</span></p><p>Optical Vignetting=80%æŒ‡ç¦»è½´ç‰©ç‚¹å¯¹å…‰åœˆçš„åˆ©ç”¨ç‡åªæœ‰ 80%ï¼Œ20%æ²¡æœ‰è¢«åˆ©ç”¨ã€‚å…‰å­¦æš—è§’å¤§å°æ˜¯å¯ä»¥é€šè¿‡æ§åˆ¶å…‰ç³/å…‰åœˆå¤§å°ã€é€é•œç›´å¾„å¤§å°è¿›è¡Œäººä¸ºè®¾è®¡ã€æ§åˆ¶ã€‚</p><p>ç»¼åˆè¿™ä¸¤ç±»æš—è§’å½±å“ï¼Œæè¿°å…‰å­¦ç³»ç»Ÿæˆåƒæ€»ä½“æš—è§’çš„å‚æ•°å¯ä»¥å®šä¹‰ä¸ºï¼Œè‡ªç„¶æš—è§’ä¸å…‰å­¦æš—è§’ç›¸ä¹˜ï¼š</p><p><span class="math display">\[Vignetting = RI \times Optical Vignetting = \frac{I_{A'}}{I_{O'}}  \frac{D_{\alpha _{Max}}}{D_{\alpha  = 0}}  = (cos^4 \alpha_{Max}) \frac{D_{\alpha _{Max}}}{D_{\alpha  = 0}} \]</span></p><h1 id="äººå·¥æš—è§’">äººå·¥æš—è§’</h1><p>åœ¨ä»¥é‡æµ‹ä¸ºç›®çš„çš„å…‰å­¦æˆåƒç³»ç»Ÿä¸­ï¼ŒæŸç§ç¨‹åº¦ä¸Šæš—è§’æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°ï¼Œå¯ä»¥å½’ç±»ä¸ºæˆåƒç¼ºé™·ã€‚ä½†æ˜¯ç»å¸¸å‡ºç°å…‰åœ¨è¾¹ç¼˜å¤„ç”±äºæ–¯æ¶…è€³å®šå¾‹çš„å‡ ä½•å…‰å­¦å› ç´ äº§ç”Ÿè¾¹ç¼˜è§†åœºä¸Šçš„åƒå·®ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens24.png"></p><p>ä»¥åŠåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œè¾¹ç¼˜å¤„çš„åƒå·®å‘ˆå‘æ•£å¼ã€ä¸æ”¶æ•›çš„çŠ¶å†µï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens25.png"></p><p>ä¸ºæ¶ˆå‡è¿™éƒ¨åˆ†åƒå·®å¯¹æˆåƒçš„å½±å“ï¼Œè¿™æ—¶å¯ä»¥é€‰æ‹©é€šè¿‡å°†é•œç‰‡åšå°çš„æ–¹å¼æ•…æ„äº§ç”Ÿäººå·¥æš—è§’ï¼Œå¼ºè¡Œåˆ‡å»éƒ¨åˆ†è¾¹ç¼˜å…‰çº¿ï¼Œç”¨ä»¥æ¶ˆå‡è¾¹ç¼˜å…‰çº¿äº§ç”Ÿçš„åƒå·®ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNjUzNjM5NDU=">https://zhuanlan.zhihu.com/p/365363945<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Lens </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Lens </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lens ä¹‹å…‰å­¦åŸºç¡€</title>
      <link href="/2023/Camera/CameraLensOpticalBasics/"/>
      <url>/2023/Camera/CameraLensOpticalBasics/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>å…‰å­¦ç³»ç»Ÿå¤§çš„åˆ†ç±»ï¼š</p><ul><li>å‡ ä½•å…‰å­¦ -&gt; å…‰çº¿ï¼ˆåƒç£åœºçº¿ä¸€æ ·ï¼Œå…¶å®ä¸å­˜åœ¨ä¸ºäº†æ›´å¥½çš„ç ”ç©¶å…¶å®è§‚ç‰¹æ€§è€Œäººä¸ºè®¾è®¡å‡ºæ¥çš„ï¼‰ã€‚</li><li>ç‰©ç†å…‰å­¦ -&gt; å…‰æ³¢ ï¼ˆåˆ†æå…‰çš„æ³¢å‡½æ•°ï¼‰ã€‚</li><li>é‡å­å…‰å­¦ -&gt; å…‰å­ ï¼ˆem...ï¼‰ã€‚</li></ul><span id="more"></span><h1 id="æŠ˜å°„ç³»æ•°-index-of-refraction">æŠ˜å°„ç³»æ•° (index of refraction)</h1><p>åœ¨å‡ ä½•å…‰å­¦çš„æ¨¡å‹ä¸­ï¼Œææ–™çš„å…‰å­¦æ€§è´¨æ˜¯ç”±ææ–™çš„æŠ˜å°„ç³»æ•°ç¡®å®šçš„ï¼Œæˆ‘ä»¬ç”¨å­—æ¯ n æ¥ä»£è¡¨æŠ˜å°„ç³»æ•°ã€‚n æ˜¯ä¸€ä¸ªå…³äºæ³¢é•¿ <span class="math inline">\(\lambda\)</span>çš„å‡½æ•°ï¼Œä¸åŒæ³¢é•¿çš„ n ä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è‰²æ•£ (dispersion)ã€‚</p><p>æŠ˜å°„ç³»æ•°ä¸å…‰é€Ÿçš„å…³ç³»ä¸ºï¼š</p><p><span class="math display">\[n = \frac{çœŸç©ºä¸­å…‰é€Ÿ}{ä»‹è´¨ä¸­å…‰é€Ÿ} = \frac{c}{v}  \]</span></p><p>å‰æï¼š</p><ul><li>ä»‹è´¨æ˜¯å‡åŒ€çš„ (homogenous)ï¼Œå³ n åœ¨ä»‹è´¨ä»»æ„ä¸€ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li><li>ä»‹è´¨æ˜¯å„å‘åŒæ€§çš„ (isotropic)ï¼Œå³ n åœ¨å…‰ä¼ æ’­çš„ä»»ä½•æ–¹å‘éƒ½æ˜¯ç›¸åŒçš„ã€‚</li></ul><p>å› ä¸º <span class="math inline">\(v = \frac{c}{n}\)</span>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…‰ä» A ä¼ æ’­åˆ° B æ‰€éœ€çš„æ—¶é—´å†™æˆï¼š</p><p><span class="math display">\[t_{AB} = \int_{A}^{B} \frac{ds}{v} = \frac{1}{c}  \int_{A}^{B}n \cdot ds\]</span></p><p>æˆ‘ä»¬å¯ä»¥æŠŠ <span class="math inline">\(\int n \cdot ds\)</span> ç§°ä½œå…‰ç¨‹é•¿åº¦ (optical path length), å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç‚¹å…‰æºï¼ˆé¢ç§¯æ— é™å°çš„ç†æƒ³åŒ–å…‰æºï¼‰ï¼Œå¦‚æœæœ‰ä¸€è¡¨é¢æ»¡è¶³ç­‰å…‰ç¨‹é•¿åº¦ï¼ˆä¼ æ’­æ—¶é—´éƒ½ç›¸ç­‰ï¼‰ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸€è¡¨é¢ç§°ä½œå‡ ä½•æ³¢å‰ (geometrical wavefront)ã€‚åœ¨ä¸€ä¸ª n æ˜¯æ’å®šçš„ä»‹è´¨é‡Œï¼Œå¦‚æœæ»¡è¶³åˆšåˆšè¯´çš„ç­‰å…‰ç¨‹é•¿åº¦çš„æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ³¢å‰å°±æ˜¯ä¸€ä¸ªçƒå½¢æ³¢å‰ (spherical wavefront)ã€‚</p><h1 id="è´¹é©¬åŸç†-fermats-principle">è´¹é©¬åŸç† (Fermat's Principle)</h1><p>è´¹é©¬åŸç†ï¼ˆFermat's principleï¼‰æœ€æ—©ç”±æ³•å›½ç§‘å­¦å®¶çš®åŸƒå°”Â·å¾·Â·è´¹é©¬åœ¨ 1662 å¹´æå‡ºï¼šå…‰ä¼ æ’­çš„è·¯å¾„æ˜¯å…‰ç¨‹å–æå€¼çš„è·¯å¾„ã€‚è¿™ä¸ªæå€¼å¯èƒ½æ˜¯æå¤§å€¼ã€æå°å€¼æˆ–å‡½æ•°çš„æ‹ç‚¹ã€‚ æœ€åˆæå‡ºæ—¶ï¼Œåˆåâ€œæœ€çŸ­æ—¶é—´åŸç†â€ï¼šå…‰çº¿ä¼ æ’­çš„è·¯å¾„æ˜¯éœ€æ—¶æœ€å°‘çš„è·¯å¾„ã€‚ è´¹é©¬åŸç†æ›´æ­£ç¡®çš„ç§°è°“åº”æ˜¯â€œå¹³ç¨³æ—¶é—´åŸç†â€ï¼šå…‰æ²¿ç€æ‰€éœ€æ—¶é—´ä¸ºå¹³ç¨³çš„è·¯å¾„ä¼ æ’­ã€‚å¹³ç¨³æ˜¯æ•°å­¦ä¸Šçš„å¾®åˆ†æ¦‚å¿µï¼Œå¯ä»¥ç†è§£ä¸ºä¸€é˜¶å¯¼æ•°ä¸ºé›¶ï¼Œå®ƒå¯ä»¥æ˜¯æå¤§å€¼ã€æå°å€¼ç”šè‡³æ˜¯æ‹ç‚¹ã€‚ è´¹é©¬åŸç†æ˜¯å‡ ä½•å…‰å­¦çš„åŸºæœ¬å®šç†ã€‚ç”¨å¾®åˆ†æˆ–å˜åˆ†æ³•å¯ä»¥ä»è´¹é©¬åŸç†å¯¼å‡ºä»¥ä¸‹ä¸‰ä¸ªå‡ ä½•å…‰å­¦å®šå¾‹ï¼š</p><ul><li>å…‰çº¿åœ¨çœŸç©ºä¸­çš„ç›´çº¿ä¼ æ’­ã€‚</li><li>å…‰çš„åå°„å®šå¾‹ - å…‰çº¿åœ¨ç•Œé¢ä¸Šçš„åå°„ï¼Œ å…¥å°„è§’å¿…é¡»ç­‰äºå‡ºå°„è§’ã€‚</li><li>å…‰çš„æŠ˜å°„å®šå¾‹ï¼ˆæ–¯æ¶…å°”å®šå¾‹ï¼‰ã€‚</li></ul><h1 id="æ–¯æ¶…å°”å®šå¾‹-snells-law">æ–¯æ¶…å°”å®šå¾‹ (Snell's Law)</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/Snell.png"></p><p>æˆåƒå…¬å¼ï¼Œå³é€é•œæˆåƒå…¬å¼ã€é«˜æ–¯æˆåƒå…¬å¼ï¼Œå…¶å½¢å¼ä¸º <span class="math inline">\(\frac{1}{f} =\frac{1}{u} +\frac{1}{v}\)</span>ã€‚å…¶ä¸­ f ä¸ºç„¦è·ï¼Œå‡¸æ­£å‡¹è´Ÿï¼›u ä¸ºç‰©è·ï¼›v ä¸ºåƒè·ï¼Œå®æ­£è™šè´Ÿã€‚</p><h1 id="è¡å°„å®šå¾‹-todoå¾…è¡¥å……">è¡å°„å®šå¾‹ TODOï¼ˆå¾…è¡¥å……ï¼‰</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/diffraction.png"> å…‰åœ¨ä¼ æ’­è·¯å¾„ä¸­ï¼Œé‡åˆ°ä¸é€æ˜æˆ–é€æ˜çš„éšœç¢ç‰©æˆ–è€…å°å­”ï¼ˆçª„ç¼ï¼‰ï¼Œç»•è¿‡éšœç¢ç‰©ï¼Œäº§ç”Ÿåç¦»ç›´çº¿ä¼ æ’­çš„ç°è±¡ç§°ä¸ºå…‰çš„è¡å°„ã€‚è¡å°„æ—¶äº§ç”Ÿçš„æ˜æš—æ¡çº¹æˆ–å…‰ç¯ï¼Œå«è¡å°„å›¾æ ·ã€‚åŒ…æ‹¬ï¼šå•ç¼è¡å°„ã€åœ†å­”è¡å°„ã€åœ†æ¿è¡å°„åŠæ³Šæ¾äº®æ–‘</p><h1 id="ç†æƒ³å…‰å­¦ç³»ç»Ÿä¸å®Œç¾æˆåƒ">ç†æƒ³å…‰å­¦ç³»ç»Ÿä¸å®Œç¾æˆåƒ</h1><h2 id="ç†æƒ³å…‰å­¦ç³»ç»Ÿ">ç†æƒ³å…‰å­¦ç³»ç»Ÿ</h2><p>å¦‚æœç‰©ç©ºé—´ä¸­çš„ä¸€ä¸ªç‰©ç‚¹ P å‘å‡ºçš„å‘æ•£çƒé¢æ³¢ç»è¿‡æˆåƒç³»ç»Ÿå˜æ¢æˆä¸€ä¸ªæ±‡èšçƒé¢æ³¢ï¼Œçƒé¢æ³¢ä¸­å¿ƒä¸º Pâ€˜ï¼Œåˆ™æ­¤ç³»ç»Ÿç§°ä¸ºç†æƒ³å…‰å­¦ç³»ç»Ÿã€‚</p><p>ç†æƒ³å…‰å­¦ç³»ç»Ÿçš„ç‰©åƒå…³ç³»åº”å…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li>ç‚¹æˆç‚¹åƒï¼šå³å¯¹äºç‰©ç©ºé—´çš„æ¯ä¸€ç‚¹ï¼Œåœ¨åƒç©ºé—´å¿…æœ‰ä¸€ä¸ªç‚¹ä¸ä¹‹ç›¸å¯¹åº”ï¼Œä¸”åªæœ‰ä¸€ä¸ªç‚¹ä¸ä¹‹å¯¹åº”ï¼Œè¿™æ ·çš„ä¸¤ä¸ªå¯¹åº”ç‚¹ç§°ä¸ºç‰©åƒç©ºé—´çš„å…±è½­ç‚¹ã€‚</li><li>çº¿æˆçº¿åƒï¼šå³å¯¹äºç‰©ç©ºé—´çš„æ¯ä¸€æ¡ç›´çº¿ï¼Œåœ¨åƒç©ºé—´å¿…æœ‰ä¸€æ¡ç›´çº¿ä¸ä¹‹ç›¸å¯¹åº”ï¼Œä¸”åªæœ‰ä¸€æ¡ç›´çº¿ä¸ä¹‹å¯¹åº”ï¼Œè¿™æ ·çš„ä¸¤æ¡å¯¹åº”ç›´çº¿ç§°ä¸ºç‰©åƒç©ºé—´çš„å…±è½­çº¿ã€‚</li><li>å¹³é¢æˆå¹³é¢åƒï¼šå³ç‰©ç©ºé—´çš„æ¯ä¸€ä¸ªå¹³é¢ï¼Œåœ¨åƒç©ºé—´å¿…æœ‰ä¸€ä¸ªå¹³é¢ä¸ä¹‹ç›¸å¯¹åº”ï¼Œä¸”åªæœ‰ä¸€ä¸ªå¹³é¢ä¸ä¹‹å¯¹åº”ï¼Œè¿™æ ·çš„ä¸¤ä¸ªå¯¹åº”å¹³é¢ç§°ä¸ºç‰©åƒç©ºé—´çš„å…±è½­é¢ã€‚</li></ul><p>å…±çº¿æˆåƒç†è®ºæ˜¯ç†æƒ³å…‰å­¦ç³»ç»Ÿçš„åŸºç¡€ç†è®ºï¼Œå®ƒåªæ˜¯åŸºæœ¬å‡è®¾ï¼Œå®é™…ä¸­æ˜¯ä¸å­˜åœ¨è¿™æ ·çš„ç†æƒ³å…‰å­¦ç³»ç»Ÿçš„ã€‚æ˜¾ç„¶ï¼Œç†æƒ³å…‰å­¦ç³»ç»Ÿæ˜¯å®é™…å…‰å­¦ç³»ç»Ÿçš„åŠªåŠ›æ–¹å‘ã€‚</p><h2 id="å®Œç¾æˆåƒ">å®Œç¾æˆåƒ</h2><h3 id="é«˜è§£æåº¦-high-resolution">é«˜è§£æåº¦ high resolution</h3><p>ç³»ç»Ÿå¯ä»¥åˆ†è¾¨è¾ƒé«˜çš„ç©ºé—´é¢‘ç‡ï¼Œå³å…‰æŸåœ¨é€šè¿‡é•œç»„æ—¶è¡å°„ç°è±¡å°½å¯èƒ½çš„ä½ã€‚åˆ†è¾¨è§£ææé™å³è‰¾é‡Œæ–‘ç›´å¾„è¦å°½å¯èƒ½çš„å°ï¼š</p><p><span class="math display">\[d = 2.44 \cdot \lambda \cdot f \#\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/f1.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/f2.png"></p><p>è·å¾—é«˜è§£æåº¦ï¼Œæ–¹æ³•æœ‰ï¼š</p><ul><li>é™ä½ F-number æˆ–æé«˜ NA å€¼ã€‚</li><li>ä½¿ç”¨æ³¢é•¿æ›´çŸ­çš„å…‰æºã€‚</li></ul><h3 id="é«˜å¯¹æ¯”åº¦-high-contrast">é«˜å¯¹æ¯”åº¦ high contrast</h3><p><span class="math display">\[C = \frac{I_{Max} - I_{Min}}{I_{Max} + I_{Min}}\]</span></p><h3 id="è‰²å½©çœŸå®-true-color">è‰²å½©çœŸå® true color</h3><p>è‰²å½©çœŸå®æ˜¯ä»¥äººå¯¹è‰²å½©çš„æ„ŸçŸ¥ä½œä¸ºå‚è€ƒåŸºå‡†çš„ã€‚ç°ä»Šå¯¹äºé¢œè‰²çš„æè¿°ï¼Œå‡ä½¿ç”¨æ•°å­¦æ–¹å¼å®šä¹‰è‰²å½©ã€‚è‰²å½©ç©ºé—´ï¼ˆè‹±è¯­ï¼šColor spaceï¼‰æ˜¯å¯¹è‰²å½©çš„ç»„ç»‡æ–¹å¼ã€‚å€ŸåŠ©è‰²å½©ç©ºé—´å’Œé’ˆå¯¹ç‰©ç†è®¾å¤‡çš„æµ‹è¯•ï¼Œå¯ä»¥å¾—åˆ°è‰²å½©çš„å›ºå®šæ¨¡æ‹Ÿå’Œæ•°å­—è¡¨ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/f3.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTc4MTUwMzQ=">https://zhuanlan.zhihu.com/p/357815034<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MzQzMTcyODc=">https://zhuanlan.zhihu.com/p/534317287<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMzkzNzk3NTc=">https://zhuanlan.zhihu.com/p/339379757<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLWhhbnMvJUU2JTk2JUFGJUU2JUI2JTg1JUU1JUIwJTk0JUU1JUFFJTlBJUU1JUJFJThC">https://www.wikiwand.com/zh-hans/%E6%96%AF%E6%B6%85%E5%B0%94%E5%AE%9A%E5%BE%8B<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9FdGVybmFMU2lsZW5jZS9wb3N0cw==">https://www.zhihu.com/people/EternaLSilence/posts<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Lens </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Lens </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lens ä¹‹æ™¯æ·±</title>
      <link href="/2023/Camera/CameraLensDepthOfField/"/>
      <url>/2023/Camera/CameraLensDepthOfField/</url>
      
        <content type="html"><![CDATA[<h1 id="æ™¯æ·±çš„è®¡ç®—">æ™¯æ·±çš„è®¡ç®—</h1><p>ç›¸æœºæ™¯æ·±ï¼šå…¶æŒ‡çš„æ˜¯åœ¨æŸä¸ªç‰©è·ä¹‹é—´ï¼Œè¿˜èƒ½å¤Ÿæ¸…æ™°æˆåƒçš„è·ç¦»ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens4.png"></p><p>å¦‚æœ sensor åˆšå¥½åœ¨åƒè·çš„ä½ç½®ä¸Šï¼Œç‰©ä½“çš„ä¸€ä¸ªç‚¹ï¼Œæˆçš„åƒä¹Ÿå°±æ˜¯ä¸€ä¸ªç‚¹ã€‚å¦‚æœ sensor åœ¨åƒè·çš„å‰é¢æˆ–è€…åé¢ï¼Œè¿™ä¸ªç‚¹ä¹Ÿå°±æˆäº†ä¸€ä¸ªåœ†ï¼Œä¸“ä¸šæœ¯è¯­å«å¼¥æ•£åœ†ã€‚å½“è¿™ä¸ªåœ†å¤§åˆ°ä¸€å®šçš„ç¨‹åº¦çš„æ—¶å€™ï¼Œç…§ç‰‡ä¹Ÿå°±ç³Šäº†ã€‚</p><span id="more"></span><p>æ™¯æ·±å…¬å¼ä¾æ®ä¸‹åˆ— 6 ä¸ªå…³ç³»å¼ï¼š</p><p><span class="math display">\[d = \frac{f}{N} \tag1\]</span></p><p>å…¶ä¸­ d ä¸ºå…‰åœˆç›´å¾„ï¼Œf ä¸ºç„¦è·ï¼ŒN ä»£è¡¨é•œå¤´è®¾å®šçš„å…‰åœˆå€¼ï¼ˆ2.8ã€4ã€5.6ã€8ã€11ã€22ï¼‰ç­‰ã€‚</p><p>å…‰å­¦é€é•œæˆåƒå…¬å¼ï¼ˆè¿™ä¸ªåœ¨å…‰å­¦åŸç†ä¸€èŠ‚æœ‰ä»‹ç»ï¼Œè¦é€šè¿‡ç›¸ä¼¼ä¸‰è§’å½¢æ¨å¯¼ï¼‰ï¼š</p><p><span class="math display">\[\frac{1}{s} + \frac{1}{v} = \frac{1}{f} \tag2\]</span></p><p>å…¶ä¸­ v ä»£è¡¨åƒè·ã€s ä»£è¡¨ç‰©è·ã€‚</p><p>åç‰©ä½“çš„æˆåƒå…¬å¼ï¼š</p><p><span class="math display">\[\frac{1}{D_N} = \frac{1}{v_N} = \frac{1}{f} \tag3\]</span></p><p>å‰ç‰©ä½“çš„æˆåƒï¼š</p><p><span class="math display">\[\frac{1}{D_F} = \frac{1}{v_F} = \frac{1}{f} \tag4\]</span></p><p><span class="math display">\[\frac{v_N - v}{v_F} = \frac{c}{d}  \tag5\]</span></p><p><span class="math display">\[\frac{v - v_F}{v_F} = \frac{c}{d} \tag6\]</span></p><p>è§£ä»¥ä¸Šæ–¹ç¨‹ç»„å¾—ï¼š</p><p><span class="math display">\[D_F = \frac{s(H - f)}{H - s}  \tag7\]</span></p><p><span class="math display">\[D_N = \frac{s(H - f)}{H - 2f + s}  \tag8\]</span></p><h1 id="æ™¯æ·±ä¸‰è¦ç´ ">æ™¯æ·±ä¸‰è¦ç´ </h1><h2 id="å…‰åœˆ">å…‰åœˆ</h2><p>å…‰åœˆå€¼ï¼Œæ˜¯é•œå¤´çš„ç„¦è·/é•œå¤´é€šå…‰ç›´å¾„å¾—å‡ºçš„ç›¸å¯¹å€¼ï¼ˆç›¸å¯¹å­”å¾„çš„å€’æ•°ï¼‰ï¼Œå…‰åœˆå€¼è¶Šå°ï¼Œå…‰åœˆè¶Šå¤§ã€‚ç›¸åŒå…‰åœˆå€¼ï¼Œsensor è¡¨é¢çš„ç…§åº¦ç›¸åŒã€‚å…‰åœˆè¶Šå¤§ï¼Œæ™¯æ·±è¶Šå°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens5.png"></p><p>å¦‚å›¾ï¼Œå½“å…‰åœˆå‡å°ï¼Œè™šçº¿ä½ç½®çš„å¼¥æ•£åœˆä¹Ÿåœ¨å‡å°ã€‚å¼¥æ•£åœˆè¶Šå°ï¼Œæˆçš„åƒå°±è¶Šæ¸…æ™°ã€‚åŸæ¥çœ‹ä¸æ¸…æ¥šçš„ç‰©ä½“ï¼Œå¼¥æ•£åœˆå˜å°äº†ï¼Œå°±èƒ½çœ‹æ¸…äº†ï¼Œæ™¯æ·±å°±å˜å¤§äº†ã€‚å¤œé—´æ‘„å½±çš„æ—¶å€™ï¼Œå¢å¤§å…‰åœˆå¯ä»¥æé«˜è¿›å…‰é‡ï¼Œæå‡å›¾åƒè´¨é‡ï¼Œä½†æ˜¯å¤§å…‰åœˆä¹Ÿä¼šå¯¼è‡´æ™¯æ·±å¤ªå°ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸¤è€…æƒè¡¡ã€‚æ‹äººåƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆä¼šè¦æ±‚æ™¯æ·±å°ï¼Œè¿™æ ·å°±æœ‰èƒŒæ™¯è™šåŒ–çš„æ•ˆæœï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¤§å…‰åœˆã€‚</p><h2 id="ç‰©è·">ç‰©è·</h2><p>ç‰©ä½“è¶Šè¿‘ï¼Œæ™¯æ·±è¶Šå° <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens6.png"></p><p>ç‰©ä½“ 123 æ˜¯ç­‰è·çš„ï¼Œä»–ä»¬æˆçš„åƒåˆ†åˆ«æ˜¯åƒ 123ï¼Œä½†æ˜¯åƒçš„ä½ç½®ä¸æ˜¯ç­‰è·çš„ã€‚ç”±äº sensor èšç„¦å¥½ä¹‹ååªèƒ½åœ¨ä¸€ä¸ªä½ç½®ä¸Šï¼Œåœ¨è¿™ä¸ªä½ç½®ä¸Šèƒ½çœ‹åˆ°æ›´å¤šçš„ç‰©ä½“ï¼Œå°±æ˜¯æ™¯æ·±å¤§ã€‚ç‰©ä½“ 1 æ¯”è¾ƒè¿œï¼Œæˆ‘ä»¬å°† sensor èšç„¦åœ¨åƒ 1 ä¸Šï¼Œåƒ 2 è·ç¦»åƒ 1 å¾ˆè¿‘ï¼Œå¼¥æ•£åœˆå¾ˆå°ï¼Œå¾ˆå®¹æ˜“çœ‹æ¸…æ¥šç‰©ä½“ 2ã€‚ç›¸åçš„ï¼Œç‰©ä½“ 3 æ¯”è¾ƒè¿‘ï¼Œæˆ‘ä»¬å°† sensor èšç„¦åœ¨åƒ 3 ä¸Šï¼Œåƒ 2 ç¦»åƒ 3 æ¯”è¾ƒè¿œï¼Œå¼¥æ•£åœˆå¤§ï¼Œä¸å®¹æ˜“çœ‹æ¸…æ¥šç‰©ä½“ 2ã€‚æ‰€ä»¥ä»å›¾ä¸­å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºï¼Œç‰©ä½“è¶Šè¿‘ï¼Œæ™¯æ·±è¶Šå°ã€‚</p><h2 id="ç„¦è·">ç„¦è·</h2><p>ç„¦è·è¶Šé•¿ï¼Œæ™¯æ·±è¶Šå°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Lens/lens7.png"></p><p>ä¸¤ä¸ªç‰©ä½“ 1 å’Œ 2ï¼Œç„¦è· fa &lt; fbã€‚å½“ç„¦è·ä¸º faï¼Œæˆçš„åƒåˆ†åˆ«æ˜¯ 1a å’Œ 2aï¼Œå½“ç„¦è·ä¸º fb æ—¶ï¼Œæˆçš„åƒåˆ†åˆ«ä¸º 1b å’Œ 2bã€‚å½“ç„¦è·æ¯”è¾ƒå°ï¼Œä¸º fa çš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°åƒ 1a å’Œåƒ 1b è·ç¦»å¾ˆè¿‘ï¼Œç”±äº sensor åªèƒ½å›ºå®šåœ¨ä¸€ä¸ªä½ç½®ï¼Œæ›´å®¹æ˜“åŒæ—¶çœ‹æ¸…ä¸¤ä¸ªç‰©ä½“ã€‚å› æ­¤ç„¦è·è¶ŠçŸ­ï¼Œæ™¯æ·±è¶Šå¤§ã€‚</p><table><thead><tr class="header"><th>æ™¯æ·±</th><th>å…‰åœˆ</th><th>ç‰©è·</th><th>ç„¦è·</th></tr></thead><tbody><tr class="odd"><td>å¤§</td><td>å°</td><td>è¿‘</td><td>çŸ­</td></tr><tr class="even"><td>å°</td><td>å¤§</td><td>è¿œ</td><td>é•¿</td></tr></tbody></table><h1 id="æ™¯æ·±ä¸-sensor-çš„å…³ç³»">æ™¯æ·±ä¸ Sensor çš„å…³ç³»</h1><p>æˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªç›´è§‚çš„ç†è§£å°±æ˜¯å¼¥æ•£åœ†å°äº cmos çš„åƒåŸå¤§å°é‚£ä¹ˆå°±ä¸ä¼šå¯¹æˆåƒäº§ç”Ÿå½±å“ï¼Œå°±æ„Ÿè§‰æ™¯æ·±å˜å¤§äº†ï¼Œå®é™…ä¸Šæ™¯æ·±éœ€è¦è½¬æ¢åˆ°ç­‰æ•ˆå‚æ•°ä¸‹ã€‚ åœ¨ç­‰æ•ˆç„¦è·ã€ç­‰æ•ˆå…‰åœˆã€å¯¹ç„¦è·ç¦»ä¸‰è€…ç›¸åŒçš„æ¡ä»¶ä¸‹ï¼Œä¸åŒå°ºå¯¸çš„æ„Ÿå…‰å…ƒä»¶æ™¯æ·±ä¿æŒä¸€è‡´ã€‚å…¶ä¸­ç„¦è·å’Œç­‰æ•ˆç„¦è·ã€å…‰åœˆå’Œç­‰æ•ˆå…‰åœˆçš„æ¢ç®—æ™®éä»¥ 135 ä¼ æ„Ÿå™¨ä¸ºæ ‡å‡†ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucWlueGluZy54eXovcG9zdHMvYjMxZDM4MWUv">https://www.qinxing.xyz/posts/b31d381e/<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Lens </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Lens </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sensor çš„ç‰¹æ€§ä¸å™ªå£°</title>
      <link href="/2023/Camera/CameraSensorCharacteristic/"/>
      <url>/2023/Camera/CameraSensorCharacteristic/</url>
      
        <content type="html"><![CDATA[<h1 id="cmos-sensor-çš„å“åº”ç‰¹æ€§">CMOS sensor çš„å“åº”ç‰¹æ€§</h1><p>ç†æƒ³ CMOS sensor çš„å“åº”ç‰¹æ€§ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos1.png"></p><p>æ¨ªåæ ‡æ˜¯å…‰å¼ºï¼Œçºµåæ ‡æ˜¯ cmos è¾“å‡ºä¿¡å·ï¼Œç›´çº¿çš„æ–œç‡å†³å®šäº†å•ä½è¾“å…¥èƒ½å¤Ÿæ¿€åŠ±çš„å“åº”å¤§å°ï¼Œè¿™ä¸ªæ–œç‡ç§°ä¸ºå¢ç›Šç³»æ•°ï¼ˆgainï¼‰ã€‚sensor ä¼šæä¾›ä¸€ç»„æ¥å£ç”¨äºè°ƒèŠ‚å®é™…ç”Ÿæ•ˆçš„å¢ç›Šå€¼ã€‚</p><span id="more"></span><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos2.png"></p><p>è€Œå®é™…çš„ sensor åªèƒ½æ˜¯åœ¨ä¸€æ®µæœ‰é™çš„åŒºé—´å†…ä¿æŒçº¿æ€§å“åº”ï¼Œå¯¹äºå¹…åº¦è¿‡å°æˆ–è€…è¿‡å¤§çš„è¾“å…¥ä¿¡å·ä¼šä¸èƒ½å¦‚å®åœ°è¡¨ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos3.png"></p><p>ä¸‹å›¾æ˜¯å®éªŒæµ‹é‡çš„è¾“å…¥è¾“å‡ºæ›²çº¿ï¼Œæ¨ªåæ ‡æ˜¯å…¥å°„åˆ° sensor çš„å…‰å­æ•°ï¼Œçºµåæ ‡æ˜¯ sensor è¾“å‡ºçš„æ•°å€¼ï¼ˆDigital Number, DNï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos4.png"></p><p>ä»¥ä¸Šå…³ç³»ç”¨å…¬å¼æè¿°å°±æ˜¯ï¼š</p><p><span class="math display">\[S(N,t) = q(\lambda) \cdot N \cdot  t\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(S(N, t)\)</span> æ˜¯ sensor çš„ä¸€ä¸ªåƒç´ é‡‡é›†åˆ°çš„ç”µå­æ•°ï¼Œ <span class="math inline">\(q(Î»)\)</span> æ˜¯ sensor åœ¨æ³¢é•¿Î»å¤„çš„å…‰ç”µè½¬æ¢æ•ˆç‡ï¼ŒN æ˜¯å•ä½æ—¶é—´å†…å…¥å°„åˆ° sensor è¡¨é¢çš„å…‰å­æ•°ï¼ˆæ³¢é•¿Î»çš„å•è‰²å…‰ï¼‰ï¼Œt æ˜¯æ›å…‰æ—¶é—´ã€‚</p><p>sensor æœ€ç»ˆè¾“å‡ºçš„åƒç´ å€¼æ˜¯ä½¿ç”¨ ADC å¯¹ S(N,t) è¿›è¡Œé‡‡æ ·å’Œ AD è½¬æ¢å¾—åˆ°çš„é‡åŒ–å€¼ï¼Œè¯¥å€¼ä¼šæœ‰ PV(Pixel Value)ï¼ŒADU(Analog-Digital Unit)ï¼ŒDN(Digital Number)ï¼ŒOutput Code ç­‰å¤šç§è¡¨è¿°æ–¹å¼ï¼Œå¹¶ä¸”</p><p><span class="math display">\[DN = g * S(N,t)\]</span></p><p>å…¶ä¸­ç¬¦å· g ä»£è¡¨å¢ç›Šç³»æ•° gainï¼Œæ„ä¹‰æ˜¯å¤šå°‘ä¸ªå…‰å­èƒ½å¤Ÿæ¿€åŠ±å‡º 1 ä¸ªæ¯”ç‰¹çš„ DN å€¼ã€‚</p><h1 id="åŠ¿é˜±å®¹é‡-saturation-capacity">åŠ¿é˜±å®¹é‡ ï¼ˆSaturation Capacityï¼‰</h1><p>åŠ¿é˜±å®¹é‡åˆç§° Full Well Capacityï¼ŒæŒ‡ä¸€ä¸ªåƒç´ çš„åŠ¿é˜±æœ€å¤šèƒ½å¤Ÿå®¹çº³å¤šå°‘ä¸ªå…‰ç”Ÿç”µå­ï¼Œæ¶ˆè´¹ç±»çš„ sensor ä¸€èˆ¬ä»¥ 2000~4000 è¾ƒä¸ºå¸¸è§ï¼Œæ­¤å€¼è¶Šå¤§åˆ™ sensor çš„åŠ¨æ€æ€§èƒ½è¶Šå¥½ã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€äº›å•åç›¸æœº sensor çš„é¥±å’Œé˜±å®¹æ¯”è¾ƒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos7.png"></p><h1 id="å™ªå£°-noise">å™ªå£° ï¼ˆNoiseï¼‰</h1><p>ç”±äºç”µå­çš„æ— è§„åˆ™çƒ­è¿åŠ¨äº§ç”Ÿçš„å™ªå£°åœ¨æ‰€æœ‰ç”µå­è®¾å¤‡ä¸­æ™®éå­˜åœ¨ï¼Œå™¨ä»¶çš„æ¸©åº¦è¶Šé«˜ï¼Œç”µå­çš„çƒ­è¿åŠ¨è¶Šå‰§çƒˆï¼Œäº§ç”Ÿçš„å™ªå£°ä¹Ÿå°±è¶Šå¤§ã€‚</p><p>å‡è®¾ç…§æ˜å¼ºåº¦æ’å®šã€å‡åŒ€ï¼Œç›¸æœºæ‹æ‘„å›¾åƒä¸­çš„å™ªå£°æ˜¯æµ‹é‡ä¿¡å·ä¸­ç©ºé—´å’Œæ—¶é—´æŒ¯åŠ¨çš„æ€»å’Œã€‚ä¸‹å›¾ä»¥ä¼ é€’å‡½æ•°çš„å½¢å¼æ€»ç»“äº† CMOS sensor å…‰ã€ç”µè½¬æ¢æ¨¡å‹ä»¥åŠå‡ ç§ä¸»è¦å™ªå£°çš„æ•°å­¦æ¨¡å‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos8.png"></p><p>ä¸‹å›¾æ›´åŠ ç»†è‡´åœ°æè¿°äº† CMOS sensor æˆåƒè¿‡ç¨‹ä¸­å„ç§å™ªå£°çš„æ¥æºå’Œä½œç”¨ä½ç½®ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos9.png"></p><p>sensor å™ªå£°ä¸­å«æœ‰å‡ éƒ¨åˆ†åˆ†é‡ï¼š</p><ul><li><p><strong>æš—æ•£ç²’å™ªå£° (ÏƒD):</strong> ç¡…ç‰‡ä¸­ç”µå­çš„çƒ­è¿åŠ¨ä¼šå¯¼è‡´ä¸€äº›ä»·ç”µå­éšæœºæ¿€å‘è‡³å¯¼å¸¦ä¸­å½¢æˆæš—ç”µæµï¼ˆdark currentï¼‰ï¼Œæ‰€ä»¥å³ä½¿å®Œå…¨æ²¡æœ‰å…‰å­å…¥å°„ï¼Œsensor ä¹Ÿä¼šå­˜åœ¨ä¸€å®šçš„ä¿¡å·è¾“å‡ºã€‚æš—æ•£ç²’å™ªå£°åœ¨ç»Ÿè®¡ä¸Šæœä»æ³Šæ¾åˆ†å¸ƒï¼Œä¸å…‰ä¿¡å·çš„é«˜ä½æ°´å¹³æ— å…³ï¼Œä½†ä¸ä¼ æ„Ÿå™¨çš„æ¸©åº¦æœ‰å…³ï¼Œä¸€èˆ¬çš„è§„å¾‹æ˜¯æ¸©åº¦æ¯å‡é«˜ 8Â°C æš—ç”µæµç¿»ä¸€å€ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos10.png"></p></li><li><p><strong>è¯»å‡ºå™ªå£° (ÏƒR):</strong> è¯¥å™ªå£°æ˜¯åœ¨äº§ç”Ÿç”µå­ä¿¡å·æ—¶ç”Ÿæˆçš„ã€‚Sensor ä¸­ä½¿ç”¨ AD è½¬æ¢å™¨ï¼ˆADCï¼‰å°†æ¨¡æ‹Ÿæ”¾å¤§å™¨è¾“å‡ºçš„æ¨¡æ‹Ÿç”µå‹é‡‡æ ·ä¸ºæ•°å­—ç”µå‹ã€‚ç”±äºæ•°å­—ä¿¡å·çš„ç²¾åº¦æ€»æ˜¯æœ‰é™çš„ï¼Œé€šå¸¸ä¸º 10 æ¯”ç‰¹è‡³ 14 æ¯”ç‰¹ï¼Œå¹…å€¼ä½äºä¸¤ä¸ªç›¸é‚»æ•°å­—ä¹‹é—´çš„æ¨¡æ‹Ÿä¿¡å·ä¼šå››èˆäº”å…¥åˆ°æœ€æ¥è¿‘çš„æ•°å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹ä¼šå¼•å…¥é‡åŒ–å™ªå£°ï¼Œè¿™æ˜¯è¯»å‡ºå™ªå£°çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¯¥å™ªå£°ç”±ä¼ æ„Ÿå™¨çš„è®¾è®¡å†³å®šï¼Œæ„ä¹‰æ˜¯è‡³å°‘éœ€è¦å¤šå°‘ä¸ªç”µå­æ‰èƒ½é©±åŠ¨è¯»å‡ºç”µè·¯çš„ ADC å˜åŒ–ä¸€ä¸ªæ¯”ç‰¹ã€‚å®ƒä¸ä¿¡å·é«˜ä½æ°´å¹³å’Œä¼ æ„Ÿå™¨æ¸©åº¦æ— å…³ã€‚</p></li><li><p><strong>å…‰å­æ•£ç²’å™ªå£° (ÏƒS):</strong> Shot noise, è¯¥å™ªå£°æ˜¯ä¸è½äºä¼ æ„Ÿå™¨åƒç´ ä¸Šå…‰å­ç›¸å…³çš„ç»Ÿè®¡å™ªå£°ã€‚åœ¨å¾®è§‚å°ºåº¦ä¸‹ï¼Œå…‰å­æµåˆ°è¾¾ä¼ æ„Ÿå™¨çš„è¡Œä¸ºåœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½æ˜¯ä¸å‡åŒ€çš„ï¼Œæ•´ä½“ä¸Šå…¶ç»Ÿè®¡è§„å¾‹ç¬¦åˆæ³Šæ¾åˆ†å¸ƒã€‚å…‰å­æ•£ç²’å™ªå£°æ˜¯ä¸è¢«æµ‹ä¿¡å·çš„é«˜ä½æ°´å¹³æœ‰å…³çš„ï¼Œä¸ä¼ æ„Ÿå™¨æ¸©åº¦æ— å…³ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos11.png"></p></li><li><p><strong>å›ºå®šæ¨¡å¼å™ªå£° (ÏƒF):</strong> Fixed-pattern noiseï¼ˆFPNï¼‰, CMOS sensor æ¯ä¸ªåƒç´ å†…éƒ½é…ç½®ä¸€ä¸ªç”µè·ç”µå‹æ”¾å¤§å™¨ï¼Œæ¯è¡Œã€æ¯åˆ—éƒ½æœ‰ä¸€äº›æ™¶ä½“ç®¡ç”¨äºæ§åˆ¶åƒç´ çš„å¤ä½å’Œè¯»å‡ºï¼Œè¿™äº›å™¨ä»¶çš„å·¥ä½œå‚æ•°ç›¸å¯¹ç†è®ºå€¼çš„æ¼‚ç§»å°±æ„æˆä¸€ç§å›ºå®šæ¨¡å¼å™ªå£°ã€‚å¦å¤–ï¼Œååƒç´ ã€ç‘•ç–µåƒç´ ä¹Ÿå¯ä»¥è§†ä¸ºä¸€ç§å›ºå®šæ¨¡å¼å™ªå£°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos12.png"></p></li><li><p><strong>å¤ä½å™ªå£° (Ïƒr):</strong> å·å¸˜æ›å…‰æ–¹å¼éœ€è¦ å…ˆå¯¹åŠ¿é˜±å¤ä½ï¼Œå°†åŠ¿é˜±ä¸­è‡ªç”±ç§¯ç´¯çš„ç”µè·å…¨éƒ¨é‡Šæ”¾ï¼Œä¸ºåç»­çš„è¯»å‡ºå‡†å¤‡ã€‚ä½†æ˜¯ç”±äºæš—ç”µæµçš„å­˜åœ¨ï¼Œæ¯æ¬¡å¤ä½åéƒ½ä¼šæ®‹ç•™ä¸€äº›å¤§å°éšæœºçš„å™ªå£°ä¿¡å·ï¼Œå³å¤ä½å™ªå£°ï¼Œå…¶å¤§å°ä¸åƒç´ ç»“æ„ã€èŠ¯ç‰‡æ¸©åº¦ã€PN ç»“ç”µå®¹æœ‰å…³ï¼Œå› æ­¤ä¹Ÿç§°ä¸º kTC å™ªå£°ã€‚åƒç´ çš„å¤ä½æ˜¯éœ€è¦ä¸€å®šæ—¶é—´çš„ã€‚å®šé‡çš„ç ”ç©¶è¡¨æ˜ï¼Œå³ä½¿æ˜¯é‡‡ç”¨è¾ƒå¤§çš„å¤ä½ç”µæµï¼Œä¸€èˆ¬ä¹Ÿéœ€è¦ 1ms ä»¥ä¸Šçš„æ—¶é—´æ‰èƒ½å°†ç”µè·é‡Šæ”¾å¹²å‡€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos13.png"></p><p>å®é™…çš„å¤ä½æ§åˆ¶ä¿¡å·é€šå¸¸ä¼šçŸ­äº 1msï¼Œå› æ­¤ä¸‹ä¸€å¸§å›¾åƒå¤šå¤šå°‘å°‘ä¼šæ®‹å­˜ä¸€äº›ä¸Šä¸€å¸§å›¾åƒçš„å½±å­ï¼Œè¿™ä¸ªæ®‹å½±å«åš image lagï¼Œä¹Ÿæ˜¯å™ªå£°çš„ä¸€ç§å½¢å¼ã€‚</p></li><li><p><strong>1/f å™ªå£° (Ïƒf):</strong> 1/f å™ªå£°æ˜¯ä¸€ç§ä½é¢‘å™ªå£°ï¼Œåœ¨æœ‰äº›æ–‡çŒ®ä¸­ä¹Ÿç§° flicker noiseï¼ˆé—ªçƒå™ªå£°ï¼‰ æˆ– pink noiseï¼ˆç²‰çº¢å™ªå£°ï¼‰ï¼Œå®ƒå¹¿æ³›å­˜åœ¨äºåŠå¯¼ä½“å™¨ä»¶ä¸­ã€‚åœ¨ä½é¢‘çš„æ—¶å€™ 1/f å™ªå£°ä¸€èˆ¬æ˜¾è‘—é«˜äºç”µæ•£ç²’å™ªå£°ã€‚ä¸€ç§ç†è®ºè®¤ä¸ºï¼ŒåŠå¯¼ä½“æ™¶æ ¼ä¸­éƒ½ä¼šå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œè¿™äº›ç¼ºé™·èƒ½å¤Ÿæ•è·ä¸€äº›è‡ªç”±ç”µå­å¹¶å°†å…¶æŸç¼šä¸€æ®µæ—¶é—´ï¼Œè¿™å¯ä»¥è§£é‡Š 1/f å™ªå£°çš„ä¸€ç§æ¥æºã€‚</p></li><li><p><strong>å…‰å“åº”éå‡åŒ€æ€§ (Ïƒp):</strong> è‹±æ–‡ä¸º PRNUï¼ŒPhoto Response Non-Uniformityã€‚Bayer æ ¼å¼çš„ sensor é€šå¸¸å­˜åœ¨å››ç§åƒç´  (R,Gr,Gb,B)ï¼Œè¿™å››ç§åƒç´ çš„å…‰ç”µè½¬æ¢ç‰¹æ€§ï¼ˆå³å¢ç›Šç‰¹æ€§ï¼‰ä¸å¯èƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä¸åŒç§åƒç´ é—´å­˜åœ¨ç§é—´å·®å¼‚ï¼ŒåŒç§åƒç´ ä¹‹é—´ä¹Ÿå­˜åœ¨ä¸ªä½“å·®å¼‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos14.png"></p></li><li><p><strong>ä¸²æ‰°ï¼š</strong> è‹±æ–‡ä¸º Crosstalkï¼Œåœ¨é€šä¿¡é¢†åŸŸä¸­æŒ‡ä¸¤æ¡ä¿¡å·çº¿ä¹‹é—´ç”±äºå±è”½ä¸è‰¯è€Œå‘ç”Ÿäº†çš„ä¿¡å·è€¦åˆï¼Œåœ¨ sensor é¢†åŸŸï¼Œä¸²æ‰°æŒ‡çš„æ˜¯å…¥å°„åˆ°ä¸€ä¸ªåƒç´  A çš„å…‰ä¿¡å·æ²¡æœ‰åœ¨è¿™ä¸ªåƒç´ é‡Œè¢«æ•è·ï¼Œåè€Œè¢«å…¶å‘¨å›´çš„åƒç´  B æ•è·ï¼Œå¯¼è‡´ B äº§ç”Ÿäº†ä¸è¯¥æœ‰çš„ä¿¡å·ã€‚</p></li></ul><p>åœ¨ä¸‹å›¾ä¾‹å­ä¸­ï¼Œç²‰è‰²è¡¨ç¤ºçš„æ˜¯ä¸é€å…‰çš„åƒç´ ï¼Œä¸åº”è¯¥æœ‰ä»»ä½•è¾“å‡ºï¼Œé»„è‰²è¡¨ç¤ºæ­£å¸¸åƒç´ ï¼Œåº”è¯¥æœ‰è¾“å‡ºã€‚å®é™…ä¸Šï¼Œå…‰å­æ˜¯å¯ä»¥åœ¨ç¡…ç‰‡ä¸­ç©¿é€ä¸€å®šçš„è·ç¦»çš„ï¼Œä»è€Œæœ‰æœºä¼šè¿›å…¥åˆ°ç²‰è‰²åƒç´ çš„æ„Ÿå…‰åŒºï¼Œä»è€Œå˜æˆç²‰è‰²åƒç´ çš„ä¿¡å·ï¼Œè¿™å°±æ˜¯ CMOS sensor çš„ä¸²æ‰°æœºåˆ¶ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos15.png"></p><p>ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œæ³¢é•¿è¶Šé•¿ï¼Œä¸²æ‰°è¶Šä¸¥é‡ï¼ŒæŸäº›åƒç´ ä½ç½®ä¸²æ‰°èƒ½é‡å¯ä»¥è¾¾åˆ° 5%ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos16.png"></p><p>ç”šè‡³å¯ä»¥è¿›ä¸€æ­¥å°†é‡åŒ–å™ªå£°å¸æ”¶åˆ°è¯»å‡ºå™ªå£°ä¸­ï¼Œäºæ˜¯æ¯ä¸ªåƒç´ çš„æ€»æœ‰æ•ˆå™ªå£°æ˜¯ä¸‹åˆ—æ‰€æœ‰å™ªå£°çš„æ€»å’Œï¼š</p><p><span class="math display">\[\sigma_{eff} = \sqrt{\sigma_D^2 + \sigma_R^2 + \sigma_S^2}\]</span></p><h1 id="å™ªå£°æ¨¡å‹">å™ªå£°æ¨¡å‹</h1><p>PRNU ä½“ç°çš„æ˜¯çº¢ã€ç»¿ã€è“ä¸‰ç§åƒç´ çš„å¢ç›Šå·®å¼‚ï¼Œå¯¹äºä»»ä¸€ç§åƒç´ ï¼Œå…‰ä¿¡å·è¶Šå¼ºåƒç´ å€¼æŠ–åŠ¨è¶Šå¤§ï¼Œè¿™ä½“ç°äº†å…‰ä¿¡å·æœ¬èº«çš„æ•£ç²’å™ªå£°ï¼Œå…‰ä¿¡å·ä¸ºé›¶æ—¶ï¼Œè¾“å‡ºå¹…åº¦æœ€å°çš„åƒç´ ä½“ç°äº†åŠå¯¼ä½“çš„æš—æ•£ç²’å™ªå£°ï¼Œè€Œ çº¢ã€ç»¿ã€è“ä¸‰ç§åƒç´ ä¹‹é—´çš„å·®å¼‚ä½“ç°äº† FPN å™ªå£°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos17.png"></p><p>å°½ç®¡åƒç´ å™ªå£°æœ‰å¤šç§æ¥æºï¼Œä½†æ¯ç§å™ªå£°çš„è´¡çŒ®ç¨‹åº¦å¹¶ä¸æ˜¯åŒç­‰é‡è¦çš„ã€‚ä¸ºäº†ç®€åŒ–è®¡ç®—ï¼Œå®é™…ä¸Šç»å¸¸é‡‡ç”¨ç®€åŒ–çš„å™ªå£°æ¨¡å‹ï¼Œåªè€ƒè™‘å…‰æ•£ç²’å™ªå£°ã€æš—æ•£ç²’å™ªå£°ã€è¯»å‡ºå™ªå£°ã€ä»¥åŠ ADC å™¨ä»¶çš„é‡åŒ–å™ªå£°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos18.png"></p><h1 id="ä¿¡å™ªæ¯”-snr">ä¿¡å™ªæ¯” ï¼ˆSNRï¼‰</h1><p>ä¿¡å™ªæ¯”æ˜¯ä¸€ä¸ªç”µå­è®¾å¤‡æˆ–è€…ç”µå­ç³»ç»Ÿä¸­ä¿¡å·ä¸å™ªå£°çš„æ¯”ä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™é‡Œé¢çš„ä¿¡å·æŒ‡çš„æ˜¯æ¥è‡ªè®¾å¤‡å¤–éƒ¨éœ€è¦é€šè¿‡è¿™å°è®¾å¤‡è¿›è¡Œå¤„ç†çš„ç”µå­ä¿¡å·ï¼Œè€Œå™ªå£°æ˜¯æŒ‡è¯¥è®¾å¤‡è‡ªè¡Œäº§ç”Ÿçš„æ— è§„åˆ™ä¿¡å·ï¼Œå¹¶ä¸”è¯¥ç§ä¿¡å·å¹¶ä¸éšå¤–éƒ¨è¾“å…¥ä¿¡å·çš„å˜åŒ–è€Œå˜åŒ–ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos19.png"></p><p>ä¸‹é¢åˆ†æ sensor å›¾åƒçš„ä¿¡å™ªæ¯”ã€‚å¦‚å‰æ‰€è¿°ï¼Œè®¾ S ä¸ºä¼ æ„Ÿå™¨ä¸Šæ¯ä¸ªåƒç´ ä¸Šå…¥å°„å…‰å­é€šé‡ä¸º N å…‰å­/ç§’æƒ…å†µä¸‹äº§ç”Ÿçš„â€œä¿¡å·â€ç”µå­çš„æ•°é‡ï¼Œå…¶ä¸­é‡å­æ•ˆç‡ä¸º QEï¼Œæ›å…‰æ—¶é—´ä¸º t ç§’ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[S = (Q E)Nt\]</span></p><p>é€šè¿‡ Sï¼Œå¯ä»¥å°†å…‰å­æ•£ç²’å™ªå£°è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[\sigma_s = \sqrt{(Q E)Nt}\]</span></p><p>ä¿¡å™ªæ¯”ï¼ˆSNRï¼‰å¯ä»¥ç”±ä¸‹å¼è¿›è¡Œä¼°ç®—ï¼š</p><p><span class="math display">\[SNR = \frac{S}{\sigma_{eff}}\]</span></p><p>å‰é¢å·²ç»æåˆ°ï¼š</p><p><span class="math display">\[\sigma_{eff} = \sqrt{\sigma_D^2 + \sigma_R^2 + \sigma_S^2}\]</span></p><p>ä¸‹å›¾ç»™å‡ºäº† sensor ä¿¡å·ï¼ˆå…‰ç”µå­æ•° Sï¼‰ä¸å™ªå£° (Ïƒeff) ä¹‹é—´çš„å…³ç³»å’Œå˜åŒ–è§„å¾‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos20.png"></p><p>ä¼ æ„Ÿå™¨åœ¨å…‰å­æ•°è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼åæ‰å¼€å§‹æœ‰ä¿¡å·çš„ï¼ˆå›¾ä¸Šæ˜¯åœ¨ 10 ä¸ 100 ä¸ªå…‰å­ä¹‹é—´ï¼‰ï¼Œå¦‚æœä¼ æ„Ÿå™¨æ¥å—çš„å…‰å­æ•°å°‘äºæŸä¸ªé˜ˆå€¼ï¼Œå°±ä¸ä¼šæœ‰ä¿¡å·è¾“å‡ºã€‚è¿™ä¸ªé˜ˆå€¼ä¸€èˆ¬è®¤ä¸ºæ˜¯è¯»å‡ºå™ªå£°ã€‚åœ¨åƒç´ è¾¾åˆ°é¥±å’Œå‰ï¼Œå…‰ç”µå­æ•°éšç€å…¥å°„å…‰å­æ•°çš„å¢åŠ è€Œçº¿æ€§å¢åŠ ï¼Œè€Œå™ªå£°éšå…¥å°„å…‰å­æ•°å¢åŠ æŒ‰æ ¹å·è§„å¾‹å¢åŠ ï¼Œå™ªå£°å¢åŠ çš„é€Ÿç‡ä½äºä¿¡å·å¢åŠ çš„é€Ÿç‡ï¼Œå› æ­¤æ€»çš„ä¿¡å™ªæ¯”ä¸æ–­å¢é•¿ã€‚</p><p>å½“ S å¾ˆå°æ—¶ï¼ŒSNR ä¸»è¦ç”±ÏƒR å†³å®šï¼Œå³ sensor æš—ç”µæµå’Œè¯»å‡ºå™ªå£°æ˜¯ä¸»è¦æ¥æºã€‚å½“ S å¾ˆå¤§æ—¶ï¼ŒSNR ä¸»è¦ç”±ÏƒS å†³å®šï¼Œå³å…‰ä¿¡å·æœ¬èº«çš„ç»Ÿè®¡æ¶¨è½æ˜¯å™ªå£°çš„ä¸»è¦æ¥æºã€‚</p><p>ä¸€èˆ¬è®¤ä¸ºï¼ŒSNR=10dB æ˜¯å¯æ¥å—ï¼ˆacceptableï¼‰çš„å›¾åƒè´¨é‡æ ‡å‡†ï¼Œè¯¥å€¼æ„å‘³ç€ä¿¡å·å¹…åº¦æ˜¯å™ªå£°çš„ 3.16 å€ã€‚è€Œ SNR=40dB æ˜¯ä¼˜ç§€ï¼ˆexcellentï¼‰çš„å›¾åƒè´¨é‡æ ‡å‡†ï¼Œè¯¥å€¼æ„å‘³ç€ä¿¡å·å¹…åº¦æ˜¯å™ªå£°çš„ 100 å€ï¼Œå› æ­¤è‡³å°‘éœ€è¦ 10000e-é¥±å’Œé˜±å®¹ã€‚ä»‹äºä¸­é—´çš„æ˜¯ SNR=30dBï¼Œè¯¥å€¼è¦æ±‚åƒç´ æä¾› 1000e-ä»¥ä¸Šçš„é¥±å’Œé˜±å®¹ï¼Œè¿™åˆšå¥½æ˜¯å¾ˆå¤šæ‰‹æœº sensor çš„æŒ‡æ ‡èŒƒå›´ã€‚</p><p>ä¸‹å›¾æ˜¯ä¸€äº›å•åç›¸æœºçš„å…¸å‹ SNR å¯¹æ¯”ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos22.png"></p><p>ä¸‹å›¾æ˜¯ Canon 1D3 å•åç›¸æœºåœ¨ä¸åŒ ISO ä¸‹çš„ä¿¡å™ªæ¯”æ›²çº¿ï¼Œæ¨ªåæ ‡æ˜¯æ›å…‰é‡ï¼Œçºµåæ ‡æ˜¯ SNRï¼Œéƒ½æ˜¯ä»¥"stop"ä¸ºå•ä½ï¼Œå³ä»¥ 2 ä¸ºåº•çš„ log-log åæ ‡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos23.png"></p><h1 id="åŠ¨æ€èŒƒå›´-dynamic-range">åŠ¨æ€èŒƒå›´ ï¼ˆDynamic Rangeï¼‰</h1><p>ä¸€ä¸ªä¿¡å·ç³»ç»Ÿçš„åŠ¨æ€èŒƒå›´è¢«å®šä¹‰æˆæœ€å¤§ä¸å¤±çœŸç”µå¹³å’Œå™ªå£°ç”µå¹³çš„æ¯”å€¼ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ç»å¸¸ç”¨ä»¥ 10 ä¸ºåº•çš„å¯¹æ•°æ¥è¡¨ç¤ºï¼Œå•ä½æ˜¯åˆ†è´ã€‚å¯¹äºèƒ¶ç‰‡å’Œæ„Ÿå…‰å…ƒä»¶æ¥è¯´ï¼ŒåŠ¨æ€èŒƒå›´è¡¨ç¤ºå›¾åƒä¸­æ‰€åŒ…å«çš„ä»â€œæœ€æš—â€è‡³â€œæœ€äº®â€çš„å–å€¼èŒƒå›´ã€‚æ ¹æ® ISO15739 çš„å®šä¹‰ï¼Œâ€œæœ€äº®â€æŒ‡çš„æ˜¯èƒ½å¤Ÿä½¿è¾“å‡ºç¼–ç å€¼è¾¾åˆ°ç‰¹å®šâ€œé¥±å’Œå€¼â€çš„äº®åº¦ï¼›è€Œâ€œæœ€æš—â€æŒ‡çš„æ˜¯å›¾åƒä¿¡å™ªæ¯”ä¸‹é™è‡³ 1.0 æ—¶çš„äº®åº¦ã€‚</p><p>sensor åŠ¨æ€èŒƒå›´è¶Šå¤§ï¼Œæ‰€èƒ½è¡¨ç°çš„å±‚æ¬¡è¶Šä¸°å¯Œï¼Œæ‰€åŒ…å«çš„è‰²å½©ç©ºé—´ä¹Ÿè¶Šå¹¿ã€‚ä¸‹å›¾æ˜¯ç”¨æ¥æµ‹é‡ sensor åŠ¨æ€èŒƒå›´æ€§èƒ½çš„å¸¸ç”¨æ–¹æ³•ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos24.jpg"></p><p>å‰é¢å·²ç»æåˆ°ï¼Œsensor æ˜¯ç”±æ•°ä»¥ç™¾ä¸‡ä¸ªç”šè‡³æ›´å¤šåƒç´ ç»„æˆçš„ï¼Œè¿™äº›åƒç´ åœ¨æ›å…‰è¿‡ç¨‹ä¸­å¸æ”¶å…‰å­è½¬åŒ–æˆç”µè·ã€‚ä¸€æ—¦è¿™äº›åƒç´ å®¹é‡è¾¾åˆ°é¥±å’Œï¼Œå¤šä½™çš„ç”µè·ä¾¿ä¼šæº¢å‡ºå¯¼è‡´è¾“å‡ºä¿¡å·ä¸å†å¢åŠ ï¼Œæ­¤æ—¶åƒç´ çš„å€¼ä¸èƒ½åæ˜ å…‰ä¿¡å·çš„çœŸå®å¼ºåº¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos25.png"></p><p>æ ¹æ®åŠ¨æ€èŒƒå›´çš„å®šä¹‰ï¼Œsensor åŠ¨æ€èŒƒå›´çš„åˆ†è´è¡¨ç¤ºç”¨ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š</p><p><span class="math display">\[DR = 20log(\frac{FullWellCapacity}{ReadOutNoise})\]</span></p><p>æ ¹æ®ä¸Šé¢çš„å…¬å¼å¯ä»¥ç®€å•è®¡ç®—å‡ºåŠ¨æ€èŒƒå›´ä¸ FullWellCapacity ä¹‹é—´çš„å…³ç³»ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos26.png"></p><p>æ˜¾ç„¶ï¼Œç›®å‰è¾ƒå¥½çš„å·¥è‰ºæ°´å¹³ï¼ˆSONYï¼‰å¯ä»¥åšåˆ°æ¯ä¸ªåƒç´ å®¹çº³ 10000 ~ 30000 ä¸ªç”µå­ï¼Œå¯ä»¥æä¾› 80 ~ 90dB çš„æé™åŠ¨æ€èŒƒå›´ï¼Œä½†æ˜¯æ›´å¤šå°±ä¸åˆç†ä¹Ÿä¸ç»æµäº†ï¼Œå› ä¸ºæ›´å¤§çš„åŠ¿é˜±å®¹é‡éœ€è¦æ›´å¤§çš„åƒç´ é¢ç§¯ï¼Œè€Œåƒç´ å¤§åˆ°ä¸€å®šç¨‹åº¦ä¹‹åå°±ä¼šé‡åˆ°æˆå“ç‡ç“¶é¢ˆã€‚</p><p>ä¸‹å›¾åˆ—ä¸¾äº†ä¸€äº›å…¸å‹å•åç›¸æœº sensor çš„åŠ¨æ€èŒƒå›´æŒ‡æ ‡ï¼Œçºµåæ ‡å¯ä»¥ç†è§£ä¸º AD è½¬æ¢å™¨çš„ä½æ•°ã€‚ä¾‹å¦‚ 12 ä½ ADC èƒ½å¤Ÿè¡¨ç¤ºçš„åŠ¨æ€èŒƒå›´æ˜¯ <span class="math inline">\(2^{12} = 4096\)</span>ï¼Œè€Œ 14 ä½ ADC èƒ½å¤Ÿè¡¨ç¤º <span class="math inline">\(2^{14}=16384\)</span> ï¼Œä»¥æ­¤ç±»æ¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos27.png"></p><p>PS: ADC ä½æ•°çš„é€‰æ‹©å¿…é¡»æ˜¯å’Œ sensor çš„åŠ¨æ€èŒƒå›´ç›¸é€‚é…çš„ï¼ŒADC ä½æ•°é«˜äº sensor æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„æ€§èƒ½æµªè´¹ï¼Œä½äº sensor åˆ™ä¸èƒ½å®Œå…¨å‘æŒ¥å‡º sensor çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¹Ÿæ˜¯ä¸€ç§æ€§èƒ½æµªè´¹ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå•åç›¸æœºçš„ä¸»æµæ˜¯é‡‡ç”¨ 14 ä½ ADCï¼Œæ›´é«˜ç«¯çš„åˆ™é‡‡ç”¨ 16 ä½ ADCã€‚</p><h1 id="çµæ•åº¦-sensitivity">çµæ•åº¦ ï¼ˆSensitivityï¼‰</h1><p>CMOS sensor å¯¹å…¥å°„å…‰åŠŸç‡çš„å“åº”èƒ½åŠ›ç”¨çµæ•åº¦å‚æ•°è¡¡é‡ï¼Œå¸¸ç”¨çš„å®šä¹‰æ˜¯åœ¨ 1Î¼m2 å•ä½åƒç´ é¢ç§¯ä¸Šï¼Œæ ‡å‡†æ›å…‰æ¡ä»¶ä¸‹ (1Lux ç…§åº¦ï¼ŒF5.6 å…‰åœˆï¼‰ï¼Œåœ¨ 1s æ—¶é—´å†…ç§¯ç´¯çš„å…‰å­æ•°èƒ½æ¿€åŠ±å‡ºå¤šå°‘ mV çš„è¾“å‡ºç”µå‹ã€‚</p><p>åœ¨é‡å­æ•ˆç‡ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œsensor çš„çµæ•åº¦ä¸»è¦å–å†³äºç”µè·/ç”µå‹è½¬æ¢ç³»æ•° (Charge/Voltage Factor, CVF)ã€‚åœ¨ä¸‹å›¾çš„ä¾‹å­ä¸­ï¼ŒCVF =220uV/eï¼Œè¿™æ„å‘³ç€é˜±å®¹ 2000e çš„åƒç´ èƒ½å¤Ÿæ¿€åŠ±å‡ºæœ€å¤§ 440mV çš„ç”µå‹ä¿¡å·ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos28.png"></p><p>åœ¨æ›å…‰ã€å¢ç›Šç›¸åŒçš„æ¡ä»¶ä¸‹ï¼Œçµæ•åº¦é«˜çš„ sensor ä¿¡å™ªæ¯”æ›´é«˜ï¼Œè¿™æ„å‘³ç€è‡³å°‘åœ¨ä¸¤ä¸ªæ–¹é¢å¯ä»¥è·å¾—æ¯”è¾ƒä¼˜åŠ¿ï¼Œ</p><ul><li>åœ¨å›¾åƒå™ªå£°æ°´å¹³æ¥è¿‘çš„æƒ…å†µä¸‹ï¼Œçµæ•åº¦é«˜çš„ sensor å›¾åƒäº®åº¦æ›´é«˜ã€ç»†èŠ‚æ›´ä¸°å¯Œã€‚</li><li>åœ¨å›¾åƒæ•´ä½“äº®åº¦æ¥è¿‘çš„æƒ…å†µä¸‹ï¼Œçµæ•åº¦é«˜çš„ sensor å™ªå£°æ°´å¹³æ›´ä½ï¼Œå›¾åƒç”»è´¨æ›´ç»†è…»ã€‚</li></ul><p>EMVA 1288 å®šä¹‰äº†è¯„ä»· camera çµæ•åº¦çš„æ ‡å‡†ï¼Œå³å¤šå°‘ä¸ªå…‰å­å¯ä»¥å¼•èµ· camera åƒç´ å€¼å˜åŒ– 1ï¼Œå³ä¸€ä¸ª DNã€‚æ ¹æ®é‡å­åŠ›å­¦çš„å…¬å¼ï¼š</p><p><span class="math display">\[E_p = \frac{h \cdot c}{\lambda }\]</span></p><p>1 ä¸ªæ³¢é•¿ä¸º 540 nm çš„ç»¿å…‰å…‰å­æºå¸¦çš„èƒ½é‡æ˜¯ï¼š</p><p><span class="math display">\[E_p = 3.683 \times  10^{-19}[J]\]</span></p><p>Camera æŠ€æœ¯æ‰‹å†Œä¸­ä¼šç»™å‡ºåƒç´ çµæ•åº¦è§„æ ¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/cmos29.png"></p><p>æ ¹æ®æ­¤è§„æ ¼å³å¯è®¡ç®—åƒç´ å€¼å˜åŒ– 1 éœ€è¦å¤šå°‘ä¸ªå…‰å­ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDA3NzcxMjE=">https://zhuanlan.zhihu.com/p/100777121<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Sensor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Sensor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sensor çš„ç»“æ„</title>
      <link href="/2023/Camera/CameraSensorStruct/"/>
      <url>/2023/Camera/CameraSensorStruct/</url>
      
        <content type="html"><![CDATA[<h1 id="sensor-çš„ç¡¬ä»¶ç»“æ„">sensor çš„ç¡¬ä»¶ç»“æ„</h1><h2 id="æ¯ä¸ªåƒç´ çš„ç»“æ„">æ¯ä¸ªåƒç´ çš„ç»“æ„</h2><ul><li><p>Microlensï¼ˆå¾®é€é•œï¼‰ã€‚ æ¯ä¸ªåƒç´ ç‚¹çš„æœ€ä¸Šæ–¹æœ‰ä¸ªå¾®é€é•œï¼Œå¢åŠ é€å…‰é‡ã€‚æœ‰é•œå¤´å°±æœ‰ CRA çš„é—®é¢˜ï¼Œè¶…å‡ºä¸€å®šè§’åº¦çš„å…‰çº¿æ— æ³•è¢«æ”¶é›†ï¼Œéœ€è¦å’Œé•œå¤´è¿›è¡ŒåŒ¹é…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel.png"></p></li><li>Photodiodeï¼ˆç¡…æ„Ÿå…‰åŒºï¼‰æ•è·å…‰å­ï¼Œæ¿€å‘å…‰ç”Ÿç”µå­ã€‚</li><li>åŠ¿é˜±ï¼Œç”¨ç”µåœºæ•è·ã€å­˜å‚¨å…‰ç”Ÿç”µå­ã€‚</li><li>ç”µè·¯ï¼Œå°†ç”µè·æ•°é‡å˜æ¢ä¸ºç”µå‹ä¿¡å·ï¼Œä»¥åŠå¤ä½ã€é€‰æ‹©ã€è¯»å‡ºé€»è¾‘ã€‚</li><li><p>æ»¤å…‰è†œï¼Œé€‰æ‹©æ€§é€è¿‡ä¸‰ç§æ³¢é•¿ä¸­çš„ä¸€ç§ã€‚</p></li></ul><span id="more"></span><h2 id="ç»†è¯´-cra">ç»†è¯´ CRA</h2><p>CRA æ˜¯ Chief Ray Angle çš„ç¼©å†™ï¼Œæ„æ€æ˜¯ä¸»å…‰è§’ã€‚ä»é•œå¤´çš„ä¼ æ„Ÿå™¨ä¸€ä¾§ï¼Œå¯ä»¥èšç„¦åˆ°åƒç´ ä¸Šçš„å…‰çº¿çš„æœ€å¤§è§’åº¦è¢«å®šä¹‰ä¸ºä¸€ä¸ªå‚æ•°ï¼Œç§°ä¸ºä¸»å…‰è§’ (CRA)ã€‚å¯¹äºä¸»å…‰è§’çš„ä¸€èˆ¬æ€§å®šä¹‰æ˜¯ï¼šæ­¤è§’åº¦å¤„çš„åƒç´ å“åº”é™ä½ä¸ºé›¶åº¦è§’åƒç´ å“åº”çš„ 80%ã€‚</p><p>æˆ‘ä»¬åœ¨æŒ‘é€‰ Lens çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ª CRA çš„å‚æ•°ï¼Œåœ¨é€‰æ‹© sensor çš„æ—¶å€™åŒæ ·æœ‰ä¸€ä¸ª CRA çš„å‚æ•°ï¼Œä¸€èˆ¬æˆ‘ä»¬è¦æ±‚ Lens çš„ CRA æ›²çº¿ä¸ senosr çš„ CRA æ›²çº¿å®Œå…¨åŒ¹é…ï¼Œå¦‚æœå®åœ¨ä¸èƒ½åŒ¹é…ï¼Œæˆ‘ä»¬ä¹Ÿè¦æ±‚åœ¨åŒæ ·çš„åƒé«˜ä½ç½®ï¼ŒCRA ç›¸å·®ä¸èƒ½è¶…è¿‡ 3 åº¦ï¼Œè€Œä¸”æœ€å¥½æ˜¯ Lens çš„ CRA æ¯” sensor çš„ CRA å°ï¼Œå¦åˆ™å°†ä¼šå¯¼è‡´æˆåƒç…§åº¦æˆ–è‰²å½©é—®é¢˜ã€‚</p><p>æ™®é€šçš„ FSI çš„ sensor éƒ½æœ‰ä¸€ä¸ªç±»ä¼¼å…‰å­äº•çš„ç»“æ„ç”¨æ¥æ”¶é›†å…‰å­ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel9.jpg"></p><p>å½“ CRA å¢åŠ çš„æ—¶å€™ï¼Œå…‰çº¿ä¼šè¢«é‡‘å±ç”µè·¯å±‚é˜»æŒ¡æ‰ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´ sensor æ¥å—å…‰çš„æ•ˆèƒ½é™ä½ã€‚</p><p>å¯¹äº BSI çš„ sensorï¼Œè¿™ç§å½±å“ä¹Ÿä¼šæ›´å°ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel10.jpg"></p><p>æ€æ ·é€‰æ‹© Sensor çš„ CRAï¼š</p><ul><li>å¹¿è§’é•œå¤´ï¼šè¿™æ—¶ä¸€èˆ¬ Lens çš„ CRA æ¯”è¾ƒå¤§ï¼Œéœ€è¦é€‰æ‹© CRA å¤§äº 25 åº¦çš„ Sensor æˆ–è€… BSI çš„ Sensorï¼›ä¸€èˆ¬ç”¨äºæ‰‹æœºã€å®‰é˜²ã€ç©å…·ã€ç½‘ç»œæ‘„åƒå¤´ç­‰ã€‚</li><li>è¶…é•¿ç„¦é•œå¤´ï¼šè¿™æ—¶ä¸€èˆ¬ Lens çš„ CRA æ¯”è¾ƒå°ï¼Œéœ€è¦é€‰æ‹© CRA ä¸º 0 åº¦çš„ Sensorï¼›ä¸€èˆ¬ç”¨äºå®‰é˜²ã€æœºå™¨è§†è§‰ç­‰ã€‚</li><li>å˜ç„¦é•œå¤´ï¼šè¿™æ—¶ Lens çš„ CRA æ˜¯å˜åŒ–çš„ï¼Œä¸€èˆ¬éœ€è¦æ ¹æ®å®é™…åº”ç”¨é€‰æ‹©ï¼Œæœ€å¥½é‡‡ç”¨å¤§ pixelï¼ŒBSI çš„ Sensorï¼›ä¸€èˆ¬ç”¨äºå®‰é˜²ç­‰ã€‚</li></ul><h2 id="sensor-çš„çºµå‘ç»“æ„">sensor çš„çºµå‘ç»“æ„</h2><p>å¯¹äºå‰ç…§å¼ CMOSï¼Œå…‰é€è¿‡ç”µè·¯ä¼šå‘ç”Ÿåå°„ï¼Œé€ æˆæ¯ä¸ªåƒç´ ç‚¹ä¹‹é—´çš„å¹²æ‰°ã€‚èƒŒç…§å¼çš„ç»“æ„ï¼ˆæ„Ÿå…‰å±‚åœ¨ç”µè·¯çš„ä¸Šæ–¹ï¼‰ä¸ä¼šå—åˆ°ç”µè·¯çš„å½±å“ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel1.png"></p><p>åœ¨èƒŒç…§å¼å·¥è‰ºçš„åŸºç¡€ä¸Šåˆå‘å±•å‡ºäº†å †æ ˆå¼ï¼ˆStackedï¼‰å·¥è‰ºã€‚é¡¾åæ€ä¹‰ï¼Œå †æ ˆå¼å·¥è‰ºæŠŠä¸¤ç‰‡æˆ–è€…æ›´å¤šç‰‡ç¡…ç‰‡ä¸Šä¸‹å †å åœ¨ä¸€èµ·ï¼Œæœ€ä¸Šå±‚ç¡…ç‰‡å…¨éƒ¨ç”¨äºåˆ¶é€ åƒç´ çš„æ„Ÿå…‰åŒºï¼Œè€Œ sensor æ§åˆ¶æ‰€éœ€çš„æ¨¡æ‹Ÿã€æ•°å­—é€»è¾‘å…¨éƒ¨ç§»åˆ°ä¸‹å±‚ç¡…ç‰‡ï¼Œæ‰€ä»¥æ„Ÿå…‰åŒºå  sensor é¶é¢å°ºå¯¸çš„æ¯”ä¾‹å¯ä»¥æ¥è¿‘ 100%ï¼Œç»ˆäºè¾¾åˆ°äº† sensor æ•ˆç‡çš„å·…å³°ã€‚</p><h2 id="ç»†è¯´-cfacolor-filter-array">ç»†è¯´ CFA(color filter array)</h2><p>æ¯ä¸ªåƒç´ ç‚¹ä¸Šè¦†ç›–æœ‰ä¸€ç§é¢œè‰²çš„æ»¤å…‰ç‰‡ï¼Œä»è€Œå»æ„ŸçŸ¥æ¯ç§é¢œè‰²çš„äº®åº¦ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel2.png"></p><p>Bayer æ ¼å¼ï¼šç»¿è‰²åˆ†é‡ä¸ºæ€»åƒç´ æ•°çš„ä¸€åŠï¼Œçº¢è‰²è“è‰²å„ä¸ºæ€»åƒç´ çš„å››åˆ†ä¹‹ä¸€ã€‚</p><h2 id="ad-è½¬æ¢åŠè¯»å‡º">AD è½¬æ¢åŠè¯»å‡º</h2><p>sensor ä¼šä½¿ç”¨ä¸€ä¸ªè¡Œé€‰ä¿¡å· (Row Select) å’Œä¸€ä¸ªåˆ—é€‰ä¿¡å· (Column Select) æ¥é€‰ä¸­ä¸€ä¸ªå­˜å‚¨å•å…ƒ (Pixel)ï¼Œè¢«é€‰ä¸­çš„å­˜å‚¨å•å…ƒä¸è¾“å‡ºæ”¾å¤§å™¨è”é€šï¼Œå°†å…¶å­˜å‚¨çš„ç”µè·æ•°è½¬æ¢æˆç”µå‹å€¼è¾“å‡ºåˆ°é˜µåˆ—å¤–éƒ¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel30.png"></p><ul><li>æ¯ä¸ªåƒç´ å†…ç½®ä¸€ä¸ªç”µè·/ç”µå‹æ”¾å¤§å™¨ï¼ˆCharge/Voltage Converter, CVCï¼‰ï¼Œå°†åƒç´ åŠ¿é˜±ä¸­ç”µè·çš„æ•°é‡è½¬æ¢æˆç”µå‹ä¿¡å·ã€‚</li><li>è¯»å‡ºé€»è¾‘é€‰ä¸­æŸä¸€è¡Œï¼Œè¯¥è¡Œæ‰€æœ‰åƒç´ çš„ç”µè·/ç”µå‹æ”¾å¤§å™¨çš„è¾“å‡ºä¿¡å·ä¸åˆ—è¾“å‡ºä¿¡å·è”é€šã€‚</li><li>è¯»å‡ºé€»è¾‘ç»§ç»­é€‰ä¸­æŸä¸€åˆ—ï¼Œè¯¥åˆ—ä¿¡å·ä¸å¯ç¼–ç¨‹è¾“å‡ºæ”¾å¤§å™¨ï¼ˆOutput Amplifierï¼‰è”é€šï¼Œè¢«é€‰ä¸­çš„åƒç´ çš„ç”µå‹ä¿¡å·è¢«æ”¾å¤§ä¸€å®šå€æ•°ã€‚</li><li>æ”¾å¤§åçš„ç”µå‹ä¿¡å·ç» ADC è½¬æ¢å™¨åå˜æˆæ•°å­—ä¿¡å·ï¼Œæœ€åé€šè¿‡ä¸€å®šçš„æ¥å£åè®®ï¼ˆå¦‚ MIPIï¼‰è¾“å‡ºåˆ°å¤–éƒ¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel31.png"></li></ul><blockquote><p>è°ƒèŠ‚ç›¸æœºçš„ ISO å…¶å®å°±æ˜¯è°ƒèŠ‚è¿™é‡Œçš„æ”¾å¤§å™¨æ”¾å¤§å€ç‡ä»¥åŠç»è¿‡ AD è½¬æ¢åçš„æ•°å­—é‡ä¹˜ä»¥ä¸€ä¸ªå€ç‡ï¼Œå¾ˆå®¹æ˜“ç†è§£æ¨¡æ‹Ÿæ”¾å¤§å™¨çš„å™ªå£°æ›´å°ï¼Œå› ä¸º AD è½¬æ¢å™¨æœ¬èº«å­˜åœ¨ä¸€å®šçš„ç²¾åº¦æŸå¤±ä»¥åŠ AD å›ºæœ‰çš„å™ªå£°éƒ½ä¼šè¢«æ•°å­—å¢ç›Šæ”¾å¤§ã€‚å…·ä½“åœ¨è®¾è®¡çš„æ—¶å€™æ ¹æ®ç”¨æˆ·è®¾ç½®çš„ ISO å°†å…¶è½¬æ¢æˆå…·ä½“çš„å¢ç›Šå€¼ï¼Œç„¶åå¦‚æœæ¨¡æ‹Ÿå¢ç›Šè¶³å¤Ÿå°±åªç”¨æ¨¡æ‹Ÿå¢ç›Šï¼Œå¦‚æœæ¨¡æ‹Ÿå¢ç›Šä¸å¤Ÿï¼Œé‚£ä¹ˆå…ˆå°†æ¨¡æ‹Ÿå¢ç›Šæ‹‰æ»¡å†è®¾ç½®æ•°å­—å¢ç›Šã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><p>sensor ä¼šé€šè¿‡å¾®é€é•œå°†å…‰çº¿èšåœ¨ä¸€èµ·ï¼ˆæ›´å¤šçš„å…‰å­ç…§å°„åˆ°æ„Ÿå…‰å…ƒä»¶ä¸Šï¼‰ç„¶åé€šè¿‡ Bayer Filter åˆ†åˆ«è·å–çº¢ç»¿è“ä¸‰åŸè‰²ï¼Œè¿™æ ·æ¯ä¸ªåƒå…ƒä¸Šå°†å¯ä»¥è·å–ä¸€ç§é¢œè‰²ï¼Œå†ç»è¿‡æ„Ÿå…‰å…ƒä»¶å°†å…‰å­è½¬æ¢æˆç”µä¿¡å·å­˜å‚¨èµ·æ¥ã€‚ç„¶åè¯¥ä¿¡å·ä¼šç»è¿‡ç»è¿‡æ¨¡æ‹Ÿæ”¾å¤§å™¨ï¼Œå°†ä¿¡å·æ”¾å¤§ï¼Œå†ç»è¿‡ AD è½¬æ¢å™¨è·å¾—æ•°å­—ä¿¡å·ï¼Œç»è¿‡ MIPI ç­‰ç‰©ç†æ¥å£å°†ä¿¡å·å‘é€å‡ºå»ï¼ˆå¯¹äºé›†æˆ ISP çš„æ¨¡ç»„è¿˜ä¼šç»è¿‡ ISP çš„å¤„ç†å†å°†ä¿¡å·å‘é€å‡ºå»ï¼‰ã€‚</p><h1 id="åƒç´ ç±»å‹-pixel-type">åƒç´ ç±»å‹ (Pixel type)</h1><h2 id="è¢«åŠ¨åƒç´ -passive-pixel">è¢«åŠ¨åƒç´  ï¼ˆPassive pixelï¼‰</h2><p>æœ€ç®€å•çš„ Pixel ç»“æ„åªæœ‰ä¸€ä¸ª PN ç»“ä½œä¸ºæ„Ÿå…‰ç»“æ„ï¼Œä»¥åŠä¸€ä¸ªä¸å®ƒç›¸è¿çš„ reset æ™¶ä½“ç®¡ï¼ˆRSï¼‰ä½œä¸ºä¸€ä¸ªå¼€å…³ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel34.png"></p><ul><li>å¼€å§‹æ›å…‰å‰ï¼Œåƒç´ çš„è¡Œé€‰æ‹©åœ°å€ä¼šä¸Šç”µï¼Œäºæ˜¯ RS ä½¿èƒ½ï¼Œè¿é€š PN ç»“ä¸åˆ—é€‰æ‹©å™¨ï¼ˆcolumn busï¼‰ï¼ŒåŒæ—¶åˆ—é€‰æ‹©å™¨ä¼šä¸Šç”µï¼Œä½¿ PN ç»“ä¸ŠåŠ é«˜åå‘ç”µå‹ï¼ˆå¦‚ 3.3 Vï¼‰ï¼ŒçŸ­æš‚å»¶æ—¶å PN ç»“å†…ç”µå­ç©ºç©´å¯¹è¾¾åˆ°å¹³è¡¡ï¼Œäºæ˜¯ reset æ“ä½œå®Œæˆï¼ŒRS ä¿¡å·å¤±æ•ˆï¼Œéš”æ–­ PN ç»“ä¸ column bus çš„è¿é€šã€‚</li><li>å¼€å§‹æ›å…‰æ—¶ï¼ŒPN ç»“å†…çš„ç¡…åœ¨å¸æ”¶å…‰å­æ¿€å‘å‡ºç”µå­-ç©ºç©´å¯¹ã€‚å— PN ç»“å†…ç”µåœºçš„å½±å“ï¼Œç”µå­ä¼šæµå‘ PN ç»“çš„ n+ç«¯ï¼Œç©ºç©´ä¼šæµå‘ PN ç»“çš„ p-substrateã€‚å› æ­¤ï¼Œæ›å…‰åçš„çš„ PN ç»“åå‘ç”µå‹ä¼šé™ä½ã€‚</li><li>æ›å…‰ç»“æŸåï¼ŒRS å†æ¬¡ä½¿èƒ½ï¼Œè¯»å‡ºç”µè·¯ä¼šæµ‹é‡ PN ç»“å†…çš„ç”µå‹ï¼Œè¯¥ç”µå‹ä¸åŸåå‘ç”µå‹ä¹‹é—´çš„å·®å€¼å³æ­£æ¯”äº PN ç»“æ¥å—åˆ°çš„å…‰å­æ•°ã€‚</li><li>åœ¨è¯»å‡ºæ„Ÿå…‰ä¿¡å·åï¼Œä¼šå¯¹ PN ç»“è¿›è¡Œå†æ¬¡ resetï¼Œå‡†å¤‡ä¸‹æ¬¡æ›å…‰ã€‚</li></ul><p>è¿™ç§åƒç´ ç»“æ„å› ä¸ºè¯»å‡ºç”µè·¯å®Œå…¨ä½äºåƒç´ å¤–é¢æ‰€ä»¥ç§°ä¸º Passive Pixelï¼Œå…¶ä¼˜ç‚¹æ˜¯ PN ç»“å¯ä»¥ç‹¬å åƒç´ é¢ç§¯ï¼Œç¼ºç‚¹æ˜¯å™ªå£°è¾ƒå¤§ï¼Œä¸»è¦æœ‰ 2 ä¸ªåŸå› ï¼š</p><ul><li>PN ç»“çš„ç”µå®¹å°äºè¯»å‡ºç”µè·¯ä¸Šçš„ç”µå®¹ï¼Œæ‰€ä»¥å¯¹ç”µè·¯å™ªå£°å¾ˆæ•æ„Ÿã€‚</li><li>PN ç»“çš„ä¿¡å·éœ€è¦å…ˆè¯»å‡ºæ‰è¿›è¡Œæ”¾å¤§ï¼Œå› æ­¤è¯»å‡ºç”µè·¯çš„å™ªå£°ä¼šè¢«ä¸€èµ·æ”¾å¤§ã€‚</li></ul><p>å½“ RS ä½¿èƒ½ä¸”åˆ—é€‰æ‹©å™¨é€šé«˜ç”µå¹³æ—¶ï¼Œåœ¨ç”µè·¯åŸç†ä¸Šç›¸å½“äºå¯¹ PN ç»“çš„ç”µå®¹è¿›è¡Œå……ç”µï¼Œä½†æ˜¯å……ç”µåå¾—åˆ°çš„ç”µå‹å€¼å´æœ‰ä¸€å®šçš„éšæœºæ€§ï¼Œä¸€æ–¹é¢æ¯ä¸ª PN ç»“çš„å®é™…ç”µå®¹å¤§å°ä¼šæœä»ä¸€å®šçš„æ¦‚ç‡åˆ†å¸ƒï¼Œç»“ä¸ç»“ä¹‹é—´å­˜åœ¨å›ºå®šçš„åå·®ï¼Œè¿™ä¼šæ„æˆä¸€ç§å›ºå®šæ¨¡å¼å™ªå£°ï¼ˆFixed Pattern Noise, FPNï¼‰ï¼›å¦ä¸€æ–¹é¢ç”±äºç”µè·¯ä¸­å­˜åœ¨æš—ç”µæµå™ªå£°ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªç»“æ¯æ¬¡å……ç”µåå¾—åˆ°çš„å®é™…ç”µå‹ä¹Ÿä¸å®Œå…¨ä¸€æ ·ï¼Œè¿™å°±æ„æˆäº†å¦ä¸€ç§æ¨¡å¼çš„å™ªå£°ï¼Œå®ƒä¸ PN ç»“çš„ç»“æ„ã€æ¸©åº¦å’Œç»“ç”µå®¹å¤§å°éƒ½æœ‰å…³ï¼Œç§°ä¸º kTC å™ªå£°ã€‚</p><h2 id="åƒç´ -ktc-å™ªå£°">åƒç´  kTC å™ªå£°</h2><p>åœ¨ç ”ç©¶ PN ç»“çš„å™ªå£°ç‰¹æ€§æ—¶å¯å°†å…¶ç®€åŒ–ä¸ºä¸‹å›¾æ‰€ç¤ºçš„ç”±ç”µé˜»ç”µå®¹å½¢æˆçš„ä½é€šæ»¤æ³¢ç½‘ç»œã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel35.png"></p><p>å¯ä»¥è¯æ˜ï¼Œç”±ç”µå­çƒ­è¿åŠ¨å¼•èµ·çš„å®½å¸¦çƒ­å™ªå£°ç» PN ç»“æ»¤æ³¢åååº”åœ¨ç»“ç”µå®¹ä¸Šçš„è¾“å‡ºå™ªå£°åŠŸç‡ç”¨ kT/C æè¿°ï¼Œå…¶ä¸­ T ä¸º PN ç»“æ¸©åº¦ï¼ŒC ä¸ºç»“ç”µå®¹ï¼Œk ä¸ºå¸¸ç³»æ•°ï¼Œå› æ­¤åˆç§° kTC å™ªå£°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel36.png"></p><h2 id="ä¸»åŠ¨åƒç´ -active-pixel">ä¸»åŠ¨åƒç´  ï¼ˆActive pixelï¼‰</h2><p>ç›®å‰ä¸»æµçš„ CMOS ä¼ æ„Ÿå™¨éƒ½é‡‡ç”¨ Active Pixel ç»“æ„è®¾è®¡ã€‚ä¸‹å›¾æ‰€ç¤ºçš„ Active Pixel ç»“æ„ç§°ä¸º 3T ç»“æ„ï¼Œæ¯ä¸ªåƒç´ åŒ…å«ä¸€ä¸ªæ„Ÿå…‰ PN ç»“å’Œ 3 ä¸ªæ™¶ä½“ç®¡ï¼Œå³ä¸€ä¸ªå¤ä½ç®¡ RSTï¼Œä¸€ä¸ªè¡Œé€‰æ‹©å™¨ RSï¼Œä¸€ä¸ªæ”¾å¤§å™¨ SFã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel37.png"></p><p>3T ç»“æ„çš„å·¥ä½œæ–¹å¼æ˜¯ï¼š</p><ul><li>å¤ä½ï¼šä½¿èƒ½ RST ç»™ PN ç»“åŠ è½½åå‘ç”µå‹ï¼Œå¤ä½å®Œæˆåæ’¤é”€ RSTã€‚</li><li>æ›å…‰ï¼šä¸ Passive Pixel åŸç†ç›¸åŒã€‚</li><li>è¯»å‡ºï¼šæ›å…‰å®Œæˆåï¼ŒRS ä¼šè¢«æ¿€æ´»ï¼ŒPN ç»“ä¸­çš„ä¿¡å·è¢« SF æ”¾å¤§åè¯»å‡ºã€‚</li><li>å¾ªç¯ï¼šè¯»å‡ºä¿¡å·åï¼Œé‡æ–°å¤ä½ï¼Œæ›å…‰ï¼Œè¯»å‡ºï¼Œä¸æ–­è¾“å‡ºå›¾åƒä¿¡å·ã€‚</li></ul><p>åŸºäº PN ç»“çš„ Active Pixel æµè¡Œä¸ 90 å¹´ä»£ä¸­æœŸï¼Œå®ƒè§£å†³äº†å¾ˆå¤šå™ªå£°é—®é¢˜ã€‚ä½†æ˜¯ç”± PN ç»“å¤ä½å¼•å…¥çš„ kTC å™ªå£°å´å¹¶æ²¡æœ‰å¾—åˆ°è§£å†³ã€‚</p><h2 id="ppd-ç»“æ„">PPD ç»“æ„</h2><p>ä¸ºäº†è§£å†³å¤ä½ kTC å™ªå£°ï¼Œå‡å°æš—ç”µæµï¼Œåœ¨ 3T ç»“æ„ä¹‹ååˆå‡ºç°äº† PPD ç»“æ„ï¼ˆPinned Photodiode Pixelï¼‰ï¼ŒåŒ…æ‹¬ä¸€ä¸ª PN ç»“æ„Ÿå…‰åŒºå’Œ 4 ä¸ªæ™¶ä½“ç®¡ï¼Œæ‰€ä»¥ä¹Ÿç§° 4T ç»“æ„ï¼Œå®ƒåœ¨ 3T ç»“æ„çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ª TX ä¸‰æç®¡èµ·æ§åˆ¶ç”µè·è½¬ç§»çš„ä½œç”¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel38.png"></p><p>PPD çš„å‡ºç°æ˜¯ CMOS æ€§èƒ½çš„å·¨å¤§çªç ´ï¼Œå®ƒå…è®¸ç›¸å…³åŒé‡‡æ ·ï¼ˆCDSï¼‰ç”µè·¯çš„å¼•å…¥ï¼Œæ¶ˆé™¤äº†å¤ä½å¼•å…¥çš„ kTC å™ªå£°ï¼Œè¿æ”¾å™¨å¼•å…¥çš„ 1/f å™ªå£°å’Œ offset å™ªå£°ã€‚ å®ƒçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>æ›å…‰ã€‚</li><li>å¤ä½ï¼šæ›å…‰ç»“æŸæ—¶ä½¿èƒ½ RSTï¼Œå°†è¯»å‡ºåŒºï¼ˆn+åŒºï¼‰å¤ä½åˆ°é«˜ç”µå¹³ã€‚</li><li>è¯»å¤ä½ç”µå¹³ï¼šè¯»å‡º n+åŒºçš„ç”µå¹³ï¼Œå…¶ä¸­åŒ…å«è¿æ”¾çš„ offset å™ªå£°ï¼Œ1/f å™ªå£°ä»¥åŠå¤ä½å¼•å…¥çš„ kTC å™ªå£°ï¼Œå°†è¯»å‡ºçš„ä¿¡å·å­˜å‚¨åœ¨ç¬¬ä¸€ä¸ªç”µå®¹ä¸­ã€‚</li><li>ç”µè·è½¬ç§»ï¼šä½¿èƒ½ TXï¼Œå°†ç”µè·ä»æ„Ÿå…‰åŒºå®Œå…¨è½¬ç§»åˆ° n+åŒºå‡†å¤‡è¯»å‡ºï¼Œè¿™é‡Œçš„æœºåˆ¶ç±»ä¼¼äº CCD ä¸­çš„ç”µè·è½¬ç§»ã€‚</li><li>è¯»ä¿¡å·ç”µå¹³ï¼šå°† n+åŒºçš„ç”µå‹ä¿¡å·è¯»å‡ºåˆ°ç¬¬äºŒä¸ªç”µå®¹ã€‚è¿™é‡Œçš„ä¿¡å·åŒ…æ‹¬ï¼šå…‰ç”µè½¬æ¢äº§ç”Ÿçš„ä¿¡å·ï¼Œè¿æ”¾äº§ç”Ÿçš„ offsetï¼Œ1/f å™ªå£°ä»¥åŠå¤ä½å¼•å…¥çš„ kTC å™ªå£°ã€‚</li><li>ä¿¡å·è¾“å‡ºï¼šå°†å­˜å‚¨åœ¨ä¸¤ä¸ªç”µå®¹ä¸­çš„ä¿¡å·ç›¸å‡ï¼ˆå¦‚é‡‡ç”¨ CDSï¼Œå³å¯æ¶ˆé™¤ Pixel ä¸­çš„ä¸»è¦å™ªå£°ï¼‰ï¼Œå¾—åˆ°çš„ä¿¡å·åœ¨ç»è¿‡æ¨¡æ‹Ÿæ”¾å¤§ï¼Œç„¶åç»è¿‡ ADC é‡‡æ ·ï¼Œå³å¯è¿›è¡Œæ•°å­—åŒ–ä¿¡å·è¾“å‡ºã€‚</li></ul><p>PPD åƒç´ ç»“æ„æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>è¯»å‡ºç»“æ„ï¼ˆn+åŒºï¼‰çš„ kTC å™ªå£°å®Œå…¨è¢« CDS æ¶ˆé™¤ã€‚</li><li>è¿æ”¾å™¨çš„ offset å’Œ 1/f å™ªå£°ï¼Œéƒ½ä¼šå›  CDS å¾—åˆ°æ˜æ˜¾æ”¹å–„ã€‚</li><li>æ„Ÿå…‰ç»“æ„å› å¤ä½å¼•èµ·çš„ kTC å™ªå£°ï¼Œç”±äº PPD ç”µè·çš„å…¨è½¬ç§»ï¼Œå˜çš„ä¸å†å­˜åœ¨ã€‚</li><li>å…‰æ•æ„Ÿåº¦ï¼Œå®ƒç›´æ¥å–å†³äºè€—å°½åŒºçš„å®½åº¦ï¼Œç”±äº PPD çš„è€—å°½åŒºä¸€ç›´å»¶ä¼¸åˆ°è¿‘ Siâˆ’SiO2 ç•Œé¢ï¼ŒPPD çš„å…‰æ„Ÿåº¦æ›´é«˜ã€‚</li><li>ç”±äº p-n-p çš„åŒç»“ç»“æ„ï¼ŒPPD çš„ç”µå®¹æ›´é«˜ï¼Œèƒ½äº§ç”Ÿæ›´é«˜çš„åŠ¨æ€èŒƒå›´ã€‚</li><li>ç”±äº Siâˆ’SiO2 ç•Œé¢ç”±ä¸€å±‚ p+è¦†ç›–ï¼Œå‡å°äº†æš—ç”µæµã€‚</li></ul><h2 id="ppd-å…±äº«ç»“æ„">PPD å…±äº«ç»“æ„</h2><p>PPD ç»“æ„æœ‰ 4 ä¸ªæ™¶ä½“ç®¡ï¼Œæœ‰çš„è®¾è®¡ç”šè‡³æœ‰ 5 ä¸ªï¼Œè¿™å¤§å¤§é™ä½äº†åƒç´ çš„å¡«å……å› å­ï¼ˆå³æ„Ÿå…‰åŒºå æ•´ä¸ªåƒç´ é¢ç§¯çš„æ¯”å€¼ï¼‰ï¼Œè¿™ä¼šå½±å“ä¼ æ„Ÿå™¨çš„å…‰ç”µè½¬æ¢æ•ˆç‡ï¼Œè¿›è€Œå½±å“ä¼ æ„Ÿå™¨çš„å™ªå£°è¡¨ç°ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜åˆå‡ºç°äº† PPD å…±äº«ç»“æ„ï¼Œåƒç´ çš„æ„Ÿå…‰åŒºå’Œè¯»å‡ºç”µè·¯ç”± TX æ™¶ä½“ç®¡éš”å¼€ï¼Œç›¸é‚»åƒç´ ä¹‹é—´å¯ä»¥å…±ç”¨è¯»å‡ºç”µè·¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel39.png"></p><p>å›¾ä¸­ 2x2 åƒç´ å…±äº«ä¸€ä¸ªè¯»å‡ºç”µè·¯ï¼Œä¸€å…±ä½¿ç”¨ 7 ä¸ªæ™¶ä½“ç®¡ï¼Œå¹³å‡ä¸€ä¸ªåƒç´  1.75 ä¸ªæ™¶ä½“ç®¡ã€‚è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ¯ä¸ªåƒç´ ä¸­è¯»å‡ºç”µè·¯å ç”¨çš„é¢ç§¯ï¼Œæé«˜å¡«å……å› å­ã€‚ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œç”±äºè¿™ 2x2 ä¸ªåƒç´ çš„ç»“æ„ä¸å†ä¸€è‡´ï¼Œä¼šå¯¼è‡´å›ºå®šæ¨¡å¼å™ªå£°ï¼ˆFPNï¼‰çš„å‡ºç°ï¼Œéœ€è¦åœ¨åç»­ ISP å¤„ç†ä¸­æ¶ˆé™¤ã€‚</p><h2 id="åŒç›¸å…³é‡‡æ ·cds">åŒç›¸å…³é‡‡æ ·ï¼ˆCDSï¼‰</h2><p>åŒç›¸å…³é‡‡æ ·å³ Correlated Double Sampingï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯è¿›è¡Œä¸¤æ¬¡é‡‡æ ·ï¼Œå…ˆé‡‡æ ·ä¸€ä¸ªå‚è€ƒä¿¡å·ç”¨äºè¯„ä¼°èƒŒæ™¯å™ªå£°ï¼Œå»¶è¿Ÿå¾ˆçŸ­æ—¶é—´åå†é‡‡é›†ç›®æ ‡ä¿¡å·ï¼Œä»ç¬¬äºŒæ¬¡é‡‡æ ·ä¸­å‡å»å‚è€ƒä¿¡å·å³å¾—åˆ°å»é™¤äº†å¤§éƒ¨åˆ†èƒŒæ™¯å™ªå£°çš„ç›®æ ‡ä¿¡å·ï¼Œå…¶åŸç†æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel40.png"></p><p>CDS æˆç«‹çš„æ¡ä»¶æ˜¯åœ¨ä¸¤æ¬¡é‡‡æ ·é—´èƒŒæ™¯å™ªå£°çš„å¹…åº¦å˜åŒ–ä¸å¤§ï¼Œå› æ­¤å®ƒå¯¹å»é™¤å›ºå®šå™ªå£°ï¼ˆFPNï¼‰å’Œä½é¢‘å™ªå£°æ•ˆæœæ¯”è¾ƒç†æƒ³ï¼Œå¦‚ 1/f å™ªå£°ï¼ŒkTC å™ªå£°ç­‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel41.png"></p><h1 id="å…‰è°±å“åº”æ›²çº¿">å…‰è°±å“åº”æ›²çº¿</h1><p>ä¸‹å›¾æ˜¯ IMX290 æ¯ä¸ªçº¢ç»¿è“æ»¤å…‰ç‰‡çš„å…‰è°±å“åº”æ›²çº¿ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel3.png"></p><p>è¿™æ˜¯äººçœ¼è§†é”¥ç»†èƒå¯¹å…‰è°±çš„å“åº”æ›²çº¿ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel4.png"></p><p>ç”±äºäººçœ¼å’Œ sensor å¯¹å…‰è°±çš„æ„Ÿåº”æ›²çº¿ä¸åŒï¼ŒåŒä¸€ä¸ªç‰©ä½“æ„ŸçŸ¥åˆ°çš„é¢œè‰²ä¸åŒã€‚å› æ­¤é¢œè‰²éœ€è¦ä¸€ä¸ªè½¬æ¢å…³ç³»ã€‚ISP ä¸­çš„ CCMï¼ˆè‰²å½©æ ¡æ­£çŸ©é˜µï¼‰å°±æ­¤è¯ç”Ÿï¼Œåˆ©ç”¨ä¸€ä¸ª 3x3 çš„çŸ©é˜µï¼Œå°† sensor æ„ŸçŸ¥åˆ°çš„ RGB é¢œè‰²ï¼Œæ ¡å‡†æˆæˆ‘ä»¬çœ‹åˆ°çš„ RGB é¢œè‰²ã€‚</p><h1 id="sensor-çš„æ›å…‰">Sensor çš„æ›å…‰</h1><p>sensor çš„æ›å…‰æ—¶é—´å’Œå¿«é—¨æ—¶é—´æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œéƒ½æ˜¯ sensor çš„æ„Ÿå…‰æ—¶é—´ã€‚æ›å…‰ï¼ˆå¿«é—¨ï¼‰æ—¶é—´è¶Šé•¿ï¼Œå›¾åƒå°±è¶Šäº®ã€‚</p><p>å½“æ§åˆ¶å¿«é—¨æ—¶é—´ï¼Œä»ç„¶è¾¾ä¸åˆ°æœŸæœ›çš„äº®åº¦ï¼Œå°±éœ€è¦è°ƒèŠ‚ sensor çš„æ„Ÿå…‰åº¦ï¼ˆISOï¼‰ã€‚CMOS sensor çš„æ„Ÿå…‰åº¦å°±æ˜¯å®ƒçš„å¢ç›Šã€‚å¢ç›Šæ˜¯ç”¨æ¨¡æ‹Ÿæˆ–æ•°å­—çš„æ–¹æ³•è¿›è¡Œæ”¾å¤§ï¼Œä¸å¯é¿å…çš„ä¼šæ”¾å¤§å™ªå£°ï¼Œå› æ­¤æ‹æ‘„æ—¶ä¸€èˆ¬å¿«é—¨ä¼˜å…ˆã€‚</p><p>å½“æ‹æ‘„é«˜é€Ÿè¿åŠ¨çš„ç‰©ä½“æˆ–è€…æ‰‹æŠ–çš„æ—¶å€™ï¼Œå®¹æ˜“äº§ç”Ÿè¿åŠ¨æ¨¡ç³Šï¼Œå°±éœ€è¦é™ä½å¿«é—¨æ—¶é—´ã€‚</p><p>sensor çš„æ›å…‰æ–¹å¼æœ‰ä¸¤ç§ï¼Œå·å¸˜æ›å…‰å’Œå…¨å±€æ›å…‰ã€‚</p><h2 id="å·å¸˜æ›å…‰rolling-shutter">å·å¸˜æ›å…‰ï¼ˆrolling shutterï¼‰</h2><ul><li>ä¸€ä¸ª reset ä¿¡å·è´Ÿè´£å°†æŸä¸€è¡Œåƒç´ æ¸…é›¶ï¼Œä½¿å…¶ä»é›¶å¼€å§‹ç§¯ç´¯ç”µè·ã€‚</li><li>ä¸€ä¸ª read ä¿¡å·è´Ÿè´£é€‰æ‹©æŸä¸€è¡Œï¼Œè¯»å‡ºè¯¥è¡Œä¿¡å·ã€‚</li></ul><p>è¿™ä¸¤ä¸ªä¿¡å·çš„å·¥ä½œæ—¶åºæ˜¯ reset ä¿¡å·åœ¨å…ˆï¼Œread ä¿¡å·åœ¨åï¼Œä¹‹é—´ç›¸å·®ä¸€ä¸ªæ’å®šçš„é—´éš”ï¼Œè¿™ä¸ªé—´éš”åœ¨ç©ºé—´ä¸Šçœ‹æ˜¯ä¸¤ä¸ªä¿¡å·å‰åç›¸å·®å›ºå®šçš„è¡Œæ•°ï¼Œåœ¨æ—¶é—´ä¸Šçœ‹æ˜¯ä¸€è¡Œåƒç´ è¢«æ¸…é›¶åï¼Œç­‰å¾…å›ºå®šçš„æ—¶é—´åå³è¢«è¯»å‡ºã€‚</p><p>æ˜¾ç„¶ï¼Œsensor read ä¿¡å·ä¸ reset ä¿¡å·ä¹‹é—´çš„æ—¶é—´é—´éš”å°±æ˜¯æ¯ä¸ªåƒç´ èƒ½å¤Ÿç§¯ç´¯å…‰ä¿¡å·çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯äººä»¬æ‰€ç†ŸçŸ¥çš„â€œæ›å…‰æ—¶é—´ï¼ˆexposure timeï¼‰â€ï¼Œåœ¨æŠ€æœ¯é¢†åŸŸåˆ™æ›´å¤šä¼šä½¿ç”¨â€œç§¯åˆ†æ—¶é—´ï¼ˆintegration timeï¼‰â€è¿™ä¸ªæœ¯è¯­ï¼Œå®ƒä¸€èˆ¬æ˜¯ä»¥è¡Œä¸ºå•ä½çš„ä¸€ä¸ªé‡ï¼Œèƒ½å¤Ÿç²¾ç¡®åœ°åæ˜ åƒç´ æ›å…‰è¿‡ç¨‹çš„ç‰©ç†æœ¬è´¨å’Œå®ç°åŸç†ã€‚</p><p>ä¸‹å›¾æ˜¯å·å¸˜æ›å…‰æ‹æ‘„é«˜é€Ÿè¿åŠ¨çš„ç‰©ä½“çš„ç°è±¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel7.png"></p><p>è¿™æ˜¯ IMX290 çš„ sensor æ›å…‰ä¸è¾“å‡ºç¤ºæ„å›¾ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel8.png"></p><p>é»„è‰²åŒºåŸŸæ˜¯ sensor å¤„äºæ„Ÿå…‰çš„æ—¶é—´ï¼Œè“è‰²åŒºåŸŸæ˜¯ sensor æ¯ä¸€è¡Œæ•°æ®çš„è¾“å‡ºæ—¶é—´ï¼Œçº¢è‰²æ˜¯æ›å…‰å¼€å§‹çš„æ—¶é—´ã€‚XHS æ˜¯è¿›è¡Œæ¯ä¸ªæ“ä½œçš„æœ€å°æ—¶é—´å•ä½ã€‚</p><p>ä»æ—¶é—´å…ˆåæ¥çœ‹ï¼Œä¸€å¹…å›¾åƒæ˜¯ä»ç¬¬ä¸€è¡Œå¼€å§‹æ›å…‰ï¼Œä¸€ä¸ª XHS ä¹‹åï¼Œå†ä»ç¬¬äºŒè¡Œå¼€å§‹æ›å…‰ï¼Œä¾æ¬¡ç±»æ¨ã€‚å›¾åƒçš„ç¬¬ä¸€è¡Œæ›å…‰ç»“æŸåï¼Œè¿›è¡Œè¾“å‡ºï¼Œè¾“å‡ºæ•°æ®çš„æ—¶é—´æ˜¯ä¸€ä¸ª XHSï¼Œä¾æ­¤ç±»æ¨ã€‚</p><p>å·å¸˜æ›å…‰å¸¦æ¥çš„é—®é¢˜ï¼š</p><ul><li>æ—¥å…‰ç¯ä¸‹æœ‰æ¨ªæ¡çº¹ã€‚ æ—¥å…‰ç¯å±äºé¢‘é—ªç¯ï¼Œè·Ÿå½“åœ°çš„ä¾›ç”µé¢‘ç‡æœ‰å…³ï¼Œå¦‚æœå½“åœ°çš„ä¾›ç”µæ˜¯ 50Hz çš„æ­£å¼¦æ³¢ï¼ˆå›½å†…ï¼‰ï¼Œæ—¥å…‰ç¯å°±ä¼šä»¥ 100Hz çš„é¢‘ç‡é—ªçƒã€‚sensor æ¯è¡Œçš„èµ·å§‹æ›å…‰æ—¶é—´æ˜¯ä¸åŒçš„ï¼Œè¿™å°±å¯¼è‡´äº†æ¯ä¸€è¡Œæ›å…‰æ—¶çš„äº®åº¦ä¸åŒã€‚å› æ­¤ä¼šå‡ºç°æ¨ªæ¡çº¹ è§£å†³æ–¹æ³•ï¼š - æ§åˆ¶æ›å…‰æ—¶é—´æ˜¯ 1/100 çš„æ•´æ•°å€ï¼Œè¿™æ ·æ¯è¡Œçš„æ›å…‰æ—¶é—´éƒ½æ˜¯ä¸€ä¸ªå‘¨æœŸçš„æ•´æ•°å€ï¼Œäº®åº¦å°±ä¿æŒä¸€è‡´äº† - æ§åˆ¶å¸§ç‡ä¸º 25/50 å¸§ï¼Œä¸èƒ½è§£å†³æ¨ªæ¡çº¹çš„é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥è®©æ¯å¸§å›¾åƒä¸­çš„æ¨ªæ¡çº¹å›ºå®šåœ¨ç›¸åŒçš„ä½ç½®ã€‚1/25 æ˜¯ 1/100 çš„æ•´æ•°å€ï¼Œå¯ä»¥ä½¿ä¸åŒå›¾åƒä¸­æ¯ä¸€è¡Œæ›å…‰çš„å¼€å§‹æ—¶é—´éƒ½ç›¸å·®å››ä¸ªå‘¨æœŸã€‚ä¿è¯äº†æ¯å¼ å›¾åƒä¸­åŒä¸€è¡Œçš„äº®åº¦æ˜¯ä¸€è‡´çš„</li><li>Rolling shutterï¼ˆæ‹æ‘„å¿«é€Ÿè¿åŠ¨çš„ç‰©ä½“ä¼šæœ‰å¤±çœŸï¼‰ã€‚ å› ä¸ºæ¯ä¸€è¡Œæ›å…‰å¼€å§‹çš„æ—¶é—´ä¸åŒï¼Œå½“ç‰©ä½“å¿«é€Ÿè¿åŠ¨æ—¶ï¼Œæ¯è¡ŒæŠ“æ‹ä¸‹æ¥çš„ç‰©ä½“ä½ç½®éƒ½ä¸åŒï¼Œé€ æˆäº†ç‰©ä½“çš„å˜å½¢ã€‚ è§£å†³æ–¹æ³•ï¼š - åŠ å¤§å›¾åƒè¾“å‡ºçš„é€Ÿåº¦ï¼ˆæé«˜å¸§ç‡ä¹Ÿå¯è¡Œï¼Œæœ¬è´¨ä¸Šæ”¹å˜çš„å°±æ˜¯è¾“å‡ºé€Ÿåº¦ï¼‰ - è°ƒæ•´æŠ“æ‹çš„æ—¶é—´å’Œè§’åº¦ï¼Œæ¯”å¦‚è¿œå¤„çš„è½¦è¾†æ¯å¸§ç§»åŠ¨çš„åƒç´ ç‚¹è¾ƒå°‘ï¼Œå¯ä»¥å»æŠ“æ‹ç¨è¿œå¤„çš„è½¦è¾† - ä½¿ç”¨å…¨å±€æ›å…‰çš„ sensor</li></ul><h2 id="interlaced-æ›å…‰">Interlaced æ›å…‰</h2><p>ä¸ºäº†æ”¹å–„ rolling shutter æ›å…‰æ–¹å¼å­˜åœ¨çš„é—®é¢˜ï¼Œæœ‰äººæå‡ºäº† Interlaced æ›å…‰å’Œè¯»å‡ºæ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–°çš„æ›å…‰é¡ºåºå°†ä¸€å¸§æ‹†åˆ†æˆ 8 ç»„ï¼Œç¬¬ä¸€ç»„åŒ…å«è¡Œå· {0,8,16,24...}ï¼Œç¬¬äºŒç»„åŒ…å«è¡Œå· {1,9,17,25,...} ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç¬¬å…«ç»„åŒ…å«è¡Œå· {7,15,23,31,....} ã€‚è¿™ç§æ›å…‰æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç»„ä¸ç»„ä¹‹é—´çš„æ›å…‰å»¶æ—¶ä¸ºä¸€å¸§æ—¶é—´çš„å…«åˆ†ä¹‹ä¸€ï¼Œä»¥ 1080p@30fps ä¸ºä¾‹ï¼Œä¸€å¸§çš„è¯»å‡ºæ—¶é—´å¤§è‡´åœ¨ 28ms å·¦å³ï¼Œåœ¨æ–°çš„æ›å…‰æ–¹å¼ä¸‹åƒç´ é—´çš„æœ€å¤§æ›å…‰å»¶æ—¶ä»…ä¸º 3.5msï¼Œå¯ä»¥æ›´å¥½åœ°æ•æ‰è¿åŠ¨åœºæ™¯ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel33.png"></p><h2 id="å·¥é¢‘é—ªçƒ-flicker">å·¥é¢‘é—ªçƒ (flicker)</h2><p>flicker çš„æœ¬è´¨æ˜¯åƒç´ æ›å…‰èµ·å§‹ç‚¹ç›¸å¯¹äº¤æµç”µçš„ç›¸ä½å…³ç³»åœ¨ä¸æ–­å˜åŒ–ã€‚è¿™ä¸ªé—®é¢˜ä¸ä»…å­˜åœ¨äºä¸€å¸§å›¾åƒå†…éƒ¨ï¼Œåœ¨å¸§ä¸å¸§ä¹‹é—´ä¹Ÿå­˜åœ¨åŒæ ·çš„é—®é¢˜ã€‚</p><p>ä»¥ç”µé¢‘ç‡ 50Hz ä¸ºä¾‹ï¼Œå¦‚æœ sensor å·¥ä½œåœ¨ 25 æˆ– 50fpsï¼ˆframe per secondï¼‰ï¼Œåˆ™å¸§é¢‘ç‡åˆšå¥½ä¸ç”µé¢‘ç‡åŒæ­¥ï¼Œæ¯å¸§å›¾åƒçš„ flicker è¡¨ç°ï¼ˆæ˜æš—ä½ç½®ï¼‰ä¸ä¸Šä¸€å¸§å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥æ˜æš—æ¡çº¹åœ¨è§†é¢‘ä¸Šæ˜¯é™æ­¢ä¸åŠ¨çš„ã€‚å¦‚æœ sensor å·¥ä½œåœ¨ 30 æˆ– 60fpsï¼Œåˆ™æ¯å¸§çš„ flicker ä¸ä¸Šä¸€å¸§ä¼šäº§ç”Ÿå›ºå®šçš„ç›¸ç§»ï¼Œè§†é¢‘ä¸Šçš„æ˜æš—æ¡çº¹å›¾æ ·ä¼šåœ¨ç”»é¢å‚ç›´æ–¹å‘ä¸Šç¼“æ…¢ç§»åŠ¨ã€‚</p><h2 id="å…¨å±€æ›å…‰global-shutter">å…¨å±€æ›å…‰ï¼ˆglobal shutterï¼‰</h2><p>æ¯ä¸€è¡Œçš„èµ·å§‹æ›å…‰å’Œç»ˆæ­¢æ›å…‰çš„æ—¶é—´ä¸€è‡´ï¼Œç›®å‰åªæœ‰ç”µè­¦è®¾å¤‡ä¸Šç”¨åˆ°ï¼Œä»·æ ¼æ˜‚è´µã€‚å› ä¸ºç”µè­¦è®¾å¤‡æœ‰çˆ†é—ªç¯ï¼Œçˆ†é—ªç¯äº®çš„æ—¶é—´å¾ˆçŸ­ã€‚å¦‚æœä½¿ç”¨å·å¸˜æ›å…‰çš„ sensorï¼Œä¸€å¹…å›¾åƒæ‰æ›å…‰å‡ è¡Œç¯å°±ç†„ç­äº†ï¼Œæ‰€ä»¥å¿…é¡»è¦ç”¨å…¨å±€æ›å…‰çš„ä¼ æ„Ÿå™¨ã€‚</p><h1 id="ä¸-ccd-å¯¹æ¯”">ä¸ CCD å¯¹æ¯”</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/pixel32.png"></p><p>CCD çš„ä¸€ä¸ªä¸»è¦ä¼˜ç‚¹åœ¨äºæ‰€æœ‰åƒç´ å…±äº«åŒä¸€ä¸ªç”µè·-ç”µå‹è½¬æ¢å™¨ï¼Œæ‰€ä»¥åƒç´ ä¸€è‡´æ€§éå¸¸å¥½ã€‚ç›¸æ¯”ä¹‹ä¸‹ CMOS æ¯ä¸ªåƒç´ éƒ½æœ‰è‡ªå·±ä¸“ç”¨çš„ç”µè·-ç”µå‹è½¬æ¢å™¨ï¼Œä¸€è‡´æ€§å¾ˆä¸å®¹æ˜“æ§åˆ¶ã€‚</p><p>å½“ CCD åƒç´ æ•°å¤šäº 200 ä¸‡æ—¶ï¼Œæ‰€æœ‰åƒç´ å…±ç”¨ä¸€ä¸ªç”µè·-ç”µå‹è½¬æ¢å™¨ä¼šä¸¥é‡å½±å“è¯»å‡ºé€Ÿåº¦ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè€ƒè™‘æŠŠåƒç´ è®¾è®¡æˆä¸¤ä¸ªæˆ–å››ä¸ªé˜µåˆ—ï¼Œæ¯ä¸ªé˜µåˆ—é…å¤‡ä¸“ç”¨çš„è¡Œç¼“å†²å’Œç”µè·-ç”µå‹è½¬æ¢å™¨ï¼Œå¯ä»¥æˆå€åŠ å¿«è¯»å‡ºé€Ÿåº¦ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucWlueGluZy54eXovcG9zdHMvZTZmMDUyNGEv">https://www.qinxing.xyz/posts/e6f0524a/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDA3NzcxMjE=">https://zhuanlan.zhihu.com/p/100777121<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Sensor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> ISP </tag>
            
            <tag> Sensor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Odriver ä¹‹æµ‹é€Ÿ</title>
      <link href="/2023/Algorithm/odriverSpeed/"/>
      <url>/2023/Algorithm/odriverSpeed/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¼ æ„Ÿå™¨">ä¼ æ„Ÿå™¨</h1><h2 id="ç»å¯¹ç£ç¼–ç å™¨">ç»å¯¹ç£ç¼–ç å™¨</h2><p>ç»å¯¹ç£ç¼–ç å™¨æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è¯»å¯„å­˜å™¨å°±å¯ä»¥ã€‚å®é™…ä½¿ç”¨ä¸­éœ€è¦é…åˆå¾„å‘å†²ç£çš„ç£é“ä½¿ç”¨ï¼Œä¸”æœ€å¥½èƒ½è¿œç¦»å…¶ä»–å¯èƒ½é€ æˆç£åœºå˜åŒ–çš„å™¨ä»¶ï¼›å…¶æ¬¡éœ€è¦æ³¨æ„è§’åº¦æ›´æ–°é¢‘ç‡ï¼ŒåŠ¨æ€ç‰¹æ€§ç­‰å‚æ•°ã€‚</p><span id="more"></span><h2 id="çº¿æ€§éœå°”ä¼ æ„Ÿå™¨">çº¿æ€§éœå°”ä¼ æ„Ÿå™¨</h2><p>å¯¹äºçº¿æ€§éœå°”ä¼ æ„Ÿå™¨ä¸€èˆ¬æ˜¯éœ€è¦è¿›è¡Œæ ¡å‡†çš„ï¼Œå…¶ä½¿ç”¨æ–¹æ³•ä¸€èˆ¬æ˜¯ä¸¤ä¸ªä¼ æ„Ÿå™¨å‘ˆ 80 åº¦å¯¹ç§°åˆ†å¸ƒï¼ŒåŒæ ·éœ€è¦é…åˆå¾„å‘å†²ç£çš„ç£é“ä½¿ç”¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/linear_hall1.png"></p><p>å½“ç£é“æ—‹è½¬ä¸€å‘¨çš„æ—¶å€™ï¼Œçº¿æ€§éœå°”çš„ä¼ æ„Ÿå™¨çš„è¾“å‡ºåº”è¯¥æ­£å¥½æ˜¯ä¸€ä¸ªæ­£å¼¦ä¿¡å·ï¼Œä½†æ˜¯æ­£å¼¦çš„å¹…å€¼éœ€è¦æ ¡å‡†ï¼Œè®©ä¼ æ„Ÿå™¨æ—‹è½¬ä¸€å‘¨åˆ†åˆ«è·å–æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œè¿™æ ·å°±å¯ä»¥é‡æ„ä¸€å‘¨çš„ä¿¡å·ä¸ä½ç½®çš„å…³ç³»ã€‚å•ä¸ªä¼ æ„Ÿå™¨å°±å¯ä»¥è·å–å…¨éƒ¨ä½ç½®è§’åº¦çš„ä¿¡æ¯ï¼Œä½†æ˜¯å•ä¸ªä¼ æ„Ÿå™¨å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨æ­£å¼¦æ³¢çš„æç‚¹å¤„å€¼çš„å˜åŒ–éå¸¸å°ï¼Œè€Œåœ¨çº¿æ€§åŒºåŸŸå˜åŒ–åˆ™æ¯”è¾ƒæ˜æ˜¾ï¼Œå› æ­¤ä½¿ç”¨ä¸¤ä¸ªä¼ æ„Ÿå™¨å‘ˆ 90 åº¦æ‘†æ”¾åˆ™å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¦‚ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/linear_hall2.png"></p><p>å¦‚æœ a ä¼ æ„Ÿå™¨å– sin å€¼ä¸º hall_sinï¼Œb ä¼ æ„Ÿå™¨å– cos å€¼ä¸º hall_cosï¼Œåˆ™æœ€ç»ˆçš„è§’åº¦ä¸º atan2f(hall_sin, hall_cos)ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief Hall Sensor read angle</span></span><br><span class="line"><span class="comment">  * @param None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">LinearHallAngleEncoder::LinearHallSensorGetAngle</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">float</span> hall_sin = <span class="number">0.0f</span>, hall_cos = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    LinearHallSensorReadValue();</span><br><span class="line"></span><br><span class="line">    hall_sin = (hall_raw_a_ - hall_sensor_calibration_.hall_middle_a_) / \</span><br><span class="line">              hall_sensor_calibration_.hall_amplitude_a_;</span><br><span class="line">    hall_cos = (hall_raw_b_ - hall_sensor_calibration_.hall_middle_b_) / \</span><br><span class="line">              hall_sensor_calibration_.hall_amplitude_b_;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::clamp(hall_sin, <span class="number">-1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    <span class="built_in">std</span>::clamp(hall_cos, <span class="number">-1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> atan2f(hall_sin, hall_cos);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><span class="math display">\[tan(x) = \frac{sin(a)}{cos(b)}\]</span></p><p>å½“ sin åœ¨ 1 æˆ–è€…-1 é™„è¿‘çš„æ—¶å€™ cos å€¼æ¥è¿‘ 0ï¼Œå› æ­¤è™½ç„¶ sin å€¼å˜åŒ–å¾ˆå°ï¼Œä½†æ˜¯é™¤ä»¥ cos åå°±ä¼šå˜åŒ–å¾ˆæ˜æ˜¾ï¼Œæ¯•ç«Ÿ cos å€¼è¿™ä¸ªæ—¶å€™æ˜¯å˜åŒ–æœ€æ˜æ˜¾çš„ï¼Œæ¥è¿‘çº¿æ€§çŠ¶æ€ã€‚åŒç†åœ¨ sin å€¼åœ¨ 0 é™„è¿‘çš„æ—¶å€™ï¼Œcos åœ¨ 1 é™„è¿‘ï¼Œè¿™æ—¶ sin å˜åŒ–æ˜æ˜¾ï¼Œsin å€¼é™¤ä»¥ä¸€ä¸ª 1 é™„è¿‘çš„å€¼ä»ç„¶æ˜¯å˜åŒ–æ˜æ˜¾çš„ã€‚å¤šä¹ˆç¾å¦™çš„è®¾è®¡å•Šï¼Œç¥å¥‡çš„ä¸‰è§’å‡½æ•°ï¼</p><h1 id="è½¬å­è§’åº¦å’Œé€Ÿåº¦çš„çŠ¶æ€ä¼°è®¡">è½¬å­è§’åº¦å’Œé€Ÿåº¦çš„çŠ¶æ€ä¼°è®¡</h1><h2 id="çŠ¶æ€ä¼°è®¡">çŠ¶æ€ä¼°è®¡</h2><p>ä¼°è®¡å™¨æœ‰ä¸¤ç§çŠ¶æ€ï¼šä½ç½®å’Œé€Ÿåº¦ã€‚ä½ç½®ä»¥ç¼–ç å™¨è®¡æ•°ä¸ºå•ä½ï¼Œé€Ÿåº¦ä»¥è®¡æ•°/ç§’ä¸ºå•ä½ã€‚ç”±äºç¼–ç å™¨åœ¨æˆ‘ä»¬è½¬å®Œä¸€æ•´åœˆæ—¶ä¸æ–­è®¡æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡çŠ¶æ€æ˜¯æ²¿ç€å±•å¼€çš„çº¿è€Œä¸æ˜¯è§’åº¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è°ˆè®ºä½ç½®ï¼ˆä»¥è®¡æ•°ä¸ºå•ä½ï¼‰è€Œä¸æ˜¯è§’åº¦ã€‚</p><p>å› æ­¤ï¼Œé‰´äºä½ç½®å’Œé€Ÿåº¦è¿™ä¸¤ç§çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥åšçš„æœ€ç®€å•çš„äº‹æƒ…å°±æ˜¯ä½¿ç”¨é€Ÿåº¦æ¥é¢„æµ‹éšæ—¶é—´å˜åŒ–çš„ä½ç½®ã€‚è¿™å¯¹äºåœ¨ç¦»æ•£è®¡æ•°ä¹‹é—´æ’å…¥ç¼–ç å™¨ä½ç½®å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å§‹ç»ˆä»¥ä¸€é˜¶ï¼ˆç›´çº¿ï¼‰è·Ÿè¸ªé¢„æœŸä½ç½®ï¼Œå³ä½¿æˆ‘ä»¬å¤„äºç¼–ç å™¨è„‰å†²ä¹‹é—´ã€‚è¿™æä¾›äº†æ›´å¹³æ»‘çš„æ§åˆ¶å’Œæ›´é«˜çš„æœ‰æ•ˆç²¾åº¦ã€‚ é¢„æµ‹é¢„æœŸè§’åº¦çš„ä½ç½®ä¹Ÿå¾ˆé‡è¦ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é¢„æµ‹ä¸‹ä¸€ä¸ªç¼–ç å™¨è„‰å†²ä½•æ—¶åˆ°æ¥ã€‚å¦‚æœå®ƒæ™šäº†æˆ–æ—©äº†ï¼Œè¿™ç»™äº†æˆ‘ä»¬å…³äºæˆ‘ä»¬é«˜ä¼°æˆ–ä½ä¼°äº†é€Ÿåº¦è¿™ä¸€äº‹å®çš„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼šè¿™æ˜¯è¯¥é¢„æµ‹çš„ä»£ç ï¼Œé€Ÿåº¦çš„è¶…çº§ç®€å•ä¸€é˜¶ç§¯åˆ†ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Predict current pos</span></span><br><span class="line">rotor-&gt;pll_pos += CURRENT_MEAS_PERIOD * rotor-&gt;pll_vel;</span><br></pre></td></tr></tbody></table></figure><p>å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬æ‰§è¡Œæ£€æŸ¥ç¼–ç å™¨è¾¹ç¼˜æ˜¯æ—©è¿˜æ˜¯æ™šçš„éƒ¨åˆ†ã€‚è¿™å›´ç»•ç€ä¸€ä¸ª floor å‡½æ•°ï¼Œè¯¥å‡½æ•°ä»¥å…¨æµ®ç‚¹ç²¾åº¦è·å–é¢„æµ‹è§’åº¦ï¼ˆå°±åƒç¼–ç å™¨è®¡æ•°æœ‰å¾ˆå¤šå°æ•°ä½ï¼‰ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬åº”è¯¥å¯¹åº”çš„ç¼–ç å™¨è®¡æ•°ã€‚å°±åƒå¦‚æœé¢„æµ‹è§’åº¦æ˜¯ä¸€ä¸ªæ–œå¡ï¼Œç¼–ç å™¨è®¡æ•°å°†æ˜¯ä¸€ä¸ªé˜¶æ¢¯ã€‚æˆ‘ä»¬ä½¿ç”¨ floor å‡½æ•°æ¥åšè¿™ä¸ªä»å¡é“åˆ°æ¥¼æ¢¯çš„æ˜ å°„ã€‚ å¦‚æœæˆ‘ä»¬é¢„æµ‹çš„è§’åº¦æœ‰ç‚¹è½åï¼Œæˆ‘ä»¬çš„é¢„æµ‹è¿˜æ²¡æœ‰åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œä½†ç¼–ç å™¨å·²ç»åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œdelta_pos å°†æ˜¯ 1.0f æ˜¯å®é™…ä½ç½®ä¸é¢„æµ‹ä½ç½®çš„å·®å€¼ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// discrete phase detector</span></span><br><span class="line"><span class="type">float</span> delta_pos = (<span class="type">float</span>)(rotor-&gt;encoder_state - (<span class="type">int32_t</span>)floorf(rotor-&gt;pll_pos));</span><br></pre></td></tr></tbody></table></figure><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æ˜¯æ—©è¿˜æ˜¯æ™šï¼Œç°åœ¨æˆ‘ä»¬å°±æ­¤é‡‡å–è¡ŒåŠ¨ã€‚å‡è®¾æˆ‘ä»¬è¿Ÿåˆ°äº†ï¼Œæˆ‘ä»¬éœ€è¦åŠ å¿«é€Ÿåº¦ä¼°è®¡ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢ç¬¬äºŒè¡Œã€‚åœ¨ç¬¬äºŒè¡Œä¸­ï¼Œæˆ‘ä»¬åŠ é€Ÿï¼ˆä»¥ä¸€å®šé€Ÿç‡å¢åŠ é€Ÿåº¦ï¼‰ä¸æˆ‘ä»¬çš„ä½ç½®è¯¯å·®æˆæ­£æ¯”ï¼šå°±åƒè´¨é‡å¼¹ç°§ç³»ç»Ÿä¸€æ ·ã€‚åŒæ ·ï¼Œåœ¨æ²¡æœ‰é˜»å°¼çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šå½¢æˆè°æ³¢æŒ¯è¡å™¨å¹¶å›´ç»•æ­£ç¡®å€¼æŒ¯è¡ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ é˜»å°¼ã€‚è¿™æ˜¯é€šè¿‡å°†ä½ç½®ä¼°è®¡å€¼ä¹Ÿæ›´æ¥è¿‘æµ‹é‡å€¼æ¥å®Œæˆçš„ï¼Œå› æ­¤æ˜¯ä¸‹é¢çš„ä¸€è¡Œã€‚è§£é‡Šå®ƒçš„å¦ä¸€ç§æ–¹æ³•æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ª PI å¾ªç¯ï¼Œå…¶ä¸­ç¼–ç å™¨æ˜¯æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸€äº›æœ‰é™å¸¦å®½è·Ÿè¸ªçš„è¾“å…¥ä¿¡å·ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pll feedback</span></span><br><span class="line">rotor-&gt;pll_pos += CURRENT_MEAS_PERIOD * rotor-&gt;pll_kp * delta_pos;</span><br><span class="line">rotor-&gt;pll_vel += CURRENT_MEAS_PERIOD * rotor-&gt;pll_ki * delta_pos;</span><br></pre></td></tr></tbody></table></figure><h2 id="è¾¹ç•Œå¤„ç†">è¾¹ç•Œå¤„ç†</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if we are stopped, make sure we don't randomly drift</span></span><br><span class="line"><span class="keyword">if</span> (snap_to_zero_vel || !config_.enable_phase_interpolation) {</span><br><span class="line">    interpolation_ = <span class="number">0.5f</span>;</span><br><span class="line"><span class="comment">// reset interpolation if encoder edge comes</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> This isn't correct. At high velocities the first phase in this count mayvery well not be at the edge.</span></span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (delta_enc &gt; <span class="number">0</span>) {</span><br><span class="line">    interpolation_ = <span class="number">0.0f</span>;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (delta_enc &lt; <span class="number">0</span>) {</span><br><span class="line">    interpolation_ = <span class="number">1.0f</span>;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// Interpolate (predict) between encoder counts using vel_estimate,</span></span><br><span class="line">    interpolation_ += current_meas_period * vel_estimate_counts_;</span><br><span class="line">    <span class="comment">// don't allow interpolation indicated position outside of [enc, enc+1)</span></span><br><span class="line">    <span class="keyword">if</span> (interpolation_ &gt; <span class="number">1.0f</span>) interpolation_ = <span class="number">1.0f</span>;</span><br><span class="line">    <span class="keyword">if</span> (interpolation_ &lt; <span class="number">0.0f</span>) interpolation_ = <span class="number">0.0f</span>;</span><br><span class="line">}</span><br><span class="line"><span class="type">float</span> interpolated_enc = corrected_enc + interpolation_;</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœé€Ÿåº¦ä¸º 0ï¼Œåˆ™å°†æ’å€¼å¼ºåˆ¶è®¾ç½®ä¸º 0.5ï¼Œä»…æ˜¯å–ä¸€ä¸ªä¸­é—´å€¼ï¼Œå®é™…é€Ÿåº¦ä¸º 0 çš„å¯èƒ½æ€§å¾ˆå°ã€‚å½“é¢„æµ‹è¯¯å·®å¤§äº 0 çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯é¢„æµ‹å€¼åˆšå¥½è¿‡äº†ä¼ æ„Ÿå™¨æµ‹é‡å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™æ’å€¼åº”è¯¥å¾ˆå°ï¼Œå½“ç„¶å¯¹äºé«˜é€Ÿè½¬åŠ¨çš„æ—¶å€™æ˜¯ä¸æˆç«‹çš„ï¼Œåœ¨ä½é€Ÿçš„æ—¶å€™å°†æ’å€¼è®¾ç½®ä¸º 0 æ˜¯å¯ä»¥çš„ã€‚ç›¸åå½“é¢„æµ‹è¯¯å·®å°äº 0 çš„æ—¶å€™ï¼Œå°±æ˜¯ä¼ æ„Ÿå™¨åˆšå¥½åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä½ç½®çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™é¢„æµ‹å€¼åˆšå¥½æ»åä¸€ä¸ª countï¼ˆåŒæ ·åªæœ‰åœ¨ä½é€Ÿçš„æ—¶å€™æ‰æˆç«‹ï¼‰è¿™ä¸ªæ—¶å€™æ’å€¼åº”è¯¥è®¾ç½®ä¸º 1ã€‚è€Œå½“é¢„æµ‹è¯¯å·®ä¸€ä¸ª count å†…çš„æ—¶å€™è¯´æ˜é€Ÿåº¦æ¯”è¾ƒä½ï¼Œè¿™ä¸ªæ—¶å€™æ’å€¼åº”è¯¥æ ¹æ®é¢„æµ‹çš„é€Ÿåº¦æ¥è®¡ç®—ï¼Œå¯¹é¢„æµ‹é€Ÿåº¦è¿›è¡Œç§¯åˆ†ã€‚ä½†æ˜¯ç§¯åˆ†çš„ä¸Šä¸‹é™å°±æ˜¯ä¸€ä¸ª count å³ [0,1]ã€‚æœ€åå°†ä¼ æ„Ÿå™¨è¯»å‡ºæ¥çš„å€¼åŠ ä¸Šæ’å€¼å°±æ˜¯é¢„ä¼°çš„è§’åº¦ã€‚</p><h1 id="å‚æ•°è®¾è®¡">å‚æ•°è®¾è®¡</h1><h2 id="è°ƒèŠ‚">è°ƒèŠ‚</h2><p>æˆ‘ä»¬å¦‚ä½•é€‰æ‹©è¿™äº›å¢ç›Šï¼Ÿä¸ä»»ä½•è¿‡æ»¤å™¨ä¸€æ ·ï¼Œéœ€è¦æƒè¡¡å»¶è¿Ÿä¸å¹³æ»‘åº¦ã€‚åˆé€‚çš„å€¼å–å†³äºç¼–ç å™¨çš„åˆ†è¾¨ç‡å’Œåº”ç”¨ç¨‹åºã€‚é«˜å¸¦å®½æ§åˆ¶éœ€è¦é«˜å¸¦å®½çŠ¶æ€ä¼°è®¡ï¼Œä½†ä»£ä»·æ˜¯å¯¹ç¼–ç å™¨è„‰å†²çš„ååº”æ›´æ•é”ã€‚ æ›´é«˜åˆ†è¾¨ç‡çš„ç¼–ç å™¨æ„å‘³ç€æ¯ä¸ªè„‰å†²åœ¨â€œé˜¶æ¢¯â€ä¸­å…·æœ‰æ›´å°çš„å¹…åº¦ï¼Œå› æ­¤æ‚¨å¾—åˆ°çš„ååº”ä¸é‚£ä¹ˆå°–é”ï¼Œå› æ­¤æ‚¨å¯ä»¥é’ˆå¯¹ç³»ç»Ÿä¸­ç›¸åŒå¹…åº¦çš„å™ªå£°/æŒ¯é“ƒè°ƒé«˜å¸¦å®½ã€‚</p><h2 id="ç†è®º">ç†è®º</h2><h3 id="é˜»å°¼æ¯”">é˜»å°¼æ¯”</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/Damped_spring.gif"></p><p>å½“å¼¹ç°§è´¨é‡ç³»ç»Ÿå®Œå…¨æ²¡æœ‰æŸè€—ï¼Œè´¨é‡ä¼šä¸€ç›´æ‘†åŠ¨ï¼Œä¸ä¼šç»“æŸï¼Œæ¯ä¸€æ¬¡çš„æ‘†åŠ¨æŒ¯å¹…éƒ½å’Œä¹‹å‰ä¸€æ ·ï¼Œè¿™ç§ç†æƒ³æƒ…å½¢ç§°ä¸ºæ— é˜»å°¼ã€‚ è‹¥ç³»ç»Ÿçš„æŸè€—å¾ˆå¤§ï¼Œä¾‹å¦‚å¼¹ç°§è´¨é‡ç³»ç»Ÿæ”¾ç½®åœ¨é»æ»çš„æ¶²ä½“ä¸­ï¼Œç³»ç»Ÿä¼šæ…¢æ…¢çš„å›åˆ°åˆå§‹ä½ç½®ï¼Œç”šè‡³ä¸ä¼šè¿‡å†²ï¼Œè¿™ç§°ä¸ºè¿‡é˜»å°¼ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨æ‘†åŠ¨æ—¶ä¼šå‡ºç°è¿‡å†²ï¼Œå†å¾€å¦ä¸€è¾¹æ‘†åŠ¨ï¼Œå†å›æ¥ï¼Œåœ¨æ‘†åŠ¨è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿæ¶ˆè€—äº†ä¸€äº›èƒ½é‡ï¼Œè€Œæ‘†åŠ¨æŒ¯å¹…ä¹Ÿä¼šè¶Šæ¥è¶Šå°ï¼Œæœ€åå›åˆ°åˆå§‹ä½ç½®ï¼Œè¿™ç§°ä¸ºæ¬ é˜»å°¼ã€‚ åœ¨è¿‡é˜»å°¼åŠæ¬ é˜»å°¼äºŒä¸ªæ¡ä»¶ä¹‹é—´ï¼Œæœ‰ä¸€ä¸ªç‰¹å®šçš„æƒ…å½¢æ˜¯ç³»ç»Ÿä¸ä¼šè¿‡å†²ï¼Œä¼šåœ¨æœ€å¿«æ—¶é—´å›åˆ°åˆå§‹ä½ç½®ï¼Œè¿™ç§°ä¸ºä¸´ç•Œé˜»å°¼ã€‚ä¸´ç•Œé˜»å°¼å’Œè¿‡é˜»å°¼éƒ½ä¸ä¼šè¿‡å†²ï¼Œè€Œä¸´ç•Œé˜»å°¼æ˜¯æœ€å¿«å›åˆ°åˆå§‹ä½ç½®çš„é‚£ä¸€ä¸ªé˜»å°¼æ¡ä»¶ã€‚</p><h3 id="é˜»å°¼æ¯”å®šä¹‰">é˜»å°¼æ¯”å®šä¹‰</h3><p>é˜»å°¼æ¯”å¸¸ç”¨Î¶è¡¨ç¤ºï¼Œæ˜¯äºŒé˜¶å¾®åˆ†æ–¹ç¨‹æ­¥é˜¶å“åº”åŠé¢‘ç‡å“åº”çš„å‚æ•°ä¹‹ä¸€ã€‚åœ¨æ§åˆ¶ç†è®ºåŠè°æŒ¯å­ä¸­ç›¸å½“é‡è¦ã€‚é˜»å°¼æ¯”è¡¨ç¤ºç³»ç»Ÿçš„é˜»å°¼ç›¸å¯¹äºä¸´ç•Œé˜»å°¼çš„æ¯”å€¼ã€‚</p><h3 id="äºŒé˜¶ç³»ç»Ÿç›¸å¯¹äºé˜»å°¼æ¯”-Î¶-çš„é˜¶è·ƒå“åº”">äºŒé˜¶ç³»ç»Ÿç›¸å¯¹äºé˜»å°¼æ¯” Î¶ çš„é˜¶è·ƒå“åº”</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/preview.jpg"></p><ul><li>è¿‡é˜»å°¼æŒ¯è¡ã€‚é˜»å°¼æ¯”å¤§äº 1ï¼Œæç‚¹å‡ä¸ºè´Ÿå®æ•°ã€‚ç³»ç»Ÿåœ¨æ²¡æœ‰æŒ¯è¡çš„æƒ…å†µä¸‹è¾¾åˆ°ç¨³å®šçŠ¶æ€ã€‚éšç€é˜»å°¼æ¯”çš„å¢åŠ ï¼Œå®ƒè¾¾åˆ°ç¨³æ€çš„é€Ÿåº¦å˜æ…¢ã€‚</li><li>æ— é˜»å°¼æŒ¯è¡ã€‚æ³¨æ„æ‰€æœ‰çš„æç‚¹éƒ½åœ¨è™šè½´ä¸Šã€‚é˜»å°¼æ¯”ä¸ºé›¶ï¼Œå­˜åœ¨æ— é˜»å°¼æŒ¯è¡ã€‚</li><li>æ¬ é˜»å°¼æŒ¯è¡ã€‚é˜»å°¼æ¯”åœ¨ 0~1 ä¹‹é—´ï¼Œæç‚¹ä¸ºè´Ÿå®éƒ¨çš„å¤æ•°ã€‚å½“ç³»ç»Ÿè¾¾åˆ°ç¨³å®šçŠ¶æ€æ—¶ï¼ŒæŒ¯è¡é€æ¸å‡å°åˆ°é›¶ã€‚</li><li>ä¸´ç•Œé˜»å°¼æŒ¯è¡ã€‚åœ¨æ²¡æœ‰æŒ¯è¡çš„æƒ…å†µä¸‹ä»¥æœ€å¿«çš„æ–¹å¼è¾¾åˆ°ç¨³å®šçŠ¶æ€ã€‚è¿™ä¸¤ä¸ªæç‚¹å…·æœ‰ç›¸åŒçš„è´Ÿå€¼ã€‚</li></ul><p>æ›´å®šé‡åœ°è¯´ï¼Œè¶Šé å·¦çš„æç‚¹â€œè¶Šå¿«â€ï¼ˆæ›´é«˜çš„å¸¦å®½ï¼‰é€¼è¿‘ï¼Œå…·æœ‰æ›´å¤§è™šéƒ¨çš„æç‚¹ä»¥æ›´é«˜çš„é¢‘ç‡æŒ¯è¡ã€‚æœ‰ä»€ä¹ˆä¸åŒï¼ŸåŒæ ·ï¼Œè¿™æœ€å¥½ç”¨å›¾ç‰‡æ˜¾ç¤ºï¼š</p><p>è¯·æ³¨æ„ï¼Œåœ¨æ‰€æœ‰è¿™äº›ä¸­ï¼Œæç‚¹ä½ç½®çš„å•ä½å¯ä»¥é‡‡ç”¨å¼§åº¦/ç§’ã€‚å› æ­¤ï¼Œå¦‚æœæå¯¹ä½äºï¼ˆ-2 Â± 5iï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªé¢‘ç‡ä¸º 5 å¼§åº¦/ç§’çš„æ­£å¼¦å“åº”ï¼Œå®ƒä»¥ 2 å¼§åº¦/ç§’çš„é€Ÿåº¦è¡°å‡ã€‚</p><p>æ‰€ä»¥å‡è®¾è“è‰²è½¨è¿¹æ˜¯å“åº”è¾“å…¥ä½ç½®çªç„¶å¢åŠ çš„ä½ç½®ï¼Œå³ç¼–ç å™¨è¾“å…¥å˜åŒ–ã€‚å‡è®¾æˆ‘ä»¬å¸Œæœ›è¿‡æ»¤åçš„è¾“å‡ºå°½å¯èƒ½å¿«åœ°è·Ÿè¸ªå®ƒï¼Œè€Œä¸ä¼šè¿‡å†²ã€‚å½“ä¸¤ä¸ªæç‚¹ï¼ˆçº¢è‰²çš„ Xï¼‰æ°å¥½åœ¨å½¼æ­¤çš„é¡¶éƒ¨æ—¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼šè¿™ç§°ä¸ºä¸´ç•Œé˜»å°¼ï¼ˆè¯·å‚è§ç¬¬ä¸€å¼ å›¾ç‰‡ä¸­å³ä¸‹è§’çš„ç¤ºä¾‹ï¼‰ã€‚</p><h3 id="æç‚¹">æç‚¹</h3><p>ã€‚</p><h2 id="æ¨å¯¼">æ¨å¯¼</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº› P å’Œ I å¢ç›Šï¼ˆ <span class="math inline">\(K_p\)</span> å’Œ <span class="math inline">\(K_i\)</span>ï¼‰ï¼Œæç‚¹æ˜¯ä»€ä¹ˆï¼Œå› æ­¤å¸¦å®½æ˜¯å¤šå°‘ï¼Œé˜»å°¼æ˜¯å¤šå°‘ï¼Ÿæˆ‘é€‰æ‹©å°†å…¶å¯¼å‡ºä¸ºä¸€ä¸ªè¿ç»­æ—¶é—´ç³»ç»Ÿï¼ˆç”¨ç¦»æ•£æ—¶é—´æ¥è¿‘ä¼¼ï¼‰ã€‚</p><p>æ‰€ä»¥ä¸‹é¢çš„æ–¹ç¨‹å¼æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œp æ˜¯ä½ç½®ï¼Œv é€Ÿåº¦ã€‚ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå˜é‡æ¥ e è¡¨ç¤ºä½ç½®çŠ¶æ€å’Œç¼–ç å™¨è¯»æ•°ä¹‹é—´çš„è¯¯å·®ï¼Œåè€…æŒ‡å®š <span class="math inline">\(p_i\)</span> ä¸ºè¾“å…¥ä½ç½®ã€‚å› æ­¤å°†ä¸¤ä¸ªæ–¹ç¨‹å†™æˆçŸ©é˜µæ ¼å¼ã€‚</p><p><span class="math display">\[\dot{p} = v + k_p \cdot  e = v + k_p (p_i - p) \tag{1}\]</span></p><p><span class="math display">\[\dot{v} = k_i \cdot e = k_i (p_i - p) \tag{2}\]</span></p><p>å†™æˆçŸ©é˜µï¼š</p><p><span class="math display">\[\begin{bmatrix}\dot{p}  \\\dot{v}\end{bmatrix} =\begin{pmatrix}-k_p  &amp; 1 \\-k_i  &amp; 0\end{pmatrix}\begin{bmatrix}p \\v\end{bmatrix}+\begin{bmatrix}k_p \\k_i\end{bmatrix} p_i \tag{3}\]</span></p><p>è¿™ä¸ªç³»ç»Ÿçš„æç‚¹ç­‰äºå·¦è¾¹çŸ©é˜µçš„ç‰¹å¾å€¼ï¼Œç³»ç»ŸçŸ©é˜µï¼Œé€šå¸¸ç§°ä¸º Aã€‚</p><p>å¥½çš„ï¼ŒçŸ©é˜µçš„ç‰¹å¾å€¼æ˜¯å¤šå°‘ï¼Ÿæœ‰äº†ç°ä»£æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥è®©è®¡ç®—æœºä¸ºæˆ‘ä»¬åšè¿™äº›ï¼šæˆ‘ä»¬ä½¿ç”¨ SymPyã€‚åœ¨ SymPy ç°åœºäº²è‡ªå°è¯•è¾“å…¥æ­¤å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Matrix([[-x, 1], [-y, 0]]).eigenvals()</span><br></pre></td></tr></tbody></table></figure><p>å‡è£…é‚£ x æ„å‘³ç€ <span class="math inline">\(K_p\)</span> é‚£ y æ„å‘³ç€ <span class="math inline">\(K_i\)</span> ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ï¼š</p><p><span class="math display">\[p_{ok} = \frac{-k_p}{2} \pm \frac{\sqrt{k_p^2 - 4 k_i}}{2} \cdot  i \tag{4}\]</span></p><p>æˆ‘ä»¬å¸Œæœ›æç‚¹çš„å®éƒ¨æ˜¯æŸä¸ªç‰¹å®šæ•°å­—ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„å¸¦å®½ï¼ˆä»¥å¼§åº¦/ç§’ä¸ºå•ä½ï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›è™šéƒ¨åœ¨ä¸¤ä¸ªæç‚¹ä¸Šéƒ½ä¸ºé›¶ã€‚</p><p><span class="math display">\[k_p = -2 \cdot p_{ok} \tag{5}\]</span></p><p><span class="math display">\[k_i = \frac{k_p^2}{4} \tag{6}\]</span></p><p>è¿™æ­£æ˜¯ä»£ç ä¸­çš„å†…å®¹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">motor-&gt;rotor.pll_kp = <span class="number">2.0f</span> * rotor_pll_bandwidth;</span><br><span class="line"><span class="comment">// Critically damped</span></span><br><span class="line">motor-&gt;rotor.pll_ki = <span class="number">0.25f</span> * (motor-&gt;rotor.pll_kp * motor-&gt;rotor.pll_kp);</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9kaXNjb3Vyc2Uub2RyaXZlcm9ib3RpY3MuY29tL3Qvcm90b3ItZW5jb2Rlci1wbGwtYW5kLXZlbG9jaXR5LzIyNC80">https://discourse.odriverobotics.com/t/rotor-encoder-pll-and-velocity/224/4<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cudGkuY29tLmNuL3poLWNuL3NlbnNvcnMvbWFnbmV0aWMtc2Vuc29ycy9saW5lYXItaGFsbC1lZmZlY3Qtc2Vuc29ycy9wcm9kdWN0cy5odG1s">https://www.ti.com.cn/zh-cn/sensors/magnetic-sensors/linear-hall-effect-sensors/products.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cudGkuY29tLmNuL3Byb2R1Y3QvY24vRFJWNTA1NQ==">https://www.ti.com.cn/product/cn/DRV5055<i class="fa fa-external-link-alt"></i></span><br><a href="https://figshare.com/articles/figure/_Step_response_of_a_second_order_system_with_respect_to_the_damping_ratio_950_the_poles_are_shown_as_X_/500243">https://figshare.com/articles/figure/<em>Step_response_of_a_second_order_system_with_respect_to_the_damping_ratio_950_the_poles_are_shown_as_X</em>/500243</a><br><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLyVFOSU5OCVCQiVFNSVCMCVCQyVFNiVBRiU5NA==">https://www.wikiwand.com/zh/%E9%98%BB%E5%B0%BC%E6%AF%94<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Odriver </tag>
            
            <tag> Actuator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>odriver ä¹‹ SVM</title>
      <link href="/2022/Algorithm/odriverSVM/"/>
      <url>/2022/Algorithm/odriverSVM/</url>
      
        <content type="html"><![CDATA[<h1 id="æºç ">æºç </h1><p>SVM å‡½æ•°çš„ alpha å’Œ beta çš„å€¼æ˜¯ç»è¿‡äº†æ ‡å¹ºåŒ–ï¼ŒåŸºå‡†å€¼ä¸º ï¼ˆæœ€å¤§ç›¸ç”µå‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ alpha å’Œ beta çš„èŒƒå›´æ˜¯ [-1,1]ã€‚çº¦æŸï¼šalpha-beta å‘é‡çš„å¤§å°ä¸å¾—å¤§äº $  $ã€‚</p><span id="more"></span><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Compute rising edge timings (0.0 - 1.0) as a function of alpha-beta</span></span><br><span class="line"><span class="comment">// as per the magnitude invariant clarke transform</span></span><br><span class="line"><span class="comment">// The magnitude of the alpha-beta vector may not be larger than sqrt(3)/2</span></span><br><span class="line"><span class="comment">// Returns true on success, and false if the input was out of range</span></span><br><span class="line"><span class="built_in">std</span>::tuple&lt;<span class="type">float</span>, <span class="type">float</span>, <span class="type">float</span>, <span class="type">bool</span>&gt; <span class="title function_">SVM</span><span class="params">(<span class="type">float</span> alpha, <span class="type">float</span> beta)</span> {</span><br><span class="line">    <span class="type">float</span> tA, tB, tC;</span><br><span class="line">    <span class="type">int</span> Sextant;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beta &gt;= <span class="number">0.0f</span>) {</span><br><span class="line">        <span class="keyword">if</span> (alpha &gt;= <span class="number">0.0f</span>) {</span><br><span class="line">            <span class="comment">//quadrant I</span></span><br><span class="line">            <span class="keyword">if</span> (one_by_sqrt3 * beta &gt; alpha)</span><br><span class="line">                Sextant = <span class="number">2</span>; <span class="comment">//sextant v2-v3</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Sextant = <span class="number">1</span>; <span class="comment">//sextant v1-v2</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//quadrant II</span></span><br><span class="line">            <span class="keyword">if</span> (-one_by_sqrt3 * beta &gt; alpha)</span><br><span class="line">                Sextant = <span class="number">3</span>; <span class="comment">//sextant v3-v4</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Sextant = <span class="number">2</span>; <span class="comment">//sextant v2-v3</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (alpha &gt;= <span class="number">0.0f</span>) {</span><br><span class="line">            <span class="comment">//quadrant IV</span></span><br><span class="line">            <span class="keyword">if</span> (-one_by_sqrt3 * beta &gt; alpha)</span><br><span class="line">                Sextant = <span class="number">5</span>; <span class="comment">//sextant v5-v6</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Sextant = <span class="number">6</span>; <span class="comment">//sextant v6-v1</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//quadrant III</span></span><br><span class="line">            <span class="keyword">if</span> (one_by_sqrt3 * beta &gt; alpha)</span><br><span class="line">                Sextant = <span class="number">4</span>; <span class="comment">//sextant v4-v5</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Sextant = <span class="number">5</span>; <span class="comment">//sextant v5-v6</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (Sextant) {</span><br><span class="line">        <span class="comment">// sextant v1-v2</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t1 = alpha - one_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t2 = two_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tA = (<span class="number">1.0f</span> - t1 - t2) * <span class="number">0.5f</span>;</span><br><span class="line">            tB = tA + t1;</span><br><span class="line">            tC = tB + t2;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sextant v2-v3</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t2 = alpha + one_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t3 = -alpha + one_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tB = (<span class="number">1.0f</span> - t2 - t3) * <span class="number">0.5f</span>;</span><br><span class="line">            tA = tB + t3;</span><br><span class="line">            tC = tA + t2;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sextant v3-v4</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t3 = two_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t4 = -alpha - one_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tB = (<span class="number">1.0f</span> - t3 - t4) * <span class="number">0.5f</span>;</span><br><span class="line">            tC = tB + t3;</span><br><span class="line">            tA = tC + t4;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sextant v4-v5</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t4 = -alpha + one_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t5 = -two_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tC = (<span class="number">1.0f</span> - t4 - t5) * <span class="number">0.5f</span>;</span><br><span class="line">            tB = tC + t5;</span><br><span class="line">            tA = tB + t4;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sextant v5-v6</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t5 = -alpha - one_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t6 = alpha - one_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tC = (<span class="number">1.0f</span> - t5 - t6) * <span class="number">0.5f</span>;</span><br><span class="line">            tA = tC + t5;</span><br><span class="line">            tB = tA + t6;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sextant v6-v1</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: {</span><br><span class="line">            <span class="comment">// Vector on-times</span></span><br><span class="line">            <span class="type">float</span> t6 = -two_by_sqrt3 * beta;</span><br><span class="line">            <span class="type">float</span> t1 = alpha + one_by_sqrt3 * beta;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// PWM timings</span></span><br><span class="line">            tA = (<span class="number">1.0f</span> - t6 - t1) * <span class="number">0.5f</span>;</span><br><span class="line">            tC = tA + t1;</span><br><span class="line">            tB = tC + t6;</span><br><span class="line">        } <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> result_valid =</span><br><span class="line">            tA &gt;= <span class="number">0.0f</span> &amp;&amp; tA &lt;= <span class="number">1.0f</span></span><br><span class="line">         &amp;&amp; tB &gt;= <span class="number">0.0f</span> &amp;&amp; tB &lt;= <span class="number">1.0f</span></span><br><span class="line">         &amp;&amp; tC &gt;= <span class="number">0.0f</span> &amp;&amp; tC &lt;= <span class="number">1.0f</span>;</span><br><span class="line">    <span class="keyword">return</span> {tA, tB, tC, result_valid};</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‡½æ•°ä¸»ä½“ä¸Šå¯ä»¥åˆ†ä¸º 2 å¤§å—ï¼Œç¬¬ä¸€å¤§å—æ˜¯ä¸ªå¤åˆçš„ if è¯­å¥ï¼Œç”¨äºåˆ¤æ–­æ‰‡åŒºï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯ä¸ª switch è¯­å¥ï¼Œç”¨äºè®¡ç®—å®šæ—¶å™¨çš„æ¯”è¾ƒå€¼ï¼Œç”¨äºäº§ç”Ÿä¸åŒå ç©ºæ¯”çš„ PWMã€‚</p><h1 id="æ‰‡åŒºåˆ¤æ–­">æ‰‡åŒºåˆ¤æ–­</h1><p>å¯¹äºç¬¬ä¸€éƒ¨åˆ†æ‰‡åŒºåˆ¤æ–­ï¼Œä»¥ç¬¬ 1 æ‰‡åŒºä¸ºä¾‹è¯´æ˜ã€‚</p><p>å¦‚å›¾ 1 æ‰€ç¤ºï¼Œç»™å®šçš„$ <span class="math inline">\(å€¼ä½¿å¾—å…¶åˆå‘é‡è“è‰²çš„\)</span>vref<span class="math inline">\(ä½äºç¬¬ 1 æ‰‡åŒºã€‚åˆ†æä¸€ä¸‹ä½äºç¬¬ 1 æ‰‡åŒºçš„\)</span> <span class="math inline">\(æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯ ï¼Œä½†è¿™åº”è¯¥æ˜¯ä½äºç¬¬ä¸€è±¡é™çš„ç‰¹ç‚¹ï¼Œè¿˜æœ‰ 30Â°çš„èŒƒå›´ä¸å±äºç¬¬ 1 æ‰‡åŒºï¼Œç»§ç»­åˆ†æã€‚æ¯ä¸ªæ‰‡åŒºéƒ½æ˜¯ 60Â°ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ä¸‰è§’å‡½æ•°æ¥ç¡®å®š\)</span> <span class="math inline">\(å’Œ\)</span> <span class="math inline">\(çš„å…³ç³»ã€‚è¿‡ 110 è½´ä¸Šä»»æ„ç‚¹ P åš 100 è½´çš„å‚çº¿ PAï¼Œåˆ™Î”OPA æ˜¾ç„¶ä¸ºç›´è§’ä¸‰è§’å½¢ï¼Œä¸”âˆ PAO=90Â°ï¼Œâˆ POA=60Â°ï¼Œâˆ OPA=30Â°ï¼Œæ­¤æ—¶ï¼Œæ­£å¥½æ˜¯\)</span> <span class="math inline">\(çš„åˆå‘é‡æ°å¥½ä½äº 110 è½´çš„æƒ…å½¢ï¼Œå½“\)</span><span class="math inline">\(çš„å€¼ç•¥å°æˆ–\)</span>$çš„å€¼ç•¥å¤§æ—¶ï¼Œâˆ POA éƒ½å°†å°äº 60Â°ï¼Œåˆå‘é‡è½å…¥ç¬¬ 1 æ‰‡åŒºã€‚ä»æ•°å­¦ä¸Šè¯´</p><p><span class="math display">\[\angle POA = arctan \frac{PA}{ OA} = arctan \frac{\beta}{ \alpha} &lt; 60Â°\]</span></p><p>å³å¯ä½œä¸º 1 æ‰‡åŒºåˆ¤æ–­æ¡ä»¶ï¼Œåæ¶ˆæ¯æ˜¯ arctan åœ¨ MCU ä¸Šè®¡ç®—å¾—æ…¢ï¼Œæ‰€ä»¥å¾—æ¢æ¢æ€è·¯ã€‚</p><p><span class="math display">\[tan \angle POA = \frac{\beta}{ \alpha}\]</span></p><p>è¿™æ˜¯ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„ç»“è®ºï¼Œå½“åˆå‘é‡æ°å¥½ä½äº 110 è½´æ—¶$ tan60Â° =  $ ï¼Œä¹Ÿå°±æ˜¯$ =  $ ï¼Œå¦‚æœå’Œç¨‹åºä¸­çš„è¡¨è¿°ä¸€è‡´çš„è¯ï¼Œå°±æ˜¯<span class="math inline">\(\alpha = \frac{1}{ \sqrt{3}} \beta\)</span> ã€‚å½“<span class="math inline">\(\beta\)</span>å‡å°<span class="math inline">\(\alpha\)</span>ä¸å˜æˆ–<span class="math inline">\(\alpha\)</span>å¢å¤§<span class="math inline">\(\beta\)</span>ä¸å˜æ—¶ï¼Œåˆå‘é‡éƒ½å°†ä» 110 è½´è½¬å‘ 1 æ‰‡åŒºï¼Œåä¹‹åˆ™è½¬å…¥ 2 æ‰‡åŒºã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svm1.png"></p><p>ç»¼ä¸Šæ‰€è¿°å¾—åˆ°ç»“è®ºï¼Œå½“$&gt; 0, &gt; 0 $ ä¸” <span class="math inline">\(\beta &gt; \sqrt{3} \alpha\)</span> åˆå‘é‡è½åœ¨ç¬¬ 1 æ‰‡åŒºï¼› å½“$&gt; 0, &gt; 0 $ ä¸” <span class="math inline">\(\beta &lt; \sqrt{3} \alpha\)</span>ï¼Œåˆå‘é‡è½åœ¨ç¬¬ 2 æ‰‡åŒºã€‚</p><h1 id="pwm-å€¼è®¡ç®—">PWM å€¼è®¡ç®—</h1><p>æ¥ä¸‹æ¥èŠä¸€èŠ PWM æ¯”è¾ƒå€¼æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Œè¿™æ¬¡ä»¥ç¬¬ 2 æ‰‡åŒºä¸ºä¾‹ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚</p><p>åœ¨ç¬¬ 2 æ‰‡åŒºçš„åˆå‘é‡æ˜¯éœ€è¦å€ŸåŠ© 010 å’Œ 110 è¿™ä¸¤ä¸ªåŸºæœ¬å‘é‡åˆæˆå¾—åˆ°ï¼Œä¼ å…¥ SVM å‡½æ•°çš„å‚æ•° alpha å’Œ beta çš„åˆå‘é‡æ˜¯<span class="math inline">\(Vref\)</span>ã€‚ç„¶åè€ƒè™‘å°† <span class="math inline">\(\alpha\)</span> å’Œ<span class="math inline">\(\beta\)</span>çš„å€¼éƒ½åˆ†è§£åˆ° 010 å’Œ 110 è¿™ä¸¤ä¸ªåŸºæœ¬å‘é‡ä¸Šã€‚å°†<span class="math inline">\(\alpha\)</span> åœ¨ 100 è½´çš„ç«¯ç‚¹ç§°ä¸º A ç‚¹ï¼Œ<span class="math inline">\(\beta\)</span>ç«¯ç‚¹ç§°ä¸º B ç‚¹ã€‚</p><p>å…ˆè¯•ç€åˆ†è§£<span class="math inline">\(\alpha\)</span>å‘é‡ï¼Œè¿‡ A ç‚¹ä½œ 110ï¼ˆ001ï¼‰è½´çš„å¹³è¡Œçº¿äº¤ 101 è½´äº C ç‚¹ã€‚è¿‡ A ç‚¹ä½œ 010ï¼ˆ101ï¼‰è½´å¹³è¡Œçº¿äº¤ 110 è½´äº D ç‚¹ã€‚åˆ†ææ˜“å¾—$ OAC OAD$ éƒ½æ˜¯ç­‰è¾¹ä¸‰è§’å½¢ã€‚å› æ­¤ï¼Œ<span class="math inline">\(\alpha\)</span>å‘é‡åˆ†è§£åˆ° 110 è½´çš„é•¿åº¦ä¹Ÿæ˜¯<span class="math inline">\(\alpha\)</span>ï¼Œåˆ†è§£åˆ° 010 è½´çš„é•¿åº¦æ˜¯<span class="math inline">\(- \alpha\)</span>ã€‚</p><p>ç„¶ååˆ†è§£<span class="math inline">\(\beta\)</span>å‘é‡ï¼Œè¿‡ B ç‚¹ä½œ 110 è½´å¹³è¡Œçº¿äº¤ 010 è½´äº E ç‚¹ï¼Œè¿‡ B ç‚¹ä½œ 010 è½´å¹³è¡Œçº¿äº¤ 110 è½´äº F ç‚¹ã€‚æ˜“åˆ†æå¾— <span class="math inline">\(\bigtriangleup OBE ã€ \bigtriangleup OBF\)</span> ä¸ºåº•è§’ä¸º 30Â°çš„ç­‰è…°ä¸‰è§’å½¢ï¼Œéœ€æ±‚ OE å’Œ OF é•¿åº¦ï¼Œä¸” OE=OF=BF=BEã€‚è¿‡ E ç‚¹ä½œ OB å‚çº¿äº¤äº Gï¼Œåˆ™ <span class="math inline">\(\bigtriangleup EGB\)</span>ä¸ºç›´è§’ä¸‰è§’å½¢ï¼Œä¸”<span class="math inline">\(\angle EBG = 30Â°\)</span> åˆ™<span class="math inline">\(BE = \frac{2}{\sqrt{3}} BG\)</span> è€Œ<span class="math inline">\(BG = \frac{1}{2} \beta\)</span> æ•…<span class="math inline">\(BE = \frac{1}{\sqrt{3}} \beta\)</span> ä¸ºæ‰€æ±‚ã€‚ å¯ä»¥ç»™ç»“è®ºäº†ï¼Œ110 è½´ä¸Šäº§ç”Ÿä½œç”¨åŠ›çš„æ—¶é—´å®šä¹‰ä¸º t2ï¼Œ010 è½´ä¸Šäº§ç”Ÿä½œç”¨åŠ›çš„æ—¶é—´å®šä¹‰ä¸º t3ã€‚åˆ™æœ‰ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svm2.png"></p><p><span class="math display">\[t3 = - \alpha + \frac{1}{\sqrt{3}} \beta\]</span></p><p><span class="math display">\[t2 = \alpha + \frac{1}{\sqrt{3}} \beta\]</span></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MDYyNDAwMzA=">https://zhuanlan.zhihu.com/p/506240030<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Odriver </tag>
            
            <tag> Actuator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FOC ç”µæµé‡‡æ ·</title>
      <link href="/2022/Algorithm/FOCCurrentSampling/"/>
      <url>/2022/Algorithm/FOCCurrentSampling/</url>
      
        <content type="html"><![CDATA[<h1 id="é‡‡æ ·ç‚¹">é‡‡æ ·ç‚¹</h1><p>åœ¨åŸºå°”éœå¤«å®šå¾‹ä¸‹ï¼Œä¸‰ç›¸ç”µæµçš„åˆåº”è¯¥ç­‰äº 0ï¼Œå› æ­¤åªéœ€è¦è·å–äº®ç›¸ç”µæµå°±å¯ä»¥é‡æ„å‡ºå®Œæ•´çš„ä¸‰ç›¸ç”µæµã€‚</p><p>å¯¹äº STM32 ä¸€èˆ¬é€šè¿‡é«˜çº§å®šæ—¶å™¨çš„ channel4 ä½œä¸º ADC çš„è§¦å‘æºï¼Œå¯¹äºä¸‹æ¡¥è‡‚ç”µæµé‡‡æ ·ï¼Œéœ€è¦åœ¨ä¸‹æ¡¥è‡‚ MOS ç®¡å¯¼ç­’çš„æ—¶å€™æ‰èƒ½å»é‡‡æ ·ï¼Œè€Œä¸”éœ€è¦åœ¨ MOS ç®¡å¯¼é€šæ—¶é—´ä»¥åŠç”µæµç¨³å®šåæ‰èƒ½é‡‡æ ·åˆ°æ¯”è¾ƒå¯é çš„ç”µæµã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/r3_2_1.png"></p><span id="more"></span><ul><li>å½“ <span class="math inline">\(\Delta_1\)</span> å¤§äºä¸¤å€çš„ $T_{dead} + T_{on} + T_{ring} + T_{conv} $ é‚£ä¹ˆåœ¨ PWM Freq Middle æ—¶åˆ»å‡ºå‘ ADC è½¬æ¢ä¹Ÿæ˜¯è¶³å¤Ÿè½¬æ¢ 3 ç›¸ä¸­ä»»æ„çš„ä¸€ç›¸ã€‚</li><li>å½“ <span class="math inline">\(\Delta_1\)</span> å¤§äº$T_{dead} + T_{on} + T_{ring} + T_{conv} é‚£ä¹ˆä» CCRmax ä¹‹åå¼€å§‹è½¬æ¢ä¹Ÿæ˜¯å¯ä»¥è½¬æ¢ 3 ç›¸ä¸­ä»»æ„çš„ä¸€ç›¸ã€‚</li><li>å½“ <span class="math inline">\(\Delta_2\)</span> &gt; <span class="math inline">\(\Delta_0\)</span> &gt; <span class="math inline">\(\Delta_1\)</span> é‚£ä¹ˆå¯¼é€šæœ€çŸ­çš„é‚£ä¸€ç›¸å°±æ²¡æœ‰è¶³å¤Ÿçš„è½¬æ¢æ—¶é—´äº†ï¼Œé‚£ä¹ˆåªèƒ½è½¬æ¢å¯¼é€šæ—¶é—´é•¿çš„é‚£ä¸¤ç›¸ã€‚</li><li><span class="math inline">\(\Delta_1\)</span> &lt; <span class="math inline">\(\Delta_0\)</span> å’Œ <span class="math inline">\(\Delta_2\)</span> &lt; <span class="math inline">\(\Delta_0\)</span> æ²¡æœ‰è¶³å¤Ÿçš„è½¬æ¢æ—¶é—´ï¼Œæœ‰ä¸¤ç›¸ç”µæµä¸å¯è·å–å°†æ— æ³•é‡å»ºä¸‰ç›¸ç”µæµã€‚</li></ul><p>å› æ­¤éœ€è¦æ ¹æ® uã€vã€w ä¸‰ç›¸ pwm çš„å ç©ºæ¯”æ¥è°ƒæ•´ timer çš„ channel 4 æ¯”è¾ƒå€¼æ¥è°ƒæ•´è§¦å‘æ—¶åˆ»å®Œæˆä¸‰ç›¸ç”µæµçš„é‡å»ºå·¥ä½œã€‚</p><h1 id="ç›¸ç”µæµé‡æ„">ç›¸ç”µæµé‡æ„</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/r3_2_2.png"></p><ul><li>å¯¹äº Sector4 å’Œ 5ï¼ŒC ç›¸å¯¼é€šæ—¶é—´æœ€é•¿ï¼Œç›¸åº”çš„å°±æ˜¯ä¸‹æ¡¥è‡‚å¯¼é€šæ—¶é—´æœ€çŸ­ï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥é‡‡é›† A å’Œ B ç›¸ç”µæµã€‚</li><li>å¯¹äº Sector2 å’Œ 3ï¼ŒB ç›¸å¯¼é€šæ—¶é—´æœ€é•¿ï¼Œç›¸åº”çš„å°±æ˜¯ä¸‹æ¡¥è‡‚å¯¼é€šæ—¶é—´æœ€çŸ­ï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥é‡‡é›† A å’Œ C ç›¸ç”µæµã€‚</li><li>å¯¹äº Sector1 å’Œ 6ï¼ŒA ç›¸å¯¼é€šæ—¶é—´æœ€é•¿ï¼Œç›¸åº”çš„å°±æ˜¯ä¸‹æ¡¥è‡‚å¯¼é€šæ—¶é—´æœ€çŸ­ï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥é‡‡é›† B å’Œ C ç›¸ç”µæµã€‚</li></ul><h1 id="å¸¸ç”¨èŠ¯ç‰‡">å¸¸ç”¨èŠ¯ç‰‡</h1><h2 id="mp6540-ç”µæµé‡‡æ ·">MP6540 ç”µæµé‡‡æ ·</h2><p>MP6540H çš„å†…éƒ¨ç”µæµé‡‡æ ·ç”µè·¯ã€‚å…¶è¾“å‡ºå¯é€šè¿‡å¤–éƒ¨ç”µé˜»å™¨ (RTERM) å’Œå‚è€ƒç”µå‹ (VREF) æ¥è®¾ç½®ã€‚ä¸¤ä¸ªç­‰å€¼ç”µé˜»è¿æ¥åˆ° ADC ç”µæºå’Œåœ°ï¼Œæ¥åœ°ç”¨äºç»ˆæ­¢è¾“å‡ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/mp6540.png"></p><p>MP6540 çš„ç”µæµé‡‡æ ·è®¡ç®—æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†è¯´æ˜äº†ã€‚</p><h2 id="drv8301drv8302-ç”µæµé‡‡æ ·">DRV8301/DRV8302 ç”µæµé‡‡æ ·</h2><p>é¦–å…ˆå°† DRV8301 çš„æ¡†å›¾åˆ—å‡ºæ¥ï¼Œå¤§è‡´äº†è§£ä¸‹ç»“æ„ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡ SNx å’Œ SPx å››ä¸ªå¼•è„šä¹‹é—´çš„ç”µé˜»æ¥é‡‡æ ·ç”µæµã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/drv8301_block.png"></p><p>å¦‚æœæˆ‘ä»¬éœ€è¦é‡‡æ ·ä¸€ä¸ªæ¡¥è‡‚çš„ç”µæµï¼Œé‚£ä¼ ç»Ÿçš„æ–¹å¼è‡ªç„¶æ˜¯ç›´æ¥åœ¨ç”µè·¯ä¸Šä¸²è”ä¸€ä¸ªé‡‡æ ·ç”µé˜»ï¼Œç„¶åé‡‡æ ·ä¸¤ç«¯ç”µå‹å³å¯ã€‚ç”±äºç”µé˜»æ˜¯ä¸²è”è¿›ç”µè·¯çš„ï¼Œæ‰€ä»¥é˜»å€¼å½“ç„¶æ˜¯è¦è¶Šä½è¶Šå¥½ã€‚ä½†æ˜¯è¿™åˆä¼šå¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼Œä½é˜»å€¼å¯¼è‡´çš„é‡‡æ ·ç²¾åº¦ä¸é«˜ï¼Œå› æ­¤éœ€è¦è¿æ”¾æ¥å®ç°ç”µæµçš„é‡‡æ ·ã€‚</p><p>æˆ‘ä»¬ä»¥ odriver åŸç†å›¾ä¸ºä¾‹è¿›è¡Œè®¡ç®—ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/odriver.png"></p><p>è¿™é‡Œ R27 å’Œ R28 ç”µé˜»å°±æ˜¯é‡‡æ ·ç”µé˜»ï¼Œ<span class="math inline">\(500u\Omega(500 * 10^{-6})\Omega\)</span>.</p><p>ä¸‹é¢æ˜¯å®˜æ–¹æ‰‹å†Œç»™å‡ºçš„ç”µæµè®¡ç®—æ–¹å¼ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/drv8301.png"></p><p>è¿™é‡Œåšå¦‚ä¸‹è¯´æ˜ï¼š <span class="math inline">\(SN_x - SN_x\)</span> æ˜¯é‡‡æ ·ç”µé˜»ä¸¤ç«¯çš„ç”µå‹å€¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦æµ‹é‡çš„å€¼ï¼Œå¾—åˆ°è¯¥å€¼åé™¤ä»¥ç”µé˜»å°±å¾—åˆ°å¯¹åº”çš„ç”µæµå€¼ã€‚Vo æ˜¯æˆ‘ä»¬ ADC å¾—åˆ°çš„å€¼ã€‚é’ˆå¯¹å®˜æ–¹ç»™å‡ºçš„å…¬å¼ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[V_o = \frac{V_{REF}}{2} - G \times (SN_x - SP_x)\]</span></p><p>åŒ–ç®€å¦‚ä¸‹ï¼š</p><p><span class="math display">\[(SN_x - SP_x) = \frac{(\frac{V_{REF}}{2} - V_o )}{G}\]</span></p><p>è¿™é‡Œ G æ˜¯ 10ã€20ã€40ã€80. <span class="math inline">\(V_{REF}\)</span>ä¸€èˆ¬æ˜¯ 3.3vï¼Œé‚£ä¹ˆå¦‚ä¸‹ï¼š</p><p><span class="math display">\[(\frac{V_{REF}}{2} - V_o ) = (\frac{3.3}{2} - \frac{ADC}{2^{12}} \times 3.3 ) = \frac{2^{11} - ADC}{2^{12}} \times 3.3\]</span></p><p>å¾—åˆ°ç”µæµå€¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[(SN_x - SP_x) = I_{measure} \times R_{Isensor} = \frac{2^{11} - ADC}{2^{12}} \times \frac{3.3}{G}\]</span></p><p>å¾—åˆ°æœ€ç»ˆç»“æœä¸ºï¼š</p><p><span class="math display">\[I_{measure} = \frac{2^{11} - ADC}{2^{12}} \times \frac{3.3}{G} \times \frac{1}{R_{Isensor}}\]</span></p><h2 id="æ­»åŒºæ—¶é—´çš„è®¡ç®—">æ­»åŒºæ—¶é—´çš„è®¡ç®—</h2><p>æˆ‘ä»¬ç”¨ä¸‹åˆ—å…¬å¼è®¡ç®—æ§åˆ¶æ­»åŒºæ—¶é—´ï¼š</p><p><span class="math display">\[t_{dead} = [(td_{offmax} - td_{onmin}) + (tpdd_{max} - tpdd_{min})] * 1.2\]</span></p><ul><li><span class="math inline">\(td_{offmax}\)</span> ï¼šMOS ç®¡æœ€å¤§å…³æ–­å»¶è¿Ÿæ—¶é—´ã€‚</li><li><span class="math inline">\(td_{onmin}\)</span>ï¼šMOS ç®¡æœ€å°å¼€é€šå»¶è¿Ÿæ—¶é—´ã€‚</li><li><span class="math inline">\(tpdd_{max}\)</span>ï¼šé©±åŠ¨å™¨æœ€å¤§ä¼ è¾“å»¶è¿Ÿæ—¶é—´ã€‚</li><li><span class="math inline">\(tpdd_{min}\)</span>ï¼šé©±åŠ¨å™¨æœ€å°ä¼ è¾“å»¶è¿Ÿæ—¶é—´ã€‚</li></ul><p>åœ¨è¯¥å…¬å¼ä¸­ï¼Œç¬¬ä¸€é¡¹<span class="math inline">\(td_{offmax}-td_{onmin}\)</span>ä¸ºæœ€å¤§å…³æ–­å»¶è¿Ÿæ—¶é—´å’Œæœ€å°å¼€é€šå»¶è¿Ÿæ—¶é—´ä¹‹å·®ã€‚è¿™ä¸€é¡¹ä¸»è¦æè¿° MOS ç®¡å™¨ä»¶ç»“åˆæ‰€ç”¨çš„é—¨æç”µé˜»çš„ç‰¹æ€§ã€‚ç”±äºä¸Šå‡å’Œä¸‹é™æ—¶é—´é€šå¸¸æ¯”å»¶è¿Ÿæ—¶é—´çŸ­å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸è€ƒè™‘å®ƒä»¬ã€‚å¦ä¸€é¡¹<span class="math inline">\(tpdd_{max} - tpdd_{min}\)</span>ä¸ºç”±é©±åŠ¨å™¨å†³å®šçš„ä¼ è¾“å»¶è¿Ÿæ—¶é—´ä¹‹å·®ï¼ˆå»¶è¿Ÿæ—¶é—´ä¸åŒ¹é…ï¼‰ã€‚è¯¥å‚æ•°é€šå¸¸å¯åœ¨é©±åŠ¨å™¨åˆ¶é€ å•†æä¾›çš„é©±åŠ¨å™¨æ•°æ®è¡¨ä¸­æŸ¥æ‰¾åˆ°ã€‚å¯¹äºåŸºäºå…‰è€¦åˆå™¨çš„é©±åŠ¨å™¨ï¼Œè¯¥å‚æ•°å€¼é€šå¸¸å¾ˆå¤§ã€‚</p><p>å¯¹äº csd18540q:</p><p><span class="math inline">\(td_{offmax}\)</span> = 20ns <span class="math inline">\(td_{onmin}\)</span> = 6ns</p><h1 id="stm32-å®ç°åŒ-adc-é‡‡æ ·ä¸‰ç”µé˜»ç”µæµ">STM32 å®ç°åŒ ADC é‡‡æ ·ä¸‰ç”µé˜»ç”µæµ</h1><h2 id="é‡æ„é‡‡æ ·ç‚¹">é‡æ„é‡‡æ ·ç‚¹</h2><p>STM32 çš„é«˜çº§å®šæ—¶å™¨æœ‰ 6 ä¸ª pwm channelï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‰ä¸‰ä¸ª channel è¾“å‡ºäº’è¡¥çš„ pwmï¼Œç¬¬å››ä¸ª channel ç”¨äºè§¦å‘ adc çš„é‡‡æ ·æ—¶åˆ»ã€‚è¿™é‡Œä¸»è¦æ˜¯æ ¹æ®æ‰‡åŒºä»¥åŠä¸‰é€šé“çš„ pwm å ç©ºæ¯”æ¥åˆ¤æ–­ç”µæµé‡‡æ ·ç‚¹æ—¶åˆ»ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  Configure the ADC for the current sampling related to sector 1.</span></span><br><span class="line"><span class="comment"> *         It means set the sampling point via TIMx_Ch4 value and polarity</span></span><br><span class="line"><span class="comment"> *         ADC sequence length and channels.</span></span><br><span class="line"><span class="comment"> *         And call the WriteTIMRegisters method.</span></span><br><span class="line"><span class="comment"> * @retval none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">R3_2_SetADCSampPointSectX</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">uint16_t</span> sampling_point;</span><br><span class="line">    <span class="type">uint16_t</span> DeltaDuty;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é€šè¿‡æ£€æŸ¥æœ€å°å ç©ºæ¯”éªŒè¯æ˜¯å¦å¯ä»¥åœ¨ PWM ä¸­é—´è¿›è¡Œé‡‡æ · */</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">uint16_t</span>)(kMCLowLevelInstance.half_pwm_period - kMCLowLevelInstance.low_duty) &gt; kMCLowLevelInstance.t_after) {</span><br><span class="line">        <span class="comment">/* å½“å¯ä»¥åœ¨ PWM å‘¨æœŸçš„ä¸­é—´è¿›è¡Œé‡‡æ ·æ—¶ï¼Œå§‹ç»ˆå¯¹æ‰€æœ‰æ‰‡åŒºçš„ç›¸åŒç›¸ä½ï¼ˆé€‰æ‹© ABï¼‰è¿›è¡Œé‡‡æ ·ï¼Œä»¥ä¾¿åœ¨åç§»é‡ä¹‹é—´å­˜åœ¨å·®å¼‚æ—¶ä¸ä¼šå¼•èµ·ç”µæµä¸è¿ç»­ */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* GetPhaseCurrent éœ€è¦çš„æ‰‡åŒºå·ï¼Œé‡‡æ · A ç›¸å’Œ B ç›¸å¯¹åº”æ‰‡åŒº 4 æˆ– 5  */</span></span><br><span class="line">        kMCLowLevelInstance.sector = SECTOR_5;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åœ¨ PWM å‘¨æœŸä¸­é—´è®¾ç½®é‡‡æ ·ç‚¹è§¦å‘å™¨ */</span></span><br><span class="line">        sampling_point = kMCLowLevelInstance.half_pwm_period - (<span class="type">uint16_t</span>)<span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">/* åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦è½¬æ¢å…·æœ‰æœ€å¤§å’Œå¯å˜äº’è¡¥å ç©ºæ¯”çš„ç›¸ä½ã€‚*/</span></span><br><span class="line">        DeltaDuty = (<span class="type">uint16_t</span>)(kMCLowLevelInstance.low_duty - kMCLowLevelInstance.mid_duty);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Definition of crossing point */</span></span><br><span class="line">        <span class="keyword">if</span> (DeltaDuty &gt; (<span class="type">uint16_t</span>)(kMCLowLevelInstance.half_pwm_period - kMCLowLevelInstance.low_duty) * <span class="number">2u</span>) {</span><br><span class="line">            sampling_point = kMCLowLevelInstance.low_duty - kMCLowLevelInstance.t_before;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            sampling_point = kMCLowLevelInstance.low_duty + kMCLowLevelInstance.t_after;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sampling_point &gt;= kMCLowLevelInstance.half_pwm_period) {</span><br><span class="line">                <span class="comment">/* ADC trigger edge must be changed from positive to negative */</span></span><br><span class="line">                kMCLowLevelInstance.adc_external_polarity_injected = (<span class="type">uint16_t</span>)LL_ADC_INJ_TRIG_EXT_FALLING;</span><br><span class="line">                sampling_point = (<span class="number">2u</span> * kMCLowLevelInstance.half_pwm_period) - sampling_point - (<span class="type">uint16_t</span>)<span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> R3_2_WriteTIMRegisters(sampling_point);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="é‡æ„ç”µæµé‡‡æ ·">é‡æ„ç”µæµé‡‡æ ·</h2><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®å½“å‰æ‰‡åŒºä»¥åŠä¸‰é€šé“çš„ pwm å ç©ºæ¯”æ¥é€‰æ‹©é‡‡æ ·å“ªä¸¤ç›¸ç”µæµï¼Œé€šå¸¸ä¸é‡‡æ ·å ç©ºæ¯”æœ€å°çš„é‚£ä¸€é€šé“ï¼Œè€Œé€šè¿‡åŸºå°”éœå¤«å®šå¾‹æ¥ç®—ç¬¬ä¸‰é€šé“çš„ç”µæµï¼Œé¿å…é‡‡æ ·åŒºé—´å¤ªå°é€ æˆçš„é‡‡æ ·ç”µæµä¸ç¨³å®šã€‚å…·ä½“ç®—æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  It computes and return latest converted motor phase currents motor</span></span><br><span class="line"><span class="comment"> * @param  pHdl: handler of the current instance of the PWM component</span></span><br><span class="line"><span class="comment"> * @retval Ia and Ib current in Curr_Components format</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">R3_2_PhaseCurrentsUpdate</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int16_t</span> i_a,i_b;</span><br><span class="line">    <span class="type">int32_t</span> aux;</span><br><span class="line">    <span class="type">uint32_t</span> adc_data_reg1, adc_data_reg2;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> sector = (<span class="type">uint8_t</span>)kMCLowLevelInstance.sector;</span><br><span class="line">    TIM_TypeDef* TIMx = kMCLowLevelInstance.TIMx;</span><br><span class="line">    adc_data_reg1 = *kMCLowLevelInstance.adc_data_reg1[sector];</span><br><span class="line">    adc_data_reg2 = *kMCLowLevelInstance.adc_data_reg2[sector];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* disable ADC trigger source */</span></span><br><span class="line">    <span class="comment">// LL_TIM_CC_DisableChannel(TIMx, LL_TIM_CHANNEL_CH4);</span></span><br><span class="line">    LL_TIM_SetTriggerOutput(TIMx, TIM_TRGO_RESET);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (sector) {</span><br><span class="line">        <span class="keyword">case</span> SECTOR_4:</span><br><span class="line">        <span class="keyword">case</span> SECTOR_5:</span><br><span class="line">            <span class="comment">/* Current on Phase C is not accessible     */</span></span><br><span class="line">            <span class="comment">/* Ia = phase_a_offset - ADC converted value) */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_a_offset) - (<span class="type">int32_t</span>)(adc_data_reg1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ia */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_a = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_a = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_a = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Ib = phase_b_offset - ADC converted value) */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_b_offset) - (<span class="type">int32_t</span>)(adc_data_reg2);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ib */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_b = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_b = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_b = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SECTOR_6:</span><br><span class="line">        <span class="keyword">case</span> SECTOR_1:</span><br><span class="line">            <span class="comment">/* Current on Phase A is not accessible     */</span></span><br><span class="line">            <span class="comment">/* Ib = phase_b_offset - ADC converted value) */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_b_offset) - (<span class="type">int32_t</span>)(adc_data_reg1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ib */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_b = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_b = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_b = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Ia = -Ic -Ib */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(adc_data_reg2) - (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_c_offset); <span class="comment">/* -Ic */</span></span><br><span class="line">            aux -= (<span class="type">int32_t</span>)i_b;                                                     <span class="comment">/* Ia  */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ia */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_a = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_a = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_a = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SECTOR_2:</span><br><span class="line">        <span class="keyword">case</span> SECTOR_3:</span><br><span class="line">            <span class="comment">/* Current on Phase B is not accessible     */</span></span><br><span class="line">            <span class="comment">/* Ia = phase_a_offset - ADC converted value) */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_a_offset) - (<span class="type">int32_t</span>)(adc_data_reg1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ia */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_a = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_a = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_a = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Ib = -Ic -Ia */</span></span><br><span class="line">            aux = (<span class="type">int32_t</span>)(adc_data_reg2) - (<span class="type">int32_t</span>)(kMCLowLevelInstance.phase_c_offset); <span class="comment">/* -Ic */</span></span><br><span class="line">            aux -= (<span class="type">int32_t</span>)i_a;                                                     <span class="comment">/* Ib */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Saturation of Ib */</span></span><br><span class="line">            <span class="keyword">if</span> (aux &gt; INT16_MAX) {</span><br><span class="line">                i_b = INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (aux &lt; -INT16_MAX) {</span><br><span class="line">                i_b = -INT16_MAX;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                i_b = (<span class="type">int16_t</span>)aux;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    kMCLowLevelInstance.current_a = i_a;</span><br><span class="line">    kMCLowLevelInstance.current_b = i_b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> MotorControlLowLevel_t kMCLowLevelInstance = {</span><br><span class="line">    .adc_config1 = {MC_ADC_CHANNEL_2  &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT),</span><br><span class="line">                   MC_ADC_CHANNEL_1  &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT),</span><br><span class="line">                   MC_ADC_CHANNEL_2  &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT)},</span><br><span class="line">    .adc_config2 = {MC_ADC_CHANNEL_12 &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT),</span><br><span class="line">                   MC_ADC_CHANNEL_12 &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT),</span><br><span class="line">                   MC_ADC_CHANNEL_2  &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT),</span><br><span class="line">                   MC_ADC_CHANNEL_12 &lt;&lt; ADC_JSQR_JSQ1_Pos | (LL_ADC_INJ_TRIG_EXT_TIM1_TRGO &amp; ~ADC_INJ_TRIG_EXT_EDGE_DEFAULT)},</span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„è¿™é‡Œ sector 1 çš„é‡‡æ ·é€šé“æ˜¯ ADC1 çš„ MC_ADC_CHANNEL_2 å’Œ ADC2 çš„ MC_ADC_CHANNEL_12ï¼Œsector2 çš„é‡‡æ ·é€šé“æ˜¯ ADC1 çš„ MC_ADC_CHANNEL_1 å’Œ ADC2 çš„ MC_ADC_CHANNEL_12ã€‚è¿™ä¸ªè¡¨æ ¼æ˜¯æ ¹æ®å‰é¢çš„ç†è®ºéƒ¨åˆ†ä»¥åŠåŸç†å›¾æ¥è®¡ç®—å¾—åˆ°çš„é€šé“ã€‚</p><p>åœ¨å¾—åˆ°åŸå§‹çš„ ADC å€¼ä¹‹åå¯ä»¥é€šè¿‡ç”µè·¯åŸç†å°† ADC è½¬æ¢ä¸ºå¯¹åº”çš„ç”µæµå€¼ï¼Œè¿™ä¸ªå°±è·Ÿå…·ä½“çš„è®¾è®¡æœ‰å…³äº†ï¼Œè¿™é‡Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubW9ub2xpdGhpY3Bvd2VyLmNuL2NuL2Rlc2lnbmluZy1hLWJydXNobGVzcy1tb3Rvci1kcml2ZXItY2lyY3VpdC13aXRoLXRoZS1tcDY1NDA=">https://www.monolithicpower.cn/cn/designing-a-brushless-motor-driver-circuit-with-the-mp6540<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cudGkuY29tL2xpdC9kcy9zeW1saW5rL2RydjgzMDEucGRmP3RzPTE2NjQ5Nzg2MDEzMTYmcmVmX3VybD1odHRwcyUyNTNBJTI1MkYlMjUyRnd3dy50aS5jb20lMjUyRnByb2R1Y3QlMjUyRkRSVjgzMDE=">https://www.ti.com/lit/ds/symlink/drv8301.pdf?ts=1664978601316&amp;ref_url=https%253A%252F%252Fwww.ti.com%252Fproduct%252FDRV8301<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Actuator </tag>
            
            <tag> FOC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·®é€Ÿè½®è¿åŠ¨å­¦è§£ç®—</title>
      <link href="/2022/Algorithm/DifferentialWheelKinematicsSolution/"/>
      <url>/2022/Algorithm/DifferentialWheelKinematicsSolution/</url>
      
        <content type="html"><![CDATA[<h1 id="å·®é€Ÿè½®è¿åŠ¨å­¦æ¨¡å‹">å·®é€Ÿè½®è¿åŠ¨å­¦æ¨¡å‹</h1><h2 id="æœºå™¨äººåæ ‡ç³»ä¸‹çš„å˜æ¢">æœºå™¨äººåæ ‡ç³»ä¸‹çš„å˜æ¢</h2><p>è¿åŠ¨ç‰¹æ€§ä¸ºä¸¤è½®å·®é€Ÿé©±åŠ¨ï¼Œå…¶åº•éƒ¨åæ–¹ä¸¤ä¸ªåŒæ„é©±åŠ¨è½®çš„è½¬åŠ¨ä¸ºå…¶æä¾›åŠ¨åŠ›ï¼Œå‰æ–¹çš„éšåŠ¨è½®èµ·æ”¯æ’‘ä½œç”¨å¹¶ä¸æ¨åŠ¨å…¶è¿åŠ¨ï¼Œå¦‚ä¸‹å›¾ä¸¤è½®å·®é€Ÿé©±åŠ¨ç¤ºæ„å›¾æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/differential_wheel_chassis.png"></p><p>æœºå™¨äººçš„è¿åŠ¨ç®€åŒ–æ¨¡å‹å¦‚å›¾ 4-1 æ‰€ç¤ºï¼ŒX è½´æ­£æ–¹å‘ä¸ºå‰è¿›ã€Y è½´æ­£æ–¹å‘ä¸ºå·¦å¹³ç§»ã€Z è½´æ­£æ–¹å‘ä¸ºé€†æ—¶é’ˆã€‚æœºå™¨äººä¸¤ä¸ªè½®å­ä¹‹é—´çš„é—´è·ä¸º Dï¼Œæœºå™¨äºº X è½´å’Œ Z è½´çš„é€Ÿåº¦åˆ†åˆ«ä¸ºï¼š<span class="math inline">\(V_x\)</span>å’Œ<span class="math inline">\(V_z\)</span> ï¼Œæœºå™¨äººå·¦è½®å’Œå³è½®çš„é€Ÿåº¦åˆ†åˆ«ä¸ºï¼š<span class="math inline">\(V_l\)</span> å’Œ<span class="math inline">\(V_r\)</span>ã€‚</p><p>å‡è®¾æœºå™¨äººå¾€ä¸€ä¸ªå·¦å‰çš„æ–¹å‘è¡Œè¿›äº†ä¸€æ®µè·ç¦»ï¼Œè®¾æœºå™¨äººçš„å³è½®æ¯”å·¦è½®å¤šèµ°çš„è·ç¦»è¿‘ä¼¼ä¸º K, ä»¥æœºå™¨äººçš„è½®å­ä¸Šçš„ç‚¹ä½œä¸ºå‚è€ƒç‚¹åšå»¶é•¿å‚è€ƒçº¿ï¼Œå¯å¾—ï¼š<span class="math inline">\(Î¸_1 = Î¸_2\)</span> ã€‚ç”±äºè¿™ä¸ª<span class="math inline">\(Î”_t\)</span> å¾ˆå°ï¼Œå› æ­¤è§’åº¦çš„å˜åŒ–é‡<span class="math inline">\(Î¸_1\)</span> ä¹Ÿå¾ˆå°ï¼Œå› æ­¤æœ‰è¿‘ä¼¼å…¬å¼ï¼š</p><span id="more"></span><p><span class="math display">\[\theta_{2} \approx \sin \left(\theta_{2}\right)=\frac{K}{D}\]</span></p><p>ç”±æ•°å­¦åˆ†æå¯ä»¥å¾—åˆ°ä¸‹é¢çš„å¼å­ï¼š</p><p><span class="math display">\[\begin{equation}\mathrm{K}=\left(\mathrm{V}_{\mathrm{R}}-\mathrm{V}_{\mathrm{L}}\right) * \Delta \mathrm{t}, \quad \omega=\frac{\theta_{1}}{\Delta \mathrm{t}}\end{equation}\]</span></p><p>ç”±ä¸Šé¢çš„å…¬å¼å’Œå¼å­å¯ä»¥æ±‚è§£å‡ºè¿åŠ¨å­¦æ­£è§£çš„ç»“æœï¼šæœºå™¨äºº X è½´æ–¹å‘é€Ÿåº¦</p><p><span class="math display">\[V_x=(V_l+V_r) / 2\]</span></p><p>æœºå™¨äºº Z è½´æ–¹å‘é€Ÿåº¦ï¼š</p><p><span class="math display">\[V_z=ï¼ˆV_r - V_lï¼‰/D\]</span></p><p>ç”±æ­£è§£ç›´æ¥åæ¨å¾—å‡ºè¿åŠ¨å­¦é€†è§£çš„ç»“æœï¼š</p><p>æœºå™¨äººå·¦è½®çš„é€Ÿåº¦ï¼š</p><p><span class="math display">\[V_l = V_x -ï¼ˆV_z * Dï¼‰/2\]</span></p><p>æœºå™¨äººå³è½®çš„é€Ÿåº¦ï¼š</p><p><span class="math display">\[V_r = V_x +ï¼ˆV_z * Dï¼‰/2\]</span></p><h2 id="å®ç°">å®ç°</h2><h3 id="è¿åŠ¨å­¦æ­£è§£">è¿åŠ¨å­¦æ­£è§£</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief è½®å­çº¿é€Ÿåº¦åˆ°æœºå™¨äººåæ ‡é€Ÿåº¦çš„å˜æ¢</span></span><br><span class="line"><span class="comment"> *        Vx = (Vl + Vr) / 2</span></span><br><span class="line"><span class="comment"> *        Vz = (Vr - Vl) / D</span></span><br><span class="line"><span class="comment"> * @return Eigen::Vector3f æœºå™¨äººåæ ‡ç³»ä¸‹çš„é€Ÿåº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Eigen::Vector3f <span class="title">MotorToRobotSpeed</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Eigen::Vector3f robot_speed;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">robot_speed</span>(<span class="number">0</span>) = <span class="number">-0.5f</span> * <span class="built_in">motor_line_speed_measure_</span>(<span class="number">0</span>) + <span class="number">0.5f</span> * <span class="built_in">motor_line_speed_measure_</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">robot_speed</span>(<span class="number">1</span>) = <span class="number">0</span> * <span class="built_in">motor_line_speed_measure_</span>(<span class="number">0</span>) + <span class="number">0</span> * <span class="built_in">motor_line_speed_measure_</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">robot_speed</span>(<span class="number">2</span>) = (<span class="number">0.5f</span> / body_radius_) * (<span class="built_in">motor_line_speed_measure_</span>(<span class="number">0</span>) + <span class="built_in">motor_line_speed_measure_</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> robot_speed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="è¿åŠ¨å­¦é€†è§£">è¿åŠ¨å­¦é€†è§£</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief æœºå™¨äººåæ ‡é€Ÿåº¦åˆ°è½®å­çº¿é€Ÿåº¦çš„å˜æ¢</span></span><br><span class="line"><span class="comment"> *        Vl = -Vx + (Vz * D) / 2</span></span><br><span class="line"><span class="comment"> *        Vr = Vx + (Vz * D) / 2</span></span><br><span class="line"><span class="comment"> * @param robot_speed æœºå™¨äººåæ ‡ç³»ä¸‹çš„é€Ÿåº¦</span></span><br><span class="line"><span class="comment"> * @return None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RobotToMotorSpeed</span><span class="params">(Eigen::Vector3f&amp; robot_speed)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">motor_line_speed_target_</span>(<span class="number">0</span>) =  <span class="number">-1</span> * <span class="built_in">robot_speed</span>(<span class="number">0</span>)  + <span class="number">0</span> * <span class="built_in">robot_speed</span>(<span class="number">1</span>) + body_radius_ * <span class="built_in">robot_speed</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">motor_line_speed_target_</span>(<span class="number">1</span>) =   <span class="number">1</span> * <span class="built_in">robot_speed</span>(<span class="number">0</span>)  + <span class="number">0</span> * <span class="built_in">robot_speed</span>(<span class="number">1</span>) + body_radius_ * <span class="built_in">robot_speed</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(motor_num_ &gt;= <span class="number">4</span>) {</span><br><span class="line">        <span class="built_in">motor_line_speed_target_</span>(<span class="number">2</span>) = <span class="built_in">motor_line_speed_target_</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">motor_line_speed_target_</span>(<span class="number">3</span>) = <span class="built_in">motor_line_speed_target_</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="åæ ‡ç³»æ—‹è½¬">åæ ‡ç³»æ—‹è½¬</h1><h2 id="å…¨å±€åæ ‡ç³»åˆ°æœºå™¨äººåæ ‡ç³»çš„å˜æ¢">å…¨å±€åæ ‡ç³»åˆ°æœºå™¨äººåæ ‡ç³»çš„å˜æ¢</h2><p>ä¸€ä¸ªå¹³é¢åæ ‡ç³»é€†æ—¶é’ˆæ—‹è½¬ä¸€ä¸ªè§’åº¦åå¾—åˆ°å¦ä¸€ä¸ªåæ ‡ç³»ï¼Œåˆ™åŒä¸€ä¸ªç‚¹åœ¨è¿™ä¸¤ä¸ªåæ ‡ç³»ä¹‹é—´çš„å‡ ä½•å…³ç³»å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/rotate2.png"></p><p>ç”±ä¸Šå›¾å¯å¾—ï¼š</p><p><span class="math display">\[\begin{equation}\begin{aligned}x^{\prime} &amp;=O B+B C \\&amp;=O D \cos \theta+A D \sin \theta \\&amp;=x \cos \theta+y \sin \theta\end{aligned}\end{equation}\]</span></p><p><span class="math display">\[\begin{equation}\begin{aligned}y^{\prime} &amp;=A E-C E \\&amp;=A D \cos \theta-O D \sin \theta \\&amp;=y \cos \theta-x \sin \theta\end{aligned}\end{equation}\]</span></p><p>åˆ™åè¿‡æ¥çš„å…³ç³»å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{equation}\left[\begin{array}{l}x \\y\end{array}\right]=\left[\begin{array}{cc}\cos \theta &amp; -\sin \theta \\\sin \theta &amp; \cos \theta\end{array}\right]\left[\begin{array}{l}x^{\prime} \\y^{\prime}\end{array}\right]\end{equation}\]</span></p><p>åˆ™åè¿‡æ¥çš„å…³ç³»å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{equation}\left[\begin{array}{l}x \\y\end{array}\right]=\left[\begin{array}{cc}\cos \theta &amp; -\sin \theta \\\sin \theta &amp; \cos \theta\end{array}\right]\left[\begin{array}{l}x^{\prime} \\y^{\prime}\end{array}\right]\end{equation}\]</span></p><h2 id="å®ç°-1">å®ç°</h2><h3 id="æ­£è§£">æ­£è§£</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief ä¸–ç•Œåæ ‡åˆ°æœºå™¨äººåæ ‡çš„é€Ÿåº¦å˜æ¢</span></span><br><span class="line"><span class="comment"> * @param global_speed ä¸º Global åæ ‡çš„é€Ÿåº¦å‘é‡ xyw</span></span><br><span class="line"><span class="comment"> * @return Eigen::Vector3f Robot åæ ‡çš„é€Ÿåº¦å‘é‡ xyw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Eigen::Vector3f <span class="title">GlobalToRobotSpeed</span><span class="params">(Eigen::Vector3f&amp; global_speed)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Eigen::Vector3f robot_speed;</span><br><span class="line">    Eigen::Matrix3f rotate_mat;</span><br><span class="line"></span><br><span class="line">    rotate_mat &lt;&lt;  <span class="built_in">cos</span>(global_coordinat_z_), <span class="built_in">sin</span>(global_coordinat_z_), <span class="number">0.0f</span>,</span><br><span class="line">                  -<span class="built_in">sin</span>(global_coordinat_z_), <span class="built_in">cos</span>(global_coordinat_z_), <span class="number">0.0f</span>,</span><br><span class="line">                  <span class="number">0.0f</span>,                      <span class="number">0.0f</span>,                     <span class="number">1.0f</span>;</span><br><span class="line">    robot_speed = rotate_mat * global_speed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> robot_speed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="é€†è§£">é€†è§£</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief æœºå™¨äººåæ ‡åˆ°ä¸–ç•Œåæ ‡çš„é€Ÿåº¦å˜æ¢</span></span><br><span class="line"><span class="comment"> * @param robot_speed Robot åæ ‡çš„é€Ÿåº¦å‘é‡ xyw</span></span><br><span class="line"><span class="comment"> * @return Eigen::Vector3f Global åæ ‡çš„é€Ÿåº¦å‘é‡ xyw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Eigen::Vector3f <span class="title">RobotToGlobalSpeed</span><span class="params">(Eigen::Vector3f&amp; robot_speed)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Eigen::Vector3f global_speed;</span><br><span class="line">    Eigen::Matrix3f rotate_mat;</span><br><span class="line"></span><br><span class="line">    rotate_mat &lt;&lt; <span class="built_in">cos</span>(global_coordinat_z_), -<span class="built_in">sin</span>(global_coordinat_z_), <span class="number">0.0f</span>,</span><br><span class="line">                  <span class="built_in">sin</span>(global_coordinat_z_),  <span class="built_in">cos</span>(global_coordinat_z_), <span class="number">0.0f</span>,</span><br><span class="line">                  <span class="number">0.0f</span>,                      <span class="number">0.0f</span>,                     <span class="number">1.0f</span>;</span><br><span class="line">    global_speed = rotate_mat * robot_speed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> global_speed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ3V5dWVob21lLmNvbS8zMzk1Mw==">https://www.guyuehome.com/33953<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xJTkVBUjEwMjQvYXJ0aWNsZS9kZXRhaWxzLzEwNDk1Njc3NA==">https://blog.csdn.net/LINEAR1024/article/details/104956774<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ3V5dWVob21lLmNvbS84Mzky">https://www.guyuehome.com/8392<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Odriver </tag>
            
            <tag> Actuator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Valgrind æ£€æµ‹ C++å†…å­˜æ³„æ¼</title>
      <link href="/2022/Debug/ValgrindMemleak/"/>
      <url>/2022/Debug/ValgrindMemleak/</url>
      
        <content type="html"><![CDATA[<h1 id="valgrind-çš„ä»‹ç»">Valgrind çš„ä»‹ç»</h1><p>Valgrind å¯ä»¥ç”¨æ¥æ£€æµ‹ç¨‹åºæ˜¯å¦æœ‰éæ³•ä½¿ç”¨å†…å­˜çš„é—®é¢˜ï¼Œä¾‹å¦‚è®¿é—®æœªåˆå§‹åŒ–çš„å†…å­˜ã€è®¿é—®æ•°ç»„æ—¶è¶Šç•Œã€å¿˜è®°é‡Šæ”¾åŠ¨æ€å†…å­˜ç­‰é—®é¢˜ã€‚åœ¨ Linux å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… Valgrindï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget ftp://sourceware.org/pub/valgrind/valgrind-3.13.0.tar.bz2</span><br><span class="line">$ bzip2 -d valgrind-3.13.0.tar.bz2</span><br><span class="line">$ tar -xf valgrind-3.13.0.tar</span><br><span class="line">$ <span class="built_in">cd</span> valgrind-3.13.0</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></tbody></table></figure><h1 id="æ£€æµ‹å†…å­˜æ³„æ¼">æ£€æµ‹å†…å­˜æ³„æ¼</h1><h2 id="c-è¯­è¨€">C è¯­è¨€</h2><p>Valgrind å¯ä»¥ç”¨æ¥æ£€æµ‹ç¨‹åºåœ¨å“ªä¸ªä½ç½®å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç¨‹åºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> *<span class="built_in">array</span> = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¯‘ç¨‹åºæ—¶ï¼Œéœ€è¦åŠ ä¸Š-g é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -g -o main_c main.c</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ Valgrind æ£€æµ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ valgrind --tool=memcheck --leak-check=full  ./main_c</span><br><span class="line">==31416== Memcheck, a memory error detector</span><br><span class="line">==31416== Copyright (C) 2002-2017, and GNU GPL<span class="string">'d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31416== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31416== Command: ./main_c</span></span><br><span class="line"><span class="string">==31416==</span></span><br><span class="line"><span class="string">==31416== HEAP SUMMARY:</span></span><br><span class="line"><span class="string">==31416==     in use at exit: 4 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31416==   total heap usage: 1 allocs, 0 frees, 4 bytes allocated</span></span><br><span class="line"><span class="string">==31416==</span></span><br><span class="line"><span class="string">==31416== 4 bytes in 1 blocks are definitely lost in loss record 1 of 1</span></span><br><span class="line"><span class="string">==31416==    at 0x4C2DBF6: malloc (vg_replace_malloc.c:299)</span></span><br><span class="line"><span class="string">==31416==    by 0x400537: main (main.c:5)</span></span><br><span class="line"><span class="string">==31416==</span></span><br><span class="line"><span class="string">==31416== LEAK SUMMARY:</span></span><br><span class="line"><span class="string">==31416==    definitely lost: 4 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31416==    indirectly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31416==      possibly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31416==    still reachable: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31416==         suppressed: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31416==</span></span><br><span class="line"><span class="string">==31416== For counts of detected and suppressed errors, rerun with: -v</span></span><br><span class="line"><span class="string">==31416== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span></span><br></pre></td></tr></tbody></table></figure><p>å…ˆçœ‹çœ‹è¾“å‡ºä¿¡æ¯ä¸­çš„ HEAP SUMMARYï¼Œå®ƒè¡¨ç¤ºç¨‹åºåœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æƒ…å†µï¼Œå…¶ä¸­çš„ 1 allocs è¡¨ç¤ºç¨‹åºåˆ†é…äº† 1 æ¬¡å†…å­˜ï¼Œ0 frees è¡¨ç¤ºç¨‹åºé‡Šæ”¾äº† 0 æ¬¡å†…å­˜ï¼Œ4 bytes allocated è¡¨ç¤ºåˆ†é…äº† 4 ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚ å¦å¤–ï¼ŒValgrind ä¹Ÿä¼šæŠ¥å‘Šç¨‹åºæ˜¯åœ¨å“ªä¸ªä½ç½®å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ä¾‹å¦‚ï¼Œä»ä¸‹é¢çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå‘ç”Ÿäº†ä¸€æ¬¡å†…å­˜æ³„æ¼ï¼Œä½ç½®æ˜¯ main.c æ–‡ä»¶çš„ç¬¬ 5 è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">==31416== 4 bytes <span class="keyword">in</span> 1 blocks are definitely lost <span class="keyword">in</span> loss record 1 of 1</span><br><span class="line">==31416==    at 0x4C2DBF6: malloc (vg_replace_malloc.c:299)</span><br><span class="line">==31416==    by 0x400537: main (main.c:5)</span><br></pre></td></tr></tbody></table></figure><h2 id="cè¯­è¨€">C++è¯­è¨€</h2><p>Valgrind ä¹Ÿå¯ä»¥ç”¨æ¥æ£€æµ‹ C++ ç¨‹åºçš„å†…å­˜æ³„æ¼ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ C++ ç¨‹åºï¼Œæ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">auto</span> ptr = <span class="keyword">new</span> std::<span class="built_in">string</span>(<span class="string">"Hello, World!"</span>);</span><br><span class="line">    <span class="keyword">delete</span> ptr;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æè¿™æ®µç¨‹åºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all ./main_cpp</span><br><span class="line">==31438== Memcheck, a memory error detector</span><br><span class="line">==31438== Copyright (C) 2002-2017, and GNU GPL<span class="string">'d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31438== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31438== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== HEAP SUMMARY:</span></span><br><span class="line"><span class="string">==31438==     in use at exit: 72,704 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31438==   total heap usage: 2 allocs, 1 frees, 72,736 bytes allocated</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== 72,704 bytes in 1 blocks are still reachable in loss record 1 of 1</span></span><br><span class="line"><span class="string">==31438==    at 0x4C2DBF6: malloc (vg_replace_malloc.c:299)</span></span><br><span class="line"><span class="string">==31438==    by 0x4EC3EFF: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.21)</span></span><br><span class="line"><span class="string">==31438==    by 0x40104E9: call_init.part.0 (dl-init.c:72)</span></span><br><span class="line"><span class="string">==31438==    by 0x40105FA: call_init (dl-init.c:30)</span></span><br><span class="line"><span class="string">==31438==    by 0x40105FA: _dl_init (dl-init.c:120)</span></span><br><span class="line"><span class="string">==31438==    by 0x4000CF9: ??? (in /lib/x86_64-linux-gnu/ld-2.23.so)</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== LEAK SUMMARY:</span></span><br><span class="line"><span class="string">==31438==    definitely lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==    indirectly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==      possibly lost: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==    still reachable: 72,704 bytes in 1 blocks</span></span><br><span class="line"><span class="string">==31438==         suppressed: 0 bytes in 0 blocks</span></span><br><span class="line"><span class="string">==31438==</span></span><br><span class="line"><span class="string">==31438== For counts of detected and suppressed errors, rerun with: -v</span></span><br><span class="line"><span class="string">==31438== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æ C++ ç¨‹åºæ—¶ï¼Œæœ‰ä¸€äº›é—®é¢˜éœ€è¦ç•™æ„ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œä½†æ˜¯ä» HEAP SUMMARY å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºåˆ†é…äº† 2 æ¬¡å†…å­˜ï¼Œä½†å´åªé‡Šæ”¾äº† 1 æ¬¡å†…å­˜ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šè¿™æ˜¯ç”±äº C++ åœ¨åˆ†é…å†…å­˜æ—¶ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œä½¿ç”¨äº†å®ƒè‡ªå·±çš„å†…å­˜æ± ã€‚å½“ç¨‹åºç»ˆæ­¢æ—¶ï¼Œå†…å­˜æ± çš„å†…å­˜æ‰ä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ï¼Œæ‰€ä»¥ Valgrind ä¼šå°†è¿™éƒ¨åˆ†å†…å­˜æŠ¥å‘Šä¸º reachable çš„ï¼Œéœ€è¦æ³¨æ„ï¼Œreachable çš„å†…å­˜ä¸ä»£è¡¨å†…å­˜æ³„æ¼ï¼Œä¾‹å¦‚ï¼Œä»ä¸Šé¢çš„è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ 72704 ä¸ªå­—èŠ‚æ˜¯ reachable çš„ï¼Œä½†æ²¡æœ‰æŠ¥å‘Šå†…å­˜æ³„æ¼ã€‚</p><h1 id="æ£€æµ‹è¶Šç•Œè®¿é—®">æ£€æµ‹è¶Šç•Œè®¿é—®</h1><p>C++ ç¨‹åºç»å¸¸å‡ºç°çš„ Bug å°±æ˜¯æ•°ç»„è¶Šç•Œè®¿é—®ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç¨‹åºå‡ºç°äº†è¶Šç•Œè®¿é—®ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">v</span><span class="params">(<span class="number">10</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; v[<span class="number">10</span>] &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ Valgrind åˆ†æè¿™æ®µç¨‹åºï¼ŒValgrind ä¼šæç¤ºè¶Šç•Œè®¿é—®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -std=c++11 -g -o main_cpp main.cpp</span><br><span class="line">$ valgrind --tool=memcheck --leak-check=full ./main_cpp</span><br><span class="line">==31523== Memcheck, a memory error detector</span><br><span class="line">==31523== Copyright (C) 2002-2017, and GNU GPL<span class="string">'d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31523== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31523== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31523==</span></span><br><span class="line"><span class="string">==31523== Invalid read of size 4</span></span><br><span class="line"><span class="string">==31523==    at 0x400AD7: main (main.cpp:7)</span></span><br><span class="line"><span class="string">==31523==  Address 0x5ab5ca8 is 0 bytes after a block of size 40 alloc'</span>d</span><br><span class="line">==31523==    at 0x4C2E216: operator new(unsigned long) (vg_replace_malloc.c:334)</span><br><span class="line">==31523==    by 0x4010D3: __gnu_cxx::new_allocator&lt;int&gt;::allocate(unsigned long, void const*) (new_allocator.h:104)</span><br><span class="line">==31523==    by 0x401040: std::allocator_traits&lt;std::allocator&lt;int&gt; &gt;::allocate(std::allocator&lt;int&gt;&amp;, unsigned long) (alloc_traits.h:491)</span><br><span class="line">==31523==    by 0x400F91: std::_Vector_base&lt;int, std::allocator&lt;int&gt; &gt;::_M_allocate(unsigned long) (stl_vector.h:170)</span><br><span class="line">==31523==    by 0x400E7E: std::_Vector_base&lt;int, std::allocator&lt;int&gt; &gt;::_M_create_storage(unsigned long) (stl_vector.h:185)</span><br><span class="line">==31523==    by 0x400D1E: std::_Vector_base&lt;int, std::allocator&lt;int&gt; &gt;::_Vector_base(unsigned long, std::allocator&lt;int&gt; const&amp;) (stl_vector.h:136)</span><br><span class="line">==31523==    by 0x400C11: std::vector&lt;int, std::allocator&lt;int&gt; &gt;::vector(unsigned long, int const&amp;, std::allocator&lt;int&gt; const&amp;) (stl_vector.h:291)</span><br><span class="line">==31523==    by 0x400AB9: main (main.cpp:6)</span><br></pre></td></tr></tbody></table></figure><p>Invalid read of size 4 è¡¨ç¤ºè¶Šç•Œè¯»å– 4 ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ“ä½œå‡ºç°åœ¨ main.cpp æ–‡ä»¶çš„ç¬¬ 7 è¡Œã€‚å¦å¤–å¯ä»¥çœ‹åˆ°ï¼Œvector åˆ†é…äº†ä¸€å— 40 å­—èŠ‚çš„å†…å­˜ï¼Œç¨‹åºè¶Šç•Œè®¿é—®ç´§æ€¥ç€è¿™å—å†…å­˜ä¹‹åçš„ 4 ä¸ªå­—èŠ‚ã€‚</p><h1 id="æ£€æµ‹æœªåˆå§‹åŒ–çš„å†…å­˜">æ£€æµ‹æœªåˆå§‹åŒ–çš„å†…å­˜</h1><p>å¦ä¸€ç§ç»å¸¸å‡ºç°çš„ Bugï¼Œå°±æ˜¯ç¨‹åºè®¿é—®äº†æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"X is zero"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ Valgrind æ£€æµ‹è¿™ä¸ªç¨‹åºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ g++ -std=c++11 -g -o main_cpp main.cpp</span><br><span class="line">$ valgrind --tool=memcheck --leak-check=full ./main_cpp</span><br><span class="line">==31554== Memcheck, a memory error detector</span><br><span class="line">==31554== Copyright (C) 2002-2017, and GNU GPL<span class="string">'d, by Julian Seward et al.</span></span><br><span class="line"><span class="string">==31554== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span></span><br><span class="line"><span class="string">==31554== Command: ./main_cpp</span></span><br><span class="line"><span class="string">==31554==</span></span><br><span class="line"><span class="string">==31554== Conditional jump or move depends on uninitialised value(s)</span></span><br><span class="line"><span class="string">==31554==    at 0x400852: main (main.cpp:6)</span></span><br></pre></td></tr></tbody></table></figure><p>è¾“å‡ºä¸­æç¤ºäº† main.cpp æ–‡ä»¶çš„ç¬¬ 6 è¡Œè®¿é—®äº†æœªåˆå§‹åŒ–çš„å†…å­˜ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9zZW5saW56aGFuLmdpdGh1Yi5pby8yMDE3LzEyLzMxL3ZhbGdyaW5kLw==">https://senlinzhan.github.io/2017/12/31/valgrind/<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åº”ç”¨å´©æºƒè°ƒè¯•åˆ†æ</title>
      <link href="/2022/Debug/ApplicationDebug/"/>
      <url>/2022/Debug/ApplicationDebug/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>åº”ç”¨å´©æºƒï¼Œå„ç§ç©ºæŒ‡é’ˆç­‰å¤§æ¦‚æ˜¯åº”ç”¨å¼€å‘è¿‡ç¨‹ä¸­æœ€å¸¸é‡åˆ°çš„é—®é¢˜äº†ã€‚è€Œæˆ‘ä»¬ä¼ ç»Ÿçš„è°ƒè¯•åˆ©å™¨ syslog èƒ½å¿«é€Ÿè§£å†³ 90%çš„é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºé‚£äº›ä½æ¦‚ç‡ï¼Œéœ€è¦è€åŒ–å‡ åå°æ—¶æ‰èƒ½å¤ç°åˆ°çš„é—®é¢˜é€šè¿‡ syslog å°±å¾ˆéš¾å®šä½åˆ°é—®é¢˜äº†ã€‚è¿™æ—¶å¦‚æœå¯ä»¥æä¾›ä¸€ç§æƒ…æ™¯å†ç°çš„æ–¹å¼å°†åº”ç”¨å´©æºƒç°åœºçš„è°ƒç”¨æ ˆä»¥åŠæ ˆå†…æ•°æ®ç»™å±•ç°å‡ºæ¥é‚£ä¹ˆå¯¹äºæˆ‘ä»¬å®šä½é—®é¢˜æ˜¯å¤§æœ‰å¸®åŠ©çš„ã€‚è€Œç¬”è€…æœ€è¿‘å°±é‡åˆ°å¤§é‡è¿™ç§ï¼ˆåŸºæœ¬éƒ½æ˜¯è€åŒ–è¿‡ç¨‹ä¸­é‡åˆ°çš„ä½æ¦‚ç‡ï¼‰é—®é¢˜ï¼Œäºæ˜¯è¿™é‡Œå°è¯•æä¾›ä¸€ç§æ–¹æ³•æ¥å¿«é€Ÿå®šä½é—®é¢˜ã€‚å½“ç„¶è¿™ç±»é—®é¢˜éƒ½æ˜¯ä¸€ä¸ªè·¯å­ï¼ŒæŒæ¡è¿™ç§åˆ†ææ–¹æ³•ä»¥åé‡åˆ°è¿™ç±»é—®é¢˜å°±éƒ½å¯ä»¥è½»æ¾å¤„ç†äº†ã€‚</p><p>æœ¬æ–‡æä¾›çš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡ gdb+core dump æ–‡ä»¶åˆ†æè°ƒè¯•æ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><span id="more"></span><h1 id="å¼€å¯-core-dump-åŠŸèƒ½">å¼€å¯ core dump åŠŸèƒ½</h1><p>åœ¨ init è„šæœ¬çš„ start_service ä¸­æ·»åŠ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procd_set_param limits core=<span class="string">"unlimited"</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·ä¸€æ¡ä»£ç ï¼Œä¾‹å¦‚ xxxapp ä¸­çš„æ·»åŠ å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/start_core.png"></p><p>æˆ–è€…ç›´æ¥åœ¨ shell ä¸­æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/tmp/core-%e-%p-%t"</span> &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæ‰§è¡Œåº”ç”¨ã€‚</p><h1 id="æ·»åŠ æ·»åŠ è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨">æ·»åŠ æ·»åŠ è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨</h1><h2 id="å»æ‰ç¼–è¯‘ç³»ç»Ÿçš„å…¨å±€-stripç”±-strip-æ”¹ä¸º-none">å»æ‰ç¼–è¯‘ç³»ç»Ÿçš„å…¨å±€ stripï¼ˆç”± strip æ”¹ä¸º noneï¼‰</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br><span class="line">    -&gt; Global build settings  </span><br><span class="line">        ---&gt; Binary stripping method (none)  </span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/strip.png"></p><blockquote><p>æ³¨æ„ï¼šå› ä¸º xxxapp ä¸Šå­˜å‚¨å®¹é‡é™åˆ¶ï¼Œå¯ä»¥åœ¨ strip æ¨¡å¼ä¸‹ç¼–è¯‘å®Œç³»ç»Ÿåå†æ”¹ä¸º noneï¼Œç„¶ååœ¨ç¼–è¯‘ xxxappï¼Œè¿™æ ·å°±åªæœ‰ xxxapp æœ‰ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ã€‚</p></blockquote><h2 id="åº”ç”¨ä¸­æ·»åŠ ç¬¦å·ä¿¡æ¯">åº”ç”¨ä¸­æ·»åŠ ç¬¦å·ä¿¡æ¯</h2><p>åº”ç”¨æˆ–è€…åº“ä¸­æ·»åŠ ç¬¦å·ä¿¡æ¯åªéœ€è¦åœ¨ gcc ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š-g é€‰é¡¹ï¼Œä¸€èˆ¬ä¸ºäº†æ–¹ä¾¿è°ƒè¯•éœ€è¦å»æ‰-Ox é€‰é¡¹ã€‚ä¾‹å¦‚ xxxapp è°ƒè¯•æ—¶çš„ç¼–è¯‘é€‰é¡¹å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/g.png"></p><h2 id="å¼€å¯-gdb">å¼€å¯ gdb</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br><span class="line">    -&gt; Development  </span><br><span class="line">        ---&gt; &lt;*&gt; gdb</span><br></pre></td></tr></tbody></table></figure><h1 id="è°ƒè¯•åº”ç”¨å´©æºƒç°åœº">è°ƒè¯•åº”ç”¨å´©æºƒç°åœº</h1><p>åœ¨å°æœºç«¯ä½¿ç”¨â€œgdb å¯æ‰§è¡Œç¨‹åº core æ–‡ä»¶â€å¼€å¯ gdbï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gdb /usr/bin/xxxapp /tmp/core-startEventCall-675-1610194273</span><br></pre></td></tr></tbody></table></figure><p>åŠ è½½å®Œç¬¦å·è¡¨ä¹‹åï¼Œå°±å¯ä»¥æŸ¥çœ‹ç¨‹åº dump æ—¶å€™çš„æ ˆè¿½æº¯ï¼Œå‘½ä»¤ä¸º bt</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ (gdb) bt</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰ç¬¦å·è¡¨ï¼Œbt æ‰“å°çš„å°±åªæœ‰åœ°å€ï¼›å¦‚æœæœ‰ç¬¦å·è¡¨ï¼Œbt çš„æ‰“å°å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core1.png"></p><blockquote><p>è¯´æ˜ï¼šè¿™ä¸ªè°ƒç”¨æ ˆæ˜¯ä»#0 åˆ°#12 è¿™ä¸ªé¡ºåºçœ‹çš„ï¼Œå°±æ˜¯è¯´åº”ç”¨æ˜¯åœ¨#0 è¿™ä¸ªç‚¹é€€å‡ºï¼Œè°ƒç”¨é¡ºåºæ˜¯ä»#12 åˆ°#0,</p></blockquote><p>å¦‚æœæ—¢æœ‰ç¬¦å·è¡¨ï¼Œåˆæœ‰ debug ä¿¡æ¯ï¼Œå‡½æ•°çš„å‚æ•°ä¼šåŒæ­¥æ‰“å°å‡ºæ¥ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core2.png"></p><blockquote><p>è¯´æ˜ï¼šæ·»åŠ ç¬¦å·è¡¨åä¼šæ ‡è¯†å‡ºè°ƒç”¨å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶å’Œè¡Œæ•°ï¼Œä»¥åŠè°ƒç”¨çš„æ—¶å€™çš„å‚æ•°ï¼Œé€šè¿‡è°ƒç”¨æ ˆå¯ä»¥çŸ¥é“ç¨‹åºæ˜¯åœ¨#2ï¼ˆBitmapDDAScalerExï¼‰è¿™ä¸ªç‚¹å‡ºé”™ï¼Œç„¶åè¿›å…¥åˆ°äº† c åº“çš„å´©æºƒå¤„ç†å‡½æ•°</p></blockquote><p>è¿›å…¥#2 å¸§è¿›è¡Œè°ƒè¯•çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frame 2</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core3.png"></p><blockquote><p>è¯´æ˜ï¼šé€šè¿‡ pc ç«¯æ‰“å¼€ bitmap.c å®šä½åˆ° 1989 è¡Œï¼ˆä¹Ÿå¯ä»¥æŠŠæ–‡ä»¶æ”¾åˆ° tf å¡ä¸Šä½¿ç”¨ gdb åŒæ­¥è°ƒè¯•ï¼‰</p></blockquote><p>è¿™éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core4.png"></p><p>å¯¹ç…§æºç å¯ä»¥æ‰“å°ç°åœº dp1ï¼Œdp2 ä»¥åŠ sx çš„å€¼ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core5.png"></p><blockquote><p>è¯´æ˜ï¼šé€šè¿‡æºç å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„ dp1 å·²ç»æ˜¯ä¸€ä¸ªé”™è¯¯çš„åœ°å€ï¼Œç¨‹åºæ— æ³•è®¿é—®ï¼Œæ¥æ¥ä¸‹å°±è¦æ¢ç´¢ dp1 çš„å€¼ä»å“ªé‡Œæ¥çš„ã€‚</p></blockquote><p>æ‰¾åˆ°è¯¥ç¨‹åºçš„ä¸Šä¸‹æ–‡ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core6.png"></p><p>é€šè¿‡æºç èµ°è¯»ï¼Œéœ€è¦æ‰“å°çš„å˜é‡å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core7.png"></p><blockquote><p>è¯´æ˜ï¼šé€šè¿‡è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™é‡Œæ˜¯è¦å°†ä¸€ä¸ªé•¿ä¸º 59ï¼Œå®½ä¸º 24 çš„å›¾ç‰‡ï¼Œç¼©æ”¾æˆé•¿ä¸º 50ï¼Œå®½ä¸º 28 çš„å›¾ç‰‡ï¼Œå›¾ç‰‡çš„åƒç´ å®½åº¦ä¸º 4 ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å›¾ç‰‡çš„å†…å®¹å·²ç»è¢«æ”¹å†™æ²¡æœ‰äº†ã€‚</p></blockquote><p>ä½†æ˜¯æ²¡æœ‰æœ‰æ‰¾åˆ° dp1 å¯¹åº”çš„å€¼çš„æ¥æºï¼Œæ±‡ç¼–çœ‹çœ‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ (gdb) disassemble</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core8.png"></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ (gdb) info registers</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/core9.png"></p><blockquote><p>è¯´æ˜ï¼šé€šè¿‡ç°åœºèƒ½å¤ŸçŸ¥é“ dp1 å¯¹åº”åœ°å€ä¸ºæ ˆä¸Šçš„åœ°å€ 0xbe973990ï¼Œè¿™ä¸ªåœ°å€é‡Œä¿å­˜çš„å€¼ä¸º 0x135cï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–å¤ªé•¿äº†ï¼Œè¿½è¸ªå†…å­˜å¾ˆè€—æ—¶å…ˆæ”¾å¼ƒäº†ã€‚</p></blockquote><p>é€šè¿‡åœ¨ xxxapp ä¸­æŸ¥æ‰¾å¯¹åº”çš„å›¾ç‰‡ï¼Œèƒ½å¤ŸçŸ¥é“ç›®å‰ç¼©æ”¾çš„å›¾ç‰‡æ˜¯ç”µæ± ç”µé‡å›¾æ ‡çš„å›¾ç‰‡ï¼Œè¿™ä¸ªæ˜¯ minigui é‡Œçš„ä¸€ä¸ª bugï¼Œè·Ÿå›¾æ ‡åˆ·æ–°æœ‰å…³ã€‚è¿™é‡Œä¸å†ç»§ç»­ä¸‹å»äº†ã€‚ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªåº”ç”¨å´©æºƒåé€šè¿‡ gdb+core dump æ–‡ä»¶å¯¹ç°åœºè¿›è¡Œåˆ†æè°ƒè¯•è¿‡ç¨‹ã€‚ä»¥åé‡åˆ°çš„åº”ç”¨å´©æºƒé—®é¢˜éƒ½å¯ä»¥é€šè¿‡ç±»ä¼¼åˆ†ææ–¹æ³•è¿›è¡Œåˆ†æã€‚</p><h1 id="åœ¨-pc-ä¸Šè¿›è¡Œè°ƒè¯•">åœ¨ pc ä¸Šè¿›è¡Œè°ƒè¯•</h1><p>æœ€è¿‘åœ¨å¼€å‘ä¸­é‡åˆ°ä¸€ä¸ªæ–°é—®é¢˜ï¼Œflashï¼ˆ16M nor flashï¼‰æ»¡äº†ï¼Œæœºå™¨ç«¯ flash æ²¡æœ‰ç©ºé—´æ”¾ gdb äº†ï¼Œå†…å­˜ã€å¸¦å®½å’Œ cpu éƒ½è¶…æé™äº†ï¼Œéœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œä¼˜åŒ–ï¼Œè€Œä¼˜åŒ–çš„æ”¹åŠ¨æ˜¯å¾ˆå¤§çš„ï¼ŒæœŸé—´éå¸¸å®¹æ˜“å¼•å…¥å„ç§æ­»æœºé—®é¢˜ï¼Œè€Œæ­¤æ—¶åˆæ²¡æœ‰ gdb äº†ã€‚åªèƒ½é€šè¿‡ syslog æ¥è°ƒè¯•ï¼Œä¸€äº›ä½æ¦‚ç‡çš„è€åŒ–å¾ˆä¹…æ‰ä¼šå‡ºç°çš„é—®é¢˜å¾ˆéš¾é€šè¿‡ syslog çš„æ‰“å°æŸ¥æ‰¾å‡ºæ¥ï¼Œè¿˜æ˜¯éœ€è¦ gdb+core dump æ–‡ä»¶æ‰èƒ½å¿«é€Ÿå®šä½é—®é¢˜ã€‚ä¸ºæ­¤æˆ‘ä»¬åˆç ”ç©¶äº†åœ¨ pc ç«¯ä½¿ç”¨ gdb å’Œ core dump æ–‡ä»¶çš„æ–¹æ³•ã€‚å…·ä½“å·®å¼‚ç‚¹å¦‚ä¸‹ï¼š</p><h2 id="å»æ‰-gdb">å»æ‰ gdb</h2><p>å½“ç„¶ä½ çš„ flash å·²ç»å®¹ä¸ä¸‹ gdb äº†ï¼Œæ­¤æ—¶ã€‚</p><h2 id="è®¾ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾gdb">è®¾ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆgdbï¼‰</h2><p>åœ¨~/.bashrc æ–‡ä»¶é‡Œæ·»åŠ å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/liushuai/workspace/project/prebuilt/gcc/linux-x86/arm/toolchain-sunxi-musl/toolchain/bin</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‹·è´æ–‡ä»¶-xxxapp-å’Œ-core-dump-æ–‡ä»¶è¦æ‹·è´å¸¦ç¬¦å·è¡¨çš„-xxxapp">æ‹·è´æ–‡ä»¶ (xxxapp å’Œ core dump æ–‡ä»¶ï¼Œè¦æ‹·è´å¸¦ç¬¦å·è¡¨çš„ xxxapp)</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ~/workspace/project/out/v833-perf1/staging_dir/target/rootfs/usr/bin/***app ./</span><br></pre></td></tr></tbody></table></figure><p>å°†æœºå™¨ç«¯å¤ç°åˆ°é—®é¢˜åäº§ç”Ÿçš„ core æ–‡ä»¶æ‹·è´åˆ° pc ç«¯ï¼Œadb pull /tmp/core****</p><h2 id="è¿è¡Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­çš„-gdb-ç¨‹åº">è¿è¡Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­çš„ gdb ç¨‹åº</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-openwrt-linux-gdb vegoapp core-startEventCall-675-1610194273</span><br></pre></td></tr></tbody></table></figure><h2 id="åœ¨è¿è¡Œ-gdb-ä¹‹åè®¾ç½®ç³»ç»Ÿåº“è·¯å¾„ç”±äºæ˜¯åœ¨-pc-ç«¯è¿è¡Œxxxapp-é‡Œä¸åŒ…å«å…±äº«åº“çš„å†…å®¹ä½†æ˜¯-sdk-è·¯å¾„é‡Œæ˜¯æœ‰-rootfs-æ–‡ä»¶çš„">åœ¨è¿è¡Œ gdb ä¹‹åè®¾ç½®ç³»ç»Ÿåº“è·¯å¾„ï¼ˆç”±äºæ˜¯åœ¨ pc ç«¯è¿è¡Œï¼Œxxxapp é‡Œä¸åŒ…å«å…±äº«åº“çš„å†…å®¹ä½†æ˜¯ sdk è·¯å¾„é‡Œæ˜¯æœ‰ rootfs æ–‡ä»¶çš„ï¼‰</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ (gdb) <span class="built_in">set</span> sysroot /home/liushuai/workspace/project/out/v833-perf1/staging_dir/target/rootfs</span><br></pre></td></tr></tbody></table></figure><h2 id="æ‰“å°è¿½æº¯æ ˆ">æ‰“å°è¿½æº¯æ ˆ</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ (gdb) bt</span><br></pre></td></tr></tbody></table></figure><p>å‰©ä¸‹çš„å°±è·Ÿåœ¨æœºå™¨ç«¯è°ƒè¯•ä¸€æ ·äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C/C++å†…å­˜æ³„éœ²åˆ†æè¿‡ç¨‹</title>
      <link href="/2022/Debug/CCMemLeakAsync/"/>
      <url>/2022/Debug/CCMemLeakAsync/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><p>æœ€è¿‘åœ¨å·¥ä½œä¸­é‡åˆ°äº†ä¸€äº›å†…å­˜æ³„éœ²é—®é¢˜ï¼Œè™½ç„¶æ³„éœ²é€Ÿåº¦å¾ˆæ…¢ï¼Œä½†æ˜¯å¯¹äºå°å‹åµŒå…¥å¼è®¾å¤‡è€Œè¨€èµ„æºæœ¬èº«å°±å¾ˆç´§å¼ è€Œä¸”è¿‡ 72h è€åŒ–æµ‹è¯•è¿‡ä¸äº†ã€‚äºæ˜¯å¯»æ‰¾ä¸€äº›å†…å­˜æ³„éœ²æ£€æµ‹å·¥å…·è¾…åŠ©æŸ¥æ‰¾å†…å­˜æ³„éœ²é—®é¢˜ï¼Œæ­¤å¤„åªä½¿ç”¨äº† leaktracer è¿™ä¸ªå¼€æºåº“æ¥å¸®åŠ©æŸ¥æ‰¾å†…å­˜æ³„éœ²é—®é¢˜ã€‚</p><span id="more"></span><h1 id="leaktracer-æ¦‚è¿°">leaktracer æ¦‚è¿°</h1><p>LeakTracer æ˜¯åœ¨æ£€æŸ¥ C/C++ ç¨‹åºå†…å­˜æ³„æ¼æ—¶ç¼–å†™çš„ä¸€ä¸ªå°å·¥å…·ã€‚ è¦ä½¿ç”¨ LeakTracerï¼Œè¯·ä½¿ç”¨æä¾›çš„ LeakCheck è„šæœ¬è¿è¡Œæ‚¨çš„ç¨‹åºã€‚å®ƒä½¿ç”¨ LD_PRELOAD ç‰¹æ€§åœ¨ä½ çš„å‡½æ•°ä¹‹ä¸Šâ€œè¦†ç›–â€ä¸€äº›å‡½æ•°ï¼ˆä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼‰ã€‚å¦‚æœæ‚¨çš„å¹³å°ä¸æ”¯æŒ LD_PRELOADï¼Œæ‚¨å¯ä»¥å°† LeakTracer.o å¯¹è±¡æ–‡ä»¶æ·»åŠ åˆ° Makefile ä¸­çš„å¯¹è±¡å¹¶è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºã€‚ LeakTracer åˆ©ç”¨ gdb å»è¾“å‡ºå‘ç”Ÿå†…å­˜æ³„éœ²æ‰€å‘ç”Ÿçš„ä½ç½®ï¼Œå®ƒæ˜¯é€šè¿‡ override operator new, operator delete, operator malloc, operator free æ¥å®ç°æ£€æµ‹ã€‚</p><h1 id="ç”¨æ³•">ç”¨æ³•</h1><h2 id="åŠ è½½-leaktracer-åº“çš„-3-ç§æ–¹æ³•">åŠ è½½ leaktracer åº“çš„ 3 ç§æ–¹æ³•ï¼š</h2><ul><li>å°†æ‚¨çš„ç¨‹åºé“¾æ¥åˆ° libleaktracer.aã€‚</li><li>å°†æ‚¨çš„ç¨‹åºé“¾æ¥åˆ° <span class="exturl" data-url="aHR0cDovL2xpYmxlYWt0cmFjZXIuc28v">libleaktracer.so<i class="fa fa-external-link-alt"></i></span>ã€‚æ‚¨éœ€è¦å°† -lleaktracer é€‰é¡¹ä½œä¸ºé“¾æ¥å‘½ä»¤çš„ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚</li><li>ä½¿ç”¨ LD_PRELOAD ç¯å¢ƒå˜é‡ä»¥ç¡®ä¿å®ƒåœ¨ä»»ä½•å…¶ä»–åº“ä¹‹å‰åŠ è½½ã€‚</li></ul><h2 id="å°†-leaktracer-æ·»åŠ åˆ°ç¨‹åºä¸­">å°† leaktracer æ·»åŠ åˆ°ç¨‹åºä¸­ï¼š</h2><ul><li>æ·»åŠ å¤´æ–‡ä»¶ MemoryTrace.hppã€‚</li><li>æ·»åŠ  leaktracer::MemoryTrace::GetInstance().startMonitoringAllThreads() å‡½æ•°ï¼Œä½œä¸ºèµ·å§‹æ£€æµ‹ä½ç½®ã€‚</li><li>æ·»åŠ  leaktracer::MemoryTrace::GetInstance().writeLeaksToFile("/mnt/extsd/leaks.out") å‡½æ•°ï¼Œä½œä¸ºç»“æŸä½ç½®ï¼Œç”Ÿæˆæ£€æµ‹æŠ¥å‘Šã€‚</li><li>ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ -funwind-tables ç”Ÿæˆ backtrace ä¿¡æ¯è¡¨ã€‚</li><li>é“¾æ¥é€‰é¡¹ä¸­æ·»åŠ -Wl,-Bstatic -lleaktracer é™æ€é“¾æ¥ libleaktracerï¼Œæœ€å¥½åŠ ä¸Š-g3ï¼Œå¤„ç†æŠ¥å‘Šæ—¶å¯ä»¥æ˜¾ç¤ºå¯¹åº”çš„ä»£ç ã€‚</li><li>ç¼–è¯‘åä¿å­˜ç”Ÿæˆçš„ bin æ–‡ä»¶ï¼Œå¤‡ç”¨ã€‚</li></ul><h2 id="ç”ŸæˆæŠ¥å‘ŠåŠå¤„ç†">ç”ŸæˆæŠ¥å‘ŠåŠå¤„ç†ï¼š</h2><h3 id="ç”Ÿæˆçš„æŠ¥å‘Šä¸­ä¸€è¡Œä¿¡æ¯å¦‚ä¸‹">ç”Ÿæˆçš„æŠ¥å‘Šä¸­ä¸€è¡Œä¿¡æ¯å¦‚ä¸‹ï¼š</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LeakTracer report diff_utc_mono=1588164717.365890</span></span><br><span class="line">leak, time=1434.190531, stack=0x7f05d63801d5 0x7f05d638e594 0x7f05d638d8f8 0x7f05d638c28d 0x7f05d6382738, size=1024, data=***********************************************...</span><br><span class="line">leak, time=1444.194638, stack=0x7f05d70f9c58 0x4027f5 0x7f05d6333830 0x402369, size=100, data=.<span class="string">"%...............................................</span></span><br><span class="line"><span class="string">leak, time=1434.190625, stack=0x4024d7 0x7f05d6333830 0x402369, size=100, data=..................................................</span></span><br><span class="line"><span class="string">leak, time=1444.194222, stack=0x7f05d70f9a5c 0x4027f0 0x7f05d6333830 0x402369, size=100, data=. %...............................................</span></span><br><span class="line"><span class="string">leak, time=1434.190651, stack=0x402500 0x7f05d6333830 0x402369, size=100,</span></span><br></pre></td></tr></tbody></table></figure><ul><li>leakï¼šä»£è¡¨å†…å­˜æ³„éœ²ã€‚</li><li>timeï¼šä»£è¡¨è°ƒç”¨åˆ†é…å†…å­˜å‡½æ•°çš„æ—¶é—´ï¼ˆå¼€æœºåˆ°å½“å‰çš„æ—¶é—´ï¼‰ã€‚</li><li>stackï¼šè°ƒç”¨æ ˆã€‚</li><li>sizeï¼šæ³„éœ²çš„å†…å­˜å¤§å°ã€‚</li><li>dataï¼šç”³è¯·æ—¶å†…å­˜ä¸­çš„æ•°æ®ã€‚</li></ul><p>æ˜æ˜¾å¯ä»¥çœ‹åˆ°è°ƒç”¨æ ˆï¼Œcallstack å…¨æ˜¯åœ°å€ï¼Œæˆ‘ä»¬ä»¥ä½¿ç”¨ helpers æ–‡ä»¶å¤¹ä¸­çš„ leak-analyze-addr2lineï¼Œleak-analyze-gdb äºŒä¸ªå·¥å…·è¿›è¡Œè§£æã€‚æˆ–è€…å€ŸåŠ© gdbã€objdump æˆ– map æ–‡ä»¶ç­‰æ‰‹æ®µå¾—åˆ°è¯¥æ³„éœ²æºçš„çœŸæ­£æ–‡ä»¶/è¡Œå·æˆ–å‡½æ•°èŒƒå›´ã€‚</p><h3 id="æŠ¥å‘Šå¤„ç†">æŠ¥å‘Šå¤„ç†</h3><ul><li>ä½¿ç”¨ addr2line å¤„ç† leaks.outï¼Œç”Ÿæˆå¯è¯»çš„è°ƒç”¨æ ˆã€‚</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leak-analyze-addr2line {bin} leaks.out &gt; leaks.addr2line.txt</span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆçš„æŠ¥å‘Šç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./helpers/leak-analyze-addr2line memleak_test_so leaks.out </span><br><span class="line">Processing <span class="string">"leaks.out"</span> <span class="built_in">log</span> <span class="keyword">for</span> <span class="string">"memleak_test_so"</span></span><br><span class="line">Matching addresses to <span class="string">"memleak_test_so"</span></span><br><span class="line">found 49 leak(s)</span><br><span class="line">100 bytes lost <span class="keyword">in</span> 1 blocks (one of them allocated at 1444.194222), from following call stack:</span><br><span class="line">??:0</span><br><span class="line">/home/cll/99_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:110</span><br><span class="line">??:0</span><br><span class="line">??:?</span><br><span class="line">400 bytes lost <span class="keyword">in</span> 1 blocks (one of them allocated at 1444.194550), from following call stack:</span><br><span class="line">??:0</span><br><span class="line">/home/cll/99_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:110</span><br><span class="line">??:0</span><br><span class="line">??:?</span><br><span class="line">328 bytes lost <span class="keyword">in</span> 1 blocks (one of them allocated at 1434.190960), from following call stack:</span><br><span class="line">/home/cll/99_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:83</span><br><span class="line">??:0</span><br><span class="line">??:?</span><br></pre></td></tr></tbody></table></figure><p>è§£æï¼š49 ä¸ªé‡å¤è°ƒç”¨ï¼Œæ³„éœ² 100 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªæ³„æ¼ç‚¹åœ¨ leaks.out ä¸­çš„æ—¶é—´æ˜¯ 06219.879013ï¼Œè°ƒç”¨æ ˆä»ä¸‹å¾€ä¸Šçœ‹ã€‚</p><ul><li>ä½¿ç”¨ gdb å¤„ç† leaks.outï¼Œç”Ÿæˆå¯è¯»çš„è°ƒç”¨æ ˆåŠæºç å¯¹åº”ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leak-analyze-gdb {bin} leaks.out &gt; leaks.gdb.txt</span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆçš„æŠ¥å‘Šç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ./helpers/leak-analyze-gdb memleak_test_so  leaks.out </span><br><span class="line">found 49 leak(s)</span><br><span class="line">(gdb) Reading symbols from memleak_test_so...done.</span><br><span class="line">16 bytes lost <span class="keyword">in</span> 1 blocks (one of them allocated at 1434.190803), from following call stack:</span><br><span class="line">main + 364 <span class="keyword">in</span> section .text</span><br><span class="line">0x4025e4 is <span class="keyword">in</span> main() (memleak_test.cpp:80).</span><br><span class="line">80new_delete_test *p_new_class_no_free =  new new_delete_test;</span><br><span class="line">No symbol matches 0x7f05d6333830.</span><br><span class="line">_start + 41 <span class="keyword">in</span> section .text</span><br><span class="line"> </span><br><span class="line">1 bytes lost <span class="keyword">in</span> 1 blocks (one of them allocated at 1444.194798), from following call stack:</span><br><span class="line">No symbol matches 0x7f05d70f9cee.</span><br><span class="line">main + 893 <span class="keyword">in</span> section .text</span><br><span class="line">0x4027f5 is <span class="keyword">in</span> main() (memleak_test.cpp:111).</span><br><span class="line">111leaktracer::MemoryTrace::GetInstance().stopAllMonitoring();</span><br><span class="line">No symbol matches 0x7f05d6333830.</span><br></pre></td></tr></tbody></table></figure><p>æ— è®ºæ˜¯ leak-analyze-addr2lineï¼Œleak-analyze-gdb äºŒä¸ªå·¥å…·è¿›è¡Œè§£æã€‚æˆ–è€…å€ŸåŠ© gdbã€objdump æˆ– map æ–‡ä»¶ç­‰æ‰‹æ®µå¾—åˆ°è¯¥æ³„éœ²æºçš„çœŸæ­£æ–‡ä»¶/è¡Œå·æˆ–å‡½æ•°èŒƒå›´ã€‚å…¶ä¸­éƒ½ä¼šç¢°ä¸Šå„ç§åº“å¼•ç”¨ç­‰é—®é¢˜å¯¼è‡´ï¼Ÿï¼Ÿï¼Ÿã€‚éƒ½ä¼šå¾ˆéº»çƒ¦ï¼Œç„¶è€Œ leaktracer æä¾›äº†ç›¸å…³æºç ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ leaktracer è¿›è¡Œæ”¹é€ æˆç¬¦åˆæˆ‘ä»¬çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚</p><h1 id="åŸç†">åŸç†</h1><h2 id="leaktracer-ä¸»è¦çš„è®¾è®¡æ€è·¯ä¸º">leaktracer ä¸»è¦çš„è®¾è®¡æ€è·¯ä¸ºï¼š</h2><ul><li>å®ç°ä¸€ç»„å†…å­˜çš„åˆ†é…/é‡Šæ”¾å‡½æ•°ï¼Œè¿™ç»„å‡½æ•°çš„å‡½æ•°åŸå‹ä¸ç³»ç»Ÿçš„é‚£ä¸€ç»„å®Œå…¨ä¸€æ ·ï¼Œè®©è¢« trace çš„ library å¯¹äºå†…å­˜çš„åˆ†é…/é‡Šæ”¾å‡½æ•°çš„è°ƒç”¨éƒ½é“¾æ¥åˆ°è‡ªå·±å®ç°çš„è¿™ä¸€ç»„å‡½æ•°ä¸­ä»¥ override æ‰ç³»ç»Ÿçš„é‚£ç»„å†…å­˜/åˆ†é…é‡Šæ”¾å‡½æ•°ï¼›</li><li>è‡ªå·±å®ç°çš„è¿™ç»„å‡½æ•°ä¸­çš„å†…å­˜åˆ†é…å‡½æ•°è®°å½•åˆ†é…ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åˆ†é…çš„å†…å­˜çš„å¤§å°ï¼Œcallstack ç­‰ï¼Œå¹¶è°ƒç”¨ç³»ç»Ÿæœ¬æ¥çš„å†…å­˜åˆ†é…å‡½æ•°å»åˆ†é…å†…å­˜ï¼›</li><li>è‡ªå·±å®ç°çš„è¿™ç»„å‡½æ•°ä¸­çš„å†…å­˜é‡Šæ”¾å‡½æ•°åˆ™é”€æ¯å†…å­˜åˆ†é…çš„ç›¸å…³è®°å½•ï¼Œå¹¶ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜é‡Šæ”¾å‡½æ•°çœŸæ­£çš„é‡Šæ”¾å†…å­˜ï¼›</li><li>åœ¨ trace ç»“æŸæ—¶ï¼Œéå†æ‰€æœ‰ä¿å­˜çš„å†…å­˜åˆ†é…è®°å½•çš„ä¿¡æ¯ï¼Œå¹¶æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜è¿›æ–‡ä»¶ä»¥ä¾›è¿›ä¸€æ­¥çš„åˆ†æï¼›</li></ul><h2 id="override-ç³»ç»Ÿå†…å­˜åˆ†é…é‡Šæ”¾å‡½æ•°">override ç³»ç»Ÿå†…å­˜åˆ†é…/é‡Šæ”¾å‡½æ•°</h2><p>LeakTracer å®ç°çš„ç”¨äº override ç³»ç»Ÿå†…å­˜åˆ†é…/é‡Šæ”¾å‡½æ•°çš„é‚£ç»„å‡½æ•°åœ¨ AllocationHandlers.cpp ä¸­å®šä¹‰ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c++</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[] <span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span> <span class="params">(<span class="type">void</span> *p)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[]</span></span><br><span class="line"><span class="function">c</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span></span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// LeakTracer</span></span><br><span class="line"><span class="comment">// Contribution to original project by Erwin S. Andreasen</span></span><br><span class="line"><span class="comment">// site: http://www.andreasen.org/LeakTracer/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Added by Michael Gopshtein, 2006</span></span><br><span class="line"><span class="comment">// mgopshtein@gmail.com</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Any comments/suggestions are welcome</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"MemoryTrace.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"LeakTracer_l.hpp"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span>* (*lt_malloc)(<span class="type">size_t</span> size);</span><br><span class="line"><span class="built_in">void</span>  (*lt_free)(<span class="type">void</span>* ptr);</span><br><span class="line"><span class="type">void</span>* (*lt_realloc)(<span class="type">void</span> *ptr, <span class="type">size_t</span> size);</span><br><span class="line"><span class="type">void</span>* (*lt_calloc)(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[] (<span class="type">size_t</span> size) {</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span> <span class="params">(<span class="type">void</span> *p)</span> </span>{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(p, <span class="literal">false</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(p);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[] (<span class="type">void</span> *p) {</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(p, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(p);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** -- libc memory operators -- **/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* malloc</span></span><br><span class="line"><span class="comment"> * in some malloc implementation, there is a recursive call to malloc</span></span><br><span class="line"><span class="comment"> * (for instance, in uClibc 0.9.29 malloc-standard )</span></span><br><span class="line"><span class="comment"> * we use a InternalMonitoringDisablerThreadUp that use a tls variable to prevent several registration</span></span><br><span class="line"><span class="comment"> * during the same malloc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(ptr, <span class="literal">false</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(ptr);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_REALLOC</span>(ptr, size);</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (p != ptr)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (ptr)</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(ptr, <span class="literal">false</span>);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerReallocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line">p = <span class="built_in">LT_CALLOC</span>(nmemb, size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, nmemb*size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="å†…å­˜åˆ†é…å‡½æ•°è®°å½•åˆ†é…ç›¸å…³çš„ä¿¡æ¯">å†…å­˜åˆ†é…å‡½æ•°è®°å½•åˆ†é…ç›¸å…³çš„ä¿¡æ¯</h4><p>registerAllocation è®°å½•æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers new memory allocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting "new" calls */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** registers memory reallocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting realloc calls */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="registerreallocation-è®°å½•æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç›¸å…³ä¿¡æ¯">registerReallocation è®°å½•æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç›¸å…³ä¿¡æ¯ï¼š</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers memory reallocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting realloc calls */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// adds all relevant info regarding current allocation to map</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">MemoryTrace::registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">allocation_info_t</span> *info = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (!AllMonitoringIsDisabled() &amp;&amp; (__monitoringAllThreads || getThreadOptions().monitoringAllocations) &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line">MutexLock <span class="title function_">lock</span><span class="params">(__allocations_mutex)</span>;</span><br><span class="line">info = __allocations.insert(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line">info-&gt;size = size;</span><br><span class="line">info-&gt;isArray = is_array;</span><br><span class="line">storeTimestamp(info-&gt;timestamp);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"> <span class="comment">// we store the stack without locking __allocations_mutex</span></span><br><span class="line"><span class="comment">// it should be safe enough</span></span><br><span class="line"><span class="comment">// prevent a deadlock between backtrave function who are now using advanced dl_iterate_phdr function</span></span><br><span class="line"> <span class="comment">// and dl_* function which uses malloc functions</span></span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line">storeAllocationStack(info-&gt;allocStack);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) {</span><br><span class="line">InternalMonitoringDisablerThreadUp();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line">InternalMonitoringDisablerThreadDown();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="comment">// adds all relevant info regarding current allocation to map</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">MemoryTrace::registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!AllMonitoringIsDisabled() &amp;&amp; (__monitoringAllThreads || getThreadOptions().monitoringAllocations) &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line">MutexLock <span class="title function_">lock</span><span class="params">(__allocations_mutex)</span>;</span><br><span class="line"><span class="type">allocation_info_t</span> *info = __allocations.find(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line">info-&gt;size = size;</span><br><span class="line">info-&gt;isArray = is_array;</span><br><span class="line">storeAllocationStack(info-&gt;allocStack);</span><br><span class="line">storeTimestamp(info-&gt;timestamp);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) {</span><br><span class="line">InternalMonitoringDisablerThreadUp();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line">InternalMonitoringDisablerThreadDown();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="å†…å­˜é‡Šæ”¾å‡½æ•°åˆ™é”€æ¯å†…å­˜åˆ†é…çš„ç›¸å…³è®°å½•">å†…å­˜é‡Šæ”¾å‡½æ•°åˆ™é”€æ¯å†…å­˜åˆ†é…çš„ç›¸å…³è®°å½•</h4><p>registerReallocation è®°å½•æ¯ä¸€æ¬¡å†…å­˜é‡Šæ”¾çš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers new memory allocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting "new" calls */</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// removes allocation's info from the map</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">MemoryTrace::registerRelease</span><span class="params">(<span class="type">void</span> *p, <span class="type">bool</span> is_array)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!AllMonitoringIsDisabled() &amp;&amp; __monitoringReleases &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line">MutexLock <span class="title function_">lock</span><span class="params">(__allocations_mutex)</span>;</span><br><span class="line"><span class="type">allocation_info_t</span> *info = __allocations.find(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;isArray != is_array) {</span><br><span class="line">InternalMonitoringDisablerThreadUp();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line">InternalMonitoringDisablerThreadDown();</span><br><span class="line">}</span><br><span class="line">__allocations.release(p);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="éå†æ‰€æœ‰ä¿å­˜çš„å†…å­˜åˆ†é…è®°å½•çš„ä¿¡æ¯å¹¶æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜">éå†æ‰€æœ‰ä¿å­˜çš„å†…å­˜åˆ†é…è®°å½•çš„ä¿¡æ¯ï¼Œå¹¶æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜</h4><p>writeLeaksToFile ä¿å­˜å†…å­˜åˆ†é…è®°å½•ä¿¡æ¯åˆ°æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** writes report with all memory leaks */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeLeaksToFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* reportFileName)</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writes all memory leaks to given stream</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MemoryTrace::writeLeaksToFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* reportFilename)</span></span><br><span class="line">{</span><br><span class="line">MutexLock <span class="title function_">lock</span><span class="params">(__allocations_mutex)</span>;</span><br><span class="line">InternalMonitoringDisablerThreadUp();</span><br><span class="line"> </span><br><span class="line"><span class="built_in">std</span>::ofstream oleaks;</span><br><span class="line"><span class="keyword">if</span> (!isFolderExist(reportFilename)) {</span><br><span class="line">createDirectory(reportFilename);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (__allocations.empty()) {</span><br><span class="line"><span class="keyword">return</span>; <span class="comment">//no memory leak, not need to create leak file</span></span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">oleaks.open(reportFilename, <span class="built_in">std</span>::ios_base::out);</span><br><span class="line"><span class="keyword">if</span> (oleaks.is_open())</span><br><span class="line">{</span><br><span class="line">writeLeaksPrivate(oleaks);</span><br><span class="line">oleaks.close();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"Failed to write to \""</span> &lt;&lt; reportFilename &lt;&lt; <span class="string">"\"\n"</span>;</span><br><span class="line">}</span><br><span class="line">InternalMonitoringDisablerThreadDown();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="éå†è‡ªå®šä¹‰-mapmemoryinfo-ä¸­æ‰€æœ‰å…ƒç´ ">éå†è‡ªå®šä¹‰ MapMemoryInfo ä¸­æ‰€æœ‰å…ƒç´ </h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writes all memory leaks to given stream</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MemoryTrace::writeLeaksPrivate</span><span class="params">(<span class="built_in">std</span>::ostream &amp;out)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">mono</span>, <span class="title">utc</span>, <span class="title">diff</span>;</span></span><br><span class="line"><span class="type">allocation_info_t</span> *info;</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line"><span class="type">double</span> d;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> precision = <span class="number">6</span>;</span><br><span class="line"><span class="type">int</span> maxsecwidth;</span><br><span class="line"> </span><br><span class="line">clock_gettime(CLOCK_REALTIME, &amp;utc);</span><br><span class="line">clock_gettime(CLOCK_MONOTONIC, &amp;mono);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (utc.tv_nsec &gt; mono.tv_nsec) {</span><br><span class="line">diff.tv_nsec = utc.tv_nsec - mono.tv_nsec;</span><br><span class="line">diff.tv_sec = utc.tv_sec - mono.tv_sec;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">diff.tv_nsec = <span class="number">1000000000</span> - (mono.tv_nsec - utc.tv_nsec);</span><br><span class="line">diff.tv_sec = utc.tv_sec - mono.tv_sec <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">maxsecwidth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(mono.tv_sec &gt; <span class="number">0</span>) {</span><br><span class="line">mono.tv_sec = mono.tv_sec/<span class="number">10</span>;</span><br><span class="line">maxsecwidth++;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (maxsecwidth == <span class="number">0</span>) maxsecwidth=<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">out &lt;&lt; <span class="string">"# LeakTracer report"</span>;</span><br><span class="line">d = diff.tv_sec + (((<span class="type">double</span>)diff.tv_nsec)/<span class="number">1000000000</span>);</span><br><span class="line">out &lt;&lt; <span class="string">" diff_utc_mono="</span> &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::left &lt;&lt; <span class="built_in">std</span>::setprecision(precision) &lt;&lt; d ;</span><br><span class="line">out &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line"> </span><br><span class="line">__allocations.beginIteration();</span><br><span class="line"><span class="keyword">while</span> (__allocations.getNextPair(&amp;info, &amp;p)) {</span><br><span class="line">d = info-&gt;timestamp.tv_sec + (((<span class="type">double</span>)info-&gt;timestamp.tv_nsec)/<span class="number">1000000000</span>);</span><br><span class="line">out &lt;&lt; <span class="string">"leak, "</span>;</span><br><span class="line">out &lt;&lt; <span class="string">"time="</span>  &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::right &lt;&lt; <span class="built_in">std</span>::setprecision(precision) &lt;&lt; <span class="built_in">std</span>::setfill(<span class="string">'0'</span>) &lt;&lt; <span class="built_in">std</span>::setw(maxsecwidth+<span class="number">1</span>+precision) &lt;&lt; d &lt;&lt; <span class="string">", "</span>; <span class="comment">// setw(16) ?</span></span><br><span class="line">out &lt;&lt; <span class="string">"stack="</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> BACKTRACE_SYMBOLS_USED</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i_depth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i_depth = <span class="number">0</span>; i_depth &lt; ALLOCATION_STACK_DEPTH; i_depth++) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;allocStack[i_depth] == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (i_depth &gt; <span class="number">0</span>) out &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">out &lt;&lt; info-&gt;allocStack[i_depth];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"><span class="type">char</span> **trace_symbols = (<span class="type">char</span> **)backtrace_symbols (info-&gt;allocStack, i_depth);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> != trace_symbols) {</span><br><span class="line"><span class="type">size_t</span> name_size = <span class="number">64</span>;</span><br><span class="line"><span class="type">char</span> *name = (<span class="type">char</span>*)<span class="built_in">malloc</span>(name_size);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> j = <span class="number">0</span>; j &lt; i_depth; j++) {</span><br><span class="line"><span class="type">char</span> *begin_name = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> *begin_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> *end_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> *p = trace_symbols[j]; *p; ++p) {</span><br><span class="line"><span class="keyword">if</span> (*p == <span class="string">'('</span>) {</span><br><span class="line">begin_name = p;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (*p == <span class="string">'+'</span> &amp;&amp; begin_name) {</span><br><span class="line">begin_offset = p;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (*p == <span class="string">')'</span> &amp;&amp; begin_offset) {</span><br><span class="line">end_offset = p;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (begin_name &amp;&amp; begin_offset &amp;&amp; end_offset ) {</span><br><span class="line">*begin_name++ = <span class="string">'\0'</span>;</span><br><span class="line">*begin_offset++ = <span class="string">'\0'</span>;</span><br><span class="line">*end_offset = <span class="string">'\0'</span>;</span><br><span class="line"><span class="type">int</span> status = <span class="number">-4</span>;</span><br><span class="line"><span class="type">char</span> *ret = abi::__cxa_demangle(begin_name, name, &amp;name_size, &amp;status);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> == status) {</span><br><span class="line">name = ret;</span><br><span class="line">out &lt;&lt; trace_symbols[j] &lt;&lt; <span class="string">":"</span> &lt;&lt; name &lt;&lt; <span class="string">"+"</span> &lt;&lt; begin_offset;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">out &lt;&lt; trace_symbols[j] &lt;&lt; <span class="string">":"</span> &lt;&lt; begin_name &lt;&lt; <span class="string">"()+"</span> &lt;&lt; begin_offset;</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">out &lt;&lt; trace_symbols[j];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">free</span>(trace_symbols);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; ALLOCATION_STACK_DEPTH; i++) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;allocStack[i] == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (i &gt; <span class="number">0</span>) out &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">out &lt;&lt; info-&gt;allocStack[i];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">", "</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">out &lt;&lt; <span class="string">"size="</span> &lt;&lt; info-&gt;size &lt;&lt; <span class="string">", "</span>;</span><br><span class="line"> </span><br><span class="line">out &lt;&lt; <span class="string">"data="</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *data = reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span> *&gt;(p);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; PRINTED_DATA_BUFFER_SIZE &amp;&amp; i &lt; info-&gt;size; i++)</span><br><span class="line">out &lt;&lt; (<span class="built_in">isprint</span>(data[i]) ? data[i] : <span class="string">'.'</span>);</span><br><span class="line">out &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æ•´ä½“æ¥çœ‹ LeakTracer çš„è®¾è®¡ä¸å®ç°éƒ½å¹¶ä¸å¤æ‚ï¼Œå› è€Œèƒ½å¤Ÿ trace çš„ memory issue ä¹Ÿå°±æœ‰é™ã€‚æ¯”å¦‚ï¼ŒLeakTracer å°±æ— æ³• trace å¤šæ¬¡é‡Šæ”¾ç­‰é—®é¢˜ã€‚ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç ç¼–å†™æ›´å¼ºå¤§çš„å†…å­˜ç›¸å…³çš„ trace å·¥å…·ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¯¹äºåº”ç”¨ï¼Œæ— è®ºæ˜¯é™æ€é“¾æ¥æˆ–åŠ¨æ€é“¾æ¥çš„åº“ï¼Œè‹¥æƒ³èƒ½å¤Ÿç”Ÿæˆ callstackï¼Œéƒ½éœ€è¦æ·»åŠ -funwind-tables é‡æ–°ç¼–è¯‘ä¸€æ¬¡ leak-analyze-addr2line å’Œ leak-analyze-gdb åœ¨ libleaktracer.tar.gz ä¸­ï¼Œéœ€è¦å°†å…¶ä¸­çš„ addr2line å’Œ gdb æ”¹æˆäº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­çš„ arm-xxx-addr2line å’Œ arm-xxx-gdb</p></blockquote><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpYW90aW5nNDUxMjkyNTEwL2FydGljbGUvZGV0YWlscy8xMDU4NTA0MDk=">https://blog.csdn.net/xiaoting451292510/article/details/105850409<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ä¸ª oops åˆ†æå®ä¾‹</title>
      <link href="/2022/Debug/oops/"/>
      <url>/2022/Debug/oops/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å‡ºç°äº†æ¯”è¾ƒå¤šçš„å†…æ ¸å´©æºƒçš„é—®é¢˜ï¼Œä¹‹å‰ä¹Ÿæ›¾è½¬å‘è¿‡ç½‘ä¸Šä¸€ç¯‡å…³äºå†…æ ¸å´©æºƒé—®é¢˜çš„è·Ÿè¸ªæ–¹æ³•ï¼Œæˆ‘åœ¨è¿™é‡Œå€Ÿ xxx æä¾›çš„è¿™ä¸ªæ­»æœºç°åœºï¼Œå†ç»™å¤§å®¶æè¿°ä¸€ä¸‹è¿™ç±»é—®é¢˜çš„åˆ†ææ–¹æ³•å’Œ debug è¿‡ç¨‹ï¼Œä¹Ÿå¸Œæœ›èƒ½è®©å¤§å®¶çœŸæ­£æŒæ¡è¿™ç±»é—®é¢˜çš„è°ƒè¯•æ–¹æ³•ã€‚è®©å¤§å®¶æ˜ç™½ï¼Œå†…æ ¸å´©æºƒé—®é¢˜çš„è°ƒè¯•æ–¹æ³•å…¶å®ä¹Ÿå°±æ˜¯è¿™æ ·ä¸€äº›å›ºå®šçš„å¥—è·¯ã€‚é—®é¢˜çš„åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><span id="more"></span><h1 id="ç¡®è®¤æ­»æœºç°åœº">ç¡®è®¤æ­»æœºç°åœº</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[56400.437450] Unable to handle kernel paging request at virtual address f7fe44a1</span><br><span class="line">[56400.440040] pgd = d112c000</span><br><span class="line">[56400.440040] [f7fe44a1] *pgd=00000000</span><br><span class="line">[56400.440040] Internal error: Oops: 5 [<span class="comment">#1] PREEMPT SMP ARM</span></span><br><span class="line">[56400.440040] Modules linked <span class="keyword">in</span>: 8188eu gt82x mma8452 rtl8150 mcs7830 qf9700 asix sunxi_keyboard sw_device vfe_v4l2 gc2035 gc0307 vfe_subdev vfe_os cci videobuf_dma_contig videobuf_core mali(O) lcd disp nand(O)</span><br><span class="line">[56400.440040] CPU: 0    Tainted: G           O  (3.4.39 <span class="comment">#428)</span></span><br><span class="line">[56400.440040] PC is at cpuacct_charge+0x68/0xa8</span><br><span class="line">[56400.440040] LR is at cpuacct_charge+0x30/0xa8</span><br><span class="line">[56400.440040] pc : [&lt;c004b93c&gt;]    lr : [&lt;c004b904&gt;]    psr: a0000093</span><br><span class="line">[56400.440040] sp : ca25bda0  ip : 0061b000  fp : ca25bdb4</span><br><span class="line">[56400.440040] r10: 00000000  r9 : 00000000  r8 : 000b64fe</span><br><span class="line">[56400.440040] r7 : 00000000  r6 : 000b64fe  r5 : 00000000  r4 : c06e4480</span><br><span class="line">[56400.440040] r3 : f7fe4479  r2 : db506884  r1 : c07312c8  r0 : c06c8a00</span><br></pre></td></tr></tbody></table></figure><p>æ ¹æ®æ­»æœºç°åœºçš„æ‰“å°åˆ†æï¼Œæ­»æœºçš„åŸå› æ˜¯å› ä¸ºæ‰§è¡Œ 0xc004b93c å¤„çš„ä»£ç è®¿é—®æ•°æ®æ—¶ï¼Œå–åˆ°ä¸€ä¸ªéæ³•åœ°å€ï¼š0xf7fe44a1ï¼Œè®¿é—®è¯¥åœ°å€çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ï¼›</p><h1 id="åæ±‡ç¼–å†…æ ¸ä»£ç åˆ†æåŸå› ">åæ±‡ç¼–å†…æ ¸ä»£ç ï¼Œåˆ†æåŸå› </h1><p>é€šè¿‡å‘½ä»¤"arm-none-linux-gnueabi-objdump -d vmlinux &gt; vmlinux.lst "ï¼Œå¯ä»¥åæ±‡ç¼–å‡ºå†…æ ¸çš„ä»£ç ã€‚ å›ºä»¶ä¸æ˜¯åœ¨æˆ‘çš„æœºå™¨ä¸Šç¼–å‡ºæ¥çš„ï¼Œæ‰€ä»¥åæ±‡ç¼–å¾—åˆ°çš„ä»£ç å’Œåœ¨æœºå™¨ä¸Šå®é™…è¿è¡Œçš„ä¸æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œä½†æ˜¯ï¼Œæ²¡å…³ç³»ï¼Œè¿™ä¸å½±å“æˆ‘ä»¬åˆ†æé—®é¢˜ã€‚ ç”±äºæœ¬åœ°çš„åæ±‡ç¼–ä»£ç å’Œè®¾å¤‡ä¸Šçš„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ PC å€¼ 0xc004b93c å»å®šä½ä»£ç ï¼Œè€Œæ˜¯ç”¨"PC is at cpuacct_charge+0x68/0xa8"è¿™ä¸ªä¿¡æ¯æ¥ç¡®è®¤æ­»æœºæ—¶çš„ä»£ç ä½ç½®ã€‚ "cpuacct_charge+0x68/0xa8"çš„å«ä¹‰æ˜¯ï¼šå‡½æ•°"cpuacct_charge"çš„ä»£ç ä¸º 0xa8 ä¸ªå­—èŠ‚ï¼Œå‡ºé”™æ—¶ï¼ŒPC ä½äº"cpuacct_charge"åç§» 0x68 å­—èŠ‚å¤„ã€‚ OKï¼Œæ ¹æ®æ­¤ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹åæ±‡ç¼–å¾—åˆ°çš„ä»£ç ã€‚cpuacct_charge ä½äº 0xc004bab4 å¤„ï¼Œåç§» 0x68 å­—èŠ‚ï¼Œå³ 0xc004bab4 + 0x68 = 0xc004bb1c å¤„å‡ºç°å¼‚å¸¸ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c004bab4 &lt;cpuacct_charge&gt;:</span><br><span class="line">c004bab4: e92d48f0  push {r4, r5, r6, r7, fp, lr}</span><br><span class="line">ã€‚</span><br><span class="line">c004bb0c: e5913000  ldr r3, [r1]</span><br><span class="line">c004bb10: e5933018  ldr r3, [r3, #24]</span><br><span class="line">c004bb14: e3530000  cmp r3, #0</span><br><span class="line">c004bb18: 0a000002  beq c004bb28 &lt;cpuacct_charge+0x74&gt;</span><br><span class="line">c004bb1c: e5931028  ldr r1, [r3, #40] ; 0x28</span><br></pre></td></tr></tbody></table></figure><p>å†å›å¤´çœ‹å¼‚å¸¸ç°åœºï¼šr3 : f7fe4479ï¼Œå‘ç° r3 + 0x28 = f7fe44a1ï¼Œä»£ç å’Œå¼‚å¸¸ç°åœºç›¸å»åˆã€‚ æ¥ä¸‹æ¥å°±æ˜¯å°è¯•åˆ†æå‡ºé”™çš„ä»£ç æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™ä¸ªæœ‰ä¸€å®šçš„éš¾åº¦ï¼Œéœ€è¦ç»“åˆ C æºä»£ç ï¼Œå’Œå¯¹æ±‡ç¼–ä»£ç çš„ç†è§£æ¥è¿›è¡Œåˆ†æã€‚</p><h1 id="å®šä½å‡ºé”™ä½ç½®çš„æºä»£ç ">å®šä½å‡ºé”™ä½ç½®çš„æºä»£ç </h1><p>é€šè¿‡åæ±‡ç¼–å¾—çŸ¥ï¼Œå‡ºé”™æ—¶çš„ PC ä½ç½®åœ¨æˆ‘ç¼–å‡ºæ¥çš„ vmlinux çš„ 0xc004bb1c åœ°å€å¤„ï¼Œé‡‡ç”¨å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-none-linux-gnueabi-addr2line -e vmlinux -f c004bb1c</span><br></pre></td></tr></tbody></table></figure><p>æ¥è¡Œæºç å®šä½ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kevin@Exdroid6:~/aw1650-47/lichee/linux-3.4$ arm-none-linux-gnueabi-addr2line -e vmlinux -f c004bb1c</span><br><span class="line">cgroup_subsys_state</span><br><span class="line">/home/kevin/aw1650-47/lichee/linux-3.4/include/linux/cgroup.h:508</span><br></pre></td></tr></tbody></table></figure><p></p><p>å‘ç°å‡ºé”™çš„æºä»£ç æ˜¯åœ¨æ“ä½œä¸€ä¸ªé“¾è¡¨ä¸Šçš„æŒ‡é’ˆï¼Œè¿™äº›æ•°æ®ä¸æ˜¯å…¨å±€å˜é‡ï¼Œå¾ˆéš¾åˆ†æå‡ºå…¶å‡ºé”™çš„æœ¬è´¨åŸå› ï¼Œæ‰€ä»¥æºç åˆ†æä¸€æ­¥åœ¨è¿™æ—¶å¯ä»¥æ”¾å¼ƒï¼›</p><h1 id="åˆ†æå‡ºé”™çš„æ±‡ç¼–ä»£ç ">åˆ†æå‡ºé”™çš„æ±‡ç¼–ä»£ç </h1><p>ç»“åˆ"cpuacct_charge"å‡½æ•°çš„ C ä»£ç å®ç°ï¼Œå†å›å¤´çœ‹å‡ºé”™æ—¶çš„æ±‡ç¼–ä»£ç ï¼Œå‘ç°å‡ºé”™çš„ä»£ç å…¶å®æ˜¯ä½äºä¸€ä¸ªå¾ªç¯ä½“ä¸­ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">c004baf0: ea00000a  b c004bb20 &lt;cpuacct_charge+0x6c&gt;</span><br><span class="line">c004baf4: e794c105  ldr ip, [r4, r5, lsl <span class="comment">#2]</span></span><br><span class="line">c004baf8: e5910010  ldr r0, [r1, <span class="comment">#16]</span></span><br><span class="line">c004bafc: e18020dc  ldrd r2, [r0, ip]</span><br><span class="line">c004bb00: e0922006  adds r2, r2, r6</span><br><span class="line">c004bb04: e0a33007  adc r3, r3, r7</span><br><span class="line">c004bb08: e18020fc  strd r2, [r0, ip]</span><br><span class="line">c004bb0c: e5913000  ldr r3, [r1]</span><br><span class="line">c004bb10: e5933018  ldr r3, [r3, <span class="comment">#24]</span></span><br><span class="line">c004bb14: e3530000  cmp r3, <span class="comment">#0</span></span><br><span class="line">c004bb18: 0a000002  beq c004bb28 &lt;cpuacct_charge+0x74&gt;</span><br><span class="line">c004bb1c: e5931028  ldr r1, [r3, <span class="comment">#40] ; 0x28</span></span><br><span class="line">c004bb20: e3510000  cmp r1, <span class="comment">#0</span></span><br><span class="line">c004bb24: 1afffff2  bne c004baf4 &lt;cpuacct_charge+0x40&gt;</span><br></pre></td></tr></tbody></table></figure><p>å‡ºé”™çš„ä»£ç æ˜¯ï¼š"c004bb1c: e5931028 ldr r1, [r3, #40] ; 0x28"ï¼Œå³ r3 çš„å€¼æ˜¯é”™çš„ï¼Œæˆ‘ä»¬æ¥å°è¯•åˆ†æ r3 è¿™ä¸ªæ•°æ®çš„æ¥æºã€‚ ä»ï¼š"c004bb1c: e5931028 ldr r1, [r3, #40] ; 0x28"è¿™å¥ä»£ç å‘å‰æ‰¾ï¼Œå‘ç° r3 æ•°æ®çš„ç›´æ¥æ¥æºæ˜¯ r1ï¼Œ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c004bb0c: e5913000  ldr r3, [r1]</span><br><span class="line">c004bb10: e5933018  ldr r3, [r3, <span class="comment">#24]</span></span><br></pre></td></tr></tbody></table></figure><p>å†å›å¤´çœ‹å¼‚å¸¸ç°åœºçš„ r1 å€¼ä¸º"r1 : c07312c8"ï¼Œä»¥åŠ r1 æ‰€æŒ‡å‘çš„æ•°æ®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[56400.440040] R1: 0xc0731248:</span><br><span class="line">[56400.440040] 1248  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[56400.440040] 1268  00000000 00000000 00000000 00000000 d9833700 00989680 00000000 00000000</span><br><span class="line">[56400.440040] 1288  00000000 00000000 00000000 d9818e40 00000000 00000000 00000000 d9847380</span><br><span class="line">[56400.440040] 12a8  d9800dc0 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">[56400.440040] 12c8  d8dd2018 00000001 00000001 00000000 c06c8a00 c06c5768 00000000 00000000</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°"c004bb0c: e5913000 ldr r3, [r1]"å–åˆ°çš„ r3 å€¼ä¸º 0xd8dd2018ï¼Œå†çœ‹æ¥ä¸‹æ¥çš„ä¸€æ¡æ±‡ç¼–ï¼š "c004bb10: e5933018 ldr r3, [r3, #24]"ï¼Œå³é”™è¯¯çš„æ•°æ®æ˜¯ä» 0xd8dd2018 + 24 = 0xd8dd2030 å¤„å–åˆ°çš„ã€‚</p><p>æ­¤æ—¶å¦‚æœæƒ³å†å¾€ä¸‹åˆ†æï¼Œå°±åªèƒ½å€ŸåŠ© Jtag äº†ã€‚</p><h1 id="jtag-åˆ†æ">Jtag åˆ†æ</h1><p>å½“å‰æ­»æœºçš„è¿™ä¸€å°ï¼ŒDS-5 æ— æ³•æ‰“å¼€ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ç›´æ¥é€šè¿‡ DS-5 æ¥æŸ¥çœ‹ 0xd8dd2030 å¤„çš„æ•°æ®æ˜¯å¦çœŸçš„é”™äº†ã€‚ æ­¤æ—¶ï¼Œå¯ä»¥å…ˆæ¨æ–­ CPU æ¨¡å—æœ¬èº«å·²ç»å‡ºé”™äº†ï¼Œå¯¼è‡´ jtag æ— æ³•é€šè¿‡ CPU è®¿é—®æ•°æ®ã€‚ æˆ‘ä»¬å†æ¥å°è¯•ä¸€ä¸‹ç”¨ JTAG çš„ CSAT æ–¹å¼ï¼Œè®¿é—®ä¸€ä¸‹ï¼Œå‘ç° CSAT å¯ä»¥è¿æ¥ä¸Šï¼Œè€Œä¸”å¯ä»¥è¯»å–ç‰©ç†å†…å­˜çš„å†…å®¹ã€‚ ç”±äº CSAT æ˜¯ç»•è¿‡ CPU æ¥è®¿é—®å†…å­˜çš„æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è®¿é—®"0xd8dd2030"å¤„çš„å†…å®¹ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå†…æ ¸ ç©ºé—´æœ‰è¿‘ 700Mbyte çš„æ˜¯ç›´æ¥æ˜ å°„çš„ï¼Œå³ 0x40000000 -&gt; 0xc0000000ï¼Œé‚£ä¹ˆ 0xd8dd2030 æ‰€å¯¹åº”çš„ç‰©ç†åœ°å€åº”è¯¥ ä¸º 0x58dd2030ï¼Œé€šè¿‡ CSAT æŸ¥çœ‹ä¸€ä¸‹ 0x58dd2030 å¤„çš„æ•°æ®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%&gt;dmr 0 0x58dc6010 16</span><br><span class="line">0x58DC6010 : 0xC06ED7EC 0xC06ED7EC 0x00000002 0x00000001</span><br><span class="line">0x58DC6020 : 0xD8DC6020 0xD8DC6020 0xD9A32088 0xD9A32088</span><br><span class="line">0x58DC6030 : 0x00000000 0xD9432F70 0x00000000 0x00000000</span><br><span class="line">0x58DC6040 : 0xC07312C8 0x00000000 0x00000000 0x00000000</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å‘ç°ï¼Œ0x58dd2030 å¤„çš„æ•°æ®æ˜¯ 0x00000000ï¼Œå³ï¼š0xd8dd2030 å¤„çš„æ•°æ®åº”è¯¥æ˜¯ 0x00000000ã€‚</p><p>å†å›å¤´çœ‹æŠŠæ±‡ç¼–å‡ºæ¥çš„ä»£ç ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c004bb10: e5933018  ldr r3, [r3, <span class="comment">#24]</span></span><br><span class="line">c004bb14: e3530000  cmp r3, <span class="comment">#0</span></span><br><span class="line">c004bb18: 0a000002  beq c004bb28 &lt;cpuacct_charge+0x74&gt;</span><br><span class="line">c004bb1c: e5931028  ldr r1, [r3, <span class="comment">#40] ; 0x28</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ r3 æ˜¯ 0ï¼Œåº”è¯¥æ˜¯é€€å‡ºå¾ªç¯ï¼Œè€Œä¸æ˜¯å†å»å–å€¼ï¼Œå› æ­¤ï¼Œå¯ä»¥å…ˆæ¨æ–­ï¼Œå‡ºé”™çš„åŸå› å¯èƒ½æ˜¯ï¼š</p><ul><li>cpu æœ¬èº«å‡ºé”™ï¼Œå¯¼è‡´æŒ‡ä»¤æ‰§è¡Œä¸æ­£å¸¸ï¼Œä»è€Œå¯¼è‡´ r3 ä¸­çš„æ•°æ®å‡ºé”™</li><li>DRAM è®¿é—®å‡ºé”™ï¼Œå¯¼è‡´å–å›åˆ° r3 çš„æ•°æ®æ˜¯é”™çš„</li></ul><p>å†ç»“åˆæˆ‘ä»¬ä¹‹å‰çš„æ¨æ–­ï¼ŒCPU æ¨¡å—æœ¬èº«å¯èƒ½å·²ç»å‡ºé”™äº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æ›´ç¯ç–‘è¯¥é—®é¢˜æ˜¯ CPU å·¥ä½œä¸ç¨³å®šå¯¼è‡´çš„ã€‚ æˆ‘ä»¬å†æ¥ç¡®è®¤ä¸€ä¸‹æ­¤æ—¶ CPU çš„å·¥ä½œé¢‘ç‡å’Œç”µå‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%&gt;dmr 0 0x1c20000 16</span><br><span class="line">0x01C20000 : 0x90001410 0x00000000 0x90034E14 0x00000000</span><br></pre></td></tr></tbody></table></figure><p>æ ¹æ®å¯„å­˜å™¨çš„å€¼å¯ä»¥æ¨å‡º CPU å½“å‰å·¥ä½œé¢‘ç‡ä¸º 1008Mhzï¼›æµ‹å¾—å½“å‰çš„ CPU å·¥ä½œç”µå‹ä¸ºï¼š1.17vï¼›</p><p>åˆ†æä¸‹æ¥ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æŸ¥æ˜é—®é¢˜çš„åŸå› ï¼Œåªæ˜¯åˆæ­¥æ¨æµ‹äº†ä¸€ä¸ªé—®é¢˜å¯èƒ½çš„æ–¹å‘ï¼Œåç»­çš„å®éªŒå¯ä»¥é‡ç‚¹è§‚æ³¨è¯¥æ–¹å‘ä¸Šçš„ä¸€äº›å®éªŒã€‚</p><h1 id="å…¶ä»–å¸¸ç”¨å‘½ä»¤">å…¶ä»–å¸¸ç”¨å‘½ä»¤</h1><p>æ ¹æ®å‡½æ•°åæ‹¿åˆ°å‡½æ•°çš„åœ°å€ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabi-nm vmlinux | grep __cpuinfo_store_cpu</span><br><span class="line">ffffff80100919c0 t __cpuinfo_store_cpu</span><br></pre></td></tr></tbody></table></figure><p>æ ¹æ®å‡ºé”™çš„ä½ç½®è®¡ç®—èµ·å§‹å’Œç»“æŸåœ°å€</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"obase=16;ibase=10;<span class="subst">$((0x80100919c0+0x80)</span>)"</span> | bc -l</span><br><span class="line">8010091A40</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"obase=16;ibase=10;<span class="subst">$((0x80100919c0+0x1d0)</span>)"</span> | bc -l</span><br><span class="line">8010091B90</span><br></pre></td></tr></tbody></table></figure><p>æ ¹æ®èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ dump å‡ºå‡ºé”™çš„æ±‡ç¼–å’Œæºç ï¼Œç»“åˆ oops ç°åœºè¿›è¡Œå¤ç›˜åˆ†æ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabi-objdump -dS vmlinux --start-address=0xffffff80100919c0 --stop-address=0xffffff8010091b90</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡</title>
      <link href="/2022/Science/ProbabilityTheoryandMathematicalStatistics/"/>
      <url>/2022/Science/ProbabilityTheoryandMathematicalStatistics/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/ProbabilityTheoryandMathematicalStatistics.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjFlMWQ1NTYzNzY4OTIxMjI5OWRhNDU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚ç‡è®ºåŸºæœ¬æ¦‚å¿µ">æ¦‚ç‡è®ºåŸºæœ¬æ¦‚å¿µ</h1><h2 id="æ¦‚ç‡çš„æ´¾åˆ«">æ¦‚ç‡çš„æ´¾åˆ«</h2><p>å¯¹äºæ¦‚ç‡çš„å®šä¹‰æœ‰å‡ ä¸ªä¸»æµçš„æ´¾åˆ«ï¼š</p><ul><li><p>é¢‘ç‡æ´¾ï¼š é¢‘ç‡æ´¾è®¤ä¸ºå¦‚æœé¢‘ç‡å­˜åœ¨ç¨³å®šæ€§ï¼Œå³å½“<span class="math inline">\(n\to\infty\)</span>æ—¶ä¸‹é¢æé™å­˜åœ¨ï¼ˆä¸‹é¢è¿™ä¸ªå†™æ³•åªæ˜¯ç¤ºæ„ï¼Œåé¢ä»‹ç»å¤§æ•°å®šå¾‹çš„æ—¶å€™ä¼šç»™å‡ºä¸¥æ ¼çš„å®šä¹‰ï¼‰ï¼Œå°±å¾—åˆ°äº†æ¦‚ç‡ï¼ˆç”¨ Probability çš„é¦–å­—æ¯ P æ¥è¡¨ç¤ºï¼‰ï¼š <span class="math display">\[  Pï¼ˆæ­£é¢ï¼‰=\lim_{n\to\infty}P_{n}ï¼ˆæ­£é¢ï¼‰  \]</span></p></li><li><p>å¤å…¸æ´¾ï¼š å¦‚æœå› ä¸ºæ— çŸ¥ï¼Œä½¿å¾—æˆ‘ä»¬æ²¡æœ‰åŠæ³•åˆ¤æ–­å“ªä¸€ä¸ªç»“æœä¼šæ¯”å¦å¤–ä¸€ä¸ªç»“æœæ›´å®¹æ˜“å‡ºç°ï¼Œé‚£ä¹ˆåº”è¯¥ç»™äºˆå®ƒä»¬ç›¸åŒçš„æ¦‚ç‡ï¼Œæ­¤ç§°ä¸ºä¸å……åˆ†ç†ç”±åŸåˆ™ï¼ˆInsufficient Reason Principleï¼‰ã€‚ä»¥ä¸å……åˆ†ç†ç”±åŸåˆ™ä¸ºåŸºç¡€ï¼Œç»ç”±æ‹‰æ™®æ‹‰æ–¯ï¼šä¹‹æ‰‹ï¼Œç¡®ç«‹äº†å¤å…¸æ¦‚ç‡çš„å®šä¹‰ï¼Œå³ï¼š æœªçŸ¥çš„æ¦‚ç‡éƒ½ä¸ºç­‰æ¦‚ç‡</p></li><li><p>ä¸»è§‚æ´¾ï¼š æœ€åä»‹ç»ä¸‹ä¸»è§‚æ´¾ï¼Œä¸»è§‚æ´¾è®¤ä¸ºæ¦‚ç‡æ˜¯ä¿¡å¿µå¼ºåº¦ï¼ˆdegree of beliefï¼‰ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä¸ªäººç›¸ä¿¡ 20 å¹´åäººç±»ä»ç½‘ç»œæ—¶ä»£è¿›å…¥äººå·¥æ™ºèƒ½æ—¶ä»£çš„æ¦‚ç‡ä¸º 70%.</p></li></ul><p>ä¸‰ä¸ªæµæ´¾å¤§æ¦‚æœ‰ä»¥ä¸‹çš„åŒºåˆ«ï¼š <span class="math display">\[\begin{array}{c|c}    \hline    \quad\quad&amp;\quad\color{orange}{é¢‘ç‡æ´¾}\quad&amp;\quad\color{blue}{å¤å…¸æ´¾}\quad&amp;\quad\color{ForestGreen}{ä¸»è§‚æ´¾}\quad\\    \hline \\    \quad ç†è®ºåŸºç¡€ \quad&amp;\quad è¿‡å¾€äº‹å®çš„å½’çº³æ€»ç»“ã€quad&amp;\quad ä¸å……åˆ†ç†ç”±åŸåˆ™ã€quad&amp;\quad çŸ¥è¯†å’Œç›´è§‰ã€quad\\    \quad æ¦‚ç‡å®šä¹‰ \quad&amp;\quad é¢‘ç‡ç¨³å®šæ€§ã€quad&amp;\quad ç­‰æ¦‚ç‡ã€quad&amp;\quad ä¿¡å¿µå¼ºåº¦ã€quad\\    \\\hline\end{array}\]</span></p><h2 id="æ¦‚ç‡å…¬ç†åŒ–">æ¦‚ç‡å…¬ç†åŒ–</h2><p>å·²çŸ¥æŸæ ·æœ¬ç©ºé—´<span class="math inline">\(\Omega\)</span>ï¼Œå¯¹äºå…¶ä¸­ä»»ä¸€äº‹ä»¶<span class="math inline">\(A\)</span>ï¼Œå®šä¹‰å‡½æ•°<span class="math inline">\(P\)</span>ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸‰å¤§å…¬ç†ï¼š</p><ul><li><p>éè´Ÿæ€§å…¬ç†ï¼š <span class="math display">\[  P(A)\ge 0  \]</span></p></li><li><p>è§„èŒƒæ€§å…¬ç†ï¼š <span class="math display">\[  P(\Omega) = 1  \]</span></p></li><li><p>å¯åŠ æ€§å…¬ç†ï¼š è®¾<span class="math inline">\(A_1ã€A_2ã€\cdots\)</span>ä¸ºä¸¤ä¸¤ä¸ç›¸å®¹çš„äº‹ä»¶ï¼Œå³<span class="math inline">\(A_i\cap A_j=\varnothingï¼ˆi\ne jï¼‰\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[  P(A_1\cup A_2\cup\cdots) = P(A_1)+P(A_2)+\cdots  \]</span></p></li></ul><p>åˆ™<span class="math inline">\(P\)</span>ç§°ä¸ºæ¦‚ç‡å‡½æ•°ï¼Œ<span class="math inline">\(P(A)\)</span>ç§°ä¸ºäº‹ä»¶ A çš„æ¦‚ç‡ã€‚</p><h2 id="äº‹ä»¶ä¹‹é—´çš„è¿ç®—å’Œå…³ç³»">äº‹ä»¶ä¹‹é—´çš„è¿ç®—å’Œå…³ç³»</h2><ul><li><p>å¹¶è¿ç®—ï¼š å¯¹äºäº‹ä»¶<span class="math inline">\(Aã€B\)</span>ï¼Œå¹¶è¿ç®—å®šä¹‰ä¸ºï¼ˆ<span class="math inline">\(\equiv\)</span>è¡¨ç¤ºå®šä¹‰ï¼‰ï¼š <span class="math display">\[  A\cup B\equiv\{x|x\in A\ æˆ– \ x\in B\}  \]</span></p></li><li><p>äº¤è¿ç®—ï¼š å¯¹äºäº‹ä»¶<span class="math inline">\(Aã€B\)</span>ï¼Œäº¤è¿ç®—å®šä¹‰ä¸ºï¼š <span class="math display">\[  A\cap B\equiv\{x|x\in A\ ä¸” \ x\in B\}  \]</span></p></li><li><p>å·®è¿ç®—ï¼š å¯¹äºäº‹ä»¶<span class="math inline">\(Aã€B\)</span>ï¼Œå®šä¹‰å·®è¿ç®—ä¸ºï¼š <span class="math display">\[  A-B\equiv\{x|x\in A\quad ä¸”ã€quad x\notin B\}  \]</span></p></li><li><p>è¡¥è¿ç®—ï¼š å¯¹äºäº‹ä»¶ Aã€Bï¼Œå¦‚æœï¼š <span class="math display">\[  A=\Omega-B  \]</span> åˆ™ç§° B ä¸º A çš„è¡¥ï¼Œè®°ä½œï¼ˆå…¶ä¸­ c ä»£è¡¨ Complementï¼‰ï¼š <span class="math display">\[  B=\overline{A}\quad æˆ–ã€quad B=A^c  \]</span></p></li><li><p>åŸºæœ¬è¿ç®—çš„æ€§è´¨ï¼š <span class="math display">\[\begin{array}{c|c|c}  \hline  \quad\quad&amp;\quad  ç±»æ¯”ã€quad&amp;\quad æ”¹å†™ \quad\\  \hline  \\  \quad å¹¶ \quad&amp;\quad  +\quad&amp;\quad A\cup B=A+B \quad\\  \quad äº¤ \quad&amp;\quad  \times\quad&amp;\quad A\cap B=AB \quad\\   \quad å·® \quad&amp;\quad  -\quad&amp;\quad A-B \quad\\  \\  \hline\end{array}\]</span></p></li><li><p>å¾·æ‘©æ ¹å®šå¾‹ï¼š <span class="math display">\[  \overline{A\cup B}=\overline{A}\cap\overline{B}  \]</span> = $$</p></li><li><p>å°ç»“ï¼š <span class="math display">\[\begin{array}{c|c|c}  \hline  \quad\quad&amp;\quad å®šä¹‰ã€quad&amp;\quad ç±»æ¯”ã€quad\\  \hline  \\  \quad å¹¶ \quad&amp;\quad A\cup B=\{x|x\in A\ æˆ– \ x\in B\}\quad&amp;\quad  +\quad\\  \quad äº¤ \quad&amp;\quad A\cap B=\{x|x\in A\ ä¸” \ x\in B\}\quad&amp;\quad  \times\quad\\   \quad å·® \quad&amp;\quad A-B=\{x|x\in A\ ä¸”ã€x\notin B\}\quad&amp;\quad  -\quad\\  \quad è¡¥ \quad&amp;\quad \overline{A}=B\iff B=\Omega - A\\  \\  \hline\end{array}\]</span></p></li><li><p>äº‹ä»¶ä¹‹é—´çš„å…³ç³»ï¼š</p></li></ul><p><span class="math display">\[   äº‹ä»¶ä¹‹é—´çš„å…³ç³»=\begin{cases}    åŒ…å«ã€\    ç›¸ç­‰ã€\    ä¸ç›¸å®¹ã€\    å¯¹ç«‹\end{cases}\]</span></p><h2 id="æ¡ä»¶æ¦‚ç‡">æ¡ä»¶æ¦‚ç‡</h2><p>è®¾ A å’Œ B æ˜¯æ ·æœ¬ç©ºé—´<span class="math inline">\(\Omega\)</span>ä¸­çš„ä¸¤äº‹ä»¶ï¼Œè‹¥<span class="math inline">\(P(B) &gt; 0\)</span>ï¼Œåˆ™ç§°ï¼š</p><p><span class="math display">\[P(A|B)=\frac{P(A\cap B)}{P(B)}\]</span></p><p>ä¸ºâ€œå‡è®¾æ¡ä»¶ä¸º B æ—¶çš„ A çš„æ¦‚ç‡â€ï¼Œç®€ç§°æ¡ä»¶æ¦‚ç‡ã€‚ä¹Ÿå¸¸å†™ä½œï¼š</p><p><span class="math display">\[P(A|B)=\frac{P(AB)}{P(B)}\]</span></p><h4 id="ä¹˜æ³•å…¬å¼">ä¹˜æ³•å…¬å¼</h4><ul><li><p>è‹¥<span class="math inline">\(P(B) &gt; 0\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  P(AB)=P(\color{Orange}{B})P(A|\color{Orange}{B})  \]</span></p></li><li><p>è‹¥<span class="math inline">\(P(A) &gt; 0\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  P(AB)=P(\color{Magenta}{A})P(B|\color{Magenta}{A})  \]</span></p></li><li><p>è‹¥<span class="math inline">\(P(A_1\cdots A_n) &gt; 0\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  P(A_1\cdots A_n)=P(A_1)P(A_2|A_1)P(A_3|A_1A_2)\cdots P(A_n|A_1\cdots A_{n-1})  \]</span></p></li></ul><p>63 4ã€ è´å¶æ–¯ä¸å…¨æ¦‚ç‡ å¯¹äºåŒä¸€æ ·æœ¬ç©ºé—´<span class="math inline">\(\Omega\)</span>ä¸­çš„éšæœºäº‹ä»¶<span class="math inline">\(Aã€B\)</span>ï¼Œè‹¥<span class="math inline">\(P(B) \ne 0\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[P(A|B)=\frac{P(A)}{P(B)}P(B|A)\]</span></p><p>è®¾<span class="math inline">\(A_1ã€A_2ã€\cdotsã€A_n\)</span>æ»¡è¶³ï¼š <span class="math display">\[A_i\cap A_j=\varnothing , (i\ne j)\quad ä¸”ã€quad P(\bigcup_{i=1}^{n}A_i)=1\]</span></p><p>è‹¥<span class="math inline">\(P(A_i) &gt; 0,i=1,2,\cdots,n\)</span>ï¼Œåˆ™å¯¹ä»»æ„äº‹ä»¶<span class="math inline">\(B\)</span>æœ‰ï¼š <span class="math display">\[P(B)=\sum_{i=1}^{n}P(A_i)P(B|A_i)\]</span></p><p>æœ‰äº†å…¨æ¦‚ç‡å…¬å¼åï¼Œå¯ä»¥å¾—åˆ°è´å¶æ–¯å®šç†çœŸæ­£çš„æ ·å­ï¼š è®¾<span class="math inline">\(A_1ã€A_2ã€\cdotsã€A_n\)</span>ä¸ºæ ·æœ¬ç©ºé—´<span class="math inline">\(\Omega\)</span>çš„ä¸€ä¸ªåˆ†å‰²ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[\begin{aligned}    P(A_i|B)        &amp;=\frac{P(BA_i)}{P(B)}\\        \\        &amp;=\frac{P(B|A_i)}{P(B)}P(A_i)\\        \\        &amp;=\frac{P(B|A_i)}{\displaystyle\sum_{i=1}^{n}P(A_i)P(B|A_i)}P(A_i)\end{aligned}\]</span></p><p>ä¹Ÿå°±æ˜¯æŠŠ<span class="math inline">\(P(B)\)</span>åˆ†è§£åˆ°åˆ†å‰²<span class="math inline">\(A_1ã€A_2ã€\cdotsã€A_n\)</span>ä¸Šå»äº†ã€‚</p><h2 id="ç‹¬ç«‹äº‹ä»¶">ç‹¬ç«‹äº‹ä»¶</h2><p>å¯¹äºä¸¤ä¸ªéšæœºäº‹ä»¶<span class="math inline">\(Aã€B\)</span>ï¼Œå¦‚æœæ»¡è¶³ï¼š <span class="math display">\[P(AB)=P(A)P(B)\]</span></p><p>åˆ™ç§° A ä¸ B ç›¸äº’ç‹¬ç«‹ï¼Œæˆ–ç®€ç§° A ä¸ B ç‹¬ç«‹ï¼Œå¦åˆ™ç§° A ä¸ B ä¸ç‹¬ç«‹æˆ–ç›¸ä¾ã€‚</p><p>è®¾<span class="math inline">\(A_1ã€A_2ã€\cdots\)</span>ä¸ºæœ‰é™ä¸ªæˆ–è€…æ— é™ä¸ªäº‹ä»¶ï¼Œä»ä¸­ä»»å–ä¸¤ä¸ª<span class="math inline">\(A_{i1}ã€A_{i2}\)</span>ï¼Œè‹¥æ»¡è¶³ï¼š <span class="math display">\[P(A_{i1}A_{i2})=P(A_{i1})P(A_{i2})\]</span></p><p>åˆ™ç§°<span class="math inline">\(A_1ã€A_2ã€\cdots\)</span>æ˜¯ä¸¤ä¸¤ç‹¬ç«‹ã€‚</p><p>è‹¥ä»ä¸­ä»»å–æœ‰é™ä¸ª<span class="math inline">\(A_{j1}ã€A_{j2}ã€\cdotsã€A_{jm}\)</span>ï¼Œè‹¥æ»¡è¶³ï¼š <span class="math display">\[P(A_{j1}A_{j2}\cdots A_{jm})=P(A_{j1})P(A_{j2})\cdots P(A_{jm})\]</span></p><p>åˆ™ç§°<span class="math inline">\(A_1ã€A_2ã€\cdots\)</span>æ˜¯ç›¸äº’ç‹¬ç«‹ã€‚</p><h1 id="éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ">éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ</h1><h2 id="éšæœºå˜é‡">éšæœºå˜é‡</h2><p>å®šä¹‰åœ¨æ ·æœ¬ç©ºé—´<span class="math inline">\(\Omega\)</span>ä¸Šçš„å®å€¼å‡½æ•°ï¼š <span class="math display">\[X=X(\omega),\quad \omega\in\Omega\]</span></p><p>ç§°ä¸ºéšæœºå˜é‡ã€‚éšæœºå˜é‡æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥éƒ½ç”¨å¤§å†™å­—æ¯æ¥è¡¨ç¤ºï¼Œä»¥ç¤ºå’Œè‡ªå˜é‡ x çš„åŒºåˆ«ã€‚</p><h2 id="äºŒé¡¹åˆ†å¸ƒ">äºŒé¡¹åˆ†å¸ƒ</h2><h4 id="æ¦‚ç‡è´¨é‡å‡½æ•°">æ¦‚ç‡è´¨é‡å‡½æ•°</h4><p>å¦‚æœ<span class="math inline">\(p(x)\)</span>æ»¡è¶³<span class="math inline">\(ï¼ˆx\in \{x_i\},i=1,2,\cdotsï¼‰\)</span>ï¼š</p><ul><li><p>éè´Ÿæ€§ï¼š <span class="math display">\[  p(x_i) \ge 0  \]</span></p></li><li><p>è§„èŒƒæ€§ï¼š <span class="math display">\[  \sum_{i=1}^{\infty}p(x_i)=1  \]</span></p></li></ul><p>åˆ™ç§°å…¶ä¸ºæ¦‚ç‡è´¨é‡å‡½æ•°ï¼ˆPMFï¼‰ã€‚</p><h4 id="ä¼¯åŠªåˆ©åˆ†å¸ƒ">ä¼¯åŠªåˆ©åˆ†å¸ƒ</h4><p>æŸæ ·æœ¬ç©ºé—´åªåŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼Œ<span class="math inline">\(\Omega=\{\omega_1,\omega_2\}\)</span>ï¼Œåœ¨å…¶ä¸Šå®šä¹‰éšæœºå˜é‡<span class="math inline">\(X\)</span>ï¼š <span class="math display">\[X=X(\omega)=\begin{cases}1,&amp;\omega=\omega_1\\0,&amp;\omega=\omega_2\end{cases}\]</span></p><p>è‹¥<span class="math inline">\(0\le p\le 1\)</span>æ—¶ï¼Œæœ‰ï¼š</p><p><span class="math display">\[p(1)=P(X=1)=p\]</span></p><p><span class="math display">\[p(0)=P(X=0)=1-p\]</span></p><p>æˆ–å†™ä½œï¼š</p><p><span class="math display">\[P(X=x)=p(x)=\begin{cases}p,&amp;x=1\\1-p,&amp;x=0 \end{cases}\]</span></p><p>åˆ™æ­¤æ¦‚ç‡åˆ†å¸ƒç§°ä½œ 0-1 åˆ†å¸ƒï¼Œä¹Ÿç§°ä½œä¼¯åŠªåˆ©åˆ†å¸ƒã€‚</p><p>åœ¨æ•°å­¦ä¸­ï¼Œç±»ä¼¼äºæ‰”ä¸€æ¬¡ç¡¬å¸è¿™æ ·çš„â€œæ˜¯éé¢˜â€ç§°ä¸ºä¸€æ¬¡ä¼¯åŠªåˆ©è¯•éªŒï¼Œåƒä¸Šé¢è¿™æ ·ç‹¬ç«‹åœ°é‡å¤æ‰” n æ¬¡ç¡¬å¸ï¼ˆåšåŒæ ·çš„â€œæ˜¯éé¢˜â€n æ¬¡ï¼‰ï¼Œå°±ç§°ä¸º n é‡ä¼¯åŠªåˆ©è¯•éªŒã€‚</p><h3 id="äºŒé¡¹åˆ†å¸ƒ-1">äºŒé¡¹åˆ†å¸ƒ</h3><p>å¯¹äº n é‡ä¼¯åŠªåˆ©å®éªŒï¼Œå¦‚æœæ¯æ¬¡å¾—åˆ°â€œæ˜¯â€çš„æ¦‚ç‡ä¸º pï¼Œè®¾éšæœºå˜é‡ï¼š <span class="math display">\[X=å¾—åˆ°â€œæ˜¯â€çš„æ¬¡æ•°\]</span></p><p>åˆ™ç§°ï¼š <span class="math display">\[p(k)=P(X=k)={n\choose k}p^k(1-p)^{n-k},\quad k=0,1,\cdots,n\]</span></p><p>ä¸ºéšæœºå˜é‡ X çš„äºŒé¡¹åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥è®°ä½œï¼š <span class="math display">\[X\sim b(n,p)\]</span></p><p>å½“ n=1 çš„æ—¶å€™ï¼Œå¯¹åº”çš„å°±æ˜¯ä¼¯åŠªåˆ©åˆ†å¸ƒï¼Œæ‰€ä»¥ä¼¯åŠªåˆ©åˆ†å¸ƒä¹Ÿå¯ä»¥è®°ä½œ<span class="math inline">\(b(1,p)\)</span>ã€‚</p><h3 id="ç¦»æ•£çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°">ç¦»æ•£çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°</h3><p>è®¾<span class="math inline">\(X\)</span>æ˜¯ä¸€ä¸ªéšæœºå˜é‡ï¼Œ<span class="math inline">\(x\)</span>æ˜¯ä»»æ„å®æ•°ï¼Œå‡½æ•°ï¼š <span class="math display">\[F(x)=P(X \le x)=\sum_{a\le x}p(a)\]</span></p><p>å› ä¸ºæ˜¯æŠŠæ¦‚ç‡è´¨é‡å‡½æ•°ç´¯åŠ èµ·æ¥ï¼Œæ‰€ä»¥ç§°ä¸ºç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCumulative Distribution Functionï¼Œæˆ–è€…ç¼©å†™ä¸º CDFï¼‰ï¼Œä¹Ÿç®€ç§°ä¸ºåˆ†å¸ƒå‡½æ•°ã€‚</p><p>ç¦»æ•£çš„æ•°å­¦æœŸæœ› è®¾ç¦»æ•£éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¦‚ç‡è´¨é‡å‡½æ•°ä¸ºï¼š <span class="math display">\[p(x_i)=P(X=x_i),i=1,2,\cdots,n,\cdots\]</span></p><p>å¦‚æœï¼š <span class="math display">\[\sum_{i=1}^{\infty}|x_i|p(x_i) &lt; \infty\]</span> åˆ™ç§°ï¼š <span class="math display">\[E(X)=\sum_{i=1}^{\infty}x_ip(x_i)\]</span></p><p>ä¸ºéšæœºå˜é‡ X çš„æ•°å­¦æœŸæœ›ï¼ˆexpected valueï¼Œæˆ–ï¼Œexpectationï¼‰ï¼Œç®€ç§°æœŸæœ›æˆ–å‡å€¼ï¼ˆmeanï¼‰ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ–‡æ¡£ä¼šç”¨<span class="math inline">\(\mu_X\)</span>æ¥è¡¨ç¤ºï¼ˆå¦‚æœä¸å¼ºè°ƒéšæœºå˜é‡çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨<span class="math inline">\(\mu\)</span>æ¥è¡¨ç¤ºï¼‰ï¼š <span class="math display">\[\mu_X=\mu=\sum_{i=1}^{\infty}x_ip(x_i)\]</span></p><p>è‹¥çº§æ•°<span class="math inline">\(\sum_{i=1}^{\infty}|x_i|p(x_i)\)</span>ä¸æ”¶æ•›ï¼Œåˆ™ç§°<span class="math inline">\(X\)</span>çš„æ•°å­¦æœŸæœ›ä¸å­˜åœ¨ã€‚</p><p>å­¦æœŸæœ›ä¹Ÿç§°ä½œçŸ©ã€‚æ›´å‡†ç¡®ç‚¹è¯´ï¼Œç”±äºæ•°å­¦æœŸæœ›ï¼š <span class="math display">\[E(X)=\sum_{i=1}^{\infty}x_ip(x_i)\]</span> ä¸­<span class="math inline">\(x_i\)</span>æ˜¯ä¸€æ¬¡é¡¹ï¼Œæ‰€ä»¥åˆç§°ä½œä¸€é˜¶çŸ©ã€‚è¿™ä¸ªç§°å‘¼ç»å¸¸åœ¨ç»Ÿè®¡çš„ä¹¦ä¸Šä¼šé‡åˆ°ï¼Œç‰¹åœ¨æ­¤è¯´æ˜ã€‚</p><h4 id="æ•°å­¦æœŸæœ›çš„æ€§è´¨">æ•°å­¦æœŸæœ›çš„æ€§è´¨</h4><ul><li><p>å¤åˆï¼š å‡è®¾<span class="math inline">\(g(X)\)</span>ä¸ºéšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æŸä¸€å‡½æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  E\left[g(X)\right]=\sum_i g(x_i)p(x_i)  \]</span></p></li><li><p>å¸¸æ•°ï¼š è‹¥ c ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  E(c)=c  \]</span></p></li><li>çº¿æ€§ç»„åˆï¼š æ•°å­¦æœŸæœ›æ»¡è¶³ï¼š<ul><li>é½æ¬¡æ€§ï¼Œå¯¹äºä»»æ„å¸¸æ•°<span class="math inline">\(a\)</span>æœ‰ï¼š <span class="math display">\[  E(aX)=aE(X)  \]</span></li><li>å¯åŠ æ€§ï¼Œå¯¹äºéšæœºå˜é‡çš„å‡½æ•°<span class="math inline">\(g_1(X)ã€g_2(X)\)</span>æœ‰ï¼š <span class="math display">\[  E\left[g_1(X)+g_2(X)\right]=E\left[g_1(X)\right]+E\left[g_2(X)\right]  \]</span></li></ul></li><li><p>ä¼¯åŠªåˆ©åˆ†å¸ƒå’ŒäºŒé¡¹åˆ†å¸ƒçš„æœŸæœ›åˆ†åˆ«å¦‚ä¸‹ï¼š <span class="math display">\[\begin{array}{c|c}  &amp;\qquad ä¼¯åŠªåˆ©åˆ†å¸ƒã€qquad&amp;\qquad äºŒé¡¹åˆ†å¸ƒã€qquad\\  \hline\\  \ PMF\ &amp; p(x)=\begin{cases}p,&amp;x=1\\1-p,&amp;x=0\end{cases} &amp; p(x)={n\choose x}p^x(1-p)^{n-x}\\\\  \hline \\  \quad \mu\quad&amp; p &amp; np \\\end{array}\]</span></p></li></ul><h2 id="æ–¹å·®ä¸æ ‡å‡†å·®">æ–¹å·®ä¸æ ‡å‡†å·®</h2><h3 id="æ–¹å·®">æ–¹å·®</h3><p>ä»£æ•°å¼ï¼š <span class="math display">\[Var(X)=E\left[\Big(X-E(X)\Big)^2\right]\]</span> ç§°ä¸ºéšæœºå˜é‡ X çš„æ–¹å·®ï¼ˆVarianceï¼‰ï¼Œä¹Ÿå¯è®°ä½œ<span class="math inline">\(\sigma^2\)</span>æˆ–è€…<span class="math inline">\(\sigma_X^2\)</span>ã€‚</p><h3 id="æ–¹å·®çš„æ€§è´¨">æ–¹å·®çš„æ€§è´¨</h3><ul><li><p>åŒ–ç®€ï¼š å¯ä»¥é€šè¿‡ä¸‹å¼æ¥åŒ–ç®€è¿ç®—ï¼š <span class="math display">\[  Var(X)=E\left(X^2\right)-\mu^2  \]</span></p></li><li><p>å¸¸æ•°ï¼š è‹¥ c ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  Var(c)=0  \]</span></p></li><li><p>ç›¸åŠ ä¸æ•°ä¹˜ï¼š è‹¥ aã€b ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  Var(aX+b)=a^2Var(X)  \]</span></p></li></ul><h3 id="æ ‡å‡†å·®">æ ‡å‡†å·®</h3><p>å‡å¦‚éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ–¹å·®ä¸º<span class="math inline">\(Var(X)\)</span>ï¼Œåˆ™ç§°ï¼š</p><p><span class="math display">\[\sigma(X)=\sqrt{Var(X)}\]</span> ä¸ºæ ‡å‡†å·®ï¼Œä¹Ÿå¯ä»¥è®°ä½œ<span class="math inline">\(\sigma\)</span>æˆ–è€…<span class="math inline">\(\sigma_X\)</span>ã€‚</p><h3 id="äºŒé¡¹åˆ†å¸ƒçš„æ–¹å·®">äºŒé¡¹åˆ†å¸ƒçš„æ–¹å·®</h3><p><span class="math display">\[\begin{array}{c|c}    &amp;\qquad ä¼¯åŠªåˆ©åˆ†å¸ƒã€qquad&amp;\qquad äºŒé¡¹åˆ†å¸ƒã€qquad\\    \hline    \\    \ PMF\ &amp; p(x)=\begin{cases}p,&amp;x=1\\1-p,&amp;x=0\end{cases} &amp; p(x)={n\choose x}p^x(1-p)^{n-x}\\    \\    \hline    \\    \quad \mu\quad&amp; p &amp; np \\    \\    \hline     \\    \quad Var(X)\quad&amp; p(1-p) &amp; np(1-p) \\    \\\end{array}\]</span></p><h3 id="é©¬å°”å¯å¤«ä¸ç­‰å¼">é©¬å°”å¯å¤«ä¸ç­‰å¼</h3><p>è®¾<span class="math inline">\(X\)</span>ä¸ºå–éè´Ÿå€¼çš„éšæœºå˜é‡ï¼Œåˆ™å¯¹äºä»»ä½•<span class="math inline">\(a &gt; 0\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[P(X\ge a)\le \frac{E(X)}{a}\]</span></p><h3 id="åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼">åˆ‡æ¯”é›ªå¤«ä¸ç­‰å¼</h3><p>è®¾<span class="math inline">\(X\)</span>æ˜¯ä¸€éšæœºå˜é‡ï¼Œå‡å€¼<span class="math inline">\(\mu\)</span>å’Œæ–¹å·®<span class="math inline">\(\sigma^2\)</span>æœ‰é™ï¼Œåˆ™å¯¹ä»»ä½•<span class="math inline">\(k &gt; 0\)</span>æœ‰ï¼š <span class="math display">\[P(|X-\mu| \ge k)\le \frac{\sigma^2}{k^2}\]</span></p><h2 id="æ³Šæ¾åˆ†å¸ƒ">æ³Šæ¾åˆ†å¸ƒ</h2><p>å¯¹äºéšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¦‚ç‡è´¨é‡å‡½æ•°ï¼š <span class="math display">\[P(X=k)=\frac{\lambda^k}{k!}e^{-\lambda},\quad k=0,1,2,\cdots\]</span> ç§°ä¸ºéšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ³Šæ¾åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥è®°ä¸ºï¼š <span class="math display">\[X\sim P(\lambda)\]</span></p><p>å…¶æ•°å­¦æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š</p><p><span class="math display">\[E(X)=\lambda,\quad Var(X)=\lambda\]</span></p><p><strong>æ¡ä»¶</strong><br>æ›´ä¸€èˆ¬åœ°ï¼Œåœ¨æŸä¸€æ®µæ—¶é—´ T å†…å‘ç”Ÿç‰¹å®šäº‹ä»¶çš„æ¬¡æ•°ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹å‡è®¾ï¼Œéƒ½å¯ä»¥çœ‹ä½œæ³Šæ¾åˆ†å¸ƒï¼š</p><ul><li>å¹³ç¨³æ€§ï¼šåœ¨æ­¤æ—¶é—´æ®µ T å†…ï¼Œæ­¤äº‹ä»¶å‘ç”Ÿçš„æ¦‚ç‡ç›¸åŒï¼ˆåœ¨å®é™…åº”ç”¨ä¸­å¤§è‡´ç›¸åŒå°±å¯ä»¥äº†ï¼‰ã€‚</li><li>ç‹¬ç«‹æ€§ï¼šäº‹ä»¶çš„å‘ç”Ÿå½¼æ­¤ä¹‹é—´ç‹¬ç«‹ï¼ˆæˆ–è€…è¯´ï¼Œå…³è”æ€§å¾ˆå¼±ï¼‰ã€‚</li><li>æ™®é€šæ€§ï¼šæŠŠ T åˆ‡åˆ†æˆè¶³å¤Ÿå°çš„åŒºé—´ã€Delta Tï¼Œåœ¨ã€Delta T å†…æ°å¥½å‘ç”Ÿä¸¤ä¸ªã€æˆ–å¤šä¸ªäº‹ä»¶çš„å¯èƒ½æ€§ä¸º 0ï¼ˆæˆ–è€…è¯´ï¼Œå‡ ä¹ä¸º 0ï¼‰ã€‚</li></ul><p>æ³Šæ¾åˆ†å¸ƒæ˜¯äºŒé¡¹åˆ†å¸ƒçš„æé™ï¼š <span class="math display">\[\lim_{n\to\infty}{n\choose k}\left(\frac{\mu}{n}\right)^k\left(1-\frac{\mu}{n}\right)^{n-k}=\frac{\mu^k}{k!}e^{-\mu}\]</span></p><p>æ‰€ä»¥åœ¨æ³Šæ¾åˆ†å¸ƒçš„<span class="math inline">\(\lambda\)</span>å›ºå®šçš„æƒ…å†µï¼ŒäºŒé¡¹åˆ†å¸ƒçš„ n è¶Šå¤§ï¼ˆå¯¹åº”çš„<span class="math inline">\(p=\frac{\lambda}{n}\)</span>è¶Šå°ï¼‰ï¼Œæ­¤æ—¶ä¸¤è€…ä¼šéå¸¸æ¥è¿‘ã€‚</p><h2 id="é‡è¦çš„ç¦»æ•£åˆ†éƒ¨">é‡è¦çš„ç¦»æ•£åˆ†éƒ¨</h2><h3 id="å‡ ä½•åˆ†å¸ƒ">å‡ ä½•åˆ†å¸ƒ</h3><p>å¯¹äº n é‡ä¼¯åŠªåˆ©å®éªŒï¼Œå¦‚æœæ¯æ¬¡å¾—åˆ°â€œæ˜¯â€çš„æ¦‚ç‡ä¸º pï¼Œè®¾éšæœºå˜é‡ï¼š <span class="math display">\[X=é¦–æ¬¡å¾—åˆ°â€œæ˜¯â€æ—¶è¿›è¡Œçš„è¯•éªŒæ¬¡æ•°\]</span></p><p>åˆ™ç§°ï¼š <span class="math display">\[p(k)=P(X=k)=(1-p)^{k-1}p,\quad k=1,2,\cdots\]</span></p><p>ä¸ºéšæœºå˜é‡ X çš„å‡ ä½•åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥è®°ä½œï¼š <span class="math display">\[X\sim Ge(p)\]</span></p><p>å…¶æ•°å­¦æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š <span class="math display">\[E(X)=\frac{1}{p},\quad Var(X)=\frac{1-p}{p^2}\]</span></p><h3 id="è´ŸäºŒé¡¹åˆ†å¸ƒ">è´ŸäºŒé¡¹åˆ†å¸ƒ</h3><p>å¯¹äº n é‡ä¼¯åŠªåˆ©å®éªŒï¼Œå¦‚æœæ¯æ¬¡å¾—åˆ°â€œæ˜¯â€çš„æ¦‚ç‡ä¸º pï¼Œè®¾éšæœºå˜é‡ï¼š <span class="math display">\[X=ç¬¬ r æ¬¡â€œæ˜¯â€å‘ç”Ÿæ—¶çš„å®éªŒæ¬¡æ•°\]</span></p><p>åˆ™ç§°ï¼š <span class="math display">\[p(k)=P(X=k)={k-1\choose r-1}p^r(1-p)^{k-r},k=r,r+1,\cdots\]</span></p><p>ä¸ºéšæœºå˜é‡ X çš„è´ŸäºŒé¡¹åˆ†å¸ƒï¼Œä¹Ÿç§°ä¸ºå¸•æ–¯å¡åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥è®°ä½œï¼š <span class="math display">\[X\sim Nb(r,p)\]</span></p><p>å…¶æ•°å­¦æœŸæœ›ä¸ºï¼š <span class="math display">\[E(X)=\frac{r}{p},\quad Var(X)=\frac{r(1-p)}{p^2}\]</span></p><h3 id="è´ŸäºŒé¡¹åˆ†å¸ƒä¸å‡ ä½•åˆ†å¸ƒ">è´ŸäºŒé¡¹åˆ†å¸ƒä¸å‡ ä½•åˆ†å¸ƒ</h3><ul><li><p>å‡ ä½•æ˜¯è´ŸäºŒé¡¹çš„ç‰¹ä¾‹ ï¼š è´ŸäºŒé¡¹åˆ†å¸ƒæ˜¯è¿™æ ·çš„ï¼š <span class="math display">\[  p(k)=P(X=k)={k-1\choose r-1}p^r(1-p)^{k-r},k=r,r+1,\cdots  \]</span> r=1 çš„æ—¶å€™ï¼Œå°±å¾—åˆ°äº†å‡ ä½•åˆ†å¸ƒï¼š <span class="math display">\[  p(k)=P(X=k)=(1-p)^{k-1}p,\quad k=1,2,\cdots  \]</span></p></li><li><p>è´ŸäºŒé¡¹æ˜¯å‡ ä½•çš„å’Œï¼š å‚æ•°ä¸º rã€p çš„è´ŸäºŒé¡¹åˆ†å¸ƒå¯ä»¥è¡¨ç¤ºä¸ºå¦‚ä¸‹äº‹ä»¶åºåˆ—ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/negativeBinomial.png"> å›¾ä¸­æ‰€ç¤ºçš„æ¯ä¸€æ®µ<span class="math inline">\(X_1ã€X_2ã€\cdotsã€X_r\)</span>éƒ½æ˜¯å‡ ä½•åˆ†å¸ƒï¼Œæ‰€ä»¥æœ‰ï¼š <span class="math display">\[  X=X_1+X_2+\cdots+X_r\sim Nb(r,p)  \]</span> æ‰€ä»¥è´ŸäºŒé¡¹åˆ†å¸ƒçš„æœŸæœ›ä¸ºï¼š <span class="math display">\[  E(X)=E(X_1)+E(X_2)+\cdots+E(X_r)=\frac{r}{p}  \]</span></p></li></ul><h3 id="è¶…å‡ ä½•åˆ†å¸ƒ">è¶…å‡ ä½•åˆ†å¸ƒ</h3><p>è®¾æœ‰ N ä»¶äº§å“ï¼Œå…¶ä¸­æœ‰ M ä»¶ä¸åˆæ ¼å“ï¼ŒéšæœºæŠ½å– n ä»¶äº§å“ï¼Œåˆ™å…¶ä¸­å«æœ‰ m ä»¶ä¸åˆæ ¼äº§å“çš„æ¦‚ç‡ä¸ºå¤šå°‘ï¼Ÿ å‡è®¾éšæœºå˜é‡ï¼š <span class="math display">\[X=éšæœºæŠ½å–çš„ n ä»¶ä¸­æœ‰ m ä»¶ä¸åˆæ ¼å“\]</span> è¿™ä¸ªéšæœºå˜é‡çš„æ¦‚ç‡å¯ä»¥ç”¨å¤å…¸æ¦‚ç‡æ¥æ±‚ï¼Œé¦–å…ˆï¼Œæ ·æœ¬ç©ºé—´å°±æ˜¯ä» N ä»¶ä¸­éšä¾¿æŠ½å– n ä»¶ï¼Œæ‰€ä»¥ï¼š</p><p><span class="math display">\[|\Omega| = {N\choose n}\]</span></p><p>ç„¶åæœ‰ m ä»¶ä»ä¸åˆæ ¼å“ä¸­æŠ½å–ï¼Œå‰©ä¸‹çš„åœ¨åˆæ ¼å“ä¸­æŠ½å–ï¼Œåˆ™æœ‰ï¼š</p><p><span class="math display">\[|X| = {M\choose m}{N-M\choose n-m}\]</span></p><p>æ‰€æ±‚æ¦‚ç‡å³ä¸ºï¼š</p><p><span class="math display">\[P(X=m)=\frac{\left(\begin{array}{c}M \\m\end{array}\right)\left(\begin{array}{c}N-M \\n-m\end{array}\right)}{\left(\begin{array}{c}N \\n\end{array}\right)}, m=0,1, \cdots, r\]</span></p><p>å…¶ä¸­<span class="math inline">\(r=min(M,n)\)</span>ã€‚æ­¤æ—¶ç§° X æœä»è¶…å‡ ä½•åˆ†å¸ƒï¼Œå¯ä»¥è®°ä½œï¼š</p><p><span class="math display">\[X\sim h(n,N,M)\]</span></p><p>å…¶æ•°å­¦æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š <span class="math display">\[E(X)=n\frac{M}{N},\quad Var(X)=n\frac{M}{N}\left(1-\frac{M}{N}\right)\left(1-\frac{n-1}{N-1}\right)\]</span></p><h3 id="è¶…å‡ ä½•åˆ†å¸ƒä¸äºŒé¡¹åˆ†å¸ƒ">è¶…å‡ ä½•åˆ†å¸ƒä¸äºŒé¡¹åˆ†å¸ƒ</h3><p>è¶…å‡ ä½•åˆ†å¸ƒä¸äºŒé¡¹åˆ†å¸ƒç±»ä¼¼ï¼Œéƒ½æ˜¯æ±‚æŠ½å– n æ¬¡å…¶ä¸­æœ‰ m æ¬¡â€œæ˜¯â€çš„æ¦‚ç‡ï¼Œåªæ˜¯ï¼š</p><ul><li>äºŒé¡¹åˆ†å¸ƒï¼šç›¸å½“äºæŠ½å–ä¹‹åæ”¾å›ã€‚</li><li>è¶…å‡ ä½•åˆ†å¸ƒï¼šæŠ½å–ä¹‹åä¸æ”¾å›ã€‚</li></ul><p>æ‰€ä»¥åœ¨è¶…å‡ ä½•åˆ†å¸ƒä¸­ï¼Œå¦‚æœè¢«æŠ½å–çš„æ€»æ•° N ç‰¹åˆ«å¤§ï¼Œé‚£ä¹ˆæ”¾å›ä¸æ”¾å›åŒºåˆ«ä¹Ÿå°±ä¸å¤§äº†ï¼Œæ­¤æ—¶ï¼Œé‚£ä¹ˆè¶…å‡ ä½•åˆ†å¸ƒå¯ä»¥è¿‘ä¼¼çœ‹ä½œäºŒé¡¹åˆ†å¸ƒã€‚ è¿™ç‚¹ä»ä¸¤è€…çš„æœŸæœ›ã€æ–¹å·®ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼š <span class="math display">\[\begin{array}{c|c}    &amp;\qquad äºŒé¡¹åˆ†å¸ƒã€qquad&amp;\qquad è¶…å‡ ä½•åˆ†å¸ƒã€qquad\\    \hline    \\    \quad \mu\quad&amp; np &amp; n\frac{M}{N} \\    \\    \hline     \\    \quad \sigma^2\quad&amp; np(1-p) &amp; n\frac{M}{N}\left(1-\frac{M}{N}\right)\left(1-\frac{n-1}{N-1}\right)\\    \\\end{array}\]</span> ä»¤<span class="math inline">\(p=\frac{M}{N}\)</span>ï¼Œè¶…å‡ ä½•åˆ†å¸ƒçš„æœŸæœ›å’Œæ–¹å·®å¯ä»¥å†™ä½œï¼š <span class="math display">\[\mu=n\frac{M}{N}=np\]</span> ^2=n(1-)(1-)=np(1-p)(1-) $$</p><p>å¯¹è¶…å‡ ä½•åˆ†å¸ƒè€Œè¨€ï¼Œå½“ N è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œ<span class="math inline">\(\frac{M}{N}\)</span>å¯çœ‹ä½œå–å‡ºä¸åˆæ ¼äº§å“çš„æ¦‚ç‡ï¼Œé‚£æ­¤æ—¶è¶…å‡ ä½•åˆ†å¸ƒå¯çœ‹ä½œäºŒé¡¹åˆ†å¸ƒã€‚</p><h3 id="æ€»ç»“">æ€»ç»“</h3><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad ä¼¯åŠªåˆ©åˆ†å¸ƒã€quad&amp;\quad æŠ›ç¡¬å¸ï¼ŒäºŒé€‰ä¸€ \quad\\     \quad äºŒé¡¹åˆ†å¸ƒã€quad&amp;\quad n é‡ä¼¯åŠªåˆ©ï¼Œå‡ºç° k æ¬¡â€œæ˜¯â€ \quad\\     \quad æ³Šæ¾åˆ†å¸ƒã€quad&amp;\quad äºŒé¡¹åˆ†å¸ƒçš„æé™ \quad\\     \quad å‡ ä½•åˆ†å¸ƒã€quad&amp;\quad n é‡ä¼¯åŠªåˆ©ï¼Œç¬¬ k æ¬¡é¦–æ¬¡å‡ºç°â€œæ˜¯â€ \quad\\     \quad è´ŸäºŒé¡¹åˆ†å¸ƒã€quad&amp;\quad å‡ ä½•åˆ†å¸ƒçš„å’Œ \quad\\     \quad è¶…å‡ ä½•åˆ†å¸ƒã€quad&amp;\quad ä¸æ”¾å›æŠ½æ ·çš„äºŒé¡¹åˆ†å¸ƒ \quad\\     \\    \hline\end{array}\]</span></p><h2 id="æ¦‚ç‡å¯†åº¦å‡½æ•°">æ¦‚ç‡å¯†åº¦å‡½æ•°</h2><h3 id="æ¦‚ç‡å¯†åº¦å‡½æ•°-1">æ¦‚ç‡å¯†åº¦å‡½æ•°</h3><p>å¦‚æœå‡½æ•°<span class="math inline">\(p(x)\)</span>æ»¡è¶³ä¸‹åˆ—ä¸¤ä¸ªæ¡ä»¶ï¼ˆå¯¹åº”äº†æ¦‚ç‡çš„ä¸‰å¤§å…¬ç†ï¼‰ï¼š</p><ul><li><p>éè´Ÿæ€§ï¼š <span class="math display">\[  p(x) \ge 0  \]</span></p></li><li><p>è§„èŒƒæ€§ï¼ˆæš—å«äº†å¯åŠ æ€§ï¼‰ï¼Œå› ä¸ºæ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥é€šè¿‡ç§¯åˆ†ç›¸åŠ ï¼š <span class="math display">\[  \int_{-\infty}^{+\infty}p(x)\mathrm{d}x=1  \]</span></p></li></ul><p>åˆ™ç§°å…¶ä¸ºæ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆProbability Density Functionï¼Œç®€å†™ä¸º PDFï¼‰ã€‚</p><h3 id="æœŸæœ›">æœŸæœ›</h3><p>ç¦»æ•£éšæœºå˜é‡çš„æœŸæœ›å®šä¹‰ä¸ºï¼š <span class="math display">\[E(X)=\sum_{i=1}^{\infty}x_ip(x_i)\]</span></p><p>å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•å®šä¹‰è¿ç»­éšæœºå˜é‡çš„æœŸæœ›ï¼Œå½“ç„¶æœŸæœ›çš„æ„ä¹‰æ˜¯æ²¡æœ‰æ”¹å˜çš„ï¼š <span class="math display">\[E(X)=\int_{-\infty}^{+\infty}xp(x)\mathrm{d}x\]</span> å…³äºæœŸæœ›çš„å‡ ä¸ªæ€§è´¨ä¹Ÿæ˜¯æˆç«‹çš„ï¼š</p><ul><li><p>å¤åˆï¼š å‡è®¾<span class="math inline">\(g(X)\)</span>ä¸ºè¿ç»­éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æŸä¸€å‡½æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  E\left[g(X)\right]=\int_{-\infty}^{+\infty}g(x)p(x)\mathrm{d}x  \]</span></p></li><li><p>å¸¸æ•°ï¼š è‹¥ c ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  E(c)=c  \]</span></p></li><li>çº¿æ€§ï¼š æ•°å­¦æœŸæœ›æ»¡è¶³ï¼š<ul><li>é½æ¬¡æ€§ï¼Œå¯¹äºä»»æ„å¸¸æ•° a æœ‰ï¼š <span class="math display">\[  E(aX)=aE(X)  \]</span></li><li>å¯åŠ æ€§ï¼Œå¯¹äºä»»æ„ä¸¤ä¸ªå‡½æ•°<span class="math inline">\(g_1(X)ã€g_2(X)\)</span>æœ‰ï¼š <span class="math display">\[  E\left[g_1(X)+g_2(X)\right]=E\left[g_1(X)\right]+E\left[g_2(X)\right]  \]</span></li></ul></li></ul><h3 id="æ–¹å·®-1">æ–¹å·®</h3><p>æ–¹å·®çš„å®šä¹‰ä¾ç„¶æ˜¯ï¼š <span class="math display">\[Var(X)=E\left[\Big(X-E(X)\Big)^2\right]\]</span></p><p>ç›¸å…³çš„æ€§è´¨ä¹Ÿæ˜¯æˆç«‹çš„ï¼š</p><ul><li><p>åŒ–ç®€ï¼š å¯ä»¥é€šè¿‡ä¸‹å¼æ¥åŒ–ç®€è¿ç®—ï¼š <span class="math display">\[  Var(X)=E\left(X^2\right)-\mu^2  \]</span></p></li><li><p>å¸¸æ•°ï¼š è‹¥ c ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  Var(c)=0  \]</span></p></li><li><p>ç›¸åŠ ä¸æ•°ä¹˜ï¼š è‹¥ aã€b ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  Var(aX+b)=a^2Var(X)  \]</span></p></li></ul><h3 id="ç´¯ç§¯åˆ†å¸ƒå‡½æ•°">ç´¯ç§¯åˆ†å¸ƒå‡½æ•°</h3><p>è¿ç»­éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<span class="math inline">\(p(x)\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[F(x)=P(X \le x)=\int_{-\infty}^{x}p(t)\mathrm{d}t\]</span> ç§°ä¸º<span class="math inline">\(X\)</span>çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ã€‚</p><h2 id="æ­£æ€åˆ†å¸ƒ">æ­£æ€åˆ†å¸ƒ</h2><h3 id="æ­£æ€åˆ†å¸ƒ-1">æ­£æ€åˆ†å¸ƒ</h3><p>å¦‚æœè¿ç»­éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š <span class="math display">\[p(x)=\frac{1}{\sigma\sqrt{2\pi}}e^{-\frac{(x-\mu)^2}{2\sigma^2}},\quad -\infty &lt; x &lt; +\infty\]</span></p><p>åˆ™ç§°<span class="math inline">\(X\)</span>æœä»æ­£æ€åˆ†å¸ƒï¼ˆnormal distributionï¼‰ï¼Œä¹Ÿç§°ä½œé«˜æ–¯åˆ†å¸ƒï¼ˆGaussian distributionï¼‰ï¼Œè®°ä½œ<span class="math inline">\(X\sim N(\mu,\sigma^2)\)</span>ï¼Œå…¶ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ä¸ºï¼š <span class="math display">\[F(x)=\frac{1}{\sigma\sqrt{2\pi}}\int_{-\infty}^{x}e^{-\frac{(t-\mu)^2}{2\sigma^2}}\mathrm{d}t\]</span></p><p>æˆ‘ä»¬ç§°<span class="math inline">\(\mu=0ã€\sigma=1\)</span>æ—¶çš„æ­£æ€åˆ†å¸ƒ<span class="math inline">\(N(0,1)\)</span>ä¸ºæ ‡å‡†æ­£æ€åˆ†å¸ƒã€‚</p><h3 id="æœŸæœ›ä¸æ–¹å·®">æœŸæœ›ä¸æ–¹å·®</h3><p>æ­£æ€åˆ†å¸ƒ<span class="math inline">\(X\sim N(\mu,\sigma^2)\)</span>çš„æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š <span class="math display">\[E(X)=\mu,\quad Var(X)=\sigma^2\]</span></p><h2 id="æŒ‡æ•°åˆ†å¸ƒ">æŒ‡æ•°åˆ†å¸ƒ</h2><p>è‹¥éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š <span class="math display">\[p(x)=\begin{cases}\lambda e^{-\lambda x}, &amp; x \ge 0\\0,&amp; x &lt; 0\end{cases}\]</span></p><p>å…¶ä¸­<span class="math inline">\(\lambda &gt; 0\)</span>ï¼Œç§°<span class="math inline">\(X\)</span>æœä»æŒ‡æ•°åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥è®°ä¸ºï¼š <span class="math display">\[X\sim Exp(\lambda)\]</span></p><p>ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ä¸ºï¼š <span class="math display">\[F(x)=\begin{cases}1-e^{-\lambda x}, &amp; x \ge 0\\0,&amp; x &lt; 0\end{cases}\]</span></p><p>æŒ‡æ•°åˆ†å¸ƒ<span class="math inline">\(X\sim Exp(\lambda)\)</span>çš„æœŸæœ›å’Œæ–¹å·®ä¸ºï¼š <span class="math display">\[E(X)=\frac{1}{\lambda},\quad Var(X)=\frac{1}{\lambda^2}\]</span></p><h4 id="æ€»ç»“-1">æ€»ç»“</h4><p>é¦–å…ˆæ˜¯ä¸€ç»´ç¦»æ•£éšæœºå˜é‡çš„æ¦‚ç‡åˆ†å¸ƒï¼š</p><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad ä¼¯åŠªåˆ©åˆ†å¸ƒã€quad&amp;\quad æŠ›ç¡¬å¸ï¼ŒäºŒé€‰ä¸€ \quad\\     \quad äºŒé¡¹åˆ†å¸ƒã€quad&amp;\quad n é‡ä¼¯åŠªåˆ©ï¼Œå‡ºç° k æ¬¡â€œæ˜¯â€ \quad\\     \quad æ³Šæ¾åˆ†å¸ƒã€quad&amp;\quad äºŒé¡¹åˆ†å¸ƒçš„æé™ \quad\\     \quad å‡ ä½•åˆ†å¸ƒã€quad&amp;\quad n é‡ä¼¯åŠªåˆ©ï¼Œç¬¬ k æ¬¡é¦–æ¬¡å‡ºç°â€œæ˜¯â€ \quad\\     \quad è´ŸäºŒé¡¹åˆ†å¸ƒã€quad&amp;\quad å‡ ä½•åˆ†å¸ƒçš„å’Œ \quad\\     \quad è¶…å‡ ä½•åˆ†å¸ƒã€quad&amp;\quad ä¸æ”¾å›æŠ½æ ·çš„äºŒé¡¹åˆ†å¸ƒ \quad\\     \\    \hline\end{array}\]</span></p><p>ç„¶åæ˜¯ä¸€ç»´è¿ç»­éšæœºå˜é‡çš„æ¦‚ç‡åˆ†å¸ƒï¼š</p><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad å‡åŒ€åˆ†å¸ƒã€quad&amp;\quad å¤å…¸æ´¾ä¸­çš„å‡ ä½•æ¦‚å‹ \quad\\     \quad æ­£æ€åˆ†å¸ƒã€quad&amp;\quad äºŒé¡¹åˆ†å¸ƒçš„å¦å¤–ä¸€ç§æé™ \quad\\     \quad æŒ‡æ•°åˆ†å¸ƒã€quad&amp;\quad æ³Šæ¾åˆ†å¸ƒçš„é—´éš”ï¼Œè¿ç»­çš„å‡ ä½•åˆ†å¸ƒ \quad\\     \\    \hline\end{array}\]</span></p><h1 id="å¤šç»´éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ">å¤šç»´éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ</h1><h2 id="å¤šç»´éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ-1">å¤šç»´éšæœºå˜é‡åŠå…¶åˆ†å¸ƒ</h2><h3 id="è”åˆæ¦‚ç‡è´¨é‡å‡½æ•°">è”åˆæ¦‚ç‡è´¨é‡å‡½æ•°</h3><p>å¦‚æœäºŒç»´éšæœºå‘é‡<span class="math inline">\((X,Y)\)</span>æ‰€æœ‰å¯èƒ½çš„å–å€¼ä¸º<span class="math inline">\((x_i,y_j),i,j=1,2,\cdots\)</span>ï¼Œè¿™ä¸¤ä¸ªéšæœºå˜é‡åŒæ—¶å‘ç”Ÿçš„æ¦‚ç‡å¯ä»¥ç”¨å‡½æ•°è¡¨ç¤ºå¦‚ä¸‹ï¼š <span class="math display">\[p_{ij}=P(X=x_i,Y=y_j)=P(X=x_i\ \color{red}{ä¸”}\ Y=y_j),\quad i,j=1,2,\cdots\]</span></p><p>ä¸”æ­¤å‡½æ•°æ»¡è¶³å¦‚ä¸‹æ€§è´¨ï¼ˆå³æ¦‚ç‡çš„ä¸‰å¤§å…¬ç†ï¼‰ï¼š</p><ul><li><p>éè´Ÿæ€§ï¼š <span class="math display">\[  p_{ij}\ge 0  \]</span></p></li><li><p>è§„èŒƒæ€§å’Œå¯åŠ æ€§ï¼š <span class="math display">\[  \sum_{i=1}^{\infty}\sum_{j=1}^{\infty}p_{ij}=1  \]</span></p></li></ul><p>åˆ™ç§°æ­¤å‡½æ•°ä¸º<span class="math inline">\((X,Y)\)</span>çš„è”åˆæ¦‚ç‡è´¨é‡å‡½æ•°ï¼ˆJoint Probability Mass Functionï¼‰ï¼Œæˆ–è€…ç§°ä¸ºè”åˆåˆ†å¸ƒåˆ—ï¼Œæ­¤å®šä¹‰å¯ä»¥æ¨å¹¿åˆ°å¤šç»´ç¦»æ•£éšæœºå˜é‡ä¸Šå»ã€‚</p><h3 id="è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°">è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°</h3><p>å¯¹äºæŸäºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>å­˜åœ¨äºŒå…ƒå‡½æ•°<span class="math inline">\(p(x,y)\)</span>æ»¡è¶³ï¼š</p><ul><li><p>éè´Ÿæ€§ï¼š <span class="math display">\[  p(x,y)\ge 0  \]</span></p></li><li><p>è§„èŒƒæ€§å’Œå¯åŠ æ€§ï¼ˆè¿ç»­çš„éƒ½é€šè¿‡ç§¯åˆ†æ¥ç›¸åŠ ï¼‰ï¼š <span class="math display">\[  \int_{-\infty}^{+\infty}\int_{-\infty}^{+\infty}p(x,y)\mathrm{d}x\mathrm{d}y=1  \]</span></p></li></ul><p>åˆ™ç§°æ­¤å‡½æ•°ä¸º<span class="math inline">\((X,Y)\)</span>çš„è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆJoint Probability Density Functionï¼‰ï¼Œæ­¤å®šä¹‰å¯ä»¥æ¨å¹¿åˆ°å¤šç»´è¿ç»­éšæœºå˜é‡ä¸Šå»ã€‚</p><h3 id="è”åˆç´¯ç§¯åˆ†å¸ƒå‡½æ•°">è”åˆç´¯ç§¯åˆ†å¸ƒå‡½æ•°</h3><p>è®¾<span class="math inline">\((X,Y)\)</span>æ˜¯äºŒç»´éšæœºå˜é‡ï¼Œå¯¹äºä»»æ„å®æ•°<span class="math inline">\(xã€y\)</span>ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªäºŒå…ƒå‡½æ•°æ¥è¡¨ç¤ºä¸¤ä¸ªäº‹ä»¶åŒæ—¶å‘ç”Ÿçš„æ¦‚ç‡ï¼š <span class="math display">\[F(x,y)=P\Big(\{X\le x\}\ \color{red}{ä¸”}\ \{Y\le y\}\Big)=P(X\le x, Y\le y)\]</span></p><p>ç§°ä¸ºäºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„è”åˆç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆJoint Cumulative Distribution Functionï¼‰ï¼Œå¦‚æœæ··åˆåå¯¼å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[\frac{\partial F(x,y)}{\partial x \partial y}=p(x,y)\]</span></p><p>å¾—åˆ°<span class="math inline">\(p(x,y)\)</span>å°±æ˜¯æ­¤åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°ã€‚æ­¤å®šä¹‰å’Œæ€§è´¨å¯ä»¥æ¨å¹¿åˆ°å¤šç»´éšæœºå˜é‡ã€‚</p><h3 id="å¤šç»´å‡åŒ€åˆ†å¸ƒ">å¤šç»´å‡åŒ€åˆ†å¸ƒ</h3><p>è®¾<span class="math inline">\(D\)</span>ä¸º<span class="math inline">\(R^n\)</span>ä¸­çš„ä¸€ä¸ªæœ‰ç•ŒåŒºåŸŸï¼Œå…¶åº¦é‡ï¼ˆç›´çº¿ä¸ºé•¿åº¦ï¼Œå¹³é¢ä¸ºé¢ç§¯ï¼Œç©ºé—´ä¸ºä½“ç§¯ç­‰ï¼‰ä¸º<span class="math inline">\(S_D\)</span>ï¼Œå¦‚æœå¤šç»´éšæœºå˜é‡<span class="math inline">\((X_1,X_2,\cdots,X_n)\)</span>çš„è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š <span class="math display">\[p(x_1,x_2,\cdots,x_n)=\begin{cases}    \frac{1}{S_D},&amp;(x_1,x_2,\cdots,x_n)\in D\\    0,&amp;å…¶å®ƒ\end{cases}\]</span> åˆ™ç§°<span class="math inline">\((X_1,X_2,\cdots,X_n)\)</span>æœä»<span class="math inline">\(D\)</span>ä¸Šçš„å¤šç»´å‡åŒ€åˆ†å¸ƒï¼Œè®°ä½œï¼š</p><p><span class="math display">\[(X_1,X_2,\cdots,X_n)\sim U(D)\]</span></p><h2 id="è¾¹ç¼˜åˆ†å¸ƒä¸éšæœºå˜é‡çš„ç‹¬ç«‹æ€§">è¾¹ç¼˜åˆ†å¸ƒä¸éšæœºå˜é‡çš„ç‹¬ç«‹æ€§</h2><h3 id="è¾¹ç¼˜æ¦‚ç‡è´¨é‡å‡½æ•°">è¾¹ç¼˜æ¦‚ç‡è´¨é‡å‡½æ•°</h3><p>å¦‚æœäºŒç»´ç¦»æ•£éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„è”åˆæ¦‚ç‡è´¨é‡å‡½æ•°ä¸ºï¼š <span class="math display">\[P(X=x_i,Y=y_j),i,j=1,2,\cdots\]</span></p><p>å¯¹<span class="math inline">\(j\)</span>æ±‚å’Œæ‰€å¾—çš„å‡½æ•°ï¼š</p><p><span class="math display">\[\sum_{j=1}^{\infty}P(X=x_i,Y=y_j)=P(X=x_i)\]</span></p><p>ç§°ä¸º<span class="math inline">\(X\)</span>çš„è¾¹ç¼˜æ¦‚ç‡è´¨é‡å‡½æ•°ï¼ˆMarginal Probability Mass Functionï¼‰ï¼Œæˆ–è€…ç§°ä¸ºè¾¹ç¼˜åˆ†å¸ƒåˆ—ã€‚ç±»ä¼¼çš„å¯¹ i æ±‚å’Œæ‰€å¾—çš„å‡½æ•°ï¼š <span class="math display">\[\sum_{i=1}^{\infty}P(X=x_i,Y=y_j)=P(Y=y_j)\]</span></p><p>ç§°ä¸º<span class="math inline">\(Y\)</span>çš„è¾¹ç¼˜æ¦‚ç‡è´¨é‡å‡½æ•°ã€‚</p><h3 id="è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°">è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°</h3><p>å¦‚æœäºŒç»´è¿ç»­éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<span class="math inline">\(p(x,y)\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[p_X(x)=\int_{-\infty}^{+\infty}p(x,y)\mathrm{d}y\]</span></p><p>ç§°ä¸º<span class="math inline">\(X\)</span>çš„è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆMarginal Probability Density Functionï¼‰ã€‚ç±»ä¼¼çš„ï¼š <span class="math display">\[p_Y(y)=\int_{-\infty}^{+\infty}p(x,y)\mathrm{d}x\]</span></p><p>ç§°ä¸º Y çš„è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°ã€‚</p><h3 id="è¾¹ç¼˜ç´¯ç§¯åˆ†å¸ƒå‡½æ•°">è¾¹ç¼˜ç´¯ç§¯åˆ†å¸ƒå‡½æ•°</h3><p>å¦‚æœäºŒç»´è¿ç»­éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„è”åˆç´¯ç§¯åˆ†å¸ƒå‡½æ•°ä¸º<span class="math inline">\(F(x,y)\)</span>ï¼Œå¦‚ä¸‹å¯ä»¥å¾—åˆ°<span class="math inline">\(X\)</span>çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼š <span class="math display">\[F_X(x)=\lim_{y\to+\infty}F(x,y)=P(X\le x,Y &lt; +\infty)=P(X\le x)\]</span></p><p>ç§°ä¸º<span class="math inline">\(X\)</span>çš„è¾¹ç¼˜ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆMarginal Cumulative Distribution Functionï¼‰ã€‚å¯è®°ä½œï¼š <span class="math display">\[F_X(x)=F(x,+\infty)\]</span></p><p>åŒç†å¯ä»¥å¾—åˆ° Y çš„è¾¹ç¼˜ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼š <span class="math display">\[F_Y(y)=F(+\infty, y)\]</span></p><h2 id="æ¡ä»¶åˆ†å¸ƒ">æ¡ä»¶åˆ†å¸ƒ</h2><h3 id="ç¦»æ•£çš„æ¡ä»¶åˆ†å¸ƒ">ç¦»æ•£çš„æ¡ä»¶åˆ†å¸ƒ</h3><p>è®¾<span class="math inline">\((X,Y)\)</span>æ˜¯äºŒç»´ç¦»æ•£å‹éšæœºå˜é‡ï¼Œå¯¹äºå›ºå®šçš„<span class="math inline">\(j\)</span>ï¼Œè‹¥<span class="math inline">\(P(Y=y_j)\ge 0\)</span>ï¼Œåˆ™ç§°ï¼š <span class="math display">\[P\left(X=x_{i} | Y=y_{j}\right)=\frac{P\left(X=x_{i}, Y=y_{j}\right)}{P\left(Y=y_{j}\right)}, i=1,2, \cdots\]</span></p><p>ä¸º<span class="math inline">\(Y=y_j\)</span>æ¡ä»¶ä¸‹çš„éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¡ä»¶æ¦‚ç‡è´¨é‡å‡½æ•°ã€‚åŒæ ·çš„å¯¹äºå›ºå®šçš„<span class="math inline">\(i\)</span>ï¼Œè‹¥<span class="math inline">\(P(X=x_i)\ge 0\)</span>ï¼Œåˆ™ç§°ï¼š <span class="math display">\[P\left(Y=y_{j} | X=x_{i}\right)=\frac{P\left(X=x_{i}, Y=y_{j}\right)}{P\left(X=x_{i}\right)}, j=1,2, \cdots\]</span></p><p>ä¸º<span class="math inline">\(X=x_i\)</span>æ¡ä»¶ä¸‹çš„éšæœºå˜é‡<span class="math inline">\(Y\)</span>çš„æ¡ä»¶æ¦‚ç‡è´¨é‡å‡½æ•°ã€‚</p><p>æ¡ä»¶åˆ†å¸ƒå’Œæ¡ä»¶æ¦‚ç‡æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸€æ ·å¯ä»¥ç”¨äºå…¨æ¦‚ç‡å…¬å¼ã€è´å¶æ–¯å…¬å¼ã€‚</p><h3 id="è¿ç»­çš„æ¡ä»¶åˆ†å¸ƒ">è¿ç»­çš„æ¡ä»¶åˆ†å¸ƒ</h3><p>è®¾äºŒç»´è¿ç»­å‹éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<span class="math inline">\(p(x,y)\)</span>ï¼Œè‹¥å¯¹äºå›ºå®šçš„<span class="math inline">\(y\)</span>æœ‰è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°<span class="math inline">\(p_Y(y) &gt; 0\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[p_{X|Y}(x\ |\ y)=\frac{p(x,y)}{p_Y(y)}\]</span> ä¸º<span class="math inline">\(Y=y\)</span>æ¡ä»¶ä¸‹çš„éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„æ¡ä»¶æ¦‚ç‡å¯†åº¦å‡½æ•°ã€‚å¯¹åº”çš„æ¡ä»¶ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ä¸ºï¼š <span class="math display">\[F_{X|Y}(x\ |\ y)=\int_{-\infty}^{x}\frac{p(u,y)}{p_Y(y)}\mathrm{d}u\]</span></p><p>åŒæ ·çš„é“ç†ï¼Œä»¥<span class="math inline">\(X=x\)</span>ä¸ºæ¡ä»¶æœ‰ï¼š <span class="math display">\[p_{Y|X}(y\ |\ x)=\frac{p(x,y)}{p_X(x)}\]</span> F_{Y|X}(y&nbsp;|&nbsp;x)=_{-}^{y}u $$</p><h3 id="è¿ç»­çš„å…¨æ¦‚ç‡å’Œè´å¶æ–¯">è¿ç»­çš„å…¨æ¦‚ç‡å’Œè´å¶æ–¯</h3><ul><li><p>å…¨æ¦‚ç‡ï¼š <span class="math display">\[  p_{Y}(y)=\int_{-\infty}^{+\infty} p(y | x) p_{X}(x) \mathrm{d} x  \]</span> p_{X}(x)=<em>{-}^{+} p(x | y) p</em>{Y}(y)  y $$</p></li><li><p>è´å¶æ–¯ï¼š <span class="math display">\[\begin{aligned}   p(x | y)       &amp;=\frac{p(y | x) p_{X}(x)}{p_{Y}(y)} \\      &amp;=\frac{p(y | x) p_{X}(x)}{\int_{-\infty}^{+\infty} p(y | x) p_{X}(x) \mathrm{d} x} \end{aligned}\]</span></p></li></ul><h2 id="å¤šç»´éšæœºå˜é‡å‡½æ•°çš„åˆ†å¸ƒ">å¤šç»´éšæœºå˜é‡å‡½æ•°çš„åˆ†å¸ƒ</h2><h3 id="éšæœºå˜é‡çš„å’Œ">éšæœºå˜é‡çš„å’Œ</h3><ul><li><p>ç¦»æ•£ï¼š è®¾ Xã€Y ä¸ºä¸¤ä¸ªç›¸äº’ç‹¬ç«‹çš„ç¦»æ•£éšæœºå˜é‡ï¼Œå–å€¼èŒƒå›´ä¸º<span class="math inline">\(0ï¼Œ1ï¼Œ2ï¼Œ\cdots\)</span>ï¼Œåˆ™å…¶å’Œçš„æ¦‚ç‡è´¨é‡å‡½æ•°ä¸ºï¼š <span class="math display">\[  P(X+Y=k)=\sum_{i=0}^{k}P(X=i)P(Y=k-i)  \]</span> è¿™ä¸ªæ¦‚ç‡ç­‰å¼ç§°ä¸ºç¦»æ•£åœºåˆä¸‹çš„å·ç§¯å…¬å¼ã€‚</p></li><li><p>è¿ç»­ï¼š è®¾<span class="math inline">\((X,Y)\)</span>ä¸ºäºŒç»´è¿ç»­å‹éšæœºå˜é‡ï¼Œæ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<span class="math inline">\(p(x,y)\)</span>ï¼Œåˆ™<span class="math inline">\(Z=X+Y\)</span>ä»ä¸ºè¿ç»­å‹éšæœºå˜é‡ï¼Œå…¶æ¦‚ç‡å¯†åº¦ä¸ºï¼š <span class="math display">\[  p_{X+Y}(z)=\int_{-\infty}^{+\infty}p(z-y,y)\mathrm{d}y=\int_{-\infty}^{+\infty}p(x,z-x)\mathrm{d}x  \]</span> è‹¥<span class="math inline">\(Xã€Y\)</span>ä¸ºç›¸äº’ç‹¬ç«‹ï¼Œå…¶è¾¹ç¼˜å¯†åº¦å‡½æ•°åˆ†åˆ«ä¸º<span class="math inline">\(p_X(x)\)</span>å’Œ<span class="math inline">\(p_Y(y)\)</span>ï¼Œåˆ™å…¶å’Œ<span class="math inline">\(Z=X+Y\)</span>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š <span class="math display">\[  p_Z(z)=\int_{-\infty}^{+\infty}p_X(z-y)p_Y(y)\mathrm{d}y=\int_{-\infty}^{+\infty}p_X(x)p_Y(z-x)\mathrm{d}x  \]</span> ä¸Šé¢ä¸¤ä¸ªæ¦‚ç‡ç­‰å¼ç§°ä¸ºè¿ç»­åœºåˆä¸‹çš„å·ç§¯å…¬å¼ã€‚</p></li></ul><h1 id="éšæœºå˜é‡çš„æ•°å­—ç‰¹å¾">éšæœºå˜é‡çš„æ•°å­—ç‰¹å¾</h1><h2 id="æ•°å­¦æœŸæœ›">æ•°å­¦æœŸæœ›</h2><h3 id="æ•°å­¦æœŸæœ›çš„å®šä¹‰">æ•°å­¦æœŸæœ›çš„å®šä¹‰</h3><p>ç¦»æ•£éšæœºå˜é‡çš„æ•°å­¦æœŸæœ›å®šä¹‰ä¸ºï¼š <span class="math display">\[E(X)=\sum_{i=1}^{\infty}x_ip(x_i)\]</span></p><p>è¿ç»­éšæœºå˜é‡çš„æ•°å­¦æœŸæœ›å®šä¹‰ä¸ºï¼š <span class="math display">\[E(X)=\int_{-\infty}^{+\infty}xp(x)\mathrm{d}x\]</span></p><h3 id="å‡½æ•°çš„æ•°å­¦æœŸæœ›">å‡½æ•°çš„æ•°å­¦æœŸæœ›</h3><ul><li><p>ä¸€ç»´éšæœºå˜é‡ï¼š è®¾<span class="math inline">\(Y\)</span>æ˜¯éšæœºå˜é‡<span class="math inline">\(X\)</span>çš„å‡½æ•°<span class="math inline">\(Y=g(X)\)</span>(g æ˜¯è¿ç»­å‡½æ•°ï¼‰ã€‚</p><ul><li>è‹¥<span class="math inline">\(X\)</span>ä¸ºç¦»æ•£éšæœºå˜é‡ï¼Œåˆ™ï¼ˆè®¾ä¸‹å¼ä¸­çš„çº§æ•°ç»å¯¹æ”¶æ•›ï¼‰ï¼š <span class="math display">\[  E(Y)=E\left[g(X)\right]=\sum_i g(x_i)p(x_i)  \]</span></li><li>è‹¥<span class="math inline">\(X\)</span>ä¸ºè¿ç»­éšæœºå˜é‡ï¼Œåˆ™ï¼ˆè®¾ä¸‹å¼ä¸­çš„ç§¯åˆ†ç»å¯¹æ”¶æ•›ï¼‰ï¼š <span class="math display">\[  E(Y)=E\left[g(X)\right]=\int_{-\infty}^{+\infty}g(x)p(x)\mathrm{d}x  \]</span></li></ul></li><li><p>å¤šç»´éšæœºå˜é‡ï¼š è®¾<span class="math inline">\(Z\)</span>æ˜¯éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„å‡½æ•°<span class="math inline">\(Z=g(X,Y)\)</span>(g æ˜¯è¿ç»­å‡½æ•°ï¼‰ã€‚</p><ul><li>è‹¥<span class="math inline">\((X,Y)\)</span>ä¸ºç¦»æ•£éšæœºå˜é‡ï¼Œåˆ™ï¼ˆè®¾ä¸‹å¼ä¸­çš„çº§æ•°ç»å¯¹æ”¶æ•›ï¼‰ï¼š <span class="math display">\[  E(Z)=E\left[g(X,Y)\right]=\sum_j\sum_i g(x_i,y_j)p(x_i,y_j)  \]</span></li><li>è‹¥<span class="math inline">\((X,Y)\)</span>ä¸ºè¿ç»­éšæœºå˜é‡ï¼Œåˆ™ï¼ˆè®¾ä¸‹å¼ä¸­çš„ç§¯åˆ†ç»å¯¹æ”¶æ•›ï¼‰ï¼š <span class="math display">\[  E(Z)=E\left[g(X,Y)\right]=\int_{-\infty}^{+\infty}\int_{-\infty}^{+\infty}g(x,y)p(x,y)\mathrm{d}x\mathrm{d}y  \]</span></li></ul></li></ul><h3 id="çº¿æ€§çš„æ•°å­¦æœŸæœ›">çº¿æ€§çš„æ•°å­¦æœŸæœ›</h3><p>æ•°å­¦æœŸæœ›æ»¡è¶³ï¼š</p><ul><li><p>é½æ¬¡æ€§ï¼Œå¯¹äºä»»æ„å¸¸æ•° a æœ‰ï¼š <span class="math display">\[  E(aX)=aE(X)  \]</span></p></li><li><p>å¯åŠ æ€§ï¼Œå¯¹äºä»»æ„ä¸¤ä¸ªå‡½æ•°<span class="math inline">\(g_1(X)ã€g_2(X)\)</span>æœ‰ï¼š <span class="math display">\[  E\left[g_1(X)+g_2(X)\right]=E\left[g_1(X)\right]+E\left[g_2(X)\right]  \]</span></p></li></ul><p>å¯¹äºå¤šç»´ä¹Ÿæˆç«‹ï¼š <span class="math display">\[E(X+Y)=E(X)+E(Y)\]</span> E(X_1+X_2++X_n)=E(X_1)+E(X_2)++E(X_n) $$</p><h3 id="æ–½ç“¦èŒ¨ä¸ç­‰å¼">æ–½ç“¦èŒ¨ä¸ç­‰å¼</h3><p>å¯¹ä»»æ„éšæœºå˜é‡<span class="math inline">\(X\)</span>ä¸<span class="math inline">\(Y\)</span>éƒ½æœ‰ï¼š <span class="math display">\[\Big[E(XY)\Big]^2 \le E(X^2)E(Y^2)\]</span></p><h3 id="ç‹¬ç«‹çš„æ•°å­¦æœŸæœ›">ç‹¬ç«‹çš„æ•°å­¦æœŸæœ›</h3><p>è®¾<span class="math inline">\((X,Y)\)</span>ä¸ºäºŒç»´ç‹¬ç«‹éšæœºå˜é‡ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[E(XY)=E(X)E(Y)\]</span> è¿™ä¸ªç»“è®ºå¯ä»¥æ¨å¹¿åˆ° n ç»´ç‹¬ç«‹éšæœºå˜é‡ï¼š <span class="math display">\[E\left(X_{1} X_{2} \cdots X_{n}\right)=E\left(X_{1}\right) E\left(X_{2}\right) \cdots E\left(X_{n}\right)\]</span></p><h2 id="æ–¹å·®ä¸æ ‡å‡†å·®-1">æ–¹å·®ä¸æ ‡å‡†å·®</h2><h3 id="æ–¹å·®ä¸æ ‡å‡†å·®çš„å®šä¹‰">æ–¹å·®ä¸æ ‡å‡†å·®çš„å®šä¹‰</h3><p>æ–¹å·®å®šä¹‰ä¸ºï¼ˆå› ä¸ºç›´æ¥é€šè¿‡æ•°å­¦æœŸæœ›å®šä¹‰çš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŒºåˆ†ç¦»æ•£å’Œè¿ç»­ï¼‰ï¼š <span class="math display">\[Var(X)=E\left[\Big(X-E(X)\Big)^2\right]\]</span></p><p>ä¸ºäº†å†™çš„ç®€å•ä¸€ç‚¹ï¼Œä¹Ÿå¸¸å¸¸ä»¤<span class="math inline">\(E(X)=\mu\)</span>ï¼Œé‚£ä¹ˆä¸Šå¼å¯ä»¥æ”¹å†™ä¸ºï¼š <span class="math display">\[Var(X)=E\left[(X-\mu)^2\right]\]</span></p><p>ä¹‹å‰ä¹Ÿä»‹ç»è¿‡ï¼Œç”±äºæ–¹å·®é‡Œé¢å«æœ‰å¹³æ–¹ï¼Œåœ¨å®é™…åº”ç”¨ä¸­éœ€è¦å¼€å¹³æ–¹æ‰èƒ½ä¿æŒå•ä½ä¸€è‡´ï¼Œè¿™å°±æ˜¯æ ‡å‡†å·®ï¼š</p><p><span class="math display">\[\sigma(X)=\sqrt{Var(X)}\]</span></p><h3 id="çº¿æ€§çš„æ–¹å·®">çº¿æ€§çš„æ–¹å·®</h3><p>è‹¥<span class="math inline">\(aã€b\)</span>ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[Var(aX+b)=a^2Var(X)\]</span></p><h3 id="ç‹¬ç«‹çš„æ–¹å·®">ç‹¬ç«‹çš„æ–¹å·®</h3><p>è®¾<span class="math inline">\((X,Y)\)</span>ä¸ºäºŒç»´ç‹¬ç«‹éšæœºå˜é‡ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[Var(X\pm Y)=Var(X)+Var(Y)\]</span></p><p>è¿™ä¸ªç»“è®ºå¯ä»¥æ¨å¹¿åˆ° n ç»´ç‹¬ç«‹éšæœºå˜é‡ï¼š</p><p><span class="math display">\[Var\left(X_{1}\pm X_{2}\pm \cdots\pm X_{n}\right)=Var\left(X_{1}\right) +Var\left(X_{2}\right)+\cdots+Var\left(X_{n}\right)\]</span></p><h2 id="åæ–¹å·®">åæ–¹å·®</h2><h3 id="åæ–¹å·®çš„å®šä¹‰">åæ–¹å·®çš„å®šä¹‰</h3><p>è®¾<span class="math inline">\((X,Y)\)</span>æ˜¯ä¸€ä¸ªäºŒç»´éšæœºå˜é‡ï¼Œè‹¥<span class="math inline">\(E\Big[(X-\mu_X)(Y-\mu_Y)\Big]\)</span>å­˜åœ¨ï¼Œåˆ™ç§°æ­¤æ•°å­¦æœŸæœ›ä¸º<span class="math inline">\(X\)</span>ä¸<span class="math inline">\(Y\)</span>çš„åæ–¹å·®ï¼ˆCovarianceï¼‰ï¼Œè®°ä½œï¼š <span class="math display">\[Cov(X,Y)=E\Big[(X-\mu_X)(Y-\mu_Y)\Big]\]</span></p><p>ç‰¹åˆ«åœ°æœ‰<span class="math inline">\(Cov(X,X)=Var(X)\)</span>ã€‚</p><p>å¾ˆæ˜¾ç„¶ä¼šæœ‰ï¼š</p><ul><li><span class="math inline">\(Cov(X,Y) &gt; 0\)</span>æ—¶ï¼Œ<span class="math inline">\(Xã€Y\)</span>æ­£ç›¸å…³ï¼Œå³ä¸¤è€…æœ‰åŒæ—¶å¢åŠ æˆ–è€…å‡å°‘çš„å€¾å‘ã€‚</li><li><span class="math inline">\(Cov(X,Y) &lt; 0\)</span>æ—¶ï¼Œ<span class="math inline">\(Xã€Y\)</span>è´Ÿç›¸å…³ï¼Œå³ä¸¤è€…æœ‰åå‘å¢åŠ æˆ–è€…å‡å°‘çš„å€¾å‘ã€‚</li><li><span class="math inline">\(Cov(X,Y) = 0\)</span>æ—¶ï¼Œ<span class="math inline">\(Xã€Y\)</span>ä¸ç›¸å…³ï¼Œä¸è¿‡å’Œç‹¬ç«‹è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œè¿™ç‚¹æˆ‘ä»¬åé¢å†è®ºè¿°ã€‚</li></ul><h3 id="åæ–¹å·®çš„æ€§è´¨">åæ–¹å·®çš„æ€§è´¨</h3><ul><li><p>åŒ–ç®€ï¼š å¯ä»¥é€šè¿‡ä¸‹å¼æ¥åŒ–ç®€è¿ç®—ï¼š <span class="math display">\[  Cov(X,Y)=E(XY)-E(X)E(Y)  \]</span> æ®æ­¤é©¬ä¸Šå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¨è®ºï¼š <span class="math display">\[  Cov(X,Y)=Cov(Y,X)  \]</span></p></li><li><p>æ–¹å·®ï¼š å¯¹äºä»»æ„çš„äºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>æœ‰ï¼š <span class="math display">\[  Var(X+Y)=Var(X)+Var(Y)+2Cov(X,Y)  \]</span> Var(X-Y)=Var(X)+Var(Y)-2Cov(X,Y) <span class="math display">\[  æ‰€ä»¥å½“$(X,Y)$ä¸ºäºŒç»´ä¸ç›¸å…³éšæœºå˜é‡æ—¶ï¼Œæœ‰ï¼š  \]</span> Var(XY)=Var(X)+Var(Y) $$</p></li><li><p>åˆ†é…å¾‹ï¼š <span class="math display">\[  Cov(X_1+X_2,Y)=Cov(X_1, Y)+Cov(X_2,Y)  \]</span></p></li><li><p>æ•°ä¹˜ï¼š <span class="math display">\[  Cov(aX+c,bY+d)=abCov(X, Y)  \]</span></p></li></ul><h3 id="ç‹¬ç«‹ä¸ä¸ç›¸å…³">ç‹¬ç«‹ä¸ä¸ç›¸å…³</h3><ul><li><p>ç‹¬ç«‹å¿…ä¸ç›¸å…³ï¼š æ ¹æ®åˆšæ‰çš„æ€§è´¨ï¼š <span class="math display">\[  Cov(X,Y)=E(XY)-E(X)E(Y)  \]</span> å¦‚æœ Xã€Y ç‹¬ç«‹ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[  E(XY)=E(X)E(Y)\implies Cov(X,Y)=0  \]</span> æ‰€ä»¥ï¼š <span class="math display">\[  ç‹¬ç«‹ã€implies ä¸ç›¸å…³  \]</span></p></li><li><p>ä¸ç›¸å…³ä¸èƒ½æ¨å‡ºç‹¬ç«‹ï¼š ä¸ç›¸å…³åªèƒ½è¯´æ˜ Xã€Y ä¹‹é—´æ²¡æœ‰æ­£ç›¸å…³è§„å¾‹ï¼Œä¹Ÿæ²¡æœ‰è´Ÿç›¸å…³è§„å¾‹ï¼Œä½†å¯èƒ½è¿˜æœ‰å¾ˆå¤šåˆ«çš„è§„å¾‹ï¼Œæ‰€ä»¥ï¼š <span class="math display">\[  ä¸ç›¸å…³ã€\mathrel{\rlap{\hskip .5em/}}\Longrightarrow\ ç‹¬ç«‹  \]</span></p></li></ul><h3 id="ç›¸å…³ç³»æ•°">ç›¸å…³ç³»æ•°</h3><p>å¯¹äºäºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>ï¼Œå„è‡ªçš„æ–¹å·®ä¸ºï¼š <span class="math display">\[Var(X)=\sigma^2_X,\quad Var(Y)=\sigma^2_Y\]</span> åˆ™ï¼š <span class="math display">\[\rho_{XY}=\frac{Cov(X,Y)}{\sigma_X\sigma_Y}\]</span> ç§°ä¸ºéšæœºå˜é‡<span class="math inline">\(X\)</span>å’Œ<span class="math inline">\(Y\)</span>çš„ç›¸å…³ç³»æ•°ã€‚</p><p>å¯¹äºä»»æ„çš„äºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>ï¼Œè‹¥ç›¸å…³ç³»æ•°å­˜åœ¨ï¼Œåˆ™ï¼š <span class="math display">\[-1\le\rho_{XY}\le 1\]</span></p><p>æœ‰ç•Œæ€§è®©æ¯”è¾ƒæœ‰äº†ä¸€ä¸ªèŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®ºï¼š</p><ul><li><span class="math inline">\(\rho &gt; 0\)</span>ï¼šæ­£ç›¸å…³ï¼Œä¸”<span class="math inline">\(\rho=1\)</span>çš„æ—¶å€™ï¼Œæ­£ç›¸å…³æ€§æœ€å¤§ï¼Œç§°ä¸ºå®Œå…¨æ­£ç›¸å…³ã€‚</li><li><span class="math inline">\(\rho &lt; 0\)</span>ï¼šè´Ÿç›¸å…³ï¼Œä¸”<span class="math inline">\(\rho=-1\)</span>çš„æ—¶å€™ï¼Œè´Ÿç›¸å…³æ€§æœ€å¤§ï¼Œç§°ä¸ºå®Œå…¨è´Ÿç›¸å…³ã€‚</li><li><span class="math inline">\(\rho = 0\)</span>ï¼šä¸ç›¸å…³ã€‚</li></ul><h3 id="äºŒç»´æ­£æ€åˆ†å¸ƒ">äºŒç»´æ­£æ€åˆ†å¸ƒ</h3><p>å¦‚æœäºŒç»´éšæœºå˜é‡<span class="math inline">\((X,Y)\)</span>çš„è”åˆæ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š <span class="math display">\[\begin{aligned}     p(x, y)=        &amp; \frac{1}{2 \pi \sigma_{1} \sigma_{2} \sqrt{1-\rho^{2}}} \exp \left\{-\frac{1}{2\left(1-\rho^{2}\right)}\left[\frac{\left(x-\mu_{1}\right)^{2}}{\sigma_{1}^{2}}\right.\right.\\         &amp;-\frac{2 \rho\left(x-\mu_{1}\right)\left(y-\mu_{2}\right)}{\sigma_{1} \sigma_{2}}+\frac{\left(y-\mu_{2}\right)^{2}}{\sigma_{2}^{2}} ] \} \end{aligned}\]</span></p><p>åˆ™ç§°<span class="math inline">\((X,Y)\)</span>æœä»äºŒç»´æ­£æ€åˆ†å¸ƒï¼Œè®°ä½œï¼š <span class="math display">\[(X,Y)\sim N(\mu_1,\mu_2,\sigma_1^2,\sigma_2^2,\rho)\]</span></p><p>å®ƒå«æœ‰äº”ä¸ªå‚æ•°<span class="math inline">\(\mu_1ï¼Œ\mu_2ï¼Œ\sigma_1^2ï¼Œ\sigma_2^2\)</span>å’Œ<span class="math inline">\(\rho\)</span>ï¼Œå–å€¼èŒƒå›´åˆ†åˆ«ä¸ºï¼š <span class="math display">\[-\infty&lt;\mu_{1}&lt;\infty,-\infty&lt;\mu_{2}&lt;\infty, \sigma_{1}&gt;0, \sigma_{2}&gt;0,-1 \leqslant \rho \leqslant 1\]</span> å¹¶ä¸”<span class="math inline">\(\mu_1ï¼Œ\mu_2\)</span>åˆ†åˆ«æ˜¯<span class="math inline">\(Xã€Y\)</span>çš„æœŸæœ›ï¼›<span class="math inline">\(\sigma_1^2ï¼Œ\sigma_2^2\)</span>åˆ†åˆ«æ˜¯<span class="math inline">\(Xã€Y\)</span>çš„æ–¹å·®ï¼›<span class="math inline">\(\rho\)</span>æ˜¯<span class="math inline">\(Xã€Y\)</span>çš„ç›¸å…³ç³»æ•°ã€‚</p><h1 id="å¤§æ•°å®šå¾‹åŠä¸­å¿ƒæé™å®šç†">å¤§æ•°å®šå¾‹åŠä¸­å¿ƒæé™å®šç†</h1><h2 id="å¤§æ•°å®šå¾‹">å¤§æ•°å®šå¾‹</h2><h3 id="ä¼¯åŠªåˆ©å¤§æ•°å®šå¾‹">ä¼¯åŠªåˆ©å¤§æ•°å®šå¾‹</h3><p>æ•´ä¸ªæ¦‚ç‡è®ºçš„å¾—ä»¥å­˜åœ¨çš„åŸºç¡€æ˜¯ï¼Œå…¶æ‰€ç ”ç©¶çš„éšæœºç°è±¡è™½ç„¶ç»“æœä¸ç¡®å®šï¼Œä½†åˆæœ‰è§„å¾‹å¯å¾ªã€‚è¿™ä¸ªåŸºç¡€åœ¨æ¦‚ç‡è®ºä¸­è¢«ç§°ä¸ºå¤§æ•°å®šå¾‹ï¼ˆLaw of large numbersï¼‰ã€‚å¤§æ•°å®šå¾‹æ˜¯ä¸€ç³»åˆ—çš„å®šå¾‹ï¼Œå…ˆæ¥ä»‹ç»ä¼¯åŠªåˆ©å¤§æ•°å®šå¾‹ï¼š</p><p>è®¾<span class="math inline">\(n_A\)</span>æ˜¯<span class="math inline">\(n\)</span>æ¬¡é‡å¤ç‹¬ç«‹å®éªŒä¸­äº‹ä»¶<span class="math inline">\(A\)</span>å‘ç”Ÿçš„æ¬¡æ•°ï¼Œ<span class="math inline">\(p\)</span>æ˜¯äº‹ä»¶<span class="math inline">\(A\)</span>åœ¨æ¯æ¬¡å®éªŒä¸­å‘ç”Ÿçš„æ¦‚ç‡ï¼Œåˆ™å¯¹äºä»»æ„æ­£æ•°<span class="math inline">\(\epsilon &gt; 0\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\frac{n_\text{A}}{n}-p\right| &lt; \epsilon \right) = 1\]</span></p><p>æˆ–ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\frac{n_\text{A}}{n}-p\right| \ge \epsilon \right) = 0\]</span></p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸èƒ½ç›´æ¥ç”¨ï¼š <span class="math display">\[\lim_{n\to \infty}\frac{n_\text{H}}{n}=p\]</span> è€Œå¿…é¡»åœ¨å¤–é¢å¥—ä¸Šä¸€ä¸ªæ¦‚ç‡å‡½æ•°ï¼Œ<span class="math inline">\(\frac{n_\text{H}}{n}\)</span>å¹¶ä¸æ˜¯ä¸€ä¸ªæ•°åˆ—ï¼Œè€Œæ˜¯éšæœºå˜é‡ã€‚å› æ­¤å®ƒä¸å…·å¤‡è¿›è¡Œæé™è¿ç®—çš„å‰æã€‚</p><h3 id="ä¾æ¦‚ç‡æ”¶æ•›">ä¾æ¦‚ç‡æ”¶æ•›</h3><p>å› ä¸º<span class="math inline">\(\frac{n_\text{H}}{n}\)</span>æ˜¯éšæœºå˜é‡ï¼Œæ‰€ä»¥è¦è¡¨ç¤ºå®ƒå’Œ<span class="math inline">\(p\)</span>æ¥è¿‘ï¼Œåªèƒ½è¡¨ç¤ºä¸ºäº‹ä»¶ï¼š <span class="math display">\[â€œé¢‘ç‡ P_n è¶Šæ¥è¶Šæ¥è¿‘æ¦‚ç‡ pâ€=\Big\{\left|\frac{n_\text{H}}{n}-p\right| &lt; \epsilon\Big\}\]</span> ç„¶åå¥—ä¸Šæ¦‚ç‡å‡½æ•°<span class="math inline">\(P\)</span>ï¼Œå¯¹è¯¥å‡½æ•°æ±‚<span class="math inline">\(n\)</span>è¶‹äºæ— ç©·æ—¶çš„æé™ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\frac{n_\text{H}}{n}-p\right| &lt; \epsilon \right) = 1\]</span></p><p>è¿™ä¸ªæé™åŒæ ·è¡¨è¾¾äº†â€œéšç€<span class="math inline">\(n\)</span>çš„å¢å¤§ï¼Œé¢‘ç‡<span class="math inline">\(P_n\)</span>ä¼šè¶Šæ¥è¶Šæ¥è¿‘æ¦‚ç‡<span class="math inline">\(p\)</span>â€çš„æ„æ€ï¼Œä½†æ˜¯å› ä¸ºå¥—ä¸Šäº†æ¦‚ç‡å‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸º<span class="math inline">\(P_n\)</span>ä¾æ¦‚ç‡æ”¶æ•›äº<span class="math inline">\(p\)</span>ï¼Œè®°ä½œï¼š <span class="math display">\[\frac{n_\text{H}}{n}\xrightarrow{\quad P \quad}p,\quad n\to\infty\]</span></p><h3 id="è¾›é’¦å¤§æ•°å®šå¾‹">è¾›é’¦å¤§æ•°å®šå¾‹</h3><p>ä¼¯åŠªåˆ©å¤§æ•°å®šå¾‹å±€é™äºä¼¯åŠªåˆ©åˆ†å¸ƒï¼Œä¸‹é¢ä»‹ç»è¾›é’¦å¤§æ•°å®šå¾‹å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œåªæ˜¯è¦æ±‚éµå¾ªç›¸åŒçš„åˆ†å¸ƒï¼š è®¾æœ‰éšæœºå˜é‡ï¼š <span class="math display">\[X_1,X_2,\cdots,X_n\]</span> è¿™äº›éšæœºå˜é‡ç›¸äº’ç‹¬ç«‹ï¼Œæœä»åŒä¸€åˆ†å¸ƒï¼Œä¸”å…·æœ‰ç›¸åŒçš„æ•°å­¦æœŸæœ›ï¼š <span class="math display">\[E(X_i)=\mu,\quad i=1,2,\cdots,n\]</span> ä»¤ï¼š <span class="math display">\[\overline{X}=\frac{X_1+X_2+\cdots+X_n}{n}\]</span> åˆ™å¯¹äºä»»æ„<span class="math inline">\(\epsilon &gt; 0\)</span>æœ‰ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\overline{X}-\mu\right| &lt; \epsilon \right) = 1\]</span> æˆ–ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\overline{X}-\mu\right| \ge \epsilon \right) = 0\]</span> ä¹Ÿå¯ä»¥è¡¨è¿°ä¸ºï¼š <span class="math display">\[\overline{X}\xrightarrow{\quad P \quad}\mu,\quad n\to\infty\]</span></p><h3 id="åˆ‡æ¯”é›ªå¤«å¤§æ•°å®šå¾‹">åˆ‡æ¯”é›ªå¤«å¤§æ•°å®šå¾‹</h3><p>ç›¸åŒçš„åˆ†å¸ƒä¹Ÿç®—æ¯”è¾ƒä¸¥æ ¼çš„é™åˆ¶ï¼Œä¸‹é¢ä»‹ç»åˆ‡æ¯”é›ªå¤«å¤§æ•°å®šå¾‹å¯¹äºåˆ†å¸ƒå°±æ›´åŠ å®½æ¾ï¼Œåªè¦å„è‡ªçš„æ–¹å·®æœ‰å…±åŒä¸Šç•Œå³å¯ï¼š è®¾æœ‰éšæœºå˜é‡ï¼š <span class="math display">\[X_1,X_2,\cdots,X_n\]</span> è¿™äº›éšæœºå˜é‡ä¸¤ä¸¤ä¸ç›¸å…³ï¼Œè‹¥æ¯ä¸ªéšæœºå˜é‡<span class="math inline">\(X_i\)</span>çš„æ–¹å·®å­˜åœ¨ï¼Œä¸”æœ‰å…±åŒçš„ä¸Šç•Œï¼Œå³ï¼š <span class="math display">\[Var(X_i)\le c,\quad i=1,2,\cdots,n\]</span> ä»¤ï¼š <span class="math display">\[\overline{X}=\frac{X_1+X_2+\cdots+X_n}{n},\quad \mu=E(\overline{X})\]</span> åˆ™å¯¹äºä»»æ„<span class="math inline">\(\epsilon &gt; 0\)</span>æœ‰ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\overline{X}-\mu\right| &lt; \epsilon \right) = 1\]</span> æˆ–ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\overline{X}-\mu\right| \ge \epsilon \right) = 0\]</span> ä¹Ÿå¯ä»¥è¡¨è¿°ä¸ºï¼š <span class="math display">\[\overline{X}\xrightarrow{\quad P \quad}\mu,\quad n\to\infty\]</span></p><h3 id="æ€»ç»“-2">æ€»ç»“</h3><p>è¿™é‡Œæ€»å…±ä»‹ç»äº†ä¸‰ä¸ªå¤§æ•°å®šå¾‹ï¼Œä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š <span class="math display">\[\begin{array}{c|c}    \hline    \quad \quad &amp;\quad åˆ†å¸ƒã€quad&amp;\quad ç‹¬ç«‹æ€§ã€quad&amp;\quad æ–¹å·®ã€quad\\    \hline    \\    \quad ä¼¯åŠªåˆ©å¤§æ•°ã€quad &amp; \quad ä¼¯åŠªåˆ©åˆ†å¸ƒã€quad &amp; \quad ç‹¬ç«‹ã€quad &amp; \quad æ— è¦æ±‚ã€quad\\    è¾›é’¦å¤§æ•° &amp; åŒåˆ†å¸ƒ &amp; ç‹¬ç«‹ &amp; æ— è¦æ±‚ \\    åˆ‡æ¯”é›ªå¤«å¤§æ•° &amp; æ— è¦æ±‚ &amp; ä¸ç›¸å…³ &amp; åŒä¸Šç•Œã€\    \\    \hline\end{array}\]</span></p><h3 id="å¼ºå¤§æ•°å®šå¾‹">å¼ºå¤§æ•°å®šå¾‹</h3><p>å‰é¢ä»‹ç»çš„å¤§æ•°å®šå¾‹åˆç§°ä¸ºå¼±å¤§æ•°å®šå¾‹ï¼ˆWeak Law of large numbersï¼‰ï¼Œæœ‰å¼±å°±è‡ªç„¶å°±æœ‰å¼ºï¼Œä¸‹é¢å°±æ¥ä»‹ç»å¼ºå¤§æ•°å®šå¾‹ï¼ˆStrong Law of large numbersï¼‰ï¼š è®¾æœ‰éšæœºå˜é‡ï¼š <span class="math display">\[X_1,X_2,\cdots,X_n\]</span> è¿™äº›éšæœºå˜é‡ç›¸äº’ç‹¬ç«‹ï¼Œæœä»åŒä¸€åˆ†å¸ƒï¼Œä¸”å…·æœ‰ç›¸åŒçš„æ•°å­¦æœŸæœ›ï¼š <span class="math display">\[E(X_i)=\mu,\quad i=1,2,\cdots,n\]</span> ä»¤ï¼š <span class="math display">\[\overline{X}=\frac{X_1+X_2+\cdots+X_n}{n}\]</span> åˆ™å¯¹äºä»»æ„<span class="math inline">\(\epsilon &gt; 0\)</span>æœ‰ï¼š <span class="math display">\[P\left(\lim_{n\to \infty}\left|\overline{X}-\mu\right| &lt; \epsilon \right) = 1\]</span> æˆ–ï¼š <span class="math display">\[P\left(\lim_{n\to \infty}\left|\overline{X}-\mu\right| \ge \epsilon \right) = 0\]</span></p><p>è¿™ä¸ªå¼ºå¤§æ•°å®šå¾‹å’Œä¹‹å‰çš„è¾›é’¦å¤§æ•°å®šå¾‹éå¸¸æ¥è¿‘ï¼š</p><ul><li><p>å¼±å¤§æ•°å®šå¾‹ï¼ˆè¾›é’¦å¤§æ•°å®šå¾‹ï¼‰ï¼Œæé™ç¬¦å·åœ¨ P å‡½æ•°å¤–é¢ï¼š <span class="math display">\[\lim_{n\to \infty}P\left(\left|\overline{X}-\mu\right| &lt; \epsilon \right) = 1\]</span></p></li><li><p>å¼ºå¤§æ•°å®šå¾‹ï¼Œæé™ç¬¦å·åœ¨ P å‡½æ•°é‡Œé¢ï¼š <span class="math display">\[P\left(\lim_{n\to \infty}\left|\overline{X}-\mu\right| &lt; \epsilon \right) = 1\]</span> ä»”ç»†ä½“ä¼šè¿™ä¸¤åˆ™ä¹‹é—´çš„åŒºåˆ«^â€†_â€†^ã€‚</p></li></ul><h2 id="ä¸­å¿ƒæé™å®šç†">ä¸­å¿ƒæé™å®šç†</h2><h3 id="æ££è«å¼—-æ‹‰æ™®æ‹‰æ–¯å®šç†">æ££è«å¼—-æ‹‰æ™®æ‹‰æ–¯å®šç†</h3><p>è®¾éšæœºå˜é‡<span class="math inline">\(X\sim b(n,p)\)</span>ï¼Œåˆ™å¯¹ä»»æ„ x æœ‰ï¼š <span class="math display">\[\lim_{n\to\infty}P\left(\frac{X-np}{\sqrt{np(1-p)}}\le x\right)=\Phi(x)=\frac{1}{\sqrt{2\pi}}\int_{-\infty}^{x}e^{-\frac{t^2}{2}}\mathrm{d}t\]</span></p><h3 id="æ—å¾·ä¼¯æ ¼-è±ç»´å®šç†">æ—å¾·ä¼¯æ ¼-è±ç»´å®šç†</h3><p>è®¾éšæœºå˜é‡ï¼š <span class="math display">\[X_i,\quad i=1,2,\cdots,n\]</span> ç›¸äº’ç‹¬ç«‹ï¼Œæœä»åŒä¸€åˆ†å¸ƒï¼Œä¸”æœ‰ç›¸åŒçš„æ•°å­¦æœŸæœ›å’Œæ–¹å·®ï¼š <span class="math display">\[E(X_i)=\mu,\quad Var(X_i)=\sigma^2\]</span> åˆ™éšæœºå˜é‡ï¼š <span class="math display">\[Y=\frac{X_1+X_2+\cdots+X_n-n\mu}{\sigma\sqrt{n}}\]</span> å¯¹äºä»»æ„å®æ•°<span class="math inline">\(y\)</span>æœ‰ï¼š <span class="math display">\[\lim_{n\to\infty}F_Y(y)=\lim_{n\to\infty}P(Y\le y)=\Phi(y)=\frac{1}{\sqrt{2\pi}}\int_{-\infty}^{y}e^{-\frac{t^2}{2}}\mathrm{d}t\]</span></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé©¬åŒå­¦çš„æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡ã€‹<br>æ„Ÿå…´è¶£çš„å¯ä»¥è´­ä¹°ä»–çš„è¯¾ç¨‹ï¼Œå†™çš„å¾ˆå¥½ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼ï¼ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Science Thought </category>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Linear Algebra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿æ€§ä»£æ•°</title>
      <link href="/2022/Science/linearAlgebra/"/>
      <url>/2022/Science/linearAlgebra/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/LinearAlgebra.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjFlMWQzMzYzNzY4OTIxMjI5OWQ5ZTY=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å‘é‡ç©ºé—´">å‘é‡ç©ºé—´</h1><h2 id="å‘é‡">å‘é‡</h2><p>n ä¸ªæœ‰åºçš„æ•°<span class="math inline">\(a_1,a_2,...,a_n\)</span>æ‰€ç»„æˆçš„æ•°ç»„ç§°ä¸º<span class="math inline">\(n\)</span> ç»´å‘é‡ï¼Œè¿™<span class="math inline">\(n\)</span>ä¸ªæ•°ç§°ä¸ºè¯¥å‘é‡çš„<span class="math inline">\(n\)</span>ä¸ªåˆ†é‡ï¼Œç¬¬<span class="math inline">\(i\)</span>ä¸ªæ•°<span class="math inline">\(a_i\)</span>ç§°ä¸ºç¬¬<span class="math inline">\(i\)</span>ä¸ªåˆ†é‡ã€‚<span class="math inline">\(n\)</span>ç»´å‘é‡å¯å†™æˆä¸€è¡Œï¼Œä¹Ÿå¯å†™æˆä¸€åˆ—ã€‚åˆ†åˆ«ç§°ä¸ºè¡Œå‘é‡å’Œåˆ—å‘é‡ï¼š</p><ul><li>n ç»´åˆ—å‘é‡ï¼š</li></ul><p><span class="math display">\[\begin{pmatrix}a_1\\a_2\\\vdots\\a_n\end{pmatrix}\]</span></p><ul><li>ä¸ n ç»´è¡Œå‘é‡ï¼š</li></ul><p><span class="math display">\[(a_1,a_2,...,a_n)\quad æˆ–ã€quad \begin{pmatrix}a_1&amp;a_2&amp;\cdots&amp;a_n\end{pmatrix}\]</span></p><p><span class="math inline">\(n\)</span>ä¹Ÿç§°ä¸ºè¯¥å‘é‡çš„ç»´æ•°ã€‚</p><h2 id="å‘é‡çš„åŸºæœ¬è¿ç®—æ³•åˆ™">å‘é‡çš„åŸºæœ¬è¿ç®—æ³•åˆ™</h2><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad åŠ æ³•ã€quad &amp; \quad\begin{aligned} äº¤æ¢å¾‹ã€\ ç»“åˆå¾‹ \end{aligned}\quad &amp; \quad\begin{aligned}\boldsymbol{v}+\boldsymbol{u}=\boldsymbol{u}+\boldsymbol{v}\qquad\quad\\ \boldsymbol{u}+\boldsymbol{v}+\boldsymbol{w}=\boldsymbol{u}+(\boldsymbol{v}+\boldsymbol{w}) \end{aligned}\quad\\    \\    \hline    \\    \quad æ•°ä¹˜ã€quad &amp; \quad\begin{aligned} äº¤æ¢å¾‹ã€\ ç»“åˆå¾‹ã€\åˆ†é…å¾‹ \end{aligned}\quad &amp; \quad\begin{aligned}k\cdot\boldsymbol{u}=\boldsymbol{u}\cdot k\qquad\ \ \\ k\cdot m\cdot\boldsymbol{u}=k\cdot(m\cdot\boldsymbol{u})\\k(\boldsymbol{u}+\boldsymbol{v})=k\boldsymbol{u}+k\boldsymbol{v}\ \  \end{aligned}\quad\\    \\    \hline\end{array}\]</span></p><h2 id="çº¿æ€§ç»„åˆ">çº¿æ€§ç»„åˆ</h2><ul><li><p>å‘é‡ç»„ï¼š è‹¥å¹²åŒç»´æ•°çš„åˆ—å‘é‡ï¼ˆæˆ–è€…åŒç»´æ•°çš„è¡Œå‘é‡ï¼‰æ‰€ç»„æˆçš„é›†åˆï¼Œå«åšå‘é‡ç»„ã€‚æ¯”å¦‚åŒç»´æ•° çš„å‘é‡<span class="math inline">\(\boldsymbol{a_1},\boldsymbol{a_2},...\boldsymbol{a_m}\)</span>ï¼Œå¯ ä»¥ç»„æˆå‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>ï¼Œé€šå¸¸è®°ä½œï¼š</p><p><span class="math display">\[  \mathcal{A}:\boldsymbol{a_1},\boldsymbol{a_2},...,\boldsymbol   {a_m}\quad æˆ–ã€quad \mathcal{A}=\{\boldsymbol{a_1},\boldsymbol  {a_2},...,\boldsymbol{a_m}\}  \]</span></p></li><li><p>çº¿æ€§ç›¸å…³ï¼š ç»™å®šå‘é‡ç»„<span class="math inline">\(\mathcal{A}=\{\boldsymbol{a_1},\boldsymbol{a_2},..., \boldsymbol{a_m}\}\)</span>å’Œå‘é‡<span class="math inline">\(\boldsymbol{b_{}}\)</span>ï¼Œå¦‚æœå­˜åœ¨ä¸€ç»„å®æ•°<span class="math inline">\(k_1, k_2,...k_m\)</span>ï¼Œä½¿ï¼š</p><p><span class="math display">\[  \boldsymbol{b_{}}=k_1\boldsymbol{a_1}+k_2\boldsymbol{a_2}+...   +k_m\boldsymbol{a_m}  \]</span></p><p>åˆ™ç§°å‘é‡<span class="math inline">\(\boldsymbol{b_{}}\)</span>èƒ½ç”±å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span> çº¿æ€§è¡¨ç¤ºï¼Œæˆ–ç§°å‘é‡ <span class="math inline">\(\boldsymbol{b_{}}\)</span>æ˜¯å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çš„çº¿æ€§ç»„åˆã€‚</p></li><li><p>çº¿æ€§ç›¸å…³å’Œçº¿æ€§æ— å…³ï¼š ç»™å®šå‘é‡ç»„<span class="math inline">\(\mathcal{A}=\{\boldsymbol{a_1},\boldsymbol{a_2},..., \boldsymbol{a_m}\}\)</span>ï¼Œå¦‚æœå­˜åœ¨ä¸å…¨ä¸ºé›¶çš„å®æ•°<span class="math inline">\(k_1,k_2,...k_m\)</span>ï¼Œä½¿ï¼š</p><p><span class="math display">\[  k_1\boldsymbol{a_1}+k_2\boldsymbol{a_2}+...+k_m\boldsymbol{a_m} =\boldsymbol{0}  \]</span></p><p>åˆ™ç§°å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>æ˜¯çº¿æ€§ç›¸å…³çš„ï¼Œå¦åˆ™ç§°å®ƒä¸ºçº¿æ€§æ— å…³ã€‚</p></li></ul><h2 id="å‘é‡ç©ºé—´-1">å‘é‡ç©ºé—´</h2><p>è®¾<span class="math inline">\(\mathcal{V}\)</span>ä¸ºä¸€å‘é‡ç»„ï¼Œå¦‚æœ<span class="math inline">\(\mathcal{V}\)</span>éç©ºï¼Œä¸”<span class="math inline">\(\mathcal{V}\)</span>å¯¹äºå‘é‡çš„åŠ æ³•åŠæ•°ä¹˜ä¸¤ç§è¿ç®—å°é—­ï¼Œé‚£ä¹ˆå°±ç§°<span class="math inline">\(\mathcal{V}\)</span>ä¸ºå‘é‡ç©ºé—´ã€‚</p><p>æ‰€è°“å°é—­ï¼Œæ˜¯æŒ‡åœ¨<span class="math inline">\(\mathcal{V}\)</span>ä¸­å‘é‡è¿›è¡Œæ•°ä¹˜å’ŒåŠ å‡ï¼Œå…¶ç»“æœä¾ç„¶åœ¨<span class="math inline">\(\mathcal{V}\)</span>ä¸­ã€‚å…·ä½“çš„è¯´ï¼Œå°±æ˜¯ï¼š</p><ul><li>è‹¥<span class="math inline">\(\boldsymbol{a}\in \mathcal{V},\boldsymbol{b}\in \mathcal{V}\)</span>ï¼Œåˆ™<span class="math inline">\(\boldsymbol{a}+\boldsymbol{b} \in \mathcal{V}\)</span>ã€‚</li><li>è‹¥<span class="math inline">\(\boldsymbol{a}\in \mathcal{V},k\in \mathbb{R}\)</span>ï¼Œåˆ™<span class="math inline">\(k\boldsymbol{a} \in \mathcal{V}\)</span>ã€‚</li></ul><h2 id="å¼ æˆç©ºé—´">å¼ æˆç©ºé—´</h2><h3 id="å¼ æˆç©ºé—´çš„å®šä¹‰">å¼ æˆç©ºé—´çš„å®šä¹‰</h3><p>æŸå‘é‡ç»„<span class="math inline">\(\mathcal{A}=\{\boldsymbol{v_1},\boldsymbol{v_2},...,\boldsymbol{v_p}\}\)</span>ï¼Œå…¶æ‰€æœ‰çº¿æ€§ç»„åˆæ„æˆçš„é›†åˆä¸ºå‘é‡ç©ºé—´ï¼Œä¹Ÿç§°ä¸ºå‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çš„å¼ æˆç©ºé—´ï¼Œè®°ä¸º<span class="math inline">\(span(\boldsymbol{v_1},\boldsymbol{v_2},...,\boldsymbol{v_p})\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[span(\boldsymbol{v_1},\boldsymbol{v_2},...,\boldsymbol{v_p})=\{k_1\boldsymbol{v_1}+k_2\boldsymbol{v_2}+...+k_p\boldsymbol{v_p},k_{1,2,...,p}\in\mathbb{R}\}\]</span></p><p>ä¹Ÿç§°<span class="math inline">\(span(\boldsymbol{v_1},\boldsymbol{v_2},...,\boldsymbol{v_p})\)</span>ä¸ºå‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>æ‰€å¼ æˆã€‚</p><h3 id="ç­‰ä»·å‘é‡ç»„">ç­‰ä»·å‘é‡ç»„</h3><p>è®¾æœ‰ä¸¤ä¸ªå‘é‡ç»„<span class="math inline">\(\mathcal{A}=\{\boldsymbol{a_1},\boldsymbol{a_2},...,\boldsymbol{a_m}\}\)</span>åŠ<span class="math inline">\(\mathcal{B}=\{\boldsymbol{b_1},\boldsymbol{b_2},...,\boldsymbol{b_n}\}\)</span>ï¼Œè‹¥å‘é‡ç»„<span class="math inline">\(\mathcal{B}\)</span>ä¸­çš„æ¯ä¸ªå‘é‡éƒ½èƒ½ç”±å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çº¿æ€§è¡¨ç¤ºï¼Œåˆ™ç§°å‘é‡ç»„<span class="math inline">\(\mathcal{B}\)</span>èƒ½ç”±å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çº¿æ€§è¡¨ç¤ºã€‚</p><p>è‹¥å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>ä¸å‘é‡ç»„<span class="math inline">\(\mathcal{B}\)</span>èƒ½ç›¸äº’çº¿æ€§è¡¨ç¤ºï¼Œåˆ™ç§°è¿™ä¸¤ä¸ªå‘é‡ç»„ç­‰ä»·ï¼Œä¹Ÿå¯ä»¥è¯´<span class="math inline">\(\mathcal{A}\)</span>å’Œ<span class="math inline">\(\mathcal{B}\)</span>æ˜¯ç­‰ä»·å‘é‡ç»„ã€‚</p><h3 id="æœ€å¤§æ— å…³ç»„">æœ€å¤§æ— å…³ç»„</h3><p>è®¾æœ‰å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>ï¼Œå¦‚æœåœ¨<span class="math inline">\(\mathcal{A}\)</span>ä¸­èƒ½é€‰å‡º<span class="math inline">\(r\)</span>ä¸ªå‘é‡<span class="math inline">\(\boldsymbol{a_1},\boldsymbol{a_2},...,\boldsymbol{a_r}\)</span>æ»¡è¶³ï¼š</p><ul><li>å‘é‡ç»„<span class="math inline">\(\mathcal{A}_0=\{\boldsymbol{a_1},\boldsymbol{a_2},...,\boldsymbol{a_r}\}\)</span>çº¿æ€§æ— å…³ã€‚</li><li>å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>ä¸­ä»»æ„<span class="math inline">\(r+1\)</span>ä¸ªå‘é‡ï¼ˆå¦‚æœ<span class="math inline">\(\mathcal{A}\)</span>ä¸­æœ‰<span class="math inline">\(r+1\)</span>ä¸ªå‘é‡çš„è¯ï¼‰éƒ½çº¿æ€§ç›¸å…³ï¼Œé‚£ä¹ˆç§°å‘é‡ç»„<span class="math inline">\(\mathcal{A}_0\)</span>æ˜¯å‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çš„ä¸€ä¸ªæœ€å¤§çº¿æ€§æ— å…³ç»„ï¼Œç®€ç§°æœ€å¤§æ— å…³ç»„ã€‚</li></ul><h3 id="å‘é‡ç»„çš„ç§©">å‘é‡ç»„çš„ç§©</h3><p>å‡è®¾å‘é‡ç»„<span class="math inline">\(A\)</span>çš„æœ€å¤§æ— å…³ç»„ä¸ºï¼š <span class="math display">\[\mathcal{A}_0=\{a_1,a_2,\cdots,a_r\}\]</span></p><p><span class="math inline">\(\mathcal{A}_0\)</span>çš„å‘é‡ä¸ªæ•°<span class="math inline">\(r\)</span>ç§°ä¸ºå‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>çš„ç§©ï¼Œè®°åš<span class="math inline">\(rank(\mathcal{A})\)</span>ï¼Œæœ‰æ—¶ä¹Ÿè®°ä½œ<span class="math inline">\(r(\mathcal{A})\)</span>ã€‚</p><h2 id="å‘é‡ç©ºé—´çš„åŸº">å‘é‡ç©ºé—´çš„åŸº</h2><ul><li><p>åŸºï¼š å·²çŸ¥<span class="math inline">\(\mathcal{V}\)</span>ä¸ºå‘é‡ç©ºé—´ï¼Œå¦‚æœå…¶ä¸­çš„æŸå‘é‡ç»„ï¼š</p><p><span class="math display">\[  \mathcal{A}=\{\boldsymbol{a_1},\boldsymbol{a_2},...\boldsymbol  {a_n}\}  \]</span></p><p>æ˜¯<span class="math inline">\(\mathcal{V}\)</span>çš„æœ€å¤§æ— å…³ç»„ï¼Œé‚£ä¹ˆå‘é‡ç»„<span class="math inline">\(\mathcal{A}\)</span>è¢«ç§°ä¸ºå‘é‡ç©ºé—´ <span class="math inline">\(\mathcal{V}\)</span>çš„ä¸€ä¸ªåŸºã€‚</p></li><li><p>åæ ‡ï¼š å‡è®¾<span class="math inline">\(\mathcal{A}=\{\boldsymbol{a_1},\boldsymbol{a_2},...,\boldsymbol{a_n}\}\)</span>æ˜¯å‘é‡ç©ºé—´<span class="math inline">\(\mathcal{V}\)</span>çš„ä¸€ä¸ªåŸºï¼Œåˆ™<span class="math inline">\(\mathcal{V}\)</span>ä¸­æ¯ä¸ªå‘é‡<span class="math inline">\(\boldsymbol{x}\)</span>å¯å”¯ä¸€åœ°è¡¨ç¤ºä¸ºï¼š <span class="math display">\[  \boldsymbol{x}=k_1\boldsymbol{a_1}+k_2\boldsymbol{a_2}+\cdots  +k_n\boldsymbol{a_n}  \]</span> ä¸Šå¼çš„ç³»æ•°å¯ä»¥ç»„æˆå‘é‡ï¼š <span class="math display">\[  [\boldsymbol{x}]_\mathcal{A}=\begin{pmatrix}k_1\\k_2\\\vdots\\k_n\end{pmatrix}  \]</span> æˆ‘ä»¬å°†å…¶ç§°ä¸º<span class="math inline">\(\boldsymbol{x}\)</span>åœ¨åŸº<span class="math inline">\(\mathcal{A}\)</span>ä¸‹çš„åæ ‡å‘é‡ï¼Œæˆ–è€…ç®€ç§°ä¸º<span class="math inline">\(\boldsymbol{x}\)</span>åœ¨åŸº<span class="math inline">\(\mathcal{A}\)</span>ä¸‹çš„åæ ‡ã€‚</p></li><li><p>ç»´åº¦ï¼š å‡è®¾å‘é‡ç©ºé—´<span class="math inline">\(\mathcal{V}\)</span>çš„åŸºä¸ºï¼š <span class="math display">\[  \mathcal{A}=\{a_1,a_2,\cdots,a_r\}  \]</span> åˆ™<span class="math inline">\(\mathcal{A}\)</span>çš„ç§©<span class="math inline">\(r\)</span>ç§°ä¸ºè¯¥å‘é‡ç©ºé—´çš„ç»´åº¦ï¼Œæˆ–è€…ç§°<span class="math inline">\(\mathcal{V}\)</span>ä¸º<span class="math inline">\(r\)</span>ç»´å‘é‡ç©ºé—´ã€‚</p></li></ul><h2 id="æ•°é‡ç§¯ç‚¹ç§¯">æ•°é‡ç§¯ï¼ˆç‚¹ç§¯ï¼‰</h2><h3 id="ç‚¹ç§¯çš„å®šä¹‰">ç‚¹ç§¯çš„å®šä¹‰</h3><p>å‘é‡<span class="math inline">\(\boldsymbol{x}=\begin{pmatrix}x_1\\\vdots\\x_n\end{pmatrix}\)</span>å’Œ <span class="math inline">\(\boldsymbol{y}=\begin{pmatrix}y_1\\\vdots\\y_n\end{pmatrix}\)</span>çš„ç‚¹ç§¯<span class="math inline">\((dot product)\)</span>ï¼Œæˆ–ç§°å†…ç§¯<span class="math inline">\((inner product)\)</span>ï¼Œå®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[\boldsymbol{x}\cdot\boldsymbol{y}=x_1y_1+\cdots+x_ny_n=\displaystyle\sum_{i=1}^{n}x_iy_i\]</span></p><p>ç‚¹ç§¯è¿˜å¯ä»¥ç§°ä¸ºæ•°é‡ç§¯æˆ–è€…æ ‡é‡ç§¯ï¼Œè¿™æ˜¯å› ä¸ºä¸¤ä¸ªå‘é‡é€šè¿‡ç‚¹ç§¯è¿ç®—ä¹‹åçš„ç»“æœæ˜¯æ•°é‡ï¼ˆæ ‡é‡ï¼‰ã€‚</p><h3 id="ç‚¹ç§¯çš„æ€§è´¨">ç‚¹ç§¯çš„æ€§è´¨</h3><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad äº¤æ¢å¾‹ã€quad&amp;\quad \boldsymbol{a}\cdot\boldsymbol{b}=\boldsymbol{b}\cdot\boldsymbol{a}\quad\\    \quad æ•°ä¹˜ç»“åˆå¾‹ã€quad&amp;\quad (k\boldsymbol{a})\cdot\boldsymbol{b}=k(\boldsymbol{b}\cdot\boldsymbol{a})\quad\\    \quad åˆ†é…å¾‹ã€quad&amp;\quad (\boldsymbol{a}+\boldsymbol{b})\cdot\boldsymbol{c}=\boldsymbol{a}\cdot\boldsymbol{c}+\boldsymbol{b}\cdot\boldsymbol{c}\quad\\    \\    \hline\end{array}\]</span></p><h1 id="çŸ©é˜µå’ŒçŸ©é˜µè¿ç®—">çŸ©é˜µå’ŒçŸ©é˜µè¿ç®—</h1><h2 id="çŸ©é˜µçš„å®šä¹‰">çŸ©é˜µçš„å®šä¹‰</h2><p>ç”±<span class="math inline">\(m\times n\)</span>ä¸ªæ•°<span class="math inline">\(a_{ij}(i=1,2,...m;j=1,2...n)\)</span>æ’æˆçš„<span class="math inline">\(m\)</span>è¡Œ<span class="math inline">\(n\)</span>åˆ—çš„æ•°è¡¨ç§°ä¸º<span class="math inline">\(m\)</span>è¡Œ<span class="math inline">\(n\)</span>åˆ—çŸ©é˜µ<span class="math inline">\(ï¼ˆMatrixï¼‰\)</span>ï¼Œç®€ç§°<span class="math inline">\(m\times n\)</span>çŸ©é˜µã€‚ä¸ºè¡¨ç¤ºè¿™äº›æ•°å­—æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œæ€»æ˜¯åŠ ä¸€ä¸ªæ‹¬å¼§ï¼Œä¸‹é¢å°±è¡¨ç¤ºäº†çŸ©é˜µ<span class="math inline">\(A\)</span>ï¼š</p><p><span class="math display">\[A=\underbrace{\begin{pmatrix}a_{11}&amp;a_{12}&amp;...&amp;a_{1n}\\a_{21}&amp;a_{22}&amp;...&amp;a_{2n}\\...&amp;...&amp;&amp;...\\a_{m1}&amp;a_{m2}&amp;...&amp;a_{mn}\end{pmatrix}}_{\large n åˆ—}\left.\begin{aligned}\\\\\\\\\end{aligned}\right\}m è¡Œ\]</span></p><p>å¯ä»¥ç”¨<span class="math inline">\(a_{ij}\)</span>æˆ–<span class="math inline">\(a_{i,j}\)</span>æ¥è¡¨ç¤ºè¯¥çŸ©é˜µ<span class="math inline">\(A\)</span>çš„ç¬¬<span class="math inline">\(i\)</span>è¡Œ<span class="math inline">\(j\)</span>åˆ—çš„æ•°å­—ï¼Œåˆšæ‰çš„çŸ©é˜µè¿˜å¯ä»¥ç®€è®°ä¸ºï¼š</p><p><span class="math display">\[A=(a_{ij})=(a_{i,j})\]</span></p><p>ä¸ºäº†è¡¨ç¤ºçŸ©é˜µçš„è¡Œæ•°å’Œåˆ—æ•°ï¼Œ<span class="math inline">\(m\times n\)</span>çŸ©é˜µ<span class="math inline">\(A\)</span>ä¹Ÿè®°ä½œ<span class="math inline">\(A_{m\times n}\)</span>ã€‚</p><h2 id="é«˜æ–¯æ¶ˆå…ƒæ³•">é«˜æ–¯æ¶ˆå…ƒæ³•</h2><ul><li>è¡Œé˜¶æ¢¯å½¢çŸ©é˜µï¼š éé›¶çŸ©é˜µè‹¥æ»¡è¶³ï¼š<ul><li>éé›¶è¡Œåœ¨é›¶è¡Œï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰çš„ä¸Šé¢</li><li>éé›¶è¡Œæœ€å·¦è¾¹çš„é¦–éé›¶å…ƒç´ åœ¨ä¸Šä¸€è¡Œï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰çš„é¦–éé›¶å…ƒç´ çš„å³é¢</li></ul><p>æ‰€ä»¥ç§°ä¸ºè¡Œé˜¶æ¢¯å½¢çŸ©é˜µï¼ˆRow echelon formï¼‰ï¼Œéé›¶è¡Œæœ€å·¦è¾¹çš„é¦–éé›¶å…ƒç´ ç§°ä¸ºä¸»å…ƒï¼ˆPivot elementï¼‰ã€‚</p></li><li><p>å¯¹è§’çŸ©é˜µï¼š è‹¥ n é˜¶æ–¹é˜µå¦‚ä¸‹ï¼š <span class="math display">\[  \Lambda_{n}=\begin{pmatrix}\lambda_1&amp;0&amp;...&amp;0\\0&amp;\lambda_2&amp;...&amp;0\\...&amp;...&amp;&amp;...\\  0&amp;0&amp;...&amp;\lambda_n\end{pmatrix}  \]</span> å¯¹è§’çº¿ä»¥å¤–çš„å…ƒç´ éƒ½æ˜¯ 0ï¼Œè¿™ç§æ–¹é˜µç§°ä¸ºå¯¹è§’çŸ©é˜µï¼ˆDiagonal matrixï¼‰ï¼Œç®€ç§°å¯¹è§’é˜µï¼Œä¹Ÿè®°ä½œï¼š <span class="math display">\[  \Lambda_{n}=diag(\lambda_1,\lambda_2,...,\lambda_n)  \]</span></p></li><li><p>å•ä½é˜µï¼š å¦‚æœ n é˜¶å¯¹è§’é˜µçš„å¯¹è§’çº¿ä¸Šçš„å…ƒç´ å…¨ä¸º 1ï¼š <span class="math display">\[  I_n=\begin{pmatrix}1&amp;0&amp;...&amp;0\\0&amp;1&amp;...&amp;0\\...&amp;...&amp;&amp;...\\  0&amp;0&amp;...&amp;1\end{pmatrix}  \]</span> è¯¥å¯¹è§’é˜µç§°ä¸º n é˜¶å•ä½çŸ©é˜µï¼ˆIdentity matrixï¼‰ï¼Œæˆ–è€…ç®€ç§°ä¸ºå•ä½é˜µã€‚åœ¨å›½å†…æ•™æä¸­ï¼Œå•ä½é˜µä¸€èˆ¬ç”¨ E è¡¨ç¤ºã€‚</p></li><li>è¡Œæœ€ç®€å½¢çŸ©é˜µï¼š è‹¥ A æ˜¯è¡Œé˜¶æ¢¯å½¢çŸ©é˜µï¼Œå¹¶ä¸”è¿˜æ»¡è¶³ï¼š<ul><li>ä¸»å…ƒä¸º 1</li><li>é™¤ä¸»å…ƒå¤–ï¼Œå…¶æ‰€åœ¨åˆ—çš„å…¶å®ƒå…ƒç´ å‡ä¸º 0</li></ul><p>åˆ™ç§° A ä¸ºè¡Œæœ€ç®€å½¢çŸ©é˜µï¼ˆReduced row echelon formï¼‰.</p></li><li><p>åˆç­‰è¡Œå˜æ¢å’Œåˆç­‰è¡ŒçŸ©é˜µï¼š å®Œæˆé«˜æ–¯æ¶ˆå…ƒæ³•åªéœ€è¦ä¸‰ç§æ“ä½œï¼Œè¿™ä¸‰ç§æ“ä½œæ˜¯ä½œç”¨åœ¨çŸ©é˜µçš„è¡Œä¸Šçš„ï¼Œæ‰€ä»¥åˆç§°ä¸ºåˆç­‰è¡Œå˜æ¢ï¼ˆElementary row operationsï¼‰ã€‚åœ¨å•ä½é˜µä¸Šåº”ç”¨è¿™ä¸‰ç§åˆç­‰è¡Œå˜æ¢ä¸€æ¬¡å¾—åˆ°çš„çŸ©é˜µç§°ä¸ºåˆç­‰è¡ŒçŸ©é˜µï¼ˆElementary row matrixï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸‹åˆ—è¡¨æ ¼ä¸­æœ€å³çš„çŸ©é˜µï¼š <span class="math display">\[  \begin{array}{c|c|c}      \hline      \quad åˆç­‰è¡Œå˜æ¢ã€quad &amp;\quad æ“ä½œã€quad &amp;\quad åˆç­‰è¡ŒçŸ©é˜µã€quad\\      \hline      \\      \quad \begin{aligned}\color{SkyBlue}{å€åŠ å˜æ¢}  \qquad\qquad\quad\\\text{row-addition transformations}\end    {aligned}\quad &amp;\quad \boldsymbol{r_1}'=\boldsymbol{r_1}    +k\boldsymbol{r_2}\quad &amp;\quad \begin{pmatrix}1&amp;{\color{red}    {k}}&amp;0\\0&amp;1&amp;0\\0&amp;0&amp;1\end{pmatrix}\quad      \\      \hline      \\      \quad \begin{aligned}\color{Goldenrod}{å€ä¹˜å˜æ¢}    \qquad\qquad\quad\\\text{row-multiplying transformations}   \end{aligned}\quad &amp;\quad \boldsymbol{r_1}'=k\boldsymbol   {r_1} (k\neq 0)\quad &amp;      \quad \begin{pmatrix}{\color{red}{k}}&amp;0&amp;0\\0&amp;1&amp;0\\0&amp;0&amp;1\end {pmatrix}\quad \\      \\      \hline      \\      \quad \begin{aligned}\color{orange}{å¯¹æ¢å˜æ¢}   \qquad\qquad\quad\\\text{row-switching transformations}\end    {aligned}\quad &amp;\quad \boldsymbol{r_1}\leftrightarrow   \boldsymbol{r_2}\quad &amp;      \quad \begin{pmatrix}{\color{red}{0}}&amp;{\color{red}{1}}&amp; {\color{red}{0}}\\      {\color{red}{1}}&amp;{\color{red}{0}}&amp;{\color{red}{0}}\\0&amp;0&amp;    1\end{pmatrix}\quad \\      \\      \hline  \end{array}  \]</span></p><p>åˆç­‰è¡ŒçŸ©é˜µä¹˜ä¸ŠçŸ©é˜µ Aï¼Œå°±ç›¸å½“äºåœ¨çŸ©é˜µ A ä¸Šå®æ–½äº†å¯¹åº”çš„åˆç­‰è¡Œå˜æ¢ã€‚</p></li></ul><h2 id="çŸ©é˜µçš„åŠ æ³•ä¸ä¹˜æ³•">çŸ©é˜µçš„åŠ æ³•ä¸ä¹˜æ³•</h2><p>ä¸¤ä¸ªçŸ©é˜µçš„è¡Œæ•°ç›¸ç­‰ã€åˆ—æ•°ä¹Ÿç›¸ç­‰æ—¶ï¼Œå°±ç§°å®ƒä»¬æ˜¯åŒå‹çŸ©é˜µã€‚</p><ul><li><p>åŠ æ³•ï¼š è®¾æœ‰ä¸¤ä¸ª<span class="math inline">\(m\times n\)</span>çŸ©é˜µ<span class="math inline">\(A=(a_{ij})\)</span>å’Œ<span class="math inline">\(B=(b_{ij})\)</span>ï¼Œé‚£ä¹ˆçŸ©é˜µ<span class="math inline">\(A\)</span>å’Œ<span class="math inline">\(B\)</span>çš„å’Œè®°åš<span class="math inline">\(A+B\)</span>ï¼Œè§„å®šä¸ºï¼š <span class="math display">\[  A+B=\begin{pmatrix}a_{11}+b_{11}&amp;a_{12}+b_{12}&amp;...&amp;a_{1n}+b_{1n}\\a_{21}+b_{21}&amp;a_{22}+b_{22}&amp;...&amp;a_{2n}+b_{2n}\\  ...&amp;...&amp;&amp;...\\a_{m1}+b_{m1}&amp;a_{m2}+b_{m2}&amp;...&amp;a_{mn}+b_{mn}\end{pmatrix}  \]</span></p></li><li><p>çŸ©é˜µåŠ æ³•è¿ç®—è§„å¾‹ï¼š <span class="math display">\[  \begin{array}{c|c}      \hline      \\      \quad äº¤æ¢å¾‹ã€quad&amp;\quad A+B=B+A\quad\\      \quad ç»“åˆå¾‹ã€quad&amp;\quad (A+B)+C=A+(B+C)\quad\\      \\      \hline  \end{array}  \]</span></p></li><li><p>çŸ©é˜µæ•°ä¹˜ï¼š æ•°<span class="math inline">\(k\)</span>ä¸çŸ©é˜µ<span class="math inline">\(A\)</span>çš„ä¹˜ç§¯è®°ä½œï¼š <span class="math display">\[  kA\quad æˆ–ã€quad Ak  \]</span> è§„å®šä¸ºï¼š <span class="math display">\[  kA=Ak=  \begin{pmatrix}      ka_{11}&amp;ka_{12}&amp;\cdots&amp;ka_{1n}\\      ka_{21}&amp;ka_{22}&amp;\cdots&amp;ka_{2n}\\      \cdots&amp;\cdots&amp; &amp;\cdots\\      ka_{m1}&amp;ka_{m2}&amp;\cdots&amp;ka_{mn}\end{pmatrix}  \]</span></p></li><li><p>æ•°ä¹˜çš„è¿ç®—è§„å¾‹ï¼š <span class="math display">\[  \begin{array}{c|c}      \hline      \\      \quad ç»“åˆå¾‹ã€quad&amp;\quad (\lambda\mu) A=\lambda(\mu A)\quad\\      \\      \quad åˆ†é…å¾‹ã€quad&amp;\quad \begin{aligned}(\lambda+\mu)    A=\lambda A+\mu A\\\lambda(A+B)=\lambda A+\lambda B\end    {aligned}\quad\\      \\      \hline  \end{array}  \]</span></p></li><li><p>çŸ©é˜µä¹˜æ³•çš„å®šä¹‰ï¼š è®¾<span class="math inline">\(A=(a_{ij})\)</span>æ˜¯ä¸€ä¸ª<span class="math inline">\(m\times s\)</span>çŸ©é˜µï¼Œ<span class="math inline">\(B=(b_{ij})\)</span>æ˜¯ä¸€ä¸ª<span class="math inline">\(s\times n\)</span>çŸ©é˜µï¼Œé‚£ä¹ˆè§„å®š<span class="math inline">\(A\)</span>ä¸<span class="math inline">\(B\)</span>çš„ä¹˜ç§¯æ˜¯ä¸€ä¸ª<span class="math inline">\(m\times n\)</span>çŸ©é˜µ<span class="math inline">\(C=(c_{ij})\)</span>ï¼Œå…¶ä¸­ï¼š <span class="math display">\[     c_{ij}=\boldsymbol{a}_{i*}\cdot\boldsymbol{b}_{*j}=a_{i1}b_{1j} +a_{i2}b_{2j}+...+a_{is}b_{sj}=\displaystyle \sum_{k=1}^s a_{ik} b_{kj}  (i=1,\cdots,m;j=1,\cdots,n)  \]</span> å¹¶æŠŠä¹˜ç§¯è®°ä½œï¼š <span class="math display">\[  C=AB  \]</span></p></li><li><p>çŸ©é˜µä¹˜æ³•è¿ç®—è§„å¾‹ï¼š <span class="math display">\[  \begin{array}{c|c}      \hline      \\      \quad äº¤æ¢å¾‹ã€quad&amp;\quad ä¸ä¸€å®šæ»¡è¶³ã€quad\\      \quad æ•°ä¹˜äº¤æ¢å¾‹ã€quad&amp;\quad \lambda(AB)=(\lambda A)B=A  (\lambda B)ï¼ˆå…¶ä¸­ã€lambda æ˜¯æ•°ï¼‰\quad\\      \quad ç»“åˆå¾‹ã€quad&amp;\quad (AB)C=A(BC)\quad\\      \quad åˆ†é…å¾‹ã€quad&amp;\quad A(B+C)=AB+AC\quad\\      \\      \hline  \end{array}  \]</span></p></li></ul><h2 id="çŸ©é˜µçš„å¹‚ä¸è½¬ç½®">çŸ©é˜µçš„å¹‚ä¸è½¬ç½®</h2><p>ç±»ä¼¼äº<span class="math inline">\(x^n\)</span>ç§°ä¸º<span class="math inline">\(x\)</span>çš„å¹‚è¿ç®—ï¼ŒçŸ©é˜µä¹Ÿæœ‰å¹‚è¿ç®—ï¼Œä¹Ÿç§°ä¸ºçŸ©é˜µçš„å¹‚ï¼š è®¾<span class="math inline">\(A\)</span>æ˜¯æ–¹é˜µï¼Œå®šä¹‰ï¼š</p><p><span class="math display">\[A^1=A,\quad A^2=A^1A^1,\quad\cdots,\quad A^{k+1}=A^kA^1\]</span></p><p>å…¶ä¸­ k ä¸ºæ­£æ•´æ•°ã€‚</p><ul><li><p>çŸ©é˜µçš„è½¬ç½®ï¼š æŠŠçŸ©é˜µ<span class="math inline">\(A\)</span>çš„è¡Œæ¢æˆåŒåºæ•°çš„åˆ—ï¼Œè¯¥æ“ä½œç§°ä¸ºçŸ©é˜µçš„è½¬ç½®è¿ç®—ã€‚è½¬ç½®è¿ç®—åå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çŸ©é˜µï¼Œè¯¥çŸ©é˜µç§°ä¸º A çš„è½¬ç½®çŸ©é˜µï¼Œè®°ä½œ<span class="math inline">\(A^\mathrm{T}\)</span>ã€‚æˆ–è€…ç”¨ç¬¦å·è¡¨ç¤ºå¦‚ä¸‹ï¼š <span class="math display">\[  A=(a_{ij}),\quad A^\mathrm{T}=(a_{ji})  \]</span></p></li><li><p>è½¬ç½®çš„æ€§è´¨ï¼š <span class="math display">\[ (A^\mathrm{T})^\mathrm{T}=A \]</span> (AB)<sup>=B</sup>A<sup> <span class="math display">\[ (A^\mathrm{T})^n=(A^n)^\mathrm{T} \]</span> (A+B)</sup>=A<sup>+B</sup> <span class="math display">\[ å¯¹äºä¸¤ä¸ªåŒç»´å‘é‡$\boldsymbol{x}$å’Œ$\boldsymbol{y}$ï¼Œæœ‰ï¼š \]</span> ^=() $$</p></li><li><p>å¯¹ç§°çŸ©é˜µä¸åå¯¹ç§°çŸ©é˜µï¼š è‹¥ï¼š <span class="math display">\[  A^T=A  \]</span> åˆ™çŸ©é˜µ A ç§°ä¸ºå¯¹ç§°çŸ©é˜µã€‚</p><p>è‹¥ï¼š <span class="math display">\[  A^T=-A  \]</span> åˆ™çŸ©é˜µ A ç§°ä¸ºåå¯¹ç§°çŸ©é˜µã€‚</p></li></ul><h2 id="çŸ©é˜µå‡½æ•°">çŸ©é˜µå‡½æ•°</h2><p>å…¶å®ï¼Œä»»ç»™ä¸€ä¸ª RGB éƒ½å¯ä»¥å¦‚ä¸Šè½¬ä¸ºå¯¹åº”çš„<span class="math inline">\(YP_rP_b\)</span>ã€‚ä¸ºäº†è¡¨æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç”¨æœªçŸ¥å‘é‡<span class="math inline">\(\boldsymbol{x}ã€\boldsymbol{y}\)</span>æ¥æ›¿æ¢å¸¸å‘é‡<span class="math inline">\(\boldsymbol{a}ã€\boldsymbol{b}\)</span>ï¼š</p><p><span class="math display">\[\underbrace{\begin{pmatrix}0.299&amp;0.587&amp;0.114\\0.5&amp;-0.418688&amp;-0.081312\\-0.168736&amp;-0.331264&amp;0.5\end{pmatrix}}_{\large \boldsymbol{A}}\ \underbrace{\begin{pmatrix}R\\G\\B\end{pmatrix}}_{\large \boldsymbol{x}}\ =\ \underbrace{\begin{pmatrix}Y\\P_r\\P_b\end{pmatrix}}_{\large \boldsymbol{y}}\]</span></p><p>è¿™æ ·å°±å¾—åˆ°äº†å‡½æ•°<span class="math inline">\(\boldsymbol{A}\boldsymbol{x}=\boldsymbol{y}ï¼ˆï¼‰\)</span>ï¼Œä¹Ÿç§°ä¸ºçŸ©é˜µå‡½æ•°ï¼Œå…¶è¾“å…¥ä¸º<span class="math inline">\(\boldsymbol{x}\)</span>ï¼Œè¾“å‡ºä¸º<span class="math inline">\(\boldsymbol{y}\)</span>ï¼š</p><h2 id="çŸ©é˜µå‡½æ•°çš„æ€§è´¨">çŸ©é˜µå‡½æ•°çš„æ€§è´¨</h2><p><span class="math display">\[\begin{array}{c|c}    \hline    \\    \quad äº¤æ¢å¾‹ã€quad&amp;\quad ä¸ä¸€å®šæ»¡è¶³ã€quad\\    \quad æ•°ä¹˜äº¤æ¢å¾‹ã€quad&amp;\quad \lambda(AB)=(\lambda A)B=A(\lambda B)ï¼ˆå…¶ä¸­ã€lambda æ˜¯æ•°ï¼‰\quad\\    \quad ç»“åˆå¾‹ã€quad&amp;\quad (AB)C=A(BC)\quad\\    \quad åˆ†é…å¾‹ã€quad&amp;\quad A(B+C)=AB+AC\quad\\    \\    \hline\end{array}\]</span></p><h1 id="çŸ©é˜µçš„ç§©">çŸ©é˜µçš„ç§©</h1><h2 id="è¡Œç§©å’Œåˆ—ç§©">è¡Œç§©å’Œåˆ—ç§©</h2><h3 id="åˆ—ç©ºé—´">åˆ—ç©ºé—´</h3><p>çŸ©é˜µ A çš„åˆ—å‘é‡ä¸ºï¼š</p><p><span class="math display">\[A=\begin{pmatrix}    {\color{green}{a_{11}}}&amp;{\color{blue}{a_{12}}}&amp;\cdots&amp;{\color{purple}{a_{1n}}}\\    {\color{green}{a_{21}}}&amp;{\color{blue}{a_{22}}}&amp;\cdots&amp;{\color{purple}{a_{2n}}}\\    \vdots&amp;\vdots&amp;\quad&amp;\vdots\\    {\color{green}{a_{m1}}}&amp;{\color{blue}{a_{m2}}}&amp;\cdots&amp;{\color{purple}{a_{mn}}}\end{pmatrix}=({\color{green}{\boldsymbol{c_1}}},{\color{blue}{\boldsymbol{c_2}}},\cdots,{\color{purple}{\boldsymbol{c_n}}})\]</span></p><p>åŒ…å«æ‰€æœ‰åˆ—å‘é‡çš„å‘é‡ç»„ç§°ä¸ºåˆ—å‘é‡ç»„ï¼Œå³ï¼š</p><p><span class="math display">\[åˆ—å‘é‡ç»„ï¼š\{\boldsymbol{c_1},\boldsymbol{c_2},\cdots,\boldsymbol{c_n}\}\]</span></p><p>åˆ—å‘é‡ç»„çš„å¼ æˆç©ºé—´ç§°ä¸ºåˆ—ç©ºé—´ï¼Œè®°ä½œ<span class="math inline">\(colsp(A)\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[\begin{aligned}    colsp(A)        &amp;=span(\{\boldsymbol{c_1},\boldsymbol{c_2},\cdots,\boldsymbol{c_n}\})\\        &amp;=x_1\boldsymbol{c_1}+x_2\boldsymbol{c_2}+\cdots+x_n\boldsymbol{c_n},\quad x_{1,2,\cdots,n}\in\mathbb{R}\end{aligned}\]</span></p><p>åˆ—å‘é‡ç»„çš„ç§©ï¼Œä¹Ÿå°±æ˜¯åˆ—ç©ºé—´çš„ç»´åº¦ï¼Œç§°ä¸ºåˆ—ç§©ï¼Œå³ï¼š</p><p><span class="math display">\[åˆ—ç§©=rank(colsp(A))\]</span></p><p>å¦‚æœåˆ—å‘é‡ç»„çº¿æ€§æ— å…³ï¼Œå°±ç§°ä¸ºåˆ—æ»¡ç§©ã€‚</p><h3 id="è¡Œç©ºé—´">è¡Œç©ºé—´</h3><p>çŸ©é˜µ A çš„è¡Œå‘é‡ä¸ºï¼š</p><p><span class="math display">\[A=\begin{pmatrix}    {\color{green}{a_{11}}}&amp;{\color{green}{a_{12}}}&amp;\cdots&amp;{\color{green}{a_{1n}}}\\    {\color{blue}{a_{21}}}&amp;{\color{blue}{a_{22}}}&amp;\cdots&amp;{\color{blue}{a_{2n}}}\\    \vdots&amp;\vdots&amp;\quad&amp;\vdots\\    {\color{purple}{a_{m1}}}&amp;{\color{purple}{a_{m2}}}&amp;\cdots&amp;{\color{purple}{a_{mn}}}\end{pmatrix}=\begin{pmatrix}{\color{green}{\boldsymbol{r_1}^\mathrm{T}}}\\{\color{blue}{\boldsymbol{r_2}^\mathrm{T}}}\\\vdots\\{\color{purple}{\boldsymbol{r_m}^\mathrm{T}}}\end{pmatrix}\]</span></p><p>åŒ…å«æ‰€æœ‰è¡Œå‘é‡çš„å‘é‡ç»„ç§°ä¸ºè¡Œå‘é‡ç»„ï¼Œå³ï¼š</p><p><span class="math display">\[è¡Œå‘é‡ç»„ï¼š\{\boldsymbol{r_1}^\mathrm{T},\boldsymbol{r_2}^\mathrm{T},\cdots,\boldsymbol{r_m}^\mathrm{T}\}\]</span></p><p>è¡Œå‘é‡ç»„çš„å¼ æˆç©ºé—´ç§°ä¸ºè¡Œç©ºé—´ï¼Œè®°ä½œ<span class="math inline">\(rowsp(A)\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[\begin{aligned}    rowsp(A)        &amp;=span(\{\boldsymbol{r_1}^\mathrm{T},\boldsymbol{r_2}^\mathrm{T},\cdots,\boldsymbol{r_m}^\mathrm{T}\})\\        &amp;=x_1\boldsymbol{r_1}^\mathrm{T}+x_2\boldsymbol{r_2}^\mathrm{T}+\cdots+x_m\boldsymbol{r_m}^\mathrm{T},\quad x_{1,2,\cdots,m}\in\mathbb{R}\end{aligned}\]</span></p><p>è¡Œå‘é‡ç»„çš„ç§©ï¼Œä¹Ÿå°±æ˜¯è¡Œç©ºé—´çš„ç»´åº¦ï¼Œç§°ä¸ºè¡Œç§©ï¼Œå³ï¼š</p><p><span class="math display">\[è¡Œç§©=rank(rowsp(A))\]</span></p><p>å¦‚æœè¡Œå‘é‡ç»„çº¿æ€§æ— å…³ï¼Œå°±ç§°ä¸ºè¡Œæ»¡ç§©ã€‚</p><h2 id="ç§©">ç§©</h2><ul><li><p>çŸ©é˜µçš„ç§©çš„å®šä¹‰ï¼š å¯¹äºä»»æ„çŸ©é˜µï¼Œå§‹ç»ˆæœ‰åˆ—ç§©ç­‰äºè¡Œç§©ï¼Œæ‰€ä»¥ç»Ÿç§°ä¸ºçŸ©é˜µçš„ç§©ï¼Œå³ï¼š <span class="math display">\[  çŸ©é˜µçš„ç§©=åˆ—ç§©=è¡Œç§©  \]</span></p><p>çŸ©é˜µ A çš„ç§©è®°ä½œ<span class="math inline">\(rank(A)\)</span>ï¼Œæœ‰æ—¶ä¹Ÿç®€å†™ä¸º<span class="math inline">\(r(A)\)</span>ã€‚</p></li><li><p>ç§©çš„å‡ ä½•æ„ä¹‰ï¼š æ ¹æ®è‡ªç„¶å®šä¹‰åŸŸä¸‹ï¼ŒçŸ©é˜µå‡½æ•°çš„å€¼åŸŸå¯çŸ¥ï¼Œåœ¨è‡ªç„¶å®šä¹‰åŸŸä¸‹</p><ul><li>åˆ—å‘é‡çŸ©é˜µå‡½æ•°<span class="math inline">\(A\boldsymbol{x}=\boldsymbol{y}\)</span>çš„å€¼åŸŸçš„ç»´åº¦æ˜¯åˆ—ç§©</li><li>è¡Œå‘é‡çŸ©é˜µå‡½æ•°<span class="math inline">\(\boldsymbol{x}^\mathrm{T}A=\boldsymbol{y}^\mathrm{T}\)</span>çš„å€¼åŸŸçš„ç»´åº¦æ˜¯è¡Œç§©</li></ul><p>å› ä¸ºè¡Œç§©=åˆ—ç§©=ç§©ï¼Œæ‰€ä»¥å½“åœ¨è‡ªç„¶å®šä¹‰åŸŸä¸‹æ—¶ï¼Œç§©å°±æ˜¯çŸ©é˜µå‡½æ•°çš„å€¼åŸŸçš„ç»´åº¦ã€‚ä¸‹é¢æ¥çœ‹å‡ ä¸ªä¾‹å­ã€‚</p></li><li><p>æ»¡ç§©ï¼š å¦‚æœæŸä¸ªçŸ©é˜µï¼Œæ—¢æ˜¯åˆ—æ»¡ç§©ï¼Œåˆæ˜¯è¡Œæ»¡ç§©ï¼Œé‚£ä¹ˆå°±ç§°è¯¥çŸ©é˜µä¸ºæ»¡ç§©çŸ©é˜µï¼Œæˆ–è€…ç®€ç§°ä¸ºæ»¡ç§©ã€‚æ»¡ç§©çŸ©é˜µå¿…ä¸ºæ–¹é˜µã€‚</p></li><li>ç§©çš„æ€§è´¨ï¼š<ul><li><p>ç§©çš„å–å€¼èŒƒå›´ï¼š <span class="math display">\[  0\le rank(A_{m\times n})\le\min(m,n)  \]</span></p></li><li><p>è½¬ç½®çŸ©é˜µçš„ç§©ï¼š <span class="math display">\[  rank(A)=rank(A^\mathrm{T})  \]</span></p></li><li><p>å¤åˆå‡½æ•°çš„ç§©ï¼š <span class="math display">\[  rank(AB)\leq\min\Big(rank(A),rank(B)\Big)  \]</span></p></li><li><p>æ»¡ç§©çŸ©é˜µå¤åˆçš„ç§©ã€‚å‡è®¾ Pã€Q ä¸ºæ»¡ç§©çŸ©é˜µï¼Œé‚£ä¹ˆï¼š <span class="math display">\[  rank(PA)=rank(AQ)=rank(PAQ)=rank(A)  \]</span></p></li><li><p>çŸ©é˜µç›¸åŠ çš„ç§©ã€‚å‡è®¾ Aã€B ä¸ºåŒå‹çŸ©é˜µï¼Œé‚£ä¹ˆï¼š <span class="math display">\[  rank(A+B)\le rank(A)+rank(B)  \]</span></p></li></ul></li></ul><h2 id="é€†çŸ©é˜µ">é€†çŸ©é˜µ</h2><h3 id="é€†çŸ©é˜µçš„å®šä¹‰">é€†çŸ©é˜µçš„å®šä¹‰</h3><p>è‹¥å­˜åœ¨ä¸¤ä¸ª<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}ã€\boldsymbol{C}\)</span>ï¼Œä¸¤è€…çš„ä¹˜ç§¯ä¸º<span class="math inline">\(n\)</span>é˜¶å•ä½é˜µ<span class="math inline">\(\boldsymbol{I}\)</span>ï¼š</p><p><span class="math display">\[\boldsymbol{A}\boldsymbol{C}=\boldsymbol{I}\qquad ä¸”ã€qquad \boldsymbol{C}\boldsymbol{A}=\boldsymbol{I}\]</span></p><p>é‚£ä¹ˆ<span class="math inline">\(\boldsymbol{C}\)</span>å°±æ˜¯<span class="math inline">\(\boldsymbol{A}\)</span>çš„é€†çŸ©é˜µï¼Œå³æœ‰<span class="math inline">\(\boldsymbol{A}^{-1}=\boldsymbol{C}\)</span>ï¼Œä¸”<span class="math inline">\(\boldsymbol{A}^{-1}\)</span>æ˜¯å”¯ä¸€çš„ã€‚</p><p>å¦‚æœå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—åˆç­‰è¡ŒçŸ©é˜µ<span class="math inline">\(\boldsymbol{E}_i\)</span>ï¼Œå°†çŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>å˜æ¢æˆå•ä½é˜µ<span class="math inline">\(\boldsymbol{I}\)</span>ï¼Œåˆ™<span class="math inline">\(\boldsymbol{A}\)</span>çš„é€†çŸ©é˜µå°±æ˜¯è¿™äº›åˆç­‰è¡ŒçŸ©é˜µçš„ä¹˜ç§¯ï¼š</p><p><span class="math display">\[\underbrace{\boldsymbol{E}_1\boldsymbol{E}_2...\boldsymbol{E}_n}_{\boldsymbol{A}^{-1}}\boldsymbol{A}=\boldsymbol{I}\]</span></p><h3 id="é€†çŸ©é˜µçš„è¿ç®—è§„å¾‹">é€†çŸ©é˜µçš„è¿ç®—è§„å¾‹</h3><p>è‹¥<span class="math inline">\(\boldsymbol{A}\)</span>å¯é€†ï¼Œåˆ™<span class="math inline">\(\boldsymbol{A}^{-1}\)</span>ä¹Ÿå¯é€†ï¼Œä¸”ï¼š</p><p><span class="math display">\[(\boldsymbol{A}^{-1})^{-1}=\boldsymbol{A}\]</span></p><p>è‹¥<span class="math inline">\(\boldsymbol{A}\)</span>å¯é€†ï¼Œæ•°<span class="math inline">\(\lambda\ne 0\)</span>ï¼Œåˆ™<span class="math inline">\(\lambda\boldsymbol{A}\)</span>å¯é€†ï¼Œä¸”ï¼š</p><p><span class="math display">\[(\lambda\boldsymbol{A})^{-1}=\frac{1}{\lambda}\boldsymbol{A}^{-1}\]</span></p><p>è‹¥<span class="math inline">\(\boldsymbol{A}ã€\boldsymbol{B}\)</span>ä¸ºåŒé˜¶æ–¹é˜µä¸”å‡å¯é€†ï¼Œåˆ™<span class="math inline">\(\boldsymbol{A}\boldsymbol{B}\)</span>ä¹Ÿå¯é€†ï¼Œä¸”ï¼š</p><p><span class="math display">\[(\boldsymbol{A}\boldsymbol{B})^{-1}=\boldsymbol{B}^{-1}\boldsymbol{A}^{-1}\]</span></p><p>è‹¥<span class="math inline">\(\boldsymbol{A}\)</span>å¯é€†ï¼Œåˆ™<span class="math inline">\(\boldsymbol{A}^\mathrm{T}\)</span>ä¹Ÿå¯é€†ï¼Œä¸”ï¼š</p><p><span class="math display">\[(\boldsymbol{A}^\mathrm{T})^{-1}=(\boldsymbol{A}^{-1})^\mathrm{T}\]</span></p><h2 id="çº¿æ€§æ–¹ç¨‹ç»„çš„æ±‚è§£">çº¿æ€§æ–¹ç¨‹ç»„çš„æ±‚è§£</h2><ul><li>è§£çš„å­˜åœ¨æ€§ å¯¹äºçº¿æ€§æ–¹ç¨‹ç»„<span class="math inline">\(\boldsymbol{A}\boldsymbol{x}=\boldsymbol{b}\)</span>ï¼Œå®ƒçš„å¢å¹¿çŸ©é˜µä¸º<span class="math inline">\(\boldsymbol{B}=(\boldsymbol{A}\ |\ \boldsymbol{b_{}})\)</span>ï¼Œé‚£ä¹ˆï¼š<ul><li>æœ‰è§£ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(rank(\boldsymbol{A})=rank(\boldsymbol{B})\)</span></li><li>æ— è§£ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(rank(\boldsymbol{A}) &lt; rank(\boldsymbol{B})\)</span></li></ul><p>è¡Œæ»¡ç§©çŸ©é˜µä¸€å®šæœ‰è§£</p></li><li>è§£çš„ä¸ªæ•°åˆ¤åˆ«æ³•ï¼š å¯¹äºçº¿æ€§æ–¹ç¨‹ç»„<span class="math inline">\(\boldsymbol{A}\boldsymbol{x}=\boldsymbol{b}\)</span>ï¼Œå®ƒçš„å¢å¹¿çŸ©é˜µä¸º<span class="math inline">\(\boldsymbol{B}=(\boldsymbol{A}\ |\ \boldsymbol{b_{}})\)</span>ï¼Œå¦‚æœ<span class="math inline">\(\boldsymbol{A}\)</span>ä¸º<span class="math inline">\(m\times n\)</span>çš„çŸ©é˜µï¼Œé‚£ä¹ˆï¼š<ul><li>æœ‰å”¯ä¸€è§£ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(rank(\boldsymbol{A})=rank(\boldsymbol{B})=n\)</span></li><li>æœ‰æ— æ•°è§£ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(rank(\boldsymbol{A})=rank(\boldsymbol{B})&lt;n\)</span></li></ul><p>æ»¡ç§©çŸ©é˜µè§£æœ‰å”¯ä¸€è§£</p></li></ul><h1 id="è¡Œåˆ—å¼">è¡Œåˆ—å¼</h1><h2 id="è¡Œåˆ—å¼å®šä¹‰">è¡Œåˆ—å¼å®šä¹‰</h2><h3 id="äºŒé˜¶è¡Œåˆ—å¼">äºŒé˜¶è¡Œåˆ—å¼</h3><p>å‡è®¾æœ‰äºŒé˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}=\begin{pmatrix}a_{11}&amp;a_{12}\\a_{21}&amp;a_{22}\end{pmatrix}\)</span>ï¼Œé‚£ä¹ˆåˆšæ‰å®šä¹‰çš„è¿ç®—è§„åˆ™ç§°ä¸ºè¯¥äºŒé˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>å¯¹åº”çš„è¡Œåˆ—å¼<span class="math inline">\(|\boldsymbol{A}|\)</span>ï¼Œä¹Ÿç§°ä¸ºäºŒé˜¶è¡Œåˆ—å¼ï¼š</p><p><span class="math display">\[|\boldsymbol{A}|=\begin{vmatrix}a_{11}&amp;a_{12}\\a_{21}&amp;a_{22}\end{vmatrix}=a_{11}a_{22}-a_{12}a_{21}\]</span></p><p>ä¸Šè¿°å®šä¹‰åªè¦æ±‚<span class="math inline">\(\boldsymbol{A}\)</span>æ˜¯æ–¹é˜µï¼Œä¸è¦æ±‚æ˜¯æ»¡ç§©çŸ©é˜µã€‚</p><h3 id="ä¸‰é˜¶è¡Œåˆ—å¼">ä¸‰é˜¶è¡Œåˆ—å¼</h3><p>å‡è®¾æœ‰ä¸‰é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}=\begin{pmatrix}a_{11}&amp;a_{12}&amp;a_{13}\\a_{21}&amp;a_{22}&amp;a_{23}\\a_{31}&amp;a_{32}&amp;a_{33}\end{pmatrix}\)</span>ï¼Œé‚£ä¹ˆåˆšæ‰å®šä¹‰çš„è¿ç®—è§„åˆ™ç§°ä¸ºè¯¥ä¸‰é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>å¯¹åº”çš„è¡Œåˆ—å¼<span class="math inline">\(|\boldsymbol{A}|\)</span>ï¼Œä¹Ÿç§°ä¸ºä¸‰é˜¶è¡Œåˆ—å¼ï¼š</p><p><span class="math display">\[\begin{aligned}    |\boldsymbol{A}|        &amp;=\begin{vmatrix}a_{11}&amp;a_{12}&amp;a_{13}\\a_{21}&amp;a_{22}&amp;a_{23}\\a_{31}&amp;a_{32}&amp;a_{33}\end{vmatrix}\\        &amp;=a_{11}a_{22}a_{33}+a_{12}a_{23}a_{31}+a_{13}a_{21}a_{32}-a_{11}a_{23}a_{32}-a_{12}a_{21}a_{33}-a_{13}a_{22}a_{31}\end{aligned}\]</span></p><p>ä¸Šè¿°å®šä¹‰ä¹Ÿåªè¦æ±‚ã€boldsymbol{A}æ˜¯æ–¹é˜µï¼Œä¸è¦æ±‚æ˜¯æ»¡ç§©çŸ©é˜µã€‚</p><h3 id="å…¨æ’åˆ—">å…¨æ’åˆ—</h3><p>æŠŠ n ä¸ªä¸åŒçš„å…ƒç´ æ’æˆä¸€åˆ—ï¼Œå«åšè¿™ n ä¸ªå…ƒç´ çš„å…¨æ’åˆ—ã€‚</p><h3 id="é€†åºæ•°">é€†åºæ•°</h3><p>åœ¨ä¸€ä¸ªæ’åˆ—ï¼ˆä¹Ÿå°±æ˜¯æ•°åˆ—ï¼‰ä¸­ï¼Œå¦‚æœä¸€å¯¹æ•°çš„å‰åä½ç½®ä¸å¤§å°é¡ºåºç›¸åï¼Œå³å‰é¢çš„æ•°å¤§äºåé¢çš„æ•°ï¼Œé‚£ä¹ˆå®ƒä»¬å°±ç§°ä¸ºä¸€ä¸ªé€†åºã€‚ä¸€ä¸ªæ’åˆ—ä¸­é€†åºçš„æ€»æ•°å°±ç§°ä¸ºè¯¥æ’åˆ—çš„é€†åºæ•°ã€‚é€†åºæ•°ä¸ºå¥‡æ•°çš„æ’åˆ—ç§°ä¸ºå¥‡æ’åˆ—ï¼Œé€†åºæ•°ä¸ºå¶æ•°çš„æ’åˆ—ç§°ä¸ºå¶æ’åˆ—ã€‚</p><h3 id="è¡Œåˆ—å¼å®šä¹‰-1">è¡Œåˆ—å¼å®šä¹‰</h3><p>å¯¹äº<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}=(a_{ij})\)</span>ï¼Œå…¶è¡Œåˆ—å¼å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[    |\boldsymbol{A}|=|a_{ij}|=\begin{vmatrix}        a_{11}&amp;a_{12}&amp;\cdots&amp;a_{1n}\\        a_{21}&amp;a_{22}&amp;\cdots&amp;a_{2n}\\        \vdots&amp;\vdots&amp;\quad&amp;\vdots\\        a_{n1}&amp;a_{n2}&amp;\cdots&amp;a_{nn}    \end{vmatrix}=\sum(-1)^ta_{1p_1}a_{2p_2}\cdots a_{np_n}\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(t\)</span>ä¸ºæ’åˆ—<span class="math inline">\(p_1p_2\cdots p_n\)</span>çš„é€†åºæ•°ï¼Œ<span class="math inline">\(\sum\)</span>è¡¨ç¤ºå¯¹<span class="math inline">\(â€œ1,2,\cdots,nâ€\)</span>çš„å…¨æ’åˆ—<span class="math inline">\(â€œp_1p_2\cdots p_nâ€\)</span>æ±‚å’Œã€‚</p><h2 id="å‘é‡ç§¯">å‘é‡ç§¯</h2><p>å‘é‡ç§¯<span class="math inline">\(\boldsymbol{S}\)</span>æŠ•å½±åˆ°äº†å„ä¸ªå¹³é¢ï¼š</p><p><span class="math display">\[\boldsymbol{S}\xrightarrow{\quad æŠ•å½±ã€quad}\begin{cases}    \boldsymbol{S_{xoy}}\\    \boldsymbol{S_{yoz}}\\    \boldsymbol{S_{zox}}\end{cases}\]</span></p><p>å°†è¿™äº›æŠ•å½±åŠ èµ·æ¥å°±å¾—åˆ°äº†å‘é‡ç§¯<span class="math inline">\(\boldsymbol{S}\)</span>ï¼š</p><p><span class="math display">\[\begin{aligned}    \boldsymbol{S}        &amp;=\boldsymbol{b}\times\boldsymbol{c}\\        \quad\\        &amp;=\boldsymbol{S_{xoy}}+\boldsymbol{S_{yoz}}+\boldsymbol{S_{zox}}\\        \quad\\        &amp;=\begin{vmatrix}b_1&amp;c_1\\b_2&amp;c_2\end{vmatrix}\boldsymbol{e_3}+\begin{vmatrix}b_2&amp;c_2\\b_3&amp;c_3\end{vmatrix}\boldsymbol{e_1}+\begin{vmatrix}b_3&amp;c_3\\b_1&amp;c_1\end{vmatrix}\boldsymbol{e_2}\\        \quad\\        &amp;=\begin{vmatrix}b_2&amp;c_2\\b_3&amp;c_3\end{vmatrix}\boldsymbol{e_1}+\begin{vmatrix}b_3&amp;c_3\\b_1&amp;c_1\end{vmatrix}\boldsymbol{e_2}+\begin{vmatrix}b_1&amp;c_1\\b_2&amp;c_2\end{vmatrix}\boldsymbol{e_3}\end{aligned}\]</span></p><p>ä¸ºäº†æ–¹ä¾¿è®°å¿†ï¼Œä¸Šé¢çš„å¼å­å¾€å¾€å¦‚ä¸‹ä¹¦å†™ï¼Œè¿™å°±æ˜¯å‘é‡ç§¯çš„å®šä¹‰ï¼š <span class="math display">\[\boldsymbol{b}\times\boldsymbol{c}=\begin{vmatrix}b_2&amp;c_2\\b_3&amp;c_3\end{vmatrix}\boldsymbol{e_1}-\begin{vmatrix}b_1&amp;c_1\\b_3&amp;c_3\end{vmatrix}\boldsymbol{e_2}+\begin{vmatrix}b_1&amp;c_1\\b_2&amp;c_2\end{vmatrix}\boldsymbol{e_3}\]</span></p><h2 id="å­å¼å’Œä½™å­å¼">å­å¼å’Œä½™å­å¼</h2><h3 id="å­å¼">å­å¼</h3><p>åœ¨<span class="math inline">\(m\times n\)</span>çŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>ä¸­ï¼Œä»»å– k è¡Œä¸ k åˆ—<span class="math inline">\(ï¼ˆk\le m,k\le nï¼‰\)</span>ï¼Œä½äºè¿™äº›è¡Œã€åˆ—äº¤å‰å¤„çš„<span class="math inline">\(k^2\)</span>ä¸ªå…ƒç´ ï¼Œä¸æ”¹å˜å®ƒä»¬åœ¨<span class="math inline">\(\boldsymbol{A}\)</span>ä¸­æ‰€å¤„çš„ä½ç½®æ¬¡åºè€Œå¾—çš„ k é˜¶è¡Œåˆ—å¼ï¼Œç§°ä¸ºçŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>çš„ k é˜¶å­å¼ï¼ˆMinorï¼‰ã€‚</p><p>è®¾<span class="math inline">\(\boldsymbol{A}\)</span>æ˜¯<span class="math inline">\(m\times n\)</span>çš„çŸ©é˜µï¼Œ<span class="math inline">\(I\)</span>æ˜¯é›†åˆ<span class="math inline">\(\{1,...,m\}\)</span>çš„ä¸€ä¸ª<span class="math inline">\(k\)</span>å…ƒå­é›†ï¼Œ<span class="math inline">\(J\)</span>æ˜¯é›†åˆ<span class="math inline">\(\{1,...,n\}\)</span>çš„ä¸€ä¸ª<span class="math inline">\(k\)</span>å…ƒå­é›†ï¼Œ<span class="math inline">\(|\boldsymbol{A}|_{I,J}\)</span>æ˜¯<span class="math inline">\(\boldsymbol{A}\)</span>çš„<span class="math inline">\(k\)</span>é˜¶å­å¼ï¼Œå…¶ä¸­æŠ½å–çš„ k è¡Œçš„è¡Œå·æ˜¯ I ä¸­æ‰€æœ‰å…ƒç´ ï¼Œ<span class="math inline">\(k\)</span>åˆ—çš„åˆ—å·æ˜¯<span class="math inline">\(J\)</span>ä¸­æ‰€æœ‰å…ƒç´ ã€‚é‚£ä¹ˆï¼š</p><ul><li>å¦‚æœ<span class="math inline">\(I=J\)</span>ï¼Œç§°<span class="math inline">\(|\boldsymbol{A}|_{I,J}ä¸ºã€boldsymbol{A}\)</span>çš„<span class="math inline">\(k\)</span>é˜¶ä¸»å­å¼ï¼ˆPrincipal minorï¼‰ã€‚</li><li>å¦‚æœ<span class="math inline">\(I=J=\{1,\cdots,k\}\)</span>æ‰€å–çš„æ˜¯å·¦èµ·å‰ k åˆ—å’Œä¸Šèµ·å‰<span class="math inline">\(k\)</span>è¡Œï¼‰ï¼Œç§°<span class="math inline">\(|\boldsymbol{A}|_{I,J}\)</span>ä¸º<span class="math inline">\(\boldsymbol{A}\)</span>çš„<span class="math inline">\(k\)</span>é˜¶é¡ºåºä¸»å­å¼ï¼ˆLeading principal minorï¼‰ã€‚</li></ul><p>è®¾åœ¨çŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>ä¸­æœ‰ä¸€ä¸ªä¸ç­‰äº 0 çš„ r é˜¶å­å¼<span class="math inline">\(|\boldsymbol{B}_{r}|\)</span>ï¼Œä¸”æ‰€æœ‰<span class="math inline">\(r+1\)</span>é˜¶å­å¼ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰å…¨ç­‰äº 0ï¼Œé‚£ä¹ˆ<span class="math inline">\(|\boldsymbol{B}_{r}|\)</span>ç§°ä¸ºçŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>çš„æœ€é«˜é˜¶éé›¶å­å¼ï¼Œæ•° r ç§°ä¸ºçŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>çš„ç§©ã€‚ï¼ˆä¸é€‚åˆæ±‚çŸ©é˜µçš„ç§©ï¼Œå¤ªéº»çƒ¦ï¼‰</p><h3 id="ä½™å­å¼">ä½™å­å¼</h3><p>åœ¨ n é˜¶è¡Œåˆ—å¼ä¸­ï¼ŒæŠŠ<span class="math inline">\(a_{ij}\)</span>æ‰€åœ¨çš„ç¬¬ i è¡Œå’Œç¬¬ j åˆ—åˆ’å»åï¼Œç•™ä¸‹æ¥çš„ n-1 é˜¶è¡Œåˆ—å¼å«åš<span class="math inline">\(a_{ij}\)</span>çš„ä½™å­å¼ï¼Œè®°åš<span class="math inline">\(\boldsymbol{M}_{ij}\)</span>.</p><h3 id="ä»£æ•°ä½™å­å¼">ä»£æ•°ä½™å­å¼</h3><p>åœ¨<span class="math inline">\(a_{ij}\)</span>çš„ä½™å­å¼<span class="math inline">\(M_{ij}\)</span>çš„åŸºç¡€ä¸Šï¼Œè¿˜å¯ä»¥å®šä¹‰<span class="math inline">\(A_{ij}\)</span>ï¼Œç§°ä¸º<span class="math inline">\(a_{ij}\)</span>çš„ä»£æ•°ä½™å­å¼ï¼š <span class="math display">\[A_{ij}=(-1)^{i+j}M_{ij}\]</span></p><h3 id="æ€»ç»“">æ€»ç»“</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/math_sub_formula.png"></p><h2 id="è¡Œåˆ—å¼çš„æ€§è´¨">è¡Œåˆ—å¼çš„æ€§è´¨</h2><ul><li><p>è¡Œåˆ—å¼è½¬ç½®ï¼š å¯¹äº n é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}=(a_{ij})\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[  |\boldsymbol{A}|=      \begin{vmatrix}          a_{11}&amp;a_{12}&amp;\cdots&amp;a_{1n}\\          a_{21}&amp;a_{22}&amp;\cdots&amp;a_{2n}\\          \vdots&amp;\vdots&amp;\quad&amp;\vdots\\          a_{n1}&amp;a_{n2}&amp;\cdots&amp;a_{nn}      \end{vmatrix},\quad  |\boldsymbol{A}^\mathrm{T}|=      \begin{vmatrix}          a_{11}&amp;a_{21}&amp;\cdots&amp;a_{n1}\\          a_{12}&amp;a_{22}&amp;\cdots&amp;a_{n2}\\          \vdots&amp;\vdots&amp;\quad&amp;\vdots\\          a_{1n}&amp;a_{2n}&amp;\cdots&amp;a_{nn}      \end{vmatrix}  \]</span></p><p>è¡Œåˆ—å¼<span class="math inline">\(|\boldsymbol{A}^\mathrm{T}|\)</span>ç§°ä¸ºè¡Œåˆ—å¼<span class="math inline">\(|\boldsymbol{A}|\)</span>çš„è½¬ ç½®è¡Œåˆ—å¼ã€‚å¯ä»¥è¯æ˜ï¼š <span class="math display">\[  |\boldsymbol{A}|=|\boldsymbol{A}^\mathrm{T}|  \]</span></p></li><li><p>æ»¡ç§©ã€å¯é€†ä¸è¡Œåˆ—å¼ï¼š å¯¹äºæ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>æœ‰ï¼š <span class="math display">\[  |\boldsymbol{A}|\ne 0\iff \boldsymbol{A}\ æ»¡ç§©ã€iff \boldsymbol{A}\ å¯é€†  \]</span></p></li><li><p>è¡Œåˆ—å¼çš„æ•°ä¹˜ï¼š è¡Œåˆ—å¼ä¹˜ä»¥ k å€ï¼Œç­‰äºæŸè¡Œï¼ˆåˆ—ï¼‰ä¹˜ä»¥ kï¼Œè¯¥æ€§è´¨ä¹Ÿå¯ä»¥ç§°ä¸ºè¡Œåˆ—å¼çš„æ•°ä¹˜ï¼š <span class="math display">\[{\color {blue}k}\begin{vmatrix}  a_{11}&amp;a_{12}&amp;\dots &amp;a_{1n}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots\\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix}=\begin{vmatrix}  a_{11}&amp;a_{12}&amp;\dots&amp;a_{1n}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots\\  {\color {blue}k}a_{i1}&amp;{\color{blue}k}a_{i2}&amp;\dots&amp;{\color{blue}k}a_{in}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots \\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix}=\begin{vmatrix}  a_{11}&amp;\dots&amp;{\color {blue}k}a_{1j}&amp;\dots &amp;a_{1n}\\  \vdots &amp;\dots&amp;{\color {blue}k}a_{2j} &amp;\dots &amp;\vdots \\  \vdots &amp;\ddots&amp;\vdots&amp;\ddots &amp;\vdots   \\a_{n1}&amp;\dots&amp;{\color {blue}k}a_{nj}&amp;\dots &amp;a_{nn}\end{vmatrix}  \]</span></p></li><li><p>è¡Œæˆ–åˆ—äº’æ¢ï¼š è¡Œåˆ—å¼ä¸­çš„è¡Œï¼ˆåˆ—ï¼‰äº’æ¢åï¼Œè¡Œåˆ—å¼æ­£è´Ÿå·å‘ç”Ÿæ”¹å˜ï¼š <span class="math display">\[\begin{vmatrix}  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\  {\color{blue}{a_{i1}}}&amp;{\color{blue}{a_{i2}}}&amp;\dots&amp;{\color{blue}{a_{in}}}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\  {\color{ForestGreen}{a_{j1}}}&amp;{\color{ForestGreen}{a_{j2}}}&amp;\dots&amp;{\color{ForestGreen}{a_{jn}}}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\\end{vmatrix}=-\begin{vmatrix}  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\  {\color{ForestGreen}{a_{j1}}}&amp;{\color{ForestGreen}{a_{j2}}}&amp;\dots&amp;{\color{ForestGreen}{a_{jn}}}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\  {\color{blue}{a_{i1}}}&amp;{\color{blue}{a_{i2}}}&amp;\dots&amp;{\color{blue}{a_{in}}}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\\end{vmatrix}\]</span></p></li><li><p>è¡Œåˆ—å¼çš„å€åŠ ï¼š å°†ä¸€è¡Œï¼ˆåˆ—ï¼‰çš„ k å€åŠ è¿›å¦ä¸€è¡Œï¼ˆåˆ—ï¼‰é‡Œï¼Œè¡Œåˆ—å¼çš„å€¼ä¸å˜ï¼Œè¯¥æ€§è´¨ä¹Ÿå¯ä»¥ç§°ä¸ºè¡Œåˆ—å¼çš„å€åŠ ï¼š <span class="math display">\[  \begin{vmatrix}  \vdots &amp;\vdots &amp;\vdots &amp;\vdots \\  a_{i1}&amp;a_{i2}&amp;\dots &amp;a_{in}\\  a_{j1}&amp;a_{j2}&amp;\dots &amp;a_{jn}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots\end{vmatrix}=\begin{vmatrix}  \vdots &amp;\vdots &amp;\vdots &amp;\vdots\\  a_{i1}&amp;a_{i2}&amp;\dots &amp;a_{in}\\  a_{j1}{\color{blue}{+ka_{i1}}}&amp;a_{j2}{\color{blue}{+ka_{i2}}}&amp;\dots&amp;a_{jn}{\color{blue}{+ka_{in}}}\\  \vdots &amp;\vdots &amp;\vdots &amp;\vdots\end{vmatrix}\]</span></p></li><li><p>è¡Œåˆ—å¼çš„åŠ æ³•ï¼š åœ¨è¡Œåˆ—å¼ä¸­ï¼ŒæŸä¸€è¡Œï¼ˆåˆ—ï¼‰çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸¤æ•°ä¹‹å’Œï¼Œåˆ™æ­¤è¡Œåˆ—å¼å¯æ‹†åˆ†ä¸ºä¸¤ä¸ªç›¸åŠ çš„è¡Œåˆ—å¼ï¼Œè¯¥æ€§è´¨ä¹Ÿå¯ä»¥ç§°ä¸ºè¡Œåˆ—å¼çš„åŠ æ³•ï¼š <span class="math display">\[ \begin{vmatrix}  a_{11}&amp;a_{12}&amp;\dots &amp;a_{1n}\\  \vdots &amp;\vdots &amp;\dots &amp;\vdots\\  {\color{blue}{a_{i1}}}+{\color{ForestGreen}{b_{i1}}}&amp;{\color{blue}a_{i2}}+{\color{ForestGreen}{b_{i2}}}&amp;\dots&amp;{\color{blue}{a_{in}}}+{\color{ForestGreen}{b_{in}}}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots\\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix} =\begin{vmatrix}  a_{11}&amp;a_{12}&amp;\dots &amp;a_{1n}\\  \vdots &amp;\vdots &amp;\dots &amp;\vdots\\  {\color{blue}{a_{i1}}}&amp;{\color{blue}{a_{i2}}}&amp;\dots&amp;{\color{blue}{a_{in}}}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots\\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix} +\begin{vmatrix}  a_{11}&amp;a_{12}&amp;\dots &amp;a_{1n}\\  \vdots &amp;\vdots &amp;\dots &amp;\vdots   \\{\color{ForestGreen}{b_{i1}}}&amp;{\color{ForestGreen}{b_{i2}}}&amp;\dots &amp;{\color{ForestGreen}{b_{in}}}\\  \vdots &amp;\vdots &amp;\ddots &amp;\vdots\\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix}  \]</span></p></li><li><p>è¡Œåˆ—å¼çš„ä¹˜æ³•ï¼š å¯¹äºåŒé˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A},\boldsymbol{B}\)</span>ï¼Œæœ‰ï¼š <span class="math display">\[  |\boldsymbol{A}\boldsymbol{B}|=|\boldsymbol{A}||\boldsymbol{B}|  \]</span> è¯¥æ€§è´¨åˆç§°ä¸ºè¡Œåˆ—å¼çš„ä¹˜æ³•ã€‚</p></li><li><p>ä¸‰è§’è¡Œåˆ—å¼çš„è®¡ç®—æ³•ï¼š <span class="math display">\[|\boldsymbol{A}|=\begin{vmatrix}  a_{11}&amp;&amp;&amp;\\  a_{21}&amp;a_{22}&amp;&amp;0\\  \vdots &amp;\vdots &amp;\ddots &amp;\\  a_{n1}&amp;a_{n2}&amp;\dots &amp;a_{nn}\end{vmatrix}= a_{11}a_{22}\cdots a_{nn}\]</span></p></li><li><p>ä¸‰è§’åˆ†å—è¡Œåˆ—å¼çš„è®¡ç®—æ³•ï¼š è®¾æœ‰åˆ†å—çŸ©é˜µï¼š <span class="math display">\[  \boldsymbol{A}=\begin{pmatrix}\boldsymbol{B}&amp;\boldsymbol{O}\\\boldsymbol{C}&amp;\boldsymbol{D}\end{pmatrix}  \]</span> åˆ™æœ‰ï¼š <span class="math display">\[  |\boldsymbol{A}|=|\boldsymbol{B}||\boldsymbol{D}|  \]</span> è¯¥æ€§è´¨ä¹Ÿç§°ä¸ºä¸‰è§’åˆ†å—è¡Œåˆ—å¼çš„è®¡ç®—æ³•ã€‚</p></li><li><p>æ‹‰æ™®æ‹‰æ–¯å±•å¼€ï¼š n é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}=(a_{ij})\)</span>çš„è¡Œåˆ—å¼å¯ä»¥è¡¨ç¤ºæˆå…³äºè¯¥æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>çš„æŸä¸€è¡Œçš„å„å…ƒç´ ä¸å…¶å¯¹åº”çš„ä»£æ•°ä½™å­å¼ä¹˜ç§¯ä¹‹å’Œï¼Œå³ï¼š <span class="math display">\[  |\boldsymbol{A}|=a_{i1}A_{i1}+a_{i2}A_{i2}+...+a_{in}A_{in}\quad (i=1,2,...,n)  \]</span> æˆ–è¡¨ç¤ºæˆå…³äºè¯¥æ–¹é˜µ A çš„æŸä¸€åˆ—çš„å„å…ƒç´ ä¸å…¶å¯¹åº”çš„ä»£æ•°ä½™å­å¼ä¹˜ç§¯ä¹‹å’Œï¼š <span class="math display">\[  |\boldsymbol{A}|=a_{1j}A_{1j}+a_{2j}A_{2j}+...+a_{nj}A_{nj}\quad (j=1,2,...,n)  \]</span> è¿™ç§è®¡ç®—è¡Œåˆ—å¼çš„æ–¹æ³•ç§°ä¸ºæ‹‰æ™®æ‹‰æ–¯å±•å¼€ï¼ˆLaplace expansionï¼‰ã€‚</p></li></ul><h2 id="å…‹æ‹‰é»˜æ³•åˆ™">å…‹æ‹‰é»˜æ³•åˆ™</h2><p>æœ‰ n ä¸ªæœªçŸ¥æ•°ï¼Œn ä¸ªæ–¹ç¨‹æ‰€ç»„æˆçš„çº¿æ€§æ–¹ç¨‹ç»„ï¼Œå®ƒçš„ç³»æ•°çŸ©é˜µæ˜¯ n é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>ã€‚å¦‚æœå¯¹åº”çš„è¡Œåˆ—å¼<span class="math inline">\(|\boldsymbol{A}|\)</span>ä¸ç­‰äº 0ï¼Œå³ï¼š</p><p><span class="math display">\[|\boldsymbol{A}|=\begin{vmatrix}a_{11}&amp;\cdots&amp;a_{1n}\\\vdots&amp;&amp;\vdots\\a_{n1}&amp;\cdots&amp;a_{nn}\end{vmatrix}\neq 0\]</span></p><p>åˆ™æ–¹ç¨‹ç»„æœ‰å”¯ä¸€è§£ï¼Œå¹¶ä¸”è§£ä¸ºï¼š</p><p><span class="math display">\[\displaystyle x_1=\frac{|\boldsymbol{A}_1|}{|\boldsymbol{A}|},\quad     x_2=\frac{|\boldsymbol{A}_2|}{|\boldsymbol{A}|},\quad...,\quad x_n=\frac{|\boldsymbol{A}_n|}{|\boldsymbol{A}|}\]</span></p><p>å…¶ä¸­<span class="math inline">\(\boldsymbol{A}_j(j=1,2,...,n)\)</span>æ˜¯æŠŠç³»æ•°çŸ©é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>ä¸­ç¬¬ j åˆ—çš„å…ƒç´ ç”¨æ–¹ç¨‹ç»„å³ç«¯çš„å¸¸æ•°é¡¹ä»£æ›¿åæ‰€å¾—åˆ°çš„ n é˜¶çŸ©é˜µï¼Œå³ï¼š</p><p><span class="math display">\[\boldsymbol{A}_j=\begin{pmatrix}    a_{11}&amp;\cdots&amp;a_{1,j-1}&amp;{\color{red}{b_1}}&amp;a_{1,j+1}&amp;\cdots&amp;a_{1n}\\    \vdots&amp;&amp;\vdots&amp;{\color{red}{\vdots}}&amp;\vdots&amp;&amp;\vdots\\    a_{n1}&amp;\cdots&amp;a_{n,j-1}&amp;{\color{red}{b_n}}&amp;a_{n,j+1}&amp;\cdots&amp;a_{nn}    \end{pmatrix}\]</span></p><p>è¿™å°±æ˜¯å…‹æ‹‰é»˜æ³•åˆ™ï¼ˆCramer's Ruleï¼‰ï¼Œä¹Ÿç§°ä¸ºå…‹è±å§†æ³•åˆ™ã€‚</p><h1 id="ç›¸ä¼¼çŸ©é˜µ">ç›¸ä¼¼çŸ©é˜µ</h1><h2 id="åŸºå˜æ¢">åŸºå˜æ¢</h2><p>å·²çŸ¥ä¸¤ä¸ªåŸº<span class="math inline">\(\boldsymbol{m_1},\boldsymbol{m_2},\ldots,\boldsymbol{m_s}\)</span>ä»¥åŠ<span class="math inline">\(\boldsymbol{n_1},\boldsymbol{n_2},\ldots,\boldsymbol{n_s}\)</span>ï¼Œå½“ä¸”ä»…å½“å®ƒä»¬æ˜¯åŒä¸€ä¸ªå‘é‡ç©ºé—´çš„åŸºæ—¶ï¼Œé‚£ä¹ˆå­˜åœ¨å”¯ä¸€çš„çŸ©é˜µ Pï¼Œä½¿å¾—ä¸‹å¼æˆç«‹ï¼š <span class="math display">\[(\boldsymbol{n_1},\boldsymbol{n_2},\ldots,\boldsymbol{n_s})=(\boldsymbol{m_1},\boldsymbol{m_2},\ldots,\boldsymbol{m_s})P\]</span> è¯¥çŸ©é˜µ P ç§°ä¸ºç”±åŸº<span class="math inline">\(\boldsymbol{m_1},\boldsymbol{m_2},\ldots,\boldsymbol{m}_s\)</span>åˆ°åŸº<span class="math inline">\(\boldsymbol{n_1},\boldsymbol{n_2},\ldots,\boldsymbol{n_s}\)</span>çš„è¿‡æ¸¡çŸ©é˜µï¼ˆTransition matrixï¼‰ï¼Œè€Œä¸Šè¿°å…¬å¼ç§°ä¸ºåŸºå˜æ¢å…¬å¼ï¼ˆChange of basis formulaï¼‰ã€‚</p><p>è¿‡æ¸¡çŸ©é˜µæ˜¯æ»¡ç§©çŸ©é˜µã€‚</p><h2 id="åæ ‡å˜æ¢">åæ ‡å˜æ¢</h2><p>å·²çŸ¥<span class="math inline">\(P\)</span>ä¸ºç”±åŸº<span class="math inline">\(\mathcal{M}=\{\boldsymbol{m_1},\boldsymbol{m_2},\ldots,\boldsymbol{m}_s\}\)</span>åˆ°åŸº<span class="math inline">\(\mathcal{N}=\{\boldsymbol{n_1},\boldsymbol{n_2},\ldots,\boldsymbol{n_s}\}\)</span>çš„è¿‡æ¸¡çŸ©é˜µï¼š</p><p><span class="math display">\[(\boldsymbol{n_1},\boldsymbol{n_2},\ldots,\boldsymbol{n_s})=(\boldsymbol{m_1},\boldsymbol{m_2},\ldots,\boldsymbol{m_s})P\]</span></p><p>åˆçŸ¥å‘é‡<span class="math inline">\(\boldsymbol{x}åœ¨åŸºã€mathcal{M}\)</span>ä¸‹çš„åæ ‡ä¸º<span class="math inline">\([\boldsymbol{x}]_\mathcal{M}\)</span>ä»¥åŠåœ¨åŸº<span class="math inline">\(\mathcal{N}\)</span>ä¸‹çš„åæ ‡ä¸º<span class="math inline">\([\boldsymbol{x}]_\mathcal{N}\)</span>ï¼Œåˆ™æœ‰åæ ‡å˜æ¢å…¬å¼ï¼ˆChange of coordinates formulaï¼‰ï¼š</p><p><span class="math display">\[[\boldsymbol{x}]_\mathcal{N}=P^{-1}[\boldsymbol{x}]_\mathcal{M},\quad [\boldsymbol{x}]_\mathcal{M}=P[\boldsymbol{x}]_\mathcal{N}\]</span></p><p>åŸºå˜æ¢å’Œåæ ‡å˜æ¢çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…æ˜¯å³ä¹˜è¿‡æ¸¡çŸ©é˜µ<span class="math inline">\(P\)</span>ï¼Œåè€…æ˜¯å·¦ä¹˜<span class="math inline">\(P^{-1}\)</span>ï¼š</p><h2 id="ç›¸ä¼¼çŸ©é˜µ-1">ç›¸ä¼¼çŸ©é˜µ</h2><p>è®¾<span class="math inline">\(A,B\)</span>éƒ½æ˜¯<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µï¼Œè‹¥æœ‰å¯é€†çŸ©é˜µ<span class="math inline">\(P\)</span>ï¼Œä½¿å¾—ï¼š</p><p><span class="math display">\[B=P^{-1}AP\]</span></p><p>åˆ™ç§° P ä¸ºç›¸ä¼¼å˜æ¢çŸ©é˜µï¼ˆSimilarity transformation matrixï¼‰ï¼Œç§° B æ˜¯ A çš„ç›¸ä¼¼çŸ©é˜µï¼ˆSimilar matrixï¼‰ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[A\simeq B\]</span></p><p>ç›¸ä¼¼çŸ©é˜µå…¶å®å°±æ˜¯æ”¹å˜çŸ©é˜µå‡½æ•°çš„åŸº</p><h2 id="ç›¸ä¼¼çŸ©é˜µçš„æ€§è´¨">ç›¸ä¼¼çŸ©é˜µçš„æ€§è´¨</h2><p>è‹¥<span class="math inline">\(A\simeq B\)</span>ï¼Œåˆ™ï¼š</p><p><span class="math display">\[A^k\simeq B^k,\quad k\in\mathbb{Z}^+\]</span></p><p><span class="math display">\[A^\mathrm{T}\simeq B^\mathrm{T}\]</span></p><p>è‹¥<span class="math inline">\(A\simeq B\)</span>ï¼Œä¸”<span class="math inline">\(Aã€B\)</span>å¯é€†ï¼Œåˆ™ï¼š</p><p><span class="math display">\[A^{-1}\simeq B^{-1}\]</span></p><p><span class="math display">\[A^*\simeq B^*\]</span></p><p>è‹¥<span class="math inline">\(A\simeq Bï¼ŒB\simeq C\)</span>ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[A\simeq C\]</span></p><h1 id="ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡">ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡</h1><h2 id="ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡-1">ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡</h2><h3 id="å®šä¹‰">å®šä¹‰</h3><p>è®¾ A æ˜¯ n é˜¶æ–¹é˜µï¼Œ<span class="math inline">\(\boldsymbol{x}\)</span>ä¸ºéé›¶å‘é‡ï¼Œè‹¥å­˜åœ¨æ•°<span class="math inline">\(\lambda\)</span>ä½¿å¾—ä¸‹å¼æˆç«‹ï¼š</p><p><span class="math display">\[A\boldsymbol{x}=\lambda\boldsymbol{x}\]</span></p><p>é‚£ä¹ˆå°†æ•°<span class="math inline">\(\lambda\)</span>ç§°ä¸º A çš„ç‰¹å¾å€¼ï¼ˆEigenvalueï¼‰ï¼Œéé›¶å‘é‡<span class="math inline">\(\boldsymbol{x}\)</span>ç§°ä¸º<span class="math inline">\(A\)</span>çš„å¯¹åº”äº<span class="math inline">\(\lambda\)</span>çš„ç‰¹å¾å‘é‡ï¼ˆEigenvectorï¼‰ã€‚</p><h3 id="æ±‚è§£">æ±‚è§£</h3><p>æ±‚è§£æ­¥éª¤è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡è§£ä¸‹åˆ—æ–¹ç¨‹ç»„æ¥æ±‚å‡ºç‰¹å¾å€¼å’Œç‰¹å¾å‘é‡ï¼š</p><p><span class="math display">\[\begin{cases}|A-\lambda I| = 0\\\\(A-\lambda I)\boldsymbol{x} = \boldsymbol{0} \end{cases}\Longrightarrow \begin{cases}\lambda = ? \\\\ \boldsymbol{x} = ?\end{cases}\]</span></p><p>æ›´å…·ä½“çš„æ­¥éª¤æ˜¯ï¼Œå…ˆé€šè¿‡ç¬¬ä¸€ä¸ªå¼å­æ±‚å‡ºç‰¹å¾å€¼ï¼š</p><p><span class="math display">\[|A-\lambda I| = 0\implies \lambda_1,\lambda_2,\cdots,\lambda_i,\cdots\lambda_n\]</span></p><p>ç„¶åå°†ã€lambda_i ä»£å…¥ (A-I)=æ±‚å‡ºè¯¥çº¿æ€§æ–¹ç¨‹ç»„çš„è§£é›†ï¼š</p><p><span class="math display">\[(A-\lambda_i I)\boldsymbol{x}=\boldsymbol{0}\implies \boldsymbol{x}=?\]</span></p><p>è¯¥è§£é›†å¿…ç„¶ä¸ºå‘é‡ç©ºé—´ï¼Œå› ä¸ºå…¶ä¸­éƒ½æ˜¯ç‰¹å¾å€¼ä¸ºã€lambda_i çš„ç‰¹å¾å‘é‡ï¼ˆé›¶å‘é‡é™¤å¤–ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºç‰¹å¾å€¼ä¸º<span class="math inline">\(\lambda_i\)</span>çš„ç‰¹å¾ç©ºé—´ï¼ˆEigenspaceï¼‰ã€‚</p><h3 id="ç‰¹å¾å¤šé¡¹å¼ä¸ç‰¹å¾æ–¹ç¨‹">ç‰¹å¾å¤šé¡¹å¼ä¸ç‰¹å¾æ–¹ç¨‹</h3><p>å‡è®¾ï¼š <span class="math display">\[A=\begin{pmatrix}a_{11}&amp; a_{12} &amp; \cdots &amp; a_{1 n} \\ a_{21} &amp; a_{22}&amp; \cdots &amp; a_{2 n} \\ \vdots &amp; \vdots &amp; &amp; \vdots \\ a_{n 1} &amp; a_{n 2} &amp; \cdots &amp; a_{n n}\end{pmatrix}\]</span></p><p>é‚£ä¹ˆ<span class="math inline">\(|A-\lambda I| = 0\)</span>å¯ä»¥å†™ä½œï¼š</p><p><span class="math display">\[|A-\lambda I|=\begin{vmatrix}    a_{11}-\lambda &amp; a_{12} &amp; \cdots &amp; a_{1 n} \\ a_{21} &amp; a_{22}-\lambda &amp; \cdots &amp; a_{2 n} \\ \vdots &amp; \vdots &amp; &amp; \vdots \\ a_{n 1} &amp; a_{n 2} &amp; \cdots &amp; a_{n n}-\lambda\end{vmatrix}=0\]</span></p><p>å…¶ä¸­<span class="math inline">\(|A-\lambda I|\)</span>å±•å¼€åå°±æ˜¯å…³äºç‰¹å¾å€¼<span class="math inline">\(\lambda\)</span>çš„å¤šé¡¹å¼ï¼Œæ‰€ä»¥ç§°ä¸ºç‰¹å¾å¤šé¡¹å¼ï¼ˆCharacteristic polynomialï¼‰ï¼š</p><p><span class="math display">\[\underbrace{\left|\begin{array}{cccc}a_{11}-\lambda &amp; a_{12} &amp; \cdots &amp; a_{1 n} \\ a_{21} &amp; a_{22}-\lambda &amp; \cdots &amp; a_{2 n} \\ \vdots &amp; \vdots &amp; &amp; \vdots \\ a_{n 1} &amp; a_{n 2} &amp; \cdots &amp; a_{n n}-\lambda\end{array}\right|}_{|A-\lambda I|}=c_0\lambda^{n}+c_1\lambda^{n-1}+\cdots+c_n\]</span></p><p>è¿›è€Œ<span class="math inline">\(|A-\lambda I| = 0\)</span>è¢«ç§°ä¸ºç‰¹å¾æ–¹ç¨‹ï¼ˆCharacteristic equationï¼‰ã€‚</p><p>å·²çŸ¥<span class="math inline">\(\lambda_1,\lambda_2,\cdots,\lambda_m\)</span>æ˜¯<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(A\)</span>ç›¸å¼‚çš„ç‰¹å¾å€¼ï¼Œä»¥åŠ<span class="math inline">\(\boldsymbol{v}_1,\boldsymbol{v}_2,\cdots,\boldsymbol{v}_m\)</span>æ˜¯<span class="math inline">\(\lambda_1,\lambda_2,\cdots,\lambda_m\)</span>å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼Œåˆ™å‘é‡ç»„<span class="math inline">\(\{\boldsymbol{v}_1,\boldsymbol{v}_2,\cdots,\boldsymbol{v}_m\}\)</span>çº¿æ€§æ— å…³ã€‚</p><p>ä¸åŒç‰¹å¾å€¼çš„ç‰¹å¾å‘é‡æ˜¯çº¿æ€§æ— å…³çš„ã€‚</p><h2 id="å¯¹è§’åŒ–">å¯¹è§’åŒ–</h2><p>å¦‚æœ<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(A\)</span>æœ‰<span class="math inline">\(n\)</span>ä¸ªçº¿æ€§æ— å…³çš„ç‰¹å¾å‘é‡<span class="math inline">\(\boldsymbol{p_1},\boldsymbol{p_2},\cdots,\boldsymbol{p_n}\)</span>ï¼Œé‚£ä¹ˆå¦‚ä¸‹çŸ©é˜µï¼š</p><p><span class="math display">\[P=(\boldsymbol{p_1},\boldsymbol{p_2},\cdots,\boldsymbol{p_n})\]</span></p><p>å¯ä»¥ä½¿å¾—ï¼š</p><p><span class="math display">\[A=P\Lambda P^{-1}\]</span></p><p>å…¶ä¸­<span class="math inline">\(\Lambda\)</span>ä¸ºå¦‚ä¸‹å¯¹è§’é˜µ</p><p><span class="math display">\[\Lambda=\left(\begin{array}{llll}\lambda_{1} &amp; &amp; &amp; \\ &amp; \lambda_{2} &amp; &amp; \\ &amp; &amp; \ddots &amp; \\ &amp; &amp; &amp; \lambda_{n}\end{array}\right)\]</span></p><p>å…¶ä¸­çš„<span class="math inline">\(\lambda_1,\lambda_2,\cdots,\lambda_n\)</span>ä¸ºç‰¹å¾å‘é‡<span class="math inline">\(\boldsymbol{p_1},\boldsymbol{p_2},\cdots,\boldsymbol{p_n}\)</span>å¯¹åº”çš„ç‰¹å¾å€¼ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºå¯¹è§’åŒ–ï¼ˆDiagonalizableï¼‰ã€‚</p><h2 id="æ­£äº¤çŸ©é˜µ">æ­£äº¤çŸ©é˜µ</h2><p>å·²çŸ¥<span class="math inline">\(\boldsymbol{p}_1,\boldsymbol{p}_2,\cdots,\boldsymbol{p}_r\)</span>æ˜¯å‘é‡ç©ºé—´<span class="math inline">\(V\)</span>çš„ä¸€ä¸ªåŸºï¼Œå¦‚æœä¸¤ä¸¤æ­£äº¤ï¼Œå³æ»¡è¶³ï¼š</p><p><span class="math display">\[\boldsymbol{p}_i\cdot\boldsymbol{p}_j=0,\quad i\ne j\]</span></p><p>é‚£ä¹ˆç§°å…¶ä¸ºæ­£äº¤åŸºï¼ˆOrthogonal basisï¼‰ã€‚å¦‚æœè¿˜æ»¡è¶³é•¿åº¦å‡ä¸º 1ï¼Œå³ï¼š</p><p><span class="math display">\[\boldsymbol{p}_1\cdot\boldsymbol{p}_1=\boldsymbol{p}_2\cdot\boldsymbol{p}_2=\cdots=\boldsymbol{p}_r\cdot\boldsymbol{p}_r=1\]</span></p><p>é‚£ä¹ˆï¼Œå°±ç§°ä¸ºæ ‡å‡†æ­£äº¤åŸºï¼ˆOrthonormal basisï¼‰ã€‚</p><p>å‡è®¾<span class="math inline">\(\boldsymbol{p}_1,\boldsymbol{p}_2,\cdots,\boldsymbol{p}_n\)</span>æ˜¯å‘é‡ç©ºé—´<span class="math inline">\(\mathbb{R}^n\)</span>çš„ä¸€ä¸ªæ ‡å‡†æ­£äº¤åŸºï¼Œé‚£ä¹ˆç”±å®ƒä»¬æ„é€ çš„<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(P\)</span>ä¹Ÿç§°ä¸ºæ­£äº¤çŸ©é˜µï¼ˆOrthogonal Matrixï¼‰ï¼š</p><p><span class="math display">\[P=(\boldsymbol{p}_1,\boldsymbol{p_2},\cdots,\boldsymbol{p}_n)\]</span></p><p>è¯¥æ–¹é˜µ P å¿…ç„¶æ»¡è¶³ï¼š</p><p><span class="math display">\[P^\mathrm{T}P=P^{-1}P=I\]</span></p><p>å³<span class="math inline">\(P^\mathrm{T}\)</span>å°±æ˜¯<span class="math inline">\(P\)</span>çš„é€†çŸ©é˜µã€‚</p><h2 id="æ–½å¯†ç‰¹æ­£äº¤åŒ–">æ–½å¯†ç‰¹æ­£äº¤åŒ–</h2><p>å¦‚æœ<span class="math inline">\(\boldsymbol{x}_1,\boldsymbol{x_2},\cdots\boldsymbol{x_n}\)</span>æ˜¯æŸå‘é‡ç©ºé—´çš„åŸºï¼Œé‚£ä¹ˆé€šè¿‡ä¸‹è¿°æ–¹æ³•å°±å¯ä»¥æ‰¾åˆ°è¯¥å‘é‡ç©ºé—´çš„æ­£äº¤åŸº<span class="math inline">\(\boldsymbol{v}_1,\boldsymbol{v_2},\cdots\boldsymbol{v_n}\)</span>ï¼Œè¯¥æ–¹æ³•è¢«ç§°ä¸ºæ–½å¯†ç‰¹æ­£äº¤åŒ–ï¼ˆGramâ€“Schmidt processï¼‰ï¼š</p><p><span class="math display">\[\boldsymbol{x_1},\cdots,\boldsymbol{x_n}\xrightarrow{\quad\text{æ–½å¯†ç‰¹æ­£äº¤åŒ–}\quad}\begin{cases}    \boldsymbol{v_1}=\boldsymbol{x_1}\\    \quad\\    \boldsymbol{v_2}=\boldsymbol{x_2}-\frac{\boldsymbol{x_2}\cdot\boldsymbol{v_1}}{\boldsymbol{v_1}\cdot\boldsymbol{v_1}}\boldsymbol{v_1}\\    \quad\\    \boldsymbol{v_3}=\boldsymbol{x_3}-\frac{\boldsymbol{x_3}\cdot\boldsymbol{v_1}}{\boldsymbol{v_1}\cdot\boldsymbol{v_1}}\boldsymbol{v_1}-\frac{\boldsymbol{x_3}\cdot\boldsymbol{v_2}}{\boldsymbol{v_2}\cdot\boldsymbol{v_2}}\boldsymbol{v_2}\\    \quad\\    \qquad\qquad\vdots\\    \\    \boldsymbol{v_n}=\boldsymbol{x_n}-\frac{\boldsymbol{x_n}\cdot\boldsymbol{v_1}}{\boldsymbol{v_1}\cdot\boldsymbol{v_1}}\boldsymbol{v_1}-\cdots-\frac{\boldsymbol{x_n}\cdot\boldsymbol{v_{n-1}}}{\boldsymbol{v_{n-1}}\cdot\boldsymbol{v_{n-1}}}\boldsymbol{v_{n-1}}\end{cases}\]</span></p><h2 id="æ­£äº¤å¯¹è§’åŒ–">æ­£äº¤å¯¹è§’åŒ–</h2><p>å¦‚æœçŸ©é˜µ<span class="math inline">\(A\)</span>æ˜¯å¯¹ç§°é˜µï¼Œä¸”å…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å®æ•°ï¼Œé‚£ä¹ˆç§°ä¹‹ä¸ºå®å¯¹ç§°é˜µï¼ˆReal symmetric matricesï¼‰ã€‚æ­¤æ—¶æœ‰å¦‚ä¸‹æ€§è´¨ï¼š</p><p>è‹¥<span class="math inline">\(\lambda_1,\lambda_2\)</span>æ˜¯å®å¯¹ç§°é˜µ A ç›¸å¼‚çš„ç‰¹å¾å€¼ï¼Œ<span class="math inline">\(\boldsymbol{p}_1,\boldsymbol{p}_2\)</span>æ˜¯<span class="math inline">\(\lambda_1,\lambda_2\)</span>å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼Œåˆ™æœ‰<span class="math inline">\(\boldsymbol{p}_1\)</span>ä¸<span class="math inline">\(\boldsymbol{p}_2\)</span>æ­£äº¤ï¼Œå³ï¼š</p><p><span class="math display">\[\boldsymbol{p_1}\cdot\boldsymbol{p_2}=0\]</span></p><p>å¯¹äº<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(A\)</span>ï¼Œå¦‚æœå­˜åœ¨æ­£äº¤çŸ©é˜µ<span class="math inline">\(P\)</span>å’Œå¯¹è§’é˜µ<span class="math inline">\(\Lambda\)</span>ä½¿å¾—ï¼š</p><p><span class="math display">\[A=P\Lambda P^{-1}=P\Lambda P^\mathrm{T}\]</span></p><p>é‚£ä¹ˆå°±ç§°è¯¥æ–¹é˜µ<span class="math inline">\(A\)</span>å¯æ­£äº¤å¯¹è§’åŒ–ï¼ˆOrthogonal diagonalizableï¼‰ã€‚</p><p>æ­£äº¤å¯¹è§’åŒ–æ˜¯å¯¹è§’åŒ–çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œè¿™é‡Œè¿›è¡Œä¸€ä¸‹å¯¹æ¯”ï¼š</p><ul><li>n é˜¶æ–¹é˜µ A å¯å¯¹è§’åŒ–ï¼Œå½“ä¸”ä»…å½“æœ‰ n ä¸ªçº¿æ€§æ— å…³çš„ç‰¹å¾å‘é‡</li><li>n é˜¶æ–¹é˜µ A å¯æ­£äº¤å¯¹è§’åŒ–ï¼Œå½“ä¸”ä»…å½“æœ‰ n ä¸ªæ­£äº¤çš„ç‰¹å¾å‘é‡ï¼Œæ­¤æ—¶è¿™ n ä¸ªç‰¹å¾å‘é‡å¿…ç„¶ä¹Ÿçº¿æ€§æ— å…³</li></ul><p>å¯ä»¥è¯æ˜ A å¯æ­£äº¤å¯¹è§’åŒ–çš„å……è¦æ¡ä»¶æ˜¯ A ä¸ºå¯¹ç§°é˜µï¼Œå³ï¼š <span class="math display">\[A\ å¯æ­£äº¤å¯¹è§’åŒ–ã€iff A\ æ˜¯å¯¹ç§°é˜µ\]</span></p><h2 id="ç›¸ä¼¼çŸ©é˜µä¸­çš„ä¸å˜é‡">ç›¸ä¼¼çŸ©é˜µä¸­çš„ä¸å˜é‡</h2><p>å¦‚æœ A å’Œ B æ˜¯ç›¸ä¼¼çŸ©é˜µï¼Œé‚£ä¹ˆä¸¤è€…çš„ç‰¹å¾å€¼ç›¸åŒï¼š</p><p><span class="math display">\[A\simeq B\implies A,B çš„ç‰¹å¾å€¼ç›¸åŒ\]</span></p><p>å¦‚æœ<span class="math inline">\(\boldsymbol{A}\)</span>å’Œ<span class="math inline">\(\boldsymbol{B}\)</span>æ˜¯ç›¸ä¼¼çŸ©é˜µï¼Œé‚£ä¹ˆä¸¤è€…çš„è¡Œåˆ—å¼ç›¸åŒï¼š</p><p><span class="math display">\[\boldsymbol{A}\simeq \boldsymbol{B}\implies |\boldsymbol{A}|=|\boldsymbol{B}|\]</span></p><p>å¯¹äº<span class="math inline">\(n\)</span>é˜¶æ–¹é˜µ<span class="math inline">\(\boldsymbol{A}\)</span>ï¼Œå…¶ä¸»å¯¹è§’çº¿ï¼ˆä»å·¦ä¸Šæ–¹è‡³å³ä¸‹æ–¹çš„å¯¹è§’çº¿ï¼‰çš„å…ƒç´ ä¹‹å’Œç§°ä¸ºè¿¹ï¼ˆTraceï¼‰ï¼Œè®°ä½œ<span class="math inline">\(tr(\boldsymbol{A})\)</span>ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/math_trace.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé©¬åŒå­¦çš„çº¿æ€§ä»£æ•°ã€‹<br>æ„Ÿå…´è¶£çš„å¯ä»¥è´­ä¹°ä»–çš„è¯¾ç¨‹ï¼Œå†™çš„å¾ˆå¥½ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼ï¼ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Science Thought </category>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Linear Algebra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾®ç§¯åˆ†ï¼ˆä¸‹ï¼‰</title>
      <link href="/2022/Science/CalculusPart2/"/>
      <url>/2022/Science/CalculusPart2/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/advanced_mathematics.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjExZTM0N2U0MDFmZDU4N2IzYTIxZGU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å¤šå…ƒå‡½æ•°å¾®åˆ†">å¤šå…ƒå‡½æ•°å¾®åˆ†</h1><h2 id="å¤šå…ƒå‡½æ•°åŠå…¶é‚»åŸŸ">å¤šå…ƒå‡½æ•°åŠå…¶é‚»åŸŸ</h2><p>äºŒå…ƒå‡½æ•°çš„ä¸¥æ ¼å®šä¹‰ï¼š å‡è®¾<span class="math inline">\(D\)</span>æ˜¯äºŒç»´å‘é‡<span class="math inline">\((x,y)\)</span>çš„é›†åˆï¼Œ<span class="math inline">\(D\)</span>ä¸Šçš„äºŒå…ƒå‡½æ•°<span class="math inline">\(\ f\)</span>æ˜¯ä¸€ä¸ªæ˜ å°„æ³•åˆ™ï¼Œå®ƒå¯¹<span class="math inline">\(D\)</span>å†…çš„æ¯ä¸€ä¸ªæœ‰åºå¯¹<span class="math inline">\((x,y)\)</span>æŒ‡å®šå”¯ä¸€çš„ä¸€ä¸ªå®æ•°ï¼š</p><p><span class="math display">\[z=f(x,y),\quad (x,y)\in D\]</span></p><p>å¦‚æœç”¨<span class="math inline">\(P\)</span>æ¥ä»£æ›¿<span class="math inline">\((x,y)\)</span>çš„è¯ï¼Œä¹Ÿå¯ä»¥å†™ä½œï¼š</p><p><span class="math display">\[z=f(P),\quad P\in D\]</span></p><p><span class="math inline">\(D\)</span>ç§°ä¸º<span class="math inline">\(f\)</span>çš„å®šä¹‰åŸŸï¼Œ<span class="math inline">\(xã€y\)</span>ï¼ˆæˆ–<span class="math inline">\((x,y)\)</span>ï¼Œæˆ–<span class="math inline">\(P\)</span>ï¼‰ç§°ä¸º<span class="math inline">\(f\)</span>çš„è‡ªå˜é‡ï¼Œ<span class="math inline">\(z\)</span>ç§°ä¸º<span class="math inline">\(f\)</span>çš„å› å˜é‡ã€‚</p><p>å¦‚æœå®šä¹‰åŸŸ<span class="math inline">\(D\)</span>æ˜¯æ›´é«˜ç»´çš„å‘é‡çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯è¯´è‡ªå˜é‡ä¸ºæ›´é«˜ç»´çš„å‘é‡ï¼Œé‚£ä¹ˆ <span class="math inline">\(f\)</span>å¯ä»¥ç§°ä¸ºå¤šå…ƒå‡½æ•°ï¼Œä¹Ÿå«ä½œå¤šå˜é‡å‡½æ•°ã€‚</p><h4 id="é‚»åŸŸå’Œå»å¿ƒé‚»åŸŸ">é‚»åŸŸå’Œå»å¿ƒé‚»åŸŸï¼š</h4><p>äºŒç»´å‘é‡çš„é‚»åŸŸè¦æ¯”ä¸€ç»´å‘é‡çš„å¤æ‚ã€‚å¯¹äºäºŒç»´å‘é‡<span class="math inline">\(P_0(x_0,y_0)\)</span>è€Œè¨€ï¼ŒåŠå¾„ä¸º<span class="math inline">\(\delta\)</span> é‚»åŸŸå¯ä»¥è¡¨ç¤ºä¸ºå¹³é¢ç‚¹é›†ï¼š</p><p><span class="math display">\[U(P_0,\delta)=\{(x,y)\ |\ (x-x_0)^2 + (y-y_0)^2 &lt; \delta^2\}\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/math_area.png"></p><h2 id="å¤šå…ƒå‡½æ•°æé™å’Œè¿ç»­">å¤šå…ƒå‡½æ•°æé™å’Œè¿ç»­</h2><ul><li><p>èšç‚¹ï¼š å¦‚æœå¯¹äºä»»æ„ç»™å®šçš„<span class="math inline">\(\delta &gt; 0\)</span>ï¼Œç‚¹<span class="math inline">\(P\)</span>çš„å»å¿ƒé‚»åŸŸ<span class="math inline">\(\mathring{U}(P,\delta)\)</span>å†…æ€»æœ‰å¹³é¢ç‚¹é›†<span class="math inline">\(E\)</span>ä¸­çš„ç‚¹ï¼Œé‚£ä¹ˆç§°ç‚¹<span class="math inline">\(P\)</span>ä¸º<span class="math inline">\(E\)</span>çš„èšç‚¹ã€‚ å®šä¹‰èšç‚¹æ˜¯ä¸ºäº†ä¿è¯ï¼Œä»<span class="math inline">\(P_0(x_0,y_0)\)</span>çš„æŸå»å¿ƒé‚»åŸŸå†…çš„æŸä¸€ç‚¹<span class="math inline">\(P(x,y)\)</span>å‡ºå‘ï¼Œè‡³å°‘èƒ½æ‰¾åˆ°ä¸€ä¸²å®Œå…¨åœ¨ E ä¸­çš„ç‚¹æ¥é è¿‘<span class="math inline">\(P_0\)</span></p></li><li><p>äºŒå…ƒå‡½æ•°æé™çš„å®šä¹‰ï¼š è®¾äºŒå…ƒå‡½æ•°<span class="math inline">\(f(x,y)\)</span>çš„å®šä¹‰åŸŸä¸º<span class="math inline">\(Dï¼ŒP_0(x_0,y_0)\)</span>æ˜¯<span class="math inline">\(D\)</span>çš„èšç‚¹ã€‚å¦‚æœå­˜åœ¨å¸¸æ•°<span class="math inline">\(L\)</span>ï¼Œå¯¹äºä»»æ„ç»™å®šçš„æ­£æ•°<span class="math inline">\(\epsilon\)</span>ï¼Œæ€»å­˜åœ¨æ­£æ•°<span class="math inline">\(\delta\)</span>ï¼Œä½¿å¾—å½“ç‚¹<span class="math inline">\(P(x,y)\)</span>æ»¡è¶³ä¸‹åˆ—æ¡ä»¶æ—¶ï¼š <span class="math display">\[  (x,y)\in D\cap \mathring{U}(P_0,\delta)  \]</span> éƒ½æœ‰ï¼š <span class="math display">\[  |f(x,y)-L| &lt; \epsilon  \]</span> æˆç«‹ï¼Œé‚£ä¹ˆå°±ç§°å¸¸æ•°<span class="math inline">\(L\)</span>ä¸ºå‡½æ•°<span class="math inline">\(f(x,y)\)</span>å½“<span class="math inline">\((x,y)\to(x_0,y_0)\)</span>æ—¶çš„æé™ï¼Œè®°ä½œï¼š <span class="math display">\[  \lim_{(x,y)\to(x_0,y_0)}f(x,y)=L\quad æˆ–ã€quad f(x,y)\to L\ \big(\ (x,y)\to(x_0,y_0)\ \big)  \]</span> å› ä¸ºè¿™æ˜¯äºŒå…ƒå‡½æ•°çš„æé™ï¼Œæ‰€ä»¥ä¹Ÿç§°ä½œäºŒé‡æé™ã€‚</p></li><li><p>è¿ç»­ï¼š è®¾äºŒå…ƒå‡½æ•°<span class="math inline">\(f(x,y)\)</span>çš„å®šä¹‰åŸŸä¸º<span class="math inline">\(D\)</span>ï¼Œ<span class="math inline">\(P_0(x_0,y_0)\)</span>æ˜¯<span class="math inline">\(D\)</span>çš„èšç‚¹ï¼Œä¸”<span class="math inline">\(P_0\in D\)</span>ï¼Œå¦‚æœï¼š <span class="math display">\[  \lim_{(x,y)\to(x_0,y_0)}f(x,y)=f(x_0,y_0)  \]</span> é‚£ä¹ˆç§°å‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\(P_0(x_0,y_0)\)</span>è¿ç»­ã€‚</p></li></ul><h2 id="å…¨å¾®åˆ†">å…¨å¾®åˆ†</h2><p>è®¾å‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>çš„æŸé‚»åŸŸå†…æœ‰å®šä¹‰ï¼Œå‡è®¾ï¼š</p><p><span class="math display">\[\Delta x=x-x_0,\quad \Delta y=y-y_0\]</span></p><p>å¦‚æœå‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>çš„å…¨å¢é‡ï¼š</p><p><span class="math display">\[\Delta z=f(x_0+\Delta x, y_0+\Delta y)-f(x_0, y_0)\]</span></p><p>å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[\Delta z=A\Delta x+B\Delta y+o(\rho)=A\Delta x+B\Delta y+\epsilon_1\Delta x+\epsilon_2\Delta y\]</span></p><p>å…¶ä¸­<span class="math inline">\(Aã€B\)</span>ä¸ä¾èµ–äº<span class="math inline">\(\Delta xã€\Delta y\)</span>ï¼Œä¸”ï¼š</p><p><span class="math display">\[\rho=\sqrt{(\Delta x)^2+(\Delta y)^2},\quad \lim_{\Delta x\to 0}\epsilon_1=0,\quad \lim_{\Delta y\to 0}\epsilon_2=0\]</span></p><p>é‚£ä¹ˆç§°<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>å¤„å¯å¾®åˆ†ï¼Œè€Œ<span class="math inline">\(A\Delta x+B\Delta y\)</span>ç§°ä¸º<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>å¤„çš„å…¨å¾®åˆ†ï¼ˆæˆ–ç§°ä¸ºåˆ‡å¹³é¢ï¼‰ï¼Œè®°ä½œ<span class="math inline">\(\mathrm{d}z\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[\mathrm{d}z=A\mathrm{d}x+B\mathrm{d}y\]</span></p><p>å¯ä»¥ç±»æ¯”å•å˜é‡å¾®åˆ†çš„å®šä¹‰ï¼Œå•å˜é‡å¾®ç§¯åˆ†æ˜¯ä»¥ç›´çº¿ä»£æ›¿æ›²çº¿ï¼ŒåŒå˜é‡å…¨å¾®åˆ†æ˜¯ä»¥å¹³é¢ä»£æ›¿æ›²çº¿ã€‚</p><h2 id="åå¯¼æ•°">åå¯¼æ•°</h2><ul><li><p>å…³äº<span class="math inline">\(x\)</span>çš„åå¯¼æ•°ï¼š <span class="math display">\[  \left.\frac{\partial f}{\partial x}\right|_{(x_0,y_0)}=\left.\frac{\mathrm{d}}{\mathrm{d}x}f(x,y_0)\right|_{x=x_0}=\lim_{h\to 0}\frac{f(x_0+h,y_0)-f(x_0,y_0)}{h}  \]</span></p></li><li><p>å…³äº<span class="math inline">\(y\)</span>çš„åå¯¼æ•°ï¼š <span class="math display">\[  \left.\frac{\partial f}{\partial y}\right|_{(x_0,y_0)}=\left.\frac{\mathrm{d}}{\mathrm{d}y}f(x_0,y)\right|_{y=y_0}=\lim_{h\to 0}\frac{f(x_0,y_0+h)-f(x_0,y_0)}{h}  \]</span></p></li><li><p>ä¸å…¨å¾®åˆ†çš„å…³ç³»ï¼š å¦‚æœå‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>å¯å¾®åˆ†ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>çš„åå¯¼æ•°<span class="math inline">\(f_x(x_0,y_0)ã€f_y(x_0,y_0)\)</span>å¿…å®šå­˜åœ¨ï¼Œä¸”<span class="math inline">\(z=f(x,y)\)</span>åœ¨ç‚¹<span class="math inline">\((x_0,y_0)\)</span>çš„å…¨å¾®åˆ†ä¸ºï¼š <span class="math display">\[  \mathrm{d}z=f_x(x_0,y_0)\mathrm{d}x+f_y(x_0,y_0)\mathrm{d}y  \]</span></p></li></ul><h2 id="æ–¹å‘å¯¼æ•°ä¸æ¢¯åº¦">æ–¹å‘å¯¼æ•°ä¸æ¢¯åº¦</h2><p>å¯¹äºäºŒå…ƒå‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>ï¼Œæ²¿æŸå•ä½å‘é‡ï¼š</p><p><span class="math display">\[\boldsymbol{u}=\begin{pmatrix}u_1\\u_2\end{pmatrix}\]</span></p><p>åœ¨<span class="math inline">\((x_0,y_0)\)</span>ç‚¹çš„æ–¹å‘å¯¼æ•°ä¸ºï¼š</p><p><span class="math display">\[\left.\frac{\partial f}{\partial u}\right|_{(x_0,y_0)}=\lim_{t\to 0}\frac{f(x_0+tu_1, y_0+tu_2)-f(x_0,y_0)}{t},\quad t\in\mathbb{R}\]</span></p><p>å•ä½å‘é‡è¿˜å¯ä»¥ç”¨è¯¥å‘é‡çš„æ–¹å‘ä½™å¼¦<span class="math inline">\(\cos\alpha\)</span>å’Œ<span class="math inline">\(\cos\beta\)</span>è¡¨ç¤ºï¼Œå³ï¼š</p><p><span class="math display">\[\boldsymbol{u}=\begin{pmatrix}u_1\\u_2\end{pmatrix}=\begin{pmatrix}\cos\alpha\\\cos\beta\end{pmatrix}\]</span></p><p>æ‰€ä»¥æ–¹å‘å¯¼æ•°ä¹Ÿå¸¸è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[\left.\frac{\partial f}{\partial u}\right|_{(x_0,y_0)}=\lim_{t\to 0}\frac{f(x_0+t\cos\alpha, y_0+t\cos\beta)-f(x_0,y_0)}{t},\quad t\in\mathbb{R}\]</span></p><ul><li>æ¨¡é•¿ï¼šè¯¥æ–¹å‘å‘é‡çš„æ¨¡é•¿æ˜¯æ–¹å‘å¯¼æ•°çš„æœ€å¤§å€¼ã€‚</li><li>æ–¹å‘ï¼šè¯¥æ–¹å‘å‘é‡çš„æ–¹å‘æ­£æ˜¯å–å¾—æœ€å¤§æ–¹å‘å¯¼æ•°çš„æ–¹å‘ã€‚</li><li>æŠ•å½±ï¼šå®ƒå‘æŸå•ä½å‘é‡<span class="math inline">\(\boldsymbol{u}\)</span>çš„æŠ•å½±å°±æ˜¯å¯¹åº”çš„æ–¹å‘å¯¼æ•°ã€‚</li></ul><p>è¯¥æ–¹å‘å‘é‡å°±ç§°ä¸ºæ¢¯åº¦ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[\nabla f(x_0,y_0)=grad f(x_0,y_0)=\begin{pmatrix}f_x(x_0,y_0)\\f_y(x_0,y_0)\end{pmatrix}=f_x(x_0,y_0)\boldsymbol{i}+f_y(x_0,y_0)\boldsymbol{j}\]</span></p><p>ç›´è§‚çš„ç†è§£å°±æ˜¯ï¼š</p><ul><li>æ²¿ç€æ¢¯åº¦å‘é‡æ–¹å‘èµ°ï¼Œèƒ½ä»¥æœ€å¿«çš„é€Ÿåº¦åˆ°è¾¾å±±é¡¶ã€‚</li><li>é€†ç€æ¢¯åº¦å‘é‡æ–¹å‘èµ°ï¼Œèƒ½ä»¥æœ€å¿«çš„é€Ÿåº¦åˆ°è¾¾å±±è„šã€‚</li><li>å’Œæ¢¯åº¦å‘é‡æ–¹å‘å‚ç›´ï¼Œæ­¤æ—¶å¡åº¦ä¸º 0ï¼Œå³ä¸ä¸Šå±±ä¹Ÿä¸ä¸‹å±±ã€‚</li></ul><h2 id="å…¨å¯¼æ•°">å…¨å¯¼æ•°</h2><p>è‹¥<span class="math inline">\(z=f(x,y)\)</span>æ˜¯å¯å¾®åˆ†çš„ï¼Œè€Œ x å’Œ y æ˜¯ t çš„å¯å¯¼å‡½æ•°ï¼Œåˆ™ z æ˜¯ t çš„å¯å¯¼å‡½æ•°ï¼Œå¹¶ä¸”ï¼š</p><p><span class="math display">\[\frac{\mathrm{d}z}{\mathrm{d}t}=\frac{\partial z}{\partial x}\frac{\mathrm{d}x}{\mathrm{d}t}+\frac{\partial z}{\partial y}\frac{\mathrm{d}y}{\mathrm{d}t}\]</span></p><p>è¿™ä¸ªå¯¼æ•°å¯ä»¥çœ‹ä½œè¿‡åˆ‡ç‚¹çš„æ›²çº¿çš„å¯¼æ•°ï¼Œæ‰€ä»¥åˆè¢«ç§°ä¸ºå…¨å¯¼æ•°ã€‚</p><p>æ€»ç»“ï¼š <span class="math display">\[\begin{array}{c|c}    \hline    \quad \quad&amp;\quad æè¿°ã€quad &amp;\quad å…¬å¼ \quad\\    \hline    \\    \quad åå¯¼æ•° \quad&amp;\quad \begin{aligned}y=y_0\ å’Œã€x=x_0\ ä¸¤å¹³é¢ã€\ \\ä¸æ›²é¢ç›¸äº¤æ‰€å¾—æ›²çº¿çš„å¯¼æ•°ã€end{aligned}\quad&amp;\quad f_x=\frac{\partial f}{\partial x},f_y=\frac{\partial f}{\partial y}\quad \\    \\    \hline    \\    \quad æ–¹å‘å¯¼æ•° \quad&amp;\quad\begin{aligned}å‚ç›´äº xy çš„å¹³é¢ã€quad\quad\ \ \\ä¸æ›²é¢ç›¸äº¤æ‰€å¾—æ›²çº¿çš„å¯¼æ•°ã€\ \end{aligned}\quad&amp;\quad \frac{\partial f}{\partial u}=f_x\cos\alpha+f_y\cos\beta\quad\\    \\    \hline    \\    \quad å…¨å¯¼æ•° \quad&amp;\quad\begin{aligned}å‚ç›´äº xy çš„æ›²é¢ã€quad\quad\ \ \\ä¸æ›²é¢ç›¸äº¤æ‰€å¾—æ›²çº¿çš„å¯¼æ•°ã€\ \end{aligned}\quad&amp;\quad\frac{\mathrm{d}z}{\mathrm{d}t}=\frac{\partial z}{\partial x}\frac{\mathrm{d}x}{\mathrm{d}t}+\frac{\partial z}{\partial y}\frac{\mathrm{d}y}{\mathrm{d}t}\quad\\    \\    \hline\end{array}\]</span></p><h2 id="é›…å¯æ¯”çŸ©é˜µ">é›…å¯æ¯”çŸ©é˜µ</h2><ul><li><p>äºŒå…ƒå‡½æ•°çš„å¯¼æ•°ï¼š äºŒå…ƒå‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>çš„å¾®åˆ†ï¼Œå¾®åˆ†åœ¨<span class="math inline">\(\mathrm{d}x\mathrm{d}y\mathrm {d}z\)</span>åæ ‡ç³»ä¸­çš„æ–¹ç¨‹ä¸ºï¼š</p><p><span class="math display">\[  \mathrm{d}z=f_x\mathrm{d}x+f_y\mathrm{d}y  \]</span></p><p>å¯ä»¥æ”¹å†™ä¸ºçŸ©é˜µçš„å½¢å¼ï¼š <span class="math display">\[  \underbrace{\begin{pmatrix}\mathrm{d}z\end{pmatrix}}_   {\boldsymbol{d_z}}\quad=\quad\underbrace{\begin{pmatrix}   f_x&amp;f_y\end{pmatrix}}_{T}\quad\underbrace{\begin{pmatrix}  \mathrm{d}x\\\mathrm{d}y\end{pmatrix}}_{\boldsymbol{d_{xy}    }}  \]</span></p><p>æˆ–è€…å†™ä½œï¼š</p><p><span class="math display">\[  \boldsymbol{d_z}=T\boldsymbol{d_{xy}}  \]</span></p></li><li><p>ä¸€èˆ¬çš„å¤šå…ƒå‡½æ•°ï¼š <span class="math display">\[  y=f(x_1,x_2,\cdots,x_n),\quad (y,x_1,x_2,\cdots,    x_n\in\mathbb{R})  \]</span></p><p>å¦‚æœå¯å¾®çš„è¯ï¼Œé‚£ä¹ˆå¾®åˆ†æ–¹ç¨‹ä¸ºï¼š</p><p><span class="math display">\[  \mathrm{d}y=f_{x_1}\mathrm{d}x_1+f_{x_2}\mathrm{d}x_2   +\cdots+f_{x_n}\mathrm{d}x_n  \]</span></p><p>å¯ä»¥æ”¹å†™ä¸ºçŸ©é˜µçš„å½¢å¼ï¼š</p><p><span class="math display">\[  \underbrace{\begin{pmatrix}\mathrm{d}y\end{pmatrix}}_   {\boldsymbol{d_y}}\quad=\quad\underbrace{\begin{pmatrix}f_ {x_1}&amp;f_{x_2}&amp;\cdots&amp;f_{x_n}\end{pmatrix}}_{T}   \quad\underbrace{\begin{pmatrix}\mathrm{d}x_1\\\mathrm{d}  x_2\\\vdots\\\mathrm{d}x_b\end{pmatrix}}_{\boldsymbol{d_  {x}}}  \]</span></p><p>æˆ–è€…å†™ä½œï¼š</p><p><span class="math display">\[  \boldsymbol{d_y}=T\boldsymbol{d_{x}}  \]</span></p><p>å…¶ä¸­çŸ©é˜µ T å°±æ˜¯è¯¥å¤šå…ƒå‡½æ•°çš„å¯¼æ•°ã€‚</p></li><li><p>äºŒå…ƒæ–¹ç¨‹ç»„çš„å¯¼æ•°ï¼š <span class="math display">\[  \begin{cases}      \mathrm{d}z=\frac{\partial f}{\partial x}\mathrm{d}x    +\frac{\partial f}{\partial y}\mathrm{d}y\\      \\      \mathrm{d}w=\frac{\partial g}{\partial x}\mathrm{d}x    +\frac{\partial g}{\partial y}\mathrm{d}y  \end{cases}  \]</span> å¯ä»¥å†™æˆçŸ©é˜µçš„å½¢å¼ï¼š <span class="math display">\[  \underbrace{\begin{pmatrix}\mathrm{d}z\\\mathrm{d}w\end{pmatrix}}_{\boldsymbol{d_{v}}}\quad=\quad\underbrace{\begin{pmatrix}\frac{\partial f}{\partial x}&amp;\frac{\partial f}{\partial y}\\\frac{\partial g}{\partial x}&amp;\frac{\partial g}{\partial y}\end{pmatrix}}_{T}\quad\underbrace{\begin{pmatrix}\mathrm{d}x\\\mathrm{d}y\end{pmatrix}}_{\boldsymbol{d_{u}}}  \]</span> æˆ–è€…å†™ä½œï¼š <span class="math display">\[  \boldsymbol{d_{v}}=T\boldsymbol{d_{u}}  \]</span> å…¶ä¸­çŸ©é˜µ T å°±æ˜¯è¯¥æ–¹ç¨‹ç»„æ‰€ä»£è¡¨çš„å‡½æ•°çš„å¯¼æ•°ã€‚</p></li><li><p>é›…å¯æ¯”çŸ©é˜µï¼ˆå¤šå…ƒæ–¹ç¨‹ç»„çš„å¯¼æ•°çŸ©é˜µï¼‰ï¼š å‡å¦‚<span class="math inline">\(f_1,f_2,\cdots,f_n\)</span>éƒ½æ˜¯<span class="math inline">\(x_1,x_2,\cdots,x_m\)</span>çš„å‡½æ•°ï¼Œå¹¶ä¸”ç›¸å¯¹äºå„ä¸ªè‡ªå˜é‡çš„åå¾®åˆ†éƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆå®šä¹‰ T ä¸ºï¼š <span class="math display">\[  T=\frac{\partial (f_1,f_2,\cdots,f_n)}{\partial (x_1,x_2,\cdots,x_m)}=\begin{pmatrix}\frac{\partial f_1}{\partial x_1}&amp;\frac{\partial f_1}{\partial x_2}&amp;\cdots&amp;\frac{\partial f_1}{\partial x_m}\\\frac{\partial f_2}{\partial x_1}&amp;\frac{\partial f_2}{\partial x_2}&amp;\cdots&amp;\frac{\partial f_2}{\partial x_m}\\\vdots&amp;\vdots&amp;\ddots&amp;\vdots\\\frac{\partial f_n}{\partial x_1}&amp;\frac{\partial f_n}{\partial x_2}&amp;\cdots&amp;\frac{\partial f_n}{\partial x_m}\end{pmatrix}  \]</span> è¯¥çŸ©é˜µ<span class="math inline">\(T\)</span>ç§°ä¸ºé›…å¯æ¯”çŸ©é˜µã€‚å› ä¸ºé›…å¯æ¯”çŸ©é˜µçš„è‹±æ–‡åä¸º Jacobian Matrixï¼Œæ‰€ä»¥ä¸Šè¿°çŸ©é˜µåˆå¸¸å†™ä½œï¼š <span class="math display">\[  J=\frac{\partial (f_1,f_2,\cdots,f_n)}{\partial (x_1,x_2,\cdots,x_m)}  \]</span></p></li><li><p>æµ·æ£®çŸ©é˜µï¼š ä¸€å…ƒå¯¼æ•°<span class="math inline">\(y=f(x)\)</span>çš„äºŒé˜¶å¯¼æ•°å°±æ˜¯è¿ç»­ä¸¤æ¬¡ä½¿ç”¨<span class="math inline">\(\frac{\mathrm{d}}{\mathrm{d}x}\)</span>ï¼š <span class="math display">\[  \frac{\mathrm{d}^2y}{\mathrm{d}x^2}=\frac{\mathrm{d}}{\mathrm{d}x}\left(\frac{\mathrm{d}y}{\mathrm{d}x}\right)  \]</span> ç±»ä¼¼çš„ï¼ŒäºŒå…ƒå‡½æ•°<span class="math inline">\(z=f(x,y)\)</span>çš„äºŒé˜¶å¯¼æ•°å°±æ˜¯è¿ç»­ä¸¤æ¬¡è®¡ç®—é›…å¯æ¯”çŸ©é˜µï¼š <span class="math display">\[  \frac{\partial^2 z}{\partial(x,y)^2}=\frac{\partial }{\partial(x,y)}\left(\frac{\partial z}{\partial(x,y)}\right)=\begin{pmatrix}f_{xx}&amp;f_{xy}\\f_{yx}&amp;f_{yy}\end{pmatrix}  \]</span> äºŒé˜¶å¯¼æ•°åˆç§°ä¸ºæµ·æ£®çŸ©é˜µï¼ˆHessian Matrixï¼‰ï¼Œæ‰€ä»¥å¸¸ç”¨ H æ¥è¡¨ç¤ºè¿™ä¸ªçŸ©é˜µï¼š <span class="math display">\[  H=\frac{\partial^2 z}{\partial(x,y)^2}=\begin{pmatrix}f_{xx}&amp;f_{xy}\\f_{yx}&amp;f_{yy}\end{pmatrix}  \]</span> æµ·æ£®çŸ©é˜µå¯ä»¥åˆ¤æ–­å›¾åƒçš„å‡¹å‡¸æ€§ã€‚</p></li></ul><p>æ­¤å¤–å…³äºéšå‡½æ•°çš„æ±‚å¯¼ï¼Œå¤šå…ƒå‡½æ•°çš„æå€¼æ±‚æ³•è¿™é‡Œä¸å†åˆ—å‡ºï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒç›¸å…³ä¹¦ç±ã€‚</p><h1 id="é‡ç§¯åˆ†">é‡ç§¯åˆ†</h1><h2 id="äºŒé‡ç§¯åˆ†">äºŒé‡ç§¯åˆ†</h2><p>è®¾<span class="math inline">\(f(x,y)\)</span>æ˜¯æœ‰ç•Œé—­åŒºåŸŸ<span class="math inline">\(D\)</span>ä¸Šçš„æœ‰ç•Œå‡½æ•°ï¼Œå°†é—­åŒºåŸŸ<span class="math inline">\(D\)</span>ä»»æ„åˆ†æˆ<span class="math inline">\(n\)</span>ä¸ªå°é—­åŒºåŸŸï¼š</p><p><span class="math display">\[\Delta A_1,\Delta A_2,\cdots,\Delta A_i,\cdots,\Delta A_n\]</span></p><p>å…¶ä¸­<span class="math inline">\(\Delta A_i\)</span>è¡¨ç¤ºç¬¬<span class="math inline">\(i\)</span>ä¸ªå°é—­åŒºåŸŸï¼Œä¹Ÿè¡¨ç¤ºå®ƒçš„é¢ç§¯ï¼Œè§„å®š<span class="math inline">\(\Delta A_i\)</span>ä¸­æœ€é•¿çš„ç›´å¾„ï¼ˆä¸€ä¸ªé—­åŒºåŸŸçš„ç›´å¾„æ˜¯æŒ‡åŒºåŸŸä¸Šä»»æ„ä¸¤ç‚¹é—´è·ç¦»çš„æœ€å¤§è€…ï¼‰ä¸º<span class="math inline">\(\lambda\)</span>ï¼Œåœ¨æ¯ä¸ª<span class="math inline">\(\Delta A_i\)</span>å†…ä»»å–ä¸€ç‚¹<span class="math inline">\((x_i,y_i)\)</span>ï¼Œå¯ä»¥å¾—åˆ°çº§æ•°ï¼š</p><p><span class="math display">\[\sum_{i=0}^{n}f(x_i,y_i)\Delta A_i\]</span></p><p>å¦‚æœå½“<span class="math inline">\(\lambda\to 0\)</span>æ—¶ï¼Œæ— è®ºå¦‚ä½•åˆ’åˆ†é—­åŒºåŸŸ<span class="math inline">\(D\)</span>ï¼Œæ— è®ºæ€æ ·é€‰å–<span class="math inline">\((x_i,y_i)\)</span>ï¼Œè¯¥çº§æ•°çš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œé‚£ä¹ˆç§°æ­¤æé™ä¸ºå‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨é—­åŒºåŸŸ<span class="math inline">\(D\)</span>ä¸Šçš„äºŒé‡ç§¯åˆ†ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[\iint_{D} f(x, y) \mathrm{d} A=\lim _{\lambda \rightarrow 0} \sum_{i=0}^{n} f\left(x_{i}, y_{i}\right) \Delta A_{i}\]</span></p><p>å…¶ä¸­<span class="math inline">\(f(x,y)\)</span>ç§°ä¸ºè¢«ç§¯å‡½æ•°ï¼Œ<span class="math inline">\(\mathrm{d}A\)</span>ç§°ä¸ºé¢ç§¯å¾®åˆ†ï¼Œ<span class="math inline">\(x\)</span>ä¸<span class="math inline">\(y\)</span>ç§°ä¸ºç§¯åˆ†å˜é‡ï¼Œ<span class="math inline">\(D\)</span>ç§°ä¸ºç§¯åˆ†åŒºåŸŸã€‚</p><h2 id="äºŒé‡ç§¯åˆ†çš„æ€§è´¨">äºŒé‡ç§¯åˆ†çš„æ€§è´¨</h2><p>è®¾<span class="math inline">\(f(x,y)ï¼Œg(x,y)\)</span>éƒ½æ˜¯æœ‰ç•Œé—­åŒºåŸŸ<span class="math inline">\(D\)</span>ä¸Šçš„æœ‰ç•Œå‡½æ•°ï¼Œ<span class="math inline">\(\alphaã€\beta\)</span>ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š</p><ul><li><p>é½æ¬¡æ€§ï¼š <span class="math display">\[  \iint_{D} \alpha f(x, y) \mathrm{d} A=\alpha \iint_{D} f(x, y)  \mathrm{d} A  \]</span></p></li><li><p>å¯åŠ æ€§ï¼š <span class="math display">\[  \iint_{D}(f(x, y)+g(x, y)) \mathrm{d} A=\iint_{D} f(x, y) \mathrm{d} A+\iint_{D} g(x, y) \mathrm{d} A  \]</span></p></li><li><p>æ¨è®ºï¼š <span class="math display">\[  \iint_{D}(\alpha f(x, y) \pm \beta g(x, y)) \mathrm{d} A=\alpha \iint_{D} f(x, y) \mathrm{d} A \pm \beta \iint_{D} g(x, y) \mathrm{d} A  \]</span></p></li><li><p>åŒºåŸŸå¯åŠ æ€§ï¼š å¦‚æœé—­åŒºåŸŸ<span class="math inline">\(D\)</span>è¢«æœ‰é™æ¡æ›²çº¿åˆ†ä¸ºæœ‰é™ä¸ªéƒ¨åˆ†é—­åŒºåŸŸï¼Œé‚£ä¹ˆ<span class="math inline">\(D\)</span>ä¸Šçš„äºŒé‡ç§¯åˆ†ç­‰äºå„éƒ¨åˆ†é—­åŒºåŸŸä¸Šçš„äºŒé‡ç§¯åˆ†ä¹‹å’Œã€‚</p></li><li><p>äºŒé‡ç§¯åˆ†ä¸­å€¼å®šç†ï¼š è®¾å‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨é—­åŒºåŸŸ<span class="math inline">\(D\)</span>ä¸Šè¿ç»­ï¼Œ<span class="math inline">\(A\)</span>æ˜¯åŒºåŸŸ<span class="math inline">\(D\)</span>çš„é¢ç§¯ï¼Œåˆ™åœ¨<span class="math inline">\(D\)</span>ä¸Šè‡³å°‘å­˜åœ¨ä¸€ç‚¹<span class="math inline">\((\xi,\mu)\)</span>ï¼Œä½¿å¾—ï¼š <span class="math display">\[  \iint_{D} f(x, y) \mathrm{d} A=f(\xi, \mu) A  \]</span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/DoubleIntegralMeanValueTheorem.png"></p></li></ul><h2 id="äºŒé‡ç§¯åˆ†æ³•">äºŒé‡ç§¯åˆ†æ³•</h2><h3 id="å¼±å¯Œæ¯”å°¼å®šç†">å¼±å¯Œæ¯”å°¼å®šç†</h3><p>è®¾æœ‰çŸ©å½¢åŒºåŸŸ<span class="math inline">\(R\)</span>ï¼š</p><p><span class="math display">\[R=\{(x,y)|a\le x\le b,c\le y\le d\}\]</span></p><p>è‹¥<span class="math inline">\(f(x,y)\)</span>åœ¨åŒºåŸŸ<span class="math inline">\(R\)</span>ä¸Šè¿ç»­ï¼Œåˆ™ï¼š</p><p><span class="math display">\[\iint_{R} f(x, y) \mathrm{d} A=\int_{c}^{d}\left[\int_{a}^{b} f(x, y) \mathrm{d} x\right] \mathrm{d} y=\int_{a}^{b}\left[\int_{c}^{d} f(x, y) \mathrm{d} y\right] \mathrm{d} x\]</span></p><p>å°†äºŒé‡ç§¯åˆ†å˜ä¸ºï¼Œå…ˆç§¯ x åç§¯ yï¼ˆæˆ–å…ˆç§¯ y åç§¯ xï¼‰çš„äºŒæ¬¡ç§¯åˆ†ã€‚</p><h3 id="å¼ºå¯Œæ¯”å°¼å®šç†">å¼ºå¯Œæ¯”å°¼å®šç†</h3><p>è‹¥<span class="math inline">\(f(x,y)\)</span>åœ¨åŒºåŸŸ<span class="math inline">\(D\)</span>ä¸Šè¿ç»­ï¼š</p><ul><li>è‹¥åŒºåŸŸ D ä¸º<span class="math inline">\(a \le x \le b, g_1(x) \le y \le g_2(x)\)</span>ï¼Œå…¶ä¸­<span class="math inline">\(g_1ã€g_2\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­ï¼Œåˆ™ï¼š</li></ul><p><span class="math display">\[\iint_{D} f(x, y) \mathrm{d} A=\int_{a}^{b}\left[\int_{g_{1}(x)}^{g_{2}(x)} f(x, y) \mathrm{d} y\right] \mathrm{d} x\]</span></p><ul><li>è‹¥åŒºåŸŸ D ä¸º<span class="math inline">\(c \le y \le d, h_1(y) \le x \le h_2(y)\)</span>ï¼Œå…¶ä¸­<span class="math inline">\(h_1ã€h_2\)</span>åœ¨<span class="math inline">\([c,d]\)</span>ä¸Šè¿ç»­ï¼Œåˆ™ï¼š</li></ul><p><span class="math display">\[\iint_{D} f(x, y) \mathrm{d} A=\int_{c}^{d}\left[\int_{h_{1}(y)}^{h_{2}(y)} f(x, y) \mathrm{d} x\right] \mathrm{d} y\]</span></p><p>å¯è§ï¼Œå’Œå¯Œæ¯”å°¼å®šç†çš„è¾ƒå¼±å½¢å¼ä¸ä¸€æ ·ï¼Œè¿™é‡Œæ˜¯ä¸èƒ½äº¤æ¢ç§¯åˆ†é¡ºåºçš„ã€‚</p><h3 id="åæ ‡ç³»å˜æ¢">åæ ‡ç³»å˜æ¢</h3><p>æœ‰æ—¶å€™åˆ‡æ¢ä¸€ä¸‹åæ ‡ç³»é—®é¢˜ä¼šå˜å¾—ç®€å•çš„å¤šï¼Œä¸ºæ­¤ç ”ç©¶åœ¨åæ ‡å˜æ¢åçš„å¤šé‡ç§¯åˆ†ä¹Ÿæ˜¯å¾ˆæœ‰ä»·å€¼çš„ã€‚</p><p>åœ¨åŒºåŸŸ D ä¸Šï¼Œå¦‚æœ<span class="math inline">\(xy\)</span>ç›´è§’åæ ‡ç³»å’Œ<span class="math inline">\(uv\)</span>ç›´è§’åæ ‡ç³»ä¹‹é—´å­˜åœ¨å¦‚ä¸‹çš„åæ ‡å˜æ¢å‡½æ•°ï¼Œä¸”<span class="math inline">\(x(u,v)ã€y(u,v)\)</span>åœ¨åŒºåŸŸ D ä¸Šæœ‰ä¸€é˜¶è¿ç»­åå¯¼æ•°ï¼ˆè¿™æ˜¯ä¸ºäº†ä¿è¯å¯ä»¥æ‰¾åˆ°æœ€ä½³çº¿æ€§è¿‘ä¼¼ï¼‰ï¼š</p><p><span class="math display">\[\begin{cases}    x=x(u,v)\\    y=y(u,v)\end{cases}\]</span></p><p>å¦‚æœé›…å¯æ¯”è¡Œåˆ—å¼å­˜åœ¨ä¸”ä¸ä¸º 0ï¼š</p><p><span class="math display">\[|J|=|\frac{\partial(x,y)}{\partial(u,v)}|=\begin{vmatrix}\frac{\partial x}{\partial u }&amp;\frac{\partial x}{\partial v}\\\frac{\partial y}{\partial u}&amp;\frac{\partial y}{\partial v}\end{vmatrix}\ne 0\]</span></p><p>åˆ™åŒºåŸŸ D ä¸Šåœ¨<span class="math inline">\(xy\)</span>ç›´è§’åæ ‡ç³»ä¸‹çš„é¢ç§¯ä¸ºï¼š</p><p><span class="math display">\[\iint_{D} \mathrm{~d} x \mathrm{~d} y=\iint_{D}\|J\| \mathrm{d} u \mathrm{~d} v\]</span></p><p>æ‰€ä»¥ï¼Œ<span class="math inline">\(z=f(x,y)\)</span>åœ¨åŒºåŸŸ D ä¸Šçš„ä½“ç§¯ä¸ºï¼ˆåœ¨<span class="math inline">\(xyz\)</span>ç›´è§’åæ ‡ç³»ä¸‹çš„ä½“ç§¯ï¼‰ï¼š</p><p><span class="math display">\[\iint_{D} f(x, y) \mathrm{d} x \mathrm{~d} y=\iint_{D} f(x(u, v), y(u, v))\|J\| \mathrm{d} u \mathrm{~d} v\]</span></p><h2 id="ä¸‰é‡ç§¯åˆ†">ä¸‰é‡ç§¯åˆ†</h2><p>è®¾<span class="math inline">\(f(x,y,z)\)</span>æ˜¯æœ‰ç•Œé—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ä¸Šçš„æœ‰ç•Œå‡½æ•°ï¼Œå°†é—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ä»»æ„åˆ†æˆ<span class="math inline">\(n\)</span>ä¸ªå°é—­åŒºåŸŸï¼š</p><p><span class="math display">\[\Delta V_1,\Delta V_2,\cdots,\Delta V_i,\cdots,\Delta V_n\]</span></p><p>å…¶ä¸­<span class="math inline">\(\Delta V_i\)</span>è¡¨ç¤ºç¬¬<span class="math inline">\(i\)</span>ä¸ªå°é—­åŒºåŸŸï¼Œä¹Ÿè¡¨ç¤ºå®ƒçš„ä½“ç§¯ï¼Œè§„å®š<span class="math inline">\(\Delta V_i\)</span>ä¸­æœ€å¤§çš„ä½“ç§¯ä¸º<span class="math inline">\(\lambda\)</span>ï¼š</p><p><span class="math display">\[\lambda=\max(\Delta V_i)\]</span></p><p>åœ¨æ¯ä¸ª<span class="math inline">\(\Delta V_i\)</span>å†…ä»»å–ä¸€ç‚¹<span class="math inline">\((\xi_i,\mu_i,\zeta_i)\)</span>ï¼Œå¯ä»¥å¾—åˆ°çº§æ•°ï¼š</p><p><span class="math display">\[\sum_{i=0}^{n}f(\xi_i,\mu_i,\zeta_i)\Delta V_i\]</span></p><p>å¦‚æœå½“<span class="math inline">\(\lambda\to 0\)</span>æ—¶ï¼Œæ— è®ºå¦‚ä½•åˆ’åˆ†é—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ï¼Œæ— è®ºæ€æ ·é€‰å–<span class="math inline">\((\xi_i,\mu_i,\zeta_i)\)</span>ï¼Œè¯¥çº§æ•°çš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œé‚£ä¹ˆç§°æ­¤æé™ä¸ºå‡½æ•°<span class="math inline">\(f(x,y,z)\)</span>åœ¨é—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ä¸Šçš„ä¸‰é‡ç§¯åˆ†ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[\iiint_{\Omega} f(x, y, z) \mathrm{d} V=\lim _{\lambda \rightarrow 0} \sum_{i=0}^{n} f\left(\xi_{i}, \mu_{i}, \zeta_{i}\right) \Delta V_{i}\]</span></p><p>å…¶ä¸­<span class="math inline">\(f(x,y,z)\)</span>ç§°ä¸ºè¢«ç§¯å‡½æ•°ï¼Œ<span class="math inline">\(\mathrm{d}V\)</span>ç§°ä¸ºä½“ç§¯å¾®åˆ†ï¼Œ<span class="math inline">\(xã€y\)</span>ä»¥åŠ<span class="math inline">\(z\)</span>ç§°ä¸ºç§¯åˆ†å˜é‡ï¼Œ<span class="math inline">\(\Omega\)</span>ç§°ä¸ºç§¯åˆ†åŒºåŸŸã€‚</p><h2 id="ä¸‰é‡ç§¯åˆ†æ³•">ä¸‰é‡ç§¯åˆ†æ³•</h2><h3 id="å¯Œæ¯”å°¼å®šç†">å¯Œæ¯”å°¼å®šç†</h3><p>åŒºåŸŸ E å¯ä»¥è¡¨ç¤ºä¸ºï¼š <span class="math display">\[E=\{(x,y,z)|a\le x\le b,g_1(x)\le y\le g_2(x), u_1(x,y)\le z\le u_2(x,y)\}\]</span></p><p>é‚£ä¹ˆé€šè¿‡å¯Œæ¯”å°¼å®šç†ï¼Œå‡½æ•°<span class="math inline">\(f(x,y,z)\)</span>åœ¨åŒºåŸŸ E ä¸Šçš„ä¸‰é‡ç§¯åˆ†å¯ä»¥å¦‚ä¸‹è®¡ç®—ï¼š</p><p><span class="math display">\[\begin{aligned}\iiint_{E} f(x, y, z) \mathrm{d} V &amp;=\iint_{D}\left[\int_{u_{1}(x, y)}^{u_{2}(x, y)} f(x, y, z) \mathrm{d} z\right] \mathrm{d} A \\&amp;=\int_{a}^{b} \int_{g_{1}(x)}^{g_{2}(x)} \int_{u_{1}(x, y)}^{u_{2}(x, y)} f(x, y, z) \mathrm{d} z \mathrm{~d} y \mathrm{~d} x\end{aligned}\]</span></p><p>è¿™æ ·å°±å°†ä¸‰é‡ç§¯åˆ†åˆ’ä¸ºäº†æ–¹ä¾¿è®¡ç®—çš„ä¸‰æ¬¡ç§¯åˆ†ã€‚</p><h3 id="åæ ‡ç³»å˜æ¢-1">åæ ‡ç³»å˜æ¢</h3><p>åŒæ ·å˜æ¢åæ ‡ç³»æ˜¯ä¸ºäº†ç®€åŒ–é—®é¢˜ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºåæ ‡ç³»å˜æ¢ç§¯åˆ†å…¬å¼ï¼š</p><ul><li><p>æŸ±é¢åæ ‡ç³»çš„ä½“ç§¯å¾®åˆ†ï¼š é€šè¿‡é›…å¯æ¯”è¡Œåˆ—å¼<span class="math inline">\(|J|\)</span>ï¼Œå¯å¾—æŸ±é¢åæ ‡ç³»å‡½æ•°<span class="math inline">\(w=f(\rho,\theta,z)\)</span>åœ¨åŒºåŸŸ <span class="math inline">\(\Omega\)</span>ä¸Šçš„ä¸‰é‡ç§¯åˆ†ä¸ºï¼š</p><p><span class="math display">\[  \begin{aligned}  \iiint_{\Omega} f(\rho, \theta, z) \mathrm{d} V &amp;=\iiint_   {\Omega} f(\rho, \theta, z)\|J\| \mathrm{d} \rho \mathrm{d}    \theta \mathrm{d} z \\  &amp;=\iiint_{\Omega} f(\rho, \theta, z) \rho \mathrm{d} \rho   \mathrm{d} \theta \mathrm{d} z  \end{aligned}  \]</span></p><p>å…¶ä¸­<span class="math inline">\(\rho\mathrm{d}\rho\mathrm{d}\theta\mathrm{d}z\)</span>ç§°ä¸ºæŸ±é¢åæ ‡ç³»çš„ ä½“ç§¯å¾®åˆ†ã€‚</p></li><li><p>çƒé¢åæ ‡ç³»çš„ä½“ç§¯å¾®åˆ†ï¼š é€šè¿‡é›…å¯æ¯”è¡Œåˆ—å¼<span class="math inline">\(|J|\)</span>ï¼Œå¯å¾—çƒé¢åæ ‡ç³»å‡½æ•°<span class="math inline">\(w=f(r,\varphi,\theta)\)</span>åœ¨åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ä¸Šçš„ä¸‰é‡ç§¯åˆ†ä¸ºï¼š <span class="math display">\[  \begin{aligned}  \iiint_{\Omega} f(r, \varphi, \theta) \mathrm{d} V &amp;=\iiint_    {\Omega} f(r, \varphi, \theta)\|J\| \mathrm{d} r \mathrm{~d}    \varphi \mathrm{d} \theta \\  &amp;=\iint_{\Omega} \iint(r, \varphi, \theta) r^{2} \sin \varphi   \mathrm{d} r \mathrm{~d} \varphi \mathrm{d} \theta  \end{aligned}  \]</span></p><p>å…¶ä¸­<span class="math inline">\(r^2\sin\varphi\mathrm{d}r\mathrm{d}\varphi\mathrm{d}\theta\)</span>ç§°ä¸ºçƒé¢åæ ‡ç³»çš„ä½“ç§¯å¾®åˆ†ã€‚</p></li></ul><h1 id="æ›²çº¿ç§¯åˆ†ä¸æ›²é¢ç§¯åˆ†">æ›²çº¿ç§¯åˆ†ä¸æ›²é¢ç§¯åˆ†</h1><h2 id="ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†">ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†</h2><p>è®¾<span class="math inline">\(L\)</span>ä¸º<span class="math inline">\(xOy\)</span>é¢å†…çš„ä¸€æ¡å…‰æ»‘æ›²çº¿å¼§ï¼Œå‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨<span class="math inline">\(L\)</span>ä¸Šæœ‰ç•Œã€‚åœ¨<span class="math inline">\(L\)</span>ä¸Šä»»æ„æ’å…¥ä¸€ç‚¹åˆ—<span class="math inline">\(P_0ã€P_1ï¼Œ\cdotsã€P_{n}\)</span>ï¼ŒæŠŠ<span class="math inline">\(L\)</span>åˆ†æˆ<span class="math inline">\(n\)</span>ä¸ªå°æ®µã€‚è®¾ç¬¬<span class="math inline">\(k\)</span>ä¸ªå°æ®µçš„é•¿åº¦ä¸º<span class="math inline">\(\Delta s_k\)</span>ã€‚åˆ<span class="math inline">\((\xi_k,\eta_k)\)</span>ä¸ºç¬¬<span class="math inline">\(k\)</span>ä¸ªå°æ®µä¸Šä»»æ„å–å®šçš„ä¸€ç‚¹ï¼Œåšä¹˜ç§¯<span class="math inline">\(f(\xi_k,\eta_k)\Delta s_k\)</span>ï¼Œå¹¶ä½œå’Œï¼š</p><p><span class="math display">\[\sum_{k=1}^{n}f(\xi_k,\eta_k)\Delta s_k\]</span></p><p>å¦‚æœå½“å„å°å¼§æ®µçš„é•¿åº¦çš„æœ€å¤§å€¼<span class="math inline">\(\lambda\to 0\)</span>æ—¶ï¼Œè¿™å’Œçš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œä¸”ä¸æ›²çº¿<span class="math inline">\(L\)</span>çš„åˆ†æ³•åŠç‚¹<span class="math inline">\((\xi_k,\eta_k)\)</span>çš„å–æ³•æ— å…³ï¼Œé‚£ä¹ˆç§°æ­¤æé™ä¸ºå‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨æ›²çº¿<span class="math inline">\(L\)</span>ä¸Šçš„ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[\int_L f(x,y)\mathrm{d}s=\lim_{\lambda\to 0}\sum_{k=1}^{n}f(\xi_k,\eta_k)\Delta s_k\]</span></p><p>å…¶ä¸­<span class="math inline">\(\mathrm{d}s\)</span>ç§°ä¸ºå¼§å¾®åˆ†ã€‚</p><ul><li><p>ç‰©ç†æ„ä¹‰ï¼š ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†çš„ç‰©ç†æ„ä¹‰è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œä¹‹å‰ä»‹ç»è¿‡ï¼Œå¦‚æœ<span class="math inline">\(\mu(x,y)\)</span>æ˜¯æ›²çº¿<span class="math inline">\(L\)</span>çš„å¯†åº¦å‡½æ•°æ—¶ï¼Œå¦‚ä¸‹è®¡ç®—çš„æ˜¯æ›²çº¿è´¨é‡ï¼š <span class="math display">\[  m=\int_L \mu(x,y)\mathrm{d}s  \]</span> è€Œå¦‚æœ<span class="math inline">\(\delta(x,y)\)</span>æ˜¯æ›²çº¿<span class="math inline">\(L\)</span>çš„ç”µè·å¯†åº¦å‡½æ•°ï¼Œé‚£ä¹ˆå¦‚ä¸‹è®¡ç®—çš„å°±æ˜¯æ›²çº¿çš„ç”µè·é‡ï¼š <span class="math display">\[  c=\int_L \delta(x,y)\mathrm{d}s  \]</span></p></li><li><p>å‡ ä½•æ„ä¹‰ï¼š ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†<span class="math inline">\(\int_L f(x,y)\mathrm{d}s\)</span>çš„å‡ ä½•æ„ä¹‰å°±æ˜¯æ±‚æ›²çº¿ L ä¸æ›²é¢<span class="math inline">\(z=f(x,y)\)</span>ä¹‹é—´çš„é¢ç§¯ï¼š</p></li><li>æ€§è´¨ï¼š<ul><li><p>æ€§è´¨ 1ï¼šè®¾<span class="math inline">\(\alphaã€\beta\)</span>ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L[\alpha f(x,y)+\beta g(x,y)]\mathrm{d}s=\alpha\int_L f(x,y)\mathrm{d}s+\beta\int_L g(x,y)\mathrm{d}s  \]</span></p></li><li><p>æ€§è´¨ 2ï¼šè®¾å…‰æ»‘æ›²çº¿<span class="math inline">\(L\)</span>å¯åˆ†ä¸ºä¸¤ä¸ªå…‰æ»‘æ›²çº¿<span class="math inline">\(L_1\)</span>å’Œ<span class="math inline">\(L_2\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L f(x,y)\mathrm{d}s=\int_{L_1} f(x,y)\mathrm{d}s+\int_{L_2} f(x,y)\mathrm{d}s  \]</span></p></li><li><p>æ€§è´¨ 3ï¼šè®¾åœ¨å…‰æ»‘æ›²çº¿ L ä¸Šæœ‰<span class="math inline">\(f(x,y)\le g(x,y)\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L f(x,y)\mathrm{d}s\le\int_{L} g(x,y)\mathrm{d}s  \]</span></p></li></ul></li></ul><h2 id="ç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†">ç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†</h2><p>è®¾<span class="math inline">\(L\)</span>ä¸º<span class="math inline">\(xOy\)</span>é¢å†…ä»<span class="math inline">\(A\)</span>ç‚¹åˆ°<span class="math inline">\(B\)</span>ç‚¹çš„ä¸€æ¡å…‰æ»‘æ›²çº¿å¼§ï¼Œå‡½æ•°<span class="math inline">\(P(x,y)ã€Q(x,y)\)</span>åœ¨<span class="math inline">\(L\)</span>ä¸Šæœ‰ç•Œã€‚åœ¨<span class="math inline">\(L\)</span>ä¸Šä»»æ„æ’å…¥ä¸€ç‚¹åˆ—<span class="math inline">\(P_0ã€P_1ï¼Œ\cdotsã€P_{n}\)</span>ï¼ŒæŠŠ<span class="math inline">\(L\)</span>åˆ†æˆ<span class="math inline">\(n\)</span>ä¸ªæœ‰å‘å°å¼§æ®µï¼š</p><p><span class="math display">\[\overbrace{P_{k-1} P_{k}}, \quad\left(k=1,2, \cdots, n, P_{0}=A, P_{n}=B\right)\]</span></p><p>è®¾<span class="math inline">\(\Delta x_k=x_k-x_{k-1}ï¼Œ\Delta y_k=y_k-y_{k-1}\)</span>ï¼Œç‚¹<span class="math inline">\((\xi_k,\eta_k)\)</span>ä¸º<span class="math inline">\(\overbrace{P_{k-1} P_{k}}\)</span>ä¸Šä»»æ„å–å®šçš„ç‚¹ï¼Œåšä¹˜ç§¯<span class="math inline">\(P(\xi_k,\eta_k)\Delta x_i\)</span>ï¼Œå¹¶ä½œå’Œï¼š</p><p><span class="math display">\[\sum_{k=1}^{n}P(\xi_k,\eta_k)\Delta x_k,\quad \sum_{k=1}^{n}Q(\xi_k,\eta_k)\Delta y_k\]</span></p><p>å¦‚æœå½“å„å°å¼§æ®µçš„é•¿åº¦çš„æœ€å¤§å€¼<span class="math inline">\(\lambda\to 0\)</span>æ—¶ï¼Œå’Œçš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œä¸”ä¸æ›²çº¿<span class="math inline">\(L\)</span>çš„åˆ†æ³•åŠç‚¹<span class="math inline">\((\xi_k,\eta_k)\)</span>çš„å–æ³•æ— å…³ï¼Œå°±ç§°è¿™ä¸¤ä¸ªæé™ä¸º<span class="math inline">\(P(x,y)\)</span>åœ¨æœ‰å‘æ›²çº¿<span class="math inline">\(\ L\)</span> ä¸Šå¯¹åæ ‡<span class="math inline">\(\ x\)</span> çš„æ›²çº¿ç§¯åˆ†ï¼š</p><p><span class="math display">\[\int_L P(x,y)\mathrm{d}x=\lim_{\lambda\to 0}\sum_{k=1}^{n}P(\xi_k,\eta_k)\Delta x_k\]</span></p><p>ä»¥åŠ<span class="math inline">\(Q(x,y)\)</span>åœ¨æœ‰å‘æ›²çº¿<span class="math inline">\(\ L\)</span> ä¸Šå¯¹åæ ‡<span class="math inline">\(\ y\)</span> çš„æ›²çº¿ç§¯åˆ†ï¼š</p><p><span class="math display">\[\int_L Q(x,y)\mathrm{d}y=\lim_{\lambda\to 0}\sum_{k=1}^{n}Q(\xi_k,\eta_k)\Delta y_k\]</span></p><p>ä»¥ä¸Šä¸¤ä¸ªç§¯åˆ†ä¹Ÿç§°ä¸ºç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†ã€‚</p><ul><li>æ€§è´¨ï¼š<ul><li><p>æ€§è´¨ 1ï¼šè®¾<span class="math inline">\(\alphaã€\beta\)</span>ä¸ºå¸¸æ•°ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L[\alpha\boldsymbol{F_1}(x,y)+\beta\boldsymbol{F_2}(x,y)]\cdot\mathrm{d}\boldsymbol{s}=\alpha\int_L\boldsymbol{F_1}(x,y)\cdot\mathrm{d}\boldsymbol{s}+\beta\int_L\boldsymbol{F_2}(x,y)\cdot\mathrm{d}\boldsymbol{s}  \]</span></p></li><li><p>æ€§è´¨ 2ï¼šè®¾æœ‰å‘å…‰æ»‘æ›²çº¿<span class="math inline">\(L\)</span>å¯åˆ†ä¸ºä¸¤ä¸ªå…‰æ»‘æœ‰å‘æ›²çº¿<span class="math inline">\(L_1\)</span>å’Œ<span class="math inline">\(L_2\)</span>ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L \boldsymbol{F}(x,y)\cdot\mathrm{d}\boldsymbol{s}=\int_{L_1} \boldsymbol{F}(x,y)\cdot\mathrm{d}\boldsymbol{s}+\int_{L_2}\boldsymbol{F}(x,y)\cdot\mathrm{d}\boldsymbol{s}  \]</span></p></li><li><p>æ€§è´¨ 3ï¼šè®¾<span class="math inline">\(L\)</span>æ˜¯æœ‰å‘å…‰æ»‘æ›²çº¿ï¼Œ<span class="math inline">\(L^-\)</span>æ˜¯<span class="math inline">\(L\)</span>çš„åå‘æ›²çº¿ï¼Œåˆ™ï¼š <span class="math display">\[  \int_L \boldsymbol{F}(x,y)\cdot\mathrm{d}\boldsymbol{s}=-\int_{L^-} \boldsymbol{F}(x,y)\cdot\mathrm{d}\boldsymbol{s}  \]</span></p></li></ul></li></ul><h2 id="ä¸¤ç±»æ›²çº¿ç§¯åˆ†çš„å…³ç³»">ä¸¤ç±»æ›²çº¿ç§¯åˆ†çš„å…³ç³»</h2><h3 id="åŒºåˆ«">åŒºåˆ«</h3><ul><li>ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†é’ˆå¯¹çš„æ˜¯æ›²çº¿ï¼Œè€Œç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†é’ˆå¯¹çš„æ˜¯æœ‰å‘æ›²çº¿ã€‚</li><li>ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†ï¼Œä½œç”¨åœ¨æ›²çº¿ä¸Šçš„æ˜¯æ ‡é‡ï¼›è€Œç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†ï¼Œä½œç”¨åœ¨æ›²çº¿ä¸Šçš„æ˜¯å‘é‡ã€‚</li></ul><h3 id="è”ç³»">è”ç³»</h3><p>å› ä¸ºå¼§å¾®åˆ†å’Œæœ‰å‘å¼§å¾®åˆ†çš„å…³ç³»ä¸º<span class="math inline">\(\boldsymbol{\tau}\mathrm{d}s=\mathrm{d}\boldsymbol{s}\)</span>ï¼Œæ‰€ä»¥ï¼š</p><p><span class="math display">\[\int_L \boldsymbol{F}\cdot\boldsymbol{\tau}\mathrm{d}s=\int_L \boldsymbol{F}\cdot\mathrm{d}\boldsymbol{s}\]</span></p><p>å·¦è¾¹ä¸ºç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†ï¼Œå³è¾¹ä¸ºç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†ï¼Œå¯è§è¿™ä¸¤ç±»ç§¯åˆ†æ˜¯å¯ä»¥äº’ç›¸è½¬åŒ–çš„ã€‚</p><h2 id="äºŒç»´çš„æ•£åº¦å’Œæ—‹åº¦">äºŒç»´çš„æ•£åº¦å’Œæ—‹åº¦</h2><h3 id="é€šé‡">é€šé‡</h3><p>åœ¨è¿ç»­å‘é‡åœº<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}\)</span>ä¸­çš„å…‰æ»‘é—­æ›²çº¿<span class="math inline">\(L\)</span>ï¼Œ<span class="math inline">\(\boldsymbol{n}\)</span>ä¸ºå…‰æ»‘é—­æ›²çº¿<span class="math inline">\(L\)</span>çš„å•ä½æ³•å‘é‡ï¼ˆæŒ‡å‘é—­æ›²çº¿å¤–éƒ¨ï¼‰ï¼Œåˆ™<span class="math inline">\(\boldsymbol{F}\)</span>ç©¿è¿‡<span class="math inline">\(L\)</span>çš„æµé‡ï¼Œå³é€šé‡ä¸ºï¼š</p><p><span class="math display">\[\oint_{L} \boldsymbol{F}\cdot\boldsymbol{n}\mathrm{d}s=\oint_{L}P\mathrm{d}y-Q\mathrm{d}x\]</span></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šå¼ä»ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†å˜ä¸ºäº†ç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†ï¼Œæ›²çº¿çš„æ–¹å‘ä¸ºé€†æ—¶é’ˆã€‚</p><h3 id="æ•£åº¦">æ•£åº¦</h3><p>å·²çŸ¥æ°´æµé‡ä¸ºå‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ã€‚ç”¨æ›²çº¿<span class="math inline">\(L_A\)</span>æ¥è¡¨ç¤º A åœ†ï¼Œé‚£ä¹ˆ A åœ†çš„é€šé‡ä¸ºï¼š</p><p><span class="math display">\[T_A=\oint_{L_A} \boldsymbol{F}\cdot\boldsymbol{n}\mathrm{d}s\]</span></p><p>å‡è®¾ A åœ†å¯¹åº”çš„é¢ç§¯ä¸º<span class="math inline">\(\Omega_A\)</span>ï¼Œåœ†ç¼©åˆ°æœ€å°å³<span class="math inline">\(\Omega_A\to 0\)</span>ï¼ŒåŒæ—¶å†é™¤ä¸Šé¢ç§¯<span class="math inline">\(\Omega_A\)</span>ï¼Œå°±å¾—åˆ°äº†<span class="math inline">\(A\)</span>ç‚¹åœ¨å‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ä¸­çš„é€šé‡å¯†åº¦ï¼Œä¹Ÿç§°ä¸º A ç‚¹åœ¨å‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ä¸­çš„æ•£åº¦ï¼Œå³ï¼š</p><p><span class="math display">\[\operatorname{div}\boldsymbol{F}(A)=\lim_{\Omega_A\to 0}\frac{1}{\Omega_A}\oint_{L_A} \boldsymbol{F}\cdot\boldsymbol{n}\mathrm{d}s\]</span></p><p>åŒæ ·çš„ï¼Œä¹Ÿå¯ä»¥ç®—å‡º C ç‚¹çš„æ•£åº¦<span class="math inline">\(\operatorname{div}\boldsymbol{F}(C)\)</span>ï¼Œä¸¤è€…è°å¤§ï¼Œå°±è¯´æ˜å“ªä¸ªæ°´é¾™å¤´çš„å‡ºæ°´é‡æ›´å¤§ã€‚</p><h3 id="ç¯é‡">ç¯é‡</h3><p>åœ¨è¿ç»­å‘é‡åœº<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}\)</span>ä¸­çš„å…‰æ»‘é—­æ›²çº¿<span class="math inline">\(L\)</span>ï¼Œ<span class="math inline">\(\boldsymbol{\tau}\)</span>ä¸ºå…‰æ»‘é—­æ›²çº¿<span class="math inline">\(L\)</span>çš„å•ä½åˆ‡å‘é‡<span class="math inline">\(\boldsymbol{\tau}\)</span>ï¼ˆæŒ‡å‘é€†æ—¶é’ˆæ–¹å‘ï¼‰ï¼Œåˆ™<span class="math inline">\(\boldsymbol{F}\)</span>å¯¹äº<span class="math inline">\(L\)</span>çš„ç¯é‡ä¸ºï¼š</p><p><span class="math display">\[\oint_{L} \boldsymbol{F}\cdot\boldsymbol{\tau}\mathrm{d}s=\oint_{L}P\mathrm{d}x+Q\mathrm{d}y\]</span></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šå¼ä»ç¬¬ä¸€ç±»æ›²çº¿ç§¯åˆ†å˜ä¸ºäº†ç¬¬äºŒç±»æ›²çº¿ç§¯åˆ†ï¼Œæ›²çº¿çš„æ–¹å‘ä¸ºé€†æ—¶é’ˆã€‚</p><h3 id="æ—‹åº¦">æ—‹åº¦</h3><p>å·²çŸ¥æ°´æµé‡ä¸ºå‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ã€‚ç”¨æ›²çº¿<span class="math inline">\(L_A\)</span>æ¥è¡¨ç¤º<span class="math inline">\(A\)</span>åœ†ï¼Œé‚£ä¹ˆ<span class="math inline">\(A\)</span>åœ†çš„ç¯é‡ä¸ºï¼š</p><p><span class="math display">\[H_A=\oint_{L_A} \boldsymbol{F}\cdot\boldsymbol{\tau}\mathrm{d}s\]</span></p><p>å¯è§ï¼Œç¯é‡ä¼šå—åˆ°åœ†çš„å¤§å°çš„å½±å“ï¼Œæ‰€ä»¥æ¥æ’é™¤æ‰è¿™ä¸ªå½±å“ã€‚å‡è®¾ A åœ†å¯¹åº”çš„é¢ç§¯ä¸º<span class="math inline">\(\Omega_A\)</span>ï¼Œåœ†ç¼©åˆ°æœ€å°å³<span class="math inline">\(\Omega_A\to 0\)</span>ï¼ŒåŒæ—¶å†é™¤ä¸Šé¢ç§¯<span class="math inline">\(\Omega_A\)</span>ï¼Œå°±å¾—åˆ°äº†<span class="math inline">\(A\)</span>ç‚¹åœ¨å‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ä¸­çš„ç¯é‡å¯†åº¦ï¼Œä¹Ÿç§°ä¸º<span class="math inline">\(A\)</span>ç‚¹åœ¨å‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>ä¸­çš„æ—‹åº¦ï¼Œå³ï¼š</p><p><span class="math display">\[\operatorname{curl}\boldsymbol{F}(A)=\lim_{\Omega_A\to 0}\frac{1}{\Omega_A}\oint_{L_A} \boldsymbol{F}\cdot\boldsymbol{\tau}\mathrm{d}s\]</span></p><h2 id="æ ¼æ—å…¬å¼">æ ¼æ—å…¬å¼</h2><h3 id="æ ¼æ—å…¬å¼çš„é€šé‡å½¢å¼">æ ¼æ—å…¬å¼çš„é€šé‡å½¢å¼ï¼š</h3><p>æŸå…‰æ»‘é—­æ›²çº¿ L å›´æˆé—­åŒºåŸŸ Dï¼Œå®šä¹‰åœ¨é—­åŒºåŸŸ D ä¸Šçš„å‘é‡åœº<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}\)</span>ï¼Œå®ƒçš„åˆ†é‡å…·æœ‰ä¸€é˜¶è¿ç»­åå¯¼æ•°ï¼Œåˆ™<span class="math inline">\(\boldsymbol{F}\)</span>å…³äº L çš„é€šé‡ï¼Œå¯é€šè¿‡é—­åŒºåŸŸ D ä¸Šçš„æ•£åº¦æ±‚å‡ºï¼š</p><p><span class="math display">\[\underbrace{\oint_{L} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} s=\oint_{L} P \mathrm{~d} y-Q \mathrm{~d} x}_{\text {é—­æ›²çº¿çš„é€šé‡ }}=\underbrace{\iint_{D} \frac{\partial P}{\partial x}+\frac{\partial Q}{\partial y} \mathrm{~d} x \mathrm{~d} y}_{\text {é—­æ›²çº¿å›´æˆåŒºåŸŸçš„é€šé‡ä¹‹å’Œ }}\]</span></p><h3 id="æ ¼æ—å…¬å¼çš„ç¯é‡å½¢å¼">æ ¼æ—å…¬å¼çš„ç¯é‡å½¢å¼ï¼š</h3><p>æŸå…‰æ»‘é—­æ›²çº¿ L å›´æˆé—­åŒºåŸŸ Dï¼Œå®šä¹‰åœ¨é—­åŒºåŸŸ D ä¸Šçš„å‘é‡åœº<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}\)</span>ï¼Œå®ƒçš„åˆ†é‡å…·æœ‰ä¸€é˜¶è¿ç»­åå¯¼æ•°ï¼Œåˆ™<span class="math inline">\(\boldsymbol{F}\)</span>å…³äº L çš„ç¯é‡ï¼Œå¯é€šè¿‡é—­åŒºåŸŸ D ä¸Šçš„æ—‹åº¦æ±‚å‡ºï¼š</p><p><span class="math display">\[\underbrace{\oint_{L} \boldsymbol{F} \cdot \boldsymbol{\tau} \mathrm{d} s=\oint_{L} P \mathrm{~d} x+Q \mathrm{~d} y}_{\text {é—­æ›²çº¿çš„ç¯é‡ }}=\underbrace{\iint_{D} \frac{\partial Q}{\partial x}-\frac{\partial P}{\partial y} \mathrm{~d} x \mathrm{~d} y}_{\text {é—­æ›²çº¿å›´æˆåŒºåŸŸçš„ç¯é‡ä¹‹å’Œ }}\]</span></p><h3 id="äºŒé‡ç§¯åˆ†çš„åŸºæœ¬å®šç†">äºŒé‡ç§¯åˆ†çš„åŸºæœ¬å®šç†</h3><p><span class="math display">\[\iint_{D} \frac{\partial P}{\partial x}+\frac{\partial Q}{\partial y} \mathrm{~d} x \mathrm{~d} y=\oint_{\partial D} P \mathrm{~d} y-Q \mathrm{~d} x\]</span></p><h2 id="ç¬¬ä¸€ç±»æ›²é¢ç§¯åˆ†">ç¬¬ä¸€ç±»æ›²é¢ç§¯åˆ†</h2><p>è®¾<span class="math inline">\(\Sigma\)</span>ä¸ºä¸‰ç»´ç©ºé—´ä¸­çš„ä¸€ä¸ªå…‰æ»‘æ›²é¢ï¼Œå‡½æ•°<span class="math inline">\(f(x,y)\)</span>åœ¨<span class="math inline">\(\Sigma\)</span>ä¸Šæœ‰ç•Œã€‚æŠŠ<span class="math inline">\(\Sigma\)</span>ä¸Šä»»æ„åˆ†ä¸º<span class="math inline">\(n\)</span>ä¸ªå°æ›²é¢ï¼Œç¬¬<span class="math inline">\(k\)</span>ä¸ªå°æ›²é¢ä¸º<span class="math inline">\(\Delta S_k\)</span>ï¼ˆè¯¥å°æ›²é¢çš„é¢ç§¯ä¹ŸåŒæ ·ç”±<span class="math inline">\(\Delta S_k\)</span>æ¥è¡¨ç¤ºï¼‰ã€‚è®¾ (<span class="math inline">\(\xi_k,\eta_k\)</span>) æ˜¯<span class="math inline">\(\Delta S_k\)</span>ä¸Šä»»æ„å–çš„ä¸€ç‚¹ï¼Œåšä¹˜ç§¯<span class="math inline">\(f(\xi_k,\eta_k)\Delta S_k\)</span>ï¼Œå¹¶ä½œå’Œï¼š</p><p><span class="math display">\[\sum_{k=1}^{n}f(\xi_k,\eta_k)\Delta S_k\]</span></p><p>å¦‚æœå½“å„å°æ›²é¢çš„é¢ç§¯çš„æœ€å¤§å€¼<span class="math inline">\(\lambda\to 0\)</span>æ—¶ï¼Œå’Œçš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œä¸”ä¸æ›²é¢<span class="math inline">\(\Sigma\)</span>çš„åˆ†æ³•åŠç‚¹<span class="math inline">\((\xi_k,\eta_k)\)</span>çš„å–æ³•æ— å…³ï¼Œå°±ç§°è¿™æ­¤æé™ä¸º<span class="math inline">\(f(x,y)\)</span>åœ¨æ›²é¢<span class="math inline">\(\Sigma\)</span>ä¸Šçš„ç¬¬ä¸€ç±»æ›²é¢ç§¯åˆ†ï¼š</p><p><span class="math display">\[\iint_{\Sigma} f(x, y) \mathrm{d} S=\lim _{\lambda \rightarrow 0} \sum_{k=1}^{n} f\left(\xi_{k}, \eta_{k}\right) \Delta S_{k}\]</span></p><p>å…¶ä¸­<span class="math inline">\(\mathrm{d}S\)</span>ç§°ä¸ºæ›²é¢å¾®åˆ†ã€‚</p><h2 id="ç¬¬äºŒç±»æ›²é¢ç§¯åˆ†">ç¬¬äºŒç±»æ›²é¢ç§¯åˆ†</h2><p>å‡è®¾å¤ªé˜³è¡¨é¢ä¸ºé—­çƒé¢<span class="math inline">\(\Sigma\)</span>ï¼Œå°†æ‰€æœ‰çš„å°æ›²é¢çš„é€šé‡åŠ èµ·æ¥å°±å¾—åˆ°é—­çƒé¢<span class="math inline">\(\Sigma\)</span>çš„é€šé‡ï¼Œä¹Ÿå°±æ˜¯å¤ªé˜³çš„é€šé‡ï¼š</p><p><span class="math display">\[\iint_{\Sigma} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} S\]</span></p><p>å…¶ä¸­å•ä½æ³•å‘é‡<span class="math inline">\(\boldsymbol{n}\)</span>å’Œé¢ç§¯å¾®åˆ†<span class="math inline">\(\mathrm{d}S\)</span>ç»„æˆäº†æœ‰å‘æ›²é¢ï¼Œä¹Ÿç§°ä¸ºæœ‰å‘é¢ç§¯å¾®åˆ†ï¼š</p><p><span class="math display">\[\boldsymbol{n}\mathrm{d}S=\mathrm{d}\boldsymbol{S}\]</span></p><p>æ‰€ä»¥é—­çƒé¢<span class="math inline">\(\Sigma\)</span>çš„é€šé‡åˆå¯ä»¥å†™ä½œï¼š</p><p><span class="math display">\[\iint_{\Sigma} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} S=\iint_{\Sigma} \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{S}\]</span></p><p>ä¸Šè¿°ç§¯åˆ†æ˜¯å‘é‡åœº<span class="math inline">\(\boldsymbol{F}\)</span>åœ¨æœ‰å‘é¢ç§¯<span class="math inline">\(\Sigma\)</span>ä¸Šçš„ç§¯åˆ†ï¼Œç§°ä¸ºç¬¬äºŒç±»æ›²é¢ç§¯åˆ†ã€‚</p><h2 id="ä¸‰ç»´çš„æ•£åº¦å’Œæ—‹åº¦">ä¸‰ç»´çš„æ•£åº¦å’Œæ—‹åº¦</h2><h3 id="æ•£åº¦-1">æ•£åº¦</h3><p>å‡è®¾é—­æ›²é¢<span class="math inline">\(\Sigma\)</span>å›´æˆçš„ä½“ç§¯ä¸º<span class="math inline">\(V\)</span>ï¼Œå’ŒäºŒç»´çš„æƒ…å†µä¸€æ ·ï¼Œé€šé‡çš„å¯†åº¦å°±æ˜¯æ•£åº¦ï¼š</p><p><span class="math display">\[\operatorname{div} \boldsymbol{F}=\lim _{V \rightarrow 0} \frac{1}{V} \oiint_{\Sigma} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} S\]</span></p><p>å‡è®¾å‘é‡åœºä¸º<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}+R\boldsymbol{k}\)</span>ï¼Œå¯ä»¥è¯æ˜æ•£åº¦è¿˜æœ‰ä¸€ä¸ªåå¯¼å½¢å¼ï¼ˆè¾ƒå¤æ‚ï¼Œè¯æ˜ç•¥ï¼‰ï¼š</p><p><span class="math display">\[\operatorname{div}\boldsymbol{F}=\frac{\partial P}{\partial x}+\frac{\partial Q}{\partial y}+\frac{\partial R}{\partial z}\]</span></p><h3 id="æ—‹åº¦-1">æ—‹åº¦</h3><p>å‡è®¾ä¸‰ç»´å‘é‡åœºä¸º<span class="math inline">\(\boldsymbol{F}=P\boldsymbol{i}+Q\boldsymbol{j}+R\boldsymbol{k}\)</span>ï¼Œé‚£ä¹ˆä»¥ä¸‹å‘é‡å°±ä¸ºä¸‰ç»´ç©ºé—´ä¸­çš„æ—‹åº¦ï¼š</p><p><span class="math display">\[\operatorname{curl}\boldsymbol{F}=\left(\frac{\partial R}{\partial y}-\frac{\partial Q}{\partial z}\right)\boldsymbol{i}+\left(\frac{\partial P}{\partial z}-\frac{\partial R}{\partial x}\right)\boldsymbol{j}+\left(\frac{\partial Q}{\partial x}-\frac{\partial P}{\partial y}\right)\boldsymbol{k}\]</span></p><p>è¯¥å‘é‡çš„æ¨¡å°±æ˜¯ç¯é‡å¯†åº¦ï¼Œæ–¹å‘å°±æ˜¯æ—‹è½¬è½´å‘é‡ã€‚</p><h2 id="æ ¼æ—å…¬å¼æ–°å½¢å¼">æ ¼æ—å…¬å¼æ–°å½¢å¼</h2><p>é€šè¿‡<span class="math inline">\(\nabla\)</span>ç®—å­ï¼Œæ ¼æ—å…¬å¼çš„é€šé‡å½¢å¼å¯ä»¥æ”¹å†™ä¸ºï¼š</p><p><span class="math display">\[\oint_{\partial D} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} s=\iint_{D} \nabla \cdot \boldsymbol{F} \mathrm{d} A\]</span></p><p>ç¯é‡å½¢å¼å¯ä»¥æ”¹å†™ä¸ºï¼š</p><p><span class="math display">\[\oint_{\partial D} \boldsymbol{F} \cdot \boldsymbol{\tau} \mathrm{d} s=\iint_{D} \nabla \times \boldsymbol{F} \cdot \boldsymbol{k} \mathrm{d} A\]</span></p><p>ç¯é‡å…¬å¼ä¸­çš„<span class="math inline">\(\boldsymbol{k}\mathrm{d}A\)</span>ï¼Œå…¶ä¸­<span class="math inline">\(\mathrm{d}A\)</span>æŒ‡çš„æ˜¯<span class="math inline">\(xy\)</span>é¢ä¸Šçš„å¹³é¢ï¼Œ<span class="math inline">\(\boldsymbol{k}\)</span>æ˜¯<span class="math inline">\(z\)</span>è½´çš„å•ä½æ–¹å‘å‘é‡ï¼Œä¹Ÿå°±æ˜¯<span class="math inline">\(\mathrm{d}A\)</span>çš„å•ä½æ³•å‘é‡ï¼š</p><p>å› æ­¤<span class="math inline">\(\boldsymbol{k}\mathrm{d}A\)</span>å…¶å®è¡¨ç¤ºçš„æ˜¯æœ‰å‘å¹³é¢ï¼š</p><p><span class="math display">\[\boldsymbol{k}\mathrm{d}A=\mathrm{d}\boldsymbol{A}\]</span></p><p>è¿›è€Œï¼Œæ ¼æ—å…¬å¼çš„ç¯é‡å½¢å¼è¿˜å¯ä»¥æ”¹å†™ä¸ºç¬¬äºŒç±»æ›²é¢ç§¯åˆ†çš„å½¢å¼ï¼š</p><p><span class="math display">\[\oint_{\partial D} \boldsymbol{F} \cdot \boldsymbol{\tau} \mathrm{d} s=\iint_{D} \nabla \times \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{A}\]</span></p><h2 id="é«˜æ–¯å…¬å¼å’Œæ–¯æ‰˜å…‹æ–¯å…¬å¼">é«˜æ–¯å…¬å¼å’Œæ–¯æ‰˜å…‹æ–¯å…¬å¼</h2><h3 id="é«˜æ–¯å…¬å¼">é«˜æ–¯å…¬å¼</h3><p>å­˜åœ¨æœ‰å‘å…‰æ»‘é—­æ›²é¢ï¼ˆæˆ–è€…ç”±å‡ ç‰‡æœ‰å‘å…‰æ»‘æ›²é¢ç»„æˆï¼‰<span class="math inline">\(\partial\Omega\)</span>ï¼Œè¯¥æ›²é¢çš„æ­£æ–¹å‘<span class="math inline">\(\boldsymbol{n}\)</span>æŒ‡å‘å¤–éƒ¨ã€‚é—­æ›²é¢<span class="math inline">\(\partial\Omega\)</span>å›´æˆç©ºé—´é—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ï¼Œåœ¨è¯¥é—­åŒºåŸŸ<span class="math inline">\(\Omega\)</span>ä¸Šå®šä¹‰æœ‰å‘é‡å‡½æ•°<span class="math inline">\(\boldsymbol{F}\)</span>ï¼Œå®ƒçš„å„ä¸ªåˆ†é‡å…·æœ‰ä¸€é˜¶è¿ç»­åå¯¼æ•°ã€‚é‚£ä¹ˆæœ‰ï¼š</p><p><span class="math display">\[\underbrace{\int_{\boldsymbol{F}} \boldsymbol{F} \cdot \boldsymbol{n d} S}_{\partial \int_{\text {é—­æ›²é¢çš„é€šé‡ }}}=\underbrace{\iiint_{\Omega} \operatorname{div} \boldsymbol{F} \mathrm{d} V=\iiint_{\Omega} \nabla \cdot \boldsymbol{F} \mathrm{d} V}_{\text {é—­æ›²é¢å›´æˆåŒºåŸŸçš„é€šé‡ä¹‹å’Œ }}\]</span></p><p>è¯¥å®šç†ç§°ä¸ºé«˜æ–¯å…¬å¼æˆ–è€…æ•£åº¦å®šç†ã€‚</p><h3 id="æ–¯æ‰˜å…‹æ–¯å…¬å¼">æ–¯æ‰˜å…‹æ–¯å…¬å¼</h3><p>å‡è®¾å­˜åœ¨æœ‰å‘å…‰æ»‘é—­æ›²çº¿ï¼ˆæˆ–è€…ç”±å‡ ä¸ªæœ‰å‘å…‰æ»‘æ›²çº¿ç»„æˆï¼‰<span class="math inline">\(\partial\Sigma\)</span>ï¼Œè¯¥æœ‰å‘æ›²çº¿<span class="math inline">\(\partial\Sigma\)</span>ä¸ºæœ‰å‘å…‰æ»‘æ›²é¢ï¼ˆæˆ–è€…ç”±å‡ ä¸ªæœ‰å‘å…‰æ»‘æ›²é¢ç»„æˆï¼‰<span class="math inline">\(\Sigma\)</span>çš„è¾¹ç•Œï¼Œä¸”æœ‰å‘æ›²çº¿<span class="math inline">\(\partial\Sigma\)</span>çš„æ–¹å‘<span class="math inline">\(\boldsymbol{\tau}ä¸ã€Sigma\)</span>çš„æ­£å‘<span class="math inline">\(\boldsymbol{n}\)</span>ç¬¦åˆå³æ‰‹æ³•åˆ™ã€‚åœ¨è¯¥æœ‰å‘æ›²é¢<span class="math inline">\(\Sigma\)</span>ä¸Šå®šä¹‰æœ‰å‘é‡å‡½æ•°<span class="math inline">\(\boldsymbol{F}\)</span>ï¼Œå®ƒçš„å„ä¸ªåˆ†é‡å…·æœ‰ä¸€é˜¶è¿ç»­åå¯¼æ•°ã€‚é‚£ä¹ˆæœ‰ï¼š</p><p><span class="math display">\[\underbrace{\oint_{\partial \Sigma} \boldsymbol{F} \cdot \boldsymbol{d} s}_{\text {æœ‰å‘é—­æ›²çº¿çš„ç¯é‡ }}=\underbrace{\iint_{\Sigma} \operatorname{curl} \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{S}=\iint_{\Sigma} \nabla \times \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{S}}_{\text {æœ‰å‘é—­æ›²çº¿å›´æˆæœ‰å‘æ›²é¢çš„ç¯é‡ä¹‹å’Œ }}\]</span></p><p>è¯¥å®šç†ç§°ä¸ºæ–¯æ‰˜å…‹æ–¯å…¬å¼ã€‚</p><h1 id="å°ç»“">å°ç»“</h1><p>åœ¨äºŒç»´å¹³é¢ä¸­ï¼Œæ ¼æ—å…¬å¼æœ‰ä¸¤ç§å½¢å¼ï¼Œé€šé‡å½¢å¼å’Œç¯é‡å½¢å¼ï¼š</p><p><span class="math display">\[\begin{gathered}\oint_{\partial D} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} s=\iint_{D} \operatorname{div} \boldsymbol{F} \mathrm{d} A=\iint_{D} \nabla \cdot \boldsymbol{F} \mathrm{d} A \\\oint_{\partial D} \boldsymbol{F} \cdot \boldsymbol{\tau} \mathrm{d} s=\iint_{D} \operatorname{curl} \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{A}=\iint_{D} \nabla \times \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{A}\end{gathered}\]</span></p><p>åœ¨ä¸‰ç»´ç©ºé—´ä¸­ï¼Œé€šé‡å½¢å¼æ‰©å±•ä¸ºäº†é«˜æ–¯å…¬å¼ï¼š</p><p><span class="math display">\[\oiint_{\partial \Omega} \boldsymbol{F} \cdot \boldsymbol{n} \mathrm{d} S=\iiint_{\Omega} \operatorname{div} \boldsymbol{F} \mathrm{d} V=\iiint_{\Omega} \nabla \cdot \boldsymbol{F} \mathrm{d} V\]</span></p><p>ç¯é‡å½¢å¼æ‰©å±•ä¸ºäº†æ–¯æ‰˜å…‹æ–¯å…¬å¼ï¼š</p><p><span class="math display">\[\oint_{\partial \Sigma} \boldsymbol{F} \cdot \boldsymbol{\tau} \mathrm{d} s=\iint_{\Sigma} \operatorname{curl} \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{S}=\iint_{\Sigma} \nabla \times \boldsymbol{F} \cdot \mathrm{d} \boldsymbol{S}\]</span></p><blockquote><p>å…³äºæ— ç©·çº§æ•°è¿™é‡Œä¸åˆ—å‡ºäº†ï¼Œåé¢åœ¨æ•°å­¦ç‰©ç†æ–¹æ³•ä¸­å†åˆ—å‡ºã€‚</p></blockquote><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé©¬åŒå­¦çš„å¤šå˜é‡å¾®ç§¯åˆ†è¯¾ç¨‹ã€‹<br>æ„Ÿå…´è¶£çš„å¯ä»¥è´­ä¹°ä»–çš„è¯¾ç¨‹ï¼Œå†™çš„å¾ˆå¥½ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼ï¼ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Science Thought </category>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Linear Algebra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¾®ç§¯åˆ†ï¼ˆä¸Šï¼‰</title>
      <link href="/2022/Science/CalculusPart1/"/>
      <url>/2022/Science/CalculusPart1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/advanced_mathematics.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjExZTM0N2U0MDFmZDU4N2IzYTIxZGU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æé™">æé™</h1><h2 id="é­å°”æ–¯ç‰¹æ‹‰æ–¯çš„æ•°åˆ—æé™">é­å°”æ–¯ç‰¹æ‹‰æ–¯çš„æ•°åˆ—æé™</h2><p>è®¾<span class="math inline">\({x_n}\)</span>ä¸ºä¸€æ•°åˆ—ï¼Œå¦‚æœå­˜åœ¨å®æ•° Lï¼Œå¯¹äºä»»æ„ç»™å®šçš„æ­£å®æ•°<span class="math inline">\(\epsilon\)</span>ï¼ˆä¸è®ºå®ƒå¤šä¹ˆå°ï¼‰ï¼Œæ€»å­˜åœ¨æ­£æ•´æ•° Nï¼Œä½¿å¾—å¯¹æ‰€æœ‰çš„ n &gt; N æ—¶ï¼Œæœ‰ï¼š</p><p><span class="math display">\[\left|x_{n}-L\right|&lt;\epsilon\]</span></p><p>é‚£ä¹ˆå°±ç§° L æ˜¯æ•°åˆ—<span class="math inline">\({x_n}\)</span>çš„æé™ï¼Œæˆ–è€…ç§°æ•°åˆ—<span class="math inline">\({x_n}\)</span>æ”¶æ•›äº Lï¼Œè®°ä¸ºï¼š</p><p><span class="math display">\[\begin{gathered}\lim _{n \rightarrow \infty} x_{n}=L \end{gathered}\]</span> æˆ– <span class="math display">\[\begin{gathered}x_{n} \rightarrow L(n \rightarrow \infty)\end{gathered}\]</span></p><h2 id="ä¸€èˆ¬å‡½æ•°çš„æé™å®šä¹‰">ä¸€èˆ¬å‡½æ•°çš„æé™å®šä¹‰</h2><p>è®¾å‡½æ•° f(x) åœ¨<span class="math inline">\(\mathring{U}(x_0)\)</span>ä¸Šæœ‰å®šä¹‰ã€‚ å¦‚æœå­˜åœ¨å¸¸æ•° Lï¼Œå¯¹ä»»æ„ç»™å®šçš„æ­£æ•°<span class="math inline">\(\epsilon\)</span>ï¼ˆä¸è®ºå®ƒå¤šä¹ˆå°ï¼‰ï¼Œæ€»å­˜åœ¨æ­£æ•°<span class="math inline">\(\delta\)</span>ï¼Œä½¿å¾—å½“ x æ»¡è¶³ä¸ç­‰å¼<span class="math inline">\(0 &lt; |x - x_0| &lt; \delta\)</span>æ—¶ï¼Œå¯¹åº”çš„å‡½æ•°å€¼ f(x) éƒ½æ»¡è¶³ä¸ç­‰å¼ï¼š</p><p><span class="math display">\[\left|f(x)-L\right|&lt;\epsilon\]</span></p><p>é‚£ä¹ˆå¸¸æ•° L å°±å«åšå‡½æ•° f(x) å½“<span class="math inline">\(x\to x_0\)</span>çš„æé™ï¼Œè®°ä½œï¼š</p><p><span class="math display">\[\lim _{x \rightarrow x_{0}} f(x)=L \text { æˆ– } f(x) \rightarrow L\left(\text { å½“ } x \rightarrow x_{0}\right)\]</span></p><h2 id="è¶‹äºpminftyçš„å‡½æ•°æé™å®šä¹‰">è¶‹äº<span class="math inline">\(\pm\infty\)</span>çš„å‡½æ•°æé™å®šä¹‰</h2><p>å¦‚æœå­˜åœ¨å¸¸æ•° Lï¼Œå¯¹äºä»»æ„ç»™å®šçš„æ­£æ•°<span class="math inline">\(\epsilon\)</span>ï¼ˆä¸è®ºå®ƒå¤šä¹ˆå°ï¼‰ï¼Œæ€»å­˜åœ¨ç€æ­£æ•° Xï¼Œä½¿å¾—å½“ x æ»¡è¶³ä¸ç­‰å¼<span class="math inline">\(|x| &gt; X\)</span>æ—¶ï¼Œå¯¹åº”çš„å‡½æ•°å€¼ f(x) æ»¡è¶³ä¸ç­‰å¼ï¼š</p><p><span class="math display">\[\left|f(x)-L\right|&lt;\epsilon\]</span></p><p>é‚£ä¹ˆå¸¸æ•° L å°±å«åšå‡½æ•° f(x) å½“<span class="math inline">\(x\to\pm\infty\)</span>æ—¶çš„æé™ï¼Œè®°åšï¼š</p><p><span class="math display">\[\lim _{x \rightarrow \pm \infty} f(x)=L\]</span></p><h2 id="æ— ç©·å°ä¸æ— ç©·å¤§">æ— ç©·å°ä¸æ— ç©·å¤§</h2><p>å¯¹äºæ•°åˆ—<span class="math inline">\(a={a_n}\)</span>ï¼Œå¦‚æœæ»¡è¶³ï¼š</p><p><span class="math display">\[\lim _{n \rightarrow \infty} a_{n}=0\]</span></p><p>åˆ™ç§°æ•°åˆ— a ä¸º<span class="math inline">\(n\to\infty\)</span>æ—¶çš„æ— ç©·å°ã€‚</p><p>å¯¹äºå‡½æ•°<span class="math inline">\(f(x)\)</span>ï¼Œå¦‚æœæ»¡è¶³ï¼š</p><p><span class="math display">\[\lim f(x)=0\]</span></p><p>åˆ™ç§°å‡½æ•°<span class="math inline">\(f(x)\)</span>ä¸ºæ­¤è‡ªå˜é‡å˜åŒ–è¿‡ç¨‹ï¼ˆæŒ‡<span class="math inline">\(x\to x_0,x\to+\infty\)</span>ç­‰ï¼‰çš„æ— ç©·å°ã€‚</p><p>è®¾å‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\(x_0\)</span>çš„æŸä¸€å»å¿ƒé‚»åŸŸå†…æœ‰å®šä¹‰ï¼Œå¦‚æœå¯¹äºä»»æ„ç»™å®šçš„æ­£æ•° Mï¼ˆä¸è®ºå®ƒå¤šä¹ˆå¤§ï¼‰ï¼Œæ€»å­˜åœ¨æ­£æ•°<span class="math inline">\(\delta\)</span>ï¼Œåªè¦<span class="math inline">\(x\)</span>é€‚åˆä¸ç­‰å¼<span class="math inline">\(0 &lt; |x-x_0| &lt; \delta\)</span>ï¼Œå¯¹åº”çš„å‡½æ•°å€¼<span class="math inline">\(f(x)\)</span>æ€»æ»¡è¶³ä¸ç­‰å¼</p><p><span class="math display">\[f(x) &gt; M\]</span></p><p>é‚£ä¹ˆæœ‰ï¼š</p><p><span class="math display">\[\lim _{x \rightarrow x_{0}} f(x)=+\infty\]</span></p><blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ€ªèƒ 0ï¼Œ0 åˆ°åº•æ˜¯ä¸æ˜¯æ— ç©·å°å‘¢ï¼Ÿåœ¨åŒæµå¤§å­¦çš„é«˜ç­‰æ•°å­¦æ•™æé‡Œå°† 0 è§†ä¸ºæ— ç©·å°ã€‚å› ä¸ºå®ƒæŠŠå¸¸æ•° 0 çœ‹ä½œå¸¸å€¼å‡½æ•°<span class="math inline">\(f(x)\equiv 0\)</span>ã€‚ä½†æ˜¯æˆ‘ä¸ªäººéå¸¸ä¸å–œæ¬¢æŠŠ 0 è§†ä¸ºæ— ç©·å°ï¼Œç¬¬ä¸€ï¼šæ— ç©·å°ä¸æ˜¯ä¸€ä¸ªå®æ•°ï¼Œä¸ç„¶å°±å¯ä»¥é€šè¿‡é™¤ä»¥äºŒå¾—åˆ°æ¯”ä»–æ›´æ¥è¿‘ 0 çš„æ•°ï¼Œè€Œæ— ç©·å°æ˜¯æœ€æ¥è¿‘ 0 çš„ã€‚ç¬¬äºŒï¼šæˆ‘ä»¬åœ¨å¾®ç§¯åˆ†ä¸­åˆ†æ¯ç»å¸¸å‡ºç°æ— ç©·å°ï¼Œéœ€è¦å•ç‹¬è¯´æ˜å°† 0 æ’é™¤ï¼Œå¾ˆä¸çˆ½ã€‚ä½†æ˜¯æœ‰å¾ˆå¤šæ—¶å€™å¯ä»¥å°†æ— ç©·å°ç›´æ¥ç”¨ 0 ä»£æ›¿ï¼Œä½¿ç”¨ä¸Šåˆå¾ˆæ–¹ä¾¿ã€‚</p></blockquote><h2 id="å¤¹é€¼å®šç†">å¤¹é€¼å®šç†</h2><p>æœ‰æ—¶å€™æé™çš„æ±‚å–æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œè¿™æ—¶æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯å¤¹é€¼å®šç†å¯ä»¥å¸®æˆ‘ä»¬æ›´å¥½çš„æ‰¾åˆ°æ•°åˆ—æˆ–å‡½æ•°çš„æé™ï¼š</p><p>å¦‚æœæ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š</p><p><span class="math display">\[\exists \delta&gt;0, \forall x \in \stackrel{O}{U}\left(x_{0}, \delta\right), g(x) \leq f(x) \leq h(x)\]</span></p><p><span class="math display">\[\lim _{x \rightarrow x_{0}} g(x)=\lim _{x \rightarrow x_{0}} h(x)=L\]</span></p><p>é‚£ä¹ˆï¼š</p><p><span class="math display">\[\lim _{x \rightarrow x_{0}} f(x)=L\]</span></p><p>å½“ç„¶æ•°åˆ—çš„å¤¹é€¼å®šç†å®šä¹‰ä¹Ÿç±»ä¼¼ï¼Œè¿™é‡Œä¸å†åˆ—å‡ºã€‚</p><h2 id="è¿ç»­å’Œé—´æ–­çš„å®šä¹‰">è¿ç»­å’Œé—´æ–­çš„å®šä¹‰</h2><p>è®¾å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>çš„æŸä¸€é‚»åŸŸå†…æœ‰å®šä¹‰ï¼Œå¦‚æœï¼š <span class="math display">\[\lim _{x \rightarrow x_{0}} f(x)=f\left(x_{0}\right)\]</span></p><p>é‚£ä¹ˆå°±ç§°å‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>è¿ç»­ã€‚</p><p>è¿ç»­è®¨è®ºçš„å‰ææ˜¯<span class="math inline">\(f(x)\)</span>åœ¨é‚»åŸŸä¸Šæœ‰å®šä¹‰ï¼Œè€Œé—´æ–­è®¨è®ºçš„å‰ææ˜¯<span class="math inline">\(f(x)\)</span>åœ¨å»å¿ƒé‚»åŸŸä¸Šæœ‰å®šä¹‰ã€‚åœ¨æ­¤å‰æä¸‹ï¼Œå¦‚æœå‡½æ•°æœ‰ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼š</p><ul><li>åœ¨<span class="math inline">\(x=x_0\)</span>æ²¡æœ‰å®šä¹‰ã€‚</li><li>è™½åœ¨<span class="math inline">\(x=x_0\)</span>æœ‰å®šä¹‰ï¼Œä½†<span class="math inline">\(\lim_{x\to x_0}f(x)\)</span>ä¸å­˜åœ¨ã€‚</li><li>è™½åœ¨<span class="math inline">\(x=x_0\)</span>æœ‰å®šä¹‰ï¼Œä¸”<span class="math inline">\(\lim_{x\to x_0}f(x)\)</span>å­˜åœ¨ï¼Œä½†<span class="math inline">\(\lim_{x\to x_0}f(x)\neq f(x_0)\)</span>ã€‚</li></ul><p>é‚£ä¹ˆå‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>ä¸ºä¸è¿ç»­ï¼Œè€Œç‚¹<span class="math inline">\(x_0\)</span>ç§°ä¸ºå‡½æ•°<span class="math inline">\(f(x)\)</span>çš„ä¸è¿ç»­ç‚¹æˆ–é—´æ–­ç‚¹ã€‚</p><blockquote><p>æ‰€æœ‰çš„åŸºæœ¬åˆç­‰å‡½æ•°éƒ½æ˜¯è¿ç»­å‡½æ•°ã€‚åŸºæœ¬åˆç­‰å‡½æ•°è¿›è¡Œæœ‰é™æ¬¡çš„å››åˆ™è¿ç®—å’Œæœ‰é™æ¬¡çš„å¤åˆï¼Œå¾—åˆ°çš„å‡½æ•°ç§°ä¸ºåˆç­‰å‡½æ•°ï¼Œåˆç­‰å‡½æ•°ä¹Ÿéƒ½æ˜¯è¿ç»­å‡½æ•°ã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><p>åœ¨å¾®ç§¯åˆ†ä¸­æ ¸å¿ƒæ€æƒ³å°±æ˜¯å¯¹è‡ªå˜é‡è¿›è¡Œæ— çº¿ç»†åˆ†ï¼Œä»¥ç›´ä»£æ›²ã€æ— çº¿é€¼è¿‘ï¼Œè€Œè¿™äº›éƒ½è®¾è®¡æ— ç©·å°é‡ï¼Œä¸ºäº†å¯¹æ— ç©·å°é‡è¿›è¡Œå®šä¹‰ï¼Œé¦–å…ˆéœ€è¦ç ”ç©¶æé™ï¼Œæ— ç©·å°é‡å°±æ˜¯é€šè¿‡æé™æ¥å®šä¹‰çš„ã€‚æé™çš„å®šä¹‰ç»å†äº†æŸ¯è¥¿æé™å®šä¹‰ï¼Œç›´åˆ°é­å°”æ–¯ç‰¹æ‹‰æ–¯ç»™å‡ºä¸¥æ ¼çš„æ•°å­¦å®šä¹‰ï¼Œåˆ†ä¸ºç¦»æ•£å˜é‡ï¼ˆæ•°åˆ—ï¼‰å’Œè¿ç»­å˜é‡ï¼ˆå‡½æ•°ï¼‰çš„å®šä¹‰ï¼›æœ‰äº†æé™å°±å¯ä»¥å®šä¹‰æ— ç©·å°å’Œæ— ç©·å¤§ã€‚è¿›è€Œç ”ç©¶äº†æ— ç©·å°å’Œæ— ç©·å¤§ç›¸å…³æ€§è´¨ï¼Œæœ€åç»™å‡ºç ”ç©¶å¾®ç§¯åˆ†éå¸¸é‡è¦çš„æ¡ä»¶è¿ç»­çš„å®šä¹‰ï¼Œè¿™ä¸€åˆ‡éƒ½ç¦»ä¸å¼€æé™çš„å®šä¹‰ï¼Œå¯ä»¥è¯´æé™çš„å®šä¹‰ä¸ºå¾®ç§¯åˆ†é“ºå¹³äº†é“è·¯ï¼Œåé¢çš„å¾®ç§¯åˆ†ä½ ä¼šå‘ç°æ— ä¸€ä¸æ˜¯æé™ã€‚</p><h1 id="å¾®åˆ†">å¾®åˆ†</h1><h2 id="å¾®åˆ†çš„å®šä¹‰">å¾®åˆ†çš„å®šä¹‰</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/math_tangent.png"></p><p>ä¸€æ¡æ›²çº¿ä¸ŠæŸç‚¹çš„å‰²çº¿ï¼Œå½“å¦ä¸€ä¸ªäº¤ç‚¹é€æ¸é è¿‘è¿™ç‚¹æ—¶ï¼Œå–æé™å°±æ˜¯åˆ‡çº¿ï¼Œå³å‰²çº¿çš„æé™æ˜¯åˆ‡çº¿ã€‚ç”±ä¸Šå›¾å¯çŸ¥ï¼š</p><p><span class="math display">\[åˆ‡çº¿çš„æ–œç‡ = \lim _{x \rightarrow x_{0}} \frac{f(x)-f\left(x_{0}\right)}{x-x_{0}}\]</span></p><p>è¿™ä¸ªæé™å°±è¢«ç§°ä¸ºå¯¼æ•°ï¼š</p><p>è®¾å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>çš„æŸä¸ªé‚»åŸŸå†…æœ‰å®šä¹‰ï¼Œå½“è‡ªå˜é‡<span class="math inline">\(x\)</span>åœ¨<span class="math inline">\(x_0\)</span>å¤„å–å¾—å¢é‡<span class="math inline">\(\Delta x\)</span>ï¼ˆç‚¹<span class="math inline">\(x_0+\Delta x\)</span>ä»åœ¨è¯¥é‚»åŸŸå†…ï¼‰æ—¶ï¼Œç›¸åº”çš„ï¼Œå› å˜é‡å–å¾—å¢é‡<span class="math inline">\(\Delta y=f(x_0+\Delta x)-f(x_0)\)</span>ã€‚ å¦‚æœ<span class="math inline">\(\Delta y\)</span>ä¸<span class="math inline">\(\Delta x\)</span>ä¹‹æ¯”å½“<span class="math inline">\(\Delta x\to 0\)</span>æ—¶çš„æé™å­˜åœ¨ï¼Œé‚£ä¹ˆç§°å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>å¤„å¯å¯¼ï¼Œå¹¶ç§°è¿™ä¸ªæé™ä¸ºå‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>å¤„çš„å¯¼æ•°ï¼Œè®°ä¸º<span class="math inline">\(f'(x_0)\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[f^{\prime}\left(x_{0}\right)=\lim _{\Delta x \rightarrow 0} \frac{\Delta y}{\Delta x}=\lim _{\Delta x \rightarrow 0} \frac{f\left(x_{0}+\Delta x\right)-f\left(x_{0}\right)}{\Delta x}\]</span></p><p>æœ‰äº†å¯¼æ•°<span class="math inline">\(f'(x_0)\)</span>ä¹‹åï¼Œå†çŸ¥é“åˆ‡ç‚¹<span class="math inline">\(A=(x_0,f(x_0))\)</span>ï¼Œå°±å¯ä»¥ç”¨ç›´çº¿çš„ç‚¹æ–œå¼å¾—åˆ°åˆ‡çº¿å‡½æ•°ï¼š</p><p><span class="math display">\[g(x)=f^{\prime}\left(x_{0}\right)\left(x-x_{0}\right)+f\left(x_{0}\right)\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/Derivative.png"></p><p><span class="math inline">\(\textrm{d}y\)</span>è¢«ç§°ä¸ºçº¿æ€§å¢é‡ï¼ŒåŒç†<span class="math inline">\(\Delta y\)</span>è¢«ç§°ä¸ºæ›²çº¿å¢é‡ï¼Œå®šä¹‰äº†çº¿æ€§å¢é‡å’Œæ›²çº¿å¢é‡åï¼Œåˆ‡çº¿å¯¹æ›²çº¿çš„è¿‘ä¼¼ç”¨ä¸€ä¸ªä»£æ•°å¼å°±å¯ä»¥æ¸…æ¥šè¡¨ç¤ºï¼š</p><p><span class="math display">\[\Delta y-\mathrm{d} y=o(\Delta x)\]</span></p><p>è¿™ä¸ªä»£æ•°æ¢ä¸ªå½¢å¼å°±æ˜¯ï¼š</p><p><span class="math display">\[\lim _{\Delta x \rightarrow 0}[\Delta y-\mathrm{d} y]=0\]</span></p><p>è¿™ä¸ªä»£æ•°å¼çš„æ„æ€å°±æ˜¯ï¼Œéšç€<span class="math inline">\(\Delta x\)</span>ç¼©å°ï¼Œ<span class="math inline">\(\textrm{d}y\)</span>å’Œ<span class="math inline">\(\Delta y\)</span>ä¼šæ— é™æ¥è¿‘ï¼š</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬ç»ˆäºå¯ä»¥ç»™å‡ºå¾®åˆ†çš„å®šä¹‰ï¼š</p><p>è®¾å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨æŸåŒºé—´å†…æœ‰å®šä¹‰ï¼Œ<span class="math inline">\(x_0\)</span>åŠ<span class="math inline">\(x_0+\Delta x\)</span>åœ¨æ­¤åŒºé—´å†…ï¼Œå¦‚æœå‡½æ•°å¢é‡ï¼š</p><p><span class="math display">\[\Delta y=f\left(x_{0}+\Delta x\right)-f\left(x_{0}\right)\]</span></p><p>å¯è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[\Delta y=A \Delta x+o(\Delta x)\]</span></p><p>å…¶ä¸­<span class="math inline">\(A\)</span>æ˜¯ä¸ä¾èµ–äº<span class="math inline">\(\Delta x\)</span>çš„å¸¸æ•°ï¼Œé‚£ä¹ˆç§°å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>æ˜¯å¯å¾®çš„ï¼Œè€Œ<span class="math inline">\(A\Delta x\)</span>å«ä½œå‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨ç‚¹<span class="math inline">\(x_0\)</span>ç›¸åº”äºè‡ªå˜é‡å¢é‡<span class="math inline">\(\Delta x\)</span>çš„å¾®åˆ†ï¼Œè®°ä½œ<span class="math inline">\(\textrm{d}y\)</span>ï¼Œå³ï¼š</p><p><span class="math display">\[\mathrm{d} y=A \Delta x\]</span></p><h2 id="å¯¼å‡½æ•°">å¯¼å‡½æ•°</h2><p>è®¾å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨å¼€åŒºé—´<span class="math inline">\(I\)</span>å†…çš„æ¯ç‚¹å¤„éƒ½å¯å¯¼ï¼Œåˆ™ç§°å‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨å¼€åŒºé—´<span class="math inline">\(I\)</span>å†…å¯å¯¼ã€‚ è¿™æ—¶ï¼Œå¯¹äºä»»æ„<span class="math inline">\(x\in I\)</span>ï¼Œéƒ½å¯¹åº”ç€<span class="math inline">\(f(x)\)</span>çš„ä¸€ä¸ªç¡®å®šçš„å¯¼æ•°å€¼ï¼Œè¿™å°±æ„æˆäº†æ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å«ä½œ<span class="math inline">\(y=f(x)\)</span>çš„å¯¼å‡½æ•°ï¼Œè®°ä½œ<span class="math inline">\(y'\)</span>æˆ–<span class="math inline">\(f'(x)ã€\frac{\textrm{d}y}{\textrm{d}x}ã€\frac{\textrm{d}f(x)}{\textrm{d}x}\)</span>ï¼Œå®šä¹‰å¼ä¸ºï¼š</p><p><span class="math display">\[y^{\prime}=\lim _{\Delta x \rightarrow 0} \frac{f(x+\Delta x)-f(x)}{\Delta x}\]</span></p><p>å¯¼æ•°æ˜¯æŸä¸€ç‚¹åˆ‡çº¿çš„æ–œç‡ï¼Œå¯¼å‡½æ•°å°±æ˜¯åŒºé—´å†…æ‰€æœ‰ç‚¹çš„åˆ‡çº¿çš„æ–œç‡æ„æˆçš„å‡½æ•°ï¼š</p><p>æœ‰äº†å¯¼å‡½æ•°åï¼Œå°±å¯ä»¥å¾—åˆ°å‡½æ•°çš„å¾®åˆ†ï¼š</p><p><span class="math display">\[\mathrm{d} y=f^{\prime}(x) \mathrm{d} x\]</span></p><p>æ‰€ä»¥å‡½æ•°çš„å¾®åˆ†å®é™…ä¸Šæ˜¯ä¸€ä¸ªäºŒå…ƒå‡½æ•°ï¼Œæ³¨æ„åŒºåˆ†<span class="math inline">\(x\)</span>å’Œ<span class="math inline">\(dx\)</span>ï¼Œæˆ–è®¸å†™æˆè¿™æ ·æ›´æ˜ç¡®ï¼š</p><p><span class="math display">\[\mathrm{d} y=f^{\prime}(x) \mathrm{d} x \Longrightarrow h(x, \mathrm{~d} x)=f^{\prime}(x) \mathrm{d} x\]</span></p><h2 id="æ±‚å¯¼ä»¥åŠå¯¼æ•°çš„è¿ç®—æ³•åˆ™">æ±‚å¯¼ä»¥åŠå¯¼æ•°çš„è¿ç®—æ³•åˆ™</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/DerivativesOfElementaryFunctions.png"></p><p>å¾®åˆ†æ˜¯å¯¼æ•°å’Œ<span class="math inline">\(dx\)</span>çš„ä¹˜ç§¯ï¼Œå› æ­¤å¯¼æ•°çš„æ±‚å–åŠå…¶è¿ç®—æ³•åˆ™å°±ç›¸å½“é‡è¦ï¼Œå…³äºåˆç­‰å‡½æ•°æ±‚å¯¼æ³•åˆ™è¿™é‡Œä¸åšè¯¦è¿°ï¼Œä¼šæŸ¥è¡¨å³å¯ã€‚ä¸‹é¢åˆ—å‡ºå¯¼æ•°çš„è¿ç®—æ³•åˆ™ï¼š</p><ul><li><p>å’Œå·®ï¼š <span class="math display">\[  [u(x) \pm v(x)]^{\prime}=u^{\prime}(x) \pm v^{\prime}(x)  \]</span></p></li><li><p>ç§¯ï¼š <span class="math display">\[  [u(x) v(x)]^{\prime}=u^{\prime}(x) v(x)+u(x) v^{\prime}(x)  \]</span></p></li><li><p>å•†ï¼š <span class="math display">\[  \left[\frac{u(x)}{v(x)}\right]^{\prime}=\frac{u^{\prime}    (x) v(x)-u(x) v^{\prime}(x)}{v^{2}(x)}(v(x) \neq 0)  \]</span></p></li><li><p>å¤åˆå‡½æ•°æ±‚å¯¼ï¼ˆé“¾å¼æ³•åˆ™ï¼‰ï¼š å¦‚æœ<span class="math inline">\(u=g(x)\)</span>åœ¨ç‚¹<span class="math inline">\(a\)</span>å¯å¯¼ï¼Œè€Œ<span class="math inline">\(y=f(u)\)</span>åœ¨ç‚¹<span class="math inline">\(b=g(a)\)</span>å¯å¯¼ï¼Œé‚£ä¹ˆå¤åˆå‡½ æ•°<span class="math inline">\(y=f[g(x)]\)</span>åœ¨ç‚¹<span class="math inline">\(a\)</span>å¯å¯¼ï¼Œä¸”å…¶å¯¼æ•°ä¸ºï¼š</p><p><span class="math display">\[  \frac{\mathrm{d} y}{\mathrm{~d} x}=f^{\prime}(b) g^ {\prime}(a)  \]</span></p><p>æˆ–</p><p><span class="math display">\[  \frac{\mathrm{d} y}{\mathrm{~d} x}=\frac{\mathrm{d} y}  {\mathrm{~d} u} \cdot \frac{\mathrm{d} u}{\mathrm{~d} x}  \]</span></p></li><li><p>åå‡½æ•°æ±‚å¯¼ï¼š å¦‚æœå‡½æ•°<span class="math inline">\(y=f(x)\)</span>åœ¨åŒºé—´<span class="math inline">\(I\)</span>å†…å•è°ƒã€å¯å¯¼ä¸”<span class="math inline">\(f'(x)\neq 0\)</span>ï¼Œé‚£ä¹ˆå®ƒçš„å å‡½æ•°<span class="math inline">\(f^{-1}(x)\)</span>åœ¨åŒºé—´<span class="math inline">\(\{y=f(x), x\in I\}\)</span>å†…ä¹Ÿå¯å¯¼ã€‚ä¸”ï¼š</p><p><span class="math display">\[  \left[f^{-1}(y)\right]^{\prime}=\frac{1}{f^{\prime}(x)}  \]</span></p></li><li>éšå‡½æ•°æ±‚å¯¼ï¼š<ul><li>ç¬¬ä¸€æ­¥ï¼Œå¯¹æ–¹ç¨‹ä¸¤è¾¹æ±‚å…³äº <span class="math inline">\(x\)</span>çš„å¾®åˆ†ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå…³äº <span class="math inline">\(y'\)</span> çš„ æ–¹ç¨‹ï¼›</li><li>ç¬¬äºŒæ­¥ï¼Œåœ¨å¾®åˆ†åçš„æ–¹ç¨‹ä¸­æ±‚è§£<span class="math inline">\(y'\)</span>æ—¢å¯ã€‚</li></ul></li><li><p>å‚æ•°æ–¹ç¨‹æ±‚å¯¼ï¼š å¯¹äºå‚æ•°æ–¹ç¨‹ï¼š</p><p><span class="math display">\[  \left\{\begin{array}{l}  x=x(t) \\  y=y(t)  \end{array}\right.  \]</span></p><p>å…¶ä¸­<span class="math inline">\(x(t)\)</span>å’Œ<span class="math inline">\(y(t)\)</span>å¯å¯¼ï¼Œä¸”<span class="math inline">\(x(t)\)</span>å•è°ƒï¼Œ <span class="math inline">\(x'(t)\neq 0\)</span>ï¼Œåˆ™ï¼š</p><p><span class="math display">\[  \frac{\mathrm{d} y}{\mathrm{~d} x}=\frac{y^{\prime}(t)}{x^  {\prime}(t)}  \]</span></p></li></ul><p>å…³äºé«˜é˜¶å¯¼æ•°å®šä¹‰å’Œè¿ç®—è¿™é‡Œä¸å†åˆ—å‡ºã€‚</p><h2 id="å¾®åˆ†ç›¸å…³æ€§è´¨">å¾®åˆ†ç›¸å…³æ€§è´¨</h2><p>å‰é¢æˆ‘ä»¬å·²ç»æåˆ°å¾®åˆ†ä»¥åŠå¯¼æ•°çš„å®šä¹‰ä»¥åŠå¦‚ä½•æ±‚å–ï¼Œä¸‹é¢å°±æ˜¯å…³äºå¾®åˆ†ç›¸å…³æ€§è´¨çš„ç ”ç©¶äº†ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯å‡ ä¸ªä¸­å€¼å®šç†ã€‚</p><ul><li><p>è´¹é©¬å¼•ç†ï¼š <span class="math display">\[  \left.\begin{array}{c}  f(a) \text { ä¸ºæå€¼ç‚¹ } \\  x=a \text { ç‚¹å¯å¯¼ }  \end{array}\right\} \Longrightarrow f^{\prime}(a)=0  \]</span></p><p>è¿™å°±æ˜¯è´¹é©¬å¼•ç†ã€‚</p><p>å…¶ä¸­æå€¼ç‚¹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>å·²çŸ¥å‡½æ•°<span class="math inline">\(y=f(x)\)</span>ï¼Œåˆ™ï¼š<ul><li><span class="math inline">\(f(a)\)</span>æ˜¯æå¤§å€¼ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(\exists\delta &gt; 0ï¼Œ\forall x\in \mathring{U}(a,\delta)\)</span>ï¼Œæœ‰<span class="math inline">\(f(x) &lt; f(a)\)</span></li><li><span class="math inline">\(f(a)\)</span>æ˜¯æå°å€¼ï¼Œå½“ä¸”ä»…å½“<span class="math inline">\(\exists\delta &gt; 0ï¼Œ\forall x\in \mathring{U}(a,\delta)\)</span>ï¼Œæœ‰<span class="math inline">\(f(x) &gt; f(a)\)</span></li></ul></li><li>ç½—å°”ä¸­å€¼å®šç†ï¼š è®¾å‡½æ•°æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼š<ul><li><span class="math inline">\(f(x)\)</span>åœ¨é—­åŒºé—´<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­</li><li><span class="math inline">\(f(x)\)</span>åœ¨å¼€åŒºé—´<span class="math inline">\((a,b)\)</span>ä¸Šå¯å¯¼</li><li><span class="math inline">\(f(a)=f(b)\)</span> åˆ™å­˜åœ¨<span class="math inline">\(\xi \in (a,b)\)</span>ï¼Œä½¿å¾—<span class="math inline">\(f'(\xi)=0\)</span></li></ul></li><li><p>å¾®åˆ†ä¸­å€¼å®šç†ï¼š è®¾å‡½æ•°æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li><span class="math inline">\(f(x)\)</span>åœ¨é—­åŒºé—´<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­</li><li><span class="math inline">\(f(x)\)</span>åœ¨å¼€åŒºé—´<span class="math inline">\((a,b)\)</span>ä¸Šå¯å¯¼</li></ul><p>åˆ™å­˜åœ¨<span class="math inline">\(\xi\in (a,b)\)</span>ï¼Œä½¿å¾—<span class="math inline">\(f'(\xi)=\frac{f(b)-f(a)}{b-a}\)</span></p><p>è¿™ä¸ªå®šç†çš„å‡ ä½•æ„ä¹‰å°±æ˜¯ï¼Œè‡³å°‘å­˜åœ¨ä¸€ç‚¹çš„åˆ‡çº¿ä¸ç«¯ç‚¹çš„è¿çº¿å¹³è¡Œï¼›ç‰©ç†æ„ä¹‰ æ˜¯ï¼Œè‡³å°‘å­˜åœ¨ä¸€ç‚¹çš„é€Ÿåº¦ä¸å¹³å‡é€Ÿåº¦ç›¸ç­‰ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/differentialMeanValueTheorem.png"></p></li><li><p>æŸ¯è¥¿ä¸­å€¼å®šç†ï¼š è®¾å‡½æ•°<span class="math inline">\(f(x),g(x)\)</span>æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li><span class="math inline">\(f(x),g(x)\)</span>åœ¨é—­åŒºé—´<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­</li><li><span class="math inline">\(f(x),g(x)\)</span>åœ¨å¼€åŒºé—´<span class="math inline">\((a,b)\)</span>ä¸Šå¯å¯¼</li><li><span class="math inline">\(\forall x\in(a,b)\)</span>æœ‰ï¼š<span class="math inline">\(g'(x)\neq 0\)</span></li></ul><p>åˆ™å­˜åœ¨<span class="math inline">\(\xi \in (a,b)\)</span>ï¼Œä½¿ç­‰å¼ï¼š</p><p><span class="math display">\[  \frac{f(b)-f(a)}{g(b)-g(a)}=\frac{f'(\xi)}{g'(\xi)}  \]</span></p><p>æˆç«‹ã€‚</p><p>ç›´è§‚ç†è§£ï¼šå¯¹äºå‚æ•°æ–¹ç¨‹ <span class="math display">\[  \left\{\begin{array}{l}  x=g(t) \\  y=f(t)  \end{array}\right.  \]</span> å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/CauchysMeanValueTheorem.png"> æ­¤æ—¶ï¼Œ<span class="math inline">\(\boldsymbol{a}\)</span>æ‰€åœ¨ç›´çº¿çš„æ–œç‡ï¼š <span class="math display">\[  \frac{f(b)-f(a)}{g(b)-g(a)}  \]</span> ä»¥åŠ<span class="math inline">\(\boldsymbol{v}\)</span>æ‰€åœ¨ç›´çº¿çš„æ–œç‡ï¼ˆæ ¹æ®å‚æ•°æ–¹ç¨‹çš„æ±‚å¯¼æ³•åˆ™ï¼‰ï¼š <span class="math display">\[  \frac{f'(\xi)}{g'(\xi)}  \]</span> å¿…ç„¶ç›¸ç­‰ï¼š <span class="math display">\[  \frac{f(b)-f(a)}{g(b)-g(a)}=\frac{f'(\xi)}{g'(\xi)}  \]</span></p></li><li>æ´›å¿…è¾¾æ³•åˆ™ï¼š <span class="math inline">\(\frac{0}{0}\)</span>å‹ï¼šè®¾ï¼š<ul><li><span class="math inline">\(\lim_{x\to a}f(x)=\lim_{x\to a}g(x)=0\)</span></li><li>æŸ<span class="math inline">\(\mathring{U}(a)\)</span>å†…ï¼Œ<span class="math inline">\(f'(x)\)</span>åŠ<span class="math inline">\(g'(x)\)</span>éƒ½å­˜åœ¨ï¼Œä¸”<span class="math inline">\(g'(x)\neq 0\)</span></li><li><span class="math inline">\(\displaystyle\lim_{x\to a}\frac{f'(x)}{g'(x)}\)</span>å­˜åœ¨ï¼ˆæˆ–ä¸ºæ— ç©·å¤§ï¼‰ åˆ™ï¼š <span class="math display">\[  \lim_{x\to a}\frac{f(x)}{g(x)}=\lim_{x\to a}\frac{f'(x)}{g'(x)}  \]</span></li></ul><span class="math inline">\(\frac{\infty}{\infty}\)</span>å‹ï¼šè®¾ï¼š<ul><li><span class="math inline">\(\lim_{x\to a}f(x)=\pm\inftyï¼Œ\lim_{x\to a}g(x)=\pm\infty\)</span></li><li>æŸ<span class="math inline">\(\mathring{U}(a)\)</span>å†…ï¼Œ<span class="math inline">\(f'(x)\)</span>åŠ<span class="math inline">\(g'(x)\)</span>éƒ½å­˜åœ¨ï¼Œä¸”<span class="math inline">\(g'(x)\neq 0\)</span></li><li><span class="math inline">\(\displaystyle\lim_{x\to a}\frac{f'(x)}{g'(x)}\)</span>å­˜åœ¨ï¼ˆæˆ–ä¸ºæ— ç©·å¤§ï¼‰ åˆ™ï¼š <span class="math display">\[  \lim_{x\to a}\frac{f(x)}{g(x)}=\lim_{x\to a}\frac{f'(x)}{g'(x)}  \]</span></li></ul></li><li><p>ç‰›é¡¿æ’å€¼æ³•ï¼š å…³äºç‰›é¡¿æ’å€¼æ³•çš„æ€æƒ³è¯·å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzIyMzIwNDA4">https://www.zhihu.com/question/22320408<i class="fa fa-external-link-alt"></i></span> é©¬åŒå­¦çš„å›ç­”ï¼Œè¿™é‡Œä¸å†åˆ—å‡ºã€‚</p></li><li><p>æ³°å‹’å…¬å¼ï¼š è®¾<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\(x=x_0\)</span>å¤„<span class="math inline">\(k\)</span>é˜¶å¯å¯¼ï¼Œåˆ™å¯¹äºä»»ä½•åœ¨ 0 åˆ°<span class="math inline">\(k\)</span>ä¹‹é—´çš„æ•´æ•°<span class="math inline">\(n\)</span>ï¼Œå¯ä»¥ç”Ÿæˆ n é˜¶æ³°å‹’å¤šé¡¹å¼ï¼š <span class="math display">\[  \begin{aligned}  p_{n}(x)=&amp; f\left(x_{0}\right)+f^{\prime}\left(x_{0}    \right)\left(x-x_{0}\right)+\frac{f^{\prime \prime}\left    (x_{0}\right)}{2 !}\left(x-x_{0}\right)^{2} \\  &amp;+\cdots+\frac{f^{(n)}\left(x_{0}\right)}{n !}\left(x-x_    {0}\right)^{n}  \end{aligned}  \]</span> ç‰¹åˆ«çš„ï¼Œå¦‚æœåœ¨<span class="math inline">\(x=0\)</span>å¤„ç”Ÿæˆçš„æ³°å‹’å¤šé¡¹å¼ï¼Œä¹Ÿç§°ä¸º n é˜¶éº¦å…‹åŠ³æ—å¤šé¡¹å¼ï¼š <span class="math display">\[  p_n(x)=f(0)+f'(0)x+\frac{f''(0)}{2!}x^2+\cdots+\frac{f^{(n)}(0)}{n!}x^n  \]</span> æ³°å‹’å…¬å¼æ˜¯ç‰›é¡¿æ’å€¼æ³•çš„è¿›é˜¶ã€‚</p></li></ul><h1 id="ç§¯åˆ†">ç§¯åˆ†</h1><h2 id="å®šç§¯åˆ†">å®šç§¯åˆ†</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/math_integral.png"></p><p>ç›´è§‚ç†è§£ç§¯åˆ†å°±æ˜¯ï¼Œä»¥æ¯ä¸ªå°æ–¹å½¢é¢ç§¯å–ä»£æ›²è¾¹å½¢é¢ç§¯ï¼Œå½“ x å–æé™æ—¶æ¯ä¸ªå°é•¿æ–¹å½¢çš„é¢ç§¯å°±æ˜¯å¾®åˆ†ï¼Œè€Œæ‰€æœ‰çš„é•¿æ–¹å½¢é¢ç§¯ä¹‹å’Œå°±æ˜¯ç§¯åˆ†ã€‚ ä¸‹é¢æ˜¯å®šç§¯åˆ†çš„å®šä¹‰ï¼š</p><p>è®¾å‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šæœ‰å®šä¹‰ï¼Œå¯¹äº<span class="math inline">\([a,b]\)</span>ä¸Šçš„ä»»æ„åˆ’åˆ†<span class="math inline">\(P\)</span>ï¼Œ<span class="math inline">\(\xi_k\)</span>ä¸ºå­åŒºé—´<span class="math inline">\([x_{k-1},x_k]\)</span>ä¸Šä»»æ„é€‰å–çš„æ•°ï¼Œå­åŒºé—´<span class="math inline">\([x_{k-1},x_k]\)</span>çš„é•¿åº¦ä¸º<span class="math inline">\(\Delta x_k\)</span>ï¼Œè®°ï¼š</p><p><span class="math display">\[\lambda=max\{\Delta x_1,\Delta x_2,...,\Delta x_n\}\]</span></p><p>å¦‚æœå½“<span class="math inline">\(\lambda\to 0\)</span>æ—¶</p><p><span class="math display">\[S=\sum_{i=1}^{n} f\left(\xi_{i}\right) \Delta x_{i}\]</span></p><p>çš„æé™æ€»æ˜¯å­˜åœ¨ï¼Œä¸”ä¸é—­åŒºé—´<span class="math inline">\([a,b]\)</span>çš„åˆ†æ³•åŠç‚¹<span class="math inline">\(\xi_i\)</span>çš„å–æ³•æ— å…³ï¼Œé‚£ä¹ˆç§°è¿™ä¸ªæé™ I ä¸ºå‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨åŒºé—´<span class="math inline">\([a,b]\)</span>ä¸Šçš„å®šç§¯åˆ†ï¼Œè®°åš<span class="math inline">\(\int_{a}^{b}f(x)dx,\)</span>å³ï¼š</p><p><span class="math display">\[\int_{a}^{b} f(x) \mathrm{d} x=I=\lim _{\lambda \rightarrow 0} \sum_{i=1}^{n} f\left(\xi_{i}\right) \Delta x_{i}\]</span></p><p>å…¶ä¸­ a ä¸ºç§¯åˆ†ä¸‹é™ï¼Œb ä¸ºç§¯åˆ†ä¸Šé™ï¼Œ<span class="math inline">\(I\)</span>ä¸º<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šçš„å®šç§¯åˆ†ï¼Œx ä¸ºç§¯åˆ†å˜é‡ã€‚</p><h2 id="å®šç§¯åˆ†çš„æ€§è´¨">å®šç§¯åˆ†çš„æ€§è´¨</h2><ul><li>å¯ç§¯æ¡ä»¶ï¼š<ul><li>å¦‚æœ<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­ï¼Œåˆ™<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šå¯ç§¯</li><li>å¦‚æœ<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šæœ‰ç•Œï¼Œä¸”åªæœ‰æœ‰é™ä¸ªé—´æ–­ç‚¹ï¼Œåˆ™<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šå¯ç§¯</li></ul></li><li><p>é½æ¬¡æ€§ï¼š <span class="math display">\[  \int_{a}^{b}cf(x)\textrm{d}x=c\int_{a}^{b}f(x)\textrm{d}x,c\in\mathbb{R}  \]</span></p></li><li><p>å¯åŠ æ€§ï¼š <span class="math display">\[  \int_{a}^{b}[f(x)+g(x)]\textrm{d}x=\int_{a}^{b}f(x)\textrm{d}x+\int_{a}^{b}g(x)\textrm{d}x  \]</span></p></li><li><p>ç§¯åˆ†ä¸­å€¼å®šç†ï¼š å¦‚æœå‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨ç§¯åˆ†åŒºé—´<span class="math inline">\([a,b]\)</span>è¿ç»­ï¼Œé‚£ä¹ˆåœ¨<span class="math inline">\([a,b]\)</span>ä¸Šè‡³å°‘å­˜åœ¨ä¸€ç‚¹<span class="math inline">\(\xi\)</span>ï¼Œä½¿ä¸‹å¼æˆç«‹ï¼š <span class="math display">\[  \int_a^bf(x)dx=f(\xi)(b-a),\xi\in[a,b]  \]</span></p></li></ul><h2 id="å¾®ç§¯åˆ†åŸºæœ¬å®šç†">å¾®ç§¯åˆ†åŸºæœ¬å®šç†</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Science/Math/integralUpperLimitFunction.png"></p><p>b ç«¯ç‚¹å˜æˆä¸€ä¸ªå˜é‡ï¼Œå®šç§¯åˆ†å°±å˜æˆå…³äºè¯¥å˜é‡çš„ç§¯åˆ†ä¸Šé™å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[A(x)=\int_a^x f(x)\textrm{d}x\]</span></p><p>å› ä¸º<span class="math inline">\(x\)</span>åˆè¡¨ç¤ºç§¯åˆ†å‡½æ•°ï¼Œåˆè¡¨ç¤ºç§¯åˆ†å˜é‡ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œæ‰€ä»¥ä¸€èˆ¬å¦‚ä¸‹è¡¨ç¤ºï¼š</p><p><span class="math display">\[A(x)=\int_a^x f(t)\textrm{d}t\]</span></p><p><strong>ç‰›é¡¿-è±å¸ƒå°¼å…¹å…¬å¼</strong> <span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­ï¼Œ<span class="math inline">\(F(x)\)</span>æ˜¯<span class="math inline">\(f(x)\)</span>çš„ä¸€ä¸ªåŸå‡½æ•°ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[\int_a^b f(x)\textrm{d}x=F(b)-F(a)\]</span></p><p>ä¹Ÿå¯ä»¥è®°ä½œï¼š</p><p><span class="math display">\[\int_a^b f(x)\textrm{d}x=[F(x)]_a^b\]</span></p><p>å¯ä»¥è¿™æ ·ç†è§£ï¼Œ<span class="math inline">\(F(x)\)</span>å¯¹ x æ±‚å¯¼ä»£è¡¨çš„æ˜¯åœ¨ x ç‚¹çš„å˜åŒ–ç‡ï¼Œè€Œå¯¹äº<span class="math inline">\(f(x)\)</span>åœ¨ x ç‚¹çš„å˜åŒ–é‡æ­£å¥½å°±æ˜¯<span class="math inline">\(F(x)\)</span>åœ¨ x ç‚¹çš„å˜åŒ–ç‡åœ¨ x å–æé™çš„æƒ…å†µä¸‹ã€‚</p><h2 id="ä¸å®šç§¯åˆ†">ä¸å®šç§¯åˆ†</h2><p>å¦‚æœ<span class="math inline">\(F(x)\)</span>æ˜¯<span class="math inline">\(f(x)\)</span>åœ¨åŒºé—´<span class="math inline">\(I\)</span>ä¸Šçš„ä¸€ä¸ªåŸå‡½æ•°ï¼Œé‚£ä¹ˆ<span class="math inline">\(F(x)+C\)</span>å°±æ˜¯<span class="math inline">\(f(x)\)</span>çš„ä¸å®šç§¯åˆ†ï¼Œå³ï¼š</p><p><span class="math display">\[\int f(x)\textrm{d}x=F(x)+C,C\in\mathbb{R}\]</span></p><p>å¹¶ä¸”ä¸å®šç§¯åˆ†<span class="math inline">\(\int f(x)dx\)</span>è¡¨ç¤ºäº†<span class="math inline">\(f(x)\)</span>çš„æ‰€æœ‰åŸå‡½æ•°ã€‚</p><h4 id="ç§¯åˆ†è¡¨">ç§¯åˆ†è¡¨</h4><p><span class="math display">\[\begin{array}{c|c|c|c}    \hline\\    \quad \int k\textrm{d}x= kx+C\quad&amp;    \quad \int \cos x\textrm{d}x=\sin x+C\quad\\    \quad \int x^n\textrm{d}x=\frac{x^{n+1}}{n+1}+C,(n\neq -1)\quad&amp;    \quad \int\sin x\textrm{d}x=-\cos x+C\quad\\        \quad \int\frac{1}{x}\textrm{d}x=\ln |x|+C\quad&amp;    \quad \int\sec^2x\textrm{d}x=\tan x+C\quad\\    \quad \int\frac{1}{\sqrt{a^2-x^2}}\textrm{d}x=\arcsin \frac{x}{a}+C\quad&amp;    \quad \int\csc^2x\textrm{d}x=-\cot x+C\quad\\    \quad \int e^x\textrm{d}x=e^x+C\quad&amp;    \quad \int\sec x\tan x\textrm{d}x=\sec x+C\quad\\    \quad \int a^x\textrm{d}x=\frac{a^x}{\ln a}+C\quad&amp;    \quad \int\csc x\cot x\textrm{d}x=-\csc x+C\quad\\    \quad \int\frac{1}{a^2+x^2}\textrm{d}x=\frac{1}{a}\arctan\frac{x}{a}+C\quad&amp;    \quad \int\tan x\textrm{d}x=\ln|\sec x|+C\quad\\    \\    \hline\end{array}\]</span></p><h2 id="ç§¯åˆ†æ–¹æ³•">ç§¯åˆ†æ–¹æ³•</h2><ul><li><p>çº¿æ€§æ€§è´¨ï¼š è®¾å‡½æ•°<span class="math inline">\(f(x)\)</span>åŠ<span class="math inline">\(g(x)\)</span>çš„åŸå‡½æ•°å­˜åœ¨ï¼Œåˆ™ï¼ˆå¯åŠ æ€§ï¼‰ï¼š</p><p><span class="math display">\[  \int[f(x)+g(x)]dx=\int f(x)dx+\int g(x)dx\qquad (1)  \]</span></p><p><span class="math inline">\(k\)</span>ä¸ºéé›¶å¸¸æ•°ï¼ˆé½æ¬¡æ€§ï¼‰ï¼š</p><p><span class="math display">\[  \int kf(x)dx=k\int f(x)dx\qquad (2)  \]</span></p></li><li><p>ç¬¬ä¸€ç±»æ¢å…ƒæ³•ï¼š è®¾<span class="math inline">\(f(u)\)</span>å…·æœ‰åŸå‡½æ•°<span class="math inline">\(F(u)\)</span>ï¼Œ<span class="math inline">\(u=u(x)\)</span>å¯å¯¼ï¼Œåˆ™æœ‰æ¢å…ƒå…¬å¼ï¼š</p><p><span class="math display">\[  \int f[\underbrace{u(x)}_{\color{skyblue}{u}}]\underbrace   {u'(x)\textrm{d}x}_{\color{salmon}{\textrm{d}u}}=\int f    (\color{skyblue}{u})\color{salmon}{\textrm{d}u}=F(u)+C  \]</span></p></li><li><p>ç¬¬äºŒç±»æ¢å…ƒæ³•ï¼š è®¾<span class="math inline">\(x=x(t)\)</span>æ˜¯å•è°ƒçš„å¯å¯¼å‡½æ•°ï¼Œä¸”<span class="math inline">\(x'(t)\neq 0\)</span>ï¼Œåˆ™<span class="math inline">\(t\)</span>å¯ä»¥ç”¨<span class="math inline">\(x\)</span>æ¥è¡¨ç¤ºï¼Œå³æœ‰åå‡½æ•°ï¼š <span class="math display">\[  t=t(x)  \]</span> å¦‚æœæœ‰ï¼š <span class="math display">\[  \int f(x)\textrm{d}x\xrightarrow{\quad æ¢å…ƒ x=x(t)\quad}\int f[x(t)]x'(t)\textrm{d}t=F(t)+C  \]</span> åˆ™ï¼š <span class="math display">\[  \int f(x)\textrm{d}x=F(t(x))+C  \]</span></p></li><li>å®šç§¯åˆ†çš„æ¢å…ƒï¼š å‡è®¾å‡½æ•°<span class="math inline">\(f(x)\)</span>åœ¨åŒºé—´<span class="math inline">\([a,b]\)</span>ä¸Šè¿ç»­ï¼Œå‡½æ•°<span class="math inline">\(x=g(t)\)</span>æ»¡è¶³æ¡ä»¶ï¼š<ul><li><span class="math inline">\(g(\alpha)=a,g(\beta)=b\)</span></li><li><span class="math inline">\(g(t)\)</span>åœ¨<span class="math inline">\([\alpha,\beta]\)</span>ï¼ˆæˆ–<span class="math inline">\([\beta,\alpha]\)</span>) ä¸Šå…·æœ‰è¿ç»­å¯¼æ•°ï¼Œä¸”å…¶å€¼åŸŸ<span class="math inline">\(R_{g}=[a,b]\)</span>ï¼Œåˆ™æœ‰ï¼š <span class="math display">\[  \int_{a}^{b}f(x)dx=\int_{\alpha}^{\beta}f[g(t)]g'(t)dt  \]</span></li></ul>å®šç§¯åˆ†çš„æ¢å…ƒå’Œä¸å®šç§¯åˆ†çš„æ¢å…ƒçš„ä¸åŒä¹‹å¤„åœ¨äºï¼š<ul><li>å®šç§¯åˆ†æ¢å…ƒæ—¶ï¼Œéœ€è¦å˜é‡ä¸ç§¯åˆ†é™åŒæ—¶æ¢</li><li>åœ¨å®šç§¯åˆ†æ¢å…ƒåï¼Œåˆ©ç”¨ç‰›é¡¿-è±å¸ƒå°¼èŒ¨å…¬å¼å¯ä»¥ç›´æ¥è®¡ç®—å‡ºç»“æœï¼Œä¸éœ€è¦å›ä»£</li></ul></li><li><p>åˆ†éƒ¨ç§¯åˆ†æ³•ï¼š <span class="math inline">\(f(x),g(x)\)</span>çš†ä¸ºå¯å¯¼å‡½æ•°ï¼Œæœ‰ï¼š <span class="math display">\[  \int f(x)g'(x)dx=f(x)g(x)-\int g(x)f'(x)dx  \]</span> æˆ–è®¾<span class="math inline">\(u=f(x),v=g(x)\)</span>ï¼Œä¸Šå¼å¯ä»¥å†™ä½œï¼š <span class="math display">\[  \int udv=uv-\int vdu  \]</span></p></li></ul><h1 id="å¾®åˆ†æ–¹ç¨‹">å¾®åˆ†æ–¹ç¨‹</h1><p>æ–¹ç¨‹ç®€å•è€Œè¨€å°±æ˜¯å«æœ‰æœªçŸ¥é‡çš„ç­‰å¼ï¼›ç‰¹åˆ«åœ°ï¼Œå«æœ‰æœªçŸ¥å‡½æ•°åŠå…¶å¯¼å‡½æ•°çš„æ–¹ç¨‹ç§°ä¸ºå¾®åˆ†æ–¹ç¨‹ï¼š</p><p><span class="math display">\[\begin{array}{c|c|c}     \hline    &amp;\quad æœªçŸ¥æ•°ã€quad&amp;\quad ä¾‹å­ã€quad\\\hline    \quad\color{SkyBlue}{æ–¹ç¨‹}\quad&amp;\quad x\quad&amp;\quad 2x+1=3\quad\quad\\    \hline     \quad\color{orange}{å¾®åˆ†æ–¹ç¨‹}\quad&amp;\quad y\quad&amp;\quad\frac{\mathrm{d}y}{\mathrm{d}x}+xy=2x\quad\\    \hline\end{array}\]</span></p><h2 id="å¯åˆ†ç¦»å˜é‡çš„å¾®åˆ†æ–¹ç¨‹">å¯åˆ†ç¦»å˜é‡çš„å¾®åˆ†æ–¹ç¨‹</h2><p>å¦‚æœä¸€é˜¶å¾®åˆ†æ–¹ç¨‹å¯ä»¥å†™æˆï¼š <span class="math display">\[g(y)\mathrm{d}y=f(x)\mathrm{d}x\]</span> çš„å½¢å¼ï¼Œè¿™å°±æ˜¯å¯åˆ†ç¦»å˜é‡çš„å¾®åˆ†æ–¹ç¨‹ã€‚</p><p>å¯ä»¥ç›´æ¥å¯¹ä¸¤è¾¹æ±‚ä¸å®šç§¯åˆ†ï¼Œæ¯”è¾ƒç®€å•ã€‚</p><p>å¦‚æœä¸€é˜¶å¾®åˆ†æ–¹ç¨‹å¯ä»¥å†™æˆï¼š <span class="math display">\[\frac{\mathrm{d}y}{\mathrm{d}x}=\varphi\left(\frac{y}{x}\right)\]</span></p><p>çš„å½¢å¼ï¼Œé‚£ä¹ˆç§°æ­¤æ–¹ç¨‹ä¸ºé½æ¬¡æ–¹ç¨‹ã€‚è¿™ä¸ªæ–¹ç¨‹æ˜¯å¯ä»¥é€šè¿‡ æ¢å…ƒå˜æ¢ä¸ºå¯åˆ†ç¦»å˜é‡çš„å¾®åˆ†æ–¹ç¨‹çš„ã€‚</p><h2 id="çº¿å½¢å¾®åˆ†æ–¹ç¨‹">çº¿å½¢å¾®åˆ†æ–¹ç¨‹</h2><h3 id="å®šä¹‰">å®šä¹‰</h3><p><span class="math display">\[\mathcal{L}=a_0+a_1D+a_2D^2+a_3D^3+\cdots+a_nD^n\]</span> ä¹Ÿæ˜¯çŸ©é˜µï¼Œä¹Ÿæ˜¯çº¿æ€§å‡½æ•°ï¼Œå¤šé¡¹å¼ç»„åˆã€mathcal{L}ç§°ä¸ºå¾®åˆ†ç®—å­ã€‚</p><p>å¯¹äºå¾®åˆ†ç®—å­ï¼š</p><p><span class="math display">\[\mathcal{L}=a_0+a_1D+a_2D^2+a_3D^3+\cdots+a_nD^n\]</span></p><p>ä¸‹å¼ï¼š</p><p><span class="math display">\[\mathcal{L}(y)=f(x)\]</span></p><p>ç§°ä¸ºçº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚å¦‚æœ<span class="math inline">\(f(x)\)</span>ï¼š - ç­‰äº 0ï¼šé½æ¬¡çº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚ - ä¸ç­‰äº 0ï¼šéé½æ¬¡çº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚</p><p>å¦‚æœç³»æ•°<span class="math inline">\(a_0,a_1,\cdots,a_nï¼š\)</span></p><ul><li>æ˜¯å¸¸æ•°ï¼šå¸¸ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚</li><li>æ˜¯å‡½æ•°ï¼šå˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚</li></ul><h3 id="çº¿æ€§å¾®åˆ†æ–¹ç¨‹è§£çš„ç»“æ„">çº¿æ€§å¾®åˆ†æ–¹ç¨‹è§£çš„ç»“æ„</h3><p>å¦‚æœ<span class="math inline">\(\boldsymbol{p_1}ã€\boldsymbol{p_2}\)</span>æ˜¯é½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„ï¼š <span class="math display">\[A\boldsymbol{x}=\boldsymbol{0}\]</span></p><p>çš„è§£ï¼Œé‚£ä¹ˆå®ƒä»¬çš„çº¿æ€§ç»„åˆï¼š</p><p><span class="math display">\[\boldsymbol{p_3}=C_1\boldsymbol{p_1}+C_2\boldsymbol{p_2}(C_1,C_2\in\mathbb{R})\]</span></p><p>ä¹Ÿæ˜¯æ­¤çº¿æ€§æ–¹ç¨‹ç»„çš„è§£ã€‚</p><p>å¦‚æœ<span class="math inline">\(\boldsymbol{p_1},\boldsymbol{p_2},\cdots,\boldsymbol{p_n}\)</span>æ˜¯ n ç»´é½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„ï¼š</p><p><span class="math display">\[A\boldsymbol{x}=\boldsymbol{0}\]</span></p><p>çš„è§£ï¼Œå¹¶ä¸”å®ƒä»¬çº¿æ€§æ— å…³ï¼Œé‚£ä¹ˆçº¿æ€§ç»„åˆï¼š</p><p><span class="math display">\[\boldsymbol{p}=C_1\boldsymbol{p_1}+C_2\boldsymbol{p_2}+\cdots+C_n\boldsymbol{p_n}(C_1,C_2,\cdots,C_n\in\mathbb{R})\]</span></p><p>æ˜¯æ­¤æ–¹ç¨‹ç»„çš„é€šè§£ã€‚</p><p>å¦‚æœï¼š <span class="math display">\[\boldsymbol{p}=C_1\boldsymbol{p_1}+C_2\boldsymbol{p_2}+\cdots+C_n\boldsymbol{p_n}(C_1,C_2,\cdots,C_n\in\mathbb{R})\]</span></p><p>æ˜¯é½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„ï¼š</p><p><span class="math display">\[A\boldsymbol{x}=\boldsymbol{0}\]</span></p><p>çš„é€šè§£ã€‚<span class="math inline">\(\boldsymbol{p^*}\)</span>æ˜¯éé½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„ï¼š</p><p><span class="math display">\[A\boldsymbol{x}=\boldsymbol{b}\]</span></p><p>çš„ä¸€ä¸ªè§£ï¼Œä¹Ÿç§°ä¸ºç‰¹è§£ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[\boldsymbol{p}+\boldsymbol{p^*}\]</span></p><p>æ˜¯éé½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„çš„æ‰€æœ‰è§£ã€‚</p><h3 id="å¸¸ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹">å¸¸ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹</h3><p>å¾®åˆ†ç®—å­<span class="math inline">\(\mathcal{L}\)</span>æ˜¯ D çš„å¤šé¡¹å¼ç»„åˆï¼š <span class="math display">\[\mathcal{L}=a_0+a_1D+a_2D^2+a_3D^3+\cdots+a_nD^n\]</span> å¦‚æœç³»æ•°<span class="math inline">\(a_0,a_1,\cdots,a_n\)</span>æ˜¯å¸¸æ•°ï¼Œé‚£ä¹ˆï¼š <span class="math display">\[\mathcal{L}(y)=f(x)\]</span></p><p>å°±æ˜¯å¸¸ç³»æ•°å¾®åˆ†æ–¹ç¨‹ã€‚æ ¹æ®çº¿æ€§å¾®åˆ†æ–¹ç¨‹è§£çš„ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹é½æ¬¡è§£ã€‚ æŸäºŒé˜¶å¸¸ç³»æ•°é½æ¬¡çº¿æ€§å¾®åˆ†æ–¹ç¨‹ï¼š <span class="math display">\[y''+py'+qy=0\]</span></p><p>å…¶ä¸­<span class="math inline">\(pã€q\)</span>æ˜¯å¸¸æ•°ã€‚å¤§ç¥æ¬§æ‹‰å‘ç°ä¸è®º<span class="math inline">\(pã€q\)</span>æ˜¯ä»€ä¹ˆï¼Œé€šè§£éƒ½å…·æœ‰ä»¥ä¸‹å½¢å¼ï¼š</p><p><span class="math display">\[Y=C_1e^{r_1x}+C_2e^{r_2x}\]</span></p><p><span class="math inline">\(r_1ã€r_2\)</span>æ˜¯å¤æ•°ã€‚é‚£ä¹ˆå¯ä»¥åˆç†å‡è®¾<span class="math inline">\(y=e^{rx}\)</span>ï¼Œå¾—åˆ°ï¼š</p><p><span class="math display">\[y'=re^{rx},\quad y''=r^2e^{rx}\]</span></p><p>å›ä»£åˆ°å¾®åˆ†æ–¹ç¨‹ä¸­ï¼Œå¾—åˆ°ï¼š</p><p><span class="math display">\[(r^2+pr+q)e^{rx}=0\]</span></p><p>é‚£ä¹ˆä¸Šé¢ç­‰å¼è¦æˆç«‹ï¼Œåªèƒ½æ˜¯ï¼š</p><p><span class="math display">\[r^2+pr+q=0\]</span></p><p>è¿™æ˜¯ä¸€ä¸ªä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ï¼Œä¹Ÿè¢«ç§°ä¸ºæ­¤å¾®åˆ†æ–¹ç¨‹çš„ç‰¹å¾æ–¹ç¨‹ã€‚</p><p>å¯ä»¥ç”¨å…¬å¼ï¼š</p><p><span class="math display">\[r_{1,2}=\frac{-p\pm\sqrt{p^2-4q}}{2}\]</span></p><p>æ±‚å‡º r_1ã€r_2</p><h3 id="å˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹">å˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹</h3><ul><li><p>ä¸€é˜¶å˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ï¼š ä¸€é˜¶å˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ç»è¿‡å˜å½¢ä¹‹åéƒ½å¯ä»¥å†™æˆå¦‚ä¸‹çš„å½¢å¼ï¼š <span class="math display">\[  \frac{\mathrm{d}y}{\mathrm{d}x}+P(x)y=Q(x)  \]</span> å¯ä»¥å…ˆå†™ä¸ºé½æ¬¡æ–¹ç¨‹ï¼Œç„¶åå¯¹ä¸¤è¾¹è¿›è¡Œç§¯åˆ†æ±‚è§£ã€‚ç„¶åå†æ±‚è§£éé½æ¬¡æ–¹ç¨‹çš„è§£ã€‚</p></li><li><p>ä¼¯åŠªåˆ©å¾®åˆ†æ–¹ç¨‹ï¼š <span class="math display">\[  \frac{\mathrm{d}y}{\mathrm{d}x}+P(x)y=Q(x)y^n\quad (n\ne 0, 1)  \]</span> å«åšä¼¯åŠªåˆ©å¾®åˆ†æ–¹ç¨‹ã€‚ å¯ä»¥å˜æˆäº†ä¸€é˜¶å˜ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹æ¥æ±‚è§£ã€‚</p></li><li><p>æ¬§æ‹‰æ–¹ç¨‹ï¼š <span class="math display">\[  x^ny^{(n)}+p_1x^{n-1}y^{(n-1)}+\cdots+p_{n-1}xy'+p_ny=f(x)  \]</span> ç§°ä¸ºæ¬§æ‹‰æ–¹ç¨‹ã€‚ æ¬§æ‹‰æ–¹ç¨‹ä¹Ÿå¯ä»¥è½¬ä¸ºå¸¸ç³»æ•°çº¿æ€§å¾®åˆ†æ–¹ç¨‹ã€‚</p></li></ul><p>è¿™é‡Œæ²¡æœ‰å°†å…·ä½“çš„è§£æ³•åˆ—å‡ºæ¥ï¼Œè€Œåªæ˜¯ä»¥æçº²çš„æ–¹å¼å°†æ¦‚å¿µç†å‡ºæ¥ï¼Œå…·ä½“çš„è§£æ³•å¯ä»¥å‚è€ƒç›¸å…³å‚è€ƒä¹¦ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé©¬åŒå­¦çš„å•å˜é‡å¾®ç§¯åˆ†è¯¾ç¨‹ã€‹<br>æ„Ÿå…´è¶£çš„å¯ä»¥è´­ä¹°ä»–çš„è¯¾ç¨‹ï¼Œå†™çš„å¾ˆå¥½ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼ï¼ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Science Thought </category>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Linear Algebra </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰åŸºäº Policy çš„ class è®¾è®¡</title>
      <link href="/2022/Program/C++DesignPatternsPart1/"/>
      <url>/2022/Program/C++DesignPatternsPart1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/BasePolicyclassDesigned.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMzMjA5NDYzNzY4OTA4MmYwNDEwNDk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>è¿™ä¸€ç« å°†ä»‹ç»æ‰€è°“ policies å’Œ policy classes å®ƒä»¬æ˜¯ä¸€ç§é‡è¦çš„ classes è®¾è®¡æŠ€æœ¯ï¼Œèƒ½å¤Ÿå¢åŠ ç¨‹åºåº“çš„å¼¹æ€§å¹¶æé«˜å¤ç”¨æ€§ï¼Œè¿™æ­£æ˜¯ Loki çš„ç›®æ ‡æ‰€åœ¨ã€‚ç®€è¨€ä¹‹ï¼Œå…·å¤‡å¤æ‚åŠŸèƒ½çš„ policy based class ç”±è®¸å¤šå°å‹ classesï¼ˆç§°ä¸º policiesï¼‰ç»„æˆã€‚æ¯ä¸€ä¸ªè¿™æ ·çš„å°å‹ class éƒ½åªè´Ÿè´£å•çº¯å¦‚è¡Œä¸ºæˆ–ç»“æ„çš„æŸä¸€æ–¹é¢ï¼ˆ behavioral or structural aspectï¼‰ã€‚ä¸€å¦‚åç§°æ‰€ç¤ºï¼Œä¸€ä¸ª policy ä¼šé’ˆå¯¹ç‰¹å®šä¸»é¢˜å»ºç«‹ä¸ªæ¥å£ã€‚åœ¨â€œéµå¾ª policy æ¥å£â€çš„å‰æä¸‹ï¼Œä½ å¯ä»¥ç”¨ä»»ä½•é€‚å½“çš„æ–¹æ³•æ¥å®ä½œ policiesã€‚</p><p>ç”±äºä½ å¯ä»¥æ··åˆå¹¶åŒ¹é…å„ç§ policiesï¼Œæ‰€ä»¥è—‰ç”±å°é‡æ ¸å¿ƒåŸºç¡€ç»„ä»¶ï¼ˆ core elementary componentsï¼‰çš„ç»„åˆï¼Œä½ å¯å®Œæˆä¸€ä¸ªâ€œè¡Œä¸ºé›†â€ï¼ˆ behaviors setï¼‰ã€‚</p><h1 id="è½¯ä»¶è®¾è®¡çš„å¤šæ ·æ€§multiplicity">è½¯ä»¶è®¾è®¡çš„å¤šæ ·æ€§ï¼ˆMultiplicityï¼‰</h1><p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç®€å˜çš„å…¥é—¨çº§ç¨‹åºç»´å‹ï¼š-ä¸ª Smart Pointerï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰ã€‚è¿™ç§ class å¯è¢«ç”¨äºå•çº¿ç¨‹æˆ–å¤šçº¿ç¨‹ä¹‹ä¸­ï¼Œå¯ä»¥è¿ç”¨ä¸åŒçš„ ownershipï¼ˆæ‹¥æœ‰æƒï¼‰ç­–ç•¥ï¼Œå¯ä»¥åœ¨å®‰å…¨ä¸é€Ÿåº¦ä¹‹é—´åè°ƒï¼Œå¯ä»¥æ”¯æŒæˆ–ä¸æ”¯æŒâ€œè‡ªåŠ¨è½¬ä¸ºå†…éƒ¨æŒ‡é’ˆä»¥ä¸Šè¿™äº›ç‰¹æ€§éƒ½å¯ä»¥è¢«è‡ªç”±ç»„åˆèµ·æ¥è€Œæ‰€è°“è§£ç­”ï¼Œå°±æ˜¯æœ€é€‚åˆä½ çš„åº”ç”¨ç¨‹åºçš„é‚£ä¸ªæ–¹æ¡ˆã€‚</p><h1 id="å…¨åŠŸèƒ½å‹do-it-allæ¥å£çš„å¤±è´¥">å…¨åŠŸèƒ½å‹ï¼ˆDo-It-Allï¼‰æ¥å£çš„å¤±è´¥</h1><p>å¦‚æœç¨‹åºåº“å°†ä¸åŒçš„è®¾è®¡å®ä½œä¸ºå„ä¸ªå°å‹ classesï¼Œæ¯ä¸ª class ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„ç½è£…è§£æ³•ï¼Œå¦‚ä½•ï¼Ÿä¾‹å¦‚åœ¨ smart pointer ä¾‹ä¸­ä½ ä¼šçœ‹åˆ° Singlethreaded Smartptrï¼Œ Multithreadedsmartptrã€Refcountedsmartptrã€ Reflinkedsmartptr ç­‰ç­‰ã€‚ è¿™ç§åšæ³•çš„é—®é¢˜æ˜¯ä¼šäº§ç”Ÿå¤§é‡è®¾è®¡ç»„åˆã€‚ä¾‹å¦‚ä¸Šè¿°æåˆ°çš„å››ä¸ª classes å¿…ç„¶å¯¼è‡´è¯¸å¦‚ singlethreadedrefcountedsmartptr è¿™æ ·çš„ç»„åˆã€‚å¦‚æœå†åŠ ä¸€ä¸ªè®¾è®¡é€‰é¡¹ï¼ˆä¾‹å¦‚æ”¯æŒå‹åˆ¥è½¬æ¢ï¼‰ï¼Œä¼šäº§ç”Ÿæ›´å¤šæ¾˜åœ¨ç»„åˆã€‚è¿™æœ€ç»ˆä¼šè®©ç¨‹åºåº“å®ä½œè€…å’Œä½¿ç”¨è€…å—ä¸äº†ã€‚å¾ˆæ˜æ˜¾åœ°ï¼Œè¿™å¹¶ä¸æ˜¯ä¸ªå¥½æ–¹æ³•ã€‚é¢å¯¹è¿™ä¹ˆå¤šçš„æ½œåœ¨ç»„åˆï¼ˆè¿‘ä¹æŒ‡æ•°çˆ¬å‡ï¼‰ï¼Œåƒä¸‡åˆ¥ä¼å›¾ä½¿ç”¨æš´åŠ›æšä¸¾æ³•ã€‚ è¿™æ ·çš„ç¨‹åºåº“ä¸åªé€ æˆå¤§é‡çš„æ™ºåŠ›è´Ÿè·ï¼Œä¹Ÿæ˜¯æç«¯çš„ä¸¥è‹›è€Œæ­»æ¿ã€‚ä¸€ç‚¹ç‚¹è½»å¾®ä¸å¯æµ‹çš„å®šåˆ¶è¡Œä¸ºï¼ˆä¾‹å¦‚è¯•ç€ä»¥ä¸€ä¸ªç‰¹å®šå€¼ä¸ºé¢„å…ˆæ„é€ å¥½çš„ smart pointers è®¾åˆå€¼ï¼‰éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç²¾å¿ƒåˆ¶ä½œçš„ library classes æ²¡æœ‰ç”¨å¤„ã€‚ è®¾è®¡æ˜¯ä¸ºäº†å‰è¡Œ constraintsï¼ˆçº¦æŸæ¡ä»¶ã€è§„èŒƒï¼‰ã€‚å› æ­¤ï¼Œä»¥è®¾è®¡ä¸ºç›®æ ‡çš„ç¨‹åºåº“å¿…é¡»å¸®åŠ©ä½¿ç”¨è€…ç²¾å·§å®Œæˆè®¾è®¡ï¼Œä»¥å®ç°ä½¿ç”¨è€…è‡ªå·±çš„ constraintsï¼Œè€Œä¸æ˜¯å®ç°é¢„å…ˆå®šä¹‰å¥½çš„ constraintsã€‚ç½è£…è®¾è®¡ä¸é€‚ç”¨äºä»¥è®¾è®¡ä¸ºç›®æ ‡ç”¨é€”çš„ç¨‹åºåº“ï¼Œå°±åƒæœ¯æ•°å­—ä¸é€‚ç”¨äºãƒ¼èˆ¬ä»£ç ä¸€æ ·ã€‚å½“ç„¶å•¦ï¼Œä¸€äº›â€œæœ€æ™®éçš„ã€å—æ¨èçš„â€ç½è£…è§£æ³•å°†å—åˆ°å¤§ä¼—æ¬¢è¿åªè¦å®¢ç«¯ç¨‹åºå‘˜å¿…è¦æ—¶èƒ½å¤Ÿæ”¹å˜å®ƒä»¬ã€‚</p><h1 id="å¤šé‡ç»§æ‰¿-multiple-inheritanceæ˜¯æ•‘ä¸–ä¸»">å¤šé‡ç»§æ‰¿ï¼ˆ Multiple Inheritanceï¼‰æ˜¯æ•‘ä¸–ä¸»ï¼Ÿ</h1><p>è—‰ç”±å¤šé‡ç»§æ‰¿æœºåˆ¶æ¥ç»„åˆå¤šé¡¹åŠŸèƒ½ï¼Œä¼šäº§ç”Ÿå¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>å…³äºæŠ€æœ¯ï¼ˆ Mechanicsï¼‰ã€‚ç›®å‰å¹¶æ²¡æœ‰ä¸€æˆä¸å˜å³å¯å¥—ç”¨çš„ä»£ç ï¼Œå¯ä»¥åœ¨æŸç§å—æ§æƒ…å†µä¸‹å°†ç»§æ‰¿è€Œæ¥çš„ classes ç»„åˆï¼ˆ assembleï¼‰èµ·æ¥ã€‚å”¯ä¸€å¯ç»„åˆ Basesmartptrï¼Œ Multithreaded å’Œ Refcounted çš„å·¥å…·æ˜¯è¯­è¨€æä¾›çš„â€œå¤šé‡ç»§æ‰¿â€æœºåˆ¶ï¼šä»…ä»…åªæ˜¯å°†è¢«ç»„åˆçš„ base classes ç»“åˆåœ¨ä¸€èµ·å¹¶å»ºç«‹ä¸€ç»„ç”¨æ¥è®¿é—®å…¶æˆå‘˜çš„ç®€å•è§„åˆ™ã€‚é™¤éæƒ…å†µæä¸ºå•çº¯ï¼Œå¦åˆ™ç»“æœéš¾ä»¥è®©äººæ¥å—ã€‚å¤§å¤šæ•°æ—¶å€™ä½ å¾—å°å¿ƒåè°ƒç»§æ‰¿è€Œæ¥çš„ classes çš„è¿è½¬ï¼Œè®©å®ƒä»¬å¾—åˆ°æ‰€éœ€çš„è¡Œä¸ºã€‚</li><li>å…³äºå‹åˆ«ä¿¡æ¯ï¼ˆ Type informationï¼‰ã€‚ Based classes å¹¶æ²¡æœ‰è¶³å¤Ÿçš„å‹ä¿¡æ¯æ¥ç»§ç»­å®Œæˆå®ƒä»¬çš„å·¥ä½œã€‚ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£è¯•ç€è—‰ç”±ç»§æ‰¿ä¸€ä¸ª Deepcopy class æ¥ä¸ºä½ çš„ smart pointer å®ä½œå‡ºæ·±å±‚æ‹·è´ï¼ˆ deep copyï¼‰ã€‚ä½† Deepcopy åº”è¯¥å…·æœ‰æ€æ ·çš„æ¥å£å‘¢ï¼Ÿå®ƒå¿…é¡»äº§ç”Ÿä¸€ä¸ªå¯¹è±¡ï¼Œè€Œå…¶å‹åˆ«ç›®å‰æœªçŸ¥ã€‚</li><li>å…³äºçŠ¶æ€å¤„ç†ï¼ˆ State manipulationï¼‰ base classes å®ä½œä¹‹å„ç§è¡Œä¸ºå¿…é¡»æ“ä½œç›¸åŒçš„ stateï¼ˆè¯‘æ³¨ï¼šæ„æŒ‡æ•°æ®ï¼‰ã€‚è¿™æ„å‘³ç€ä»–ä»¬å¿…é¡»è™šç»§æ‰¿ä¸€ä¸ªæŒæœ‰è¯¥ state çš„ base class ç”±äºæ€»æ˜¯ç”± user classes ç»§æ‰¿ library classesï¼ˆè€Œéåå‘ï¼‰ï¼Œè¿™ä¼šä½¿è®¾è®¡æ›´åŠ å¤æ‚è€Œä¸”å˜å¾—æ›´æ²¡æœ‰å¼¹æ€§ã€‚</li></ul><p>è™½ç„¶æœ¬è´¨ä¸Šæ˜¯ç»„åˆï¼ˆ combinatorialï¼‰ï¼Œä½†å¤šé‡ç»§æ‰¿æ— æ³•å•ç‹¬è§£å†³è®¾è®¡æ—¶çš„å¤šæ ·æ€§é€‰æ‹©ã€‚</p><h1 id="templates-å¸¦æ¥æ›™å…‰">Templates å¸¦æ¥æ›™å…‰</h1><p>templates æ˜¯ä¸€ç§å¾ˆé€‚åˆâ€œç»„åˆå„ç§è¡Œä¸ºâ€çš„æœºåˆ¶ï¼Œä¸»è¦å› ä¸ºå®ƒä»¬æ˜¯â€œä¾èµ–ä½¿ç”¨è€…æä¾›çš„å‹åˆ«ä¿¡æ¯â€å¹¶ä¸”â€œåœ¨ç¼–è¯‘æœŸæ‰äº§ç”Ÿâ€çš„ä»£ç ã€‚ å’Œä¸€èˆ¬çš„ class ä¸åŒï¼Œ class templates å¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼å®šåˆ¶ã€‚å¦‚æœæƒ³è¦é’ˆå¯¹ç‰¹å®šæƒ…å†µæ¥è®¾è®¡ class ä½ å¯ä»¥åœ¨ä½ çš„ class template ä¸­ç‰¹åŒ–å…¶æˆå‘˜å‡½æ•°æ¥å› åº”ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæœ‰ä¸€ä¸ª Smartart<t>ä½ å¯ä»¥é’ˆå¯¹ SmartPtr<widget>ç‰¹åŒ–å…¶ä»»ä½•æˆå‘˜å‡½æ•°ï¼Œè¿™å¯ä»¥ä¸ºä½ åœ¨è®¾è®¡ç‰¹å®šè¡Œä¸ºæ—¶æä¾›è‰¯å¥½ç²’åº¦ï¼ˆgranularï¼‰ã€‚ çŠ¹æœ‰è¿›è€…ï¼Œå¯¹äºå¸¦æœ‰å¤šä¸ªå‚æ•°çš„ class templates ä½ å¯ä»¥é‡‡ç”¨ partial template specializationï¼ˆåç‰¹åŒ–ï¼‰ã€‚å®ƒå¯ä»¥è®©ä½ æ ¹æ®éƒ¨åˆ†å‚æ•°æ¥ç‰¹åŒ–ä¸€ä¸ª class templateã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸ª template å®šä¹‰ï¼š</widget></t></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>, Class U&gt; <span class="keyword">class</span> <span class="title class_">Smartptr</span> {...};</span><br></pre></td></tr></tbody></table></figure><p>ä½ å¯ä»¥ä»¤ SmartPtr&lt;Tï¼ŒU&gt;é’ˆå¯¹ widget åŠå…¶ä»–ä»»æ„å‹åˆ«åŠ ä»¥ç‰¹åŒ–ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="keyword">class</span> <span class="title class_">SmartPtr</span>&lt;Widget, U&gt; {...};</span><br></pre></td></tr></tbody></table></figure><p>template çš„ç¼–è¯‘æœŸç‰¹æ€§ä»¥åŠâ€œå¯äº’ç›¸ç»„åˆâ€ç‰¹æ€§ï¼Œä½¿å®ƒåœ¨è®¾è®¡æœŸéå¸¸å¼•äººæ³¨ç›®ã€‚ç„¶è€Œä¸€æ—¦ä½ å¼€å§‹å°è¯•å®ä½œè¿™äº›è®¾è®¡ï¼Œä½ ä¼šé­é‡ä¸€äº›ä¸æ˜¯é‚£ä¹ˆæµ…ç™½çš„é—®é¢˜ã€‚</p><ul><li>ä½ æ— æ³•ç‰¹åŒ–ç»“æ„ã€‚å•å•ä½¿ç”¨ templatesï¼Œä½ æ— æ³•ç‰¹åŒ–â€œ class çš„ç»“æ„â€ï¼ˆæˆ‘çš„æ„æ€æ˜¯å…¶æ•°æ®æˆå‘˜ï¼‰ï¼Œä½ åªèƒ½ç‰¹åŒ–å…¶æˆå‘˜å‡½æ•°ã€‚</li><li>æˆå‘˜å‡½æ•°çš„ç‰¹åŒ–å¹¶ä¸èƒ½â€œä¾ç†æ‰©å¼ â€ã€‚ä½ å¯ä»¥å¯¹â€œå•ä¸€ template å‚æ•°â€çš„ class template ç‰¹åŒ–å…¶æˆå‘˜å‡½æ•°ï¼Œå´æ— æ³•å¯¹ç€â€œå¤šä¸ª template å‚æ•°â€çš„ class template ç‰¹åŒ–å…¶ä¸ªåˆ«æˆå‘˜å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="keyword">class</span> <span class="title class_">Widget</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span> </span>{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//Okay: specialization of a member function of widget</span></span><br><span class="line"><span class="keyword">template</span> &lt;&gt; <span class="type">void</span> Widget&lt;<span class="type">char</span>&gt;:: <span class="built_in">fun</span>() </span><br><span class="line">{</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span> </span>{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯ï¼Œä¸‹é¢æ˜¯æˆ‘è¢«å‘ŠçŸ¥çš„é”™è¯¯ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="keyword">class</span> <span class="title class_">Gadget</span></span><br><span class="line">{</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span> </span>{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//Error! cannot partially specialize a member function of Gadget</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="type">void</span> Gadget&lt;<span class="type">char</span>,U&gt;::<span class="built_in">fun</span>()</span><br><span class="line">{</span><br><span class="line">  ..specialized implementation</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»…å¯¹ä¸€ä¸ªæˆå‘˜å‡½æ•°è¿›è¡Œéƒ¨åˆ†ç‰¹åŒ–æ˜¯ä¸å¯èƒ½çš„ï¼Œè€Œå¿…é¡»å¯¹æ•´ä¸ªç±»è¿›è¡Œéƒ¨åˆ†ç‰¹åŒ–ã€‚è¿™å°±æ˜¯ C++ä¸­çš„å·¥ä½œæ–¹å¼ã€‚</p><p>åŸå› æ˜¯æ‚¨ä¸èƒ½æ‹¥æœ‰éƒ¨åˆ†ä¸“é—¨çš„åŠŸèƒ½ï¼Œè€Œæˆå‘˜åŠŸèƒ½æœ¬èº«å°±æ˜¯åŠŸèƒ½ã€‚é€šè¿‡éƒ¨åˆ†åœ°ä¸“ç”¨æ•´ä¸ªç±»ï¼Œæˆå‘˜å‡½æ•°å°†â€œçœ‹èµ·æ¥â€åƒå…·æœ‰è¾ƒå°‘ç±»å‹çš„æ¨¡æ¿ï¼ˆåœ¨è¯¥éƒ¨åˆ†ä¸“ç”¨ç±»ä¸­ï¼‰ã€‚</p><ul><li>ç¨‹åºåº“æ’°å†™è€…ä¸èƒ½å¤Ÿæä¾›å¤šç¬”ç¼ºçœå€¼ã€‚ç†æƒ³æƒ…å†µä¸‹ class template çš„ä½œè€…å¯ä»¥å¯¹æ¯ä¸ªæˆå‘˜å‡½æ•°æä¾›ä¸€ä»½ç¼ºçœå®ä½œå“ï¼Œå´ä¸èƒ½å¯¹åŒä¸€ä¸ªæˆå‘˜å‡½æ•°æä¾›å¤šä»½ç¼ºçœå®ä½œå“ã€‚</li></ul><p>ç°åœ¨è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹å¤šé‡ç»§æ‰¿å’Œ templates ä¹‹é—´çš„ç¼ºç‚¹ã€‚æœ‰è¶£çš„æ˜¯ä¸¤è€…äº’è¡¥ã€‚å¤šé‡ç»§æ‰¿æ¬ ç¼ºæŠ€æœ¯ï¼ˆ mechanicsï¼‰ï¼Œ templates æœ‰ä¸°å¯Œçš„æŠ€æœ¯ã€‚å¤šé‡ç»§æ‰¿ç¼ºä¹å‹åˆ«ä¿¡æ¯ï¼Œè€Œé‚£ä¸œè¥¿åœ¨ templates é‡Œå¤§é‡å­˜åœ¨ã€‚ Templates çš„ç‰¹åŒ–æ— æ³•æ‰©å¼ ï¼ˆ scalesï¼‰ï¼Œå¤šé‡ç»§æ‰¿å´å¾ˆå®¹æ˜“æ‰©å¼ ã€‚ä½ åªèƒ½ä¸º template æˆå‘˜å‡½æ•°å†™ä¸€ä»½ç¼ºçœç‰ˆæœ¬ï¼Œä½†ä½ å¯ä»¥å†™æ•°é‡æ— é™çš„ base classes æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œå¦‚æœæˆ‘ä»¬å°† templates å’Œå¤šé‡ç»§æ‰¿ç»„åˆèµ·æ¥ï¼Œå°†ä¼šäº§ç”Ÿéå¸¸å…·å¼¹æ€§çš„è®¾å¤‡ï¼ˆ deviceï¼‰ï¼Œåº”è¯¥å¾ˆé€‚åˆç”¨æ¥äº§ç”Ÿç¨‹åºåº“ä¸­çš„â€œè®¾è®¡å…ƒç´ â€ï¼ˆ design elementsï¼‰ã€‚</p><h1 id="policies-å’Œ-policy-classes">Policies å’Œ Policy Classes</h1><p>Policies å’Œ Policy Classes æœ‰åŠ©äºæˆ‘ä»¬è®¾è®¡å‡ºå®‰å…¨ã€æœ‰æ•ˆç‡ä¸”å…·é«˜åº¦å¼¹æ€§çš„â€œè®¾è®¡å…ƒç´ â€ã€‚æ‰€è°“ policyï¼Œä¹ƒç”¨æ¥å®šä¹‰ä¸€ä¸ª class æˆ– class template çš„æ¥å£ï¼Œè¯¥æ¥å£ç”±ä¸‹åˆ—é¡¹ç›®ä¹‹ä¸€æˆ–å…¨éƒ¨ç»„æˆï¼šå†…éšå‹åˆ«å®šä¹‰ï¼ˆ inner type definitionï¼‰ã€æˆå‘˜å‡½æ•°å’Œæˆå‘˜å˜é‡</p><p>Policies ä¹Ÿè¢«å…¶ä»–äººç”¨äº traitsï¼ˆ Alexandrescu2000aï¼‰ï¼Œä¸åŒçš„æ˜¯åè€…æ¯”è¾ƒé‡è§†è¡Œä¸ºè€Œéå‹åˆ«ã€‚Policies ä¹Ÿè®©äººè”æƒ³åˆ°è®¾è®¡æ¨¡å¼ Strategyï¼ˆ Gamma et a.195ï¼‰ï¼Œåªä¸è¿‡ policies åƒç´§äºç¼–è¯‘æœŸï¼ˆæ‰€è°“ compile-time boundï¼‰ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª policy ç”¨ä»¥ç”Ÿæˆå¯¹è±¡ï¼š Creator policy æ˜¯ä¸€ä¸ªå¸¦æœ‰å‹åˆ« T çš„ class templateï¼Œå®ƒå¿…é¡»æä¾›ä¸€ä¸ªåä¸º Create çš„å‡½æ•°ç»™å¤–ç•Œä½¿ç”¨ï¼Œæ­¤å‡½æ•°ä¸æ¥å—å¼•æ•°ï¼Œä¼ å›-ä¸ª pointer-to-Tã€‚å°±è¯­ä¹‰è€Œè¨€ï¼Œæ¯å½“ Createï¼ˆï¼‰è¢«è°ƒç”¨å°±å¿…é¡»ä¼ å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ–°ç”Ÿçš„ T å¯¹è±¡ã€‚è‡³äºå¯¹è±¡çš„ç²¾ç¡®ç”Ÿæˆæ¨¡å¼ï¼ˆ creation modeï¼‰ï¼Œç•™ç»™ policy å®ä½œå“ä½œä¸ºå›æ—‹ä½™åœ°ã€‚ è®©æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå¯å®ä½œå‡º Creator policy çš„ class äº§ç”Ÿå¯¹è±¡çš„å¯è¡ŒåŠæ³•ä¹‹ä¸€å°±æ˜¯è¡¨è¾¾å¼ new å¦ä¸€ä¸ªåŠæ³•æ˜¯ä»¥ mallocï¼ˆï¼‰åŠ ä¸Š placement new æ“ä½œç¬¦ï¼ˆ Meyers1998bï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥é‡‡ç”¨å¤åˆ¶ï¼ˆ cloningï¼‰æ–¹å¼æ¥äº§ç”Ÿæ–°å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ä¸‰ç§åšæ³•çš„å®å‘ˆç°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OpNewCreator</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">static</span> T* <span class="title">Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> T;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MallocCreator</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">static</span> T* <span class="title">Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="type">void</span>* buf = std::<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(T));</span><br><span class="line">        <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">new</span>(buf) T;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PrototypeCreator</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">PrototypeCreator</span>(T* pObj = <span class="number">0</span>)</span><br><span class="line">        :<span class="built_in">pPrototype_</span>(pObj)</span><br><span class="line">    {}</span><br><span class="line">    <span class="function">T* <span class="title">Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> pPrototype_ ? pPrototype_-&gt;<span class="built_in">Clone</span>() : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function">T* <span class="title">GetPrototype</span><span class="params">()</span> </span>{ <span class="keyword">return</span> pPrototype_; }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetPrototype</span><span class="params">(T* pObj)</span> </span>{ pPrototype_ = pObj; }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* pPrototype_;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ä»»ä½•ä¸€ä¸ª policy éƒ½å¯ä»¥æœ‰æ— é™å¤šä»½å®ä½œå“ã€‚å®ä½œå‡º policy è€…ä½¿ç§°ä¸º policy classesï¼Œè¿™ä¸ªä¸œè¥¿å¹¶ä¸æ„å›¾è¢«å•ç‹¬ä½¿ç”¨ï¼Œå®ƒä»¬ä¸»è¦ç”¨äºç»§æ‰¿æˆ–è¢«å†…å«äºå…¶ä»– classesã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦è§‚å¿µï¼š policies æ¥å£å’Œä¸€èˆ¬ä¼ ç»Ÿçš„ classes æ¥å£ï¼ˆçº¯è™šå‡½æ•°é›†ï¼‰ä¸åŒï¼Œå®ƒæ¯”è¾ƒæ¾æ•£ï¼Œä¸º policy æ˜¯è¯­æ³•å¯¼å‘ï¼ˆ syntax orientedï¼‰è€Œéæ ‡è®°å¯¼å‘ï¼ˆ signature orientedï¼‰æ›å¥è¯è¯´ï¼Œ Creator æ˜ç¡®å®šä¹‰çš„æ˜¯â€œæ€æ ·çš„è¯­æ³•æ„é€ ç¬¦åˆå…¶æ‰€è§„èŒƒçš„ classâ€ï¼Œè€Œéâ€œå¿…é¡»å®ä½œå‡ºå“ªäº›å‡½æ•°â€ã€‚ä¾‹å¦‚ Creator policy å¹¶æ²¡æœ‰è§„èŒƒ Createï¼ˆï¼‰å¿…é¡»æ˜¯ static è¿˜æ˜¯ virtualï¼Œå®ƒåªè¦æ±‚ class å¿…é¡»å®šä¹‰å‡º Createï¼ˆï¼‰ã€‚æ­¤å¤–ï¼Œ Creator ä¹Ÿåªè§„å®š createï¼‰åº”è¯¥ï¼ˆä½†éå¿…é¡»ï¼‰ä¼ å›ä¸€ä¸ªæŒ‡å‘æ–°å¯¹è±¡çš„æŒ‡é’ˆå› æ­¤ Createï¼ˆï¼‰ä¹Ÿè®¸ä¼šä¼ å› 0 æˆ–ä¸¢å‡ºå¼‚å¸¸ä¸€è¿™éƒ½ææœ‰å¯èƒ½ã€‚ é¢å¯¹ä¸€ä¸ª policyï¼Œä½ å¯ä»¥å®ä½œå‡ºæ•°ä¸ª policy classes å®ƒä»¬å…¨éƒ½å¿…é¡»éµå®ˆ policy æ‰€å®šä¹‰çš„æ¥å£ã€‚ç¨åä½ ä¼šçœ‹åˆ°ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨è€…é€‰æ‹©äº†ä¸€ä¸ª policy å¹¶åº”ç”¨åˆ°è¾ƒå¤§ç»“æ„ä¸­ã€‚ å…ˆå‰å®šä¹‰çš„ä¸‰ä¸ª policy classes å„æœ‰ä¸åŒçš„å®ä½œæ–¹å¼ï¼Œç”šè‡³è¿æ¥ä¹Ÿæœ‰äº›ä¸åŒï¼ˆä¾‹å¦‚ Prototypecreator å¤šäº†ä¸¤ä¸ªå‡½æ•° GetPrototypeï¼ˆï¼‰å’Œ Setprototypeï¼ˆï¼‰ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬å…¨éƒ½å®šä¹‰ Createï¼ˆï¼‰å¹¶å¸¦æœ‰å¿…è¦çš„è¿”å›å‹åˆ¥ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½ç¬¦åˆ Creator policy ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è®¾è®¡ä¸€ä¸ª class å¾—ä»¥åˆ©ç”¨ Creator policyï¼Œå®ƒä»¥å¤åˆæˆ–ç»§æ‰¿çš„æ–¹å¼ä½¿ç”¨å…ˆå‰æ‰€å®šä¹‰çš„ä¸‰ä¸ª classes ä¹‹ï¼Œå¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Library code</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">CreationPolicy</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WidgetManager</span>: <span class="keyword">public</span> CreationPolicy</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ class é‡‡ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª policiesï¼Œæˆ‘ä»¬ç§°å…¶ä¸º hosts æˆ– host classesã€‚ä¸Šä¾‹çš„ WidgetManager ä½¿æ˜¯â€œé‡‡ç”¨äº†ä¸ª policy'â€çš„ host class. Hosts è´Ÿè´£æŠŠ policies æä¾›çš„ç»“æ„å’Œè¡Œä¸ºç»„æˆä¸€ä¸ªæ›´å¤æ‚çš„ç»“æ„å’Œè¡Œä¸ºã€‚ å½“å®¢æˆ·ç«¯å°† WidgetManager template å…·ç°åŒ–ï¼ˆ Instantiatingï¼‰æ—¶ï¼Œå¿…é¡»ä¼ è¿›ä¸€ä¸ªä»–æ‰€æœŸæœ›çš„ policyï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application code</span></span><br><span class="line"><span class="keyword">typedef</span> WidgetManager&lt; Opnewcreator&lt;Widget&gt; MyWidgetMgr;</span><br></pre></td></tr></tbody></table></figure><p>è®©æˆ‘ä»¬åˆ†ææ•´ä¸ªæ¥é¾™å»è„‰ã€‚æ— è®ºä½•æ—¶ï¼Œå½“ä¸ª MyWidgetMgr å¯¹è±¡éœ€è¦äº§ç”Ÿä¸€ä¸ª Widget å¯¹è±¡æ—¶å®ƒä¾¿è°ƒç”¨å®ƒçš„ policy äº†å¯¹è±¡ OpNewCreator<widget>æ‰€æä¾›çš„ Createï¼ˆï¼‰é€‰æ‹©â€œç”Ÿæˆç­–ç•¥ï¼ˆ Creation policyï¼‰æ˜¯ WidgetManager ä½¿ç”¨è€…çš„æƒåˆ©ã€‚è—‰ç”±è¿™æ ·çš„è®¾è®¡ï¼Œå¯ä»¥è®© WidgetManager ä½¿ç”¨è€…è‡ªè¡Œè£…é…ä»–æ‰€éœ€è¦çš„æœºèƒ½ã€‚è¿™ä¾¿æ˜¯ policy-based class çš„è®¾è®¡ä¸»æ—¨ã€‚</widget></p><h2 id="è¿ç”¨-template-template-å‚æ•°å®ä½œ-policy-classes">è¿ç”¨ Template Template å‚æ•°å®ä½œ Policy Classes</h2><p>å¦‚åŒå…ˆå‰ä¾‹å­æ‰€ç¤ºï¼Œ policy çš„ template å¼•æ•°å¾€å¾€æ˜¯ä½™çš„ã€‚ä½¿ç”¨è€…æ¯æ¯éœ€è¦ä¼ å…¥ template å¼•æ•°ç»™ Opnewcreatorï¼Œè¿™å¾ˆç¬¨æ‹™ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ host class å·²ç»çŸ¥é“ policy class æ‰€éœ€çš„å‚æ•°ï¼Œæˆ–æ˜¯è½»æ˜“ä½¿å¯æ¨å¯¼å‡ºæ¥ã€‚ä¸Šè¿°ä¾‹å­ä¸­ WidgetManager æ€»æ˜¯æ“ä½œ Widget å¯¹è±¡ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜è¦æ±‚ä½¿ç”¨è€…â€œæŠŠ Widget å‹åˆ«ä¼ ç»™ Opnewcreatorâ€å°±æ˜¾å¾—å¤šä½™è€Œä¸”å±é™©ã€‚ è¿™å€™ç¨‹åºåº“å¯ä»¥ä½¿ç”¨â€œ template template å‚æ•°â€æ¥æè¿° policiesï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Library code</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">template</span>&lt;classCreated&gt; <span class="keyword">class</span> <span class="title class_">CreationPolicy</span>&gt; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WidgetManager</span>: <span class="keyword">public</span> Creatlonpollcy&lt;Widget&gt;</span><br><span class="line"><span class="comment">//è¯‘æ³¨ï¼š Created æ˜¯ CreationPolicy çš„å‚æ•°ï¼Œ CreationPolicy åˆ™æ˜¯ WidgetManager</span></span><br><span class="line"><span class="comment">//çš„å‚æ•°ã€‚ Widget å·²ç»å†™å…¥ä¸Šè¿°ç¨‹åºåº“ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶ä¸éœ€è¦å†ä¼ ä¸€æ¬¡å‚æ•°ç»™ policys</span></span><br></pre></td></tr></tbody></table></figure><p>å°½ç®¡éœ²äº†è„¸ï¼Œä¸Šè¿° Created ä¹Ÿå¹¶æœªå¯¹ WidgetManager æœ‰ä»»ä½•è´¡çŒ®ã€‚ä½ ä¸èƒ½åœ¨ WidgetManager ä¸­ä½¿ç”¨ Createdï¼Œå®ƒåªæ˜¯ CreationPolicyï¼ˆè€Œé Wi dgetManagerï¼‰çš„å½¢å¼å¼•æ•°ï¼ˆ formal argumentï¼‰ï¼Œæ­¤å¯ä»¥çœç•¥ã€‚ åº”ç”¨ç«¯ç°åœ¨åªéœ€åœ¨ä½¿ç”¨ WidgetManager æ—¶æä¾› template åç§°å³å¯ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application code</span></span><br><span class="line"><span class="keyword">typedef</span> WidgetManager&lt;OpNewCreator&gt; MyWidgetMgr;</span><br></pre></td></tr></tbody></table></figure><p>æ­é… policy class ä½¿ç”¨â€œ template template å‚æ•°â€ï¼Œå¹¶ä¸å•çº¯åªä¸ºäº†æ–¹ä¾¿ã€‚æœ‰æ—¶å€™è¿™ç§ç”¨æ³•ä¸å¯æˆ–ç¼ºï¼Œä»¥ä¾¿ host class å¯è—‰ç”± templates äº§ç”Ÿä¸åŒå‹åˆ«çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ WidgetManager æƒ³è¦ä»¥ç›¸åŒçš„ç”Ÿæˆç­–ç•¥äº§ç”Ÿä¸€ä¸ª Gadget å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Library code</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">template</span> <span class="keyword">class</span>&gt; <span class="keyword">class</span> <span class="title class_">CreationPolicy</span>&gt; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WidgetManager</span>: <span class="keyword">public</span> CreationPolicy&lt;Widget&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Dosomething</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        Gadget* pw=<span class="built_in">CreationPolicy</span>&lt;Gadget&gt;().<span class="built_in">Create</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ policies æ˜¯å¦ä¼šä¸ºæˆ‘ä»¬å¸¦æ¥ä¸€äº›ä¼˜åŠ¿å‘¢ï¼Ÿä½œçœ‹ä¹‹ä¸‹å¹¶ä¸å¤ªå¤šã€‚é¦–å…ˆï¼Œ Creator policy çš„å®ä½œæœ¨æ¥å°±ååˆ†ç®€çŸ­ã€‚å½“ç„¶ï¼Œ WidgetManager çš„ä½œè€…åº”è¯¥ä¼šæŠŠâ€œç”Ÿæˆå¯¹è±¡â€çš„é‚£ä»½ä»£ç å†™æˆ inline å‡½æ•°ï¼Œå¹¶é¿å¼€â€œå°† WidgetManager å»ºç«‹ä¸ºä¸€ä¸ª templateâ€æ—¶å¯èƒ½é­é‡çš„é—®é¢˜ã€‚</p><p>ç„¶è€Œï¼Œ policy çš„ç¡®èƒ½å¤Ÿå¸¦ç»™ WidgetManager éå¸¸å¤§çš„å¼¹æ€§ã€‚ç¬¬ä¸€ï¼Œå½“ä½ å‡†å¤‡å…·ç°åŒ–ï¼ˆ instantiatingï¼‰ WidgetManager æ—¶ï¼Œä½ å¯ä»¥ä»å¤–éƒ¨å˜æ›´ policiesï¼Œå°±å’Œæ”¹å˜ template å¼•æ•°ä¸€æ ·ç®€å•ã€‚ç¬¬äºŒï¼Œä½ å¯ä»¥æ ¹æ®ç¨‹åºçš„ç‰¹æ®Šéœ€æ±‚ï¼Œæä¾›è‡ªå·±çš„ policiesã€‚ä½ å¯ä»¥é‡‡ç”¨ new æˆ– malloc æˆ– prototypes æˆ–ä¸€ä¸ªä¸“ç”¨äºä½ è‡ªå·±ç³»ç»Ÿä¸Šçš„ç½•è§å†…å­˜åˆ†é…å™¨ã€‚ WidgetManager å°±åƒä¸€ä¸ªå°å‹çš„â€œä»£ç ç”Ÿæˆå¼•æ“â€ï¼ˆ code generation engineï¼‰ï¼Œä½ å¯ä»¥è‡ªè¡Œè®¾å®šä»£ç çš„äº§ç”Ÿæ–¹å¼ã€‚ ä¸ºäº†è®©åº”ç”¨ç¨‹åºå¼€å‘å…¥å‘˜çš„æ—¥å­æ›´è½»æ¾ï¼Œ WidgetManager çš„ä½œè€…åº”è¯¥å®šä¹‰ä¸€äº›å¸¸ç”¨çš„ policiesï¼Œå¹¶ä¸”ä»¥â€œ template ç¼ºçœå¼•æ•°â€çš„å½¢å¼æä¾›æœ€å¸¸ç”¨çš„ policy</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">template</span> &lt;<span class="keyword">class</span>&gt; <span class="keyword">class</span> <span class="title class_">Creation</span>=Opnewcreator&gt; </span><br><span class="line"><span class="keyword">class</span> WidgetManager...</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼Œ policies å’Œè™šå‡½æ•°æœ‰å¾ˆå¤§ä¸åŒã€‚è™½ç„¶è™šå‡½æ•°ä¹Ÿæä¾›ç±»ä¼¼æ•ˆæœï¼š class ä½œè€…ä»¥åŸºæœ¬çš„ï¼ˆ primitiveï¼‰è™šå‡½æ•°æ¥å»ºç«‹é«˜ç«¯åŠŸèƒ½ï¼Œå¹¶å…è®¸ä½¿ç”¨è€…æ”¹å†™è¿™äº›åŸºæœ¬è™šå‡½æ•°çš„è¡Œä¸ºã€‚ç„¶è€Œå¦‚å‰æ‰€ç¤ºï¼Œ policies å› ä¸ºæœ‰ä¸°å¯Œçš„å‹åˆ«ä¿¡æ¯åŠé™æ€è¿æ¥ç­‰ç‰¹æ€§ï¼Œæ‰€ä»¥æ˜¯å»ºç«‹â€œè®¾è®¡å…ƒç´ â€æ—¶çš„æœ¬è´¨æ€§ä¸œè¥¿ã€‚ä¸æ­£æ˜¯â€œè®¾è®¡â€æŒ‡å®šäº†â€œæ‰§è¡Œå‰å‹åˆ«å¦‚ä½•äº’ç›¸ä½œç”¨ã€ä½ èƒ½å¤Ÿåšä»€ä¹ˆã€ä¸èƒ½å¤Ÿåšä»€ä¹ˆâ€çš„å®Œæ•´è§„åˆ™å—ï¼Ÿ Policies å¯ä»¥è®©ä½ åœ¨å‹åˆ«å®‰å…¨ï¼ˆ typesafeï¼‰çš„å‰æä¸‹è—‰ç”±ç»„åˆå„ä¸ªç®€å•çš„éœ€æ±‚æ¥äº§å‡ºä½ çš„è®¾è®¡ã€‚æ­¤å¤–ï¼Œç”±äºç¼–è¯‘æœŸæ‰å°† host class å’Œå…¶ policies ç»“åˆåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥å’Œæ‰‹å·¥æ‰“é€ çš„ç¨‹åºæ¯”è¾ƒèµ·æ¥æ›´åŠ ç‰¢å›ºå¹¶ä¸”æ›´æœ‰æ•ˆç‡ã€‚ å½“ç„¶ï¼Œä¹Ÿç”±äº policies çš„ç‰¹è´¨ï¼Œå®ƒä»¬ä¸é€‚ç”¨äºåŠ¨æ€è¿ç»“å’ŒäºŒè¿›ä½æ¥å£ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Š policies å’Œä¼ ç»Ÿæ¥å£å¹¶ä¸äº’ç›¸äº‰ã€‚</p><h2 id="è¿ç”¨-template-æˆå‘˜å‡½æ•°å®ä½œ-policy-classes">è¿ç”¨ Template æˆå‘˜å‡½æ•°å®ä½œ Policy Classes</h2><p>å¦å¤–ä¸€ç§ä½¿ç”¨â€œ template template å‚æ•°â€çš„æƒ…å†µæ˜¯æŠŠ template æˆå‘˜å‡½æ•°ç”¨æ¥è¿æ¥æ‰€éœ€çš„ç®€å•ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°† policy å®ä½œä¸ºä¸€èˆ¬ classï¼ˆâ€œä¸€èˆ¬â€æ˜¯ç›¸å¯¹äº class template è€Œè¨€ï¼‰ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–æ•°ä¸ª templated members. ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å®šä¹‰å…ˆå‰çš„ Creator policy æˆä¸ºä¸€ä¸ª non-template classï¼Œå…¶å†…æä¾›ä¸€ä¸ªåä¸º create<t>çš„ template å‡½æ•°ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œ policy class çœ‹èµ·æ¥åƒä¸‹é¢è¿™ä¸ªæ ·å­ã€‚</t></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">OpNewCreator</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; </span><br><span class="line">    <span class="function"><span class="type">static</span> T* <span class="title">Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> T;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç§æ–¹å¼æ‰€å®šä¹‰å¹¶å®ä½œå‡ºæ¥çš„ policyï¼Œå¯¹äºæ—§å¼ç¼–è¯‘å™¨æœ‰è¾ƒä½³å…¼å®¹æ€§ã€‚ä½†ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œè¿™æ ·çš„ policy éš¾ä»¥è®¨è®ºã€å®šä¹‰ã€å®ä½œå’Œè¿ç”¨ã€‚</p><h1 id="æ›´ä¸°å¯Œçš„-policies">æ›´ä¸°å¯Œçš„ Policies</h1><p>Creator policy åªæŒ‡å®šäº†ä¸€ä¸ª Createï¼ˆï¼‰æˆå‘˜å‡½æ•°ã€‚ç„¶è€Œ Prototypecreator å´å¤šå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸º GetPrototypeï¼ˆï¼‰å’Œ Setprotorypeï¼ˆï¼‰ã€‚è®©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚ç”±äº WidgetManager ç»§æ‰¿äº† policy classï¼Œè€Œä¸” GetPrototype() å’Œ Setprototypeï¼ˆï¼‰æ˜¯ Prototype Creator çš„ public æˆå‘˜ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå‡½æ•°ä½¿è¢«åŠ è‡³ WidgetManagerï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥è¢«ä½¿ç”¨è€…å–ç”¨ã€‚ ç„¶è€Œ WidgetManager åªè¦æ±‚ Createï¼ˆï¼‰ï¼›é‚£æ˜¯ WidgetManager åˆ‡æ‰€éœ€ï¼Œä¹Ÿæ˜¯ç”¨æ¥ä¿è¯å®ƒè‡ªå·±æœºèƒ½çš„å”¯ä¸€è¦æ±‚ã€‚ä¸è¿‡ä½¿ç”¨è€…å¯ä»¥å¼€å‘å‡ºæ›´ä¸°å¯Œçš„æ¥å£ã€‚ prototype-based Creator policy class çš„ä½¿ç”¨è€…å¯ä»¥å†™å‡ºä¸‹åˆ—ä»£ç ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> WidgetManager&lt;Prototypecreator&gt; MyWidqetManager</span><br><span class="line">...</span><br><span class="line">Widget* prototype = ...;</span><br><span class="line">MyWidqetManager mri;</span><br><span class="line">mgr.<span class="built_in">Setprototype</span>(prototype);</span><br><span class="line">...use mgr...</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ­¤åä½¿ç”¨è€…å†³å®šé‡‡ç”¨ä¸€ä¸ªä¸æ”¯æŒ prototypes çš„ç”Ÿæˆç­–ç•¥ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæŒ‡å‡ºé—®é¢˜ï¼š prototype ä¸“å±æ¥å£å·²ç»è¢«ç”¨ä¸Šäº†ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬å¸Œæœ›è·å¾—çš„åšå›ºè®¾è®¡ã€‚ å¦‚æ­¤çš„ç»“æœæ˜¯å¾ˆå—æ¬¢è¿çš„ã€‚ä½¿ç”¨è€…å¦‚æœéœ€è¦æ‰©å…… policiesï¼Œå¯ä»¥åœ¨ä¸å½±å“ host class åŸæœ¬åŠŸèƒ½çš„å‰æä¸‹ï¼Œä»æ›´ä¸°å¯Œçš„åŠŸèƒ½ä¸­å¾—åˆ°å¥½å¤„ã€‚åˆ«å¿˜äº†ï¼Œå†³å®šâ€œå“ªä¸ª policy è¢«ä½¿ç”¨â€çš„æ˜¯ä½¿ç”¨è€…è€Œéç¨‹åºåº“è‡ªèº«ã€‚å’Œèˆ¬å¤šé‡æ¥å£ä¸åŒçš„æ˜¯ï¼Œ policies ç»™äºˆä½¿ç”¨è€…ä¸€ç§èƒ½åŠ›ï¼Œåœ¨å‹åˆ«å®‰å…¨ï¼ˆ typesafe çš„å‰æä¸‹æ‰©å¢ host class çš„åŠŸèƒ½ã€‚</p><h2 id="policy-classes-çš„ææ„å‡½æ•°-destructors">Policy Classes çš„ææ„å‡½æ•° ( Destructors)</h2><p>æœ‰ä¸€ä¸ªå…³äºå»ºç«‹ policy classes çš„è¦ç»†èŠ‚ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ host class ä¼šä»¥ public ç»§æ‰¿â€æ–¹å¼ä»æŸäº› policies æ´¾ç”Ÿè€Œæ¥ã€‚å› æ­¤ï¼Œä½¿ç”¨è€…å¯ä»¥å°†ä¸€ä¸ª host class è‡ªåŠ¨è½¬ä¸ºä¸€ä¸ª policy classï¼ˆè¯‘æ³¨ï¼šå‘ä¸Šè½¬å‹ï¼‰ï¼Œå¹¶äºç¨å delete è¯¥æŒ‡é’ˆã€‚é™¤é policy class å®šä¹‰äº†ä¸€ä¸ªè™šææ„å‡½æ•°ï¼ˆ virtual destructorï¼‰ï¼Œå¦åˆ™ delete ä¸ªæŒ‡å‘ policy class f çš„æŒ‡é’ˆï¼Œä¼šäº§ç”Ÿä¸å¯é¢„æœŸçš„ç»“æœ 4ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> WidgetManager&lt;Prototypecreator&gt; MyWidgetManager;</span><br><span class="line">MyWidgetManager wm;</span><br><span class="line">PrototypeCreator&lt;Widget&gt;* pCreator = &amp;wm; <span class="comment">// dubious, but legal</span></span><br><span class="line"><span class="keyword">delete</span> pCreator;    <span class="comment">// compiles fine, but has undefined behavior</span></span><br></pre></td></tr></tbody></table></figure><p>ç„¶è€Œå¦‚æœä¸º policy å®šä¹‰äº†ä¸€ä¸ªè™šææ„å‡½æ•°ï¼Œä¼šå¦¨ç¢ policy çš„é™æ€è¿ç»“ç‰¹æ€§ï¼Œä¹Ÿä¼šå½±å“æ‰§è¡Œæ•ˆç‡ã€‚</p><p>è®¸å¤š policies å¹¶æ— ä»»ä½•æ•°æ®æˆå‘˜ï¼Œçº¯ç²¹åªè§„èŒƒè¡Œä¸ºã€‚ç¬¬ä¸€ä¸ªè™šå‡½æ•°è¢«åŠ å…¥åä¼šä¸ºå¯¹è±¡å¤§å°å¸¦æ¥é¢å¤–å¼€é”€ï¼ˆè¯‘æ³¨ï¼šå› ä¸ºå¼•å…¥ä¸€ä»½ vptrï¼‰ï¼Œæ‰€ä»¥è™šææ„å‡½æ•°åº”è¯¥å°½å¯èƒ½é¿å…ã€‚ ä¸€ä¸ªè§£æ³•æ˜¯ï¼Œå½“ host class è‡ª policy class æ´¾ç”Ÿæ—¶ï¼Œé‡‡ç”¨ protected ç»§æ‰¿æˆ– private ç»§æ‰¿ã€‚ç„¶è€Œè¿™æ ·ä¼šå¤±å»ä¸°å¯Œçš„ policies ç‰¹æ€§ã€‚ policies åº”è¯¥é‡‡ç”¨ä¸€ä¸ªè½»ä¾¿è€Œæœ‰æ•ˆç‡çš„è§£æ³•ä¸€å®šä¹‰ä¸€ä¸ª non-virtual protected ææ„å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">OpNewCreator</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; </span><br><span class="line">    <span class="function"><span class="type">static</span> T* <span class="title">Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> T;</span><br><span class="line">    }</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    ~<span class="built_in">Opnewcreator</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç”±äºææ„å‡½æ•°å±äº protected å±‚çº§ï¼Œæ‰€ä»¥åªæœ‰æ´¾ç”Ÿè€Œå¾—çš„ classes æ‰å¯ä»¥æ‘§æ¯è¿™ä¸ª policy å¯¹è±¡ã€‚è¿™æ ·ä¸€æ¥å¤–ç•Œå°±ä¸å¯èƒ½ delete ä¸€ä¸ªæŒ‡å‘ policy class çš„æŒ‡é’ˆã€‚è€Œç”±äºææ„å‡½æ•°å¹¶éè™šå‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¤§å°æˆ–é€Ÿåº¦ä¸Šçš„é¢å¤–å¼€é”€ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠModern C++ Design-C++è®¾è®¡æ–°æ€ç»´ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Design Patters </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆå…­ï¼‰nullptr ä¸ Lambda</title>
      <link href="/2022/Program/CPP11Part6/"/>
      <url>/2022/Program/CPP11Part6/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP1ChangeThinkType.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMzMWNjZDBlM2U3NDA3ZGE1M2NlMTg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="nullptr">nullptr</h1><h2 id="nullptrnull-å’Œ-0">nullptrã€NULL å’Œ 0</h2><p>èˆ¬æƒ…å†µä¸‹ï¼ŒNULL æ˜¯ä¸€ä¸ªå®å®šä¹‰ã€‚åœ¨ä¼ ç»Ÿçš„ C å¤´æ–‡ä»¶ï¼ˆ stddef.hï¼‰é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä»£ç </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">undef</span> NULL</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NULL O</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NULL ((void *)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒNULL å¯èƒ½è¢«å®šä¹‰ä¸ºå­—é¢å¸¸é‡ 0ï¼Œæˆ–è€…æ˜¯å®šä¹‰ä¸ºæ— ç±»å‹æŒ‡é’ˆï¼ˆvoid*ï¼‰å¸¸é‡ã€‚ä¸è¿‡æ— è®ºé‡‡ç”¨ä»€ä¹ˆæ ·çš„å®šä¹‰ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ç©ºå€¼çš„æŒ‡é’ˆæ—¶ï¼Œéƒ½ä¸å¯é¿å…åœ°ä¼šé‡åˆ°ä¸€äº›éº»çƒ¦ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"int"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"ptr"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">func</span>(<span class="number">0</span>);                   <span class="comment">// int</span></span><br><span class="line">    <span class="built_in">func</span>(<span class="literal">NULL</span>);                <span class="comment">// intï¼Œæœ¬æ„æ˜¯è°ƒç”¨æŒ‡é’ˆå‡½æ•°ï¼Œå®é™…å´è°ƒç”¨äº† int å‡½æ•°</span></span><br><span class="line">    <span class="built_in">func</span>((<span class="type">void</span>*)<span class="number">0</span>);            <span class="comment">// ptr</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šçš„ä»£ç ä¸­ func(NULL); æœ¬æ„æ˜¯è°ƒç”¨æŒ‡é’ˆå‡½æ•°ï¼Œå®é™…å´è°ƒç”¨äº† int å‡½æ•°ï¼Œå› ä¸º NULL è¢«å®šä¹‰æˆäº† 0ã€‚è™½ç„¶åœ¨å‰é¢åŠ ä¸Š (void*) å¼ºåˆ¶è½¬æ¢èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æŸäº›ç¼–è¯‘å™¨ç¼ºä¼šåœ¨äº§ç”Ÿè¿™ç§äºŒä¹‰æ€§æ—¶æŠ¥é”™ï¼Œå¤šä»¥å¯¹äºä»£ç ç§»æ¤æ¥è¯´ä¼šæœ‰ä¸€å®šé™åˆ¶ã€‚äºæ˜¯ C++11 ä¸­æ–°å¢äº† nullptr æ¥ä»£è¡¨æŒ‡é’ˆç©ºå€¼ï¼Œä»¥ä¸Šé—®é¢˜å°±å¾—åˆ°äº†è§£å†³ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">func</span>(<span class="number">0</span>);                   <span class="comment">// int</span></span><br><span class="line">    <span class="built_in">func</span>(<span class="literal">nullptr</span>);             <span class="comment">// ptr</span></span><br><span class="line">    <span class="built_in">func</span>((<span class="type">void</span>*)<span class="number">0</span>);            <span class="comment">// ptr</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="nullptr-å’Œ-nullptr_t">nullptr å’Œ nullptr_t</h2><p>åŒæ—¶ï¼ŒC++11 è¿˜å®šä¹‰äº†æŒ‡é’ˆç©ºå€¼ç±»å‹ nullptr_tï¼Œå°±æ˜¯è¯´æŒ‡é’ˆç©ºå€¼å¹¶éåªæœ‰ nullptr ä¸€ä¸ªå®ä¾‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ nullptr_t æ¥å£°æ˜ä¸€ä¸ªç©ºæŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œè™½ç„¶å¥½åƒæ²¡ä»€ä¹ˆç”¨ã€‚å¦å¤–ï¼Œnullptr_t ä¹Ÿè§„å®šäº†ä¸€äº›è§„åˆ™ï¼š</p><ul><li>æ‰€æœ‰å®šä¹‰ä¸º nullptr_t ç±»å‹çš„æ•°æ®éƒ½æ˜¯ç­‰ä»·çš„ï¼Œè¡Œä¸ºä¹Ÿå®Œå…¨ä¸€è‡´ã€‚</li><li>nullptr_t ç±»å‹æ•°æ®å¯ä»¥éšå¼è½¬æ¢æˆä»»æ„ä¸€ä¸ªæŒ‡é’ˆç±»å‹ã€‚</li><li>nullptr_t ç±»å‹æ•°æ®ä¸èƒ½è½¬æ¢æˆéæŒ‡é’ˆç±»å‹ã€‚</li><li>nullptr_t ç±»å‹æ•°æ®ä¸é€‚ç”¨äºç®—æœ¯è¿ç®—è¡¨è¾¾å¼ã€‚</li><li>nullptr_t ç±»å‹æ•°æ®å¯ä»¥ç”¨äºå…³ç³»è¿ç®—è¡¨è¾¾å¼ï¼Œä½†æ˜¯åªèƒ½å’Œ nullptr_t ç±»å‹æˆ–è€…æŒ‡é’ˆç±»å‹è¿›è¡Œæ¯”è¾ƒã€‚</li></ul><p>nullptr_t ç±»å‹è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œå®ƒçš„å®šä¹‰æ˜¯ä» nullptr åæ¨è€Œæ¥ï¼Œä»è¿™ç‚¹åˆèƒ½çœ‹å‡º C++11 ç”¨æ³•çš„çµæ´»æ€§ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">decltype</span><span class="params">(<span class="literal">nullptr</span>)</span> <span class="type">nullptr_t</span></span>;</span><br></pre></td></tr></tbody></table></figure><h1 id="é»˜è®¤å‡½æ•°çš„æ§åˆ¶">é»˜è®¤å‡½æ•°çš„æ§åˆ¶</h1><p>åœ¨ C++ä¸­å£°æ˜è‡ªå®šä¹‰çš„ç±»ä¹‹åï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤ç”Ÿæˆä¸€äº›æˆå‘˜å‡½æ•°ï¼Œè¿™äº›å‡½æ•°è¢«ç§°ä¸ºé»˜è®¤å‡½æ•°ã€‚åŒ…æ‹¬æ„é€ å‡½æ•°ã€æ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°ã€ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨æ‹·è´å‡½æ•°ã€ææ„å‡½æ•°ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è¿˜ä¼šé»˜è®¤ç”Ÿæˆä¸€äº›æ“ä½œç¬¦å‡½æ•°ï¼ŒåŒ…æ‹¬ operator ,ã€operator &amp;ã€operator &amp;&amp;ã€operator ã€operator -&gt;ã€operator -&gt;ã€operator newã€operator deleteã€‚</p><h2 id="æ˜¾å¼ç¼ºçœå‡½æ•°-default">æ˜¾å¼ç¼ºçœå‡½æ•° (= default)</h2><p>ä½†æ˜¯å¦‚æœå®ç°äº†è¿™äº›å‡½æ•°çš„è‡ªå®šä¹‰ç‰ˆæœ¬åï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šå»ç”Ÿæˆé»˜è®¤çš„ç‰ˆæœ¬ã€‚æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å£°æ˜å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œæ­¤æ—¶å°±ä¸ä¼šç”Ÿæˆé»˜è®¤çš„æ„é€ å‡½æ•°ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç±»ä¸å†æ˜¯ POD ç±»å‹ï¼Œä»è€Œå½±å“ç±»çš„ä¼˜åŒ–ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">int</span> i) : <span class="built_in">data</span>(i) {}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; std::is_pod &lt;Example&gt;::value &lt;&lt; std::endl;  <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>C++11 ä¸­æä¾›äº†æ–°çš„æœºåˆ¶æ¥æ§åˆ¶é»˜è®¤å‡½æ•°ç”Ÿæˆæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å£°æ˜æ—¶åœ¨å‡½æ•°æœ«å°¾åŠ ä¸Šâ€= defaultâ€æ¥æ˜¾å¼åœ°æŒ‡ç¤ºç¼–è¯‘å™¨å»ç”Ÿæˆè¯¥å‡½æ•°çš„é»˜è®¤ç‰ˆæœ¬ï¼Œè¿™æ ·å°±ä¿è¯äº†ç±»è¿˜æ˜¯ POD ç±»å‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">int</span> i) : <span class="built_in">data</span>(i) {}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; std::is_pod &lt;Example&gt;::value &lt;&lt; std::endl;  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="æ˜¾å¼åˆ é™¤å‡½æ•°-delete">æ˜¾å¼åˆ é™¤å‡½æ•° (= delete)</h2><p>å¦ä¸€æ–¹é¢ï¼Œæœ‰æ—¶å€™å¯èƒ½éœ€è¦é™åˆ¶ä¸€äº›é»˜è®¤å‡½æ•°çš„ç”Ÿæˆï¼Œä¾‹å¦‚éœ€è¦ç¦æ­¢æ‹·è´æ„é€ å‡½æ•°çš„ä½¿ç”¨ã€‚åŸæ¥ï¼Œé€šè¿‡æŠŠæ‹·è´æ„é€ å‡½æ•°å£°æ˜ä¸º private æˆå‘˜ï¼Œè¿™æ ·ä¸€æ—¦ä½¿ç”¨ç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚è€Œåœ¨ C++11 ä¸­ï¼Œåœ¨å‡½æ•°çš„å®šä¹‰æˆ–è€…å£°æ˜åé¢åŠ ä¸Šâ€= deleteâ€å°±èƒ½å®ç°è¿™ä¸ªæ•ˆæœï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">const</span> Example&amp; ex) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Example ex;</span><br><span class="line">    <span class="function">Example <span class="title">ex1</span><span class="params">(ex)</span></span>;   <span class="comment">// ç¼–è¯‘å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="å…¶ä»–ç”¨æ³•">å…¶ä»–ç”¨æ³•</h2><p>= default å’Œ= delete èƒ½å¤Ÿæ›´åŠ ç²¾å‡†çš„æ§åˆ¶ç±»çš„é»˜è®¤å‡½æ•°ç‰ˆæœ¬ã€‚å…¶ä¸­ï¼Œ= default åŒæ ·ä¹Ÿèƒ½åœ¨ç±»å¤–çš„å®šä¹‰ä¸­ä¿®é¥°æˆå‘˜å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">const</span> Example&amp;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">Example::<span class="built_in">Example</span>(<span class="type">const</span> Example&amp; ex) = <span class="keyword">default</span>;</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œèƒ½å¤Ÿä¸ºä¸€ä¸ªç±»å®ç°å¤šä¸ªç‰ˆæœ¬ï¼Œåªè¦æˆ‘ä»¬åœ¨å¤´æ–‡ä»¶é‡Œå£°æ˜åŒæ ·çš„å‡½æ•°ï¼Œè€Œåœ¨ä¸åŒçš„ cpp æ–‡ä»¶ä¸­ç”¨ä¸åŒçš„æ–¹æ³•å®ç°ï¼Œå½“é€‰æ‹©ä¸åŒçš„ cpp ç¼–è¯‘æ—¶äº§ç”Ÿçš„ç‰ˆæœ¬å°±ä¸åŒã€‚</p><p>å…³äº= deleteï¼Œå®ƒä¸ä»…å±€é™äºé™åˆ¶ç”Ÿæˆé»˜è®¤å‡½æ•°ï¼Œè¿˜èƒ½é¿å…ç¼–è¯‘å™¨åšä¸€äº›ä¸å¿…è¦çš„éšå¼æ•°æ®è½¬æ¢ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">int</span> i) {}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">Example <span class="title">ex</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="function">Example <span class="title">ex1</span><span class="params">(<span class="string">'a'</span>)</span></span>;     <span class="comment">// ç¼–è¯‘æˆåŠŸï¼Œchar ä¼šéšå¼è£…æ¢æˆ int å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æœ‰æ—¶å€™æˆ‘ä»¬ä¸æƒ³è¦è¿™ç§éšå¼è½¬æ¢ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">int</span> i) {}</span><br><span class="line">    <span class="built_in">Example</span>(<span class="type">char</span> c) = <span class="keyword">delete</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">Example <span class="title">ex</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="function">Example <span class="title">ex1</span><span class="params">(<span class="string">'a'</span>)</span></span>;  <span class="comment">// ç¼–è¯‘å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿèƒ½ç”¨äºæ™®é€šå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> i)</span> </span>{}</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">char</span> c)</span> </span>= <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">func</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">func</span>(<span class="string">'a'</span>);   <span class="comment">// ç¼–è¯‘å¤±è´¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šç”¨æ³•ï¼Œä¾‹å¦‚æ˜¾ç¤ºåˆ é™¤ new æ“ä½œç¬¦æ¥é¿å…åœ¨å †ä¸Šåˆ†é…å¯¹è±¡ã€æ˜¾ç¤ºåˆ é™¤ææ„å‡½æ•°ç”¨äºæ„å»ºå•ä¾‹æ¨¡å¼ç­‰ç­‰ã€‚</p><h1 id="lambda">Lambda</h1><h2 id="ä»€ä¹ˆæ˜¯-lambda-è¡¨è¾¾å¼">ä»€ä¹ˆæ˜¯ Lambda è¡¨è¾¾å¼ï¼Ÿ</h2><p>Lambda è¡¨è¾¾å¼æ˜¯ C++11 æå‡ºçš„æ–°ç‰¹æ€§ï¼Œä¸»è¦ç”¨æ¥å®ç°ä»£ç ä¸­<strong>å‡½æ•°çš„å†…åµŒ</strong>ï¼Œç®€åŒ–äº†ç¼–ç¨‹ï¼Œæé«˜äº†æ•ˆç‡ã€‚</p><p>å®ƒçš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fun = [æ•è·å‚æ•°](å‡½æ•°å‚æ•°){å‡½æ•°ä½“};</span><br></pre></td></tr></tbody></table></figure><p>ä¾‹å¦‚è¿™ä¸ª Hello Lambdaï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> fun = [](){ std::cout &lt;&lt; <span class="string">"Hello Lambda"</span> &lt;&lt; std::endl; };</span><br></pre></td></tr></tbody></table></figure><p>Lambda`æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å†…è”å‡½æ•°</strong>ï¼Œåªæ˜¯å®šä¹‰å’Œä½¿ç”¨çš„æ–¹å¼ä¸æ™®é€šçš„å‡½æ•°æœ‰äº›ä¸åŒï¼Œä¸‹é¢æ¥å…·ä½“ä»‹ç»ä¸‹å®ƒçš„åŸºæœ¬è¯­æ³•ã€‚</p><h2 id="åŸºæœ¬è¯­æ³•">åŸºæœ¬è¯­æ³•</h2><h3 id="æœ€ç®€å•çš„-lambda">æœ€ç®€å•çš„ Lambda</h3><p>åé¢ä¸åŠ  () çš„ Lambda è¡¨è¾¾å¼ç›¸å½“äº<strong>å‡½æ•°æŒ‡é’ˆ</strong>ï¼ŒåŠ ä¸Š ()`å°±ç›¸å½“äºè°ƒç”¨è¿™ä¸ª Lambda å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line"></span><br><span class="line">  [](){ cout &lt;&lt; <span class="string">"Hello World!"</span> &lt;&lt; endl; };</span><br><span class="line"></span><br><span class="line">  [](){ cout &lt;&lt; <span class="string">"Hello World!"</span> &lt;&lt; endl; }();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="lambda-å¯ä»¥èµ‹å€¼">Lambda å¯ä»¥èµ‹å€¼</h3><p>å¯ä»¥å°† Lambda è¡¨è¾¾å¼èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œä¹‹åè¿™ä¸ªå˜é‡å¯ä»¥å½“ä½œå‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨ï¼Œéœ€è¦åŠ ä¸Š ()ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line">  <span class="keyword">auto</span> fun = [](){ cout &lt;&lt; <span class="string">"Hello World!"</span> &lt;&lt; endl; };</span><br><span class="line">  <span class="built_in">fun</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="ä¸º-lambda-ä¼ é€’å‚æ•°">ä¸º Lambda ä¼ é€’å‚æ•°</h3><p>å¯ä»¥ä¸º Lambda æŒ‡å®šå‡½æ•°å‚æ•°ï¼Œè¯¥å‚æ•°ä¹Ÿå…·æœ‰å‰¯æœ¬æœºåˆ¶ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line">  <span class="type">int</span> num = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun = [](<span class="type">int</span> num){ num = <span class="number">5</span>; cout &lt;&lt; num &lt;&lt; endl; };</span><br><span class="line">  <span class="built_in">fun</span>(num);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; num &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="è·å–-lambda-çš„è¿”å›å€¼">è·å– Lambda çš„è¿”å›å€¼</h3><p>Lambda çš„è¿”å›å€¼ç±»å‹å¯ä»¥è¿›è¡Œç±»å‹è½¬æ¢æˆ–è€…ä½¿ç”¨ decltype è‡ªåŠ¨æ¨å¯¼ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> num1 = [](<span class="type">int</span> a, <span class="type">int</span> b){ <span class="keyword">return</span> a + b; }(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> num2 = [](<span class="type">double</span> a, <span class="type">double</span> b)-&gt;<span class="type">int</span>{ <span class="keyword">return</span> a + b; }(<span class="number">1.2</span>, <span class="number">2.1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> num3 = [](<span class="type">double</span> a, <span class="type">double</span> b)-&gt;<span class="keyword">decltype</span>(a + b){ <span class="keyword">return</span> a + b; }(<span class="number">1.2</span>, <span class="number">2.1</span>);</span><br><span class="line">  cout &lt;&lt; num1 &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; num2 &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; num3 &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="çš„ä½¿ç”¨æ–¹æ³•">[ ] çš„ä½¿ç”¨æ–¹æ³•</h3><p>Lambda è¡¨è¾¾å¼çš„ [] ç”¨æ¥ç¡®å®šæ•è·å‚æ•°ï¼š</p><ol type="1"><li>[=]ï¼šæ•è·çš„å±€éƒ¨å˜é‡åªå¯è¯»ä¸å¯å†™ï¼Œæ•è·èŒƒå›´æ˜¯å½“å‰ Lambda è¡¨è¾¾å¼ä¹‹å‰çš„ä½œç”¨åŸŸã€‚</li><li>[&amp;]ï¼šæ•è·çš„å±€éƒ¨å˜é‡å¯è¯»å¯å†™ã€‚</li></ol><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line">  <span class="type">int</span> num = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun1 = [=](){ cout &lt;&lt; num &lt;&lt; endl; };</span><br><span class="line">  <span class="built_in">fun1</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun2 = [&amp;num](){ num = <span class="number">200</span>; cout &lt;&lt; num &lt;&lt; endl; };</span><br><span class="line">  <span class="built_in">fun2</span>();</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; num &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="lambda-æ˜¯-const-å‡½æ•°">Lambda æ˜¯ const å‡½æ•°</h3><p>Lambda é»˜è®¤æ˜¯ const å‡½æ•°ï¼Œä¸èƒ½ä¿®æ”¹å¼•ç”¨çš„å˜é‡ï¼Œä½¿ç”¨ mutable å¯ä»¥å–æ¶ˆè¯¥å±æ€§ï¼Œä½†æ˜¯ mutable ä¿®æ”¹çš„åªæ˜¯å‰¯æœ¬ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line">  <span class="type">int</span> num = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun = [=]() <span class="keyword">mutable</span> { num = <span class="number">200</span>; cout &lt;&lt; num &lt;&lt; endl; };</span><br><span class="line">  <span class="built_in">fun</span>();</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; num &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="lambda-æ²¡æœ‰åœ°å€">Lambda æ²¡æœ‰åœ°å€</h3><p>Lambda è¡¨è¾¾å¼æ˜¯å†…è”å±•å¼€çš„ï¼Œæ²¡æœ‰å®é™…çš„åœ°å€ï¼Œè¿™æ˜¯ä¸æ™®é€šå‡½æ•°çš„ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  string str;</span><br><span class="line">  <span class="keyword">auto</span> fun = [](string str){cout &lt;&lt; str &lt;&lt; endl; };</span><br><span class="line">  cin &gt;&gt; str;</span><br><span class="line">  <span class="built_in">fun</span>(str);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="lambda-åœ¨-class-ä¸­çš„ä½¿ç”¨">Lambda åœ¨ class ä¸­çš„ä½¿ç”¨</h3><p>Lambda åœ¨ C++ class ä¸­çš„ä½¿ç”¨éœ€è¦çŸ¥é“å¦‚ä½•æ•è· thisã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyClass::function</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun1 = [<span class="keyword">this</span>](<span class="type">int</span> v){cout &lt;&lt; v + <span class="keyword">this</span>-&gt;num &lt;&lt; endl; };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fun2 = [&amp;](<span class="type">int</span> v){cout &lt;&lt; v + <span class="keyword">this</span>-&gt;num &lt;&lt; endl; };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="lambda-ä¸ä»¿å‡½æ•°">Lambda ä¸ä»¿å‡½æ•°</h2><p>Lambda ä¸ä»¿å‡½æ•°æœ‰äº›ç±»ä¼¼ï¼Œä»¿å‡½æ•°æ˜¯ç¼–è¯‘å™¨å®ç° Lambda çš„ä¸€ç§æ–¹å¼ï¼Œç¼–è¯‘å™¨ä¼šå°† Lambda è½¬æ¢ä¸ºä¸€ä¸ªä»¿å‡½æ•°å¯¹è±¡ï¼ŒLambda å¯ä»¥è§†ä¸ºä»¿å‡½æ•°çš„ç­‰ä»·å½¢å¼ï¼Œç¼–è¯‘å™¨åœ¨å‘ç° Lambda å‡½æ•°å‡ºç°è¯­æ³•é”™è¯¯çš„æ—¶å€™ï¼Œä¼šæŠ¥å‡ºä¸€äº›ä¸æ„é€ å‡½æ•°ç›¸å…³çš„ä¿¡æ¯ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä»¿å‡½æ•°ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestLambda</span> {</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">TestLambda</span>(<span class="type">float</span> f) : <span class="built_in">x</span>(f) {}</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">float</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">float</span> price)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> price * (<span class="number">1</span> - x / <span class="number">100</span>);</span><br><span class="line">  }</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">float</span> x;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨ä»¿å‡½æ•°å’Œ Lambda æ˜¯å¾ˆç±»ä¼¼çš„ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="type">float</span> f = <span class="number">5.5f</span>;</span><br><span class="line">  <span class="function">TestLambda <span class="title">t</span><span class="params">(f)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> fun = [f](<span class="type">float</span> price)-&gt;<span class="type">float</span>{ <span class="keyword">return</span> price * (<span class="number">1</span> - f / <span class="number">100</span>);};</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> p1 = <span class="built_in">t</span>(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> p2 = <span class="built_in">fun</span>(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; p1 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; p2 &lt;&lt; endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Lambda æ˜¯ C++11 æå‡ºçš„æ–°ç‰¹æ€§ï¼Œç®€åŒ–äº†æˆ‘ä»¬çš„ä»£ç ï¼Œæé«˜äº†ç¼–ç¨‹çš„æ•ˆç‡ï¼Œåº”è¯¥äº†è§£å¹¶å­¦ä¼šä½¿ç”¨å®ƒã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1dpemFyZHRvSC9hcnRpY2xlL2RldGFpbHMvODExNjQ3NDA=">https://blog.csdn.net/WizardtoH/article/details/81164740<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1dpemFyZHRvSC9hcnRpY2xlL2RldGFpbHMvODExNjk1NzA=">https://blog.csdn.net/WizardtoH/article/details/81169570<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9hMjAwYTJkYWI5NjA=">https://www.jianshu.com/p/a200a2dab960<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆäº”ï¼‰constexprã€åŸå­ä¸çº¿ç¨‹å­˜å‚¨</title>
      <link href="/2022/Program/CPP11Part5/"/>
      <url>/2022/Program/CPP11Part5/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP11ImprovePerformanceAndAbility.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyZmQ4YTU2NTNiYjA3NGIyMzI4NTk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å¸¸é‡è¡¨è¾¾å¼constexpr">å¸¸é‡è¡¨è¾¾å¼ï¼ˆconstexprï¼‰</h1><p>å¸¸é‡è¡¨è¾¾å¼æœºåˆ¶æ˜¯ä¸ºäº†ï¼š</p><ul><li>æä¾›ä¸€ç§æ›´åŠ é€šç”¨çš„å¸¸é‡è¡¨è¾¾å¼ã€‚</li><li>å…è®¸ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»å‹æˆä¸ºå¸¸é‡è¡¨è¾¾å¼ã€‚</li><li>æä¾›äº†ä¸€ç§ä¿è¯åœ¨ç¼–è¯‘æœŸå®Œæˆåˆå§‹åŒ–çš„æ–¹æ³•ï¼ˆå¯ä»¥åœ¨ç¼–è¯‘æ—¶æœŸæ‰§è¡ŒæŸäº›å‡½æ•°è°ƒç”¨ï¼‰ã€‚</li></ul><p>è€ƒè™‘ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Flags</span> { good=<span class="number">0</span>, fail=<span class="number">1</span>, bad=<span class="number">2</span>, eof=<span class="number">4</span> };</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="keyword">operator</span>|(Flags f1, Flags f2)</span><br><span class="line">{ <span class="keyword">return</span> <span class="built_in">Flags</span>(<span class="built_in">int</span>(f1)|<span class="built_in">int</span>(f2)); }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(Flags x)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">switch</span> (x) {</span><br><span class="line">    <span class="keyword">case</span> bad:         <span class="comment">/* â€¦ */</span> <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> eof:         <span class="comment">/* â€¦ */</span> <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> bad|eof:     <span class="comment">/* â€¦ */</span> <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:          <span class="comment">/* â€¦ */</span> <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è™½ç„¶â€œbad|eofâ€æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä½†æ˜¯å› ä¸ºè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å¸¸é‡ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸï¼Œå°±å¯ä»¥è®¡ç®—å‡ºå®ƒçš„ç»“æœï¼Œå› è€Œå¯ä»¥ä½œä¸ºå¸¸é‡å¯¹å¾…ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶æœŸè¢«åŠ¨åœ°è®¡ç®—è¡¨è¾¾å¼çš„å€¼ã€‚</p><p>constexpr å¹¶ä¸æ˜¯ const çš„é€šç”¨ç‰ˆï¼Œåä¹‹äº¦ç„¶ï¼š</p><ul><li>const ä¸»è¦ç”¨äºè¡¨è¾¾â€œå¯¹æ¥å£çš„å†™æƒé™æ§åˆ¶â€ï¼Œå³â€œå¯¹äºè¢« const ä¿®é¥°çš„é‡åï¼ˆä¾‹å¦‚ const æŒ‡é’ˆå˜é‡ï¼‰ï¼Œä¸å¾—é€šè¿‡å®ƒå¯¹æ‰€æŒ‡å¯¹è±¡ä½œä»»ä½•ä¿®æ”¹â€ã€‚ï¼ˆä½†æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–æ¥å£ä¿®æ”¹è¯¥å¯¹è±¡ï¼‰ã€‚</li><li>constexpr çš„ä¸»è¦åŠŸèƒ½åˆ™æ˜¯è®©æ›´å¤šçš„è¿ç®—å¯ä»¥åœ¨ç¼–è¯‘æœŸå®Œæˆï¼Œå¹¶èƒ½ä¿è¯è¡¨è¾¾å¼åœ¨è¯­ä¹‰ä¸Šæ˜¯ç±»å‹å®‰å…¨çš„ã€‚ï¼ˆè¯‘æ³¨ï¼šç›¸æ¯”ä¹‹ä¸‹ï¼ŒC è¯­è¨€ä¸­#define åªèƒ½æä¾›ç®€å•çš„æ–‡æœ¬æ›¿æ¢ï¼Œè€Œä¸å…·ä»»ä½•ç±»å‹æ£€æŸ¥èƒ½åŠ›ï¼‰ã€‚</li></ul><h2 id="constexpr-ä¿®é¥°æ™®é€šå˜é‡">constexpr ä¿®é¥°æ™®é€šå˜é‡</h2><p>ä½¿ç”¨ constexpr ä¿®æ”¹æ™®é€šå˜é‡æ—¶ï¼Œå˜é‡å¿…é¡»ç»è¿‡åˆå§‹åŒ–ä¸”åˆå§‹å€¼å¿…é¡»æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ã€‚</p><h2 id="constexpr-ä¿®é¥°å‡½æ•°">constexpr ä¿®é¥°å‡½æ•°</h2><p>constexpr è¿˜å¯ä»¥ç”¨äºä¿®é¥°å‡½æ•°çš„è¿”å›å€¼ï¼Œè¿™æ ·çš„å‡½æ•°åˆç§°ä¸ºâ€œå¸¸é‡è¡¨è¾¾å¼å‡½æ•°â€ã€‚</p><p>æ³¨æ„ï¼Œconstexpr å¹¶éå¯ä»¥ä¿®æ”¹ä»»æ„å‡½æ•°çš„è¿”å›å€¼ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªå‡½æ•°è¦æƒ³æˆä¸ºå¸¸é‡è¡¨è¾¾å¼å‡½æ•°ï¼Œå¿…é¡»æ»¡è¶³å¦‚ä¸‹ 4 ä¸ªæ¡ä»¶ï¼š</p><ul><li>æ•´ä¸ªå‡½æ•°çš„å‡½æ•°ä½“ä¸­ï¼Œé™¤äº†å¯ä»¥åŒ…å« using æŒ‡ä»¤ã€typedef è¯­å¥ä»¥åŠ static_assert æ–­è¨€å¤–ï¼Œåªèƒ½åŒ…å«ä¸€æ¡ return è¿”å›è¯­å¥ã€‚</li><li>è¯¥å‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼ï¼Œå³å‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¸èƒ½æ˜¯ voidã€‚</li><li>å‡½æ•°åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œå¿…é¡»æœ‰å¯¹åº”çš„å®šä¹‰è¯­å¥ã€‚</li><li>return è¿”å›çš„è¡¨è¾¾å¼å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼ã€‚</li></ul><p>å¸¸é‡è¡¨è¾¾å¼å‡½æ•°çš„è¿”å›å€¼å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼çš„åŸå› å¾ˆç®€å•ï¼Œå¦‚æœæƒ³åœ¨ç¨‹åºç¼–è¯‘é˜¶æ®µè·å¾—æŸä¸ªå‡½æ•°è¿”å›çš„å¸¸é‡ï¼Œåˆ™è¯¥å‡½æ•°çš„ return è¯­å¥ä¸­å°±ä¸èƒ½åŒ…å«ç¨‹åºè¿è¡Œé˜¶æ®µæ‰èƒ½ç¡®å®šå€¼çš„å˜é‡ã€‚</p><h2 id="constexpr-ä¿®é¥°ç±»çš„æ„é€ å‡½æ•°">constexpr ä¿®é¥°ç±»çš„æ„é€ å‡½æ•°</h2><p>å¯¹äº C++ å†…ç½®ç±»å‹çš„æ•°æ®ï¼Œå¯ä»¥ç›´æ¥ç”¨ constexpr ä¿®é¥°ï¼Œä½†å¦‚æœæ˜¯è‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼ˆç”¨ struct æˆ–è€… class å®ç°ï¼‰ï¼Œç›´æ¥ç”¨ constexpr ä¿®é¥°æ˜¯ä¸è¡Œçš„ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ­¤ç¨‹åºæ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ï¼Œç¼–è¯‘å™¨ä¼šæŠ›å‡ºâ€œconstexpr ä¸èƒ½ä¿®é¥°è‡ªå®šä¹‰ç±»å‹â€çš„å¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰ç±»å‹çš„å®šä¹‰</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">struct</span> <span class="title class_">myType</span> {</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="comment">//å…¶å®ƒç»“æ„ä½“æˆå‘˜</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">struct</span> <span class="title class_">myType</span> mt { <span class="string">"zhangsan"</span>, <span class="number">10</span> };</span><br><span class="line">    cout &lt;&lt; mt.name &lt;&lt; <span class="string">" "</span> &lt;&lt; mt.age &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“æˆ‘ä»¬æƒ³è‡ªå®šä¹‰ä¸€ä¸ªå¯äº§ç”Ÿå¸¸é‡çš„ç±»å‹æ—¶ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯åœ¨è¯¥ç±»å‹çš„å†…éƒ¨æ·»åŠ ä¸€ä¸ªå¸¸é‡æ„é€ å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä¿®æ”¹ä¸Šé¢çš„é”™è¯¯ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰ç±»å‹çš„å®šä¹‰</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">myType</span> {</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">myType</span><span class="params">(<span class="type">char</span> *name,<span class="type">int</span> age)</span>:name(name),age(age){</span>};</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="comment">//å…¶å®ƒç»“æ„ä½“æˆå‘˜</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">struct</span> <span class="title class_">myType</span> mt { <span class="string">"zhangsan"</span>, <span class="number">10</span> };</span><br><span class="line">    cout &lt;&lt; mt.name &lt;&lt; <span class="string">" "</span> &lt;&lt; mt.age &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ myType ç»“æ„ä½“ä¸­è‡ªå®šä¹‰æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå€ŸåŠ©æ­¤å‡½æ•°ï¼Œç”¨ constexpr ä¿®é¥°çš„ myType ç±»å‹çš„ my å¸¸é‡å³å¯é€šè¿‡ç¼–è¯‘ã€‚</p><h2 id="constexpr-ä¿®é¥°æ¨¡æ¿å‡½æ•°">constexpr ä¿®é¥°æ¨¡æ¿å‡½æ•°</h2><p>C++11 è¯­æ³•ä¸­ï¼Œconstexpr å¯ä»¥ä¿®é¥°æ¨¡æ¿å‡½æ•°ï¼Œä½†ç”±äºæ¨¡æ¿ä¸­ç±»å‹çš„ä¸ç¡®å®šæ€§ï¼Œå› æ­¤æ¨¡æ¿å‡½æ•°å®ä¾‹åŒ–åçš„å‡½æ•°æ˜¯å¦ç¬¦åˆå¸¸é‡è¡¨è¾¾å¼å‡½æ•°çš„è¦æ±‚ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µä¸‹ï¼ŒC++11 æ ‡å‡†è§„å®šï¼Œå¦‚æœ constexpr ä¿®é¥°çš„æ¨¡æ¿å‡½æ•°å®ä¾‹åŒ–ç»“æœä¸æ»¡è¶³å¸¸é‡è¡¨è¾¾å¼å‡½æ•°çš„è¦æ±‚ï¼Œåˆ™ constexpr ä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼Œå³è¯¥å‡½æ•°å°±ç­‰åŒäºä¸€ä¸ªæ™®é€šå‡½æ•°ã€‚</p><h1 id="å˜é•¿æ¨¡æ¿">å˜é•¿æ¨¡æ¿</h1><h2 id="å˜é•¿å‡½æ•°å’Œå˜é•¿çš„æ¨¡æ¿å‚æ•°">å˜é•¿å‡½æ•°å’Œå˜é•¿çš„æ¨¡æ¿å‚æ•°</h2><p>printf åˆ™ä½¿ç”¨äº† C è¯­è¨€çš„å‡½æ•°å˜é•¿å‚æ•°ç‰¹æ€§ï¼Œé€šè¿‡ä½¿ç”¨å˜é•¿å‡½æ•°ï¼ˆ variadic funcitonï¼‰ï¼Œ printf çš„å®ç°èƒ½å¤Ÿæ¥å—ä»»ä½•é•¿åº¦çš„å‚æ•°åˆ—è¡¨ã€‚ä¸è¿‡æ— è®ºæ˜¯å®ï¼Œè¿˜æ˜¯å˜é•¿å‚æ•°ï¼Œæ•´ä¸ªæœºåˆ¶çš„è®¾è®¡ä¸Šï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªå¯¹äºä¼ é€’å‚æ•°çš„ç±»å‹æ˜¯äº†è§£çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å˜é•¿å‡½æ•°çš„ä¾‹å­ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå˜é•¿å‡½æ•°å¯ä»¥å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Sumoffloat</span><span class="params">(<span class="type">int</span> count,...)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="type">double</span> sum =<span class="number">0</span></span><br><span class="line">    <span class="built_in">va_start</span>(ap, count);            <span class="comment">//è·å¾—å˜é•¿åˆ—è¡¨çš„å¥æŸ„ ap</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>: i &lt; count: i++)</span><br><span class="line">        sum += <span class="built_in">va_arg</span>(apï¼Œ <span class="type">double</span>);   <span class="comment">//ä¸€æ¬¡è·å¾—ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="built_in">va_end</span>(ap);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"f% \n"</span>, <span class="built_in">Sumoffloat</span>(<span class="number">3</span>, <span class="number">1.2f</span>, <span class="number">3.4</span>, <span class="number">5.6</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªåä¸º Sumoffloat å˜é•¿å‡½æ•°ã€‚å˜é•¿å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° count è¡¨ç¤ºçš„æ˜¯å˜é•¿å‚æ•°çš„ä¸ªæ•°ï¼Œè¿™å¿…é¡»ç”± Sumoffloat çš„è°ƒç”¨è€…ä¼ é€’è¿›æ¥ã€‚è€Œåœ¨è¢«è°ƒç”¨è€…ä¸­ï¼Œåˆ™éœ€è¦é€šè¿‡ä¸€ä¸ªç±»å‹ä¸º va_list çš„æ•°æ®ç»“æ„ ap æ¥è¾…åŠ©åœ°è·å¾—å‚æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä»£ç é¦–å…ˆä½¿ç”¨ va_star å‡½æ•°å¯¹ ap è¿›è¡Œåˆå§‹åŒ–ï¼Œä½¿å¾— ap æˆä¸ºè¢«ä¼ é€’çš„å˜é•¿å‚æ•°çš„ä¸€ä¸ªâ€œå¥æŸ„â€ï¼ˆ handlerï¼‰ã€‚è€Œåä»£ç å†ä½¿ç”¨ va_arg å‡½æ•°ä» ap ä¸­å°†å‚æ•°ä¸€å–å‡ºç”¨äºè¿ç®—ã€‚ç”±äºè¿™é‡Œæ˜¯è®¡ç®—æµ®ç‚¹æ•°çš„å’Œï¼Œæ‰€ä»¥æ¯æ¬¡æ€»æ˜¯ç»™ va_arg ä¼ é€’ä¸€ä¸ª double ç±»å‹ä½œä¸ºå‚æ•°ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†ä¸€ç§å˜é•¿å‡½æ•°çš„å¯èƒ½çš„å®ç°æ–¹å¼ï¼Œå³ä»¥å¥æŸ„ ap ä¸ºæŒ‡å‘å„ä¸ªå˜é•¿å‚æ•°çš„æŒ‡é’ˆï¼Œè€Œ va_arg åˆ™é€šè¿‡æ”¹å˜æŒ‡é’ˆçš„æ–¹å¼ï¼ˆæ¯æ¬¡å¢åŠ  sizeofï¼ˆ doubleï¼‰å­—èŠ‚ï¼‰æ¥è¿”å›ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/performace1.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œåªæœ‰ä½¿ç”¨è¡¨è¾¾å¼ va_argï¼ˆapï¼Œdoubleï¼‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰æŒ‰ç…§ç±»å‹ï¼ˆå®é™…æ˜¯æŒ‰ç±»å‹é•¿åº¦ï¼‰å»å˜é•¿å‚æ•°åˆ—è¡¨ä¸­è·å¾—æŒ‡å®šå‚æ•°ã€‚è€Œå¦‚ä½•æ‰“å°åˆ™å¾—ç›Šäºä¼ é€’åœ¨å­—ç¬¦ä¸²ä¸­çš„å½¢å¦‚â€œs% d%â€è¿™æ ·çš„è½¬ä¹‰å­—ï¼Œä»¥åŠä¼ é€’çš„ count å‚æ•°ã€‚äº‹å®ä¸Šï¼Œå‡½æ•°â€œæœ¬èº«â€å®Œå…¨æ— æ³•çŸ¥é“å‚æ•°æ•°é‡æˆ–è€…å‚æ•°ç±»å‹ã€‚å› æ­¤ï¼Œå¯¹äºä¸€äº›æ²¡æœ‰å®šä¹‰è½¬ä¹‰å­—çš„é POD çš„æ•°æ®æ¥è¯´ï¼Œä½¿ç”¨å˜é•¿å‡½æ•°å°±ä¼šå¯¼è‡´æœªå®šä¹‰çš„ç¨‹åºè¡Œä¸ºã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *msg = <span class="string">"hello %s"</span>;</span><br><span class="line"><span class="built_in">printf</span>(msg, std::<span class="built_in">string</span>(<span class="string">"world"</span>));</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·çš„ä»£ç å°±ä¼šå¯¼è‡´ printf å‡ºé”™ã€‚ ä»å¦ä¸€ä¸ªè§’åº¦è®²ï¼Œå˜é•¿å‡½æ•°è¿™ç§å®ç°æ–¹å¼ï¼Œå¯¹äº C++è¿™ç§å¼ºè°ƒç±»å‹çš„è¯­è¨€æ¥è¯´ç›¸å½“äºå¼€äº†ä¸€ä¸ªâ€œä¸è§„èŒƒâ€çš„åé—¨ã€‚è¿™æ˜¯ C++æ ‡å‡†ä¸­æ‰€ä¸æ„¿æ„çœ‹åˆ°çš„ï¼ˆå³ä½¿å®ƒèƒ½å¤Ÿå·¥ä½œï¼‰ã€‚å› æ­¤ï¼Œå®¢è§‚ä¸Šï¼ŒC++éœ€è¦å¼•å…¥ä¸€ç§æ›´ä¸ºâ€œç°ä»£åŒ–â€çš„å˜é•¿å‚æ•°çš„å®ç°æ–¹å¼ï¼Œå³ç±»å‹å’Œå˜é‡åŒæ—¶èƒ½å¤Ÿä¼ é€’ç»™å˜é•¿å‚æ•°çš„å‡½æ•°ã€‚ä¸€ä¸ªå¥½çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ C++çš„å‡½æ•°æ¨¡æ¿</p><p>æ­¤å¤–åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç±»ä¹Ÿéœ€è¦ä¸å®šé•¿åº¦çš„æ¨¡æ¿å‚æ•°ã€‚æœ€ä¸ºå…¸å‹çš„å°±æ˜¯ C++11 æ ‡å‡†åº“ä¸­çš„ tuple ç±»æ¨¡æ¿ã€‚å¦‚æœè¯»è€…ç†Ÿæ‚‰ C++98 ä¸­çš„ pair ç±»æ¨¡æ¿çš„è¯ï¼Œé‚£ä¹ˆç†è§£ tuple ä¹Ÿå°±ä¸å›°éš¾äº†ã€‚å…·ä½“æ¥è®²ï¼Œpair æ˜¯ä¸¤ä¸ªä¸åŒç±»å‹çš„æ•°æ®çš„é›†åˆã€‚æ¯”å¦‚ pair&lt;intï¼Œdouble&gt;å°±èƒ½å¤Ÿå®¹çº³ int ç±»å‹å’Œ double ç±»å‹çš„ä¸¤ç§æ•°æ®ã€‚ä¸€äº›å¦‚ std::map çš„æ ‡å‡†åº“å®¹å™¨ï¼Œå…¶æˆå‘˜å°±éœ€è¦æ˜¯ç±»æ¨¡æ¿ pair çš„ã€‚åœ¨ C++11 ä¸­ï¼Œ tuple æ˜¯ pair ç±»çš„ä¸€ç§æ›´ä¸ºæ³›åŒ–çš„è¡¨ç°å½¢å¼ã€‚æ¯”èµ· pairï¼Œ tuple æ˜¯å¯ä»¥æ¥å—ä»»æ„å¤šä¸ªä¸åŒç±»å‹çš„å…ƒç´ çš„é›†åˆã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::tuple&lt;<span class="type">double</span>, <span class="type">char</span>, std::string&gt; collections;</span><br></pre></td></tr></tbody></table></figure><p>æ¥å£°æ˜ä¸€ä¸ª tuple æ¨¡æ¿ç±»ã€‚è¯¥ collections å˜é‡å¯ä»¥å®¹çº³ doubleã€charã€std::string ä¸‰ç§ç±»å‹çš„æ•°æ®ã€‚å½“ç„¶ï¼Œè¯»è€…è¿˜å¯ä»¥ç”¨æ›´å¤šçš„å‚æ•°æ¥å£°æ˜ collectionï¼Œå› ä¸º tuple å¯ä»¥æ¥å—ä»»æ„å¤šçš„å‚æ•°ã€‚æ­¤å¤–ï¼Œå’Œ pair ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ›´ä¸ºç®€å•åœ°ä½¿ç”¨ C++11 çš„æ¨¡æ¿å‡½æ•° make_tuple æ¥åˆ›é€ ä¸€ä¸ª tuple æ¨¡æ¿ç±»å‹ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std: <span class="built_in">make_tuple</span>(<span class="number">9.8</span>, <span class="string">'g'</span>, <span class="string">"gravity"</span>);</span><br></pre></td></tr></tbody></table></figure><p>ç”±äº tuple åŒ…å«çš„ç±»å‹æ•°é‡å¯ä»¥ä»»æ„åœ°å¤šï¼Œé‚£ä¹ˆåœ¨å®¢è§‚ä¸Šï¼Œå°±éœ€è¦ç±»æ¨¡æ¿èƒ½å¤Ÿæ¥å—å˜é•¿çš„å‚æ•°ã€‚å› æ­¤ï¼Œåœ¨ C++11 ä¸­æˆ‘ä»¬å°±çœ‹åˆ°äº†æ‰€è°“çš„å˜é•¿æ¨¡æ¿ï¼ˆ variadic templateï¼‰çš„å®ç°ã€‚</p><h2 id="å˜é•¿æ¨¡æ¿æ¨¡æ¿å‚æ•°åŒ…å’Œå‡½æ•°å‚æ•°åŒ…">å˜é•¿æ¨¡æ¿ï¼šæ¨¡æ¿å‚æ•°åŒ…å’Œå‡½æ•°å‚æ•°åŒ…</h2><p>æˆ‘ä»¬å…ˆçœ‹çœ‹å˜é•¿æ¨¡æ¿çš„è¯­æ³•ï¼Œè¿˜æ˜¯ä»¥å‰é¢æåˆ°çš„ tuple ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸‹ä»£ç æ¥å£°æ˜ tuple æ˜¯ä¸€ä¸ªå˜é•¿ç±»æ¨¡æ¿</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ... Elements&gt; <span class="keyword">class</span> <span class="title class_">tuple</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨æ ‡ç¤ºç¬¦ Elements ä¹‹å‰çš„ä½¿ç”¨äº†çœç•¥å·ï¼ˆä¸‰ä¸ªâ€œç‚¹â€ï¼‰æ¥è¡¨ç¤ºè¯¥å‚æ•°æ˜¯å˜é•¿çš„ã€‚åœ¨ C++11 ä¸­ï¼Œ Elements è¢«ç§°ä½œæ˜¯ä¸€ä¸ªâ€œæ¨¡æ¿å‚æ•°åŒ…"ï¼ˆ template parameter packï¼‰è¿™æ˜¯ä¸€ç§æ–°çš„æ¨¡æ¿å‚æ•°ç±»å‹ã€‚æœ‰äº†è¿™æ ·çš„å‚æ•°åŒ…ï¼Œç±»æ¨¡æ¿ tuple å°±å¯ä»¥æ¥å—ä»»æ„å¤šä¸ªå‚æ•°ä½œä¸ºæ¨¡æ¿å‚æ•°ã€‚å¯¹äºä»¥ä¸‹å®ä¾‹åŒ–çš„ tuple æ¨¡æ¿ç±»ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tuple&lt;<span class="type">int</span>, <span class="type">char</span>, <span class="type">double</span>&gt;</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¯‘å™¨åˆ™å¯ä»¥å°†å¤šä¸ªæ¨¡æ¿å‚æ•°æ‰“åŒ…æˆä¸ºâ€œå•ä¸ªçš„â€æ¨¡æ¿å‚æ•°åŒ… Elementsï¼Œå³ Element åœ¨è¿›è¡Œæ¨¡æ¿æ¨å¯¼çš„æ—¶å€™ï¼Œå°±æ˜¯ä¸€ä¸ªåŒ…å« intã€char å’Œ double ä¸‰ç§ç±»å‹ç±»å‹é›†åˆã€‚</p><p>ä¸æ™®é€šçš„æ¨¡æ¿å‚æ•°ç±»ä¼¼ï¼Œæ¨¡æ¿å‚æ•°åŒ…ä¹Ÿå¯ä»¥æ˜¯éç±»å‹çš„ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">int</span>...A&gt; <span class="keyword">class</span> <span class="title">Nontypevariadictemplate</span><span class="params">()</span></span>;</span><br><span class="line">Nontypevariadictemplate&lt;<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&gt; ntvt;</span><br></pre></td></tr></tbody></table></figure><p>å°±å®šä¹‰äº†æ¥å—éç±»å‹å‚æ•°çš„å˜é•¿æ¨¡æ¿ Nontypevariadictemplateã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªä¸‰å‚æ•°ï¼ˆ1ï¼Œ0ï¼Œ2ï¼‰çš„æ¨¡æ¿å®ä¾‹ ntvtã€‚è¯¥å£°æ˜æ–¹å¼ç›¸å½“äºï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>&gt; <span class="keyword">class</span> <span class="title class_">Nontypevariadictemplate</span>:</span><br><span class="line">Nontypevariadictemplate&lt;<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&gt; ntvt:</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·çš„ç±»æ¨¡æ¿å®šä¹‰å’Œå®ä¾‹åŒ–ã€‚ é™¤äº†ç±»å‹çš„æ¨¡æ¿å‚æ•°åŒ…å’Œéç±»å‹çš„æ¨¡æ¿å‚æ•°åŒ…ï¼Œæ¨¡æ¿å‚æ•°åŒ…å®é™…ä¸Šè¿˜æ˜¯æ¨¡æ¿ç±»å‹çš„ï¼Œä¸è¿‡è¿™æ ·çš„å£°æ˜ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬åœ¨åé¢å†è®¨è®ºä¸€ä¸ªæ¨¡æ¿å‚æ•°åŒ…åœ¨æ¨¡æ¿æ¨å¯¼æ—¶ä¼šè¢«è®¤ä¸ºæ˜¯æ¨¡æ¿çš„å•ä¸ªå‚æ•°ï¼ˆè™½ç„¶å®é™…ä¸Šå®ƒå°†ä¼šæ‰“åŒ…ä»»æ„æ•°é‡çš„å®å‚ï¼‰ã€‚ä¸ºäº†ä½¿ç”¨æ¨¡æ¿å‚æ•°åŒ…ï¼Œæˆ‘ä»¬æ€»æ˜¯éœ€è¦å°†å…¶è§£åŒ…ï¼ˆ unpackï¼‰ã€‚åœ¨ C++11 ä¸­ï¼Œè¿™é€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ªåä¸ºåŒ…æ‰©å±•ï¼ˆ pack expansionï¼‰çš„è¡¨è¾¾å¼æ¥å®Œæˆã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>...A&gt; <span class="keyword">class</span> <span class="title class_">Template</span>: <span class="keyword">private</span> B&lt;A...&gt;{};</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œçš„è¡¨è¾¾å¼ A...ï¼ˆå³å‚æ•°åŒ… A åŠ ä¸Šä¸‰ä¸ªâ€œç‚¹â€ï¼‰å°±æ˜¯ä¸€ä¸ªåŒ…æ‰©å±•ã€‚ç›´è§‚åœ°çœ‹ï¼Œå‚æ•°åŒ…ä¼šåœ¨åŒ…æ‰©å±•çš„ä½ç½®å±•å¼€ä¸ºå¤šä¸ªå‚æ•°ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt; <span class="keyword">class</span> <span class="title class_">B</span>{};</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>...A&gt; <span class="keyword">class</span> <span class="title class_">Template</span>: <span class="keyword">private</span> B&lt;A...&gt;{}:</span><br><span class="line">Template&lt;X, Y&gt; xy;</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸ºç±»æ¨¡æ¿å£°æ˜äº†ä¸€ä¸ªå‚æ•°åŒ… Aï¼Œè€Œä½¿ç”¨å‚æ•°åŒ… A... åˆ™æ˜¯åœ¨ Template çš„ç§æœ‰åŸºç±» B&lt;A...&gt;ä¸­ï¼Œé‚£ä¹ˆæœ€åä¸€ä¸ªè¡¨è¾¾å¼å°±å£°æ˜äº†ä¸€ä¸ªåŸºç±»ä¸º B&lt;Xï¼ŒY&gt;çš„æ¨¡æ¿ç±» Template&lt;Xï¼ŒY&gt;çš„å¯¹è±¡ xyã€‚å…¶ä¸­ Xã€Y ä¸¤ä¸ªæ¨¡æ¿å‚æ•°å…ˆæ˜¯è¢«æ‰“åŒ…ä¸ºå‚æ•°åŒ… Aï¼Œè€Œååˆåœ¨åŒ…æ‰©å±•è¡¨è¾¾å¼ A... ä¸­è¢«è¿˜åŸã€‚è¯»è€…å¯ä»¥ä½“ä¼šä¸€ä¸‹è¿™æ ·çš„ä½¿ç”¨æ–¹å¼ã€‚</p><p>ä¸è¿‡ä¸Šé¢å¯¹è±¡ xy çš„ä¾‹å­æ˜¯åŸºäºç±»æ¨¡æ¿ B æ€»æ˜¯æ¥å—ä¸¤ä¸ªå‚æ•°çš„å‰æä¸‹çš„ã€‚å€˜è‹¥æˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜äº†ä¸€ä¸ª Template&lt;Xï¼ŒYï¼ŒZ&gt;ï¼Œå°±å¿…ç„¶ä¼šå‘ç”Ÿæ¨¡æ¿æ¨å¯¼çš„é”™è¯¯ã€‚è¿™è·Ÿæˆ‘ä»¬ä¹‹å‰æåˆ°çš„â€œå˜é•¿â€ä¼¼ä¹æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚é‚£ä¹ˆå¦‚ä½•æ‰èƒ½åˆ©ç”¨æ¨¡æ¿å‚æ•°åŒ…åŠåŒ…æ‰©å±•ï¼Œä½¿å¾—æ¨¡æ¿èƒ½å¤Ÿæ¥å—ä»»æ„å¤šçš„æ¨¡æ¿å‚æ•°ï¼Œä¸”å‡èƒ½å®ä¾‹åŒ–å‡ºæœ‰æ•ˆçš„å¯¹è±¡å‘¢ï¼Ÿ</p><p>äº‹å®ä¸Šï¼Œåœ¨ C++11 ä¸­ï¼Œå®ç° tuple æ¨¡æ¿çš„æ–¹å¼ç»™å‡ºäº†ä¸€ç§ä½¿ç”¨æ¨¡æ¿å‚æ•°åŒ…çš„ç­”æ¡ˆã€‚è¿™ä¸ªæ€è·¯æ˜¯ä½¿ç”¨æ•°å­¦çš„å½’çº³æ³•ï¼Œè½¬æ¢ä¸ºè®¡ç®—æœºèƒ½å¤Ÿå®ç°çš„æ‰‹æ®µåˆ™æ˜¯é€’å½’ã€‚é€šè¿‡å®šä¹‰é€’å½’çš„æ¨¡æ¿åç‰¹åŒ–å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¾—æ¨¡æ¿å‚æ•°åŒ…åœ¨å®ä¾‹åŒ–æ—¶èƒ½å¤Ÿå±‚å±‚å±•å¼€ï¼Œç›´åˆ°å‚æ•°åŒ…ä¸­çš„å‚æ•°é€æ¸è€—å°½æˆ–åˆ°è¾¾æŸä¸ªæ•°é‡çš„è¾¹ç•Œä¸ºæ­¢ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªç”¨å˜é•¿æ¨¡æ¿å®ç° tupleï¼ˆç®€åŒ–çš„ tuple å®ç°ï¼‰çš„ä»£ç ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>...Elements&gt; <span class="keyword">class</span> <span class="title class_">tuple</span>;  <span class="comment">//å˜é•¿æ¨¡æ¿çš„å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Head, <span class="keyword">typename</span>...Tail&gt;    <span class="comment">//é€’å½’çš„åç‰¹åŒ–å®šä¹‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">tuple</span>&lt;Head, Tail...&gt;: <span class="keyword">private</span> tuple&lt;Tail...&gt;{</span><br><span class="line">    Head head;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="keyword">class</span> <span class="title class_">tuple</span>&lt;&gt;    <span class="comment">//è¾¹ç•Œæ¡ä»¶</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†å˜é•¿æ¨¡æ¿ç±» tupleï¼Œå…¶åªåŒ…å«ä¸€ä¸ªæ¨¡æ¿å‚æ•°ï¼Œå³ Elements æ¨¡æ¿å‚æ•°åŒ…ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åˆåç‰¹åŒ–åœ°å®šä¹‰äº†ä¸€ä¸ªåŒå‚æ•°çš„ tuple çš„ç‰ˆæœ¬ã€‚è¯¥åç‰¹åŒ–ç‰ˆæœ¬çš„ tuple åŒ…å«äº†ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ç±»å‹æ¨¡æ¿å‚æ•° Headï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯æ¨¡æ¿å‚æ•°åŒ… Tail åœ¨ä»£ç çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å°† Head å‹çš„æ•°æ®ä½œä¸º tuple&lt;Headï¼ŒTail...&gt;çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œè€Œå°†ä½¿ç”¨äº†åŒ…æ‰©å±•è¡¨è¾¾å¼çš„æ¨¡æ¿ç±» tuple&lt;Tail...&gt;ä½œä¸º tuple&lt;Headï¼ŒTail...&gt;çš„ç§æœ‰åŸºç±»ã€‚è¿™æ ·æ¥ï¼Œå½“ç¨‹åºå‘˜å®ä¾‹åŒ–ä¸€ä¸ªå½¢å¦‚ tuple &lt;doubleï¼Œintï¼Œcharï¼Œ float&gt;çš„ç±»å‹æ—¶ï¼Œåˆ™ä¼šå¼•èµ·åŸºç±»çš„é€’å½’æ„é€ ï¼Œè¿™æ ·çš„é€’å½’åœ¨ tuple çš„å‚æ•°åŒ…ä¸º 0 ä¸ªçš„æ—¶å€™ä¼šç»“æŸã€‚è¿™æ˜¯ç”±äºæˆ‘ä»¬å®šä¹‰äº†è¾¹ç•Œæ¡ä»¶æˆ–è€…è¯´åˆå§‹æ¡ä»¶ï¼Œå³ tuples&lt;&gt;è¿™æ ·ä¸åŒ…å«å‚æ•°çš„åç‰¹åŒ–ç‰ˆæœ¬è€Œé€ æˆçš„ã€‚åœ¨ä»£ç ä¸­ï¼Œ tuples&lt;&gt;åç‰¹åŒ–ç‰ˆæœ¬æ˜¯ä¸€ä¸ªæ²¡æœ‰æˆå‘˜çš„ç©ºç±»å‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œç¼–è¯‘å™¨å°†ä» tuples å»ºé€ å‡º tuple&lt;float...&gt;ï¼Œç»§è€Œé€ å‡º tuple&lt;charï¼Œfoat&gt;ã€ tuple&lt;intï¼Œcharï¼Œfoat&gt;ï¼Œæœ€åå°±å»ºé€ å‡ºäº† tuple&lt;doubleï¼Œintï¼Œcharï¼Œfoa&gt;ç±»å‹ã€‚ ä¸‹å›¾æ˜¯ tuple&lt;doubleï¼Œinï¼Œcharï¼Œnioa&gt;å®ä¾‹åŒ–åçš„ç»§æ‰¿ç»“æ„ç¤ºæ„å›¾ã€‚æˆ‘ä»¬ç”¨æ–¹æ¡†è¡¨ç¤ºç±»å‹ï¼Œè€Œæ–¹æ¡†å†…çš„æ–¹æ¡†åˆ™è¡¨ç¤ºç±»å‹ç”±å…¶å†…éƒ¨çš„æ–¹æ¡†æ‰€ä»£è¡¨çš„ç±»å‹ç§æœ‰æ´¾ç”Ÿè€Œæ¥ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/performace2.png"></p><p>è¿™ç§å˜é•¿æ¨¡æ¿çš„å®šä¹‰æ–¹å¼ç¨æ˜¾å¤æ‚ï¼Œä¸è¿‡å´æœ‰æ•ˆåœ°è§£å†³äº†æ¨¡æ¿å‚æ•°ä¸ªæ•°è¿™æ ·çš„å‘é¢˜ã€‚å½“ç„¶ï¼Œè¿™æ ·åšçš„å‰ææ˜¯æ¨¡æ¿ç±»/å‡½æ•°çš„å®šä¹‰è¦å…·æœ‰èƒ½å¤Ÿé€’æ¨çš„ç»“æ„ã€‚</p><p>é™¤äº†å˜é•¿çš„æ¨¡æ¿ç±»ï¼Œåœ¨ C++11 ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å£°æ˜å˜é•¿æ¨¡æ¿çš„å‡½æ•°ã€‚å¯¹äºå˜é•¿æ¨¡æ¿å‡½æ•°è€Œè¨€ï¼Œé™¤äº†å£°æ˜å¯ä»¥å®¹çº³å˜é•¿ä¸ªæ¨¡æ¿å‚æ•°çš„æ¨¡æ¿å‚æ•°åŒ…ä¹‹å¤–ï¼Œç›¸åº”åœ°ï¼Œå˜é•¿çš„å‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥å£°æ˜æˆå‡½æ•°å‚æ•°åŒ…ï¼ˆ function parameter packï¼‰ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>...T&gt; <span class="type">void</span> <span class="title">f</span><span class="params">(T...args)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äº T æ˜¯ä¸ªå˜é•¿æ¨¡æ¿å‚æ•°ï¼ˆç±»å‹ï¼‰ï¼Œå› æ­¤ args åˆ™æ˜¯å¯¹åº”äºè¿™äº›å˜é•¿ç±»å‹çš„æ•°æ®ï¼Œå³å‡½æ•°å‚æ•°åŒ…ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ C++11 ä¸­ï¼Œæ ‡å‡†è¦æ±‚å‡½æ•°å‚æ•°åŒ…å¿…é¡»å”¯ä¸€ï¼Œä¸”æ˜¯å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ï¼ˆæ¨¡æ¿å‚æ•°åŒ…æ²¡æœ‰è¿™æ ·çš„è¦æ±‚ï¼‰ã€‚ æœ‰äº†æ¨¡æ¿å‚æ•°åŒ…å’Œå‡½æ•°å‚æ•°åŒ…ä¸¤ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° C ä¸­å˜é•¿å‡½æ•°çš„åŠŸèƒ½äº†ã€‚</p><h1 id="åŸå­ç±»å‹ä¸åŸå­æ“ä½œ">åŸå­ç±»å‹ä¸åŸå­æ“ä½œ</h1><h2 id="å¹¶è¡Œç¼–ç¨‹å¤šçº¿ç¨‹ä¸-c11">å¹¶è¡Œç¼–ç¨‹ã€å¤šçº¿ç¨‹ä¸ C++11</h2><p>åœ¨ C++11 ä¹‹å‰ï¼Œåœ¨ C/C++ä¸­ç¨‹åºä¸­ä½¿ç”¨çº¿ç¨‹å´å¹¶éé²œè§ã€‚è¿™æ ·çš„ä»£ç ä¸»è¦ä½¿ç”¨ POSIX çº¿ç¨‹ï¼ˆ pthreadï¼‰å’Œ OpenMP ç¼–è¯‘å™¨æŒ‡ä»¤ä¸¤ç§ç¼–ç¨‹æ¨¡å‹æ¥å®Œæˆç¨‹åºçš„çº¿ç¨‹åŒ–ã€‚è€Œåœ¨ C++11 ä¸­ï¼Œæ ‡å‡†çš„ä¸€ä¸ªç›¸å½“å¤§çš„å˜åŒ–å°±æ˜¯å¼•å…¥äº†å¤šçº¿ç¨‹çš„æ”¯æŒï¼Œè¿™ä½¿å¾— C/C++è¯­è¨€åœ¨è¿›è¡Œçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œä¸å¿…ä¾èµ–ç¬¬ä¸‰æ–¹åº“å’Œæ ‡å‡†ã€‚è€Œ C++å¯¹çº¿ç¨‹çš„æ”¯æŒï¼Œä¸€ä¸ªæœ€ä¸ºé‡è¦çš„éƒ¨åˆ†ï¼Œå°±æ˜¯åœ¨åŸå­æ“ä½œä¸­å¼•å…¥äº†åŸå­ç±»å‹çš„æ¦‚å¿µã€‚</p><h2 id="åŸå­æ“ä½œä¸-c11-åŸå­ç±»å‹">åŸå­æ“ä½œä¸ C++11 åŸå­ç±»å‹</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŸå­æ“ä½œéƒ½æ˜¯é€šè¿‡â€œäº’æ–¥â€ï¼ˆ mutual exclusiveï¼‰çš„è®¿é—®æ¥ä¿è¯çš„ã€‚å€ŸåŠ© POSIX æ ‡å‡†çš„ pthread åº“ä¸­çš„äº’æ–¥é”ï¼ˆ mutexï¼‰ä¹Ÿå¯ä»¥åšåˆ°ã€‚ä¸è¿‡æ˜¾è€Œæ˜“è§åœ°ï¼ŒåŸºäº pthread çš„æ–¹æ³•è™½ç„¶å¯è¡Œï¼Œä½†ä»£ç ç¼–å†™å´å¾ˆéº»çƒ¦ã€‚ç¨‹åºå‘˜éœ€è¦ä¸ºå…±äº«å˜é‡åˆ›å»ºäº’æ–¥é”ï¼Œå¹¶åœ¨è¿›å…¥ä¸´ç•ŒåŒºå‰åè¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œã€‚ä¸è¿‡åœ¨ C++11 ä¸­ï¼Œé€šè¿‡å¯¹å¹¶è¡Œç¼–ç¨‹æ›´ä¸ºè‰¯å¥½çš„æŠ½è±¡ï¼Œè¦å®ç°åŒæ ·çš„åŠŸèƒ½å°±ç®€å•äº†å¾ˆå¤šã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">std::atomic_llong total = <span class="number">0</span>;            <span class="comment">// atomic_llong ç›¸å½“äº long longï¼Œä½†æ˜¯æœ¬èº«å°±æ‹¥æœ‰åŸå­æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> <span class="type">long</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000LL</span>; ++i)</span><br><span class="line">    {</span><br><span class="line">        total += i;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(func)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(func)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; total &lt;&lt; std::endl;     <span class="comment">// 9999999900000000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†åŸå­ç±»å‹ atomic_llong ä¹‹åï¼Œä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„äº’æ–¥æ¥å£æ¥ä¿è¯ total çš„åŒæ­¥ã€‚é™¤äº† atomic_llong ç±»å‹ï¼ŒC++11 è¿˜æä¾›äº†å…¶ä»–çš„åŸå­ç±»å‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/performace3.png"></p><p>å½“æˆ‘ä»¬å»çœ‹è¿™äº›ç±»å‹çš„å®šä¹‰æ—¶ä¼šå‘ç°ï¼Œèµ·å§‹å®ƒä»¬éƒ½æ˜¯ç”¨ atomic<t>æ¨¡æ¿æ¥å®šä¹‰çš„ã€‚ä¾‹å¦‚ std::atomic_llong å°±æ˜¯ç”¨ std::atomic<long long="">æ¥å®šä¹‰çš„ã€‚</long></t></p><p>C++11 ä¸­å°†åŸå­æ“ä½œå®šä¹‰ä¸º atomic æ¨¡æ¿ç±»çš„æˆå‘˜å‡½æ•°ï¼ŒåŒ…æ‹¬äº†å¤§å¤šæ•°ç±»å‹çš„æ“ä½œï¼Œæ¯”å¦‚è¯»å†™ã€äº¤æ¢ç­‰ã€‚å¯¹äºå†…ç½®ç±»å‹ï¼Œä¸»è¦é€šè¿‡é‡è½½å…¨å±€æ“ä½œç¬¦æ¥å®ç°ã€‚ä¸‹é¢åˆ—å‡ºæ‰€æœ‰ atomic ç±»å‹åŠå…¶æ”¯æŒçš„ç›¸å…³æ“ä½œåˆ—è¡¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/performace4.png"></p><p>åˆ—è¡¨ä¸­çš„ atomic-intergral-type ä»¥åŠ atomic<intergral-type>å°±æ˜¯å‰é¢çš„åŸå­ç±»å‹åˆ—è¡¨ä¸­çš„ç±»å‹ï¼Œclass-type æ˜¯è‡ªå®šä¹‰ç±»å‹ã€‚å¯¹äºå¤§éƒ¨åˆ†åŸå­ç±»å‹ï¼Œéƒ½æ”¯æŒè¯» (load)ã€å†™ (store)ã€äº¤æ¢ (exchange) ç­‰æ“ä½œã€‚</intergral-type></p><h2 id="å†…å­˜æ¨¡å‹é¡ºåºä¸€è‡´æ€§å’Œ-memory_order">å†…å­˜æ¨¡å‹ã€é¡ºåºä¸€è‡´æ€§å’Œ memory_order</h2><p>äº†è§£è¿™ä¸€å°èŠ‚çš„å†…å®¹ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€æ®µä»£ç ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    b = <span class="number">2</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; <span class="string">","</span> &lt;&lt; b &lt;&lt; std::endl;     <span class="comment">// ä¸å®š</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(func1)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(func2)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; a &lt;&lt; <span class="string">","</span> &lt;&lt; b &lt;&lt; std::endl;   <span class="comment">// 1,2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šçš„ä»£ç ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ‰“å° a å’Œ b ç»“æœå¿…å®šæ˜¯ 1,2ï¼Œè€Œåœ¨çº¿ç¨‹ func2 ä¸­æ‰“å°ç»“æœå°±ä¸ä¸€å®šäº†ï¼Œå¯èƒ½æ˜¯ 0,0 æˆ–è€… 1,2 æˆ–è€… 1,0ã€‚å› ä¸ºçº¿ç¨‹çš„æ‰§è¡Œå¹¶ä¸èƒ½ä¿è¯å…ˆåˆ›å»ºçš„ä¸€å®šå…ˆè¿è¡Œï¼Œä¸¤è€…è¿è¡Œé¡ºåºå­˜åœ¨å¤šç§å¯èƒ½ã€‚ä½†æ˜¯å¯¹äºåŸå­ç±»å‹æ¥è¯´ï¼Œfunc2 ä¸­çš„æ‰“å°ä¸å¯èƒ½å‡ºç° 0,2 çš„æƒ…å†µï¼Œå› ä¸ºåŸå­ç±»å‹çš„å˜é‡åœ¨çº¿ç¨‹ä¸­æ€»æ˜¯ä¿æŒé¡ºåºæ‰§è¡Œçš„ç‰¹æ€§ï¼ˆé¡ºåºä¸€è‡´æ€§ï¼‰ã€‚</p><p>ä¸è¿‡åœ¨ C++11 ä¸­é¡ºåºä¸€è‡´æ€§åªæ˜¯å¤šç§å†…å­˜æ¨¡å‹ä¸­çš„ä¸€ç§ï¼Œä»£ç å¹¶éå¿…é¡»æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œå› ä¸ºé¡ºåºå¾€å¾€æ„å‘³ç€æœ€ä½æ•ˆçš„åŒæ­¥æ–¹å¼ã€‚åœ¨äº†è§£å…¶ä»–å†…å­˜æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€äº›å¤„ç†å™¨å’Œç¼–è¯‘å™¨ç›¸å…³çš„çŸ¥è¯†ã€‚ç°ä»£çš„å¤„ç†å™¨å¹¶ä¸æ˜¯é€æ¡å¤„ç†æœºå™¨æŒ‡ä»¤çš„ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: Load    reg3, <span class="number">1</span>;           <span class="comment">// å°†ç«‹å³æ•° 1 æ”¾å…¥å¯„å­˜å™¨ reg3</span></span><br><span class="line"><span class="number">2</span>: Move    reg4,reg3;         <span class="comment">// å°† reg3 çš„æ•°æ®æ”¾å…¥ reg4</span></span><br><span class="line"><span class="number">3</span>: Store   reg4, a;           <span class="comment">// å°† reg4 çš„æ•°æ®å­˜å…¥å†…å­˜åœ°å€ a</span></span><br><span class="line"><span class="number">4</span>: Load    reg5, <span class="number">2</span>;           <span class="comment">// å°†ç«‹å³æ•° 2 æ”¾å…¥å¯„å­˜å™¨ reg5</span></span><br><span class="line"><span class="number">5</span>: Store   reg5, b;           <span class="comment">// å°† reg5 çš„æ•°æ®å­˜å…¥å†…å­˜åœ°å€ b</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šçš„ä¼ªæ±‡ç¼–ä»£ç ä»£è¡¨äº† temp = 1; a = temp; b = 2ï¼Œé€šå¸¸æƒ…å†µä¸‹æŒ‡ä»¤éƒ½æ˜¯æŒ‰ç…§ 1~5 çš„é¡ºåºæ‰§è¡Œï¼Œè¿™ç§å†…å­˜æ¨¡å‹ç§°ä¸ºå¼ºé¡ºåº (strong ordered)ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‡ä»¤ 1ã€2ã€3 å’ŒæŒ‡ä»¤ 4ã€5 çš„è¿è¡Œé¡ºåºä¸å½±å“ç»“æœï¼Œæœ‰ä¸€äº›å¤„ç†å™¨å¯èƒ½ä¼šå°†æŒ‡ä»¤çš„é¡ºåºæ‰“ä¹±ï¼Œä¾‹å¦‚æŒ‰ç…§ 1-4-2-5-3 çš„é¡ºåºæ‰§è¡Œï¼Œè¿™ç§å†…å­˜æ¨¡å‹ç§°ä¸ºå¼±é¡ºåº (weak ordered)ã€‚</p><p>ä»‹ç»äº†ç¡¬ä»¶å†…å­˜æ¨¡å‹åï¼Œå†æ¥è¯´è¯´ C++11 ä¸­å®šä¹‰çš„å†…å­˜æ¨¡å‹å’Œé¡ºåºä¸€è‡´æ€§å’Œç¡¬ä»¶ä¸­çš„å…³ç³»ã€‚é«˜çº§è¯­è¨€å’Œæœºå™¨æŒ‡ä»¤æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥è¿›è¡Œè½¬æ¢çš„ï¼Œè€Œç¼–è¯‘å™¨å¤„äºä»£ç ä¼˜åŒ–çš„è€ƒè™‘ï¼Œä¼šå°†æŒ‡ä»¤è¿›è¡Œç§»åŠ¨ã€‚å¯¹äº C++11 çš„å†…å­˜æ¨¡å‹è€Œè¨€ï¼Œè¦ä¿è¯ä»£ç çš„é¡ºåºä¸€è‡´æ€§ï¼Œéœ€è¦åŒæ—¶åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ç¼–è¯‘å™¨ä¿è¯åŸå­æ“ä½œçš„æŒ‡ä»¤é—´é¡ºåºä¸å˜ï¼Œå³äº§ç”Ÿçš„è¯»å†™åŸå­ç±»å‹å˜é‡çš„æœºå™¨æŒ‡ä»¤å’Œä»£ç ç¼–å†™é¡ºåºæ˜¯ä¸€æ ·çš„ã€‚</li><li>å¤„ç†å™¨å¯¹åŸå­æ“ä½œçš„æ±‡ç¼–æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºä¸å˜ã€‚è¿™å¯¹äº x86 è¿™æ ·çš„å¼ºé¡ºåºçš„ä½“ç³»ç»“æ„è€Œè¨€æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè€Œå¯¹äºä¸€äº›å¼±é¡ºåºçš„å¹³å°åˆ™éœ€è¦æ¯ä¸ªåŸå­æ“ä½œä¹‹åè¦åŠ å…¥å†…å­˜æ …æ ã€‚</li></ul><p>å¯¹äºä¸Šæ–‡æ‰“å° aï¼Œb çš„ä»£ç æ¥è¯´ï¼Œå¦‚æœåªéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸­æ‰“å°ç»“æœï¼Œé‚£ä¹ˆä»£ç çš„æ‰§è¡Œé¡ºåºå¹¶ä¸é‡è¦ã€‚ä½†æ˜¯ atomic åŸå­ç±»å‹é»˜è®¤çš„é¡ºåºä¸€è‡´æ€§ä¼šè¦æ±‚ç¼–è¯‘å™¨ç¦ç”¨ä¼˜åŒ–ï¼Œè¿™æ— ç–‘å¢åŠ äº†æ€§èƒ½å¼€é”€ã€‚äºæ˜¯ C++11 ä¸­ï¼Œè®¾è®¡äº†èƒ½å¤Ÿå¯¹åŸå­ç±»å‹æŒ‡å®šå†…å­˜é¡ºåº memory_orderã€‚æˆ‘ä»¬æŠŠä¸Šæ–‡æ‰“å° aï¼Œb çš„ä»£ç ä¸­çš„ func1 åšä¸€ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    a.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">    b.<span class="built_in">store</span>(<span class="number">2</span>, std::memory_order_relaxed);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº† store å‡½æ•°è¿›è¡Œèµ‹å€¼ï¼Œstore å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¦å†™å…¥çš„å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯åä¸º memory_order çš„æšä¸¾å€¼ã€‚è¿™é‡Œä½¿ç”¨äº† std::memory_order_relaxedï¼Œè¡¨ç¤ºæ¾æ•£å†…å­˜é¡ºåºï¼Œè¯¥æšä¸¾å€¼ä»£è¡¨ç¼–è¯‘å™¨å¯ä»¥ä»»ç”±ç¼–è¯‘å™¨é‡æ–°æ’åºæˆ–åˆ™ç”±å¤„ç†å™¨ä¹±åºå¤„ç†ã€‚è¿™æ · a å’Œ b çš„èµ‹å€¼æ‰§è¡Œé¡ºåºæ€§å°±è¢«è§£é™¤äº†ï¼Œå¯¹äº func2 ä¸­çš„æ‰“å°è¯­å¥ï¼Œæ‰“å°å‡º 0,2 çš„ç»“æœä¹Ÿå°±æ˜¯åˆç†çš„äº†ã€‚åœ¨ C++11 ä¸­ä¸€å…±æœ‰ 7 ç§ memory_order æšä¸¾å€¼ï¼Œé»˜è®¤æŒ‰ç…§ memory_order_seq_cst æ‰§è¡Œï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/performace5.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰çš„ memory_order éƒ½èƒ½è¢« atomic æˆå‘˜ä½¿ç”¨ï¼š</p><ul><li>store å‡½æ•°å¯ä»¥ä½¿ç”¨ memory_order_seq_cstã€memory_order_releaseã€memory_order_relaxedã€‚</li><li>load å‡½æ•°å¯ä»¥ä½¿ç”¨ memory_order_seq_cstã€memory_order_acquireã€memory_order_consumeã€memory_order_relaxedã€‚</li><li>éœ€è¦åŒæ—¶è¯»å†™çš„æ“ä½œï¼Œä¾‹å¦‚ test_and_flagã€exchange ç­‰æ“ä½œã€‚å¯ä»¥ä½¿ç”¨ memory_order_seq_cstã€memory_order_relã€memory_order_releaseã€memory_order_acquireã€memory_order_consumeã€memory_order_relaxedã€‚</li><li>åŸå­ç±»å‹æä¾›çš„ä¸€äº›æ“ä½œç¬¦éƒ½æ˜¯ memory_order_seq_cst çš„å°è£…ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æ˜¯é¡ºåºä¸€è‡´æ€§çš„ã€‚</li></ul><p>æœ€åè¯´æ˜ä¸€ä¸‹ï¼Œåœ¨é™¤éå¿…è¦çš„æƒ…å†µä¸‹ï¼Œä¸ç”¨ä½¿ç”¨ std::memory_orderï¼Œstd::atmoic é»˜è®¤ç”¨çš„æ˜¯æœ€å¼ºé™åˆ¶ã€‚</p><h1 id="çº¿ç¨‹å±€éƒ¨å­˜å‚¨">çº¿ç¨‹å±€éƒ¨å­˜å‚¨</h1><p>çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼Œ thread local storageï¼‰æ˜¯ä¸€ä¸ªå·²æœ‰çš„æ¦‚å¿µã€‚ç®€å•åœ°è¯´ï¼Œæ‰€è°“çº¿ç¨‹å±€éƒ¨å­˜å‚¨å˜é‡ï¼Œå°±æ˜¯æ‹¥æœ‰çº¿ç¨‹ç”Ÿå‘½æœŸåŠçº¿ç¨‹å¯è§æ€§çš„å˜é‡ã€‚çº¿ç¨‹å±€éƒ¨å­˜å‚¨å®é™…ä¸Šæ˜¯ç”±å•çº¿ç¨‹ç¨‹åºä¸­çš„å…¨å±€/é™æ€å˜é‡è¢«åº”ç”¨åˆ°å¤šçº¿ç¨‹ç¨‹åºä¸­è¢«çº¿ç¨‹å…±äº«è€Œæ¥ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å›é¡¾ä¸€ä¸‹æ‰€è°“çš„çº¿ç¨‹æ¨¡å‹ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¼šæ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œä½†æ˜¯å †ç©ºé—´ã€é™æ€æ•°æ®åŒºåˆ™æ˜¯å…±äº«çš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œå…¨å±€ã€é™æ€å˜é‡åœ¨è¿™ç§å¤šçº¿ç¨‹æ¨¡å‹ä¸‹å°±æ€»æ˜¯åœ¨çº¿ç¨‹é—´å…±äº«çš„ã€‚ C++11 å£°æ˜ä¸€ä¸ª TLS å˜é‡çš„è¯­æ³•å¾ˆç®€å•ï¼Œå³é€šè¿‡ thread_local ä¿®é¥°ç¬¦å£°æ˜å˜é‡å³å¯ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="keyword">thread_local</span> errcode;</span><br></pre></td></tr></tbody></table></figure><p>ä¸€æ—¦å£°æ˜ä¸€ä¸ªå˜é‡ä¸º thread_localï¼Œå…¶å€¼å°†åœ¨çº¿ç¨‹å¼€å§‹æ—¶è¢«åˆå§‹åŒ–ï¼Œè€Œåœ¨çº¿ç¨‹ç»“æŸæ—¶ï¼Œè¯¥å€¼ä¹Ÿå°†ä¸å†æœ‰æ•ˆã€‚å¯¹äº thread_local å˜é‡åœ°å€å–å€¼ï¼ˆ&amp;ï¼‰ï¼Œä¹Ÿåªå¯ä»¥è·å¾—å½“å‰çº¿ç¨‹ä¸­çš„ TLS å˜é‡çš„åœ°å€å€¼ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1dpemFyZHRvSC9hcnRpY2xlL2RldGFpbHMvODExMTE1NDk=">https://blog.csdn.net/WizardtoH/article/details/81111549<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆå››ï¼‰æ™ºèƒ½æŒ‡é’ˆ</title>
      <link href="/2022/Program/CPP11Part4/"/>
      <url>/2022/Program/CPP11Part4/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP11ImproveTypeSafety.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyZjM0NjU2NTNiYjA3NGIyMmU3Njg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="shared_ptr">shared_ptr</h1><h2 id="å®ç°åŸç†">å®ç°åŸç†</h2><p>ä¸€ä¸ª shared_ptr å¯¹è±¡çš„å†…å­˜å¼€é”€è¦æ¯”è£¸æŒ‡é’ˆå’Œæ— è‡ªå®šä¹‰ deleter çš„ unique_ptr å¯¹è±¡ç•¥å¤§ã€‚shared_ptr éœ€è¦ç»´æŠ¤çš„ä¿¡æ¯æœ‰ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>æŒ‡å‘å…±äº«èµ„æºçš„æŒ‡é’ˆ</li><li>å¼•ç”¨è®¡æ•°ç­‰å…±äº«èµ„æºçš„æ§åˆ¶ä¿¡æ¯â€”â€”å®ç°ä¸Šæ˜¯ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘æ§åˆ¶ä¿¡æ¯çš„æŒ‡é’ˆ</li></ul><p>æ‰€ä»¥ï¼Œshared_ptr å¯¹è±¡éœ€è¦ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆã€‚shared_ptr çš„ deleter æ˜¯ä¿å­˜åœ¨æ§åˆ¶ä¿¡æ¯ä¸­ï¼Œæ‰€ä»¥ï¼Œæ˜¯å¦æœ‰è‡ªå®šä¹‰ deleter ä¸å½±å“ shared_ptr å¯¹è±¡çš„å¤§å°ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª shared_ptr æ—¶ï¼Œå…¶å®ç°ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;T&gt; <span class="title">sptr1</span><span class="params">(<span class="keyword">new</span> T)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer1.jpg"></p><p>å¤åˆ¶ä¸€ä¸ª shared_ptr ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::shared_ptr&lt;T&gt; sptr2 = sptr1;</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer2.jpg"></p><p>ä¸ºä»€ä¹ˆæ§åˆ¶ä¿¡æ¯å’Œæ¯ä¸ª shared_ptr å¯¹è±¡éƒ½éœ€è¦ä¿å­˜æŒ‡å‘å…±äº«èµ„æºçš„æŒ‡é’ˆï¼Ÿå¯ä¸å¯ä»¥å»æ‰ shared_ptr å¯¹è±¡ä¸­æŒ‡å‘å…±äº«èµ„æºçš„æŒ‡é’ˆï¼Œä»¥èŠ‚çœå†…å­˜å¼€é”€ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼šä¸èƒ½ã€‚ å› ä¸º shared_ptr å¯¹è±¡ä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä¸ä¸€å®šå’Œæ§åˆ¶å—ä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä¸€æ ·ã€‚</p><p>æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Fruit</span> {</span><br><span class="line">    <span class="type">int</span> juice;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Vegetable</span> {</span><br><span class="line">    <span class="type">int</span> fiber;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Tomato</span> : <span class="keyword">public</span> Fruit, Vegetable {</span><br><span class="line">    <span class="type">int</span> sauce;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ç”±äºç»§æ‰¿çš„å­˜åœ¨ï¼Œshared_ptr å¯èƒ½æŒ‡å‘åŸºç±»å¯¹è±¡</span></span><br><span class="line">std::shared_ptr&lt;Tomato&gt; tomato = std::<span class="built_in">make_shared</span>&lt;Tomato&gt;();</span><br><span class="line">std::shared_ptr&lt;Fruit&gt; fruit = tomato;</span><br><span class="line">std::shared_ptr&lt;Vegetable&gt; vegetable = tomato;</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer3.jpg"></p><p>å¦å¤–ï¼Œstd::shared_ptr æ”¯æŒ aliasing constructorã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Y &gt;</span></span><br><span class="line"><span class="function"><span class="title">shared_ptr</span><span class="params">( <span class="type">const</span> shared_ptr&lt;Y&gt;&amp; r, element_type* ptr )</span> <span class="keyword">noexcept</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>Aliasing constructorï¼Œç®€å•è¯´å°±æ˜¯æ„é€ å‡ºæ¥çš„ shared_ptr å¯¹è±¡å’Œå‚æ•° r æŒ‡å‘åŒä¸€ä¸ªæ§åˆ¶å—ï¼ˆä¼šå½±å“ r æŒ‡å‘çš„èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼‰ï¼Œä½†æ˜¯æŒ‡å‘å…±äº«èµ„æºçš„æŒ‡é’ˆæ˜¯å‚æ•° ptrã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Vec = std::vector&lt;<span class="type">int</span>&gt;;</span><br><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">GetSPtr</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">auto</span> elts = {<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>};</span><br><span class="line">    std::shared_ptr&lt;Vec&gt; pvec = std::<span class="built_in">make_shared</span>&lt;Vec&gt;(elts);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">shared_ptr</span>&lt;<span class="type">int</span>&gt;(pvec, &amp;(*pvec)[<span class="number">2</span>]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sptr = <span class="built_in">GetSPtr</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">-2</span>; i &lt; <span class="number">3</span>; ++i) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, sptr.<span class="built_in">get</span>()[i]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer4.jpg"></p><p>çœ‹ä¸Šé¢çš„ä¾‹å­ï¼Œä½¿ç”¨ std::shared_ptr æ—¶ï¼Œä¼šæ¶‰åŠä¸¤æ¬¡å†…å­˜åˆ†é…ï¼šä¸€æ¬¡åˆ†é…å…±äº«èµ„æºå¯¹è±¡ï¼›ä¸€æ¬¡åˆ†é…æ§åˆ¶å—ã€‚C++ æ ‡å‡†åº“æä¾›äº† std::make_shared å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª shared_ptr å¯¹è±¡ï¼Œåªéœ€è¦ä¸€æ¬¡å†…å­˜åˆ†é…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer5.jpg"></p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ç”¨é€šè¿‡æ§åˆ¶å—ä¸­çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çŸ¥é“å…±äº«èµ„æºçš„ä½ç½®â€”â€”è¿™ä¸ªæŒ‡é’ˆä¹Ÿå¯ä»¥çœç•¥æ‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer6.jpg"></p><h2 id="ææ„">ææ„</h2><p>shared_ptr é»˜è®¤è°ƒç”¨ delete é‡Šæ”¾å…³è”çš„èµ„æºã€‚å¦‚æœç”¨æˆ·é‡‡ç”¨ä¸€ä¸ªä¸ä¸€æ ·çš„ææ„ç­–ç•¥æ—¶ï¼Œä»–å¯ä»¥è‡ªç”±æŒ‡å®šæ„é€ è¿™ä¸ª shared_ptr çš„ç­–ç•¥ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªç”±äºé‡‡ç”¨é»˜è®¤ææ„ç­–ç•¥å¯¼è‡´çš„é—®é¢˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> {...};</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">shared_ptr&lt;Test&gt; <span class="title">sptr1</span><span class="params">( <span class="keyword">new</span> Test[<span class="number">5</span>] )</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨æ­¤åœºæ™¯ä¸‹ï¼Œshared_ptr æŒ‡å‘ä¸€ç»„å¯¹è±¡ï¼Œä½†æ˜¯å½“ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œé»˜è®¤çš„ææ„å‡½æ•°è°ƒç”¨ delete é‡Šæ”¾èµ„æºã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨ delete[] æ¥é”€æ¯è¿™ä¸ªæ•°ç»„ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ä¸€ä¸ª lamda è¡¨è¾¾å¼ï¼Œæ¥æŒ‡å®šä¸€ä¸ªé€šç”¨çš„é‡Šæ”¾æ­¥éª¤ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">shared_ptr&lt;Test&gt; <span class="title">sptr1</span><span class="params">( <span class="keyword">new</span> Test[<span class="number">5</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        [ ](Test* p) { <span class="keyword">delete</span>[ ] p; } )</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡æŒ‡å®š delete[] æ¥ææ„ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥å®Œç¾è¿è¡Œã€‚</p><h2 id="issues">Issues</h2><p>æ‰€æœ‰çš„ shared_ptrs æ‹¥æœ‰ç›¸åŒçš„å¼•ç”¨è®¡æ•°ï¼Œå±äºç›¸åŒçš„ç»„ã€‚ä¸Šè¿°ä»£ç å·¥ä½œè‰¯å¥½ï¼Œè®©æˆ‘ä»¬çœ‹å¦å¤–ä¸€ç»„ä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span>* p = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    <span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sptr1</span><span class="params">( p)</span></span>;</span><br><span class="line">    <span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sptr2</span><span class="params">( p )</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°ä»£ç ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºä¸¤ä¸ªæ¥è‡ªä¸åŒç»„çš„ shared_ptr æŒ‡å‘åŒä¸€ä¸ªèµ„æºã€‚ä¸‹è¡¨ç»™ä½ å…³äºé”™è¯¯åŸå› çš„å›¾æ™¯ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/sp1.jpg"></p><p>é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå°½é‡ä¸è¦ä»ä¸€ä¸ªè£¸æŒ‡é’ˆ (naked pointer) åˆ›å»º shared_ptrã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() : <span class="built_in">m_sptrB</span>(<span class="literal">nullptr</span>) { };</span><br><span class="line">    ~<span class="built_in">A</span>()</span><br><span class="line">    {</span><br><span class="line">     cout&lt;&lt;<span class="string">" A is destroyed"</span>&lt;&lt;endl;</span><br><span class="line">    }</span><br><span class="line">    shared_ptr&lt;B&gt; m_sptrB;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">B</span>() : <span class="built_in">m_sptrA</span>(<span class="literal">nullptr</span>) { };</span><br><span class="line">    ~<span class="built_in">B</span>()</span><br><span class="line">    {</span><br><span class="line">     cout&lt;&lt;<span class="string">" B is destroyed"</span>&lt;&lt;endl;</span><br><span class="line">    }</span><br><span class="line">    shared_ptr&lt;A&gt; m_sptrA;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">shared_ptr&lt;B&gt; <span class="title">sptrB</span><span class="params">( <span class="keyword">new</span> B )</span></span>;</span><br><span class="line">    <span class="function">shared_ptr&lt;A&gt; <span class="title">sptrA</span><span class="params">( <span class="keyword">new</span> A )</span></span>;</span><br><span class="line">    sptrB-&gt;m_sptrA = sptrA;</span><br><span class="line">    sptrA-&gt;m_sptrB = sptrB;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„ä»£ç äº§ç”Ÿäº†ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼ŒA å¯¹ B æœ‰ä¸€ä¸ª shared_ptr, B å¯¹ A ä¹Ÿæœ‰ä¸€ä¸ª shared_ptr ï¼Œä¸ sptrA å’Œ sptrB å…³è”çš„èµ„æºéƒ½æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå‚è€ƒä¸‹è¡¨ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/sp2.jpg"></p><p>å½“ sptrA å’Œ sptrB ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå®ƒä»¬çš„å¼•ç”¨è®¡æ•°éƒ½åªå‡å°‘åˆ° 1ï¼Œæ‰€ä»¥å®ƒä»¬æŒ‡å‘çš„èµ„æºå¹¶æ²¡æœ‰é‡Šæ”¾ï¼ï¼ï¼ï¼ï¼</p><ul><li>å¦‚æœå‡ ä¸ª shared_ptrs æŒ‡å‘çš„å†…å­˜å—å±äºä¸åŒç»„ï¼Œå°†äº§ç”Ÿé”™è¯¯ã€‚</li><li>å¦‚æœä»ä¸€ä¸ªæ™®é€šæŒ‡é’ˆåˆ›å»ºä¸€ä¸ª shared_ptr è¿˜ä¼šå¼•å‘å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè€ƒè™‘åˆ°åªæœ‰ä¸€ä¸ª shared_ptr æ˜¯ç”± p åˆ›å»ºçš„ï¼Œä»£ç å¯ä»¥å¥½å¥½å·¥ä½œã€‚ä¸‡ä¸€ç¨‹åºå‘˜åœ¨æ™ºèƒ½æŒ‡é’ˆä½œç”¨åŸŸç»“æŸä¹‹å‰åˆ é™¤äº†æ™®é€šæŒ‡é’ˆ pã€‚å¤©å•¦å™œï¼ï¼ï¼åˆæ˜¯ä¸€ä¸ª crashã€‚</li><li>å¾ªç¯å¼•ç”¨ï¼šå¦‚æœå…±äº«æ™ºèƒ½æŒ‡é’ˆå·å…¥äº†å¾ªç¯å¼•ç”¨ï¼Œèµ„æºéƒ½ä¸ä¼šæ­£å¸¸é‡Šæ”¾ã€‚</li></ul><p>ä¸ºäº†è§£å†³å¾ªç¯å¼•ç”¨ï¼ŒC++æä¾›äº†å¦å¤–ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼šweak_ptr</p><h1 id="weak_ptr">Weak_Ptr</h1><h2 id="åŸç†">åŸç†</h2><p>std::weak_ptr è¦ä¸ std::shared_ptr ä¸€èµ·ä½¿ç”¨ã€‚ ä¸€ä¸ª std::weak_ptr å¯¹è±¡çœ‹åšæ˜¯ std::shared_ptr å¯¹è±¡ç®¡ç†çš„èµ„æºçš„è§‚å¯Ÿè€…ï¼Œå®ƒä¸å½±å“å…±äº«èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>å¦‚æœéœ€è¦ä½¿ç”¨ weak_ptr æ­£åœ¨è§‚å¯Ÿçš„èµ„æºï¼Œå¯ä»¥å°† weak_ptr æå‡ä¸º shared_ptr</li><li>å½“ shared_ptr ç®¡ç†çš„èµ„æºè¢«é‡Šæ”¾æ—¶ï¼Œweak_ptr ä¼šè‡ªåŠ¨å˜æˆ nullptr</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Observe</span><span class="params">(std::weak_ptr&lt;<span class="type">int</span>&gt; wptr)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> sptr = wptr.<span class="built_in">lock</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"value: "</span> &lt;&lt; *sptr &lt;&lt; std::endl;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"wptr lock fail"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">std::weak_ptr&lt;<span class="type">int</span>&gt; wptr;</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">auto</span> sptr = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">111</span>);</span><br><span class="line">    wptr = sptr;</span><br><span class="line">    <span class="built_in">Observe</span>(wptr);  <span class="comment">// sptr æŒ‡å‘çš„èµ„æºæ²¡è¢«é‡Šæ”¾ï¼Œwptr å¯ä»¥æˆåŠŸæå‡ä¸º shared_ptr</span></span><br><span class="line">}</span><br><span class="line"><span class="built_in">Observe</span>(wptr);  <span class="comment">// sptr æŒ‡å‘çš„èµ„æºå·²è¢«é‡Šæ”¾ï¼Œwptr æ— æ³•æå‡ä¸º shared_ptr</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer7.jpg"></p><p>å½“ shared_ptr ææ„å¹¶é‡Šæ”¾å…±äº«èµ„æºçš„æ—¶å€™ï¼Œåªè¦ weak_ptr å¯¹è±¡è¿˜å­˜åœ¨ï¼Œæ§åˆ¶å—å°±ä¼šä¿ç•™ï¼Œweak_ptr å¯ä»¥é€šè¿‡æ§åˆ¶å—è§‚å¯Ÿåˆ°å¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer8.jpg"></p><h2 id="enable_shared_from_this">enable_shared_from_this</h2><p>ä¸€ä¸ªç±»çš„æˆå‘˜å‡½æ•°å¦‚ä½•è·å¾—æŒ‡å‘è‡ªèº«ï¼ˆthisï¼‰çš„ shared_ptrï¼Ÿ çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­æœ‰æ²¡æœ‰é—®é¢˜ï¼Ÿ</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> {</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function">std::shared_ptr&lt;Foo&gt; <span class="title">GetSPtr</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">shared_ptr</span>&lt;Foo&gt;(<span class="keyword">this</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> sptr1 = std::<span class="built_in">make_shared</span>&lt;Foo&gt;();</span><br><span class="line"><span class="built_in">assert</span>(sptr1.<span class="built_in">use_count</span>() == <span class="number">1</span>);</span><br><span class="line"><span class="keyword">auto</span> sptr2 = sptr1-&gt;<span class="built_in">GetSPtr</span>();</span><br><span class="line"><span class="built_in">assert</span>(sptr1.<span class="built_in">use_count</span>() == <span class="number">1</span>);</span><br><span class="line"><span class="built_in">assert</span>(sptr2.<span class="built_in">use_count</span>() == <span class="number">1</span>);</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„ä»£ç å…¶å®ä¼šç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„ shared_ptrï¼Œä»–ä»¬çš„æ§åˆ¶å—æ˜¯ç‹¬ç«‹çš„ï¼Œæœ€ç»ˆå¯¼è‡´ä¸€ä¸ª Foo å¯¹è±¡ä¼šè¢« delete ä¸¤æ¬¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer9.jpg"></p><p>æˆå‘˜å‡½æ•°è·å– this çš„ shared_ptr çš„æ­£ç¡®çš„åšæ³•æ˜¯ç»§æ‰¿ std::enable_shared_from_thisã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> : <span class="keyword">public</span> std::enable_shared_from_this&lt;Bar&gt; {</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function">std::shared_ptr&lt;Bar&gt; <span class="title">GetSPtr</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">shared_from_this</span>();</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> sptr1 = std::<span class="built_in">make_shared</span>&lt;Bar&gt;();</span><br><span class="line"><span class="built_in">assert</span>(sptr1.<span class="built_in">use_count</span>() == <span class="number">1</span>);</span><br><span class="line"><span class="keyword">auto</span> sptr2 = sptr1-&gt;<span class="built_in">GetSPtr</span>();</span><br><span class="line"><span class="built_in">assert</span>(sptr1.<span class="built_in">use_count</span>() == <span class="number">2</span>);</span><br><span class="line"><span class="built_in">assert</span>(sptr2.<span class="built_in">use_count</span>() == <span class="number">2</span>);</span><br></pre></td></tr></tbody></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç»§æ‰¿äº† std::enable_shared_from_this çš„å­ç±»ï¼Œæˆå‘˜å˜é‡ä¸­å¢åŠ äº†ä¸€ä¸ªæŒ‡å‘ this çš„ weak_ptrã€‚è¿™ä¸ª weak_ptr åœ¨ç¬¬ä¸€æ¬¡åˆ›å»º shared_ptr çš„æ—¶å€™ä¼šè¢«åˆå§‹åŒ–ï¼ŒæŒ‡å‘ thisã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/smart_pointer10.jpg"></p><p>ä¼¼ä¹ç»§æ‰¿äº† std::enable_shared_from_this çš„ç±»éƒ½è¢«å¼ºåˆ¶å¿…é¡»é€šè¿‡ shared_ptr è¿›è¡Œç®¡ç†ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> b = <span class="keyword">new</span> Bar;</span><br><span class="line"><span class="keyword">auto</span> sptr = b-&gt;<span class="built_in">shared_from_this</span>();</span><br></pre></td></tr></tbody></table></figure><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>ç°åœ¨è®©æˆ‘ä»¬è§è¯†ä¸€ä¸‹ weak_ptr å¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>(  ) : <span class="built_in">m_a</span>(<span class="number">5</span>)  { };</span><br><span class="line">    ~<span class="built_in">A</span>( )</span><br><span class="line">    {</span><br><span class="line">     cout&lt;&lt;<span class="string">" A is destroyed"</span>&lt;&lt;endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">PrintSpB</span><span class="params">( )</span></span>;</span><br><span class="line">    weak_ptr&lt;B&gt; m_sptrB;</span><br><span class="line">    <span class="type">int</span> m_a;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">B</span>(  ) : <span class="built_in">m_b</span>(<span class="number">10</span>) { };</span><br><span class="line">    ~<span class="built_in">B</span>( )</span><br><span class="line">    {</span><br><span class="line">     cout&lt;&lt;<span class="string">" B is destroyed"</span>&lt;&lt;endl;</span><br><span class="line">    }</span><br><span class="line">    weak_ptr&lt;A&gt; m_sptrA;</span><br><span class="line">    <span class="type">int</span> m_b;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">A::PrintSpB</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>( !m_sptrB.<span class="built_in">expired</span>() )</span><br><span class="line">    {</span><br><span class="line">     cout&lt;&lt; m_sptrB.<span class="built_in">lock</span>( )-&gt;m_b&lt;&lt;endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">shared_ptr&lt;B&gt; <span class="title">sptrB</span><span class="params">( <span class="keyword">new</span> B )</span></span>;</span><br><span class="line">    <span class="function">shared_ptr&lt;A&gt; <span class="title">sptrA</span><span class="params">( <span class="keyword">new</span> A )</span></span>;</span><br><span class="line">    sptrB-&gt;m_sptrA = sptrA;</span><br><span class="line">    sptrA-&gt;m_sptrB = sptrB;</span><br><span class="line">    sptrA-&gt;<span class="built_in">PrintSpB</span>( );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/sp3.jpg"></p><h1 id="unique_ptr">unique_ptr</h1><p>unique_ptr éµå¾ªç€ç‹¬å è¯­ä¹‰ã€‚åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œèµ„æºåªèƒ½å”¯ä¸€åœ°è¢«ä¸€ä¸ª unique_ptr å æœ‰ã€‚å½“ unique_ptr ç¦»å¼€ä½œç”¨åŸŸï¼Œæ‰€åŒ…å«çš„èµ„æºè¢«é‡Šæ”¾ã€‚å¦‚æœèµ„æºè¢«å…¶å®ƒèµ„æºé‡å†™äº†ï¼Œä¹‹å‰æ‹¥æœ‰çš„èµ„æºå°†è¢«é‡Šæ”¾ã€‚æ‰€ä»¥å®ƒä¿è¯äº†ä»–æ‰€å…³è”çš„èµ„æºæ€»æ˜¯èƒ½è¢«é‡Šæ”¾ã€‚</p><p><strong>åˆ›å»º</strong> </p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">uptr</span><span class="params">( <span class="keyword">new</span> <span class="type">int</span> )</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å½“åˆ›å»º unique_ptr æ—¶ï¼Œè¿™ä¸€ç»„å¯¹è±¡è¢«è§†ä½œæ¨¡æ¿å‚æ•°çš„éƒ¨åˆ†ã€‚è¿™æ ·ï¼Œç¨‹åºå‘˜å°±ä¸éœ€è¦å†æä¾›ä¸€ä¸ªæŒ‡å®šçš„ææ„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>[ ]&gt; <span class="title">uptr</span><span class="params">( <span class="keyword">new</span> <span class="type">int</span>[<span class="number">5</span>] )</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>å½“æŠŠ unique_ptr èµ‹ç»™å¦å¤–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œèµ„æºçš„æ‰€æœ‰æƒå°±ä¼šè¢«è½¬ç§»ã€‚è®°ä½ unique_ptr ä¸æä¾›å¤åˆ¶è¯­ä¹‰ï¼ˆæ‹·è´èµ‹å€¼å’Œæ‹·è´æ„é€ éƒ½ä¸å¯ä»¥ï¼‰ï¼Œåªæ”¯æŒç§»åŠ¨è¯­ä¹‰ (move semantics)ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9lNDkxOWYxYzNhMjg=">https://www.jianshu.com/p/e4919f1c3a28<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNTA1NTUxNjU=">https://zhuanlan.zhihu.com/p/150555165<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆä¸‰ï¼‰autoã€decltype ä¸ for</title>
      <link href="/2022/Program/CPP11Part3/"/>
      <url>/2022/Program/CPP11Part3/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP11EasyToLearn.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyZWZmYTYzNzY4OTA4MmYwMzA4Nzk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å³å°–æ‹¬å·çš„æ”¹è¿›">å³å°–æ‹¬å·&gt;çš„æ”¹è¿›</h1><p>åœ¨ C++98 ä¸­ï¼Œæœ‰ä¸€æ¡éœ€è¦ç¨‹åºå‘˜è§„é¿çš„è§„åˆ™ï¼šå¦‚æœåœ¨å®ä¾‹åŒ–æ¨¡æ¿çš„æ—¶å€™å‡ºç°äº†è¿ç»­çš„ä¸¤ä¸ªå³å°–æ‹¬å·&gt;ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´éœ€è¦ä¸€ä¸ªç©ºæ ¼æ¥è¿›è¡Œåˆ†éš”ï¼Œä»¥é¿å…å‘ç”Ÿç¼–è¯‘æ—¶çš„é”™è¯¯ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> i&gt; <span class="keyword">class</span> <span class="title class_">X</span>{};</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="keyword">class</span> <span class="title class_">Y</span>{};</span><br><span class="line"></span><br><span class="line">Y&lt;X&lt;<span class="number">1</span>&gt; &gt; x1;   <span class="comment">//ç¼–è¯‘æˆåŠŸ</span></span><br><span class="line">Y&lt;X&lt;<span class="number">2</span>&gt;&gt; x2;   <span class="comment">//ç¼–è¯‘å¤±è´¥</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨ x2 çš„å®šä¹‰ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæŠŠ&gt;&gt;ä¼˜å…ˆè§£æä¸ºå³ç§»ç¬¦å·ã€‚</p><p>C++98 åŒæ ·ä¼šå°†&gt;&gt;ä¼˜å…ˆè§£æä¸ºå³ç§»ã€‚C++11 ä¸­ï¼Œè¿™ç§é™åˆ¶è¢«å–æ¶ˆäº†ã€‚äº‹å®ä¸Šï¼ŒC++11 æ ‡å‡†è¦æ±‚ç¼–è¯‘å™¨æ™ºèƒ½åœ°å»åˆ¤æ–­åœ¨å“ªäº›æƒ…å†µä¸‹&gt;&gt;ä¸æ˜¯å³ç§»ç¬¦å·ã€‚ä½¿ç”¨ C++11 æ ‡å‡†ï¼Œä¸Šè¿°æ‰€ç¤ºä»£ç åˆ™ä¼šæˆåŠŸåœ°é€šè¿‡ç¼–è¯‘ã€‚</p><h1 id="auto-å…³é”®å­—">auto å…³é”®å­—</h1><h2 id="auto-çš„é™åˆ¶">auto çš„é™åˆ¶</h2><p>ä½¿ç”¨ auto çš„æ—¶å€™å¿…é¡»å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ˜¯ auto çš„é™åˆ¶ä¹‹ä¸€ã€‚é‚£ä¹ˆï¼Œé™¤æ­¤ä»¥å¤–ï¼Œauto è¿˜æœ‰å“ªäº›å…¶å®ƒçš„é™åˆ¶å‘¢ï¼Ÿ</p><ul><li>auto ä¸èƒ½åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨ è¿™ä¸ªåº”è¯¥å¾ˆå®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰å‡½æ•°çš„æ—¶å€™åªæ˜¯å¯¹å‚æ•°è¿›è¡Œäº†å£°æ˜ï¼ŒæŒ‡æ˜äº†å‚æ•°çš„ç±»å‹ï¼Œä½†å¹¶æ²¡æœ‰ç»™å®ƒèµ‹å€¼ï¼Œåªæœ‰åœ¨å®é™…è°ƒç”¨å‡½æ•°çš„æ—¶å€™æ‰ä¼šç»™å‚æ•°èµ‹å€¼ï¼›è€Œ auto è¦æ±‚å¿…é¡»å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™æ˜¯çŸ›ç›¾çš„</li><li>auto ä¸èƒ½ä½œç”¨äºç±»çš„éé™æ€æˆå‘˜å˜é‡ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ static å…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡ï¼‰ä¸­</li><li>auto å…³é”®å­—ä¸èƒ½å®šä¹‰æ•°ç»„</li><li>auto ä¸èƒ½ä½œç”¨äºæ¨¡æ¿å‚æ•°</li></ul><h2 id="auto-çš„åº”ç”¨">auto çš„åº”ç”¨</h2><ul><li>ä½¿ç”¨ auto å®šä¹‰è¿­ä»£å™¨</li><li>auto ç”¨äºæ³›å‹ç¼–ç¨‹</li></ul><h1 id="decltype-å…³é”®å­—">decltype å…³é”®å­—</h1><h2 id="decltype-ä¸-auto-çš„åŒºåˆ«">decltype ä¸ auto çš„åŒºåˆ«</h2><p>æ—¢ç„¶å·²ç»æœ‰äº† auto å…³é”®å­—ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ decltype å…³é”®å­—å‘¢ï¼Ÿå› ä¸º auto å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„è‡ªåŠ¨ç±»å‹æ¨å¯¼åœºæ™¯ï¼Œåœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ auto ç”¨èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç”šè‡³å‹æ ¹æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥ decltype å…³é”®å­—ä¹Ÿè¢«å¼•å…¥åˆ° C++11 ä¸­ã€‚</p><p>auto å’Œ decltype å…³é”®å­—éƒ½å¯ä»¥è‡ªåŠ¨æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ï¼Œä½†å®ƒä»¬çš„ç”¨æ³•æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> varname = value;</span><br><span class="line"><span class="keyword">decltype</span>(exp) varname = value;</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ï¼Œvarname è¡¨ç¤ºå˜é‡åï¼Œvalue è¡¨ç¤ºèµ‹ç»™å˜é‡çš„å€¼ï¼Œexp è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚</p><p>auto æ ¹æ®=å³è¾¹çš„åˆå§‹å€¼ value æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ï¼Œè€Œ decltype æ ¹æ® exp è¡¨è¾¾å¼æ¨å¯¼å‡ºå˜é‡çš„ç±»å‹ï¼Œè·Ÿ=å³è¾¹çš„ value æ²¡æœ‰å…³ç³»ã€‚</p><p>å¦å¤–ï¼Œauto è¦æ±‚å˜é‡å¿…é¡»åˆå§‹åŒ–ï¼Œè€Œ decltype ä¸è¦æ±‚ã€‚è¿™å¾ˆå®¹æ˜“ç†è§£ï¼Œauto æ˜¯æ ¹æ®å˜é‡çš„åˆå§‹å€¼æ¥æ¨å¯¼å‡ºå˜é‡ç±»å‹çš„ï¼Œå¦‚æœä¸åˆå§‹åŒ–ï¼Œå˜é‡çš„ç±»å‹ä¹Ÿå°±æ— æ³•æ¨å¯¼äº†ã€‚decltype å¯ä»¥å†™æˆä¸‹é¢çš„å½¢å¼ï¼š decltype(exp) varname;</p><blockquote><p>åŸåˆ™ä¸Šè®²ï¼Œexp å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¡¨è¾¾å¼ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„å¤æ‚çš„å½¢å¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»è¦ä¿è¯ exp çš„ç»“æœæ˜¯æœ‰ç±»å‹çš„ï¼Œä¸èƒ½æ˜¯ voidï¼›ä¾‹å¦‚ï¼Œå½“ exp è°ƒç”¨ä¸€ä¸ªè¿”å›å€¼ç±»å‹ä¸º void çš„å‡½æ•°æ—¶ï¼Œexp çš„ç»“æœä¹Ÿæ˜¯ void ç±»å‹ï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</p></blockquote><h2 id="decltype-æ¨å¯¼è§„åˆ™">decltype æ¨å¯¼è§„åˆ™</h2><ul><li>å¦‚æœ exp æ˜¯ä¸€ä¸ªä¸è¢«æ‹¬å· ( ) åŒ…å›´çš„è¡¨è¾¾å¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç±»æˆå‘˜è®¿é—®è¡¨è¾¾å¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå•ç‹¬çš„å˜é‡ï¼Œé‚£ä¹ˆ decltype(exp) çš„ç±»å‹å°±å’Œ exp ä¸€è‡´ï¼Œè¿™æ˜¯æœ€æ™®éæœ€å¸¸è§çš„æƒ…å†µã€‚</li><li>å¦‚æœ exp æ˜¯å‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆ decltype(exp) çš„ç±»å‹å°±å’Œå‡½æ•°è¿”å›å€¼çš„ç±»å‹ä¸€è‡´ã€‚</li><li>å¦‚æœ exp æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œæˆ–è€…è¢«æ‹¬å· ( ) åŒ…å›´ï¼Œé‚£ä¹ˆ decltype(exp) çš„ç±»å‹å°±æ˜¯ exp çš„å¼•ç”¨ï¼›å‡è®¾ exp çš„ç±»å‹ä¸º Tï¼Œé‚£ä¹ˆ decltype(exp) çš„ç±»å‹å°±æ˜¯ T&amp;ã€‚</li></ul><h2 id="decltype-çš„å®é™…åº”ç”¨">decltype çš„å®é™…åº”ç”¨</h2><p>auto çš„è¯­æ³•æ ¼å¼æ¯” decltype ç®€å•ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬çš„ç±»å‹æ¨å¯¼ä¸­ï¼Œä½¿ç”¨ auto æ¯”ä½¿ç”¨ decltype æ›´åŠ æ–¹ä¾¿ï¼Œæœ¬èŠ‚ä»…æ¼”ç¤ºåªèƒ½ä½¿ç”¨ decltype çš„æƒ…å½¢ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œauto åªèƒ½ç”¨äºç±»çš„é™æ€æˆå‘˜ï¼Œä¸èƒ½ç”¨äºç±»çš„éé™æ€æˆå‘˜ï¼ˆæ™®é€šæˆå‘˜ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ¨å¯¼éé™æ€æˆå‘˜çš„ç±»å‹ï¼Œè¿™ä¸ªæ—¶å€™å°±å¿…é¡»ä½¿ç”¨ decltype äº†ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ¿çš„å®šä¹‰ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(T&amp; container)</span> </span>{</span><br><span class="line">        m_it = container.<span class="built_in">begin</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">typename</span> T::iterator m_it;  <span class="comment">//æ³¨æ„è¿™é‡Œ</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">const</span> vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">    Base&lt;<span class="type">const</span> vector&lt;<span class="type">int</span>&gt;&gt; obj;</span><br><span class="line">    obj.<span class="built_in">func</span>(v);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å•ç‹¬çœ‹ Base ç±»ä¸­ m_it æˆå‘˜çš„å®šä¹‰ï¼Œå¾ˆéš¾çœ‹å‡ºä¼šæœ‰ä»€ä¹ˆé”™è¯¯ï¼Œä½†åœ¨ä½¿ç”¨ Base ç±»çš„æ—¶å€™ï¼Œå¦‚æœä¼ å…¥ä¸€ä¸ª const ç±»å‹çš„å®¹å™¨ï¼Œç¼–è¯‘å™¨é©¬ä¸Šå°±ä¼šå¼¹å‡ºä¸€å¤§å †é”™è¯¯ä¿¡æ¯ã€‚åŸå› å°±åœ¨äºï¼ŒT::iterator å¹¶ä¸èƒ½åŒ…æ‹¬æ‰€æœ‰çš„è¿­ä»£å™¨ç±»å‹ï¼Œå½“ T æ˜¯ä¸€ä¸ª const å®¹å™¨æ—¶ï¼Œåº”å½“ä½¿ç”¨ const_iteratorã€‚</p><p>è¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¹‹å‰çš„ C++98/03 ç‰ˆæœ¬ä¸‹åªèƒ½æƒ³åŠæ³•æŠŠ const ç±»å‹çš„å®¹å™¨ç”¨æ¨¡æ¿ç‰¹åŒ–å•ç‹¬å¤„ç†ï¼Œå¢åŠ äº†ä¸å°‘å·¥ä½œé‡ï¼Œçœ‹èµ·æ¥ä¹Ÿéå¸¸æ™¦æ¶©ã€‚ä½†æ˜¯æœ‰äº† C++11 çš„ decltype å…³é”®å­—ï¼Œå°±å¯ä»¥ç›´æ¥è¿™æ ·å†™ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(T&amp; container)</span> </span>{</span><br><span class="line">        m_it = container.<span class="built_in">begin</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">decltype</span>(<span class="built_in">T</span>().<span class="built_in">begin</span>()) m_it;  <span class="comment">//æ³¨æ„è¿™é‡Œ</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h1 id="åŸºäºèŒƒå›´çš„-for-å¾ªç¯">åŸºäºèŒƒå›´çš„ for å¾ªç¯</h1><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> stdï¼›</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> arr[<span class="number">5</span>]={<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>};</span><br><span class="line">    <span class="type">int</span> * p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p= arr; p &lt; arr +<span class="built_in">sizeof</span>(arr)/<span class="built_in">sizeof</span>(arr[<span class="number">0</span>]); ++p){</span><br><span class="line">        *p *= <span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span>(p =arr; p &lt; arr +<span class="built_in">sizeof</span>(arr)/<span class="built_in">sizeof</span>(arr[<span class="number">0</span>]); ++p){</span><br><span class="line">        cout &lt; *p &lt; <span class="string">"\t"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æŒ‡é’ˆ p æ¥éå†æ•°ç»„ arr ä¸­çš„å†…å®¹ï¼Œä¸¤ä¸ªå¾ªç¯åˆ†åˆ«å®Œæˆäº†æ¯ä¸ªå…ƒç´ è‡ªä¹˜ä»¥ 2 å’Œæ‰“å°å·¥ä½œã€‚è€Œ C++çš„æ ‡å‡†æ¨¡æ¿åº“ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰¾åˆ°å½¢å¦‚ for_each çš„æ¨¡æ¿å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ for_each æ¥å®Œæˆä¸Šè¿°ä»£ç ä¸­çš„å·¥ä½œï¼Œä»£ç çœ‹èµ·æ¥ä¼šæ˜¯è¿™ä¸ªæ ·å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std:</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">action1</span><span class="params">(<span class="type">int</span> &amp; e)</span> </span>{e*=<span class="number">2</span>;};</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">action2</span><span class="params">(<span class="type">int</span> &amp;e)</span> </span>{cout &lt;&lt; e &lt;&lt; <span class="string">'\t'</span>};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> arr[<span class="number">5</span>]={<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>}</span><br><span class="line">    for_each(arr, arr + <span class="built_in">sizeof</span>(arr)/<span class="built_in">sizeof</span>(arr[<span class="number">0</span>]), action1);</span><br><span class="line">    for_each(arr, arr + <span class="built_in">sizeof</span>(arr)/<span class="built_in">sizeof</span>(arr[<span class="number">0</span>]), action2);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>for_each ä½¿ç”¨äº†è¿­ä»£å™¨çš„æ¦‚å¿µï¼Œå…¶è¿­ä»£å™¨å°±æ˜¯æŒ‡é’ˆï¼Œè¿­ä»£å™¨å†…å«äº†è‡ªå¢æ“ä½œã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹åŸºäºèŒƒå›´çš„ for å¾ªç¯æ”¹å†™çš„ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> arr[<span class="number">5</span>] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>};</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> &amp;e: arr)</span><br><span class="line">        e *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> &amp;e: arr)</span><br><span class="line">        cout &lt;&lt; e &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°ä»£ç å°±æ˜¯ä¸€ä¸ªåŸºäºèŒƒå›´çš„ for å¾ªç¯çš„å®ä¾‹ã€‚for å¾ªç¯åçš„æ‹¬å·ç”±å†’å·â€œï¼šâ€åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯èŒƒå›´å†…ç”¨äºè¿­ä»£çš„å˜é‡ï¼Œç¬¬äºŒéƒ¨åˆ†åˆ™è¡¨ç¤ºå°†è¢«è¿­ä»£çš„èŒƒå›´ã€‚è¿™æ ·ä¸€æ¥ï¼Œéå†æ•°ç»„å’Œ STL å®¹å™¨å°±éå¸¸å®¹æ˜“äº†ã€‚</p><p>å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œæ˜¯å¦èƒ½å¤Ÿä½¿ç”¨åŸºäºèŒƒå›´çš„ for å¾ªç¯ï¼Œå¿…é¡»ä¾èµ–äºä¸€äº›æ¡ä»¶ã€‚é¦–å…ˆï¼Œå°±æ˜¯ for å¾ªç¯è¿­ä»£çš„èŒƒå›´æ˜¯å¯ç¡®å®šçš„ã€‚å¯¹äºç±»æ¥è¯´ï¼Œå¦‚æœè¯¥ç±»æœ‰ begin å’Œ end å‡½æ•°ï¼Œé‚£ä¹ˆ begin å’Œ end ä¹‹é—´å°±æ˜¯ for å¾ªç¯è¿­ä»£çš„èŒƒå›´ã€‚å¯¹äºæ•°ç»„è€Œè¨€ï¼Œå°±æ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ é—´çš„èŒƒå›´ã€‚å…¶æ¬¡ï¼ŒåŸºäºèŒƒå›´çš„ for å¾ªç¯è¿˜è¦æ±‚è¿­ä»£çš„å¯¹è±¡å®ç°++å’Œ=ç­‰æ“ä½œç¬¦ã€‚å¯¹äºæ ‡å‡†åº“ä¸­çš„å®¹å™¨ï¼Œå¦‚ stringã€arayã€ vectorã€ dequeã€itã€ queueã€mapã€set ç­‰ï¼Œä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºæ ‡å‡†åº“æ€»æ˜¯ä¿è¯å…¶å®¹å™¨å®šä¹‰äº†ç›¸å…³çš„æ“ä½œã€‚æ™®é€šçš„å·²çŸ¥é•¿åº¦çš„æ•°ç»„ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ã€‚è€Œç”¨æˆ·è‡ªå·±å†™çš„ç±»ï¼Œåˆ™éœ€è¦è‡ªè¡Œæä¾›ç›¸å…³æ“ä½œã€‚ç›¸åï¼Œå¦‚æœæˆ‘ä»¬æ•°ç»„å¤§å°ä¸èƒ½ç¡®å®šçš„è¯ï¼Œæ˜¯ä¸èƒ½å¤Ÿä½¿ç”¨åŸºäºèŒƒå›´çš„ for å¾ªç¯çš„ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL2MuYmlhbmNoZW5nLm5ldC92aWV3LzY5ODQuaHRtbA==">http://c.biancheng.net/view/6984.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL2MuYmlhbmNoZW5nLm5ldC92aWV3LzcxNTEuaHRtbA==">http://c.biancheng.net/view/7151.html<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆäºŒï¼‰å³å€¼å¼•ç”¨ä¸ POD</title>
      <link href="/2022/Program/CPP11Part2/"/>
      <url>/2022/Program/CPP11Part2/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP11GeneralPurposeAndSpecialPurposeAtTheEnd.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyZTBlYTdkOWMwODA3NmQxMDkzMGE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ç»§æ‰¿æ„é€ å‡½æ•°">ç»§æ‰¿æ„é€ å‡½æ•°</h1><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> i){};</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">double</span> d, <span class="type">int</span> i) {};</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">float</span> f, <span class="type">int</span> i, <span class="type">const</span> <span class="type">char</span>* c){};</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> : A</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">B</span>(<span class="type">int</span> i): <span class="built_in">A</span>(i){};</span><br><span class="line">    <span class="built_in">B</span>(<span class="type">double</span> d, <span class="type">int</span> i): <span class="built_in">A</span>(d, i){};</span><br><span class="line">    <span class="built_in">B</span>(<span class="type">float</span> f, <span class="type">int</span> i, <span class="type">const</span> <span class="type">char</span>*c): <span class="built_in">A</span>(f, i, c)(){};</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Extrainterface</span><span class="params">()</span></span>{};</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç»§æ‰¿äº A çš„æ´¾ç”Ÿç±» B å®é™…ä¸Šåªæ˜¯æ·»åŠ äº†ä¸€ä¸ªæ¥å£ Extralnterfaceï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨æ„é€  B çš„æ—¶å€™æƒ³è¦æ‹¥æœ‰ A è¿™æ ·å¤šçš„æ„é€ æ–¹æ³•çš„è¯ï¼Œå°±å¿…é¡»ä¸€â€œé€ä¼ â€å„ä¸ªæ¥å£ã€‚è¿™æ— ç–‘æ˜¯ç›¸å½“ä¸æ–¹ä¾¿çš„ã€‚äº‹å®ä¸Šï¼Œåœ¨ C++ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªå¥½ç”¨çš„è§„åˆ™ï¼Œå­ç±»å¯ä»¥é€šè¿‡ä½¿ç”¨ using å£°æ˜æ¥å£°æ˜ç»§æ‰¿åŸºç±»çš„æ„é€ å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> i){};</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">double</span> d, <span class="type">int</span> i) {};</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">float</span> f, <span class="type">int</span> i, <span class="type">const</span> <span class="type">char</span>* c){};</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">};</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> : A</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">using</span> A::A;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Extrainterface</span><span class="params">()</span></span>{};</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è€Œæœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¼šé‡åˆ°ç»§æ‰¿æ„é€ å‡½æ•°â€œå†²çªâ€çš„æƒ…å†µã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨æ´¾ç”Ÿç±»æ‹¥æœ‰å¤šä¸ªåŸºç±»çš„æ—¶å€™ã€‚å¤šä¸ªåŸºç±»ä¸­çš„éƒ¨åˆ†æ„é€ å‡½æ•°å¯èƒ½å¯¼è‡´æ´¾ç”Ÿç±»ä¸­çš„ç»§æ‰¿æ„é€ å‡½æ•°çš„å‡½æ•°åã€å‚æ•°ï¼ˆæœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿç§°å…¶ä¸ºå‡½æ•°ç­¾åï¼‰éƒ½ç›¸åŒï¼Œé‚£ä¹ˆç»§æ‰¿ç±»ä¸­çš„å†²çªçš„ç»§æ‰¿æ„é€ å‡½æ•°å°†å¯¼è‡´ä¸åˆæ³•çš„æ´¾ç”Ÿç±»ä»£ç ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> {<span class="built_in">A</span>(<span class="type">int</span>){}};</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> {<span class="built_in">B</span>(<span class="type">int</span>){}};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">C</span>: A, B {</span><br><span class="line">    <span class="keyword">using</span> A::A;</span><br><span class="line">    <span class="keyword">using</span> B::B;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>A å’Œ B çš„æ„é€ å‡½æ•°ä¼šå¯¼è‡´ C ä¸­é‡å¤å®šä¹‰ç›¸åŒç±»å‹çš„ç»§æ‰¿æ„é€ å‡½æ•°ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡æ˜¾å¼å®šä¹‰ç»§æ‰¿ç±»çš„å†²çªçš„æ„é€ å‡½æ•°ï¼Œé˜»æ­¢éšå¼ç”Ÿæˆç›¸åº”çš„ç»§æ‰¿æ„é€ å‡½æ•°æ¥è§£å†³å†²çªã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">C</span>: A, B {</span><br><span class="line">    <span class="keyword">using</span> A::A;</span><br><span class="line">    <span class="keyword">using</span> B::B;</span><br><span class="line">    <span class="built_in">C</span>(<span class="type">int</span>){};</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­çš„æ„é€ å‡½æ•° C(int) å°±å¾ˆå¥½åœ°è§£å†³äº†ç»§æ‰¿æ„é€ å‡½æ•°çš„å†²çªé—®é¢˜ã€‚</p><h1 id="å§”æ´¾æ„é€ å‡½æ•°">å§”æ´¾æ„é€ å‡½æ•°</h1><p>ä¸ç»§æ‰¿æ„é€ å‡½æ•°ç±»ä¼¼çš„ï¼Œå§”æ´¾æ„é€ å‡½æ•°ä¹Ÿæ˜¯ C++11 ä¸­å¯¹ C++çš„æ„é€ å‡½æ•°çš„ä¸€é¡¹æ”¹è¿›å…¶ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†å‡å°‘ç¨‹åºå‘˜ä¹¦å†™æ„é€ å‡½æ•°çš„æ—¶é—´ã€‚é€šè¿‡å§”æ´¾å…¶ä»–æ„é€ å‡½æ•°ï¼Œå¤šæ„é€ å‡½æ•°çš„ç±»ç¼–å†™å°†æ›´åŠ å®¹æ˜“ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Info</span> {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Info</span>(): <span class="built_in">type</span>(<span class="number">1</span>), <span class="built_in">name</span>(a){<span class="built_in">Initrest</span>()};</span><br><span class="line">    <span class="built_in">Info</span>(<span class="type">int</span> i): <span class="built_in">type</span>(i), <span class="built_in">name</span>(a){<span class="built_in">Initrest</span>()};</span><br><span class="line">    <span class="built_in">Info</span>(<span class="type">char</span> e): <span class="built_in">type</span>(<span class="number">1</span>), <span class="built_in">name</span>(e){<span class="built_in">Initrest</span>()};</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">void</span> Initrestï¼ˆï¼‰{<span class="comment">/*å…¶ä»–åˆå§‹åŒ–*/</span> }</span><br><span class="line">    <span class="type">int</span> type;</span><br><span class="line">    <span class="type">char</span> name;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ª Info çš„è‡ªå®šä¹‰ç±»å‹ã€‚è¯¥ç±»å‹æ‹¥æœ‰ 2 ä¸ªæˆå‘˜å˜é‡ä»¥åŠ 3 ä¸ªæ„é€ å‡½æ•°ã€‚è¿™é‡Œçš„ 3 ä¸ªæ„é€ å‡½æ•°éƒ½å£°æ˜äº†åˆå§‹åŒ–åˆ—è¡¨æ¥åˆå§‹åŒ–æˆå‘˜ type å’Œ nameï¼Œå¹¶ä¸”éƒ½è°ƒç”¨äº†ç›¸åŒçš„å‡½æ•° Initrestã€‚å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†åˆå§‹åŒ–åˆ—è¡¨æœ‰çš„ä¸åŒï¼Œè€Œå…¶ä»–çš„éƒ¨åˆ†ï¼Œ3 ä¸ªæ„é€ å‡½æ•°åŸºæœ¬ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼Œå› æ­¤å…¶ä»£ç å­˜åœ¨ç€å¾ˆå¤šé‡å¤ã€‚</p><p>åœ¨ C++11 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å§”æ´¾æ„é€ å‡½æ•°æ¥è¾¾åˆ°æœŸæœ›çš„æ•ˆæœã€‚æ›´å…·ä½“çš„ï¼ŒC++11 ä¸­çš„å§”æ´¾æ„é€ å‡½æ•°æ˜¯åœ¨æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨ä½ç½®è¿›è¡Œæ„é€ çš„ã€å§”æ´¾çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Info</span> {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Info</span>(){<span class="built_in">Initrest</span>();};</span><br><span class="line">    <span class="built_in">Info</span>(<span class="type">int</span> i): <span class="built_in">Info</span>(){type =i;};</span><br><span class="line">    <span class="built_in">Info</span>(<span class="type">char</span> e): <span class="built_in">Info</span>(){name = e;};</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Initrest</span><span class="params">()</span></span>{<span class="comment">/*å…¶ä»–åˆå§‹åŒ–*/</span>};</span><br><span class="line">    <span class="type">int</span> type{<span class="number">1</span>};</span><br><span class="line">    <span class="type">char</span> name{<span class="string">'a'</span>};</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨ Infoï¼ˆintï¼‰å’Œ Infoï¼ˆcharï¼‰çš„åˆå§‹åŒ–åˆ—è¡¨çš„ä½ç½®ï¼Œè°ƒç”¨äº†â€œåŸºå‡†ç‰ˆæœ¬â€çš„æ„é€ å‡½æ•° Infoã€‚è¿™é‡Œæˆ‘ä»¬ä¸ºäº†åŒºåˆ†è¢«è°ƒç”¨è€…å’Œè°ƒç”¨è€…ï¼Œç§°åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­è°ƒç”¨â€œåŸºå‡†ç‰ˆæœ¬â€çš„æ„é€ å‡½æ•°ä¸ºå§”æ´¾æ„é€ å‡½æ•°ï¼ˆ delegating constructorï¼‰ï¼Œè€Œè¢«è°ƒç”¨çš„åŸºå‡†ç‰ˆæœ¬â€åˆ™ä¸ºç›®æ ‡æ„é€ å‡½æ•°ï¼ˆ target constructorï¼‰ã€‚åœ¨ C++11 ä¸­ï¼Œæ‰€è°“å§”æ´¾æ„é€ ï¼Œå°±æ˜¯æŒ‡å§”æ´¾å‡½æ•°å°†æ„é€ çš„ä»»åŠ¡å§”æ´¾ç»™äº†ç›®æ ‡æ„é€ å‡½æ•°æ¥å®Œæˆè¿™æ ·ä¸€ç§ç±»æ„é€ çš„æ–¹å¼ã€‚</p><h1 id="å³å€¼å¼•ç”¨ç§»åŠ¨è¯­ä¹‰å’Œå®Œç¾è½¬å‘">å³å€¼å¼•ç”¨ï¼šç§»åŠ¨è¯­ä¹‰å’Œå®Œç¾è½¬å‘</h1><h2 id="c11-çš„å·¦å€¼å’Œå³å€¼çš„æ¦‚å¿µ">C++11 çš„å·¦å€¼å’Œå³å€¼çš„æ¦‚å¿µ</h2><p>åœ¨ c++ä¸­ï¼Œä¸€ä¸ªå€¼è¦ä¹ˆæ˜¯å³å€¼ï¼Œè¦ä¹ˆæ˜¯å·¦å€¼ï¼Œå·¦å€¼æ˜¯æŒ‡è¡¨è¾¾å¼ç»“æŸåä¾ç„¶å­˜åœ¨çš„æŒä¹…åŒ–å¯¹è±¡ï¼Œå³å€¼æ˜¯æŒ‡è¡¨è¾¾å¼ç»“æŸæ—¶å°±ä¸å†å­˜åœ¨çš„ä¸´æ—¶å¯¹è±¡ã€‚æ‰€æœ‰çš„å…·åå˜é‡æˆ–è€…å¯¹è±¡éƒ½æ˜¯å·¦å€¼ï¼Œè€Œå³å€¼ä¸å…·åã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> lvalue = <span class="number">1</span>; <span class="comment">// lvalue ä¸ºå·¦å€¼ï¼Œ 1 ä¸ºå³å€¼</span></span><br></pre></td></tr></tbody></table></figure><h2 id="å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨">å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨</h2><ul><li>å·¦å€¼å¼•ç”¨ï¼šå¼•ç”¨ä¸€ä¸ªå¯¹è±¡</li><li>å³å€¼å¼•ç”¨ï¼šå°±æ˜¯å¿…é¡»ç»‘å®šåˆ°å³å€¼çš„å¼•ç”¨ï¼ŒC++11 ä¸­å³å€¼å¼•ç”¨å¯ä»¥å®ç°â€œç§»åŠ¨è¯­ä¹‰â€ï¼Œé€šè¿‡ &amp;&amp; è·å¾—å³å€¼å¼•ç”¨ã€‚å³å€¼å¼•ç”¨ï¼Œå¯ä»¥å»¶é•¿å³å€¼çš„ç”Ÿå‘½æœŸï¼Œæ¯”å¦‚ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>&amp;&amp; i = <span class="number">123</span>;</span><br><span class="line"><span class="type">int</span>&amp;&amp; j = std::<span class="built_in">move</span>(i);</span><br><span class="line"><span class="type">int</span>&amp;&amp; k = i;        <span class="comment">//ç¼–è¯‘ä¸è¿‡ï¼Œè¿™é‡Œ i æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå³å€¼å¼•ç”¨åªèƒ½å¼•ç”¨å³å€¼</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œæ›´æ·±å…¥çš„ä½“ä¼šå·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨çš„åŒºåˆ«ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">int</span>&amp;&amp; j = i++; <span class="comment">// å³å€¼ i å…ˆèµ‹å€¼ï¼Œç„¶ååš+1 è¿ç®—ï¼Œè¿ç®—ç»“æœå­˜åœ¨æ ˆä¸­</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; k = ++i; <span class="comment">// å·¦å€¼ å…ˆåš+1 è¿ç®—ï¼Œ+1 çš„ç»“æœèµ‹å€¼åˆ° i å˜é‡ä¸­ï¼Œi æ˜¯ä¸€ä¸ªå·¦å€¼</span></span><br><span class="line"><span class="type">int</span>&amp; m = i++;</span><br><span class="line"><span class="type">int</span>&amp; l = ++i;</span><br><span class="line"></span><br><span class="line">move.cpp: In function â€˜<span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>â€™:</span></span><br><span class="line"><span class="function">move.cpp:<span class="number">72</span>:<span class="number">14</span>: error: cannot bind â€˜intâ€™ lvalue to â€˜int&amp;&amp;â€™</span></span><br><span class="line"><span class="function">  int&amp;&amp; k =</span> ++i;</span><br><span class="line">              ^</span><br><span class="line">move.cpp:<span class="number">73</span>:<span class="number">15</span>: error: invalid initialization of non-<span class="type">const</span> reference of type â€˜<span class="type">int</span>&amp;â€™ from an rvalue of type â€˜<span class="type">int</span>â€™</span><br><span class="line">     <span class="type">int</span>&amp; m = i++;</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸ºä»€ä¹ˆéœ€è¦å³å€¼å¼•ç”¨">ä¸ºä»€ä¹ˆéœ€è¦å³å€¼å¼•ç”¨</h2><p>C++å¼•å…¥å³å€¼å¼•ç”¨ä¹‹åï¼Œå¯ä»¥é€šè¿‡å³å€¼å¼•ç”¨ï¼Œå……åˆ†ä½¿ç”¨ä¸´æ—¶å˜é‡ï¼Œæˆ–è€…å³å°†ä¸ä½¿ç”¨çš„å˜é‡å³å³å€¼çš„èµ„æºï¼Œå‡å°‘ä¸å¿…è¦çš„æ‹·è´ï¼Œæé«˜æ•ˆç‡ã€‚å¦‚ä¸‹ä»£ç ï¼Œå‡ä¼šäº§ç”Ÿä¸´æ—¶å˜é‡ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RValue</span> {</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function">RValue <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RValue</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(RValue)</span></span>{}</span><br></pre></td></tr></tbody></table></figure><p>ä¸ºäº†å……åˆ†åˆ©ç”¨å³å€¼çš„èµ„æºï¼Œå‡å°‘ä¸å¿…è¦çš„æ‹·è´ï¼ŒC++11 å¼•å…¥äº†å³å€¼å¼•ç”¨ (&amp;&amp;)ï¼Œç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç§»åŠ¨å¤åˆ¶è¿ç®—ç¬¦ä»¥åŠ std::moveã€‚</p><h2 id="stdmove">std::move</h2><h3 id="å³å€¼å¼•ç”¨-ç§»åŠ¨æ„é€ å‡½æ•°ç§»åŠ¨å¤åˆ¶è¿ç®—ç¬¦ä»¥åŠ-stdmove">å³å€¼å¼•ç”¨ (&amp;&amp;)ï¼Œç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç§»åŠ¨å¤åˆ¶è¿ç®—ç¬¦ä»¥åŠ std::move</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RValue</span> {</span><br><span class="line"><span class="built_in">RValue</span>():<span class="built_in">sources</span>(<span class="string">"hello!!!"</span>){}</span><br><span class="line"><span class="built_in">RValue</span>(RValue&amp;&amp; a) {</span><br><span class="line">sources = std::<span class="built_in">move</span>(a.sources);</span><br><span class="line">cout&lt;&lt;<span class="string">"&amp;&amp; RValue"</span>&lt;&lt;endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">RValue</span>(<span class="type">const</span> RValue&amp; a) {</span><br><span class="line">sources = a.sources;</span><br><span class="line">cout&lt;&lt;<span class="string">"&amp; RValue"</span>&lt;&lt;endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> RValue&amp;&amp; a) {</span><br><span class="line">sources = std::<span class="built_in">move</span>(a.sources);</span><br><span class="line">cout&lt;&lt;<span class="string">"&amp;&amp; =="</span>&lt;&lt;endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> RValue&amp; a) {</span><br><span class="line">sources = a.sources;</span><br><span class="line">cout&lt;&lt;<span class="string">"&amp; =="</span>&lt;&lt;endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">string sources;;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function">RValue <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    RValue a;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(RValue)</span></span>{}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">RValue a = <span class="built_in">get</span>();</span><br><span class="line">    cout&lt;&lt;<span class="string">"---------------"</span>&lt;&lt;endl;</span><br><span class="line"><span class="built_in">put</span>(<span class="built_in">RValue</span>());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸è¿‡ï¼Œå½“è¿è¡Œçš„æ—¶å€™å´å‘ç°æ²¡æœ‰ä»»ä½•è¾“å‡º</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g++ move.cpp -std=c++11 -o move</span><br><span class="line">./move</span><br><span class="line">---------------</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ˜¯å› ä¸ºï¼Œç¼–è¯‘å™¨åšäº†ä¼˜åŒ–ï¼Œç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š-fno-elide-constructorsï¼Œå»æ‰ä¼˜åŒ–</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g++ move.cpp -std=c++11 -fno-elide-constructors -o move</span><br><span class="line"> ./move</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">---------------</span><br><span class="line">&amp;&amp; RValue</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨æ²¡æœ‰åŠ -fno-elide-constructors é€‰é¡¹æ—¶ï¼Œç¼–è¯‘å™¨åšäº†ä¼˜åŒ–ï¼Œæ²¡æœ‰ä¸´æ—¶å˜é‡çš„ç”Ÿæˆã€‚åœ¨åŠ äº†-fno-elide-constructors é€‰é¡¹æ—¶ï¼Œget äº§ç”Ÿäº†ä¸¤æ¬¡ä¸´æ—¶å˜é‡ï¼Œput ç”Ÿæˆäº†ä¸€æ¬¡ä¸´æ—¶å˜é‡ã€‚</p><p>å°† get å‡½æ•°ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RValue <span class="function"><span class="title">get</span></span>() {</span><br><span class="line">RValue a;</span><br><span class="line"><span class="built_in">return</span> std::move(RValue());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">g++ move.cpp -std=c++11 -o move</span><br><span class="line"> ./move</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line">//åŠ ç¼–è¯‘é€‰é¡¹</span><br><span class="line">g++ move.cpp -std=c++11 -fno-elide-constructors -o move</span><br><span class="line"> ./move</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">---------------</span><br><span class="line">&amp;&amp; RValue</span><br></pre></td></tr></tbody></table></figure><p>åªæ˜¯ç®€å•çš„ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œstd::move(a)ï¼Œåœ¨ç¼–è¯‘å™¨åšäº†ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œç”¨äº† std::moveï¼Œåè€Œå¤šåšäº†ä¸€æ¬¡æ‹·è´ã€‚</p><p>å…¶å®ï¼ŒRValue å¦‚æœåœ¨æ²¡æœ‰å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œé‡å¤ä¸Šé¢çš„æ“ä½œï¼Œç”Ÿæˆä¸´æ—¶å˜é‡çš„æ¬¡æ•°è¿˜æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ï¼Œè°ƒç”¨çš„æ—¶æ‹·è´æ„é€ å‡½æ•°äº†è€Œå·²ã€‚</p><p>é€šè¿‡ get å‡½æ•°å¯ä»¥çŸ¥é“ï¼Œä¹±ç”¨ std::move åœ¨ç¼–è¯‘å™¨å¼€å¯æ„é€ å‡½æ•°ä¼˜åŒ–çš„åœºæ™¯ä¸‹åè€Œå¢åŠ äº†ä¸å¿…è¦çš„æ‹·è´ã€‚é‚£ä¹ˆï¼Œstd::move åº”è¯¥åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ</p><h3 id="stdmove-ä½¿ç”¨åœºæ™¯">std::move ä½¿ç”¨åœºæ™¯</h3><h4 id="ç§»åŠ¨æ„é€ å‡½æ•°çš„åŸç†">ç§»åŠ¨æ„é€ å‡½æ•°çš„åŸç†</h4><p>é€šè¿‡ç§»åŠ¨æ„é€ ï¼Œb æŒ‡å‘ a çš„èµ„æºï¼Œa ä¸å†æ‹¥æœ‰èµ„æºï¼Œè¿™é‡Œçš„èµ„æºï¼Œå¯ä»¥æ˜¯åŠ¨æ€ç”³è¯·çš„å†…å­˜ï¼Œç½‘ç»œé“¾æ¥ï¼Œæ‰“å¼€çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬ä¾‹ä¸­çš„ stringã€‚è¿™æ—¶å€™è®¿é—® a çš„è¡Œä¸ºæ—¶æœªå®šä¹‰çš„ï¼Œæ¯”å¦‚ï¼Œå¦‚æœèµ„æºæ˜¯åŠ¨æ€å†…å­˜ï¼Œa è¢«ç§»åŠ¨ä¹‹åï¼Œå†æ¬¡è®¿é—® a çš„èµ„æºï¼Œæ ¹æ®ç§»åŠ¨æ„é€ å‡½æ•°çš„å®šä¹‰ï¼Œå¯èƒ½æ˜¯ç©ºæŒ‡é’ˆï¼Œå¦‚æœæ˜¯èµ„æºä¸Šæ–‡çš„ stringï¼Œç§»åŠ¨ä¹‹åï¼Œa çš„èµ„æºä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆstring è¢«ç§»åŠ¨ä¹‹åï¼Œä¸ºç©ºå­—ç¬¦ä¸²ï¼‰ã€‚ å¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç éªŒè¯ï¼Œä¿®æ”¹ main å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">RValue a, b;</span><br><span class="line">RValue a1 = std::<span class="built_in">move</span>(a);</span><br><span class="line">cout&lt;&lt;<span class="string">"a.sources:"</span>&lt;&lt;a.sources&lt;&lt;endl;</span><br><span class="line">cout&lt;&lt;<span class="string">"a1.sources:"</span>&lt;&lt;a1.sources&lt;&lt;endl;</span><br><span class="line"><span class="function">RValue <span class="title">b1</span><span class="params">(b)</span></span>;</span><br><span class="line">cout&lt;&lt;<span class="string">"b.sources:"</span>&lt;&lt;b.sources&lt;&lt;endl;</span><br><span class="line">cout&lt;&lt;<span class="string">"b1.sources:"</span>&lt;&lt;a1.sources&lt;&lt;endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">g++ move.cpp -std=c++<span class="number">11</span> -o move</span><br><span class="line"> ./move</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">a.sources:</span><br><span class="line">a1.sources:hello!!!</span><br><span class="line">&amp; RValue</span><br><span class="line">b.sources:hello!!!</span><br><span class="line">b1.sources:hello!!!</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ç§»åŠ¨æ„é€ å‡½æ•°ä¹‹åï¼Œa çš„èµ„æºä¸ºç©ºï¼Œb æŒ‡å‘äº† a çš„èµ„æºã€‚é€šè¿‡æ‹·è´æ„é€ å‡½æ•°ï¼Œb å¤åˆ¶äº† a çš„èµ„æºã€‚</p><h4 id="stdmove-çš„åŸç†">std::move çš„åŸç†</h4><p>std::move çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">  <span class="keyword">constexpr</span> <span class="keyword">typename</span> std::remove_reference&lt;_Tp&gt;::<span class="function">type&amp;&amp;</span></span><br><span class="line"><span class="function">  <span class="title">move</span><span class="params">(_Tp&amp;&amp; <span class="type">__t</span>)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">  </span>{ <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> std::remove_reference&lt;_Tp&gt;::type&amp;&amp;&gt;(<span class="type">__t</span>); }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œï¼ŒT&amp;&amp;æ˜¯é€šç”¨å¼•ç”¨ï¼Œéœ€è¦æ³¨æ„å’Œå³å€¼å¼•ç”¨ï¼ˆæ¯”å¦‚ int&amp;&amp;ï¼‰åŒºåˆ†ã€‚é€šè¿‡ move å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œmove å¹¶æ²¡æœ‰â€ç§»åŠ¨â€œä»€ä¹ˆå†…å®¹ï¼Œåªæ˜¯å°†ä¼ å…¥çš„å€¼è½¬æ¢ä¸ºå³å€¼ï¼Œæ­¤å¤–æ²¡æœ‰å…¶ä»–åŠ¨ä½œã€‚std::move+ç§»åŠ¨æ„é€ å‡½æ•°æˆ–è€…ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œæ‰èƒ½å……åˆ†èµ·åˆ°å‡å°‘ä¸å¿…è¦æ‹·è´çš„æ„ä¹‰ã€‚</p><h4 id="stdmove-çš„ä½¿ç”¨åœºæ™¯">std::move çš„ä½¿ç”¨åœºæ™¯</h4><p>åœ¨ä¹‹å‰çš„é¡¹ç›®ä¸­çœ‹åˆ°æœ‰çš„åŒäº‹åˆ°å¤„ä½¿ç”¨ std::moveï¼Œå¥½åƒè§‰å¾—ä½¿ç”¨äº† std::move å°±èƒ½ç§»åŠ¨èµ„æºï¼Œæå‡æ€§èƒ½ä¸€æ ·ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œstd::move ä¸»è¦ä½¿ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š</p><ul><li>ä½¿ç”¨å‰æï¼š<ul><li><ol type="1"><li>å®šä¹‰çš„ç±»ä½¿ç”¨äº†èµ„æºå¹¶å®šä¹‰äº†ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦</li></ol></li><li><ol start="2" type="1"><li>è¯¥å˜é‡å³å°†ä¸å†ä½¿ç”¨</li></ol></li></ul></li><li>ä½¿ç”¨åœºæ™¯</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RValue a, b;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹ a,b åšä¸€ç³»åˆ—æ“ä½œä¹‹åï¼Œä¸å†ä½¿ç”¨ a,bï¼Œä½†éœ€è¦ä¿å­˜åˆ°æ™ºèƒ½æŒ‡é’ˆæˆ–è€…å®¹å™¨ä¹‹ä¸­</span></span><br><span class="line"><span class="function">unique_ptr&lt;RValue&gt; <span class="title">up</span><span class="params">(<span class="keyword">new</span> RValue(std::move(a)))</span></span>;</span><br><span class="line">vector&lt;RValue*&gt; vr;</span><br><span class="line">vr.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">RValue</span>(std::<span class="built_in">move</span>(b)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸´æ—¶å®¹å™¨ä¸­ä¿å­˜çš„å¤§é‡çš„å…ƒç´ éœ€è¦å¤åˆ¶åˆ°ç›®æ ‡å®¹å™¨ä¹‹ä¸­</span></span><br><span class="line">vector&lt;RValue&gt; vrs_temp;</span><br><span class="line">vrs_temp.<span class="built_in">push_back</span>(<span class="built_in">RValue</span>());</span><br><span class="line"><span class="function">vector&lt;RValue&gt; <span class="title">vrs</span><span class="params">(std::move(vrs_temp))</span></span>;</span><br><span class="line"></span><br><span class="line">RValue c;</span><br><span class="line"><span class="built_in">put</span>(std::<span class="built_in">move</span>(c));</span><br></pre></td></tr></tbody></table></figure><ul><li>åœ¨æ²¡æœ‰å³å€¼å¼•ç”¨ä¹‹å‰ï¼Œä¸ºäº†ä½¿ç”¨ä¸´æ—¶å˜é‡ï¼Œé€šå¸¸å®šä¹‰ const çš„å·¦å€¼å¼•ç”¨ï¼Œæ¯”å¦‚ const string&amp;ï¼Œåœ¨æœ‰äº†å³å€¼å¼•ç”¨ä¹‹åï¼Œä¸ºäº†ä½¿ç”¨å³å€¼è¯­ä¹‰ï¼Œä¸è¦æŠŠå‚æ•°å®šä¹‰ä¸ºå¸¸é‡å·¦å€¼å¼•ç”¨ï¼Œå¦åˆ™ï¼Œä¼ é€’å³å€¼æ—¶è°ƒç”¨çš„æ˜¯æ‹·è´æ„é€ å‡½æ•°ã€‚</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void put(const RValue&amp; c){</span><br><span class="line">cout&lt;&lt;<span class="string">"----------"</span>&lt;&lt;<span class="string">endl;</span></span><br><span class="line"><span class="string">unique_ptr&lt;RValue&gt; up(new RValue(std::move(c)));</span></span><br><span class="line"><span class="string">cout&lt;&lt;"----------"&lt;&lt;endl</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">RValue c;</span><br><span class="line">put(std::move(c));</span><br><span class="line"></span><br><span class="line">g++ move.cpp -std=c++11 -o move</span><br><span class="line"> ./move</span><br><span class="line">----------</span><br><span class="line">&amp; RValue</span><br><span class="line">----------</span><br></pre></td></tr></tbody></table></figure><p>ä¸ä½¿ç”¨å·¦å€¼å¸¸é‡å¼•ç”¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void put(RValue c){</span><br><span class="line">cout&lt;&lt;<span class="string">"----------"</span>&lt;&lt;<span class="string">endl;</span></span><br><span class="line"><span class="string">unique_ptr&lt;RValue&gt; up(new RValue(std::move(c)));</span></span><br><span class="line"><span class="string">cout&lt;&lt;"----------"&lt;&lt;endl</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">RValue c;</span><br><span class="line">put(std::move(c));</span><br><span class="line"></span><br><span class="line">g++ move.cpp -std=c++11 -o move</span><br><span class="line"> ./move</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">----------</span><br><span class="line">&amp;&amp; RValue</span><br><span class="line">----------</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ˜¯å› ä¸ºï¼Œæ ¹æ®é€šç”¨å¼•ç”¨çš„å®šä¹‰ï¼Œstd::move(c) è¿‡ç¨‹ä¸­ï¼Œæ¨¡æ¿å‚æ•°è¢«æ¨å€’ä¸º const RValue&amp;ï¼Œå› æ­¤ï¼Œè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ã€‚</p><h4 id="æ€»ç»“">æ€»ç»“</h4><p>é€šè¿‡ç®€ç»å³å€¼å’Œå³å€¼å¼•ç”¨ä»¥åŠ std::move å’Œç§»åŠ¨æ„é€ å‡½æ•°ï¼Œæ€»ç»“å³å€¼å¼•ç”¨ï¼Œç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦å’Œ std::move çš„ç”¨æ³•å’Œæ³¨æ„äº‹é¡¹ã€‚</p><h2 id="stdforward">std::forward</h2><h3 id="forward-çš„ä½œç”¨">forward çš„ä½œç”¨</h3><p>std::forward è¢«ç§°ä¸ºå®Œç¾è½¬å‘ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¿æŒåŸæ¥çš„å€¼å±æ€§ä¸å˜ã€‚å•¥æ„æ€å‘¢ï¼Ÿé€šä¿—çš„è®²å°±æ˜¯ï¼Œå¦‚æœåŸæ¥çš„å€¼æ˜¯å·¦å€¼ï¼Œç» std::forward å¤„ç†åè¯¥å€¼è¿˜æ˜¯å·¦å€¼ï¼›å¦‚æœåŸæ¥çš„å€¼æ˜¯å³å€¼ï¼Œç» std::forward å¤„ç†åå®ƒè¿˜æ˜¯å³å€¼ã€‚</p><p>çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œä½ åº”è¯¥å°±æ¸…æ¥šä¸Šé¢è¿™å¥è¯çš„å«ä¹‰äº†ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(T &amp; t)</span></span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"å·¦å€¼"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(T &amp;&amp; t)</span></span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"å³å€¼"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">testForward</span><span class="params">(T &amp;&amp; v)</span></span>{</span><br><span class="line">    <span class="built_in">print</span>(v);</span><br><span class="line">    <span class="built_in">print</span>(std::forward&lt;T&gt;(v));</span><br><span class="line">    <span class="built_in">print</span>(std::<span class="built_in">move</span>(v));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">testForward</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"======================"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">testFoward</span>(x);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//clang++ -std=c++11 -g -o forward test_forward.cpp</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ä»£ç æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å·¦å€¼</span><br><span class="line">å³å€¼</span><br><span class="line">=========================</span><br><span class="line">å·¦å€¼</span><br><span class="line">å³å€¼</span><br></pre></td></tr></tbody></table></figure><p>ä»ä¸Šé¢ç¬¬ä¸€ç»„çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„ 1 è™½ç„¶æ˜¯å³å€¼ï¼Œä½†ç»è¿‡å‡½æ•°ä¼ å‚ä¹‹åå®ƒå˜æˆäº†å·¦å€¼ï¼ˆåœ¨å†…å­˜ä¸­åˆ†é…äº†ç©ºé—´ï¼‰ï¼›è€Œç¬¬äºŒè¡Œç”±äºä½¿ç”¨äº† std::forward å‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¼šæ”¹å˜å®ƒçš„å³å€¼å±æ€§ï¼Œå› æ­¤ä¼šè°ƒç”¨å‚æ•°ä¸ºå³å€¼å¼•ç”¨çš„ print æ¨¡æ¿å‡½æ•°ï¼›ç¬¬ä¸‰è¡Œï¼Œå› ä¸º std::move ä¼šå°†ä¼ å…¥çš„å‚æ•°å¼ºåˆ¶è½¬æˆå³å€¼ï¼Œæ‰€ä»¥ç»“æœä¸€å®šæ˜¯å³å€¼ã€‚</p><p>å†æ¥çœ‹çœ‹ç¬¬äºŒç»„ç»“æœã€‚å› ä¸º x å˜é‡æ˜¯å·¦å€¼ï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œä¸€å®šæ˜¯å·¦å€¼ï¼›ç¬¬äºŒè¡Œä½¿ç”¨ forward å¤„ç†ï¼Œå®ƒä¾ç„¶ä¼šè®©å…¶ä¿æŒå·¦å€¼ï¼Œæ‰€ä»¥ç¬¬äºŒä¹Ÿæ˜¯å·¦å€¼ï¼›æœ€åä¸€è¡Œä½¿ç”¨ move å‡½æ•°ï¼Œå› æ­¤ä¸€å®šæ˜¯å³å€¼ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘æƒ³ä½ åº”è¯¥å·²ç»æ¸…æ¥š forward çš„ä½œç”¨æ˜¯ä»€ä¹ˆäº†å§ï¼Ÿ</p><h3 id="forward-å®ç°åŸç†">forward å®ç°åŸç†</h3><p>è¦åˆ†æ forward å®ç°åŸç†ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ forward ä»£ç å®ç°ã€‚ç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»æœ‰äº†åˆ†æ std::move çš„åŸºç¡€ï¼Œæ‰€ä»¥å†æ¥çœ‹ forward ä»£ç åº”è¯¥ä¸ä¼šå¤ªå›°éš¾ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp; param)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>forward å®ç°äº†ä¸¤ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œä¸€ä¸ªæ¥æ”¶å·¦å€¼ï¼Œå¦ä¸€ä¸ªæ¥æ”¶å³å€¼ã€‚</p><h1 id="pod">POD</h1><p>POD æ˜¯è‹±æ–‡ä¸­ Plain Old Data çš„ç¼©å†™ã€‚POD åœ¨ C++ä¸­æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œé€šå¸¸ç”¨äºè¯´æ˜ä¸€ä¸ªç±»å‹çš„å±æ€§ï¼Œå°¤å…¶æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹çš„å±æ€§ã€‚å…·ä½“åœ°ï¼ŒC++11 å°† POD åˆ’åˆ†ä¸ºä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µçš„åˆé›†ï¼Œå³ï¼šå¹³å‡¡çš„ï¼ˆtrivialï¼‰å’Œæ ‡å‡†å¸ƒå±€çš„ï¼ˆstandard layoutï¼‰ã€‚</p><h2 id="trivial">trivial</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å¹³å‡¡çš„å®šä¹‰ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¹³å‡¡çš„ç±»æˆ–ç»“æ„ä½“åº”è¯¥ç¬¦åˆä»¥ä¸‹å®šä¹‰ï¼š</p><ul><li>æ‹¥æœ‰å¹³å‡¡çš„é»˜è®¤æ„é€ å‡½æ•°ï¼ˆtrivial constructorï¼‰å’Œææ„å‡½æ•°ï¼ˆtrivial destructorï¼‰ã€‚å¹³å‡¡çš„é»˜è®¤æ„é€ å‡½æ•°å°±æ˜¯è¯´æ„é€ å‡½æ•°â€œä»€ä¹ˆéƒ½ä¸å¹²â€ã€‚ä½¿ç”¨=default å…³é”®å­—æ¥æ˜¾å¼åœ°å£°æ˜ç¼ºçœç‰ˆæœ¬çš„æ„é€ å‡½æ•°ï¼Œä½¿å¾—ç±»å‹æ¢å¤â€œå¹³å‡¡åŒ–â€ã€‚</li><li>æ‹¥æœ‰å¹³å‡¡çš„æ‹·è´æ„é€ å‡½æ•°ï¼ˆtrivial copy constructorï¼‰å’Œç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆtrivialmove constructorï¼‰ã€‚å¹³å‡¡çš„æ‹·è´æ„é€ å‡½æ•°åŸºæœ¬ä¸Šç­‰åŒäºä½¿ç”¨ memcpy è¿›è¡Œç±»å‹çš„æ„é€ ã€‚åŒå¹³å‡¡çš„é»˜è®¤æ„é€ å‡½æ•°ä¸€æ ·ï¼Œä¸å£°æ˜æ‹·è´æ„é€ å‡½æ•°çš„ã€‚è¯ï¼Œç¼–è¯‘å™¨ä¼šå¸®ç¨‹åºå‘˜è‡ªåŠ¨åœ°ç”Ÿæˆã€‚åŒæ ·åœ°ï¼Œå¯ä»¥æ˜¾å¼åœ°ä½¿ç”¨=default å£°æ˜é»˜è®¤æ‹·è´æ„é€ å‡½æ•°ã€‚</li><li>æ‹¥æœ‰å¹³å‡¡çš„æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼ˆtrivial assignment operatorï¼‰å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼ˆtrivial move operatorï¼‰ã€‚è¿™åŸºæœ¬ä¸Šä¸å¹³å‡¡çš„æ‹·è´æ„é€ å‡½æ•°å’Œå¹³å‡¡çš„ç§»åŠ¨æ„é€ è¿ç®—ç¬¦ç±»ä¼¼ã€‚</li><li>ä¸èƒ½åŒ…å«è™šå‡½æ•°ä»¥åŠè™šåŸºç±»</li></ul><h2 id="standard-layout">standard layout</h2><p>æ ‡å‡†å¸ƒå±€çš„ç±»æˆ–ç»“æ„ä½“åº”è¯¥ç¬¦åˆä»¥ä¸‹å®šä¹‰ï¼š</p><ul><li>æ‰€æœ‰éé™æ€æˆå‘˜æœ‰ç›¸åŒçš„è®¿é—®æƒé™ï¼ˆpublic, private, protectedï¼‰</li><li>åœ¨ç±»æˆ–è€…ç»“æ„ä½“ç»§æ‰¿æ—¶ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼š<ul><li>æ´¾ç”Ÿç±»ä¸­æœ‰éé™æ€æˆå‘˜ï¼Œä¸”åªæœ‰ä¸€ä¸ªä»…åŒ…å«é™æ€æˆå‘˜çš„åŸºç±»</li><li>åŸºç±»æœ‰éé™æ€æˆå‘˜ï¼Œè€Œæ´¾ç”Ÿç±»æ²¡æœ‰éé™æ€æˆå‘˜</li></ul></li><li>ç±»ä¸­ç¬¬ä¸€ä¸ªéé™æ€æˆå‘˜çš„ç±»å‹ä¸å…¶åŸºç±»ä¸åŒ</li><li>æ²¡æœ‰è™šå‡½æ•°å’Œè™šåŸºç±»</li><li>æ‰€æœ‰éé™æ€æ•°æ®æˆå‘˜å‡ç¬¦åˆæ ‡å‡†å¸ƒå±€ç±»å‹ï¼Œå…¶åŸºç±»ä¹Ÿç¬¦åˆæ ‡å‡†å¸ƒå±€ã€‚è¿™æ˜¯ä¸€ä¸ªé€’å½’çš„å®šä¹‰ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½ç‰¹åˆ«è§£é‡Šçš„</li></ul><h2 id="pod-1">POD</h2><p>å¯¹äº POD è€Œè¨€ï¼Œåœ¨ C++11 ä¸­çš„å®šä¹‰å°±æ˜¯å¹³å‡¡çš„å’Œæ ‡å‡†å¸ƒå±€çš„ä¸¤ä¸ªæ–¹é¢ã€‚åŒæ ·åœ°ï¼Œè¦åˆ¤å®šæŸä¸€ç±»å‹æ˜¯å¦æ˜¯ PODï¼Œæ ‡å‡†åº“ä¸­çš„<type_traits>å¤´æ–‡ä»¶ä¹Ÿä¸ºç¨‹åºå‘˜æä¾›äº†å¦‚ä¸‹æ¨¡æ¿ç±»ï¼š</type_traits></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// is_pod</span></span><br><span class="line"><span class="comment">// Could use is_standard_layout &amp;&amp; is_trivial instead of the builtin.</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">is_pod</span></span><br><span class="line">: <span class="keyword">public</span> integral_constant&lt;<span class="type">bool</span>, __is_pod(_Tp)&gt;</span><br><span class="line">  { };</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ POD æˆ‘ä»¬çœ‹å¾—åˆ°çš„å¤§æ¦‚æœ‰å¦‚ä¸‹ 3 ç‚¹ï¼š</p><ul><li>å­—èŠ‚èµ‹å€¼ï¼Œä»£ç ä¸­æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ memset å’Œ memcpy å¯¹ POD ç±»å‹è¿›è¡Œåˆå§‹åŒ–å’Œæ‹·è´ç­‰æ“ä½œã€‚</li><li>æä¾›å¯¹ C å†…å­˜å¸ƒå±€å…¼å®¹ã€‚C++ç¨‹åºå¯ä»¥ä¸ C å‡½æ•°è¿›è¡Œç›¸äº’æ“ä½œï¼Œå› ä¸º POD ç±»å‹çš„æ•°æ®åœ¨ C ä¸ C++é—´çš„æ“ä½œæ€»æ˜¯å®‰å…¨çš„ã€‚</li><li>ä¿è¯äº†é™æ€åˆå§‹åŒ–çš„å®‰å…¨æœ‰æ•ˆã€‚é™æ€åˆå§‹åŒ–åœ¨å¾ˆå¤šæ—¶å€™èƒ½å¤Ÿæé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œè€Œ POD ç±»å‹çš„å¯¹è±¡åˆå§‹åŒ–å¾€å¾€æ›´åŠ ç®€å•ï¼ˆæ¯”å¦‚æ”¾å…¥ç›®æ ‡æ–‡ä»¶çš„ã€‚bss æ®µï¼Œåœ¨åˆå§‹åŒ–ä¸­ç›´æ¥è¢«èµ‹ 0ï¼‰ã€‚</li></ul><h1 id="ç”¨æˆ·å®šä¹‰å­—é¢é‡">ç”¨æˆ·å®šä¹‰å­—é¢é‡</h1><h2 id="cä¸­çš„å­—é¢é‡">C++ä¸­çš„å­—é¢é‡</h2><p>C++ è‡ªå¸¦ 4 ç§å­—é¢é‡ï¼š</p><ul><li>æ•´å½¢ 123</li><li>æµ®ç‚¹å‹ 12.3</li><li>å­—ç¬¦ '1'</li><li>å­—ç¬¦ä¸² "123"</li></ul><p>å­—é¢é‡åˆå¯æ·»åŠ åç¼€æ¥è¡¨æ˜å…·ä½“ç±»å‹ï¼š</p><ul><li>æ— ç¬¦å·æ•´å½¢ (unsigned int): 123u</li><li>é•¿æ•´å½¢ (long): 123l</li></ul><p>åœ¨ C++03 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæµ®ç‚¹æ•° height</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> height = <span class="number">3.4</span>;</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆï¼Œç—›ç‚¹æ¥äº†ï¼Œæ­¤å¤„çš„ height çš„å•ä½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç±³ï¼Ÿå˜ç±³ï¼Ÿåˆæˆ–æ˜¯è‹±å°ºï¼Ÿåœ¨é¢å¯¹æ­¤ç±»é—®é¢˜æ—¶ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ç¼–å†™å¦‚ä¸‹ä»£ç ï¼Œäº‹æƒ…å°±ä¼šç®€å•è®¸å¤šï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">height = <span class="number">3</span>cm;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ratio = (3 * 10) / 2</span></span><br><span class="line">ratio = <span class="number">3</span>cm / <span class="number">2</span>mm;</span><br></pre></td></tr></tbody></table></figure><h2 id="ç”¨æˆ·è‡ªå®šä¹‰å­—é¢é‡">ç”¨æˆ·è‡ªå®šä¹‰å­—é¢é‡</h2><p>C++11 å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å­—é¢é‡åç¼€</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="type">double</span></span><br><span class="line"><span class="keyword">operator</span><span class="string">""</span> _cm(<span class="type">long</span> <span class="type">double</span> x) {</span><br><span class="line">  <span class="keyword">return</span> x * <span class="number">10</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">double</span></span><br><span class="line"><span class="keyword">operator</span><span class="string">""</span> _m(<span class="type">long</span> <span class="type">double</span> x) {</span><br><span class="line">  <span class="keyword">return</span> x * <span class="number">1000</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">double</span></span><br><span class="line"><span class="keyword">operator</span><span class="string">""</span> _mm(<span class="type">long</span> <span class="type">double</span> x) {</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// height = 30.0</span></span><br><span class="line"><span class="keyword">auto</span> height = <span class="number">3.0</span>_cm;</span><br><span class="line"></span><br><span class="line"><span class="comment">// length = 1230.0</span></span><br><span class="line"><span class="keyword">auto</span> length = <span class="number">1.23</span>_m;</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä½¿ç”¨è¿™ç§å†™æ³•ï¼Œ_cm, _m, _mm ç­‰å‡½æ•°å°†åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨ï¼Œå¦‚æœå¸Œæœ›åœ¨ç¼–è¯‘æ—¶å°±è°ƒç”¨å­—é¢é‡åç¼€å‡½æ•°ï¼Œåˆ™éœ€è¦æŠŠå‡½æ•°å®šä¹‰ä¸º constexprï¼Œä¾‹å¦‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="type">long</span> <span class="type">double</span></span><br><span class="line"><span class="keyword">operator</span><span class="string">""</span> _cm(<span class="type">long</span> <span class="type">double</span> x) {</span><br><span class="line">  <span class="keyword">return</span> x * <span class="number">10</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„ï¼Œå¦‚æœè¿™é‡Œè¦å®šä¹‰å‡½æ•°ä¸º constexpr</span></span><br><span class="line"><span class="comment">// ç¼–è¯‘æ—¶éœ€è¦ä½¿ç”¨ c++14 æ ‡å‡† (-std=c++14)</span></span><br><span class="line"><span class="type">int</span> <span class="keyword">operator</span><span class="string">""</span> _bin(</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* s,</span><br><span class="line">  <span class="type">size_t</span> l</span><br><span class="line">) {</span><br><span class="line">  <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; l; i++){</span><br><span class="line">    ret = (ret &lt;&lt; <span class="number">1</span>) | (s[i] - <span class="string">'0'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> num = <span class="string">"110"</span>_bin; <span class="comment">// num = 6</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è‡ªå®šä¹‰å­—é¢é‡çš„é™åˆ¶">è‡ªå®šä¹‰å­—é¢é‡çš„é™åˆ¶</h2><p>C++11 åªå…è®¸å­—é¢é‡åç¼€å‡½æ•°çš„å‚æ•°ä¸ºä»¥ä¸‹ç±»å‹ï¼Œå³æ•´æ•°ï¼Œæµ®ç‚¹ä»¥åŠå­—ç¬¦ä¸²ï¼š</p><ul><li>unsigned long long</li><li>long double</li><li>char const*</li><li>char const*, std::size_t</li><li>wchar_t const*, std::size_t</li><li>char16_t const*, std::size_t</li><li>char32_t const*, std::size_t</li></ul><p>è¿”å›å€¼åˆ™æ— ç±»å‹é™åˆ¶</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NDU4ODIwNA==">https://zhuanlan.zhihu.com/p/94588204<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC85N2ZkZDg1Mjk3NGY=">https://www.jianshu.com/p/97fdd852974f<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMTEzNjk2OTM=">https://zhuanlan.zhihu.com/p/111369693<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++11ï¼ˆä¸€ï¼‰assert ä¸ noexcept</title>
      <link href="/2022/Program/CPP11Part1/"/>
      <url>/2022/Program/CPP11Part1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPP11EnsureStabilityAndCompatibility.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyZDc3NTFlMDg1MzA3YTI0YjdiMDI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="é™æ€æ–­è¨€-static_assert">é™æ€æ–­è¨€ static_assert</h1><p>æ–­è¨€ assert å®åªæœ‰åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰èƒ½èµ·ä½œç”¨ï¼Œè€Œ#error åªåœ¨ç¼–è¯‘å™¨é¢„å¤„ç†æ—¶æ‰èƒ½èµ·ä½œç”¨ã€‚æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç¼–è¯‘æ—¶èƒ½åšä¸€äº›æ–­è¨€ã€‚è¯»è€…ä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹ Boost åº“å†…ç½®çš„ BOOST_STATIC_ASSERTï¼Œå…¶ç¼ºé™·éƒ½æ˜¯å¾ˆæ˜æ˜¾çš„ï¼šè¯Šæ–­ä¿¡æ¯ä¸å¤Ÿå……åˆ†ï¼Œä»è€Œéš¾ä»¥å‡†ç¡®å®šä½é”™è¯¯çš„æ ¹æºã€‚</p><p>åœ¨ C++11 æ ‡å‡†ä¸­ï¼Œå¼•äººäº† static_assert æ–­è¨€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ static_assert ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œå®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æ–­è¨€è¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼é€šå¸¸éœ€è¦è¿”å›ä¸€ä¸ª bool å€¼ï¼›ä¸€ä¸ªåˆ™æ˜¯è­¦å‘Šä¿¡æ¯ï¼Œå®ƒé€šå¸¸ä¹Ÿå°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²ï¼Œåœ¨å‡ºé”™æ—¶ä¼šè¾“å‡ºè¯¥å­—ç¬¦ä¿¡æ¯ï¼Œè¿™æ ·å‡ºé”™ä½ç½®å°±æ˜¯éå¸¸æ˜ç¡®çš„ã€‚</p><h1 id="noexcept">noexcept</h1><p>noexcept å½¢å¦‚å…¶åï¼Œè¡¨ç¤ºå…¶ä¿®é¥°çš„å‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨ C++11 ä¸­å¦‚æœ noexcept ä¿®é¥°çš„å‡½æ•°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©ç›´æ¥è°ƒç”¨ std::terminate å‡½æ•°æ¥ç»ˆæ­¢ç¨‹åºçš„è¿è¡Œï¼Œè¿™æ¯”åŸºäºå¼‚å¸¸æœºåˆ¶çš„ throw åœ¨æ•ˆç‡ä¸Šä¼šé«˜ä¸€äº›ã€‚è¿™æ˜¯å› ä¸ºå¼‚å¸¸æœºåˆ¶ä¼šå¸¦æ¥ä¸€äº›é¢å¤–å¼€é”€ï¼Œæ¯”å¦‚å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šå¯¼è‡´å‡½æ•°æ ˆè¢«ä¾æ¬¡åœ°å±•å¼€ï¼ˆ unwindï¼‰ï¼Œå¹¶ä¾å¸§è°ƒç”¨åœ¨æœ¬å¸§ä¸­å·²æ„é€ çš„è‡ªåŠ¨å˜é‡çš„ææ„å‡½æ•°ç­‰ã€‚</p><p>å½“ç„¶ï¼Œ noexcept æ›´å¤§çš„ä½œç”¨æ˜¯ä¿è¯åº”ç”¨ç¨‹åºçš„å®‰å…¨ã€‚æ¯”å¦‚ä¸€ä¸ªç±»ææ„å‡½æ•°ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå¯¹äºå¸¸è¢«ææ„å‡½æ•°è°ƒç”¨çš„ delete å‡½æ•°æ¥è¯´ï¼ŒC++é»˜è®¤å°† delete å‡½æ•°è®¾ç½®æˆ noexceptï¼Œå°±å¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚è€ŒåŒæ ·å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒC++11 æ ‡å‡†ä¸­è®©ç±»çš„ææ„å‡½æ•°é»˜è®¤ä¹Ÿæ˜¯ noexcept(true) çš„ã€‚å½“ç„¶ï¼Œå¦‚æœç¨‹åºå‘˜æ˜¾å¼åœ°ä¸ºææ„å‡½æ•°æŒ‡å®šäº† noexceptï¼Œæˆ–è€…ç±»çš„åŸºç±»æˆ–æˆå‘˜æœ‰ noexcept(false) çš„ææ„å‡½æ•°ï¼Œææ„å‡½æ•°å°±ä¸ä¼šå†ä¿æŒé»˜è®¤å€¼ã€‚</p><h1 id="éé™æ€æˆå‘˜çš„-sizeof">éé™æ€æˆå‘˜çš„ sizeof</h1><p>ä» C è¯­è¨€è¢«å‘æ˜å¼€å§‹ï¼Œ sizeof å°±æ˜¯ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œä¹Ÿæ˜¯ C è¯­è¨€ä¸­é™¤äº†åŠ å‡ä¹˜é™¤ä»¥å¤–ä¸ºæ•°ä¸å¤šçš„ç‰¹æ®Šè¿ç®—ç¬¦ä¹‹ä¸€ã€‚è€Œåœ¨ C++å¼•å…¥ç±»ï¼ˆ classï¼‰ç±»å‹ä¹‹åï¼Œ sizeof çš„å®šä¹‰ä¹Ÿéšä¹‹è¿›è¡Œäº†æ‹“å±•ã€‚ä¸è¿‡åœ¨ C++98 æ ‡å‡†ä¸­ï¼Œå¯¹éé™æ€æˆå‘˜å˜é‡ä½¿ç”¨ sizeof æ˜¯ä¸èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std:</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">People</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> hand;</span><br><span class="line">    <span class="type">static</span> People * all;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    People p;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(p.hand) &lt;&lt; endl;         <span class="comment">//C++98 ä¸­é€šè¿‡ï¼ŒC++11 ä¸­é€šè¿‡</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(People::allï¼‰&lt;&lt;endlï¼›    <span class="comment">//c++98 ä¸­é€šè¿‡ï¼ŒC+11 ä¸­é€šè¿‡</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(People::handï¼‰&lt;&lt; end1;   <span class="comment">//C++98 ä¸­é”™è¯¯ï¼ŒC++11 ä¸­é€šè¿‡</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„æœ€åä¸€ä¸ª sizeof æ“ä½œã€‚åœ¨ C++11 ä¸­ï¼Œå¯¹éé™æ€æˆå‘˜å˜é‡ä½¿ç”¨ sizeof æ“ä½œæ˜¯åˆæ³•çš„ã€‚è€Œåœ¨ C++98 ä¸­ï¼Œåªæœ‰é™æ€æˆå‘˜ï¼Œæˆ–è€…å¯¹è±¡çš„å®ä¾‹æ‰èƒ½å¯¹å…¶æˆå‘˜è¿›è¡Œ sizeof æ“ä½œã€‚å› æ­¤å¦‚æœè¯»è€…åªæœ‰ä¸€ä¸ªæ”¯æŒ C++98 æ ‡å‡†çš„ç¼–è¯‘å™¨ï¼Œåœ¨æ²¡æœ‰å®šä¹‰ç±»å®ä¾‹çš„æ—¶å€™ï¼Œè¦è·å¾—ç±»æˆå‘˜çš„å¤§å°ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé‡‡ç”¨ä»¥ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sizeof</span> (((People*)<span class="number">0</span>)-&gt;hand)</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶è½¬æ¢ 0 ä¸ºä¸€ä¸ª People ç±»çš„æŒ‡é’ˆï¼Œç»§è€Œé€šè¿‡æŒ‡é’ˆçš„è§£å¼•ç”¨è·å¾—å…¶æˆå‘˜å˜é‡å¹¶ç”¨ sizeof æ±‚å¾—è¯¥æˆå‘˜å˜é‡çš„å¤§å°ã€‚è€Œåœ¨ C++11 ä¸­ï¼Œæˆ‘ä»¬æ— éœ€è¿™æ ·çš„æŠ€å·§ï¼Œå› ä¸º sizeof å¯ä»¥ä½œç”¨çš„è¡¨è¾¾å¼åŒ…æ‹¬äº†ç±»æˆå‘˜è¡¨è¾¾å¼ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sizeof</span>(People::hand);</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºä»ä»£ç çš„å¯è¯»æ€§è¿˜æ˜¯ç¼–å†™çš„ä¾¿åˆ©æ€§ï¼ŒC++11 çš„è§„åˆ™éƒ½æ¯”å¼ºåˆ¶æŒ‡é’ˆè½¬æ¢çš„æ–¹æ¡ˆæ›´èƒœä¸€ç­¹ã€‚</p><h1 id="æ‰©å±•çš„-friend-è¯­æ³•">æ‰©å±•çš„ friend è¯­æ³•</h1><p>friend å…³é”®å­—ç”¨äºå£°æ˜ç±»çš„å‹å…ƒï¼Œå‹å…ƒå¯ä»¥æ— è§†ç±»ä¸­æˆå‘˜çš„å±æ€§ã€‚æ— è®ºæˆå‘˜æ˜¯ publicã€ protected æˆ–æ˜¯ private çš„ï¼Œå‹å…ƒç±»æˆ–å‹å…ƒå‡½æ•°éƒ½å¯ä»¥è®¿é—®ï¼Œè¿™å°±å®Œå…¨ç ´åäº†é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­å°è£…æ€§çš„æ¦‚å¿µã€‚å› æ­¤ï¼Œä½¿ç”¨ friend å…³é”®å­—å……æ»¡äº†äº‰è®®æ€§ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œé¢å‘å¯¹è±¡ç¨‹åºå¼€å‘çš„ä¸“å®¶ä¼šå»ºè®®ç¨‹åºå‘˜ä½¿ç”¨ Get/Set æ¥å£æ¥è®¿é—®ç±»çš„æˆå‘˜ï¼Œä½†æœ‰çš„æ—¶å€™ï¼Œ friend å…³é”®å­—ç¡®å®ä¼šè®©ç¨‹åºå‘˜å°‘å†™å¾ˆå¤šä»£ç ã€‚å› æ­¤å³ä½¿å­˜åœ¨äº‰è®ºï¼Œ friend è¿˜æ˜¯åœ¨å¾ˆå¤šç¨‹åºä¸­è¢«ä½¿ç”¨åˆ°ã€‚è€Œ C++11 å¯¹ friend å…³é”®å­—è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼Œä»¥ä¿è¯å…¶æ›´åŠ å¥½ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Poly</span>;</span><br><span class="line"><span class="keyword">typedef</span> Poly P;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Lilei</span> {</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Poly</span>;  <span class="comment">//C++98 é€šè¿‡ï¼ŒC++11 é€šè¿‡</span></span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Jim</span> {</span><br><span class="line">    <span class="keyword">friend</span> Poly;        <span class="comment">//C++98 å¤±è´¥ï¼ŒC++11 é€šè¿‡</span></span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hanmeimei</span> {</span><br><span class="line">    <span class="keyword">friend</span> p;           <span class="comment">//C++98 å¤±è´¥ï¼ŒC++11 é€šè¿‡</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è™½ç„¶åœ¨ C++11 ä¸­è¿™æ˜¯ä¸€ä¸ªå°çš„æ”¹è¿›ï¼Œå´ä¼šå¸¦æ¥ä¸€ç‚¹åº”ç”¨çš„å˜åŒ–ä¸€ç¨‹åºå‘˜å¯ä»¥ä¸ºç±»æ¨¡æ¿å£°æ˜å‹å…ƒäº†ã€‚è¿™åœ¨ C++98 ä¸­æ˜¯æ— æ³•åšåˆ°çš„ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå¦‚ä»£ç æ¸…å• 2-20 æ‰€ç¤ºã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">P</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span>{</span><br><span class="line">    <span class="keyword">friend</span> T;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">People&lt;P&gt; PP;   <span class="comment">//ç±»å‹ P åœ¨è¿™é‡Œæ˜¯ People ç±»å‹çš„å‹å…ƒ</span></span><br><span class="line">People&lt;<span class="type">int</span>&gt; P;  <span class="comment">//å¯¹äº int ç±»å‹æ¨¡æ¿å‚æ•°ï¼Œå‹å…ƒå£°æ˜è¢«å¿½ç•¥</span></span><br></pre></td></tr></tbody></table></figure><p>ä»ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äº People è¿™ä¸ªæ¨¡æ¿ç±»ï¼Œåœ¨ä½¿ç”¨ç±» P ä¸ºæ¨¡æ¿å‚æ•°æ—¶ï¼ŒP æ˜¯ People&lt; P &gt; çš„ä¸€ä¸ª friend ç±»ã€‚è€Œåœ¨ä½¿ç”¨å†…ç½®ç±»å‹ int ä½œä¸ºæ¨¡æ¿å‚æ•°çš„æ—¶å€™ï¼Œ People&lt; int &gt;ä¼šè¢«å®ä¾‹åŒ–ä¸ºä¸€ä¸ªæ™®é€šçš„æ²¡æœ‰å‹å…ƒå®šä¹‰çš„ç±»å‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ¨¡æ¿å®ä¾‹åŒ–æ—¶æ‰ç¡®å®šä¸€ä¸ªæ¨¡æ¿ç±»æ˜¯å¦æœ‰å‹å…ƒï¼Œä»¥åŠè°æ˜¯è¿™ä¸ªæ¨¡æ¿ç±»çš„å‹å…ƒã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„å°ç‰¹æ€§ï¼Œåœ¨ç¼–å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œä½¿ç”¨è¯¥ç‰¹æ€§æ˜¯å¾ˆæœ‰å¥½å¤„çš„ã€‚</p><h1 id="finaloverride-æ§åˆ¶">final/override æ§åˆ¶</h1><p>final å…³é”®å­—çš„ä½œç”¨æ˜¯ä½¿æ´¾ç”Ÿç±»ä¸å¯è¦†ç›–å®ƒæ‰€ä¿®é¥°çš„è™šå‡½æ•°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">object</span>{</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">fun</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span>: <span class="keyword">public</span> object {</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span> <span class="keyword">final</span></span>;       <span class="comment">//å£°æ˜ä¸º fina1</span></span><br><span class="line">};</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Derived</span>: <span class="keyword">public</span> Base {</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">()</span></span>;             <span class="comment">//æ— æ³•é€šè¿‡ç¼–è¯‘</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ´¾ç”Ÿäº Object çš„ Base ç±»é‡è½½äº† Object çš„ fun æ¥å£ï¼Œå¹¶å°†æœ¬ç±»ä¸­çš„ fun å‡½æ•°å£°æ˜ä¸º final çš„ã€‚é‚£ä¹ˆæ´¾ç”Ÿäº Base çš„ Derived ç±»å¯¹æ¥å£ fun çš„é‡è½½åˆ™ä¼šå¯¼è‡´ç¼–è¯‘æ—¶çš„é”™è¯¯ã€‚</p><p>åœ¨ C++11 ä¸­ä¸ºäº†å¸®åŠ©ç¨‹åºå‘˜å†™ç»§æ‰¿ç»“æ„å¤æ‚çš„ç±»å‹ï¼Œå¼•å…¥äº†è™šå‡½æ•°æè¿°ç¬¦ overrideï¼Œå¦‚æœæ´¾ç”Ÿç±»åœ¨è™šå‡½æ•°å£°æ˜æ—¶ä½¿ç”¨äº† override æè¿°ç¬¦ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°å¿…é¡»é‡è½½å…¶åŸºç±»ä¸­çš„åŒåå‡½æ•°å¦åˆ™ä»£ç å°†æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚</p><h1 id="å¤–éƒ¨æ¨¡æ¿">å¤–éƒ¨æ¨¡æ¿</h1><h2 id="ä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨æ¨¡æ¿">ä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨æ¨¡æ¿</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T)</span> </span>{}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ç¬¬ä¸€ä¸ª test1.pp æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹ä»£ç </p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> test. h<span class="string">"</span></span></span><br><span class="line"><span class="string"><span class="meta">void test1() {fun(3)};</span></span></span><br></pre></td></tr></tbody></table></figure><p>è€Œåœ¨å¦ä¸€ä¸ª test2.cpp æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹ä»£ç </p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"test.h"</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span> </span>{<span class="built_in">fun</span>(<span class="number">4</span>)};</span><br></pre></td></tr></tbody></table></figure><p>ç”±äºä¸¤ä¸ªæºä»£ç ä½¿ç”¨çš„æ¨¡æ¿å‡½æ•°çš„å‚æ•°ç±»å‹ä¸€è‡´ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘ test1.cpp çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å®ä¾‹åŒ–å‡ºäº†å‡½æ•° fun<int>(int)ï¼Œè€Œå½“ç¼–è¯‘ test2.cpp çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨åˆå†ä¸€æ¬¡å®ä¾‹åŒ–å‡ºäº†å‡½æ•° fun<int>(int)ã€‚é‚£ä¹ˆå¯ä»¥æƒ³è±¡ï¼Œåœ¨ test1.o ç›®æ ‡æ–‡ä»¶å’Œ test2.o ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œä¼šæœ‰ä¸¤ä»½ä¸€æ¨¡ä¸€æ ·çš„å‡½æ•° fun<int>(int) ä»£ç ã€‚è€Œä»£ç é‡å¤ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œä¿ç•™å…¶ä¸­ä¹‹ä¸€å°±å¯ä»¥äº†ã€‚äº‹å®ä¸Šï¼Œå¤§éƒ¨åˆ†é“¾æ¥å™¨ä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Œåœ¨é“¾æ¥çš„æ—¶å€™ï¼Œé“¾æ¥å™¨é€šè¿‡ä¸€äº›ç¼–è¯‘å™¨è¾…åŠ©çš„æ‰‹æ®µå°†é‡å¤çš„æ¨¡æ¿å‡½æ•°ä»£ç  fun<int>(int) åˆ é™¤æ‰ï¼Œåªä¿ç•™äº†å•ä¸ªå‰¯æœ¬ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸­çš„æ¨¡æ¿å‡½æ•°çš„ç¼–è¯‘ä¸é“¾æ¥çš„è¿‡ç¨‹ç¤ºæ„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/c++11_1.png"></int></int></int></int></p><p>ä¸è¿‡è¯»è€…ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œå¯¹äºæºä»£ç ä¸­å‡ºç°çš„æ¯ä¸€å¤„æ¨¡æ¿å®ä¾‹åŒ–ï¼Œç¼–è¯‘å™¨éƒ½éœ€è¦å»åšå®ä¾‹åŒ–çš„å·¥ä½œï¼›è€Œåœ¨é“¾æ¥æ—¶ï¼Œé“¾æ¥å™¨è¿˜éœ€è¦ç§»é™¤é‡å¤çš„å®ä¾‹åŒ–ä»£ç ã€‚ä¼šæå¤§åœ°å¢åŠ ç¼–è¯‘å™¨çš„ç¼–è¯‘æ—¶é—´å’Œé“¾æ¥æ—¶é—´ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨â€œå¤–éƒ¨çš„â€æ¨¡æ¿ã€‚</p><h2 id="æ˜¾å¼çš„å®ä¾‹åŒ–ä¸å¤–éƒ¨æ¨¡æ¿çš„å£°æ˜">æ˜¾å¼çš„å®ä¾‹åŒ–ä¸å¤–éƒ¨æ¨¡æ¿çš„å£°æ˜</h2><p>å¤–éƒ¨æ¨¡æ¿çš„ä½¿ç”¨å®é™…ä¾èµ–äº C++98 ä¸­ä¸€ä¸ªå·²æœ‰çš„ç‰¹æ€§ï¼Œå³æ˜¾å¼å®ä¾‹åŒ–ã€‚æ˜¾å¼å®ä¾‹åŒ–çš„è¯­æ³•å¾ˆç®€å•ï¼Œæ¯”å¦‚å¯¹äºä»¥ä¸‹æ¨¡æ¿ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T)</span></span>{}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬åªéœ€è¦å£°æ˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> <span class="type">void</span> <span class="built_in">fun</span>&lt;<span class="type">int</span>&gt;(<span class="type">int</span>);</span><br></pre></td></tr></tbody></table></figure><p>è¿™å°±å¯ä»¥ä½¿ç¼–è¯‘å™¨åœ¨æœ¬ç¼–è¯‘å•å…ƒä¸­å®ä¾‹åŒ–å‡ºä¸€ä¸ª fun<int>(int) ç‰ˆæœ¬çš„å‡½æ•°ï¼ˆè¿™ç§åšæ³•ä¹Ÿè¢«ç§°ä¸ºå¼ºåˆ¶å®ä¾‹åŒ–ï¼‰ã€‚è€Œåœ¨ C++11 æ ‡å‡†ä¸­ï¼ŒåˆåŠ å…¥äº†å¤–éƒ¨æ¨¡æ¿ï¼ˆ Extern Templateï¼‰çš„å£°æ˜ã€‚è¯­æ³•ä¸Šï¼Œå¤–éƒ¨æ¨¡æ¿çš„å£°æ˜è·Ÿæ˜¾å¼çš„å®ä¾‹åŒ–å·®ä¸å¤šï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå…³é”®å­— externã€‚å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š</int></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="type">void</span> <span class="built_in">fun</span>&lt;<span class="type">int</span>&gt;(<span class="type">int</span>)</span><br></pre></td></tr></tbody></table></figure><p>é¦–å…ˆï¼Œåœ¨ test1.cpp åšæ˜¾å¼åœ°å®ä¾‹åŒ–ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"test.h"</span></span></span><br><span class="line"><span class="keyword">template</span> <span class="type">void</span> <span class="built_in">fun</span>&lt;<span class="type">int</span>&gt;(<span class="type">int</span>);    <span class="comment">//æ˜¾ç¤ºåœ°å®ä¾‹åŒ–</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span>{<span class="built_in">fun</span>(<span class="number">3</span>)};</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥ï¼Œåœ¨ test2.cpp ä¸­åšå¤–éƒ¨æ¨¡æ¿çš„å£°æ˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#incude <span class="string">"test.h"</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="type">void</span> fun&lt;<span class="type">int</span>&gt;ï¼ˆ<span class="type">int</span>ï¼‰;   <span class="comment">//å¤–éƒ¨æ¨¡æ¿çš„å£°æ˜</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span> </span>{<span class="built_in">fun</span>(<span class="number">3</span>)};</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·ä¸€æ¥ï¼Œåœ¨ test2.o ä¸­ä¸ä¼šå†ç”Ÿæˆ fun<int>(int) çš„å®ä¾‹ä»£ç ã€‚æ•´ä¸ªæ¨¡æ¿çš„å®ä¾‹åŒ–æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/c++11_2.png"></int></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç”±äº test2.o ä¸å†åŒ…å« fun<int>(int) çš„å®ä¾‹ï¼Œå› æ­¤é“¾æ¥å™¨çš„å·¥ä½œå¾ˆè½»æ¾ï¼ŒåŸºæœ¬è·Ÿå¤–éƒ¨å˜é‡çš„åšæ³•æ˜¯ä¸€æ ·çš„ï¼Œå³åªéœ€è¦ä¿è¯è®© test1.cpp å’Œ test2.cpp å…±äº«ä¸€ä»½ä»£ç ä½ç½®å³å¯ã€‚è€ŒåŒæ—¶ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ç”¨æ¯æ¬¡éƒ½äº§ç”Ÿä¸€ä»½ fun<int>(int) çš„ä»£ç ï¼Œæ‰€ä»¥å¯ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´ã€‚è¿™é‡Œä¹Ÿå¯ä»¥æŠŠå¤–éƒ¨æ¨¡æ¿å£°æ˜æ”¾åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œè¿™æ ·æ‰€æœ‰åŒ…å« test.h çš„å¤´æ–‡ä»¶å°±å¯ä»¥å…±äº«è¿™ä¸ªå¤–éƒ¨æ¨¡æ¿å£°æ˜äº†ï¼Œè¿™ä¸€ç‚¹è·Ÿä½¿ç”¨å¤–éƒ¨å˜é‡å£°æ˜æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</int></int></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šæ·±å…¥ç†è§£ C++11ï¼šC++11 æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡æ„ï¼ˆä¸‰ï¼‰æ„ç­‘æµ‹è¯•ä½“ç³»</title>
      <link href="/2022/Program/RefactorPart3/"/>
      <url>/2022/Program/RefactorPart3/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡ªæµ‹è¯•ä»£ç çš„ä»·å€¼">è‡ªæµ‹è¯•ä»£ç çš„ä»·å€¼</h1><p>ä¸€å¥—æµ‹è¯•å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ bug ä¾¦æµ‹å™¨ï¼Œèƒ½å¤Ÿå¤§å¤§ç¼©å‡æŸ¥æ‰¾ bug æ‰€éœ€çš„æ—¶é—´ã€‚</p><p>äº‹å®ä¸Šï¼Œæ’°å†™æµ‹è¯•ä»£ç çš„æœ€å¥½æ—¶æœºæ˜¯åœ¨å¼€å§‹åŠ¨æ‰‹ç¼–ç ä¹‹å‰ã€‚å½“æˆ‘éœ€è¦æ·»åŠ ç‰¹æ€§æ—¶ï¼Œæˆ‘ä¼šå…ˆç¼–å†™ç›¸åº”çš„æµ‹è¯•ä»£ç ã€‚å¬èµ·æ¥ç¦»ç»å›é“ï¼Œå…¶å®ä¸ç„¶ã€‚ç¼–å†™æµ‹è¯•ä»£ç å…¶å®å°±æ˜¯åœ¨é—®è‡ªå·±ï¼šä¸ºäº†æ·»åŠ è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘éœ€è¦å®ç°äº›ä»€ä¹ˆï¼Ÿç¼–å†™æµ‹è¯•ä»£ç è¿˜èƒ½å¸®æˆ‘æŠŠæ³¨æ„åŠ›é›†ä¸­äºæ¥å£è€Œéå®ç°ï¼ˆè¿™æ°¸è¿œæ˜¯ä¸€ä»¶å¥½äº‹ï¼‰ã€‚é¢„å…ˆå†™å¥½çš„æµ‹è¯•ä»£ç ä¹Ÿä¸ºæˆ‘çš„å·¥ä½œå®‰ä¸Šä¸€ä¸ªæ˜ç¡®çš„ç»“æŸæ ‡å¿—ï¼šä¸€æ—¦æµ‹è¯•ä»£ç æ­£å¸¸è¿è¡Œï¼Œå·¥ä½œå°±å¯ä»¥ç»“æŸäº†ã€‚</p><p>Kent Beck å°†è¿™ç§å…ˆå†™æµ‹è¯•çš„ä¹ æƒ¯æç‚¼æˆä¸€é—¨æŠ€è‰ºï¼Œå«æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Developmentï¼ŒTDDï¼‰[mf-tdd]ã€‚æµ‹è¯•é©±åŠ¨å¼€å‘çš„ç¼–ç¨‹æ–¹å¼ä¾èµ–äºä¸‹é¢è¿™ä¸ªçŸ­å¾ªç¯ï¼šå…ˆç¼–å†™ä¸€ä¸ªï¼ˆå¤±è´¥çš„ï¼‰æµ‹è¯•ï¼Œç¼–å†™ä»£ç ä½¿æµ‹è¯•é€šè¿‡ï¼Œç„¶åè¿›è¡Œé‡æ„ä»¥ä¿è¯ä»£ç æ•´æ´ã€‚è¿™ä¸ªâ€œæµ‹è¯•ã€ç¼–ç ã€é‡æ„â€çš„å¾ªç¯åº”è¯¥åœ¨æ¯ä¸ªå°æ—¶å†…éƒ½å®Œæˆå¾ˆå¤šæ¬¡ã€‚è¿™ç§è‰¯å¥½çš„èŠ‚å¥æ„Ÿå¯ä½¿ç¼–ç¨‹å·¥ä½œä»¥æ›´åŠ é«˜æ•ˆã€æœ‰æ¡ä¸ç´Šçš„æ–¹å¼å¼€å±•ã€‚</p><h1 id="ç¬¬ä¸€ç»„é‡æ„">ç¬¬ä¸€ç»„é‡æ„</h1><h2 id="æç‚¼å‡½æ•°extract-function">æç‚¼å‡½æ•°ï¼ˆExtract Functionï¼‰</h2><p>æˆ‘ä¼šæµè§ˆä¸€æ®µä»£ç ï¼Œç†è§£å…¶ä½œç”¨ï¼Œç„¶åå°†å…¶æç‚¼åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­ï¼Œå¹¶ä»¥è¿™æ®µä»£ç çš„ç”¨é€”ä¸ºè¿™ä¸ªå‡½æ•°å‘½åã€‚å¦‚æœä½ éœ€è¦èŠ±æ—¶é—´æµè§ˆä¸€æ®µä»£ç æ‰èƒ½å¼„æ¸…å®ƒåˆ°åº•åœ¨å¹²ä»€ä¹ˆï¼Œé‚£ä¹ˆå°±åº”è¯¥å°†å…¶æç‚¼åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå¹¶æ ¹æ®å®ƒæ‰€åšçš„äº‹ä¸ºå…¶å‘½åã€‚ä»¥åå†è¯»åˆ°è¿™æ®µä»£ç æ—¶ï¼Œä½ ä¸€çœ¼å°±èƒ½çœ‹åˆ°å‡½æ•°çš„ç”¨é€”ï¼Œå¤§å¤šæ•°æ—¶å€™æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒå‡½æ•°å¦‚ä½•è¾¾æˆå…¶ç”¨é€”ï¼ˆè¿™æ˜¯å‡½æ•°ä½“å†…å¹²çš„äº‹ï¼‰ã€‚</p><h2 id="æç‚¼å˜é‡extract-variable">æç‚¼å˜é‡ï¼ˆExtract Variableï¼‰</h2><p>å¦‚æœæˆ‘è€ƒè™‘ä½¿ç”¨æç‚¼å˜é‡ï¼Œå°±æ„å‘³ç€æˆ‘è¦ç»™ä»£ç ä¸­çš„ä¸€ä¸ªè¡¨è¾¾å¼å‘½åã€‚ä¸€æ—¦å†³å®šè¦è¿™æ ·åšï¼Œæˆ‘å°±å¾—è€ƒè™‘è¿™ä¸ªåå­—æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¿™ä¸ªåå­—åªåœ¨å½“å‰çš„å‡½æ•°ä¸­æœ‰æ„ä¹‰ï¼Œé‚£ä¹ˆæç‚¼å˜é‡æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼›ä½†å¦‚æœè¿™ä¸ªå˜é‡ååœ¨æ›´å®½çš„ä¸Šä¸‹æ–‡ä¸­ä¹Ÿæœ‰æ„ä¹‰ï¼Œæˆ‘å°±ä¼šè€ƒè™‘å°†å…¶æš´éœ²å‡ºæ¥ï¼Œé€šå¸¸ä»¥å‡½æ•°çš„å½¢å¼ã€‚å¦‚æœåœ¨æ›´å®½çš„èŒƒå›´å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªåå­—ï¼Œå°±æ„å‘³ç€å…¶ä»–ä»£ç ä¹Ÿå¯ä»¥ç”¨åˆ°è¿™ä¸ªè¡¨è¾¾å¼ï¼Œè€Œä¸ç”¨æŠŠå®ƒé‡å†™ä¸€éï¼Œè¿™æ ·èƒ½å‡å°‘é‡å¤ï¼Œå¹¶ä¸”èƒ½æ›´å¥½åœ°è¡¨è¾¾æˆ‘çš„æ„å›¾ã€‚</p><h2 id="æ”¹å˜å‡½æ•°å£°æ˜change-function-declaration">æ”¹å˜å‡½æ•°å£°æ˜ï¼ˆChange Function Declarationï¼‰</h2><p>å¦‚æœæˆ‘çœ‹åˆ°ä¸€ä¸ªå‡½æ•°çš„åå­—ä¸å¯¹ï¼Œä¸€æ—¦å‘ç°äº†æ›´å¥½çš„åå­—ï¼Œå°±å¾—å°½å¿«ç»™å‡½æ•°æ”¹åã€‚è¿™æ ·ï¼Œä¸‹ä¸€æ¬¡å†çœ‹åˆ°è¿™æ®µä»£ç æ—¶ï¼Œæˆ‘å°±ä¸ç”¨å†è´¹åŠ›ææ‡‚å…¶ä¸­åˆ°åº•åœ¨å¹²ä»€ä¹ˆã€‚æœ‰ä¸€ä¸ªæ”¹è¿›å‡½æ•°åå­—çš„å¥½åŠæ³•ï¼šå…ˆå†™ä¸€å¥æ³¨é‡Šæè¿°è¿™ä¸ªå‡½æ•°çš„ç”¨é€”ï¼Œå†æŠŠè¿™å¥æ³¨é‡Šå˜æˆå‡½æ•°çš„åå­—ã€‚ï¼‰ ä¿®æ”¹å‚æ•°åˆ—è¡¨ä¸ä»…èƒ½å¢åŠ å‡½æ•°çš„åº”ç”¨èŒƒå›´ï¼Œè¿˜èƒ½æ”¹å˜è¿æ¥ä¸€ä¸ªæ¨¡å—æ‰€éœ€çš„æ¡ä»¶ï¼Œä»è€Œå»é™¤ä¸å¿…è¦çš„è€¦åˆã€‚å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å‚æ•°ï¼Œæ²¡æœ‰ç®€å•çš„è§„åˆ™å¯å¾ªã€‚æˆ‘å¯èƒ½æœ‰ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ”¯ä»˜æ˜¯å¦é€¾æœŸâ€”â€”å¦‚æœè¶…æœŸ 30 å¤©æœªä»˜æ¬¾ï¼Œé‚£ä¹ˆè¿™ç¬”æ”¯ä»˜å°±é€¾æœŸäº†ã€‚è¿™ä¸ªå‡½æ•°çš„å‚æ•°åº”è¯¥æ˜¯â€œæ”¯ä»˜â€ï¼ˆpaymentï¼‰å¯¹è±¡ï¼Œè¿˜æ˜¯æ”¯ä»˜çš„åˆ°æœŸæ—¥å‘¢ï¼Ÿå¦‚æœä½¿ç”¨æ”¯ä»˜å¯¹è±¡ï¼Œä¼šä½¿è¿™ä¸ªå‡½æ•°ä¸æ”¯ä»˜å¯¹è±¡çš„æ¥å£è€¦åˆï¼Œä½†å¥½å¤„æ˜¯å¯ä»¥å¾ˆå®¹æ˜“åœ°è®¿é—®åè€…çš„å…¶ä»–å±æ€§ï¼Œå½“â€œé€¾æœŸâ€çš„é€»è¾‘å‘ç”Ÿå˜åŒ–æ—¶å°±ä¸ç”¨ä¿®æ”¹æ‰€æœ‰è°ƒç”¨è¯¥å‡½æ•°çš„ä»£ç â€”â€”æ¢å¥è¯è¯´ï¼Œæé«˜äº†è¯¥å‡½æ•°çš„å°è£…åº¦ã€‚</p><h2 id="å°è£…å˜é‡encapsulate-variable">å°è£…å˜é‡ï¼ˆEncapsulate Variableï¼‰</h2><p>å¦‚æœæˆ‘æŠŠæ•°æ®æ¬èµ°ï¼Œå°±å¿…é¡»åŒæ—¶ä¿®æ”¹æ‰€æœ‰å¼•ç”¨è¯¥æ•°æ®çš„ä»£ç ï¼Œå¦åˆ™ç¨‹åºå°±ä¸èƒ½è¿è¡Œã€‚å¦‚æœæ•°æ®çš„å¯è®¿é—®èŒƒå›´å¾ˆå°ï¼Œæ¯”å¦‚ä¸€ä¸ªå°å‡½æ•°å†…éƒ¨çš„ä¸´æ—¶å˜é‡ï¼Œé‚£è¿˜ä¸æˆé—®é¢˜ã€‚ä½†å¦‚æœå¯è®¿é—®èŒƒå›´å˜å¤§ï¼Œé‡æ„çš„éš¾åº¦å°±ä¼šéšä¹‹å¢å¤§ï¼Œè¿™ä¹Ÿæ˜¯è¯´å…¨å±€æ•°æ®æ˜¯å¤§éº»çƒ¦çš„åŸå› ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦æ¬ç§»ä¸€å¤„è¢«å¹¿æ³›ä½¿ç”¨çš„æ•°æ®ï¼Œæœ€å¥½çš„åŠæ³•å¾€å¾€æ˜¯å…ˆä»¥å‡½æ•°å½¢å¼å°è£…æ‰€æœ‰å¯¹è¯¥æ•°æ®çš„è®¿é—®ã€‚è¿™æ ·ï¼Œæˆ‘å°±èƒ½æŠŠâ€œé‡æ–°ç»„ç»‡æ•°æ®â€çš„å›°éš¾ä»»åŠ¡è½¬åŒ–ä¸ºâ€œé‡æ–°ç»„ç»‡å‡½æ•°â€è¿™ä¸ªç›¸å¯¹ç®€å•çš„ä»»åŠ¡ã€‚</p><p>å°è£…æ•°æ®çš„ä»·å€¼è¿˜ä¸æ­¢äºæ­¤ã€‚å°è£…èƒ½æä¾›ä¸€ä¸ªæ¸…æ™°çš„è§‚æµ‹ç‚¹ï¼Œå¯ä»¥ç”±æ­¤ç›‘æ§æ•°æ®çš„å˜åŒ–å’Œä½¿ç”¨æƒ…å†µï¼›æˆ‘è¿˜å¯ä»¥è½»æ¾åœ°æ·»åŠ æ•°æ®è¢«ä¿®æ”¹æ—¶çš„éªŒè¯æˆ–åç»­é€»è¾‘ã€‚æˆ‘çš„ä¹ æƒ¯æ˜¯ï¼šå¯¹äºæ‰€æœ‰å¯å˜çš„æ•°æ®ï¼Œåªè¦å®ƒçš„ä½œç”¨åŸŸè¶…å‡ºå•ä¸ªå‡½æ•°ï¼Œæˆ‘å°±ä¼šå°†å…¶å°è£…èµ·æ¥ï¼Œåªå…è®¸é€šè¿‡å‡½æ•°è®¿é—®ã€‚æ•°æ®çš„ä½œç”¨åŸŸè¶Šå¤§ï¼Œå°è£…å°±è¶Šé‡è¦ã€‚</p><h2 id="å¼•å…¥å‚æ•°å¯¹è±¡introduce-parameter-object">å¼•å…¥å‚æ•°å¯¹è±¡ï¼ˆIntroduce Parameter Objectï¼‰</h2><p>æˆ‘å¸¸ä¼šçœ‹è§ï¼Œä¸€ç»„æ•°æ®é¡¹æ€»æ˜¯ç»“ä¼´åŒè¡Œï¼Œå‡ºæ²¡äºä¸€ä¸ªåˆä¸€ä¸ªå‡½æ•°ã€‚è¿™æ ·ä¸€ç»„æ•°æ®å°±æ˜¯æ‰€è°“çš„æ•°æ®æ³¥å›¢ï¼Œæˆ‘å–œæ¬¢ä»£ä¹‹ä»¥ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>è¿™é¡¹é‡æ„çœŸæ­£çš„æ„ä¹‰åœ¨äºï¼Œå®ƒä¼šå‚¬ç”Ÿä»£ç ä¸­æ›´æ·±å±‚æ¬¡çš„æ”¹å˜ã€‚ä¸€æ—¦è¯†åˆ«å‡ºæ–°çš„æ•°æ®ç»“æ„ï¼Œæˆ‘å°±å¯ä»¥é‡ç»„ç¨‹åºçš„è¡Œä¸ºæ¥ä½¿ç”¨è¿™äº›ç»“æ„ã€‚æˆ‘ä¼šåˆ›å»ºå‡ºå‡½æ•°æ¥æ•æ‰å›´ç»•è¿™äº›æ•°æ®çš„å…±ç”¨è¡Œä¸ºâ€”â€”å¯èƒ½åªæ˜¯ä¸€ç»„å…±ç”¨çš„å‡½æ•°ï¼Œä¹Ÿå¯èƒ½ç”¨ä¸€ä¸ªç±»æŠŠæ•°æ®ç»“æ„ä¸ä½¿ç”¨æ•°æ®çš„å‡½æ•°ç»„åˆèµ·æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæ”¹å˜ä»£ç çš„æ¦‚å¿µå›¾æ™¯ï¼Œå°†è¿™äº›æ•°æ®ç»“æ„æå‡ä¸ºæ–°çš„æŠ½è±¡æ¦‚å¿µï¼Œå¯ä»¥å¸®åŠ©æˆ‘æ›´å¥½åœ°ç†è§£é—®é¢˜åŸŸã€‚</p><h2 id="å‡½æ•°ç»„åˆæˆç±»combine-functions-into-class">å‡½æ•°ç»„åˆæˆç±»ï¼ˆCombine Functions into Classï¼‰</h2><p>å¦‚æœå‘ç°ä¸€ç»„å‡½æ•°å½¢å½±ä¸ç¦»åœ°æ“ä½œåŒä¸€å—æ•°æ®ï¼ˆé€šå¸¸æ˜¯å°†è¿™å—æ•°æ®ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼‰ï¼Œæˆ‘å°±è®¤ä¸ºï¼Œæ˜¯æ—¶å€™ç»„å»ºä¸€ä¸ªç±»äº†ã€‚ç±»èƒ½æ˜ç¡®åœ°ç»™è¿™äº›å‡½æ•°æä¾›ä¸€ä¸ªå…±ç”¨çš„ç¯å¢ƒï¼Œåœ¨å¯¹è±¡å†…éƒ¨è°ƒç”¨è¿™äº›å‡½æ•°å¯ä»¥å°‘ä¼ è®¸å¤šå‚æ•°ï¼Œä»è€Œç®€åŒ–å‡½æ•°è°ƒç”¨ï¼Œå¹¶ä¸”è¿™æ ·ä¸€ä¸ªå¯¹è±¡ä¹Ÿå¯ä»¥æ›´æ–¹ä¾¿åœ°ä¼ é€’ç»™ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚</p><h2 id="æ‹†åˆ†é˜¶æ®µsplit-phase">æ‹†åˆ†é˜¶æ®µï¼ˆSplit Phaseï¼‰</h2><p>æ¯å½“çœ‹è§ä¸€æ®µä»£ç åœ¨åŒæ—¶å¤„ç†ä¸¤ä»¶ä¸åŒçš„äº‹ï¼Œæˆ‘å°±æƒ³æŠŠå®ƒæ‹†åˆ†æˆå„è‡ªç‹¬ç«‹çš„æ¨¡å—ï¼Œå› ä¸ºè¿™æ ·åˆ°äº†éœ€è¦ä¿®æ”¹çš„æ—¶å€™ï¼Œæˆ‘å°±å¯ä»¥å•ç‹¬å¤„ç†æ¯ä¸ªä¸»é¢˜ï¼Œè€Œä¸å¿…åŒæ—¶åœ¨è„‘å­é‡Œè€ƒè™‘ä¸¤ä¸ªä¸åŒçš„ä¸»é¢˜ã€‚å¦‚æœè¿æ°”å¤Ÿå¥½çš„è¯ï¼Œæˆ‘å¯èƒ½åªéœ€è¦ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªæ¨¡å—ï¼Œå®Œå…¨ä¸ç”¨å›å¿†èµ·å¦ä¸€ä¸ªæ¨¡å—çš„è¯¸èˆ¬ç»†èŠ‚ã€‚</p><p>æœ€ç®€æ´çš„æ‹†åˆ†æ–¹æ³•ä¹‹ä¸€ï¼Œå°±æ˜¯æŠŠä¸€å¤§æ®µè¡Œä¸ºåˆ†æˆé¡ºåºæ‰§è¡Œçš„ä¸¤ä¸ªé˜¶æ®µã€‚å¦‚æœä¸€å—ä»£ç ä¸­å‡ºç°äº†ä¸Šä¸‹å‡ æ®µï¼Œå„è‡ªä½¿ç”¨ä¸åŒçš„ä¸€ç»„æ•°æ®å’Œå‡½æ•°ï¼Œè¿™å°±æ˜¯æœ€æ˜æ˜¾çš„çº¿ç´¢ã€‚å°†è¿™äº›ä»£ç ç‰‡æ®µæ‹†åˆ†æˆå„è‡ªç‹¬ç«‹çš„æ¨¡å—ï¼Œèƒ½æ›´æ˜ç¡®åœ°æ ‡ç¤ºå‡ºå®ƒä»¬ä¹‹é—´çš„å·®å¼‚ã€‚</p><h1 id="å°è£…">å°è£…</h1><h2 id="å°è£…è®°å½•encapsulate-record">å°è£…è®°å½•ï¼ˆEncapsulate Recordï¼‰</h2><p>è®°å½•å‹ç»“æ„æ˜¯å¤šæ•°ç¼–ç¨‹è¯­è¨€æä¾›çš„ä¸€ç§å¸¸è§ç‰¹æ€§ã€‚å®ƒä»¬èƒ½ç›´è§‚åœ°ç»„ç»‡èµ·å­˜åœ¨å…³è”çš„æ•°æ®ï¼Œè®©æˆ‘å¯ä»¥å°†æ•°æ®ä½œä¸ºæœ‰æ„ä¹‰çš„å•å…ƒä¼ é€’ï¼Œè€Œä¸ä»…æ˜¯ä¸€å †æ•°æ®çš„æ‹¼å‡‘ã€‚ä½†ç®€å•çš„è®°å½•å‹ç»“æ„ä¹Ÿæœ‰ç¼ºé™·ï¼Œæœ€æ¼äººçš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒå¼ºè¿«æˆ‘æ¸…æ™°åœ°åŒºåˆ†â€œè®°å½•ä¸­å­˜å‚¨çš„æ•°æ®â€å’Œâ€œé€šè¿‡è®¡ç®—å¾—åˆ°çš„æ•°æ®â€ã€‚å‡ä½¿æˆ‘è¦æè¿°ä¸€ä¸ªæ•´æ•°é—­åŒºé—´ï¼Œæˆ‘å¯ä»¥ç”¨{start: 1, end: 5}æè¿°ï¼Œæˆ–è€…ç”¨{start: 1, length: 5}ï¼ˆç”šè‡³è¿˜èƒ½ç”¨{end: 5, length: 5}ï¼Œå¦‚æœæˆ‘æƒ³éœ²ä¸¤æ‰‹åä¸½çš„ç¼–ç¨‹æŠ€å·§çš„è¯ï¼‰ã€‚ä½†ä¸è®ºå¦‚ä½•å­˜å‚¨ï¼Œè¿™ 3 ä¸ªå€¼éƒ½æ˜¯æˆ‘æƒ³çŸ¥é“çš„ï¼Œå³åŒºé—´çš„èµ·ç‚¹ï¼ˆstartï¼‰å’Œç»ˆç‚¹ï¼ˆendï¼‰ï¼Œä»¥åŠåŒºé—´çš„é•¿åº¦ï¼ˆlengthï¼‰ã€‚</p><p>è¿™å°±æ˜¯å¯¹äºå¯å˜æ•°æ®ï¼Œæˆ‘æ€»æ˜¯æ›´åçˆ±ä½¿ç”¨ç±»å¯¹è±¡è€Œéè®°å½•çš„åŸå› ã€‚å¯¹è±¡å¯ä»¥éšè—ç»“æ„çš„ç»†èŠ‚ï¼Œä»…ä¸ºè¿™ 3 ä¸ªå€¼æä¾›å¯¹åº”çš„æ–¹æ³•ã€‚è¯¥å¯¹è±¡çš„ç”¨æˆ·ä¸å¿…è¿½ç©¶å­˜å‚¨çš„ç»†èŠ‚å’Œè®¡ç®—çš„è¿‡ç¨‹ã€‚åŒæ—¶ï¼Œè¿™ç§å°è£…è¿˜æœ‰åŠ©äºå­—æ®µçš„æ”¹åï¼šæˆ‘å¯ä»¥é‡æ–°å‘½åå­—æ®µï¼Œä½†åŒæ—¶æä¾›æ–°è€å­—æ®µåçš„è®¿é—®æ–¹æ³•ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥æ¸è¿›åœ°ä¿®æ”¹è°ƒç”¨æ–¹ï¼Œç›´åˆ°æ›¿æ¢å…¨éƒ¨å®Œæˆã€‚</p><h2 id="å°è£…é›†åˆencapsulate-collection">å°è£…é›†åˆï¼ˆEncapsulate Collectionï¼‰</h2><p>å°è£…é›†åˆæ—¶äººä»¬å¸¸å¸¸çŠ¯ä¸€ä¸ªé”™è¯¯ï¼šåªå¯¹é›†åˆå˜é‡çš„è®¿é—®è¿›è¡Œäº†å°è£…ï¼Œä½†ä¾ç„¶è®©å–å€¼å‡½æ•°è¿”å›é›†åˆæœ¬èº«ã€‚è¿™ä½¿å¾—é›†åˆçš„æˆå‘˜å˜é‡å¯ä»¥ç›´æ¥è¢«ä¿®æ”¹ï¼Œè€Œå°è£…å®ƒçš„ç±»åˆ™å…¨ç„¶ä¸çŸ¥ï¼Œæ— æ³•ä»‹å…¥ã€‚ ä¸€ç§é¿å…ç›´æ¥ä¿®æ”¹é›†åˆçš„æ–¹æ³•æ˜¯ï¼Œæ°¸è¿œä¸ç›´æ¥è¿”å›é›†åˆçš„å€¼ã€‚è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ï¼Œä»¥æŸç§å½¢å¼é™åˆ¶é›†åˆçš„è®¿é—®æƒï¼Œåªå…è®¸å¯¹é›†åˆè¿›è¡Œè¯»æ“ä½œã€‚</p><h2 id="ä»¥æŸ¥è¯¢å–ä»£ä¸´æ—¶å˜é‡replace-temp-with-query">ä»¥æŸ¥è¯¢å–ä»£ä¸´æ—¶å˜é‡ï¼ˆReplace Temp with Queryï¼‰</h2><p>è¿™é¡¹é‡æ„æ‰‹æ³•åœ¨ç±»ä¸­æ–½å±•æ•ˆæœæœ€å¥½ï¼Œå› ä¸ºç±»ä¸ºå¾…æç‚¼å‡½æ•°æä¾›äº†ä¸€ä¸ªå…±åŒçš„ä¸Šä¸‹æ–‡ã€‚å¦‚æœä¸æ˜¯åœ¨ç±»ä¸­ï¼Œæˆ‘å¾ˆå¯èƒ½ä¼šåœ¨é¡¶å±‚å‡½æ•°ä¸­æ‹¥æœ‰è¿‡å¤šå‚æ•°ï¼Œè¿™å°†å†²æ·¡æç‚¼å‡½æ•°æ‰€èƒ½å¸¦æ¥çš„è¯¸å¤šå¥½å¤„ã€‚ ä»¥æŸ¥è¯¢å–ä»£ä¸´æ—¶å˜é‡æ‰‹æ³•åªé€‚ç”¨äºå¤„ç†æŸäº›ç±»å‹çš„ä¸´æ—¶å˜é‡ï¼šé‚£äº›åªè¢«è®¡ç®—ä¸€æ¬¡ä¸”ä¹‹åä¸å†è¢«ä¿®æ”¹çš„å˜é‡ã€‚</p><h2 id="éšè—å§”æ‰˜å…³ç³»hide-delegate">éšè—å§”æ‰˜å…³ç³»ï¼ˆHide Delegateï¼‰</h2><p>å¦‚æœæŸäº›å®¢æˆ·ç«¯å…ˆé€šè¿‡æœåŠ¡å¯¹è±¡çš„å­—æ®µå¾—åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼ˆå—æ‰˜ç±»ï¼‰ï¼Œç„¶åè°ƒç”¨åè€…çš„å‡½æ•°ï¼Œé‚£ä¹ˆå®¢æˆ·å°±å¿…é¡»çŸ¥æ™“è¿™ä¸€å±‚å§”æ‰˜å…³ç³»ã€‚ä¸‡ä¸€å—æ‰˜ç±»ä¿®æ”¹äº†æ¥å£ï¼Œå˜åŒ–ä¼šæ³¢åŠé€šè¿‡æœåŠ¡å¯¹è±¡ä½¿ç”¨å®ƒçš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚æˆ‘å¯ä»¥åœ¨æœåŠ¡å¯¹è±¡ä¸Šæ”¾ç½®ä¸€ä¸ªç®€å•çš„å§”æ‰˜å‡½æ•°ï¼Œå°†å§”æ‰˜å…³ç³»éšè—èµ·æ¥ï¼Œä»è€Œå»é™¤è¿™ç§ä¾èµ–ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œå³ä½¿å°†æ¥å§”æ‰˜å…³ç³»å‘ç”Ÿå˜åŒ–ï¼Œå˜åŒ–ä¹Ÿåªä¼šå½±å“æœåŠ¡å¯¹è±¡ï¼Œè€Œä¸ä¼šç›´æ¥æ³¢åŠæ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p><h2 id="ç§»é™¤ä¸­é—´äººremove-middle-man">ç§»é™¤ä¸­é—´äººï¼ˆRemove Middle Manï¼‰</h2><p>åœ¨éšè—å§”æ‰˜å…³ç³»çš„â€œåŠ¨æœºâ€ä¸€èŠ‚ä¸­ï¼Œæˆ‘è°ˆåˆ°äº†â€œå°è£…å—æ‰˜å¯¹è±¡â€çš„å¥½å¤„ã€‚ä½†æ˜¯è¿™å±‚å°è£…ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ã€‚æ¯å½“å®¢æˆ·ç«¯è¦ä½¿ç”¨å—æ‰˜ç±»çš„æ–°ç‰¹æ€§æ—¶ï¼Œä½ å°±å¿…é¡»åœ¨æœåŠ¡ç«¯æ·»åŠ ä¸€ä¸ªç®€å•å§”æ‰˜å‡½æ•°ã€‚éšç€å—æ‰˜ç±»çš„ç‰¹æ€§ï¼ˆåŠŸèƒ½ï¼‰è¶Šæ¥è¶Šå¤šï¼Œæ›´å¤šçš„è½¬å‘å‡½æ•°å°±ä¼šä½¿äººçƒ¦èºã€‚æœåŠ¡ç±»å®Œå…¨å˜æˆäº†ä¸€ä¸ªä¸­é—´äººï¼Œæ­¤æ—¶å°±åº”è¯¥è®©å®¢æˆ·ç›´æ¥è°ƒç”¨å—æ‰˜ç±»ã€‚</p><p>å¾ˆéš¾è¯´ä»€ä¹ˆç¨‹åº¦çš„éšè—æ‰æ˜¯åˆé€‚çš„ã€‚è¿˜å¥½ï¼Œæœ‰äº†éšè—å§”æ‰˜å…³ç³»ï¼ˆ189ï¼‰å’Œåˆ é™¤ä¸­é—´äººï¼Œæˆ‘å¤§å¯ä¸å¿…æ“å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæˆ‘å¯ä»¥åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­è¿›è¡Œè°ƒæ•´ã€‚éšç€ä»£ç çš„å˜åŒ–ï¼Œâ€œåˆé€‚çš„éšè—ç¨‹åº¦â€è¿™ä¸ªå°ºåº¦ä¹Ÿç›¸åº”æ”¹å˜ã€‚</p><h1 id="ç®€åŒ–æ¡ä»¶é€»è¾‘">ç®€åŒ–æ¡ä»¶é€»è¾‘</h1><h2 id="åˆ†è§£æ¡ä»¶è¡¨è¾¾å¼decompose-conditional">åˆ†è§£æ¡ä»¶è¡¨è¾¾å¼ï¼ˆDecompose Conditionalï¼‰</h2><p>åœ¨å¸¦æœ‰å¤æ‚æ¡ä»¶é€»è¾‘çš„å‡½æ•°ä¸­ï¼Œä»£ç ä¼šå‘Šè¯‰æˆ‘å‘ç”Ÿçš„äº‹ï¼Œä½†å¸¸å¸¸è®©æˆ‘å¼„ä¸æ¸…æ¥šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™æ ·çš„äº‹ï¼Œè¿™å°±è¯´æ˜ä»£ç çš„å¯è¯»æ€§çš„ç¡®å¤§å¤§é™ä½äº†ã€‚å’Œä»»ä½•å¤§å—å¤´ä»£ç ä¸€æ ·ï¼Œæˆ‘å¯ä»¥å°†å®ƒåˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼Œæ ¹æ®æ¯ä¸ªå°å—ä»£ç çš„ç”¨é€”ï¼Œä¸ºåˆ†è§£è€Œå¾—çš„æ–°å‡½æ•°å‘½åï¼Œå¹¶å°†åŸå‡½æ•°ä¸­å¯¹åº”çš„ä»£ç æ”¹ä¸ºè°ƒç”¨æ–°å‡½æ•°ï¼Œä»è€Œæ›´æ¸…æ¥šåœ°è¡¨è¾¾è‡ªå·±çš„æ„å›¾ã€‚å¯¹äºæ¡ä»¶é€»è¾‘ï¼Œå°†æ¯ä¸ªåˆ†æ”¯æ¡ä»¶åˆ†è§£æˆæ–°å‡½æ•°è¿˜å¯ä»¥å¸¦æ¥æ›´å¤šå¥½å¤„ï¼šå¯ä»¥çªå‡ºæ¡ä»¶é€»è¾‘ï¼Œæ›´æ¸…æ¥šåœ°è¡¨æ˜æ¯ä¸ªåˆ†æ”¯çš„ä½œç”¨ï¼Œå¹¶ä¸”çªå‡ºæ¯ä¸ªåˆ†æ”¯çš„åŸå› ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!aDate.isBefore(plan.summerStart) &amp;amp;&amp;amp; !aDate.isAfter(plan.summerEnd))</span><br><span class="line"> charge = quantity * plan.summerRate;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> charge = quantity * plan.regularRate + plan.regularServiceCharge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (summer())</span><br><span class="line"> charge = summerCharge();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> charge = regularCharge();</span><br></pre></td></tr></tbody></table></figure><h2 id="ä»¥å«è¯­å¥å–ä»£åµŒå¥—æ¡ä»¶è¡¨è¾¾å¼replace-nested-conditional-with-guard-clauses">ä»¥å«è¯­å¥å–ä»£åµŒå¥—æ¡ä»¶è¡¨è¾¾å¼ï¼ˆReplace Nested Conditional with Guard Clausesï¼‰</h2><p>æ ¹æ®æˆ‘çš„ç»éªŒï¼Œæ¡ä»¶è¡¨è¾¾å¼é€šå¸¸æœ‰ä¸¤ç§é£æ ¼ã€‚ç¬¬ä¸€ç§é£æ ¼æ˜¯ï¼šä¸¤ä¸ªæ¡ä»¶åˆ†æ”¯éƒ½å±äºæ­£å¸¸è¡Œä¸ºã€‚ç¬¬äºŒç§é£æ ¼åˆ™æ˜¯ï¼šåªæœ‰ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œå¦ä¸€ä¸ªåˆ†æ”¯åˆ™æ˜¯å¼‚å¸¸çš„æƒ…å†µã€‚</p><p>è¿™ä¸¤ç±»æ¡ä»¶è¡¨è¾¾å¼æœ‰ä¸åŒçš„ç”¨é€”ï¼Œè¿™ä¸€ç‚¹åº”è¯¥é€šè¿‡ä»£ç è¡¨ç°å‡ºæ¥ã€‚å¦‚æœä¸¤æ¡åˆ†æ”¯éƒ½æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œå°±åº”è¯¥ä½¿ç”¨å½¢å¦‚ if...else... çš„æ¡ä»¶è¡¨è¾¾å¼ï¼›å¦‚æœæŸä¸ªæ¡ä»¶æå…¶ç½•è§ï¼Œå°±åº”è¯¥å•ç‹¬æ£€æŸ¥è¯¥æ¡ä»¶ï¼Œå¹¶åœ¨è¯¥æ¡ä»¶ä¸ºçœŸæ—¶ç«‹åˆ»ä»å‡½æ•°ä¸­è¿”å›ã€‚è¿™æ ·çš„å•ç‹¬æ£€æŸ¥å¸¸å¸¸è¢«ç§°ä¸ºâ€œå«è¯­å¥â€ï¼ˆguard clausesï¼‰ã€‚</p><p>ä»¥å«è¯­å¥å–ä»£åµŒå¥—æ¡ä»¶è¡¨è¾¾å¼çš„ç²¾é«“å°±æ˜¯ï¼šç»™æŸä¸€æ¡åˆ†æ”¯ä»¥ç‰¹åˆ«çš„é‡è§†ã€‚å¦‚æœä½¿ç”¨ if-then-else ç»“æ„ï¼Œä½ å¯¹ if åˆ†æ”¯å’Œ else åˆ†æ”¯çš„é‡è§†æ˜¯åŒç­‰çš„ã€‚è¿™æ ·çš„ä»£ç ç»“æ„ä¼ é€’ç»™é˜…è¯»è€…çš„æ¶ˆæ¯å°±æ˜¯ï¼šå„ä¸ªåˆ†æ”¯æœ‰åŒæ ·çš„é‡è¦æ€§ã€‚å«è¯­å¥å°±ä¸åŒäº†ï¼Œå®ƒå‘Šè¯‰é˜…è¯»è€…ï¼šâ€œè¿™ç§æƒ…å†µä¸æ˜¯æœ¬å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘æ‰€å…³å¿ƒçš„ï¼Œå¦‚æœå®ƒçœŸå‘ç”Ÿäº†ï¼Œè¯·åšä¸€äº›å¿…è¦çš„æ•´ç†å·¥ä½œï¼Œç„¶åé€€å‡ºã€‚â€</p><h2 id="ä»¥å¤šæ€å–ä»£æ¡ä»¶è¡¨è¾¾å¼replace-conditional-with-polymorphism">ä»¥å¤šæ€å–ä»£æ¡ä»¶è¡¨è¾¾å¼ï¼ˆReplace Conditional with Polymorphismï¼‰</h2><p>å¤æ‚çš„æ¡ä»¶é€»è¾‘æ˜¯ç¼–ç¨‹ä¸­æœ€éš¾ç†è§£çš„ä¸œè¥¿ä¹‹ä¸€ï¼Œå› æ­¤æˆ‘ä¸€ç›´åœ¨å¯»æ±‚ç»™æ¡ä»¶é€»è¾‘æ·»åŠ ç»“æ„ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘å‘ç°å¯ä»¥å°†æ¡ä»¶é€»è¾‘æ‹†åˆ†åˆ°ä¸åŒçš„åœºæ™¯ï¼ˆæˆ–è€…å«é«˜é˜¶ç”¨ä¾‹ï¼‰ï¼Œä»è€Œæ‹†è§£å¤æ‚çš„æ¡ä»¶é€»è¾‘ã€‚è¿™ç§æ‹†åˆ†æœ‰æ—¶ç”¨æ¡ä»¶é€»è¾‘æœ¬èº«çš„ç»“æ„å°±è¶³ä»¥è¡¨è¾¾ï¼Œä½†ä½¿ç”¨ç±»å’Œå¤šæ€èƒ½æŠŠé€»è¾‘çš„æ‹†åˆ†è¡¨è¿°å¾—æ›´æ¸…æ™°ã€‚</p><p>å¤šæ€æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å…³é”®ç‰¹æ€§ä¹‹ä¸€ã€‚è·Ÿå…¶ä»–ä¸€åˆ‡æœ‰ç”¨çš„ç‰¹æ€§ä¸€æ ·ï¼Œå®ƒä¹Ÿå¾ˆå®¹æ˜“è¢«æ»¥ç”¨ã€‚æˆ‘æ›¾ç»é‡åˆ°æœ‰äººäº‰è®ºè¯´æ‰€æœ‰æ¡ä»¶é€»è¾‘éƒ½åº”è¯¥ç”¨å¤šæ€å–ä»£ã€‚æˆ‘ä¸èµåŒè¿™ç§è§‚ç‚¹ã€‚æˆ‘çš„å¤§éƒ¨åˆ†æ¡ä»¶é€»è¾‘åªç”¨åˆ°äº†åŸºæœ¬çš„æ¡ä»¶è¯­å¥â€”â€”if/else å’Œ switch/caseï¼Œå¹¶ä¸éœ€è¦åŠ³å¸ˆåŠ¨ä¼—åœ°å¼•å…¥å¤šæ€ã€‚ä½†å¦‚æœå‘ç°å¦‚å‰æ‰€è¿°çš„å¤æ‚æ¡ä»¶é€»è¾‘ï¼Œå¤šæ€æ˜¯æ”¹å–„è¿™ç§æƒ…å†µçš„æœ‰åŠ›å·¥å…·ã€‚</p><h2 id="å¼•å…¥æ–­è¨€introduce-assertion">å¼•å…¥æ–­è¨€ï¼ˆIntroduce Assertionï¼‰</h2><p>æ–­è¨€æ˜¯ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œåº”è¯¥æ€»æ˜¯ä¸ºçœŸã€‚å¦‚æœå®ƒå¤±è´¥ï¼Œè¡¨ç¤ºç¨‹åºå‘˜çŠ¯äº†é”™è¯¯ã€‚æ–­è¨€çš„å¤±è´¥ä¸åº”è¯¥è¢«ç³»ç»Ÿä»»ä½•åœ°æ–¹æ•æ‰ã€‚æ•´ä¸ªç¨‹åºçš„è¡Œä¸ºåœ¨æœ‰æ²¡æœ‰æ–­è¨€å‡ºç°çš„æ—¶å€™éƒ½åº”è¯¥å®Œå…¨ä¸€æ ·ã€‚å®é™…ä¸Šï¼Œæœ‰äº›ç¼–ç¨‹è¯­è¨€ä¸­çš„æ–­è¨€å¯ä»¥åœ¨ç¼–è¯‘æœŸç”¨ä¸€ä¸ªå¼€å…³å®Œå…¨ç¦ç”¨æ‰ã€‚</p><h1 id="å¤„ç†ç»§æ‰¿å…³ç³»">å¤„ç†ç»§æ‰¿å…³ç³»</h1><h2 id="ä»¥å­ç±»å–ä»£ç±»å‹ç replace-type-code-with-subclasses">ä»¥å­ç±»å–ä»£ç±»å‹ç ï¼ˆReplace Type Code with Subclassesï¼‰</h2><p>è½¯ä»¶ç³»ç»Ÿç»å¸¸éœ€è¦è¡¨ç°â€œç›¸ä¼¼ä½†åˆä¸åŒçš„ä¸œè¥¿â€ï¼Œæ¯”å¦‚å‘˜å·¥å¯ä»¥æŒ‰èŒä½åˆ†ç±»ï¼ˆå·¥ç¨‹å¸ˆã€ç»ç†ã€é”€å”®ï¼‰ï¼Œè®¢å•å¯ä»¥æŒ‰ä¼˜å…ˆçº§åˆ†ç±»ï¼ˆåŠ æ€¥ã€å¸¸è§„ï¼‰ã€‚è¡¨ç°åˆ†ç±»å…³ç³»çš„ç¬¬ä¸€ç§å·¥å…·æ˜¯ç±»å‹ç å­—æ®µâ€”â€”æ ¹æ®å…·ä½“çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯èƒ½å®ç°ä¸ºæšä¸¾ã€ç¬¦å·ã€å­—ç¬¦ä¸²æˆ–è€…æ•°å­—ã€‚ç±»å‹ç çš„å–å€¼ç»å¸¸æ¥è‡ªç»™ç³»ç»Ÿæä¾›æ•°æ®çš„å¤–éƒ¨æœåŠ¡ã€‚</p><p>å¤§å¤šæ•°æ—¶å€™ï¼Œæœ‰è¿™æ ·çš„ç±»å‹ç å°±å¤Ÿäº†ã€‚ä½†ä¹Ÿæœ‰äº›æ—¶å€™ï¼Œæˆ‘å¯ä»¥å†å¤šå¾€å‰ä¸€æ­¥ï¼Œå¼•å…¥å­ç±»ã€‚ç»§æ‰¿æœ‰ä¸¤ä¸ªè¯±äººä¹‹å¤„ã€‚é¦–å…ˆï¼Œä½ å¯ä»¥ç”¨å¤šæ€æ¥å¤„ç†æ¡ä»¶é€»è¾‘ã€‚å¦å¤–ï¼Œæœ‰äº›å­—æ®µæˆ–å‡½æ•°åªå¯¹ç‰¹å®šçš„ç±»å‹ç å–å€¼æ‰æœ‰æ„ä¹‰ï¼Œä¾‹å¦‚â€œé”€å”®ç›®æ ‡â€åªå¯¹â€œé”€å”®â€è¿™ç±»å‘˜å·¥æ‰æœ‰æ„ä¹‰ã€‚æ­¤æ—¶æˆ‘å¯ä»¥åˆ›å»ºå­ç±»ï¼Œç„¶åç”¨å­—æ®µä¸‹ç§»æŠŠè¿™æ ·çš„å­—æ®µæ”¾åˆ°åˆé€‚çš„å­ç±»ä¸­å»ã€‚å½“ç„¶ï¼Œæˆ‘ä¹Ÿå¯ä»¥åŠ å…¥éªŒè¯é€»è¾‘ï¼Œç¡®ä¿åªæœ‰å½“ç±»å‹ç å–å€¼æ­£ç¡®æ—¶æ‰ä½¿ç”¨è¯¥å­—æ®µï¼Œä¸è¿‡å­ç±»çš„å½¢å¼èƒ½æ›´æ˜ç¡®åœ°è¡¨è¾¾æ•°æ®ä¸ç±»å‹ä¹‹é—´çš„å…³ç³»ã€‚</p><h2 id="ä»¥å§”æ‰˜å–ä»£å­ç±»replace-subclass-with-delegate">ä»¥å§”æ‰˜å–ä»£å­ç±»ï¼ˆReplace Subclass with Delegate</h2><p>ç»§æ‰¿ä¹Ÿæœ‰å…¶çŸ­æ¿ã€‚æœ€æ˜æ˜¾çš„æ˜¯ï¼Œç»§æ‰¿è¿™å¼ ç‰Œåªèƒ½æ‰“ä¸€æ¬¡ã€‚å¯¼è‡´è¡Œä¸ºä¸åŒçš„åŸå› å¯èƒ½æœ‰å¤šç§ï¼Œä½†ç»§æ‰¿åªèƒ½ç”¨äºå¤„ç†ä¸€ä¸ªæ–¹å‘ä¸Šçš„å˜åŒ–ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘å¯èƒ½å¸Œæœ›â€œäººâ€çš„è¡Œä¸ºæ ¹æ®â€œå¹´é¾„æ®µâ€ä¸åŒï¼Œå¹¶ä¸”æ ¹æ®â€œæ”¶å…¥æ°´å¹³â€ä¸åŒã€‚ä½¿ç”¨ç»§æ‰¿çš„è¯ï¼Œå­ç±»å¯ä»¥æ˜¯â€œå¹´è½»äººâ€å’Œâ€œè€äººâ€ï¼Œä¹Ÿå¯ä»¥æ˜¯â€œå¯Œäººâ€å’Œâ€œç©·äººâ€ï¼Œä½†ä¸èƒ½åŒæ—¶é‡‡ç”¨ä¸¤ç§ç»§æ‰¿æ–¹å¼ã€‚æ›´å¤§çš„é—®é¢˜åœ¨äºï¼Œç»§æ‰¿ç»™ç±»ä¹‹é—´å¼•å…¥äº†éå¸¸ç´§å¯†çš„å…³ç³»ã€‚åœ¨è¶…ç±»ä¸Šåšä»»ä½•ä¿®æ”¹ï¼Œéƒ½å¾ˆå¯èƒ½ç ´åå­ç±»ï¼Œæ‰€ä»¥æˆ‘å¿…é¡»éå¸¸å°å¿ƒï¼Œå¹¶ä¸”å……åˆ†ç†è§£å­ç±»å¦‚ä½•ä»è¶…ç±»æ´¾ç”Ÿã€‚</p><p>è¿™ä¸¤ä¸ªé—®é¢˜ç”¨å§”æ‰˜éƒ½èƒ½è§£å†³ã€‚å¯¹äºä¸åŒçš„å˜åŒ–åŸå› ï¼Œæˆ‘å¯ä»¥å§”æ‰˜ç»™ä¸åŒçš„ç±»ã€‚å§”æ‰˜æ˜¯å¯¹è±¡ä¹‹é—´å¸¸è§„çš„å…³ç³»ã€‚ä¸ç»§æ‰¿å…³ç³»ç›¸æ¯”ï¼Œä½¿ç”¨å§”æ‰˜å…³ç³»æ—¶æ¥å£æ›´æ¸…æ™°ã€è€¦åˆæ›´å°‘ã€‚å› æ­¤ï¼Œç»§æ‰¿å…³ç³»é‡åˆ°é—®é¢˜æ—¶è¿ç”¨ä»¥å§”æ‰˜å–ä»£å­ç±»æ˜¯å¸¸è§çš„æƒ…å†µã€‚æœ‰ä¸€æ¡æµè¡Œçš„åŸåˆ™ï¼šâ€œå¯¹è±¡ç»„åˆä¼˜äºç±»ç»§æ‰¿â€ï¼ˆâ€œç»„åˆâ€è·Ÿâ€œå§”æ‰˜â€æ˜¯åŒä¸€å›äº‹ï¼‰ã€‚</p><h2 id="ä»¥å§”æ‰˜å–ä»£è¶…ç±»replace-superclass-with-delegate">ä»¥å§”æ‰˜å–ä»£è¶…ç±»ï¼ˆReplace Superclass with Delegateï¼‰</h2><p>å¦‚æœè¶…ç±»çš„ä¸€äº›å‡½æ•°å¯¹å­ç±»å¹¶ä¸é€‚ç”¨ï¼Œå°±è¯´æ˜æˆ‘ä¸åº”è¯¥é€šè¿‡ç»§æ‰¿æ¥è·å¾—è¶…ç±»çš„åŠŸèƒ½ã€‚é™¤äº†â€œå­ç±»ç”¨å¾—ä¸Šè¶…ç±»çš„æ‰€æœ‰å‡½æ•°â€ä¹‹å¤–ï¼Œåˆç†çš„ç»§æ‰¿å…³ç³»è¿˜æœ‰ä¸€ä¸ªé‡è¦ç‰¹å¾ï¼šå­ç±»çš„æ‰€æœ‰å®ä¾‹éƒ½åº”è¯¥æ˜¯è¶…ç±»çš„å®ä¾‹ï¼Œé€šè¿‡è¶…ç±»çš„æ¥å£æ¥ä½¿ç”¨å­ç±»çš„å®ä¾‹åº”è¯¥å®Œå…¨ä¸å‡ºé—®é¢˜ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé‡æ„ æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly9ib29rLXJlZmFjdG9yaW5nMi5pZm1pY3JvLmNvbS9kb2NzL2NoMy5odG1s">https://book-refactoring2.ifmicro.com/docs/ch3.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Refactor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡æ„ï¼ˆäºŒï¼‰ä»£ç çš„åå‘³é“</title>
      <link href="/2022/Program/RefactorPart2/"/>
      <url>/2022/Program/RefactorPart2/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/BadCodeSmell.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyYjg4NTBlM2U3NDA3ZGE1MWRmYjE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ç¥ç§˜å‘½åmysterious-name">ç¥ç§˜å‘½åï¼ˆMysterious Nameï¼‰</h1><p>æ•´æ´ä»£ç æœ€é‡è¦çš„ä¸€ç¯å°±æ˜¯å¥½çš„åå­—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæ·±æ€ç†Ÿè™‘å¦‚ä½•ç»™å‡½æ•°ã€æ¨¡å—ã€å˜é‡å’Œç±»å‘½åï¼Œä½¿å®ƒä»¬èƒ½æ¸…æ™°åœ°è¡¨æ˜è‡ªå·±çš„åŠŸèƒ½å’Œç”¨æ³•ã€‚ ç„¶è€Œï¼Œå¾ˆé—æ†¾ï¼Œå‘½åæ˜¯ç¼–ç¨‹ä¸­æœ€éš¾çš„ä¸¤ä»¶äº‹ä¹‹ä¸€ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæ”¹åå¯èƒ½æ˜¯æœ€å¸¸ç”¨çš„é‡æ„æ‰‹æ³•ï¼ŒåŒ…æ‹¬æ”¹å˜å‡½æ•°å£°æ˜ï¼ˆç”¨äºç»™å‡½æ•°æ”¹åï¼‰ã€å˜é‡æ”¹åã€å­—æ®µæ”¹åç­‰ã€‚å¾ˆå¤šäººç»å¸¸ä¸æ„¿æ„ç»™ç¨‹åºå…ƒç´ æ”¹åï¼Œè§‰å¾—ä¸å€¼å¾—è´¹è¿™ä¸ªåŠ²ï¼Œä½†å¥½çš„åå­—èƒ½èŠ‚çœæœªæ¥ç”¨åœ¨çŒœè°œä¸Šçš„å¤§æŠŠæ—¶é—´ã€‚</p><p>æ”¹åä¸ä»…ä»…æ˜¯ä¿®æ”¹åå­—è€Œå·²ã€‚å¦‚æœä½ æƒ³ä¸å‡ºä¸€ä¸ªå¥½åå­—ï¼Œè¯´æ˜èƒŒåå¾ˆå¯èƒ½æ½œè—ç€æ›´æ·±çš„è®¾è®¡é—®é¢˜ã€‚ä¸ºä¸€ä¸ªæ¼äººçš„åå­—æ‰€ä»˜å‡ºçš„çº ç»“ï¼Œå¸¸å¸¸èƒ½æ¨åŠ¨æˆ‘ä»¬å¯¹ä»£ç è¿›è¡Œç²¾ç®€ã€‚</p><h1 id="é‡å¤ä»£ç duplicated-code">é‡å¤ä»£ç ï¼ˆDuplicated Codeï¼‰</h1><p>å¦‚æœä½ åœ¨ä¸€ä¸ªä»¥ä¸Šçš„åœ°ç‚¹çœ‹åˆ°ç›¸åŒçš„ä»£ç ç»“æ„ï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®šï¼šè®¾æ³•å°†å®ƒä»¬åˆè€Œä¸ºä¸€ï¼Œç¨‹åºä¼šå˜å¾—æ›´å¥½ã€‚ä¸€æ—¦æœ‰é‡å¤ä»£ç å­˜åœ¨ï¼Œé˜…è¯»è¿™äº›é‡å¤çš„ä»£ç æ—¶ä½ å°±å¿…é¡»åŠ å€ä»”ç»†ï¼Œç•™æ„å…¶é—´ç»†å¾®çš„å·®å¼‚ã€‚å¦‚æœè¦ä¿®æ”¹é‡å¤ä»£ç ï¼Œä½ å¿…é¡»æ‰¾å‡ºæ‰€æœ‰çš„å‰¯æœ¬æ¥ä¿®æ”¹ã€‚</p><p>æœ€å•çº¯çš„é‡å¤ä»£ç å°±æ˜¯â€œåŒä¸€ä¸ªç±»çš„ä¸¤ä¸ªå‡½æ•°å«æœ‰ç›¸åŒçš„è¡¨è¾¾å¼â€ã€‚è¿™æ—¶å€™ä½ éœ€è¦åšçš„å°±æ˜¯é‡‡ç”¨æç‚¼å‡½æ•°æç‚¼å‡ºé‡å¤çš„ä»£ç ï¼Œç„¶åè®©è¿™ä¸¤ä¸ªåœ°ç‚¹éƒ½è°ƒç”¨è¢«æç‚¼å‡ºæ¥çš„é‚£ä¸€æ®µä»£ç ã€‚å¦‚æœé‡å¤ä»£ç åªæ˜¯ç›¸ä¼¼è€Œä¸æ˜¯å®Œå…¨ç›¸åŒï¼Œè¯·é¦–å…ˆå°è¯•ç”¨ç§»åŠ¨è¯­å¥é‡ç»„ä»£ç é¡ºåºï¼ŒæŠŠç›¸ä¼¼çš„éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ä»¥ä¾¿æç‚¼ã€‚å¦‚æœé‡å¤çš„ä»£ç æ®µä½äºåŒä¸€ä¸ªè¶…ç±»çš„ä¸åŒå­ç±»ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ä¸Šç§»æ¥é¿å…åœ¨ä¸¤ä¸ªå­ç±»ä¹‹é—´äº’ç›¸è°ƒç”¨ã€‚</p><h1 id="è¿‡é•¿å‡½æ•°long-function">è¿‡é•¿å‡½æ•°ï¼ˆLong Functionï¼‰</h1><p>æˆ‘ä»¬éµå¾ªè¿™æ ·ä¸€æ¡åŸåˆ™ï¼šæ¯å½“æ„Ÿè§‰éœ€è¦ä»¥æ³¨é‡Šæ¥è¯´æ˜ç‚¹ä»€ä¹ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æŠŠéœ€è¦è¯´æ˜çš„ä¸œè¥¿å†™è¿›ä¸€ä¸ªç‹¬ç«‹å‡½æ•°ä¸­ï¼Œå¹¶ä»¥å…¶ç”¨é€”ï¼ˆè€Œéå®ç°æ‰‹æ³•ï¼‰å‘½åã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä¸€ç»„ç”šè‡³çŸ­çŸ­ä¸€è¡Œä»£ç åšè¿™ä»¶äº‹ã€‚å“ªæ€•æ›¿æ¢åçš„å‡½æ•°è°ƒç”¨åŠ¨ä½œæ¯”å‡½æ•°è‡ªèº«è¿˜é•¿ï¼Œåªè¦å‡½æ•°åç§°èƒ½å¤Ÿè§£é‡Šå…¶ç”¨é€”ï¼Œæˆ‘ä»¬ä¹Ÿè¯¥æ¯«ä¸çŠ¹è±«åœ°é‚£ä¹ˆåšã€‚å…³é”®ä¸åœ¨äºå‡½æ•°çš„é•¿åº¦ï¼Œè€Œåœ¨äºå‡½æ•°â€œåšä»€ä¹ˆâ€å’Œâ€œå¦‚ä½•åšâ€ä¹‹é—´çš„è¯­ä¹‰è·ç¦»ã€‚</p><p>å¦‚æœå‡½æ•°å†…æœ‰å¤§é‡çš„å‚æ•°å’Œä¸´æ—¶å˜é‡ï¼Œå®ƒä»¬ä¼šå¯¹ä½ çš„å‡½æ•°æç‚¼å½¢æˆé˜»ç¢ã€‚å¦‚æœä½ å°è¯•è¿ç”¨æç‚¼å‡½æ•°ï¼Œæœ€ç»ˆå°±ä¼šæŠŠè®¸å¤šå‚æ•°ä¼ é€’ç»™è¢«æç‚¼å‡ºæ¥çš„æ–°å‡½æ•°ï¼Œå¯¼è‡´å¯è¯»æ€§å‡ ä¹æ²¡æœ‰ä»»ä½•æå‡ã€‚æ­¤æ—¶ï¼Œä½ å¯ä»¥ç»å¸¸è¿ç”¨ä»¥æŸ¥è¯¢å–ä»£ä¸´æ—¶å˜é‡æ¥æ¶ˆé™¤è¿™äº›ä¸´æ—¶å…ƒç´ ã€‚å¼•å…¥å‚æ•°å¯¹è±¡å’Œä¿æŒå¯¹è±¡å®Œæ•´åˆ™å¯ä»¥å°†è¿‡é•¿çš„å‚æ•°åˆ—è¡¨å˜å¾—æ›´ç®€æ´ä¸€äº›ã€‚</p><p>å¦‚æœä½ å·²ç»è¿™ä¹ˆåšäº†ï¼Œä»ç„¶æœ‰å¤ªå¤šä¸´æ—¶å˜é‡å’Œå‚æ•°ï¼Œé‚£å°±åº”è¯¥ä½¿å‡ºæˆ‘ä»¬çš„æ€æ‰‹é”â€”â€”ä»¥å‘½ä»¤å–ä»£å‡½æ•°ã€‚</p><p>å¦‚ä½•ç¡®å®šè¯¥æç‚¼å“ªä¸€æ®µä»£ç å‘¢ï¼Ÿä¸€ä¸ªå¾ˆå¥½çš„æŠ€å·§æ˜¯ï¼šå¯»æ‰¾æ³¨é‡Šã€‚å®ƒä»¬é€šå¸¸èƒ½æŒ‡å‡ºä»£ç ç”¨é€”å’Œå®ç°æ‰‹æ³•ä¹‹é—´çš„è¯­ä¹‰è·ç¦»ã€‚å¦‚æœä»£ç å‰æ–¹æœ‰ä¸€è¡Œæ³¨é‡Šï¼Œå°±æ˜¯åœ¨æé†’ä½ ï¼šå¯ä»¥å°†è¿™æ®µä»£ç æ›¿æ¢æˆä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”å¯ä»¥åœ¨æ³¨é‡Šçš„åŸºç¡€ä¸Šç»™è¿™ä¸ªå‡½æ•°å‘½åã€‚å°±ç®—åªæœ‰ä¸€è¡Œä»£ç ï¼Œå¦‚æœå®ƒéœ€è¦ä»¥æ³¨é‡Šæ¥è¯´æ˜ï¼Œé‚£ä¹Ÿå€¼å¾—å°†å®ƒæç‚¼åˆ°ç‹¬ç«‹å‡½æ•°ä¸­å»ã€‚</p><p>æ¡ä»¶è¡¨è¾¾å¼å’Œå¾ªç¯å¸¸å¸¸ä¹Ÿæ˜¯æç‚¼çš„ä¿¡å·ã€‚ä½ å¯ä»¥ä½¿ç”¨åˆ†è§£æ¡ä»¶è¡¨è¾¾å¼å¤„ç†æ¡ä»¶è¡¨è¾¾å¼ã€‚å¯¹äºåºå¤§çš„ switch è¯­å¥ï¼Œå…¶ä¸­çš„æ¯ä¸ªåˆ†æ”¯éƒ½åº”è¯¥é€šè¿‡æç‚¼å‡½æ•°å˜æˆç‹¬ç«‹çš„å‡½æ•°è°ƒç”¨ã€‚å¦‚æœæœ‰å¤šä¸ª switch è¯­å¥åŸºäºåŒä¸€ä¸ªæ¡ä»¶è¿›è¡Œåˆ†æ”¯é€‰æ‹©ï¼Œå°±åº”è¯¥ä½¿ç”¨ä»¥å¤šæ€å–ä»£æ¡ä»¶è¡¨è¾¾å¼ã€‚</p><p>è‡³äºå¾ªç¯ï¼Œä½ åº”è¯¥å°†å¾ªç¯å’Œå¾ªç¯å†…çš„ä»£ç æç‚¼åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­ã€‚å¦‚æœä½ å‘ç°æç‚¼å‡ºçš„å¾ªç¯å¾ˆéš¾å‘½åï¼Œå¯èƒ½æ˜¯å› ä¸ºå…¶ä¸­åšäº†å‡ ä»¶ä¸åŒçš„äº‹ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œè¯·å‹‡æ•¢åœ°ä½¿ç”¨æ‹†åˆ†å¾ªç¯å°†å…¶æ‹†åˆ†æˆå„è‡ªç‹¬ç«‹çš„ä»»åŠ¡ã€‚</p><h1 id="è¿‡é•¿å‚æ•°åˆ—è¡¨long-parameter-list">è¿‡é•¿å‚æ•°åˆ—è¡¨ï¼ˆLong Parameter Listï¼‰</h1><p>åˆšå¼€å§‹å­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œè€å¸ˆæ•™æˆ‘ä»¬ï¼šæŠŠå‡½æ•°æ‰€éœ€çš„æ‰€æœ‰ä¸œè¥¿éƒ½ä»¥å‚æ•°çš„å½¢å¼ä¼ é€’è¿›å»ã€‚è¿™å¯ä»¥ç†è§£ï¼Œå› ä¸ºé™¤æ­¤ä¹‹å¤–å°±åªèƒ½é€‰æ‹©å…¨å±€æ•°æ®ï¼Œè€Œå…¨å±€æ•°æ®å¾ˆå¿«å°±ä¼šå˜æˆé‚ªæ¶çš„ä¸œè¥¿ã€‚ä½†è¿‡é•¿çš„å‚æ•°åˆ—è¡¨æœ¬èº«ä¹Ÿç»å¸¸ä»¤äººè¿·æƒ‘ã€‚</p><p>å¦‚æœå¯ä»¥å‘æŸä¸ªå‚æ•°å‘èµ·æŸ¥è¯¢è€Œè·å¾—å¦ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ä»¥æŸ¥è¯¢å–ä»£å‚æ•°å»æ‰è¿™ç¬¬äºŒä¸ªå‚æ•°ã€‚å¦‚æœä½ å‘ç°è‡ªå·±æ­£åœ¨ä»ç°æœ‰çš„æ•°æ®ç»“æ„ä¸­æŠ½å‡ºå¾ˆå¤šæ•°æ®é¡¹ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¿æŒå¯¹è±¡å®Œæ•´æ‰‹æ³•ï¼Œç›´æ¥ä¼ å…¥åŸæ¥çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæœ‰å‡ é¡¹å‚æ•°æ€»æ˜¯åŒæ—¶å‡ºç°ï¼Œå¯ä»¥ç”¨å¼•å…¥å‚æ•°å¯¹è±¡å°†å…¶åˆå¹¶æˆä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœæŸä¸ªå‚æ•°è¢«ç”¨ä½œåŒºåˆ†å‡½æ•°è¡Œä¸ºçš„æ ‡è®°ï¼ˆflagï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ç§»é™¤æ ‡è®°å‚æ•°ã€‚</p><p>ä½¿ç”¨ç±»å¯ä»¥æœ‰æ•ˆåœ°ç¼©çŸ­å‚æ•°åˆ—è¡¨ã€‚å¦‚æœå¤šä¸ªå‡½æ•°æœ‰åŒæ ·çš„å‡ ä¸ªå‚æ•°ï¼Œå¼•å…¥ä¸€ä¸ªç±»å°±å°¤ä¸ºæœ‰æ„ä¹‰ã€‚ä½ å¯ä»¥ä½¿ç”¨å‡½æ•°ç»„åˆæˆç±»ï¼Œå°†è¿™äº›å…±åŒçš„å‚æ•°å˜æˆè¿™ä¸ªç±»çš„å­—æ®µã€‚å¦‚æœæˆ´ä¸Šå‡½æ•°å¼ç¼–ç¨‹çš„å¸½å­ï¼Œæˆ‘ä»¬ä¼šè¯´ï¼Œè¿™ä¸ªé‡æ„è¿‡ç¨‹åˆ›é€ äº†ä¸€ç»„éƒ¨åˆ†åº”ç”¨å‡½æ•°ï¼ˆpartially applied functionï¼‰ã€‚</p><h1 id="å…¨å±€æ•°æ®global-data">å…¨å±€æ•°æ®ï¼ˆGlobal Dataï¼‰</h1><p>å…¨å±€æ•°æ®çš„é—®é¢˜åœ¨äºï¼Œä»ä»£ç åº“çš„ä»»ä½•ä¸€ä¸ªè§’è½éƒ½å¯ä»¥ä¿®æ”¹å®ƒï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•æœºåˆ¶å¯ä»¥æ¢æµ‹å‡ºåˆ°åº•å“ªæ®µä»£ç åšå‡ºäº†ä¿®æ”¹ã€‚ä¸€æ¬¡åˆä¸€æ¬¡ï¼Œå…¨å±€æ•°æ®é€ æˆäº†é‚£äº›è¯¡å¼‚çš„ bugï¼Œè€Œé—®é¢˜çš„æ ¹æºå´åœ¨é¥è¿œçš„åˆ«å¤„ï¼Œæƒ³è¦æ‰¾åˆ°å‡ºé”™çš„ä»£ç éš¾äºç™»å¤©ã€‚å…¨å±€æ•°æ®æœ€æ˜¾è€Œæ˜“è§çš„å½¢å¼å°±æ˜¯å…¨å±€å˜é‡ï¼Œä½†ç±»å˜é‡å’Œå•ä¾‹ï¼ˆsingletonï¼‰ä¹Ÿæœ‰è¿™æ ·çš„é—®é¢˜ã€‚</p><p>é¦–è¦çš„é˜²å¾¡æ‰‹æ®µæ˜¯å°è£…å˜é‡ï¼Œæ¯å½“æˆ‘ä»¬çœ‹åˆ°å¯èƒ½è¢«å„å¤„çš„ä»£ç æ±¡æŸ“çš„æ•°æ®ï¼Œè¿™æ€»æ˜¯æˆ‘ä»¬åº”å¯¹çš„ç¬¬ä¸€æ‹›ã€‚ä½ æŠŠå…¨å±€æ•°æ®ç”¨ä¸€ä¸ªå‡½æ•°åŒ…è£…èµ·æ¥ï¼Œè‡³å°‘ä½ å°±èƒ½çœ‹è§ä¿®æ”¹å®ƒçš„åœ°æ–¹ï¼Œå¹¶å¼€å§‹æ§åˆ¶å¯¹å®ƒçš„è®¿é—®ã€‚éšåï¼Œæœ€å¥½å°†è¿™ä¸ªå‡½æ•°ï¼ˆåŠå…¶å°è£…çš„æ•°æ®ï¼‰æ¬ç§»åˆ°ä¸€ä¸ªç±»æˆ–æ¨¡å—ä¸­ï¼Œåªå…è®¸æ¨¡å—å†…çš„ä»£ç ä½¿ç”¨å®ƒï¼Œä»è€Œå°½é‡æ§åˆ¶å…¶ä½œç”¨åŸŸã€‚</p><p>å…¨å±€æ•°æ®å°è¯äº†å¸•æ‹‰å¡å°”æ–¯çš„æ ¼è¨€ï¼šè‰¯è¯ä¸æ¯’è¯çš„åŒºåˆ«åœ¨äºå‰‚é‡ã€‚æœ‰å°‘é‡çš„å…¨å±€æ•°æ®æˆ–è®¸æ— å¦¨ï¼Œä½†æ•°é‡è¶Šå¤šï¼Œå¤„ç†çš„éš¾åº¦å°±ä¼šæŒ‡æ•°ä¸Šå‡ã€‚å³ä¾¿åªæ˜¯å°‘é‡çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿæ„¿æ„å°†å®ƒå°è£…èµ·æ¥ï¼Œè¿™æ˜¯åœ¨è½¯ä»¶æ¼”è¿›è¿‡ç¨‹ä¸­åº”å¯¹å˜åŒ–çš„å…³é”®æ‰€åœ¨ã€‚</p><h1 id="å¯å˜æ•°æ®mutable-data">å¯å˜æ•°æ®ï¼ˆMutable Dataï¼‰</h1><p>å¯¹æ•°æ®çš„ä¿®æ”¹ç»å¸¸å¯¼è‡´å‡ºä¹æ„æ–™çš„ç»“æœå’Œéš¾ä»¥å‘ç°çš„ bugã€‚æˆ‘åœ¨ä¸€å¤„æ›´æ–°æ•°æ®ï¼Œå´æ²¡æœ‰æ„è¯†åˆ°è½¯ä»¶ä¸­çš„å¦ä¸€å¤„æœŸæœ›ç€å®Œå…¨ä¸åŒçš„æ•°æ®ï¼Œäºæ˜¯ä¸€ä¸ªåŠŸèƒ½å¤±æ•ˆäº†â€”â€”å¦‚æœæ•…éšœåªåœ¨å¾ˆç½•è§çš„æƒ…å†µä¸‹å‘ç”Ÿï¼Œè¦æ‰¾å‡ºæ•…éšœåŸå› å°±ä¼šæ›´åŠ å›°éš¾ã€‚å› æ­¤ï¼Œæœ‰ä¸€æ•´ä¸ªè½¯ä»¶å¼€å‘æµæ´¾â€”â€”å‡½æ•°å¼ç¼–ç¨‹â€”â€”å®Œå…¨å»ºç«‹åœ¨â€œæ•°æ®æ°¸ä¸æ”¹å˜â€çš„æ¦‚å¿µåŸºç¡€ä¸Šï¼šå¦‚æœè¦æ›´æ–°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå°±è¿”å›ä¸€ä»½æ–°çš„æ•°æ®å‰¯æœ¬ï¼Œæ—§çš„æ•°æ®ä»ä¿æŒä¸å˜ã€‚ ä¸è¿‡è¿™æ ·çš„ç¼–ç¨‹è¯­è¨€ä»ç„¶ç›¸å¯¹å°ä¼—ï¼Œå¤§å¤šæ•°ç¨‹åºå‘˜ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€è¿˜æ˜¯å…è®¸ä¿®æ”¹å˜é‡å€¼çš„ã€‚å³ä¾¿å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿä¸åº”è¯¥å¿½è§†ä¸å¯å˜æ€§å¸¦æ¥çš„ä¼˜åŠ¿â€”â€”ä»ç„¶æœ‰å¾ˆå¤šåŠæ³•å¯ä»¥ç”¨äºçº¦æŸå¯¹æ•°æ®çš„æ›´æ–°ï¼Œé™ä½å…¶é£é™©ã€‚ å¯ä»¥ç”¨å°è£…å˜é‡æ¥ç¡®ä¿æ‰€æœ‰æ•°æ®æ›´æ–°æ“ä½œéƒ½é€šè¿‡å¾ˆå°‘å‡ ä¸ªå‡½æ•°æ¥è¿›è¡Œï¼Œä½¿å…¶æ›´å®¹æ˜“ç›‘æ§å’Œæ¼”è¿›ã€‚å¦‚æœä¸€ä¸ªå˜é‡åœ¨ä¸åŒæ—¶å€™è¢«ç”¨äºå­˜å‚¨ä¸åŒçš„ä¸œè¥¿ï¼Œå¯ä»¥ä½¿ç”¨æ‹†åˆ†å˜é‡å°†å…¶æ‹†åˆ†ä¸ºå„è‡ªä¸åŒç”¨é€”çš„å˜é‡ï¼Œä»è€Œé¿å…å±é™©çš„æ›´æ–°æ“ä½œã€‚ å¦‚æœå¯å˜æ•°æ®çš„å€¼èƒ½åœ¨å…¶ä»–åœ°æ–¹è®¡ç®—å‡ºæ¥ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç‰¹åˆ«åˆºé¼»çš„åå‘³é“ã€‚å®ƒä¸ä»…ä¼šé€ æˆå›°æ‰°ã€bug å’ŒåŠ ç­ï¼Œè€Œä¸”æ¯«æ— å¿…è¦ã€‚æ¶ˆé™¤è¿™ç§åå‘³é“çš„åŠæ³•å¾ˆç®€å•ï¼Œä½¿ç”¨ä»¥æŸ¥è¯¢å–ä»£æ´¾ç”Ÿå˜é‡å³å¯ã€‚ å¦‚æœå˜é‡ä½œç”¨åŸŸåªæœ‰å‡ è¡Œä»£ç ï¼Œå³ä½¿å…¶ä¸­çš„æ•°æ®å¯å˜ï¼Œä¹Ÿä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼›ä½†éšç€å˜é‡ä½œç”¨åŸŸçš„æ‰©å±•ï¼Œé£é™©ä¹Ÿéšä¹‹å¢å¤§ã€‚å¯ä»¥ç”¨å‡½æ•°ç»„åˆæˆç±»æˆ–è€…å‡½æ•°ç»„åˆæˆå˜æ¢æ¥é™åˆ¶éœ€è¦å¯¹å˜é‡è¿›è¡Œä¿®æ”¹çš„ä»£ç é‡ã€‚å¦‚æœä¸€ä¸ªå˜é‡åœ¨å…¶å†…éƒ¨ç»“æ„ä¸­åŒ…å«äº†æ•°æ®ï¼Œé€šå¸¸æœ€å¥½ä¸è¦ç›´æ¥ä¿®æ”¹å…¶ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯ç”¨å°†å¼•ç”¨å¯¹è±¡æ”¹ä¸ºå€¼å¯¹è±¡ä»¤å…¶ç›´æ¥æ›¿æ¢æ•´ä¸ªæ•°æ®ç»“æ„ã€‚</p><h1 id="å‘æ•£å¼å˜åŒ–divergent-change">å‘æ•£å¼å˜åŒ–ï¼ˆDivergent Changeï¼‰</h1><p>å¦‚æœæŸä¸ªæ¨¡å—ç»å¸¸å› ä¸ºä¸åŒçš„åŸå› åœ¨ä¸åŒçš„æ–¹å‘ä¸Šå‘ç”Ÿå˜åŒ–ï¼Œå‘æ•£å¼å˜åŒ–å°±å‡ºç°äº†ã€‚å½“ä½ çœ‹ç€ä¸€ä¸ªç±»è¯´ï¼šâ€œå‘ƒï¼Œå¦‚æœæ–°åŠ å…¥ä¸€ä¸ªæ•°æ®åº“ï¼Œæˆ‘å¿…é¡»ä¿®æ”¹è¿™ 3 ä¸ªå‡½æ•°ï¼Œâ€è¿™å°±æ˜¯å‘æ•£å¼å˜åŒ–çš„å¾å…†ã€‚ å¦‚æœå‘ç”Ÿå˜åŒ–çš„ä¸¤ä¸ªæ–¹å‘è‡ªç„¶åœ°å½¢æˆäº†å…ˆåæ¬¡åºï¼Œå°±å¯ä»¥ç”¨æ‹†åˆ†é˜¶æ®µå°†ä¸¤è€…åˆ†å¼€ï¼Œä¸¤è€…ä¹‹é—´é€šè¿‡ä¸€ä¸ªæ¸…æ™°çš„æ•°æ®ç»“æ„è¿›è¡Œæ²Ÿé€šã€‚å¦‚æœä¸¤ä¸ªæ–¹å‘ä¹‹é—´æœ‰æ›´å¤šçš„æ¥å›è°ƒç”¨ï¼Œå°±åº”è¯¥å…ˆåˆ›å»ºé€‚å½“çš„æ¨¡å—ï¼Œç„¶åç”¨æ¬ç§»å‡½æ•°æŠŠå¤„ç†é€»è¾‘åˆ†å¼€ã€‚å¦‚æœå‡½æ•°å†…éƒ¨æ··åˆäº†ä¸¤ç±»å¤„ç†é€»è¾‘ï¼Œåº”è¯¥å…ˆç”¨æç‚¼å‡½æ•°å°†å…¶åˆ†å¼€ï¼Œç„¶åå†åšæ¬ç§»ã€‚å¦‚æœæ¨¡å—æ˜¯ä»¥ç±»çš„å½¢å¼å®šä¹‰çš„ï¼Œå°±å¯ä»¥ç”¨æç‚¼ç±»æ¥åšæ‹†åˆ†ã€‚</p><h1 id="éœ°å¼¹å¼ä¿®æ”¹shotgun-surgery">éœ°å¼¹å¼ä¿®æ”¹ï¼ˆShotgun Surgeryï¼‰</h1><p>éœ°å¼¹å¼ä¿®æ”¹ç±»ä¼¼äºå‘æ•£å¼å˜åŒ–ï¼Œä½†åˆæ°æ°ç›¸åã€‚å¦‚æœæ¯é‡åˆ°æŸç§å˜åŒ–ï¼Œä½ éƒ½å¿…é¡»åœ¨è®¸å¤šä¸åŒçš„ç±»å†…åšå‡ºè®¸å¤šå°ä¿®æ”¹ï¼Œä½ æ‰€é¢ä¸´çš„åå‘³é“å°±æ˜¯éœ°å¼¹å¼ä¿®æ”¹ã€‚å¦‚æœéœ€è¦ä¿®æ”¹çš„ä»£ç æ•£å¸ƒå››å¤„ï¼Œä½ ä¸ä½†å¾ˆéš¾æ‰¾åˆ°å®ƒä»¬ï¼Œä¹Ÿå¾ˆå®¹æ˜“é”™è¿‡æŸä¸ªé‡è¦çš„ä¿®æ”¹ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥ä½¿ç”¨æ¬ç§»å‡½æ•°å’Œæ¬ç§»å­—æ®µæŠŠæ‰€æœ‰éœ€è¦ä¿®æ”¹çš„ä»£ç æ”¾è¿›åŒä¸€ä¸ªæ¨¡å—é‡Œã€‚å¦‚æœæœ‰å¾ˆå¤šå‡½æ•°éƒ½åœ¨æ“ä½œç›¸ä¼¼çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ç»„åˆæˆç±»ã€‚å¦‚æœæœ‰äº›å‡½æ•°çš„åŠŸèƒ½æ˜¯è½¬åŒ–æˆ–è€…å……å®æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ç»„åˆæˆå˜æ¢ã€‚å¦‚æœä¸€äº›å‡½æ•°çš„è¾“å‡ºå¯ä»¥ç»„åˆåæä¾›ç»™ä¸€æ®µä¸“é—¨ä½¿ç”¨è¿™äº›è®¡ç®—ç»“æœçš„é€»è¾‘ï¼Œè¿™ç§æ—¶å€™å¸¸å¸¸ç”¨å¾—ä¸Šæ‹†åˆ†é˜¶æ®µã€‚</p><p>é¢å¯¹éœ°å¼¹å¼ä¿®æ”¹ï¼Œä¸€ä¸ªå¸¸ç”¨çš„ç­–ç•¥å°±æ˜¯ä½¿ç”¨ä¸å†…è”ï¼ˆinlineï¼‰ç›¸å…³çš„é‡æ„â€”â€”å¦‚å†…è”å‡½æ•°æˆ–æ˜¯å†…è”ç±»â€”â€”æŠŠæœ¬ä¸è¯¥åˆ†æ•£çš„é€»è¾‘æ‹½å›ä¸€å¤„ã€‚å®Œæˆå†…è”ä¹‹åï¼Œä½ å¯èƒ½ä¼šé—»åˆ°è¿‡é•¿å‡½æ•°æˆ–è€…è¿‡å¤§çš„ç±»çš„å‘³é“ï¼Œä¸è¿‡ä½ æ€»å¯ä»¥ç”¨ä¸æç‚¼ç›¸å…³çš„é‡æ„æ‰‹æ³•å°†å…¶æ‹†è§£æˆæ›´åˆç†çš„å°å—ã€‚å³ä¾¿å¦‚æ­¤é’Ÿçˆ±å°å‹çš„å‡½æ•°å’Œç±»ï¼Œæˆ‘ä»¬ä¹Ÿå¹¶ä¸æ‹…å¿ƒåœ¨é‡æ„çš„è¿‡ç¨‹ä¸­æš‚æ—¶åˆ›å»ºä¸€äº›è¾ƒå¤§çš„ç¨‹åºå•å…ƒã€‚</p><h1 id="ä¾æ‹æƒ…ç»“feature-envy">ä¾æ‹æƒ…ç»“ï¼ˆFeature Envyï¼‰</h1><p>æ‰€è°“æ¨¡å—åŒ–ï¼Œå°±æ˜¯åŠ›æ±‚å°†ä»£ç åˆ†å‡ºåŒºåŸŸï¼Œæœ€å¤§åŒ–åŒºåŸŸå†…éƒ¨çš„äº¤äº’ã€æœ€å°åŒ–è·¨åŒºåŸŸçš„äº¤äº’ã€‚ä½†æœ‰æ—¶ä½ ä¼šå‘ç°ï¼Œä¸€ä¸ªå‡½æ•°è·Ÿå¦ä¸€ä¸ªæ¨¡å—ä¸­çš„å‡½æ•°æˆ–è€…æ•°æ®äº¤æµæ ¼å¤–é¢‘ç¹ï¼Œè¿œèƒœäºåœ¨è‡ªå·±æ‰€å¤„æ¨¡å—å†…éƒ¨çš„äº¤æµï¼Œè¿™å°±æ˜¯ä¾æ‹æƒ…ç»“çš„å…¸å‹æƒ…å†µã€‚æ— æ•°æ¬¡ç»éªŒé‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°æŸä¸ªå‡½æ•°ä¸ºäº†è®¡ç®—æŸä¸ªå€¼ï¼Œä»å¦ä¸€ä¸ªå¯¹è±¡é‚£å„¿è°ƒç”¨å‡ ä¹åŠæ‰“çš„å–å€¼å‡½æ•°ã€‚ç–—æ³•æ˜¾è€Œæ˜“è§ï¼šè¿™ä¸ªå‡½æ•°æƒ³è·Ÿè¿™äº›æ•°æ®å¾…åœ¨ä¸€èµ·ï¼Œé‚£å°±ä½¿ç”¨æ¬ç§»å‡½æ•°æŠŠå®ƒç§»è¿‡å»ã€‚æœ‰æ—¶å€™ï¼Œå‡½æ•°ä¸­åªæœ‰ä¸€éƒ¨åˆ†å—è¿™ç§ä¾æ‹ä¹‹è‹¦ï¼Œè¿™æ—¶å€™åº”è¯¥ä½¿ç”¨æç‚¼å‡½æ•°æŠŠè¿™ä¸€éƒ¨åˆ†æç‚¼åˆ°ç‹¬ç«‹çš„å‡½æ•°ä¸­ï¼Œå†ä½¿ç”¨æ¬ç§»å‡½æ•°å¸¦å®ƒå»å®ƒçš„æ¢¦æƒ³å®¶å›­ã€‚</p><p>å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰æƒ…å†µéƒ½è¿™ä¹ˆç®€å•ã€‚ä¸€ä¸ªå‡½æ•°å¾€å¾€ä¼šç”¨åˆ°å‡ ä¸ªæ¨¡å—çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå®ƒç©¶ç«Ÿè¯¥è¢«ç½®äºä½•å¤„å‘¢ï¼Ÿæˆ‘ä»¬çš„åŸåˆ™æ˜¯ï¼šåˆ¤æ–­å“ªä¸ªæ¨¡å—æ‹¥æœ‰çš„æ­¤å‡½æ•°ä½¿ç”¨çš„æ•°æ®æœ€å¤šï¼Œç„¶åå°±æŠŠè¿™ä¸ªå‡½æ•°å’Œé‚£äº›æ•°æ®æ‘†åœ¨ä¸€èµ·ã€‚å¦‚æœå…ˆä»¥æç‚¼å‡½æ•°å°†è¿™ä¸ªå‡½æ•°åˆ†è§£ä¸ºæ•°ä¸ªè¾ƒå°çš„å‡½æ•°å¹¶åˆ†åˆ«ç½®æ”¾äºä¸åŒåœ°ç‚¹ï¼Œä¸Šè¿°æ­¥éª¤ä¹Ÿå°±æ¯”è¾ƒå®¹æ˜“å®Œæˆäº†ã€‚</p><p>æœ‰å‡ ä¸ªå¤æ‚ç²¾å·§çš„æ¨¡å¼ç ´åäº†è¿™æ¡è§„åˆ™ã€‚è¯´èµ·è¿™ä¸ªè¯é¢˜ï¼ŒGoF[gof] çš„ç­–ç•¥ï¼ˆStrategyï¼‰æ¨¡å¼å’Œè®¿é—®è€…ï¼ˆVisitorï¼‰æ¨¡å¼ç«‹åˆ»è·³å…¥æˆ‘çš„è„‘æµ·ï¼ŒKent Beck çš„ Self Delegation æ¨¡å¼ã€[Beck SBPP] ä¹Ÿåœ¨æ­¤åˆ—ã€‚ä½¿ç”¨è¿™äº›æ¨¡å¼æ˜¯ä¸ºäº†å¯¹æŠ—å‘æ•£å¼å˜åŒ–è¿™ä¸€åå‘³é“ã€‚æœ€æ ¹æœ¬çš„åŸåˆ™æ˜¯ï¼šå°†æ€»æ˜¯ä¸€èµ·å˜åŒ–çš„ä¸œè¥¿æ”¾åœ¨ä¸€å—å„¿ã€‚æ•°æ®å’Œå¼•ç”¨è¿™äº›æ•°æ®çš„è¡Œä¸ºæ€»æ˜¯ä¸€èµ·å˜åŒ–çš„ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–ã€‚å¦‚æœä¾‹å¤–å‡ºç°ï¼Œæˆ‘ä»¬å°±æ¬ç§»é‚£äº›è¡Œä¸ºï¼Œä¿æŒå˜åŒ–åªåœ¨ä¸€åœ°å‘ç”Ÿã€‚ç­–ç•¥æ¨¡å¼å’Œå’Œè®¿é—®è€…æ¨¡å¼ä½¿ä½ å¾—ä»¥è½»æ¾ä¿®æ”¹å‡½æ•°çš„è¡Œä¸ºï¼Œå› ä¸ºå®ƒä»¬å°†å°‘é‡éœ€è¢«è¦†å†™çš„è¡Œä¸ºéš”ç¦»å¼€æ¥â€”â€”å½“ç„¶ä¹Ÿä»˜å‡ºäº†â€œå¤šä¸€å±‚é—´æ¥æ€§â€çš„ä»£ä»·ã€‚</p><h1 id="æ•°æ®æ³¥å›¢data-clumps">æ•°æ®æ³¥å›¢ï¼ˆData Clumpsï¼‰</h1><p>æ•°æ®é¡¹å°±åƒå°å­©å­ï¼Œå–œæ¬¢æˆç¾¤ç»“é˜Ÿåœ°å¾…åœ¨ä¸€å—å„¿ã€‚ä½ å¸¸å¸¸å¯ä»¥åœ¨å¾ˆå¤šåœ°æ–¹çœ‹åˆ°ç›¸åŒçš„ä¸‰å››é¡¹æ•°æ®ï¼šä¸¤ä¸ªç±»ä¸­ç›¸åŒçš„å­—æ®µã€è®¸å¤šå‡½æ•°ç­¾åä¸­ç›¸åŒçš„å‚æ•°ã€‚è¿™äº›æ€»æ˜¯ç»‘åœ¨ä¸€èµ·å‡ºç°çš„æ•°æ®çœŸåº”è¯¥æ‹¥æœ‰å±äºå®ƒä»¬è‡ªå·±çš„å¯¹è±¡ã€‚é¦–å…ˆè¯·æ‰¾å‡ºè¿™äº›æ•°æ®ä»¥å­—æ®µå½¢å¼å‡ºç°çš„åœ°æ–¹ï¼Œè¿ç”¨æç‚¼ç±»å°†å®ƒä»¬æç‚¼åˆ°ä¸€ä¸ªç‹¬ç«‹å¯¹è±¡ä¸­ã€‚ç„¶åå°†æ³¨æ„åŠ›è½¬ç§»åˆ°å‡½æ•°ç­¾åä¸Šï¼Œè¿ç”¨å¼•å…¥å‚æ•°å¯¹è±¡æˆ–ä¿æŒå¯¹è±¡å®Œæ•´ä¸ºå®ƒç˜¦èº«ã€‚è¿™ä¹ˆåšçš„ç›´æ¥å¥½å¤„æ˜¯å¯ä»¥å°†å¾ˆå¤šå‚æ•°åˆ—è¡¨ç¼©çŸ­ï¼Œç®€åŒ–å‡½æ•°è°ƒç”¨ã€‚æ˜¯çš„ï¼Œä¸å¿…åœ¨æ„æ•°æ®æ³¥å›¢åªç”¨ä¸Šæ–°å¯¹è±¡çš„ä¸€éƒ¨åˆ†å­—æ®µï¼Œåªè¦ä»¥æ–°å¯¹è±¡å–ä»£ä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰å­—æ®µï¼Œå°±å€¼å¾—è¿™ä¹ˆåšã€‚</p><p>ä¸€ä¸ªå¥½çš„è¯„åˆ¤åŠæ³•æ˜¯ï¼šåˆ æ‰ä¼—å¤šæ•°æ®ä¸­çš„ä¸€é¡¹ã€‚å¦‚æœè¿™ä¹ˆåšï¼Œå…¶ä»–æ•°æ®æœ‰æ²¡æœ‰å› è€Œå¤±å»æ„ä¹‰ï¼Ÿå¦‚æœå®ƒä»¬ä¸å†æœ‰æ„ä¹‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ˜ç¡®ä¿¡å·ï¼šä½ åº”è¯¥ä¸ºå®ƒä»¬äº§ç”Ÿä¸€ä¸ªæ–°å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œæå€¡æ–°å»ºä¸€ä¸ªç±»ï¼Œè€Œä¸æ˜¯ç®€å•çš„è®°å½•ç»“æ„ï¼Œå› ä¸ºä¸€æ—¦æ‹¥æœ‰æ–°çš„ç±»ï¼Œä½ å°±æœ‰æœºä¼šè®©ç¨‹åºæ•£å‘å‡ºä¸€ç§èŠ³é¦™ã€‚å¾—åˆ°æ–°çš„ç±»ä»¥åï¼Œä½ å°±å¯ä»¥ç€æ‰‹å¯»æ‰¾â€œä¾æ‹æƒ…ç»“â€ï¼Œè¿™å¯ä»¥å¸®ä½ æŒ‡å‡ºèƒ½å¤Ÿç§»è‡³æ–°ç±»ä¸­çš„ç§ç§è¡Œä¸ºã€‚è¿™æ˜¯ä¸€ç§å¼ºå¤§çš„åŠ¨åŠ›ï¼šæœ‰ç”¨çš„ç±»è¢«åˆ›å»ºå‡ºæ¥ï¼Œå¤§é‡çš„é‡å¤è¢«æ¶ˆé™¤ï¼Œåç»­å¼€å‘å¾—ä»¥åŠ é€Ÿï¼ŒåŸæ¥çš„æ•°æ®æ³¥å›¢ç»ˆäºåœ¨å®ƒä»¬çš„å°ç¤¾ä¼šä¸­å……åˆ†å‘æŒ¥ä»·å€¼ã€‚</p><h1 id="åŸºæœ¬ç±»å‹åæ‰§primitive-obsession">åŸºæœ¬ç±»å‹åæ‰§ï¼ˆPrimitive Obsessionï¼‰</h1><p>å¤§å¤šæ•°ç¼–ç¨‹ç¯å¢ƒéƒ½å¤§é‡ä½¿ç”¨åŸºæœ¬ç±»å‹ï¼Œå³æ•´æ•°ã€æµ®ç‚¹æ•°å’Œå­—ç¬¦ä¸²ç­‰ã€‚ä¸€äº›åº“ä¼šå¼•å…¥ä¸€äº›å°å¯¹è±¡ï¼Œå¦‚æ—¥æœŸã€‚ä½†æˆ‘ä»¬å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç°è±¡ï¼šå¾ˆå¤šç¨‹åºå‘˜ä¸æ„¿æ„åˆ›å»ºå¯¹è‡ªå·±çš„é—®é¢˜åŸŸæœ‰ç”¨çš„åŸºæœ¬ç±»å‹ï¼Œå¦‚é’±ã€åæ ‡ã€èŒƒå›´ç­‰ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æŠŠé’±å½“ä½œæ™®é€šæ•°å­—æ¥è®¡ç®—çš„æƒ…å†µã€è®¡ç®—ç‰©ç†é‡æ—¶æ— è§†å•ä½ï¼ˆå¦‚æŠŠè‹±å¯¸ä¸æ¯«ç±³ç›¸åŠ ï¼‰çš„æƒ…å†µä»¥åŠå¤§é‡ç±»ä¼¼ if (a &lt; upper &amp;&amp; a &gt; lower) è¿™æ ·çš„ä»£ç ã€‚</p><p>å­—ç¬¦ä¸²æ˜¯è¿™ç§åå‘³é“çš„æœ€ä½³åŸ¹å…»çš¿ï¼Œæ¯”å¦‚ï¼Œç”µè¯å·ç ä¸åªæ˜¯ä¸€ä¸²å­—ç¬¦ã€‚ä¸€ä¸ªä½“é¢çš„ç±»å‹ï¼Œè‡³å°‘èƒ½åŒ…å«ä¸€è‡´çš„æ˜¾ç¤ºé€»è¾‘ï¼Œåœ¨ç”¨æˆ·ç•Œé¢ä¸Šéœ€è¦æ˜¾ç¤ºæ—¶å¯ä»¥ä½¿ç”¨ã€‚â€œç”¨å­—ç¬¦ä¸²æ¥ä»£è¡¨ç±»ä¼¼è¿™æ ·çš„æ•°æ®â€æ˜¯å¦‚æ­¤å¸¸è§çš„è‡­å‘³ï¼Œä»¥è‡³äºäººä»¬ç»™è¿™ç±»å˜é‡ä¸“é—¨èµ·äº†ä¸€ä¸ªåå­—ï¼Œå«å®ƒä»¬â€œç±»å­—ç¬¦ä¸²ç±»å‹â€ï¼ˆstringly typedï¼‰å˜é‡ã€‚</p><p>ä½ å¯ä»¥è¿ç”¨ä»¥å¯¹è±¡å–ä»£åŸºæœ¬ç±»å‹å°†åŸæœ¬å•ç‹¬å­˜åœ¨çš„æ•°æ®å€¼æ›¿æ¢ä¸ºå¯¹è±¡ï¼Œä»è€Œèµ°å‡ºä¼ ç»Ÿçš„æ´çªŸï¼Œè¿›å…¥ç‚™æ‰‹å¯çƒ­çš„å¯¹è±¡ä¸–ç•Œã€‚å¦‚æœæƒ³è¦æ›¿æ¢çš„æ•°æ®å€¼æ˜¯æ§åˆ¶æ¡ä»¶è¡Œä¸ºçš„ç±»å‹ç ï¼Œåˆ™å¯ä»¥è¿ç”¨ä»¥å­ç±»å–ä»£ç±»å‹ç åŠ ä¸Šä»¥å¤šæ€å–ä»£æ¡ä»¶è¡¨è¾¾å¼çš„ç»„åˆå°†å®ƒæ¢æ‰ã€‚</p><p>å¦‚æœä½ æœ‰ä¸€ç»„æ€»æ˜¯åŒæ—¶å‡ºç°çš„åŸºæœ¬ç±»å‹æ•°æ®ï¼Œè¿™å°±æ˜¯æ•°æ®æ³¥å›¢çš„å¾å…†ï¼Œåº”è¯¥è¿ç”¨æç‚¼ç±»å’Œå¼•å…¥å‚æ•°å¯¹è±¡æ¥å¤„ç†ã€‚</p><h1 id="é‡å¤çš„-switch-repeated-switches">é‡å¤çš„ switch ï¼ˆRepeated Switchesï¼‰</h1><p>å¦‚æœä½ è·ŸçœŸæ­£çš„é¢å‘å¯¹è±¡å¸ƒé“è€…äº¤è°ˆï¼Œä»–ä»¬å¾ˆå¿«å°±ä¼šè°ˆåˆ° switch è¯­å¥çš„é‚ªæ¶ã€‚åœ¨ä»–ä»¬çœ‹æ¥ï¼Œä»»ä½• switch è¯­å¥éƒ½åº”è¯¥ç”¨ä»¥å¤šæ€å–ä»£æ¡ä»¶è¡¨è¾¾å¼æ¶ˆé™¤æ‰ã€‚æˆ‘ä»¬ç”šè‡³è¿˜å¬è¿‡è¿™æ ·çš„è§‚ç‚¹ï¼šæ‰€æœ‰æ¡ä»¶é€»è¾‘éƒ½åº”è¯¥ç”¨å¤šæ€å–ä»£ï¼Œç»å¤§å¤šæ•° if è¯­å¥éƒ½åº”è¯¥è¢«æ‰«è¿›å†å²çš„åƒåœ¾æ¡¶ã€‚</p><p>é‡å¤çš„ switch çš„é—®é¢˜åœ¨äºï¼šæ¯å½“ä½ æƒ³å¢åŠ ä¸€ä¸ªé€‰æ‹©åˆ†æ”¯æ—¶ï¼Œå¿…é¡»æ‰¾åˆ°æ‰€æœ‰çš„ switchï¼Œå¹¶é€ä¸€æ›´æ–°ã€‚å¤šæ€ç»™äº†æˆ‘ä»¬å¯¹æŠ—è¿™ç§é»‘æš—åŠ›é‡çš„æ­¦å™¨ï¼Œä½¿æˆ‘ä»¬å¾—åˆ°æ›´ä¼˜é›…çš„ä»£ç åº“ã€‚</p><h1 id="è¿‡é•¿çš„æ¶ˆæ¯é“¾message-chains">è¿‡é•¿çš„æ¶ˆæ¯é“¾ï¼ˆMessage Chainsï¼‰</h1><p>å¦‚æœä½ çœ‹åˆ°ç”¨æˆ·å‘ä¸€ä¸ªå¯¹è±¡è¯·æ±‚å¦ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†å‘åè€…è¯·æ±‚å¦ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†è¯·æ±‚å¦ä¸€ä¸ªå¯¹è±¡â€¦â€¦è¿™å°±æ˜¯æ¶ˆæ¯é“¾ã€‚åœ¨å®é™…ä»£ç ä¸­ä½ çœ‹åˆ°çš„å¯èƒ½æ˜¯ä¸€é•¿ä¸²å–å€¼å‡½æ•°æˆ–ä¸€é•¿ä¸²ä¸´æ—¶å˜é‡ã€‚é‡‡å–è¿™ç§æ–¹å¼ï¼Œæ„å‘³å®¢æˆ·ç«¯ä»£ç å°†ä¸æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„å¯¼èˆªç»“æ„ç´§å¯†è€¦åˆã€‚ä¸€æ—¦å¯¹è±¡é—´çš„å…³ç³»å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œå®¢æˆ·ç«¯å°±ä¸å¾—ä¸åšå‡ºç›¸åº”ä¿®æ”¹ã€‚</p><p>è¿™æ—¶å€™åº”è¯¥ä½¿ç”¨éšè—å§”æ‰˜å…³ç³»ã€‚ä½ å¯ä»¥åœ¨æ¶ˆæ¯é“¾çš„ä¸åŒä½ç½®é‡‡ç”¨è¿™ç§é‡æ„æ‰‹æ³•ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥é‡æ„æ¶ˆæ¯é“¾ä¸Šçš„æ‰€æœ‰å¯¹è±¡ï¼Œä½†è¿™ä¹ˆåšå°±ä¼šæŠŠæ‰€æœ‰ä¸­é—´å¯¹è±¡éƒ½å˜æˆâ€œä¸­é—´äººâ€ã€‚é€šå¸¸æ›´å¥½çš„é€‰æ‹©æ˜¯ï¼šå…ˆè§‚å¯Ÿæ¶ˆæ¯é“¾æœ€ç»ˆå¾—åˆ°çš„å¯¹è±¡æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Œçœ‹çœ‹èƒ½å¦ä»¥æç‚¼å‡½æ•°æŠŠä½¿ç”¨è¯¥å¯¹è±¡çš„ä»£ç æç‚¼åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­ï¼Œå†è¿ç”¨æ¬ç§»å‡½æ•°æŠŠè¿™ä¸ªå‡½æ•°æ¨å…¥æ¶ˆæ¯é“¾ã€‚å¦‚æœè¿˜æœ‰è®¸å¤šå®¢æˆ·ç«¯ä»£ç éœ€è¦è®¿é—®é“¾ä¸Šçš„å…¶ä»–å¯¹è±¡ï¼ŒåŒæ ·æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥å®Œæˆæ­¤äº‹ã€‚</p><p>æœ‰äº›äººæŠŠä»»ä½•å‡½æ•°é“¾éƒ½è§†ä¸ºåä¸œè¥¿ï¼Œæˆ‘ä»¬ä¸è¿™æ ·æƒ³ã€‚æˆ‘ä»¬çš„å†·é™é•‡å®šæ˜¯å‡ºäº†åçš„ï¼Œèµ·ç åœ¨è¿™ä»¶äº‹ä¸Šæ˜¯è¿™æ ·çš„ã€‚</p><h1 id="ä¸­é—´äººmiddle-man">ä¸­é—´äººï¼ˆMiddle Manï¼‰</h1><p>å¯¹è±¡çš„åŸºæœ¬ç‰¹å¾ä¹‹ä¸€å°±æ˜¯å°è£…â€”â€”å¯¹å¤–éƒ¨ä¸–ç•Œéšè—å…¶å†…éƒ¨ç»†èŠ‚ã€‚å°è£…å¾€å¾€ä¼´éšç€å§”æ‰˜ã€‚æ¯”å¦‚ï¼Œä½ é—®ä¸»ç®¡æ˜¯å¦æœ‰æ—¶é—´å‚åŠ ä¸€ä¸ªä¼šè®®ï¼Œä»–å°±æŠŠè¿™ä¸ªæ¶ˆæ¯â€œå§”æ‰˜â€ç»™ä»–çš„è®°äº‹ç°¿ï¼Œç„¶åæ‰èƒ½å›ç­”ä½ ã€‚å¾ˆå¥½ï¼Œä½ æ²¡å¿…è¦çŸ¥é“è¿™ä½ä¸»ç®¡åˆ°åº•ä½¿ç”¨ä¼ ç»Ÿè®°äº‹ç°¿è¿˜æ˜¯ä½¿ç”¨ç”µå­è®°äº‹ç°¿æŠ‘æˆ–æ˜¯ç§˜ä¹¦æ¥è®°å½•è‡ªå·±çš„çº¦ä¼šã€‚</p><p>ä½†æ˜¯äººä»¬å¯èƒ½è¿‡åº¦è¿ç”¨å§”æ‰˜ã€‚ä½ ä¹Ÿè®¸ä¼šçœ‹åˆ°æŸä¸ªç±»çš„æ¥å£æœ‰ä¸€åŠçš„å‡½æ•°éƒ½å§”æ‰˜ç»™å…¶ä»–ç±»ï¼Œè¿™æ ·å°±æ˜¯è¿‡åº¦è¿ç”¨ã€‚è¿™æ—¶åº”è¯¥ä½¿ç”¨ç§»é™¤ä¸­é—´äººï¼Œç›´æ¥å’ŒçœŸæ­£è´Ÿè´£çš„å¯¹è±¡æ‰“äº¤é“ã€‚å¦‚æœè¿™æ ·â€œä¸å¹²å®äº‹â€çš„å‡½æ•°åªæœ‰å°‘æ•°å‡ ä¸ªï¼Œå¯ä»¥è¿ç”¨å†…è”å‡½æ•°æŠŠå®ƒä»¬æ”¾è¿›è°ƒç”¨ç«¯ã€‚å¦‚æœè¿™äº›ä¸­é—´äººè¿˜æœ‰å…¶ä»–è¡Œä¸ºï¼Œå¯ä»¥è¿ç”¨ä»¥å§”æ‰˜å–ä»£è¶…ç±»æˆ–è€…ä»¥å§”æ‰˜å–ä»£å­ç±»æŠŠå®ƒå˜æˆçœŸæ­£çš„å¯¹è±¡ï¼Œè¿™æ ·ä½ æ—¢å¯ä»¥æ‰©å±•åŸå¯¹è±¡çš„è¡Œä¸ºï¼Œåˆä¸å¿…è´Ÿæ‹…é‚£ä¹ˆå¤šçš„å§”æ‰˜åŠ¨ä½œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé‡æ„ æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly9ib29rLXJlZmFjdG9yaW5nMi5pZm1pY3JvLmNvbS9kb2NzL2NoMy5odG1s">https://book-refactoring2.ifmicro.com/docs/ch3.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Refactor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡æ„ï¼ˆä¸€ï¼‰é‡æ„çš„åŸåˆ™</title>
      <link href="/2022/Program/RefactorPart1/"/>
      <url>/2022/Program/RefactorPart1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/refactor_principle.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMyYTA5ZTA3OTEyOTA3YzI4YWM4MDM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä½•è°“é‡æ„">ä½•è°“é‡æ„</h1><p>â€œé‡æ„â€è¿™ä¸ªè¯æ—¢å¯ä»¥ç”¨ä½œåè¯ä¹Ÿå¯ä»¥ç”¨ä½œåŠ¨è¯ã€‚</p><ul><li>é‡æ„ï¼ˆåè¯ï¼‰ï¼šå¯¹è½¯ä»¶å†…éƒ¨ç»“æ„çš„ä¸€ç§è°ƒæ•´ï¼Œç›®çš„æ˜¯åœ¨ä¸æ”¹å˜è½¯ä»¶å¯è§‚å¯Ÿè¡Œä¸ºçš„å‰æä¸‹ï¼Œæé«˜å…¶å¯ç†è§£æ€§ï¼Œé™ä½å…¶ä¿®æ”¹æˆæœ¬ã€‚</li><li>é‡æ„ï¼ˆåŠ¨è¯ï¼‰ï¼šä½¿ç”¨ä¸€ç³»åˆ—é‡æ„æ‰‹æ³•ï¼Œåœ¨ä¸æ”¹å˜è½¯ä»¶å¯è§‚å¯Ÿè¡Œä¸ºçš„å‰æä¸‹ï¼Œè°ƒæ•´å…¶ç»“æ„ã€‚</li></ul><p>é‡æ„çš„å…³é”®åœ¨äºè¿ç”¨å¤§é‡å¾®å°ä¸”ä¿æŒè½¯ä»¶è¡Œä¸ºçš„æ­¥éª¤ï¼Œä¸€æ­¥æ­¥è¾¾æˆå¤§è§„æ¨¡çš„ä¿®æ”¹ã€‚æ¯ä¸ªå•ç‹¬çš„é‡æ„è¦ä¹ˆå¾ˆå°ï¼Œè¦ä¹ˆç”±è‹¥å¹²å°æ­¥éª¤ç»„åˆè€Œæˆã€‚å› æ­¤ï¼Œåœ¨é‡æ„çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘çš„ä»£ç å¾ˆå°‘è¿›å…¥ä¸å¯å·¥ä½œçš„çŠ¶æ€ï¼Œå³ä¾¿é‡æ„æ²¡æœ‰å®Œæˆï¼Œæˆ‘ä¹Ÿå¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»åœä¸‹æ¥ã€‚</p><blockquote><p><strong>Tip</strong> å¦‚æœæœ‰äººè¯´ä»–ä»¬çš„ä»£ç åœ¨é‡æ„è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸¤å¤©æ—¶é—´ä¸å¯ç”¨ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šï¼Œä»–ä»¬åœ¨åšçš„äº‹ä¸æ˜¯é‡æ„ã€‚</p></blockquote><p>åœ¨ä¸Šè¿°å®šä¹‰ä¸­ï¼Œæˆ‘ç”¨äº†â€œå¯è§‚å¯Ÿè¡Œä¸ºâ€çš„è¯´æ³•ã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œæ•´ä½“è€Œè¨€ï¼Œç»è¿‡é‡æ„ä¹‹åçš„ä»£ç æ‰€åšçš„äº‹åº”è¯¥ä¸é‡æ„ä¹‹å‰å¤§è‡´ä¸€æ ·ã€‚è¿™ä¸ªè¯´æ³•å¹¶éå®Œå…¨ä¸¥æ ¼ï¼Œå¹¶ä¸”æˆ‘æ˜¯æ•…æ„ä¿ç•™è¿™ç‚¹å„¿ç©ºé—´çš„ï¼šé‡æ„ä¹‹åçš„ä»£ç ä¸ä¸€å®šä¸é‡æ„å‰è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚æ¯”å¦‚è¯´ï¼Œæç‚¼å‡½æ•°ä¼šæ”¹å˜å‡½æ•°è°ƒç”¨æ ˆï¼Œå› æ­¤ç¨‹åºçš„æ€§èƒ½å°±ä¼šæœ‰æ‰€æ”¹å˜ï¼›æ”¹å˜å‡½æ•°å£°æ˜å’Œæ¬ç§»å‡½æ•°ç­‰é‡æ„ç»å¸¸ä¼šæ”¹å˜æ¨¡å—çš„æ¥å£ã€‚ä¸è¿‡å°±ç”¨æˆ·åº”è¯¥å…³å¿ƒçš„è¡Œä¸ºè€Œè¨€ï¼Œä¸åº”è¯¥æœ‰ä»»ä½•æ”¹å˜ã€‚å¦‚æœæˆ‘åœ¨é‡æ„è¿‡ç¨‹ä¸­å‘ç°äº†ä»»ä½• bugï¼Œé‡æ„å®ŒæˆååŒæ ·çš„ bug åº”è¯¥ä»ç„¶å­˜åœ¨ã€‚</p><h1 id="ä¸¤é¡¶å¸½å­">ä¸¤é¡¶å¸½å­</h1><p>Kent Beck æå‡ºäº†â€œä¸¤é¡¶å¸½å­â€çš„æ¯”å–»ã€‚ä½¿ç”¨é‡æ„æŠ€æœ¯å¼€å‘è½¯ä»¶æ—¶ï¼Œæˆ‘æŠŠè‡ªå·±çš„æ—¶é—´åˆ†é…ç»™ä¸¤ç§æˆªç„¶ä¸åŒçš„è¡Œä¸ºï¼šæ·»åŠ æ–°åŠŸèƒ½å’Œé‡æ„ã€‚æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œæˆ‘ä¸åº”è¯¥ä¿®æ”¹æ—¢æœ‰ä»£ç ï¼Œåªç®¡æ·»åŠ æ–°åŠŸèƒ½ã€‚é€šè¿‡æ·»åŠ æµ‹è¯•å¹¶è®©æµ‹è¯•æ­£å¸¸è¿è¡Œï¼Œæˆ‘å¯ä»¥è¡¡é‡è‡ªå·±çš„å·¥ä½œè¿›åº¦ã€‚é‡æ„æ—¶æˆ‘å°±ä¸èƒ½å†æ·»åŠ åŠŸèƒ½ï¼Œåªç®¡è°ƒæ•´ä»£ç çš„ç»“æ„ã€‚æ­¤æ—¶æˆ‘ä¸åº”è¯¥æ·»åŠ ä»»ä½•æµ‹è¯•ï¼Œåªåœ¨ç»å¯¹å¿…è¦ï¼ˆç”¨ä»¥å¤„ç†æ¥å£å˜åŒ–ï¼‰æ—¶æ‰ä¿®æ”¹æµ‹è¯•ã€‚ è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¯èƒ½ä¼šå‘ç°è‡ªå·±ç»å¸¸å˜æ¢å¸½å­ã€‚é¦–å…ˆæˆ‘ä¼šå°è¯•æ·»åŠ æ–°åŠŸèƒ½ï¼Œç„¶åä¼šæ„è¯†åˆ°ï¼šå¦‚æœæŠŠç¨‹åºç»“æ„æ”¹ä¸€ä¸‹ï¼ŒåŠŸèƒ½çš„æ·»åŠ ä¼šå®¹æ˜“å¾—å¤šã€‚äºæ˜¯æˆ‘æ¢ä¸€é¡¶å¸½å­ï¼Œåšä¸€ä¼šå„¿é‡æ„å·¥ä½œã€‚ç¨‹åºç»“æ„è°ƒæ•´å¥½åï¼Œæˆ‘åˆæ¢ä¸ŠåŸå…ˆçš„å¸½å­ï¼Œç»§ç»­æ·»åŠ æ–°åŠŸèƒ½ã€‚æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œåï¼Œæˆ‘åˆå‘ç°è‡ªå·±çš„ç¼–ç é€ æˆç¨‹åºéš¾ä»¥ç†è§£ï¼Œäºæ˜¯åˆæ¢ä¸Šé‡æ„å¸½å­â€¦â€¦æ•´ä¸ªè¿‡ç¨‹æˆ–è®¸åªèŠ± 10 åˆ†é’Ÿï¼Œä½†æ— è®ºä½•æ—¶æˆ‘éƒ½æ¸…æ¥šè‡ªå·±æˆ´çš„æ˜¯å“ªä¸€é¡¶å¸½å­ï¼Œå¹¶ä¸”æ˜ç™½ä¸åŒçš„å¸½å­å¯¹ç¼–ç¨‹çŠ¶æ€æå‡ºçš„ä¸åŒè¦æ±‚ã€‚</p><h1 id="ä¸ºä½•é‡æ„">ä¸ºä½•é‡æ„</h1><h2 id="é‡æ„æ”¹è¿›è½¯ä»¶çš„è®¾è®¡">é‡æ„æ”¹è¿›è½¯ä»¶çš„è®¾è®¡</h2><p>å¦‚æœæ²¡æœ‰é‡æ„ï¼Œç¨‹åºçš„å†…éƒ¨è®¾è®¡ï¼ˆæˆ–è€…å«æ¶æ„ï¼‰ä¼šé€æ¸è…è´¥å˜è´¨ã€‚å½“äººä»¬åªä¸ºçŸ­æœŸç›®çš„è€Œä¿®æ”¹ä»£ç æ—¶ï¼Œä»–ä»¬ç»å¸¸æ²¡æœ‰å®Œå…¨ç†è§£æ¶æ„çš„æ•´ä½“è®¾è®¡ï¼Œäºæ˜¯ä»£ç é€æ¸å¤±å»äº†è‡ªå·±çš„ç»“æ„ã€‚ç¨‹åºå‘˜è¶Šæ¥è¶Šéš¾é€šè¿‡é˜…è¯»æºç æ¥ç†è§£åŸæ¥çš„è®¾è®¡ã€‚ä»£ç ç»“æ„çš„æµå¤±æœ‰ç´¯ç§¯æ•ˆåº”ã€‚è¶Šéš¾çœ‹å‡ºä»£ç æ‰€ä»£è¡¨çš„è®¾è®¡æ„å›¾ï¼Œå°±è¶Šéš¾ä¿æŠ¤å…¶è®¾è®¡ï¼Œäºæ˜¯è®¾è®¡å°±è…è´¥å¾—è¶Šå¿«ã€‚ç»å¸¸æ€§çš„é‡æ„æœ‰åŠ©äºä»£ç ç»´æŒè‡ªå·±è¯¥æœ‰çš„å½¢æ€ã€‚</p><p>æ¶ˆé™¤é‡å¤ä»£ç ï¼Œæˆ‘å°±å¯ä»¥ç¡®å®šæ‰€æœ‰äº‹ç‰©å’Œè¡Œä¸ºåœ¨ä»£ç ä¸­åªè¡¨è¿°ä¸€æ¬¡ï¼Œè¿™æ­£æ˜¯ä¼˜ç§€è®¾è®¡çš„æ ¹æœ¬ã€‚</p><h2 id="é‡æ„ä½¿è½¯ä»¶æ›´å®¹æ˜“ç†è§£">é‡æ„ä½¿è½¯ä»¶æ›´å®¹æ˜“ç†è§£</h2><p>ç”¨äºåä½œ</p><h2 id="é‡æ„å¸®åŠ©æ‰¾åˆ°-bug">é‡æ„å¸®åŠ©æ‰¾åˆ° bug</h2><p>å¯¹ä»£ç çš„ç†è§£ï¼Œå¯ä»¥å¸®æˆ‘æ‰¾åˆ° bugã€‚æˆ‘æ‰¿è®¤æˆ‘ä¸å¤ªæ“…é•¿æ‰¾ bugã€‚æœ‰äº›äººåªè¦ç›¯ç€ä¸€å¤§æ®µä»£ç å°±å¯ä»¥æ‰¾å‡ºé‡Œé¢çš„ bugï¼Œæˆ‘ä¸è¡Œã€‚ä½†æˆ‘å‘ç°ï¼Œå¦‚æœå¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œæˆ‘å°±å¯ä»¥æ·±å…¥ç†è§£ä»£ç çš„æ‰€ä½œæ‰€ä¸ºï¼Œå¹¶ç«‹å³æŠŠæ–°çš„ç†è§£åæ˜ åœ¨ä»£ç å½“ä¸­ã€‚ææ¸…æ¥šç¨‹åºç»“æ„çš„åŒæ—¶ï¼Œæˆ‘ä¹ŸéªŒè¯äº†è‡ªå·±æ‰€åšçš„ä¸€äº›å‡è®¾ï¼Œäºæ˜¯æƒ³ä¸æŠŠ bug æªå‡ºæ¥éƒ½éš¾ã€‚</p><h2 id="é‡æ„æé«˜ç¼–ç¨‹é€Ÿåº¦">é‡æ„æé«˜ç¼–ç¨‹é€Ÿåº¦</h2><p>æœ€åï¼Œå‰é¢çš„ä¸€åˆ‡éƒ½å½’ç»“åˆ°äº†è¿™ä¸€ç‚¹ï¼šé‡æ„å¸®æˆ‘æ›´å¿«é€Ÿåœ°å¼€å‘ç¨‹åºã€‚</p><p>æœ‰çš„å›¢é˜Ÿï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/cg1.jpeg"></p><p>ä½†æœ‰äº›å›¢é˜Ÿçš„å¢ƒé‡åˆ™æˆªç„¶ä¸åŒã€‚ä»–ä»¬æ·»åŠ æ–°åŠŸèƒ½çš„é€Ÿåº¦è¶Šæ¥è¶Šå¿«ï¼Œå› ä¸ºä»–ä»¬èƒ½åˆ©ç”¨å·²æœ‰çš„åŠŸèƒ½ï¼ŒåŸºäºå·²æœ‰çš„åŠŸèƒ½å¿«é€Ÿæ„å»ºæ–°åŠŸèƒ½ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/cg2.jpeg"></p><p>ä¸¤ç§å›¢é˜Ÿçš„åŒºåˆ«å°±åœ¨äºè½¯ä»¶çš„å†…éƒ¨è´¨é‡ã€‚è‰¯å¥½çš„æ¨¡å—åˆ’åˆ†ä½¿æˆ‘åªéœ€è¦ç†è§£ä»£ç åº“çš„ä¸€å°éƒ¨åˆ†ï¼Œå°±å¯ä»¥åšå‡ºä¿®æ”¹ã€‚å¦‚æœä»£ç å¾ˆæ¸…æ™°ï¼Œæˆ‘å¼•å…¥ bug çš„å¯èƒ½æ€§å°±ä¼šå˜å°ï¼Œå³ä½¿å¼•å…¥äº† bugï¼Œè°ƒè¯•ä¹Ÿä¼šå®¹æ˜“å¾—å¤šã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘çš„ä»£ç åº“ä¼šé€æ­¥æ¼”åŒ–æˆä¸€ä¸ªå¹³å°ï¼Œåœ¨å…¶ä¸Šå¯ä»¥å¾ˆå®¹æ˜“åœ°æ„é€ ä¸å…¶é¢†åŸŸç›¸å…³çš„æ–°åŠŸèƒ½ã€‚ 20 å¹´å‰ï¼Œè¡Œä¸šçš„é™ˆè§„ï¼šè‰¯å¥½çš„è®¾è®¡å¿…é¡»åœ¨å¼€å§‹ç¼–ç¨‹ä¹‹å‰å®Œæˆï¼Œå› ä¸ºä¸€æ—¦å¼€å§‹ç¼–å†™ä»£ç ï¼Œè®¾è®¡å°±åªä¼šé€æ¸è…è´¥ã€‚é‡æ„æ”¹å˜äº†è¿™ä¸ªå›¾æ™¯ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æ”¹å–„å·²æœ‰ä»£ç çš„è®¾è®¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆåšä¸€ä¸ªè®¾è®¡ï¼Œç„¶åä¸æ–­æ”¹å–„å®ƒï¼Œå“ªæ€•ç¨‹åºæœ¬èº«çš„åŠŸèƒ½ä¹Ÿåœ¨ä¸æ–­å‘ç”Ÿç€å˜åŒ–ã€‚</p><h1 id="ä½•æ—¶é‡æ„">ä½•æ—¶é‡æ„</h1><h2 id="é¢„å¤‡æ€§é‡æ„è®©æ·»åŠ æ–°åŠŸèƒ½æ›´å®¹æ˜“">é¢„å¤‡æ€§é‡æ„ï¼šè®©æ·»åŠ æ–°åŠŸèƒ½æ›´å®¹æ˜“</h2><p>é‡æ„çš„æœ€ä½³æ—¶æœºå°±åœ¨æ·»åŠ æ–°åŠŸèƒ½ä¹‹å‰ã€‚åœ¨åŠ¨æ‰‹æ·»åŠ æ–°åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä¼šçœ‹çœ‹ç°æœ‰çš„ä»£ç åº“ï¼Œæ­¤æ—¶ç»å¸¸ä¼šå‘ç°ï¼šå¦‚æœå¯¹ä»£ç ç»“æ„åšä¸€ç‚¹å¾®è°ƒï¼Œæˆ‘çš„å·¥ä½œä¼šå®¹æ˜“å¾—å¤šã€‚ ä¿®å¤ bug æ—¶çš„æƒ…å†µä¹Ÿæ˜¯ä¸€æ ·ã€‚åœ¨å¯»æ‰¾é—®é¢˜æ ¹å› æ—¶ï¼Œæˆ‘å¯èƒ½ä¼šå‘ç°ï¼šå¦‚æœæŠŠ 3 æ®µä¸€æ¨¡ä¸€æ ·ä¸”éƒ½ä¼šå¯¼è‡´é”™è¯¯çš„ä»£ç åˆå¹¶åˆ°ä¸€å¤„ï¼Œé—®é¢˜ä¿®å¤èµ·æ¥ä¼šå®¹æ˜“å¾—å¤šã€‚æˆ–è€…ï¼Œå¦‚æœæŠŠæŸäº›æ›´æ–°æ•°æ®çš„é€»è¾‘ä¸æŸ¥è¯¢é€»è¾‘åˆ†å¼€ï¼Œä¼šæ›´å®¹æ˜“é¿å…é€ æˆé”™è¯¯çš„é€»è¾‘çº ç¼ ã€‚ç”¨é‡æ„æ”¹å–„è¿™äº›æƒ…å†µï¼Œåœ¨åŒæ ·åœºåˆå†æ¬¡å‡ºç°åŒæ · bug çš„æ¦‚ç‡ä¹Ÿä¼šé™ä½ã€‚</p><h2 id="å¸®åŠ©ç†è§£çš„é‡æ„ä½¿ä»£ç æ›´æ˜“æ‡‚">å¸®åŠ©ç†è§£çš„é‡æ„ï¼šä½¿ä»£ç æ›´æ˜“æ‡‚</h2><p>æˆ‘éœ€è¦å…ˆç†è§£ä»£ç åœ¨åšä»€ä¹ˆï¼Œç„¶åæ‰èƒ½ç€æ‰‹ä¿®æ”¹ï¼Œè¿™äº›éƒ½æ˜¯é‡æ„çš„æœºä¼šã€‚ çœ‹ä»£ç æ—¶ï¼Œæˆ‘ä¼šåœ¨è„‘æµ·é‡Œå½¢æˆä¸€äº›ç†è§£ï¼Œä½†æˆ‘çš„è®°æ€§ä¸å¥½ï¼Œè®°ä¸ä½é‚£ä¹ˆå¤šç»†èŠ‚ã€‚æ­£å¦‚ Ward Cunningham æ‰€è¯´ï¼Œé€šè¿‡é‡æ„ï¼Œæˆ‘å°±æŠŠè„‘å­é‡Œçš„ç†è§£è½¬ç§»åˆ°äº†ä»£ç æœ¬èº«ã€‚éšåæˆ‘è¿è¡Œè¿™ä¸ªè½¯ä»¶ï¼Œçœ‹å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ¥æ£€æŸ¥è¿™äº›ç†è§£æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœæŠŠå¯¹ä»£ç çš„ç†è§£æ¤å…¥ä»£ç ä¸­ï¼Œè¿™ä»½çŸ¥è¯†ä¼šä¿å­˜å¾—æ›´ä¹…ï¼Œå¹¶ä¸”æˆ‘çš„åŒäº‹ä¹Ÿèƒ½çœ‹åˆ°ã€‚</p><h2 id="æ¡åƒåœ¾å¼é‡æ„">æ¡åƒåœ¾å¼é‡æ„</h2><p>å¸®åŠ©ç†è§£çš„é‡æ„è¿˜æœ‰ä¸€ä¸ªå˜ä½“ï¼šæˆ‘å·²ç»ç†è§£ä»£ç åœ¨åšä»€ä¹ˆï¼Œä½†å‘ç°å®ƒåšå¾—ä¸å¥½ï¼Œä¾‹å¦‚é€»è¾‘ä¸å¿…è¦åœ°è¿‚å›å¤æ‚ï¼Œæˆ–è€…ä¸¤ä¸ªå‡½æ•°å‡ ä¹å®Œå…¨ç›¸åŒï¼Œå¯ä»¥ç”¨ä¸€ä¸ªå‚æ•°åŒ–çš„å‡½æ•°å–è€Œä»£ä¹‹ï¼Œæˆ‘ä¼šé©¬ä¸Šé‡æ„å®ƒï¼›å¦‚æœé‡æ„éœ€è¦èŠ±ä¸€äº›ç²¾åŠ›ï¼Œæˆ‘å¯èƒ½ä¼šæ‹¿ä¸€å¼ ä¾¿ç¬ºçº¸æŠŠå®ƒè®°ä¸‹æ¥ï¼Œå®Œæˆå½“ä¸‹çš„ä»»åŠ¡å†å›æ¥é‡æ„å®ƒã€‚</p><h2 id="æœ‰è®¡åˆ’çš„é‡æ„å’Œè§æœºè¡Œäº‹çš„é‡æ„">æœ‰è®¡åˆ’çš„é‡æ„å’Œè§æœºè¡Œäº‹çš„é‡æ„</h2><p>ä¸Šé¢çš„ä¾‹å­â€”â€”é¢„å¤‡æ€§é‡æ„ã€å¸®åŠ©ç†è§£çš„é‡æ„ã€æ¡åƒåœ¾å¼é‡æ„â€”â€”éƒ½æ˜¯è§æœºè¡Œäº‹çš„ï¼šæˆ‘å¹¶ä¸ä¸“é—¨å®‰æ’ä¸€æ®µæ—¶é—´æ¥é‡æ„ï¼Œè€Œæ˜¯åœ¨æ·»åŠ åŠŸèƒ½æˆ–ä¿®å¤ bug çš„åŒæ—¶é¡ºä¾¿é‡æ„ï¼Œè¿™æ˜¯æˆ‘è‡ªç„¶çš„ç¼–ç¨‹æµçš„ä¸€éƒ¨åˆ†ã€‚</p><blockquote><p><strong>Tip</strong> è¿˜æœ‰ä¸€ç§å¸¸è§çš„è¯¯è§£è®¤ä¸ºï¼Œé‡æ„å°±æ˜¯äººä»¬å¼¥è¡¥è¿‡å»çš„é”™è¯¯æˆ–è€…æ¸…ç†è‚®è„çš„ä»£ç ã€‚å½“ç„¶ï¼Œå¦‚æœé‡ä¸Šäº†è‚®è„çš„ä»£ç ï¼Œä½ å¿…é¡»é‡æ„ï¼Œä½†æ¼‚äº®çš„ä»£ç ä¹Ÿéœ€è¦å¾ˆå¤šé‡æ„ã€‚</p></blockquote><p>å¦‚æœå›¢é˜Ÿè¿‡å»å¿½è§†äº†é‡æ„ï¼Œé‚£ä¹ˆå¸¸å¸¸ä¼šéœ€è¦ä¸“é—¨èŠ±ä¸€äº›æ—¶é—´æ¥ä¼˜åŒ–ä»£ç åº“ï¼Œä»¥ä¾¿æ›´å®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½ã€‚åœ¨é‡æ„ä¸ŠèŠ±ä¸€ä¸ªæ˜ŸæœŸçš„æ—¶é—´ï¼Œä¼šåœ¨æœªæ¥å‡ ä¸ªæœˆé‡Œå‘æŒ¥ä»·å€¼ã€‚æœ‰æ—¶ï¼Œå³ä¾¿å›¢é˜Ÿåšäº†æ—¥å¸¸çš„é‡æ„ï¼Œè¿˜æ˜¯ä¼šæœ‰é—®é¢˜åœ¨æŸä¸ªåŒºåŸŸé€æ¸ç´¯ç§¯é•¿å¤§ï¼Œæœ€ç»ˆéœ€è¦ä¸“é—¨èŠ±äº›æ—¶é—´æ¥è§£å†³ã€‚ä½†è¿™ç§æœ‰è®¡åˆ’çš„é‡æ„åº”è¯¥å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†é‡æ„åº”è¯¥æ˜¯ä¸èµ·çœ¼çš„ã€è§æœºè¡Œäº‹çš„ã€‚</p><h2 id="ä½•æ—¶ä¸åº”è¯¥é‡æ„">ä½•æ—¶ä¸åº”è¯¥é‡æ„</h2><p>å¦‚æœæˆ‘çœ‹è§ä¸€å—å‡Œä¹±çš„ä»£ç ï¼Œä½†å¹¶ä¸éœ€è¦ä¿®æ”¹å®ƒï¼Œé‚£ä¹ˆæˆ‘å°±ä¸éœ€è¦é‡æ„å®ƒã€‚å¦‚æœä¸‘é™‹çš„ä»£ç èƒ½è¢«éšè—åœ¨ä¸€ä¸ª API ä¹‹ä¸‹ï¼Œæˆ‘å°±å¯ä»¥å®¹å¿å®ƒç»§ç»­ä¿æŒä¸‘é™‹ã€‚åªæœ‰å½“æˆ‘éœ€è¦ç†è§£å…¶å·¥ä½œåŸç†æ—¶ï¼Œå¯¹å…¶è¿›è¡Œé‡æ„æ‰æœ‰ä»·å€¼ã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœé‡å†™æ¯”é‡æ„è¿˜å®¹æ˜“ï¼Œå°±åˆ«é‡æ„äº†ã€‚</p><h1 id="é‡æ„æ¶æ„å’Œ-yagni">é‡æ„ã€æ¶æ„å’Œ YAGNI</h1><p>ä¸å…¶çŒœæµ‹æœªæ¥éœ€è¦å“ªäº›çµæ´»æ€§ã€éœ€è¦ä»€ä¹ˆæœºåˆ¶æ¥æä¾›çµæ´»æ€§ï¼Œæˆ‘æ›´æ„¿æ„åªæ ¹æ®å½“å‰çš„éœ€æ±‚æ¥æ„é€ è½¯ä»¶ï¼ŒåŒæ—¶æŠŠè½¯ä»¶çš„è®¾è®¡è´¨é‡åšå¾—å¾ˆé«˜ã€‚éšç€å¯¹ç”¨æˆ·éœ€æ±‚çš„ç†è§£åŠ æ·±ï¼Œæˆ‘ä¼šå¯¹æ¶æ„è¿›è¡Œé‡æ„ï¼Œä½¿å…¶èƒ½å¤Ÿåº”å¯¹æ–°çš„éœ€è¦ã€‚å¦‚æœä¸€ç§çµæ´»æ€§æœºåˆ¶ä¸ä¼šå¢åŠ å¤æ‚åº¦ï¼Œæˆ‘å¯ä»¥å¾ˆå¼€å¿ƒåœ°å¼•å…¥å®ƒï¼›ä½†å¦‚æœä¸€ç§çµæ´»æ€§ä¼šå¢åŠ è½¯ä»¶å¤æ‚åº¦ï¼Œå°±å¿…é¡»å…ˆè¯æ˜è‡ªå·±å€¼å¾—è¢«å¼•å…¥ã€‚å¦‚æœä¸åŒçš„è°ƒç”¨è€…ä¸ä¼šä¼ å…¥ä¸åŒçš„å‚æ•°å€¼ï¼Œé‚£ä¹ˆå°±ä¸è¦æ·»åŠ è¿™ä¸ªå‚æ•°ã€‚å½“çœŸçš„éœ€è¦æ·»åŠ è¿™ä¸ªå‚æ•°æ—¶ï¼Œè¿ç”¨å‡½æ•°å‚æ•°åŒ–ä¹Ÿå¾ˆå®¹æ˜“ã€‚è¦åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸ºæœªæ¥çš„å˜åŒ–æ·»åŠ çµæ´»æ€§ï¼Œæˆ‘ä¼šè¯„ä¼°â€œå¦‚æœä»¥åå†é‡æ„æœ‰å¤šå›°éš¾â€ï¼Œåªæœ‰å½“æœªæ¥é‡æ„ä¼šå¾ˆå›°éš¾æ—¶ï¼Œæˆ‘æ‰è€ƒè™‘ç°åœ¨å°±æ·»åŠ çµæ´»æ€§æœºåˆ¶ã€‚æˆ‘å‘ç°è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„å†³ç­–æ–¹æ³•ã€‚</p><p>è¿™ç§è®¾è®¡æ–¹æ³•æœ‰å¾ˆå¤šåå­—ï¼šç®€å•è®¾è®¡ã€å¢é‡å¼è®¾è®¡æˆ–è€… YAGNIâ€”â€”â€œä½ ä¸ä¼šéœ€è¦å®ƒâ€ï¼ˆyou arenÊ¼t going to need itï¼‰çš„ç¼©å†™ã€‚YAGNI å¹¶ä¸æ˜¯â€œä¸åšæ¶æ„æ€§æ€è€ƒâ€çš„æ„æ€ï¼Œä¸è¿‡ç¡®å®æœ‰äººä»¥è¿™ç§æ¬ è€ƒè™‘çš„æ–¹å¼åšäº‹ã€‚æˆ‘æŠŠ YAGNI è§†ä¸ºå°†æ¶æ„ã€è®¾è®¡ä¸å¼€å‘è¿‡ç¨‹èåˆçš„ä¸€ç§å·¥ä½œæ–¹å¼ï¼Œè¿™ç§å·¥ä½œæ–¹å¼å¿…é¡»æœ‰é‡æ„ä½œä¸ºåŸºç¡€æ‰å¯é ã€‚</p><h1 id="é‡æ„ä¸è½¯ä»¶å¼€å‘è¿‡ç¨‹">é‡æ„ä¸è½¯ä»¶å¼€å‘è¿‡ç¨‹</h1><p>é‡æ„çš„ç¬¬ä¸€å—åŸºçŸ³æ˜¯è‡ªæµ‹è¯•ä»£ç ã€‚æˆ‘åº”è¯¥æœ‰ä¸€å¥—è‡ªåŠ¨åŒ–çš„æµ‹è¯•ï¼Œæˆ‘å¯ä»¥é¢‘ç¹åœ°è¿è¡Œå®ƒä»¬ï¼Œå¹¶ä¸”æˆ‘æœ‰ä¿¡å¿ƒï¼šå¦‚æœæˆ‘åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­çŠ¯äº†ä»»ä½•é”™è¯¯ï¼Œä¼šæœ‰æµ‹è¯•å¤±è´¥ã€‚ å¦‚æœä¸€æ”¯å›¢é˜Ÿæƒ³è¦é‡æ„ï¼Œé‚£ä¹ˆæ¯ä¸ªå›¢é˜Ÿæˆå‘˜éƒ½éœ€è¦æŒæ¡é‡æ„æŠ€èƒ½ï¼Œèƒ½åœ¨éœ€è¦æ—¶å¼€å±•é‡æ„ï¼Œè€Œä¸ä¼šå¹²æ‰°å…¶ä»–äººçš„å·¥ä½œã€‚è¿™ä¹Ÿæ˜¯æˆ‘é¼“åŠ±æŒç»­é›†æˆçš„åŸå› ï¼šæœ‰äº† CIï¼Œæ¯ä¸ªæˆå‘˜çš„é‡æ„éƒ½èƒ½å¿«é€Ÿåˆ†äº«ç»™å…¶ä»–åŒäº‹ï¼Œä¸ä¼šå‘ç”Ÿè¿™è¾¹åœ¨è°ƒç”¨ä¸€ä¸ªæ¥å£é‚£è¾¹å´å·²æŠŠè¿™ä¸ªæ¥å£åˆ æ‰çš„æƒ…å†µï¼›å¦‚æœä¸€æ¬¡é‡æ„ä¼šå½±å“åˆ«äººçš„å·¥ä½œï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šçŸ¥é“ã€‚è‡ªæµ‹è¯•çš„ä»£ç ä¹Ÿæ˜¯æŒç»­é›†æˆçš„å…³é”®ç¯èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸‰å¤§å®è·µâ€”â€”è‡ªæµ‹è¯•ä»£ç ã€æŒç»­é›†æˆã€é‡æ„â€”â€”å½¼æ­¤ä¹‹é—´æœ‰ç€å¾ˆå¼ºçš„ååŒæ•ˆåº”ã€‚ æœ‰è¿™ä¸‰å¤§å®è·µåœ¨æ‰‹ï¼Œæˆ‘ä»¬å°±èƒ½è¿ç”¨å‰ä¸€èŠ‚ä»‹ç»çš„ YAGNI è®¾è®¡æ–¹æ³•ã€‚é‡æ„å’Œ YAGNI äº¤ç›¸å‘¼åº”ã€å½¼æ­¤å¢æ•ˆï¼Œé‡æ„ï¼ˆåŠå…¶å‰ç½®å®è·µï¼‰æ˜¯ YAGNI çš„åŸºç¡€ï¼ŒYAGNI åˆè®©é‡æ„æ›´æ˜“äºå¼€å±•ï¼šæ¯”èµ·ä¸€ä¸ªå¡æ»¡äº†æƒ³å½“ç„¶çš„çµæ´»æ€§çš„ç³»ç»Ÿï¼Œå½“ç„¶æ˜¯ä¿®æ”¹ä¸€ä¸ªç®€å•çš„ç³»ç»Ÿè¦å®¹æ˜“å¾—å¤šã€‚åœ¨è¿™äº›å®è·µä¹‹é—´æ‰¾åˆ°åˆé€‚çš„å¹³è¡¡ç‚¹ï¼Œä½ å°±èƒ½è¿›å…¥è‰¯æ€§å¾ªç¯ï¼Œä½ çš„ä»£ç æ—¢ç‰¢å›ºå¯é åˆèƒ½å¿«é€Ÿå“åº”å˜åŒ–çš„éœ€æ±‚ã€‚ æœ‰è¿™ä¸‰å¤§æ ¸å¿ƒå®è·µæ‰“ä¸‹çš„åŸºç¡€ï¼Œæ‰è°ˆå¾—ä¸Šè¿ç”¨æ•æ·æ€æƒ³çš„å…¶ä»–éƒ¨åˆ†ã€‚æŒç»­äº¤ä»˜ç¡®ä¿è½¯ä»¶å§‹ç»ˆå¤„äºå¯å‘å¸ƒçš„çŠ¶æ€ï¼Œå¾ˆå¤šäº’è”ç½‘å›¢é˜Ÿèƒ½åšåˆ°ä¸€å¤©å¤šæ¬¡å‘å¸ƒï¼Œé çš„æ­£æ˜¯æŒç»­äº¤ä»˜çš„å¨åŠ›ã€‚å³ä¾¿æˆ‘ä»¬ä¸éœ€è¦å¦‚æ­¤é¢‘ç¹çš„å‘å¸ƒï¼ŒæŒç»­é›†æˆä¹Ÿèƒ½å¸®æˆ‘ä»¬é™ä½é£é™©ï¼Œå¹¶ä½¿æˆ‘ä»¬åšåˆ°æ ¹æ®ä¸šåŠ¡éœ€è¦éšæ—¶å®‰æ’å‘å¸ƒï¼Œè€Œä¸å—æŠ€æœ¯çš„å±€é™ã€‚æœ‰äº†å¯é çš„æŠ€æœ¯æ ¹åŸºï¼Œæˆ‘ä»¬èƒ½å¤Ÿæå¤§åœ°å‹ç¼©â€œä»å¥½ç‚¹å­åˆ°ç”Ÿäº§ä»£ç â€çš„å‘¨æœŸæ—¶é—´ï¼Œä»è€Œæ›´å¥½åœ°æœåŠ¡å®¢æˆ·ã€‚è¿™äº›æŠ€æœ¯å®è·µä¹Ÿä¼šå¢åŠ è½¯ä»¶çš„å¯é æ€§ï¼Œå‡å°‘è€—è´¹åœ¨ bug ä¸Šçš„æ—¶é—´ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šé‡æ„ æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly9ib29rLXJlZmFjdG9yaW5nMi5pZm1pY3JvLmNvbS9kb2NzL2NoMi5odG1s">https://book-refactoring2.ifmicro.com/docs/ch2.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Refactor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ï¼ˆå››ï¼‰ Effective-C++ï¼ˆä¸‹ï¼‰</title>
      <link href="/2022/Program/CPPEffectivePart3/"/>
      <url>/2022/Program/CPPEffectivePart3/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/Effective-C++3.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMxZDg4YWU0MDFmZDA3MjZiZWIyMDI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¨¡æ¿ä¸æ³›å‹ç¼–ç¨‹">æ¨¡æ¿ä¸æ³›å‹ç¼–ç¨‹</h1><h2 id="æ¡æ¬¾-41äº†è§£éšå¼æ¥å£å’Œç¼–è¯‘æœŸå¤šæ€">æ¡æ¬¾ 41ï¼šäº†è§£éšå¼æ¥å£å’Œç¼–è¯‘æœŸå¤šæ€</h2><p>é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸–ç•Œæ€»æ˜¯ä»¥æ˜¾å¼æ¥å£ï¼ˆ explicit interfacesï¼‰å’Œè¿è¡ŒæœŸå¤šæ€ï¼ˆ runtime polymorphismï¼‰è§£å†³é—®é¢˜ã€‚Templates åŠæ³›å‹ç¼–ç¨‹çš„ä¸–ç•Œï¼Œä¸é¢å‘å¯¹è±¡æœ‰æ ¹æœ¬ä¸Šçš„ä¸åŒã€‚åœ¨æ­¤ä¸–ç•Œä¸­æ˜¾å¼æ¥å£å’Œè¿è¡ŒæœŸå¤šæ€ä»ç„¶å­˜åœ¨ï¼Œä½†é‡è¦æ€§é™ä½ã€‚åå€’æ˜¯éšå¼æ¥å£ï¼ˆ implicit interfacesï¼‰å’Œç¼–è¯‘æœŸå¤šæ€ï¼ˆ compile-time polymorphismï¼‰ç§»åˆ°å‰å¤´äº†ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doprocessing</span><span class="params">(T&amp; w)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (w.<span class="built_in">size</span>() &gt; <span class="number">10</span> &amp;&amp; w != somenastywidget) {</span><br><span class="line">        <span class="function">T <span class="title">temp</span> <span class="params">(w)</span></span>;</span><br><span class="line">        temp.<span class="built_in">normalize</span> ();</span><br><span class="line">        temp.<span class="built_in">swap</span>(w);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>w å¿…é¡»æ”¯æŒå“ªä¸€ç§æ¥å£ï¼Œç³»ç”± template ä¸­æ‰§è¡Œäº w èº«ä¸Šçš„æ“ä½œæ¥å†³å®šã€‚æœ¬ä¾‹çœ‹æ¥ w çš„ç±»å‹å¥½åƒå¿…é¡»æ”¯æŒ sizeï¼Œ normalize å’Œ swap æˆå‘˜å‡½æ•°ã€copy æ„é€ å‡½æ•°ï¼ˆç”¨ä»¥å»ºç«‹ tempï¼‰ã€ä¸ç­‰æ¯”è¾ƒï¼ˆ inequality comparisonï¼Œç”¨æ¥æ¯”è¾ƒ somenasty-Widgetï¼‰ã€‚æˆ‘ä»¬å¾ˆå¿«ä¼šçœ‹åˆ°è¿™å¹¶éå®Œå…¨æ­£ç¡®ï¼Œä½†å¯¹ç›®å‰è€Œè¨€è¶³å¤ŸçœŸå®ã€‚é‡è¦çš„æ˜¯ï¼Œè¿™ä¸€ç»„è¡¨è¾¾å¼ï¼ˆå¯¹æ­¤ template è€Œè¨€å¿…é¡»æœ‰æ•ˆç¼–è¯‘ï¼‰ä¾¿æ˜¯å¿…é¡»æ”¯æŒçš„ä¸€ç»„éšå¼æ¥å£ (implicit interface)ã€‚</li><li>å‡¡æ¶‰åŠ w çš„ä»»ä½•å‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚ operator&gt;å’Œ operator!=ï¼Œæœ‰å¯èƒ½é€ æˆ template å…·ç°åŒ–ï¼ˆ instantiatedï¼‰ï¼Œä½¿è¿™äº›è°ƒç”¨å¾—ä»¥æˆåŠŸã€‚è¿™æ ·çš„å…·ç°è¡Œä¸ºå‘ç”Ÿåœ¨ç¼–è¯‘æœŸã€‚â€œä»¥ä¸åŒçš„ template å‚æ•°å…·ç°åŒ– function templatesâ€ä¼šå¯¼è‡´è°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œè¿™ä¾¿æ˜¯æ‰€è°“çš„ç¼–è¯‘æœŸå¤šæ€ï¼ˆ compile-time polymorphismï¼‰ã€‚</li></ul><p><strong>è¯·è®°ä½</strong></p><ul><li>classes å’Œ templates éƒ½æ”¯æŒæ¥å£ï¼ˆ interfacesï¼‰å’Œå¤šæ€ï¼ˆ polymorphismï¼‰å¯¹ classes è€Œè¨€æ¥å£æ˜¯æ˜¾å¼çš„ï¼ˆ explicitï¼‰ï¼Œä»¥å‡½æ•°ç­¾åä¸ºä¸­å¿ƒã€‚å¤šæ€åˆ™æ˜¯é€šè¿‡ virtual å‡½æ•°å‘ç”Ÿäºè¿è¡ŒæœŸã€‚</li><li>å¯¹ template å‚æ•°è€Œè¨€ï¼Œæ¥å£æ˜¯éšå¼çš„ï¼ˆ implicitï¼‰ï¼Œå¥ åŸºäºæœ‰æ•ˆè¡¨è¾¾å¼ã€‚å¤šæ€åˆ™æ˜¯é€šè¿‡ template å…·ç°åŒ–å’Œå‡½æ•°é‡è½½è§£æï¼ˆ function overloading resolutionï¼‰å‘ç”Ÿäºç¼–è¯‘æœŸã€‚</li></ul><h2 id="æ¡æ¬¾-42äº†è§£-typename-çš„åŒé‡æ„ä¹‰">æ¡æ¬¾ 42ï¼šäº†è§£ typename çš„åŒé‡æ„ä¹‰</h2><ul><li>å£°æ˜ template å‚æ•°æ—¶ï¼Œå‰ç¼€å…³é”®å­— class å’Œ typename å¯äº’æ¢ã€‚</li><li>è¯·ä½¿ç”¨å…³é”®å­— typename æ ‡è¯†åµŒå¥—ä»å±ç±»å‹åç§°ï¼›ä½†ä¸å¾—åœ¨ base class listsï¼ˆåŸºç±»åˆ—ï¼‰æˆ– member initialization listï¼ˆæˆå‘˜åˆå€¼åˆ—ï¼‰å†…ä»¥å®ƒä½œä¸º base class ä¿®é¥°ç¬¦ã€‚</li></ul><h2 id="æ¡æ¬¾-43å­¦ä¹ å¤„ç†æ¨¡æ¿åŒ–åŸºç±»å†…çš„åç§°">æ¡æ¬¾ 43ï¼šå­¦ä¹ å¤„ç†æ¨¡æ¿åŒ–åŸºç±»å†…çš„åç§°</h2><p>å‡è®¾æˆ‘ä»¬éœ€è¦æ’°å†™ä¸€ä¸ªç¨‹åºï¼Œå®ƒèƒ½å¤Ÿä¼ é€ä¿¡æ¯åˆ°è‹¥å¹²ä¸åŒçš„å…¬å¸å»ã€‚ä¿¡æ¯è¦ä¸è¯‘æˆå¯†ç ï¼Œè¦ä¸å°±æ˜¯æœªç»åŠ å·¥çš„æ–‡å­—ã€‚å¦‚æœç¼–è¯‘æœŸé—´æˆ‘ä»¬æœ‰è¶³å¤Ÿä¿¡æ¯æ¥å†³å®šå“ªä¸€ä¸ªä¿¡æ¯ä¼ è‡³å“ªä¸€å®¶å…¬å¸ï¼Œå°±å¯ä»¥é‡‡ç”¨åŸºäº template çš„è§£æ³•ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Class CompanyA</span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendcleartext</span><span class="params">(<span class="type">const</span> std: string&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendencrypted</span><span class="params">(<span class="type">const</span> std: string&amp; msg)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">};</span><br><span class="line">Class CompanyB</span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendcleartext</span><span class="params">(<span class="type">const</span> std: string&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendencrypted</span><span class="params">(<span class="type">const</span> std: :string&amp; msg)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">...                         <span class="comment">//é’ˆå¯¹å…¶ä»–å…¬å¸è®¾è®¡çš„ classes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Msginfo</span> {...};        <span class="comment">//è¿™ä¸ª class ç”¨æ¥ä¿å­˜ä¿¡æ¯ï¼Œä»¥å¤‡å°†æ¥äº§ç”Ÿä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MsgSender</span> {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ...                     <span class="comment">//æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ç­‰ç­‰ã€‚</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendclear</span><span class="params">(<span class="type">const</span> Msginfo&amp; info)</span></span>{</span><br><span class="line">        std::string msg;</span><br><span class="line">        <span class="comment">//åœ¨è¿™å„¿ï¼Œæ ¹æ® info äº§ç”Ÿä¿¡æ¯ï¼›</span></span><br><span class="line">        Company c;</span><br><span class="line">        c.<span class="built_in">sendcleartext</span>(msg);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendSecret</span><span class="params">(<span class="type">const</span> Msginfoinfo)</span>  <span class="comment">//ç±»ä¼¼ sendclearï¼Œå”¯ä¸€ä¸åŒæ˜¯</span></span></span><br><span class="line"><span class="function">    </span>{...}                               <span class="comment">//è¿™é‡Œè°ƒç”¨ c.sendencrypted</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªåšæ³•è¡Œå¾—é€šã€‚ä½†å‡è®¾æˆ‘ä»¬æœ‰æ—¶å€™æƒ³è¦åœ¨æ¯æ¬¡é€å‡ºä¿¡æ¯æ—¶å¿—è®°ï¼ˆlogï¼‰æŸäº›ä¿¡æ¯ã€‚ derived class å¯è½»æ˜“åŠ ä¸Šè¿™æ ·çš„ç”Ÿäº§åŠ›ï¼Œé‚£ä¼¼ä¹æ˜¯ä¸ªåˆæƒ…åˆç†çš„è§£æ³•ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Loggingmsgsender</span>: <span class="keyword">public</span> MsgSender&lt;Company&gt;</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ...                                 <span class="comment">//æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ç­‰ç­‰</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendclearmsg</span><span class="params">(<span class="type">const</span> Msginfo&amp; info)</span></span>{</span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€å‰â€çš„ä¿¡æ¯å†™è‡³ log</span></span><br><span class="line">        <span class="built_in">sendclear</span>(info);    <span class="comment">//è°ƒç”¨ base class å‡½æ•°ï¼›è¿™æ®µç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚ç¼–è¯‘å™¨ä¼šæŠ±æ€¨ sendclear ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€åâ€çš„ä¿¡æ¯å†™è‡³ logï¼›</span></span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>é—®é¢˜åœ¨äºï¼Œå½“ç¼–è¯‘å™¨é­é‡ class template Loggingmsgsender å®šä¹‰å¼æ—¶ï¼Œå¹¶ä¸çŸ¥é“å®ƒç»§æ‰¿ä»€ä¹ˆæ ·çš„ class å½“ç„¶å®ƒç»§æ‰¿çš„æ˜¯ MsgSender<company>ï¼Œä½†å…¶ä¸­çš„ Company æ˜¯ä¸ª template å‚æ•°ï¼Œä¸åˆ°åæ¥ï¼ˆå½“ Loggingmsg Sender è¢«å…·ç°åŒ–ï¼‰æ— æ³•ç¡®åˆ‡çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆã€‚è€Œå¦‚æœä¸çŸ¥é“ Company æ˜¯ä»€ä¹ˆï¼Œå°±æ— æ³•çŸ¥é“ class MsgSender<company>çœ‹èµ·æ¥åƒä»€ä¹ˆä¸€æ›´æ˜ç¡®åœ°è¯´æ˜¯æ²¡åŠæ³•çŸ¥é“å®ƒæ˜¯å¦æœ‰ä¸ª sendclear å‡½æ•°ã€‚</company></company></p><p>æœ‰ä¸‰ä¸ªåŠæ³•ï¼Œç¬¬ä¸€æ˜¯åœ¨ base class å‡½æ•°è°ƒç”¨åŠ¨ä½œä¹‹å‰åŠ ä¸Š "this-&gt;":</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Loggingmsgsender</span>: <span class="keyword">public</span> Msgsender&lt;Company&gt;</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendclearmsg</span><span class="params">(<span class="type">const</span> Msginfo&amp; info)</span></span>{</span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€å‰â€çš„ä¿¡æ¯å†™è‡³ log</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">sendclear</span>(info);   <span class="comment">//æˆç«‹å‡è®¾ sendClean è¢«ç»§æ‰¿</span></span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€åâ€çš„ä¿¡æ¯å†™è‡³ logï¼›</span></span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬äºŒæ˜¯ä½¿ç”¨ using å£°æ˜å¼ã€‚å¦‚æœä½ å·²è¯»è¿‡æ¡æ¬¾ 33ï¼Œè¿™ä¸ªè§£æ³•åº”è¯¥ä¼šä»¤ä½ æ„Ÿåˆ°ç†Ÿæ‚‰ã€‚æ¡æ¬¾ 33 æè¿° using å£°æ˜å¼å¦‚ä½•å°†â€œè¢«æ©ç›–çš„ base class 2 åç§°â€å¸¦å…¥ä¸ª derived class ä½œç”¨åŸŸå†…ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ä¸‹ sendclearmsg:</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Loggingmsgsender</span>: <span class="keyword">public</span> Msgsender&lt;Company&gt;</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> Msgsender&lt;Company&gt;::sendclearï¼›<span class="comment">//å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¯·å®ƒå‡è®¾</span></span><br><span class="line">    ...                                 <span class="comment">// sendclear ä½äº base class å†…ã€‚</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendclearmsg</span><span class="params">(<span class="type">const</span> Msginfo&amp; info)</span></span>{</span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€å‰â€çš„ä¿¡æ¯å†™è‡³ log</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">sendclear</span>(info);   <span class="comment">//OKï¼Œå‡è®¾ sendclear å°†è¢«ç»§æ‰¿ä¸‹æ¥ã€‚</span></span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€åâ€çš„ä¿¡æ¯å†™è‡³ logï¼›</span></span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ä¸‰ä¸ªåšæ³•æ˜¯ï¼Œæ˜ç™½æŒ‡å‡ºè¢«è°ƒç”¨çš„å‡½æ•°ä½äº base class å†…ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Company&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Loggingmsgsender</span>: <span class="keyword">public</span> Msgsender&lt;Company&gt;</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendclearmsg</span><span class="params">(<span class="type">const</span> Msginfo&amp; info)</span></span>{</span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€å‰â€çš„ä¿¡æ¯å†™è‡³ log</span></span><br><span class="line">        Msgsender&lt;Company&gt;::<span class="built_in">sendclear</span>(info);  <span class="comment">//OK, sendclear</span></span><br><span class="line">        <span class="comment">//å°†â€œä¼ é€åâ€çš„ä¿¡æ¯å†™è‡³ logï¼›</span></span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ä½†è¿™å¾€å¾€æ˜¯æœ€ä¸è®©äººæ»¡æ„çš„ä¸€ä¸ªè§£æ³•ï¼Œå› ä¸ºå¦‚æœè¢«è°ƒç”¨çš„æ˜¯ virtual å‡½æ•°ï¼Œä¸Šè¿°çš„æ˜ç¡®èµ„æ ¼ä¿®é¥°ï¼ˆ explicit qualificationï¼‰ä¼šå…³é—­â€œ virtual ç»‘å®šè¡Œä¸ºâ€ã€‚</p><p><strong>è¯·è®°ä½</strong></p><p>å¯åœ¨ derived class templates å†…é€šè¿‡" this-&gt;"æŒ‡æ¶‰ base class templates å†…çš„æˆå‘˜åç§°ï¼Œæˆ–è—‰ç”±ä¸€ä¸ªæ˜ç™½å†™å‡ºçš„â€œbase class èµ„æ ¼ä¿®ä½ˆç¬¦â€å®Œæˆã€‚</p><h2 id="æ¡æ¬¾-44å°†ä¸å‚æ•°æ— å…³çš„ä»£ç æŠ½ç¦»-templates">æ¡æ¬¾ 44ï¼šå°†ä¸å‚æ•°æ— å…³çš„ä»£ç æŠ½ç¦» templates</h2><ul><li>Templates ç”Ÿæˆå¤šä¸ª classes å’Œå¤šä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä»»ä½• template ä»£ç éƒ½ä¸è¯¥ä¸æŸä¸ªé€ æˆè†¨èƒ€çš„ template å‚æ•°äº§ç”Ÿç›¸ä¾å…³ç³»ã€‚</li><li>å› éç±»å‹æ¨¡æ¿å‚æ•°ï¼ˆnon ä¸€ type template parametersï¼‰è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯æ¶ˆé™¤ï¼Œåšæ³•æ˜¯ä»¥å‡½æ•°å‚æ•°æˆ– class æˆå‘˜å˜é‡æ›¿æ¢ template å‚æ•°ã€‚</li><li>å› ç±»å‹å‚æ•°ï¼ˆ type parametersï¼‰è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯é™ä½ï¼Œåšæ³•æ˜¯è®©å¸¦æœ‰å®Œå…¨ç›¸åŒäºŒè¿›åˆ¶è¡¨è¿°ï¼ˆ binary representationsï¼‰çš„å…·ç°ç±»å‹ï¼ˆ instantiation typesï¼‰å…±äº«å®ç°ç ã€‚</li></ul><h2 id="æ¡æ¬¾-45è¿ç”¨æˆå‘˜å‡½æ•°æ¨¡æ¿æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹">æ¡æ¬¾ 45ï¼šè¿ç”¨æˆå‘˜å‡½æ•°æ¨¡æ¿æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹</h2><ul><li>è¯·ä½¿ç”¨ member function templatesï¼ˆæˆå‘˜å‡½æ•°æ¨¡æ¿ï¼‰ç”Ÿæˆâ€œå¯æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹çš„å‡½æ•°ã€‚</li><li>å¦‚æœä½ å£°æ˜ member templates ç”¨äºâ€œæ³›åŒ– copy æ„é€ â€æˆ–â€œæ³›åŒ– assignment æ“ä½œâ€ï¼Œä½ è¿˜æ˜¯éœ€è¦å£°æ˜æ­£å¸¸çš„ copy æ„é€ å‡½æ•°å’Œ copy assignment æ“ä½œç¬¦ã€‚</li></ul><h2 id="æ¡æ¬¾-46éœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•°">æ¡æ¬¾ 46ï¼šéœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•°</h2><p>æ¨¡æ¿ç±»ä¸­çš„æ¨¡æ¿å‡½æ•°ä¸æ”¯æŒéšå¼ç±»å‹è½¬æ¢ï¼Œå¦‚æœä½ åœ¨è°ƒç”¨æ—¶ä¼ äº†ä¸€ä¸ªå…¶ä»–ç±»å‹çš„å˜é‡ï¼Œç¼–è¯‘å™¨æ— æ³•å¸®ä½ åšç±»å‹è½¬æ¢ï¼Œä»è€ŒæŠ¥é”™ã€‚ è§£å†³æ–¹æ¡ˆæ˜¯å°†è¯¥æ¨¡æ¿å‡½æ•°å®šä¹‰ä¸ºæ¨¡æ¿ç±»å†…çš„å‹å…ƒæ¨¡æ¿å‡½æ•°ï¼Œä»è€Œæ”¯æŒäº†å‚æ•°çš„éšå¼è½¬æ¢ã€‚</p><h2 id="æ¡æ¬¾-47è¯·ä½¿ç”¨-traits-classes-è¡¨ç°ç±»å‹ä¿¡æ¯">æ¡æ¬¾ 47ï¼šè¯·ä½¿ç”¨ traits classes è¡¨ç°ç±»å‹ä¿¡æ¯</h2><p>å¯¹äºæ¨¡æ¿å‡½æ•°ï¼Œå¯èƒ½å¯¹äºæ¥æ”¶å‚æ•°çš„ä¸åŒç±»å‹ï¼Œæœ‰ä¸åŒçš„å®ç°ã€‚æ­¤æ—¶ï¼Œå¯ä»¥æä¾›ä¸€ä¸ª traits classï¼Œå…¶ä¸­åŒ…å«äº†æŸä¸€ç³»åˆ—ç±»å‹çš„ç±»å‹ä¿¡æ¯ï¼ˆé€šå¸¸ä»¥æšä¸¾åŒºåˆ†å…·ä½“ç±»å‹ï¼‰ï¼Œç„¶åï¼Œåœ¨è¯¥ç±»ä¸­å®ç°æ¥æ”¶å¤šç§ traits å‚æ•°çš„é‡è½½å·¥å…·å‡½æ•°ï¼Œç”¨æ¥æ ¹æ®æ ‡è¯†çš„ä¸åŒç±»è¿›è¡Œä¸åŒçš„å…·ä½“å‡½æ•°æ“ä½œã€‚è¿™ä½¿å¾—è¯¥è¡Œä¸ºèƒ½åœ¨ç¼–è¯‘æœŸå°±è¢«åŒºåˆ†ã€‚</p><h2 id="æ¡æ¬¾-48è®¤è¯†æ¨¡æ¿å…ƒç¼–ç¨‹tmp">æ¡æ¬¾ 48ï¼šè®¤è¯†æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTMPï¼‰</h2><p>æ‰€è°“ template metaprogramï¼ˆæ¨¡æ¿å…ƒç¨‹åºï¼‰æ˜¯ä»¥ C++å†™æˆã€æ‰§è¡Œäº C++ç¼–è¯‘å™¨å†…çš„ç¨‹åºã€‚ä¸€æ—¦ TMP ç¨‹åºç»“æŸæ‰§è¡Œï¼Œå…¶è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯ä» templates å…·ç°å‡ºæ¥çš„è‹¥å¹² C++æºç ï¼Œä¾¿ä¼šä¸€å¦‚å¾€å¸¸åœ°è¢«ç¼–è¯‘ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">unsigned</span> n&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Factorial</span> {</span><br><span class="line">    <span class="keyword">enum</span> { value = n * Factorial&lt;n<span class="number">-1</span>&gt;::value };</span><br><span class="line">};</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Factorial</span>&lt;<span class="number">0</span>&gt; {</span><br><span class="line">    <span class="keyword">enum</span> { value = <span class="number">1</span> };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æœ‰äº†è¿™ä¸ª template metaprogramï¼ˆå…¶å®åªæ˜¯ä¸ªå•ä¸€çš„ template metafuncti acterialï¼‰ï¼Œåªè¦ä½ æŒ‡æ¶‰ Factoria<n>ï¼š value å°±å¯ä»¥å¾—åˆ°é˜¶ä¹˜å€¼ã€‚</n></p><p>å¾ªç¯å‘ç”Ÿåœ¨ template å…·ç°ä½“ Factorial<n>å†…éƒ¨æŒ‡æ¶‰å¦ä¸€ä¸ª template å…·ç°ä½“ Factorial<n-1>ä¹‹æ—¶ã€‚å’Œæ‰€æœ‰è‰¯å¥½é€’å½’ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç‰¹æ®Šæƒ…å†µé€ æˆé€’å½’ç»“æŸã€‚è¿™é‡Œçš„ç‰¹æ®Šæƒ…å†µæ˜¯ template ç‰¹åŒ–ä½“ Factorial&lt;0&gt;ã€‚</n-1></n></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std: cout &lt;&lt; Factorial&lt;<span class="number">5</span>&gt;::value;    <span class="comment">//å°å‡º 120</span></span><br><span class="line">    std: cout &lt;&lt; Factorial&lt;<span class="number">10</span>&gt;::value;   <span class="comment">//å°å‡º 3628800</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>è¯·è®°ä½</strong></p><ul><li>Template metaprogrammingï¼ˆTMPï¼Œæ¨¡æ¿å…ƒç¼–ç¨‹ï¼‰å¯å°†å·¥ä½œç”±è¿è¡ŒæœŸç§»å¾€ç¼–è¯‘æœŸå› è€Œå¾—ä»¥å®ç°æ—©æœŸé”™è¯¯ä¾¦æµ‹å’Œæ›´é«˜çš„æ‰§è¡Œæ•ˆç‡</li><li>TMP å¯è¢«ç”¨æ¥ç”Ÿæˆâ€œåŸºäºæ”¿ç­–é€‰æ‹©ç»„åˆâ€ï¼ˆ based on combinations of policy choicesï¼‰çš„å®¢æˆ·å®šåˆ¶ä»£ç ï¼Œä¹Ÿå¯ç”¨æ¥é¿å…ç”Ÿæˆå¯¹æŸäº›ç‰¹æ®Šç±»å‹å¹¶ä¸é€‚åˆçš„ä»£ç </li></ul><h1 id="å®šåˆ¶-new-å’Œ-delete">å®šåˆ¶ new å’Œ delete</h1><h2 id="æ¡æ¬¾-49äº†è§£-new-handler-çš„è¡Œä¸º">æ¡æ¬¾ 49ï¼šäº†è§£ new-handler çš„è¡Œä¸º</h2><ul><li>set_new_handler å…è®¸å®¢æˆ·æŒ‡å®šä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å†…å­˜åˆ†é…æ— æ³•è·å¾—æ»¡è¶³æ—¶è¢«è°ƒç”¨ã€‚</li><li>Nothrow new æ˜¯ä¸€ä¸ªé¢‡ä¸ºå±€é™çš„å·¥å…·ï¼Œå› ä¸ºå®ƒåªé€‚ç”¨äºå†…å­˜åˆ†é…ï¼›åç»§çš„æ„é€ å‡½æ•°è°ƒç”¨è¿˜æ˜¯å¯èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><h2 id="æ¡æ¬¾-50äº†è§£-new-å’Œ-delete-çš„åˆç†æ›¿æ›æ—¶æœº">æ¡æ¬¾ 50ï¼šäº†è§£ new å’Œ delete çš„åˆç†æ›¿æ›æ—¶æœº</h2><p>è®©æˆ‘ä»¬æš‚æ—¶å›åˆ°æ ¹æœ¬åŸç†ã€‚é¦–å…ˆï¼Œæ€ä¹ˆä¼šæœ‰äººæƒ³è¦æ›¿æ¢ç¼–è¯‘å™¨æä¾›çš„ operatornew æˆ– operator deletel å‘¢ï¼Ÿä¸‹é¢æ˜¯ä¸‰ä¸ªæœ€å¸¸è§çš„ç†ç”±ï¼š</p><ul><li><p>ç”¨æ¥æ£€æµ‹è¿ç”¨ä¸Šçš„é”™è¯¯ã€‚å¦‚æœå°†â€œnew æ‰€å¾—å†…å­˜â€ delete æ‰å´ä¸å¹¸å¤±è´¥ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆ memory leaksï¼‰ã€‚å¦‚æœåœ¨â€œnew æ‰€å¾—å†…å­˜â€èº«ä¸Šå¤šæ¬¡ delete åˆ™ä¼šå¯¼è‡´ä¸ç¡®å®šè¡Œä¸ºã€‚å¦‚æœ operator new æŒæœ‰ä¸€ä¸²åŠ¨æ€åˆ†é…æ‰€å¾—åœ°å€ï¼Œè€Œ operator delete å°†åœ°å€ä»ä¸­ç§»èµ°ï¼Œå€’æ˜¯å¾ˆå®¹æ˜“æ£€æµ‹å‡ºä¸Šè¿°é”™è¯¯ç”¨æ³•ã€‚æ­¤å¤–å„å¼å„æ ·çš„ç¼–ç¨‹é”™è¯¯å¯èƒ½å¯¼è‡´æ•°æ®" over runs"ï¼ˆå†™å…¥ç‚¹åœ¨åˆ†é…åŒºå—å°¾ç«¯ä¹‹åï¼‰æˆ–" under runs"ï¼ˆå†™å…¥ç‚¹åœ¨åˆ†é…åŒºå—èµ·ç‚¹ä¹‹å‰ï¼‰ã€‚å¦‚æœæˆ‘ä»¬è‡ªè¡Œå®šä¹‰ä¸ª operator newsï¼Œä¾¿å¯è¶…é¢åˆ†é…å†…å­˜ï¼Œä»¥é¢å¤–ç©ºé—´ï¼ˆä½äºå®¢æˆ·æ‰€å¾—åŒºå—ä¹‹å‰æˆ–åï¼‰æ”¾ç½®ç‰¹å®šçš„ byte pattemsï¼ˆå³ç­¾åï¼Œ signaturesï¼‰ã€‚ operator deletes ä¾¿å¾—ä»¥æ£€æŸ¥ä¸Šè¿°ç­¾åæ˜¯å¦åŸå°ä¸åŠ¨ï¼Œè‹¥å¦å°±è¡¨ç¤ºåœ¨åˆ†é…åŒºçš„æŸä¸ªç”Ÿå‘½æ—¶é—´ç‚¹å‘ç”Ÿäº† over run æˆ– under runï¼Œè¿™æ—¶å€™ operator delete å¯ä»¥å¿—è®°ï¼ˆlogï¼‰é‚£ä¸ªäº‹å®ä»¥åŠé‚£ä¸ªæƒ¹æ˜¯ç”Ÿéçš„æŒ‡é’ˆã€‚</p></li><li><p>ä¸ºäº†å¼ºåŒ–æ•ˆèƒ½ã€‚ç¼–è¯‘å™¨æ‰€å¸¦çš„ operator new å’Œ operator delete ä¸»è¦ç”¨äºä¸€èˆ¬ç›®çš„ã€‚å®ƒä»¬å¿…é¡»å¤„ç†ä¸€ç³»åˆ—éœ€æ±‚ï¼ŒåŒ…æ‹¬å¤§å—å†…å­˜ã€å°å—å†…å­˜ã€å¤§å°æ··åˆå‹å†…å­˜ã€‚å®ƒä»¬å¿…é¡»æ¥çº³å„ç§åˆ†é…å½¢æ€ï¼ŒèŒƒå›´ä»ç¨‹åºå­˜æ´»æœŸé—´çš„å°‘é‡åŒºå—åŠ¨æ€åˆ†é…ï¼Œåˆ°å¤§æ•°é‡çŸ­å‘½å¯¹è±¡çš„æŒç»­åˆ†é…å’Œå½’è¿˜ã€‚å®ƒä»¬å¿…é¡»è€ƒè™‘ç ´ç¢é—®é¢˜ï¼ˆ fragmentationï¼‰ï¼Œè¿™æœ€ç»ˆä¼šå¯¼è‡´ç¨‹åºæ— æ³•æ»¡è¶³å¤§åŒºå—å†…å­˜è¦æ±‚å³ä½¿å½¼æ—¶æœ‰æ€»é‡è¶³å¤Ÿä½†åˆ†æ•£ä¸ºè®¸å¤šå°åŒºå—çš„è‡ªç”±å†…å­˜ã€‚</p></li><li><p>ä¸ºäº†æ”¶é›†ä½¿ç”¨ä¸Šçš„ç»Ÿè®¡æ•°æ®ã€‚åœ¨ä¸€å¤´æ ½è¿›å®šåˆ¶å‹ news å’Œå®šåˆ¶å‹ deletes ä¹‹å‰ï¼Œç†å½“å…ˆæ”¶é›†ä½ çš„è½¯ä»¶å¦‚ä½•ä½¿ç”¨å…¶åŠ¨æ€å†…å­˜ã€‚åˆ†é…åŒºå—çš„å¤§å°åˆ†å¸ƒå¦‚ä½•ï¼Ÿå¯¿å‘½åˆ†å¸ƒå¦‚ä½•ï¼Ÿå®ƒä»¬å€¾å‘äºä»¥ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰æ¬¡åºæˆ– LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰æ¬¡åºæˆ–éšæœºæ¬¡åºæ¥åˆ†é…å’Œå½’è¿˜ï¼Ÿå®ƒä»¬çš„è¿ç”¨å‹æ€æ˜¯å¦éšæ—¶é—´æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„è½¯ä»¶åœ¨ä¸åŒçš„æ‰§è¡Œé˜¶æ®µæœ‰ä¸åŒçš„åˆ†é…å½’è¿˜å½¢æ€å—ï¼Ÿä»»ä½•æ—¶åˆ»æ‰€ä½¿ç”¨çš„æœ€å¤§åŠ¨æ€åˆ†é…é‡ï¼ˆé«˜æ°´ä½ï¼‰æ˜¯å¤šå°‘ï¼Ÿè‡ªè¡Œå®šä¹‰ operator new å’Œ operator delete ä½¿æˆ‘ä»¬å¾—ä»¥è½»æ¾æ”¶é›†åˆ°è¿™äº›ä¿¡æ¯ã€‚</p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠEffective C++ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ï¼ˆä¸‰ï¼‰ Effective C++ï¼ˆä¸­ï¼‰</title>
      <link href="/2021/Program/CPPEffectivePart2/"/>
      <url>/2021/Program/CPPEffectivePart2/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/Effective-C++2.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMxY2E5ODBlM2U3NDA3ZGE1MDFhNDM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="è®¾è®¡ä¸å£°æ˜">è®¾è®¡ä¸å£°æ˜</h1><h2 id="æ¡æ¬¾-19è®¾è®¡-class-çŠ¹å¦‚è®¾è®¡-type">æ¡æ¬¾ 19ï¼šè®¾è®¡ class çŠ¹å¦‚è®¾è®¡ type</h2><p>C++å°±åƒåœ¨å…¶ä»– OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰è¯­è¨€ä¸€æ ·ï¼Œå½“ä½ å®šä¹‰ä¸€ä¸ªæ–° classï¼Œä¹Ÿå°±å®šä¹‰äº†ä¸€ä¸ªæ–° typeã€‚è¿™æ„å‘³ä½ å¹¶ä¸åªæ˜¯ class è®¾è®¡è€…ï¼Œè¿˜æ˜¯ type è®¾è®¡è€…ã€‚é‡è½½ï¼ˆ overloadingï¼‰å‡½æ•°å’Œæ“ä½œç¬¦ã€æ§åˆ¶å†…å­˜çš„åˆ†é…å’Œå½’è¿˜ã€å®šä¹‰å¯¹è±¡çš„åˆå§‹åŒ–å’Œç»ˆç»“å…¨éƒ½åœ¨ä½ æ‰‹ä¸Šã€‚å› æ­¤ä½ åº”è¯¥å¸¦ç€å’Œâ€œè¯­è¨€è®¾è®¡è€…å½“åˆè®¾è®¡è¯­è¨€å†…ç½®ç±»å‹æ—¶â€ä¸€æ ·çš„è°¨æ…æ¥ç ”è®¨ class çš„è®¾è®¡ã€‚</p><h2 id="æ¡æ¬¾-20å®ä»¥ä¼ é€’-const-å¼•ç”¨æ›¿æ¢ä¼ é€’å€¼">æ¡æ¬¾ 20ï¼šå®ä»¥ä¼ é€’ const å¼•ç”¨æ›¿æ¢ä¼ é€’å€¼</h2><p>ç¼ºçœæƒ…å†µä¸‹ C++ä»¥ by value æ–¹å¼ä¼ é€’å¯¹è±¡è‡³ï¼ˆæˆ–æ¥è‡ªï¼‰å‡½æ•°ã€‚é™¤éä½ å¦å¤–æŒ‡å®šï¼Œå¦åˆ™å‡½æ•°å‚æ•°éƒ½æ˜¯ä»¥å®é™…å®å‚çš„å¤ä»¶ï¼ˆå‰¯æœ¬ï¼‰ä¸ºåˆå€¼ï¼Œè€Œè°ƒç”¨ç«¯æ‰€è·å¾—çš„äº¦æ˜¯å‡½æ•°è¿”å›å€¼çš„ä¸€ä¸ªå¤ä»¶ã€‚è¿™äº›å¤ä»¶ï¼ˆå‰¯æœ¬ï¼‰ç³»ç”±å¯¹è±¡çš„ capy æ„é€ å‡½æ•°äº§å‡ºï¼Œè¿™å¯èƒ½ä½¿å¾— pass-by-value æˆä¸ºè´¹æ—¶çš„æ“ä½œã€‚</p><p>å¦‚æœæœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å›é¿æ‰€æœ‰é‚£äº›æ„é€ å’Œææ„åŠ¨ä½œå°±å¤ªå¥½äº†ã€‚æœ‰çš„ï¼Œå°±æ˜¯ pass by reference-to-constï¼šè¿™ç§ä¼ é€’æ–¹å¼çš„æ•ˆç‡é«˜å¾—å¤šï¼šæ²¡æœ‰ä»»ä½•æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°è¢«è°ƒç”¨ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æ–°å¯¹è±¡è¢«åˆ›å»ºã€‚ä¿®è®¢åçš„è¿™ä¸ªå‚æ•°å£°æ˜ä¸­çš„ const æ˜¯é‡è¦çš„ã€‚</p><p>ä»¥ by reference æ–¹å¼ä¼ é€’å‚æ•°ä¹Ÿå¯ä»¥é¿å… slicingï¼ˆå¯¹è±¡åˆ‡å‰²ï¼‰é—®é¢˜ã€‚å½“ä¸€ä¸ª derived class å¯¹è±¡ä»¥ by value æ–¹å¼ä¼ é€’å¹¶è¢«è§†ä¸ºä¸€ä¸ª base class å¯¹è±¡ï¼Œ base class çš„ copy æ„é€ å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œè€Œâ€œé€ æˆæ­¤å¯¹è±¡çš„è¡Œä¸ºåƒä¸ª derived class å¯¹è±¡â€çš„é‚£äº›ç‰¹åŒ–æ€§è´¨å…¨è¢«åˆ‡å‰²æ‰äº†ï¼Œä»…ä»…ç•™ä¸‹ä¸€ä¸ª base class å¯¹è±¡ã€‚è¿™å®åœ¨ä¸æ€ä¹ˆè®©äººæƒŠè®¶ï¼Œå› ä¸ºæ­£æ˜¯ base class æ„é€ å‡½æ•°å»ºç«‹äº†å®ƒï¼Œä½†è¿™å‡ ä¹ç»ä¸ä¼šæ˜¯ä½ æƒ³è¦çš„ã€‚</p><p><strong>è¯·è®°ä½</strong></p><ul><li>å°½é‡ä»¥ pass-by-reference-to-const æ›¿æ¢ pass-by-valueã€‚å‰è€…é€šå¸¸æ¯”è¾ƒé«˜æ•ˆï¼Œå¹¶å¯é¿å…åˆ‡å‰²é—®é¢˜ï¼ˆ slicing problemï¼‰</li><li>ä»¥ä¸Šè§„åˆ™å¹¶ä¸é€‚ç”¨äºå†…ç½®ç±»å‹ï¼Œä»¥åŠ STL çš„è¿­ä»£å™¨å’Œå‡½æ•°å¯¹è±¡ã€‚å¯¹å®ƒä»¬è€Œè¨€ pass-by-value å¾€å¾€æ¯”è¾ƒé€‚å½“</li></ul><h2 id="æ¡æ¬¾-21å¿…é¡»è¿”å›å¯¹è±¡æ—¶åˆ«å¦„æƒ³è¿”å›å…¶å¼•ç”¨">æ¡æ¬¾ 21ï¼šå¿…é¡»è¿”å›å¯¹è±¡æ—¶ï¼Œåˆ«å¦„æƒ³è¿”å›å…¶å¼•ç”¨</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Rational&amp; <span class="keyword">operator</span>* (<span class="type">const</span> Rational&amp; lhs</span><br><span class="line">                            <span class="type">const</span> Rational&amp;rhs)</span><br><span class="line">{                               <span class="comment">//è­¦å‘Šï¼Œåˆä¸€å †çƒ‚ä»£ç </span></span><br><span class="line">    <span class="type">static</span> Rational result;     <span class="comment">// static å¯¹è±¡ï¼Œæ­¤å‡½æ•°å°†è¿”å›å…¶ reference</span></span><br><span class="line">    result = ...                <span class="comment">//å°† lhs ä¹˜ä»¥ rhsï¼Œå¹¶å°†ç»“æœç½®äº result å†…</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å°±åƒæ‰€æœ‰ç”¨ä¸Š static å¯¹è±¡çš„è®¾è®¡ä¸€æ ·ï¼Œè¿™ä¸€ä¸ªä¹Ÿç«‹åˆ»é€ æˆæˆ‘ä»¬å¯¹å¤šçº¿ç¨‹å®‰å…¨æ€§çš„ç–‘è™‘ã€‚ä¸è¿‡é‚£è¿˜åªæ˜¯å®ƒæ˜¾è€Œæ˜“è§çš„å¼±ç‚¹ã€‚å¦‚æœæƒ³çœ‹çœ‹æ›´æ·±å±‚çš„ç‘•ç–µï¼Œè€ƒè™‘ä»¥ä¸‹é¢è¿™äº›å®Œå…¨åˆç†çš„å®¢æˆ·ä»£ç </p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> Rational&amp; lhs     <span class="comment">//ãƒ¼ä¸ªé’ˆå¯¹ Rationals</span></span><br><span class="line">                <span class="type">const</span> Rational&amp; rhsï¼‰ï¼› <span class="comment">//è€Œå†™çš„ operatorï¼š==</span></span><br><span class="line">Rational a, b, c, d;</span><br><span class="line"><span class="keyword">if</span>ï¼ˆï¼ˆa*bï¼‰ == (c*d) {</span><br><span class="line">    ...     <span class="comment">//å½“ä¹˜ç§¯ç›¸ç­‰æ—¶ï¼Œåšé€‚å½“çš„ç›¸åº”åŠ¨ä½œ</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    ...     <span class="comment">//å½“ä¹˜ç§¯ä¸ç­‰æ—¶ï¼Œåšé€‚å½“çš„ç›¸åº”åŠ¨ä½œ</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>çŒœæƒ³æ€ä¹ˆç€ï¼Ÿè¡¨è¾¾å¼ï¼ˆa * bï¼‰==ï¼ˆc * dï¼‰ï¼‰æ€»æ˜¯è¢«æ ¸ç®—ä¸º trueï¼Œä¸è®º aï¼Œbï¼Œc å’Œ d çš„å€¼æ˜¯ä»€ä¹ˆï¼ ä¸€æ—¦å°†ä»£ç é‡æ–°å†™ä¸ºç­‰ä»·çš„å‡½æ•°å½¢å¼ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥äº†è§£å‡ºäº†ä»€ä¹ˆæ„å¤–ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">operator</span>==(<span class="keyword">operator</span>*(a, b), <span class="keyword">operator</span>*(c, d)))</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼Œåœ¨ operator==è¢«è°ƒç”¨å‰ï¼Œå·²æœ‰ä¸¤ä¸ª operator* è°ƒç”¨å¼èµ·ä½œç”¨ï¼Œæ¯ä¸€ä¸ªéƒ½è¿”å› reference æŒ‡å‘ operator çš„å†…éƒ¨å®šä¹‰çš„ static Rational å¯¹è±¡ã€‚å› æ­¤ operator=è¢«è¦æ±‚å°†â€œ operator* å†…çš„ static Rational å¯¹è±¡å€¼â€æ‹¿æ¥å’Œâ€œ operator* å†…çš„ static Rational å¯¹è±¡å€¼â€æ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒç»“æœä¸ç›¸ç­‰ï¼Œé‚£ã‚ªå¥‡æ€ªå‘¢ã€‚ï¼ˆè¯‘æ³¨ï¼šè¿™é‡Œæˆ‘è¡¥å……è¯´æ˜ï¼šä¸¤æ¬¡ operator *è°ƒç”¨çš„ç¡®å„è‡ªæ”¹å˜äº† static Rational å¯¹è±¡å€¼ï¼Œä½†ç”±äºå®ƒä»¬è¿”å›çš„éƒ½æ˜¯ referenceï¼Œå› æ­¤è°ƒç”¨ç«¯çœ‹åˆ°çš„æ°¸è¿œæ˜¯ static Rational å¯¹è±¡çš„â€œç°å€¼â€ã€‚ï¼‰</p><p><strong>è¯·è®°ä½</strong></p><p>ç»ä¸è¦è¿”å› pointer æˆ– reference æŒ‡å‘ä¸€ä¸ª local stack å¯¹è±¡ï¼Œæˆ–è¿”å› reference æŒ‡å‘ä¸ª heap allocated å¯¹è±¡ï¼Œæˆ–è¿”å› pointer æˆ– reference æŒ‡å‘ä¸€ä¸ª local static å¯¹è±¡è€Œæœ‰å¯èƒ½åŒæ—¶éœ€è¦å¤šä¸ªè¿™æ ·çš„å¯¹è±¡ã€‚</p><h2 id="æ¡æ¬¾-22å°†æˆå‘˜å˜é‡å£°æ˜ä¸º-private">æ¡æ¬¾ 22ï¼šå°†æˆå‘˜å˜é‡å£°æ˜ä¸º private</h2><p>å¯¹äº private å˜é‡ï¼Œå¦‚æœä½ é€šè¿‡å‡½æ•°è®¿é—®æˆå‘˜å˜é‡ï¼Œæ—¥åå¯æ”¹ä»¥æŸä¸ªè®¡ç®—æ›¿æ¢è¿™ä¸ªæˆå‘˜å˜é‡ï¼Œè€Œ class å®¢æˆ·ä¸€ç‚¹ä¹Ÿä¸ä¼šçŸ¥é“ class çš„å†…éƒ¨å®ç°å·²ç»èµ·äº†å˜åŒ–ï¼Œå®Œå…¨å…·å¤‡å°è£…æ€§ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª public æˆå‘˜å˜é‡ï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆå–æ¶ˆäº†å®ƒï¼Œå¤šå°‘ä»£ç å¯èƒ½ä¼šè¢«ç ´åå‘¢ï¼Ÿå””ï¼Œæ‰€æœ‰ä½¿ç”¨å®ƒçš„å®¢æˆ·ç éƒ½ä¼šè¢«ç ´åï¼Œè€Œé‚£æ˜¯ä¸€ä¸ªä¸å¯çŸ¥çš„å¤§é‡ï¼Œå› æ­¤ public æˆå‘˜å˜é‡å®Œå…¨æ²¡æœ‰å°è£…æ€§ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª protected æˆå‘˜å˜é‡ï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆå–æ¶ˆäº†å®ƒï¼Œæœ‰å¤šå°‘ä»£ç è¢«ç ´åï¼Ÿå””ï¼Œæ‰€æœ‰ä½¿ç”¨å®ƒçš„ derived classes éƒ½ä¼šè¢«ç ´åï¼Œé‚£å¾€å¾€ä¹Ÿæ˜¯ä¸ªä¸å¯çŸ¥çš„å¤§é‡ã€‚å› æ­¤ï¼Œ protected æˆå‘˜å˜é‡å®Œå…¨æ²¡æœ‰å°è£…æ€§ã€‚</p><h2 id="æ¡æ¬¾-23å®ä»¥-non-membernon-friend-æ›¿æ¢-member-å‡½æ•°">æ¡æ¬¾ 23ï¼šå®ä»¥ non-memberã€non-friend æ›¿æ¢ member å‡½æ•°</h2><p>è®©æˆ‘ä»¬ä»å°è£…å¼€å§‹è®¨è®ºã€‚å¦‚æœæŸäº›ä¸œè¥¿è¢«å°è£…ï¼Œå®ƒå°±ä¸å†å¯è§ã€‚æ„ˆå¤šä¸œè¥¿è¢«å°è£…ï¼Œæ„ˆå°‘äººå¯ä»¥çœ‹åˆ°å®ƒï¼Œæˆ‘ä»¬å°±æœ‰æ„ˆå¤§çš„å¼¹æ€§å»å˜åŒ–å®ƒã€‚å› æ­¤ï¼Œæ„ˆå¤šä¸œè¥¿è¢«å°è£…ï¼Œæˆ‘ä»¬æ”¹å˜é‚£äº›ä¸œè¥¿çš„èƒ½åŠ›ä¹Ÿå°±æ„ˆå¤§ã€‚</p><p>ç°åœ¨è€ƒè™‘å¯¹è±¡å†…çš„æ•°æ®ã€‚æ„ˆå°‘ä»£ç å¯ä»¥çœ‹åˆ°æ•°æ®ï¼Œæ„ˆå¤šçš„æ•°æ®å¯è¢«å°è£…ï¼Œè€Œæˆ‘ä»¬ä¹Ÿå°±æ„ˆèƒ½è‡ªç”±åœ°æ”¹å˜å¯¹è±¡æ•°æ®ï¼Œæ„ˆå¤šå‡½æ•°å¯è®¿é—®å®ƒï¼Œæ•°æ®çš„å°è£…æ€§å°±æ„ˆä½ã€‚</p><p>æ¡æ¬¾ 22 æ›¾è¯´è¿‡ï¼Œæˆå‘˜å˜é‡åº”è¯¥æ˜¯ privateï¼Œèƒ½å¤Ÿè®¿é—® private æˆå‘˜å˜é‡çš„å‡½æ•°åªæœ‰ class çš„ member å‡½æ•°åŠ ä¸Š friend å‡½æ•°è€Œå·²ã€‚å¦‚æœè¦ä½ åœ¨ä¸€ä¸ª member å‡½æ•°å’Œä¸€ä¸ª non-memberï¼Œnon-friend å‡½æ•°ä¹‹é—´åšæŠ‰æ‹©ï¼Œè€Œä¸”ä¸¤è€…æä¾›ç›¸åŒæœºèƒ½ï¼Œé‚£ä¹ˆï¼Œå¯¼è‡´è¾ƒå¤§å°è£…æ€§çš„æ˜¯ non-member non-friend å‡½æ•°ï¼Œå› ä¸ºå®ƒå¹¶ä¸å¢åŠ â€œèƒ½å¤Ÿè®¿é—® class å†…ä¹‹ privateï¼Œæˆåˆ†â€çš„å‡½æ•°æ•°é‡ã€‚</p><p>å°†æ‰€æœ‰ä¾¿åˆ©å‡½æ•°æ”¾åœ¨å¤šä¸ªå¤´æ–‡ä»¶å†…ä½†éš¶å±åŒä¸€ä¸ªå‘½åç©ºé—´ï¼Œæ„å‘³å®¢æˆ·å¯ä»¥è½»æ¾æ‰©å±•è¿™ä¸€ç»„ä¾¿åˆ©å‡½æ•°ã€‚ä»–ä»¬éœ€è¦åšçš„å°±æ˜¯æ·»åŠ æ›´å¤š non-member non-friend å‡½æ•°åˆ°æ­¤å‘½åç©ºé—´å†…ã€‚</p><h2 id="æ¡æ¬¾-24è‹¥æ‰€æœ‰å‚æ•°çš†éœ€ç±»å‹è½¬æ¢è¯·ä¸ºæ­¤é‡‡ç”¨-non-member-å‡½æ•°">æ¡æ¬¾ 24ï¼šè‹¥æ‰€æœ‰å‚æ•°çš†éœ€ç±»å‹è½¬æ¢ï¼Œè¯·ä¸ºæ­¤é‡‡ç”¨ non-member å‡½æ•°</h2><p>å‡è®¾ä½ è¿™æ ·å¼€å§‹ä½ çš„ Rational classï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rational</span>(<span class="type">int</span> numerator =<span class="number">0</span>,  <span class="comment">//æ„é€ å‡½æ•°åˆ»æ„ä¸ä¸º explicit</span></span><br><span class="line">            <span class="type">int</span> denominator=<span class="number">1</span>ï¼‰ï¼›<span class="comment">//å…è®¸ int-to-Rational éšå¼è½¬æ¢ã€‚</span></span><br><span class="line">    <span class="type">int</span> <span class="built_in">numerator</span>() <span class="type">const</span>;      <span class="comment">//åˆ†å­ï¼ˆ numeratorï¼‰å’Œåˆ†æ¯ï¼ˆ denominatorï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="built_in">denominator</span>() <span class="type">const</span>;    <span class="comment">//çš„è®¿é—®å‡½æ•°ï¼ˆ accessorsï¼‰</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½ æƒ³æ”¯æŒç®—æœ¯è¿ç®—è¯¸å¦‚åŠ æ³•ã€ä¹˜æ³•ç­‰ç­‰ï¼Œä½†ä½ ä¸ç¡®å®šæ˜¯å¦è¯¥ç”± member å‡½æ•°ã€non-member å‡½æ•°ï¼Œæˆ–å¯èƒ½çš„è¯ç”± non-member friend å‡½æ•°æ¥å®ç°å®ƒä»¬ï¼Œå…ˆç ”ç©¶ä¸€ä¸‹å°† operator *å†™æˆ Rational æˆå‘˜å‡½æ•°çš„å†™æ³•ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs) <span class="type">const</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªè®¾è®¡ä½¿ä½ èƒ½å¤Ÿå°†ä¸¤ä¸ªæœ‰ç†æ•°ä»¥æœ€è½»æ¾è‡ªåœ¨çš„æ–¹å¼ç›¸ä¹˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Rational <span class="title">oneEighth</span><span class="params">(<span class="number">1</span>, <span class="number">8</span>)</span></span>;</span><br><span class="line"><span class="function">Rational <span class="title">oneHalf</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">Rational result= oneHalf * oneEighth;   <span class="comment">//å¾ˆå¥½</span></span><br><span class="line">result = result * oneEighth;            <span class="comment">//å¾ˆå¥½</span></span><br></pre></td></tr></tbody></table></figure><p>ä½†ä½ è¿˜ä¸æ»¡è¶³ã€‚ä½ å¸Œæœ›æ”¯æŒæ··åˆå¼è¿ç®—ï¼Œä¹Ÿå°±æ˜¯æ‹¿ Rationals å’Œâ€¦â€¦å—¯ä¾‹å¦‚ int ç›¸ä¹˜ã€‚æ¯•ç«Ÿå¾ˆå°‘æœ‰ä»€ä¹ˆä¸œè¥¿ä¼šæ¯”ä¸¤ä¸ªæ•°å€¼ç›¸ä¹˜æ›´è‡ªç„¶çš„äº†ä¸€å³ä½¿æ˜¯ä¸¤ä¸ªä¸åŒç±»å‹çš„æ•°å€¼ã€‚ç„¶è€Œå½“ä½ å°è¯•æ··åˆå¼ç®—æœ¯ï¼Œä½ å‘ç°åªæœ‰ä¸€åŠè¡Œå¾—é€šï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = oneHalf * <span class="number">2</span>;   <span class="comment">//å¾ˆå¥½</span></span><br><span class="line">result =<span class="number">2</span> * oneHalf     <span class="comment">//é”™è¯¯ï¼</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸æ˜¯å¥½å…†å¤´ã€‚ä¹˜æ³•åº”è¯¥æ»¡è¶³äº¤æ¢å¾‹ï¼Œä¸æ˜¯å—ï¼Ÿå½“ä½ ä»¥å¯¹åº”çš„å‡½æ•°å½¢å¼é‡å†™ä¸Šè¿°ä¸¤ä¸ªå¼å­ï¼Œé—®é¢˜æ‰€åœ¨ä¾¿ä¸€ç›®äº†ç„¶äº†ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result= oneHalf.<span class="keyword">operator</span>*(<span class="number">2</span>);   <span class="comment">//å¾ˆå¥½</span></span><br><span class="line">result =<span class="number">2.</span><span class="keyword">operator</span>*(oneHalf);   <span class="comment">//é”™è¯¯ï¼</span></span><br></pre></td></tr></tbody></table></figure><p>æ˜¯çš„ï¼Œ oneHalf æ˜¯ä¸€ä¸ªå†…æ¶µ operator* å‡½æ•°çš„ class çš„å¯¹è±¡ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨è°ƒç”¨è¯¥å‡½æ•°ã€‚ç„¶è€Œæ•´æ•° 2 å¹¶æ²¡æœ‰ç›¸åº”çš„ classï¼Œä¹Ÿå°±æ²¡æœ‰ operator* æˆå‘˜å‡½æ•°ã€‚</p><p>ç»“è®ºæ˜¯ï¼Œåªæœ‰å½“å‚æ•°è¢«åˆ—äºå‚æ•°åˆ—ï¼ˆ parameter listï¼‰å†…ï¼Œè¿™ä¸ªå‚æ•°æ‰æ˜¯éšå¼ç±»å‹è½¬æ¢çš„åˆæ ¼å‚ä¸è€…ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šè¿°ç¬¬ä¸€æ¬¡è°ƒç”¨å¯é€šè¿‡ç¼–è¯‘ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨åˆ™å¦ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ä¼´éšä¸€ä¸ªæ”¾åœ¨å‚æ•°åˆ—å†…çš„å‚æ•°ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨åˆ™å¦ã€‚ ç„¶è€Œä½ ä¸€å®šä¹Ÿä¼šæƒ³è¦æ”¯æŒæ··åˆå¼ç®—æœ¯è¿ç®—ã€‚å¯è¡Œä¹‹é“ç»ˆäºæ‹¨äº‘è§æ—¥ï¼šè®© operator æˆä¸ºä¸€ä¸ª non-member å‡½æ•°ï¼Œä¿¾å…è®¸ç¼–è¯‘å™¨åœ¨æ¯ä¸€ä¸ªå®å‚èº«ä¸Šæ‰§è¡Œéšå¼ç±»å‹è½¬æ¢ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rational</span></span><br><span class="line">{</span><br><span class="line">    ... <span class="comment">//ä¸åŒ…æ‹¬ operator</span></span><br><span class="line">}</span><br><span class="line"><span class="type">const</span> Rational <span class="keyword">operator</span>*(<span class="type">const</span> Rational&amp; lhs,       <span class="comment">//ç°åœ¨æˆäº†ä¸€ä¸ª</span></span><br><span class="line">                            <span class="type">const</span> Rational&amp; rhs);   <span class="comment">//non- member å‡½æ•°</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Rational</span> (lhs.<span class="built_in">numerator</span>() * rhs.<span class="built_in">numerator</span>(),</span><br><span class="line">                     lhs.<span class="built_in">denominator</span>() * rhs.<span class="built_in">denominator</span>());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">Rational <span class="title">onefourth</span><span class="params">(<span class="number">1</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">Rational result;</span><br><span class="line">result = onefourth * <span class="number">2</span>; <span class="comment">//æ²¡é—®é¢˜</span></span><br><span class="line">result =<span class="number">2</span> * onefourth;  <span class="comment">//ä¸‡å²ï¼Œé€šè¿‡ç¼–è¯‘äº†ï¼</span></span><br></pre></td></tr></tbody></table></figure><h1 id="å®ç°">å®ç°</h1><h2 id="æ¡æ¬¾-26å°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼çš„å‡ºç°æ—¶é—´">æ¡æ¬¾ 26ï¼šå°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼çš„å‡ºç°æ—¶é—´</h2><p>å°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼çš„å‡ºç°ï¼Œæ—¢åŒ…æ‹¬å»¶åæ„é€ å®ƒï¼Œä¿è¯åªæœ‰çœŸæ­£ä½¿ç”¨æ‰æ„é€ ï¼›ä¹ŸåŒ…æ‹¬åªæœ‰åˆ°èµ‹å€¼æ—¶æ‰æ„é€ å®ƒï¼Œé¿å…é»˜è®¤æ„é€ å‡½æ•°æ— è°“è°ƒç”¨ã€‚ å¯¹äºå¾ªç¯æ“ä½œï¼Œåœ¨å¾ªç¯å‰è¿˜æ˜¯ä¸­è¿›è¡Œæ„é€ ï¼Œå–å†³äºèµ‹å€¼æ“ä½œä¸æ„é€ +ææ„æ“ä½œçš„æˆæœ¬å¯¹æ¯”ã€‚</p><ul><li>å¾ªç¯å‰ï¼š1 ä¸ªæ„é€ å‡½æ•°+1 ä¸ªææ„å‡½æ•°+n ä¸ªèµ‹å€¼æ“ä½œã€‚</li><li>å¾ªç¯åï¼šn ä¸ªæ„é€ å‡½æ•°+n ä¸ªææ„å‡½æ•°ã€‚</li></ul><h2 id="æ¡æ¬¾-30é€å½»äº†è§£-inline-çš„é‡Œé‡Œå¤–å¤–">æ¡æ¬¾ 30ï¼šé€å½»äº†è§£ inline çš„é‡Œé‡Œå¤–å¤–</h2><p>åœ¨ä¸€å°å†…å­˜æœ‰é™çš„æœºå™¨ä¸Šï¼Œè¿‡åº¦çƒ­è¡· inline ä¼šé€ æˆç¨‹åºä½“ç§¯å¤ªå¤§ã€‚å³ä½¿æ‹¥æœ‰è™šæ‹Ÿå†…å­˜ï¼Œ inline é€ æˆçš„ä»£ç è†¨èƒ€äº¦ä¼šå¯¼è‡´é¢å¤–çš„æ¢é¡µè¡Œä¸ºï¼ˆ pagingï¼‰ï¼Œé™ä½æŒ‡ä»¤é«˜é€Ÿç¼“å­˜è£…ç½®çš„å‡»ä¸­ç‡ï¼ˆ instruction cache hit rateï¼‰ï¼Œä»¥åŠä¼´éšè¿™äº›è€Œæ¥çš„æ•ˆç‡æŸå¤±ã€‚</p><p>æ¢ä¸ªè§’åº¦è¯´ï¼Œå¦‚æœ inline å‡½æ•°çš„æœ¬ä½“å¾ˆå°ï¼Œç¼–è¯‘å™¨é’ˆå¯¹â€œå‡½æ•°æœ¬ä½“â€æ‰€äº§å‡ºçš„ç å¯èƒ½æ¯”é’ˆå¯¹â€œå‡½æ•°è°ƒç”¨â€æ‰€äº§å‡ºçš„ç æ›´å°ã€‚æœçœŸå¦‚æ­¤ï¼Œå°†å‡½æ•° inline ç¡®å®å¯èƒ½å¯¼è‡´è¾ƒå°çš„ç›®æ ‡ç ï¼ˆ object codeï¼‰å’Œè¾ƒé«˜çš„æŒ‡ä»¤é«˜é€Ÿç¼“å­˜è£…ç½®å‡»ä¸­ç‡ï¼</p><p>ç¨‹åºåº“è®¾è®¡è€…å¿…é¡»è¯„ä¼°â€œå°†å‡½æ•°å£°æ˜ä¸º inlineâ€çš„å†²å‡»ï¼š inline å‡½æ•°æ— æ³•éšç€ç¨‹åºåº“çš„å‡çº§è€Œå‡çº§ã€‚æ¢å¥è¯è¯´å¦‚æœ f æ˜¯ç¨‹åºåº“å†…çš„ä¸€ä¸ª inline å‡½æ•°ï¼Œå®¢æˆ·å°†â€œf å‡½æ•°æœ¬ä½“â€ç¼–è¿›å…¶ç¨‹åºä¸­ï¼Œä¸€æ—¦ç¨‹åºåº“è®¾è®¡è€…å†³å®šæ”¹å˜ fï¼Œæ‰€æœ‰ç”¨åˆ° f çš„å®¢æˆ·ç«¯ç¨‹åºéƒ½å¿…é¡»é‡æ–°ç¼–è¯‘ã€‚è¿™å¾€å¾€æ˜¯å¤§å®¶ä¸æ„¿æ„è§åˆ°çš„ã€‚</p><p>è®°ä½ï¼Œ inline åªæ˜¯å¯¹ç¼–è¯‘å™¨çš„ä¸€ä¸ªç”³è¯·ï¼Œä¸æ˜¯å¼ºåˆ¶å‘½ä»¤ã€‚è¿™é¡¹ç”³è¯·å¯ä»¥éšå–»æå‡ºï¼Œä¹Ÿå¯ä»¥æ˜ç¡®æå‡ºã€‚éšå–»æ–¹å¼æ˜¯å°†å‡½æ•°å®šä¹‰äº class å®šä¹‰å¼å†…ã€‚</p><h2 id="æ¡æ¬¾-31å°†æ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»é™è‡³æœ€ä½">æ¡æ¬¾ 31ï¼šå°†æ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»é™è‡³æœ€ä½</h2><p>é’ˆå¯¹ Person æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼šæŠŠ Person åˆ†å‰²ä¸ºä¸¤ä¸ª classesï¼Œä¸€ä¸ªåªæä¾›æ¥å£ï¼Œå¦ä¸€ä¸ªè´Ÿè´£å®ç°è¯¥æ¥å£ã€‚å¦‚æœè´Ÿè´£å®ç°çš„é‚£ä¸ªæ‰€è°“ implementation class å–åä¸º PersonImplï¼Œ Person å°†å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span>   <span class="comment">//æ ‡å‡†ç¨‹åºåº“ç»„ä»¶ä¸è¯¥è¢«å‰ç½®å£°æ˜ã€‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span>    <span class="comment">//æ­¤ä¹ƒä¸ºäº† tr1ï¼š shared ptr è€Œå«å…¥ï¼›è¯¦å</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonImpl</span>;   <span class="comment">// Person å®ç°ç±»çš„å‰ç½®å£°æ˜ã€‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Date</span>;         <span class="comment">// Person æ¥å£ç”¨åˆ°çš„ classes çš„å‰ç½®å£°æ˜ã€‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>(<span class="type">const</span> std: string&amp; name, <span class="type">const</span> Date&amp; birthday,</span><br><span class="line">            <span class="type">const</span> Address&amp; addr);</span><br><span class="line">    <span class="function">std::string <span class="title">name</span><span class="params">()</span><span class="type">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">birthdate</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">address</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    std::tr1::shared_ptr&lt;PersonImpl&gt; pimplï¼›<span class="comment">//æŒ‡é’ˆï¼ŒæŒ‡å‘å®ç°ç‰©</span></span><br><span class="line">                                            <span class="comment">//std::tr1::shared_ptr è§æ¡æ¬¾ 13.</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·å°±ä¸å¿… include Dateã€Address ç­‰å¤´æ–‡ä»¶è€Œåªæ˜¯å£°æ˜è¯¥ classï¼ˆå®šä¹‰å¼æ”¹å£°æ˜å¼ï¼‰ã€‚</p><h3 id="pimp-æ–¹å¼">pimp æ–¹å¼</h3><p>åœ¨è¿™é‡Œï¼Œ class Person åªå†…å«ä¸€ä¸ªæŒ‡é’ˆæˆå‘˜ï¼ŒæŒ‡å‘å…¶å®ç°ç±»ï¼ˆ PersonImplï¼‰ã€‚è¿™èˆ¬è®¾è®¡å¸¸è¢«ç§°ä¸º pimpl idiom(pimp æ˜¯" pointer to implementation"çš„ç¼©å†™ï¼‰ã€‚</p><p>è¿™æ ·çš„è®¾è®¡ä¹‹ä¸‹ï¼Œ Person çš„å®¢æˆ·å°±å®Œå…¨ä¸ Datesï¼Œ Addresses ä»¥åŠ Persons çš„å®ç°ç»†ç›®åˆ†ç¦»äº†ã€‚é‚£äº› classes çš„ä»»ä½•å®ç°ä¿®æ”¹éƒ½ä¸éœ€è¦ Person å®¢æˆ·ç«¯é‡æ–°ç¼–è¯‘ã€‚æ­¤å¤–ç”±äºå®¢æˆ·æ— æ³•çœ‹åˆ° Person çš„å®ç°ç»†ç›®ï¼Œä¹Ÿå°±ä¸å¯èƒ½å†™å‡ºä»€ä¹ˆâ€œå–å†³äºé‚£äº›ç»†ç›®â€çš„ä»£ç ã€‚è¿™çœŸæ­£æ˜¯â€œæ¥å£ä¸å®ç°åˆ†ç¦»ã€‚</p><p>è¿™ä¸ªåˆ†ç¦»çš„å…³é”®åœ¨äºä»¥â€œå£°æ˜çš„ä¾å­˜æ€§â€æ›¿æ¢â€œå®šä¹‰çš„ä¾å­˜æ€§â€ï¼Œé‚£æ­£æ˜¯ç¼–è¯‘ä¾å­˜æ€§æœ€å°åŒ–çš„æœ¬è´¨ï¼šç°å®ä¸­è®©å¤´æ–‡ä»¶å°½å¯èƒ½è‡ªæˆ‘æ»¡è¶³ï¼Œä¸‡ä¸€åšä¸åˆ°ï¼Œåˆ™è®©å®ƒä¸å…¶ä»–æ–‡ä»¶å†…çš„å£°æ˜å¼ï¼ˆè€Œéå®šä¹‰å¼ï¼‰ç›¸ä¾ã€‚å…¶ä»–æ¯ä¸€ä»¶äº‹éƒ½æºè‡ªäºè¿™ä¸ªç®€å•çš„è®¾è®¡ç­–ç•¥ã€‚</p><ul><li>å¦‚æœä½¿ç”¨ object references æˆ– object pointers å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œå°±ä¸è¦ä½¿ç”¨ objectsã€‚ä½ å¯ä»¥åªé ä¸€ä¸ªç±»å‹å£°æ˜å¼å°±å®šä¹‰å‡ºæŒ‡å‘è¯¥ç±»å‹çš„ references å’Œ pointersï¼›ä½†å¦‚æœå®šä¹‰æŸç±»å‹çš„ objectsï¼Œå°±éœ€è¦ç”¨åˆ°è¯¥ç±»å‹çš„å®šä¹‰å¼ã€‚</li><li>å¦‚æœèƒ½å¤Ÿï¼Œå°½é‡ä»¥ class å£°æ˜å¼æ›¿æ¢ class å®šä¹‰å¼ã€‚</li></ul><h3 id="abstract-baseclass-æ–¹å¼">abstract baseclass æ–¹å¼</h3><p>å¦ä¸€ä¸ªåˆ¶ä½œ Handle class çš„åŠæ³•æ˜¯ï¼Œä»¤ Person æˆä¸ºä¸€ç§ç‰¹æ®Šçš„ abstract baseclassï¼ˆæŠ½è±¡åŸºç±»ï¼‰ï¼Œç§°ä¸º Interface classã€‚è¿™ç§ class çš„ç›®çš„æ˜¯è¯¦ç»†ä¸€æè¿° derived classes çš„æ¥å£ï¼Œå› æ­¤å®ƒé€šå¸¸ä¸å¸¦æˆå‘˜å˜é‡ï¼Œä¹Ÿæ²¡æœ‰æ„é€ å‡½æ•°ï¼Œåªæœ‰ä¸ª virtual ææ„å‡½æ•°ä»¥åŠä¸€ç»„ pure virtual å‡½æ•°ï¼Œç”¨æ¥å™è¿°æ•´ä¸ªæ¥å£ã€‚</p><h1 id="ç»§æ‰¿ä¸é¢å‘å¯¹è±¡è®¾è®¡">ç»§æ‰¿ä¸é¢å‘å¯¹è±¡è®¾è®¡</h1><h2 id="æ¡æ¬¾-32ç¡®å®šä½ çš„-public-ç»§æ‰¿æ˜¯-is-a-å…³ç³»">æ¡æ¬¾ 32ï¼šç¡®å®šä½ çš„ public ç»§æ‰¿æ˜¯ is-a å…³ç³»</h2><p>â€œ public ç»§æ‰¿â€æ„å‘³ is-aã€‚é€‚ç”¨äº base classes èº«ä¸Šçš„æ¯ä¸€ä»¶äº‹æƒ…ä¸€å®šä¹Ÿé€‚ç”¨äº derived classes èº«ä¸Šï¼Œå› ä¸ºæ¯ä¸€ä¸ª derived class å¯¹è±¡ä¹Ÿéƒ½æ˜¯ä¸€ä¸ª base class å¯¹è±¡ã€‚</p><h3 id="æ¡æ¬¾-33é¿å…é®æ©ç»§æ‰¿è€Œæ¥çš„åç§°">æ¡æ¬¾ 33ï¼šé¿å…é®æ©ç»§æ‰¿è€Œæ¥çš„åç§°</h3><ul><li>derived classes å†…çš„åç§°ä¼šé®æ© base classes å†…çš„åç§°ã€‚åœ¨ public ç»§æ‰¿ä¸‹ä»æ¥æ²¡æœ‰äººå¸Œæœ›å¦‚æ­¤ã€‚</li><li>ä¸ºäº†è®©è¢«é®æ©çš„åç§°å†è§å¤©æ—¥ï¼Œå¯ä½¿ç”¨ using å£°æ˜å¼æˆ–è½¬äº¤å‡½æ•°ï¼ˆ forwarding functions)ã€‚</li></ul><h2 id="æ¡æ¬¾-34åŒºåˆ†æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿">æ¡æ¬¾ 34ï¼šåŒºåˆ†æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿</h2><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span></span><br><span class="line">{</span><br><span class="line">  <span class="function"><span class="keyword">public</span></span></span><br><span class="line"><span class="function">    <span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">error</span><span class="params">(<span class="type">const</span> std: string&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">objectid</span><span class="params">( )</span> <span class="type">const</span></span>;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span>: <span class="keyword">public</span> Shape {...};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ellipse</span>: <span class="keyword">public</span> Shape {...};</span><br></pre></td></tr></tbody></table></figure><p>shape class å£°æ˜äº†ä¸‰ä¸ªå‡½æ•°ã€‚draw æ˜¯ä¸ª pure virtual å‡½æ•°ï¼› error æ˜¯ä¸ªç®€æœ´çš„ï¼ˆéçº¯ï¼‰ impure virtual å‡½æ•°ï¼› objectid æ˜¯ä¸ª non-virtual å‡½æ•°ã€‚è¿™äº›ä¸åŒçš„å£°æ˜å¸¦æ¥ä»€ä¹ˆæ ·çš„æš—ç¤ºå‘¢ï¼Ÿ</p><ul><li>å£°æ˜ä¸€ä¸ª pure virtual å‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†è®© derived classes åªç»§æ‰¿å‡½æ•°æ¥å£ã€‚</li><li>å£°æ˜ç®€æœ´çš„ï¼ˆéçº¯ï¼‰ impure virtual å‡½æ•°çš„ç›®çš„ï¼Œæ˜¯è®© derived classes ç»§æ‰¿è¯¥å‡½æ•°çš„æ¥å£å’Œç¼ºçœå®ç°ã€‚</li><li>å£°æ˜ non-virtual å‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†ä»¤ derived classes ç»§æ‰¿å‡½æ•°çš„æ¥å£åŠä¸€ä»½å¼ºåˆ¶æ€§å®ç°ã€‚</li></ul><h2 id="æ¡æ¬¾-35è€ƒè™‘è™šå‡½æ•°ä»¥å¤–çš„å…¶ä»–é€‰æ‹©">æ¡æ¬¾ 35ï¼šè€ƒè™‘è™šå‡½æ•°ä»¥å¤–çš„å…¶ä»–é€‰æ‹©</h2><p>å‡è®¾ä½ æ­£åœ¨å†™ä¸€ä¸ªè§†é¢‘æ¸¸æˆè½¯ä»¶ï¼Œä½ æ‰“ç®—ä¸ºæ¸¸æˆå†…çš„äººç‰©è®¾è®¡ä¸€ä¸ªç»§æ‰¿ä½“ç³»ã€‚ä½ çš„æ¸¸æˆå±äºæš´åŠ›ç æ€ç±»å‹ï¼Œå‰§ä¸­äººç‰©è¢«ä¼¤å®³æˆ–å› å…¶ä»–å› ç´ è€Œé™ä½å¥åº·çŠ¶æ€çš„æƒ…å†µå¹¶ä¸ç½•è§ã€‚ä½ å› æ­¤å†³å®šæä¾›ä¸€ä¸ªæˆå‘˜å‡½æ•° healthvalueï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºäººç‰©çš„å¥åº·ç¨‹åº¦ã€‚ç”±äºä¸åŒçš„äººç‰©å¯èƒ½ä»¥ä¸åŒçš„æ–¹å¼è®¡ç®—ä»–ä»¬çš„å¥åº·æŒ‡æ•°ï¼Œå°† healthvalue å£°æ˜ä¸º virtual ä¼¼ä¹æ˜¯å†æ˜ç™½ä¸è¿‡çš„åšæ³•ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">heal_thvalue</span><span class="params">()</span> <span class="type">const</span>ï¼› <span class="comment">//è¿”å›äººç‰©çš„å¥åº·æŒ‡æ•°</span></span></span><br><span class="line"><span class="function">    ...                               <span class="comment">// derived classes å¯é‡æ–°å®šä¹‰å®ƒã€‚</span></span></span><br><span class="line"><span class="function">}</span></span><br></pre></td></tr></tbody></table></figure><p>healthvalue å¹¶æœªè¢«å£°æ˜ä¸º pure virtualï¼Œè¿™æš—ç¤ºæˆ‘ä»¬å°†ä¼šæœ‰ä¸ªè®¡ç®—å¥åº·æŒ‡æ•°çš„ç¼ºçœç®—æ³•ã€‚è¿™çš„ç¡®æ˜¯å†æ˜ç™½ä¸è¿‡çš„è®¾è®¡ï¼Œä½†æ˜¯ä»æŸä¸ªè§’åº¦è¯´å´åè€Œæˆäº†å®ƒçš„å¼±ç‚¹ã€‚ç”±äºè¿™ä¸ªè®¾è®¡å¦‚æ­¤æ˜æ˜¾ï¼Œä½ å¯èƒ½å› æ­¤æ²¡æœ‰è®¤çœŸè€ƒè™‘å…¶ä»–æ›¿ä»£æ–¹æ¡ˆã€‚ä¸ºäº†å¸®åŠ©ä½ è·³è„±é¢å‘å¯¹è±¡è®¾è®¡è·¯ä¸Šçš„å¸¸è½¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘å…¶ä»–ä¸€äº›è§£æ³•ã€‚</p><h3 id="è—‰ç”±-non-virtual-interface-æ‰‹æ³•å®ç°-template-method-æ¨¡å¼">è—‰ç”± Non-Virtual Interface æ‰‹æ³•å®ç° Template Method æ¨¡å¼</h3><p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªæœ‰è¶£çš„æ€æƒ³æµæ´¾å¼€å§‹ï¼Œè¿™ä¸ªæµæ´¾ä¸»å¼  virtual å‡½æ•°åº”è¯¥å‡ ä¹æ€»æ˜¯ privateã€‚è¿™ä¸ªæµæ´¾çš„æ‹¥æŠ¤è€…å»ºè®®ï¼Œè¾ƒå¥½çš„è®¾è®¡æ˜¯ä¿ç•™ healthvalue ä¸º public æˆå‘˜å‡½æ•°ï¼Œä½†è®©å®ƒæˆä¸º non-virtualï¼Œå¹¶è°ƒç”¨ä¸€ä¸ª private virtual å‡½æ•°ï¼ˆä¾‹å¦‚ dohealthvalueï¼‰è¿›è¡Œå®é™…å·¥ä½œï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">healthvalue</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// derived classes ä¸é‡æ–°å®šä¹‰å®ƒï¼Œ</span></span><br><span class="line">    {                               <span class="comment">//è§æ¡æ¬¾ 36</span></span><br><span class="line">        ...                         <span class="comment">//åšä¸€äº›äº‹å‰å·¥ä½œï¼Œè¯¦ä¸‹</span></span><br><span class="line">        <span class="type">int</span> retval=<span class="built_in">dohealthvalue</span>(); <span class="comment">//åšçœŸæ­£çš„å·¥ä½œã€‚</span></span><br><span class="line">        ...                         <span class="comment">//åšä¸€äº›äº‹åå·¥ä½œï¼Œè¯¦ä¸‹ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> retval</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">int</span> <span class="built_in">dohealthvalue</span>() <span class="type">const</span>;  <span class="comment">// derived classes å¯é‡æ–°å®šä¹‰å®ƒã€‚</span></span><br><span class="line">    {</span><br><span class="line">        ...                             <span class="comment">//ç¼ºçœç®—æ³•ï¼Œè®¡ç®—å¥åº·æŒ‡æ•°ã€‚</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>ä»¤å®¢æˆ·é€šè¿‡ public non-virtual æˆå‘˜å‡½æ•°é—´æ¥è°ƒç”¨ private virtual å‡½æ•°ï¼Œç§°ä¸º mom-virtual interfaceï¼ˆNVIï¼‰æ‰‹æ³•ã€‚å®ƒæ˜¯æ‰€è°“ Template Method è®¾è®¡æ¨¡å¼ï¼ˆä¸ C++ templates å¹¶æ— å…³è”ï¼‰çš„ä¸€ä¸ªç‹¬ç‰¹è¡¨ç°å½¢å¼ã€‚</p><p>NVI æ‰‹æ³•çš„ä¸€ä¸ªä¼˜ç‚¹éšèº«åœ¨ä¸Šè¿°ä»£ç æ³¨é‡Šâ€œåšä¸€äº›äº‹å‰å·¥ä½œâ€å’Œâ€œåšä¸€äº›äº‹åå·¥ä½œâ€ä¹‹ä¸­ã€‚é‚£äº›æ³¨é‡Šç”¨æ¥å‘Šè¯‰ä½ å½“æ—¶çš„ä»£ç ä¿è¯åœ¨â€œ virtual å‡½æ•°è¿›è¡ŒçœŸæ­£å·¥ä½œä¹‹å‰å’Œä¹‹åâ€è¢«è°ƒç”¨ã€‚</p><h3 id="è—‰ç”±-function-pointers-å®ç°-strategy-æ¨¡å¼">è—‰ç”± Function Pointers å®ç° Strategy æ¨¡å¼</h3><p>å¦ä¸€ä¸ªæ›´æˆå‰§æ€§çš„è®¾è®¡ä¸»å¼ â€œäººç‰©å¥åº·æŒ‡æ•°çš„è®¡ç®—ä¸äººç‰©ç±»å‹æ— å…³â€ï¼Œè¿™æ ·çš„è®¡ç®—å®Œå…¨ä¸éœ€è¦â€œäººç‰©â€è¿™ä¸ªæˆåˆ†ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯èƒ½ä¼šè¦æ±‚æ¯ä¸ªäººç‰©çš„æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå¥åº·è®¡ç®—å‡½æ•°ï¼Œè€Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œå®é™…è®¡ç®—ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Gamecharacter</span>;         <span class="comment">//å‰ç½®å£°æ˜ï¼ˆ forward declarationï¼‰</span></span><br><span class="line"><span class="comment">//ä»¥ä¸‹å‡½æ•°æ˜¯è®¡ç®—å¥åº·æŒ‡æ•°çš„ç¼ºçœç®—æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">defaulthealthcalc</span><span class="params">(<span class="type">const</span> Gamecharacter&amp; gc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gamecharacter</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*Healthcalcfunc)</span><span class="params">(<span class="type">const</span> Gamecharacter&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">GameCharacter</span><span class="params">(Healthcalcfunc hcf= defaulthealthcalc)</span> :healtheunc(hcf)</span></span><br><span class="line"><span class="function">    {</span>}</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">healthvalue</span><span class="params">()</span> <span class="type">const</span> </span>{ <span class="keyword">return</span> <span class="built_in">healthfunc</span> (*<span class="keyword">this</span>); };</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    Healthcalcfunc healtheunc;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªåšæ³•æ˜¯å¸¸è§çš„ Strategy è®¾è®¡æ¨¡å¼çš„ç®€å•åº”ç”¨ã€‚æ‹¿å®ƒå’Œâ€œæ¤åŸºäº GameCharacter ç»§æ‰¿ä½“ç³»å†…ä¹‹ virtual å‡½æ•°â€çš„åšæ³•æ¯”è¾ƒï¼Œå®ƒæä¾›äº†æŸäº›æœ‰è¶£å¼¹æ€§ï¼š</p><ul><li>åŒä¸€äººç‰©ç±»å‹ä¹‹ä¸åŒå®ä½“å¯ä»¥æœ‰ä¸åŒçš„å¥åº·è®¡ç®—å‡½æ•°ã€‚</li><li>æŸå·²çŸ¥äººç‰©ä¹‹å¥åº·æŒ‡æ•°è®¡ç®—å‡½æ•°å¯åœ¨è¿è¡ŒæœŸå˜æ›´ã€‚</li></ul><h3 id="è—‰ç”±-tr1-function-å®Œæˆ-strategy-æ¨¡å¼">è—‰ç”± tr1ï¼š function å®Œæˆ Strategy æ¨¡å¼</h3><p>ä¸€æ—¦ä¹ æƒ¯äº† templates ä»¥åŠå®ƒä»¬å¯¹éšå¼æ¥å£çš„ä½¿ç”¨ï¼ŒåŸºäºå‡½æ•°æŒ‡é’ˆçš„åšæ³•çœ‹èµ·æ¥ä¾¿è¿‡åˆ†è‹›åˆ»è€Œæ­»æ¿äº†ã€‚ä¸ºä»€ä¹ˆè¦æ±‚â€œå¥åº·æŒ‡æ•°ä¹‹è®¡ç®—â€å¿…é¡»æ˜¯ä¸ªå‡½æ•°ï¼Œè€Œä¸èƒ½æ˜¯æŸç§â€œåƒå‡½æ•°çš„ä¸œè¥¿â€ï¼ˆä¾‹å¦‚å‡½æ•°å¯¹è±¡ï¼‰å‘¢ï¼Ÿå¦‚æœä¸€å®šå¾—æ˜¯å‡½æ•°ï¼Œä¸ºä»€ä¹ˆä¸èƒ½å¤Ÿæ˜¯ä¸ªæˆå‘˜å‡½æ•°ï¼Ÿä¸ºä»€ä¹ˆä¸€å®šå¾—è¿”å› int è€Œä¸æ˜¯ä»»ä½•å¯è¢«è½¬æ¢ä¸º int çš„ç±»å‹å‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬ä¸å†ä½¿ç”¨å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚å‰ä¾‹çš„ healtheuncï¼‰ï¼Œè€Œæ˜¯æ”¹ç”¨ä¸€ä¸ªç±»å‹ä¸º tr1::function çš„å¯¹è±¡ï¼Œè¿™äº›çº¦æŸå°±å…¨éƒ½æŒ¥å‘ä¸è§äº†ã€‚å°±åƒæ¡æ¬¾ 54 æ‰€è¯´ï¼Œè¿™æ ·çš„å¯¹è±¡å¯æŒæœ‰ï¼ˆä¿å­˜ï¼‰ä»»ä½•å¯è°ƒç”¨ç‰©ï¼ˆ callable entityï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æŒ‡é’ˆã€å‡½æ•°å¯¹è±¡ã€æˆ–æˆå‘˜å‡½æ•°æŒ‡é’ˆï¼‰ï¼Œåªè¦å…¶ç­¾åå¼å…¼å®¹äºéœ€æ±‚ç«¯ã€‚ä»¥ä¸‹å°†åˆšæ‰çš„è®¾è®¡æ”¹ä¸ºä½¿ç”¨ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tr1::function</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameCharacter</span> <span class="comment">//å¦‚å‰</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">defaulthealthcalc</span><span class="params">(<span class="type">const</span> Gamecharacter&amp; gc)</span></span>;  <span class="comment">//å¦‚å‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gamecharacter</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//Hea1 thcalcfunc å¯ä»¥æ˜¯ä»»ä½•â€œå¯è°ƒç”¨ç‰©â€ï¼ˆ callable entityï¼‰ï¼Œå¯è¢«è°ƒç”¨å¹¶æ¥å—</span></span><br><span class="line">    <span class="comment">//ä»»ä½•å…¼å®¹äº Gamecharacter ä¹‹ç‰©ï¼Œè¿”å›ä»»ä½•å…¼å®¹äº int çš„ä¸œè¥¿ã€‚è¯¦ä¸‹ã€‚</span></span><br><span class="line">    <span class="keyword">typedef</span> std::tr1::function&lt;<span class="type">int</span>(<span class="type">const</span> Gamecharacter&amp;)&gt; Healthcalcfunc;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Gamecharacter</span><span class="params">(Healthcalcfunc hcf = defaulthealthcalc)</span></span></span><br><span class="line"><span class="function">        :healtheunc(hcf)</span></span><br><span class="line"><span class="function">    int healthvalue() const</span></span><br><span class="line"><span class="function">     {</span><span class="keyword">return</span> <span class="built_in">healthfunc</span> (*<span class="keyword">this</span>);}</span><br><span class="line">     ..</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    HealthCalcfunc healtheunc;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç°åœ¨æˆ‘ä»¬é è¿‘ä¸€ç‚¹ç§ç§ HealthCalceunc æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ typedef std::tr1::function&lt;int (const Gamecharacter&amp;)&gt; è¿™é‡Œæˆ‘æŠŠ tr1::function å…·ç°ä½“ï¼ˆ instantiationï¼‰çš„ç›®æ ‡ç­¾åå¼ï¼ˆ target signatureï¼‰ï¼Œé‚£ä¸ªç­¾åä»£è¡¨çš„å‡½æ•°æ˜¯â€œæ¥å—ä¸€ä¸ª reference æŒ‡å‘ const Gamecharacterï¼Œå¹¶è¿”å› intâ€ã€‚</p><p>å’Œå‰ä¸€ä¸ªè®¾è®¡ï¼ˆå…¶ GameCharacter æŒæœ‰çš„æ˜¯å‡½æ•°æŒ‡é’ˆï¼‰æ¯”è¾ƒï¼Œè¿™ä¸ªè®¾è®¡å‡ ä¹ç›¸åŒã€‚å”¯ä¸€ä¸åŒçš„æ˜¯å¦‚ä»Š Gamecharacter æŒæœ‰ä¸€ä¸ª tr1::function å¯¹è±¡ï¼Œç›¸å½“äºä¸ªæŒ‡å‘å‡½æ•°çš„æ³›åŒ–æŒ‡é’ˆã€‚è¿™ä¸ªæ”¹å˜å¦‚æ­¤ç»†å°ï¼Œæˆ‘æ€»è¯´å®ƒæ²¡æœ‰ä»€ä¹ˆå¤–æ˜¾å½±å“ï¼Œé™¤éå®¢æˆ·åœ¨â€œæŒ‡å®šå¥åº·è®¡ç®—å‡½æ•°â€è¿™ä»¶äº‹ä¸Šéœ€è¦æ›´æƒŠäººçš„å¼¹æ€§ï¼š</p><p>æœ¬æ¡æ¬¾çš„æ ¹æœ¬å¿ å‘Šæ˜¯ï¼Œå½“ä½ ä¸ºè§£å†³é—®é¢˜è€Œå¯»æ‰¾æŸä¸ªè®¾è®¡æ–¹æ³•æ—¶ï¼Œä¸å¦¨è€ƒè™‘ virtual å‡½æ•°çš„æ›¿ä»£æ–¹æ¡ˆï¼š</p><ul><li>ä½¿ç”¨ non-virtual interfaceï¼ˆNVIï¼‰æ‰‹æ³•ï¼Œé‚£æ˜¯ Template Method è®¾è®¡æ¨¡å¼çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ã€‚å®ƒä»¥ public non-virtual æˆå‘˜å‡½æ•°åŒ…è£¹è¾ƒä½è®¿é—®æ€§ï¼ˆ private æˆ– protectedï¼‰çš„ virtual å‡½æ•°ã€‚</li><li>å°† virtual å‡½æ•°æ›¿æ¢ä¸ºâ€œå‡½æ•°æŒ‡é’ˆæˆå‘˜å˜é‡â€ï¼Œè¿™æ˜¯ Strategy è®¾è®¡æ¨¡å¼çš„ä¸€ç§åˆ†è§£è¡¨ç°å½¢å¼ã€‚</li><li>ä»¥ tr1::function æˆå‘˜å˜é‡æ›¿æ¢ virtual å‡½æ•°ï¼Œå› è€Œå…è®¸ä½¿ç”¨ä»»ä½•å¯è°ƒç”¨ç‰©ï¼ˆ callable entityï¼‰æ­é…ä¸€ä¸ªå…¼å®¹äºéœ€æ±‚çš„ç­¾åå¼ã€‚è¿™ä¹Ÿæ˜¯ Strategy è®¾è®¡æ¨¡å¼çš„æŸç§å½¢å¼ã€‚</li><li>å°†ç»§æ‰¿ä½“ç³»å†…çš„ virtual å‡½æ•°æ›¿æ¢ä¸ºå¦ä¸€ä¸ªç»§æ‰¿ä½“ç³»å†…çš„ virtual å‡½æ•°ã€‚è¿™æ˜¯ Strategy è®¾è®¡æ¨¡å¼çš„ä¼ ç»Ÿå®ç°æ‰‹æ³•ã€‚</li></ul><h2 id="æ¡æ¬¾-36ç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°">æ¡æ¬¾ 36ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°</h2><p>non-virtual å‡½æ•°æ˜¯é™æ€ç»‘å®šã€‚è¿™æ„æ€æ˜¯ï¼Œç”±äº pb è¢«å£°æ˜ä¸ºä¸€ä¸ª pointer-to-Bï¼Œé€šè¿‡ pb è°ƒç”¨çš„ non-virtual å‡½æ•°æ°¸è¿œæ˜¯ B æ‰€å®šä¹‰çš„ç‰ˆæœ¬ï¼Œå³ä½¿ pb æŒ‡å‘ä¸€ä¸ªç±»å‹ä¸ºâ€œB æ´¾ç”Ÿä¹‹ classâ€çš„å¯¹è±¡ã€‚</p><p>ä½†å¦ä¸€æ–¹é¢ï¼Œ virtual å‡½æ•°å´æ˜¯åŠ¨æ€ç»‘å®šã€‚å¦‚æœ mf æ˜¯ä¸ª virtual å‡½æ•°ï¼Œä¸è®ºæ˜¯é€šè¿‡ pBï¼ˆæŒ‡å‘ Dï¼‰æˆ– pDï¼ˆæŒ‡å‘ Dï¼‰è°ƒç”¨ mfï¼Œéƒ½ä¼šå¯¼è‡´è°ƒç”¨ D::mfï¼Œå› ä¸º pB å’Œ pD çœŸæ­£æŒ‡çš„éƒ½æ˜¯ä¸€ä¸ªç±»å‹ä¸º D çš„å¯¹è±¡ã€‚</p><h2 id="æ¡æ¬¾-37ç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼ç¼ºçœå‚æ•°å€¼éƒ½æ˜¯é™æ€ç»‘å®šè€Œ">æ¡æ¬¾ 37ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼ï¼ˆç¼ºçœå‚æ•°å€¼éƒ½æ˜¯é™æ€ç»‘å®šè€Œï¼‰</h2><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæœ¬æ¡æ¬¾æˆç«‹çš„ç†ç”±å°±éå¸¸ç›´æ¥è€Œæ˜ç¡®äº†ï¼š virtual å‡½æ•°ç³»åŠ¨æ€ç»‘å®šï¼ˆ dynamically boundï¼‰ï¼Œè€Œç¼ºçœå‚æ•°å€¼å´æ˜¯é™æ€ç»‘å®šï¼ˆ statically boundï¼‰ã€‚é™æ€ç»‘å®šåˆå«å‰æœŸç»‘å®šï¼Œearbindingï¼šåŠ¨æ€ç»‘å®šåˆååæœŸç»‘å®šï¼Œ late bindingã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ãƒ¼ä¸ªç”¨ä»¥æè¿°å‡ ä½•å½¢çŠ¶çš„ cass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Shapecolor</span> { Red, Green, Blue };<span class="comment">//æ‰€æœ‰å½¢çŠ¶éƒ½å¿…é¡»æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥ç»˜å‡ºè‡ªå·±</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">(Shapecolor color=Red)</span><span class="type">const</span> </span>=<span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span>: <span class="keyword">public</span> Shape</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:   <span class="comment">//æ³¨æ„ï¼Œèµ‹äºˆä¸åŒçš„ç¼ºçœå‚æ•°å€¼ï¼Œè¿™çœŸç³Ÿç³•ï¼Œå¯èƒ½æ˜¯ Red</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">( Shapecolor color=Green )</span> <span class="type">const</span></span>;</span><br><span class="line">    ...</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span>: <span class="keyword">public</span> Shape</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">draw</span><span class="params">( Shapecolor color)</span> <span class="type">const</span></span>; <span class="comment">//è¯‘æ³¨ï¼šè¯·æ³¨æ„ï¼Œä»¥ä¸Šè¿™ä¹ˆå†™åˆ™å½“å®¢æˆ·ä»¥å¯¹è±¡è°ƒç”¨æ­¤å‡½æ•°ï¼Œä¸€å®šè¦æŒ‡å®šå‚æ•°å€¼ã€‚</span></span><br><span class="line">                                                <span class="comment">//å› ä¸ºé™æ€ç»‘å®šä¸‹è¿™ä¸ªå‡½æ•°å¹¶ä¸ä»å…¶ base ç»§æ‰¿ç¼ºçœå‚æ•°å€¼ã€‚</span></span><br><span class="line">                                                <span class="comment">//ä½†è‹¥ä»¥æŒ‡é’ˆï¼ˆæˆ– referenceï¼‰è°ƒç”¨æ­¤å‡½æ•°ï¼Œå¯ä»¥ä¸æŒ‡å®šå‚æ•°å€¼</span></span><br><span class="line">                                                <span class="comment">//å› ä¸ºåŠ¨æ€ç»‘å®šä¸‹è¿™ä¸ªå‡½æ•°ä¼šä»å…¶ base ç»§æ‰¿ç¼ºçœå‚æ•°å€¼ã€‚</span></span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªç»§æ‰¿ä½“ç³»å›¾ç¤ºå¦‚ä¸‹ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/effectionc++4.png"></p><p>ç°åœ¨è€ƒè™‘è¿™äº›æŒ‡é’ˆï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Shape* pr =<span class="keyword">new</span> Rectangle;   <span class="comment">//é™æ€ç±»å‹ä¸º Shape*</span></span><br><span class="line">pr ãƒ¼&gt;<span class="built_in">draw</span>();                <span class="comment">//è°ƒç”¨ Rectangleï¼šdrawï¼ˆ Shapeï¼šRedï¼‰ï¼</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤ä¾‹ä¹‹ä¸­ï¼Œpr çš„åŠ¨æ€ç±»å‹æ˜¯ Rectangle<em>ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯ Rectangle çš„ virtual å‡½æ•°ï¼Œä¸€å¦‚ä½ æ‰€é¢„æœŸã€‚ Rectangle::draw å‡½æ•°çš„ç¼ºçœå‚æ•°å€¼åº”è¯¥æ˜¯ GRENï¼Œä½†ç”±äº pr çš„é™æ€ç±»å‹æ˜¯ Shape</em>ï¼Œæ‰€ä»¥æ­¤ä¸€è°ƒç”¨çš„ç¼ºçœå‚æ•°å€¼æ¥è‡ª shape class è€Œé Rectangle classï¼ç»“å±€æ˜¯è¿™ä¸ªå‡½æ•°è°ƒç”¨æœ‰ç€å¥‡æ€ªå¹¶ä¸”å‡ ä¹ç»å¯¹æ²¡äººé¢„æ–™å¾—åˆ°çš„ç»„åˆï¼Œç”± Shape class å’Œ Rectangle class çš„ draw å£°æ˜å¼å„å‡ºä¸€åŠåŠ›ã€‚</p><p><strong>è¯·è®°ä½</strong></p><p>ç»å¯¹ä¸è¦é‡æ–°å®šä¹‰ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼ï¼Œå› ä¸ºç¼ºçœå‚æ•°å€¼éƒ½æ˜¯é™æ€ç»‘å®šè€Œ virtual å‡½æ•°ä¸€ä½ å”¯ä¸€åº”è¯¥è¦†å†™çš„ä¸œè¥¿ä¸€å´æ˜¯åŠ¨æ€ç»‘å®š</p><h2 id="æ¡æ¬¾-38é€šè¿‡å¤åˆè¡¨ç¤º-has-a-æˆ–è€…æ ¹æ®æŸç‰©å®ç°å‡ºçš„å…³ç³»">æ¡æ¬¾ 38ï¼šé€šè¿‡å¤åˆè¡¨ç¤º has-a æˆ–è€…â€œæ ¹æ®æŸç‰©å®ç°å‡ºâ€çš„å…³ç³»</h2><p>å¤åˆï¼ˆ compositionï¼‰çš„æ„ä¹‰å’Œ public ç»§æ‰¿å®Œå…¨ä¸åŒã€‚ åœ¨åº”ç”¨åŸŸï¼ˆ application domainï¼‰ï¼Œå¤åˆæ„å‘³ has aï¼ˆæœ‰ä¸€ä¸ªï¼‰ã€‚åœ¨å®ç°åŸŸï¼ˆ implementation domainï¼‰ï¼Œå¤åˆæ„å‘³ is-implemented-in-terms-ofï¼ˆæ ¹æ®æŸç‰©å®ç°å‡ºï¼‰ã€‚</p><h2 id="æ¡æ¬¾-39æ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨-private-ç»§æ‰¿">æ¡æ¬¾ 39ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨ private ç»§æ‰¿</h2><p>å…¶ä¸­ class Student ä»¥ public å½¢å¼ç»§æ‰¿ class Personï¼Œäºæ˜¯ç¼–è¯‘å™¨åœ¨å¿…è¦æ—¶åˆ»ï¼ˆä¸ºäº†è®©å‡½æ•°è°ƒç”¨æˆåŠŸï¼‰å°† Students æš—è‡ªè½¬æ¢ä¸º Personsã€‚ç°åœ¨æˆ‘ä»¥ private ç»§æ‰¿æ›¿æ¢ public ç»§æ‰¿ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> {...};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>: <span class="keyword">private</span> Person;  <span class="comment">//è¿™æ¬¡æ”¹ç”¨ pnvate ç»§æ‰¿</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">eat</span><span class="params">(<span class="type">const</span> Person&amp; p)</span></span>;      <span class="comment">//ä»»ä½•äººéƒ½ä¼šåƒ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">study</span><span class="params">(<span class="type">const</span> Student&amp; s)</span></span>;   <span class="comment">//åªæœ‰å­¦ç”Ÿæ‰åœ¨æ ¡å­¦ä¹ </span></span><br><span class="line">Person p;                       <span class="comment">//p æ˜¯äºº</span></span><br><span class="line">Student s;                      <span class="comment">//s æ˜¯å­¦ç”Ÿ</span></span><br><span class="line"><span class="built_in">eat</span> (p);                        <span class="comment">//æ²¡é—®é¢˜ï¼Œp æ˜¯äººï¼Œä¼šåƒã€‚</span></span><br><span class="line"><span class="built_in">eat</span>(s);                         <span class="comment">//é”™è¯¯ï¼å“ï¼Œéš¾é“å­¦ç”Ÿä¸æ˜¯äººï¼Ÿï¼</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ classes ä¹‹é—´çš„ç»§æ‰¿å…³ç³»æ˜¯ privateï¼Œç¼–è¯‘å™¨ä¸ä¼šè‡ªåŠ¨å°†ä¸€ä¸ª derived class å¯¹è±¡ï¼ˆä¾‹å¦‚ Studentï¼‰è½¬æ¢ä¸ºä¸€ä¸ª base class å¯¹è±¡ï¼ˆä¾‹å¦‚ Personï¼‰ã€‚è¿™å’Œ public ç»§æ‰¿çš„æƒ…å†µä¸åŒã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡ s è°ƒç”¨ eat ä¼šå¤±è´¥çš„åŸå› ã€‚ç¬¬äºŒæ¡è§„åˆ™æ˜¯ï¼Œç”± private base class ç»§æ‰¿è€Œæ¥çš„æ‰€æœ‰æˆå‘˜ï¼Œåœ¨ derived class ä¸­éƒ½ä¼šå˜æˆ private å±æ€§ï¼Œçºµä½¿å®ƒä»¬åœ¨ base class ä¸­åŸæœ¬æ˜¯ protected æˆ– public å±æ€§ã€‚</p><p>Private ç»§æ‰¿æ„å‘³ implemented-in-terms-ofï¼ˆæ ¹æ®æŸç‰©å®ç°å‡ºï¼‰ï¼Œ private ç»§æ‰¿æ„å‘³åªæœ‰å®ç°éƒ¨åˆ†è¢«ç»§æ‰¿ï¼Œæ¥å£éƒ¨åˆ†åº”ç•¥å»ã€‚</p><p><strong>è¯·è®°ä½</strong></p><ul><li>Private ç»§æ‰¿æ„å‘³ is-implemented-in-terms ofï¼ˆæ ¹æ®æŸç‰©å®ç°å‡ºï¼‰ã€‚å®ƒé€šå¸¸æ¯”å¤åˆï¼ˆ compositionï¼‰çš„çº§åˆ«ä½ã€‚ä½†æ˜¯å½“ derived class éœ€è¦è®¿é—® protected base class çš„æˆå‘˜ï¼Œæˆ–éœ€è¦é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ virtual å‡½æ•°æ—¶ï¼Œè¿™ä¹ˆè®¾è®¡æ˜¯åˆç†çš„ã€‚</li><li>å’Œå¤åˆï¼ˆ compositionï¼‰ä¸åŒï¼Œ private ç»§æ‰¿å¯ä»¥é€ æˆ empty base æœ€ä¼˜åŒ–ã€‚è¿™å¯¹è‡´åŠ›äºâ€œå¯¹è±¡å°ºå¯¸æœ€å°åŒ–â€çš„ç¨‹åºåº“å¼€å‘è€…è€Œè¨€ï¼Œå¯èƒ½å¾ˆé‡è¦ã€‚</li></ul><h2 id="æ¡æ¬¾-40æ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨å¤šé‡ç»§æ‰¿">æ¡æ¬¾ 40ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨å¤šé‡ç»§æ‰¿</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/effectionc++5.png"></p><p>ä½¿ç”¨ virtual ç»§æ‰¿çš„é‚£äº› classes æ‰€äº§ç”Ÿçš„å¯¹è±¡å¾€å¾€æ¯”ä½¿ç”¨ non-virtual ç»§æ‰¿çš„å…„å¼Ÿä»¬ä½“ç§¯å¤§ï¼Œè®¿é—® virtual base classes çš„æˆå‘˜å˜é‡æ—¶ï¼Œä¹Ÿæ¯”è®¿é—® non-virtual base classes çš„æˆå‘˜å˜é‡é€Ÿåº¦æ…¢ã€‚</p><p>virtual ç»§æ‰¿çš„æˆæœ¬è¿˜åŒ…æ‹¬å…¶ä»–æ–¹é¢ã€‚æ”¯é…â€œ virtual base classes åˆå§‹åŒ–â€çš„è§„åˆ™æ¯”èµ· non-virtual bases çš„æƒ…å†µè¿œä¸ºå¤æ‚ä¸”ä¸ç›´è§‚ã€‚ virtual base çš„åˆå§‹åŒ–è´£ä»»æ˜¯ç”±ç»§æ‰¿ä½“ç³»ä¸­çš„æœ€ä½å±‚ï¼ˆ most derivedï¼‰ class è´Ÿè´£ï¼Œè¿™æš—ç¤ºï¼š</p><ul><li>classes è‹¥æ´¾ç”Ÿè‡ª virtual bases è€Œéœ€è¦åˆå§‹åŒ–ï¼Œå¿…é¡»è®¤çŸ¥å…¶ virtual bases ä¸€ä¸è®ºé‚£äº› bases è·ç¦»å¤šè¿œã€‚</li><li>å½“ä¸€ä¸ªæ–°çš„ derived class åŠ å…¥ç»§æ‰¿ä½“ç³»ä¸­ï¼Œå®ƒå¿…é¡»æ‰¿æ‹…å…¶ virtual basesï¼ˆä¸è®ºç›´æ¥æˆ–é—´æ¥ï¼‰çš„åˆå§‹åŒ–è´£ä»»ã€‚</li></ul><p>æˆ‘å¯¹ virtual base classesï¼ˆäº¦ç›¸å½“äºå¯¹ virtual ç»§æ‰¿ï¼‰çš„å¿ å‘Šå¾ˆç®€å•ã€‚ç¬¬ä¸€ï¼Œéå¿…è¦ä¸ä½¿ç”¨â…µrtual basesã€‚å¹³å¸¸è¯·ä½¿ç”¨ non-virtual ç»§æ‰¿ã€‚ç¬¬äºŒï¼Œå¦‚æœä½ å¿…é¡»ä½¿ç”¨ virtual base classesï¼Œå°½å¯èƒ½é¿å…åœ¨å…¶ä¸­æ”¾ç½®æ•°æ®ã€‚è¿™ä¹ˆä¸€æ¥ä½ å°±ä¸éœ€æ‹…å¿ƒè¿™äº› classes èº«ä¸Šçš„åˆå§‹åŒ–ï¼ˆå’Œèµ‹å€¼ï¼‰æ‰€å¸¦æ¥çš„è¯¡å¼‚äº‹æƒ…äº†ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠEffective C++ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ï¼ˆäºŒï¼‰ Effective C++ï¼ˆä¸Šï¼‰</title>
      <link href="/2021/Program/CPPEffectivePart1/"/>
      <url>/2021/Program/CPPEffectivePart1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/Effective-C++1.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMxYmQ0NjFlZmFkNDA3ZTk5OTI3ZWI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="è®©è‡ªå·±ä¹ æƒ¯-c">è®©è‡ªå·±ä¹ æƒ¯ C++</h1><h2 id="æ¡æ¬¾-03å°½å¯èƒ½ä½¿ç”¨-const">æ¡æ¬¾ 03ï¼šå°½å¯èƒ½ä½¿ç”¨ const</h2><p>å¦‚æœå…³é”®å­— const å‡ºç°åœ¨æ˜Ÿå·å·¦è¾¹ï¼Œè¡¨ç¤ºè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼›å¦‚æœå‡ºç°åœ¨æ˜Ÿå·å³è¾¹ï¼Œè¡¨ç¤ºæŒ‡é’ˆè‡ªèº«æ˜¯å¸¸é‡ï¼›å¦‚æœå‡ºç°åœ¨æ˜Ÿå·ä¸¤è¾¹ï¼Œè¡¨ç¤ºè¢«æŒ‡ç‰©å’ŒæŒ‡é’ˆä¸¤è€…éƒ½æ˜¯å¸¸é‡ã€‚</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> greeting[] = <span class="string">"Hello"</span>;</span><br><span class="line"><span class="type">char</span>* p = greeting; <span class="comment">//non-const pointer,non-const data</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* p greeting; <span class="comment">//non-const pointer,const data</span></span><br><span class="line"><span class="type">char</span>* <span class="type">const</span> p = greeting;   <span class="comment">//const pointer,non-const data</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> p = greeting; <span class="comment">//const pointer,const data</span></span><br></pre></td></tr></tbody></table></figure><h2 id="æ¡æ¬¾-04ç¡®å®šå¯¹è±¡è¢«ä½¿ç”¨å‰å·²å…ˆè¢«åˆå§‹åŒ–">æ¡æ¬¾ 04ï¼šç¡®å®šå¯¹è±¡è¢«ä½¿ç”¨å‰å·²å…ˆè¢«åˆå§‹åŒ–</h2><ul><li>ä¸ºå†…ç½®å‹å¯¹è±¡è¿›è¡Œæ‰‹å·¥åˆå§‹åŒ–ï¼Œå› ä¸º C++ä¸ä¿è¯åˆå§‹åŒ–å®ƒä»¬ã€‚</li><li>æ„é€ å‡½æ•°æœ€å¥½ä½¿ç”¨æˆå‘˜åˆå€¼åˆ—ï¼ˆmember initialization listï¼‰ï¼Œè€Œä¸è¦åœ¨æ„é€ å‡½æ•°æœ¬ä½“å†…ä½¿ç”¨èµ‹å€¼æ“ä½œï¼ˆassignmentï¼‰ã€‚åˆå€¼åˆ—åˆ—å‡ºçš„æˆå‘˜å˜é‡ï¼Œå…¶æ’åˆ—æ¬¡åºåº”è¯¥å’Œå®ƒä»¬åœ¨ class ä¸­çš„å£°æ˜æ¬¡åºç›¸åŒã€‚</li><li>ä¸ºå…é™¤â€œè·¨ç¼–è¯‘å•å…ƒä¹‹åˆå§‹åŒ–æ¬¡åºâ€é—®é¢˜ï¼Œè¯·ä»¥ local static å¯¹è±¡æ›¿æ¢ non-local static å¯¹è±¡ã€‚</li></ul><blockquote><p>æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨å’Œæ„é€ å‡½æ•°çš„å‡½æ•°ä½“éƒ½å¯ä»¥ä¸ºæˆ‘ä»¬çš„ç±»æ•°æ®æˆå‘˜æŒ‡å®šä¸€äº›åˆå€¼ï¼Œä½†æ˜¯ä¸¤è€…åœ¨ç»™æˆå‘˜æŒ‡å®šåˆå€¼çš„æ–¹å¼ä¸Šæ˜¯ä¸åŒçš„ã€‚æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä½¿ç”¨åˆå§‹åŒ–çš„æ–¹å¼æ¥ä¸ºæ•°æ®æˆå‘˜æŒ‡å®šåˆå€¼ï¼Œè€Œæ„é€ å‡½æ•°çš„å‡½æ•°ä½“æ˜¯é€šè¿‡èµ‹å€¼çš„æ–¹å¼æ¥ç»™æ•°æ®æˆå‘˜æŒ‡å®šåˆå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆå‘˜åˆå§‹åŒ–åˆ—è¡¨æ˜¯åœ¨æ•°æ®æˆå‘˜å®šä¹‰çš„åŒæ—¶èµ‹åˆå€¼ï¼Œä½†æ˜¯æ„é€ å‡½çš„å‡½æ•°ä½“æ˜¯é‡‡ç”¨å…ˆå®šä¹‰åèµ‹å€¼çš„æ–¹å¼æ¥åšã€‚è¿™æ ·çš„åŒºåˆ«å°±é€ æˆäº†ï¼Œåœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ˜¯å¿…é¡»è¦ä½¿ç”¨æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ã€‚</p></blockquote><h1 id="æ„é€ ææ„èµ‹å€¼è¿ç®—">æ„é€ /ææ„/èµ‹å€¼è¿ç®—</h1><h2 id="æ¡æ¬¾-05äº†è§£-cé»˜é»˜ç¼–å†™å¹¶è°ƒç”¨å“ªäº›å‡½æ•°">æ¡æ¬¾ 05ï¼šäº†è§£ C++é»˜é»˜ç¼–å†™å¹¶è°ƒç”¨å“ªäº›å‡½æ•°</h2><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ Namedobject å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­ namevalue æ˜¯ä¸ª reference to stringï¼ŒobjectValue æ˜¯ä¸ª const Tï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Namedobject</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Namedobject</span> (std:string&amp; name,<span class="type">const</span> T&amp;value);</span><br><span class="line">                <span class="comment">//å¦‚å‰ï¼Œå‡è®¾å¹¶æœªå£°æ˜ operator=</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    std::string&amp; namevalueï¼›<span class="comment">// referenceconst T objectvalue;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç°åœ¨è€ƒè™‘ä¸‹é¢ä¼šå‘ç”Ÿä»€ä¹ˆäº‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std:<span class="function">string <span class="title">newDog</span><span class="params">(<span class="string">"Persephone"</span>)</span></span>;</span><br><span class="line">std:<span class="function">string <span class="title">oldDog</span> <span class="params">(<span class="string">"Satch"</span>)</span></span>;</span><br><span class="line"><span class="function">Namedobject&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(newDog,<span class="number">2</span>)</span></span>;   <span class="comment">//å½“åˆæ’°å†™è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ç‹— Persephone</span></span><br><span class="line">                                <span class="comment">//å³å°†åº¦è¿‡å…¶ç¬¬äºŒä¸ªç”Ÿæ—¥ã€‚</span></span><br><span class="line"><span class="function">Namedobject&lt;<span class="type">int</span>&gt; <span class="title">s</span><span class="params">(oldDogï¼Œ<span class="number">36</span>)</span></span>; <span class="comment">//æˆ‘å°æ—¶å€™å…»çš„ç‹— Satch åˆ™æ˜¯ 36 å²ï¼Œ</span></span><br><span class="line"></span><br><span class="line">p = s;                          <span class="comment">//ç°åœ¨ p çš„æˆå‘˜å˜é‡è¯¥å‘ç”Ÿä»€ä¹ˆäº‹ï¼Ÿ</span></span><br></pre></td></tr></tbody></table></figure><p>å› ä¸º C++å¹¶ä¸å…è®¸â€œè®© reference æ”¹æŒ‡å‘ä¸åŒå¯¹è±¡â€ã€‚é¢å¯¹è¿™ä¸ªéš¾é¢˜ï¼ŒC++çš„å“åº”æ˜¯æ‹’ç»ç¼–è¯‘é‚£ä¸€è¡Œèµ‹å€¼åŠ¨ä½œã€‚å¦‚æœä½ æ‰“ç®—åœ¨ä¸€ä¸ªâ€œå†…å« reference æˆå‘˜â€çš„ class å†…æ”¯æŒèµ‹å€¼æ“ä½œï¼ˆassignmentï¼‰ï¼Œä½ å¿…é¡»è‡ªå·±å®šä¹‰ copy assignment æ“ä½œç¬¦ã€‚</p><p>é¢å¯¹â€œå†…å« const æˆå‘˜â€çš„ classesï¼Œç¼–è¯‘å™¨çš„ååº”ä¹Ÿä¸€æ ·ã€‚æ›´æ”¹ const æˆå‘˜æ˜¯ä¸åˆæ³•çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸çŸ¥é“å¦‚ä½•åœ¨å®ƒè‡ªå·²ç”Ÿæˆçš„èµ‹å€¼å‡½æ•°å†…é¢å¯¹å®ƒä»¬ã€‚</p><p>æœ€åè¿˜æœ‰ä¸€ç§æƒ…å†µï¼šå¦‚æœæŸä¸ª base classes å°† copy assignment æ“ä½œç¬¦å£°æ˜ä¸º privateï¼Œç¼–è¯‘å™¨å°†æ‹’ç»ä¸ºå…¶ derived classes ç”Ÿæˆä¸€ä¸ª copy assignment æ“ä½œç¬¦ã€‚</p><h2 id="æ¡æ¬¾-06è‹¥ä¸æƒ³ä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°å°±è¯¥æ˜ç¡®æ‹’ç»">æ¡æ¬¾ 06ï¼šè‹¥ä¸æƒ³ä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°ï¼Œå°±è¯¥æ˜ç¡®æ‹’ç»</h2><p>æ‰€æœ‰ç¼–è¯‘å™¨äº§å‡ºçš„å‡½æ•°éƒ½æ˜¯ publicã€‚ä¸ºé˜»æ­¢è¿™äº›å‡½æ•°è¢«åˆ›å»ºå‡ºæ¥ï¼Œä½ å¾—è‡ªè¡Œå£°æ˜å®ƒä»¬ï¼Œä½†è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆéœ€æ±‚ä½¿ä½ å¿…é¡»å°†å®ƒä»¬å£°æ˜ä¸º publicã€‚å› æ­¤ä½ å¯ä»¥å°† copy æ„é€ å‡½æ•°æˆ– copy assignment æ“ä½œç¬¦å£°æ˜ä¸º privateã€‚è—‰ç”±æ˜ç¡®å£°æ˜ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œä½ é˜»æ­¢äº†ç¼–è¯‘å™¨æš—è‡ªåˆ›å»ºå…¶ä¸“å±ç‰ˆæœ¬ï¼›è€Œä»¤è¿™äº›å‡½æ•°ä¸º privateï¼Œä½¿ä½ å¾—ä»¥æˆåŠŸé˜»æ­¢äººä»¬è°ƒç”¨å®ƒã€‚</p><p><strong>è¯·è®°ä½</strong></p><ul><li>ä¸ºé©³å›ç¼–è¯‘å™¨è‡ªåŠ¨ï¼ˆæš—è‡ªï¼‰æä¾›çš„æœºèƒ½ï¼Œå¯å°†ç›¸åº”çš„æˆå‘˜å‡½æ•°å£°æ˜ä¸º private å¹¶ä¸”ä¸äºˆå®ç°ã€‚</li></ul><h2 id="æ¡æ¬¾-07ä¸ºå¤šæ€åŸºç±»å£°æ˜è™šææ„å‡½æ•°">æ¡æ¬¾ 07ï¼šä¸ºå¤šæ€åŸºç±»å£°æ˜è™šææ„å‡½æ•°</h2><ul><li>polymorphicï¼ˆå¸¦å¤šæ€æ€§è´¨çš„ï¼‰base classes åº”è¯¥å£°æ˜ä¸€ä¸ª virtual ææ„å‡½æ•°ã€‚å¦‚æœ class å¸¦æœ‰ä»»ä½• virtual å‡½æ•°ï¼Œå®ƒå°±åº”è¯¥æ‹¥æœ‰ä¸€ä¸ª virtual ææ„å‡½æ•°ï¼Œå› ä¸º C++æ˜ç™½æŒ‡å‡ºï¼Œå½“ derived class å¯¹è±¡ç»ç”±ä¸€ä¸ª base class æŒ‡é’ˆè¢«åˆ é™¤ï¼Œè€Œè¯¥ base class å¸¦ç€ä¸€ä¸ª non-virtual ææ„å‡½æ•°ï¼Œå…¶ç»“æœæœªæœ‰å®šä¹‰ä¸€å®é™…æ‰§è¡Œæ—¶é€šå¸¸å‘ç”Ÿçš„æ˜¯å¯¹è±¡çš„ derived æˆåˆ†æ²¡è¢«é”€æ¯ã€‚</li><li>Classes çš„è®¾è®¡ç›®çš„å¦‚æœä¸æ˜¯ä½œä¸º base classes ä½¿ç”¨ï¼Œæˆ–ä¸æ˜¯ä¸ºäº†å…·å¤‡å¤šæ€æ€§ï¼ˆpolymorphicallyï¼‰ï¼Œå°±ä¸è¯¥å£°æ˜ virtual ææ„å‡½æ•°ã€‚å½“ class ä¸ä¼å›¾è¢«å½“ä½œ base classï¼Œä»¤å…¶ææ„å‡½æ•°ä¸º virtual å¾€å¾€æ˜¯ä¸ªé¦Šä¸»æ„ã€‚é¢å¤–çš„è™šè¡¨æŒ‡é’ˆå’Œè™šå‡½æ•°è¡¨ç”Ÿæˆï¼Œå¯¼è‡´å ç©ºé—´å¢åŠ ä»¥åŠä¸å…¼å®¹æ€§ã€‚</li></ul><h2 id="æ¡æ¬¾-08åˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°">æ¡æ¬¾ 08ï¼šåˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°</h2><ul><li>ææ„å‡½æ•°ç»å¯¹ä¸è¦åå‡ºå¼‚å¸¸ã€‚å¦‚æœä¸€ä¸ªè¢«ææ„å‡½æ•°è°ƒç”¨çš„å‡½æ•°å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œææ„å‡½æ•°åº”è¯¥æ•æ‰ä»»ä½•å¼‚å¸¸ï¼Œç„¶ååä¸‹å®ƒä»¬ï¼ˆä¸ä¼ æ’­ï¼‰æˆ–ç»“æŸç¨‹åºã€‚</li><li>å¦‚æœå®¢æˆ·éœ€è¦å¯¹æŸä¸ªæ“ä½œå‡½æ•°è¿è¡ŒæœŸé—´æŠ›å‡ºçš„å¼‚å¸¸åšå‡ºååº”ï¼Œé‚£ä¹ˆ class åº”è¯¥æä¾›ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼ˆè€Œéåœ¨ææ„å‡½æ•°ä¸­ï¼‰æ‰§è¡Œè¯¥æ“ä½œã€‚</li></ul><h2 id="æ¡æ¬¾-09ç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨è™šå‡½æ•°">æ¡æ¬¾ 09ï¼šç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨è™šå‡½æ•°</h2><p><strong>åœ¨ base class æ„é€ æœŸé—´ï¼Œvirtual å‡½æ•°ä¸æ˜¯ virtual å‡½æ•°ã€‚</strong> ç”±äº base class æ„é€ å‡½æ•°çš„æ‰§è¡Œæ›´æ—©äº derived class æ„é€ å‡½æ•°ï¼Œå½“ base class æ„é€ å‡½æ•°æ‰§è¡Œæ—¶ derived class çš„æˆå‘˜å˜é‡å°šæœªåˆå§‹åŒ–ã€‚å¦‚æœæ­¤æœŸé—´è°ƒç”¨çš„ virtual å‡½æ•°ä¸‹é™è‡³ derived classes é˜¶å±‚ï¼Œè¦çŸ¥é“ derived class çš„å‡½æ•°å‡ ä¹å¿…ç„¶å–ç”¨ local æˆå‘˜å˜é‡ï¼Œè€Œé‚£äº›æˆå‘˜å˜é‡å°šæœªåˆå§‹åŒ–ã€‚æ‰€ä»¥ C++ä¸è®©ä½ èµ°è¿™æ¡è·¯ã€‚</p><p>å…¶å®è¿˜æœ‰æ¯”ä¸Šè¿°ç†ç”±æ›´æ ¹æœ¬çš„åŸå› ï¼šåœ¨ derived class å¯¹è±¡çš„ base class æ„é€ æœŸé—´ï¼Œå¯¹è±¡çš„ç±»å‹æ˜¯ base class è€Œä¸æ˜¯ derived classã€‚ä¸åª virtual å‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨è§£æè‡³ï¼ˆresolve toï¼‰base classï¼šï¼Œè‹¥ä½¿ç”¨è¿è¡ŒæœŸç±»å‹ä¿¡æ¯ï¼ˆruntime type informationï¼Œä¾‹å¦‚ dynamic_cast å’Œ typeidï¼‰ï¼Œä¹Ÿä¼šæŠŠå¯¹è±¡è§†ä¸º base class ç±»å‹ã€‚</p><p>ç›¸åŒé“ç†ä¹Ÿé€‚ç”¨äºææ„å‡½æ•°ã€‚ä¸€æ—¦ derived class ææ„å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œå¯¹è±¡å†…çš„ derived class æˆå‘˜å˜é‡ä¾¿å‘ˆç°æœªå®šä¹‰å€¼ï¼Œæ‰€ä»¥ C++è§†å®ƒä»¬ä»¿ä½›ä¸å†å­˜åœ¨ã€‚è¿›å…¥ baseclass ææ„å‡½æ•°åå¯¹è±¡å°±æˆä¸ºä¸€ä¸ª base class å¯¹è±¡ï¼Œè€Œ C++çš„ä»»ä½•éƒ¨åˆ†åŒ…æ‹¬ virtual å‡½æ•°ã€dynamic_casts ç­‰ç­‰ä¹Ÿå°±é‚£ä¹ˆçœ‹å¾…å®ƒã€‚</p><h2 id="æ¡æ¬¾-10ä»¤-operator-è¿”å›ä¸€ä¸ª-this-å¼•ç”¨">æ¡æ¬¾ 10ï¼šä»¤ operator= è¿”å›ä¸€ä¸ª* this å¼•ç”¨</h2><p>å…³äºèµ‹å€¼ï¼Œæœ‰è¶£çš„æ˜¯ä½ å¯ä»¥æŠŠå®ƒä»¬å†™æˆè¿é”å½¢å¼ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x,y,z;</span><br><span class="line">x = y = z = <span class="number">15</span>; <span class="comment">//èµ‹å€¼è¿é”å½¢å¼</span></span><br></pre></td></tr></tbody></table></figure><p>åŒæ ·æœ‰è¶£çš„æ˜¯ï¼Œèµ‹å€¼é‡‡ç”¨å³ç»“åˆå¾‹ï¼Œæ‰€ä»¥ä¸Šè¿°è¿é”èµ‹å€¼è¢«è§£æä¸ºï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x = (y = (z = <span class="number">15</span>));</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œ 15 å…ˆè¢«èµ‹å€¼ç»™ zï¼Œç„¶åå…¶ç»“æœï¼ˆæ›´æ–°åçš„ zï¼‰å†è¢«èµ‹å€¼ç»™ yï¼Œç„¶åå…¶ç»“æœï¼ˆæ›´æ–°åçš„ yï¼‰å†è¢«èµ‹å€¼ç»™ xã€‚ä¸ºäº†å®ç°â€œè¿é”èµ‹å€¼â€ï¼Œèµ‹å€¼æ“ä½œç¬¦å¿…é¡»è¿”å›ä¸€ä¸ª reference æŒ‡å‘æ“ä½œç¬¦çš„å·¦ä¾§å®å‚ã€‚è¿™æ˜¯ä½ ä¸º classes å®ç°èµ‹å€¼æ“ä½œç¬¦æ—¶åº”è¯¥éµå¾ªçš„åè®®ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs)    <span class="comment">//è¿”å›ç±»å‹æ˜¯ä¸ª referenceï¼Œ</span></span><br><span class="line">    {                                       <span class="comment">//æŒ‡å‘å½“å‰å¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="keyword">return</span>* <span class="keyword">this</span>;                       <span class="comment">//è¿”å›å·¦ä¾§å¯¹è±¡</span></span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h2 id="æ¡æ¬¾-12å¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€ä¸ªæˆåˆ†">æ¡æ¬¾ 12ï¼šå¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€ä¸ªæˆåˆ†</h2><p>å½“ä½ ç¼–å†™ä¸€ä¸ª copying å‡½æ•°ï¼Œè¯·ç¡®ä¿ï¼š</p><ul><li>å¤åˆ¶æ‰€æœ‰ local æˆå‘˜å˜é‡ã€‚</li><li>è°ƒç”¨æ‰€æœ‰ base classes å†…çš„é€‚å½“çš„ copying å‡½æ•°ã€‚</li></ul><p>ä»¤ copy assignment æ“ä½œç¬¦è°ƒç”¨ copy æ„é€ å‡½æ•°æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºè¿™å°±åƒè¯•å›¾æ„é€ ä¸ªå·²ç»å­˜åœ¨çš„å¯¹è±¡ã€‚è¿™ä»¶äº‹å¦‚æ­¤è’è°¬ï¼Œä¹ƒè‡³äºæ ¹æœ¬æ²¡æœ‰ç›¸å…³è¯­æ³•ã€‚æ˜¯æœ‰ä¸€äº›çœ‹ä¼¼å¦‚ä½ æ‰€æ„¿çš„è¯­æ³•ï¼Œä½†å…¶å®ä¸æ˜¯ï¼›ä¹Ÿçš„ç¡®æœ‰äº›è¯­æ³•èƒŒåçœŸæ­£åšäº†å®ƒï¼Œä½†å®ƒä»¬åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€ æˆä½ çš„å¯¹è±¡è´¥åï¼Œæ‰€ä»¥æˆ‘ä¸æ‰“ç®—å°†é‚£äº›è¯­æ³•å‘ˆç°ç»™ä½ çœ‹ã€‚å•çº¯åœ°æ¥å—è¿™ä¸ªå™è¿°å§ï¼šä½ ä¸è¯¥ä»¤ copy assignment æ“ä½œç¬¦è°ƒç”¨ copy æ„é€ å‡½æ•°ã€‚</p><p>åæ–¹å‘ä¸€ä»¤ copy æ„é€ å‡½æ•°è°ƒç”¨ copy assignment æ“ä½œç¬¦ä¸€åŒæ ·æ— æ„ä¹‰ã€‚æ„é€ å‡½æ•°ç”¨æ¥åˆå§‹åŒ–æ–°å¯¹è±¡ï¼Œè€Œ assignment æ“ä½œç¬¦åªæ–½è¡Œäºå·²åˆå§‹åŒ–å¯¹è±¡èº«ä¸Šã€‚å¯¹ä¸€ä¸ªå°šæœªæ„é€ å¥½çš„å¯¹è±¡èµ‹å€¼ï¼Œå°±åƒåœ¨ä¸€ä¸ªå°šæœªåˆå§‹åŒ–çš„å¯¹è±¡èº«ä¸Šåšâ€œåªå¯¹å·²åˆå§‹åŒ–å¯¹è±¡æ‰æœ‰æ„ä¹‰â€çš„äº‹ä¸€æ ·ã€‚æ— èŠå˜›ï¼åˆ«å°è¯•ã€‚</p><p>å¦‚æœä½ å‘ç°ä½ çš„ copy æ„é€ å‡½æ•°å’Œ copy assignment æ“ä½œç¬¦æœ‰ç›¸è¿‘çš„ä»£ç ï¼Œæ¶ˆé™¤é‡å¤ä»£ç çš„åšæ³•æ˜¯ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çš„æˆå‘˜å‡½æ•°ç»™ä¸¤è€…è°ƒç”¨ã€‚è¿™æ ·çš„å‡½æ•°å¾€å¾€æ˜¯ private è€Œä¸”å¸¸è¢«å‘½åä¸º initã€‚è¿™ä¸ªç­–ç•¥å¯ä»¥å®‰å…¨æ¶ˆé™¤ copy æ„é€ å‡½æ•°å’Œ copy assignment æ“ä½œç¬¦ä¹‹é—´çš„ä»£ç é‡å¤ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠEffective C++ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ï¼ˆä¸€ï¼‰å¯¹è±¡æ¨¡å‹</title>
      <link href="/2021/Program/CPPobjectModel/"/>
      <url>/2021/Program/CPPobjectModel/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/CPPObjectModle.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMxODNiYzBlM2U3NDA3ZGE0ZWE3ZGU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å¯¹è±¡æ¨¡å¼">å¯¹è±¡æ¨¡å¼</h1><p>åœ¨ C++ä¸­ï¼Œæœ‰ä¸¤ç§ class data membersï¼šstatic å’Œ nonstaticï¼Œä»¥åŠä¸‰ç§ class member functionsï¼šstaticã€nonstatic å’Œ virtualã€‚å·²çŸ¥ä¸‹é¢è¿™ä¸ª class Point å£°æ˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">float</span> xval);</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Point</span>();</span><br><span class="line">    <span class="function"><span class="type">float</span> <span class="title">x</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    <span class="type">static</span> <span class="type">int</span> <span class="title">PointCount</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ostream&amp;</span></span><br><span class="line"><span class="function">      <span class="title">print</span><span class="params">(ostream &amp;os)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">float</span> _x;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> _point_count;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ª class Point åœ¨æœºå™¨ä¸­å°†ä¼šè¢«æ€ä¹ˆæ ·è¡¨ç°å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¦‚ä½•æ¨¡å¡‘ï¼ˆmodelingï¼‰å‡ºå„ç§ data members å’Œ function members å‘¢ï¼Ÿ</p><h2 id="cå¯¹è±¡æ¨¡å‹the-c-object-model">C++å¯¹è±¡æ¨¡å‹ï¼ˆThe C++ Object Modelï¼‰</h2><p>Stroustrup å½“åˆè®¾è®¡çš„ C++å¯¹è±¡æ¨¡å‹æ˜¯ä»ç®€å•å¯¹è±¡æ¨¡å‹æ´¾ç”Ÿè€Œæ¥çš„ï¼Œå¹¶å¯¹å†…å­˜ç©ºé—´å’Œå­˜å–æ—¶é—´åšäº†ä¼˜åŒ–ã€‚åœ¨æ­¤æ¨¡å‹ä¸­ï¼š</p><ul><li>Nonstatic datamembers è¢«é…ç½®äºæ¯ä¸€ä¸ª class object ä¹‹å†…ã€‚</li><li>static data members åˆ™è¢«å­˜æ”¾åœ¨æ‰€æœ‰çš„ class object ä¹‹å¤–ï¼ˆdata æ®µæˆ– bss æ®µï¼‰ã€‚</li><li>Static å’Œ nonstatic function members ä¹Ÿè¢«æ”¾åœ¨æ‰€æœ‰çš„ class object ä¹‹å¤–ï¼ˆä»£ç æ®µï¼‰ã€‚</li><li>Virtual functions åˆ™ä»¥ä¸¤ä¸ªæ­¥éª¤æ”¯æŒä¹‹ï¼š<ul><li>æ¯ä¸€ä¸ª class äº§ç”Ÿå‡ºä¸€å †æŒ‡å‘ virtual functions çš„æŒ‡é’ˆï¼Œæ”¾åœ¨è¡¨æ ¼ä¹‹ä¸­ã€‚è¿™ä¸ªè¡¨æ ¼è¢«ç§°ä¸º virtual tableï¼ˆvtblï¼‰</li><li>æ¯ä¸€ä¸ª class object è¢«æ·»åŠ äº†ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç›¸å…³çš„ virtual tableã€‚é€šå¸¸è¿™ä¸ªæŒ‡é’ˆè¢«ç§°ä¸º vptrã€‚vptr çš„è®¾å®šï¼ˆsettingï¼‰å’Œé‡ç½®ï¼ˆresettingï¼‰éƒ½ç”±æ¯ä¸€ä¸ª class çš„ constructorã€destructor å’Œ copy assignment è¿ç®—ç¬¦è‡ªåŠ¨å®Œæˆã€‚æ¯ä¸€ä¸ª class æ‰€å…³è”çš„ type_info objectï¼ˆç”¨ä»¥æ”¯æŒï¼šruntime type identifcationï¼ŒRTTIï¼‰ä¹Ÿç»ç”± virtual table è¢«æŒ‡å‡ºæ¥ï¼Œé€šå¸¸æ˜¯æ”¾åœ¨è¡¨æ ¼çš„ç¬¬ä¸€ä¸ª slot å¤„ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo3.png"></li></ul></li></ul><h2 id="åŠ ä¸Šç»§æ‰¿adding-inheritance">åŠ ä¸Šç»§æ‰¿ï¼ˆAdding Inheritanceï¼‰</h2><p>å•ä¸€ç»§æ‰¿ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Library_materials</span> {...}</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span> : <span class="keyword">public</span> Library_materials {..}</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rental_book</span> : <span class="keyword">public</span> Book {..}</span><br></pre></td></tr></tbody></table></figure><p>å¤šé‡ç»§æ‰¿ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŸæœ¬çš„ï¼ˆæ›´æ—©äºæ ‡å‡†ç‰ˆçš„ï¼‰iostream å®ç°æ–¹å¼</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">iostream</span>:</span><br><span class="line">    <span class="keyword">public</span> istream,</span><br><span class="line">    <span class="keyword">public</span> ostream {..}</span><br></pre></td></tr></tbody></table></figure><p>ç”šè‡³ï¼Œç»§æ‰¿å…³ç³»ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºè™šæ‹Ÿï¼ˆvirtualï¼Œä¹Ÿå°±æ˜¯å…±äº«çš„æ„æ€ï¼‰ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">istream</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> ios {...}</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ostream</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> ios {...}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è™šæ‹Ÿç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œbase class ä¸ç®¡åœ¨ç»§æ‰¿ä¸²é“¾ä¸­è¢«æ´¾ç”Ÿï¼ˆderivedï¼‰å¤šå°‘æ¬¡ï¼Œæ°¸è¿œåªä¼šå­˜åœ¨ä¸€ä¸ªå®ä½“ï¼ˆç§°ä¸º subobjectï¼‰ã€‚ä¾‹å¦‚ iostream ä¹‹ä¸­å°±åªæœ‰ virtual ios base class çš„ä¸€ä¸ªå®ä½“ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo4.png"></p><p>base class table è¢«äº§ç”Ÿå‡ºæ¥æ—¶ï¼Œè¡¨æ ¼ä¸­çš„æ¯ä¸€ä¸ª slot å†…å«ä¸€ä¸ªç›¸å…³çš„ base class åœ°å€ï¼Œè¿™å¾ˆåƒ virtual table å†…å«æ¯ä¸€ä¸ª virtual function çš„åœ°å€ä¸€æ ·ã€‚æ¯ä¸€ä¸ª class object å†…å«ä¸€ä¸ª bptrï¼Œå®ƒä¼šè¢«åˆå§‹åŒ–ï¼ŒæŒ‡å‘å…¶ base class tableã€‚</p><ul><li>ç¼ºç‚¹ï¼šä¸»è¦ç¼ºç‚¹æ˜¯ç”±äºé—´æ¥æ€§è€Œå¯¼è‡´çš„ç©ºé—´å’Œå­˜å–æ—¶é—´ä¸Šçš„é¢å¤–è´Ÿæ‹…ï¼Œ</li><li>ä¼˜ç‚¹ï¼š<ul><li>åœ¨æ¯ä¸€ä¸ª class object ä¸­å¯¹äºç»§æ‰¿éƒ½æœ‰ä¸€è‡´çš„è¡¨ç°æ–¹å¼ï¼šæ¯ä¸€ä¸ª class object éƒ½åº”è¯¥åœ¨æŸä¸ªå›ºå®šä½ç½®ä¸Šå®‰æ”¾ä¸€ä¸ª base table æŒ‡é’ˆï¼Œä¸ base classes çš„å¤§å°æˆ–æ•°ç›®æ— å…³</li><li>ä¸éœ€è¦æ”¹å˜ class objects æœ¬èº«ï¼Œå°±å¯ä»¥æ”¾å¤§ã€ç¼©å°ã€æˆ–æ›´æ”¹ base class table <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo5.png"></li></ul></li></ul><p>éœ€è¦å¤šå°‘å†…å­˜æ‰èƒ½å¤Ÿè¡¨ç°ä¸€ä¸ª class objectï¼Ÿä¸€èˆ¬è€Œè¨€è¦æœ‰ï¼š</p><ul><li>å…¶ nonstatic data members çš„æ€»å’Œå¤§å°ã€‚</li><li>åŠ ä¸Šä»»ä½•ç”±äº alignment çš„éœ€æ±‚è€Œå¡«è¡¥ï¼ˆpaddingï¼‰ä¸Šå»çš„ç©ºé—´ã€‚</li><li>åŠ ä¸Šä¸ºäº†æ”¯æŒ virtual è€Œç”±å†…éƒ¨äº§ç”Ÿçš„ä»»ä½•é¢å¤–è´Ÿæ‹…ï¼ˆoverheadï¼‰ã€‚</li></ul><h1 id="æ„é€ å‡½æ•°è¯­ä¹‰å­¦">æ„é€ å‡½æ•°è¯­ä¹‰å­¦</h1><h2 id="default-constructor-çš„å»ºæ„æ“ä½œ">Default Constructor çš„å»ºæ„æ“ä½œ</h2><p>C++ Standardã€ISO-C++95ã€‘çš„ Section12.1 è¿™ä¹ˆè¯´ï¼š å¯¹äº class Xï¼Œå¦‚æœæ²¡æœ‰ä»»ä½• user-declared constructorï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ª default constructor è¢«æš—ä¸­ï¼ˆimplicitlyï¼‰å£°æ˜å‡ºæ¥ã€‚ä¸€ä¸ªè¢«æš—ä¸­å£°æ˜å‡ºæ¥çš„ default constructor å°†æ˜¯ä¸€ä¸ª trivialï¼ˆæµ…è–„è€Œæ— èƒ½ï¼Œæ²¡å•¥ç”¨çš„ï¼‰constructorã€‚</p><p>C++ Standard ç„¶åå¼€å§‹å™è¿°åœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹è¿™ä¸ª implicit default constructor ä¼šè¢«è§†ä¸º trivialã€‚ä¸€ä¸ª nontrivial default constructor åœ¨ ARM çš„æœ¯è¯­ä¸­å°±æ˜¯ç¼–è¯‘å™¨æ‰€éœ€è¦çš„é‚£ç§ï¼Œå¿…è¦çš„è¯ä¼šç”±ç¼–è¯‘å™¨åˆæˆå‡ºæ¥ã€‚ä¸‹é¢åˆ†åˆ«è®¨è®º nontrivial default constructor çš„å››ç§æƒ…å†µã€‚</p><h3 id="å¸¦æœ‰-default-constructor-çš„-member-class-object">å¸¦æœ‰ Default Constructor çš„ Member Class Object</h3><p>å¦‚æœä¸€ä¸ª class æ²¡æœ‰ä»»ä½• constructorï¼Œä½†å®ƒå†…å«ä¸€ä¸ª member objectï¼Œè€Œåè€…æœ‰ default constructorï¼Œé‚£ä¹ˆè¿™ä¸ª class çš„ implicit default constructor å°±æ˜¯â€œnontrivial'â€ï¼Œç¼–è¯‘å™¨éœ€è¦ä¸ºæ­¤ class åˆæˆå‡ºä¸€ä¸ª default constructorã€‚</p><ul><li>åœ¨ C++å„ä¸ªä¸åŒçš„ç¼–è¯‘æ¨¡å—ä¸­ï¼Œç¼–è¯‘å™¨å¦‚ä½•é¿å…åˆæˆå‡ºå¤šä¸ª default constructor å‘¢ï¼Ÿè§£å†³æ–¹æ³•æ˜¯æŠŠåˆæˆçš„ default constructorã€copy constructorã€destructorã€assignment copy operator éƒ½ä»¥ inline æ–¹å¼å®Œæˆã€‚ä¸€ä¸ª inline å‡½æ•°æœ‰é™æ€é“¾æ¥ï¼ˆstatic linkageï¼‰ï¼Œä¸ä¼šè¢«æ¡£æ¡ˆä»¥å¤–è€…çœ‹åˆ°ã€‚å¦‚æœå‡½æ•°å¤ªå¤æ‚ï¼Œä¸é€‚åˆåšæˆ inlineï¼Œå°±ä¼šåˆæˆå‡ºä¸€ä¸ª explicit non-inline static å®ä½“</li><li>â€œå¦‚æœ class A å†…å«ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šçš„ member class objectsï¼Œé‚£ä¹ˆ class A çš„æ¯ä¸€ä¸ª constructor å¿…é¡»è°ƒç”¨æ¯ä¸€ä¸ª member classes çš„ default constructorâ€ã€‚ç¼–è¯‘å™¨ä¼šæ‰©å¼ å·²å­˜åœ¨çš„ constructorsï¼Œåœ¨å…¶ä¸­å®‰æ’ä¸€äº›ä»£ç ï¼Œä½¿å¾— user code åœ¨è¢«æ‰§è¡Œä¹‹å‰ï¼Œå…ˆè°ƒç”¨å¿…è¦çš„ default constructors</li><li>å¦‚æœæœ‰å¤šä¸ª class member objects éƒ½è¦æ±‚ constructor åˆå§‹åŒ–æ“ä½œï¼Œå°†å¦‚ä½•å‘¢ï¼ŸC++è¯­è¨€è¦æ±‚ä»¥â€œmember objects åœ¨ class ä¸­çš„å£°æ˜æ¬¡åºâ€æ¥è°ƒç”¨å„ä¸ª constructors</li></ul><h3 id="å¸¦æœ‰-default-constructor-çš„-base-class">å¸¦æœ‰ Default Constructor çš„ Base Class</h3><p>ç±»ä¼¼çš„é“ç†ï¼Œå¦‚æœä¸€ä¸ªæ²¡æœ‰ä»»ä½• constructors çš„ class æ´¾ç”Ÿè‡ªä¸€ä¸ªâ€œå¸¦æœ‰ default constructor'â€çš„ base classï¼Œé‚£ä¹ˆè¿™ä¸ª derived class çš„ default constructor ä¼šè¢«è§†ä¸º nontrivialï¼Œå¹¶å› æ­¤éœ€è¦è¢«åˆæˆå‡ºæ¥ã€‚å®ƒå°†è°ƒç”¨ä¸Šä¸€å±‚ base classes çš„ default constructorï¼ˆæ ¹æ®å®ƒä»¬çš„å£°æ˜æ¬¡åºï¼‰ã€‚</p><p>å¦‚æœè®¾è®¡è€…æä¾›å¤šä¸ª constructorsï¼Œä½†å…¶ä¸­éƒ½æ²¡æœ‰ default constructor å‘¢ï¼Ÿç¼–è¯‘å™¨ä¼šæ‰©å¼ ç°æœ‰çš„æ¯ä¸€ä¸ª constructorsï¼Œå°†â€œç”¨ä»¥è°ƒç”¨æ‰€æœ‰å¿…è¦ä¹‹ default constructorsâ€çš„ç¨‹åºä»£ç åŠ è¿›å»ã€‚å®ƒä¸ä¼šåˆæˆä¸€ä¸ªæ–°çš„ default constructorï¼Œè¿™æ˜¯å› ä¸ºå…¶å®ƒâ€œç”± user æ‰€æä¾›çš„ constructorsâ€å­˜åœ¨çš„ç¼˜æ•…ã€‚</p><p>å¦‚æœåŒæ—¶äº¦å­˜åœ¨ç€â€œå¸¦æœ‰ default constructorsâ€çš„ member class objectsï¼Œé‚£äº› default constructor ä¹Ÿä¼šè¢«è°ƒç”¨-â€”åœ¨æ‰€æœ‰ base class constructor éƒ½è¢«è°ƒç”¨ä¹‹åã€‚</p><h3 id="å¸¦æœ‰ä¸€ä¸ª-virtual-function-çš„-class">å¸¦æœ‰ä¸€ä¸ª Virtual Function çš„ Class</h3><ul><li>class å£°æ˜ï¼ˆæˆ–ç»§æ‰¿ï¼‰ä¸€ä¸ª virtual function</li><li>class æ´¾ç”Ÿè‡ªä¸€ä¸ªç»§æ‰¿ä¸²é“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆ–æ›´å¤šçš„ virtual base classes</li></ul><p>ä¸ç®¡å“ªä¸€ç§æƒ…å†µï¼Œç”±äºç¼ºä¹ç”± user å£°æ˜çš„ constructorsï¼Œç¼–è¯‘å™¨ä¼šè¯¦ç»†è®°å½•åˆæˆä¸€ä¸ª default constructor çš„å¿…è¦ä¿¡æ¯ã€‚</p><ul><li>ä¸€ä¸ª virtual function tableï¼ˆåœ¨ cfront ä¸­è¢«ç§°ä¸º vtblï¼‰ä¼šè¢«ç¼–è¯‘å™¨äº§ç”Ÿå‡ºæ¥ï¼Œå†…æ”¾ class çš„ virtual functions åœ°å€</li><li>åœ¨æ¯ä¸€ä¸ª class object ä¸­ï¼Œä¸€ä¸ªé¢å¤–çš„ pointer memberï¼ˆä¹Ÿå°±æ˜¯ vptrï¼‰ä¼šè¢«ç¼–è¯‘å™¨åˆæˆå‡ºæ¥ï¼Œå†…å«ç›¸å…³çš„ class vtbl çš„åœ°å€</li></ul><h3 id="å¸¦æœ‰ä¸€ä¸ª-virtual-base-class-çš„-class">å¸¦æœ‰ä¸€ä¸ª Virtual Base Class çš„ Class</h3><p>Virtual base class çš„å®ç°æ³•åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¹‹é—´æœ‰æå¤§çš„å·®å¼‚ã€‚ç„¶è€Œï¼Œæ¯ä¸€ç§å®ç°æ³•çš„å…±é€šç‚¹åœ¨äºå¿…é¡»ä½¿ virtual base class åœ¨å…¶æ¯ä¸€ä¸ª derived class object ä¸­çš„ä½ç½®ï¼Œèƒ½å¤Ÿäºæ‰§è¡ŒæœŸå‡†å¤‡å¦¥å½“ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ®µç¨‹åºä»£ç ä¸­ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span> {<span class="keyword">public</span>:<span class="type">int</span> i;};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> <span class="keyword">virtual</span> X {<span class="keyword">public</span>:<span class="type">int</span> j;};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> <span class="keyword">virtual</span> X {<span class="keyword">public</span>:<span class="type">double</span> d;};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> : <span class="keyword">public</span> A,<span class="keyword">public</span> B {<span class="keyword">public</span>:<span class="type">int</span> k;};</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ— æ³•åœ¨ç¼–è¯‘æ—¶æœŸå†³å®šï¼ˆresolveï¼‰å‡º pa-&gt;X::i çš„ä½ç½®</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">const</span> A *pa)</span> </span>{ pa-&gt;i = <span class="number">1024</span>;};</span><br><span class="line"></span><br><span class="line"><span class="built_in">main</span>()</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">foo</span>(<span class="keyword">new</span> A);</span><br><span class="line">    <span class="built_in">foo</span>(<span class="keyword">new</span> C);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åŸå…ˆ cfront çš„åšæ³•æ˜¯é â€œåœ¨ derived class object çš„æ¯ä¸€ä¸ª virtual base classes ä¸­å®‰æ’ä¸€ä¸ªæŒ‡é’ˆâ€å®Œæˆã€‚æ‰€æœ‰â€œç»ç”± reference æˆ– pointer æ¥å­˜å–ä¸€ä¸ª virtual base classâ€çš„æ“ä½œéƒ½å¯ä»¥é€šè¿‡ç›¸å…³æŒ‡é’ˆå®Œæˆã€‚foo() å¯ä»¥è¢«æ”¹å†™å¦‚ä¸‹ï¼Œä»¥ç¬¦åˆè¿™æ ·çš„å®ç°ç­–ç•¥ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯èƒ½çš„ç¼–è¯‘å™¨è½¬å˜æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">const</span> A*pa)</span> </span>{pa-&gt;__vbcX-&gt;i = <span class="number">1024</span>;}</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­__vbcX è¡¨ç¤ºç¼–è¯‘å™¨æ‰€äº§ç”Ÿçš„æŒ‡é’ˆï¼ŒæŒ‡å‘ virtual base class Xã€‚æ­£å¦‚ä½ æ‰€è‡†æµ‹çš„é‚£æ ·ï¼Œ__vbcXï¼ˆæˆ–ç¼–è¯‘å™¨æ‰€åšå‡ºçš„æŸä¸ªä»€ä¹ˆä¸œè¥¿ï¼‰æ˜¯åœ¨ class object å»ºæ„æœŸé—´è¢«å®Œæˆçš„ã€‚å¯¹äº class æ‰€å®šä¹‰çš„æ¯ä¸€ä¸ª constructorï¼Œç¼–è¯‘å™¨ä¼šå®‰æ’é‚£äº›â€œå…è®¸æ¯ä¸€ä¸ª virtual base class çš„æ‰§è¡ŒæœŸå­˜å–æ“ä½œâ€çš„ç ã€‚å¦‚æœ class æ²¡æœ‰å£°æ˜ä»»ä½• constructorsï¼Œç¼–è¯‘å™¨å¿…é¡»ä¸ºå®ƒåˆæˆä¸€ä¸ª default constructorã€‚</p><h2 id="copy-constructor-çš„å»ºæ„æ“ä½œ">Copy Constructor çš„å»ºæ„æ“ä½œ</h2><p>æœ‰ä¸‰ç§æƒ…å†µï¼Œä¼šä»¥ä¸€ä¸ª object çš„å†…å®¹ä½œä¸ºå¦ä¸€ä¸ª class object çš„åˆå€¼ã€‚æœ€æ˜æ˜¾çš„ä¸€ç§æƒ…å†µå½“ç„¶å°±æ˜¯å¯¹ä¸€ä¸ª object åšæ˜ç¡®çš„åˆå§‹åŒ–æ“ä½œï¼Œå¦ä¸¤ç§æƒ…å†µæ˜¯å½“ object è¢«å½“ä½œå‚æ•°äº¤ç»™æŸä¸ªå‡½æ•°ä»¥åŠå½“å‡½æ•°ä¼ å›ä¸€ä¸ª class object æ—¶ã€‚</p><h3 id="default-memberwise-initialization">Default Memberwise Initialization</h3><p>å¦‚æœ class æ²¡æœ‰æä¾›ä¸€ä¸ª explicit copy constructor åˆå½“å¦‚ä½•ï¼Ÿå½“ class object ä»¥â€œç›¸åŒ class çš„å¦ä¸€ä¸ª objectâ€ä½œä¸ºåˆå€¼æ—¶ï¼Œå…¶å†…éƒ¨æ˜¯ä»¥æ‰€è°“çš„ default memberwise initializatior æ‰‹æ³•å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯æŠŠæ¯ä¸€ä¸ªå†…å»ºçš„æˆ–æ´¾ç”Ÿçš„ datamemberï¼ˆä¾‹å¦‚ä¸€ä¸ªæŒ‡é’ˆæˆ–æ•°ç›®ç»„ï¼‰çš„å€¼ï¼Œä»æŸä¸ª object æ‹·è´ä¸€ä»½åˆ°å¦ä¸€ä¸ª object èº«ä¸Šã€‚ä¸è¿‡å®ƒå¹¶ä¸ä¼šæ‹·è´å…¶ä¸­çš„ member class objectï¼Œè€Œæ˜¯ä»¥é€’å½’çš„æ–¹å¼æ–½è¡Œ memberwise initializaonã€‚</p><p>å¦‚æœä¸€ä¸ª String object è¢«å£°æ˜ä¸ºå¦ä¸€ä¸ª class çš„ memberï¼Œåƒè¿™æ ·ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Word</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//â€¦â€¦æ²¡æœ‰ explicit copy constructorprivate:</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _occurs;</span><br><span class="line">    string _wordï¼›<span class="comment">//è¯‘æ³¨ï¼šString object æˆä¸º class Word çš„ä¸€ä¸ª member!</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆä¸€ä¸ª Word object çš„ default memberwise initialization ä¼šæ‹·è´å…¶å†…å»ºçš„ member _occursï¼Œç„¶åå†äº String member object_word èº«ä¸Šé€’å½’å®æ–½ memberwise initialization</p><p>å°±åƒ default constructor ä¸€æ ·ï¼ŒC++ Standard ä¸Šè¯´ï¼Œå¦‚æœ class æ²¡æœ‰å£°æ˜ä¸€ä¸ª copy constructorï¼Œå°±ä¼šæœ‰éšå«çš„å£°æ˜ï¼ˆimplicitly declaredï¼‰æˆ–éšå«çš„å®šä¹‰ï¼ˆimplicitlydefinedï¼‰å‡ºç°ã€‚å’Œä»¥å‰ä¸€æ ·ï¼ŒC++Standard æŠŠ copy constructor åŒºåˆ†ä¸º trivial å’Œ nontrivial ä¸¤ç§ã€‚åªæœ‰ nontrivial çš„å®ä½“æ‰ä¼šè¢«åˆæˆäºç¨‹åºä¹‹ä¸­ã€‚å†³å®šä¸€ä¸ª copy constructor æ˜¯å¦ä¸º trivial çš„æ ‡å‡†åœ¨äº class æ˜¯å¦å±•ç°å‡ºæ‰€è°“çš„â€œbitwise copysemantics'â€ã€‚</p><h3 id="bitwise-copy-semanticsä½é€æ¬¡æ‹·è´">Bitwise Copy Semanticsï¼ˆä½é€æ¬¡æ‹·è´ï¼‰</h3><p>åœ¨ä¸‹é¢çš„ç¨‹åºç‰‡æ®µä¸­ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Word.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">Word <span class="title">noun</span><span class="params">(<span class="string">"book"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Word verb = noun;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¾ˆæ˜æ˜¾ verb æ˜¯æ ¹æ® noun æ¥åˆå§‹åŒ–ã€‚ä½†æ˜¯åœ¨å°šæœªçœ‹è¿‡ class Word çš„å£°æ˜ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¯èƒ½é¢„æµ‹è¿™ä¸ªåˆå§‹åŒ–æ“ä½œçš„ç¨‹åºè¡Œä¸ºã€‚å¦‚æœ class Word çš„è®¾è®¡è€…å®šä¹‰äº†ä¸€ä¸ª copy constructorï¼Œverb çš„åˆå§‹åŒ–æ“ä½œä¼šè°ƒç”¨å®ƒã€‚ä½†å¦‚æœè¯¥ class æ²¡æœ‰å®šä¹‰ explicit copy constructorï¼Œé‚£ä¹ˆæ˜¯å¦ä¼šæœ‰ä¸€ä¸ªç¼–è¯‘å™¨åˆæˆçš„å®ä½“è¢«è°ƒç”¨å‘¢ï¼Ÿè¿™å°±å¾—è§†è¯¥ class æ˜¯å¦å±•ç°"bitwise copy semantics'â€è€Œå®šã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå·²çŸ¥ä¸‹é¢çš„ class Word å£°æ˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»¥ä¸‹å£°æ˜å±•ç°äº† bitwise copy semantic</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Word</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Word</span>(<span class="type">const</span> <span class="type">char</span>*)</span><br><span class="line">    ~<span class="built_in">Word</span>() {<span class="keyword">delete</span>[] str;}</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> cnt;</span><br><span class="line">    <span class="type">char</span> *str;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç§æƒ…å†µä¸‹å¹¶ä¸éœ€è¦åˆæˆå‡ºä¸€ä¸ª default copy constructorï¼Œå› ä¸ºä¸Šè¿°å£°æ˜å±•ç°äº†â€œdefault copy semanticsâ€ï¼Œè€Œ verb çš„åˆå§‹åŒ–æ“ä½œä¹Ÿå°±ä¸éœ€è¦ä»¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ”¶åœºã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ çš„ class ä»…åŒ…å«äº† PODï¼ˆPlain Object Data) è¿™æ ·çš„ï¼Œæ˜¯å±•ç°å‡ºäº† Bitwise Copy Semanticsï¼Œå³ç¼–è¯‘å™¨åœ¨å†…éƒ¨å¯ä»¥ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„æ‹·è´ï¼ˆå¦‚ memcpyï¼‰ä¹Ÿä¸ä¼šå‡ºç°é—®é¢˜ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœ class Word æ˜¯è¿™æ ·å£°æ˜ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»¥ä¸‹å£°æ˜å¹¶æœªå±•ç°å‡º bitwise copy semantics</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Word</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Word</span>(<span class="type">const</span> String&amp;)</span><br><span class="line">    ~<span class="built_in">Word</span>();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> cnt;</span><br><span class="line">    String str;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ String å£°æ˜äº†ä¸€ä¸ª explicit copy constructorï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">String</span>(<span class="type">const</span> <span class="type">char</span>* );</span><br><span class="line">    <span class="built_in">String</span>(<span class="type">const</span> String&amp;);</span><br><span class="line">    ~<span class="built_in">String</span>();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¿…é¡»åˆæˆå‡ºä¸€ä¸ª copy constructor ä»¥ä¾¿è°ƒç”¨ member class String object çš„ copy constructorï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸€ä¸ªè¢«åˆæˆå‡ºæ¥çš„ copy constructor</span></span><br><span class="line"><span class="comment">//C++ä¼ªç </span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">Word::Word</span><span class="params">(<span class="type">const</span> Word&amp; wd)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    str.String::<span class="built_in">String</span>(wd.str);</span><br><span class="line">    cnt = wd.cnt;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æœ‰ä¸€ç‚¹å¾ˆå€¼å¾—æ³¨æ„ï¼šåœ¨è¿™è¢«åˆæˆå‡ºæ¥çš„ copy constructor ä¸­ï¼Œå¦‚æ•´æ•°ã€æŒ‡é’ˆã€æ•°ç»„ç­‰ç­‰çš„ nonclass members ä¹Ÿéƒ½ä¼šè¢«å¤åˆ¶ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€æœŸå¾…çš„ä¸€æ ·ã€‚</p><h3 id="ä¸è¦-bitwise-copy-semantics">ä¸è¦ Bitwise Copy Semanticsï¼</h3><p>ä»€ä¹ˆæ—¶å€™ä¸€ä¸ª class ä¸å±•ç°å‡ºâ€œbitwise copy semanticsâ€å‘¢ï¼Ÿæœ‰å››ç§æƒ…å†µï¼š</p><ul><li>å½“ class å†…å«ä¸€ä¸ª member object è€Œåè€…çš„ class å£°æ˜æœ‰ä¸€ä¸ª copy constructor æ—¶ï¼ˆä¸è®ºæ˜¯è¢« class è®¾è®¡è€…æ˜ç¡®åœ°å£°æ˜ï¼Œå°±åƒå‰é¢çš„ String é‚£æ ·ï¼›æˆ–æ˜¯è¢«ç¼–è¯‘å™¨åˆæˆï¼Œåƒ class Word é‚£æ ·ï¼‰ã€‚</li><li>å½“ class ç»§æ‰¿è‡ªä¸€ä¸ª base class è€Œåè€…å­˜åœ¨æœ‰ä¸€ä¸ª copy constructor æ—¶ï¼ˆå†æ¬¡å¼ºè°ƒï¼Œä¸è®ºæ˜¯è¢«æ˜ç¡®å£°æ˜æˆ–æ˜¯è¢«åˆæˆè€Œå¾—ï¼‰ã€‚</li><li>å½“ class å£°æ˜äº†ä¸€ä¸ªæˆ–å¤šä¸ª virtual functions æ—¶ã€‚</li><li>å½“ class æ´¾ç”Ÿè‡ªä¸€ä¸ªç»§æ‰¿ä¸²é“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª virtual base classes æ—¶ã€‚</li></ul><p>å‰ä¸¤ç§æƒ…å†µä¸­ï¼Œç¼–è¯‘å™¨å¿…é¡»å°† member æˆ– base class çš„â€œcopy constructors è°ƒç”¨æ“ä½œâ€å®‰æ’åˆ°è¢«åˆæˆçš„ copy constructor ä¸­ã€‚å‰ä¸€èŠ‚ class Word çš„â€œåˆæˆè€Œå¾—çš„ copy constructorâ€æ­£è¶³ä»¥è¯´æ˜æƒ…å†µ 1,2ã€‚æƒ…å†µ 3 å’Œ 4 æœ‰ç‚¹å¤æ‚ï¼Œæ˜¯æˆ‘æ¥ä¸‹æ¥è¦è®¨è®ºçš„é¢˜ç›®ã€‚</p><p><strong>é‡æ–°è®¾å®š Virtual Table çš„æŒ‡é’ˆ</strong><br>å›å¿†ç¼–è¯‘æœŸé—´çš„ä¸¤ä¸ªç¨‹åºæ‰©å¼ æ“ä½œï¼ˆåªè¦æœ‰ä¸€ä¸ª class å£°æ˜äº†ä¸€ä¸ªæˆ–å¤šä¸ª virtual functions å°±ä¼šå¦‚æ­¤ï¼‰ï¼š</p><ul><li>å¢åŠ ä¸€ä¸ª virtual function tableï¼ˆvtblï¼‰ï¼Œå†…å«æ¯ä¸€ä¸ªæœ‰ä½œç”¨çš„ virtual function çš„åœ°å€ã€‚</li><li>å°†ä¸€ä¸ªæŒ‡å‘ virtual function table çš„æŒ‡é’ˆï¼ˆvptrï¼‰ï¼Œå®‰æ’åœ¨æ¯ä¸€ä¸ª class object å†…ã€‚</li></ul><p>å¾ˆæ˜¾ç„¶ï¼Œå¦‚æœç¼–è¯‘å™¨å¯¹äºæ¯ä¸€ä¸ªæ–°äº§ç”Ÿçš„ class object çš„ vptr ä¸èƒ½æˆåŠŸè€Œæ­£ç¡®åœ°è®¾å¥½å…¶åˆå€¼ï¼Œå°†å¯¼è‡´å¯æ€•çš„åæœã€‚å› æ­¤ï¼Œå½“ç¼–è¯‘å™¨å¯¼å…¥ä¸€ä¸ª vptr åˆ° class ä¹‹ä¸­æ—¶ï¼Œè¯¥ class å°±ä¸å†å±•ç° bitwise semantics äº†ã€‚ç°åœ¨ï¼Œç¼–è¯‘å™¨éœ€è¦åˆæˆå‡ºä¸€ä¸ª copy constructorï¼Œä»¥æ±‚å°† vptr é€‚å½“åœ°åˆå§‹åŒ–ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo6.png"></p><p>yogi ä¼šè¢« default Bear constructor åˆå§‹åŒ–ã€‚è€Œåœ¨ constructor ä¸­ï¼Œyogi çš„ vptr è¢«è®¾å®šæŒ‡å‘ Bear class çš„ virtual tableï¼ˆé ç¼–è¯‘å™¨å®‰æ’çš„ç å®Œæˆï¼‰ã€‚å› æ­¤ï¼ŒæŠŠ yogi çš„ vptr å€¼æ‹·è´ç»™ winnie çš„ vptr æ˜¯å®‰å…¨çš„ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo7.png"> åˆæˆå‡ºæ¥çš„ ZooAnimal copy constructor ä¼šæ˜ç¡®è®¾å®š object çš„ vptr æŒ‡å‘ ZooAnimal class çš„ virtual tableï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å³æ‰‹è¾¹çš„ class object ä¸­å°†å…¶ vptr ç°å€¼æ‹·è´è¿‡æ¥ã€‚</p><h1 id="data-è¯­æ„å­¦">Data è¯­æ„å­¦</h1><h2 id="ç±»å¯¹è±¡å¤§å°å—ä¸‰ä¸ªå› ç´ å½±å“">ç±»å¯¹è±¡å¤§å°å—ä¸‰ä¸ªå› ç´ å½±å“</h2><ul><li>virtual base å’Œ virtual function å¸¦æ¥çš„ vptr å½±å“</li><li>EBOï¼ˆEmpty Base class Optimizeï¼‰ç©ºåŸºç±»ä¼˜åŒ–å¤„ç†ï¼ŒEBCï¼ˆEmpty Base Classï¼‰å ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œå…¶ä»–å«æœ‰æ•°æ®æˆå‘˜çš„ä» EBC æ´¾ç”Ÿçš„æ´¾ç”Ÿç±»ï¼Œåªä¼šç®—è‡ªå·±æ•°æ®æˆå‘˜çš„å¤§å°ï¼Œä¸å— EBC ä¸€å­—èŠ‚çš„å½±å“</li><li>alignment å­—èŠ‚å¯¹é½</li></ul><h2 id="nonstatic-data-members">Nonstatic data members</h2><ul><li>Nonstatic data members åœ¨ class object ä¸­çš„æ’åˆ—é¡ºåºå°†å’Œå…¶è¢«å£°æ˜é¡ºåºä¸€æ ·ï¼Œä»»ä½•ä¸­é—´ä»‹å…¥çš„ static data members éƒ½ä¸ä¼šè¢«æ”¾è¿›å¸ƒå±€ä¹‹ä¸­</li><li>æ¯ä¸€ä¸ª nonstatic data member çš„åç§»é‡åœ¨ç¼–è¯‘æ—¶å³å¯è·çŸ¥ï¼Œä¸ç®¡å…¶æœ‰å¤šä¹ˆå¤æ‚çš„æ´¾ç”Ÿï¼Œéƒ½æ˜¯ä¸€æ ·çš„ã€‚é€šè¿‡å¯¹è±¡å­˜å–ä¸€ä¸ª nonstatic data memberï¼Œå…¶æ•ˆç‡å’Œå­˜å–ä¸€ä¸ª C struct member æ˜¯ä¸€æ ·çš„</li><li>ä»å¯¹è±¡å­˜å– obj.x å’ŒæŒ‡é’ˆå­˜å– pt-&gt;x æœ‰å’Œå·®å¼‚ï¼Ÿ å½“ç»§æ‰¿é“¾ä¸­æœ‰è™šåŸºç±»æ—¶ï¼ŒæŸ¥æ‰¾è™šåŸºç±»çš„æˆå‘˜å˜é‡æ—¶å»¶è¿Ÿåˆ°äº†æ‰§è¡ŒæœŸï¼Œæ ¹æ® virtual class offset æŸ¥æ‰¾åˆ°è™šåŸºç±»çš„éƒ¨åˆ†ï¼Œæ•ˆç‡ç¨ä½</li></ul><h2 id="é™æ€æˆå‘˜å˜é‡-static-data-members">é™æ€æˆå‘˜å˜é‡ static data members</h2><ul><li>å­˜æ”¾åœ¨ç¨‹åºçš„ data segment ä¹‹ä¸­</li><li>é€šè¿‡æŒ‡é’ˆå’Œå¯¹è±¡æ¥å­˜å– memberï¼Œå®Œå…¨ä¸€æ ·ï¼Œä¸ç®¡ç»§æ‰¿æˆ–è€…æ˜¯è™šæ‹Ÿç»§æ‰¿å¾—æ¥ï¼Œå…¨å±€ä¹Ÿåªå­˜åœ¨å”¯ä¸€ä¸€ä¸ªå®ä¾‹</li><li>é™æ€å¸¸é‡æˆå‘˜å¯ä»¥åœ¨ç±»å®šä¹‰æ—¶ç›´æ¥åˆå§‹åŒ–ï¼Œè€Œæ™®é€šé™æ€å¸¸é‡æˆå‘˜åªèƒ½åœ¨ã€‚o ç¼–è¯‘å•å…ƒçš„å…¨å±€èŒƒå›´å†…åˆå§‹åŒ–</li></ul><h2 id="è¿·æ‰¿ä¸-data-member">â€œè¿·æ‰¿â€ä¸ Data Member</h2><h4 id="åªè¦ç»§æ‰¿ä¸è¦å¤šæ€inheritance-without-polymorphism">åªè¦ç»§æ‰¿ä¸è¦å¤šæ€ï¼ˆInheritance without Polymorphismï¼‰</h4><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Concrete</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="type">char</span> c1;</span><br><span class="line">    <span class="type">char</span> c2;</span><br><span class="line">    <span class="type">char</span> c3;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo8.png"></p><p>åœ¨ä¸€éƒ¨ 32 ä½æœºå™¨ä¸­ï¼Œæ¯ä¸€ä¸ª Concrete class object çš„å¤§å°éƒ½æ˜¯ 8 bytesï¼Œç»†åˆ†å¦‚ä¸‹ï¼š</p><ul><li>val å ç”¨ 4 bytes</li><li>c1ã€c2 å’Œ c3 å„å ç”¨ 1 bytes</li><li>alignmentï¼ˆè°ƒæ•´åˆ° word è¾¹ç•Œï¼‰éœ€è¦ 1 bytes</li></ul><p>ç°åœ¨å‡è®¾ï¼Œç»è¿‡æŸäº›åˆ†æä¹‹åï¼Œæˆ‘ä»¬å†³å®šäº†ä¸€ä¸ªæ›´é€»è¾‘çš„è¡¨è¾¾æ–¹å¼ï¼ŒæŠŠ Concrete åˆ†è£‚ä¸ºä¸‰å±‚ç»“æ„ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Concrete1</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//.â€¦</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="type">char</span> bit1;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Concrete2</span> : <span class="keyword">public</span> Concrete1</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">char</span> bit2;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Concrete3</span> : <span class="keyword">public</span> Concrete2</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">char</span> bit3;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>Concrete1 å†…å«ä¸¤ä¸ª membersï¼šval å’Œ bit1ï¼ŒåŠ èµ·æ¥æ˜¯ 5 bytesã€‚è€Œä¸€ä¸ª Concrete.object å®é™…ç”¨æ‰ 8 bytesï¼ŒåŒ…æ‹¬å¡«è¡¥ç”¨çš„ 3 bytesï¼Œä»¥ä½¿ object èƒ½å¤Ÿç¬¦åˆä¸€éƒ¨æœºå™¨çš„ word è¾¹ç•Œã€‚ä¸è®ºæ˜¯ C æˆ– C++éƒ½æ˜¯è¿™æ ·ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè¾¹ç•Œè°ƒæ•´ï¼ˆalignmentï¼‰æ˜¯ç”±å¤„ç†å™¨ï¼ˆprocessorï¼‰æ¥å†³å®šçš„ã€‚</p><p>Concrete2 çš„ bit2 å®é™…ä¸Šè¢«æ”¾åœ¨å¡«è¡¥ç©ºé—´æ‰€ç”¨çš„ 3 bytes ä¹‹åã€‚äºæ˜¯å…¶å¤§å°å˜æˆ 12 bytesï¼Œä¸æ˜¯ 8 bytesã€‚å…¶ä¸­æœ‰ 6 bytes æµªè´¹åœ¨å¡«è¡¥ç©ºé—´ä¸Šã€‚ç›¸åŒçš„é“ç†ä½¿å¾— Concrete3 object çš„å¤§å°æ˜¯ 16 bytesï¼Œå…¶ä¸­ 9 bytes ç”¨äºå¡«è¡¥ç©ºé—´ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo9.png"></p><h4 id="å¤šé‡ç»§æ‰¿multiple-inheritance">å¤šé‡ç»§æ‰¿ï¼ˆMultiple Inheritanceï¼‰</h4><p>å¤šé‡ç»§æ‰¿æ—¢ä¸åƒå•ä¸€ç»§æ‰¿ï¼Œä¹Ÿä¸å®¹æ˜“æ¨¡å¡‘å‡ºå…¶æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸‹é¢è¿™ä¸ªå¤šé‡ç»§æ‰¿æ‰€è·å¾—çš„ class Vertex3dï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point2d</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...ï¼ˆè¯‘æ³¨ï¼šæ‹¥æœ‰ virtual æ¥å£ã€‚æ‰€ä»¥ Point2d å¯¹è±¡ä¹‹ä¸­ä¼šæœ‰ Vptrï¼‰</span></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> _x,_y;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point3d</span> : <span class="keyword">public</span> Point2d</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> _z;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vertex</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...ï¼ˆè¯‘æ³¨ï¼šæ‹¥æœ‰ virtual æ¥å£ã€‚æ‰€ä»¥ Point2d å¯¹è±¡ä¹‹ä¸­ä¼šæœ‰ Vptrï¼‰</span></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    Vertex *next;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vertex3d</span> : <span class="keyword">public</span> Point3d ï¼Œ<span class="keyword">public</span> vertex</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> mumble;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo10.png"></p><p>å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo11.png"></p><h4 id="è™šæ‹Ÿç»§æ‰¿-vitual-inheritance">è™šæ‹Ÿç»§æ‰¿ (Vitual Inheritance)</h4><p>ä¸€èˆ¬çš„å®ç°æ–¹æ³•å¦‚ä¸‹æ‰€è¿°ã€‚Class å¦‚æœå†…å«ä¸€ä¸ªæˆ–å¤šä¸ª virtual base class subobjectsï¼Œå°†è¢«åˆ†å‰²ä¸ºä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªä¸å˜å±€éƒ¨å’Œä¸€ä¸ªå…±äº«å±€éƒ¨ã€‚ä¸å˜å±€éƒ¨ä¸­çš„æ•°æ®ï¼Œä¸ç®¡åç»§å¦‚ä½•è¡åŒ–ï¼Œæ€»æ˜¯æ‹¥æœ‰å›ºå®šçš„ offsetï¼ˆä» object çš„å¼€å¤´ç®—èµ·ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸€éƒ¨åˆ†æ•°æ®å¯ä»¥è¢«ç›´æ¥å­˜å–ã€‚è‡³äºå…±äº«å±€éƒ¨ï¼Œæ‰€è¡¨ç°çš„å°±æ˜¯ virtual base class subobjectã€‚è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®ï¼Œå…¶ä½ç½®ä¼šå› ä¸ºæ¯æ¬¡çš„æ´¾ç”Ÿæ“ä½œè€Œæœ‰å˜åŒ–ï¼Œæ‰€ä»¥å®ƒä»¬åªå¯ä»¥è¢«é—´æ¥å­˜å–ã€‚å„å®¶ç¼–è¯‘å™¨å®ç°æŠ€æœ¯ä¹‹é—´çš„å·®å¼‚å°±åœ¨äºé—´æ¥å­˜å–çš„æ–¹æ³•ä¸åŒã€‚ä¸‹é¢æ˜¯ Vertex3d è™šæ‹Ÿç»§æ‰¿çš„å±‚æ¬¡ç»“æ„ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point2d</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...ï¼ˆè¯‘æ³¨ï¼šæ‹¥æœ‰ virtual æ¥å£ã€‚æ‰€ä»¥ Point2d å¯¹è±¡ä¹‹ä¸­ä¼šæœ‰ Vptrï¼‰</span></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> _x,_y;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point3d</span> : <span class="keyword">public</span> vitrual Point2d</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> _z;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vertex</span> : <span class="keyword">public</span> vitrual Point2d</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//ï¼ŒÂ·.ï¼ˆè¯‘æ³¨ï¼šæ‹¥æœ‰ virtual æ¥å£ã€‚æ‰€ä»¥ Vertex å¯¹è±¡ä¹‹ä¸­ä¼šæœ‰ vptrï¼‰</span></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    Vertex *next;</span><br><span class="line">};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vertex3d</span>:: <span class="keyword">public</span> Point3d ï¼Œ<span class="keyword">public</span> vertex</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> mumble;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo12.png"></p><p>å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo13.png"></p><h1 id="function-è¯­æ„å­¦">Function è¯­æ„å­¦</h1><h2 id="cçš„è®¾è®¡å‡†åˆ™ä¹‹ä¸€nostatic-member-function-è‡³å°‘å¿…é¡»å’Œä¸€èˆ¬çš„-nonmember-function-æœ‰ç›¸åŒçš„æ•ˆç‡">C++çš„è®¾è®¡å‡†åˆ™ä¹‹ä¸€ï¼šnostatic member function è‡³å°‘å¿…é¡»å’Œä¸€èˆ¬çš„ nonmember function æœ‰ç›¸åŒçš„æ•ˆç‡</h2><ul><li>æ”¹å†™å‡½æ•°åŸå‹ï¼Œåœ¨å‚æ•°ä¸­å¢åŠ  this æŒ‡é’ˆã€‚</li><li>å¯¹æ¯ä¸€ä¸ª"nonstatic data member çš„å­˜å–æ“ä½œ"æ”¹ä¸ºç”± this æŒ‡é’ˆæ¥å­˜å–ã€‚</li><li>å°† member function é‡å†™ä¸ºä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œç»è¿‡"mangling"å¤„ç†ã€‚</li></ul><h2 id="è¦†ç›–overrideé‡å†™overloadéšè—hideçš„åŒºåˆ«">è¦†ç›–ï¼ˆoverrideï¼‰ã€é‡å†™ï¼ˆoverloadï¼‰ã€éšè—ï¼ˆhideï¼‰çš„åŒºåˆ«</h2><ul><li>é‡è½½æ˜¯æŒ‡ä¸åŒçš„å‡½æ•°ä½¿ç”¨ç›¸åŒçš„å‡½æ•°åï¼Œä½†æ˜¯å‡½æ•°çš„å‚æ•°ä¸ªæ•°æˆ–ç±»å‹ä¸åŒã€‚è°ƒç”¨çš„æ—¶å€™æ ¹æ®å‡½æ•°çš„å‚æ•°æ¥åŒºåˆ«ä¸åŒçš„å‡½æ•°ã€‚</li><li>è¦†ç›–ï¼ˆä¹Ÿå«é‡å†™ï¼‰æ˜¯æŒ‡åœ¨æ´¾ç”Ÿç±»ä¸­é‡æ–°å¯¹åŸºç±»ä¸­çš„è™šå‡½æ•°ï¼ˆæ³¨æ„æ˜¯è™šå‡½æ•°ï¼‰é‡æ–°å®ç°ã€‚å³å‡½æ•°åå’Œå‚æ•°éƒ½ä¸€æ ·ï¼Œåªæ˜¯å‡½æ•°çš„å®ç°ä½“ä¸ä¸€æ ·ã€‚</li><li>éšè—æ˜¯æŒ‡æ´¾ç”Ÿç±»ä¸­çš„å‡½æ•°æŠŠåŸºç±»ä¸­ç›¸åŒåå­—çš„å‡½æ•°å±è”½æ‰äº†ã€‚éšè—ä¸å¦å¤–ä¸¤ä¸ªæ¦‚å¿µè¡¨é¢ä¸Šçœ‹æ¥å¾ˆåƒï¼Œå¾ˆéš¾åŒºåˆ†ï¼Œå…¶å®ä»–ä»¬çš„å…³é”®åŒºåˆ«å°±æ˜¯åœ¨å¤šæ€çš„å®ç°ä¸Šã€‚</li></ul><h2 id="virtual-member-functionsè™šæ‹Ÿæˆå‘˜å‡½æ•°">Virtual Member Functionsï¼ˆè™šæ‹Ÿæˆå‘˜å‡½æ•°ï¼‰</h2><p>æˆ‘ä»¬å·²ç»çœ‹è¿‡äº† virtual function çš„ä¸€èˆ¬å®ç°æ¨¡å‹ï¼šæ¯ä¸€ä¸ª class æœ‰ä¸€ä¸ª virtual tableï¼Œå†…å«è¯¥ class ä¹‹ä¸­æœ‰ä½œç”¨çš„ virtual function çš„åœ°å€ï¼Œç„¶åæ¯ä¸ª object æœ‰ä¸€ä¸ª vptrï¼ŒæŒ‡å‘ virtual table çš„æ‰€åœ¨ã€‚åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘è¦èµ°è®¿ä¸€ç»„å¯èƒ½çš„è®¾è®¡ï¼Œç„¶åæ ¹æ®å•ä¸€ç»§æ‰¿ã€å¤šé‡ç»§æ‰¿å’Œè™šæ‹Ÿç»§æ‰¿ç­‰å„ç§æƒ…å†µï¼Œä»ç»†éƒ¨ä¸Šæ¢ç©¶è¿™ä¸ªæ¨¡å‹ã€ä¸ºäº†æ”¯æŒ virtual function æœºåˆ¶ï¼Œå¿…é¡»é¦–å…ˆèƒ½å¤Ÿå¯¹äºå¤šæ€å¯¹è±¡æœ‰æŸç§å½¢å¼çš„â€œæ‰§è¡ŒæœŸç±»å‹åˆ¤æ–­æ³•ï¼ˆruntime type resolutionï¼‰â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥ä¸‹çš„è°ƒç”¨æ“ä½œå°†éœ€è¦ ptr åœ¨æ‰§è¡ŒæœŸçš„æŸäº›ç›¸å…³ä¿¡æ¯ï¼Œ</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;<span class="built_in">z</span>();</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æ­¤ä¸€æ¥æ‰èƒ½å¤Ÿæ‰¾åˆ°å¹¶è°ƒç”¨ z() çš„é€‚å½“å®ä½“ã€‚æˆ–è®¸æœ€ç›´æ¥äº†å½“ä½†æ˜¯æˆæœ¬æœ€é«˜çš„è§£å†³æ–¹æ³•å°±æ˜¯æŠŠå¿…è¦çš„ä¿¡æ¯åŠ åœ¨ ptr èº«ä¸Šã€‚åœ¨è¿™æ ·çš„ç­–ç•¥ä¹‹ä¸‹ï¼Œä¸€ä¸ªæŒ‡é’ˆï¼ˆæˆ–æ˜¯ä¸€ä¸ª referenceï¼‰å«æœ‰ä¸¤é¡¹ä¿¡æ¯ï¼š</p><ul><li>å®ƒæ‰€å‚è€ƒåˆ°çš„å¯¹è±¡çš„åœ°å€ã€‚</li><li>å¯¹è±¡ç±»å‹çš„æŸç§ç¼–ç ï¼Œæˆ–æ˜¯æŸä¸ªç»“æ„çš„åœ°å€ã€‚</li></ul><p>è¿™ä¸ªæ–¹æ³•å¸¦æ¥ä¸¤ä¸ªé—®é¢˜</p><ul><li>ç¬¬ä¸€ï¼Œå®ƒæ˜æ˜¾å¢åŠ äº†ç©ºé—´è´Ÿæ‹…ï¼Œå³ä½¿ç¨‹åºå¹¶ä¸ä½¿ç”¨å¤šæ€ï¼ˆpolymorphismï¼‰ã€‚</li><li>ç¬¬äºŒï¼Œå®ƒæ‰“æ–­äº†ä¸ C ç¨‹åºé—´çš„é“¾æ¥å…¼å®¹æ€§ã€‚å¦‚æœè¿™ä»½é¢å¤–ä¿¡æ¯ä¸èƒ½å¤Ÿå’ŒæŒ‡é’ˆæ”¾åœ¨ä¸€èµ·ï¼Œä¸‹ä¸€ä¸ªå¯ä»¥è€ƒè™‘çš„åœ°æ–¹å°±æ˜¯æŠŠå®ƒæ”¾åœ¨å¯¹è±¡æœ¬èº«ã€‚</li></ul><p>æ¬²é‰´å®šå“ªäº› classes å±•ç°å¤šæ€ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„æ‰§è¡ŒæœŸä¿¡æ¯ã€‚ä¸€å¦‚æˆ‘æ‰€è¯´ï¼Œå…³é”®è¯ class å’Œ struct å¹¶ä¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ã€‚ç”±äºæ²¡æœ‰å¯¼å…¥å¦‚ polymorphic ä¹‹ç±»çš„æ–°å…³é”®è¯ï¼Œå› æ­¤è¯†åˆ«ä¸€ä¸ª class æ˜¯å¦æ”¯æŒå¤šæ€ï¼Œå”¯ä¸€é€‚å½“çš„æ–¹æ³•å°±æ˜¯çœ‹çœ‹å®ƒæ˜¯å¦æœ‰ä»»ä½• virtual functionã€‚åªè¦ class æ‹¥æœ‰ä¸€ä¸ª virtual functionï¼Œå®ƒå°±éœ€è¦è¿™ä»½é¢å¤–çš„æ‰§è¡ŒæœŸä¿¡æ¯ã€‚</p><p>ä¸‹ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜æ˜¯ï¼Œä»€ä¹ˆæ ·çš„é¢å¤–ä¿¡æ¯æ˜¯æˆ‘ä»¬éœ€è¦å­˜å‚¨èµ·æ¥çš„ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘æœ‰è¿™æ ·çš„è°ƒç”¨ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;<span class="built_in">z</span>();</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ z() æ˜¯ä¸€ä¸ª virtual functionï¼Œé‚£ä¹ˆä»€ä¹ˆä¿¡æ¯æ‰èƒ½è®©æˆ‘ä»¬åœ¨æ‰§è¡ŒæœŸè°ƒç”¨æ­£ç¡®çš„ z() å®ä½“ï¼Ÿæˆ‘éœ€è¦çŸ¥é“ï¼š</p><ul><li>ptr æ‰€æŒ‡å¯¹è±¡çš„çœŸå®ç±»å‹ã€‚è¿™å¯ä½¿æˆ‘ä»¬é€‰æ‹©æ­£ç¡®çš„ z() å®ä½“ã€‚</li><li>z() å®ä½“ä½ç½®ï¼Œä»¥ä¾¿æˆ‘èƒ½å¤Ÿè°ƒç”¨å®ƒã€‚</li></ul><p>é‚£ä¹ˆï¼Œæˆ‘å¦‚ä½•æœ‰è¶³å¤Ÿçš„çŸ¥è¯†åœ¨ç¼–è¯‘æ—¶æœŸè®¾å®š virtual function çš„è°ƒç”¨å‘¢ï¼Ÿ</p><ul><li>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘å¹¶ä¸çŸ¥é“ ptr æ‰€æŒ‡å¯¹è±¡çš„çœŸæ­£ç±»å‹ï¼Œç„¶è€Œæˆ‘çŸ¥é“ï¼Œç»ç”± ptr å¯ä»¥å­˜å–åˆ°è¯¥å¯¹è±¡çš„ virtual tableã€‚è™½ç„¶æˆ‘ä¸çŸ¥é“å“ªä¸€ä¸ª z() å‡½æ•°å®ä½“ä¼šè¢«è°ƒç”¨ï¼Œä½†æˆ‘çŸ¥é“æ¯ä¸€ä¸ª z() å‡½æ•°åœ°å€éƒ½è¢«æ”¾åœ¨ slot4ã€‚è¿™äº›ä¿¡æ¯ä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥å°†è¯¥è°ƒç”¨è½¬åŒ–ä¸ºï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ptr-&gt;vptr[<span class="number">4</span>]) (ptr );</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ä¸ªè½¬åŒ–ä¸­ï¼Œptr è¡¨ç¤ºç¼–è¯‘å™¨æ‰€å®‰çš„æŒ‡é’ˆï¼ŒæŒ‡å‘ virtual tableï¼›4 è¡¨ç¤º z() è¢«èµ‹å€¼çš„ slot ç¼–å·ï¼ˆå…³è”åˆ° Point ä½“ç³»çš„ virtual tableï¼‰å”¯ä¸€ä¸ªåœ¨æ‰§è¡ŒæœŸæ‰èƒ½çŸ¥é“çš„ä¸œè¥¿æ˜¯ï¼šslot4 æ‰€æŒ‡çš„åˆ°åº•æ˜¯å“ªä¸€ä¸ª z() å‡½æ•°å®ä½“ï¼Ÿ</p><p>åœ¨ä¸€ä¸ªå•ä¸€ç»§æ‰¿ä½“ç³»ä¸­ï¼Œvirtual function æœºåˆ¶çš„è¡Œä¸ºååˆ†è‰¯å¥½ï¼Œä¸ä½†æœ‰æ•ˆç‡è€Œä¸”å¾ˆå®¹æ˜“å¡‘é€ å‡ºæ¨¡å‹æ¥ã€‚ä½†æ˜¯åœ¨å¤šé‡ç»§æ‰¿å’Œè™šæ‹Ÿç»§æ‰¿ä¹‹ä¸­ï¼Œå¯¹ virtual functions çš„æ”¯æŒå°±æ²¡æœ‰é‚£ä¹ˆç¾å¥½äº†ã€‚</p><h3 id="å¤šé‡ç»§æ‰¿ä¸‹çš„-virtual-functions">å¤šé‡ç»§æ‰¿ä¸‹çš„ Virtual Functions</h3><p>åœ¨å¤šé‡ç»§æ‰¿ä¸­æ”¯æŒ virtual functionsï¼Œå…¶å¤æ‚åº¦å›´ç»•åœ¨ç¬¬äºŒä¸ªåŠåç»§çš„ base classes èº«ä¸Šï¼Œä»¥åŠâ€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´ this æŒ‡é’ˆâ€è¿™ä¸€ç‚¹ã€‚ä»¥ä¸‹é¢çš„ class ä½“ç³»ä¸ºä¾‹ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class ä½“ç³»ï¼Œç”¨æ¥æè¿°å¤šé‡ç»§æ‰¿ï¼ˆMIï¼‰æƒ…å†µä¸‹æ”¯æŒ virtual function æ—¶çš„å¤æ‚åº¦</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base1</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base1</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">speakclearly</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Base1 *<span class="title">clone</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> data_Base1;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base2</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base2</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mumble</span> <span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Base2 *<span class="title">clone</span><span class="params">()</span><span class="type">const</span></span>;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> data_Base2;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base1,<span class="keyword">public</span> Base2</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Derived</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Derived *<span class="title">clone</span> <span class="params">()</span><span class="type">const</span></span>;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">float</span> data_Derived;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo15.png"></p><p>â€œDerived æ”¯æŒ virtual functionsâ€çš„å›°éš¾åº¦ï¼Œç»Ÿç»Ÿè½åœ¨ Base2 subobject èº«ä¸Šã€‚æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œä»¥æ­¤ä¾‹è€Œè¨€åˆ†åˆ«æ˜¯</p><ul><li>virtual destructorã€‚</li><li>è¢«ç»§æ‰¿ä¸‹æ¥çš„ Base2ï¼šmumble()ã€‚</li><li>ä¸€ç»„ clone() å‡½æ•°å®ä½“ã€‚</li></ul><p>è®©æˆ‘ä¾æ¬¡è§£å†³æ¯ä¸€ä¸ªé—®é¢˜</p><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼š</strong><br>æˆ‘æŠŠä¸€ä¸ªä» heap ä¸­é…ç½®è€Œå¾—çš„ Derived å¯¹è±¡çš„åœ°å€ï¼ŒæŒ‡å®šç»™ä¸€ä¸ª Base2 æŒ‡é’ˆï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Base2 *pbase2 = <span class="keyword">new</span> Derived;</span><br></pre></td></tr></tbody></table></figure><p>æ–°çš„ Derived å¯¹è±¡çš„åœ°å€å¿…é¡»è°ƒæ•´ï¼Œä»¥æŒ‡å‘å…¶ Base2 subobjectã€‚ç¼–è¯‘æ—¶æœŸä¼šäº§ç”Ÿä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è½¬ç§»ä»¥æ”¯æŒç¬¬äºŒä¸ª base class</span></span><br><span class="line">Derived *temp = <span class="keyword">new</span> Derived;</span><br><span class="line">Base2 *pbase2 = temp ? temp + <span class="built_in">sizeof</span> ( Base1 ) : <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰è¿™æ ·çš„è°ƒæ•´ï¼ŒæŒ‡é’ˆçš„ä»»ä½•â€œéå¤šæ€è¿ç”¨â€ï¼ˆåƒä¸‹é¢é‚£æ ·ï¼‰éƒ½å°†å¤±è´¥ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å³ä½¿ pbase2 è¢«æŒ‡å®šä¸€ä¸ª Derived å¯¹è±¡ï¼Œè¿™ä¹Ÿåº”è¯¥æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">pbase2-&gt;data_Base2;</span><br></pre></td></tr></tbody></table></figure><p>å½“ç¨‹åºå‘˜è¦åˆ é™¤ pbase2 æ‰€æŒ‡çš„å¯¹è±¡æ—¶ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¿…é¡»é¦–å…ˆè°ƒç”¨æ­£ç¡®çš„ virtual destructor å‡½æ•°å®ä½“</span></span><br><span class="line"><span class="comment">//ç„¶åæ–½è¡Œ delete è¿ç®—ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">//pbase2 å¯èƒ½éœ€è¦è°ƒæ•´ï¼Œä»¥æŒ‡å‡ºå®Œæ•´å¯¹è±¡çš„èµ·å§‹ç‚¹</span></span><br><span class="line"><span class="keyword">delete</span> pbase2;</span><br></pre></td></tr></tbody></table></figure><p>æŒ‡é’ˆå¿…é¡»è¢«å†ä¸€æ¬¡è°ƒæ•´ï¼Œä»¥æ±‚å†ä¸€æ¬¡æŒ‡å‘ Derived å¯¹è±¡çš„èµ·å§‹å¤„ï¼ˆæ¨æµ‹å®ƒè¿˜æŒ‡å‘ Derived å¯¹è±¡ï¼‰ã€‚ç„¶è€Œä¸Šè¿°çš„ offset åŠ æ³•å´ä¸èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶æœŸç›´æ¥è®¾å®šï¼Œå› ä¸º pbase2 æ‰€æŒ‡çš„çœŸæ­£å¯¹è±¡åªæœ‰åœ¨æ‰§è¡ŒæœŸæ‰èƒ½ç¡®å®šã€‚</p><p>ä¸€èˆ¬è§„åˆ™æ˜¯ï¼Œç»ç”±æŒ‡å‘â€œç¬¬äºŒæˆ–åç»§ä¹‹ base classâ€çš„æŒ‡é’ˆï¼ˆæˆ– referenceï¼‰æ¥è°ƒç”¨ derived class virtual functionã€‚æ³½æ³¨å°±åƒæœ¬ä¾‹çš„ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Base2 *pbase2 = <span class="keyword">new</span> Derived;</span><br><span class="line"><span class="keyword">delete</span> pbase2; <span class="comment">//invoke derived class's destructor (virtual)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥è°ƒç”¨æ“ä½œæ‰€è¿å¸¦çš„â€œå¿…è¦çš„ this æŒ‡é’ˆè°ƒæ•´â€æ“ä½œï¼Œå¿…é¡»åœ¨æ‰§è¡ŒæœŸå®Œæˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œoffset çš„å¤§å°ï¼Œä»¥åŠæŠŠ offset åŠ åˆ° this æŒ‡é’ˆä¸Šå¤´çš„é‚£ä¸€å°æ®µç¨‹åºä»£ç å¿…é¡»ç”±ç¼–è¯‘å™¨åœ¨æŸä¸ªåœ°æ–¹æ’äººã€‚é—®é¢˜æ˜¯ï¼Œåœ¨å“ªä¸ªåœ°æ–¹ï¼Ÿ</p><p><strong>offset</strong><br>Bjarne åŸå…ˆå®æ–½äº cfront ç¼–è¯‘å™¨ä¸­çš„æ–¹æ³•æ˜¯å°† virtual table åŠ å¤§ï¼Œä½¿å®ƒå®¹çº³æ­¤å¤„æ‰€éœ€çš„ this æŒ‡é’ˆï¼Œè°ƒæ•´ç›¸å…³äº‹ç‰©ã€‚æ¯ä¸€ä¸ª virtual table slotï¼Œä¸å†åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œæ˜¯ä¸€ä¸ªèšåˆä½“ï¼Œå†…å«å¯èƒ½çš„ offset ä»¥åŠåœ°å€ã€‚äºæ˜¯ virtual function çš„è°ƒç”¨æ“ä½œç”±ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*pbase2-&gt;vptr [<span class="number">1</span>])(pbase2 )</span><br></pre></td></tr></tbody></table></figure><p>æ”¹å˜ä¸ºï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(*pbase2-&gt;vptr[<span class="number">1</span>].faddr)</span><br><span class="line">    pbase2 + pbase2-&gt;vptr[<span class="number">1</span>].offset )</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ faddr å†…å« virtual function åœ°å€ï¼Œoffset å†…å« this æŒ‡é’ˆè°ƒæ•´å€¼ã€‚</p><p>è¿™ä¸ªåšæ³•çš„ç¼ºç‚¹æ˜¯ï¼Œå®ƒç›¸å½“äºè¿å¸¦å¤„ç½šäº†æ‰€æœ‰çš„ virtual function è°ƒç”¨æ“ä½œã€‚ä¸ç®¡å®ƒä»¬æ˜¯å¦éœ€è¦ offset çš„è°ƒæ•´æˆ‘æ‰€è°“çš„å¤„ç½šï¼ŒåŒ…æ‹¬ offset çš„é¢å¤–å­˜å–åŠå…¶åŠ æ³•ï¼Œä»¥åŠæ¯ä¸€ä¸ª virtual table slot çš„å¤§å°æ”¹å˜ã€‚</p><p>æ¯”è¾ƒæœ‰æ•ˆç‡çš„è§£å†³æ–¹æ³•æ˜¯åˆ©ç”¨æ‰€è°“çš„ thunkã€‚Thunk æŠ€æœ¯åˆæ¬¡å¼•è¿›åˆ°ç¼–è¯‘å™¨æŠ€æœ¯ä¸­ï¼Œæˆ‘ç›¸ä¿¡æ˜¯ä¸ºäº†æ”¯æŒ ALGOL ç‹¬ä¸€æ— äºŒçš„ pass-by-name è¯­æ„ã€‚æ‰€è°“ thunk æ˜¯ä¸€å°æ®µ assembly ç ï¼Œç”¨æ¥ä»¥é€‚å½“çš„ offset å€¼è°ƒæ•´ this æŒ‡é’ˆï¼Œè·³åˆ° virtual function å»ã€‚ä¾‹å¦‚ï¼Œç»ç”±ä¸€ä¸ª Baseï¼ŸæŒ‡é’ˆè°ƒç”¨ Derived destructorï¼Œå…¶ç›¸å…³çš„ thunk å¯èƒ½çœ‹èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è™šæ‹Ÿ C++ç </span></span><br><span class="line">pbase2_dtor_thunk:</span><br><span class="line">    <span class="keyword">this</span> += <span class="built_in">sizeof</span> (base1)</span><br><span class="line">    Derived::~<span class="built_in">Derived</span> (<span class="keyword">this</span> )</span><br></pre></td></tr></tbody></table></figure><p>Bjarne å¹¶ä¸æ˜¯ä¸çŸ¥é“ thunk æŠ€æœ¯ï¼Œé—®é¢˜æ˜¯ thunk åªæœ‰ä»¥ assembly ç å®Œæˆæ‰æœ‰æ•ˆç‡å¯è¨€ã€‚ç”±äº cfront ä½¿ç”¨ C ä½œä¸ºå…¶ç¨‹åºä»£ç äº§ç”Ÿè¯­è¨€ï¼Œæ‰€ä»¥æ— æ³•æä¾›ä¸€ä¸ªæœ‰æ•ˆç‡çš„ thunk ç¼–è¯‘å™¨ã€‚ Thunk æŠ€æœ¯å…è®¸ virtual table slot ç»§ç»­å†…å«ä¸€ä¸ªç®€å•çš„æŒ‡é’ˆï¼Œå› æ­¤å¤šé‡ç»§æ‰¿ä¸éœ€è¦ä»»ä½•ç©ºé—´ä¸Šçš„é¢å¤–è´Ÿæ‹…ã€‚Slots ä¸­çš„åœ°å€å¯ä»¥ç›´æ¥æŒ‡å‘ virtual functionï¼Œä¹Ÿå¯ä»¥æŒ‡å‘ä¸€ä¸ªç›¸å…³çš„ thunkï¼ˆå¦‚æœéœ€è¦è°ƒæ•´ this æŒ‡é’ˆçš„è¯ï¼‰ã€‚äºæ˜¯ï¼Œå¯¹äºé‚£äº›ä¸éœ€è¦è°ƒæ•´ this æŒ‡é’ˆçš„ virtual functionï¼ˆç›¸ä¿¡å¤§éƒ¨åˆ†æ˜¯å¦‚æ­¤ï¼Œè™½ç„¶æˆ‘æ‰‹ä¸Šæ²¡æœ‰æ•°æ®ï¼‰è€Œè¨€ï¼Œä¹Ÿå°±ä¸éœ€æ‰¿è½½æ•ˆç‡ä¸Šçš„é¢å¤–è´Ÿæ‹…ã€‚ è°ƒæ•´ this æŒ‡é’ˆçš„ç¬¬äºŒä¸ªé¢å¤–è´Ÿæ‹…å°±æ˜¯ï¼Œç”±äºä¸¤ç§ä¸åŒçš„å¯èƒ½ï¼š</p><ul><li>ç»ç”± derived class è°ƒç”¨ï¼Œç»ç”±ç¬¬äºŒä¸ª base class è°ƒç”¨ï¼ŒåŒä¸€å‡½æ•°åœ¨ virtual table ä¸­å¯èƒ½éœ€è¦å¤šç¬”å¯¹åº”çš„ slotsã€‚ä¾‹å¦‚ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Base1 *pbase1 = <span class="keyword">new</span> Derived;</span><br><span class="line">Base2 *pbase2 = <span class="keyword">new</span> Derived;</span><br><span class="line"><span class="keyword">delete</span> pbase1;</span><br><span class="line"><span class="keyword">delete</span> pbase2;</span><br></pre></td></tr></tbody></table></figure><p>è™½ç„¶ä¸¤ä¸ª delete æ“ä½œå¯¼è‡´ç›¸åŒçš„ Derived destructorï¼Œä½†å®ƒä»¬éœ€è¦ä¸¤ä¸ªä¸åŒçš„ virtual table slots:</p><ul><li>pbase1 ä¸éœ€è¦è°ƒæ•´ this æŒ‡é’ˆï¼ˆå› ä¸º Base1 æ˜¯æœ€å·¦ç«¯ base class ä¹‹æ•…ï¼Œå®ƒå·²ç»æŒ‡å‘ Derived å¯¹è±¡çš„èµ·å§‹å¤„ï¼‰ã€‚å…¶ virtual table slot éœ€æ”¾ç½®çœŸæ­£çš„ destructor åœ°å€ã€‚</li><li>pbase2 éœ€è¦è°ƒæ•´ this æŒ‡é’ˆã€‚å…¶ virtual table slot éœ€è¦ç›¸å…³çš„ thunk åœ°å€ã€‚</li></ul><p>åœ¨å¤šé‡ç»§æ‰¿ä¹‹ä¸‹ï¼Œä¸€ä¸ª derived class å†…å« n-1 ä¸ªé¢å¤–çš„ virtual tablesï¼Œn è¡¨ç¤ºå…¶ä¸Šä¸€å±‚ base classes çš„æ•°ç›®ï¼ˆå› æ­¤ï¼Œå•ä¸€ç»§æ‰¿å°†ä¸ä¼šæœ‰é¢å¤–çš„ virtual tablesï¼‰ã€‚å¯¹äºæœ¬ä¾‹ä¹‹ Derived è€Œè¨€ï¼Œä¼šæœ‰ä¸¤ä¸ª virtual tables è¢«ç¼–è¯‘å™¨äº§ç”Ÿå‡ºæ¥ï¼š</p><ul><li>ä¸€ä¸ªä¸»è¦å®ä½“ï¼Œä¸ Baselï¼ˆæœ€å·¦ç«¯ base classï¼‰å…±äº«ã€‚</li><li>ä¸€ä¸ªæ¬¡è¦å®ä½“ï¼Œä¸ Base2ï¼ˆç¬¬äºŒä¸ª base classï¼‰æœ‰å…³ã€‚</li></ul><p>é’ˆå¯¹æ¯ä¸€ä¸ª virtual tablesï¼ŒDerived å¯¹è±¡ä¸­æœ‰å¯¹åº”çš„ vptrã€‚å›¾ 4.2 è¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚vptrs å°†åœ¨ constructorï¼ˆsï¼‰ä¸­è¢«è®¾ç«‹åˆå€¼ï¼ˆç»ç”±ç¼–è¯‘å™¨æ‰€äº§ç”Ÿå‡ºæ¥çš„ç ï¼‰ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/oo16.png"></p><p>ç”¨ä»¥æ”¯æŒâ€œä¸€ä¸ª class æ‹¥æœ‰å¤šä¸ª virtual tables'â€çš„ä¼ ç»Ÿæ–¹æ³•æ˜¯ï¼Œå°†æ¯ä¸€ä¸ª tables ä»¥å¤–éƒ¨å¯¹è±¡çš„å½¢å¼äº§ç”Ÿå‡ºæ¥ï¼Œå¹¶ç»™äºˆç‹¬ä¸€æ— äºŒçš„åç§°ã€‚ä¾‹å¦‚ï¼ŒDerived æ‰€å…³è”çš„ä¸¤ä¸ª tables å¯èƒ½æœ‰è¿™æ ·çš„åç§°ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vtbl Derived;  <span class="comment">//ä¸»è¦è¡¨æ ¼</span></span><br><span class="line">vtbl Base2_Derived;  <span class="comment">//æ¬¡è¦è¡¨æ ¼</span></span><br></pre></td></tr></tbody></table></figure><p>äºæ˜¯å½“ä½ å°†ä¸€ä¸ª Derived å¯¹è±¡åœ°å€æŒ‡å®šç»™ä¸€ä¸ª Base1 æŒ‡é’ˆæˆ– Derived æŒ‡é’ˆæ—¶ï¼Œè¢«å¤„ç†çš„ virtual table æ˜¯ä¸»è¦è¡¨æ ¼ vtbl Derivedã€‚è€Œå½“ä½ å°†ä¸€ä¸ª Derived å¯¹è±¡åœ°å€æŒ‡å®šç»™ä¸€ä¸ª Base2 æŒ‡é’ˆæ—¶ï¼Œè¢«å¤„ç†çš„ virtual table æ˜¯æ¬¡è¦è¡¨æ ¼ vtbl Base2 Derivedã€‚</p><p>ç”±äºæ‰§è¡ŒæœŸé“¾æ¥å™¨ï¼ˆruntime linkersï¼‰çš„é™ä¸´ï¼Œç¬¦å·åç§°çš„é“¾æ¥å¯èƒ½å˜å¾—éå¸¸ç¼“æ…¢ã€‚ä¸ºäº†è°ƒèŠ‚æ‰§è¡ŒæœŸé“¾æ¥å™¨çš„æ•ˆç‡ï¼ŒSun ç¼–è¯‘å™¨å°†å¤šä¸ª virtual tables è¿é”ä¸ºä¸€ä¸ªï¼›æŒ‡å‘æ¬¡è¦è¡¨æ ¼çš„æŒ‡é’ˆï¼Œå¯ç”±ä¸»è¦è¡¨æ ¼åç§°åŠ ä¸Šä¸€ä¸ª offset è·å¾—ã€‚åœ¨è¿™æ ·çš„ç­–ç•¥ä¸‹ï¼Œæ¯ä¸€ä¸ª class åªæœ‰ä¸€ä¸ªå…·åçš„ virtual tableã€‚â€œå¯¹äºè®¸å¤š Sun é¡¹ç›®ç¨‹åºä»£ç è€Œè¨€ï¼Œé€Ÿåº¦çš„æå‡ååˆ†æ˜æ˜¾ã€‚</p><p>ç¨æ—©æˆ‘æ›¾å†™é“ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼Œç¬¬äºŒæˆ–åç»§çš„ base class ä¼šå½±å“å¯¹ virtual functions çš„æ”¯æŒã€‚ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªâ€œæŒ‡å‘ç¬¬äºŒä¸ª base classâ€çš„æŒ‡é’ˆï¼Œè°ƒç”¨ derived class virtual functionã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Base2 *ptr = <span class="keyword">new</span> Derived;</span><br><span class="line"><span class="comment">//è°ƒç”¨ Derivedï¼š~Derived</span></span><br><span class="line"><span class="comment">//ptr å¿…é¡»è¢«å‘åè°ƒæ•´ sizeofï¼ˆBaselï¼‰ä¸ª bytes</span></span><br><span class="line"><span class="keyword">delete</span> ptr;</span><br></pre></td></tr></tbody></table></figure><p>ä»å›¾ 4.2 ä¹‹ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªè°ƒç”¨æ“ä½œçš„é‡ç‚¹ï¼šptr æŒ‡å‘ Derived å¯¹è±¡ä¸­çš„ Base2 subobjectï¼›ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œï¼Œptr å¿…é¡»è°ƒæ•´æŒ‡å‘ Derived å¯¹è±¡çš„èµ·å§‹å¤„ã€‚</p><p><strong>ç¬¬äºŒç§æƒ…å†µï¼š</strong><br>æ˜¯ç¬¬ä¸€ç§æƒ…å†µçš„å˜åŒ–ï¼Œé€šè¿‡ä¸€ä¸ªâ€œæŒ‡å‘ derived classâ€çš„æŒ‡é’ˆï¼Œè°ƒç”¨ç¬¬äºŒä¸ª base class ä¸­ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„ virtual functionã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œderived class æŒ‡é’ˆå¿…é¡»å†æ¬¡è°ƒæ•´ï¼Œä»¥æŒ‡å‘ç¬¬äºŒä¸ª base subobjectã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Derived *pder = <span class="keyword">new</span> Derived;</span><br><span class="line"><span class="comment">//è°ƒç”¨ Base2ï¼šmumble()</span></span><br><span class="line"><span class="comment">//per å¿…é¡»è¢«å‘å‰è°ƒæ•´ sizeofï¼ˆzaaelï¼‰ä¸ª bytes</span></span><br><span class="line">pder-&gt;<span class="built_in">munble</span>();</span><br></pre></td></tr></tbody></table></figure><p><strong>ç¬¬ä¸‰ç§æƒ…å†µï¼š</strong><br>å‘ç”Ÿäºä¸€ä¸ªè¯­è¨€æ‰©å……æ€§è´¨ä¹‹ä¸‹ï¼šå…è®¸ä¸€ä¸ª virtual function çš„è¿”å›å€¼ç±»å‹æœ‰æ‰€å˜åŒ–ï¼Œå¯èƒ½æ˜¯ base typeï¼Œä¹Ÿå¯èƒ½æ˜¯ publicly derived typeã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ Deriveaï¼šclone() å‡½æ•°å®ä½“æ¥è¯´æ˜ã€‚clone å‡½æ•°çš„ Derived ç‰ˆæœ¬ä¼ å›ä¸€ä¸ª Derived class æŒ‡é’ˆï¼Œé»˜é»˜åœ°æ”¹å†™äº†å®ƒçš„ä¸¤ä¸ª base class å‡½æ•°å®ä½“ã€‚å½“æˆ‘ä»¬é€šè¿‡â€œæŒ‡å‘ç¬¬äºŒä¸ª base class'â€çš„æŒ‡é’ˆæ¥è°ƒç”¨ clone() æ—¶ï¼Œthis æŒ‡é’ˆçš„ offset é—®é¢˜äºæ˜¯è¯ç”Ÿï¼š</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Base2 *pb1 = <span class="keyword">new</span> Derived;</span><br><span class="line"><span class="comment">//è°ƒç”¨ Derived*Derivedï¼šclone()</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼å¿…é¡»è¢«è°ƒæ•´ï¼Œä»¥æŒ‡å‘ Base2 subobject</span></span><br><span class="line">Base2 *pb2 = pb1-&gt;<span class="built_in">clone</span>();</span><br></pre></td></tr></tbody></table></figure><p>å½“è¿›è¡Œ pb1-&gt;clone() æ—¶ï¼Œpb1 ä¼šè¢«è°ƒæ•´æŒ‡å‘ Derived å¯¹è±¡çš„èµ·å§‹åœ°å€ï¼Œäºæ˜¯ clone() çš„ Derived ç‰ˆä¼šè¢«è°ƒç”¨ï¼šå®ƒä¼šä¼ å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ–°çš„ Derived å¯¹è±¡ï¼›è¯¥å¯¹è±¡çš„åœ°å€åœ¨è¢«æŒ‡å®šç»™ pb2 ä¹‹å‰ï¼Œå¿…é¡»å…ˆç»è¿‡è°ƒæ•´ï¼Œä»¥æŒ‡å‘ Base2 subobjectã€‚</p><p>å½“å‡½æ•°è¢«è®¤ä¸ºâ€œè¶³å¤Ÿå°â€çš„æ—¶å€™ï¼ŒSun ç¼–è¯‘å™¨ä¼šæä¾›ä¸€ä¸ªæ‰€è°“çš„â€œsplitfunctionsâ€æŠ€æœ¯ï¼šä»¥ç›¸åŒç®—æ³•äº§ç”Ÿå‡ºä¸¤ä¸ªå‡½æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªåœ¨è¿”å›ä¹‹å‰ï¼Œä¸ºæŒ‡é’ˆåŠ ä¸Šå¿…è¦çš„ offsetã€‚äºæ˜¯ä¸è®ºé€šè¿‡ Base1 æŒ‡é’ˆæˆ– Derived æŒ‡é’ˆè°ƒç”¨å‡½æ•°ï¼Œéƒ½ä¸éœ€è¦è°ƒæ•´è¿”å›å€¼ï¼›è€Œé€šè¿‡ Base2 æŒ‡é’ˆæ‰€è°ƒç”¨çš„ï¼Œæ˜¯å¦ä¸€ä¸ªå‡½æ•°ã€‚</p><p>å¦‚æœå‡½æ•°å¹¶ä¸å°ï¼Œâ€œsplit functionâ€ç­–ç•¥ä¼šç»™äºˆæ­¤å‡½æ•°ä¸­çš„å¤šä¸ªè¿›å…¥ç‚¹ï¼ˆentrypointsï¼‰ä¸­çš„ä¸€ä¸ªã€‚æ¯ä¸€ä¸ªè¿›äººç‚¹éœ€è¦ä¸‰ä¸ªæŒ‡ä»¤ï¼Œç„¶è€Œ OO ç¨‹åºå‘˜éƒ½ä¼šå°½é‡ä½¿ç”¨å°è§„æ¨¡çš„ virtual function å°†æ“ä½œâ€œå±€éƒ¨åŒ–â€ã€‚é€šå¸¸ï¼Œvirtual function çš„å¹³å‡å¤§å°æ˜¯ 8 è¡Œã€‚</p><p>å‡½æ•°å¦‚æœæ”¯æŒå¤šé‡è¿›å…¥ç‚¹ï¼Œå°±å¯ä»¥ä¸å¿…æœ‰è®¸å¤šâ€œthunks'â€ã€‚å¦‚ IBM å°±æ˜¯æŠŠ thunk æ‚æŠ±åœ¨çœŸæ­£è¢«è°ƒç”¨çš„ virtual function ä¸­ã€‚å‡½æ•°ä¸€å¼€å§‹å…ˆè°ƒæ•´ this æŒ‡é’ˆï¼Œç„¶åæ‰æ‰§è¡Œç¨‹åºå‘˜æ‰€å†™çš„å‡½æ•°ç ï¼šè‡³äºä¸éœ€è°ƒæ•´çš„å‡½æ•°è°ƒç”¨æ“ä½œï¼Œå°±ç›´æ¥è¿›äººçš„éƒ¨åˆ†ã€‚</p><h3 id="è™šæ‹Ÿç»§æ‰¿ä¸‹çš„-virtual-functions">è™šæ‹Ÿç»§æ‰¿ä¸‹çš„ Virtual Functions</h3><p>ä¸¤è€…ä¹‹é—´çš„è½¬æ¢ä¹Ÿå°±éœ€è¦è°ƒæ•´ this æŒ‡é’ˆã€‚è‡³äºåœ¨è™šæ‹Ÿç»§æ‰¿çš„æƒ…å†µä¸‹è¦æ¶ˆé™¤ thunksï¼Œä¸€èˆ¬è€Œè¨€å·²ç»è¢«è¯æ˜æ˜¯ä¸€é¡¹é«˜éš¾åº¦æŠ€æœ¯ã€‚</p><p>å½“ä¸€ä¸ª virtual base class ä»å¦ä¸€ä¸ª virtual base class æ´¾ç”Ÿè€Œæ¥ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½æ”¯æŒ virtual functions å’Œ nonstatic data members æ—¶ï¼Œç¼–è¯‘å™¨å¯¹äº virtual base class çš„æ”¯æŒç®€ç›´å°±åƒè¿›äº†è¿·å®«ä¸€æ ·ã€‚æˆ‘çš„å»ºè®®æ˜¯ï¼š</p><blockquote><p>ä¸è¦åœ¨ä¸€ä¸ª virtual base class ä¸­å£°æ˜ nonstatic data members</p></blockquote><h2 id="é™æ€æˆå‘˜å‡½æ•°-static-member-functions">é™æ€æˆå‘˜å‡½æ•° static member functions</h2><ul><li>ä¸èƒ½è®¿é—®éé™æ€æˆå‘˜ã€‚</li><li>ä¸èƒ½å£°æ˜ä¸º constã€volatile æˆ– virtualã€‚</li><li>å‚æ•°æ²¡æœ‰ thisã€‚</li><li>å¯ä»¥ä¸ç”¨å¯¹è±¡è®¿é—®ï¼Œç›´æ¥ ç±»åï¼š: é™æ€æˆå‘˜å‡½æ•°è®¿é—®ã€‚</li></ul><h2 id="vtable-è™šå‡½æ•°è¡¨ä¸€å®šæ˜¯åœ¨ç¼–è¯‘æœŸé—´è·çŸ¥çš„å…¶å‡½æ•°çš„ä¸ªæ•°ä½ç½®å’Œåœ°å€æ˜¯å›ºå®šä¸å˜çš„å®Œå…¨ç”±ç¼–è¯‘å™¨æŒæ§æ‰§è¡ŒæœŸé—´ä¸å…è®¸ä»»ä½•ä¿®æ”¹">vtable è™šå‡½æ•°è¡¨ä¸€å®šæ˜¯åœ¨ç¼–è¯‘æœŸé—´è·çŸ¥çš„ï¼Œå…¶å‡½æ•°çš„ä¸ªæ•°ã€ä½ç½®å’Œåœ°å€æ˜¯å›ºå®šä¸å˜çš„ï¼Œå®Œå…¨ç”±ç¼–è¯‘å™¨æŒæ§ï¼Œæ‰§è¡ŒæœŸé—´ä¸å…è®¸ä»»ä½•ä¿®æ”¹</h2><p>vtable çš„å†…å®¹ï¼š</p><ul><li>virtual class offsetï¼ˆæœ‰è™šåŸºç±»æ‰æœ‰ï¼‰ã€‚</li><li>topoffsetã€‚</li><li>typeinfoã€‚</li><li>ç»§æ‰¿åŸºç±»æ‰€å£°æ˜çš„è™šå‡½æ•°å®ä¾‹ï¼Œæˆ–è€…æ˜¯è¦†ç›–ï¼ˆoverrideï¼‰åŸºç±»çš„è™šå‡½æ•°ã€‚</li><li>æ–°çš„è™šå‡½æ•°ï¼ˆæˆ–è€…æ˜¯çº¯è™šå‡½æ•°å ä½ï¼‰ã€‚</li></ul><h2 id="æ‰§è¡ŒæœŸè™šå‡½æ•°è°ƒç”¨æ­¥éª¤">æ‰§è¡ŒæœŸè™šå‡½æ•°è°ƒç”¨æ­¥éª¤</h2><ul><li>é€šè¿‡ vptr æ‰¾åˆ° vtblã€‚</li><li>é€šè¿‡ thunk æŠ€æœ¯ä»¥åŠ topoffset è°ƒæ•´ this æŒ‡é’ˆï¼ˆå› ä¸ºæˆå‘˜å‡½æ•°é‡Œé¢å¯èƒ½è°ƒç”¨äº†æˆå‘˜å˜é‡ï¼‰ã€‚</li><li>é€šè¿‡ virtual class offset æ‰¾åˆ°è™šåŸºç±»å…±äº«éƒ¨åˆ†çš„æˆå‘˜ã€‚</li><li>æ‰§è¡Œ vtbl ä¸­å¯¹åº” slot çš„å‡½æ•°ã€‚</li><li>å¤šé‡ç»§æ‰¿ä¸­ï¼Œä¸€ä¸ªæ´¾ç”Ÿç±»ä¼šæœ‰ n-1 ä¸ªé¢å¤–çš„ vtblï¼ˆä¹Ÿå¯èƒ½æœ‰ n æˆ–è€… n ä»¥ä¸Šä¸ª vtblï¼Œçœ‹æ˜¯å¦æœ‰è™šåŸºç±»ï¼‰ï¼Œå®ƒä¸ç¬¬ä¸€çˆ¶ç±»å…±äº« vtblï¼Œä¼šä¿®æ”¹å…¶ä»–çˆ¶ç±»çš„ vtblã€‚</li></ul><blockquote><p>æœ€åï¼šInline å¯¹ç¼–è¯‘å™¨åªæ˜¯è¯·æ±‚ï¼Œå¹¶éå‘½ä»¤ã€‚inline ä¸­çš„å±€éƒ¨å˜é‡+æœ‰è¡¨è¾¾å¼å‚æ•°--&gt;å¤§é‡ä¸´æ—¶å˜é‡--&gt;ç¨‹åºè§„æ¨¡æš´æ¶¨</p></blockquote><h1 id="æ‰§è¡ŒæœŸè¯­æ„å­¦">æ‰§è¡ŒæœŸè¯­æ„å­¦</h1><ul><li>å°½é‡æ¨è¿Ÿå˜é‡å®šä¹‰ï¼Œé¿å…ä¸å¿…è¦çš„æ„é€ å’Œææ„ï¼ˆè™½ç„¶ C++ç¼–è¯‘å™¨ä¼šå°½é‡ä¿è¯åœ¨è°ƒç”¨å˜é‡çš„æ—¶å€™æ‰è¿›è¡Œæ„é€ ï¼Œæ¨è¿Ÿå˜é‡å®šä¹‰ä¼šä½¿å¾—ä»£ç å¥½é˜…è¯»ï¼‰.</li><li>å…¨å±€ç±»å˜é‡åœ¨ç¼–è¯‘æœŸé—´è¢«æ”¾ç½®äº data æ®µä¸­å¹¶è¢«ç½®ä¸º 0.<ul><li>GOOGLE C++ç¼–ç¨‹è§„èŒƒï¼šç¦æ­¢ä½¿ç”¨ class ç±»å‹çš„é™æ€æˆ–å…¨å±€å˜é‡ï¼Œåªå…è®¸ä½¿ç”¨ POD å‹é™æ€å˜é‡ (Plain Old Data) å’ŒåŸç”Ÿæ•°æ®ç±»å‹ã€‚å› ä¸ºå®ƒä»¬ä¼šå¯¼è‡´å¾ˆéš¾å‘ç°çš„ bug å’Œä¸ç¡®å®šçš„æ„é€ å’Œææ„å‡½æ•°è°ƒç”¨é¡ºåº</li><li>è§£å†³ï¼šæ”¹æˆåœ¨ static å‡½æ•°ä¸­ï¼Œäº§ç”Ÿå±€éƒ¨ static å¯¹è±¡</li></ul></li><li>å¦‚æœæœ‰è¡¨è¾¾å¼äº§ç”Ÿäº†ä¸´æ—¶å¯¹è±¡ï¼Œé‚£ä¹ˆåº”è¯¥å¯¹å®Œæ•´è¡¨è¾¾å¼æ±‚å€¼ç»“æŸä¹‹åæ‰æ‘§æ¯è¿™äº›åˆ›å»ºçš„ä¸´æ—¶å¯¹è±¡ã€‚æœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š<ul><li>è¯¥ä¸´æ—¶å¯¹è±¡è¢« refer ä¸ºå¦å¤–ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼›</li><li>è¯¥å¯¹è±¡ä½œä¸ºå¦ä¸€å¯¹è±¡çš„ä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ï¼Œè€Œå¦ä¸€å¯¹è±¡è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</li></ul></li></ul><h1 id="ç«™åœ¨å¯¹è±¡æ¨¡å‹çš„å°–ç«¯">ç«™åœ¨å¯¹è±¡æ¨¡å‹çš„å°–ç«¯</h1><ul><li>å¯¹äº RTTI çš„æ”¯æŒï¼Œåœ¨ vtbl ä¸­å¢åŠ ä¸€ä¸ª type_info çš„ slotã€‚</li><li>dynamic_cast æ¯” static_cast è¦èŠ±è´¹æ›´å¤šçš„æ€§èƒ½ï¼ˆæ£€æŸ¥ RTTI é‡Šæ”¾åŒ¹é…ã€æŒ‡é’ˆ offset ç­‰ï¼‰ï¼Œä½†æ˜¯å®‰å…¨æ€§æ›´å¥½ã€‚</li><li>å¯¹å¼•ç”¨æ–½åŠ  dynamic_castï¼š1ï¼‰æˆåŠŸï¼›æˆ– 2ï¼‰æŠ›å‡º bad_cast å¼‚å¸¸ï¼›å¯¹æŒ‡é’ˆæ–½åŠ ï¼š1ï¼‰æˆåŠŸï¼›2ï¼‰è¿”å› 0 æŒ‡é’ˆã€‚</li><li>ä½¿ç”¨** typeid() **è¿›è¡Œåˆ¤æ–­ï¼Œåˆæ³•ä¹‹åå†è¿›è¡Œ dynamic_castï¼Œè¿™æ ·å°±èƒ½å¤Ÿé¿å…å¯¹å¼•ç”¨æ“ä½œå¯¼è‡´çš„ bad_cast å¼‚å¸¸ï¼š if(typeid(rt) == typeid(rt2)) â€¦ã€‚ä½†æ˜¯å¦‚æœ rt å’Œ rt2 æœ¬èº«å°±æ˜¯åˆæ³•å…¼å®¹çš„è¯ï¼Œå°±ä¼šæŸå¤±äº†ä¸€æ¬¡ typeid çš„æ“ä½œæ€§èƒ½ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3pmZW5nemhlbi9CbG9nL2Jsb2IvbWFzdGVyL2FydGljbGUvJUUzJTgwJThBJUU2JUI3JUIxJUU1JTg1JUE1JUU2JThFJUEyJUU3JUI0JUEyQyUyQiUyQiVFNSVBRiVCOSVFOCVCMSVBMSVFNiVBOCVBMSVFNSU5RSU4QiVFMyU4MCU4QiVFOCVBRiVCQiVFNCVCOSVBNiVFNyVBQyU5NCVFOCVBRSVCMC5tZA==">https://github.com/zfengzhen/Blog/blob/master/article/%E3%80%8A%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2C%2B%2B%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.md<i class="fa fa-external-link-alt"></i></span><br>ã€Šæ·±å…¥æ¢ç´¢ C++å¯¹è±¡æ¨¡å‹ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾æ¥è£…è½½ä¸åº“ï¼ˆäº”ï¼‰åŠ¨æ€é“¾æ¥</title>
      <link href="/2021/Program/LinksAndLibrariesPart5/"/>
      <url>/2021/Program/LinksAndLibrariesPart5/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/DynamicLinks.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMxNDUwMjU2NTNiYjA3NGIxZDU3NjE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä¸ºä»€ä¹ˆè¦åŠ¨æ€é“¾æ¥">ä¸ºä»€ä¹ˆè¦åŠ¨æ€é“¾æ¥</h1><ul><li><p>å†…å­˜å’Œç£ç›˜ç©ºé—´ï¼š /usr/bin ä¸‹å°±æœ‰æ•°åƒä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜æœ‰å…¶ä»–æ•°ä»¥åƒè®¡çš„åº“å¦‚æœéƒ½éœ€è¦é™æ€é“¾æ¥ï¼Œé‚£ä¹ˆç©ºé—´æµªè´¹æ— æ³•æƒ³è±¡</p></li><li><p>ç¨‹åºå¼€å‘å’Œå‘å¸ƒï¼š ä¸€æ—¦ç¨‹åºä¸­æœ‰ä»»ä½•æ¨¡å—æ›´æ–°ï¼Œæ•´ä¸ªç¨‹åºå°±è¦é‡æ–°é“¾æ¥ã€å‘å¸ƒç»™ç”¨æˆ·</p></li><li><p>ç¨‹åºå¯æ‰©å±•æ€§å’Œå…¼å®¹æ€§ï¼š åŠ¨æ€é“¾æ¥è¿˜å¯ä»¥åŠ å¼ºç¨‹åºçš„å…¼å®¹æ€§ã€‚ä¸€ä¸ªç¨‹åºåœ¨ä¸åŒçš„å¹³å°è¿è¡Œæ—¶å¯ä»¥åŠ¨æ€åœ°é“¾æ¥åˆ°ç”±æ“ä½œç³»ç»Ÿæä¾›çš„åŠ¨æ€é“¾æ¥åº“</p></li><li><p>å­˜åœ¨çš„é—®é¢˜ï¼š å½“ç¨‹åºæ‰€ä¾èµ–çš„æŸä¸ªæ¨¡å—æ›´æ–°åï¼Œç”±äºæ–°çš„æ¨¡å—ä¸æ—§çš„æ¨¡å—ä¹‹é—´æ¥å£ä¸å…¼å®¹ï¼Œå¯¼è‡´äº†åŸæœ‰çš„ç¨‹åºæ— æ³•è¿è¡Œ</p></li></ul><h1 id="ç®€å•çš„åŠ¨æ€é“¾æ¥ä¾‹å­">ç®€å•çš„åŠ¨æ€é“¾æ¥ä¾‹å­</h1><p>æˆ‘ä»¬åˆ†åˆ«éœ€è¦å¦‚ä¸‹å‡ ä¸ªæºæ–‡ä»¶ï¼šâ€œProgram1.câ€ã€â€œProgram2.câ€ã€â€œLib.câ€å’Œâ€œLib.hâ€ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">æ¸…å• <span class="number">7</span><span class="number">-1</span> SimpleDynamicalLinking</span><br><span class="line"><span class="comment">/*Program1.c*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Lib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    foobar(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Program2.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Lib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    foobar(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Lib.c*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foobar</span> <span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Printing from Lib.so d\n"</span>, i);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Lib.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LIB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIB_H</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foobar</span><span class="params">(<span class="type">int</span> i)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p>ç¨‹åºå¾ˆç®€å•ï¼Œä¸¤ä¸ªç¨‹åºçš„ä¸»è¦æ¨¡å— Program1.c å’Œ Program2.c åˆ†åˆ«è°ƒç”¨äº† Lib.c é‡Œé¢çš„ foobar() å‡½æ•°ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨ GCC å°† Lib.c ç¼–è¯‘æˆä¸€ä¸ªå…±äº«å¯¹è±¡æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o Lib.so Lib.c</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ GCC å‘½ä»¤ä¸­çš„å‚æ•°â€œ-sharedâ€è¡¨ç¤ºäº§ç”Ÿå…±äº«å¯¹è±¡ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª Lib.so æ–‡ä»¶ï¼Œè¿™å°±æ˜¯åŒ…å«äº† Lib.c çš„ foobar() å‡½æ•°çš„å…±äº«å¯¹è±¡æ–‡ä»¶ã€‚ç„¶åæˆ‘ä»¬åˆ†åˆ«ç¼–è¯‘é“¾æ¥ Program1.c å’Œ Program2.cï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o Program1 Program1.c ./Lib.so</span><br><span class="line">gcc -o Program2 Program2.c ./Lib.so</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·æˆ‘ä»¬å¾—åˆ°äº†ä¸¤ä¸ªç¨‹åº Program1 å’Œ Program2ï¼Œè¿™ä¸¤ä¸ªç¨‹åºéƒ½ä½¿ç”¨äº† Lib.so é‡Œé¢çš„ foobar() å‡½æ•°ã€‚ä» Program1 çš„è§’åº¦çœ‹ï¼Œæ•´ä¸ªç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/dl3.png"></p><p><strong>å…³äºæ¨¡å—ï¼ˆModuleï¼‰</strong></p><p>åœ¨åŠ¨æ€é“¾æ¥ä¸‹ï¼Œä¸€ä¸ªç¨‹åºè¢«åˆ†æˆäº†è‹¥å¹²ä¸ªæ–‡ä»¶ï¼Œæœ‰ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†ï¼Œå³å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆProgram1ï¼‰å’Œç¨‹åºæ‰€ä¾èµ–çš„å…±äº«å¯¹è±¡ï¼ˆLib.soï¼‰ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¹ŸæŠŠè¿™äº›éƒ¨åˆ†ç§°ä¸ºæ¨¡å—ã€‚</p><p>å½“é“¾æ¥å™¨å°† Program1.o é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œè¿™æ—¶å€™é“¾æ¥å™¨å¿…é¡»ç¡®å®š Program1.o ä¸­æ‰€å¼•ç”¨çš„ foobar() å‡½æ•°çš„æ€§è´¨ã€‚å¦‚æœ foobar() æ˜¯ä¸€ä¸ªé™æ€ç›®æ ‡æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œå°† Program1.o ä¸­çš„ foobar åœ°å€å¼•ç”¨é‡å®šä½ï¼šå¦‚æœ foobar() æ˜¯ä¸€ä¸ªå®šä¹‰åœ¨æŸä¸ªåŠ¨æ€å…±äº«å¯¹è±¡ä¸­çš„å‡½æ•°ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°±ä¼šå°†è¿™ä¸ªç¬¦å·çš„å¼•ç”¨æ ‡è®°ä¸ºä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„ç¬¦å·ï¼Œä¸å¯¹å®ƒè¿›è¡Œåœ°å€é‡å®šä½ï¼ŒæŠŠè¿™ä¸ªè¿‡ç¨‹ç•™åˆ°è£…è½½æ—¶å†è¿›è¡Œã€‚</p><p>é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼Œé“¾æ¥å™¨å¦‚ä½•çŸ¥é“ foobar çš„å¼•ç”¨æ˜¯ä¸€ä¸ªé™æ€ç¬¦å·è¿˜æ˜¯ä¸€ä¸ªåŠ¨æ€ç¬¦å·ï¼Ÿè¿™å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬è¦ç”¨åˆ° Lib.so çš„åŸå› ã€‚Lib.so ä¸­ä¿å­˜äº†å®Œæ•´çš„ç¬¦å·ä¿¡æ¯ï¼ŒæŠŠ Lib.o ä¹Ÿä½œä¸ºé“¾æ¥çš„è¾“å…¥æ–‡ä»¶ä¹‹ä¸€ï¼Œé“¾æ¥å™¨åœ¨è§£æç¬¦å·æ—¶å°±å¯ä»¥çŸ¥é“ï¼šfoobar æ˜¯ä¸€ä¸ªå®šä¹‰åœ¨ Lib.so çš„åŠ¨æ€ç¬¦å·ã€‚è¿™æ ·é“¾æ¥å™¨å°±å¯ä»¥å¯¹ foobar çš„å¼•ç”¨åšç‰¹æ®Šçš„å¤„ç†ï¼Œä½¿å®ƒæˆä¸ºä¸€ä¸ªå¯¹åŠ¨æ€ç¬¦å·çš„å¼•ç”¨ã€‚</p><p><strong>åŠ¨æ€é“¾æ¥ç¨‹åºè¿è¡Œæ—¶åœ°å€ç©ºé—´åˆ†å¸ƒ</strong></p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šé¢çš„ Program1 ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foobar</span><span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Printing from Lib.so &amp;d\n"</span>,i);</span><br><span class="line">    sleep(<span class="number">-1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åå°±å¯ä»¥æŸ¥çœ‹è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/dl4.png"></p><p>Lib.so ä¸ Program1 ä¸€æ ·ï¼Œå®ƒä»¬éƒ½æ˜¯è¢«æ“ä½œç³»ç»Ÿç”¨åŒæ ·çš„æ–¹æ³•æ˜ å°„è‡³è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œåªæ˜¯å®ƒä»¬å æ®çš„è™šæ‹Ÿåœ°å€å’Œé•¿åº¦ä¸åŒã€‚Program1 é™¤äº†ä½¿ç”¨ Lib.so ä»¥å¤–ï¼Œå®ƒè¿˜ç”¨åˆ°äº†åŠ¨æ€é“¾æ¥å½¢å¼çš„ C è¯­è¨€è¿è¡Œåº“ libc-2.6.1.soã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªå¾ˆå€¼å¾—å…³æ³¨çš„å…±äº«å¯¹è±¡å°±æ˜¯ ld-2.6.soï¼Œå®ƒå®é™…ä¸Šæ˜¯ Linux ä¸‹çš„åŠ¨æ€é“¾æ¥å™¨ã€‚åŠ¨æ€é“¾æ¥å™¨ä¸æ™®é€šå…±äº«å¯¹è±¡ä¸€æ ·è¢«æ˜ å°„åˆ°äº†è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œåœ¨ç³»ç»Ÿå¼€å§‹è¿è¡Œ Program1 ä¹‹å‰ï¼Œé¦–å…ˆä¼šæŠŠæ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œç”±å®ƒå®Œæˆæ‰€æœ‰çš„åŠ¨æ€é“¾æ¥å·¥ä½œä»¥åå†æŠŠæ§åˆ¶æƒäº¤ç»™ Program1ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ readelf å·¥å…·æ¥æŸ¥çœ‹ Lib.so çš„è£…è½½å±æ€§ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">readelf -1 Lib.so</span><br><span class="line">Elf file <span class="built_in">type</span> is DYN (Shared object file)</span><br><span class="line">Entry point 0x390</span><br><span class="line">There are 4 program headers,starting at offset 52</span><br><span class="line">Program Headers:</span><br><span class="line">Type        offset  VirtAddr    PhysAddrFilesiz MemSiz  Flg       Align</span><br><span class="line">LOAD        0x000000 0x00000000 0x00000000      0x004e0 0x004e0RE 0Ã—1000</span><br><span class="line">LOAD        0x0004e0 0x000014e0 0x000014e0      0x0010c 0x00110RW 0x1000</span><br><span class="line">DYNAMIC     0x0004f4 0x000014f4 0x000014f4      0x000c8 0x000c8RW 0x4</span><br><span class="line">GNU_STACK   0x000000 0Ã—00000000 0Ã—00000000      0x00000 0x00000RW 0Ã—4</span><br><span class="line"></span><br><span class="line">Section to Segment mapping:</span><br><span class="line">  Segment Sections..</span><br><span class="line">00 .<span class="built_in">hash</span> .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn</span><br><span class="line">   .rel.plt .init .plt .text .fini</span><br><span class="line">01 .ctors .dtors .jcr .dynamic .got .got.plt .data .bss</span><br><span class="line">02 .dynamic</span><br><span class="line">03</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼šåŠ¨æ€é“¾æ¥æ¨¡å—çš„è£…è½½åœ°å€æ˜¯ä»åœ°å€ 0x00000000 å¼€å§‹çš„ã€‚æˆ‘ä»¬çŸ¥é“è¿™æ˜¯æ— æ•ˆåœ°å€ï¼Œå¹¶ä¸”ä»ä¸Šé¢çš„è¿›ç¨‹è™šæ‹Ÿç©ºé—´åˆ†å¸ƒçœ‹åˆ°ï¼ŒLib.so çš„æœ€ç»ˆè£…è½½åœ°å€å¹¶ä¸æ˜¯ 0x00000000ï¼Œä»è¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥æ¨æ–­ï¼Œå…±äº«å¯¹è±¡çš„æœ€ç»ˆè£…è½½åœ°å€åœ¨ç¼–è¯‘æ—¶æ˜¯ä¸ç¡®å®šçš„ï¼Œè€Œæ˜¯åœ¨è£…è½½æ—¶åŠ¨æ€åˆ†é…ä¸€å—è¶³å¤Ÿå¤§å°çš„è™šæ‹Ÿåœ°å€ç©ºé—´ç»™ç›¸åº”çš„å…±äº«å¯¹è±¡ã€‚</p><h1 id="åœ°å€æ— å…³ä»£ç ">åœ°å€æ— å…³ä»£ç </h1><h2 id="å›ºå®šè£…è½½åœ°å€çš„å›°æ‰°">å›ºå®šè£…è½½åœ°å€çš„å›°æ‰°</h2><p>å¦‚æœä¸åŒçš„æ¨¡å—ç›®æ ‡è£…è½½åœ°å€ä¸ä¸€æ ·æ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬è®¾æƒ³æ˜¯å¦å¯ä»¥è®©å…±äº«å¯¹è±¡åœ¨ä»»æ„åœ°å€åŠ è½½ï¼Ÿ</p><h2 id="è£…è½½æ—¶é‡å®šä½">è£…è½½æ—¶é‡å®šä½</h2><p>åœ¨é“¾æ¥æ—¶ï¼Œå¯¹æ‰€æœ‰ç»å¯¹åœ°å€çš„å¼•ç”¨ä¸ä½œé‡å®šä½ï¼Œè€ŒæŠŠè¿™ä¸€æ­¥æ¨è¿Ÿåˆ°è£…è½½æ—¶å†å®Œæˆã€‚ä¸€æ—¦æ¨¡å—è£…è½½åœ°å€ç¡®å®šï¼Œå³ç›®æ ‡åœ°å€ç¡®å®šï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¯¹ç¨‹åºä¸­æ‰€æœ‰çš„ç»å¯¹åœ°å€å¼•ç”¨è¿›è¡Œé‡å®šä½ã€‚æˆ‘ä»¬å‰é¢åœ¨é™æ€é“¾æ¥æ—¶æåˆ°è¿‡é‡å®šä½ï¼Œé‚£æ—¶çš„é‡å®šä½å«åšé“¾æ¥æ—¶é‡å®šä½ï¼ˆLink Time Relocationï¼‰ï¼Œè€Œç°åœ¨è¿™ç§æƒ…å†µç»å¸¸è¢«ç§°ä¸ºè£…è½½æ—¶é‡å®šä½ï¼ˆLoad Time Relocationï¼‰ã€‚</p><p>ä½†æ˜¯åŠ¨æ€é“¾æ¥æ¨¡å—è¢«è£…è½½æ˜ å°„è‡³è™šæ‹Ÿç©ºé—´åï¼ŒæŒ‡ä»¤éƒ¨åˆ†æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«çš„ï¼Œç”±äºè£…è½½æ—¶é‡å®šä½çš„æ–¹æ³•éœ€è¦ä¿®æ”¹æŒ‡ä»¤ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•åšåˆ°åŒä¸€ä»½æŒ‡ä»¤è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Œå› ä¸ºæŒ‡ä»¤è¢«é‡å®šä½åå¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è®²æ˜¯ä¸åŒçš„ã€‚å½“ç„¶ï¼ŒåŠ¨æ€è¿æ¥åº“ä¸­çš„å¯ä¿®æ”¹æ•°æ®éƒ¨åˆ†å¯¹äºä¸åŒçš„è¿›ç¨‹æ¥è¯´æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥é‡‡ç”¨è£…è½½æ—¶é‡å®šä½çš„æ–¹æ³•æ¥è§£å†³ã€‚</p><h2 id="åœ°å€æ— å…³ä»£ç -1">åœ°å€æ— å…³ä»£ç </h2><p>å…¶å®æˆ‘ä»¬çš„ç›®çš„å¾ˆç®€å•ï¼Œå¸Œæœ›ç¨‹åºæ¨¡å—ä¸­å…±äº«çš„æŒ‡ä»¤éƒ¨åˆ†åœ¨è£…è½½æ—¶ä¸éœ€è¦å› ä¸ºè£…è½½åœ°å€çš„æ”¹å˜è€Œæ”¹å˜ï¼Œæ‰€ä»¥å®ç°çš„åŸºæœ¬æƒ³æ³•å°±æ˜¯æŠŠæŒ‡ä»¤ä¸­é‚£äº›éœ€è¦è¢«ä¿®æ”¹çš„éƒ¨åˆ†åˆ†ç¦»å‡ºæ¥ï¼Œè·Ÿæ•°æ®éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·æŒ‡ä»¤éƒ¨åˆ†å°±å¯ä»¥ä¿æŒä¸å˜ï¼Œè€Œæ•°æ®éƒ¨åˆ†å¯ä»¥åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­æ‹¥æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚è¿™ç§æ–¹æ¡ˆå°±æ˜¯ç›®å‰è¢«ç§°ä¸ºåœ°å€æ— å…³ä»£ç ï¼ˆPICï¼ŒPosition-independent Codeï¼‰çš„æŠ€æœ¯ã€‚</p><p>äº§ç”Ÿåœ°å€æ— å…³çš„ä»£ç å¹¶ä¸éº»çƒ¦ã€‚ä¸»è¦åˆ†å¦‚ä¸‹å››ç§æƒ…å†µï¼š</p><ul><li>ç¬¬ä¸€ç§æ˜¯æ¨¡å—å†…éƒ¨çš„å‡½æ•°è°ƒç”¨ã€è·³è½¬ç­‰éƒ½å¯ä»¥æ˜¯ç›¸å¯¹åœ°å€è°ƒç”¨ï¼Œæˆ–è€…æ˜¯åŸºäºå¯„å­˜å™¨çš„ç›¸å¯¹è°ƒç”¨ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§æŒ‡ä»¤æ˜¯ä¸éœ€è¦é‡å®šä½çš„ã€‚</li><li>ç¬¬äºŒç§æ˜¯æ¨¡å—å†…éƒ¨çš„æ•°æ®è®¿é—®ã€æ¯”å¦‚æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€‚ç°ä»£çš„ä½“ç³»ç»“æ„ä¸­ï¼Œæ•°æ®çš„ç›¸å¯¹å¯»å€å¾€å¾€æ²¡æœ‰ç›¸å¯¹ä¸å½“å‰æŒ‡ä»¤åœ°å€ï¼ˆPCï¼‰çš„å¯»å€æ–¹å¼ï¼Œæ‰€ä»¥ ELF ç”¨äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„åŠæ³•æ¥å¾—åˆ°å½“å‰çš„ PC å€¼ï¼Œç„¶åå†åŠ ä¸Šä¸€ä¸ªåç§»é‡å°±å¯ä»¥è¾¾åˆ°è®¿é—®ç›¸åº”å˜é‡çš„ç›®çš„äº†ã€‚</li><li>ç¬¬ä¸‰ç§æ˜¯æ¨¡å—å¤–éƒ¨çš„æ•°æ®è®¿é—®ã€æ¯”å¦‚å…¶ä»–æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€‚ELF çš„åšæ³•æ˜¯åœ¨æ•°æ®æ®µé‡Œé¢å»ºç«‹ä¸€ä¸ªæŒ‡å‘è¿™äº›å˜é‡çš„æŒ‡é’ˆæ•°ç»„ï¼Œä¹Ÿè¢«ç§°ä¸ºå…¨å±€åç§»è¡¨ï¼ˆGlobal Offset Tableï¼ŒGOTï¼‰ï¼Œå½“ä»£ç éœ€è¦å¼•ç”¨è¯¥å…¨å±€å˜é‡æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­ç›¸å¯¹åº”çš„é¡¹é—´æ¥å¼•ç”¨ã€‚</li><li>ç¬¬å››ç§æ˜¯æ¨¡å—å¤–éƒ¨çš„å‡½æ•°è°ƒç”¨ã€è·³è½¬ç­‰ã€‚GOT ä¸­ç›¸åº”çš„é¡¹ä¿å­˜çš„æ˜¯ç›®æ ‡å‡½æ•°çš„åœ°å€ï¼Œå½“æ¨¡å—éœ€è¦è°ƒç”¨ç›®æ ‡å‡½æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­çš„é¡¹è¿›è¡Œé—´æ¥è·³è½¬ã€‚</li></ul><h2 id="å…±äº«æ¨¡å—çš„å…¨å±€å˜é‡é—®é¢˜">å…±äº«æ¨¡å—çš„å…¨å±€å˜é‡é—®é¢˜</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> global:</span><br><span class="line"><span class="type">int</span> <span class="title function_">foo</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    global = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ç¼–è¯‘å™¨ç¼–è¯‘ module.c æ—¶ï¼Œå®ƒæ— æ³•åˆ¤æ–­ global æ˜¯å®šä¹‰åœ¨åŒä¸€ä¸ªæ¨¡å—çš„çš„å…¶ä»–ç›®æ ‡æ–‡ä»¶è¿˜æ˜¯å®šä¹‰åœ¨å¦å¤–ä¸€ä¸ªå…±äº«å¯¹è±¡ä¹‹ä¸­ã€‚</p><p>å‡è®¾ module.c æ˜¯ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºç¨‹åºä¸»æ¨¡å—çš„ä»£ç å¹¶ä¸æ˜¯åœ°å€æ— å…³ä»£ç ï¼Œå®ƒå¼•ç”¨è¿™ä¸ªå…¨å±€å˜é‡çš„æ–¹å¼è·Ÿæ™®é€šæ•°æ®è®¿é—®æ–¹å¼ä¸€æ ·ï¼Œç¼–è¯‘å™¨ä¼šäº§ç”Ÿè¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl $Ox1,XXXXXXXX</span><br></pre></td></tr></tbody></table></figure><p>XXXXXXXX å°±æ˜¯ global çš„åœ°å€ã€‚ç”±äºå¯æ‰§è¡Œæ–‡ä»¶åœ¨è¿è¡Œæ—¶å¹¶ä¸è¿›è¡Œä»£ç é‡å®šä½ï¼Œæ‰€ä»¥å˜é‡çš„åœ°å€å¿…é¡»åœ¨é“¾æ¥è¿‡ç¨‹ä¸­ç¡®å®šä¸‹æ¥ã€‚ä¸ºäº†èƒ½å¤Ÿä½¿å¾—é“¾æ¥è¿‡ç¨‹æ­£å¸¸è¿›è¡Œï¼Œé“¾æ¥å™¨ä¼šåœ¨åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œåœ¨å®ƒçš„â€œ.bssâ€æ®µåˆ›å»ºä¸€ä¸ª global å˜é‡çš„å‰¯æœ¬ã€‚é‚£ä¹ˆé—®é¢˜å°±å¾ˆæ˜æ˜¾äº†ï¼Œç°åœ¨ global å˜é‡å®šä¹‰åœ¨åŸå…ˆçš„å…±äº«å¯¹è±¡ä¸­ï¼Œè€Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„â€œ.bssâ€æ®µè¿˜æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚å¦‚æœåŒä¸€ä¸ªå˜é‡åŒæ—¶å­˜åœ¨äºå¤šä¸ªä½ç½®ä¸­ï¼Œè¿™åœ¨ç¨‹åºå®é™…è¿è¡Œè¿‡ç¨‹ä¸­è‚¯å®šæ˜¯ä¸å¯è¡Œçš„ã€‚</p><p>äºæ˜¯è§£å†³çš„åŠæ³•åªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯æ‰€æœ‰çš„ä½¿ç”¨è¿™ä¸ªå˜é‡çš„æŒ‡ä»¤éƒ½æŒ‡å‘ä½äºå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„é‚£ä¸ªå‰¯æœ¬ã€‚ELF å…±äº«åº“åœ¨ç¼–è¯‘æ—¶ï¼Œé»˜è®¤éƒ½æŠŠå®šä¹‰åœ¨æ¨¡å—å†…éƒ¨çš„å…¨å±€å˜é‡å½“ä½œå®šä¹‰åœ¨å…¶ä»–æ¨¡å—çš„å…¨å±€å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä½œå‰é¢çš„ç±»å‹å››ï¼Œé€šè¿‡ GOT æ¥å®ç°å˜é‡çš„è®¿é—®ã€‚</p><h1 id="å»¶è¿Ÿç»‘å®šplt">å»¶è¿Ÿç»‘å®šï¼ˆPLTï¼‰</h1><p>åŠ¨æ€é“¾æ¥çš„ç¡®æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œæ¯”é™æ€é“¾æ¥è¦çµæ´»å¾—å¤šï¼Œä½†å®ƒæ˜¯ä»¥ç‰ºç‰²ä¸€éƒ¨åˆ†æ€§èƒ½ä¸ºä»£ä»·çš„ã€‚æ®ç»Ÿè®¡ ELF ç¨‹åºåœ¨é™æ€é“¾æ¥ä¸‹è¦æ¯”åŠ¨æ€åº“ç¨å¾®å¿«ç‚¹ï¼Œå¤§çº¦ä¸º 1%~5%ã€‚æˆ‘ä»¬çŸ¥é“åŠ¨æ€é“¾æ¥æ¯”é™æ€é“¾æ¥æ…¢çš„ä¸»è¦åŸå› æ˜¯åŠ¨æ€é“¾æ¥ä¸‹å¯¹äºå…¨å±€å’Œé™æ€çš„æ•°æ®è®¿é—®éƒ½è¦è¿›è¡Œå¤æ‚çš„ GOT å®šä½ï¼Œç„¶åé—´æ¥å¯»å€ï¼›å¯¹äºæ¨¡å—é—´çš„è°ƒç”¨ä¹Ÿè¦å…ˆå®šä½ GOTï¼Œç„¶åå†è¿›è¡Œé—´æ¥è·³è½¬ã€‚å¦å¤–ä¸€ä¸ªå‡æ…¢è¿è¡Œé€Ÿåº¦çš„åŸå› æ˜¯åŠ¨æ€é“¾æ¥çš„é“¾æ¥å·¥ä½œåœ¨è¿è¡Œæ—¶å®Œæˆï¼Œå³ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨éƒ½è¦è¿›è¡Œä¸€æ¬¡é“¾æ¥å·¥ä½œã€‚</p><p><strong>å»¶è¿Ÿç»‘å®šå®ç°</strong></p><p>åœ¨åŠ¨æ€é“¾æ¥ä¸‹ï¼Œå¦‚æœä¸€å¼€å§‹å°±æŠŠæ‰€æœ‰å‡½æ•°éƒ½é“¾æ¥å¥½å®é™…ä¸Šæ˜¯ä¸€ç§æµªè´¹ã€‚æ‰€ä»¥ ELF é‡‡ç”¨äº†ä¸€ç§å«åšå»¶è¿Ÿç»‘å®šï¼ˆLay Bindingï¼‰çš„åšæ³•ï¼ŒåŸºæœ¬çš„æ€æƒ³å°±æ˜¯å½“å‡½æ•°ç¬¬ä¸€æ¬¡è¢«ç”¨åˆ°æ—¶æ‰è¿›è¡Œç»‘å®šï¼ˆç¬¦å·æŸ¥æ‰¾ã€é‡å®šä½ç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ç”¨åˆ°åˆ™ä¸è¿›è¡Œç»‘å®šã€‚</p><p>PLT åœ¨ ELF æ–‡ä»¶ä¸­ä»¥ç‹¬ç«‹çš„æ®µå­˜æ”¾ï¼Œæ®µåé€šå¸¸å«åšâ€œ.pltâ€ï¼Œå› ä¸ºå®ƒæœ¬èº«æ˜¯ä¸€äº›åœ°å€æ— å…³çš„ä»£ç ï¼Œæ‰€ä»¥å¯ä»¥è·Ÿä»£ç æ®µç­‰ä¸€èµ·åˆå¹¶æˆåŒä¸€ä¸ªå¯è¯»å¯æ‰§è¡Œçš„â€œSegmentâ€è¢«è£…è½½å…¥å†…å­˜ã€‚</p><h1 id="åŠ¨æ€é“¾æ¥ç›¸å…³æ®µ">åŠ¨æ€é“¾æ¥ç›¸å…³æ®µ</h1><h2 id="interp-æ®µ">.interp æ®µ</h2><p>å®é™…ä¸Šï¼ŒåŠ¨æ€é“¾æ¥å™¨çš„ä½ç½®æ—¢ä¸æ˜¯ç”±ç³»ç»Ÿé…ç½®æŒ‡å®šï¼Œä¹Ÿä¸æ˜¯ç”±ç¯å¢ƒå‚æ•°å†³å®šï¼Œè€Œæ˜¯ç”± ELF å¯æ‰§è¡Œæ–‡ä»¶å†³å®šã€‚åœ¨åŠ¨æ€é“¾æ¥çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨çš„æ®µå«åšâ€œ.interpâ€æ®µã€‚â€œ.interpâ€å†…å®¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">objdump -s a.out</span><br><span class="line">a.out:  file format elf32-i386</span><br><span class="line">Contents of section .interp:</span><br><span class="line">    8048114 2f6c6962 2f6c642d 6c696e75 782e736f /lib/ld-1inux.so</span><br><span class="line">    8048124 2e3200</span><br><span class="line">.2.</span><br></pre></td></tr></tbody></table></figure><p>â€œ.interpâ€çš„å†…å®¹å¾ˆç®€å•ï¼Œé‡Œé¢ä¿å­˜çš„å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°±æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ‰€éœ€è¦çš„åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ï¼Œåœ¨ Linux ä¸‹ï¼Œå¯æ‰§è¡Œæ–‡ä»¶æ‰€éœ€è¦çš„åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„å‡ ä¹éƒ½æ˜¯â€œ/lib/ld-linux.so.2â€ã€‚</p><h2 id="dynamic-æ®µ">.dynamic æ®µ</h2><p>åŠ¨æ€é“¾æ¥ ELF ä¸­æœ€é‡è¦çš„ç»“æ„åº”è¯¥æ˜¯â€œ.dynamicâ€æ®µï¼Œè¿™ä¸ªæ®µé‡Œé¢ä¿å­˜äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ä¾èµ–äºå“ªäº›å…±äº«å¯¹è±¡ã€åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„ä½ç½®ã€åŠ¨æ€é“¾æ¥é‡å®šä½è¡¨çš„ä½ç½®ã€å…±äº«å¯¹è±¡åˆå§‹åŒ–ä»£ç çš„åœ°å€ç­‰ã€‚</p><h2 id="dynsym-æ®µåŠ¨æ€ç¬¦å·è¡¨">.dynsym æ®µï¼ˆåŠ¨æ€ç¬¦å·è¡¨ï¼‰</h2><p>ä¸ºäº†è¡¨ç¤ºåŠ¨æ€é“¾æ¥è¿™äº›æ¨¡å—ä¹‹é—´çš„ç¬¦å·å¯¼å…¥å¯¼å‡ºå…³ç³»ï¼ŒELF ä¸“é—¨æœ‰ä¸€ä¸ªå«åšåŠ¨æ€ç¬¦å·è¡¨ï¼ˆDynamic Symbol Tableï¼‰çš„æ®µç”¨æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªæ®µçš„æ®µåé€šå¸¸å«åšâ€œ.dynsymâ€ï¼ˆDynamic Symbolï¼‰ã€‚ä¸é™æ€é“¾æ¥ä¸­çš„ç¬¦å·è¡¨â€œ.symtabâ€ä¸åŒçš„æ˜¯ï¼Œâ€œ.dynsymâ€åªä¿å­˜äº†ä¸åŠ¨æ€é“¾æ¥ç›¸å…³çš„ç¬¦å·ã€‚</p><p>ä¸â€œ.symtabâ€ç±»ä¼¼ï¼ŒåŠ¨æ€ç¬¦å·è¡¨ä¹Ÿéœ€è¦ä¸€äº›è¾…åŠ©çš„è¡¨ï¼Œæ¯”å¦‚ç”¨äºä¿å­˜ç¬¦å·åçš„å­—ç¬¦ä¸²è¡¨ã€‚é™æ€é“¾æ¥æ—¶å«åšç¬¦å·å­—ç¬¦ä¸²è¡¨â€œ.strtabâ€ï¼ˆString Tableï¼‰ï¼Œåœ¨è¿™é‡Œå°±æ˜¯åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨â€œ.dynstrâ€ï¼ˆDynamic String Tableï¼‰ï¼›ç”±äºåŠ¨æ€é“¾æ¥ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºè¿è¡Œæ—¶æŸ¥æ‰¾ç¬¦å·ï¼Œä¸ºäº†åŠ å¿«ç¬¦å·çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œå¾€å¾€è¿˜æœ‰è¾…åŠ©çš„ç¬¦å·å“ˆå¸Œè¡¨ï¼ˆâ€œ.hashâ€ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ readelf å·¥å…·æ¥æŸ¥çœ‹ ELF æ–‡ä»¶çš„åŠ¨æ€ç¬¦å·è¡¨åŠå®ƒçš„å“ˆå¸Œè¡¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -sD Lib.so</span><br></pre></td></tr></tbody></table></figure><h2 id="åŠ¨æ€é“¾æ¥é‡å®šä½è¡¨">åŠ¨æ€é“¾æ¥é‡å®šä½è¡¨</h2><p>å¯¹äºä½¿ç”¨ PIC æŠ€æœ¯çš„å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«å¯¹è±¡æ¥è¯´ï¼Œè™½ç„¶å®ƒä»¬çš„ä»£ç æ®µä¸éœ€è¦é‡å®šä½ï¼ˆå› ä¸ºåœ°å€æ— å…³ï¼‰ï¼Œä½†æ˜¯æ•°æ®æ®µè¿˜åŒ…å«äº†ç»å¯¹åœ°å€çš„å¼•ç”¨ï¼Œå› ä¸ºä»£ç æ®µä¸­ç»å¯¹åœ°å€ç›¸å…³çš„éƒ¨åˆ†è¢«åˆ†ç¦»äº†å‡ºæ¥ï¼Œå˜æˆäº† GOTï¼Œè€Œ GOT å®é™…ä¸Šæ˜¯æ•°æ®æ®µçš„ä¸€éƒ¨åˆ†ã€‚é™¤äº† GOT ä»¥å¤–ï¼Œæ•°æ®æ®µè¿˜å¯èƒ½åŒ…å«ç»å¯¹åœ°å€å¼•ç”¨ã€‚</p><p>åœ¨é™æ€é“¾æ¥ä¸­ï¼Œç›®æ ‡æ–‡ä»¶é‡Œé¢åŒ…å«æœ‰ä¸“é—¨ç”¨äºè¡¨ç¤ºé‡å®šä½ä¿¡æ¯çš„é‡å®šä½è¡¨ï¼Œæ¯”å¦‚â€œ.rela.textâ€è¡¨ç¤ºæ˜¯ä»£ç æ®µçš„é‡å®šä½è¡¨ï¼Œâ€œ.rela.dataâ€æ˜¯æ•°æ®æ®µçš„é‡å®šä½è¡¨ã€‚åŠ¨æ€é“¾æ¥çš„æ–‡ä»¶ä¸­ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„é‡å®šä½è¡¨åˆ†åˆ«å«åšâ€œ.rela.dynâ€å’Œâ€œ.rela.plt'â€ã€‚â€œ.rela.dynâ€å®é™…ä¸Šæ˜¯å¯¹æ•°æ®å¼•ç”¨çš„ä¿®æ­£ï¼Œå®ƒæ‰€ä¿®æ­£çš„ä½ç½®ä½äºâ€œ.gotâ€ä»¥åŠæ•°æ®æ®µï¼›è€Œâ€œ.rela.pltâ€æ˜¯å¯¹å‡½æ•°å¼•ç”¨çš„ä¿®æ­£ï¼Œå®ƒæ‰€ä¿®æ­£çš„ä½ç½®ä½äºâ€œ.got.pltâ€ã€‚</p><h1 id="åŠ¨æ€é“¾æ¥çš„æ­¥éª¤å’Œå®ç°">åŠ¨æ€é“¾æ¥çš„æ­¥éª¤å’Œå®ç°</h1><ul><li>é¦–å…ˆæ“ä½œç³»ç»Ÿä¼šè¯»å–å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼Œæ£€æŸ¥æ–‡ä»¶çš„åˆæ³•æ€§ï¼Œç„¶åä»å¤´éƒ¨ä¸­çš„â€œProgram Headerâ€ä¸­è¯»å–æ¯ä¸ªâ€œSegmentâ€çš„è™šæ‹Ÿåœ°å€ã€æ–‡ä»¶åœ°å€å’Œå±æ€§ï¼Œå¹¶å°†å®ƒä»¬æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿç©ºé—´çš„ç›¸åº”ä½ç½®ã€‚</li><li>å¯¹äºé™æ€é“¾æ¥ã€‚ æ“ä½œç³»ç»Ÿæ¥ç€å°±å¯ä»¥æŠŠæ§åˆ¶æƒè½¬äº¤ç»™å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œç„¶åç¨‹åºå¼€å§‹æ‰§è¡Œï¼Œä¸€åˆ‡çœ‹èµ·æ¥éå¸¸ç›´è§‚</li><li>å¯¹äºåŠ¨æ€é“¾æ¥ã€‚<ul><li>å¯æ‰§è¡Œæ–‡ä»¶é‡Œå¯¹äºå¾ˆå¤šå¤–éƒ¨ç¬¦å·çš„å¼•ç”¨è¿˜å¤„äºæ— æ•ˆåœ°å€çš„çŠ¶æ€ã€‚æ‰€ä»¥åœ¨æ˜ å°„å®Œå¯æ‰§è¡Œæ–‡ä»¶ä¹‹åï¼Œæ“ä½œç³»ç»Ÿä¼šå…ˆå¯åŠ¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰</li><li>å°†æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£åœ°å€ï¼Œæ‰§è¡Œä¸€ç³»åˆ—è‡ªèº«çš„åˆå§‹åŒ–æ“ä½œï¼Œå¼€å§‹å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡ŒåŠ¨æ€é“¾æ¥å·¥ä½œ</li><li>å½“æ‰€æœ‰åŠ¨æ€é“¾æ¥å·¥ä½œå®Œæˆä»¥åï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šå°†æ§åˆ¶æƒè½¬äº¤åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œç¨‹åºå¼€å§‹æ­£å¼æ‰§è¡Œ</li></ul></li></ul><h2 id="åŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾">åŠ¨æ€é“¾æ¥å™¨è‡ªä¸¾</h2><p>æˆ‘ä»¬çŸ¥é“åŠ¨æ€é“¾æ¥å™¨æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œä½†æ˜¯äº‹å®ä¸Šå®ƒæœ‰ä¸€äº›ç‰¹æ®Šæ€§ã€‚å¯¹äºæ™®é€šå…±äº«å¯¹è±¡æ–‡ä»¶æ¥è¯´ï¼Œå®ƒçš„é‡å®šä½å·¥ä½œç”±åŠ¨æ€é“¾æ¥å™¨æ¥å®Œæˆã€‚å¯æ˜¯å¯¹äºåŠ¨æ€é“¾æ¥å™¨æœ¬èº«æ¥è¯´ï¼Œå®ƒçš„é‡å®šä½å·¥ä½œç”±è°æ¥å®Œæˆï¼ŸåŠ¨æ€é“¾æ¥å™¨å¿…é¡»æœ‰äº›ç‰¹æ®Šæ€§ã€‚</p><ul><li>é¦–å…ˆæ˜¯ï¼ŒåŠ¨æ€é“¾æ¥å™¨æœ¬èº«ä¸å¯ä»¥ä¾èµ–äºå…¶ä»–ä»»ä½•å…±äº«å¯¹è±¡ã€‚</li><li>å…¶æ¬¡æ˜¯åŠ¨æ€é“¾æ¥å™¨æœ¬èº«æ‰€éœ€è¦çš„å…¨å±€å’Œé™æ€å˜é‡çš„é‡å®šä½å·¥ä½œç”±å®ƒæœ¬èº«å®Œæˆã€‚</li></ul><p>å¯¹äºç¬¬ä¸€ä¸ªæ¡ä»¶æˆ‘ä»¬å¯ä»¥äººä¸ºåœ°æ§åˆ¶ï¼Œåœ¨ç¼–å†™åŠ¨æ€é“¾æ¥å™¨æ—¶ä¿è¯ä¸ä½¿ç”¨ä»»ä½•ç³»ç»Ÿåº“ã€è¿è¡Œåº“ï¼›å¯¹äºç¬¬äºŒä¸ªæ¡ä»¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨å¿…é¡»åœ¨å¯åŠ¨æ—¶æœ‰ä¸€æ®µéå¸¸ç²¾å·§çš„ä»£ç å¯ä»¥å®Œæˆè¿™é¡¹è‰°å·¨çš„å·¥ä½œè€ŒåŒæ—¶åˆä¸èƒ½ç”¨åˆ°å…¨å±€å’Œé™æ€å˜é‡ã€‚è¿™ç§å…·æœ‰ä¸€å®šé™åˆ¶æ¡ä»¶çš„å¯åŠ¨ä»£ç å¾€å¾€è¢«ç§°ä¸ºè‡ªä¸¾ï¼ˆBootstrapï¼‰ã€‚</p><p>åŠ¨æ€é“¾æ¥å™¨å…¥å£åœ°å€å³æ˜¯è‡ªä¸¾ä»£ç çš„å…¥å£ï¼Œå½“æ“ä½œç³»ç»Ÿå°†è¿›ç¨‹æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨çš„è‡ªä¸¾ä»£ç å³å¼€å§‹æ‰§è¡Œã€‚è‡ªä¸¾ä»£ç é¦–å…ˆä¼šæ‰¾åˆ°å®ƒè‡ªå·±çš„ GOTã€‚è€Œ GOT çš„ç¬¬ä¸€ä¸ªå…¥å£ä¿å­˜çš„å³æ˜¯â€œ.dynamicâ€æ®µçš„åç§»åœ°å€ï¼Œç”±æ­¤æ‰¾åˆ°äº†åŠ¨æ€è¿æ¥å™¨æœ¬èº«çš„â€œ.dynamicâ€æ®µã€‚é€šè¿‡â€œ.dynamicâ€ä¸­çš„ä¿¡æ¯ï¼Œè‡ªä¸¾ä»£ç ä¾¿å¯ä»¥è·å¾—åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„é‡å®šä½è¡¨å’Œç¬¦å·è¡¨ç­‰ï¼Œä»è€Œå¾—åˆ°åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„é‡å®šä½å…¥å£ï¼Œå…ˆå°†å®ƒä»¬å…¨éƒ¨é‡å®šä½ã€‚ä»è¿™ä¸€æ­¥å¼€å§‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä»£ç ä¸­æ‰å¯ä»¥å¼€å§‹ä½¿ç”¨ç™½å·±çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚</p><p>å®é™…ä¸Šåœ¨åŠ¨æ€é“¾æ¥å™¨çš„è‡ªä¸¾ä»£ç ä¸­ï¼Œé™¤äº†ä¸å¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡å’Œé™æ€å˜é‡ä¹‹å¤–ï¼Œç”šè‡³ä¸èƒ½è°ƒç”¨å‡½æ•°ï¼Œå³åŠ¨æ€é“¾æ¥å™¨æœ¬èº«çš„å‡½æ•°ä¹Ÿä¸èƒ½è°ƒç”¨ã€‚å…¶å®æˆ‘ä»¬åœ¨å‰é¢åˆ†æåœ°å€æ— å…³ä»£ç æ—¶å·²ç»æåˆ°è¿‡ï¼Œå®é™…ä¸Šä½¿ç”¨ PIC æ¨¡å¼ç¼–è¯‘çš„å…±äº«å¯¹è±¡ï¼Œå¯¹äºæ¨¡å—å†…éƒ¨çš„å‡½æ•°è°ƒç”¨ä¹Ÿæ˜¯é‡‡ç”¨è·Ÿæ¨¡å—å¤–éƒ¨å‡½æ•°è°ƒç”¨ä¸€æ ·çš„æ–¹å¼ï¼Œå³ä½¿ç”¨ GOT/PLT çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨ GOT/PLT æ²¡æœ‰è¢«é‡å®šä½ä¹‹å‰ï¼Œè‡ªä¸¾ä»£ç ä¸å¯ä»¥ä½¿ç”¨ä»»ä½•å…¨å±€å˜é‡ï¼Œä¹Ÿä¸å¯ä»¥è°ƒç”¨å‡½æ•°ã€‚</p><h2 id="è£…è½½å…±äº«å¯¹è±¡">è£…è½½å…±äº«å¯¹è±¡</h2><p>å®ŒæˆåŸºæœ¬è‡ªä¸¾ä»¥åï¼ŒåŠ¨æ€é“¾æ¥å™¨å°†å¯æ‰§è¡Œæ–‡ä»¶å’Œé“¾æ¥å™¨æœ¬èº«çš„ç¬¦å·è¡¨éƒ½åˆå¹¶åˆ°ä¸€ä¸ªç¬¦å·è¡¨å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç§°å®ƒä¸ºå…¨å±€ç¬¦å·è¡¨ï¼ˆGlobal Symbol Tableï¼‰ã€‚ç„¶åé“¾æ¥å™¨å¼€å§‹å¯»æ‰¾å¯æ‰§è¡Œæ–‡ä»¶æ‰€ä¾èµ–çš„å…±äº«å¯¹è±¡ã€‚ç”±æ­¤ï¼Œé“¾æ¥å™¨å¯ä»¥åˆ—å‡ºå¯æ‰§è¡Œæ–‡ä»¶æ‰€éœ€è¦çš„æ‰€æœ‰å…±äº«å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å…±äº«å¯¹è±¡çš„åå­—æ”¾å…¥åˆ°ä¸€ä¸ªè£…è½½é›†åˆä¸­ã€‚ç„¶åé“¾æ¥å™¨å¼€å§‹ä»é›†åˆé‡Œå–ä¸€ä¸ªæ‰€éœ€è¦çš„å…±äº«å¯¹è±¡çš„åå­—ï¼Œæ‰¾åˆ°ç›¸åº”çš„æ–‡ä»¶åæ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè¯»å–ç›¸åº”çš„ ELF æ–‡ä»¶å¤´å’Œâ€œ.dynamicâ€æ®µï¼Œç„¶åå°†å®ƒç›¸åº”çš„ä»£ç æ®µå’Œæ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ä¸­ã€‚å¦‚æœè¿™ä¸ª ELF å…±äº«å¯¹è±¡è¿˜ä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ï¼Œé‚£ä¹ˆå°†æ‰€ä¾èµ–çš„å…±äº«å¯¹è±¡çš„åå­—æ”¾åˆ°è£…è½½é›†åˆä¸­ã€‚å¦‚æ­¤å¾ªç¯ç›´åˆ°æ‰€æœ‰ä¾èµ–çš„å…±äº«å¯¹è±¡éƒ½è¢«è£…è½½è¿›æ¥ä¸ºæ­¢ã€‚</p><p><strong>ç¬¦å·çš„ä¼˜å…ˆçº§</strong></p><p>åœ¨åŠ¨æ€é“¾æ¥å™¨æŒ‰ç…§å„ä¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯¹å®ƒä»¬è¿›è¡Œè£…è½½å¹¶ä¸”å°†å®ƒä»¬çš„ç¬¦å·å¹¶å…¥åˆ°å…¨å±€ç¬¦å·è¡¨æ—¶ï¼Œä¼šä¸ä¼šæœ‰è¿™ä¹ˆä¸€ç§æƒ…å†µå‘ç”Ÿï¼Œé‚£å°±æ˜¯æœ‰å¯èƒ½ä¸¤ä¸ªä¸åŒçš„æ¨¡å—å®šä¹‰äº†åŒä¸€ä¸ªç¬¦å·ï¼Ÿä¸€ä¸ªå…±äº«å¯¹è±¡é‡Œé¢çš„å…¨å±€ç¬¦å·è¢«å¦ä¸€ä¸ªå…±äº«å¯¹è±¡çš„åŒåå…¨å±€ç¬¦å·è¦†ç›–çš„ç°è±¡è¢«ç§°ä¸ºå…±äº«å¯¹è±¡å…¨å±€ç¬¦å·ä»‹å…¥ï¼ˆGlobal Symbol Interposeï¼‰ã€‚</p><p>å…³äºå…¨å±€ç¬¦å·ä»‹å…¥è¿™ä¸ªé—®é¢˜ï¼Œå®é™…ä¸Š Linux ä¸‹çš„åŠ¨æ€é“¾æ¥å™¨æ˜¯è¿™æ ·å¤„ç†çš„ï¼šå®ƒå®šä¹‰äº†ä¸€ä¸ªè§„åˆ™ï¼Œé‚£å°±æ˜¯å½“ä¸€ä¸ªç¬¦å·éœ€è¦è¢«åŠ å…¥å…¨å±€ç¬¦å·è¡¨æ—¶ï¼Œå¦‚æœç›¸åŒçš„ç¬¦å·åå·²ç»å­˜åœ¨ï¼Œåˆ™ååŠ å…¥çš„ç¬¦å·è¢«å¿½ç•¥ã€‚</p><p><strong>å…¨å±€ç¬¦å·ä»‹å…¥ä¸åœ°å€æ— å…³ä»£ç </strong></p><p>å‰é¢ä»‹ç»åœ°å€æ— å…³ä»£ç æ—¶ï¼Œå¯¹äºç¬¬ä¸€ç±»æ¨¡å—å†…éƒ¨è°ƒç”¨æˆ–è·³è½¬çš„å¤„ç†æ—¶ï¼Œæˆ‘ä»¬ç®€å•åœ°å°†å…¶å½“ä½œæ˜¯ç›¸å¯¹åœ°å€è°ƒç”¨/è·³è½¬ã€‚ä½†å®é™…ä¸Šè¿™ä¸ªé—®é¢˜æ¯”æƒ³è±¡ä¸­è¦å¤æ‚ï¼Œç»“åˆå…¨å±€ç¬¦å·ä»‹å…¥ï¼Œå…³äºè°ƒç”¨æ–¹å¼çš„åˆ†ç±»çš„è§£é‡Šä¼šæ›´åŠ æ¸…æ¥šã€‚è¿˜æ˜¯æ‹¿å‰é¢â€œpic.câ€çš„ä¾‹å­æ¥çœ‹ï¼Œç”±äºå¯èƒ½å­˜åœ¨å…¨å±€ç¬¦å·ä»‹å…¥çš„é—®é¢˜ï¼Œfoo() å‡½æ•°å¯¹äº bar() çš„è°ƒç”¨ä¸èƒ½å¤Ÿé‡‡ç”¨ç¬¬ä¸€ç±»æ¨¡å—å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºä¸€æ—¦ bar å‡½æ•°ç”±äºå…¨å±€ç¬¦å·ä»‹å…¥è¢«å…¶ä»–æ¨¡å—ä¸­çš„åŒåå‡½æ•°è¦†ç›–ï¼Œé‚£ä¹ˆ foo å¦‚æœé‡‡ç”¨ç›¸å¯¹åœ°å€è°ƒç”¨çš„è¯ï¼Œé‚£ä¸ªç›¸å¯¹åœ°å€éƒ¨åˆ†å°±éœ€è¦é‡å®šä½ï¼Œè¿™åˆä¸å…±äº«å¯¹è±¡çš„åœ°å€æ— å…³æ€§çŸ›ç›¾ã€‚æ‰€ä»¥å¯¹äº bar() å‡½æ•°çš„è°ƒç”¨ï¼Œç¼–è¯‘å™¨åªèƒ½é‡‡ç”¨ç¬¬ä¸‰ç§ï¼Œå³å½“ä½œæ¨¡å—å¤–éƒ¨ç¬¦å·å¤„ç†ï¼Œbar() å‡½æ•°è¢«è¦†ç›–ï¼ŒåŠ¨æ€é“¾æ¥å™¨åªéœ€è¦é‡å®šä½â€œ.got.pltâ€ï¼Œä¸å½±å“å…±äº«å¯¹è±¡çš„ä»£ç æ®µã€‚ ä¸ºäº†æé«˜æ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨çš„æ•ˆç‡ï¼Œæœ‰ä¸€ä¸ªåŠæ³•æ˜¯æŠŠ bar() å‡½æ•°å˜æˆç¼–è¯‘å•å…ƒç§æœ‰å‡½æ•°ï¼Œå³ä½¿ç”¨â€œstaticâ€å…³é”®å­—å®šä¹‰ bar() å‡½æ•°ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨è¦ç¡®å®š bar() å‡½æ•°ä¸è¢«å…¶ä»–æ¨¡å—è¦†ç›–ï¼Œå°±å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ç±»çš„æ–¹æ³•ï¼Œå³æ¨¡å—å†…éƒ¨è°ƒç”¨æŒ‡ä»¤ï¼Œå¯ä»¥åŠ å¿«å‡½æ•°çš„è°ƒç”¨é€Ÿåº¦ã€‚</p><h2 id="é‡å®šä½å’Œåˆå§‹åŒ–">é‡å®šä½å’Œåˆå§‹åŒ–</h2><p>å½“ä¸Šé¢çš„æ­¥éª¤å®Œæˆä¹‹åï¼Œé“¾æ¥å™¨å¼€å§‹é‡æ–°éå†å¯æ‰§è¡Œæ–‡ä»¶å’Œæ¯ä¸ªå…±äº«å¯¹è±¡çš„é‡å®šä½è¡¨ï¼Œå°†å®ƒä»¬çš„ GOT/PLT ä¸­çš„æ¯ä¸ªéœ€è¦é‡å®šä½çš„ä½ç½®è¿›è¡Œä¿®æ­£ã€‚æ­¤æ—¶åŠ¨æ€é“¾æ¥å™¨å·²ç»æ‹¥æœ‰äº†è¿›ç¨‹çš„å…¨å±€ç¬¦å·è¡¨ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ä»‹ç»äº†ã€‚</p><p>é‡å®šä½å®Œæˆä¹‹åï¼Œå¦‚æœæŸä¸ªå…±äº«å¯¹è±¡æœ‰â€œ.initâ€æ®µï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥å™¨ä¼šæ‰§è¡Œâ€œ.initâ€æ®µä¸­çš„ä»£ç ï¼Œç”¨ä»¥å®ç°å…±äº«å¯¹è±¡ç‰¹æœ‰çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„ï¼Œå…±äº«å¯¹è±¡ä¸­çš„ C++çš„å…¨å±€/é™æ€å¯¹è±¡çš„æ„é€ å°±éœ€è¦é€šè¿‡â€œ.initâ€æ¥åˆå§‹åŒ–ã€‚ç›¸åº”åœ°ï¼Œå…±äº«å¯¹è±¡ä¸­è¿˜å¯èƒ½æœ‰â€œ.finitâ€æ®µï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶ä¼šæ‰§è¡Œâ€œ.finit'â€æ®µä¸­çš„ä»£ç ï¼Œå¯ä»¥ç”¨æ¥å®ç°ç±»ä¼¼ C++å…¨å±€å¯¹è±¡ææ„ä¹‹ç±»çš„æ“ä½œã€‚</p><p>å¦‚æœè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ä¹Ÿæœ‰â€œ.initâ€æ®µï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥å™¨ä¸ä¼šæ‰§è¡Œå®ƒï¼Œå› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„â€œ.initâ€æ®µå’Œâ€œ.finit'â€æ®µç”±ç¨‹åºåˆå§‹åŒ–éƒ¨åˆ†ä»£ç è´Ÿè´£æ‰§è¡Œã€‚</p><p>å½“å®Œæˆäº†é‡å®šä½å’Œåˆå§‹åŒ–ä¹‹åï¼Œæ‰€æœ‰çš„å‡†å¤‡å·¥ä½œå°±å®£å‘Šå®Œæˆäº†ï¼Œæ‰€éœ€è¦çš„å…±äº«å¯¹è±¡ä¹Ÿéƒ½å·²ç»è£…è½½å¹¶ä¸”é“¾æ¥å®Œæˆäº†ï¼Œè¿™æ—¶å€™åŠ¨æ€é“¾æ¥å™¨å°†è¿›ç¨‹çš„æ§åˆ¶æƒè½¬äº¤ç»™ç¨‹åºçš„å…¥å£å¹¶ä¸”å¼€å§‹æ‰§è¡Œã€‚</p><h1 id="linux-åŠ¨æ€é“¾æ¥å™¨å®ç°">Linux åŠ¨æ€é“¾æ¥å™¨å®ç°</h1><p>å…³äºåŠ¨æ€é“¾æ¥å™¨çš„å®ç°çš„å‡ ä¸ªé—®é¢˜è¿˜æ˜¯å¾ˆå€¼å¾—æ€è€ƒçš„ï¼š</p><ul><li><p>åŠ¨æ€é“¾æ¥å™¨æœ¬èº«æ˜¯åŠ¨æ€é“¾æ¥çš„è¿˜æ˜¯é™æ€é“¾æ¥çš„ï¼Ÿ åŠ¨æ€é“¾æ¥å™¨æœ¬èº«åº”è¯¥æ˜¯é™æ€é“¾æ¥çš„ï¼Œå®ƒä¸èƒ½ä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ï¼ŒåŠ¨æ€é“¾æ¥å™¨æœ¬èº«æ˜¯ç”¨æ¥å¸®åŠ©å…¶ä»– ELF æ–‡ä»¶è§£å†³å…±äº«å¯¹è±¡ä¾èµ–é—®é¢˜çš„ï¼Œå¦‚æœå®ƒä¹Ÿä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ï¼Œé‚£ä¹ˆè°æ¥å¸®å®ƒè§£å†³ä¾èµ–é—®é¢˜ï¼Ÿæ‰€ä»¥å®ƒæœ¬èº«å¿…é¡»ä¸ä¾èµ–äºå…¶ä»–å…±äº«å¯¹è±¡ã€‚è¿™ä¸€ç‚¹å¯ä»¥ä½¿ç”¨ ldd æ¥åˆ¤æ–­ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldd /lib/ld-linux.so.2</span><br><span class="line">statically linked</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>åŠ¨æ€é“¾æ¥å™¨æœ¬èº«å¿…é¡»æ˜¯ PIC çš„å—ï¼Ÿ æ˜¯ä¸æ˜¯ PIC å¯¹äºåŠ¨æ€é“¾æ¥å™¨æ¥è¯´å¹¶ä¸å…³é”®ï¼ŒåŠ¨æ€é“¾æ¥å™¨å¯ä»¥æ˜¯ PIC çš„ä¹Ÿå¯ä»¥ä¸æ˜¯ï¼Œä½†å¾€å¾€ä½¿ç”¨ PIC ä¼šæ›´åŠ ç®€å•ä¸€äº›ã€‚ä¸€æ–¹é¢ï¼Œå¦‚æœä¸æ˜¯ PIC çš„è¯ï¼Œä¼šä½¿å¾—ä»£ç æ®µæ— æ³•å…±äº«ï¼Œæµªè´¹å†…å­˜ï¼›å¦ä¸€æ–¹é¢ä¹Ÿä¼šä½¿ ld.so æœ¬èº«åˆå§‹åŒ–æ›´åŠ å¤æ‚ï¼Œå› ä¸ºè‡ªä¸¾æ—¶è¿˜éœ€è¦å¯¹ä»£ç æ®µè¿›è¡Œé‡å®šä½ã€‚å®é™…ä¸Šçš„ ld-linux.so.2 æ˜¯ PIC çš„</p></li><li><p>åŠ¨æ€é“¾æ¥å™¨å¯ä»¥è¢«å½“ä½œå¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œï¼Œé‚£ä¹ˆä»–çš„è£…è½½åœ°å€åº”è¯¥æ˜¯å¤šå°‘ï¼Ÿ ld.so çš„è£…è½½åœ°å€è·Ÿä¸€èˆ¬çš„å…±äº«å¯¹è±¡æ²¡åŒºåˆ«ï¼Œå³ä¸º 0x00000000ã€‚è¿™ä¸ªè£…è½½åœ°å€æ˜¯ä¸€ä¸ªæ— æ•ˆçš„è£…è½½åœ°å€ï¼Œä½œä¸ºä¸€ä¸ªå…±äº«åº“ï¼Œå†…æ ¸åœ¨è£…è½½å®ƒæ—¶ä¼šä¸ºå…¶é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è£…è½½åœ°å€</p></li></ul><h1 id="æ˜¾å¼è¿è¡Œæ—¶é“¾æ¥">æ˜¾å¼è¿è¡Œæ—¶é“¾æ¥</h1><p>æ˜¾å¼è¿è¡Œæ—¶é“¾æ¥ï¼ˆExplicit Run-time Linkingï¼‰æœ‰æ—¶å€™ä¹Ÿå«åšè¿è¡Œæ—¶åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è®©ç¨‹åºè‡ªå·±åœ¨è¿è¡Œæ—¶æ§åˆ¶åŠ è½½æŒ‡å®šçš„æ¨¡å—ï¼Œå¹¶ä¸”å¯ä»¥å°†å…¶å¸è½½ã€‚è¿™ç§å…±äº«å¯¹è±¡å¾€å¾€è¢«å«åšåŠ¨æ€è£…è½½åº“ï¼ˆDynamic Loading Libraryï¼‰ï¼Œå…¶å®æœ¬è´¨ä¸Šå®ƒè·Ÿä¸€èˆ¬çš„å…±äº«å¯¹è±¡æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œåªæ˜¯ç¨‹åºå¼€å‘è€…ä½¿ç”¨å®ƒçš„è§’åº¦ä¸åŒã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Links Libraries </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾æ¥è£…è½½ä¸åº“ï¼ˆå››ï¼‰å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ä¸è¿›ç¨‹</title>
      <link href="/2021/Program/LinksAndLibrariesPart4/"/>
      <url>/2021/Program/LinksAndLibrariesPart4/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/LoadingAndProcessingOfExecutableFiles.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMwYTZlNzA3OTEyOTA3YzI4NjNmZmM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="è£…è½½çš„æ–¹å¼">è£…è½½çš„æ–¹å¼</h1><p>ç¨‹åºæ‰§è¡Œæ—¶æ‰€éœ€è¦çš„æŒ‡ä»¤å’Œæ•°æ®å¿…é¡»åœ¨å†…å­˜ä¸­æ‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°†ç¨‹åºè¿è¡Œæ‰€éœ€è¦çš„æŒ‡ä»¤å’Œæ•°æ®å…¨éƒ½è£…å…¥å†…å­˜ä¸­ï¼Œè¿™å°±æ˜¯æœ€ç®€å•çš„é™æ€è£…å…¥çš„åŠæ³•ã€‚åæ¥ç ”ç©¶å‘ç°ï¼Œç¨‹åºè¿è¡Œæ—¶æ˜¯æœ‰å±€éƒ¨æ€§åŸç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†ç¨‹åºæœ€å¸¸ç”¨çš„éƒ¨åˆ†é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œè€Œå°†ä¸€äº›ä¸å¤ªå¸¸ç”¨çš„æ•°æ®å­˜æ”¾åœ¨ç£ç›˜é‡Œé¢ï¼Œè¿™å°±æ˜¯åŠ¨æ€è£…å…¥çš„åŸºæœ¬åŸç†ã€‚</p><p>è¦†ç›–è£…å…¥ï¼ˆOverlayï¼‰å’Œé¡µæ˜ å°„ï¼ˆPagingï¼‰æ˜¯ä¸¤ç§å¾ˆå…¸å‹çš„åŠ¨æ€è£…è½½æ–¹æ³•ï¼Œå®ƒä»¬æ‰€é‡‡ç”¨çš„æ€æƒ³éƒ½å·®ä¸å¤šï¼ŒåŸåˆ™ä¸Šéƒ½æ˜¯åˆ©ç”¨äº†ç¨‹åºçš„å±€éƒ¨æ€§åŸç†ã€‚åŠ¨æ€è£…å…¥çš„æ€æƒ³æ˜¯ç¨‹åºç”¨åˆ°å“ªä¸ªæ¨¡å—ï¼Œå°±å°†å“ªä¸ªæ¨¡å—è£…å…¥å†…å­˜ï¼Œå¦‚æœä¸ç”¨å°±æš‚æ—¶ä¸è£…å…¥ï¼Œå­˜æ”¾åœ¨ç£ç›˜ä¸­ã€‚</p><h2 id="é¡µæ˜ å°„">é¡µæ˜ å°„</h2><p>å°†å†…å­˜å’Œæ‰€æœ‰ç£ç›˜ä¸­çš„æ•°æ®å’ŒæŒ‡ä»¤æŒ‰ç…§â€œé¡µï¼ˆPageï¼‰â€ä¸ºå•ä½åˆ’åˆ†æˆè‹¥å¹²ä¸ªé¡µï¼Œä»¥åæ‰€æœ‰çš„è£…è½½å’Œæ“ä½œçš„å•ä½å°±æ˜¯é¡µã€‚</p><p>ä¸ºäº†æ¼”ç¤ºé¡µæ˜ å°„çš„åŸºæœ¬æœºåˆ¶ï¼Œå‡è®¾æˆ‘ä»¬çš„ 32 ä½æœºå™¨æœ‰ 16KB çš„å†…å­˜ï¼Œæ¯ä¸ªé¡µå¤§å°ä¸º 4096 å­—èŠ‚ï¼Œåˆ™å…±æœ‰ 4 ä¸ªé¡µï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr class="header"><th>é¡µç¼–å·</th><th>åœ°å€</th></tr></thead><tbody><tr class="odd"><td>F0</td><td>0x00000000 - 0xFFFFF000</td></tr><tr class="even"><td>F1</td><td>0x00001000 - 0x00001FFF</td></tr><tr class="odd"><td>F2</td><td>0X00002000 - 0X00002FFF</td></tr><tr class="even"><td>F3</td><td>0X00003000 - 0X00003FFF</td></tr></tbody></table><p>å‡è®¾ç¨‹åºæ‰€æœ‰çš„æŒ‡ä»¤å’Œæ•°æ®æ€»å’Œä¸º 32KBï¼Œé‚£ä¹ˆç¨‹åºæ€»å…±è¢«åˆ†ä¸º 8 ä¸ªé¡µã€‚æˆ‘ä»¬å°†å®ƒä»¬ç¼–å·ä¸º P0~P7ã€‚å¾ˆæ˜æ˜¾ï¼Œ16KB çš„å†…å­˜æ— æ³•åŒæ—¶å°† 32KB çš„ç¨‹åºè£…å…¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æŒ‰ç…§åŠ¨æ€è£…å…¥çš„åŸç†æ¥è¿›è¡Œæ•´ä¸ªè£…å…¥è¿‡ç¨‹ã€‚å¦‚æœç¨‹åºåˆšå¼€å§‹æ‰§è¡Œæ—¶çš„å…¥å£åœ°å€åœ¨ P0ï¼Œè¿™æ—¶è£…è½½ç®¡ç†å™¨å‘ç°ç¨‹åºçš„ P0 ä¸åœ¨å†…å­˜ä¸­ï¼Œäºæ˜¯å°†å†…å­˜ F0 åˆ†é…ç»™ P0ï¼Œå¹¶ä¸”å°† P0 çš„å†…å®¹è£…å…¥ F0ï¼›è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åï¼Œç¨‹åºéœ€è¦ç”¨åˆ° P5ï¼Œäºæ˜¯è£…è½½ç®¡ç†å™¨å°† P5 è£…å…¥ F1ï¼›å°±è¿™æ ·ï¼Œå½“ç¨‹åºç”¨åˆ° P3 å’Œ P6 çš„æ—¶å€™ï¼Œå®ƒä»¬åˆ†åˆ«è¢«è£…å…¥åˆ°äº† F2 å’Œ F3ï¼Œå®ƒä»¬çš„æ˜ å°„å…³ç³»å¦‚å›¾ 6-4 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load4.png"></p><p>å¾ˆæ˜æ˜¾ï¼Œå¦‚æœè¿™æ—¶å€™ç¨‹åºåªéœ€è¦ P0ã€P3ã€P5 å’Œ P6 è¿™ 4 ä¸ªé¡µï¼Œé‚£ä¹ˆç¨‹åºå°±èƒ½ä¸€ç›´è¿è¡Œä¸‹å»ã€‚ä½†æ˜¯é—®é¢˜å¾ˆæ˜æ˜¾ï¼Œå¦‚æœè¿™æ—¶å€™ç¨‹åºéœ€è¦è®¿é—® P4ï¼Œé‚£ä¹ˆè£…è½½ç®¡ç†å™¨å¿…é¡»åšå‡ºæŠ‰æ‹©ï¼Œå®ƒå¿…é¡»æ”¾å¼ƒç›®å‰æ­£åœ¨ä½¿ç”¨çš„ 4 ä¸ªå†…å­˜é¡µä¸­çš„å…¶ä¸­ä¸€ä¸ªæ¥è£…è½½ P4ã€‚è‡³äºé€‰æ‹©å“ªä¸ªé¡µï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šç§ç®—æ³•å¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚å¯ä»¥é€‰æ‹© F0ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€ä¸ªè¢«åˆ†é…æ‰çš„å†…å­˜é¡µï¼ˆè¿™ä¸ªç®—æ³•æˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º FIFOï¼Œå…ˆè¿›å…ˆå‡ºç®—æ³•ï¼‰ï¼šå‡è®¾è£…è½½ç®¡ç†å™¨å‘ç° F2 å¾ˆå°‘è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹© F2ï¼ˆè¿™ç§ç®—æ³•å¯ä»¥ç§°ä¹‹ä¸º LURï¼Œæœ€å°‘ä½¿ç”¨ç®—æ³•ï¼‰ã€‚</p><h1 id="ä»æ“ä½œç³»ç»Ÿè§’åº¦çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½">ä»æ“ä½œç³»ç»Ÿè§’åº¦çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½</h1><h2 id="è¿›ç¨‹çš„å»ºç«‹">è¿›ç¨‹çš„å»ºç«‹</h2><p>åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åè£…è½½ç›¸åº”çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸”æ‰§è¡Œã€‚åœ¨æœ‰è™šæ‹Ÿå­˜å‚¨çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°è¿‡ç¨‹æœ€å¼€å§‹åªéœ€è¦åšä¸‰ä»¶äº‹æƒ…ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå»ºç«‹è™šæ‹Ÿç©ºé—´åˆ°ç‰©ç†ç©ºé—´çš„æ˜ å°„å…³ç³»ã€‚åˆ›å»ºè™šæ‹Ÿåœ°å€ç©ºé—´å®é™…ä¸Šåªæ˜¯åˆ†é…ä¸€ä¸ªé¡µç›®å½•ï¼ˆPage Directoryï¼‰å°±å¯ä»¥äº†ï¼Œç”šè‡³ä¸è®¾ç½®é¡µæ˜ å°„å…³ç³»ï¼Œè¿™äº›æ˜ å°„å…³ç³»ç­‰åˆ°åé¢ç¨‹åºå‘ç”Ÿé¡µé”™è¯¯çš„æ—¶å€™å†è¿›è¡Œè®¾ç½®ã€‚</li><li>è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¤´ï¼Œå»ºç«‹è™šæ‹Ÿç©ºé—´ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ˜ å°„å…³ç³»ï¼Œæ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šâ€œè£…è½½â€çš„è¿‡ç¨‹ã€‚</li><li>å°† CPU çš„æŒ‡ä»¤å¯„å­˜å™¨è®¾ç½®æˆå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œå¯åŠ¨è¿è¡Œã€‚è¿™ä¸€æ­¥çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸Šåœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šæ¯”è¾ƒå¤æ‚ï¼Œå®ƒæ¶‰åŠå†…æ ¸å †æ ˆå’Œç”¨æˆ·å †æ ˆçš„åˆ‡æ¢ã€CPU è¿è¡Œæƒé™çš„åˆ‡æ¢ã€‚ä¸è¿‡ä»è¿›ç¨‹çš„è§’åº¦çœ‹è¿™ä¸€æ­¥å¯ä»¥ç®€å•åœ°è®¤ä¸ºæ“ä½œç³»ç»Ÿæ‰§è¡Œäº†ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œç›´æ¥è·³è½¬åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ã€‚è¿˜è®°å¾— ELF æ–‡ä»¶å¤´ä¸­ä¿å­˜æœ‰å…¥å£åœ°å€å—ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯è¿™ä¸ªåœ°å€ã€‚</li></ul><p>è®©æˆ‘ä»¬è€ƒè™‘æœ€ç®€å•çš„æƒ…å†µï¼Œå‡è®¾æˆ‘ä»¬çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶åªæœ‰ä¸€ä¸ªä»£ç æ®µâ€œ.textâ€œï¼Œå®ƒçš„è™šæ‹Ÿåœ°å€ä¸º 0x08048000ï¼Œå®ƒåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ä¸º 0x000e1ï¼Œå¯¹é½ä¸º 0x1000ã€‚ä¸€æ—¦è¯¥å¯æ‰§è¡Œæ–‡ä»¶è¢«è£…è½½ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸æ‰§è¡Œè¯¥å¯æ‰§è¡Œæ–‡ä»¶è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´çš„æ˜ å°„å…³ç³»å¦‚å›¾ 6-5 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load5.png"></p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ˜ å°„å…³ç³»åªæ˜¯ä¿å­˜åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚Linux ä¸­å°†è¿›ç¨‹è™šæ‹Ÿç©ºé—´ä¸­çš„ä¸€ä¸ªæ®µå«åšè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼ŒVirtual Memory Areaï¼‰ã€‚æ¯”å¦‚ä¸Šä¾‹ä¸­ï¼Œæ“ä½œç³»ç»Ÿåˆ›å»ºè¿›ç¨‹åï¼Œä¼šåœ¨è¿›ç¨‹ç›¸åº”çš„æ•°æ®ç»“æ„ä¸­è®¾ç½®æœ‰ä¸€ä¸ªã€‚text æ®µçš„ VMAï¼šå®ƒåœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åœ°å€ä¸º 0x08048000~0x08049000ï¼Œå®ƒå¯¹åº” ELF æ–‡ä»¶ä¸­åç§»ä¸º 0 çš„ã€‚textï¼Œå®ƒçš„å±æ€§ä¸ºåªè¯»ï¼ˆä¸€èˆ¬ä»£ç æ®µéƒ½æ˜¯åªè¯»çš„ï¼‰ã€‚</p><h2 id="é¡µé”™è¯¯">é¡µé”™è¯¯</h2><p>ä¸Šé¢çš„æ­¥éª¤æ‰§è¡Œå®Œä»¥åï¼Œå…¶å®å¯æ‰§è¡Œæ–‡ä»¶çš„çœŸæ­£æŒ‡ä»¤å’Œæ•°æ®éƒ½æ²¡æœ‰è¢«è£…å…¥åˆ°å†…å­˜ä¸­ã€‚æ“ä½œç³»ç»Ÿåªæ˜¯é€šè¿‡å¯æ‰§è¡Œæ–‡ä»¶å¤´éƒ¨çš„ä¿¡æ¯å»ºç«‹èµ·å¯æ‰§è¡Œæ–‡ä»¶å’Œè¿›ç¨‹è™šå­˜ä¹‹é—´çš„æ˜ å°„å…³ç³»è€Œå·²ã€‚å‡è®¾åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç¨‹åºçš„å…¥å£åœ°å€ä¸º 0x08048000ï¼Œå³åˆšå¥½æ˜¯ã€‚text æ®µçš„èµ·å§‹åœ°å€ã€‚å½“ CPU å¼€å§‹æ‰“ç®—æ‰§è¡Œè¿™ä¸ªåœ°å€çš„æŒ‡ä»¤æ—¶ï¼Œå‘ç°é¡µé¢ 0x08048000~0x08049000 æ˜¯ä¸ªç©ºé¡µé¢ï¼Œäºæ˜¯å®ƒå°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªé¡µé”™è¯¯ï¼ˆPage Faultï¼‰ã€‚CPU å°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿæœ‰ä¸“é—¨çš„é¡µé”™è¯¯å¤„ç†ä¾‹ç¨‹æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚è¿™æ—¶å€™æˆ‘ä»¬å‰é¢æåˆ°çš„è£…è½½è¿‡ç¨‹çš„ç¬¬äºŒæ­¥å»ºç«‹çš„æ•°æ®ç»“æ„èµ·åˆ°äº†å¾ˆå…³é”®çš„ä½œç”¨ï¼Œæ“ä½œç³»ç»Ÿå°†æŸ¥è¯¢è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œç„¶åæ‰¾åˆ°ç©ºé¡µé¢æ‰€åœ¨çš„ VMAï¼Œè®¡ç®—å‡ºç›¸åº”çš„é¡µé¢åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åç§»ï¼Œç„¶ååœ¨ç‰©ç†å†…å­˜ä¸­åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå°†è¿›ç¨‹ä¸­è¯¥è™šæ‹Ÿé¡µä¸åˆ†é…çš„ç‰©ç†é¡µä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³»ï¼Œç„¶åæŠŠæ§åˆ¶æƒå†è¿˜å›ç»™è¿›ç¨‹ï¼Œè¿›ç¨‹ä»åˆšæ‰é¡µé”™è¯¯çš„ä½ç½®é‡æ–°å¼€å§‹æ‰§è¡Œã€‚</p><p>éšç€è¿›ç¨‹çš„æ‰§è¡Œï¼Œé¡µé”™è¯¯ä¹Ÿä¼šä¸æ–­åœ°äº§ç”Ÿï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šä¸ºè¿›ç¨‹åˆ†é…ç›¸åº”çš„ç‰©ç†é¡µé¢æ¥æ»¡è¶³è¿›ç¨‹æ‰§è¡Œçš„éœ€æ±‚ï¼Œå¦‚å›¾ 6-6 æ‰€ç¤ºã€‚å½“ç„¶æœ‰å¯èƒ½è¿›ç¨‹æ‰€éœ€è¦çš„å†…å­˜ä¼šè¶…è¿‡å¯ç”¨çš„å†…å­˜æ•°é‡ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰å¤šä¸ªè¿›ç¨‹åŒæ—¶æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™æ—¶å€™æ“ä½œç³»ç»Ÿå°±éœ€è¦ç²¾å¿ƒç»„ç»‡å’Œåˆ†é…ç‰©ç†å†…å­˜ï¼Œç”šè‡³æœ‰æ—¶å€™åº”å°†åˆ†é…ç»™è¿›ç¨‹çš„ç‰©ç†å†…å­˜æš‚æ—¶æ”¶å›ç­‰ï¼Œè¿™å°±æ¶‰åŠäº†æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå­˜å‚¨ç®¡ç†ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load6.png"></p><h1 id="è¿›ç¨‹è™šå­˜ç©ºé—´åˆ†å¸ƒ">è¿›ç¨‹è™šå­˜ç©ºé—´åˆ†å¸ƒ</h1><h2 id="elf-æ–‡ä»¶é“¾æ¥è§†å›¾å’Œæ‰§è¡Œè§†å›¾">ELF æ–‡ä»¶é“¾æ¥è§†å›¾å’Œæ‰§è¡Œè§†å›¾</h2><p>å½“æ®µçš„æ•°é‡å¢å¤šæ—¶ï¼Œå°±ä¼šäº§ç”Ÿç©ºé—´æµªè´¹çš„é—®é¢˜ã€‚å½“æˆ‘ä»¬ç«™åœ¨æ“ä½œç³»ç»Ÿè£…è½½å¯æ‰§è¡Œæ–‡ä»¶çš„è§’åº¦çœ‹é—®é¢˜æ—¶ï¼Œå¯ä»¥å‘ç°å®ƒå®é™…ä¸Šå¹¶ä¸å…³å¿ƒå¯æ‰§è¡Œæ–‡ä»¶å„ä¸ªæ®µæ‰€åŒ…å«çš„å®é™…å†…å®¹ï¼Œåªå…³å¿ƒä¸€äº›è·Ÿè£…è½½ç›¸å…³çš„é—®é¢˜ï¼Œæœ€ä¸»è¦çš„æ˜¯æ®µçš„æƒé™ï¼ˆå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰ã€‚åŸºæœ¬ä¸Šæ˜¯ä¸‰ç§ï¼š</p><ul><li>ä»¥ä»£ç æ®µä¸ºä»£è¡¨çš„æƒé™ä¸ºå¯è¯»å¯æ‰§è¡Œçš„æ®µã€‚</li><li>ä»¥æ•°æ®æ®µå’Œ BSS æ®µä¸ºä»£è¡¨çš„æƒé™ä¸ºå¯è¯»å¯å†™çš„æ®µã€‚</li><li>ä»¥åªè¯»æ•°æ®æ®µä¸ºä»£è¡¨çš„æƒé™ä¸ºåªè¯»çš„æ®µã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¾ˆç®€å•çš„æ–¹æ¡ˆå°±æ˜¯ï¼šå¯¹äºç›¸åŒæƒé™çš„æ®µï¼ŒæŠŠå®ƒä»¬åˆå¹¶åˆ°ä¸€èµ·å½“ä½œä¸€ä¸ªæ®µè¿›è¡Œæ˜ å°„ã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªæ®µåˆ†åˆ«å«â€œ.textâ€å’Œâ€œ.initâ€ï¼Œå®ƒä»¬åŒ…å«çš„åˆ†åˆ«æ˜¯ç¨‹åºçš„å¯æ‰§è¡Œä»£ç å’Œåˆå§‹åŒ–ä»£ç ï¼Œå¹¶ä¸”å®ƒä»¬çš„æƒé™ç›¸åŒï¼Œéƒ½æ˜¯å¯è¯»å¹¶ä¸”å¯æ‰§è¡Œçš„ã€‚å‡è®¾ã€‚text ä¸º 4097 å­—èŠ‚ï¼Œ.init ä¸º 512 å­—èŠ‚ï¼Œè¿™ä¸¤ä¸ªæ®µåˆ†åˆ«æ˜ å°„çš„è¯å°±è¦å ç”¨ä¸‰ä¸ªé¡µé¢ï¼Œä½†æ˜¯ï¼Œå¦‚æœå°†å®ƒä»¬åˆå¹¶æˆä¸€èµ·æ˜ å°„çš„è¯åªé¡»å ç”¨ä¸¤ä¸ªé¡µé¢ï¼Œå¦‚å›¾ 6-7 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load7.png"></p><p>ELF å¯æ‰§è¡Œæ–‡ä»¶å¼•å…¥äº†ä¸€ä¸ªæ¦‚å¿µå«åšâ€œSegmentâ€ï¼Œä¸€ä¸ªâ€œSegmentâ€åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§ç±»ä¼¼çš„â€œSectionâ€ã€‚æ­£å¦‚æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ï¼Œå¦‚æœå°†â€œ.textâ€æ®µå’Œâ€œ.initâ€æ®µåˆå¹¶åœ¨ä¸€èµ·çœ‹ä½œæ˜¯ä¸€ä¸ªâ€œSegment'â€ï¼Œé‚£ä¹ˆè£…è½½çš„æ—¶å€™å°±å¯ä»¥å°†å®ƒä»¬çœ‹ä½œä¸€ä¸ªæ•´ä½“ä¸€èµ·æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ å°„ä»¥ååœ¨è¿›ç¨‹è™šå­˜ç©ºé—´ä¸­åªæœ‰ä¸€ä¸ªç›¸å¯¹åº”çš„ VMAï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å¾ˆæ˜æ˜¾åœ°å‡å°‘é¡µé¢å†…éƒ¨ç¢ç‰‡ï¼Œä»è€ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚</p><blockquote><p>ä»é“¾æ¥çš„è§’åº¦çœ‹ï¼ŒELF æ–‡ä»¶æ˜¯æŒ‰â€œSectionâ€å­˜å‚¨çš„ï¼Œäº‹å®ä¹Ÿçš„ç¡®å¦‚æ­¤ï¼›ä»è£…è½½çš„è§’åº¦çœ‹ï¼ŒELF æ–‡ä»¶åˆå¯ä»¥æŒ‰ç…§â€œSegmentâ€åˆ’åˆ†ã€‚</p></blockquote><p>â€œSegment'â€çš„æ¦‚å¿µå®é™…ä¸Šæ˜¯ä»è£…è½½çš„è§’åº¦é‡æ–°åˆ’åˆ†äº† ELF çš„å„ä¸ªæ®µã€‚è€Œç³»ç»Ÿæ­£æ˜¯æŒ‰ç…§ã€â€œSegmentâ€è€Œä¸æ˜¯â€œSectionâ€æ¥æ˜ å°„å¯æ‰§è¡Œæ–‡ä»¶çš„ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªå¾ˆå°çš„ç¨‹åºï¼Œç¨‹åºæœ¬èº«æ˜¯ä¸åœåœ°å¾ªç¯æ‰§è¡Œâ€œsleepâ€æ“ä½œï¼Œé™¤éç”¨æˆ·å‘ä¿¡å·ç»™å®ƒï¼Œå¦åˆ™å°±ä¸€ç›´è¿è¡Œã€‚å®ƒçš„æºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬ä½¿ç”¨é™æ€è¿æ¥çš„æ–¹å¼å°†å…¶ç¼–è¯‘è¿æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åå¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶â€œSectionMapping.elfâ€æ˜¯ä¸€ä¸ª Linux ä¸‹å¾ˆå…¸å‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gcc</span> -static SectionMapping.c -o SectionMapping.elf</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ readelf å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­æ€»å…±æœ‰ 32 ä¸ªæ®µï¼ˆSectionï¼‰ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ readelf -S SectionMapping.elf</span><br><span class="line">There are 32 section headers, starting at offset 0xd4588:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .note.gnu.propert NOTE             0000000000400270  00000270</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [ 2] .note.gnu.build-i NOTE             0000000000400290  00000290</span><br><span class="line">       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">  [ 3] .note.ABI-tag     NOTE             00000000004002b4  000002b4</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">  [ 4] .rela.plt         RELA             00000000004002d8  000002d8</span><br><span class="line">       0000000000000240  0000000000000018  AI       0    20     8</span><br><span class="line">  [ 5] .init             PROGBITS         0000000000401000  00001000</span><br><span class="line">       000000000000001b  0000000000000000  AX       0     0     4</span><br><span class="line">  [ 6] .plt              PROGBITS         0000000000401020  00001020</span><br><span class="line">       0000000000000180  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 7] .text             PROGBITS         00000000004011a0  000011a0</span><br><span class="line">       00000000000919a0  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 8] __libc_freeres_fn PROGBITS         0000000000492b40  00092b40</span><br><span class="line">       0000000000001ca0  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 9] .fini             PROGBITS         00000000004947e0  000947e0</span><br><span class="line">       000000000000000d  0000000000000000  AX       0     0     4</span><br><span class="line">  [10] .rodata           PROGBITS         0000000000495000  00095000</span><br><span class="line">       000000000001bfcc  0000000000000000   A       0     0     32</span><br><span class="line">  [11] .stapsdt.base     PROGBITS         00000000004b0fcc  000b0fcc</span><br><span class="line">       0000000000000001  0000000000000000   A       0     0     1</span><br><span class="line">  [12] .eh_frame         PROGBITS         00000000004b0fd0  000b0fd0</span><br><span class="line">       000000000000a5d4  0000000000000000   A       0     0     8</span><br><span class="line">  [13] .gcc_except_table PROGBITS         00000000004bb5a4  000bb5a4</span><br><span class="line">       00000000000000b1  0000000000000000   A       0     0     1</span><br><span class="line">  [14] .tdata            PROGBITS         00000000004bd0c0  000bc0c0</span><br><span class="line">       0000000000000020  0000000000000000 WAT       0     0     8</span><br><span class="line">  [15] .tbss             NOBITS           00000000004bd0e0  000bc0e0</span><br><span class="line">       0000000000000040  0000000000000000 WAT       0     0     8</span><br><span class="line">  [16] .init_array       INIT_ARRAY       00000000004bd0e0  000bc0e0</span><br><span class="line">       0000000000000010  0000000000000008  WA       0     0     8</span><br><span class="line">  [17] .fini_array       FINI_ARRAY       00000000004bd0f0  000bc0f0</span><br><span class="line">       0000000000000010  0000000000000008  WA       0     0     8</span><br><span class="line">  [18] .data.rel.ro      PROGBITS         00000000004bd100  000bc100</span><br><span class="line">       0000000000002df4  0000000000000000  WA       0     0     32</span><br><span class="line">  [19] .got              PROGBITS         00000000004bfef8  000beef8</span><br><span class="line">       00000000000000f0  0000000000000000  WA       0     0     8</span><br><span class="line">  [20] .got.plt          PROGBITS         00000000004c0000  000bf000</span><br><span class="line">       00000000000000d8  0000000000000008  WA       0     0     8</span><br><span class="line">  [21] .data             PROGBITS         00000000004c00e0  000bf0e0</span><br><span class="line">       0000000000001a50  0000000000000000  WA       0     0     32</span><br><span class="line">  [22] __libc_subfreeres PROGBITS         00000000004c1b30  000c0b30</span><br><span class="line">       0000000000000048  0000000000000000  WA       0     0     8</span><br><span class="line">  [23] __libc_IO_vtables PROGBITS         00000000004c1b80  000c0b80</span><br><span class="line">       00000000000006a8  0000000000000000  WA       0     0     32</span><br><span class="line">  [24] __libc_atexit     PROGBITS         00000000004c2228  000c1228</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     8</span><br><span class="line">  [25] .bss              NOBITS           00000000004c2240  000c1230</span><br><span class="line">       0000000000001718  0000000000000000  WA       0     0     32</span><br><span class="line">  [26] __libc_freeres_pt NOBITS           00000000004c3958  000c1230</span><br><span class="line">       0000000000000028  0000000000000000  WA       0     0     8</span><br><span class="line">  [27] .comment          PROGBITS         0000000000000000  000c1230</span><br><span class="line">       000000000000002a  0000000000000001  MS       0     0     1</span><br><span class="line">  [28] .note.stapsdt     NOTE             0000000000000000  000c125c</span><br><span class="line">       00000000000013e8  0000000000000000           0     0     4</span><br><span class="line">  [29] .symtab           SYMTAB           0000000000000000  000c2648</span><br><span class="line">       000000000000af68  0000000000000018          30   734     8</span><br><span class="line">  [30] .strtab           STRTAB           0000000000000000  000cd5b0</span><br><span class="line">       0000000000006e81  0000000000000000           0     0     1</span><br><span class="line">  [31] .shstrtab         STRTAB           0000000000000000  000d4431</span><br><span class="line">       0000000000000157  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (<span class="built_in">link</span> order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ readelf å‘½ä»¤æ¥æŸ¥çœ‹ ELF çš„â€œSegmentâ€ã€‚æ­£å¦‚æè¿°â€œSectionâ€å±æ€§çš„ç»“æ„å«åšæ®µè¡¨ï¼Œæè¿°â€œSegment'â€çš„ç»“æ„å«ç¨‹åºå¤´ï¼ˆProgram Headerï¼‰ï¼Œå®ƒæè¿°äº† ELF æ–‡ä»¶è¯¥å¦‚ä½•è¢«æ“ä½œç³»ç»Ÿæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ readelf -l SectionMapping.elf</span><br><span class="line"></span><br><span class="line">Elf file <span class="built_in">type</span> is EXEC (Executable file)</span><br><span class="line">Entry point 0x401bc0</span><br><span class="line">There are 10 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x0000000000000518 0x0000000000000518  R      0x1000</span><br><span class="line">  LOAD           0x0000000000001000 0x0000000000401000 0x0000000000401000</span><br><span class="line">                 0x00000000000937ed 0x00000000000937ed  R E    0x1000</span><br><span class="line">  LOAD           0x0000000000095000 0x0000000000495000 0x0000000000495000</span><br><span class="line">                 0x0000000000026655 0x0000000000026655  R      0x1000</span><br><span class="line">  LOAD           0x00000000000bc0c0 0x00000000004bd0c0 0x00000000004bd0c0</span><br><span class="line">                 0x0000000000005170 0x00000000000068c0  RW     0x1000</span><br><span class="line">  NOTE           0x0000000000000270 0x0000000000400270 0x0000000000400270</span><br><span class="line">                 0x0000000000000020 0x0000000000000020  R      0x8</span><br><span class="line">  NOTE           0x0000000000000290 0x0000000000400290 0x0000000000400290</span><br><span class="line">                 0x0000000000000044 0x0000000000000044  R      0x4</span><br><span class="line">  TLS            0x00000000000bc0c0 0x00000000004bd0c0 0x00000000004bd0c0</span><br><span class="line">                 0x0000000000000020 0x0000000000000060  R      0x8</span><br><span class="line">  GNU_PROPERTY   0x0000000000000270 0x0000000000400270 0x0000000000400270</span><br><span class="line">                 0x0000000000000020 0x0000000000000020  R      0x8</span><br><span class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000000 0x0000000000000000  RW     0x10</span><br><span class="line">  GNU_RELRO      0x00000000000bc0c0 0x00000000004bd0c0 0x00000000004bd0c0</span><br><span class="line">                 0x0000000000002f40 0x0000000000002f40  R      0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.gnu.property .note.gnu.build-id .note.ABI-tag .rela.plt</span><br><span class="line">   01     .init .plt .text __libc_freeres_fn .fini</span><br><span class="line">   02     .rodata .stapsdt.base .eh_frame .gcc_except_table</span><br><span class="line">   03     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data __libc_subfreeres __libc_IO_vtables __libc_atexit .bss __libc_freeres_ptrs</span><br><span class="line">   04     .note.gnu.property</span><br><span class="line">   05     .note.gnu.build-id .note.ABI-tag</span><br><span class="line">   06     .tdata .tbss</span><br><span class="line">   07     .note.gnu.property</span><br><span class="line">   08</span><br><span class="line">   09     .tdata .init_array .fini_array .data.rel.ro .got</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­å…±æœ‰ 10 ä¸ª Segmentã€‚ä»è£…è½½çš„è§’åº¦çœ‹ï¼Œæˆ‘ä»¬ç›®å‰åªå…³å¿ƒä¸¤ä¸ªâ€œLOADâ€ç±»å‹çš„ Segmentï¼Œå› ä¸ºåªæœ‰å®ƒæ˜¯éœ€è¦è¢«æ˜ å°„çš„ï¼Œå…¶ä»–çš„è¯¸å¦‚â€œNOTEâ€ã€â€œTLSâ€ã€â€œGNU_STACKâ€éƒ½æ˜¯åœ¨è£…è½½æ—¶èµ·è¾…åŠ©ä½œç”¨çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚å¯ä»¥ç”¨å›¾ 6-8 æ¥è¡¨ç¤ºâ€œSectionMapping.elfâ€å¯æ‰§è¡Œæ–‡ä»¶çš„æ®µä¸è¿›ç¨‹è™šæ‹Ÿç©ºé—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>â€œSectionMapping.elfâ€è¢«é‡æ–°åˆ’åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæœ‰ä¸€äº›æ®µè¢«å½’å…¥å¯è¯»å¯æ‰§è¡Œçš„ï¼Œå®ƒä»¬è¢«ç»Ÿä¸€æ˜ å°„åˆ°ä¸€ä¸ª VMA0ï¼›å¦å¤–ä¸€éƒ¨åˆ†æ®µæ˜¯å¯è¯»å¯å†™çš„ï¼Œå®ƒä»¬è¢«æ˜ å°„åˆ°äº† VMA1ï¼›è¿˜æœ‰ä¸€éƒ¨åˆ†æ®µåœ¨ç¨‹åºè£…è½½æ—¶æ²¡æœ‰è¢«æ˜ å°„çš„ï¼Œå®ƒä»¬æ˜¯ä¸€äº›åŒ…å«è°ƒè¯•ä¿¡æ¯å’Œå­—ç¬¦ä¸²è¡¨ç­‰æ®µï¼Œè¿™äº›æ®µåœ¨ç¨‹åºæ‰§è¡Œæ—¶æ²¡æœ‰ç”¨ï¼Œæ‰€ä»¥ä¸éœ€è¦è¢«æ˜ å°„ã€‚å¾ˆæ˜æ˜¾ï¼Œæ‰€æœ‰ç›¸åŒå±æ€§çš„â€œSectionâ€è¢«å½’ç±»åˆ°ä¸€ä¸ªâ€œSegmentâ€ï¼Œå¹¶ä¸”æ˜ å°„åˆ°åŒä¸€ä¸ª VMAã€‚</p><p>æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œâ€œSegmentâ€å’Œâ€œSectionâ€æ˜¯ä»ä¸åŒçš„è§’åº¦æ¥åˆ’åˆ†åŒä¸€ä¸ª ELF æ–‡ä»¶ã€‚è¿™ä¸ªåœ¨ ELF ä¸­è¢«ç§°ä¸ºä¸åŒçš„è§†å›¾ï¼ˆViewï¼‰ï¼Œä»â€œSectionâ€çš„è§’åº¦æ¥çœ‹ ELF æ–‡ä»¶å°±æ˜¯é“¾æ¥è§†å›¾ï¼ˆLinking Viewï¼‰ï¼Œä»â€œSegmentâ€çš„è§’åº¦æ¥çœ‹å°±æ˜¯æ‰§è¡Œè§†å›¾ï¼ˆExecution Viewï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load8.png"></p><h2 id="å †å’Œæ ˆ">å †å’Œæ ˆ</h2><p>åœ¨æ“ä½œç³»ç»Ÿé‡Œé¢ï¼ŒVMA é™¤äº†è¢«ç”¨æ¥æ˜ å°„å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å„ä¸ªâ€œSegment'â€ä»¥å¤–ï¼Œå®ƒè¿˜å¯ä»¥æœ‰å…¶ä»–çš„ä½œç”¨ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡ä½¿ç”¨ VMA æ¥å¯¹è¿›ç¨‹çš„åœ°å€ç©ºé—´è¿›è¡Œç®¡ç†ã€‚æˆ‘ä»¬çŸ¥é“è¿›ç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™å®ƒè¿˜éœ€è¦ç”¨åˆ°æ ˆï¼ˆStackï¼‰ã€å †ï¼ˆHeapï¼‰ç­‰ç©ºé—´ï¼Œäº‹å®ä¸Šå®ƒä»¬åœ¨è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ä¸­çš„è¡¨ç°ä¹Ÿæ˜¯ä»¥ VMA çš„å½¢å¼å­˜åœ¨çš„ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ ˆå’Œå †åˆ†åˆ«éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ VMAã€‚åœ¨ Linux ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹â€œ/procâ€æ¥æŸ¥çœ‹è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´åˆ†å¸ƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./SectionMapping.elf &amp;</span><br><span class="line">[1]21963</span><br><span class="line">$ <span class="built_in">cat</span> /proc/21963/maps</span><br><span class="line">08048000-080b9000   r-xp    00000000    08:01   2801887 ./SectionMapping.elf</span><br><span class="line">080b9000-080bb000   rwxp    00070000    08:01   2801887 ./SectionMapping.elf</span><br><span class="line">080bb000-080de000   rwxp    080bb000    00:00   0       [heap]</span><br><span class="line">bf7ec000-bf802000   rw-p    bf7ec0000   00:00   0       [stack]</span><br><span class="line">ffffe000-fffff000   r-xp0   000000000:0 00:00   0       [vdso]</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„è¾“å‡ºç»“æœä¸­ï¼š</p><ul><li>ç¬¬ä¸€åˆ—æ˜¯ VMA çš„åœ°å€èŒƒå›´ã€‚</li><li>ç¬¬äºŒåˆ—æ˜¯ VMA çš„æƒé™ï¼Œâ€œrâ€è¡¨ç¤ºå¯è¯»ï¼Œâ€œwâ€è¡¨ç¤ºå¯å†™ï¼Œâ€œxâ€è¡¨ç¤ºå¯æ‰§è¡Œï¼Œâ€œpâ€è¡¨ç¤ºç§æœ‰ï¼ˆCOWï¼ŒCopy on Writeï¼‰ï¼Œâ€œs"è¡¨ç¤ºå…±äº«ã€‚</li><li>ç¬¬ä¸‰åˆ—æ˜¯åç§»ï¼Œè¡¨ç¤º VMA å¯¹åº”çš„ Segment åœ¨æ˜ åƒæ–‡ä»¶ä¸­çš„åç§»ã€‚</li><li>ç¬¬å››åˆ—è¡¨ç¤ºæ˜ åƒæ–‡ä»¶æ‰€åœ¨è®¾å¤‡çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚</li><li>ç¬¬äº”åˆ—è¡¨ç¤ºæ˜ åƒæ–‡ä»¶çš„èŠ‚ç‚¹å·ã€‚</li><li>æœ€åä¸€åˆ—æ˜¯æ˜ åƒæ–‡ä»¶çš„è·¯å¾„ã€‚</li></ul><blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿›ç¨‹ä¸­æœ‰ 5 ä¸ª VMAï¼Œåªæœ‰å‰ä¸¤ä¸ªæ˜¯æ˜ å°„åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ä¸¤ä¸ª Segmentã€‚å¦å¤–ä¸‰ä¸ªæ®µçš„æ–‡ä»¶æ‰€åœ¨è®¾å¤‡ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·åŠæ–‡ä»¶èŠ‚ç‚¹å·éƒ½æ˜¯ 0ï¼Œåˆ™è¡¨ç¤ºå®ƒä»¬æ²¡æœ‰æ˜ å°„åˆ°æ–‡ä»¶ä¸­ï¼Œè¿™ç§ VMA å«åšåŒ¿åè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆAnonymous Virtual Memory Areaï¼‰ã€‚</p></blockquote><p>å¦å¤–æœ‰ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„ VMA å«åšâ€œvdsoâ€ï¼Œå®ƒçš„åœ°å€å·±ç»ä½äºå†…æ ¸ç©ºé—´äº†ï¼ˆå³å¤§äº 0xC0000000 çš„åœ°å€ï¼‰ï¼Œäº‹å®ä¸Šå®ƒæ˜¯ä¸€ä¸ªå†…æ ¸çš„æ¨¡å—ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ª VMA æ¥è·Ÿå†…æ ¸è¿›è¡Œä¸€äº›é€šä¿¡ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œè®©æˆ‘ä»¬å°ç»“å…³äºè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ¦‚å¿µï¼šæ“ä½œç³»ç»Ÿé€šè¿‡ç»™è¿›ç¨‹ç©ºé—´åˆ’åˆ†å‡ºä¸€ä¸ªä¸ª VMA æ¥ç®¡ç†è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ï¼›åŸºæœ¬åŸåˆ™æ˜¯å°†ç›¸åŒæƒé™å±æ€§çš„ã€æœ‰ç›¸åŒæ˜ åƒæ–‡ä»¶çš„æ˜ å°„æˆä¸€ä¸ª VMAï¼›ä¸€ä¸ªè¿›ç¨‹åŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ VMA åŒºåŸŸï¼š</p><ul><li>ä»£ç  VMAï¼Œæƒé™åªè¯»ã€å¯æ‰§è¡Œï¼›æœ‰æ˜ åƒæ–‡ä»¶ã€‚</li><li>æ•°æ® VMAï¼Œæƒé™å¯è¯»å†™ã€å¯æ‰§è¡Œï¼›æœ‰æ˜ åƒæ–‡ä»¶ã€‚</li><li>å † VMAï¼Œæƒé™å¯è¯»å†™ã€å¯æ‰§è¡Œï¼šæ— æ˜ åƒæ–‡ä»¶ï¼ŒåŒ¿åï¼Œå¯å‘ä¸Šæ‰©å±•ã€‚</li><li>æ ˆ VMAï¼Œæƒé™å¯è¯»å†™ã€ä¸å¯æ‰§è¡Œï¼›æ— æ˜ åƒæ–‡ä»¶ï¼ŒåŒ¿åï¼Œå¯å‘ä¸‹æ‰©å±•ã€‚</li></ul><p>å½“æˆ‘ä»¬åœ¨è®¨è®ºè¿›ç¨‹è™šæ‹Ÿç©ºé—´çš„â€œSegmentâ€çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŒ‡ä¸Šé¢çš„å‡ ç§ VMAã€‚ç°åœ¨å†è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¸¸è§è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´æ˜¯æ€ä¹ˆæ ·çš„ï¼Œå¦‚å›¾ 6-9 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/load9.png"></p><h2 id="æ®µåœ°å€å¯¹é½">æ®µåœ°å€å¯¹é½</h2><p>å¦‚æœæœ‰å¾ˆå¤šæ®µçš„å¤§å°å¾ˆå°ï¼ŒæŒ‰ç…§ page å¯¹é½æ˜ å°„ä¼šé€ æˆç©ºé—´çš„æµªè´¹ï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæœ‰äº› UNIX ç³»ç»Ÿé‡‡ç”¨äº†ä¸€ä¸ªå¾ˆå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯è®©é‚£äº›å„ä¸ªæ®µæ¥å£¤éƒ¨åˆ†å…±äº«ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œç„¶åå°†è¯¥ç‰©ç†é¡µé¢åˆ†åˆ«æ˜ å°„å¤šæ¬¡ã€‚</p><h1 id="linux-å†…æ ¸è£…è½½-elf-è¿‡ç¨‹ç®€ä»‹">Linux å†…æ ¸è£…è½½ ELF è¿‡ç¨‹ç®€ä»‹</h1><p>å½“æˆ‘ä»¬åœ¨ Linux ç³»ç»Ÿçš„ bash ä¸‹è¾“å…¥ä¸€ä¸ªå‘½ä»¤æ‰§è¡ŒæŸä¸ª ELF ç¨‹åºæ—¶ï¼ŒLinux ç³»ç»Ÿæ˜¯æ€æ ·è£…è½½è¿™ä¸ª ELF æ–‡ä»¶å¹¶ä¸”æ‰§è¡Œå®ƒçš„å‘¢ï¼Ÿ é¦–å…ˆåœ¨ç”¨æˆ·å±‚é¢ï¼Œbash è¿›ç¨‹ä¼šè°ƒç”¨ fork() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç„¶åæ–°çš„è¿›ç¨‹è°ƒç”¨ execve() ç³»ç»Ÿè°ƒç”¨æ‰§è¡ŒæŒ‡å®šçš„ ELF æ–‡ä»¶ï¼ŒåŸå…ˆçš„ bash è¿›ç¨‹ç»§ç»­è¿”å›ç­‰å¾…åˆšæ‰å¯åŠ¨çš„æ–°è¿›ç¨‹ç»“æŸï¼Œç„¶åç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>]={<span class="number">0</span>};</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"minibashs"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"s"</span>,buf);</span><br><span class="line">        pid <span class="title function_">fork</span><span class="params">()</span>;</span><br><span class="line">        <span class="keyword">if</span>(pid =<span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">if</span>(execlp(buf,<span class="number">0</span>) &lt; <span class="number">0</span>) {</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"exec error\n"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt;<span class="number">0</span>) {</span><br><span class="line">            <span class="type">int</span> status;</span><br><span class="line">            waitpid(pid,&amp;status,<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"fork error &amp;d\n"</span>,pid);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿›å…¥ execve() ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼ŒLinux å†…æ ¸å°±å¼€å§‹è¿›è¡ŒçœŸæ­£çš„è£…è½½å·¥ä½œã€‚åœ¨å†…æ ¸ä¸­ï¼Œexecve() ç³»ç»Ÿè°ƒç”¨ç›¸åº”çš„å…¥å£æ˜¯ sys_execve()ï¼Œè¿›è¡Œä¸€äº›å‚æ•°çš„æ£€æŸ¥å¤åˆ¶ä¹‹åï¼Œè°ƒç”¨ do_execve()ã€‚do_execve() ä¼šé¦–å…ˆæŸ¥æ‰¾è¢«æ‰§è¡Œçš„æ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™è¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ã€‚(Linux æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸æ­¢ ELF ä¸€ç§ï¼Œè¿˜æœ‰ a.outã€Java ç¨‹åºå’Œä»¥â€œ#ï¼â€å¼€å§‹çš„è„šæœ¬ç¨‹åºï¼‰ã€‚</p><p>å½“ do_execve() è¯»å–äº†è¿™ 128 ä¸ªå­—èŠ‚çš„æ–‡ä»¶å¤´éƒ¨ä¹‹åï¼Œç„¶åè°ƒç”¨ search_binary_handle() å»æœç´¢å’ŒåŒ¹é…åˆé€‚çš„å¯æ‰§è¡Œæ–‡ä»¶è£…è½½å¤„ç†è¿‡ç¨‹ã€‚Linux ä¸­æ‰€æœ‰è¢«æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼éƒ½æœ‰ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹ï¼Œsearch_binary_handle() ä¼šé€šè¿‡åˆ¤æ–­æ–‡ä»¶å¤´éƒ¨çš„é­”æ•°ç¡®å®šæ–‡ä»¶çš„æ ¼å¼ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹ã€‚æ¯”å¦‚ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½å¤„ç†è¿‡ç¨‹å«åš load_elf_binary()ï¼›a.out å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½å¤„ç†è¿‡ç¨‹å«åš load_aout_binary()ï¼›è€Œè£…è½½å¯æ‰§è¡Œè„šæœ¬ç¨‹åºçš„å¤„ç†è¿‡ç¨‹å«åš load_script()ã€‚è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ï¼Œload_elf_binary()ï¼Œè¿™ä¸ªå‡½æ•°çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå®ƒçš„ä¸»è¦æ­¥éª¤æ˜¯ï¼š</p><ul><li>æ£€æŸ¥ ELF å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„æœ‰æ•ˆæ€§ï¼Œæ¯”å¦‚é­”æ•°ã€ç¨‹åºå¤´è¡¨ä¸­æ®µï¼ˆSegmentï¼‰çš„æ•°é‡ã€‚</li><li>å¯»æ‰¾åŠ¨æ€é“¾æ¥çš„â€œ.interpâ€æ®µï¼Œè®¾ç½®åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ã€‚</li><li>æ ¹æ® ELF å¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºå¤´è¡¨çš„æè¿°ï¼Œå¯¹ ELF æ–‡ä»¶è¿›è¡Œæ˜ å°„ï¼Œæ¯”å¦‚ä»£ç ã€æ•°æ®ã€åªè¯»æ•°æ®ã€‚</li><li>åˆå§‹åŒ– ELF è¿›ç¨‹ç¯å¢ƒï¼Œæ¯”å¦‚è¿›ç¨‹å¯åŠ¨æ—¶ EDX å¯„å­˜å™¨çš„åœ°å€åº”è¯¥æ˜¯ DT FINI çš„åœ°å€ã€‚</li><li>å°†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›åœ°å€ä¿®æ”¹æˆ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ç‚¹ï¼Œè¿™ä¸ªå…¥å£ç‚¹å–å†³äºç¨‹åºçš„é“¾æ¥æ–¹å¼ï¼Œå¯¹äºé™æ€é“¾æ¥çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªç¨‹åºå…¥å£å°±æ˜¯ ELF æ–‡ä»¶çš„æ–‡ä»¶å¤´ä¸­ e_entry æ‰€æŒ‡çš„åœ°å€ï¼›å¯¹äºåŠ¨æ€é“¾æ¥çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¨‹åºå…¥å£ç‚¹æ˜¯åŠ¨æ€é“¾æ¥å™¨ã€‚</li></ul><p>å½“ load_elf_binary() æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›è‡³ do_execve() å†è¿”å›è‡³ sys_execve() æ—¶ï¼Œä¸Šé¢çš„ç¬¬ 5 æ­¥ä¸­å·²ç»æŠŠç³»ç»Ÿè°ƒç”¨çš„è¿”å›åœ°å€æ”¹æˆäº†è¢«è£…è½½çš„ ELF ç¨‹åºçš„å…¥å£åœ°å€äº†ã€‚æ‰€ä»¥å½“ sys_execve() ç³»ç»Ÿè°ƒç”¨ä»å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€æ—¶ï¼ŒEIP å¯„å­˜å™¨ç›´æ¥è·³è½¬åˆ°äº† ELF ç¨‹åºçš„å…¥å£åœ°å€ï¼Œäºæ˜¯æ–°çš„ç¨‹åºå¼€å§‹æ‰§è¡Œï¼ŒELF å¯æ‰§è¡Œæ–‡ä»¶è£…è½½å®Œæˆã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Links Libraries </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾æ¥è£…è½½ä¸åº“ï¼ˆä¸‰ï¼‰é™æ€é“¾æ¥</title>
      <link href="/2021/Program/LinksAndLibrariesPart3/"/>
      <url>/2021/Program/LinksAndLibrariesPart3/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/Staticlinks.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMwODIzYWU0MDFmZDA3MjZiYTVjMzY=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><p>åœ¨è¿™ä¸€èŠ‚é‡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢è¿™ä¸¤ä¸ªæºä»£ç æ–‡ä»¶â€œa.câ€å’Œâ€œb.câ€ä½œä¸ºä¾‹å­å±•å¼€åˆ†æï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld1.png"></p><p>å‡è®¾æˆ‘ä»¬çš„ç¨‹åºåªæœ‰è¿™ä¸¤ä¸ªæ¨¡å—â€œa.câ€å’Œâ€œb.câ€ã€‚é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ gcc å°†â€œa.câ€å’Œâ€œb.câ€åˆ†åˆ«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶â€œa.oâ€å’Œâ€œb.oâ€ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c a.c b.c</span><br></pre></td></tr></tbody></table></figure><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œâ€œb.câ€æ€»å…±å®šä¹‰äº†ä¸¤ä¸ªå…¨å±€ç¬¦å·ï¼Œä¸€ä¸ªæ˜¯å˜é‡â€œsharedâ€ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å‡½æ•°â€œswapâ€ï¼›â€œa.câ€é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªå…¨å±€ç¬¦å·å°±æ˜¯â€œmainâ€ã€‚æ¨¡å—â€œa.câ€é‡Œé¢å¼•ç”¨åˆ°äº†â€œb.câ€é‡Œé¢çš„â€œswapâ€å’Œâ€œsharedâ€ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æŠŠâ€œa.oâ€å’Œâ€œb.oâ€è¿™ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶é“¾æ¥åœ¨ä¸€èµ·å¹¶æœ€ç»ˆå½¢æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶â€œabâ€ã€‚</p><h1 id="ç©ºé—´ä¸åœ°å€åˆ†é…">ç©ºé—´ä¸åœ°å€åˆ†é…</h1><p>å¯¹äºå¤šä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œé“¾æ¥å™¨å¦‚ä½•å°†å®ƒä»¬çš„å„ä¸ªæ®µåˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶ï¼Ÿ</p><h2 id="æŒ‰åºå åŠ ">æŒ‰åºå åŠ </h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld2.png"> å¦‚å›¾ 4-1 æ‰€ç¤ºï¼Œå°±æ˜¯ç›´æ¥å°†å„ä¸ªç›®æ ‡æ–‡ä»¶ä¾æ¬¡åˆå¹¶ï¼Œä½†æ˜¯åœ¨æœ‰å¾ˆå¤šè¾“å…¥æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œè¾“å‡ºæ–‡ä»¶å°†ä¼šæœ‰å¾ˆå¤šé›¶æ•£çš„æ®µï¼Œè¿™ç§åšæ³•éå¸¸æµªè´¹ç©ºé—´ï¼Œå› ä¸ºæ¯ä¸ªæ®µéƒ½é¡»è¦æœ‰ä¸€å®šçš„åœ°å€å’Œç©ºé—´å¯¹é½è¦æ±‚ã€‚</p><h2 id="ç›¸ä¼¼æ®µåˆå¹¶">ç›¸ä¼¼æ®µåˆå¹¶</h2><p>ä¸€ä¸ªæ›´å®é™…çš„æ–¹æ³•æ˜¯å°†ç›¸åŒæ€§è´¨çš„æ®µåˆå¹¶åˆ°ä¸€èµ·ï¼Œæ¯”å¦‚å°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„â€œ.textâ€åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„â€œ.textâ€æ®µï¼Œæ¥ç€æ˜¯â€œ.dataâ€æ®µã€â€œ.bssâ€æ®µç­‰ï¼Œå¦‚å›¾ 4-2 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld3.png"></p><blockquote><p>å¯¹äºæœ‰å®é™…æ•°æ®çš„æ®µï¼Œæ¯”å¦‚â€œ.textâ€å’Œâ€œ.dataâ€æ¥è¯´ï¼Œå®ƒä»¬åœ¨æ–‡ä»¶ä¸­å’Œè™šæ‹Ÿåœ°å€ä¸­éƒ½è¦åˆ†é…ç©ºé—´ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¿™ä¸¤è€…ä¸­éƒ½å­˜åœ¨ï¼›è€Œå¯¹äºâ€œ.bssâ€è¿™æ ·çš„æ®µæ¥è¯´ï¼Œåˆ†é…ç©ºé—´çš„æ„ä¹‰åªå±€é™äºè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå› ä¸ºå®ƒåœ¨æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰å†…å®¹ã€‚</p></blockquote><p>ä½¿ç”¨è¿™ç§æ–¹æ³•çš„é“¾æ¥å™¨ä¸€èˆ¬éƒ½é‡‡ç”¨ä¸€ç§å«ä¸¤æ­¥é“¾æ¥ï¼ˆTwo-pass Linkingï¼‰çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æ•´ä¸ªé“¾æ¥è¿‡ç¨‹åˆ†ä¸¤æ­¥ã€‚</p><ul><li>ç¬¬ä¸€æ­¥ç©ºé—´ä¸åœ°å€åˆ†é…æ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶ä¸”è·å¾—å®ƒä»¬çš„å„ä¸ªæ®µçš„é•¿åº¦ã€å±æ€§å’Œä½ç½®ï¼Œå¹¶ä¸”å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ªå…¨å±€ç¬¦å·è¡¨ã€‚</li><li>ç¬¬äºŒæ­¥ç¬¦å·è§£æä¸é‡å®šä½ä½¿ç”¨ä¸Šé¢ç¬¬ä¸€æ­¥ä¸­æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯»å–è¾“å…¥æ–‡ä»¶ä¸­æ®µçš„æ•°æ®ã€é‡å®šä½ä¿¡æ¯ï¼Œå¹¶ä¸”è¿›è¡Œç¬¦å·è§£æä¸é‡å®šä½ã€è°ƒæ•´ä»£ç ä¸­çš„åœ°å€ç­‰ï¼ˆæ ¸å¿ƒï¼‰ã€‚</li></ul><p>æˆ‘ä»¬ä½¿ç”¨ ld é“¾æ¥å™¨å°†â€œa.oâ€å’Œâ€œb.oâ€é“¾æ¥èµ·æ¥ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ld</span> a.o b.o -e main -o ab</span><br></pre></td></tr></tbody></table></figure><ul><li>-e main è¡¨ç¤ºå°† main å‡½æ•°ä½œä¸ºç¨‹åºå…¥å£ï¼Œld é“¾æ¥å™¨é»˜è®¤çš„ç¨‹åºå…¥å£ä¸º_startã€‚</li><li>-o ab è¡¨ç¤ºé“¾æ¥è¾“å‡ºæ–‡ä»¶åä¸º abï¼Œé»˜è®¤ä¸º a.outã€‚</li></ul><p>è®©æˆ‘ä»¬ä½¿ç”¨ objdump æ¥æŸ¥çœ‹é“¾æ¥å‰ååœ°å€çš„åˆ†é…æƒ…å†µï¼Œä»£ç å¦‚æ¸…å• 4-1 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld4.png"></p><blockquote><p>VMA è¡¨ç¤º Virtual Memory Addressï¼Œå³è™šæ‹Ÿåœ°å€ï¼ŒLMA è¡¨ç¤º Load Memory Addressï¼Œå³åŠ è½½åœ°å€ã€‚</p></blockquote><p>åœ¨é“¾æ¥ä¹‹å‰ï¼Œç›®æ ‡æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ®µçš„ VMA éƒ½æ˜¯ Oï¼Œå› ä¸ºè™šæ‹Ÿç©ºé—´è¿˜æ²¡æœ‰è¢«åˆ†é…ï¼Œç­‰åˆ°é“¾æ¥ä¹‹åï¼Œå¯æ‰§è¡Œæ–‡ä»¶â€œbâ€ä¸­çš„å„ä¸ªæ®µéƒ½è¢«åˆ†é…åˆ°äº†ç›¸åº”çš„è™šæ‹Ÿåœ°å€ã€‚è¿™é‡Œçš„è¾“å‡ºç¨‹åºâ€œabâ€ä¸­ï¼Œâ€œ.textâ€æ®µè¢«åˆ†é…åˆ°äº†åœ°å€ 0x08048094ï¼Œå¤§å°ä¸º 0x72 å­—èŠ‚ï¼›â€œ.dataâ€æ®µä»åœ°å€ 0x08049108 å¼€å§‹ï¼Œå¤§å°ä¸º 4 å­—èŠ‚ã€‚å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld5.png"></p><p>ä¸ºä»€ä¹ˆé“¾æ¥å™¨è¦å°†å¯æ‰§è¡Œæ–‡ä»¶â€œabâ€çš„â€œ.textâ€åˆ†é…åˆ° 0x08048094ã€å°†â€œ.dataâ€åˆ†é… 0x08049108ï¼Ÿè€Œä¸æ˜¯ä»è™šæ‹Ÿç©ºé—´çš„ 0 åœ°å€å¼€å§‹åˆ†é…å‘¢ï¼Ÿè¿™æ¶‰åŠæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†é…è§„åˆ™ï¼Œåœ¨ Linux ä¸‹ï¼ŒELF å¯æ‰§è¡Œæ–‡ä»¶é»˜è®¤ä»åœ°å€ 0x08048000 å¼€å§‹åˆ†é…ã€‚</p><h2 id="ç¬¦å·åœ°å€çš„ç¡®å®š">ç¬¦å·åœ°å€çš„ç¡®å®š</h2><p>å› ä¸ºå„ä¸ªç¬¦å·åœ¨æ®µå†…çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™å…¶å®â€œmainâ€ã€â€œsharedâ€å’Œâ€œswapâ€çš„åœ°å€ä¹Ÿå·²ç»æ˜¯ç¡®å®šçš„äº†ï¼Œåªä¸è¿‡é“¾æ¥å™¨é¡»è¦ç»™æ¯ä¸ªç¬¦å·åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè°ƒæ•´åˆ°æ­£ç¡®çš„è™šæ‹Ÿåœ°å€ã€‚æ¯”å¦‚æˆ‘ä»¬å‡è®¾â€œa.oâ€ä¸­çš„â€œmainâ€å‡½æ•°ç›¸å¯¹äºâ€œa.oâ€çš„â€œ.textâ€æ®µçš„åç§»æ˜¯ Xï¼Œä½†æ˜¯ç»è¿‡é“¾æ¥åˆå¹¶ä»¥åï¼Œâ€œa.oâ€çš„â€œ.textâ€æ®µä½äºè™šæ‹Ÿåœ°å€ 0x08048094ï¼Œé‚£ä¹ˆâ€œmainâ€çš„åœ°å€åº”è¯¥æ˜¯ 0x08048094+Xã€‚</p><h1 id="ç¬¦å·è§£æä¸é‡å®šä½">ç¬¦å·è§£æä¸é‡å®šä½</h1><h2 id="é‡å®šä½">é‡å®šä½</h2><p>ä½¿ç”¨ objdump çš„â€œ-dâ€å‚æ•°å¯ä»¥çœ‹åˆ°â€œa.oâ€çš„ä»£ç æ®µåæ±‡ç¼–ç»“æœï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld6.png"></p><p>æˆ‘ä»¬çŸ¥é“åœ¨ç¨‹åºçš„ä»£ç é‡Œé¢ä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œåœ¨è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°â€œmainâ€çš„èµ·å§‹åœ°å€ä¸º 0Ã—00000000ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æœªè¿›è¡Œå‰é¢æåˆ°è¿‡çš„ç©ºé—´åˆ†é…ä¹‹å‰ï¼Œç›®æ ‡æ–‡ä»¶ä»£ç æ®µä¸­çš„èµ·å§‹åœ°å€ä»¥ 0x00000000 å¼€å§‹ï¼Œç­‰åˆ°ç©ºé—´åˆ†é…å®Œæˆä»¥åï¼Œå„ä¸ªå‡½æ•°æ‰ä¼šç¡®å®šè‡ªå·±åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä½ç½®ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°â€œa.oâ€çš„åæ±‡ç¼–ç»“æœä¸­ï¼Œâ€œa.oâ€å…±å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° mainã€‚æœ€å·¦è¾¹é‚£åˆ—æ˜¯æ¯æ¡æŒ‡ä»¤çš„åç§»é‡ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€æ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬å·²ç»ç”¨ç²—ä½“æ ‡å‡ºäº†ä¸¤ä¸ªå¼•ç”¨â€œsharedâ€å’Œâ€œswapâ€çš„ä½ç½®ï¼Œå¯¹äºâ€œsharedâ€çš„å¼•ç”¨æ˜¯ä¸€æ¡â€œmovâ€æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤æ€»å…± 8 ä¸ªå­—èŠ‚ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†â€œsharedâ€çš„åœ°å€èµ‹å€¼åˆ° ESP å¯„å­˜å™¨+4 çš„åç§»åœ°å€ä¸­å»ï¼Œå‰é¢ 4 ä¸ªå­—èŠ‚æ˜¯æŒ‡ä»¤ç ï¼Œåé¢ 4 ä¸ªå­—èŠ‚æ˜¯â€œsharedâ€çš„åœ°å€ï¼Œæˆ‘ä»¬åªå…³å¿ƒåé¢çš„ 4 ä¸ªå­—èŠ‚éƒ¨åˆ†ï¼Œå¦‚å›¾ 4-4 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld7.png"></p><p>å½“æºä»£ç â€œa.câ€åœ¨è¢«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“â€œsharedâ€å’Œâ€œswapâ€çš„åœ°å€ã€‚æ‰€ä»¥ç¼–è¯‘å™¨å°±æš‚æ—¶æŠŠåœ°å€ O çœ‹ä½œæ˜¯â€œsharedâ€çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¡â€œmovâ€æŒ‡ä»¤ä¸­ï¼Œå…³äºâ€œsharedâ€çš„åœ°å€éƒ¨åˆ†ä¸ºâ€œ0x00000000â€ã€‚</p><p>å¦å¤–ä¸€ä¸ªæ˜¯åç§»ä¸º 0x26 çš„æŒ‡ä»¤çš„ä¸€æ¡è°ƒç”¨æŒ‡ä»¤ï¼Œå®ƒå…¶å®å°±è¡¨ç¤ºå¯¹ swap å‡½æ•°çš„è°ƒç”¨ï¼Œå¦‚å›¾ 4-5 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld8.png"></p><p>è¿™æ¡æŒ‡ä»¤å…± 5 ä¸ªå­—èŠ‚ï¼Œå‰é¢çš„ 0xE8 æ˜¯æ“ä½œç ï¼ˆOperation Codeï¼‰ï¼Œè¿™æ¡æŒ‡ä»¤æ˜¯ä¸€æ¡è¿‘å€ç›¸å¯¹ä½ç§»è°ƒç”¨æŒ‡ä»¤ï¼Œåé¢ 4 ä¸ªå­—èŠ‚å°±æ˜¯è¢«è°ƒç”¨å‡½æ•°çš„ç›¸å¯¹äºè°ƒç”¨æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡ã€‚åœ¨æ²¡æœ‰é‡å®šä½ä¹‹å‰ï¼Œç›¸å¯¹åç§»è¢«ç½®ä¸º 0xFFFFFFFCï¼ˆå°ç«¯ï¼‰ï¼Œå®ƒæ˜¯å¸¸é‡â€œ-4â€çš„è¡¥ç å½¢å¼ã€‚</p><p>ç¼–è¯‘å™¨æŠŠè¿™ä¸¤æ¡æŒ‡ä»¤çš„åœ°å€éƒ¨åˆ†æš‚æ—¶ç”¨åœ°å€â€œ0x00000000â€å’Œâ€œ0xFFFFFFFCâ€ä»£æ›¿ç€ï¼ŒæŠŠçœŸæ­£çš„åœ°å€è®¡ç®—å·¥ä½œç•™ç»™äº†é“¾æ¥å™¨ã€‚æˆ‘ä»¬ç”¨ objdump æ¥åæ±‡ç¼–è¾“å‡ºç¨‹åºâ€œabâ€çš„ä»£ç æ®µï¼Œå¯ä»¥çœ‹åˆ° main å‡½æ•°çš„ä¸¤ä¸ªé‡å®šä½å…¥å£éƒ½å·²ç»è¢«ä¿®æ­£åˆ°æ­¢ç¡®çš„ä½ç½®ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld9.png"></p><p>ç»è¿‡ä¿®æ­£ä»¥åï¼Œâ€œsharedâ€å’Œâ€œswapâ€çš„åœ°å€åˆ†åˆ«ä¸º 0x08049108 å’Œ 0x00000009ï¼ˆå°ç«¯å­—èŠ‚åºï¼‰ã€‚å…³äºâ€œsharedâ€å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºâ€œsharedâ€å˜é‡çš„åœ°å€çš„ç¡®æ˜¯ 0x08049108ã€‚å¯¹äºâ€œswapâ€æ¥è¯´ç¨æ˜¾æ™¦æ¶©ã€‚â€œcallâ€æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯â€œaddâ€ï¼Œå®ƒçš„åœ°å€æ˜¯ 0x080480bfï¼Œæ‰€ä»¥â€œç›¸å¯¹äº add æŒ‡ä»¤åç§»é‡ä¸º 0x00000009â€çš„åœ°å€ä¸º 0x080480bf+9=0x080480c8ï¼Œå³åˆšå¥½æ˜¯â€œswapâ€å‡½æ•°çš„åœ°å€ã€‚</p><blockquote><p>ç»å¯¹å¯»å€ä¿®æ­£å’Œç›¸å¯¹å¯»å€ä¿®æ­£çš„åŒºåˆ«å°±æ˜¯ç»å¯¹å¯»å€ä¿®æ­£åçš„åœ°å€ä¸ºè¯¥ç¬¦å·çš„å®é™…åœ°å€ï¼›ç›¸å¯¹å¯»å€ä¿®æ­£åçš„åœ°å€ä¸ºç¬¦å·è·ç¦»è¢«ä¿®æ­£ä½ç½®çš„åœ°å€å·®ã€‚</p></blockquote><h2 id="é‡å®šä½è¡¨">é‡å®šä½è¡¨</h2><p>é‚£ä¹ˆé“¾æ¥å™¨æ˜¯æ€ä¹ˆçŸ¥é“å“ªäº›æŒ‡ä»¤æ˜¯è¦è¢«è°ƒæ•´çš„å‘¢ï¼Ÿæ€ä¹ˆè°ƒæ•´ï¼Ÿäº‹å®ä¸Šåœ¨ ELF æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªå«é‡å®šä½è¡¨çš„ç»“æ„ä¸“é—¨ç”¨æ¥ä¿å­˜è¿™äº›ä¸é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ï¼Œå®ƒåœ¨ ELF æ–‡ä»¶ä¸­å¾€å¾€æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ®µã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ objdump æ¥æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„é‡å®šä½è¡¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld10.png"></p><p>æ¯ä¸ªè¦è¢«é‡å®šä½çš„åœ°æ–¹å«ä¸€ä¸ªé‡å®šä½å…¥å£ï¼ˆRelocation Entryï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°â€œa.oâ€é‡Œé¢æœ‰ä¸¤ä¸ªé‡å®šä½å…¥å£ã€‚é‡å®šä½å…¥å£çš„åç§»ï¼ˆOffsetï¼‰è¡¨ç¤ºè¯¥å…¥å£åœ¨è¦è¢«é‡å®šä½çš„æ®µä¸­çš„ä½ç½®ï¼Œâ€œRELOCATION RECORDS FOR[.text]â€è¡¨ç¤ºè¿™ä¸ªé‡å®šä½è¡¨æ˜¯ä»£ç æ®µçš„é‡å®šä½è¡¨ï¼Œæ‰€ä»¥åç§»è¡¨ç¤ºä»£ç æ®µä¸­é¡»è¦è¢«è°ƒæ•´çš„ä½ç½®ã€‚</p><h2 id="ç¬¦å·è§£æ">ç¬¦å·è§£æ</h2><p>å…¶å®é‡å®šä½è¿‡ç¨‹ä¹Ÿä¼´éšç€ç¬¦å·çš„è§£æè¿‡ç¨‹ã€‚é‡å®šä½çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªé‡å®šä½çš„å…¥å£éƒ½æ˜¯å¯¹ä¸€ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå½“é“¾æ¥å™¨é¡»è¦å¯¹æŸä¸ªç¬¦å·çš„å¼•ç”¨è¿›è¡Œé‡å®šä½æ—¶ï¼Œå®ƒå°±è¦ç¡®å®šè¿™ä¸ªç¬¦å·çš„ç›®æ ‡åœ°å€ã€‚è¿™æ—¶å€™é“¾æ¥å™¨å°±ä¼šå»æŸ¥æ‰¾ç”±æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ç»„æˆçš„å…¨å±€ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°ç›¸åº”çš„ç¬¦å·åè¿›è¡Œé‡å®šä½ã€‚æ¯”å¦‚æˆ‘ä»¬æŸ¥çœ‹â€œa.oâ€çš„ç¬¦å·è¡¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld11.png"></p><p>â€œGLOBALâ€ç±»å‹çš„ç¬¦å·ï¼Œé™¤äº†â€œmainâ€å‡½æ•°æ˜¯å®šä¹‰åœ¨ä»£ç æ®µä¹‹å¤–ï¼Œå…¶ä»–ä¸¤ä¸ªâ€œsharedâ€å’Œâ€œswapâ€éƒ½æ˜¯â€œUNDâ€ï¼Œæ‰€æœ‰è¿™äº›æœªå®šä¹‰çš„ç¬¦å·éƒ½åº”è¯¥èƒ½å¤Ÿåœ¨å…¨å±€ç¬¦å·è¡¨ä¸­æ‰¾åˆ°ï¼Œå¦åˆ™é“¾æ¥å™¨å°±æŠ¥ç¬¦å·æœªå®šä¹‰é”™è¯¯ã€‚</p><h1 id="common-å—">COMMON å—</h1><p>ç›®å‰çš„é“¾æ¥å™¨æœ¬èº«å¹¶ä¸æ”¯æŒç¬¦å·çš„ç±»å‹ï¼Œå³å˜é‡ç±»å‹å¯¹äºé“¾æ¥å™¨æ¥è¯´æ˜¯é€æ˜çš„ï¼Œå®ƒåªçŸ¥é“ä¸€ä¸ªç¬¦å·çš„åå­—ï¼Œå¹¶ä¸çŸ¥é“ç±»å‹æ˜¯å¦ä¸€è‡´ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬å®šä¹‰çš„å¤šä¸ªç¬¦å·å®šä¹‰ç±»å‹ä¸ä¸€è‡´æ—¶ï¼Œé“¾æ¥å™¨è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿä¸»è¦åˆ†ä¸‰ç§æƒ…å†µï¼š</p><ul><li>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå¼ºç¬¦å·ç±»å‹ä¸ä¸€è‡´ï¼Œé“¾æ¥å™¨ä¼šæŠ¥ç¬¦å·å¤šé‡å®šä¹‰é”™è¯¯ã€‚</li><li>æœ‰ä¸€ä¸ªå¼ºç¬¦å·ï¼Œå…¶ä»–éƒ½æ˜¯å¼±ç¬¦å·ï¼Œå‡ºç°ç±»å‹ä¸ä¸€è‡´ï¼Œæœ€ç»ˆè¾“å‡ºç»“æœä¸­çš„ç¬¦å·æ‰€å ç©ºé—´ä¸å¼ºç¬¦å·ç›¸åŒã€‚</li><li>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå¼±ç¬¦å·ç±»å‹ä¸ä¸€è‡´ï¼Œä»¥å ç©ºé—´å¤§çš„ä¸ºå‡†ã€‚</li></ul><p>äº‹å®ä¸Šï¼Œç°åœ¨çš„ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨éƒ½æ”¯æŒä¸€ç§å« COMMON å—ï¼ˆCommon Blockï¼‰çš„æœºåˆ¶ï¼Œå½“ä¸åŒçš„ç›®æ ‡æ–‡ä»¶éœ€è¦çš„ COMMON å—ç©ºé—´å¤§å°ä¸ä¸€è‡´æ—¶ï¼Œä»¥æœ€å¤§çš„é‚£å—ä¸ºå‡†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å†å›å¤´æ€»ç»“æ€§åœ°æ€è€ƒå…³äºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡çš„é—®é¢˜ï¼šåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œç¼–è¯‘å™¨ä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¹Ÿå½“ä½œæœªåˆå§‹åŒ–çš„å±€éƒ¨é™æ€å˜é‡ä¸€æ ·å¤„ç†ï¼Œä¸ºå®ƒåœ¨ BSS æ®µåˆ†é…ç©ºé—´ï¼Œè€Œæ˜¯å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ª COMMON ç±»å‹çš„å˜é‡ï¼Ÿ</p><p>å½“ç¼–è¯‘å™¨å°†ä¸€ä¸ªç¼–è¯‘å•å…ƒç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ç¼–è¯‘å•å…ƒåŒ…å«äº†å¼±ç¬¦å·ï¼ˆæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å°±æ˜¯å…¸å‹çš„å¼±ç¬¦å·ï¼‰ï¼Œé‚£ä¹ˆè¯¥å¼±ç¬¦å·æœ€ç»ˆæ‰€å ç©ºé—´çš„å¤§å°åœ¨æ­¤æ—¶æ˜¯æœªçŸ¥çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½å…¶ä»–ç¼–è¯‘å•å…ƒä¸­è¯¥ç¬¦å·æ‰€å çš„ç©ºé—´æ¯”æœ¬ç¼–è¯‘å•å…ƒè¯¥ç¬¦å·æ‰€å çš„ç©ºé—´è¦å¤§ã€‚æ‰€ä»¥ç¼–è¯‘å™¨æ­¤æ—¶æ— æ³•ä¸ºè¯¥å¼±ç¬¦å·åœ¨ BSS æ®µåˆ†é…ç©ºé—´ï¼Œå› ä¸ºæ‰€é¡»è¦ç©ºé—´çš„å¤§å°æœªçŸ¥ã€‚ä½†æ˜¯é“¾æ¥å™¨åœ¨é“¾æ¥è¿‡ç¨‹ä¸­å¯ä»¥ç¡®å®šå¼±ç¬¦å·çš„å¤§å°ï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨æœ€ç»ˆè¾“å‡ºæ–‡ä»¶çš„ BSS æ®µä¸ºå…¶åˆ†é…ç©ºé—´ã€‚æ‰€ä»¥æ€»ä½“æ¥çœ‹ï¼Œæœªåˆå§‹åŒ–å…¨å±€å˜é‡æœ€ç»ˆè¿˜æ˜¯è¢«æ”¾åœ¨ BSS æ®µçš„ã€‚</p><h1 id="cç›¸å…³é—®é¢˜">C++ç›¸å…³é—®é¢˜</h1><p>C++çš„ä¸€äº›è¯­è¨€ç‰¹æ€§ä½¿ä¹‹å¿…é¡»ç”±ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨å…±åŒæ”¯æŒæ‰èƒ½å®Œæˆå·¥ä½œã€‚æœ€ä¸»è¦çš„æœ‰ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯ C++çš„é‡å¤ä»£ç æ¶ˆé™¤ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å…¨å±€æ„é€ ä¸ææ„ã€‚</p><h2 id="é‡å¤ä»£ç æ¶ˆé™¤">é‡å¤ä»£ç æ¶ˆé™¤</h2><p>C++ç¼–è¯‘å™¨åœ¨å¾ˆå¤šæ—¶å€™ä¼šäº§ç”Ÿé‡å¤çš„ä»£ç ï¼Œæ¯”å¦‚æ¨¡æ¿ï¼ˆTemplatesï¼‰ã€å¤–éƒ¨å†…è”å‡½æ•°ï¼ˆExtern Inline Functionï¼‰å’Œè™šå‡½æ•°è¡¨ï¼ˆVirtual Function Tableï¼‰éƒ½æœ‰å¯èƒ½åœ¨ä¸åŒçš„ç¼–è¯‘å•å…ƒé‡Œç”Ÿæˆç›¸åŒçš„ä»£ç ã€‚</p><p>ä¸€ä¸ªæ¯”è¾ƒæœ‰æ•ˆçš„åšæ³•å°±æ˜¯å°†æ¯ä¸ªæ¨¡æ¿çš„å®ä¾‹ä»£ç éƒ½å•ç‹¬åœ°å­˜æ”¾åœ¨ä¸€ä¸ªæ®µé‡Œï¼Œæ¯ä¸ªæ®µåªåŒ…å«ä¸€ä¸ªæ¨¡æ¿å®ä¾‹ã€‚æ¯”å¦‚æœ‰ä¸ªæ¨¡æ¿å‡½æ•°æ˜¯â€œadd<t>()â€ï¼ŒæŸä¸ªç¼–è¯‘å•å…ƒä»¥ int ç±»å‹å’Œ float ç±»å‹å®ä¾‹åŒ–äº†è¯¥æ¨¡æ¿å‡½æ•°ï¼Œé‚£ä¹ˆè¯¥ç¼–è¯‘å•å…ƒçš„ç›®æ ‡æ–‡ä»¶ä¸­å°±åŒ…å«äº†ä¸¤ä¸ªè¯¥æ¨¡æ¿å®ä¾‹çš„æ®µã€‚æˆ‘ä»¬å‡è®¾è¿™ä¸¤ä¸ªæ®µçš„åå­—åˆ†åˆ«å«â€œ.temp.add<int> â€å’Œâ€œ.temp.add<float> â€ã€‚è¿™æ ·ï¼Œå½“åˆ«çš„ç¼–è¯‘å•å…ƒä¹Ÿä»¥ int æˆ– float ç±»å‹å®ä¾‹åŒ–è¯¥æ¨¡æ¿å‡½æ•°åï¼Œä¹Ÿä¼šç”ŸæˆåŒæ ·çš„åå­—ï¼Œè¿™æ ·é“¾æ¥å™¨åœ¨æœ€ç»ˆé“¾æ¥çš„æ—¶å€™å¯ä»¥åŒºåˆ†è¿™äº›ç›¸åŒçš„æ¨¡æ¿å®ä¾‹æ®µï¼Œç„¶åå°†å®ƒä»¬åˆå¹¶å…¥æœ€åçš„ä»£ç æ®µã€‚</float></int></t></p><p><strong>å‡½æ•°çº§åˆ«é“¾æ¥</strong> VISUAL C++ç¼–è¯‘å™¨æä¾›äº†ä¸€ä¸ªç¼–è¯‘é€‰é¡¹å«å‡½æ•°çº§åˆ«é“¾æ¥ï¼ˆFunctional-Level Linkingï¼‰ï¼Œè¿™ä¸ªé€‰é¡¹çš„ä½œç”¨å°±æ˜¯è®©æ‰€æœ‰çš„å‡½æ•°éƒ½åƒå‰é¢æ¨¡æ¿å‡½æ•°ä¸€æ ·ï¼Œå•ç‹¬ä¿å­˜åˆ°ä¸€ä¸ªæ®µé‡Œé¢ã€‚å½“é“¾æ¥å™¨é¡»è¦ç”¨åˆ°æŸä¸ªå‡½æ•°æ—¶ï¼Œå®ƒå°±å°†å®ƒåˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ï¼Œå¯¹äºé‚£äº›æ²¡æœ‰ç”¨çš„å‡½æ•°åˆ™å°†å®ƒä»¬æŠ›å¼ƒã€‚è¿™ç§åšæ³•å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°è¾“å‡ºæ–‡ä»¶çš„é•¿åº¦ï¼Œå‡å°‘ç©ºé—´æµªè´¹ã€‚ä½†æ˜¯ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ã€‚</p><p>GCC ç¼–è¯‘å™¨ä¹Ÿæä¾›äº†ç±»ä¼¼çš„æœºåˆ¶ï¼Œå®ƒæœ‰ä¸¤ä¸ªé€‰æ‹©åˆ†åˆ«æ˜¯â€œ-ffunction-sectionsâ€å’Œâ€œ-fdata-sectionsâ€ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹çš„ä½œç”¨å°±æ˜¯å°†æ¯ä¸ªå‡½æ•°æˆ–å˜é‡åˆ†åˆ«ä¿æŒåˆ°ç‹¬ç«‹çš„æ®µä¸­ã€‚</p><h2 id="å…¨å±€æ„é€ ä¸ææ„">å…¨å±€æ„é€ ä¸ææ„</h2><p>Linux ç³»ç»Ÿä¸‹ä¸€èˆ¬ç¨‹åºçš„å…¥å£æ˜¯â€œ_start'â€ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ Linux ç³»ç»Ÿåº“ï¼ˆGlibcï¼‰çš„ä¸€éƒ¨åˆ†ã€‚å½“æˆ‘ä»¬çš„ç¨‹åºä¸ Glibc åº“é“¾æ¥åœ¨ä¸€èµ·å½¢æˆæœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä»¥åï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç¨‹åºçš„åˆå§‹åŒ–éƒ¨åˆ†çš„å…¥å£ï¼Œç¨‹åºåˆå§‹åŒ–éƒ¨åˆ†å®Œæˆä¸€ç³»åˆ—åˆå§‹åŒ–è¿‡ç¨‹ä¹‹åï¼Œä¼šè°ƒç”¨ main å‡½æ•°æ¥æ‰§è¡Œç¨‹åºçš„ä¸»ä½“ã€‚åœ¨ main å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åï¼Œè¿”å›åˆ°åˆå§‹åŒ–éƒ¨åˆ†ï¼Œå®ƒè¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œï¼Œç„¶åç»“æŸè¿›ç¨‹ã€‚å¯¹äºæœ‰äº›åœºåˆï¼Œç¨‹åºçš„ä¸€äº›ç‰¹å®šçš„æ“ä½œå¿…é¡»åœ¨ main å‡½æ•°ä¹‹å‰è¢«æ‰§è¡Œï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œå¿…é¡»åœ¨ main å‡½æ•°ä¹‹åè¢«æ‰§è¡Œï¼Œå…¶ä¸­å¾ˆå…·æœ‰ä»£è¡¨æ€§çš„å°±æ˜¯ C++çš„å…¨å±€å¯¹è±¡çš„æ„é€ å’Œææ„å‡½æ•°ï¼Œå› æ­¤ ELF æ–‡ä»¶è¿˜å®šä¹‰äº†ä¸¤ç§ç‰¹æ®Šçš„æ®µã€‚</p><ul><li>.init è¯¥æ®µé‡Œé¢ä¿å­˜çš„æ˜¯å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œå®ƒæ„æˆäº†è¿›ç¨‹çš„åˆå§‹åŒ–ä»£ç ã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ªç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼Œåœ¨ main å‡½æ•°è¢«è°ƒç”¨ä¹‹å‰ï¼ŒGlibc çš„åˆå§‹åŒ–éƒ¨åˆ†å®‰æ’æ‰§è¡Œè¿™ä¸ªæ®µçš„ä¸­çš„ä»£ç ã€‚</li><li>.fini è¯¥æ®µä¿å­˜ç€è¿›ç¨‹ç»ˆæ­¢ä»£ç æŒ‡ä»¤ã€‚å› æ­¤ï¼Œå½“-ä¸ªç¨‹åºçš„ main å‡½æ•°æ­£å¸¸é€€å‡ºæ—¶ï¼ŒGlibc ä¼šå®‰æ’æ‰§è¡Œè¿™ä¸ªæ®µä¸­çš„ä»£ç ã€‚</li></ul><p>åˆ©ç”¨è¿™ä¸¤ä¸ªç‰¹æ€§ï¼ŒC++çš„å…¨å±€æ„é€ å’Œææ„å‡½æ•°å°±ç”±æ­¤å®ç°ã€‚</p><h1 id="é™æ€åº“é“¾æ¥">é™æ€åº“é“¾æ¥</h1><p>å…¶å®ä¸€ä¸ªé™æ€åº“å¯ä»¥ç®€å•åœ°çœ‹æˆä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œå³å¾ˆå¤šç›®æ ‡æ–‡ä»¶ç»è¿‡å‹ç¼©æ‰“åŒ…åå½¢æˆçš„ä¸€ä¸ªæ–‡ä»¶ã€‚é€šå¸¸äººä»¬ä½¿ç”¨â€œarâ€å‹ç¼©ç¨‹åºå°†è¿™äº›ç›®æ ‡æ–‡ä»¶å‹ç¼©åˆ°ä¸€èµ·ï¼Œå¹¶ä¸”å¯¹å…¶è¿›è¡Œç¼–å·å’Œç´¢å¼•ï¼Œä»¥ä¾¿äºæŸ¥æ‰¾å’Œæ£€ç´¢ï¼Œå°±å½¢æˆäº† libc.a è¿™ä¸ªé™æ€åº“æ–‡ä»¶ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨â€œarâ€å·¥å…·æ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†å“ªäº›ç›®æ ‡æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ar -t libc.a</span><br><span class="line">init-first.o</span><br><span class="line">libc-start.o</span><br><span class="line">sysdep.o</span><br><span class="line">version.o</span><br><span class="line">check_fds.o</span><br><span class="line">libc-tls.o</span><br><span class="line">elf-init.o</span><br><span class="line">dso_handle.o</span><br><span class="line">errno.o</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨â€œobjdumpâ€æˆ–â€œreadelf'â€åŠ ä¸Šæ–‡æœ¬æŸ¥æ‰¾å·¥å…·å¦‚â€œgrepâ€ï¼Œä½¿ç”¨â€œobjdumpâ€æŸ¥çœ‹ libc.a çš„ç¬¦å·å¯ä»¥å‘ç°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -t libc.a</span><br><span class="line">aio.o:     file format elf64-little</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">...</span><br><span class="line">printf.o:     file format elf64-little</span><br><span class="line">0000000000000000 l    <span class="built_in">df</span> *ABS*0000000000000000 printf.c</span><br><span class="line">0000000000000000 l    d  .text.printf0000000000000000 .text.printf</span><br><span class="line">0000000000000000 l       .text.printf0000000000000000 <span class="variable">$x</span></span><br><span class="line">0000000000000000 g     F .text.printf0000000000000084 <span class="built_in">printf</span></span><br><span class="line">0000000000000000         *UND*0000000000000000 vfprintf</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°â€œprintfâ€å‡½æ•°è¢«å®šä¹‰åœ¨äº†â€œprintf.oâ€è¿™ä¸ªç›®æ ‡æ–‡ä»¶ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬ä¼¼ä¹æ‰¾åˆ°äº†æœ€ç»ˆçš„æœºåˆ¶ï¼Œé‚£å°±æ˜¯â€œHello Worldâ€ç¨‹åºç¼–è¯‘å‡ºæ¥çš„ç›®æ ‡æ–‡ä»¶åªè¦å’Œ libc.a é‡Œé¢çš„â€œprintf.oã€‚é“¾æ¥åœ¨ä¸€èµ·ï¼Œæœ€åå°±å¯ä»¥å½¢æˆä¸€ä¸ªå¯ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ï¼Œprintf.o ä¼šä¾èµ–å…¶ä»–ã€‚o æ–‡ä»¶ä¾‹å¦‚ vfprintf.oã€stdio.o ç­‰ï¼Œç»§ç»­é“¾æ¥å…¶ä»–æ–‡ä»¶ï¼Œæœ€ç»ˆå¾—åˆ°å¦‚å›¾ 4-6 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ld13.png"></p><p>ç°åœ¨ Linux ç³»ç»Ÿä¸Šçš„åº“æ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚ã€‚å½“æˆ‘ä»¬ç¼–è¯‘å’Œé“¾æ¥ä¸€ä¸ªæ™®é€š C ç¨‹åºçš„æ—¶å€™ï¼Œä¸ä»…è¦ç”¨åˆ° C è¯­è¨€åº“ libc.aï¼Œè€Œä¸”è¿˜æœ‰å…¶ä»–ä¸€äº›è¾…åŠ©æ€§è´¨çš„ç›®æ ‡æ–‡ä»¶å’Œåº“ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ GCC å‘½ä»¤ç¼–è¯‘â€œhello.câ€ï¼Œâ€œ-verboseâ€è¡¨ç¤ºå°†æ•´ä¸ªç¼–è¯‘é“¾æ¥è¿‡ç¨‹çš„ä¸­é—´æ­¥éª¤æ‰“å°å‡ºæ¥ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ gcc -static --verbose -fno-builtin Simplesection.c</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/9/lto-wrapper</span><br><span class="line">OFFLOAD_TARGET_NAMES=nvptx-none:hsa</span><br><span class="line">OFFLOAD_TARGET_DEFAULT=1</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion=<span class="string">'Ubuntu 9.3.0-17ubuntu1~20.04'</span> --with-bugurl=file:///usr/share/doc/gcc-9/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++,gm2 --prefix=/usr --with-gcc-major-version-only --program-suffix=-9 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=<span class="built_in">yes</span> --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-9-HskZEa/gcc-9-9.3.0/debian/tmp-nvptx/usr,hsa --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">'-static'</span> <span class="string">'-v'</span> <span class="string">'-fno-builtin'</span> <span class="string">'-mtune=generic'</span> <span class="string">'-march=x86-64'</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/9/cc1 -quiet -v -imultiarch x86_64-linux-gnu Simplesection.c -quiet -dumpbase Simplesection.c -mtune=generic -march=x86-64 -auxbase Simplesection -version -fno-builtin -fasynchronous-unwind-tables -fstack-protector-strong -Wformat -Wformat-security -fstack-clash-protection -fcf-protection -o /tmp/ccobRCAH.s</span><br><span class="line">GNU C17 (Ubuntu 9.3.0-17ubuntu1~20.04) version 9.3.0 (x86_64-linux-gnu)</span><br><span class="line">compiled by GNU C version 9.3.0, GMP version 6.2.0, MPFR version 4.0.2, MPC version 1.1.0, isl version isl-0.22.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">ignoring nonexistent directory <span class="string">"/usr/local/include/x86_64-linux-gnu"</span></span><br><span class="line">ignoring nonexistent directory <span class="string">"/usr/lib/gcc/x86_64-linux-gnu/9/include-fixed"</span></span><br><span class="line">ignoring nonexistent directory <span class="string">"/usr/lib/gcc/x86_64-linux-gnu/9/../../../../x86_64-linux-gnu/include"</span></span><br><span class="line"><span class="comment">#include "..." search starts here:</span></span><br><span class="line"><span class="comment">#include &lt;...&gt; search starts here:</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/9/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br><span class="line">GNU C17 (Ubuntu 9.3.0-17ubuntu1~20.04) version 9.3.0 (x86_64-linux-gnu)</span><br><span class="line">compiled by GNU C version 9.3.0, GMP version 6.2.0, MPFR version 4.0.2, MPC version 1.1.0, isl version isl-0.22.1-GMP</span><br><span class="line"></span><br><span class="line">GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072</span><br><span class="line">Compiler executable checksum: bbf13931d8de1abe14040c9909cb6969</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">'-static'</span> <span class="string">'-v'</span> <span class="string">'-fno-builtin'</span> <span class="string">'-mtune=generic'</span> <span class="string">'-march=x86-64'</span></span><br><span class="line"> as -v --64 -o /tmp/ccQ6DrhG.o /tmp/ccobRCAH.s</span><br><span class="line">GNU assembler version 2.34 (x86_64-linux-gnu) using BFD version (GNU Binutils <span class="keyword">for</span> Ubuntu) 2.34</span><br><span class="line">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/9/:/usr/lib/gcc/x86_64-linux-gnu/9/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/9/:/usr/lib/gcc/x86_64-linux-gnu/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/9/:/usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/9/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/9/../../../:/lib/:/usr/lib/</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">'-static'</span> <span class="string">'-v'</span> <span class="string">'-fno-builtin'</span> <span class="string">'-mtune=generic'</span> <span class="string">'-march=x86-64'</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/9/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/9/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/9/lto-wrapper -plugin-opt=-fresolution=/tmp/cctIiGBE.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_eh -plugin-opt=-pass-through=-lc --build-id -m elf_x86_64 --hash-style=gnu --as-needed -static -z relro /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/crt1.o /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/9/crtbeginT.o -L/usr/lib/gcc/x86_64-linux-gnu/9 -L/usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/9/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/9/../../.. /tmp/ccQ6DrhG.o --start-group -lgcc -lgcc_eh -lc --end-group /usr/lib/gcc/x86_64-linux-gnu/9/crtend.o /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/crtn.o</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">'-static'</span> <span class="string">'-v'</span> <span class="string">'-fno-builtin'</span> <span class="string">'-mtune=generic'</span> <span class="string">'-march=x86-64'</span></span><br></pre></td></tr></tbody></table></figure><ul><li>ç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ cc1 ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºå®é™…ä¸Šå°±æ˜¯ GCC çš„ C è¯­è¨€ç¼–è¯‘å™¨ï¼Œå®ƒå°†â€œhello.câ€ç¼–è¯‘æˆä¸€ä¸ªä¸´æ—¶çš„æ±‡ç¼–æ–‡ä»¶â€œ/tmp/ccUhtGSB.sâ€ã€‚</li><li>ç„¶åè°ƒç”¨ as ç¨‹åºï¼Œas ç¨‹åºæ˜¯ GNU çš„æ±‡ç¼–å™¨ï¼Œå®ƒå°†â€œ/tmp/ccUhtGSB.sâ€æ±‡ç¼–æˆä¸´æ—¶ç›®æ ‡æ–‡ä»¶â€œ/tmp/cCQZRPL5.oâ€ï¼Œè¿™ä¸ªâ€œ/tmp/cCQZRPL5.oâ€å®é™…ä¸Šå°±æ˜¯å‰é¢çš„â€œhello.oâ€ã€‚</li><li>æ¥ç€æœ€å…³é”®çš„æ­¥éª¤æ˜¯æœ€åä¸€æ­¥ï¼ŒGCC è°ƒç”¨ collect2 ç¨‹åºæ¥å®Œæˆæœ€åçš„é“¾æ¥ã€‚</li></ul><p>å®é™…ä¸Š collect2 å¯ä»¥çœ‹ä½œæ˜¯ ld é“¾æ¥å™¨çš„ä¸€ä¸ªåŒ…è£…ï¼Œå®ƒä¼šè°ƒç”¨ ld é“¾æ¥å™¨æ¥å®Œæˆå¯¹ç›®æ ‡æ–‡ä»¶çš„é“¾æ¥ï¼Œç„¶åå†å¯¹é“¾æ¥ç»“æœè¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¸»è¦æ˜¯æ”¶é›†æ‰€æœ‰ä¸ç¨‹åºåˆå§‹åŒ–ç›¸å…³çš„ä¿¡æ¯å¹¶ä¸”æ„é€ åˆå§‹åŒ–çš„ç»“æ„ã€‚å¯ä»¥çœ‹åˆ°æœ€åä¸€æ­¥ä¸­ï¼Œè‡³å°‘æœ‰ä¸‹åˆ—å‡ ä¸ªåº“å’Œç›®æ ‡æ–‡ä»¶è¢«é“¾æ¥å…¥äº†æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">crt1.o</span><br><span class="line">crti.o</span><br><span class="line">crtbeginT.o</span><br><span class="line">libgcc.a</span><br><span class="line">libgcc_eh.a</span><br><span class="line">libc.a</span><br><span class="line">crtend.o</span><br><span class="line">crtn.o</span><br></pre></td></tr></tbody></table></figure><h1 id="é“¾æ¥è¿‡ç¨‹æ§åˆ¶">é“¾æ¥è¿‡ç¨‹æ§åˆ¶</h1><p>é“¾æ¥å™¨ä¸€èˆ¬éƒ½æä¾›å¤šç§æ§åˆ¶æ•´ä¸ªé“¾æ¥è¿‡ç¨‹çš„æ–¹æ³•ï¼Œä»¥ç”¨æ¥äº§ç”Ÿç”¨æˆ·æ‰€é¡»è¦çš„æ–‡ä»¶ã€‚ä¸€èˆ¬é“¾æ¥å™¨æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹æ³•ã€‚</p><ul><li>ä½¿ç”¨å‘½ä»¤è¡Œæ¥ç»™é“¾æ¥å™¨æŒ‡å®šå‚æ•°ï¼Œæˆ‘ä»¬å‰é¢æ‰€ä½¿ç”¨çš„ ld çš„-oã€-e å‚æ•°å°±å±äºè¿™ç±»ã€‚</li><li>å°†é“¾æ¥æŒ‡ä»¤å­˜æ”¾åœ¨ç›®æ ‡æ–‡ä»¶é‡Œé¢ï¼Œç¼–è¯‘å™¨ç»å¸¸ä¼šé€šè¿‡è¿™ç§æ–¹æ³•å‘é“¾æ¥å™¨ä¼ é€’æŒ‡ä»¤ã€‚æ¯”å¦‚ VISUAL C++ç¼–è¯‘å™¨ä¼šæŠŠé“¾æ¥å‚æ•°æ”¾åœ¨ PE ç›®æ ‡æ–‡ä»¶çš„ã€‚drectve æ®µä»¥ç”¨æ¥ä¼ é€’å‚æ•°ã€‚</li><li>ä½¿ç”¨é“¾æ¥æ§åˆ¶è„šæœ¬ï¼Œæ˜¯æœ€ä¸ºçµæ´»ã€æœ€ä¸ºå¼ºå¤§çš„é“¾æ¥æ§åˆ¶æ–¹æ³•ã€‚</li></ul><p>å‰é¢æˆ‘ä»¬åœ¨ä½¿ç”¨ ld é“¾æ¥å™¨çš„æ—¶å€™ï¼Œæ²¡æœ‰æŒ‡å®šé“¾æ¥è„šæœ¬ï¼Œå…¶å® ld åœ¨ç”¨æˆ·æ²¡æœ‰æŒ‡å®šé“¾æ¥è„šæœ¬çš„æ—¶å€™ä¼šä½¿ç”¨é»˜è®¤é“¾æ¥è„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¡Œæ¥æŸ¥çœ‹ ld é»˜è®¤çš„é“¾æ¥è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld --verbose</span><br></pre></td></tr></tbody></table></figure><p>é»˜è®¤çš„ ld é“¾æ¥è„šæœ¬å­˜æ”¾åœ¨/usr/lib/ldscripts/ä¸‹ï¼Œä¸åŒçš„æœºå™¨å¹³å°ã€è¾“å‡ºæ–‡ä»¶æ ¼å¼éƒ½æœ‰ç›¸åº”çš„é“¾æ¥è„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åæŒ‡å®šè¯¥è„šæœ¬ä¸ºé“¾æ¥æ§åˆ¶è„šæœ¬ã€‚æ¯”å¦‚å¯ä»¥ä½¿ç”¨-T å‚æ•°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -T link.script</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Links Libraries </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾æ¥è£…è½½ä¸åº“ï¼ˆäºŒï¼‰ç›®æ ‡æ–‡ä»¶</title>
      <link href="/2021/Program/LinksAndLibrariesPart2/"/>
      <url>/2021/Program/LinksAndLibrariesPart2/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/ObjectFile.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMwNzVlODdkOWMwODA3NmQwOWM4MDI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><p>ç›®æ ‡æ–‡ä»¶ä»ç»“æ„ä¸Šè®²ï¼Œå®ƒæ˜¯å·²ç»ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œåªæ˜¯è¿˜æ²¡æœ‰ç»è¿‡é“¾æ¥çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å¯èƒ½æœ‰äº›ç¬¦å·æˆ–æœ‰äº›åœ°å€è¿˜æ²¡æœ‰è¢«è°ƒæ•´ã€‚</p><h1 id="ç›®æ ‡æ–‡ä»¶çš„æ ¼å¼">ç›®æ ‡æ–‡ä»¶çš„æ ¼å¼</h1><p>ç°åœ¨ PC å¹³å°æµè¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸»è¦æ˜¯ Windows ä¸‹çš„ PEï¼ˆPortable Executableï¼‰å’Œ Linux çš„ ELFï¼ˆExecutable Linkable Formatï¼‰ï¼Œå®ƒä»¬éƒ½æ˜¯ COFFï¼ˆCommon fileformatï¼‰æ ¼å¼çš„å˜ç§ã€‚</p><p>ELF æ–‡ä»¶æ ‡å‡†é‡Œé¢æŠŠç³»ç»Ÿä¸­é‡‡ç”¨ ELF æ ¼å¼çš„æ–‡ä»¶å½’ä¸ºå¦‚ä¸‹è¡¨æ‰€åˆ—ä¸¾çš„ 4 ç±»ã€‚</p><table><colgroup><col style="width: 18%"><col style="width: 52%"><col style="width: 29%"></colgroup><thead><tr class="header"><th>ELF æ–‡ä»¶ç±»å‹</th><th>è¯´æ˜</th><th>å®ä¾‹</th></tr></thead><tbody><tr class="odd"><td>å¯é‡å®šä½æ–‡ä»¶ <bar> Relocatable File</bar></td><td>è¿™ç±»æ–‡ä»¶åŒ…å«äº†ä»£ç å’Œæ•°æ®ï¼Œå¯ä»¥è¢«ç”¨æ¥é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«ç›®æ ‡æ–‡ä»¶ï¼Œé™æ€é“¾æ¥åº“ä¹Ÿå¯ä»¥å½’ä¸ºè¿™ä¸€ç±»</td><td>Linux çš„ã€‚o <bar> Windows çš„ã€‚obj</bar></td></tr><tr class="even"><td>å¯æ‰§è¡Œæ–‡ä»¶ <bar> Executable File</bar></td><td>è¿™ç±»æ–‡ä»¶åŒ…å«äº†å¯ä»¥ç›´æ¥æ‰§è¡Œçš„ç¨‹åºï¼Œå®ƒçš„ä»£è¡¨å°±æ˜¯ ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒä»¬ä¸€èˆ¬éƒ½æ²¡æœ‰æ‰©å±•å</td><td>æ¯”å¦‚/bin/bash æ–‡ä»¶ <bar> Windows çš„ã€‚exe</bar></td></tr><tr class="odd"><td>å…±äº«ç›®æ ‡æ–‡ä»¶ <bar> Shared Object File</bar></td><td>è¿™ç§æ–‡ä»¶åŒ…å«äº†ä»£ç å’Œæ•°æ®ï¼Œå¯ä»¥åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ã€‚ä¸€ç§æ˜¯é“¾æ¥å™¨å¯ä»¥ä½¿ç”¨è¿™ç§æ–‡ä»¶è·Ÿå…¶ä»–çš„å¯é‡å®šä½æ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶é“¾æ¥ï¼Œäº§ç”Ÿæ–°çš„ç›®æ ‡æ–‡ä»¶ã€‚ç¬¬äºŒç§æ˜¯åŠ¨æ€é“¾æ¥å™¨å¯ä»¥å°†å‡ ä¸ªè¿™ç§å…±äº«ç›®æ ‡æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶ç»“åˆï¼Œä½œä¸ºè¿›ç¨‹æ˜ åƒçš„ä¸€éƒ¨åˆ†æ¥è¿è¡Œ</td><td>Linux çš„ã€‚soï¼Œlib/glibc-2.5.so <bar> Windows çš„ DLL</bar></td></tr><tr class="even"><td>æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ <bar> Core Dump File</bar></td><td>å½“è¿›ç¨‹æ„å¤–ç»ˆæ­¢æ—¶ï¼Œç³»ç»Ÿå¯ä»¥å°†è¯¥è¿›ç¨‹çš„åœ°å€ç©ºé—´çš„å†…å®¹åŠç»ˆæ­¢æ—¶çš„ä¸€äº›å…¶ä»–ä¿¡æ¯è½¬å‚¨åˆ°æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶</td><td>Linux ä¸‹çš„ core dump</td></tr></tbody></table><p>æˆ‘ä»¬å¯ä»¥åœ¨ Linux ä¸‹ä½¿ç”¨ file å‘½ä»¤æ¥æŸ¥çœ‹ç›¸åº”çš„æ–‡ä»¶æ ¼å¼ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">file foobar.o</span><br><span class="line">foobar.o:ELF 32-bit LSB relocatable,Intel 80386,version 1 (SYSV),notstripped</span><br><span class="line">file /bin/bash</span><br><span class="line">/bin/bash:ELF 32-bit LSB executable,Intel 80386,version 1 (SYSV),forGNU/Linux 2.6.8,dynamically linked (uses shared libs),stripped</span><br><span class="line"><span class="variable">$fi1e</span>/1ib/1d-2.6.1.8o</span><br><span class="line">/lib/libc-2.6.1.so:ELF 32-bit LSB shared object,Intel 80386,version 1(SYSV),<span class="keyword">for</span> GNU/Linux 2.6.8,stripped</span><br></pre></td></tr></tbody></table></figure><h1 id="ç›®æ ‡æ–‡ä»¶æ˜¯ä»€ä¹ˆæ ·çš„">ç›®æ ‡æ–‡ä»¶æ˜¯ä»€ä¹ˆæ ·çš„</h1><p>ç›®æ ‡æ–‡ä»¶ä¸­çš„å†…å®¹è‡³å°‘æœ‰ç¼–è¯‘åçš„æœºå™¨æŒ‡ä»¤ä»£ç ã€æ•°æ®ã€‚é™¤äº†è¿™äº›å†…å®¹ä»¥å¤–ï¼Œç›®æ ‡æ–‡ä»¶ä¸­è¿˜åŒ…æ‹¬äº†é“¾æ¥æ—¶æ‰€é¡»è¦çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¦å·è¡¨ã€è°ƒè¯•ä¿¡æ¯ã€å­—ç¬¦ä¸²ç­‰ã€‚ä¸€èˆ¬ç›®æ ‡æ–‡ä»¶å°†è¿™äº›ä¿¡æ¯æŒ‰ä¸åŒçš„å±æ€§ï¼Œä»¥â€œæ®µâ€ï¼ˆSegmentï¼‰çš„å½¢å¼å­˜å‚¨ã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ç¨‹åºè¢«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶åçš„ç»“æ„ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/elf1.png"></p><p>å‡è®¾å›¾ 3-1 çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰çš„æ ¼å¼æ˜¯ ELFï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒELF æ–‡ä»¶çš„å¼€å¤´æ˜¯ä¸€ä¸ªâ€œæ–‡ä»¶å¤´â€ï¼Œå®ƒæè¿°äº†æ•´ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œã€æ˜¯é™æ€é“¾æ¥è¿˜æ˜¯åŠ¨æ€é“¾æ¥åŠå…¥å£åœ°å€ï¼ˆå¦‚æœæ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€ç›®æ ‡ç¡¬ä»¶ã€ç›®æ ‡æ“ä½œç³»ç»Ÿç­‰ä¿¡æ¯ï¼Œæ–‡ä»¶å¤´è¿˜åŒ…æ‹¬ä¸€ä¸ªæ®µè¡¨ï¼ˆSection Tableï¼‰ï¼Œæ®µè¡¨å…¶å®æ˜¯ä¸€ä¸ªæè¿°æ–‡ä»¶ä¸­å„ä¸ªæ®µçš„æ•°ç»„ã€‚æ®µè¡¨æè¿°äº†æ–‡ä»¶ä¸­å„ä¸ªæ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»ä½ç½®åŠæ®µçš„å±æ€§ç­‰ã€‚</p><blockquote><p>ä¸€èˆ¬ C è¯­è¨€çš„ç¼–è¯‘åæ‰§è¡Œè¯­å¥éƒ½ç¼–è¯‘æˆæœºå™¨ä»£ç ï¼Œä¿å­˜åœ¨ã€‚text æ®µï¼›å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡éƒ½ä¿å­˜åœ¨ã€‚data æ®µï¼›æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ä¸€èˆ¬æ”¾åœ¨ä¸€ä¸ªå«â€œ.bssâ€çš„æ®µé‡Œã€‚.bss æ®µåªæ˜¯ä¸ºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡é¢„ç•™ä½ç½®è€Œå·²ï¼Œå®ƒå¹¶æ²¡æœ‰å†…å®¹ï¼Œæ‰€ä»¥å®ƒåœ¨æ–‡ä»¶ä¸­ä¹Ÿä¸å æ®ç©ºé—´ã€‚</p></blockquote><p>æ•°æ®å’ŒæŒ‡ä»¤åˆ†æ®µçš„å¥½å¤„æœ‰å¾ˆå¤šï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>ä¸€æ–¹é¢æ˜¯å½“ç¨‹åºè¢«è£…è½½åï¼Œæ•°æ®å’ŒæŒ‡ä»¤åˆ†åˆ«è¢«æ˜ å°„åˆ°ä¸¤ä¸ªè™šå­˜åŒºåŸŸã€‚è¿™ä¸¤ä¸ªè™šå­˜åŒºåŸŸçš„æƒé™å¯ä»¥è¢«åˆ†åˆ«è®¾ç½®æˆå¯è¯»å†™å’Œåªè¯»ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ç¨‹åºçš„æŒ‡ä»¤è¢«æœ‰æ„æˆ–æ— æ„åœ°æ”¹å†™ã€‚</li><li>å¦å¤–ä¸€æ–¹é¢æ˜¯å¯¹äºç°ä»£çš„ CPU æ¥è¯´ï¼Œå®ƒä»¬æœ‰ç€æä¸ºå¼ºå¤§çš„ç¼“å­˜ï¼ˆCacheï¼‰ä½“ç³»ã€‚æŒ‡ä»¤åŒºå’Œæ•°æ®åŒºçš„åˆ†ç¦»æœ‰åˆ©äºæé«˜ç¨‹åºçš„å±€éƒ¨æ€§ï¼Œæ‰€ä»¥ç¨‹åºçš„æŒ‡ä»¤å’Œæ•°æ®è¢«åˆ†å¼€å­˜æ”¾å¯¹ CPU çš„ç¼“å­˜å‘½ä¸­ç‡æé«˜æœ‰å¥½å¤„ã€‚</li><li>ç¬¬ä¸‰ä¸ªåŸå› ï¼Œå…¶å®ä¹Ÿæ˜¯æœ€é‡è¦çš„åŸå› ï¼Œå°±æ˜¯å½“ç³»ç»Ÿä¸­è¿è¡Œç€å¤šä¸ªè¯¥ç¨‹åºçš„å‰¯æœ¬æ—¶ï¼Œå®ƒä»¬çš„æŒ‡ä»¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å†…å­˜ä¸­åªé¡»è¦ä¿å­˜ä¸€ä»½è¯¥ç¨‹åºçš„æŒ‡ä»¤éƒ¨åˆ†ã€‚</li></ul><h1 id="æŒ–æ˜-simplesection.o">æŒ–æ˜ SimpleSection.o</h1><p>æˆ‘ä»¬å°±ä»¥ SimpleSection.c ç¼–è¯‘å‡ºæ¥çš„ç›®æ ‡æ–‡ä»¶ä½œä¸ºåˆ†æå¯¹è±¡ï¼Œè¿™ä¸ªç¨‹åºæ˜¯ç»è¿‡ç²¾å¿ƒæŒ‘é€‰çš„ï¼Œå…·æœ‰ä¸€å®šçš„ä»£è¡¨æ€§è€Œåˆä¸è‡³äºè¿‡äºç¹çå’Œå¤æ‚ã€‚å›¾ 3-1 ä¸­çš„ç¨‹åºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">simpleSection.c</span></span><br><span class="line"><span class="comment">Linux:</span></span><br><span class="line"><span class="comment">gcc -c Simplesection.c</span></span><br><span class="line"><span class="comment">Windows:</span></span><br><span class="line"><span class="comment">cl Simplesection.c /c /Za</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*format,...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">84</span>;</span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,i);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">85</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var2;</span><br><span class="line">    <span class="type">int</span> a =<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    func1(static_var + static_var2 + a + b );</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ GCC æ¥ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶ï¼ˆå‚æ•°-c è¡¨ç¤ºåªç¼–è¯‘ä¸é“¾æ¥ï¼‰ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c Simplesection.c</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª 2.1k å­—èŠ‚çš„ SimpleSection.o ç›®æ ‡æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ binutils çš„å·¥å…· objdump æ¥æŸ¥çœ‹ object å†…éƒ¨çš„ç»“æ„ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥çœ‹å„ç§ç›®æ ‡æ–‡ä»¶çš„ç»“æ„å’Œå†…å®¹ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ objdump -h Simplesection.o</span><br><span class="line"></span><br><span class="line">Simplesection.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  0 .text         0000005f  0000000000000000  0000000000000000  00000040  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  1 .data         00000008  0000000000000000  0000000000000000  000000a0  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss          00000004  0000000000000000  0000000000000000  000000a8  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">  3 .rodata       00000004  0000000000000000  0000000000000000  000000a8  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  4 .comment      0000002b  0000000000000000  0000000000000000  000000ac  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  5 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000000d7  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br></pre></td></tr></tbody></table></figure><p>Linux è¿˜æœ‰ä¸€ä¸ªå¾ˆä¸é”™çš„å·¥å…¶å« readelfï¼Œå®ƒæ˜¯ä¸“é—¨é’ˆå¯¹ ELF æ–‡ä»¶æ ¼å¼çš„è§£æå™¨ï¼Œå¾ˆå¤šæ—¶å€™å®ƒå¯¹ ELF æ–‡ä»¶çš„åˆ†æå¯ä»¥è·Ÿ objdump ç›¸äº’å¯¹ç…§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸‹é¢ä¼šç»å¸¸ç”¨åˆ°è¿™ä¸ªå·¥å…·ã€‚å‚æ•°â€œ-hâ€å°±æ˜¯æŠŠ ELF æ–‡ä»¶çš„å„ä¸ªæ®µçš„åŸºæœ¬ä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨â€œobjdump -xâ€æŠŠæ›´å¤šçš„ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯â€œ-xâ€è¾“å‡ºçš„è¿™äº›ä¿¡æ¯åˆå¤šåˆå¤æ‚ï¼Œå¯¹äºä¸ç†Ÿæ‚‰ ELF å’Œ objdump çš„è¯»è€…æ¥è¯´å¯èƒ½ä¼šå¾ˆé™Œç”Ÿã€‚</p><p>ä»ä¸Šé¢çš„ç»“æœæ¥çœ‹ï¼ŒSimpleSection.o çš„æ®µçš„æ•°é‡æ¯”æˆ‘ä»¬æƒ³è±¡ä¸­çš„è¦å¤šï¼Œé™¤äº†æœ€åŸºæœ¬çš„ä»£ç æ®µã€æ•°æ®æ®µå’Œ BSS æ®µä»¥å¤–ï¼Œè¿˜æœ‰ 3 ä¸ªæ®µåˆ†åˆ«æ˜¯åªè¯»æ•°æ®æ®µï¼ˆ.rodataï¼‰ã€æ³¨é‡Šä¿¡æ¯æ®µï¼ˆ.commentï¼‰å’Œå †æ ˆæç¤ºæ®µï¼ˆ.note.GNU-stackï¼‰ï¼Œæ¯ä¸ªæ®µçš„ç¬¬ 2 è¡Œä¸­çš„â€œCONTENTSâ€ã€â€œALLOCâ€ç­‰è¡¨ç¤ºæ®µçš„å„ç§å±æ€§ï¼Œâ€œCONTENTSâ€è¡¨ç¤ºè¯¥æ®µåœ¨æ–‡ä»¶ä¸­å­˜åœ¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° BSS æ®µæ²¡æœ‰â€œCONTENTSâ€ï¼Œè¡¨ç¤ºå®ƒå®é™…ä¸Šåœ¨ ELF æ–‡ä»¶ä¸­ä¸å­˜åœ¨å†…å®¹ã€‚â€œ.note.GNU-stackâ€æ®µè™½ç„¶æœ‰â€œCONTENTSâ€ï¼Œä½†å®ƒçš„é•¿åº¦ä¸º 0ï¼Œè¿™æ˜¯ä¸ªå¾ˆå¤æ€ªçš„æ®µï¼Œæˆ‘ä»¬æš‚ä¸”å¿½ç•¥å®ƒï¼Œè®¤ä¸ºå®ƒåœ¨ ELF æ–‡ä»¶ä¸­ä¹Ÿä¸å­˜åœ¨ã€‚é‚£ä¹ˆ ELF æ–‡ä»¶ä¸­å®é™…å­˜åœ¨çš„ä¹Ÿå°±æ˜¯â€œ.textâ€ã€â€œ.dataâ€ã€â€œ.rodataâ€å’Œâ€œ.comment'â€è¿™ 4 ä¸ªæ®µäº†ã€‚å®ƒä»¬åœ¨ ELF ä¸­çš„ç»“æ„å¦‚å›¾ 3-3 æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/elf2.png"></p><p>äº†è§£äº†è¿™å‡ ä¸ªæ®µåœ¨ SimpleSection.o çš„åŸºæœ¬åˆ†å¸ƒï¼Œæ¥ç€å°†é€ä¸ªæ¥çœ‹è¿™å‡ ä¸ªæ®µï¼Œçœ‹çœ‹å®ƒä»¬åŒ…å«äº†ä»€ä¹ˆå†…å®¹ã€‚æœ‰ä¸€ä¸ªä¸“é—¨çš„å‘½ä»¤å«åšâ€œsizeâ€ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥çœ‹ ELF æ–‡ä»¶çš„ä»£ç æ®µã€æ•°æ®æ®µå’Œ BSS æ®µçš„é•¿åº¦ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ size Simplesection.o</span><br><span class="line">   text   data    bss    dec    hexfilename</span><br><span class="line">    219      8      4    231     e7Simplesection.o</span><br></pre></td></tr></tbody></table></figure><h2 id="ä»£ç æ®µ">ä»£ç æ®µ</h2><p>objdump çš„â€œ-sâ€å‚æ•°å¯ä»¥å°†æ‰€æœ‰æ®µçš„å†…å®¹ä»¥åå…­è¿›åˆ¶çš„æ–¹å¼æ‰“å°å‡ºæ¥ï¼Œâ€œ-dâ€å‚æ•°å¯ä»¥å°†æ‰€æœ‰åŒ…å«æŒ‡ä»¤çš„æ®µåæ±‡ç¼–ã€‚æˆ‘ä»¬å°† objdump è¾“å‡ºä¸­å…³äºä»£ç æ®µçš„å†…å®¹æå–å‡ºæ¥ï¼Œåˆ†æä¸€ä¸‹å…³äºä»£ç æ®µçš„å†…å®¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ objdump -x -s -d Simplesection.o</span><br><span class="line"></span><br><span class="line">Simplesection.o:     file format elf64-x86-64</span><br><span class="line">Simplesection.o</span><br><span class="line">architecture: i386:x86-64, flags 0x00000011:</span><br><span class="line">HAS_RELOC, HAS_SYMS</span><br><span class="line">start address 0x0000000000000000</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  0 .text         0000005f  0000000000000000  0000000000000000  00000040  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  1 .data         00000008  0000000000000000  0000000000000000  000000a0  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss          00000004  0000000000000000  0000000000000000  000000a8  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">  3 .rodata       00000004  0000000000000000  0000000000000000  000000a8  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  4 .comment      0000002b  0000000000000000  0000000000000000  000000ac  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  5 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000000d7  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  6 .note.gnu.property 00000020  0000000000000000  0000000000000000  000000d8  2**3</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  7 .eh_frame     00000058  0000000000000000  0000000000000000  000000f8  2**3</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l    <span class="built_in">df</span> *ABS*0000000000000000 Simplesection.c</span><br><span class="line">0000000000000000 l    d  .text0000000000000000 .text</span><br><span class="line">0000000000000000 l    d  .data0000000000000000 .data</span><br><span class="line">0000000000000000 l    d  .bss0000000000000000 .bss</span><br><span class="line">0000000000000000 l    d  .rodata0000000000000000 .rodata</span><br><span class="line">0000000000000004 l     O .data0000000000000004 static_var.2324</span><br><span class="line">0000000000000000 l     O .bss0000000000000004 static_var2.2325</span><br><span class="line">0000000000000000 l    d  .note.GNU-stack0000000000000000 .note.GNU-stack</span><br><span class="line">0000000000000000 l    d  .note.gnu.property0000000000000000 .note.gnu.property</span><br><span class="line">0000000000000000 l    d  .eh_frame0000000000000000 .eh_frame</span><br><span class="line">0000000000000000 l    d  .comment0000000000000000 .comment</span><br><span class="line">0000000000000000 g     O .data0000000000000004 global_init_var</span><br><span class="line">0000000000000004       O *COM*0000000000000004 global_uninit_var</span><br><span class="line">0000000000000000 g     F .text0000000000000028 func1</span><br><span class="line">0000000000000000         *UND*0000000000000000 _GLOBAL_OFFSET_TABLE_</span><br><span class="line">0000000000000000         *UND*0000000000000000 <span class="built_in">printf</span></span><br><span class="line">0000000000000028 g     F .text0000000000000037 main</span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 f30f1efa 554889e5 4883ec10 897dfc8b  ....UH..H....}..</span><br><span class="line"> 0010 45fc89c6 488d3d00 000000b8 00000000  E...H.=.........</span><br><span class="line"> 0020 e8000000 0090c9c3 f30f1efa 554889e5  ............UH..</span><br><span class="line"> 0030 4883ec10 c745f801 0000008b 15000000  H....E..........</span><br><span class="line"> 0040 008b0500 00000001 c28b45f8 01c28b45  ..........E....E</span><br><span class="line"> 0050 fc01d089 c7e80000 00008b45 f8c9c3    ...........E...</span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 54000000 55000000                    T...U...</span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> 0000 25640a00                             %d..</span><br><span class="line">Contents of section .comment:</span><br><span class="line"> 0000 00474343 3a202855 62756e74 7520392e  .GCC: (Ubuntu 9.</span><br><span class="line"> 0010 332e302d 31377562 756e7475 317e3230  3.0-17ubuntu1~20</span><br><span class="line"> 0020 2e303429 20392e33 2e3000             .04) 9.3.0.</span><br><span class="line">Contents of section .note.gnu.property:</span><br><span class="line"> 0000 04000000 10000000 05000000 474e5500  ............GNU.</span><br><span class="line"> 0010 020000c0 04000000 03000000 00000000  ................</span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line"> 0000 14000000 00000000 017a5200 01781001  .........zR..x..</span><br><span class="line"> 0010 1b0c0708 90010000 1c000000 1c000000  ................</span><br><span class="line"> 0020 00000000 28000000 00450e10 8602430d  ....(....E....C.</span><br><span class="line"> 0030 065f0c07 08000000 1c000000 3c000000  ._..........&lt;...</span><br><span class="line"> 0040 00000000 37000000 00450e10 8602430d  ....7....E....C.</span><br><span class="line"> 0050 066e0c07 08000000                    .n......</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;func1&gt;:</span><br><span class="line">   0:f3 0f 1e fa          endbr64</span><br><span class="line">   4:55                   push   %rbp</span><br><span class="line">   5:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">   8:48 83 ec 10          sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">   c:89 7d <span class="built_in">fc</span>             mov    %edi,-0x4(%rbp)</span><br><span class="line">   f:8b 45 <span class="built_in">fc</span>             mov    -0x4(%rbp),%eax</span><br><span class="line">  12:89 c6                mov    %eax,%esi</span><br><span class="line">  14:48 8d 3d 00 00 00 00 lea    0x0(%rip),%rdi        <span class="comment">#  1b &lt;func1+0x1b&gt;</span></span><br><span class="line">17: R_X86_64_PC32.rodata-0x4</span><br><span class="line">  1b:b8 00 00 00 00       mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">  20:e8 00 00 00 00       callq  25 &lt;func1+0x25&gt;</span><br><span class="line">21: R_X86_64_PLT32printf-0x4</span><br><span class="line">  25:90                   nop</span><br><span class="line">  26:c9                   leaveq</span><br><span class="line">  27:c3                   retq</span><br><span class="line"></span><br><span class="line">0000000000000028 &lt;main&gt;:</span><br><span class="line">  28:f3 0f 1e fa          endbr64</span><br><span class="line">  2c:55                   push   %rbp</span><br><span class="line">  2d:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  30:48 83 ec 10          sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">  34:c7 45 f8 01 00 00 00 movl   <span class="variable">$0x1</span>,-0x8(%rbp)</span><br><span class="line">  3b:8b 15 00 00 00 00    mov    0x0(%rip),%edx        <span class="comment">#  41 &lt;main+0x19&gt;</span></span><br><span class="line">3d: R_X86_64_PC32.data</span><br><span class="line">  41:8b 05 00 00 00 00    mov    0x0(%rip),%eax        <span class="comment">#  47 &lt;main+0x1f&gt;</span></span><br><span class="line">43: R_X86_64_PC32.bss-0x4</span><br><span class="line">  47:01 c2                add    %eax,%edx</span><br><span class="line">  49:8b 45 f8             mov    -0x8(%rbp),%eax</span><br><span class="line">  4c:01 c2                add    %eax,%edx</span><br><span class="line">  4e:8b 45 <span class="built_in">fc</span>             mov    -0x4(%rbp),%eax</span><br><span class="line">  51:01 d0                add    %edx,%eax</span><br><span class="line">  53:89 c7                mov    %eax,%edi</span><br><span class="line">  55:e8 00 00 00 00       callq  5a &lt;main+0x32&gt;</span><br><span class="line">56: R_X86_64_PLT32func1-0x4</span><br><span class="line">  5a:8b 45 f8             mov    -0x8(%rbp),%eax</span><br><span class="line">  5d:c9                   leaveq</span><br><span class="line">  5e:c3                   retq</span><br></pre></td></tr></tbody></table></figure><p>â€œContents of section.textâ€å°±æ˜¯ã€‚text çš„æ•°æ®ä»¥åå…­è¿›åˆ¶æ–¹å¼æ‰“å°å‡ºæ¥çš„å†…å®¹ï¼Œæœ€å·¦é¢ä¸€åˆ—æ˜¯åç§»é‡ï¼Œä¸­é—´ 4 åˆ—æ˜¯åå…­è¿›åˆ¶å†…å®¹ï¼Œæœ€å³é¢ä¸€åˆ—æ˜¯ã€‚text æ®µçš„ ASCII ç å½¢å¼ã€‚å¯¹ç…§ä¸‹é¢çš„åæ±‡ç¼–ç»“æœï¼Œå¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹åˆ°ï¼Œ.text æ®µé‡Œæ‰€åŒ…å«çš„æ­£æ˜¯ SimpleSection.c é‡Œä¸¤ä¸ªå‡½æ•° func1() å’Œ main() çš„æŒ‡ä»¤ã€‚.text æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚â€œ55â€å°±æ˜¯â€œfunc1()â€å‡½æ•°çš„ç¬¬ä¸€æ¡â€œpush %rbpâ€æŒ‡ä»¤ï¼Œè€Œæœ€åä¸€ä¸ªå­—èŠ‚ 0xc3 æ­£æ˜¯ main å‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤â€œretqâ€ã€‚</p><h2 id="æ•°æ®æ®µå’Œåªè¯»æ•°æ®æ®µ">æ•°æ®æ®µå’Œåªè¯»æ•°æ®æ®µ</h2><p>.data æ®µä¿å­˜çš„æ˜¯é‚£äº›å·²ç»åˆå§‹åŒ–äº†çš„å…¨å±€é™æ€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ã€‚å‰é¢çš„ SimpleSection.c ä»£ç é‡Œé¢ä¸€å…±æœ‰ä¸¤ä¸ªè¿™æ ·çš„å˜é‡ï¼Œåˆ†åˆ«æ˜¯ global_init_varabal ä¸ static_varã€‚è¿™ä¸¤ä¸ªå˜é‡æ¯ä¸ª 4 å­—èŠ‚ï¼Œä¸€å…±åˆšå¥½ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥â€œ.dataâ€è¿™ä¸ªæ®µçš„å¤§å°ä¸º 8 ä¸ªå­—èŠ‚ã€‚ SimpleSection.c é‡Œé¢æˆ‘ä»¬åœ¨è°ƒç”¨â€œprintfâ€çš„æ—¶å€™ï¼Œç”¨åˆ°äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡â€œ%dâ€ï¼Œå®ƒæ˜¯ä¸€ç§åªè¯»æ•°æ®ï¼Œæ‰€ä»¥å®ƒè¢«æ”¾åˆ°äº†â€œ.rodataâ€æ®µï¼Œæˆ‘ä»¬å¯ä»¥ä»è¾“å‡ºç»“æœçœ‹åˆ°â€œ.rodataâ€è¿™ä¸ªæ®µçš„ 4 ä¸ªå­—èŠ‚åˆšå¥½æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²å¸¸é‡çš„ ASCII å­—èŠ‚åºï¼Œæœ€åä»¥ã€0 ç»“å°¾ã€‚ å•ç‹¬è®¾ç«‹â€œ.rodataâ€æ®µæœ‰å¾ˆå¤šå¥½å¤„ï¼Œä¸å…‰æ˜¯åœ¨è¯­ä¹‰ä¸Šæ”¯æŒäº† C++çš„ const å…³é”®å­—ï¼Œè€Œä¸”æ“ä½œç³»ç»Ÿåœ¨åŠ è½½çš„æ—¶å€™å¯ä»¥å°†â€œ.rodataâ€æ®µçš„å±æ€§æ˜ å°„æˆåªè¯»ï¼Œè¿™æ ·å¯¹äºè¿™ä¸ªæ®µçš„ä»»ä½•ä¿®æ”¹æ“ä½œéƒ½ä¼šä½œä¸ºéæ³•æ“ä½œå¤„ç†ï¼Œä¿è¯äº†ç¨‹åºçš„å®‰å…¨æ€§ã€‚ å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰æ—¶å€™ç¼–è¯‘å™¨ä¼šæŠŠå­—ç¬¦ä¸²å¸¸é‡æ”¾åˆ°â€œ.dataâ€æ®µï¼Œè€Œä¸ä¼šå•ç‹¬æ”¾åœ¨â€œ.rodataâ€æ®µã€‚</p><h2 id="bss-æ®µ">BSS æ®µ</h2><p>.bss æ®µå­˜æ”¾çš„æ˜¯æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼Œå¦‚ä¸Šè¿°ä»£ç ä¸­ global_uninit_var å’Œ static_var2 å°±æ˜¯è¢«å­˜æ”¾åœ¨ã€‚bss æ®µï¼Œå…¶å®æ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ã€‚bss æ®µä¸ºå®ƒä»¬é¢„ç•™äº†ç©ºé—´ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ®µçš„å¤§å°åªæœ‰ 4 ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ global_uninit_var å’Œ static_var2 çš„å¤§å°çš„ 8 ä¸ªå­—èŠ‚ä¸ç¬¦ã€‚ å…¶å®æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰çœ‹åˆ°ï¼Œåªæœ‰ static_var2 è¢«å­˜æ”¾åœ¨äº†ã€‚bss æ®µï¼Œè€Œ global_uninit_var å´æ²¡æœ‰è¢«å­˜æ”¾åœ¨ä»»ä½•æ®µï¼Œåªæ˜¯ä¸€ä¸ªæœªå®šä¹‰çš„â€œCOMMON ç¬¦å·â€ã€‚è¿™å…¶å®æ˜¯è·Ÿä¸åŒçš„è¯­è¨€ä¸ä¸åŒçš„ç¼–è¯‘å™¨å®ç°æœ‰å…³ï¼Œæœ‰äº›ç¼–è¯‘å™¨ä¼šå°†å…¨å±€çš„æœªåˆå§‹åŒ–å˜é‡å­˜æ”¾åœ¨ç›®æ ‡æ–‡ä»¶ã€‚bss æ®µï¼Œæœ‰äº›åˆ™ä¸å­˜æ”¾ï¼Œåªæ˜¯é¢„ç•™ä¸€ä¸ªæœªå®šä¹‰çš„å…¨å±€å˜é‡ç¬¦å·ï¼Œç­‰åˆ°æœ€ç»ˆé“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™å†åœ¨ã€‚bss æ®µåˆ†é…ç©ºé—´ã€‚</p><h2 id="å…¶ä»–æ®µ">å…¶ä»–æ®µ</h2><p>é™¤äº†ã€‚textã€.dataã€.bss è¿™ 3 ä¸ªæœ€å¸¸ç”¨çš„æ®µä¹‹å¤–ï¼ŒELF æ–‡ä»¶ä¹Ÿæœ‰å¯èƒ½åŒ…å«å…¶ä»–çš„æ®µï¼Œç”¨æ¥ä¿å­˜ä¸ç¨‹åºç›¸å…³çš„å…¶ä»–ä¿¡æ¯ã€‚ä¸‹è¡¨ä¸­åˆ—ä¸¾äº† ELF çš„ä¸€äº›å¸¸è§çš„æ®µï¼š</p><table><thead><tr class="header"><th>å¸¸ç”¨çš„æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr class="odd"><td>.rodatal</td><td>Read only Dataï¼Œè¿™ç§æ®µé‡Œå­˜æ”¾çš„æ˜¯åªè¯»æ•°æ®ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¸¸é‡ã€å…¨å±€ const å˜é‡ã€‚è·Ÿâ€œ.rodataâ€ä¸€æ ·</td></tr><tr class="even"><td>.comment</td><td>å­˜æ”¾çš„æ˜¯ç¼–è¯‘å™¨ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ï¼šâ€GCCï¼šï¼ˆGNUï¼‰4.2.0</td></tr><tr class="odd"><td>.debug</td><td>è°ƒè¯•ä¿¡æ¯</td></tr><tr class="even"><td>.dynamic</td><td>åŠ¨æ€é“¾æ¥ä¿¡æ¯</td></tr><tr class="odd"><td>.hash</td><td>ç¬¦å·å“ˆå¸Œè¡¨</td></tr><tr class="even"><td>.line</td><td>è°ƒè¯•æ—¶çš„è¡Œå·è¡¨ï¼Œå³æºä»£ç è¡Œå·ä¸ç¼–è¯‘åæŒ‡ä»¤çš„å¯¹åº”è¡¨</td></tr><tr class="odd"><td>.note</td><td>é¢å¤–çš„ç¼–è¯‘å™¨ä¿¡æ¯ã€‚æ¯”å¦‚ç¨‹åºçš„å…¬å¸åã€å‘å¸ƒç‰ˆæœ¬å·ç­‰</td></tr><tr class="even"><td>.strtab</td><td>String Table. å­—ç¬¦ä¸²è¡¨ï¼Œç”¨äºå­˜å‚¨ ELF æ–‡ä»¶ä¸­ç”¨åˆ°çš„å„ç§å­—ç¬¦ä¸²</td></tr><tr class="odd"><td>.symtab</td><td>Symbol Table. ç¬¦å·è¡¨</td></tr><tr class="even"><td>.shstrtab</td><td>Section String Table. æ®µåè¡¨</td></tr><tr class="odd"><td>.plt <bar> .got</bar></td><td>åŠ¨æ€é“¾æ¥çš„è·³è½¬è¡¨å’Œå…¨å±€å…¥å£è¡¨</td></tr><tr class="even"><td>.init <bar> .fini</bar></td><td>ç¨‹åºåˆå§‹åŒ–ä¸ç»ˆç»“ä»£ç æ®µ</td></tr></tbody></table><p>è¿™äº›æ®µçš„åå­—éƒ½æ˜¯ç”±â€œ.â€ä½œä¸ºå‰ç¼€ï¼Œè¡¨ç¤ºè¿™äº›è¡¨çš„åå­—æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›éç³»ç»Ÿä¿ç•™çš„åå­—ä½œä¸ºæ®µåã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨ ELF æ–‡ä»¶ä¸­æ’å…¥ä¸€ä¸ªâ€œmusicâ€çš„æ®µï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€é¦– MP3 éŸ³ä¹ï¼Œå½“ ELF æ–‡ä»¶è¿è¡Œèµ·æ¥ä»¥åå¯ä»¥è¯»å–è¿™ä¸ªæ®µæ’­æ”¾è¿™é¦– MP3ã€‚ä½†æ˜¯åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„æ®µåä¸èƒ½ä½¿ç”¨â€œ.â€ä½œä¸ºå‰ç¼€ï¼Œå¦åˆ™å®¹æ˜“è·Ÿç³»ç»Ÿä¿ç•™æ®µåå†²çªã€‚</p><p>Qï¼šå¦‚æœæˆ‘ä»¬è¦å°†ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚å›¾ç‰‡ã€MP3 éŸ³ä¹ã€è¯å…¸ä¸€ç±»çš„ä¸œè¥¿ä½œä¸ºç›®æ ‡æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ®µï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ Aï¼šå¯ä»¥ä½¿ç”¨ objcopy å·¥å…·ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶â€œimage.jpgâ€ï¼Œå¤§å°ä¸º 0x82100 å­—èŠ‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objcopy -I binary -o elf32-1386 -B i386 image.jpg image.o</span><br><span class="line">objdump -ht image.o</span><br></pre></td></tr></tbody></table></figure><h1 id="elf-æ–‡ä»¶ç»“æ„æè¿°">ELF æ–‡ä»¶ç»“æ„æè¿°</h1><p>ä¸‹å›¾æè¿°çš„æ˜¯ ELF ç›®æ ‡æ–‡ä»¶çš„æ€»ä½“ç»“æ„ï¼Œæˆ‘ä»¬çœå»äº† ELF-äº›ç¹ççš„ç»“æ„ï¼ŒæŠŠæœ€é‡è¦çš„ç»“æ„æå–å‡ºæ¥ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/elf3.png"></p><h2 id="æ–‡ä»¶å¤´">æ–‡ä»¶å¤´</h2><p>æˆ‘ä»¬å¯ä»¥ç”¨ readelf å‘½ä»¤æ¥è¯¦ç»†æŸ¥çœ‹ ELF æ–‡ä»¶ï¼Œ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ readelf -h Simplesection.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">'s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          1184 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         14</span></span><br><span class="line"><span class="string">  Section header string table index: 13</span></span><br></pre></td></tr></tbody></table></figure><p>ä»ä¸Šé¢è¾“å‡ºçš„ç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒELF çš„æ–‡ä»¶å¤´ä¸­å®šä¹‰äº† ELF é­”æ•°ã€æ–‡ä»¶æœºå™¨å­—èŠ‚é•¿åº¦ã€æ•°æ®å­˜å‚¨æ–¹å¼ã€ç‰ˆæœ¬ã€è¿è¡Œå¹³å°ã€ABI ç‰ˆæœ¬ã€ELF é‡å®šä½ç±»å‹ã€ç¡¬ä»¶å¹³å°ã€ç¡¬ä»¶å¹³å°ç‰ˆæœ¬ã€å…¥å£åœ°å€ã€ç¨‹åºå¤´å…¥å£å’Œé•¿åº¦ã€æ®µè¡¨çš„ä½ç½®å’Œé•¿åº¦åŠæ®µçš„æ•°é‡ç­‰ã€‚è¿™äº›æ•°å€¼ä¸­æœ‰å…³æè¿° ELF ç›®æ ‡å¹³å°çš„éƒ¨åˆ†ï¼Œä¸æˆ‘ä»¬å¸¸è§çš„ 32 ä½ Intel çš„ç¡¬ä»¶å¹³å°åŸºæœ¬ä¸Šä¸€æ ·ã€‚</p><h2 id="æ®µè¡¨">æ®µè¡¨</h2><p>å‰æ–‡ä¸­æˆ‘ä»¬ä½¿ç”¨äº†â€œobjudump -hâ€æ¥æŸ¥çœ‹ ELF æ–‡ä»¶ä¸­åŒ…å«çš„æ®µï¼Œç»“æœæ˜¯ SimpleSection é‡Œé¢çœ‹åˆ°äº†æ€»å…±æœ‰ 6 ä¸ªæ®µï¼Œåˆ†åˆ«æ˜¯â€œ.codeâ€ã€â€œ.dataâ€ã€â€œ.bssâ€ã€â€œ.rodataâ€ã€â€œ.comment'â€å’Œâ€œ.note.GNU-stackâ€ã€‚å®é™…ä¸Šçš„æƒ…å†µå´æœ‰æ‰€ä¸åŒï¼Œâ€œobjdump -hâ€å‘½ä»¤åªæ˜¯æŠŠ ELF æ–‡ä»¶ä¸­å…³é”®çš„æ®µæ˜¾ç¤ºäº†å‡ºæ¥ï¼Œè€Œçœç•¥äº†å…¶ä»–çš„è¾…åŠ©æ€§çš„æ®µï¼Œæ¯”å¦‚ï¼šç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€æ®µåå­—ç¬¦ä¸²è¡¨ã€é‡å®šä½è¡¨ç­‰ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ readelf å·¥å…·æ¥æŸ¥çœ‹ ELF æ–‡ä»¶çš„æ®µï¼Œå®ƒæ˜¾ç¤ºå‡ºæ¥çš„ç»“æœæ‰æ˜¯çœŸæ­£çš„æ®µè¡¨ç»“æ„ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ readelf -S Simplesection.o</span><br><span class="line">There are 14 section headers, starting at offset 0x4a0:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000005f  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000380</span><br><span class="line">       0000000000000078  0000000000000018   I      11     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  000000a0</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .comment          PROGBITS         0000000000000000  000000ac</span><br><span class="line">       000000000000002b  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  000000d7</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .note.gnu.propert NOTE             0000000000000000  000000d8</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [ 9] .eh_frame         PROGBITS         0000000000000000  000000f8</span><br><span class="line">       0000000000000058  0000000000000000   A       0     0     8</span><br><span class="line">  [10] .rela.eh_frame    RELA             0000000000000000  000003f8</span><br><span class="line">       0000000000000030  0000000000000018   I      11     9     8</span><br><span class="line">  [11] .symtab           SYMTAB           0000000000000000  00000150</span><br><span class="line">       00000000000001b0  0000000000000018          12    12     8</span><br><span class="line">  [12] .strtab           STRTAB           0000000000000000  00000300</span><br><span class="line">       000000000000007c  0000000000000000           0     0     1</span><br><span class="line">  [13] .shstrtab         STRTAB           0000000000000000  00000428</span><br><span class="line">       0000000000000074  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (<span class="built_in">link</span> order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></tbody></table></figure><p>å¯¹äº SimpleSection.o æ¥è¯´ï¼Œæ®µè¡¨å°±æ˜¯æœ‰ 11 ä¸ªå…ƒç´ çš„æ•°ç»„ã€‚ELF æ®µè¡¨çš„è¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ— æ•ˆçš„æ®µæè¿°ç¬¦ï¼Œå®ƒçš„ç±»å‹ä¸ºâ€œNULLâ€ï¼Œé™¤æ­¤ä¹‹å¤–æ¯ä¸ªæ®µæè¿°ç¬¦éƒ½å¯¹åº”ä¸€ä¸ªæ®µã€‚ä¹Ÿå°±æ˜¯è¯´ SimpleSection.o å…±æœ‰ 13 ä¸ªæœ‰æ•ˆçš„æ®µã€‚</p><h2 id="é‡å®šä½è¡¨">é‡å®šä½è¡¨</h2><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒSimpleSection.o ä¸­æœ‰ä¸€ä¸ªå«åšâ€œ.rela.textâ€çš„æ®µï¼Œå®ƒçš„ç±»å‹ï¼ˆsh_typeï¼‰ä¸ºâ€œRELAâ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯ä¸€ä¸ªé‡å®šä½è¡¨ï¼ˆRelocation Tableï¼‰ã€‚æ­£å¦‚æˆ‘ä»¬æœ€å¼€å§‹æ‰€è¯´çš„ï¼Œé“¾æ¥å™¨åœ¨å¤„ç†ç›®æ ‡æ–‡ä»¶æ—¶ï¼Œé¡»è¦å¯¹ç›®æ ‡æ–‡ä»¶ä¸­æŸäº›éƒ¨ä½è¿›è¡Œé‡å®šä½ï¼Œå³ä»£ç æ®µå’Œæ•°æ®æ®µä¸­é‚£äº›å¯¹ç»å¯¹åœ°å€çš„å¼•ç”¨çš„ä½ç½®ã€‚</p><p>æ¯”å¦‚ SimpleSection.o ä¸­çš„â€œ.rela.textâ€å°±æ˜¯é’ˆå¯¹â€œ.textâ€æ®µçš„é‡å®šä½è¡¨ï¼Œå› ä¸ºâ€œ.textâ€æ®µä¸­è‡³å°‘æœ‰ä¸€ä¸ªç»å¯¹åœ°å€çš„å¼•ç”¨ï¼Œé‚£å°±æ˜¯å¯¹â€œprintfâ€å‡½æ•°çš„è°ƒç”¨ï¼›è€Œâ€œ.dataâ€æ®µåˆ™æ²¡æœ‰å¯¹ç»å¯¹åœ°å€çš„å¼•ç”¨ï¼Œå®ƒåªåŒ…å«äº†å‡ ä¸ªå¸¸é‡ï¼Œæ‰€ä»¥ SimpleSection.o ä¸­æ²¡æœ‰é’ˆå¯¹â€œ.dataâ€æ®µçš„é‡å®šä½è¡¨â€œ.rela.dataâ€ã€‚</p><h2 id="å­—ç¬¦ä¸²è¡¨">å­—ç¬¦ä¸²è¡¨</h2><p>ELF æ–‡ä»¶ä¸­ç”¨åˆ°äº†å¾ˆå¤šå­—ç¬¦ä¸²ï¼Œæ¯”å¦‚æ®µåã€å˜é‡åç­‰ï¼Œæ¯”å¦‚ä¸‹è¡¨è¿™ä¸ªå­—ç¬¦ä¸²è¡¨ã€‚</p><table><thead><tr class="header"><th>åç§»</th><th>+0</th><th>+1</th><th>+2</th><th>+3</th><th>+4</th><th>+5</th><th>+6</th><th>+7</th><th>+8</th><th>+9</th></tr></thead><tbody><tr class="odd"><td>+0</td><td>\0</td><td>h</td><td>e</td><td>l</td><td>l</td><td>o</td><td>w</td><td>o</td><td>r</td><td>l</td></tr><tr class="even"><td>+10</td><td>d</td><td>\0</td><td>M</td><td>y</td><td>v</td><td>a</td><td>r</td><td>i</td><td>a</td><td>b</td></tr><tr class="odd"><td>+20</td><td>l</td><td>e</td><td>\0</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>å¸¸è§çš„æ®µåä¸ºâ€œ.strtabâ€æˆ–â€œ.shstrtabâ€ã€‚è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²è¡¨åˆ†åˆ«ä¸ºå­—ç¬¦ä¸²è¡¨ï¼ˆString Tableï¼‰å’Œæ®µè¡¨å­—ç¬¦ä¸²è¡¨ï¼ˆSection Header String Tableï¼‰ã€‚</p><h1 id="ç¬¦å·">ç¬¦å·</h1><p>åœ¨é“¾æ¥ä¸­ï¼Œæˆ‘ä»¬å°†å‡½æ•°å’Œå˜é‡ç»Ÿç§°ä¸ºç¬¦å·ï¼ˆSymbolï¼‰ï¼Œå‡½æ•°åæˆ–å˜é‡åå°±æ˜¯ç¬¦å·åï¼ˆSymbol Nameï¼‰ã€‚</p><p>é“¾æ¥è¿‡ç¨‹ä¸­å¾ˆå…³é”®çš„ä¸€éƒ¨åˆ†å°±æ˜¯ç¬¦å·çš„ç®¡ç†ï¼Œæ¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ªç›¸åº”çš„ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰ï¼Œè¿™ä¸ªè¡¨é‡Œé¢è®°å½•äº†ç›®æ ‡æ–‡ä»¶ä¸­æ‰€ç”¨åˆ°çš„æ‰€æœ‰ç¬¦å·ã€‚æ¯ä¸ªå®šä¹‰çš„ç¬¦å·æœ‰ä¸€ä¸ªå¯¹åº”çš„å€¼ï¼Œå«åšç¬¦å·å€¼ï¼ˆSymbol Valueï¼‰ï¼Œå¯¹äºå˜é‡å’Œå‡½æ•°æ¥è¯´ï¼Œç¬¦å·å€¼å°±æ˜¯å®ƒä»¬çš„åœ°å€ã€‚é™¤äº†å‡½æ•°å’Œå˜é‡ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨å…¶ä»–å‡ ç§ä¸å¸¸ç”¨åˆ°çš„ç¬¦å·ï¼Œæˆ‘ä»¬å°†ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·è¿›è¡Œåˆ†ç±»ï¼Œå®ƒä»¬æœ‰å¯èƒ½æ˜¯ä¸‹é¢è¿™äº›ç±»å‹ä¸­çš„ä¸€ç§ï¼š</p><ul><li>å®šä¹‰åœ¨æœ¬ç›®æ ‡æ–‡ä»¶çš„å…¨å±€ç¬¦å·ï¼Œå¯ä»¥è¢«å…¶ä»–ç›®æ ‡æ–‡ä»¶å¼•ç”¨ã€‚æ¯”å¦‚ SimpleSection.o é‡Œé¢çš„â€œfunc1â€ã€â€œmainâ€å’Œâ€œglobal_init_varâ€ã€‚</li><li>åœ¨æœ¬ç›®æ ‡æ–‡ä»¶ä¸­å¼•ç”¨çš„å…¨å±€ç¬¦å·ï¼Œå´æ²¡æœ‰å®šä¹‰åœ¨æœ¬ç›®æ ‡æ–‡ä»¶ï¼Œè¿™ä¸€èˆ¬å«åšå¤–éƒ¨ç¬¦å·ï¼ˆExternal Symbolï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è®²çš„ç¬¦å·å¼•ç”¨ã€‚æ¯”å¦‚ SimpleSection.o é‡Œé¢çš„â€œprintfâ€ã€‚</li><li>æ®µåï¼Œè¿™ç§ç¬¦å·å¾€å¾€ç”±ç¼–è¯‘å™¨äº§ç”Ÿï¼Œå®ƒçš„å€¼å°±æ˜¯è¯¥æ®µçš„èµ·å§‹åœ°å€ã€‚æ¯”å¦‚ SimpleSection.o é‡Œé¢çš„â€œ.textâ€ã€â€œ.dataâ€ç­‰ã€‚</li><li>å±€éƒ¨ç¬¦å·ï¼Œè¿™ç±»ç¬¦å·åªåœ¨ç¼–è¯‘å•å…ƒå†…éƒ¨å¯è§ã€‚æ¯”å¦‚ SimpleSection.o é‡Œé¢çš„â€œstatic_varâ€å’Œâ€œstatic_var2â€ã€‚è°ƒè¯•å™¨å¯ä»¥ä½¿ç”¨è¿™äº›ç¬¦å·æ¥åˆ†æç¨‹åºæˆ–å´©æºƒæ—¶çš„æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚è¿™äº›å±€éƒ¨ç¬¦å·å¯¹äºé“¾æ¥è¿‡ç¨‹æ²¡æœ‰ä½œç”¨ï¼Œé“¾æ¥å™¨å¾€å¾€ä¹Ÿå¿½ç•¥å®ƒä»¬ã€‚</li><li>è¡Œå·ä¿¡æ¯ï¼Œå³ç›®æ ‡æ–‡ä»¶æŒ‡ä»¤ä¸æºä»£ç ä¸­ä»£ç è¡Œçš„å¯¹åº”å…³ç³»ï¼Œå®ƒä¹Ÿæ˜¯å¯é€‰çš„ã€‚</li></ul><p>å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæœ€å€¼å¾—å…³æ³¨çš„å°±æ˜¯å…¨å±€ç¬¦å·ï¼Œå³ä¸Šé¢åˆ†ç±»ä¸­çš„ç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»ã€‚å› ä¸ºé“¾æ¥è¿‡ç¨‹åªå…³å¿ƒå…¨å±€ç¬¦å·çš„ç›¸äº’â€œç²˜åˆâ€ï¼Œå±€éƒ¨ç¬¦å·ã€æ®µåã€è¡Œå·ç­‰éƒ½æ˜¯æ¬¡è¦çš„ï¼Œå®ƒä»¬å¯¹äºå…¶ä»–ç›®æ ‡æ–‡ä»¶æ¥è¯´æ˜¯â€œä¸å¯è§â€çš„ï¼Œåœ¨é“¾æ¥è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯æ— å…³ç´§è¦çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ˆå¤šå·¥å…·æ¥æŸ¥çœ‹ ELF æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œæ¯”å¦‚ readelfã€objdumpã€nm ç­‰ï¼Œæ¯”å¦‚ä½¿ç”¨â€œnmâ€æ¥æŸ¥çœ‹â€œSimpleSection.oâ€çš„ç¬¦å·ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ nm Simplesection.o</span><br><span class="line">                 U _GLOBAL_OFFSET_TABLE_</span><br><span class="line">0000000000000000 T func1</span><br><span class="line">0000000000000000 D global_init_var</span><br><span class="line">0000000000000004 C global_uninit_var</span><br><span class="line">0000000000000028 T main</span><br><span class="line">                 U <span class="built_in">printf</span></span><br><span class="line">0000000000000004 d static_var.2324</span><br><span class="line">0000000000000000 b static_var2.2325</span><br></pre></td></tr></tbody></table></figure><h2 id="ç‰¹æ®Šç¬¦å·">ç‰¹æ®Šç¬¦å·</h2><p>å½“æˆ‘ä»¬ä½¿ç”¨ ld ä½œä¸ºé“¾æ¥å™¨æ¥é“¾æ¥ç”Ÿäº§å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå®ƒä¼šä¸ºæˆ‘ä»¬å®šä¹‰å¾ˆå¤šç‰¹æ®Šçš„ç¬¦å·ï¼Œè¿™äº›ç¬¦å·å¹¶æ²¡æœ‰åœ¨ä½ çš„ç¨‹åºä¸­å®šä¹‰ï¼Œä½†æ˜¯ä½ å¯ä»¥ç›´æ¥å£°æ˜å¹¶ä¸”å¼•ç”¨å®ƒï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç‰¹æ®Šç¬¦å·ã€‚å…¶å®è¿™äº›ç¬¦å·æ˜¯è¢«å®šä¹‰åœ¨ ld é“¾æ¥å™¨çš„é“¾æ¥è„šæœ¬ä¸­çš„ï¼Œé“¾æ¥å™¨ä¼šåœ¨å°†ç¨‹åºæœ€ç»ˆé“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™å°†å…¶è§£ææˆæ­£ç¡®çš„å€¼ï¼Œæ³¨æ„ï¼Œåªæœ‰ä½¿ç”¨ ld é“¾æ¥ç”Ÿäº§æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™è¿™äº›ç¬¦å·æ‰ä¼šå­˜åœ¨ã€‚</p><ul><li>_executable_startï¼Œè¯¥ç¬¦å·ä¸ºç¨‹åºèµ·å§‹åœ°å€ï¼Œæ³¨æ„ï¼Œä¸æ˜¯å…¥å£åœ°å€ï¼Œæ˜¯ç¨‹åºçš„æœ€å¼€å§‹çš„åœ°å€ã€‚</li><li>etext æˆ–_etext æˆ– etextï¼Œè¯¥ç¬¦å·ä¸ºä»£ç æ®µç»“æŸåœ°å€ï¼Œå³ä»£ç æ®µæœ€æœ«å°¾çš„åœ°å€ã€‚</li><li>_edata æˆ– edataï¼Œè¯¥ç¬¦å·ä¸ºæ•°æ®æ®µç»“æŸåœ°å€ï¼Œå³æ•°æ®æ®µæœ€æœ«å°¾çš„åœ°å€ã€‚</li><li>_end æˆ– endï¼Œè¯¥ç¬¦å·ä¸ºç¨‹åºç»“æŸåœ°å€ã€‚</li><li>ä»¥ä¸Šåœ°å€éƒ½ä¸ºç¨‹åºè¢«è£…è½½æ—¶çš„è™šæ‹Ÿåœ°å€ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨è¿™äº›ç¬¦å·ã€‚</p><h2 id="ç¬¦å·ä¿®é¥°ä¸å‡½æ•°ç­¾å">ç¬¦å·ä¿®é¥°ä¸å‡½æ•°ç­¾å</h2><p><strong>C++ç¬¦å·ä¿®é¥°</strong><br>C++å…è®¸å¤šä¸ªä¸åŒå‚æ•°ç±»å‹çš„å‡½æ•°æ‹¥æœ‰ä¸€æ ·çš„åå­—ï¼Œå°±æ˜¯æ‰€è°“çš„å‡½æ•°é‡è½½ï¼›å¦å¤– C++è¿˜åœ¨è¯­è¨€çº§åˆ«æ”¯æŒåç§°ç©ºé—´ï¼Œå³å…è®¸åœ¨ä¸åŒçš„åç§°ç©ºé—´æœ‰å¤šä¸ªåŒæ ·åå­—çš„ç¬¦å·ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">float</span> <span class="title function_">func</span><span class="params">(<span class="type">float</span>)</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> {</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C2</span> {</span></span><br><span class="line">        <span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line">    };</span><br><span class="line">};</span><br><span class="line">namespace N {</span><br><span class="line">    <span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span> {</span></span><br><span class="line">        <span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæœ¯è¯­å«åšå‡½æ•°ç­¾åï¼ˆFunction Signatureï¼‰ï¼Œå‡½æ•°ç­¾ååŒ…å«äº†ä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‡½æ•°åã€å®ƒçš„å‚æ•°ç±»å‹ã€å®ƒæ‰€åœ¨çš„ç±»å’Œåç§°ç©ºé—´åŠå…¶ä»–ä¿¡æ¯ï¼Œå‡½æ•°ç­¾åç”¨äºè¯†åˆ«ä¸åŒçš„å‡½æ•°ã€‚C++ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨éƒ½ä½¿ç”¨ç¬¦å·æ¥è¯†åˆ«å’Œå¤„ç†å‡½æ•°å’Œå˜é‡ï¼Œæ‰€ä»¥å¯¹äºä¸åŒå‡½æ•°ç­¾åçš„å‡½æ•°ï¼Œå³ä½¿å‡½æ•°åç›¸åŒï¼Œç¼–è¯‘å™¨å’Œé“¾æ¥å™¨éƒ½è®¤ä¸ºå®ƒä»¬æ˜¯ä¸åŒçš„å‡½æ•°ã€‚ä¸Šé¢çš„ 6 ä¸ªå‡½æ•°ç­¾ååœ¨ GCC ç¼–è¯‘å™¨ä¸‹ï¼Œç›¸å¯¹åº”çš„ä¿®é¥°ååç§°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/elf6.png"></p><p>GCC çš„åŸºæœ¬ C++åç§°ä¿®é¥°æ–¹æ³•å¦‚ä¸‹ï¼šæ‰€æœ‰çš„ç¬¦å·éƒ½ä»¥â€œ_Zâ€å¼€å¤´ï¼Œå¯¹äºåµŒå¥—çš„åå­—ï¼ˆåœ¨åç§°ç©ºé—´æˆ–åœ¨ç±»é‡Œé¢çš„ï¼‰ï¼Œåé¢ç´§è·Ÿâ€œNâ€ï¼Œç„¶åæ˜¯å„ä¸ªåç§°ç©ºé—´å’Œç±»çš„åå­—ï¼Œæ¯ä¸ªåå­—å‰æ˜¯åå­—å­—ç¬¦ä¸²é•¿åº¦ï¼Œå†ä»¥â€œEâ€ç»“å°¾ã€‚æ¯”å¦‚ N::C::func ç»è¿‡åç§°ä¿®é¥°ä»¥åå°±æ˜¯_ZN1N1C4funcEã€‚å¯¹äºä¸€ä¸ªå‡½æ•°æ¥è¯´ï¼Œå®ƒçš„å‚æ•°åˆ—è¡¨ç´§è·Ÿåœ¨â€œEâ€åé¢ï¼Œå¯¹äº int ç±»å‹æ¥è¯´ï¼Œå°±æ˜¯å­—æ¯â€œiâ€ã€‚æ‰€ä»¥æ•´ä¸ª N::C::funcï¼ˆintï¼‰å‡½æ•°ç­¾åç»è¿‡ä¿®é¥°ä¸º_ZN1N1C4funcEiã€‚binutils é‡Œé¢æä¾›äº†ä¸€ä¸ªå«â€œc++filtâ€çš„å·¥å…·å¯ä»¥ç”¨æ¥è§£æè¢«ä¿®é¥°è¿‡çš„åç§°ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c++filt _ZN1N1C4funcEi</span><br><span class="line">N:C:func(int)</span><br></pre></td></tr></tbody></table></figure><p>ç­¾åå’Œåç§°ä¿®é¥°æœºåˆ¶ä¸å…‰è¢«ä½¿ç”¨åˆ°å‡½æ•°ä¸Šï¼ŒC++ä¸­çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ä¹Ÿæœ‰åŒæ ·çš„æœºåˆ¶ã€‚å¯¹äºå…¨å±€å˜é‡æ¥è¯´ï¼Œå®ƒè·Ÿå‡½æ•°ä¸€æ ·éƒ½æ˜¯ä¸€ä¸ªå…¨å±€å¯è§çš„åç§°ï¼Œå®ƒä¹Ÿéµå¾ªä¸Šé¢çš„åç§°ä¿®é¥°æœºåˆ¶ã€‚</p><p>ç”±äºä¸åŒçš„ç¼–è¯‘å™¨é‡‡ç”¨ä¸åŒçš„åå­—ä¿®é¥°æ–¹æ³•ï¼Œå¿…ç„¶ä¼šå¯¼è‡´ç”±ä¸åŒç¼–è¯‘å™¨ç¼–è¯‘äº§ç”Ÿçš„ç›®æ ‡æ–‡ä»¶æ— æ³•æ­£å¸¸ç›¸äº’é“¾æ¥ï¼Œè¿™æ˜¯å¯¼è‡´ä¸åŒç¼–è¯‘å™¨ä¹‹é—´ä¸èƒ½äº’æ“ä½œçš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><h2 id="extern-c">extern â€œC"</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">memset</span> <span class="params">(<span class="type">void</span> *<span class="type">int</span>, <span class="type">size_t</span>)</span>;</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ C++è¯­è¨€ä¸­ï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸ºè¿™ä¸ª memset å‡½æ•°æ˜¯ä¸€ä¸ª C++å‡½æ•°ï¼Œå°† memset çš„ç¬¦å·ä¿®é¥°æˆ_ZmemsetPviiï¼Œè¿™æ ·é“¾æ¥å™¨å°±æ— æ³•ä¸ C è¯­è¨€åº“ä¸­çš„ memset ç¬¦å·è¿›è¡Œé“¾æ¥ã€‚æ‰€ä»¥å¯¹äº C++æ¥è¯´ï¼Œå¿…é¡»ä½¿ç”¨ externâ€œC"æ¥å£°æ˜ memset è¿™ä¸ªå‡½æ•°ã€‚ä½†æ˜¯ C è¯­è¨€åˆä¸æ”¯æŒ externâ€œCâ€è¯­æ³•ã€‚å¹¸å¥½æˆ‘ä»¬æœ‰ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨ C++çš„å®â€œ_cplusplusâ€ï¼ŒC++ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘ C++çš„ç¨‹åºæ—¶é»˜è®¤å®šä¹‰è¿™ä¸ªå®ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>{</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memset</span> <span class="params">(<span class="type">void</span> *<span class="type">int</span>,<span class="type">size_t</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> cplusplus</span></span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç ä¸­çš„æŠ€å·§å‡ ä¹åœ¨æ‰€æœ‰çš„ç³»ç»Ÿå¤´æ–‡ä»¶é‡Œé¢éƒ½è¢«ç”¨åˆ°ã€‚</p><h2 id="å¼±ç¬¦å·ä¸å¼ºç¬¦å·">å¼±ç¬¦å·ä¸å¼ºç¬¦å·</h2><p>å¯¹äº C/C++è¯­è¨€æ¥è¯´ï¼Œç¼–è¯‘å™¨é»˜è®¤å‡½æ•°å’Œåˆå§‹åŒ–äº†çš„å…¨å±€å˜é‡ä¸ºå¼ºç¬¦å·ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¸ºå¼±ç¬¦å·ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ GCC çš„â€œ<strong>attribute</strong>ï¼ˆweakï¼‰â€æ¥å®šä¹‰ä»»ä½•ä¸€ä¸ªå¼ºç¬¦å·ä¸ºå¼±ç¬¦å·ã€‚æ³¨æ„ï¼Œå¼ºç¬¦å·å’Œå¼±ç¬¦å·éƒ½æ˜¯é’ˆå¯¹å®šä¹‰æ¥è¯´çš„ï¼Œä¸æ˜¯é’ˆå¯¹ç¬¦å·çš„å¼•ç”¨ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸‹é¢è¿™æ®µç¨‹åºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> ext;</span><br><span class="line"><span class="type">int</span> weak;</span><br><span class="line"><span class="type">int</span> strong = <span class="number">1</span>:</span><br><span class="line">__attribute__((weak) weak2 = <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> main()</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢è¿™æ®µç¨‹åºä¸­ï¼Œâ€œweakâ€å’Œâ€œweak2â€æ˜¯å¼±ç¬¦å·ï¼Œâ€œstrongâ€å’Œâ€œmainâ€æ˜¯å¼ºç¬¦å·ï¼Œè€Œâ€œextâ€æ—¢éå¼ºç¬¦å·ä¹Ÿéå¼±ç¬¦å·ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¤–éƒ¨å˜é‡çš„å¼•ç”¨ã€‚é’ˆå¯¹å¼ºå¼±ç¬¦å·çš„æ¦‚å¿µï¼Œé“¾æ¥å™¨å°±ä¼šæŒ‰å¦‚ä¸‹è§„åˆ™å¤„ç†ä¸é€‰æ‹©è¢«å¤šæ¬¡å®šä¹‰çš„å…¨å±€ç¬¦å·ï¼š</p><ul><li>è§„åˆ™ 1ï¼šä¸å…è®¸å¼ºç¬¦å·è¢«å¤šæ¬¡å®šä¹‰ã€‚</li><li>è§„åˆ™ 2ï¼šå¦‚æœä¸€ä¸ªç¬¦å·åœ¨æŸä¸ªç›®æ ‡æ–‡ä»¶ä¸­æ˜¯å¼ºç¬¦å·ï¼Œåœ¨å…¶ä»–æ–‡ä»¶ä¸­éƒ½æ˜¯å¼±ç¬¦å·ï¼Œé‚£ä¹ˆé€‰æ‹©å¼ºç¬¦å·ã€‚</li><li>è§„åˆ™ 3ï¼šå¦‚æœä¸€ä¸ªç¬¦å·åœ¨æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ä¸­éƒ½æ˜¯å¼±ç¬¦å·ï¼Œé‚£ä¹ˆé€‰æ‹©å…¶ä¸­å ç”¨ç©ºé—´æœ€å¤§çš„ä¸€ä¸ªã€‚</li></ul><p>å¼±å¼•ç”¨å’Œå¼ºå¼•ç”¨ï¼š</p><ul><li>ç›®å‰æˆ‘ä»¬æ‰€çœ‹åˆ°çš„å¯¹å¤–éƒ¨ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·å¼•ç”¨åœ¨ç›®æ ‡æ–‡ä»¶è¢«æœ€ç»ˆé“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå®ƒä»¬é¡»è¦è¢«æ­£ç¡®å†³è®®ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯¥ç¬¦å·çš„å®šä¹‰ï¼Œé“¾æ¥å™¨å°±ä¼šæŠ¥ç¬¦å·æœªå®šä¹‰é”™è¯¯ï¼Œè¿™ç§è¢«ç§°ä¸ºå¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ã€‚</li><li>ä¸ä¹‹ç›¸å¯¹åº”è¿˜æœ‰ä¸€ç§å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ï¼Œåœ¨å¤„ç†å¼±å¼•ç”¨æ—¶ï¼Œå¦‚æœè¯¥ç¬¦å·æœ‰å®šä¹‰ï¼Œåˆ™é“¾æ¥å™¨å°†è¯¥ç¬¦å·çš„å¼•ç”¨å†³è®®ï¼›å¦‚æœè¯¥ç¬¦å·æœªè¢«å®šä¹‰ï¼Œåˆ™é“¾æ¥å™¨å¯¹äºè¯¥å¼•ç”¨ä¸æŠ¥é”™ã€‚</li></ul><p>åœ¨ GCC ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨â€œ<strong>attribute</strong>ï¼ˆweakrefï¼‰â€è¿™ä¸ªæ‰©å±•å…³é”®å­—æ¥å£°æ˜å¯¹ä¸€ä¸ªå¤–éƒ¨å‡½æ•°çš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((weakref))<span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span>:</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    foo():</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥å°†å®ƒç¼–è¯‘æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒGCC å¹¶ä¸ä¼šæŠ¥é“¾æ¥é”™è¯¯ã€‚ä½†æ˜¯å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿè¿è¡Œé”™è¯¯ã€‚å› ä¸ºå½“ main å‡½æ•°è¯•å›¾è°ƒç”¨ foo å‡½æ•°æ—¶ï¼Œfoo å‡½æ•°çš„åœ°å€ä¸º 0ï¼Œäºæ˜¯å‘ç”Ÿäº†éæ³•åœ°å€è®¿é—®çš„é”™è¯¯ã€‚ä¸€ä¸ªæ”¹è¿›çš„ä¾‹å­æ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((weakref) <span class="type">void</span> foo();</span><br><span class="line"><span class="type">int</span> main()</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(foo)</span><br><span class="line">        foo();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç§å¼±ç¬¦å·å’Œå¼±å¼•ç”¨å¯¹äºåº“æ¥è¯´ååˆ†æœ‰ç”¨ï¼Œæ¯”å¦‚åº“ä¸­å®šä¹‰çš„å¼±ç¬¦å·å¯ä»¥è¢«ç”¨æˆ·å®šä¹‰çš„å¼ºç¬¦å·æ‰€è¦†ç›–ï¼Œä»è€Œä½¿å¾—ç¨‹åºå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬çš„åº“å‡½æ•°ã€‚</p><h1 id="è°ƒè¯•ä¿¡æ¯">è°ƒè¯•ä¿¡æ¯</h1><p>å¦‚æœæˆ‘ä»¬åœ¨ GCC ç¼–è¯‘æ—¶åŠ ä¸Šâ€œ-gâ€å‚æ•°ï¼Œç¼–è¯‘å™¨å°±ä¼šåœ¨äº§ç”Ÿçš„ç›®æ ‡æ–‡ä»¶é‡Œé¢åŠ ä¸Šè°ƒè¯•ä¿¡æ¯ï¼Œæˆ‘ä»¬é€šè¿‡ readelf ç­‰å·¥å…·å¯ä»¥çœ‹åˆ°ï¼Œç›®æ ‡æ–‡ä»¶é‡Œå¤šäº†å¾ˆå¤šâ€œdebugâ€ç›¸å…³çš„æ®µï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ gcc -c -g Simplesection.c</span><br><span class="line">vooxle@liushuai:~$ <span class="built_in">ls</span></span><br><span class="line">Document  Simplesection.c  Simplesection.o  nfs_rootfs  workspace</span><br><span class="line">vooxle@liushuai:~$ readelf -S Simplesection.o</span><br><span class="line">There are 22 section headers, starting at offset 0x1570:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000005f  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000d40</span><br><span class="line">       0000000000000078  0000000000000018   I      19     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  000000a0</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000a8</span><br><span class="line">       0000000000000004  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .debug_info       PROGBITS         0000000000000000  000000ac</span><br><span class="line">       00000000000003a0  0000000000000000           0     0     1</span><br><span class="line">  [ 7] .rela.debug_info  RELA             0000000000000000  00000db8</span><br><span class="line">       0000000000000678  0000000000000018   I      19     6     8</span><br><span class="line">  [ 8] .debug_abbrev     PROGBITS         0000000000000000  0000044c</span><br><span class="line">       0000000000000130  0000000000000000           0     0     1</span><br><span class="line">  [ 9] .debug_aranges    PROGBITS         0000000000000000  0000057c</span><br><span class="line">       0000000000000030  0000000000000000           0     0     1</span><br><span class="line">  [10] .rela.debug_arang RELA             0000000000000000  00001430</span><br><span class="line">       0000000000000030  0000000000000018   I      19     9     8</span><br><span class="line">  [11] .debug_line       PROGBITS         0000000000000000  000005ac</span><br><span class="line">       000000000000012e  0000000000000000           0     0     1</span><br><span class="line">  [12] .rela.debug_line  RELA             0000000000000000  00001460</span><br><span class="line">       0000000000000018  0000000000000018   I      19    11     8</span><br><span class="line">  [13] .debug_str        PROGBITS         0000000000000000  000006da</span><br><span class="line">       0000000000000314  0000000000000001  MS       0     0     1</span><br><span class="line">  [14] .comment          PROGBITS         0000000000000000  000009ee</span><br><span class="line">       000000000000002b  0000000000000001  MS       0     0     1</span><br><span class="line">  [15] .note.GNU-stack   PROGBITS         0000000000000000  00000a19</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [16] .note.gnu.propert NOTE             0000000000000000  00000a20</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [17] .eh_frame         PROGBITS         0000000000000000  00000a40</span><br><span class="line">       0000000000000058  0000000000000000   A       0     0     8</span><br><span class="line">  [18] .rela.eh_frame    RELA             0000000000000000  00001478</span><br><span class="line">       0000000000000030  0000000000000018   I      19    17     8</span><br><span class="line">  [19] .symtab           SYMTAB           0000000000000000  00000a98</span><br><span class="line">       0000000000000228  0000000000000018          20    17     8</span><br><span class="line">  [20] .strtab           STRTAB           0000000000000000  00000cc0</span><br><span class="line">       000000000000007c  0000000000000000           0     0     1</span><br><span class="line">  [21] .shstrtab         STRTAB           0000000000000000  000014a8</span><br><span class="line">       00000000000000c3  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (<span class="built_in">link</span> order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></tbody></table></figure><p>è¿™äº›æ®µä¸­ä¿å­˜çš„å°±æ˜¯è°ƒè¯•ä¿¡æ¯ã€‚ç°åœ¨çš„ ELF æ–‡ä»¶é‡‡ç”¨ä¸€ä¸ªå« DWARFï¼ˆDebug With Arbitrary Record Formatï¼‰çš„æ ‡å‡†çš„è°ƒè¯•ä¿¡æ¯æ ¼å¼ï¼Œç°åœ¨è¯¥æ ‡å‡†å·²ç»å‘å±•åˆ°äº†ç¬¬ä¸‰ä¸ªç‰ˆæœ¬ï¼Œå³ DWARF3ï¼Œç”± DWARF æ ‡å‡†å§”å‘˜ä¼šç”± 2006 å¹´é¢å¸ƒã€‚åœ¨ Linux ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€œstripâ€å‘½ä»¤æ¥å»æ‰ ELF æ–‡ä»¶ä¸­çš„è°ƒè¯•ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ strip foo</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Links Libraries </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é“¾æ¥è£…è½½ä¸åº“ï¼ˆä¸€ï¼‰ç¼–è¯‘å’Œé“¾æ¥</title>
      <link href="/2021/Program/LinksAndLibrariesPart1/"/>
      <url>/2021/Program/LinksAndLibrariesPart1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/CompileAndLink.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjMwNmM0OWYzNDZmYjA3ZjkyZGFiOGI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="è¢«éšè—äº†çš„è¿‡ç¨‹">è¢«éšè—äº†çš„è¿‡ç¨‹</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ Linux ä¸‹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ GCC æ¥ç¼–è¯‘ Hello World ç¨‹åºæ—¶ï¼Œåªé¡»ä½¿ç”¨æœ€ç®€å•çš„å‘½ä»¤ï¼ˆå‡è®¾æºä»£ç æ–‡ä»¶åä¸º hello.cï¼‰ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc hello.c</span><br><span class="line">./a.out</span><br><span class="line">Hello world</span><br></pre></td></tr></tbody></table></figure><p>äº‹å®ä¸Šï¼Œä¸Šè¿°è¿‡ç¨‹å¯ä»¥åˆ†è§£ä¸º 4 ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯é¢„å¤„ç†ï¼ˆPrepressingï¼‰ã€ç¼–è¯‘ï¼ˆCompilationï¼‰ã€æ±‡ç¼–ï¼ˆAssemblyï¼‰å’Œé“¾æ¥ï¼ˆLinkingï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/program1.png"></p><h2 id="é¢„ç¼–è¯‘">é¢„ç¼–è¯‘</h2><p>ç¬¬ä¸€æ­¥é¢„ç¼–è¯‘çš„è¿‡ç¨‹ç›¸å½“äºå¦‚ä¸‹å‘½ä»¤ï¼ˆ-E è¡¨ç¤ºåªè¿›è¡Œé¢„ç¼–è¯‘ï¼‰ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpp hello.c hello.i</span><br></pre></td></tr></tbody></table></figure><p>é¢„ç¼–è¯‘è¿‡ç¨‹ä¸»è¦å¤„ç†é‚£äº›æºä»£ç æ–‡ä»¶ä¸­çš„ä»¥â€œ#â€å¼€å§‹çš„é¢„ç¼–è¯‘æŒ‡ä»¤ã€‚æ¯”å¦‚â€œ#includeâ€ã€â€œ#defineâ€ç­‰ï¼Œé¢„ç¼–è¯‘æˆä¸€ä¸ªã€‚i æ–‡ä»¶ï¼Œä¸»è¦å¤„ç†è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>å°†æ‰€æœ‰çš„â€œ#defineâ€åˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰</li><li>å¤„ç†æ‰€æœ‰æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œæ¯”å¦‚â€œ#ifâ€ã€â€œ#ifdef'â€ã€â€œ#elifâ€ã€â€œ#elseâ€ã€â€œ#endifâ€</li><li>å¤„ç†â€œ#includeâ€é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥é¢„ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ã€‚æ³¨æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€’å½’è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¢«åŒ…å«çš„æ–‡ä»¶å¯èƒ½è¿˜åŒ…å«å…¶ä»–æ–‡ä»¶ã€‚åˆ é™¤æ‰€æœ‰çš„æ³¨é‡Šâ€œ//â€å’Œâ€œ/**/â€</li><li>æ·»åŠ è¡Œå·å’Œæ–‡ä»¶åæ ‡è¯†ï¼Œæ¯”å¦‚#2â€œhello.câ€2ï¼Œä»¥ä¾¿äºç¼–è¯‘æ—¶ç¼–è¯‘å™¨äº§ç”Ÿè°ƒè¯•ç”¨çš„è¡Œå·ä¿¡æ¯åŠç”¨äºç¼–è¯‘æ—¶äº§ç”Ÿç¼–è¯‘é”™è¯¯æˆ–è­¦å‘Šæ—¶èƒ½å¤Ÿæ˜¾ç¤ºè¡Œå·</li><li>ä¿ç•™æ‰€æœ‰çš„#pragma ç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œå› ä¸ºç¼–è¯‘å™¨é¡»è¦ä½¿ç”¨å®ƒä»¬</li></ul><p>ç»è¿‡é¢„ç¼–è¯‘åçš„ã€‚i æ–‡ä»¶ä¸åŒ…å«ä»»ä½•å®å®šä¹‰ï¼Œå¹¶ä¸”åŒ…å«çš„æ–‡ä»¶ä¹Ÿå·²ç»è¢«æ’å…¥åˆ°ã€‚i æ–‡ä»¶ä¸­ã€‚</p><h2 id="ç¼–è¯‘">ç¼–è¯‘</h2><p>ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿäº§ç›¸åº”çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾€å¾€æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ•´ä¸ªç¨‹åºæ„å»ºçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ä¹‹ä¸€ã€‚ä¸Šé¢çš„ç¼–è¯‘è¿‡ç¨‹ç›¸å½“äºå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -s hello.i -o hello.s</span><br></pre></td></tr></tbody></table></figure><p>ç°åœ¨ç‰ˆæœ¬çš„ GCC æŠŠé¢„ç¼–è¯‘å’Œç¼–è¯‘ä¸¤ä¸ªæ­¥éª¤åˆå¹¶æˆä¸€ä¸ªæ­¥éª¤ï¼Œä½¿ç”¨ä¸€ä¸ªå«åš cc1 çš„ç¨‹åºæ¥å®Œæˆè¿™ä¸¤ä¸ªæ­¥éª¤ã€‚è¿™ä¸ªç¨‹åºä½äºâ€œ/usr/lib/gcc/i486-linux-gnu/4.1/â€ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ cc1 æ¥å®Œæˆå®ƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/gcc/i486-linux-gnu/4.1/cc1 hello.c</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -s hello.c -o hello.s</span><br></pre></td></tr></tbody></table></figure><h2 id="æ±‡ç¼–">æ±‡ç¼–</h2><p>æ±‡ç¼–å™¨æ˜¯å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ¯ä¸€ä¸ªæ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚æ‰€ä»¥æ±‡ç¼–å™¨çš„æ±‡ç¼–è¿‡ç¨‹ç›¸å¯¹äºç¼–è¯‘å™¨æ¥è®²æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯æ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ç¿»è¯‘å°±å¯ä»¥äº†ã€‚ä¸Šé¢çš„æ±‡ç¼–è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥è°ƒç”¨æ±‡ç¼–å™¨ as æ¥å®Œæˆï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as hello.s -o hello.o</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -o hello.o</span><br></pre></td></tr></tbody></table></figure><p>æˆ–è€…ä½¿ç”¨ gcc å‘½ä»¤ä» C æºä»£ç æ–‡ä»¶å¼€å§‹ï¼Œç»è¿‡é¢„ç¼–è¯‘ã€ç¼–è¯‘å’Œæ±‡ç¼–ç›´æ¥è¾“å‡ºç›®æ ‡æ–‡ä»¶ï¼ˆObject File):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.c -o hello.o</span><br></pre></td></tr></tbody></table></figure><h2 id="é“¾æ¥">é“¾æ¥</h2><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆæ ·è°ƒç”¨ ld æ‰å¯ä»¥äº§ç”Ÿä¸€ä¸ªèƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„ HelloWorld ç¨‹åºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ld -static /usr/lib/crt1.o /usr/lib/crti.o</span><br><span class="line">/usr/lib/gcc/i486-linux-gnu/4.1.3/crtbeginT.o</span><br><span class="line">-L/usr/lib/gcc/i486-linux-gnu/4.1.3 -L/usr/lib -L/lib hello.o --start-group</span><br><span class="line">-lgcc -lgcc_eh -lc --end-group /usr/lib/gcc/i486-linux-gnu/4.1.3/crtend.o/usr/lib/crtn.o</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæŠŠæ‰€æœ‰çš„è·¯å¾„éƒ½çœç•¥æ‰ï¼Œé‚£ä¹ˆä¸Šé¢çš„å‘½ä»¤å°±æ˜¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -static crt1.o crti.o crtbeginT.o hello.o -start-group -lgcc -lgcc_eh -lc -end-group crtend.o crtn.o</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸€å¤§å †æ–‡ä»¶é“¾æ¥èµ·æ¥æ‰å¯ä»¥å¾—åˆ°â€œa.outâ€ï¼Œå³æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h1 id="ç¼–è¯‘å™¨åšäº†ä»€ä¹ˆ">ç¼–è¯‘å™¨åšäº†ä»€ä¹ˆ</h1><p>ä»æœ€ç›´è§‚çš„è§’åº¦æ¥è®²ï¼Œç¼–è¯‘å™¨å°±æ˜¯å°†é«˜çº§è¯­è¨€ç¿»è¯‘æˆæœºå™¨è¯­è¨€çš„ä¸€ä¸ªå·¥å…·ã€‚</p><p>ç¼–è¯‘è¿‡ç¨‹ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºæ­¥ï¼šæ‰«æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æºä»£ç ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆå’Œç›®æ ‡ä»£ç ä¼˜åŒ–ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/compile.png"></p><p>æˆ‘ä»¬å°†ç»“åˆä¸Šå›¾æ¥ç®€å•æè¿°ä»æºä»£ç ï¼ˆSource Codeï¼‰åˆ°æœ€ç»ˆç›®æ ‡ä»£ç ï¼ˆFinal Target Codeï¼‰çš„è¿‡ç¨‹ã€‚ä»¥ä¸€æ®µå¾ˆç®€å•çš„ C è¯­è¨€çš„ä»£ç ä¸ºä¾‹å­æ¥è®²è¿°è¿™ä¸ªè¿‡ç¨‹ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€è¡Œ C è¯­è¨€çš„æºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">array</span>[index] = (index +<span class="number">4</span>)*(<span class="number">2</span> +<span class="number">6</span>)</span><br><span class="line">CompilerExpression.c</span><br></pre></td></tr></tbody></table></figure><h2 id="è¯æ³•åˆ†æ">è¯æ³•åˆ†æ</h2><p>é¦–å…ˆæºä»£ç ç¨‹åºè¢«è¾“å…¥åˆ°æ‰«æå™¨ï¼ˆScannerï¼‰ï¼Œæ‰«æå™¨çš„ä»»åŠ¡å¾ˆç®€å•ï¼Œå®ƒåªæ˜¯ç®€å•åœ°è¿›è¡Œè¯æ³•åˆ†æï¼Œè¿ç”¨ä¸€ç§ç±»ä¼¼äºæœ‰é™çŠ¶æ€æœºï¼ˆFinite State Machineï¼‰çš„ç®—æ³•å¯ä»¥å¾ˆè½»æ¾åœ°å°†æºä»£ç çš„å­—ç¬¦åºåˆ—åˆ†å‰²æˆä¸€ç³»åˆ—çš„è®°å·ï¼ˆTokenï¼‰ã€‚æ¯”å¦‚ä¸Šé¢çš„é‚£è¡Œç¨‹åºï¼Œæ€»å…±åŒ…å«äº† 28 ä¸ªéç©ºå­—ç¬¦ï¼Œç»è¿‡æ‰«æä»¥åï¼Œäº§ç”Ÿäº† 16 ä¸ªè®°å·ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><table><thead><tr class="header"><th>è®°å·</th><th>ç±»å‹</th></tr></thead><tbody><tr class="odd"><td>array</td><td>æ ‡è¯†ç¬¦</td></tr><tr class="even"><td>[</td><td>å·¦æ–¹æ‹¬å·</td></tr><tr class="odd"><td>index</td><td>æ ‡è¯†ç¬¦</td></tr><tr class="even"><td>]</td><td>å³æ–¹æ‹¬å·</td></tr><tr class="odd"><td>=</td><td>èµ‹å€¼</td></tr><tr class="even"><td>(</td><td>å·¦åœ†æ‹¬å·</td></tr><tr class="odd"><td>index</td><td>æ ‡è¯†ç¬¦</td></tr><tr class="even"><td>+</td><td>åŠ å·</td></tr><tr class="odd"><td>4</td><td>æ•°å­—</td></tr><tr class="even"><td>)</td><td>å³åœ†æ‹¬å·</td></tr><tr class="odd"><td>*</td><td>ä¹˜å·</td></tr><tr class="even"><td>(</td><td>å·¦åœ†æ‹¬å·</td></tr><tr class="odd"><td>2</td><td>æ•°å­—</td></tr><tr class="even"><td>+</td><td>åŠ å·</td></tr><tr class="odd"><td>6</td><td>æ•°å­—</td></tr><tr class="even"><td>)</td><td>å³åœ†æ‹¬å·</td></tr></tbody></table><p>è¯æ³•åˆ†æäº§ç”Ÿçš„è®°å·ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼šå…³é”®å­—ã€æ ‡è¯†ç¬¦ã€å­—é¢é‡ï¼ˆåŒ…å«æ•°å­—ã€å­—ç¬¦ä¸²ç­‰ï¼‰å’Œç‰¹æ®Šç¬¦å·ï¼ˆå¦‚åŠ å·ã€ç­‰å·ï¼‰ã€‚åœ¨è¯†åˆ«è®°å·çš„åŒæ—¶ï¼Œæ‰«æå™¨ä¹Ÿå®Œæˆäº†å…¶ä»–å·¥ä½œã€‚æ¯”å¦‚å°†æ ‡è¯†ç¬¦å­˜æ”¾åˆ°ç¬¦å·è¡¨ï¼Œå°†æ•°å­—ã€å­—ç¬¦ä¸²å¸¸é‡å­˜æ”¾åˆ°æ–‡å­—è¡¨ç­‰ï¼Œä»¥å¤‡åé¢çš„æ­¥éª¤ä½¿ç”¨ã€‚</p><h2 id="è¯­æ³•åˆ†æ">è¯­æ³•åˆ†æ</h2><p>è¯­æ³•åˆ†æå™¨ç”Ÿæˆçš„è¯­æ³•æ ‘å°±æ˜¯ä»¥è¡¨è¾¾å¼ï¼ˆExpressionï¼‰ä¸ºèŠ‚ç‚¹çš„æ ‘ã€‚ä¸Šé¢ä¾‹å­ä¸­çš„è¯­å¥å°±æ˜¯ä¸€ä¸ªç”±èµ‹å€¼è¡¨è¾¾å¼ã€åŠ æ³•è¡¨è¾¾å¼ã€ä¹˜æ³•è¡¨è¾¾å¼ã€æ•°ç»„è¡¨è¾¾å¼ã€æ‹¬å·è¡¨è¾¾å¼ç»„æˆçš„å¤æ‚è¯­å¥ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/sytex.png"></p><p>ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè¯­å¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼›èµ‹å€¼è¡¨è¾¾å¼çš„å·¦è¾¹æ˜¯ä¸€ä¸ªæ•°ç»„è¡¨è¾¾å¼ï¼Œå®ƒçš„å³è¾¹æ˜¯ä¸€ä¸ªä¹˜æ³•è¡¨è¾¾å¼ï¼›æ•°ç»„è¡¨è¾¾å¼åˆç”±ä¸¤ä¸ªç¬¦å·è¡¨è¾¾å¼ç»„æˆï¼Œç­‰ç­‰ã€‚åœ¨è¯­æ³•åˆ†æçš„åŒæ—¶ï¼Œå¾ˆå¤šè¿ç®—ç¬¦å·çš„ä¼˜å…ˆçº§å’Œå«ä¹‰ä¹Ÿè¢«ç¡®å®šä¸‹æ¥äº†ã€‚å¦‚æœå‡ºç°äº†è¡¨è¾¾å¼ä¸åˆæ³•ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥å‘Šè¯­æ³•åˆ†æé˜¶æ®µçš„é”™è¯¯ã€‚</p><h2 id="è¯­ä¹‰åˆ†æ">è¯­ä¹‰åˆ†æ</h2><p>è¯­æ³•åˆ†æä»…ä»…æ˜¯å®Œæˆäº†å¯¹è¡¨è¾¾å¼çš„è¯­æ³•å±‚é¢çš„åˆ†æï¼Œä½†æ˜¯å®ƒå¹¶ä¸äº†è§£è¿™ä¸ªè¯­å¥æ˜¯å¦çœŸæ­£æœ‰æ„ä¹‰ã€‚æ¯”å¦‚è¯­è¨€é‡Œé¢ä¸¤ä¸ªæŒ‡é’ˆåšä¹˜æ³•è¿ç®—æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯è¿™ä¸ªè¯­å¥åœ¨è¯­æ³•ä¸Šæ˜¯åˆæ³•çš„ã€‚ç¼–è¯‘å™¨æ‰€èƒ½åˆ†æçš„è¯­ä¹‰æ˜¯é™æ€è¯­ä¹‰ï¼ˆStatic Semanticï¼‰ï¼Œæ‰€è°“é™æ€è¯­ä¹‰æ˜¯æŒ‡åœ¨ç¼–è¯‘æœŸå¯ä»¥ç¡®å®šçš„è¯­ä¹‰ï¼Œä¸ä¹‹å¯¹åº”çš„åŠ¨æ€è¯­ä¹‰ï¼ˆDynamic Semanticï¼‰å°±æ˜¯åªæœ‰åœ¨è¿è¡ŒæœŸæ‰èƒ½ç¡®å®šçš„è¯­ä¹‰ã€‚</p><p>é™æ€è¯­ä¹‰é€šå¸¸åŒ…æ‹¬å£°æ˜å’Œç±»å‹çš„åŒ¹é…ï¼Œç±»å‹çš„è½¬æ¢ã€‚æ¯”å¦‚å½“ä¸€ä¸ªæµ®ç‚¹å‹çš„è¡¨è¾¾å¼èµ‹å€¼ç»™ä¸€ä¸ªæ•´å‹çš„è¡¨è¾¾å¼æ—¶ï¼Œå…¶ä¸­éšå«äº†ä¸€ä¸ªæµ®ç‚¹å‹åˆ°æ•´å‹è½¬æ¢çš„è¿‡ç¨‹ï¼Œè¯­ä¹‰åˆ†æè¿‡ç¨‹ä¸­éœ€è¦å®Œæˆè¿™ä¸ªæ­¥éª¤ã€‚</p><p>ç»è¿‡è¯­ä¹‰åˆ†æé˜¶æ®µä»¥åï¼Œæ•´ä¸ªè¯­æ³•æ ‘çš„è¡¨è¾¾å¼éƒ½è¢«æ ‡è¯†äº†ç±»å‹ï¼Œå¦‚æœæœ‰äº›ç±»å‹éœ€è¦åšéšå¼è½¬æ¢ï¼Œè¯­ä¹‰åˆ†æç¨‹åºä¼šåœ¨è¯­æ³•æ ‘ä¸­æ’å…¥ç›¸åº”çš„è½¬æ¢èŠ‚ç‚¹ã€‚ä¸Šé¢æè¿°çš„è¯­æ³•æ ‘åœ¨ç»è¿‡è¯­ä¹‰åˆ†æé˜¶æ®µä»¥åæˆä¸ºå¦‚å›¾ 2-4 æ‰€ç¤ºçš„å½¢å¼ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/sytex2.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªè¡¨è¾¾å¼ï¼ˆåŒ…æ‹¬ç¬¦å·å’Œæ•°å­—ï¼‰éƒ½è¢«æ ‡è¯†äº†ç±»å‹ã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­å‡ ä¹æ‰€æœ‰çš„è¡¨è¾¾å¼éƒ½æ˜¯æ•´å‹çš„ï¼Œæ‰€ä»¥æ— é¡»åšè½¬æ¢ï¼Œæ•´ä¸ªåˆ†æè¿‡ç¨‹å¾ˆé¡ºåˆ©ã€‚è¯­ä¹‰åˆ†æå™¨è¿˜å¯¹ç¬¦å·è¡¨é‡Œçš„ç¬¦å·ç±»å‹ä¹Ÿåšäº†æ›´æ–°ã€‚</p><h2 id="ä¸­é—´è¯­è¨€ç”Ÿæˆå‰ç«¯">ä¸­é—´è¯­è¨€ç”Ÿæˆï¼ˆå‰ç«¯ï¼‰</h2><p>ç°ä»£çš„ç¼–è¯‘å™¨æœ‰ç€å¾ˆå¤šå±‚æ¬¡çš„ä¼˜åŒ–ï¼Œå¾€å¾€åœ¨æºä»£ç çº§åˆ«ä¼šæœ‰ä¸€ä¸ªä¼˜åŒ–è¿‡ç¨‹ã€‚æºä»£ç çº§ä¼˜åŒ–å™¨ä¼šåœ¨æºä»£ç çº§åˆ«è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ä¸Šä¾‹ä¸­ï¼Œç»†å¿ƒçš„è¯»è€…å¯èƒ½å·±ç»å‘ç°ï¼Œï¼ˆ2+6ï¼‰è¿™ä¸ªè¡¨è¾¾å¼å¯ä»¥è¢«ä¼˜åŒ–æ‰ï¼Œå› ä¸ºå®ƒçš„å€¼åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥è¢«ç¡®å®šã€‚ç»è¿‡ä¼˜åŒ–çš„è¯­æ³•æ ‘å¦‚å›¾ 2-5 æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/sytex3.png"></p><p>æˆ‘ä»¬çœ‹åˆ°ï¼ˆ2+6ï¼‰è¿™ä¸ªè¡¨è¾¾å¼è¢«ä¼˜åŒ–æˆ 8ã€‚å…¶å®ç›´æ¥åœ¨è¯­æ³•æ ‘ä¸Šä½œä¼˜åŒ–æ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥æºä»£ç ä¼˜åŒ–å™¨å¾€å¾€å°†æ•´ä¸ªè¯­æ³•æ ‘è½¬æ¢æˆä¸­é—´ä»£ç ï¼ˆIntermediate Codeï¼‰ï¼Œå®ƒæ˜¯è¯­æ³•æ ‘çš„é¡ºåºè¡¨ç¤ºï¼Œå…¶å®å®ƒå·²ç»éå¸¸æ¥è¿‘ç›®æ ‡ä»£ç äº†ã€‚ ä¸­é—´ä»£ç ä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥è¢«åˆ†ä¸ºå‰ç«¯å’Œåç«¯ï¼Œç¼–è¯‘å™¨å‰ç«¯è´Ÿè´£äº§ç”Ÿæœºå™¨æ— å…³çš„ä¸­é—´ä»£ç ï¼Œç¼–è¯‘å™¨åç«¯å°†ä¸­é—´ä»£ç è½¬æ¢æˆç›®æ ‡æœºå™¨ä»£ç ï¼Œè¿™æ ·å¯ä»¥è·¨å¹³å°ã€‚</p><h2 id="ç›®æ ‡ä»£ç ç”Ÿæˆä¸ä¼˜åŒ–åç«¯">ç›®æ ‡ä»£ç ç”Ÿæˆä¸ä¼˜åŒ–ï¼ˆåç«¯ï¼‰</h2><p>å±äºç¼–è¯‘å™¨åç«¯ï¼Œç¼–è¯‘å™¨åç«¯ä¸»è¦åŒ…æ‹¬ä»£ç ç”Ÿæˆå™¨ï¼ˆCode Generatorï¼‰å’Œç›®æ ‡ä»£ç ä¼˜åŒ–å™¨ï¼ˆTarget Code Optimizerï¼‰ã€‚ä»£ç ç”Ÿæˆå™¨å°†ä¸­é—´ä»£ç è½¬æ¢æˆç›®æ ‡æœºå™¨ä»£ç ï¼Œè¿™ä¸ªè¿‡ç¨‹ååˆ†ä¾èµ–äºç›®æ ‡æœºå™¨ï¼Œå› ä¸ºä¸åŒçš„æœºå™¨æœ‰ç€ä¸åŒçš„å­—é•¿ã€å¯„å­˜å™¨ã€æ•´æ•°æ•°æ®ç±»å‹å’Œæµ®ç‚¹æ•°æ•°æ®ç±»å‹ç­‰ã€‚</p><p>æœ€åç›®æ ‡ä»£ç ä¼˜åŒ–å™¨å¯¹ä¸Šè¿°çš„ç›®æ ‡ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚é€‰æ‹©åˆé€‚çš„å¯»å€æ–¹å¼ã€ä½¿ç”¨ä½ç§»æ¥ä»£æ›¿ä¹˜æ³•è¿ç®—ã€åˆ é™¤å¤šä½™çš„æŒ‡ä»¤ç­‰ã€‚</p><p>ç»è¿‡è¿™äº›æ‰«æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æºä»£ç ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆå’Œç›®æ ‡ä»£ç ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨å¿™æ´»äº†è¿™ä¹ˆå¤šä¸ªæ­¥éª¤ä»¥åï¼Œæºä»£ç ç»ˆäºè¢«ç¼–è¯‘æˆäº†ç›®æ ‡ä»£ç ï¼Œä½†æ˜¯è¿™ä¸ªç›®æ ‡ä»£ç ä¸­æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å˜é‡å’Œå‡½æ•°çš„åœ°å€è¿˜æ²¡æœ‰ç¡®å®šã€‚</p><h1 id="é“¾æ¥å™¨">é“¾æ¥å™¨</h1><p>å‡è®¾æœ‰ä¸€ç§è®¡ç®—æœºï¼Œå®ƒçš„æ¯æ¡æŒ‡ä»¤æ˜¯ 1 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 8 ä½ã€‚æˆ‘ä»¬å‡è®¾æœ‰ä¸€ç§è·³è½¬æŒ‡ä»¤ï¼Œå®ƒçš„é«˜ 4 ä½æ˜¯ 0001ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/sytex4.png"></p><p>ä½ 4 ä½å­˜æ”¾çš„æ˜¯è·³è½¬ç›®çš„åœ°çš„ç»å¯¹åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸Šå›¾ä¸­çœ‹åˆ°ï¼Œè¿™ä¸ªç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤å°±æ˜¯ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œå®ƒçš„ç›®çš„åœ°å€æ˜¯ç¬¬ 5 æ¡æŒ‡ä»¤ï¼ˆæ³¨æ„ï¼Œç¬¬ 5 æ¡æŒ‡ä»¤çš„ç»å¯¹åœ°å€æ˜¯ 4ï¼‰ã€‚</p><p>ç°åœ¨é—®é¢˜æ¥äº†ï¼Œç¨‹åºå¹¶ä¸æ˜¯ä¸€å†™å¥½å°±æ°¸è¿œä¸å˜åŒ–çš„ï¼Œå®ƒå¯èƒ½ä¼šç»å¸¸è¢«ä¿®æ”¹ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ç¬¬ 1 æ¡æŒ‡ä»¤ä¹‹åã€ç¬¬ 5 æ¡æŒ‡ä»¤ä¹‹å‰æ’å…¥äº†ä¸€æ¡æˆ–å¤šæ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆç¬¬ 5 æ¡æŒ‡ä»¤åŠåé¢çš„æŒ‡ä»¤çš„ä½ç½®å°†ä¼šç›¸åº”åœ°å¾€åç§»åŠ¨ï¼ŒåŸå…ˆç¬¬ä¸€æ¡æŒ‡ä»¤çš„ä½ä½çš„æ•°å­—å°†éœ€è¦ç›¸åº”åœ°è°ƒæ•´ã€‚è¿™ç§é‡æ–°è®¡ç®—å„ä¸ªç›®æ ‡çš„åœ°å€è¿‡ç¨‹è¢«å«åšé‡å®šä½ï¼ˆRelocationï¼‰ã€‚</p><p>å…ˆé©±è€…å‘æ˜äº†æ±‡ç¼–è¯­è¨€ï¼Œè¿™ç›¸æ¯”æœºå™¨è¯­è¨€æ¥è¯´æ˜¯ä¸ªå¾ˆå¤§çš„è¿›æ­¥ã€‚æ±‡ç¼–è¯­è¨€å¯ä»¥ä½¿ç”¨ç¬¦å·æ¥æ ‡è®°ä½ç½®ï¼Œæ¯”å¦‚ä¸€ä¸ªç¬¦å·â€œdivideâ€è¡¨ç¤ºä¸€ä¸ªé™¤æ³•å­ç¨‹åºçš„èµ·å§‹åœ°å€ï¼Œæ¯”è®°ä½ä»æŸä¸ªä½ç½®å¼€å§‹çš„ç¬¬å‡ æ¡æŒ‡ä»¤æ˜¯é™¤æ³•å­ç¨‹åºæ–¹ä¾¿å¾—å¤šã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ç§ç¬¦å·çš„æ–¹æ³•ä½¿å¾—äººä»¬ä»å…·ä½“çš„æŒ‡ä»¤åœ°å€ä¸­é€æ­¥è§£æ”¾å‡ºæ¥ã€‚æ¯”å¦‚å‰é¢çº¸å¸¦ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æŠŠåˆšå¼€å§‹ç¬¬ 5 æ¡æŒ‡ä»¤å¼€å§‹çš„å­ç¨‹åºå‘½åä¸ºâ€œfooâ€ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ±‡ç¼–å°±æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmp foo</span><br></pre></td></tr></tbody></table></figure><p>ç¬¦å·ï¼ˆSymbolï¼‰è¿™ä¸ªæ¦‚å¿µéšç€æ±‡ç¼–è¯­è¨€çš„æ™®åŠè¿…é€Ÿè¢«ä½¿ç”¨ï¼Œå®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å¯èƒ½æ˜¯ä¸€æ®µå­ç¨‹åºçš„èµ·å§‹åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå˜é‡çš„èµ·å§‹åœ°å€ã€‚</p><p>åœ¨ä¸€ä¸ªç¨‹åºè¢«åˆ†å‰²æˆå¤šä¸ªæ¨¡å—ä»¥åï¼Œè¿™äº›æ¨¡å—ä¹‹é—´æœ€åå¦‚ä½•ç»„åˆå½¢æˆä¸€ä¸ªå•ä¸€çš„ç¨‹åºæ˜¯é¡»è§£å†³çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯æ¨¡å—é—´ç¬¦å·çš„å¼•ç”¨ã€‚è¿™ä¸ªæ¨¡å—çš„æ‹¼æ¥è¿‡ç¨‹å°±æ˜¯é“¾æ¥ï¼ˆLinkingï¼‰ã€‚</p><h1 id="é™æ€é“¾æ¥">é™æ€é“¾æ¥</h1><p>é“¾æ¥çš„ä¸»è¦å†…å®¹å°±æ˜¯æŠŠå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†éƒ½å¤„ç†å¥½ï¼Œä½¿å¾—å„ä¸ªæ¨¡å—ä¹‹é—´èƒ½å¤Ÿæ­£ç¡®åœ°è¡”æ¥ã€‚é“¾æ¥å™¨æ‰€è¦åšçš„å·¥ä½œå…¶å®è·Ÿå‰é¢æ‰€æè¿°çš„â€œç¨‹åºå‘˜äººå·¥è°ƒæ•´åœ°å€â€æœ¬è´¨ä¸Šæ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œé“¾æ¥è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬äº†åœ°å€å’Œç©ºé—´åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰ã€ç¬¦å·å†³è®®ï¼ˆSymbol Resolutionï¼‰å’Œé‡å®šä½ï¼ˆRelocationï¼‰ç­‰è¿™äº›æ­¥éª¤ã€‚</p><p>ä½¿ç”¨é“¾æ¥å™¨ï¼Œä½ å¯ä»¥ç›´æ¥å¼•ç”¨å…¶ä»–æ¨¡å—çš„å‡½æ•°å’Œå…¨å±€å˜é‡è€Œæ— é¡»çŸ¥é“å®ƒä»¬çš„åœ°å€ï¼Œå› ä¸ºé“¾æ¥å™¨åœ¨é“¾æ¥çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ä½ æ‰€å¼•ç”¨çš„ç¬¦å· fooï¼Œè‡ªåŠ¨å»ç›¸åº”çš„ func.c æ¨¡å—æŸ¥æ‰¾ foo çš„åœ°å€ï¼Œç„¶åå°† main.c æ¨¡å—ä¸­æ‰€æœ‰å¼•ç”¨åˆ° foo çš„æŒ‡ä»¤é‡æ–°ä¿®æ­£ï¼Œè®©å®ƒä»¬çš„ç›®æ ‡åœ°å€ä¸ºçœŸæ­£çš„ foo å‡½æ•°çš„åœ°å€ã€‚è¿™å°±æ˜¯é™æ€é“¾æ¥çš„æœ€åŸºæœ¬çš„è¿‡ç¨‹å’Œä½œç”¨ã€‚</p><p>è®©æˆ‘ä»¬ç»“åˆå…·ä½“çš„ CPU æŒ‡ä»¤æ¥äº†è§£è¿™ä¸ªè¿‡ç¨‹ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸ªå…¨å±€å˜é‡å«åš varï¼Œå®ƒåœ¨ç›®æ ‡æ–‡ä»¶ A é‡Œé¢ã€‚æˆ‘ä»¬åœ¨ç›®æ ‡æ–‡ä»¶ B é‡Œé¢è¦è®¿é—®è¿™ä¸ªå…¨å±€å˜é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ç›®æ ‡æ–‡ä»¶é‡Œé¢æœ‰è¿™ä¹ˆä¸€æ¡æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl %Ox2a,var</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ¡æŒ‡ä»¤å°±æ˜¯ç»™è¿™ä¸ª var å˜é‡èµ‹å€¼ 0x2aï¼Œç›¸å½“äº C è¯­è¨€é‡Œé¢çš„è¯­å¥ var=42ã€‚ç„¶åæˆ‘ä»¬ç¼–è¯‘ç›®æ ‡æ–‡ä»¶ Bï¼Œå¾—åˆ°è¿™æ¡æŒ‡ä»¤æœºå™¨ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Principle/sytex7.png"></p><p>ç”±äºåœ¨ç¼–è¯‘ç›®æ ‡æ–‡ä»¶ B çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“å˜é‡ var çš„ç›®æ ‡åœ°å€ï¼Œå°†è¿™æ¡ mov æŒ‡ä»¤çš„ç›®æ ‡åœ°å€ç½®ä¸º Oï¼Œç­‰å¾…é“¾æ¥å™¨åœ¨å°†ç›®æ ‡æ–‡ä»¶ A å’Œ B é“¾æ¥èµ·æ¥çš„æ—¶å€™å†å°†å…¶ä¿®æ­£ã€‚æˆ‘ä»¬å‡è®¾ A å’Œ B é“¾æ¥åï¼Œå˜é‡ var çš„åœ°å€ç¡®å®šä¸‹æ¥ä¸º 0x1000ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°†ä¼šæŠŠè¿™ä¸ªæŒ‡ä»¤çš„ç›®æ ‡åœ°å€éƒ¨åˆ†ä¿®æ”¹æˆ 0x10000ã€‚è¿™ä¸ªåœ°å€ä¿®æ­£çš„è¿‡ç¨‹ä¹Ÿè¢«å«åšé‡å®šä½ï¼ˆRelocationï¼‰ï¼Œæ¯ä¸ªè¦è¢«ä¿®æ­£çš„åœ°æ–¹å«ä¸€ä¸ªé‡å®šä½å…¥å£ï¼ˆRelocation Entryï¼‰ã€‚é‡å®šä½æ‰€åšçš„å°±æ˜¯ç»™ç¨‹åºä¸­æ¯ä¸ªè¿™æ ·çš„ç»å¯¹åœ°å€å¼•ç”¨çš„ä½ç½®â€œæ‰“è¡¥ä¸â€ï¼Œä½¿å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„åœ°å€ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Links Libraries </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºåä½œç”¨è½®çš„ 3D å€’ç«‹æ‘†çš„éçº¿æ€§åˆ†æä¸æ§åˆ¶</title>
      <link href="/2021/Science/NonlinearAnalysisAndControlOf3DInvertedPendulumBasedOnCounterwheelAction/"/>
      <url>/2021/Science/NonlinearAnalysisAndControlOf3DInvertedPendulumBasedOnCounterwheelAction/</url>
      
        <content type="html"><![CDATA[<h1 id="æ‘˜è¦">æ‘˜è¦</h1><p>æœ¬æ–‡ä»‹ç»äº†åŸºäºåä½œç”¨è½®çš„ 3D å€’ç«‹æ‘† Cubli çš„éçº¿æ€§åˆ†æå’Œæ§åˆ¶è®¾è®¡ã€‚ ä½¿ç”¨å¹¿ä¹‰åŠ¨é‡çš„æ¦‚å¿µï¼Œå°†åŸºäºåä½œç”¨è½®çš„ 3D å€’ç«‹æ‘†çš„å…³é”®ç‰¹æ€§ä¸ 1D æƒ…å†µçš„ç‰¹æ€§è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æå‡ºç›¸å¯¹ç®€å•å’Œç›´è§‚çš„éçº¿æ€§æ§åˆ¶å™¨ã€‚ æœ€åï¼Œåœ¨ Cubli ä¸Šå®ç°äº†æ‰€æå‡ºçš„æ§åˆ¶å™¨ï¼Œå¹¶ç»™å‡ºäº†å®éªŒç»“æœ</p><h1 id="introduction">INTRODUCTION</h1><p>æœ¬æ–‡ä»‹ç»äº†å›¾ 1 æ‰€ç¤º Cubli çš„éçº¿æ€§åˆ†æå’Œæ§åˆ¶ã€‚Cubli æ˜¯ä¸€ä¸ªè¾¹é•¿ä¸º 150 mm çš„ç«‹æ–¹ä½“ï¼Œä¸‰ä¸ªåä½œç”¨è½®ç›¸äº’å‚ç›´å®‰è£…ã€‚ ä¸å…¶ä»– 3D å€’ç«‹æ‘†è¯•éªŒå° [1] å’Œ [2] ç›¸æ¯”ï¼ŒCubli å…·æœ‰ä¸¤ä¸ªç‹¬ç‰¹çš„åŠŸèƒ½ã€‚ ä¸€æ˜¯å…¶å åœ°é¢ç§¯ç›¸å¯¹è¾ƒå°ï¼ˆå› æ­¤å¾—å Cubliï¼Œæºè‡ªç‘å£«å¾·è¯­ä¸­â€œç«‹æ–¹ä½“â€çš„ç¼©ç•¥è¯ï¼‰ã€‚ å¦ä¸€ä¸ªç‰¹ç‚¹æ˜¯å®ƒèƒ½å¤Ÿåœ¨æ²¡æœ‰ä»»ä½•å¤–éƒ¨æ”¯æ’‘çš„æƒ…å†µä¸‹ä»é™æ­¢ä½ç½®è·³èµ·æ¥ï¼Œé€šè¿‡çªç„¶åˆ¶åŠ¨ä»¥é«˜è§’é€Ÿåº¦æ—‹è½¬çš„åä½œç”¨è½®ã€‚ åœ¨ [3] ä¸­ä»‹ç»äº†è·³è·ƒçš„æ¦‚å¿µï¼Œåœ¨ [4] ä¸­ä»‹ç»äº†çº¿æ€§æ§åˆ¶å™¨ï¼Œæœ¬æ–‡é‡ç‚¹åˆ†æéçº¿æ€§æ¨¡å‹å’Œéçº¿æ€§æ§åˆ¶ç­–ç•¥ã€‚</p><p>ä¸ [5] å’Œ [6] ä¸­æå‡ºçš„å·¥ä½œç›¸åï¼Œæœ¬æ–‡ä»çº¯æœºæ¢°çš„è§’åº¦æ¥å¤„ç†æ§åˆ¶å™¨è®¾è®¡ã€‚ Cubli çš„åŸºæœ¬æœºæ¢°ç‰¹æ€§è¢«åˆ©ç”¨æ¥æå‡ºå…·æœ‰ç‰©ç†æ´å¯ŸåŠ›çš„ç®€å•ç›´è§‚çš„æ¨å¯¼ï¼ˆ[5]ï¼š1Dï¼Œåä½œç”¨è½®ï¼Œåé¦ˆçº¿æ€§åŒ–ï¼›[6]ï¼š3Dï¼Œæ£€æµ‹è´¨é‡ï¼Œçº¿æ€§æ§åˆ¶å™¨ï¼Œå±€éƒ¨ç¨³å®šæ€§ï¼‰ã€‚ ç”±æ­¤äº§ç”Ÿçš„å¹³æ»‘ã€æ¸è¿‘ç¨³å®šçš„æ§åˆ¶å¾‹æä¾›äº†åŸºäºå››ä¸ªç›´è§‚å‚æ•°çš„ç›¸å¯¹ç®€å•çš„è°ƒæ•´ç­–ç•¥ï¼Œä»è€Œä½¿æ§åˆ¶å¾‹é€‚ç”¨äºå®é™…å®ç°</p><p>æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†ç»“æ„å¦‚ä¸‹ï¼šç¬¬ II èŠ‚é¦–å…ˆä»‹ç»äº†åä½œç”¨è½®åŸºäºä¸€ç»´å€’ç«‹æ‘†çš„ç®€è¦éçº¿æ€§åˆ†æå’Œæ§åˆ¶ã€‚ æ¥ä¸‹æ¥ï¼Œéçº¿æ€§ç³»ç»ŸåŠ¨åŠ›å­¦æ˜¯ä»ç¬¬ III èŠ‚ä¸­çš„ç¬¬ä¸€åŸç†æ¨å¯¼å‡ºæ¥çš„ï¼Œç„¶ååˆ†åˆ«åœ¨ç¬¬ IV èŠ‚å’Œç¬¬ V èŠ‚ä¸­è¿›è¡Œè¯¦ç»†çš„åˆ†æå’Œæ§åˆ¶è®¾è®¡ã€‚ æœ€åï¼Œå®éªŒç»“æœåœ¨ç¬¬å…­èŠ‚ä¸­ç»™å‡ºï¼Œç»“è®ºåœ¨ç¬¬ä¸ƒèŠ‚ä¸­å¾—å‡ºã€‚</p><h1 id="analysis-and-control-of-a-1d-inverted-pendulum">ANALYSIS AND CONTROL OF A 1D INVERTED PENDULUM</h1><p>æœ¬èŠ‚ä»‹ç»äº†åŸºäº 1D åä½œç”¨è½®å€’ç«‹æ‘†çš„åˆ†æå’Œéçº¿æ€§æ§åˆ¶ç­–ç•¥ã€‚ ç”±äº 1D å’Œ 3D æƒ…å†µä¸‹æŸäº›å…³é”®å±æ€§çš„ç›¸ä¼¼æ€§ï¼Œåˆ†æ 3D å€’ç«‹æ‘†åœ¨åé¢çš„éƒ¨åˆ†ã€‚</p><h2 id="modelling">Modelling</h2><p>è®© $$ å’Œ $$ æè¿°å¦‚å›¾ 2 æ‰€ç¤ºçš„ä¸€ç»´å€’ç«‹æ‘†çš„ä½ç½®ã€‚æ¥ä¸‹æ¥ï¼Œè®© $_w $ è¡¨ç¤ºåä½œç”¨è½®çš„è½¬åŠ¨æƒ¯é‡ï¼Œ<span class="math inline">\(\Phi_o\)</span> è¡¨ç¤ºç³»ç»Ÿå›´ç»•èº«ä½“å›ºå®šåæ ‡ç³»ä¸­æ¢è½´ç‚¹çš„æ€»è½¬åŠ¨æƒ¯é‡ï¼Œä»¥åŠ <span class="math inline">\(m_{tot}\)</span> å’Œ <span class="math inline">\(l\)</span> ä»£è¡¨æ€»è´¨é‡å’Œæ¢è½´ç‚¹åˆ°æ•´ä¸ªç³»ç»Ÿé‡å¿ƒçš„è·ç¦»ã€‚</p><p>ç³»ç»Ÿçš„æ‹‰æ ¼æœ—æ—¥ [7] ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[\iota = \frac{1}{2} \hat{\Theta_o}\dot{\varphi^2} + \frac{1}{2} \Theta_w(\dot{\varphi } + \dot{\psi } )^2 - mg\cos \varphi \tag1\]</span></p><p>å…¶ä¸­ <span class="math inline">\(\hat{\Theta_o} = \Theta_o âˆ’ \Theta_w &gt; 0ï¼Œm = m_{tot}l\)</span>ï¼Œg æ˜¯æ’å®šçš„é‡åŠ›åŠ é€Ÿåº¦ã€‚ å¹¿ä¹‰åŠ¨é‡å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[p_{\varphi } :=\frac{\partial \iota }{\partial {\varphi }' }  = \Theta_o{\varphi }' + \Theta_w\dot{\psi }  \tag2\]</span></p><p><span class="math display">\[p_{\psi } :=\frac{\partial \iota }{\partial {\psi }' }  = \Theta_w({\varphi }' + \dot{\psi })  \tag3\]</span></p><p>è®© T è¡¨ç¤ºç”µæœºæ–½åŠ åˆ°åä½œç”¨è½®ä¸Šçš„æ‰­çŸ©ã€‚ ç°åœ¨ï¼Œå¯ä»¥ä½¿ç”¨æ¬§æ‹‰-æ‹‰æ ¼æœ—æ—¥æ–¹ç¨‹å°†æ‰­çŸ© T ä½œä¸ºéåŠ¿èƒ½æ¨å¯¼å‡ºè¿åŠ¨æ–¹ç¨‹ã€‚ è¿™äº§ç”Ÿï¼š</p><p><span class="math display">\[\dot{p}_{\varphi } = \frac{\partial \iota }{\partial \varphi }  = mg\sin \varphi  \tag4\]</span></p><p><span class="math display">\[\dot{p}_{\psi } = \frac{\partial \iota }{\partial \psi }  +T = T \tag5\]</span></p><p>è¯·æ³¨æ„ï¼Œï¼ˆ2ï¼‰å’Œï¼ˆ3ï¼‰ä¸­å¹¿ä¹‰åŠ¨é‡çš„å¼•å…¥å¯¼è‡´ç³»ç»Ÿçš„ç®€åŒ–è¡¨ç¤ºï¼Œå…¶ä¸­ï¼ˆ4ï¼‰ç±»ä¼¼äºç”±ï¼ˆ5ï¼‰ä¸­çš„ç§¯åˆ†å™¨å¢å¼ºçš„å€’ç«‹æ‘†ã€‚</p><p>ç”±äºåä½œç”¨è½®çš„å®é™…ä½ç½®å¹¶ä¸é‡è¦ï¼Œæˆ‘ä»¬å¼•å…¥ <span class="math inline">\(x := (\varphi; p_{\varphi}; p_{\psi} )\)</span> æ¥è¡¨ç¤ºç®€åŒ–çš„çŠ¶æ€é›†å¹¶æè¿°æœºæ¢°ç³»ç»Ÿçš„åŠ¨åŠ›å­¦å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\dot{x} = \begin{pmatrix}\dot{\varphi }  \\\dot{p}_{\varphi }  \\\dot{p}_{\psi }\end{pmatrix} = f(x,T) = \begin{pmatrix}\hat{\Theta_o}^{-1}(p_{\varphi } - p_{\psi })  \\mg\sin \varphi  \\T\end{pmatrix} \tag6\]</span></p><h2 id="analysis">Analysis</h2><p>ï¼ˆ1ï¼‰çŠ¶æ€ç©ºé—´ï¼šå¯¹äºåç»­åˆ†æï¼ŒçŠ¶æ€ç©ºé—´å®šä¹‰ä¸ºï¼š<span class="math inline">\(\chi = {x | \varphi \in (-\pi, \pi ], p_{\varphi }\in \mathcal{R}, p_{\psi }\in \mathcal{R} }\)</span> ï¼ˆ2ï¼‰å‡è¡¡ï¼šç³»ç»Ÿçš„å‡è¡¡ç”±ä¸‹å¼ç»™å‡ºï¼š<span class="math inline">\(\varepsilon = {(x,T)\in \chi \times \mathcal{R} | f(x,T) = 0 }\)</span> è¯„ä¼°<span class="math inline">\(\dot{p_{\varphi }} = \dot{p_{\psi }} = \dot{\varphi } = 0\)</span>ç»™å‡ºä»¥ä¸‹å¹³è¡¡ï¼š</p><p><span class="math display">\[\varepsilon_1 =  \left \{ {(x,T)\in \chi \times \mathcal{R} | \varphi =0 , p_{\varphi } = p_{\psi }, T = 0} \right \}  \tag7\]</span></p><p><span class="math display">\[\varepsilon_2 =  \left \{ {(x,T)\in \chi \times \mathcal{R} | \varphi =\pi  , p_{\varphi } = p_{\psi }, T = 0} \right \}  \tag8\]</span></p><p>æ¯ä¸ªå‡è¡¡éƒ½æ˜¯ä¸€ä¸ªå°é—­çš„ä¸å˜é‡é›†ï¼Œå…¶å¸¸æ•° $p_{} $å¯èƒ½ä¸ä¸ºé›¶ã€‚ ä»æœºæ¢°ä¸Šè®²ï¼Œè¿™æ„å‘³ç€æ‘†é”¤å¯ä»¥åœ¨ç›´ç«‹ä½ç½®é™æ­¢ï¼Œè€Œå…¶åä½œç”¨è½®ä»¥æ’å®šè§’é€Ÿåº¦æ—‹è½¬ã€‚ è¿›ä¸€æ­¥çš„çº¿æ€§åˆ†æè¡¨æ˜ï¼Œåœ¨æé›…æ™®è¯ºå¤«çš„æ„ä¹‰ä¸Šï¼Œç›´ç«‹å¹³è¡¡ç‚¹ <span class="math inline">\(\varepsilon_1\)</span> æ˜¯ä¸ç¨³å®šçš„ï¼Œè€Œæ‚¬æŒ‚å¹³è¡¡ç‚¹ <span class="math inline">\(\varepsilon_2\)</span> æ˜¯ç¨³å®šçš„</p><h2 id="control-design">Control Design</h2><p>æ§åˆ¶å™¨çš„ç›®æ ‡æ˜¯å°†å€’ç«‹æ‘†é©±åŠ¨åˆ°ç›´ç«‹ä½ç½® $ = 0$ å¹¶ä½¿åä½œç”¨è½®çš„è§’é€Ÿåº¦ <span class="math inline">\(\dot{\psi } = 0\)</span> ä¸ºé›¶ï¼Œå…·ä½“æ¥è¯´ï¼š</p><p><span class="math display">\[\lim_{t \to \infty} x = 0 \tag9\]</span></p><p>ç°åœ¨ï¼Œè€ƒè™‘ä»¥ä¸‹åé¦ˆæ§åˆ¶å¾‹ï¼š</p><p><span class="math display">\[u(\varphi ,p_{\varphi }, p_{\psi }) = k_1 mg \sin \varphi + k_2p_{\varphi } - k_3p_{\psi } \tag{10}\]</span></p><p>å…¶ä¸­ï¼š</p><p><span class="math display">\[k_1 = 1+\alpha \hat{\Theta_0 } + \frac{\beta \gamma }{mg} + \delta   \\k_2 = \frac{\beta }{\hat{\Theta_0 }} \cos \varphi  + \gamma (1 + \alpha \hat{\Theta_0 }) \\k_3 =  \frac{\beta }{\hat{\Theta_0 }} \cos \varphi  + \gamma \\\alpha ,\beta, \gamma ,\delta &gt; 0\]</span></p><p>å®šç† 2.1ï¼šï¼ˆ10ï¼‰ä¸­ç»™å‡ºçš„æ§åˆ¶å¾‹ <span class="math inline">\(T = u(\varphi,p_{\varphi},p_{\psi})\)</span>ä½¿å¾—å¹³è¡¡ç‚¹ <span class="math inline">\(x = 0\)</span>åœ¨åŸŸ$^- = &nbsp;{ = ,p_{= 0,p_{} = 0} } $ ä¸Šç¨³å®šä¸”æ¸è¿‘ç¨³å®š</p><p>è¯æ˜ï¼šè€ƒè™‘ä¸‹é¢çš„æé›…æ™®è¯ºå¤«å€™é€‰å‡½æ•° $V: x $</p><p><span class="math display">\[V(x) = \frac{1}{2} \alpha p^2_{\varphi } + mg(1 - \cos \varphi ) _ \frac{1}{2 \delta \hat{\Theta_0} }z^2  \tag{11}\]</span></p><p>where <span class="math inline">\(z = z(x) = p_{\varphi } (1 + \alpha \hat{\Theta_0} ) + \beta \sin \varphi - p_{\psi }\)</span>å­˜åœ¨ç±»<span class="math inline">\(\kappa_{\propto }^1\)</span>å‡½æ•°$ a(x) :=x^2$ with $&lt; min{  , ,  } $ such that <span class="math inline">\(Vï¼ˆxï¼‰ \ge a(\left \| p_{\varphi }, \varphi, z \right \| )_2 , \forall x\in \chi\)</span> and <span class="math inline">\(V(0) = 0\)</span> è¿™é‡Œ<span class="math inline">\(V(x)\)</span> æ˜¯æ­£å®šå’Œæœ‰æ•ˆçš„æé›…æ™®è¯ºå¤«å€™é€‰ã€‚ ä¸Šè¿°æé›…æ™®è¯ºå¤«å€™é€‰å‡½æ•°æ²¿é—­ç¯è½¨è¿¹çš„æ—¶é—´å¯¼æ•°ä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}\dot{V}(x) &amp;=\frac{m g}{\hat{\Theta}_{0}}(z-\beta \sin \varphi) \sin \varphi+\frac{1}{\delta \hat{\Theta}_{0}} z \dot{z} \\&amp;=-\frac{m g}{\hat{\Theta}_{0}} \beta \sin ^{2} \varphi-\frac{\gamma}{\delta \hat{\Theta}_{0}} z^{2} \leq 0, \quad \forall x \in \mathcal{X} .\end{aligned}\]</span></p><p>ç”±äº$ï¼ˆxï¼‰ 0, x $ æˆ‘ä»¬ä»æé›…æ™®è¯ºå¤«ç¨³å®šæ€§å®šç†å¾—å‡ºç»“è®ºï¼Œç‚¹ <span class="math inline">\(x = 0\)</span> æ˜¯ç¨³å®šçš„ã€‚ ç°åœ¨ï¼Œä¸ºäº†è¯æ˜ <span class="math inline">\(x = 0\)</span> åœ¨ <span class="math inline">\(\chi^âˆ’\)</span> ä¸­çš„æ¸è¿‘ç¨³å®šæ€§ï¼Œè®©æˆ‘ä»¬å®šä¹‰é›†åˆï¼š</p><p><span class="math display">\[\mathcal{R}=\left\{x \in \mathcal{X}^{-} \mid \dot{V}(x)=0\right\}\]</span></p><p>è€ƒè™‘ <span class="math inline">\(\mathcal{R}\)</span> çš„ä¸å˜é›†å†…çš„è½¨è¿¹ <span class="math inline">\(x(t)\)</span>ã€‚æ˜¾ç„¶ï¼Œå®ƒä»¬å¿…é¡»æ»¡è¶³ $ = 0, z = 0$ å’Œç³»ç»ŸåŠ¨åŠ›å­¦ (6)ã€‚ è¿™æ„å‘³ç€ <span class="math inline">\(x(t) â‰¡ 0\)</span>ï¼Œå› æ­¤ <span class="math inline">\(\mathcal{R}\)</span> ä¸­æœ€å¤§çš„ä¸å˜é‡é›†æ˜¯ <span class="math inline">\(x = 0\)</span>ã€‚ ç°åœ¨ï¼Œæ ¹æ® Krasovskii-LaSalle åŸç† [9](å®šç† 4.4ï¼‰ï¼Œå¯¹äºä»»ä½•è½¨è¿¹ <span class="math inline">\(x(t)\)</span>ï¼Œ</p><p><span class="math display">\[\lim _{t \rightarrow \infty} x(t)=0, \quad x(0) \in \mathcal{X}^{-}\]</span></p><p>æœ‰å…³åŸºäºä¸€ç»´åä½œç”¨è½®çš„å€’ç«‹æ‘†çš„ç±»ä¼¼æ§åˆ¶è®¾è®¡å’Œç¨³å®šæ€§è¯æ˜ï¼Œè¯·å‚è§ [10]ã€‚</p><h2 id="remarks">Remarks</h2><p>ï¼ˆ1ï¼‰ã€Lyapunov å‡½æ•° (11) çš„è§£é‡Šï¼šLyapunov å‡½æ•° (11) å¯ä»¥é€šè¿‡æ ‡å‡†çš„åæ¨æ–¹æ³• [9]ã€[10] æ‰¾åˆ°ã€‚ å¦‚æœå¿½ç•¥åä½œç”¨è½®åŠ¨åŠ›å­¦å¹¶ä¸”å‡è®¾ p æ˜¯æ§åˆ¶è¾“å…¥ï¼Œåˆ™å‡½æ•°<span class="math inline">\(\tilde{V}\left(\varphi, p_{\varphi}\right)=\frac{1}{2} \alpha p_{\varphi}^{2}+m g(1-\cos \varphi)\)</span> æ˜¯æœ‰æ•ˆçš„æé›…æ™®è¯ºå¤«å‡½æ•°å€™é€‰ã€‚ æ²¿è½¨è¿¹è¦æ±‚<span class="math inline">\(\dot{\tilde{V} } \le 0\)</span>å°†æ„å‘³ç€<span class="math inline">\(p_{\psi}=p_{\varphi}\left(1+\alpha \hat{\Theta}_{0}\right)+\beta \sin \varphi\)</span>ï¼Œå³ <span class="math inline">\(z = 0\)</span>ã€‚è¿™å¯¼è‡´è§£é‡Š z æƒ©ç½šä¸æ§åˆ¶å¾‹çš„åå·®ï¼Œè¯¥åå·®å°†åº”ç”¨äº å¿½ç•¥è½¦è½®åŠ¨åŠ›å­¦æ—¶çš„ç³»ç»Ÿã€‚ å› æ­¤ï¼Œé™ä½è°ƒæ•´å‚æ•° Î´ ä¼šå¯¼è‡´æ›´ç§¯æçš„æ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨å°†å€¾æ–œç½®äºè½¦è½®é€Ÿåº¦ä¹‹ä¸Šã€‚ ï¼ˆ2ï¼‰ã€æ§åˆ¶å™¨ (10) çš„æ‰©å±•ï¼šLyapunov å‡½æ•° (11) å¯ä»¥é€šè¿‡é¢å¤–çš„ç§¯åˆ†å™¨çŠ¶æ€è¿›è¡Œæ‰©å……ï¼š</p><p><span class="math display">\[\hat{V}(x)=V(x)+\frac{\nu}{2 \delta \hat{\Theta}_{0}} z_{i n t}^{2}\]</span> where <span class="math inline">\(z_{i n t}(t)=z_{0}+\int_{0}^{t} z(\tau) d \tau\)</span> å› æ­¤ï¼Œæ§åˆ¶å™¨ (10) å¿…é¡»æ‰©å±• <span class="math inline">\(z_{i n t}, \hat{u}=u+\nu z_{i n t}\)</span> ä»¥æä¾›ç›´ç«‹å¹³è¡¡çš„ç¨³å®šæ€§ã€‚ è¿™å¯¹äºå®é™…å®æ–½ä¹Ÿå¯èƒ½å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒè€ƒè™‘äº†å»ºæ¨¡é”™è¯¯ã€‚</p><p>æ§åˆ¶å¾‹ï¼ˆ10ï¼‰çš„è§£é‡Šï¼šï¼ˆ10ï¼‰ä¸­ç»™å‡ºçš„æ§åˆ¶å¾‹å¯ä»¥æ”¹å†™ä¸º :</p><p><span class="math display">\[u=\frac{\beta}{m g} \ddot{p}_{\varphi}+k_{1} \dot{p}_{\varphi}+\gamma\left(1+\alpha \hat{\Theta}_{0}\right) p_{\varphi}-\gamma p_{\psi}\]</span></p><p>where ï¼š</p><p><span class="math display">\[p_{\psi}=u_{0}+\int_{0}^{t} u(\tau) d \tau\]</span></p><p>è¿™åªä¸è¿‡æ˜¯ç”±æ¯”ä¾‹ã€ï¼ˆåŒï¼‰å¾®åˆ†å’Œç§¯åˆ†éƒ¨åˆ†ç»„æˆçš„çº¿æ€§æ§åˆ¶å™¨ã€‚ æ­¤å¤– $$å¯ä»¥è§£é‡Šä¸ºç§¯åˆ†å™¨æƒé‡ã€‚</p><h2 id="system-dynamics-of-the-reaction-wheel-based-3d-inverted-pendulum">SYSTEM DYNAMICS OF THE REACTION WHEEL-BASED 3D INVERTED PENDULUM</h2><p>è®© <span class="math inline">\(\Theta_0\)</span> è¡¨ç¤ºæ•´ä¸ª Cubli å›´ç»•æ¢è½´ç‚¹ O çš„æ€»è½¬åŠ¨æƒ¯é‡ï¼ˆè§å›¾ 3ï¼‰ï¼Œ<span class="math inline">\(\Theta_{wi};i = 1, 2, 3\)</span> è¡¨ç¤ºæ¯ä¸ªåä½œç”¨è½®çš„è½¬åŠ¨æƒ¯é‡ï¼ˆåœ¨ç›¸åº”æ—‹è½¬è½´çš„æ–¹å‘ä¸Šï¼‰å¹¶å®šä¹‰ <span class="math inline">\(\Theta_w := diag(\Theta_{w1}, \Theta_{w2}, \Theta_{w3}), \Theta^0 := \Theta_0 - \Theta_w\)</span>ã€‚æ¥ä¸‹æ¥ï¼Œè®©$ $ è¡¨ç¤ºä»æ¢è½´ç‚¹åˆ°é‡å¿ƒçš„ä½ç½®å‘é‡ä¹˜ä»¥æ€»è´¨é‡ï¼Œ$ $ è¡¨ç¤ºé‡åŠ›å‘é‡ã€‚å¼ é‡åœ¨ç‰¹å®šåæ ‡ç³»ä¸Šçš„æŠ•å½±ç”±å‰é¢çš„ä¸Šæ ‡è¡¨ç¤ºï¼Œå³<span class="math inline">\(B \Theta_{0} \in \mathbb{R}^{3 \times 3}, \quad B(\vec{m})=B m \in \mathbb{R}^{3}\)</span>ã€‚ç®­å¤´ç¬¦å·ç”¨äºå¼ºè°ƒå‘é‡ï¼ˆå’Œå¼ é‡ï¼‰åº”è¯¥å…ˆéªŒåœ°è¢«è®¤ä¸ºæ˜¯èµ‹èŒƒå‘é‡ç©ºé—´ä¸­çš„çº¿æ€§å¯¹è±¡ï¼Œä¸å…¶ç›¸å¯¹äºç‰¹å®šåæ ‡ç³»çš„åæ ‡è¡¨ç¤ºåˆ†ç¦»ã€‚ç”±äºèº«ä½“å›ºå®šåæ ‡ç³» ${ B } $ æ˜¯æœ€å¸¸ç”¨çš„æŠ•å½±åæ ‡ç³»ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬é€šå¸¸å°†å…¶å‰é¢çš„ä¸Šæ ‡å»æ‰ã€‚è¿›ä¸€æ­¥æ³¨æ„ï¼Œ<span class="math inline">\({ }^{B} \hat{\Theta}_{0}=\hat{\Theta}_{0} \in \mathbb{R}^{3 \times 3}\)</span>æ˜¯æ­£å®šçš„ã€‚</p><p>ç³»ç»Ÿçš„æ‹‰æ ¼æœ—æ—¥ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[\begin{gathered}\mathcal{L}\left(\omega_{h}, g, \omega_{w}, \phi\right)=\frac{1}{2} \omega_{h}{ }^{\mathrm{T}} \hat{\Theta}_{0} \omega_{h}+\frac{1}{2}\left(\omega_{h}+\omega_{w}\right)^{\mathrm{T}} \\\Theta_{w}\left(\omega_{h}+\omega_{w}\right)+m^{\mathrm{T}} g\end{gathered} \tag{12}\]</span></p><p>å…¶ä¸­<span class="math inline">\(B\left(\vec{\omega}_{h}\right)=\omega_{h} \in \mathbb{R}^{3}\)</span> è¡¨ç¤ºä¸»ä½“è§’é€Ÿåº¦<span class="math inline">\({ }^{B}\left(\vec{\omega}_{w}\right)=\omega_{w} \in \mathbb{R}^{3}\)</span>è¡¨ç¤ºåä½œç”¨è½®è§’é€Ÿåº¦ã€‚ <span class="math inline">\(T \in \mathbb{R}^{3}\)</span> çš„ç»„ä»¶åŒ…å«æ–½åŠ åˆ°åä½œç”¨è½®ä¸Šçš„æ‰­çŸ©ã€‚ åœ¨èº«ä½“å›ºå®šåæ ‡ç³»ä¸­ï¼Œå‘é‡ m æ˜¯å¸¸æ•°ï¼Œè€Œ g çš„æ—¶é—´å¯¼æ•°ç”± <span class="math inline">\({ }^{B}(\dot{\vec{g}})=0=\dot{g}+\omega_{h} \times g=\dot{g}+\tilde{\omega}_{h} g\)</span> ç»™å‡ºã€‚ åº”ç”¨äºå‘é‡ <span class="math inline">\(v \in \mathbb{R}^{3}\)</span> çš„æ³¢æµªå·è¿ç®—ç¬¦ï¼Œå³ <span class="math inline">\(\tilde{v}\)</span>è¡¨ç¤º<span class="math inline">\(\tilde{v} a=v \times a \text { holds } \forall a \in \mathbb{R}^{3} \text {. }\)</span> çš„åæ–œå¯¹ç§°çŸ©é˜µã€‚ ä»‹ç»å¹¿ä¹‰åŠ¨é‡ã€‚</p><p><span class="math display">\[\begin{aligned}p_{\omega_{h}}= \frac{\partial \mathcal{L}^{\mathrm{T}}}{\partial \omega_{h}}=\Theta_{0} \omega_{h}+\Theta_{w} \omega_{w}, \tag{13}\end{aligned}\]</span> p_{<em>{w}}= ^{}=</em>{w}(<em>{h}+</em>{w})  $$</p><p>å¯¼è‡´è¿åŠ¨æ–¹ç¨‹ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[\begin{aligned}\dot{g} &amp;=-\tilde{\omega}_{h} g, \tag{15}\end{aligned}\]</span></p><p><span class="math display">\[\dot{p}_{\omega_{h}} =-\tilde{\omega}_{h} p_{\omega_{h}}+\tilde{m} g, \tag{16}\]</span></p><p><span class="math display">\[\dot{p}_{\omega_{w}} =T . \tag{17}\]</span></p><p>è¯·æ³¨æ„ï¼Œæœ‰å¤šç§æ¨å¯¼è¿åŠ¨æ–¹ç¨‹çš„æ–¹æ³•ï¼› ä¾‹å¦‚ï¼Œåœ¨ [4] ä¸­ä½¿ç”¨äº†è™šæ‹ŸåŠŸç‡çš„æ¦‚å¿µã€‚ é™„å½• 2 æ˜¾ç¤ºäº†ä½¿ç”¨æ‹‰æ ¼æœ—æ—¥å½¢å¼ä¸»ä¹‰çš„æ¨å¯¼ï¼Œå¹¶å¼ºè°ƒäº† 1D å’Œ 3D æƒ…å†µä¹‹é—´çš„ç›¸ä¼¼ä¹‹å¤„ã€‚ æ‹‰æ ¼æœ—æ—¥å½¢å¼ä¸»ä¹‰ä¹Ÿæ¿€å‘äº†å¹¿ä¹‰åŠ¨é‡çš„å¼•å…¥ã€‚</p><p>ç°åœ¨ï¼Œä½¿ç”¨<span class="math inline">\(\dot{\vec{v}}=\dot{v}+\omega_{h} \times v\)</span>ï¼Œæ—‹è½¬åæ ‡ç³»ä¸­å‘é‡çš„æ—¶é—´å¯¼æ•°ï¼Œï¼ˆ15ï¼‰-ï¼ˆ17ï¼‰å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}\dot{\vec{g}} =0, \tag{18}\end{aligned}\]</span></p><p><span class="math display">\[\dot{\vec{p}}_{\omega_{h}} =\vec{m} \times \vec{g}, \tag{19}\]</span></p><p><span class="math display">\[\dot{p}_{\omega_{w}} =T . \tag{20}\]</span></p><p>è¿™ç‰¹åˆ«çªå‡ºäº† 1D å’Œ 3D å€’ç«‹æ‘†ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚ ç”±äºå‘é‡çš„èŒƒæ•°ä¸å…¶åœ¨åæ ‡ç³»ä¸­çš„è¡¨ç¤ºæ— å…³ï¼Œå› æ­¤è„‰å†²å˜åŒ–çš„ 2 èŒƒæ•°ç”±<span class="math inline">\(\left\|\dot{\vec{p}}_{\omega_{h}}\right\|_{2}= \|\vec{m}\|_{2}\|\vec{g}\|_{2} \sin \phi\)</span>ç»™å‡ºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<span class="math inline">\(\phi\)</span> è¡¨ç¤ºå‘é‡ <span class="math inline">\(\vec{m}\)</span> å’Œ <span class="math inline">\(\vec{g}\)</span> ä¹‹é—´çš„è§’åº¦ã€‚ æ­¤å¤–ï¼Œåœ¨ 1D æƒ…å†µä¸‹ï¼Œ<span class="math inline">\(p_{w_w}\)</span> æ˜¯æ‰€æ–½åŠ æ‰­çŸ© T çš„ç§¯åˆ†ã€‚</p><h1 id="analysis-1">ANALYSIS</h1><h2 id="conservation-of-angular-momentum">Conservation of Angular Momentum</h2><p>ä»ï¼ˆ19ï¼‰å¯ä»¥çœ‹å‡º$ $ çš„å˜åŒ–ç‡æ€»æ˜¯ä¸<span class="math inline">\(\vec{m}\)</span> å’Œ<span class="math inline">\(\vec{g}\)</span> æ­£äº¤ã€‚ ç”±äº<span class="math inline">\(\vec{g}\)</span> æ˜¯å¸¸æ•°ï¼Œ$ $ åœ¨æ•´ä¸ªè½¨è¿¹ä¸­æ°¸è¿œä¸ä¼šæ”¹å˜å®ƒåœ¨<span class="math inline">\(\vec{g}\)</span>æ–¹å‘ä¸Šçš„åˆ†é‡ã€‚ ç”¨ Cubli çš„èº«ä½“å›ºå®šåæ ‡ç³»è¡¨ç¤ºï¼Œå¯ä»¥å†™æˆ<span class="math inline">\(\frac{d}{d t}\left(p_{\omega_{h}}^{\mathrm{T}} g\right) \equiv 0\)</span> è¿™ä¸è¿‡æ˜¯ç»•è½´è§’åŠ¨é‡å®ˆæ’~</p><h2 id="state-space">State Space</h2><p>ç”±äºåç»­çš„åˆ†æå’Œæ§åˆ¶å°†åœ¨å›ºå®šä½“åæ ‡ç³»ä¸­è¿›è¡Œï¼ŒçŠ¶æ€ç©ºé—´å®šä¹‰ä¸ºé›†åˆ $={x=(g, p_{<em>{h}}, p</em>{<em>{w}}) ^{9} |g|</em>{2}= 9.81} <span class="math inline">\(ã€‚ æ³¨æ„\)</span><em>{h}=</em>{0}^{-1}(p_{<em>{h}}-p</em>{_{w}})$ã€‚</p><h2 id="equilibria">Equilibria</h2><p>è¯¥ç¨‹åºä¸ç¬¬ II-B.2 å°èŠ‚ä¸­ä»‹ç»çš„ç¨‹åºç›¸åŒã€‚ ä» (19) ä¸­å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰å½“<span class="math inline">\(m \| g \text {, i.e., } g=\pm \frac{m}{\|m\|_{2}}\|g\|_{2}\)</span> æ—¶ï¼Œæ‰æ»¡è¶³æ¡ä»¶ <span class="math inline">\(\dot{\vec{p}}_{\omega_{h}}=0\)</span>ã€‚ ä» (20) å¾—å‡º <span class="math inline">\(p_{w_w} = const, T = 0\)</span>ã€‚ä½¿ç”¨ (15) å’Œ (16) å¯¼è‡´ <span class="math inline">\(\omega_{h}=\hat{\Theta}_{0}^{-1}\left(p_{\omega_{h}}-p_{\omega_{w}}\right) \| g \text { and } p_{\omega_{h}} \| g\)</span>ï¼Œ è¿™æ­£å¥½å¯¹åº”äº<span class="math inline">\(p_{w_h}\)</span> çš„å®ˆæ’éƒ¨åˆ†ã€‚ å°†æ‰€æœ‰å†…å®¹ç»“åˆåœ¨ä¸€èµ·ä¼šå¯¼è‡´ä»¥ä¸‹å¹³è¡¡ï¼š</p><p><span class="math display">\[\begin{gathered}\mathcal{E}_{1}=\left\{(x, T) \in \mathcal{X} \times \mathbb{R}^{3} \mid g^{\mathrm{T}} m=-\|g\|_{2}\|m\|_{2},\right. \\\left.p_{\omega_{h}}\left\|m, \hat{\Theta}_{0}^{-1}\left(p_{\omega_{h}}-p_{\omega_{w}}\right)\right\| m, T=0\right\}, \\\mathcal{E}_{2}=\left\{(x, T) \in \mathcal{X} \times \mathbb{R}^{3} \mid g^{\mathrm{T}} m=\|g\|_{2}\|m\|_{2},\right. \\\left.p_{\omega_{h}}\left\|m, \hat{\Theta}_{0}^{-1}\left(p_{\omega_{h}}-p_{\omega_{w}}\right)\right\| m, T=0\right\} .\end{gathered}\]</span></p><p>çº¿æ€§åŒ–è¡¨æ˜ï¼Œåœ¨æé›…æ™®è¯ºå¤«çš„æ„ä¹‰ä¸Šï¼Œç›´ç«‹å¹³è¡¡ç‚¹ E1 æ˜¯ä¸ç¨³å®šçš„ï¼Œè€Œæ‚¬æŒ‚å¹³è¡¡ç‚¹ E2 æ˜¯ç¨³å®šçš„ã€‚</p><h1 id="nonlinear-control-of-the-reaction-wheel-based-3d-inverted-pendulum">NONLINEAR CONTROL OF THE REACTION WHEEL-BASED 3D INVERTED PENDULUM</h1><p>è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰æ§åˆ¶ç›®æ ‡ã€‚ ç”±äºè§’åŠ¨é‡$ $ åœ¨<span class="math inline">\(\vec{g}\)</span> çš„æ–¹å‘ä¸Šæ˜¯å®ˆæ’çš„ï¼Œæ§åˆ¶å™¨åªèƒ½å°†$ $ çš„ä¸<span class="math inline">\(\vec{g}\)</span> æ­£äº¤çš„åˆ†é‡å½’é›¶ã€‚ å› æ­¤ï¼Œå°†å‘é‡ $ $ åˆ†æˆä¸¤éƒ¨åˆ†æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼šä¸€ä¸ªåœ¨ <span class="math inline">\(\vec{g}\)</span> çš„æ–¹å‘ä¸Šï¼Œå¦ä¸€ä¸ªä¸å®ƒæ­£äº¤ï¼Œå³ï¼š <span class="math display">\[\vec{p}_{\omega_{h}}=\vec{p}_{\omega_{h}}^{\perp}+\vec{p}_{\omega_{h}}^{g} \quad \text { and } \quad \vec{p}_{\omega_{h}}^{g}=\left(\vec{p}_{\omega_{h}}^{\mathrm{T}} \vec{g}\right) \frac{\vec{g}}{\|\vec{g}\|_{2}^{2}} .\]</span></p><p>ä» (19) å’Œè§’åŠ¨é‡å®ˆæ’ï¼Œå¯ä»¥ç›´æ¥å¾—å‡ºï¼š</p><p><span class="math display">\[B\left(\dot{\vec{p}}_{\omega_{h}}^{\perp}\right)=\dot{p}_{\omega_{h}}^{\perp}+\tilde{\omega}_{h} p_{\omega_{h}}^{\perp}=\tilde{m} g \tag{21}\]</span></p><p>æ§åˆ¶ç›®æ ‡çš„å¦ä¸€ä¸ªåˆç†è¡¥å……æ˜¯ Cubli çš„è§’é€Ÿåº¦ !h æ¸è¿‘æ”¶æ•›åˆ°é›¶ã€‚ å› æ­¤ï¼Œæ§åˆ¶ç›®æ ‡å¯ä»¥è¡¨è¿°ä¸ºå°†ç³»ç»Ÿæ¨å‘é—­ä¸å˜é‡ï¼š</p><p><span class="math display">\[\begin{aligned}&amp; \mathcal{T}=\left\{x \in \mathcal{X} \mid g^{\mathrm{T}} m=-\|g\|_{2}\|m\|_{2}, \omega_{h}=\hat{\Theta}_{0}^{-1}\left(p_{\omega_{h}}-\right.\right. \left.\left.p_{\omega_{w}}\right)=0, p_{\omega_{h}}^{\perp}=0\right\}\end{aligned}\]</span></p><p>ä¸ºäº†è¯æ˜æ¸è¿‘ç¨³å®šæ€§ï¼Œå¿…é¡»æ’é™¤æ‚¬æŒ‚å¹³è¡¡ï¼ˆç¨åå°†å˜å¾—æ¸…æ¥šï¼‰ã€‚ è¿™å¯ä»¥é€šè¿‡å¼•å…¥é›†åˆ $^âˆ’ = $æ¥å®Œæˆï¼Œå…¶ä¸­ <span class="math inline">\(x^âˆ’\)</span> è¡¨ç¤ºæ‚¬å‚å¹³è¡¡ <span class="math inline">\(w_h = 0\)</span>ï¼š</p><p><span class="math display">\[x^{-}=\left\{x \in X \mid g=\frac{\|g\|_{2}}{\|m\|_{2}} m, p_{\omega_{h}}^{\perp}=0, p_{\omega_{h}}=p_{\omega_{w}}\right\}\]</span></p><p>æ¥ä¸‹æ¥ï¼Œè€ƒè™‘æ§åˆ¶å™¨ï¼š</p><p><span class="math display">\[u=K_{1} \tilde{m} g+K_{2} \omega_{h}+K_{3} p_{\omega_{h}}-K_{4} p_{\omega_{w}} \tag{22}\]</span></p><p>whereï¼š</p><p><span class="math display">\[\begin{aligned}&amp;K_{1}=(1+\beta \gamma+\delta) I+\alpha \hat{\Theta}_{0} \\&amp;K_{2}=\alpha \hat{\Theta}_{0} \tilde{p}_{\omega_{h}}^{\perp}+\beta \tilde{m} \tilde{g}+\tilde{p}_{\omega_{h}} \\&amp;K_{3}=\gamma\left(I+\alpha \hat{\Theta}_{0}\left(I-\frac{g g^{\mathrm{T}}}{\|g\|_{2}^{2}}\right)\right) \\&amp;K_{4}=\gamma I, \quad \alpha, \beta, \gamma, \delta&gt;0\end{aligned}\]</span></p><p>and <span class="math inline">\(I \in \mathbb{R}^{3 \times 3}\)</span> is the identity matrix</p><p>å®šç† 5.1ï¼šï¼ˆ22ï¼‰ä¸­ç»™å‡ºçš„æ§åˆ¶å™¨ä½¿ç”±ï¼ˆ18ï¼‰-ï¼ˆ20ï¼‰å®šä¹‰çš„ç³»ç»Ÿçš„é—­ä¸å˜é›† $$åœ¨ $x ^- $ ä¸Šç¨³å®šå’Œæ¸è¿‘ç¨³å®šã€‚</p><p>è¯æ˜ï¼šè€ƒè™‘ä»¥ä¸‹æé›…æ™®è¯ºå¤«å€™é€‰å‡½æ•°$x  $ï¼š</p><p><span class="math display">\[V(x)=\frac{1}{2} \alpha p_{\omega_{h}}^{\perp}{^{\mathrm{T}}} p_{\omega_{h}}^{\perp}+m^{\mathrm{T}} g+\|m\|_{2}\|g\|_{2}+\frac{1}{2 \delta} z^{\mathrm{T}} \hat{\Theta}_{0}^{-1} z \tag{23}\]</span></p><p>withï¼š</p><p><span class="math display">\[z=z(x)=\alpha \hat{\Theta}_{0} p_{\omega_{h}}^{\perp}+p_{\omega_{h}}+\beta \tilde{m} g-p_{\omega_{w}}\]</span></p><p>å½“<span class="math inline">\(\mathcal{K}_{\infty}\)</span>å‡½æ•°<span class="math inline">\(a(x):=\epsilon x^{2}, \text { with } \epsilon&lt; \min \left\{\frac{2}{\pi^{2}}\|m\|_{2}\|g\|_{2}, \frac{1}{2 \delta\left\|\hat{\Theta}_{0}\right\|_{2}}, \frac{\alpha}{2}\right\}\)</span> is such that <span class="math inline">\(V(x) \ge a\left(\left\|\left(p_{\omega_{h}}, p_{\omega_{w}}, z\right)\right\|_{2}\right), \forall x \in \mathcal{X}\)</span> æ­¤å¤–<span class="math inline">\(V(x = x_0) = 0\)</span> æ„å‘³ç€ <span class="math inline">\(x = x_0\)</span>ï¼Œå…¶ä¸­ $x_0 $ ã€‚ å› æ­¤ V æ˜¯ä¸€ä¸ªæ­£å®šå‡½æ•°å’Œä¸€ä¸ªæœ‰æ•ˆçš„ Lyapunov å€™é€‰</p><p>æ¥ä¸‹æ¥ï¼Œæ²¿ç€é—­ç¯ç³»ç»Ÿçš„è½¨è¿¹è¯„ä¼° $ $ï¼š</p><p><span class="math display">\[\begin{aligned}\dot{V}(x) &amp;=\alpha p_{\omega_{h}}^{\perp}{p}_{\omega_{h}}^{\perp}+m^{\mathrm{T}} \dot{g}+\frac{1}{\delta} z^{\mathrm{T}} \hat{\Theta}_{0}^{-1} \dot{z} \\&amp;=m^{\mathrm{T}} \tilde{g} \hat{\Theta}_{0}^{-1}(\beta \tilde{g} m+z)+\frac{1}{\delta} z^{\mathrm{T}} \hat{\Theta}_{0}^{-1} \dot{z} \\&amp;=-\beta(\tilde{g} m)^{\mathrm{T}} \hat{\Theta}_{0}^{-1}(\tilde{g} m)+z^{\mathrm{T}} \hat{\Theta}_{0}^{-1}\left(\tilde{m} g+\frac{1}{\delta} \dot{z}\right) \\&amp;=-\beta(\tilde{g} m)^{\mathrm{T}} \hat{\Theta}_{0}^{-1}(\tilde{g} m)-\frac{\gamma}{\delta} z^{\mathrm{T}} \hat{\Theta}_{0}^{-1} z \leq 0, \forall x \in \mathcal{X} .\end{aligned}\]</span></p><p>ç”±äº <span class="math inline">\(\dot{V}(x) \leq 0 , \forall x \in \mathcal{X}\)</span>ï¼Œæˆ‘ä»¬ä»æé›…æ™®è¯ºå¤«ç¨³å®šæ€§å®šç†å¾—å‡ºç»“è®ºï¼Œç‚¹ $x_0 $æ˜¯ç¨³å®šçš„ï¼š</p><p>ä¸ºäº†è¯æ˜é›†åˆ <span class="math inline">\(\tau\)</span> åœ¨ <span class="math inline">\(\chi^âˆ’\)</span> ä¸­çš„æ¸è¿‘ç¨³å®šæ€§ï¼Œå®šä¹‰é›†åˆ <span class="math inline">\(\mathcal{R}:=\{x \in \mathcal{X}-\mid \dot{V}(x)=0\}\)</span>ã€‚ æ¡ä»¶ <span class="math inline">\(\dot{V}(x) = 0\)</span> ç«‹å³å¯¼è‡´ <span class="math inline">\(z = 0, m || g\)</span>ï¼Œä½¿å¾—<span class="math inline">\(\mathcal{R}\)</span> å¯ä»¥é‡å†™ä¸º <span class="math inline">\(\mathcal{R}=\left\{x \in \mathcal{X}^{-} \mid m \| g, p_{\omega_{w}}=\alpha \hat{\Theta}_{0} p_{\omega_{h}}^{\perp}+p_{\omega_{h}}\right\}\)</span>ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘åŒ…å«åœ¨ <span class="math inline">\(\mathcal{R}\)</span> ä¸­çš„ä¸å˜é›†å†…è½¨è¿¹çš„ç³»ç»ŸåŠ¨åŠ›å­¦ã€‚è¿™ç»™å‡ºï¼š</p><p><span class="math display">\[\begin{aligned}g \| m &amp; \Rightarrow g=-\frac{m}{\|m\|_{2}}\|g\|_{2} \Rightarrow \dot{g}=0 \\&amp; \Rightarrow \omega_{h} \| g \quad \because \dot{g}=-\tilde{\omega}_{h} g \\\end{aligned} \tag{24}\]</span></p><p><span class="math display">\[g \| m, z=0  \Rightarrow \omega_{h}=\alpha p_{\omega_{h}}^{\perp} \\ \Rightarrow \omega_{h} \| p_{\omega_{h}}^{\perp} \tag{25}\]</span></p><p>ç„¶è€Œï¼Œç”±äº <span class="math inline">\(p_{w_h}^{\perp} \perp g\)</span> æ ¹æ®å®šä¹‰ï¼Œ(24) å’Œ (25) æ„å‘³ç€ <span class="math inline">\(w_h = 0\)</span> å’Œ$ p_{w_h}^{} = 0$ã€‚è¿™è¡¨æ˜ $$ æ˜¯ $ $ çš„æœ€å¤§ä¸å˜å­é›†ã€‚ç°åœ¨ï¼Œæ ¹æ® Krasovskii-LaSalle åŸç† [9](å®šç† 4.4ï¼‰ ï¼Œç”±æ­¤å¯çŸ¥ï¼Œå¯¹äºä»»ä½•è½¨è¿¹$ x(t)$ï¼š</p><p><span class="math display">\[\lim _{t \rightarrow \infty} x(t)=x_{f}, \quad x(0) \in \mathcal{X}^{-}, \quad x_{f} \in \mathcal{T}\]</span></p><h2 id="remarks-1">Remarks</h2>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆä¸‰ï¼‰VFS</title>
      <link href="/2021/LinuxKernel/LinuxFileSystemVFS/"/>
      <url>/2021/LinuxKernel/LinuxFileSystemVFS/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/LinuxFSVFS.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjNhYmExNzdkOWMwODA3MGU1YjkwODc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£">é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£</h1><p>VFS ä½¿å¾—ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ open()ã€read() å’Œ write() è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨è€Œæ— é¡»è€ƒè™‘å…·ä½“æ–‡ä»¶ç³»ç»Ÿå’Œå®é™…ç‰©ç†ä»‹è´¨ï¼Œä½¿å¾—è¿™äº›é€šç”¨çš„ç³»ç»Ÿè°ƒç”¨å¯ä»¥è·¨è¶Šå„ç§æ–‡ä»¶ç³»ç»Ÿå’Œä¸åŒä»‹è´¨æ‰§è¡Œã€‚</p><p>Unix ä½¿ç”¨äº†å››ç§å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¼ ç»ŸæŠ½è±¡æ¦‚å¿µï¼šæ–‡ä»¶ã€ç›®å½•é¡¹ã€ç´¢å¼•èŠ‚ç‚¹å’Œå®‰è£…ç‚¹ (mount point)ã€‚</p><h1 id="vfs-å¯¹è±¡åŠå…¶æ•°æ®ç»“æ„">VFS å¯¹è±¡åŠå…¶æ•°æ®ç»“æ„</h1><p>VFS å…¶å®é‡‡ç”¨çš„æ˜¯é¢å‘å¯¹è±¡çš„è®¾è®¡æ€è·¯ï¼Œä½¿ç”¨ä¸€ç»„æ•°æ®ç»“æ„æ¥ä»£è¡¨é€šç”¨æ–‡ä»¶å¯¹è±¡ï¼Œæœ‰å››ä¸ªä¸»è¦çš„å¯¹è±¡ç±»å‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><ul><li>è¶…çº§å—å¯¹è±¡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå…·ä½“çš„å·²å®‰è£…æ–‡ä»¶ç³»ç»Ÿ</li><li>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå…·ä½“æ–‡ä»¶</li><li>ç›®å½•é¡¹å¯¹è±¡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†</li><li>æ–‡ä»¶å¯¹è±¡ï¼Œå®ƒä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶</li></ul><blockquote><p>æ³¨æ„ï¼Œå› ä¸º VFS å°†ç›®å½•ä½œä¸ºä¸€ä¸ªæ–‡ä»¶æ¥å¤„ç†ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ç›®å½•å¯¹è±¡ã€‚</p></blockquote><p>æ¯ä¸ªä¸»è¦å¯¹è±¡ä¸­éƒ½åŒ…å«ä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œè¿™äº›æ“ä½œå¯¹è±¡æè¿°äº†å†…æ ¸é’ˆå¯¹ä¸»è¦å¯¹è±¡å¯ä»¥ä½¿ç”¨çš„æ–¹æ³•ï¼š</p><ul><li>super_operations å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬å†…æ ¸é’ˆå¯¹ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿæ‰€èƒ½è°ƒç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚ write_inode() å’Œ sync_fs() ç­‰æ–¹æ³•</li><li>inode_operations å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬å†…æ ¸é’ˆå¯¹ç‰¹å®šæ–‡ä»¶æ‰€èƒ½è°ƒç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚ create() å’Œ link() ç­‰æ–¹æ³•</li><li>dentry_operations å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬å†…æ ¸é’ˆå¯¹ç‰¹å®šç›®å½•æ‰€èƒ½è°ƒç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚ d_compare() å’Œ d_delete() ç­‰æ–¹æ³•</li><li>file_operations å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬è¿›ç¨‹é’ˆå¯¹å·²æ‰“å¼€æ–‡ä»¶æ‰€èƒ½è°ƒç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚ read() å’Œ write() ç­‰æ–¹æ³•</li></ul><p>æ“ä½œå¯¹è±¡ä½œä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆæ¥å®ç°ï¼Œæ­¤ç»“æ„ä½“ä¸­åŒ…å«æŒ‡å‘æ“ä½œå…¶çˆ¶å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆã€‚</p><h2 id="è¶…çº§å—å¯¹è±¡">è¶…çº§å—å¯¹è±¡</h2><p>å„ç§æ–‡ä»¶ç³»ç»Ÿéƒ½å¿…é¡»å®ç°è¶…çº§å—å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨äºå­˜å‚¨ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œé€šå¸¸å¯¹åº”äºå­˜æ”¾åœ¨ç£ç›˜ç‰¹å®šæ‰‡åŒºä¸­çš„æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—æˆ–æ–‡ä»¶ç³»ç»Ÿæ§åˆ¶å—ï¼ˆæ‰€ä»¥ç§°ä¸ºè¶…çº§å—å¯¹è±¡ï¼‰ã€‚å¯¹äºå¹¶éåŸºäºç£ç›˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚ sysfsï¼‰ï¼Œå®ƒä»¬ä¼šåœ¨ä½¿ç”¨ç°åœºåˆ›å»ºè¶…çº§å—å¹¶å°†å…¶ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚è¶…çº§å—å¯¹è±¡ç”± super block ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs.hã€‹ä¸­ï¼Œä¸‹é¢ç»™å‡ºå®ƒçš„ç»“æ„å’Œå„ä¸ªåŸŸçš„æè¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">s_list</span>;</span><span class="comment">/* Keep this first */</span></span><br><span class="line"><span class="type">dev_t</span>s_dev;<span class="comment">/* search index; _not_ kdev_t */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>s_blocksize_bits;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>s_blocksize;</span><br><span class="line"><span class="type">loff_t</span>s_maxbytes;<span class="comment">/* Max file size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>*<span class="title">s_type</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span>*<span class="title">s_op</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dquot_operations</span>*<span class="title">dq_op</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">quotactl_ops</span>*<span class="title">s_qcop</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">export_operations</span> *<span class="title">s_export_op</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>s_flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>s_iflags;<span class="comment">/* internal SB_I_* flags */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>s_magic;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>*<span class="title">s_root</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span><span class="title">s_umount</span>;</span></span><br><span class="line"><span class="type">int</span>s_count;</span><br><span class="line"><span class="type">atomic_t</span>s_active;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="type">void</span>                    *s_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xattr_handler</span> **<span class="title">s_xattr</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_operations</span>*<span class="title">s_cop</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">s_master_keys</span>;</span> <span class="comment">/* master crypto keys in use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fsverity_operations</span> *<span class="title">s_vop</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_UNICODE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">unicode_map</span> *<span class="title">s_encoding</span>;</span></span><br><span class="line">__u16 s_encoding_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_head</span><span class="title">s_roots</span>;</span><span class="comment">/* alternate root dentries for NFS */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">s_mounts</span>;</span><span class="comment">/* list of mounts; _not_ for fs use */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>*<span class="title">s_bdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">s_bdi</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span>*<span class="title">s_mtd</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span><span class="title">s_instances</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>s_quota_types;<span class="comment">/* Bitmask of supported quota types */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">quota_info</span><span class="title">s_dquot</span>;</span><span class="comment">/* Diskquota specific options */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sb_writers</span><span class="title">s_writers</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Keep s_fs_info, s_time_gran, s_fsnotify_mask, and</span></span><br><span class="line"><span class="comment"> * s_fsnotify_marks together for cache efficiency. They are frequently</span></span><br><span class="line"><span class="comment"> * accessed and rarely modified.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span>*s_fs_info;<span class="comment">/* Filesystem private info */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Granularity of c/m/atime in ns (cannot be worse than a second) */</span></span><br><span class="line">u32s_time_gran;</span><br><span class="line"><span class="comment">/* Time limits for c/m/atime in seconds */</span></span><br><span class="line"><span class="type">time64_t</span>   s_time_min;</span><br><span class="line"><span class="type">time64_t</span>   s_time_max;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">__u32s_fsnotify_mask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>*<span class="title">s_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>s_id[<span class="number">32</span>];<span class="comment">/* Informational name */</span></span><br><span class="line"><span class="type">uuid_t</span>s_uuid;<span class="comment">/* UUID */</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>s_max_links;</span><br><span class="line"><span class="type">fmode_t</span>s_mode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The next field is for VFS *only*. No filesystems have any business</span></span><br><span class="line"><span class="comment"> * even looking at it. You had been warned.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">s_vfs_rename_mutex</span>;</span><span class="comment">/* Kludge */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Filesystem subtype.  If non-empty the filesystem type field</span></span><br><span class="line"><span class="comment"> * in /proc/mounts will be "type.subtype"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *s_subtype;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">s_d_op</span>;</span> <span class="comment">/* default d_op for dentries */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Saved pool identifier for cleancache (-1 means none)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> cleancache_poolid;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrinker</span> <span class="title">s_shrink</span>;</span><span class="comment">/* per-sb shrinker handle */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Number of inodes with nlink == 0 but still referenced */</span></span><br><span class="line"><span class="type">atomic_long_t</span> s_remove_count;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Number of inode/mount/sb objects that are being watched, note that</span></span><br><span class="line"><span class="comment"> * inodes objects are currently double-accounted.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">atomic_long_t</span> s_fsnotify_connectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Being remounted read-only */</span></span><br><span class="line"><span class="type">int</span> s_readonly_remount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* per-sb errseq_t for reporting writeback errors via syncfs */</span></span><br><span class="line"><span class="type">errseq_t</span> s_wb_err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* AIO completions deferred from interrupt context */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">s_dio_done_wq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">s_pins</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Owning user namespace and default context in which to</span></span><br><span class="line"><span class="comment"> * interpret filesystem uids, gids, quotas, device nodes,</span></span><br><span class="line"><span class="comment"> * xattrs and security labels.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">s_user_ns</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The list_lru structure is essentially just a pointer to a table</span></span><br><span class="line"><span class="comment"> * of per-node lru lists, each of which has its own spinlock.</span></span><br><span class="line"><span class="comment"> * There is no need to put them into separate cachelines.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span><span class="title">s_dentry_lru</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span><span class="title">s_inode_lru</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span><span class="title">destroy_work</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">s_sync_lock</span>;</span><span class="comment">/* sync serialisation lock */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Indicates how deep in a filesystem stack this SB is</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> s_stack_depth;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* s_inode_list_lock protects s_inodes */</span></span><br><span class="line"><span class="type">spinlock_t</span>s_inode_list_lock ____cacheline_aligned_in_smp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">s_inodes</span>;</span><span class="comment">/* all inodes */</span></span><br><span class="line"></span><br><span class="line"><span class="type">spinlock_t</span>s_inode_wblist_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">s_inodes_wb</span>;</span><span class="comment">/* writeback inodes */</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºã€ç®¡ç†å’Œæ’¤é”€è¶…çº§å—å¯¹è±¡çš„ä»£ç ä½äºæ–‡ä»¶ fs/super.c ä¸­ã€‚è¶…çº§å—å¯¹è±¡é€šè¿‡ alloc_super() å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿå®‰è£…æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šè°ƒç”¨è¯¥å‡½æ•°ä»¥ä¾¿ä»ç£ç›˜è¯»å–æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—ï¼Œå¹¶ä¸”å°†å…¶ä¿¡æ¯å¡«å……åˆ°å†…å­˜ä¸­çš„è¶…çº§å—å¯¹è±¡ä¸­ã€‚</p><h3 id="è¶…çº§å—æ“ä½œ">è¶…çº§å—æ“ä½œ</h3><p>è¶…çº§å—å¯¹è±¡ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåŸŸæ˜¯ s_opï¼Œå®ƒæŒ‡å‘è¶…çº§å—çš„æ“ä½œå‡½æ•°è¡¨ã€‚è¶…çº§å—æ“ä½œå‡½æ•°è¡¨ç”± super_operations ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs.hã€‹ä¸­ï¼Œå…¶å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span> {</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *(*<span class="title">alloc_inode</span>)(<span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>);</span></span><br><span class="line"><span class="type">void</span> (*destroy_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line"><span class="type">void</span> (*free_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line"></span><br><span class="line">   <span class="type">void</span> (*dirty_inode) (<span class="keyword">struct</span> inode *, <span class="type">int</span> flags);</span><br><span class="line"><span class="type">int</span> (*write_inode) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> writeback_control *wbc);</span><br><span class="line"><span class="type">int</span> (*drop_inode) (<span class="keyword">struct</span> inode *);</span><br><span class="line"><span class="type">void</span> (*evict_inode) (<span class="keyword">struct</span> inode *);</span><br><span class="line"><span class="type">void</span> (*put_super) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="type">int</span> (*sync_fs)(<span class="keyword">struct</span> super_block *sb, <span class="type">int</span> wait);</span><br><span class="line"><span class="type">int</span> (*freeze_super) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="type">int</span> (*freeze_fs) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="type">int</span> (*thaw_super) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="type">int</span> (*unfreeze_fs) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="type">int</span> (*statfs) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> kstatfs *);</span><br><span class="line"><span class="type">int</span> (*remount_fs) (<span class="keyword">struct</span> super_block *, <span class="type">int</span> *, <span class="type">char</span> *);</span><br><span class="line"><span class="type">void</span> (*umount_begin) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*show_options)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*show_devname)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*show_path)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*show_stats)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_QUOTA</span></span><br><span class="line"><span class="type">ssize_t</span> (*quota_read)(<span class="keyword">struct</span> super_block *, <span class="type">int</span>, <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">loff_t</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*quota_write)(<span class="keyword">struct</span> super_block *, <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">loff_t</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dquot</span> **(*<span class="title">get_dquots</span>)(<span class="keyword">struct</span> <span class="title">inode</span> *);</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">long</span> (*nr_cached_objects)(<span class="keyword">struct</span> super_block *,</span><br><span class="line">  <span class="keyword">struct</span> shrink_control *);</span><br><span class="line"><span class="type">long</span> (*free_cached_objects)(<span class="keyword">struct</span> super_block *,</span><br><span class="line">    <span class="keyword">struct</span> shrink_control *);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¯¥ç»“æ„ä½“ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘è¶…çº§å—æ“ä½œå‡½æ•°çš„æŒ‡é’ˆï¼Œè¶…çº§å—æ“ä½œå‡½æ•°æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿå’Œç´¢å¼•èŠ‚ç‚¹çš„åº•å±‚æ“ä½œã€‚å½“æ–‡ä»¶ç³»ç»Ÿéœ€è¦å¯¹å…¶è¶…çº§å—æ‰§è¡Œæ“ä½œæ—¶ï¼Œé¦–å…ˆè¦åœ¨è¶…çº§å—å¯¹è±¡ä¸­å¯»æ‰¾éœ€è¦çš„æ“ä½œæ–¹æ³•ã€‚</p><p>ä¸‹é¢ç»™å‡º super_operation ä¸­ï¼Œè¶…çº§å—æ“ä½œå‡½æ•°çš„ç”¨æ³•ã€‚</p><ul><li>alloc_inode: åœ¨ç»™å®šçš„è¶…çº§å—ä¸‹åˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</li><li>destroy_inode: ç”¨äºé‡Šæ”¾ç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹</li><li>dirty_inode: VFS åœ¨ç´¢å¼•èŠ‚ç‚¹è„ï¼ˆè¢«ä¿®æ”¹ï¼‰æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext3 å’Œ ext4ï¼‰æ‰§è¡Œè¯¥å‡½æ•°è¿›è¡Œæ—¥å¿—æ›´æ–°</li><li>write_inode: ç”¨äºå°†ç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹å†™å…¥ç£ç›˜ã€‚wait å‚æ•°æŒ‡æ˜å†™æ“ä½œæ˜¯å¦éœ€è¦åŒæ­¥</li><li>...</li></ul><h3 id="ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡">ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</h3><p>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡åŒ…å«äº†å†…æ ¸åœ¨æ“ä½œæ–‡ä»¶æˆ–ç›®å½•æ—¶éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯ã€‚å¯¹äº Unix é£æ ¼çš„æ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ä»ç£ç›˜ç´¢å¼•èŠ‚ç‚¹ç›´æ¥è¯»å…¥ã€‚ ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ç”± inode ç»“æ„ä½“è¡¨ç¤ºï¼Œå®ƒå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs.hã€‹ä¸­ï¼Œä¸‹é¢ç»™å‡ºå®ƒçš„ç»“æ„ä½“å’Œå„é¡¹çš„æè¿°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Keep mostly read-only and often accessed (especially for</span></span><br><span class="line"><span class="comment"> * the RCU path lookup and 'stat' data) fields at the beginning</span></span><br><span class="line"><span class="comment"> * of the 'struct inode'</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> {</span></span><br><span class="line"><span class="type">umode_t</span>i_mode;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>i_opflags;</span><br><span class="line"><span class="type">kuid_t</span>i_uid;</span><br><span class="line"><span class="type">kgid_t</span>i_gid;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>i_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_POSIX_ACL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>*<span class="title">i_acl</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>*<span class="title">i_default_acl</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span>*<span class="title">i_op</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>*<span class="title">i_sb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>*<span class="title">i_mapping</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="type">void</span>*i_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Stat data, not accessed from path walking */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>i_ino;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Filesystems may only read i_nlink directly.  They shall use the</span></span><br><span class="line"><span class="comment"> * following functions for modification:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    (set|clear|inc|drop)_nlink</span></span><br><span class="line"><span class="comment"> *    inode_(inc|dec)_link_count</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> i_nlink;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __i_nlink;</span><br><span class="line">};</span><br><span class="line"><span class="type">dev_t</span>i_rdev;</span><br><span class="line"><span class="type">loff_t</span>i_size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span><span class="title">i_atime</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span><span class="title">i_mtime</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span><span class="title">i_ctime</span>;</span></span><br><span class="line"><span class="type">spinlock_t</span>i_lock;<span class="comment">/* i_blocks, i_bytes, maybe i_size */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>          i_bytes;</span><br><span class="line">u8i_blkbits;</span><br><span class="line">u8i_write_hint;</span><br><span class="line"><span class="type">blkcnt_t</span>i_blocks;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NEED_I_SIZE_ORDERED</span></span><br><span class="line"><span class="type">seqcount_t</span>i_size_seqcount;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Misc */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>i_state;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span><span class="title">i_rwsem</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>dirtied_when;<span class="comment">/* jiffies of first dirtying */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>dirtied_time_when;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span><span class="title">i_hash</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">i_io_list</span>;</span><span class="comment">/* backing dev IO list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span>*<span class="title">i_wb</span>;</span><span class="comment">/* the associated cgroup wb */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line"><span class="type">int</span>i_wb_frn_winner;</span><br><span class="line">u16i_wb_frn_avg_time;</span><br><span class="line">u16i_wb_frn_history;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">i_lru</span>;</span><span class="comment">/* inode LRU list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">i_sb_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">i_wb_list</span>;</span><span class="comment">/* backing dev writeback list */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span><span class="title">i_dentry</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">i_rcu</span>;</span></span><br><span class="line">};</span><br><span class="line"><span class="type">atomic64_t</span>i_version;</span><br><span class="line"><span class="type">atomic64_t</span>i_sequence; <span class="comment">/* see futex */</span></span><br><span class="line"><span class="type">atomic_t</span>i_count;</span><br><span class="line"><span class="type">atomic_t</span>i_dio_count;</span><br><span class="line"><span class="type">atomic_t</span>i_writecount;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IMA) || defined(CONFIG_FILE_LOCKING)</span></span><br><span class="line"><span class="type">atomic_t</span>i_readcount; <span class="comment">/* struct files open RO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>*<span class="title">i_fop</span>;</span><span class="comment">/* former -&gt;i_op-&gt;default_file_ops */</span></span><br><span class="line"><span class="type">void</span> (*free_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line">};</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_lock_context</span>*<span class="title">i_flctx</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span><span class="title">i_data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">i_devices</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>*<span class="title">i_pipe</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>*<span class="title">i_cdev</span>;</span></span><br><span class="line"><span class="type">char</span>*i_link;</span><br><span class="line"><span class="type">unsigned</span>i_dir_seq;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">__u32i_generation;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">__u32i_fsnotify_mask; <span class="comment">/* all events this inode cares about */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>*<span class="title">i_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_info</span>*<span class="title">i_crypt_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fsverity_info</span>*<span class="title">i_verity_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>*i_private; <span class="comment">/* fs or device private pointer */</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ä»£è¡¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆä½†æ˜¯ç´¢å¼•èŠ‚ç‚¹ä»…å½“æ–‡ä»¶è¢«è®¿é—®æ—¶ï¼Œæ‰åœ¨å†…å­˜ä¸­åˆ›å»ºï¼‰çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒä¹Ÿå¯ä»¥æ˜¯è®¾å¤‡æˆ–ç®¡é“è¿™æ ·çš„ç‰¹æ®Šæ–‡ä»¶ã€‚å› æ­¤ç´¢å¼•èŠ‚ç‚¹ç»“æ„ä½“ä¸­æœ‰ä¸€äº›å’Œç‰¹æ®Šæ–‡ä»¶ç›¸å…³çš„é¡¹ï¼Œæ¯”å¦‚ i_pipe é¡¹å°±æŒ‡å‘ä¸€ä¸ªä»£è¡¨æœ‰åç®¡é“çš„æ•°æ®ç»“æ„ï¼Œi_bdev æŒ‡å‘å—è®¾å¤‡ç»“æ„ä½“ï¼Œi_cdev æŒ‡å‘å­—ç¬¦è®¾å¤‡ç»“æ„ä½“ã€‚è¿™ä¸‰ä¸ªæŒ‡é’ˆè¢«å­˜æ”¾åœ¨ä¸€ä¸ªå…¬ç”¨ä½“ä¸­ï¼Œå› ä¸ºä¸€ä¸ªç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹æ¯æ¬¡åªèƒ½è¡¨ç¤ºä¸‰è€…ä¹‹ä¸€ï¼ˆæˆ–ä¸‰è€…å‡ä¸ï¼‰ã€‚</p><h3 id="ç´¢å¼•èŠ‚ç‚¹æ“ä½œ">ç´¢å¼•èŠ‚ç‚¹æ“ä½œ</h3><p>å’Œè¶…çº§å—æ“ä½œä¸€æ ·ï¼Œç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ä¸­çš„ inode_operations é¡¹ä¹Ÿéå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒæè¿°äº† VFS ç”¨ä»¥æ“ä½œç´¢å¼•èŠ‚ç‚¹å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ç”±æ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚ä¸è¶…çº§å—ç±»ä¼¼ï¼Œå¯¹ç´¢å¼•èŠ‚ç‚¹çš„æ“ä½œè°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i-&gt;i_op-&gt;truncate(i)</span><br></pre></td></tr></tbody></table></figure><p>i æŒ‡å‘ç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹ï¼Œtruncate() å‡½æ•°æ˜¯ç”±ç´¢å¼•èŠ‚ç‚¹ i æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿå®šä¹‰çš„ã€‚inode_operations ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs.hã€‹ä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> * (*<span class="title">lookup</span>) (<span class="keyword">struct</span> <span class="title">inode</span> *,<span class="keyword">struct</span> <span class="title">dentry</span> *, <span class="title">unsigned</span> <span class="title">int</span>);</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * (*get_link) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> inode *, <span class="keyword">struct</span> delayed_call *);</span><br><span class="line"><span class="type">int</span> (*permission) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *, <span class="type">int</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span> * (*<span class="title">get_acl</span>)(<span class="keyword">struct</span> <span class="title">inode</span> *, <span class="title">int</span>, <span class="title">bool</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*readlink) (<span class="keyword">struct</span> dentry *, <span class="type">char</span> __user *,<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*create) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,</span><br><span class="line">       <span class="type">umode_t</span>, <span class="type">bool</span>);</span><br><span class="line"><span class="type">int</span> (*link) (<span class="keyword">struct</span> dentry *,<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*unlink) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*symlink) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"><span class="type">int</span> (*mkdir) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,</span><br><span class="line">      <span class="type">umode_t</span>);</span><br><span class="line"><span class="type">int</span> (*rmdir) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*mknod) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,</span><br><span class="line">      <span class="type">umode_t</span>,<span class="type">dev_t</span>);</span><br><span class="line"><span class="type">int</span> (*rename) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *,</span><br><span class="line"><span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*setattr) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> dentry *,</span><br><span class="line"><span class="keyword">struct</span> iattr *);</span><br><span class="line"><span class="type">int</span> (*getattr) (<span class="keyword">struct</span> user_namespace *, <span class="type">const</span> <span class="keyword">struct</span> path *,</span><br><span class="line"><span class="keyword">struct</span> kstat *, u32, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*listxattr) (<span class="keyword">struct</span> dentry *, <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line"><span class="type">int</span> (*fiemap)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> fiemap_extent_info *, u64 start,</span><br><span class="line">      u64 len);</span><br><span class="line"><span class="type">int</span> (*update_time)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> timespec64 *, <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*<span class="type">atomic_open</span>)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *,</span><br><span class="line">   <span class="keyword">struct</span> file *, <span class="type">unsigned</span> open_flag,</span><br><span class="line">   <span class="type">umode_t</span> create_mode);</span><br><span class="line"><span class="type">int</span> (*tmpfile) (<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,</span><br><span class="line"><span class="keyword">struct</span> dentry *, <span class="type">umode_t</span>);</span><br><span class="line"><span class="type">int</span> (*set_acl)(<span class="keyword">struct</span> user_namespace *, <span class="keyword">struct</span> inode *,</span><br><span class="line">       <span class="keyword">struct</span> posix_acl *, <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*fileattr_set)(<span class="keyword">struct</span> user_namespace *mnt_userns,</span><br><span class="line">    <span class="keyword">struct</span> dentry *dentry, <span class="keyword">struct</span> fileattr *fa);</span><br><span class="line"><span class="type">int</span> (*fileattr_get)(<span class="keyword">struct</span> dentry *dentry, <span class="keyword">struct</span> fileattr *fa);</span><br><span class="line">} ____cacheline_aligned;</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢è¿™äº›æ¥å£ç”±å„ç§å‡½æ•°ç»„æˆï¼Œåœ¨ç»™å®šçš„èŠ‚ç‚¹ä¸Šï¼Œå¯èƒ½ç”± VF æ‰§è¡Œè¿™äº›å‡½æ•°ï¼Œä¹Ÿå¯èƒ½ç”±å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œï¼š</p><ul><li>create: VFS é€šè¿‡ç³»ç»Ÿè°ƒç”¨ create() å’Œ open() æ¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œä»è€Œä¸º dentry å¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„ç´¢å¼•èŠ‚ç‚¹ã€‚åœ¨åˆ›å»ºæ—¶ä½¿ç”¨ mode æŒ‡å®šçš„åˆå§‹æ¨¡å¼</li><li>lookup: è¯¥å‡½æ•°åœ¨ç‰¹å®šç›®å½•ä¸­å¯»æ‰¾ç´¢å¼•èŠ‚ç‚¹ï¼Œè¯¥ç´¢å¼•èŠ‚ç‚¹è¦å¯¹åº”äº denrty ä¸­ç»™å‡ºçš„æ–‡ä»¶å</li><li>link: è¯¥å‡½æ•°è¢«ç³»ç»Ÿè°ƒç”¨ link() è°ƒç”¨ï¼Œç”¨æ¥åˆ›å»ºç¡¬è¿æ¥ã€‚ç¡¬è¿æ¥åç§°ç”± dentry å‚æ•°æŒ‡å®šï¼Œè¿æ¥å¯¹è±¡æ˜¯ dir ç›®å½•ä¸­ old_dentry ç›®å½•é¡¹æ‰€ä»£è¡¨çš„æ–‡ä»¶</li><li>unlink: è¯¥å‡½æ•°è¢«ç³»ç»Ÿè°ƒç”¨ unlinkO() è°ƒç”¨ï¼Œä»ç›®å½• dir ä¸­åˆ é™¤ç”±ç›®å½•é¡¹ dentry æŒ‡å®šçš„ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</li><li>symlink: è¯¥å‡½æ•°è¢«ç³»ç»Ÿè°ƒç”¨ symlik() è°ƒç”¨ï¼Œåˆ›å»ºç¬¦å·è¿æ¥ã€‚è¯¥ç¬¦å·è¿æ¥åç§°ç”± symname æŒ‡å®šï¼Œè¿æ¥å¯¹è±¡æ˜¯ dir ç›®å½•ä¸­çš„ dentry ç›®å½•é¡¹</li><li>mkdir: è¯¥å‡½æ•°è¢«ç³»ç»Ÿè°ƒç”¨ mkdir() è°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ã€‚åˆ›å»ºæ—¶ä½¿ç”¨ mode æŒ‡å®šçš„åˆå§‹æ¨¡å¼</li><li>rmdir: è¯¥å‡½æ•°è¢«ç³»ç»Ÿè°ƒç”¨ rmdir() è°ƒç”¨ï¼Œåˆ é™¤ dir ç›®å½•ä¸­çš„ dentry ç›®å½•é¡¹ä»£è¡¨çš„æ–‡ä»¶</li><li>...</li></ul><h2 id="ç›®å½•é¡¹å¯¹è±¡">ç›®å½•é¡¹å¯¹è±¡</h2><p>VFS æŠŠç›®å½•å½“ä½œæ–‡ä»¶å¯¹å¾…ï¼Œè™½ç„¶å®ƒä»¬å¯ä»¥ç»Ÿä¸€ç”±ç´¢å¼•èŠ‚ç‚¹è¡¨ç¤ºï¼Œä½†æ˜¯ VFS ç»å¸¸éœ€è¦æ‰§è¡Œç›®å½•ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚è·¯å¾„åæŸ¥æ‰¾ç­‰ï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾æ“ä½œï¼ŒVFS å¼•å…¥äº†ç›®å½•é¡¹çš„æ¦‚å¿µã€‚æ¯ä¸ª dentry ä»£è¡¨è·¯å¾„ä¸­çš„ä¸€ä¸ªç‰¹å®šéƒ¨åˆ†ã€‚è§£æä¸€ä¸ªè·¯å¾„å¹¶éå†å…¶åˆ†é‡ç»éç®€å•ï¼Œå®ƒæ˜¯è€—æ—¶çš„ã€å¸¸è§„çš„å­—ç¬¦ä¸²æ¯”è¾ƒè¿‡ç¨‹ï¼Œæ‰§è¡Œè€—æ—¶ã€ä»£ç ç¹çã€‚ç›®å½•é¡¹å¯¹è±¡çš„å¼•å…¥ä½¿å¾—è¿™ä¸ªè¿‡ç¨‹æ›´åŠ ç®€å•ã€‚ç›®å½•é¡¹ä¹Ÿå¯åŒ…æ‹¬å®‰è£…ç‚¹ã€‚VFS åœ¨æ‰§è¡Œç›®å½•æ“ä½œæ—¶ä¼šç°åœºåˆ›å»ºç›®å½•é¡¹å¯¹è±¡ã€‚ ç›®å½•é¡¹å¯¹è±¡ç”± dentry ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/dcache.hã€‹ä¸­ã€‚ä¸‹é¢ç»™å‡ºè¯¥ç»“æ„ä½“å’Œå…¶ä¸­å„é¡¹çš„æè¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> {</span></span><br><span class="line"><span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> d_flags;<span class="comment">/* protected by d_lock */</span></span><br><span class="line"><span class="type">seqcount_spinlock_t</span> d_seq;<span class="comment">/* per dentry seqlock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span><span class="comment">/* lookup hash list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span><span class="comment">/* parent directory */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span><span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment"> * negative */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> d_iname[DNAME_INLINE_LEN];<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span><span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span><span class="comment">/* The root of the dentry tree */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> d_time;<span class="comment">/* used by d_revalidate */</span></span><br><span class="line"><span class="type">void</span> *d_fsdata;<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span><span class="comment">/* LRU list */</span></span><br><span class="line"><span class="type">wait_queue_head_t</span> *d_wait;<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">};</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span><span class="comment">/* child of parent list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span><span class="comment">/* our children */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span><span class="comment">/* inode alias list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span><span class="comment">/* only for in-lookup ones */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">} d_u;</span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>ä¸å‰é¢çš„ä¸¤ä¸ªå¯¹è±¡ä¸åŒï¼Œç›®å½•é¡¹å¯¹è±¡æ²¡æœ‰å¯¹åº”çš„ç£ç›˜æ•°æ®ç»“æ„ï¼ŒVFS æ ¹æ®å­—ç¬¦ä¸²å½¢å¼çš„è·¯å¾„åç°åœºåˆ›å»ºå®ƒã€‚è€Œä¸”ç”±äºç›®å½•é¡¹å¯¹è±¡å¹¶éçœŸæ­£ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œæ‰€ä»¥ç›®å½•é¡¹ç»“æ„ä½“æ²¡æœ‰æ˜¯å¦è¢«ä¿®æ”¹çš„æ ‡å¿—ï¼ˆä¹Ÿå°±æ˜¯æ˜¯å¦ä¸ºè„ã€æ˜¯å¦éœ€è¦å†™å›ç£ç›˜çš„æ ‡å¿—ï¼‰ã€‚</p><h3 id="ç›®å½•é¡¹çŠ¶æ€">ç›®å½•é¡¹çŠ¶æ€</h3><p>ç›®å½•é¡¹å¯¹è±¡æœ‰ä¸‰ç§æœ‰æ•ˆçŠ¶æ€ï¼šè¢«ä½¿ç”¨ã€æœªè¢«ä½¿ç”¨å’Œè´ŸçŠ¶æ€ã€‚</p><ul><li>ä¸€ä¸ªè¢«ä½¿ç”¨çš„ç›®å½•é¡¹å¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„ç´¢å¼•èŠ‚ç‚¹ï¼ˆå³ d_inode æŒ‡å‘ç›¸åº”çš„ç´¢å¼•èŠ‚ç‚¹ï¼‰å¹¶ä¸”è¡¨æ˜è¯¥å¯¹è±¡å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªä½¿ç”¨è€…ï¼ˆå³ d_count ä¸ºæ­£å€¼ï¼‰</li><li>ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç›®å½•é¡¹å¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„ç´¢å¼•èŠ‚ç‚¹ï¼ˆd_inode æŒ‡å‘ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ï¼‰ï¼Œä½†æ˜¯åº”æŒ‡æ˜ VFS å½“å‰å¹¶æœªä½¿ç”¨å®ƒï¼ˆd_count ä¸º Oï¼‰ã€‚è¯¥ç›®å½•é¡¹å¯¹è±¡ä»ç„¶æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆå¯¹è±¡ï¼Œè€Œä¸”è¢«ä¿ç•™åœ¨ç¼“å­˜ä¸­ä»¥ä¾¿éœ€è¦æ—¶å†ä½¿ç”¨å®ƒ</li><li>ä¸€ä¸ªè´ŸçŠ¶æ€çš„ç›®å½•é¡¹æ²¡æœ‰å¯¹åº”çš„æœ‰æ•ˆç´¢å¼•èŠ‚ç‚¹ï¼ˆd_inode ä¸º NULLï¼‰ï¼Œå› ä¸ºç´¢å¼•èŠ‚ç‚¹å·²è¢«åˆ é™¤äº†ï¼Œæˆ–è·¯å¾„ä¸å†æ­£ç¡®äº†ï¼Œä½†æ˜¯ç›®å½•é¡¹ä»ç„¶ä¿ç•™ï¼Œä»¥ä¾¿å¿«é€Ÿè§£æä»¥åçš„è·¯å¾„æŸ¥è¯¢ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ä¸æ–­åœ°å»è¯•å›¾æ‰“å¼€å¹¶è¯»å–ä¸€ä¸ªä¸å­˜åœ¨çš„é…ç½®æ–‡ä»¶ã€‚open() ç³»ç»Ÿè°ƒç”¨ä¸æ–­åœ°è¿”å› ENOENTï¼Œç›´åˆ°å†…æ ¸æ„å»ºäº†è¿™ä¸ªè·¯å¾„ã€éå†ç£ç›˜ä¸Šçš„ç›®å½•ç»“æ„ä½“å¹¶æ£€æŸ¥è¿™ä¸ªæ–‡ä»¶çš„ç¡®ä¸å­˜åœ¨ä¸ºæ­¢ã€‚å³ä¾¿è¿™ä¸ªå¤±è´¥çš„æŸ¥æ‰¾å¾ˆæµªè´¹èµ„æºï¼Œä½†æ˜¯å°†è´ŸçŠ¶æ€ç¼“å­˜èµ·æ¥è¿˜æ˜¯éå¸¸å€¼å¾—çš„</li></ul><h3 id="ç›®å½•é¡¹ç¼“å­˜">ç›®å½•é¡¹ç¼“å­˜</h3><p>å¦‚æœ VFS å±‚éå†è·¯å¾„åä¸­æ‰€æœ‰çš„å…ƒç´ å¹¶å°†å®ƒä»¬é€ä¸ªåœ°è§£ææˆç›®å½•é¡¹å¯¹è±¡ï¼Œè¿˜è¦åˆ°è¾¾æœ€æ·±å±‚ç›®å½•ï¼Œå°†æ˜¯ä¸€ä»¶éå¸¸è´¹åŠ›çš„å·¥ä½œï¼Œä¼šæµªè´¹å¤§é‡çš„æ—¶é—´ã€‚æ‰€ä»¥å†…æ ¸å°†ç›®å½•é¡¹å¯¹è±¡ç¼“å­˜åœ¨ç›®å½•é¡¹ç¼“å­˜ï¼ˆç®€ç§° dcacheï¼‰ä¸­ã€‚ ç›®å½•é¡¹ç¼“å­˜åŒ…æ‹¬ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ul><li>â€œè¢«ä½¿ç”¨çš„â€ç›®å½•é¡¹é“¾è¡¨ã€‚è¯¥é“¾è¡¨é€šè¿‡ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ä¸­çš„ i_dentry é¡¹è¿æ¥ç›¸å…³çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œå› ä¸ºä¸€ä¸ªç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹å¯èƒ½æœ‰å¤šä¸ªé“¾æ¥ï¼Œæ‰€ä»¥å°±å¯èƒ½æœ‰å¤šä¸ªç›®å½•é¡¹å¯¹è±¡ï¼Œå› æ­¤ç”¨ä¸€ä¸ªé“¾è¡¨æ¥è¿æ¥å®ƒä»¬</li><li>â€œæœ€è¿‘è¢«ä½¿ç”¨çš„â€åŒå‘é“¾è¡¨ã€‚è¯¥é“¾è¡¨å«æœ‰æœªè¢«ä½¿ç”¨çš„å’Œè´ŸçŠ¶æ€çš„ç›®å½•é¡¹å¯¹è±¡ã€‚ç”±äºè¯¥é“¾æ€»æ˜¯åœ¨å¤´éƒ¨æ’å…¥ç›®å½•é¡¹ï¼Œæ‰€ä»¥é“¾å¤´èŠ‚ç‚¹çš„æ•°æ®æ€»æ¯”é“¾å°¾çš„æ•°æ®è¦æ–°</li><li>æ•£åˆ—è¡¨å’Œç›¸åº”çš„æ•£åˆ—å‡½æ•°ç”¨æ¥å¿«é€Ÿåœ°å°†ç»™å®šè·¯å¾„è§£æä¸ºç›¸å…³ç›®å½•é¡¹å¯¹è±¡</li></ul><p>ä¸¾ä¾‹è¯´æ˜ï¼Œå‡è®¾ä½ éœ€è¦åœ¨è‡ªå·±ç›®å½•ä¸­ç¼–è¯‘ä¸€ä¸ªæºæ–‡ä»¶ï¼Œ/home/dracula/src/the_sun _sucks.cï¼Œæ¯ä¸€æ¬¡å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ï¼ˆæ¯”å¦‚è¯´ï¼Œé¦–å…ˆè¦æ‰“å¼€å®ƒï¼Œç„¶åè¦å­˜å‚¨å®ƒï¼Œè¿˜è¦è¿›è¡Œç¼–è¯‘ç­‰ï¼‰ï¼ŒVFS éƒ½å¿…é¡»æ²¿ç€åµŒå¥—çš„ç›®å½•ä¾æ¬¡è§£æå…¨éƒ¨è·¯å¾„ï¼š/ã€homeã€draculaã€src å’Œæœ€ç»ˆçš„ the_sun_sucks.cã€‚ä¸ºäº†é¿å…æ¯æ¬¡è®¿é—®è¯¥è·¯å¾„åéƒ½è¿›è¡Œè¿™ç§è€—æ—¶çš„æ“ä½œï¼ŒVFS ä¼šå…ˆåœ¨ç›®å½•é¡¹ç¼“å­˜ä¸­æœç´¢è·¯å¾„åï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ— é¡»èŠ±è´¹é‚£ä¹ˆå¤§çš„åŠ›æ°”äº†ã€‚ç›¸åï¼Œå¦‚æœè¯¥ç›®å½•é¡¹åœ¨ç›®å½•é¡¹ç¼“å­˜ä¸­å¹¶ä¸å­˜åœ¨ï¼ŒVFS å°±å¿…é¡»è‡ªå·±é€šè¿‡éå†æ–‡ä»¶ç³»ç»Ÿä¸ºæ¯ä¸ªè·¯å¾„åˆ†é‡è§£æè·¯å¾„ï¼Œè§£æå®Œæ¯•åï¼Œå†å°†ç›®å½•é¡¹å¯¹è±¡åŠ å…¥ dcache ä¸­ï¼Œä»¥ä¾¿ä»¥åå¯ä»¥å¿«é€ŸæŸ¥æ‰¾åˆ°å®ƒã€‚</p><p>è€Œ dcache åœ¨ä¸€å®šæ„ä¹‰ä¸Šä¹Ÿæä¾›å¯¹ç´¢å¼•èŠ‚ç‚¹çš„ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ icacheã€‚å’Œç›®å½•é¡¹å¯¹è±¡ç›¸å…³çš„ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºç›®å½•é¡¹ä¼šè®©ç›¸å…³ç´¢å¼•èŠ‚ç‚¹çš„ä½¿ç”¨è®¡æ•°ä¸ºæ­£ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿ç´¢å¼•èŠ‚ç‚¹ç•™åœ¨å†…å­˜ä¸­ã€‚åªè¦ç›®å½•é¡¹è¢«ç¼“å­˜ï¼Œå…¶ç›¸åº”çš„ç´¢å¼•èŠ‚ç‚¹ä¹Ÿå°±è¢«ç¼“å­˜äº†ã€‚</p><p>å› ä¸ºæ–‡ä»¶è®¿é—®å‘ˆç°ç©ºé—´å’Œæ—¶é—´çš„å±€éƒ¨æ€§ï¼Œæ‰€ä»¥å¯¹ç›®å½•é¡¹å’Œç´¢å¼•èŠ‚ç‚¹è¿›è¡Œç¼“å­˜éå¸¸æœ‰ç›Šã€‚</p><h3 id="ç›®å½•é¡¹æ“ä½œ">ç›®å½•é¡¹æ“ä½œ</h3><p>dentry_operation ç»“æ„ä½“æŒ‡æ˜äº† VFS æ“ä½œç›®å½•é¡¹çš„æ‰€æœ‰æ–¹æ³•ã€‚è¯¥ç»“æ„å®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/dcache.hã€‹ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> {</span></span><br><span class="line"><span class="type">int</span> (*d_revalidate)(<span class="keyword">struct</span> dentry *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*d_weak_revalidate)(<span class="keyword">struct</span> dentry *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*d_hash)(<span class="type">const</span> <span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> qstr *);</span><br><span class="line"><span class="type">int</span> (*d_compare)(<span class="type">const</span> <span class="keyword">struct</span> dentry *,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="keyword">struct</span> qstr *);</span><br><span class="line"><span class="type">int</span> (*d_delete)(<span class="type">const</span> <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">int</span> (*d_init)(<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">void</span> (*d_release)(<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">void</span> (*d_prune)(<span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="type">void</span> (*d_iput)(<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> inode *);</span><br><span class="line"><span class="type">char</span> *(*d_dname)(<span class="keyword">struct</span> dentry *, <span class="type">char</span> *, <span class="type">int</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *(*<span class="title">d_automount</span>)(<span class="keyword">struct</span> <span class="title">path</span> *);</span></span><br><span class="line"><span class="type">int</span> (*d_manage)(<span class="type">const</span> <span class="keyword">struct</span> path *, <span class="type">bool</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *(*<span class="title">d_real</span>)(<span class="keyword">struct</span> <span class="title">dentry</span> *, <span class="title">const</span> <span class="keyword">struct</span> <span class="title">inode</span> *);</span></span><br><span class="line">} ____cacheline_aligned;</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢ç»™å‡ºå‡½æ•°çš„å…·ä½“ç”¨æ³•ï¼š</p><ul><li>d_revalidate: è¯¥å‡½æ•°åˆ¤æ–­ç›®å½•å¯¹è±¡æ˜¯å¦æœ‰æ•ˆã€‚VFS å‡†å¤‡ä» dcache ä¸­ä½¿ç”¨ä¸€ä¸ªç›®å½•é¡¹æ—¶ï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚å¤§éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿå°†è¯¥æ–¹æ³•ç½® NULLï¼Œå› ä¸ºå®ƒä»¬è®¤ä¸º dcache ä¸­çš„ç›®å½•é¡¹å¯¹è±¡æ€»æ˜¯æœ‰æ•ˆçš„</li><li>d_hash: è¯¥å‡½æ•°ä¸ºç›®å½•é¡¹ç”Ÿæˆæ•£åˆ—å€¼ï¼Œå½“ç›®å½•é¡¹éœ€è¦åŠ å…¥åˆ°æ•£åˆ—è¡¨ä¸­æ—¶ï¼ŒVF è°ƒç”¨è¯¥å‡½æ•°</li><li>d_compare: VFS è°ƒç”¨è¯¥å‡½æ•°æ¥æ¯”è¾ƒ namel å’Œ name2 è¿™ä¸¤ä¸ªæ–‡ä»¶åã€‚å¤šæ•°æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ VFS é»˜è®¤çš„æ“ä½œï¼Œä»…ä»…ä½œå­—ç¬¦ä¸²æ¯”è¾ƒã€‚å¯¹æœ‰äº›æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚ FATï¼Œç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒä¸èƒ½æ»¡è¶³å…¶éœ€è¦ã€‚å› ä¸º FAT æ–‡ä»¶ç³»ç»Ÿä¸åŒºåˆ†å¤§å°å†™ï¼Œæ‰€ä»¥éœ€è¦å®ç°ä¸€ç§ä¸åŒºåˆ†å¤§å°å†™çš„å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°ã€‚æ³¨æ„ä½¿ç”¨è¯¥å‡½æ•°æ—¶éœ€è¦åŠ  dcache_lock é”</li><li>d_delete: å½“ç›®å½•é¡¹å¯¹è±¡çš„ d_count è®¡æ•°å€¼ç­‰äº O æ—¶ï¼ŒVFS è°ƒç”¨è¯¥å‡½æ•°ã€‚æ³¨æ„ä½¿ç”¨è¯¥å‡½æ•°éœ€è¦åŠ  dcache_lock é”å’Œç›®å½•é¡¹çš„ d_lock</li><li>d_release: å½“ç›®å½•é¡¹å¯¹è±¡å°†è¦è¢«é‡Šæ”¾æ—¶ï¼ŒVFS è°ƒç”¨è¯¥å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»€ä¹ˆä¹Ÿä¸åš</li><li>d_iput: å½“ä¸€ä¸ªç›®å½•é¡¹å¯¹è±¡ä¸¢å¤±äº†å…¶ç›¸å…³çš„ç´¢å¼•èŠ‚ç‚¹æ—¶ï¼ˆä¹Ÿå°±æ˜¯è¯´ç£ç›˜ç´¢å¼•èŠ‚ç‚¹è¢«åˆ é™¤äº†ï¼‰ï¼ŒVFS è°ƒç”¨è¯¥å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ VFS ä¼šè°ƒç”¨ iput() å‡½æ•°é‡Šæ”¾ç´¢å¼•èŠ‚ç‚¹ã€‚å¦‚æœæ–‡ä»¶ç³»ç»Ÿé‡è½½äº†è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆé™¤äº†æ‰§è¡Œæ­¤æ–‡ä»¶ç³»ç»Ÿç‰¹æ®Šçš„å·¥ä½œå¤–ï¼Œè¿˜å¿…é¡»è°ƒç”¨ iput() å‡½æ•°</li></ul><h2 id="æ–‡ä»¶å¯¹è±¡">æ–‡ä»¶å¯¹è±¡</h2><p>VFS çš„æœ€åä¸€ä¸ªä¸»è¦å¯¹è±¡æ˜¯æ–‡ä»¶å¯¹è±¡ã€‚æ–‡ä»¶å¯¹è±¡è¡¨ç¤ºè¿›ç¨‹å·²æ‰“å¼€çš„æ–‡ä»¶ã€‚æ–‡ä»¶å¯¹è±¡åŒ…å«æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ä¿¡æ¯ï¼ˆå¦‚è®¿é—®æ¨¡å¼ï¼Œå½“å‰åç§»ç­‰ï¼‰ï¼ŒåŒæ ·é“ç†ï¼Œæ–‡ä»¶æ“ä½œå’Œæˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ç³»ç»Ÿè°ƒç”¨ read() å’Œ write() ç­‰ä¹Ÿå¾ˆç±»ä¼¼ã€‚æ–‡ä»¶å¯¹è±¡æ˜¯å·²æ‰“å¼€çš„æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºã€‚è¯¥å¯¹è±¡ï¼ˆä¸æ˜¯ç‰©ç†æ–‡ä»¶ï¼‰ç”±ç›¸åº”çš„ open() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºï¼Œç”± close() ç³»ç»Ÿè°ƒç”¨æ’¤é”€ï¼Œæ‰€æœ‰è¿™äº›æ–‡ä»¶ç›¸å…³çš„è°ƒç”¨å®é™…ä¸Šéƒ½æ˜¯æ–‡ä»¶æ“ä½œè¡¨ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚å› ä¸ºå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€å’Œæ“ä½œåŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥åŒä¸€ä¸ªæ–‡ä»¶ä¹Ÿå¯èƒ½å­˜åœ¨å¤šä¸ªå¯¹åº”çš„æ–‡ä»¶å¯¹è±¡ã€‚æ–‡ä»¶å¯¹è±¡ä»…ä»…åœ¨è¿›ç¨‹è§‚ç‚¹ä¸Šä»£è¡¨å·²æ‰“å¼€æ–‡ä»¶ï¼Œå®ƒåè¿‡æ¥æŒ‡å‘ç›®å½•é¡¹å¯¹è±¡ï¼ˆåè¿‡æ¥æŒ‡å‘ç´¢å¼•èŠ‚ç‚¹ï¼‰ï¼Œå…¶å®åªæœ‰ç›®å½•é¡¹å¯¹è±¡æ‰è¡¨ç¤ºå·²æ‰“å¼€çš„å®é™…æ–‡ä»¶ã€‚è™½ç„¶ä¸€ä¸ªæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡ä¸æ˜¯å”¯ä¸€çš„ï¼Œä½†å¯¹åº”çš„ç´¢å¼•èŠ‚ç‚¹å’Œç›®å½•é¡¹å¯¹è±¡æ— ç–‘æ˜¯å”¯ä¸€çš„ã€‚ æ–‡ä»¶å¯¹è±¡ç”± file ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs.hã€‹ä¸­ï¼Œä¸‹é¢ç»™å‡ºè¯¥ç»“æ„ä½“å’Œå„é¡¹çš„æè¿°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span><span class="title">fu_llist</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">fu_rcuhead</span>;</span></span><br><span class="line">} f_u;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span><span class="title">f_path</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span>*<span class="title">f_inode</span>;</span><span class="comment">/* cached value */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Protects f_ep, f_flags.</span></span><br><span class="line"><span class="comment"> * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">spinlock_t</span>f_lock;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span><span class="title">f_write_hint</span>;</span></span><br><span class="line"><span class="type">atomic_long_t</span>f_count;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> f_flags;</span><br><span class="line"><span class="type">fmode_t</span>f_mode;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">f_pos_lock</span>;</span></span><br><span class="line"><span class="type">loff_t</span>f_pos;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span><span class="title">f_owner</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>*<span class="title">f_cred</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span><span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">u64f_version;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="type">void</span>*f_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line"><span class="type">void</span>*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line"><span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>*<span class="title">f_ep</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>*<span class="title">f_mapping</span>;</span></span><br><span class="line"><span class="type">errseq_t</span>f_wb_err;</span><br><span class="line"><span class="type">errseq_t</span>f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">} __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br></pre></td></tr></tbody></table></figure><p>ç±»ä¼¼äºç›®å½•é¡¹å¯¹è±¡ï¼Œæ–‡ä»¶å¯¹è±¡å®é™…ä¸Šæ²¡æœ‰å¯¹åº”çš„ç£ç›˜æ•°æ®ã€‚æ‰€ä»¥åœ¨ç»“æ„ä½“ä¸­æ²¡æœ‰ä»£è¡¨å…¶å¯¹è±¡æ˜¯å¦ä¸ºè„ã€æ˜¯å¦éœ€è¦å†™å›ç£ç›˜çš„æ ‡å¿—ã€‚æ–‡ä»¶å¯¹è±¡é€šè¿‡ f_dentry æŒ‡é’ˆæŒ‡å‘ç›¸å…³çš„ç›®å½•é¡¹å¯¹è±¡ã€‚ç›®å½•é¡¹ä¼šæŒ‡å‘ç›¸å…³çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œç´¢å¼•èŠ‚ç‚¹ä¼šè®°å½•æ–‡ä»¶æ˜¯å¦æ˜¯è„çš„ã€‚</p><h3 id="æ–‡ä»¶æ“ä½œ">æ–‡ä»¶æ“ä½œ</h3><p>å’Œ VFS çš„å…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œæ–‡ä»¶æ“ä½œè¡¨åœ¨æ–‡ä»¶å¯¹è±¡ä¸­ä¹Ÿéå¸¸é‡è¦ã€‚è·Ÿ file ç»“æ„ä½“ç›¸å…³çš„æ“ä½œä¸ç³»ç»Ÿè°ƒç”¨å¾ˆç±»ä¼¼ï¼Œè¿™äº›æ“ä½œæ˜¯æ ‡å‡† Unix ç³»ç»Ÿè°ƒç”¨çš„åŸºç¡€ã€‚ æ–‡ä»¶å¯¹è±¡çš„æ“ä½œç”± file_operations ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶&lt;linux/fs.h&gt;ä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line"><span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line"><span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line"><span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line"><span class="type">int</span> (*iopoll)(<span class="keyword">struct</span> kiocb *kiocb, <span class="type">bool</span> spin);</span><br><span class="line"><span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line"><span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line"><span class="type">__poll_t</span> (*poll) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *);</span><br><span class="line"><span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line"><span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line"><span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line"><span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line"><span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line"><span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line"><span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line"><span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line"><span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line"><span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">  <span class="type">loff_t</span> len);</span><br><span class="line"><span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line"><span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line"><span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">loff_t</span> (*remap_file_range)(<span class="keyword">struct</span> file *file_in, <span class="type">loff_t</span> pos_in,</span><br><span class="line">   <span class="keyword">struct</span> file *file_out, <span class="type">loff_t</span> pos_out,</span><br><span class="line">   <span class="type">loff_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> remap_flags);</span><br><span class="line"><span class="type">int</span> (*fadvise)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä¸ºæ¯ä¸€ç§æ“ä½œåšä¸“é—¨çš„å®ç°ï¼Œæˆ–è€…å¦‚æœå­˜åœ¨é€šç”¨æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šç”¨æ“ä½œã€‚ä¸€èˆ¬åœ¨åŸºäº Unix çš„æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œè¿™äº›é€šç”¨æ“ä½œæ•ˆæœéƒ½ä¸é”™ã€‚å¹¶ä¸è¦æ±‚å®é™…æ–‡ä»¶ç³»ç»Ÿå®ç°æ–‡ä»¶æ“ä½œå‡½æ•°è¡¨ä¸­çš„æ‰€æœ‰æ–¹æ³•â€”ä¸€è™½ç„¶ä¸å®ç°æœ€åŸºç¡€çš„é‚£äº›æ“ä½œæ˜¾ç„¶æ˜¯å¾ˆä¸æ˜æ™ºçš„ï¼Œå¯¹ä¸æ„Ÿå…´è¶£çš„æ“ä½œå®Œå…¨å¯ä»¥ç®€å•åœ°å°†è¯¥å‡½æ•°æŒ‡é’ˆç½®ä¸º NULLã€‚ ä¸‹é¢ç»™å‡ºæ“ä½œçš„ç”¨æ³•è¯´æ˜ï¼š</p><ul><li>lleek: è¯¥å‡½æ•°ç”¨äºæ›´æ–°åç§»é‡æŒ‡é’ˆï¼Œç”±ç³»ç»Ÿè°ƒç”¨ lleek() è°ƒç”¨å®ƒ</li><li>read: è¯¥å‡½æ•°ä»ç»™å®šæ–‡ä»¶çš„ offset åç§»å¤„è¯»å– conut å­—èŠ‚çš„æ•°æ®åˆ° buf ä¸­ï¼ŒåŒæ—¶æ›´æ–°æ–‡ä»¶æŒ‡é’ˆã€‚ç”±ç³»ç»Ÿè°ƒç”¨ read() è°ƒç”¨å®ƒ</li><li>aio_read: è¯¥å‡½æ•°ä» iocb æè¿°çš„æ–‡ä»¶é‡Œï¼Œä»¥åŒæ­¥æ–¹å¼è¯»å– count å­—èŠ‚çš„æ•°æ®åˆ° buf ä¸­ã€‚ç”±ç³»ç»Ÿè°ƒç”¨ aio_read() è°ƒç”¨å®ƒ</li><li>write: è¯¥å‡½æ•°ä»ç»™å®šçš„ buf ä¸­å–å‡º conut å­—èŠ‚çš„æ•°æ®ï¼Œå†™å…¥ç»™å®šæ–‡ä»¶çš„ offset åç§»å¤„ï¼ŒåŒæ—¶æ›´æ–°æ–‡ä»¶æŒ‡é’ˆã€‚ç”±ç³»ç»Ÿè°ƒç”¨ write() è°ƒç”¨å®ƒ</li><li>aio_write: è¯¥å‡½æ•°ä»¥åŒæ­¥æ–¹å¼ä»ç»™å®šçš„ buf ä¸­å–å‡º conut å­—èŠ‚çš„æ•°æ®ï¼Œå†™å…¥ç”± iocb æè¿°çš„æ–‡ä»¶ä¸­ã€‚ç”±ç³»ç»Ÿè°ƒç”¨ aio_write() è°ƒç”¨å®ƒ</li><li>readdir: è¯¥å‡½æ•°è¿”å›ç›®å½•åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªç›®å½•ã€‚ç”±ç³»ç»Ÿè°ƒç”¨ readdir() è°ƒç”¨å®ƒ</li><li>poll: è¯¥å‡½æ•°ç¡çœ ç­‰å¾…ç»™å®šæ–‡ä»¶æ´»åŠ¨ã€‚ç”±ç³»ç»Ÿè°ƒç”¨ poll() è°ƒç”¨å®ƒ</li><li>ioctl: è¯¥å‡½æ•°ç”¨æ¥ç»™è®¾å¤‡å‘é€å‘½ä»¤å‚æ•°å¯¹ã€‚å½“æ–‡ä»¶æ˜¯ä¸€ä¸ªè¢«æ‰“å¼€çš„è®¾å¤‡èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥é€šè¿‡å®ƒè¿›è¡Œè®¾ç½®æ“ä½œã€‚ç”±ç³»ç»Ÿè°ƒç”¨ ioctl() è°ƒç”¨å®ƒã€‚è°ƒç”¨è€…å¿…é¡»æŒæœ‰ BKL</li><li>unlocked_ioctl: å…¶å®ç°ä¸ ioctl() æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œåªä¸è¿‡ä¸éœ€è¦è°ƒç”¨è€…æŒæœ‰ BKLã€‚å¦‚æœç”¨æˆ·ç©ºé—´è°ƒç”¨ ioctl() ç³»ç»Ÿè°ƒç”¨ï¼ŒVFS ä¾¿å¯ä»¥è°ƒç”¨ unlocked_ioctl()ï¼ˆå‡¡æ˜¯ ioctl() å‡ºç°çš„åœºæ‰€ï¼‰ã€‚å› æ­¤æ–‡ä»¶ç³»ç»Ÿåªéœ€è¦å®ç°å…¶ä¸­çš„ä¸€ä¸ªï¼Œä¸€èˆ¬ä¼˜å…ˆå®ç° unlocked_ioctl()</li><li>...</li></ul><h1 id="å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„">å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„</h1><p>é™¤äº†ä»¥ä¸Šå‡ ç§ VFS åŸºç¡€å¯¹è±¡å¤–ï¼Œå†…æ ¸è¿˜ä½¿ç”¨äº†å¦å¤–ä¸€äº›æ ‡å‡†æ•°æ®ç»“æ„æ¥ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–ç›¸å…³æ•°æ®ã€‚ç¬¬ä¸€ä¸ªå¯¹è±¡æ˜¯ file_system_typeï¼Œç”¨æ¥æè¿°å„ç§ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œæ¯”å¦‚ ext3ã€ext4 æˆ– UDFã€‚ç¬¬äºŒä¸ªç»“æ„ä½“æ˜¯ vfsmountï¼Œç”¨æ¥æè¿°ä¸€ä¸ªå®‰è£…æ–‡ä»¶ç³»ç»Ÿçš„å®ä¾‹ã€‚</p><p>å› ä¸º Linux æ”¯æŒä¼—å¤šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥å†…æ ¸å¿…é¡»ç”±ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„æ¥æè¿°æ¯ç§æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½å’Œè¡Œä¸ºã€‚file_system_type ç»“æ„ä½“è¢«å®šä¹‰åœ¨ã€Šlinux/fs.hã€‹ä¸­ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="type">int</span> fs_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_REQUIRES_DEV1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_BINARY_MOUNTDATA2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_HAS_SUBTYPE4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_USERNS_MOUNT8<span class="comment">/* Can be mounted by userns root */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_DISALLOW_NOTIFY_PERM16<span class="comment">/* Disable fanotify permission events */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_ALLOW_IDMAP         32      <span class="comment">/* FS has been updated to handle vfs idmappings. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_THP_SUPPORT8192<span class="comment">/* Remove once all fs converted */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_RENAME_DOES_D_MOVE32768<span class="comment">/* FS will handle d_move() during rename() internally. */</span></span></span><br><span class="line"><span class="type">int</span> (*init_fs_context)(<span class="keyword">struct</span> fs_context *);</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fs_parameter_spec</span> *<span class="title">parameters</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *(*<span class="title">mount</span>) (<span class="keyword">struct</span> <span class="title">file_system_type</span> *, <span class="title">int</span>,</span></span><br><span class="line"><span class="class">       <span class="title">const</span> <span class="title">char</span> *, <span class="title">void</span> *);</span></span><br><span class="line"><span class="type">void</span> (*kill_sb) (<span class="keyword">struct</span> super_block *);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> * <span class="title">next</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">fs_supers</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_lock_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_umount_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_vfs_rename_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_writers_key</span>[<span class="title">SB_FREEZE_LEVELS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_lock_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_mutex_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">invalidate_lock_key</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_mutex_dir_key</span>;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ¯ç§æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ç®¡æœ‰å¤šå°‘ä¸ªå®ä¾‹å®‰è£…åˆ°ç³»ç»Ÿä¸­ï¼Œè¿˜æ˜¯æ ¹æœ¬å°±æ²¡æœ‰å®‰è£…åˆ°ç³»ç»Ÿä¸­ï¼Œéƒ½åªæœ‰ä¸€ä¸ª file_system_type ç»“æ„ã€‚ æ›´æœ‰è¶£çš„äº‹æƒ…æ˜¯ï¼Œå½“æ–‡ä»¶ç³»ç»Ÿè¢«å®é™…å®‰è£…æ—¶ï¼Œå°†æœ‰ä¸€ä¸ª vfsmount ç»“æ„ä½“åœ¨å®‰è£…ç‚¹è¢«åˆ›å»ºã€‚è¯¥ç»“æ„ä½“ç”¨æ¥ä»£è¡¨æ–‡ä»¶ç³»ç»Ÿçš„å®ä¾‹â€”ä¸€æ¢å¥è¯è¯´ï¼Œä»£è¡¨ä¸€ä¸ªå®‰è£…ç‚¹ã€‚ vfsmount ç»“æ„è¢«å®šä¹‰åœ¨ã€Šlinux/mount.hã€‹ä¸­ï¼Œä¸‹é¢æ˜¯å…·ä½“ç»“æ„ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">mnt_root</span>;</span><span class="comment">/* root of the mounted tree */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">mnt_sb</span>;</span><span class="comment">/* pointer to superblock */</span></span><br><span class="line"><span class="type">int</span> mnt_flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">mnt_userns</span>;</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><h1 id="å’Œè¿›ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„">å’Œè¿›ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„</h1><p>ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„æ‰“å¼€çš„æ–‡ä»¶ï¼Œåƒæ ¹æ–‡ä»¶ç³»ç»Ÿã€å½“å‰å·¥ä½œç›®å½•ã€å®‰è£…ç‚¹ç­‰ã€‚æœ‰ä¸‰ä¸ªæ•°æ®ç»“æ„å°† VFS å±‚å’Œç³»ç»Ÿçš„è¿›ç¨‹ç´§å¯†è”ç³»åœ¨ä¸€èµ·ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼šfile_structã€fs_struct ç»“æ„ä½“ã€‚ file_struct ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fdtable.hã€‹ä¸­ã€‚è¯¥ç»“æ„ä½“ç”±è¿›ç¨‹æè¿°ç¬¦ä¸­çš„ files ç›®å½•é¡¹æŒ‡å‘ã€‚æ‰€æœ‰ä¸å•ä¸ªè¿›ç¨‹ï¼ˆper-processï¼‰ç›¸å…³çš„ä¿¡æ¯ã€ï¼ˆå¦‚æ‰“å¼€çš„æ–‡ä»¶åŠæ–‡ä»¶æè¿°ç¬¦ï¼‰éƒ½åŒ…å«åœ¨å…¶ä¸­ï¼Œå…¶ç»“æ„å’Œæè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> {</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * read mostly part</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="type">atomic_t</span> count;</span><br><span class="line"><span class="type">bool</span> resize_in_progress;</span><br><span class="line"><span class="type">wait_queue_head_t</span> resize_wait;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * written part on a separate cache line in SMP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="type">spinlock_t</span> file_lock ____cacheline_aligned_in_smp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> next_fd;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> close_on_exec_init[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> open_fds_init[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> full_fds_bits_init[<span class="number">1</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>fd_array æ•°ç»„æŒ‡é’ˆæŒ‡å‘å·²æ‰“å¼€çš„æ–‡ä»¶å¯¹è±¡ã€‚å› ä¸º NR_OPEN_DEFAULT ç­‰äº BITS_PER_LONGï¼Œåœ¨ 64 ä½æœºå™¨ä½“ç³»ç»“æ„ä¸­è¿™ä¸ªå®çš„å€¼ä¸º 64ï¼Œæ‰€ä»¥è¯¥æ•°ç»„å¯ä»¥å®¹çº³ 64 ä¸ªæ–‡ä»¶å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶å¯¹è±¡è¶…è¿‡ 6 ä¸ªï¼Œå†…æ ¸å°†åˆ†é…ä¸€ä¸ªæ–°æ•°ç»„ï¼Œå¹¶ä¸”å°† fdt æŒ‡é’ˆæŒ‡å‘å®ƒã€‚æ‰€ä»¥å¯¹é€‚å½“æ•°é‡çš„æ–‡ä»¶å¯¹è±¡çš„è®¿é—®ä¼šæ‰§è¡Œå¾—å¾ˆå¿«ï¼Œå› ä¸ºå®ƒæ˜¯å¯¹é™æ€æ•°ç»„è¿›è¡Œçš„æ“ä½œï¼›å¦‚æœä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆå†…æ ¸å°±éœ€è¦å»ºç«‹æ–°æ•°ç»„ã€‚æ‰€ä»¥å¦‚æœç³»ç»Ÿä¸­æœ‰å¤§é‡çš„è¿›ç¨‹éƒ½è¦æ‰“å¼€è¶…è¿‡ 6 ä¸ªæ–‡ä»¶ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œç®¡ç†å‘˜å¯ä»¥é€‚å½“å¢å¤§ NR_OPEN_DEFAULT çš„é¢„å®šä¹‰å€¼ã€‚ å’Œè¿›ç¨‹ç›¸å…³çš„ç¬¬äºŒä¸ªç»“æ„ä½“æ˜¯ fs_struct. è¯¥ç»“æ„ç”±è¿›ç¨‹æè¿°ç¬¦çš„ fs åŸŸæŒ‡å‘ã€‚å®ƒåŒ…å«æ–‡ä»¶ç³»ç»Ÿå’Œè¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/fs_struct.hã€‹ä¸­ï¼Œä¸‹é¢æ˜¯å®ƒçš„å…·ä½“ç»“æ„ä½“å’Œå„é¡¹æè¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> {</span></span><br><span class="line"><span class="type">int</span> users;</span><br><span class="line"><span class="type">spinlock_t</span> lock;</span><br><span class="line"><span class="type">seqcount_spinlock_t</span> seq;</span><br><span class="line"><span class="type">int</span> umask;</span><br><span class="line"><span class="type">int</span> in_exec;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">root</span>, <span class="title">pwd</span>;</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>è¯¥ç»“æ„åŒ…å«äº†å½“å‰è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ï¼ˆpwdï¼‰å’Œæ ¹ç›®å½•ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> FileSystem </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆä¸€ï¼‰åŸºæœ¬æ¦‚å¿µ</title>
      <link href="/2021/LinuxKernel/LinuxFileSystemBasic/"/>
      <url>/2021/LinuxKernel/LinuxFileSystemBasic/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/FSBasic.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjNhYjMyOTFlMDg1MzA2ZjhjZDczYTk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><blockquote><p>å£°æ˜ï¼šæœ¬æ–‡è½¬è½½è‡ª <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDY0NTk0NDU=">æ–‡ä»¶ç³»ç»Ÿçš„åŸç†<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDAzMjkxNzc=">Linux ä¸­çš„ VFS å®ç° [ä¸€]<i class="fa fa-external-link-alt"></i></span></p></blockquote><p>æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œè®¿é—®ç£ç›˜ä¸Šçš„æ•°æ®å°±éœ€è¦ç›´æ¥è¯»å†™ç£ç›˜çš„ sectorï¼ˆç¹çï¼‰ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿå­˜åœ¨çš„æ„ä¹‰ï¼Œå°±æ˜¯èƒ½æ›´æœ‰æ•ˆçš„ç»„ç»‡ã€ç®¡ç†å’Œä½¿ç”¨ç£ç›˜ä¸Šçš„ raw dataã€‚</p><h1 id="æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆ">æ–‡ä»¶ç³»ç»Ÿçš„ç»„æˆ</h1><p>å› ä¸ºç£ç›˜ä¸Šçš„æ•°æ®è¦å’Œå†…å­˜äº¤äº’ï¼Œè€Œå†…å­˜é€šå¸¸æ˜¯ä»¥ 4KB ä¸ºå•ä½ç®¡ç†çš„ï¼Œæ‰€ä»¥æŠŠç£ç›˜æŒ‰ç…§ 4KB åˆ’åˆ†æ¯”è¾ƒæ–¹ä¾¿ï¼ˆç§°ä¸ºä¸€ä¸ª blockï¼‰ã€‚ç°åœ¨å‡è®¾ç”±ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç®¡ç† 64 ä¸ª blocks çš„ä¸€ä¸ªç£ç›˜åŒºåŸŸï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem1.png"></p><h2 id="æ–‡ä»¶">æ–‡ä»¶</h2><p>æ–‡ä»¶ç³»ç»Ÿçš„åŸºç¡€è¦ç´ è‡ªç„¶æ˜¯æ–‡ä»¶ï¼Œè€Œæ–‡ä»¶ä½œä¸ºä¸€ä¸ªæ•°æ®å®¹å™¨çš„é€»è¾‘æ¦‚å¿µï¼Œæœ¬è´¨ä¸Šæ˜¯å­—èŠ‚æ„æˆçš„é›†åˆï¼Œè¿™äº›å­—èŠ‚å°±æ˜¯æ–‡ä»¶çš„ user dataï¼ˆå¯¹åº”ä¸‹å›¾çš„"D"ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem2.jpg"></p><p>é™¤äº†æ–‡ä»¶æœ¬èº«åŒ…å«çš„æ•°æ®ï¼Œè¿˜æœ‰æ–‡ä»¶çš„è®¿é—®æƒé™ã€å¤§å°å’Œåˆ›å»ºæ—¶é—´ç­‰æ§åˆ¶ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ç§°ä¸ºæ–‡ä»¶çš„ meta dataã€‚è¿™äº› meta data çš„æ•°æ®ç»“æ„å°±æ˜¯ inodeï¼ˆå¯¹åº”ä¸‹å›¾çš„"I"ï¼Œæœ‰äº›æ–‡ä»¶ç³»ç»Ÿç§°ä¹‹ä¸º dnode æˆ– fnodeï¼‰ã€‚</p><p>å‡è®¾ä¸€ä¸ª inode å æ® 256 å­—èŠ‚ï¼Œé‚£ä¹ˆä¸€ä¸ª 4KB çš„ block å¯ä»¥å­˜æ”¾ 16 ä¸ª inodesï¼Œä½¿ç”¨ 5 ä¸ª blocks å¯ä»¥å­˜æ”¾ 80 ä¸ª inodesï¼Œä¹Ÿå°±æ˜¯æœ€å¤šæ”¯æŒ 80 ä¸ªæ–‡ä»¶ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem3.jpg"></p><h2 id="bitmap">bitmap</h2><p>éœ€è¦è¿½è¸ªè¿™äº› inodes å’Œ data blocks çš„åˆ†é…å’Œé‡Šæ”¾æƒ…å†µï¼Œåˆ¤æ–­å“ªäº›æ˜¯å·²ç”¨çš„ï¼Œå“ªäº›æ˜¯ç©ºé—²çš„ã€‚æœ€ç®€å•çš„åŠæ³•å°±æ˜¯ä½¿ç”¨ bitmapï¼ŒåŒ…æ‹¬è®°å½• inode ä½¿ç”¨æƒ…å†µçš„ bitmapï¼ˆå¯¹åº”ä¸‹å›¾çš„"i"ï¼‰ï¼Œå’Œè®°å½• data block ä½¿ç”¨æƒ…å†µçš„ bitmapï¼ˆå¯¹åº”ä¸‹å›¾çš„"d"ï¼‰ã€‚ç©ºé—²å°±æ ‡è®°ä¸º 0ï¼Œæ­£åœ¨ä½¿ç”¨å°±æ ‡è®°ä¸º 1ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem4.jpg"></p><h2 id="superblock">superblock</h2><p>superblock åŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰çš„æ§åˆ¶ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ª inodes å’Œ data blocksï¼Œinode çš„ä¿¡æ¯èµ·å§‹äºå“ªä¸ª blockï¼ˆè¿™é‡Œæ˜¯ç¬¬ 3 ä¸ªï¼‰ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ä¸åŒæ–‡ä»¶ç³»ç»Ÿç±»å‹çš„ magic numberã€‚å› æ­¤ï¼Œsuperblock å¯ç†è§£ä¸ºæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ meta dataã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem5.jpg"></p><h1 id="æ–‡ä»¶å¯»å€">æ–‡ä»¶å¯»å€</h1><h2 id="å¯»å€è¿‡ç¨‹">å¯»å€è¿‡ç¨‹</h2><p>è¿™ 5 ä¸ª blocks ä¸­çš„ 80 ä¸ª inodes æ„æˆäº†ä¸€ä¸ª inode tableã€‚å‡è®¾ä¸€ä¸ª inode çš„å¤§å°æ˜¯ 256 å­—èŠ‚ï¼Œç°åœ¨æˆ‘ä»¬è¦è®¿é—®ç¬¬ 32 ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 32 ä¸ª inode æ‰€åœ¨çš„ç£ç›˜ä½ç½®ã€‚å®ƒåº”è¯¥åœ¨ç›¸å¯¹ inode table èµ·å§‹åœ°å€çš„ 8KB å¤„ï¼ˆ32*256=8192ï¼‰ï¼Œè€Œ inode table çš„èµ·å§‹åœ°å€æ˜¯ 12KBï¼Œæ‰€ä»¥å®é™…ä½ç½®æ˜¯ 20KBã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem6.jpg"></p><p>ç£ç›˜åŒå†…å­˜ä¸åŒï¼Œå®ƒåœ¨ç‰©ç†ä¸Šä¸æ˜¯æŒ‰å­—èŠ‚å¯»å€çš„ï¼Œè€Œæ˜¯æŒ‰ sectorã€‚ä¸€ä¸ª sector çš„å¤§å°é€šå¸¸æ˜¯ 512 å­—èŠ‚ï¼Œå› æ­¤æ¢ç®—ä¸€ä¸‹å°±æ˜¯ç¬¬ 40 ä¸ª sectorï¼ˆ20*1024/512ï¼‰ã€‚æ‰¾åˆ° inode åï¼Œinode é‡Œå°±æœ‰æŒ‡é’ˆæŒ‡å‘ä¿æŒæ–‡ä»¶æ•°æ®çš„ data block å°±æŸ¥æ‰¾åˆ°äº†æ–‡ä»¶ã€‚</p><p>å¯¹äº ext2/3/4 æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ä¸Šä»‹ç»çš„è¿™äº› inode bitmap, data block bitmap å’Œ inode tableï¼Œéƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªåä¸º"dumpe2fs"çš„å·¥å…·æ¥æŸ¥çœ‹å…¶åœ¨ç£ç›˜ä¸Šçš„å…·ä½“ä½ç½®ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem7.jpg"></p><p>å¦‚æœåªéœ€è¦æŸ¥çœ‹ inode çš„ä½¿ç”¨æƒ…å†µï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨"df -i"å‘½ä»¤å³å¯ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem8.png"></p><h2 id="å¯»å€æ–¹å¼">å¯»å€æ–¹å¼</h2><p>ä¸¤ç§å¯»å€æ–¹å¼ï¼š</p><ul><li>inode é‡Œé€šè¿‡æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª blockï¼Œå‡è®¾ä¸€ä¸ª inode æœ€å¤šèƒ½åŒ…å« 12 ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆæ–‡ä»¶çš„å¤§å°ä¸èƒ½è¶…è¿‡ 48KBã€‚é‚£å¦‚æœè¶…è¿‡äº†æ€ä¹ˆåŠï¼Ÿå¯ç”± inode å…ˆæŒ‡å‘ä¸€ä¸ªä¸­é—´ blockï¼Œè¿™ä¸ª block å†æŒ‡å‘åˆ†æ•£çš„ data blockï¼Œè¿™ç§æ–¹æ³•ç§°ä¸º multi-level indexã€‚å‡è®¾ä¸€ä¸ªæŒ‡é’ˆå æ® 4 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¸€ä¸ªä¸­é—´ block å¯å­˜å‚¨ 1024 ä¸ªæŒ‡é’ˆï¼ŒäºŒçº§ index çš„å¯»å€èŒƒå›´å°±å¯è¶…è¿‡ 4MBï¼Œä¸‰çº§ index åˆ™å¯è¶…è¿‡ 4GBã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem9.jpg"></li></ul><p>è¿™ç§åªä½¿ç”¨ block æŒ‡é’ˆçš„æ–¹å¼ï¼ˆå¯è¢«ç§°ä¸º"pointer-based"ï¼‰è¢« ext2 å’Œ ext3 æ–‡ä»¶ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼Œä½†å®ƒå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹äºå æ®å¤šä¸ª data block çš„æ–‡ä»¶ï¼Œéœ€è¦è¾ƒå¤šçš„ meta dataã€‚</p><ul><li>å¦ä¸€ç§å®ç°æ˜¯ä½¿ç”¨ä¸€ä¸ª block æŒ‡é’ˆåŠ ä¸Šä¸€ä¸ª length æ¥è¡¨ç¤ºä¸€ç»„ç‰©ç†ä¸Šè¿ç»­çš„ blocksï¼ˆç§°ä¸ºä¸€ä¸ª extentï¼Œå…¶ä¸­ length ä»¥ block ä¸ºå•ä½è®¡ï¼‰ï¼Œä¸€ä¸ªæ–‡ä»¶åˆ™ç”±è‹¥å¹²ä¸ª extents æ„æˆã€‚è¿™ç§"extent-based"çš„æ–¹å¼è¢«åæ¥çš„ ext4 æ–‡ä»¶ç³»ç»Ÿæ‰€é‡‡ç”¨ã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext4_extent</span> {</span></span><br><span class="line">    __le32  ee_block;   <span class="comment">/* first logical block extent covers */</span></span><br><span class="line">    __le16  ee_len;     <span class="comment">/* number of blocks covered by extent */</span></span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç›¸æ¯”"pointer-based"è€Œè¨€ï¼Œ"extent-based"ç”±äºéœ€è¦ç£ç›˜ä¸Šè¿ç»­çš„ free spaceï¼Œçµæ´»æ€§ç¨å·®ï¼Œé€‚ç”¨äºç£ç›˜ç©ºé—²ç©ºé—´æ¯”è¾ƒå……è¶³çš„åœºæ™¯ã€‚</p><h1 id="ç›®å½•å’Œè·¯å¾„">ç›®å½•å’Œè·¯å¾„</h1><p>å„çº§ç›®å½•æ„æˆäº†è®¿é—®æ–‡ä»¶çš„è·¯å¾„ï¼Œä»æŠ½è±¡çš„è§’åº¦ï¼Œç›®å½•ä¹Ÿå¯è§†ä½œä¸€ç§æ–‡ä»¶ï¼Œåªæ˜¯è¿™ç§æ–‡ä»¶æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„ user data å­˜å‚¨çš„æ˜¯è¯¥è·¯å¾„ä¸‹çš„æ™®é€šæ–‡ä»¶çš„ inode ç¼–å·ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem10.jpg"></p><p>æ‰€ä»¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„è¿™æ ·ä¸€ä¸ªè·¯å¾„ç»“æ„ï¼Œå‡è®¾è¦åœ¨"/foo"ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶"bar.txt"ï¼Œé‚£ä¹ˆéœ€è¦ä» inode bitmap ä¸­åˆ†é…ä¸€ä¸ªç©ºé—²çš„ inodeï¼Œå¹¶åœ¨"/foo"è¿™ä¸ªç›®å½•ä¸­åˆ†é…ä¸€ä¸ª entryï¼Œä»¥å…³è”è¿™ä¸ª inode å·ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem11.jpg"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è¯»å–åˆšæ‰åˆ›å»ºçš„è¿™ä¸ª"/foo/bar.txt"æ–‡ä»¶ï¼Œé‚£ä¹ˆå…ˆå¾—æ‰¾åˆ°"/"è¿™ä¸ªç›®å½•æ–‡ä»¶çš„ inode å·ï¼ˆè¿™å¿…é¡»æ˜¯äº‹å…ˆçŸ¥é“çš„ï¼Œå‡è®¾æ˜¯ 2ï¼‰ã€‚ç„¶åè®¿é—®è¿™ä¸ª inode æŒ‡å‘çš„ data blockï¼Œä»ä¸­æ‰¾åˆ°ä¸€ä¸ªåä¸º"foo"çš„ entryï¼Œå¾—åˆ°ç›®å½•æ–‡ä»¶"foo"çš„ inode å·ï¼ˆå‡è®¾æ˜¯ 44ï¼‰ã€‚é‡å¤æ­¤è¿‡ç¨‹ï¼ŒæŒ‰å›¾ç´¢éª¥ï¼Œç›´åˆ°æ‰¾åˆ°æ–‡æœ¬æ–‡ä»¶"bar.txt"çš„ inode å·ã€‚</p><h1 id="ç”¨æˆ·çœ‹åˆ°çš„æ–‡ä»¶">ç”¨æˆ·çœ‹åˆ°çš„æ–‡ä»¶</h1><h2 id="è®¿é—®æƒé™æ§åˆ¶">è®¿é—®æƒé™æ§åˆ¶</h2><p>æ¯ä¸ªæ–‡ä»¶æœ‰ä¸‰ç§ä¸ä¹‹å…³è”çš„æƒé™ï¼Œåˆ†åˆ«æ˜¯è¯»ã€å†™å’Œæ‰§è¡Œã€‚è¯•å›¾è®¿é—®æ–‡ä»¶çš„ç”¨æˆ·ä¹Ÿåˆ’åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯æ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆuserï¼‰ã€ä¸æ‰€æœ‰è€…åœ¨åŒä¸€ç”¨æˆ·ç»„çš„ç”¨æˆ·ï¼ˆgroupï¼‰ï¼Œä»¥åŠå…¶ä»–ç”¨æˆ·ï¼ˆothersï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem12.jpg"></p><p>å¯é€šè¿‡"chmod"å‘½ä»¤ä¿®æ”¹æ–‡ä»¶çš„æƒé™ï¼Œé€šè¿‡"chown"å‘½ä»¤ä¿®æ”¹æ–‡ä»¶çš„ UID å’Œ GIDã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> {</span></span><br><span class="line">    <span class="type">kuid_t</span>    i_uid;    <span class="comment">/* user id */</span></span><br><span class="line">    <span class="type">kgid_t</span>    i_gid;    <span class="comment">/* group id */</span></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸‰ç§ timestampï¼šæ–‡ä»¶ä¸Šæ¬¡è¢«è®¿é—®çš„æ—¶é—´ï¼ˆaccess timeï¼Œç®€ç§° atimeï¼‰ã€æ–‡ä»¶ä¸Šæ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ï¼ˆmodification timeï¼Œç®€ç§° mtimeï¼‰å’Œæ–‡ä»¶å±æ€§ä¸Šæ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ï¼ˆchange timeï¼Œç®€ç§° ctimeï¼‰</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>   <span class="title">i_atime</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>   <span class="title">i_mtime</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>   <span class="title">i_ctime</span>;</span></span><br></pre></td></tr></tbody></table></figure><p>mtime é’ˆå¯¹çš„æ˜¯æ–‡ä»¶çš„å†…å®¹ï¼ˆå³ user dataï¼‰ï¼Œè€Œ ctime é’ˆå¯¹çš„æ˜¯ inode ç»“æ„è‡ªèº«ï¼ˆå³ meta dataï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem13.jpg"></p><h2 id="ç‰¹æ®Šæ–‡ä»¶">ç‰¹æ®Šæ–‡ä»¶</h2><p>ä¸Šé¢ç¤ºä¾‹çš„è¿™ä¸ªæ–‡ä»¶æ˜¯ regular fileï¼Œæ­¤å¤–ï¼Œè®¾å¤‡åœ¨ Linux ä¸­ä¹Ÿè¢«è§†ä½œæ–‡ä»¶ï¼Œä¸€ä¸ªè®¾å¤‡å¯ä»¥æ˜¯ block deviceï¼ˆå³"i_bdev"ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ character deviceï¼ˆå³"i_cdev"ï¼‰ï¼Œè€Œä¸”è®¾å¤‡è¿˜å…·æœ‰ä¸»è®¾å¤‡å·å’Œä»è®¾å¤‡å·ï¼ˆå³"i_rdev"ï¼‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">dev_t</span> i_rdev;</span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>  *<span class="title">i_pipe</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>     *<span class="title">i_bdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>             *<span class="title">i_cdev</span>;</span></span><br><span class="line">    <span class="type">char</span>                    *i_link;</span><br><span class="line">    ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œç›®å½•ï¼ˆdirectoryï¼‰ä¹Ÿè¢«è§†ä½œä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå› è€Œå®ƒæ²¡æœ‰ç‹¬ç«‹çš„æ•°æ®ç»“æ„ï¼Œä¸”åŸºäºæ–‡ä»¶çš„å¤§éƒ¨åˆ†æ“ä½œä¹Ÿå¯ç”¨äº directoryã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem14.jpg"></p><h2 id="inode-ç¼–å·å’Œ-superblock">inode ç¼–å·å’Œ superblock</h2><p>ä¸€ä¸ªæ–‡ä»¶å¿…ç„¶å¤„äºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå› è€Œä¸€ä¸ª inode ä¹Ÿå¿…ç„¶è¢«ä¸€ä¸ª superblock æ‰€ç®¡ç†ï¼ˆç”±"i_sb"æŒ‡å‘ï¼‰ã€‚åŒä¸€ superblock çš„æ‰€æœ‰ inodes ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥ï¼ˆå³"i_sb_list"ï¼‰ï¼Œæ¯ä¸ª inode åœ¨å…¶æ‰€å±çš„ superblock ä¸­æœ‰å”¯ä¸€çš„ç¼–å·ï¼ˆå³"i_ino"ï¼Œå¯¹åº”ä¸Šé¢ stat å‘½ä»¤è¾“å‡ºçš„"Inode"é¡¹ï¼‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>  *<span class="title">i_sb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>     <span class="title">i_sb_list</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>        i_ino;</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸¤ç§-link">ä¸¤ç§ link</h2><p>ä¸€ä¸ªæ–‡ä»¶å¯ä»¥æœ‰ä¸¤ç§ linkï¼šhard link å’Œ symbolic/soft linkï¼Œå¯åˆ†åˆ«é€šè¿‡"ln"å’Œ"ln -s"å‘½ä»¤åˆ›å»ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem15.png"></p><p>å®ƒä»¬çš„ inode ç¼–å·å´ä¸ç›¸åŒï¼ˆé€šè¿‡"ls -i"æŸ¥çœ‹ï¼‰ï¼Œhard link ä¸åŸæ–‡ä»¶çš„ inode å·ç›¸åŒï¼Œsoft link åˆ™æœ‰å•ç‹¬çš„ inode å·ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem17.png"></p><p>å†æ¥æŸ¥çœ‹æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem18.png"></p><p>ç°åœ¨ç”¨"rm"å‘½ä»¤åˆ é™¤åŸæ–‡ä»¶ï¼Œå¹¶é€šè¿‡ strace å·¥å…·è¿½è¸ªè¿™æœŸé—´å‘ç”Ÿçš„ç³»ç»Ÿè°ƒç”¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem19.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒè°ƒç”¨äº†"unlink"ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å«"remove"æˆ–è€…"delete"å‘¢ï¼Ÿå…ˆæ¥è¯•è¯•åˆ é™¤åŸæ–‡ä»¶ä¹‹åï¼Œè¿˜èƒ½å¦ç»§ç»­ä½¿ç”¨ hard link å’Œ soft linkã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem20.png"></p><p>hard link è¿˜å¯ä»¥æ­£å¸¸è®¿é—®åŸæ¥çš„å†…å®¹ï¼Œè€Œ soft link çš„è®¿é—®åˆ™ä¼šå¤±è´¥ã€‚è¿™ä¸€åˆ‡çš„åŸå› è¿˜å¾—ä» hard link å’Œ soft link çš„å±æ€§è¯´èµ·ã€‚</p><p>å½“åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ä¸ªè·¯å¾„ï¼ˆpathnameï¼‰ï¼Œå¹¶ä¸ºæ–‡ä»¶è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„åç§°ï¼ˆsymbolï¼‰ã€‚è¿™å…¶å®åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯ç”Ÿæˆä¸€ä¸ª inode ç»“æ„ä½“ï¼Œç”¨äºè®°å½•è¿™ä¸ªæ–‡ä»¶çš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤§å°ã€åœ¨ç£ç›˜ä¸Šå æ®çš„ blocks æ•°ç›®ç­‰ï¼ŒäºŒæ˜¯å°†ç”Ÿæˆçš„ inode å…³è”ï¼ˆlinkï¼‰äº†è¿™ä¸ªè·¯å¾„å’Œåç§°ã€‚</p><p>ä¸€ä¸ªæ–‡ä»¶çš„ hard link å¢åŠ çš„æ˜¯å¯¹è¿™ä¸ª inode ç»“æ„ä½“çš„å…³è”/æŒ‡å‘ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚è€Œ soft link æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±åƒ directory è¿™ç§ç‰¹æ®Šæ–‡ä»¶é‡Œå­˜æ”¾çš„æ˜¯è¯¥ç›®å½•ä¸‹åŒ…å«å“ªäº›æ–‡ä»¶ï¼Œsoft link è¿™ç§æ–‡ä»¶é‡Œå­˜æ”¾çš„åˆ™æ˜¯æŒ‡å‘åŸ inode çš„è·¯å¾„ï¼Œè·¯å¾„è¶Šé•¿ï¼Œsoft link çš„å¤§å°å°±è¶Šå¤§ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ hard link å’ŒåŸæ–‡ä»¶çš„ inode å·ç›¸åŒï¼Œè€Œ soft link ä¸åŒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/filesystem21.jpg"></p><p>å› æ­¤ï¼Œå½“æˆ‘ä»¬ç”¨"rm"å‘½ä»¤â€œåˆ é™¤â€åŸæ–‡ä»¶æ—¶ï¼Œåˆ é™¤çš„åªæ˜¯åŸæ–‡ä»¶çš„è·¯å¾„å’Œ inode ä¹‹é—´çš„å…³è”ï¼Œè€Œä¸æ˜¯è¿™ä¸ª inode æœ¬èº«ï¼Œæ–‡ä»¶çš„å†…å®¹ä¾ç„¶å­˜åœ¨äºç£ç›˜ä¸­ï¼Œå› è€Œåªèƒ½ç®—æ˜¯"unlink"ã€‚æ‰€ä»¥ç›´æ¥å…³è” inode çš„ hard link ä¸å—å½±å“ï¼Œè€Œå…³è”åŸæ–‡ä»¶è·¯å¾„çš„ soft link æ­¤æ—¶ç›¸å½“äºæ˜¯ä¸€ä¸ª dangling referenceã€‚</p><p>ä¸€ä¸ª inode è¢« link çš„æ•°ç›®ç”±"i_nlink"è¡¨ç¤ºï¼ˆè¿™å°±æ˜¯å‰é¢"ls -l"å‘½ä»¤è¾“å‡ºä¸­ç¬¬äºŒåˆ—æ•°å€¼çš„å«ä¹‰ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i_nlink;</span><br></pre></td></tr></tbody></table></figure><p>ç›¸æ¯”èµ· soft linkï¼Œhard link åœ¨ä½¿ç”¨çš„æ—¶å€™æœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯å¿…é¡»å’ŒåŸæ–‡ä»¶ä½äºç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŸå› è¿˜æ˜¯å’Œ inode ç¼–å·æœ‰å…³ã€‚å› ä¸ºä¸€ä¸ª inode ç¼–å·åªåœ¨æ–‡ä»¶æ‰€å±çš„ superblock ä¸­æ˜¯å”¯ä¸€çš„ï¼Œè€Œ hard link ä½¿ç”¨å’ŒåŸæ–‡ä»¶ç›¸åŒçš„ inode ç¼–å·ï¼Œå¦‚æœ hard link è·‘åˆ°å…¶ä»–æ–‡ä»¶ç³»ç»Ÿï¼Œå°±å¯èƒ½å’Œè¿™äº›æ–‡ä»¶ç³»ç»Ÿä¸­æ—¢æœ‰çš„æ–‡ä»¶ inode ç¼–å·å†²çªã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDY0NTk0NDU=">https://zhuanlan.zhihu.com/p/106459445<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDAzMjkxNzc=">https://zhuanlan.zhihu.com/p/100329177<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> FileSystem </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆäºŒï¼‰å— I/O</title>
      <link href="/2021/LinuxKernel/LinuxFileSystemblockIO/"/>
      <url>/2021/LinuxKernel/LinuxFileSystemblockIO/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/LinuxFSBlockI_O.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjNhZTkxMTA3OTEyOTA2ZjUxNDZjODg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><p>ç³»ç»Ÿä¸­èƒ½å¤Ÿéšæœºè®¿é—®å›ºå®šå¤§å°æ•°æ®ç‰‡çš„ç¡¬ä»¶è®¾å¤‡ç§°ä½œå—è®¾å¤‡ï¼Œè¿™äº›å›ºå®šå¤§å°çš„æ•°æ®ç‰‡å°±ç§°ä½œå—ã€‚å¦ä¸€ç§åŸºæœ¬çš„è®¾å¤‡ç±»å‹æ˜¯å­—ç¬¦è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æŒ‰ç…§å­èŠ‚æµçš„æ–¹å¼è¢«æœ‰åºè®¿é—®ï¼Œåƒä¸²å£å’Œé”®ç›˜å°±å±äºå­—ç¬¦è®¾å¤‡ã€‚å¯¹äºè¿™ä¸¤ç§ç±»å‹çš„è®¾å¤‡ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºæ˜¯å¦å¯ä»¥éšæœºè®¿é—®æ•°æ®ã€‚</p><span id="more"></span><h1 id="å‰–æä¸€ä¸ªå—è®¾å¤‡">å‰–æä¸€ä¸ªå—è®¾å¤‡</h1><p>å—è®¾å¤‡ä¸­æœ€å°çš„å¯å¯»å€å•å…ƒæ˜¯æ‰‡åŒºï¼ˆsectorï¼‰ã€‚æ‰‡åŒºå¤§å°ä¸€èˆ¬æ˜¯ 2 çš„æ•´æ•°å€ï¼Œè€Œæœ€å¸¸è§çš„æ˜¯ 512 å­—èŠ‚ã€‚æ‰‡åŒºçš„å¤§å°æ˜¯è®¾å¤‡çš„ç‰©ç†å±æ€§ï¼Œæ‰‡åŒºæ˜¯æ‰€æœ‰å—è®¾å¤‡çš„åŸºæœ¬å•å…ƒâ€”-å—è®¾å¤‡æ— æ³•å¯¹æ¯”å®ƒè¿˜å°çš„å•å…ƒè¿›è¡Œå¯»å€å’Œæ“ä½œã€‚</p><p>å› ä¸ºå„ç§è½¯ä»¶çš„ç”¨é€”ä¸åŒï¼Œæ‰€ä»¥å®ƒä»¬éƒ½ä¼šç”¨åˆ°è‡ªå·±çš„æœ€å°é€»è¾‘å¯å¯»å€å•å…ƒ--å—ï¼ˆblockï¼‰ã€‚å—æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§æŠ½è±¡ï¼Œåªèƒ½åŸºäºå—æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€‚è™½ç„¶ç‰©ç†ç£ç›˜å¯»å€æ˜¯æŒ‰ç…§æ‰‡åŒºçº§è¿›è¡Œçš„ï¼Œä½†æ˜¯å†…æ ¸æ‰§è¡Œçš„æ‰€æœ‰ç£ç›˜æ“ä½œéƒ½æ˜¯æŒ‰ç…§å—è¿›è¡Œçš„ã€‚ç”±äºæ‰‡åŒºæ˜¯è®¾å¤‡çš„æœ€å°å¯å¯»å€å•å…ƒï¼Œæ‰€ä»¥å—ä¸èƒ½æ¯”æ‰‡åŒºè¿˜å°ï¼Œåªèƒ½æ•°å€äºæ‰‡åŒºå¤§å°ã€‚å¦å¤–ï¼Œå†…æ ¸ï¼ˆå¯¹æœ‰æ‰‡åŒºçš„ç¡¬ä»¶è®¾å¤‡ï¼‰è¿˜è¦æ±‚å—å¤§å°æ˜¯ 2 çš„æ•´æ•°å€ï¼Œè€Œä¸”ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé¡µï¼ˆpageï¼‰çš„é•¿åº¦ã€‚æ‰€ä»¥ï¼Œå¯¹å—å¤§å°çš„æœ€ç»ˆè¦æ±‚æ˜¯ï¼Œå¿…é¡»æ˜¯æ‰‡åŒºå¤§å°çš„ 2 çš„æ•´æ•°å€ï¼Œå¹¶ä¸”è¦å°äºé¡µé¢å¤§å°ã€‚æ‰€ä»¥é€šå¸¸å—å¤§å°æ˜¯ 512 å­—èŠ‚ã€1KB æˆ– 4KBã€‚</p><blockquote><p>æ‰‡åŒºâ€”â€”è®¾å¤‡çš„æœ€å°å¯»å€å•å…ƒï¼›åŒæ ·çš„ï¼Œå—â€”â€”æ–‡ä»¶ç³»ç»Ÿçš„æœ€å°å¯»å€å•å…ƒã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/io1.png"></p><h1 id="ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´">ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´</h1><blockquote><p>ç¼“å†²åŒºå¤´çš„ç›®çš„åœ¨äºæè¿°ç£ç›˜å—å’Œç‰©ç†å†…å­˜ç¼“å†²åŒºä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªç»“æ„ä½“åœ¨å†…æ ¸ä¸­åªæ‰®æ¼”ä¸€ä¸ªæè¿°ç¬¦çš„è§’è‰²ï¼Œè¯´æ˜ä»ç¼“å†²åŒºåˆ°å—çš„æ˜ å°„å…³ç³»ã€‚</p></blockquote><p>å½“ä¸€ä¸ªå—è¢«è°ƒå…¥å†…å­˜æ—¶ï¼Œå®ƒè¦å­˜å‚¨åœ¨ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œæ¯ä¸ªç¼“å†²åŒºä¸ä¸€ä¸ªå—å¯¹åº”ï¼Œå®ƒç›¸å½“äºæ˜¯ç£ç›˜å—åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºã€‚å‰é¢æåˆ°è¿‡ï¼Œå—åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºï¼Œä½†å¤§å°ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé¡µé¢ï¼Œæ‰€ä»¥ä¸€ä¸ªé¡µå¯ä»¥å®¹çº³ä¸€ä¸ªæˆ–å¤šä¸ªå†…å­˜ä¸­çš„å—ã€‚ç”±äºå†…æ ¸åœ¨å¤„ç†æ•°æ®æ—¶éœ€è¦ä¸€äº›ç›¸å…³çš„æ§åˆ¶ä¿¡æ¯ã€ï¼ˆæ¯”å¦‚å—å±äºå“ªä¸€ä¸ªå—è®¾å¤‡ï¼Œå—å¯¹åº”äºå“ªä¸ªç¼“å†²åŒºç­‰ï¼‰ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªç¼“å†²åŒºéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æè¿°ç¬¦ã€‚è¯¥æè¿°ç¬¦ç”¨ buffer head ç»“æ„ä½“è¡¨ç¤ºï¼Œç§°ä½œç¼“å†²åŒºå¤´ï¼Œåœ¨æ–‡ä»¶ã€Šlinux/buffer_head.hã€‹ä¸­å®šä¹‰ï¼Œå®ƒåŒ…å«äº†å†…æ ¸æ“ä½œç¼“å†²åŒºæ‰€éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> {</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> b_state;<span class="comment">/* buffer state bitmap (see above) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">b_this_page</span>;</span><span class="comment">/* circular list of page's buffers */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">b_page</span>;</span><span class="comment">/* the page this bh is mapped to */</span></span><br><span class="line"></span><br><span class="line"><span class="type">sector_t</span> b_blocknr;<span class="comment">/* start block number */</span></span><br><span class="line"><span class="type">size_t</span> b_size;<span class="comment">/* size of mapping */</span></span><br><span class="line"><span class="type">char</span> *b_data;<span class="comment">/* pointer to data within the page */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">b_bdev</span>;</span></span><br><span class="line"><span class="type">bh_end_io_t</span> *b_end_io;<span class="comment">/* I/O completion */</span></span><br><span class="line"> <span class="type">void</span> *b_private;<span class="comment">/* reserved for b_end_io */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_assoc_buffers</span>;</span> <span class="comment">/* associated with another mapping */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">b_assoc_map</span>;</span><span class="comment">/* mapping this buffer is</span></span><br><span class="line"><span class="comment">   associated with */</span></span><br><span class="line"><span class="type">atomic_t</span> b_count;<span class="comment">/* users using this buffer_head */</span></span><br><span class="line"><span class="type">spinlock_t</span> b_uptodate_lock;<span class="comment">/* Used by the first bh in a page, to</span></span><br><span class="line"><span class="comment"> * serialise IO completion of other</span></span><br><span class="line"><span class="comment"> * buffers in the page */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ 2.6 å†…æ ¸ä»¥å‰ï¼Œç¼“å†²åŒºå¤´çš„ä½œç”¨æ¯”ç°åœ¨è¿˜è¦é‡è¦ã€‚å› ä¸ºç¼“å†²åŒºå¤´ä½œä¸ºå†…æ ¸ä¸­çš„ I/O æ“ä½œå•å…ƒï¼Œä¸ä»…ä»…æè¿°äº†ä»ç£ç›˜å—åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œè€Œä¸”è¿˜æ˜¯æ‰€æœ‰å— I/O æ“ä½œçš„å®¹å™¨ã€‚å¯æ˜¯ï¼Œå°†ç¼“å†²åŒºå¤´ä½œä¸º I/O æ“ä½œå•å…ƒå¸¦æ¥äº†ä¸¤ä¸ªå¼Šç«¯ã€‚</p><ul><li>é¦–å…ˆï¼Œç¼“å†²åŒºå¤´æ˜¯ä¸€ä¸ªå¾ˆå¤§ä¸”ä¸æ˜“æ§åˆ¶çš„æ•°æ®ç»“æ„ä½“ï¼ˆç°åœ¨æ˜¯ç¼©å‡è¿‡äº†çš„ï¼‰ï¼Œè€Œä¸”ç¼“å†²åŒºå¤´å¯¹æ•°æ®çš„æ“ä½œæ—¢ä¸æ–¹ä¾¿ä¹Ÿä¸æ¸…æ™°ã€‚</li><li>ç¼“å†²åŒºå¤´å¸¦æ¥çš„ç¬¬äºŒä¸ªå¼Šç«¯æ˜¯ï¼šå®ƒä»…èƒ½æè¿°å•ä¸ªç¼“å†²åŒºï¼Œå½“ä½œä¸ºæ‰€æœ‰ I/O çš„å®¹å™¨ä½¿ç”¨æ—¶ï¼Œç¼“å†²åŒºå¤´ä¼šä¿ƒä½¿å†…æ ¸æŠŠå¯¹å¤§å—æ•°æ®çš„ I/O æ“ä½œï¼ˆæ¯”å¦‚å†™æ“ä½œï¼‰åˆ†è§£ä¸ºå¯¹å¤šä¸ª buffer_head ç»“æ„ä½“è¿›è¡Œæ“ä½œï¼Œè¿™æ ·åšå¿…ç„¶ä¼šé€ æˆä¸å¿…è¦çš„è´Ÿæ‹…å’Œç©ºé—´æµªè´¹ã€‚æ‰€ä»¥ 2.5 å¼€å‘ç‰ˆå†…æ ¸çš„ä¸»è¦ç›®æ ‡å°±æ˜¯ä¸ºå— I/O æ“ä½œå¼•å…¥ä¸€ç§æ–°å‹ã€çµæ´»å¹¶ä¸”è½»é‡çº§çš„å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯ bio ç»“æ„ä½“ã€‚</li></ul><h1 id="bio-ç»“æ„ä½“">bio ç»“æ„ä½“</h1><p>ç›®å‰å†…æ ¸ä¸­å— I/O æ“ä½œçš„åŸºæœ¬å®¹å™¨ç”± bio ç»“æ„ä½“è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“ä»£è¡¨äº†æ­£åœ¨ç°åœºçš„ï¼ˆæ´»åŠ¨çš„ï¼‰ä»¥ç‰‡æ–­ï¼ˆsegmentï¼‰é“¾è¡¨å½¢å¼ç»„ç»‡çš„å— I/O æ“ä½œã€‚ä¸€ä¸ªç‰‡æ®µæ˜¯ä¸€å°å—è¿ç»­çš„å†…å­˜ç¼“å†²åŒºã€‚è¿™æ ·çš„è¯ï¼Œå°±ä¸éœ€è¦ä¿è¯å•ä¸ªç¼“å†²åŒºä¸€å®šè¦è¿ç»­ã€‚æ‰€ä»¥é€šè¿‡ç”¨ç‰‡æ®µæ¥æè¿°ç¼“å†²åŒºï¼Œå³ä½¿ä¸€ä¸ªç¼“å†²åŒºåˆ†æ•£åœ¨å†…å­˜çš„å¤šä¸ªä½ç½®ä¸Šï¼Œbio ç»“æ„ä½“ä¹Ÿèƒ½å¯¹å†…æ ¸ä¿è¯ I/O æ“ä½œçš„æ‰§è¡Œã€‚åƒè¿™æ ·çš„å‘é‡ I/O å°±æ˜¯æ‰€è°“çš„èšæ•£ I/Oã€‚bio ç»“æ„ä½“å®šä¹‰äºã€Šlinux/bio.hã€‹ä¸­ï¼Œä¸‹é¢ç»™å‡º bio ç»“æ„ä½“å’Œå„ä¸ªåŸŸçš„æè¿°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span>*<span class="title">bi_next</span>;</span><span class="comment">/* request queue link */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>*<span class="title">bi_bdev</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>bi_opf;<span class="comment">/* bottom bits req flags,</span></span><br><span class="line"><span class="comment"> * top bits REQ_OP. Use</span></span><br><span class="line"><span class="comment"> * accessors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>bi_flags;<span class="comment">/* BIO_* below */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>bi_ioprio;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>bi_write_hint;</span><br><span class="line"><span class="type">blk_status_t</span>bi_status;</span><br><span class="line"><span class="type">atomic_t</span>__bi_remaining;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bvec_iter</span><span class="title">bi_iter</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">bio_end_io_t</span>*bi_end_io;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>*bi_private;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Represents the association of the css and request_queue for the bio.</span></span><br><span class="line"><span class="comment"> * If a bio goes direct to device, it will not have a blkg as it will</span></span><br><span class="line"><span class="comment"> * not have a request_queue associated with it.  The reference is put</span></span><br><span class="line"><span class="comment"> * on release of the bio.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">blkcg_gq</span>*<span class="title">bi_blkg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_issue</span><span class="title">bi_issue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BLK_CGROUP_IOCOST</span></span><br><span class="line">u64bi_iocost_cost;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BLK_INLINE_ENCRYPTION</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_crypt_ctx</span>*<span class="title">bi_crypt_context</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BLK_DEV_INTEGRITY)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_integrity_payload</span> *<span class="title">bi_integrity</span>;</span> <span class="comment">/* data integrity */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>bi_vcnt;<span class="comment">/* how many bio_vec's */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Everything starting with bi_max_vecs will be preserved by bio_reset()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>bi_max_vecs;<span class="comment">/* max bvl_vecs we can hold */</span></span><br><span class="line"></span><br><span class="line"><span class="type">atomic_t</span>__bi_cnt;<span class="comment">/* pin count */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>*<span class="title">bi_io_vec</span>;</span><span class="comment">/* the actual vec list */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_set</span>*<span class="title">bi_pool</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We can inline a number of vecs at the end of the bio, to avoid</span></span><br><span class="line"><span class="comment"> * double allocations for a small number of bio_vecs. This member</span></span><br><span class="line"><span class="comment"> * MUST obviously be kept at the very end of the bio.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span><span class="title">bi_inline_vecs</span>[];</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ bio ç»“æ„ä½“çš„ç›®çš„ä¸»è¦æ˜¯ä»£è¡¨æ­£åœ¨ç°åœºæ‰§è¡Œçš„ I/O æ“ä½œï¼Œæ‰€ä»¥è¯¥ç»“æ„ä½“ä¸­çš„ä¸»è¦åŸŸéƒ½æ˜¯ç”¨æ¥ç®¡ç†ç›¸å…³ä¿¡æ¯çš„ï¼Œå…¶ä¸­æœ€é‡è¦çš„å‡ ä¸ªåŸŸæ˜¯ bi_io_vecsã€bi_vcnt å’Œ bi_idxã€‚ä¸‹å›¾æ˜¾ç¤ºäº† bio ç»“æ„ä½“åŠå…¶ä»–ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/io2.png"></p><p>Sectorã€Blockã€Segment ä¹‹é—´çš„å…³ç³»ï¼š<br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Bio.png"></p><h2 id="io-å‘é‡">I/O å‘é‡</h2><p>bi_io_vec åŸŸæŒ‡å‘ä¸€ä¸ª bio_vec ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®š I/O æ“ä½œæ‰€éœ€è¦ä½¿ç”¨åˆ°çš„æ‰€æœ‰ç‰‡æ®µã€‚æ¯ä¸ª bio_vec ç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸º&lt;pageï¼Œoffsetï¼Œlen&gt;çš„å‘é‡ï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„ç‰‡æ®µï¼šç‰‡æ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»ä½ç½®ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„å—é•¿åº¦ã€‚æ•´ä¸ª bio_io_vec ç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vec ç»“æ„å®šä¹‰åœ¨ã€Šlinux/bio.hã€‹æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>*<span class="title">bv_page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>bv_len;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>bv_offset;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åœ¨æ¯ä¸ªç»™å®šçš„å— I/O æ“ä½œä¸­ï¼Œbi_vcnt åŸŸç”¨æ¥æè¿° bi_io_vec æ‰€æŒ‡å‘çš„ bio_vec æ•°ç»„ä¸­çš„å‘é‡æ•°ç›®ã€‚å½“å— I/O æ“ä½œæ‰§è¡Œå®Œæ¯•åï¼Œbi_idx åŸŸæŒ‡å‘æ•°ç»„çš„å½“å‰ç´¢å¼•ã€‚</p><p>bi_vcnt åŸŸè®°å½• bio ç»“æ„ä½“çš„ä½¿ç”¨è®¡æ•°ï¼Œå¦‚æœè¯¥åŸŸå€¼å‡ä¸º Oï¼Œå°±åº”è¯¥æ’¤é”€è¯¥ bio ç»“æ„ä½“ï¼Œå¹¶é‡Šæ”¾å®ƒå ç”¨çš„å†…å­˜ã€‚é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ç®¡ç†ä½¿ç”¨è®¡æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">bio_get</span><span class="params">(<span class="keyword">struct</span> bio *bio)</span></span><br><span class="line">{</span><br><span class="line">bio-&gt;bi_flags |= (<span class="number">1</span> &lt;&lt; BIO_REFFED);</span><br><span class="line">smp_mb__before_atomic();</span><br><span class="line"><span class="type">atomic_inc</span>(&amp;bio-&gt;__bi_cnt);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">bio_put</span><span class="params">(<span class="keyword">struct</span> bio *)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å‰è€…å¢åŠ ä½¿ç”¨è®¡æ•°ï¼Œåè€…å‡å°‘ä½¿ç”¨è®¡æ•°ï¼ˆå¦‚æœè®¡æ•°å‡åˆ° 0ï¼Œåˆ™æ’¤é”€ bio ç»“æ„ä½“ï¼‰ã€‚åœ¨æ“ä½œæ­£åœ¨æ´»åŠ¨çš„ bio ç»“æ„ä½“æ—¶ï¼Œä¸€å®šè¦é¦–å…ˆå¢åŠ å®ƒçš„ä½¿ç”¨è®¡æ•°ï¼Œä»¥å…åœ¨æ“ä½œè¿‡ç¨‹ä¸­è¯¥ bio ç»“æ„ä½“è¢«é‡Šæ”¾ï¼›ç›¸åï¼Œåœ¨æ“ä½œå®Œæ¯•åï¼Œè¦å‡å°‘ä½¿ç”¨è®¡æ•°ã€‚</p><h2 id="æ–°è€æ–¹æ³•å¯¹æ¯”">æ–°è€æ–¹æ³•å¯¹æ¯”</h2><p>åˆ©ç”¨ bio ç»“æ„ä½“ä»£æ›¿ buffer bead ç»“æ„ä½“è¿˜æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p><ul><li>bio ç»“æ„ä½“å¾ˆå®¹æ˜“å¤„ç†é«˜ç«¯å†…å­˜ï¼Œå› ä¸ºå®ƒå¤„ç†çš„æ˜¯ç‰©ç†é¡µè€Œä¸æ˜¯ç›´æ¥æŒ‡é’ˆ</li><li>bio ç»“æ„ä½“æ—¢å¯ä»¥ä»£è¡¨æ™®é€šé¡µ I/Oï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»£è¡¨ç›´æ¥ I/Oï¼ˆæŒ‡é‚£äº›ä¸é€šè¿‡é¡µé«˜é€Ÿç¼“å­˜çš„ I/0 æ“ä½œï¼‰</li><li>bio ç»“æ„ä½“ä¾¿äºæ‰§è¡Œåˆ†æ•£ä¸€é›†ä¸­ï¼ˆçŸ¢é‡åŒ–çš„ï¼‰å— I/O æ“ä½œï¼Œæ“ä½œä¸­çš„æ•°æ®å¯å–è‡ªå¤šä¸ªç‰©ç†é¡µé¢</li><li>bio ç»“æ„ä½“ç›¸æ¯”ç¼“å†²åŒºå¤´å±äºè½»é‡çº§çš„ç»“æ„ä½“ã€‚å› ä¸ºå®ƒåªéœ€è¦åŒ…å«å— I/O æ“ä½œæ‰€éœ€çš„ä¿¡æ¯å°±è¡Œäº†ï¼Œä¸ç”¨åŒ…å«ä¸ç¼“å†²åŒºæœ¬èº«ç›¸å…³çš„ä¸å¿…è¦ä¿¡æ¯</li></ul><p>ä½†æ˜¯è¿˜æ˜¯éœ€è¦ç¼“å†²åŒºå¤´è¿™ä¸ªæ¦‚å¿µï¼Œæ¯•ç«Ÿå®ƒè¿˜è´Ÿè´£æè¿°ç£ç›˜å—åˆ°é¡µé¢çš„æ˜ å°„ã€‚bio ç»“æ„ä½“ä¸åŒ…å«ä»»ä½•å’Œç¼“å†²åŒºç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ä¸€å®ƒä»…ä»…æ˜¯ä¸€ä¸ªçŸ¢é‡æ•°ç»„ï¼Œæè¿°ä¸€ä¸ªæˆ–å¤šä¸ªå•ç‹¬å— I/O æ“ä½œçš„æ•°æ®ç‰‡æ®µå’Œç›¸å…³ä¿¡æ¯ã€‚åœ¨å½“å‰è®¾ç½®ä¸­ï¼Œå½“ bio ç»“æ„ä½“æè¿°å½“å‰æ­£åœ¨ä½¿ç”¨çš„ I/O æ“ä½œæ—¶ï¼Œbufferhead ç»“æ„ä½“ä»ç„¶éœ€è¦åŒ…å«ç¼“å†²åŒºä¿¡æ¯ã€‚å†…æ ¸é€šè¿‡è¿™ä¸¤ç§ç»“æ„åˆ†åˆ«ä¿å­˜å„è‡ªçš„ä¿¡æ¯ï¼Œå¯ä»¥ä¿è¯æ¯ç§ç»“æ„æ‰€å«çš„ä¿¡æ¯é‡å°½å¯èƒ½åœ°å°‘ã€‚</p><h1 id="è¯·æ±‚é˜Ÿåˆ—">è¯·æ±‚é˜Ÿåˆ—</h1><p>å—è®¾å¤‡å°†å®ƒä»¬æŒ‚èµ·çš„å— I/O è¯·æ±‚ä¿å­˜åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œè¯¥é˜Ÿåˆ—ç”± reques_queue ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/blkdev.hã€‹ä¸­ï¼ŒåŒ…å«ä¸€ä¸ªåŒå‘è¯·æ±‚é“¾è¡¨ä»¥åŠç›¸å…³æ§åˆ¶ä¿¡æ¯ã€‚é€šè¿‡å†…æ ¸ä¸­åƒæ–‡ä»¶ç³»ç»Ÿè¿™æ ·é«˜å±‚çš„ä»£ç å°†è¯·æ±‚åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚è¯·æ±‚é˜Ÿåˆ—åªè¦ä¸ä¸ºç©ºï¼Œé˜Ÿåˆ—å¯¹åº”çš„å—è®¾å¤‡é©±åŠ¨ç¨‹åºå°±ä¼šä»é˜Ÿåˆ—å¤´è·å–è¯·æ±‚ï¼Œç„¶åå°†å…¶é€å…¥å¯¹åº”çš„å—è®¾å¤‡ä¸Šå»ã€‚è¯·æ±‚é˜Ÿåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¯·æ±‚ï¼Œç”± reques ç»“æ„ä½“è¡¨ç¤ºã€‚ é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç”±ç»“æ„ä½“ request è¡¨ç¤ºï¼Œå®ƒå®šä¹‰åœ¨æ–‡ä»¶ã€Šlinux/blkdev.hã€‹ä¸­ã€‚å› ä¸ºä¸€ä¸ªè¯·æ±‚å¯èƒ½è¦æ“ä½œå¤šä¸ªè¿ç»­çš„ç£ç›˜å—ï¼Œæ‰€ä»¥æ¯ä¸ªè¯·æ±‚å¯ä»¥ç”±å¤šä¸ª bio ç»“æ„ä½“ç»„æˆã€‚æ³¨æ„ï¼Œè™½ç„¶ç£ç›˜ä¸Šçš„å—å¿…é¡»è¿ç»­ï¼Œä½†æ˜¯åœ¨å†…å­˜ä¸­è¿™äº›å—å¹¶ä¸ä¸€å®šè¦è¿ç»­â€”â€”æ¯ä¸ª bio ç»“æ„ä½“éƒ½å¯ä»¥æè¿°å¤šä¸ªç‰‡æ®µï¼Œè€Œæ¯ä¸ªè¯·æ±‚ä¹Ÿå¯ä»¥åŒ…å«å¤šä¸ª bio ç»“æ„ä½“ã€‚</p><h1 id="io-è°ƒåº¦ç¨‹åº">I/O è°ƒåº¦ç¨‹åº</h1><p>ä¸ºäº†ä¼˜åŒ–å¯»å€æ“ä½œï¼Œå†…æ ¸æ—¢ä¸ä¼šç®€å•åœ°æŒ‰è¯·æ±‚æ¥æ”¶æ¬¡åºï¼Œä¹Ÿä¸ä¼šç«‹å³å°†å…¶æäº¤ç»™ç£ç›˜ã€‚ç›¸åï¼Œå®ƒä¼šåœ¨æäº¤å‰ï¼Œå…ˆæ‰§è¡Œåä¸ºåˆå¹¶ä¸æ’åºçš„é¢„æ“ä½œï¼Œè¿™ç§é¢„æ“ä½œå¯ä»¥æå¤§åœ°æé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚åœ¨å†…æ ¸ä¸­è´Ÿè´£æäº¤ I/O è¯·æ±‚çš„å­ç³»ç»Ÿç§°ä¸º I/O è°ƒåº¦ç¨‹åºã€‚</p><h2 id="io-è°ƒåº¦ç¨‹åºçš„å·¥ä½œ">I/O è°ƒåº¦ç¨‹åºçš„å·¥ä½œ</h2><p>I/O è°ƒåº¦ç¨‹åºé€šè¿‡ä¸¤ç§æ–¹æ³•å‡å°‘ç£ç›˜å¯»å€æ—¶é—´ï¼šåˆå¹¶ä¸æ’åºã€‚</p><ul><li><p>åˆå¹¶æŒ‡å°†ä¸¤ä¸ªæˆ–å¤šä¸ªè¯·æ±‚ç»“åˆæˆä¸€ä¸ªæ–°è¯·æ±‚ã€‚è¯·æ±‚åˆå¹¶ååªéœ€è¦ä¼ é€’ç»™ç£ç›˜ä¸€æ¡å¯»å€å‘½ä»¤ï¼Œå› æ­¤åˆå¹¶è¯·æ±‚æ˜¾ç„¶èƒ½å‡å°‘ç³»ç»Ÿå¼€é”€å’Œç£ç›˜å¯»å€æ¬¡æ•°ã€‚</p></li><li><p>æ•´ä¸ªè¯·æ±‚é˜Ÿåˆ—å°†æŒ‰æ‰‡åŒºå¢é•¿æ–¹å‘æœ‰åºæ’åˆ—ã€‚ä½¿æ‰€æœ‰è¯·æ±‚æŒ‰ç¡¬ç›˜ä¸Šæ‰‡åŒºçš„æ’åˆ—é¡ºåºæœ‰åºæ’åˆ—ï¼ˆå°½å¯èƒ½çš„ï¼‰çš„ç›®çš„ä¸ä»…æ˜¯ä¸ºäº†ç¼©çŸ­å•ç‹¬ä¸€æ¬¡è¯·æ±‚çš„å¯»å€æ—¶é—´ï¼Œæ›´é‡è¦çš„ä¼˜åŒ–åœ¨äºï¼Œé€šè¿‡ä¿æŒç£ç›˜å¤´ä»¥ç›´çº¿æ–¹å‘ç§»åŠ¨ï¼Œç¼©çŸ­äº†æ‰€æœ‰è¯·æ±‚çš„ç£ç›˜å¯»å€æ—¶é—´ã€‚è¯¥æ’åºç®—æ³•ç±»ä¼¼äºç”µæ¢¯è°ƒåº¦ï¼Œæ‰€ä»¥ I/O è°ƒåº¦ç¨‹åºç§°ä½œç”µæ¢¯è°ƒåº¦ã€‚</p></li></ul><h2 id="linus-ç”µæ¢¯">Linus ç”µæ¢¯</h2><p>å½“ä¸€ä¸ªè¯·æ±‚åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­æ—¶ï¼Œæœ‰å¯èƒ½å‘ç”Ÿå››ç§æ“ä½œï¼Œå®ƒä»¬ä¾æ¬¡æ˜¯ï¼š</p><ul><li>å¦‚æœé˜Ÿåˆ—ä¸­å·²å­˜åœ¨ä¸€ä¸ªå¯¹ç›¸é‚»ç£ç›˜æ‰‡åŒºæ“ä½œçš„è¯·æ±‚ï¼Œé‚£ä¹ˆæ–°è¯·æ±‚å°†å’Œè¿™ä¸ªå·²ç»å­˜åœ¨çš„è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚</li><li>å¦‚æœé˜Ÿåˆ—ä¸­å­˜åœ¨ä¸€ä¸ªé©»ç•™æ—¶é—´è¿‡é•¿çš„è¯·æ±‚ï¼Œé‚£ä¹ˆæ–°è¯·æ±‚å°†è¢«æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œä»¥é˜²æ­¢å…¶ä»–æ—§çš„è¯·æ±‚é¥¥é¥¿å‘ç”Ÿ</li><li>å¦‚æœé˜Ÿåˆ—ä¸­ä»¥æ‰‡åŒºæ–¹å‘ä¸ºåºå­˜åœ¨åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œé‚£ä¹ˆæ–°çš„è¯·æ±‚å°†è¢«æ’å…¥åˆ°è¯¥ä½ç½®ï¼Œä¿è¯é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ˜¯ä»¥è¢«è®¿é—®ç£ç›˜ç‰©ç†ä½ç½®ä¸ºåºè¿›è¡Œæ’åˆ—çš„</li><li>å¦‚æœé˜Ÿåˆ—ä¸­ä¸å­˜åœ¨åˆé€‚çš„è¯·æ±‚æ’å…¥ä½ç½®ï¼Œè¯·æ±‚å°†è¢«æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨</li></ul><h2 id="æœ€ç»ˆæœŸé™-io-è°ƒåº¦ç¨‹åº">æœ€ç»ˆæœŸé™ I/O è°ƒåº¦ç¨‹åº</h2><p>æœ€ç»ˆæœŸé™ï¼ˆdeadlineï¼‰I/O è°ƒåº¦ç¨‹åºæ˜¯ä¸ºäº†è§£å†³ Linus ç”µæ¢¯æ‰€å¸¦æ¥çš„é¥¥é¥¿é—®é¢˜è€Œæå‡ºçš„ã€‚</p><p>æ™®é€šçš„è¯·æ±‚é¥¥é¥¿è¿˜ä¼šå¸¦æ¥åä¸ºå†™ä¸€é¥¥é¥¿ä¸€è¯»ï¼ˆwrites-starving-readsï¼‰è¿™ç§ç‰¹æ®Šé—®é¢˜ã€‚å†™æ“ä½œå®Œå…¨å’Œæäº¤å®ƒçš„åº”ç”¨ç¨‹åºå¼‚æ­¥æ‰§è¡Œï¼›è¯»æ“ä½œåˆ™æ°æ°ç›¸åæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥è¯»æ“ä½œå“åº”æ—¶é—´å¯¹ç³»ç»Ÿçš„æ€§èƒ½éå¸¸é‡è¦ã€‚</p><p>é—®é¢˜è¿˜å¯èƒ½æ›´ä¸¥é‡ï¼Œè¿™æ˜¯å› ä¸ºè¯»è¯·æ±‚å¾€å¾€ä¼šç›¸äº’ä¾é ã€‚å½“è¯»æ“ä½œé˜»å¡åï¼Œåé¢çš„è¯»è¯·æ±‚æ“ä½œä¹Ÿä¼šè·Ÿç€é˜»å¡ã€‚å› æ­¤ 2.6 ç‰ˆæœ¬å†…æ ¸æ–°å¼•å…¥äº†æœ€åæœŸé™ I/0 è°ƒåº¦ç¨‹åºæ¥å‡å°‘è¯·æ±‚é¥¥é¥¿ç°è±¡ï¼Œç‰¹åˆ«æ˜¯è¯»è¯·æ±‚é¥¥é¥¿ç°è±¡ã€‚</p><blockquote><p>åœ¨æœ€åæœŸé™ I/O è°ƒåº¦ç¨‹åºä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚</p></blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯»è¯·æ±‚çš„è¶…æ—¶æ—¶é—´æ˜¯ 500msï¼Œå†™è¯·æ±‚çš„è¶…æ—¶æ—¶é—´æ˜¯ 5sã€‚æœ€åæœŸé™ I/O è°ƒåº¦è¯·æ±‚ç±»ä¼¼äº Linus ç”µæ¢¯ï¼Œä¹Ÿä»¥ç£ç›˜ç‰©ç†ä½ç½®ä¸ºæ¬¡åºç»´æŠ¤è¯·æ±‚é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ç§°ä¸ºæ’åºé˜Ÿåˆ—ã€‚å½“ä¸€ä¸ªæ–°è¯·æ±‚é€’äº¤ç»™æ’åºé˜Ÿåˆ—æ—¶ï¼Œ</p><ul><li>æœ€åæœŸé™ I/O è°ƒåº¦ç¨‹åºåœ¨æ‰§è¡Œåˆå¹¶å’Œæ’å…¥è¯·æ±‚æ—¶ç±»ä¼¼äº Linus ç”µæ¢¯æ‰§è¡Œåˆå¹¶æ’åºåˆ°æ’é˜Ÿåºåˆ—</li><li>åŒæ—¶ä¹Ÿä¼šä»¥è¯·æ±‚ç±»å‹ä¸ºä¾æ®å°†å®ƒä»¬æ’å…¥åˆ°é¢å¤–é˜Ÿåˆ—ä¸­ã€‚è¯»è¯·æ±‚æŒ‰æ¬¡åºè¢«æ’å…¥åˆ°ç‰¹å®šçš„è¯» FIFO é˜Ÿåˆ—ä¸­</li><li>å†™è¯·æ±‚è¢«æ’å…¥åˆ°ç‰¹å®šçš„å†™ FIFO é˜Ÿåˆ—ä¸­</li></ul><p>è™½ç„¶æ™®é€šé˜Ÿåˆ—ä»¥ç£ç›˜æ‰‡åŒºä¸ºåºè¿›è¡Œæ’åˆ—ï¼Œä½†æ˜¯è¿™äº›é˜Ÿåˆ—æ˜¯ä»¥ FIFOï¼ˆå¾ˆæœ‰æ•ˆï¼Œä»¥æ—¶é—´ä¸ºåŸºå‡†æ’åºï¼‰å½¢å¼ç»„ç»‡çš„ï¼Œç»“æœæ–°é˜Ÿåˆ—æ€»æ˜¯è¢«åŠ äººåˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚å¯¹äºæ™®é€šæ“ä½œæ¥è¯´ï¼Œæœ€åæœŸé™ I/O è°ƒåº¦ç¨‹åºå°†è¯·æ±‚ä»æ’åºé˜Ÿåˆ—çš„å¤´éƒ¨å–ä¸‹ï¼Œå†æ¨å…¥åˆ°æ´¾å‘é˜Ÿåˆ—ä¸­ï¼Œæ´¾å‘é˜Ÿåˆ—ç„¶åå°†è¯·æ±‚æäº¤ç»™ç£ç›˜é©±åŠ¨ï¼Œä»è€Œä¿è¯äº†æœ€å°åŒ–çš„è¯·æ±‚å¯»å€ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/io3.png"></p><p>æ³¨æ„ï¼Œæœ€åæœŸé™ I/O è°ƒåº¦ç®—æ³•å¹¶ä¸èƒ½ä¸¥æ ¼ä¿è¯è¯·æ±‚çš„å“åº”æ—¶é—´ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¶…æ—¶æˆ–è¶…æ—¶å‰æäº¤å’Œæ‰§è¡Œï¼Œä»¥é˜²æ­¢è¯·æ±‚é¥¥é¥¿ç°è±¡çš„å‘ç”Ÿã€‚æœ€åæœŸé™ I/O è°ƒåº¦ç¨‹åºçš„å®ç°åœ¨æ–‡ä»¶ block/deadline-iosched.c ä¸­ã€‚</p><h2 id="é¢„æµ‹-io-è°ƒåº¦ç¨‹åº">é¢„æµ‹ I/O è°ƒåº¦ç¨‹åº</h2><p>è™½ç„¶æœ€åæœŸé™ I/O è°ƒåº¦ç¨‹åºä¸ºé™ä½è¯»æ“ä½œå“åº”æ—¶é—´åšäº†è®¸å¤šå·¥ä½œï¼Œä½†æ˜¯å®ƒåŒæ—¶ä¹Ÿé™ä½äº†ç³»ç»Ÿååé‡ã€‚é¢„æµ‹ï¼ˆAnticipatoryï¼‰I/O è°ƒåº¦ç¨‹åºçš„ç›®æ ‡å°±æ˜¯åœ¨ä¿æŒè‰¯å¥½çš„è¯»å“åº”çš„åŒæ—¶ä¹Ÿèƒ½æä¾›è‰¯å¥½çš„å…¨å±€ååé‡ã€‚ é¢„æµ‹ I/O è°ƒåº¦ç¨‹åºæœ€ä¸»è¦çš„æ”¹è¿›æ˜¯å®ƒå¢åŠ äº†é¢„æµ‹å¯å‘ï¼ˆanticipation-heuristicï¼‰èƒ½åŠ›ã€‚è¯·æ±‚æäº¤åå¹¶ä¸ç›´æ¥è¿”å›å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œè€Œæ˜¯ä¼šæœ‰æ„ç©ºé—²ç‰‡åˆ»ï¼ˆå®é™…ç©ºé—²æ—¶é—´å¯ä»¥è®¾ç½®ï¼Œé»˜è®¤ä¸º 6msï¼‰ã€‚è¿™å‡  msï¼Œå¯¹åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯ä¸ªæäº¤å…¶ä»–è¯»è¯·æ±‚çš„å¥½æœºä¼šâ€”â€”ä»»ä½•å¯¹ç›¸é‚»ç£ç›˜ä½ç½®æ“ä½œçš„è¯·æ±‚éƒ½ä¼šç«‹åˆ»å¾—åˆ°å¤„ç†ã€‚åœ¨ç­‰å¾…æ—¶é—´ç»“æŸåï¼Œé¢„æµ‹ I/O è°ƒåº¦ç¨‹åºé‡æ–°è¿”å›åŸæ¥çš„ä½ç½®ï¼Œç»§ç»­æ‰§è¡Œä»¥å‰å‰©ä¸‹çš„è¯·æ±‚ã€‚</p><p>é¢„æµ‹ I/O è°ƒåº¦ç¨‹åºçš„å®ç°åœ¨æ–‡ä»¶å†…æ ¸æºä»£ç æ ‘çš„ block/as-iosched.c ä¸­ï¼Œå®ƒæ˜¯ Linux å†…æ ¸ä¸­ç¼ºçœçš„ I/O è°ƒåº¦ç¨‹åºã€‚</p><h2 id="å®Œå…¨å…¬æ­£çš„æ’é˜Ÿ-io-è°ƒåº¦ç¨‹åº">å®Œå…¨å…¬æ­£çš„æ’é˜Ÿ I/O è°ƒåº¦ç¨‹åº</h2><p>å®Œå…¨å…¬æ­£çš„æ’é˜Ÿ I/O è°ƒåº¦ç¨‹åºï¼ˆComplete Fair Queuingï¼ŒCFQï¼‰æ˜¯ä¸ºä¸“æœ‰å·¥ä½œè´Ÿè·è®¾è®¡çš„ï¼ŒCFQ I/O è°ƒåº¦ç¨‹åºæŠŠè¿›å…¥çš„ I/O è¯·æ±‚æ”¾å…¥ç‰¹å®šçš„é˜Ÿåˆ—ä¸­ï¼Œè¿™ç§é˜Ÿåˆ—æ˜¯æ ¹æ®å¼•èµ· I/O è¯·æ±‚çš„è¿›ç¨‹ç»„ç»‡çš„ã€‚ä¾‹å¦‚ï¼Œæ¥è‡ª foo è¿›ç¨‹çš„ I/O è¯·æ±‚è¿›å…¥ foo é˜Ÿåˆ—ï¼Œè€Œæ¥è‡ª bar è¿›ç¨‹çš„ I/O è¯·æ±‚è¿›å…¥ bar é˜Ÿåˆ—ã€‚åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­ï¼Œåˆšè¿›å…¥çš„è¯·æ±‚ä¸ç›¸é‚»è¯·æ±‚åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¹¶è¿›è¡Œæ’å…¥åˆ†ç±»ã€‚é˜Ÿåˆ—ç”±æ­¤æŒ‰æ‰‡åŒºæ–¹å¼åˆ†ç±»ï¼Œè¿™ä¸å…¶ä»– I/O è°ƒåº¦ç¨‹åºé˜Ÿåˆ—ç±»ä¼¼ã€‚CFQ I/O è°ƒåº¦ç¨‹åºçš„å·®å¼‚åœ¨äºæ¯ä¸€ä¸ªæäº¤ I/O çš„è¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€‚</p><p>CFQ I/O è°ƒåº¦ç¨‹åºä»¥æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦é˜Ÿåˆ—ï¼Œä»æ¯ä¸ªé˜Ÿåˆ—ä¸­é€‰å–è¯·æ±‚æ•°ï¼ˆé»˜è®¤å€¼ä¸ºï¼Œå¯ä»¥è¿›è¡Œé…ç½®ï¼‰ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€è½®è°ƒåº¦ã€‚è¿™å°±åœ¨è¿›ç¨‹çº§æä¾›äº†å…¬å¹³ï¼Œç¡®ä¿æ¯ä¸ªè¿›ç¨‹æ¥æ”¶å…¬å¹³çš„ç£ç›˜å¸¦å®½ç‰‡æ–­ã€‚</p><h2 id="ç©ºæ“ä½œçš„-io-è°ƒåº¦ç¨‹åº">ç©ºæ“ä½œçš„ I/O è°ƒåº¦ç¨‹åº</h2><p>ç©ºæ“ä½œï¼ˆNoopï¼‰I/O è°ƒåº¦ç¨‹åºä¸è¿›è¡Œæ’åºï¼Œæˆ–è€…ä¹Ÿä¸è¿›è¡Œä»€ä¹ˆå…¶ä»–å½¢å¼çš„é¢„å¯»å€æ“ä½œã€‚ä¸è¿‡ï¼Œç©ºæ“ä½œ I/O è°ƒåº¦ç¨‹åºå¿˜ä¸äº†æ‰§è¡Œåˆå¹¶ã€‚é™¤äº†è¿™ä¸€æ“ä½œï¼Œç©ºæ“ä½œ I/O è°ƒåº¦ç¨‹åºçš„ç¡®å†ä¸åšä»€ä¹ˆï¼Œåªæ˜¯ç»´æŠ¤è¯·æ±‚é˜Ÿåˆ—ä»¥è¿‘ä¹ FIFO çš„é¡ºåºæ’åˆ—ï¼Œå—è®¾å¤‡é©±åŠ¨ç¨‹åºä¾¿å¯ä»¥ä»è¿™ç§é˜Ÿåˆ—ä¸­æ‘˜å–è¯·æ±‚ã€‚</p><p>ç©ºæ“ä½œ I/O è°ƒåº¦ç¨‹åºä½äº block/noop-iosched.cï¼Œå®ƒæ˜¯ä¸“ä¸ºéšæœºè®¿é—®è®¾å¤‡è€Œè®¾è®¡çš„ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šlinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> FileSystem </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…æ ¸è°ƒè¯•ï¼ˆäºŒï¼‰å†…å­˜æ£€æµ‹</title>
      <link href="/2021/LinuxKernel/LinuxKernelDebugMem/"/>
      <url>/2021/LinuxKernel/LinuxKernelDebugMem/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Debugftrace.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5YjAzNWU0MDFmZDA3MGJiYTBlYmE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><p>ä¸€èˆ¬çš„å†…å­˜è®¿é—®é”™è¯¯å¦‚ä¸‹ã€‚</p><ul><li>è¶Šç•Œè®¿é—®ï¼ˆout-of-boundsï¼‰</li><li>è®¿é—®å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼ˆuse after freeï¼‰</li><li>é‡å¤é‡Šæ”¾ï¼ˆdouble freeï¼‰</li><li>å†…å­˜æ³„æ¼ï¼ˆmemory leakï¼‰</li><li>æ ˆæº¢å‡ºï¼ˆstack overflowï¼‰</li></ul><p>æœ¬èŠ‚ä¸»è¦ä»‹ç» Linux å†…æ ¸ä¸­å¸¸ç”¨çš„å†…å­˜æ£€æµ‹çš„å·¥å…·å’Œæ–¹æ³•ã€‚</p><h1 id="slub_debug">slub_debug</h1><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œå¯¹äºå°å—å†…å­˜åˆ†é…ï¼Œå¤§é‡ä½¿ç”¨ slab/slub åˆ†é…å™¨ã€‚slab/slub åˆ†é…å™¨æä¾›äº†ä¸€ä¸ªå†…å­˜æ£€æµ‹åŠŸèƒ½ï¼Œå¾ˆæ–¹ä¾¿åœ¨äº§å“å¼€å‘é˜¶æ®µè¿›è¡Œå†…å­˜æ£€æŸ¥ã€‚å†…å­˜è®¿é—®ä¸­æ¯”è¾ƒå®¹æ˜“å‡ºç°é”™è¯¯çš„åœ°æ–¹å¦‚ä¸‹ã€‚</p><ul><li>è®¿é—®å·±ç»è¢«é‡Šæ”¾çš„å†…å­˜</li><li>è¶Šç•Œè®¿é—®</li><li>é‡Šæ”¾å·±ç»é‡Šæ”¾è¿‡çš„å†…å­˜</li></ul><h2 id="é…ç½®å’Œç¼–è¯‘å†…æ ¸">é…ç½®å’Œç¼–è¯‘å†…æ ¸</h2><p>é¦–å…ˆï¼Œéœ€è¦é‡æ–°é…ç½®å†…æ ¸é€‰é¡¹ï¼Œæ‰“å¼€ CONFIG_SLUBã€CONFIG_SLUB_DEBUG_ON ä»¥åŠ CONFIG_SLUB_STATS é€‰é¡¹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># CONFIG_SLAB is not <span class="built_in">set</span></span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line">CONFIG_SLUB_DEBUG_ON=y</span><br><span class="line">CONFIG_SLUB_STATS=y</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹äº†ä¸Šè¿°é…ç½®æ–‡ä»¶ä¹‹åï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸å¹¶æ›´æ–°æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="æ·»åŠ -slub_debug-é€‰é¡¹">æ·»åŠ  slub_debug é€‰é¡¹</h2><p>åœ¨å†…æ ¸ commandline ä¸­æ·»åŠ  slub_debug å­—ç¬¦ä¸²æ¥æ‰“å¼€è¯¥åŠŸèƒ½ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-append <span class="string">"nointrd root=/dev/vda rootfstype=ext4 rw loglevel=8 slub_debug=UFPZ"</span> \</span><br></pre></td></tr></tbody></table></figure><h2 id="ç¼–è¯‘-slabinfo-å·¥å…·">ç¼–è¯‘ slabinfo å·¥å…·</h2><p>åœ¨ Linux-5.0 å†…æ ¸çš„ tools/vm ç›®å½•ä¸‹ç¼–è¯‘ slabinfo å·¥å…·ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gcc slabinfo.c -o slabinfo</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è¿è¡Œ">è¿è¡Œ</h2><p>åŠ è½½é©±åŠ¨æˆ–è¿è¡Œç¨‹åºï¼Œå¯åŠ¨ slabinfoï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ slabinfo -v</span><br></pre></td></tr></tbody></table></figure><p>ä¹‹åå¦‚æœæœ‰å†…å­˜è¶Šç•Œè®¿é—®å°±ä¼šæœ‰å¼‚å¸¸ log è¾“å‡ºã€‚</p><h1 id="kasan-å†…å­˜æ£€æµ‹">KASAN å†…å­˜æ£€æµ‹</h1><p>KASAN åœ¨ Linux4.0 å†…æ ¸ä¸­è¢«åˆå¹¶åˆ°å®˜æ–¹ Linux å†…æ ¸ï¼Œä»–æ˜¯ä¸€ä¸ªåŠ¨æ€æ£€æµ‹å†…å­˜é”™è¯¯çš„å·¥å…·ï¼Œå¯ä»¥æ£€æŸ¥å†…å­˜è¶Šç•Œè®¿é—®å’Œä½¿ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ç­‰é—®é¢˜ã€‚Linux å†…æ ¸æ—©æœŸæœ‰ä¸€ä¸ªç±»ä¼¼çš„å·¥å…· kmemcheckï¼ŒKASAN æ¯” kmemeheck çš„æ£€æµ‹é€Ÿåº¦æ›´å¿«ã€‚è¦ä½¿ç”¨ KASANï¼Œå¿…é¡»æ‰“å¼€ CONFIG_KASAN ç­‰é€‰é¡¹ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">arch</span>/arm64/configs/debian_defconfig&gt;</span><br><span class="line">CONFIG_HAVE_ARCH_KASAN=y</span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_OUTLINE=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br><span class="line">CONFIG_TEST_KASAN=m</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦åƒ slab_debug ä¸€æ ·è¿˜æœ‰å•ç‹¬è¿è¡Œ slabinfo ç¨‹åºã€‚KASAN å¯åŠ¨åä¼šåŠ¨æ€ç›‘æµ‹å†…å­˜è®¿é—®ï¼Œå¦‚æœå‡ºé”™ä¼šæ‰“å°ç›¸å…³ log ä¿¡æ¯ã€‚</p><p>KASAN æ€»ä½“æ•ˆç‡æ¯” slub_debug è¦é«˜å¾—å¤šï¼Œå¹¶ä¸”æ”¯æŒçš„å†…å­˜é”™è¯¯è®¿é—®ç±»å‹æ›´å¤šã€‚ç¼ºç‚¹æ˜¯ KASAN éœ€è¦è¾ƒæ–°çš„å†…æ ¸ï¼ˆLinx4.4 å†…æ ¸æ‰æ”¯æŒ ARM64 ç‰ˆæœ¬çš„ KASANï¼‰å’Œè¾ƒæ–°çš„ GCC ç¼–è¯‘ å™¨ï¼ˆGCC-4.9.2 ä»¥ä¸Šï¼‰ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…æ ¸è°ƒè¯•ï¼ˆä¸€ï¼‰ftrace</title>
      <link href="/2021/LinuxKernel/LinuxKernelDebugftrace/"/>
      <url>/2021/LinuxKernel/LinuxKernelDebugftrace/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Debugftrace.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5YjAzNWU0MDFmZDA3MGJiYTBlYmE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä½ç½®æ— å…³ç ">ä½ç½®æ— å…³ç </h1><ul><li>åŠ è½½åœ°å€ï¼šå­˜å‚¨ä»£ç çš„ç‰©ç†åœ°å€ã€‚å¦‚ ARM64 å¤„ç†å™¨ä¸Šç”µå¤ä½åæ˜¯ä» 0x0 åœ°å€å¼€å§‹ç¬¬ä¸€æ¡æŒ‡ä»¤çš„ï¼Œæ‰€ä»¥é€šå¸¸è¿™ä¸ªåœ°æ–¹å­˜æ”¾ä»£ç æœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œå¦‚å¼‚å¸¸å‘é‡è¡¨çš„å¤„ç†åœ°å€</li><li>è¿è¡Œåœ°å€ï¼šæŒ‡ç¨‹åºè¿è¡Œæ—¶çš„åœ°å€</li><li>é“¾æ¥åœ°å€ï¼šåœ¨ç¼–è¯‘é“¾æ¥æ—¶æŒ‡å®šçš„åœ°å€ï¼Œç¼–ç¨‹äººå‘˜è®¾æƒ³å°†æ¥ç¨‹åºè¦è¿è¡Œçš„åœ°å€ã€‚ç¨‹åºæ‰€æœ‰æ ‡å·çš„åœ°å€åœ¨é“¾æ¥åä¾¿ç¡®å®šäº†ï¼Œä¸ç®¡ç¨‹åºåœ¨å“ªé‡Œè¿è¡Œéƒ½ä¸ä¼šæ”¹å˜ã€‚aarch64-linux-gnu-obidump (objdump) å·¥å…·è¿›è¡Œåæ±‡ç¼–æŸ¥çœ‹çš„å°±æ¥åœ°é“¾æ¥åœ°å€</li></ul><p>é“¾æ¥åœ°å€å’Œè¿è¡Œåœ°å€å¯ä»¥ç›¸åŒï¼Œä¹Ÿå¯ä»¥ä¸åŒã€‚é‚£ä»€ä¹ˆæ—¶å€™è¿è¡Œåœ°å€å’Œé“¾æ¥åœ°å€ä¸ç›¸åŒï¼Œä»€ä¹ˆæ—¶å€™ç›¸åŒå‘¢ï¼Ÿæˆ‘ä»¬ä»¥ä¸€å— ARM64 å¼€å‘æ¿ä¸ºä¾‹ï¼ŒèŠ¯ç‰‡å†…éƒ¨æœ‰ SRAMï¼Œèµ·å§‹åœ°å€ä¸º 0x0ï¼ŒDDR å†…å­˜çš„èµ·å§‹åœ°å€ä¸º 0x4000 0000ã€‚</p><p>é€šå¸¸ä»£ç å­˜å‚¨åœ¨ Nor Flash å­˜å‚¨å™¨æˆ–è€… Nand Flash å­˜å‚¨å™¨ä¸­ï¼ŒèŠ¯ç‰‡å†…éƒ¨çš„ BOOT ROM ä¼šæŠŠå¼€å§‹çš„å°éƒ¨åˆ†ä»£ç è£…è½½åˆ° SRAM ä¸­è¿è¡Œã€‚èŠ¯ç‰‡ä¸Šç”µå¤ä½ä¹‹åï¼Œä» SRAM ä¸­å–æŒ‡ä»¤ã€‚ç”±äº Uboot çš„é•œåƒå¤ªå¤§äº†ï¼ŒSRAM æ”¾ä¸ä¸‹ï¼Œå› æ­¤å¿…é¡»è¦æ”¾åœ¨ DDR å†…å­˜ä¸­ã€‚é€šå¸¸ Uboot ç¼–è¯‘æ—¶é“¾æ¥åœ°å€éƒ½è®¾ç½®åˆ° DDR å†…å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯ 0x4000 0000 åœ°å€å¤„ã€‚é‚£è¿™æ—¶è¿è¡Œåœ°å€å’Œé“¾æ¥åœ°å€å°±ä¸ä¸€æ ·äº†ã€‚è¿è¡Œåœ°å€ä¸º 0x0ï¼Œé“¾æ¥åœ°å€å˜æˆäº† 0x4000 0000 é‚£ä¹ˆç¨‹åºä¸ºä»€ä¹ˆè¿˜èƒ½è¿è¡Œå‘¢ä¸ªé‡è¦é—®é¢˜ï¼Œå°±æ˜¯ä½ç½®æ— å…³ä»£ç å’Œä½ç½®æœ‰å…³ä»£ç ã€‚</p><ul><li>ä½ç½®æ— å…³ä»£ç ï¼šä»å­—é¢æ„æ€çœ‹ï¼Œè¯¥æŒ‡ä»¤çš„æ‰§è¡Œæ˜¯ä¸å†…å­˜åœ°å€æ— å…³çš„ï¼›æ— è®ºè¿è¡Œåœ°å€å’Œé“¾æ¥åœ°å€ç›¸ç­‰æˆ–è€…ä¸ç›¸ç­‰ï¼Œè¯¥æŒ‡ä»¤éƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œåƒ BLã€Bã€MOV æŒ‡ä»¤å±äºä½ç½®æ— å…³æŒ‡ä»¤ï¼Œä¸ç®¡ç¨‹åºè£…è½½åœ¨å“ªä¸ªä½ç½®ï¼Œå®ƒä»¬éƒ½èƒ½æ­£ç¡®åœ°è¿è¡Œï¼Œå®ƒä»¬çš„åœ°å€åŸŸæ˜¯åŸºäº PC å€¼çš„ç›¸å¯¹åç§»å¯»å€ï¼Œç›¸å½“äº [pc+offset]</li><li>ä½ç½®æœ‰å…³ä»£ç ï¼šä»å­—é¢æ„æ€çœ‹ï¼Œè¯¥æŒ‡ä»¤çš„æ‰§è¡Œæ˜¯ä¸å†…å­˜åœ°å€æœ‰å…³çš„ï¼Œå’Œå½“å‰ PC å€¼æ— å…³ã€‚ARM æ±‡ç¼–é‡Œé¢é€šè¿‡ç»å¯¹è·³è½¬ä¿®æ”¹ PC å€¼ä¸ºå½“å‰é“¾æ¥åœ°å€çš„å€¼</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr pc, = on_sdram ; è·³åˆ° SDRAM ä¸­ç»§ç»­æ‰§è¡Œ</span><br></pre></td></tr></tbody></table></figure><p>å› æ­¤ï¼Œå½“é€šè¿‡ LDR æŒ‡ä»¤è·³è½¬åˆ°é“¾æ¥åœ°å€å¤„æ‰§è¡Œæ—¶ï¼Œè¿è¡Œåœ°å€å°±ç­‰äºé“¾æ¥åœ°å€äº†ã€‚è¿™ä¸ªè¿‡ç¨‹å«ä½œâ€œé‡å®šä½â€ã€‚åœ¨é‡å®šä½ä¹‹å‰ï¼Œç¨‹åºåªèƒ½æ‰§è¡Œå’Œä½ç½®æ— å…³çš„ä¸€äº›æ±‡ç¼–ä»£ç ã€‚ä¸ºä»€ä¹ˆè¦åˆ»æ„è®¾ç½®åŠ è½½åœ°å€ã€è¿è¡Œåœ°å€ä»¥åŠé“¾æ¥åœ°å€ä¸ä¸€æ ·å‘¢ï¼Ÿ å¦‚æœæ‰€æœ‰ä»£ç éƒ½åœ¨ ROMï¼ˆæˆ– Nor Flash å­˜å‚¨å™¨ï¼‰ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆé“¾æ¥åœ°å€å¯ä»¥ä¸åŠ è½½åœ°å€ç›¸åŒï¼›è€Œåœ¨å®é™…é¡¹ç›®åº”ç”¨ä¸­ï¼Œå¾€å¾€æƒ³è¦æŠŠç¨‹åºåŠ è½½åˆ° DDR å†…å­˜ä¸­ï¼ŒDDR å†…å­˜çš„è®¿é—®é€Ÿåº¦æ¯” ROM è¦å¿«å¾ˆå¤šï¼Œè€Œä¸”å®¹é‡ä¹Ÿå¤§ã€‚ä½†æ˜¯ç¢äºåŠ è½½åœ°å€çš„å½±å“ï¼Œä¸å¯èƒ½ç›´æ¥è¾¾åˆ°è¿™ä¸€æ­¥ï¼Œæ‰€ä»¥æ€è·¯å°±æ˜¯è®©ç¨‹åºçš„åŠ è½½åœ°å€ç­‰äº ROM èµ·å§‹åœ°å€ï¼Œè€Œé“¾æ¥åœ°å€ç­‰äº DDR å†…å­˜ä¸­æŸä¸€å¤„çš„èµ·å§‹åœ°å€ï¼ˆæš‚ä¸”ç§°ä¸º ram startï¼‰ã€‚ç¨‹åºå…ˆä» ROM ä¸­å¯åŠ¨ï¼Œæœ€å…ˆå¯åŠ¨çš„éƒ¨åˆ†è¦å®ç°ä»£ç å¤åˆ¶åŠŸèƒ½ï¼ˆæŠŠæ•´ä¸ª ROM ä»£ç å¤åˆ¶åˆ° DDR å†…å­˜ä¸­ï¼‰ï¼Œå¹¶é€šè¿‡ LDR æŒ‡ä»¤æ¥è·³è½¬åˆ° DDR å†…å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨é“¾æ¥åœ°å€é‡Œè¿è¡Œ B æŒ‡ä»¤æ²¡æ³•å®ç°è¿™ä¸ªè·³è½¬ï¼‰ã€‚ä¸Šè¿°é‡å®šä½è¿‡ç¨‹åœ¨ U-Boot ä¸­å®ç°ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/relocation.png"></p><p>å½“è·³è½¬åˆ° Linux å†…æ ¸ä¸­æ—¶ï¼ŒU-Boot éœ€è¦æŠŠ Linux å†…æ ¸æ˜ åƒå†…å®¹å¤åˆ¶åˆ° DDR å†…å­˜ä¸­ï¼Œç„¶åè·³è½¬åˆ°å†…æ ¸å…¥å£åœ°å€å¤„ï¼ˆ stext å‡½æ•°ï¼‰ã€‚å½“è·³è½¬åˆ°å†…æ ¸å…¥å£åœ°å€ï¼ˆ stext å‡½æ•°ï¼‰æ—¶ï¼Œç¨‹åºè¿è¡Œåœ¨è¿è¡Œåœ°å€ï¼Œå³ DDR å†…å­˜çš„åœ°å€ã€‚ä½†æ˜¯æˆ‘ä»¬ä» vmlinux çœ‹åˆ°çš„ stext å‡½æ•°çš„é“¾æ¥åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ï¼ˆå†…æ ¸å¯åŠ¨æ±‡ç¼–ä»£ç ä¹Ÿéœ€è¦ä¸€ä¸ªé‡å®šä½è¿‡ç¨‹ã€‚è¿™ä¸ªé‡å®šä½è¿‡ç¨‹åœ¨__primary_switch() æ±‡ç¼–å‡½æ•°ä¸­å®Œæˆã€‚å¯åŠ¨ MMU ä¹‹åï¼Œé€šè¿‡ ldr æŒ‡ä»¤æŠŠ __primary_switched() å‡½æ•°çš„é“¾æ¥åœ°å€åŠ è½½åˆ° x8 å¯„å­˜å™¨ï¼Œç„¶åé€šè¿‡ br æŒ‡ä»¤è·³è½¬åˆ° __primary_switched() å‡½æ•°çš„é“¾æ¥åœ°å€å¤„ï¼Œä»è€Œå®ç°äº†é‡å®šä½ï¼Œå¦‚å›¾æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/kernspace.png"></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/kernel/head.S&gt;</span><br><span class="line">/*</span><br><span class="line"> * The following fragment of code is executed with the MMU enabled.</span><br><span class="line"> *</span><br><span class="line"> *   x0 = __PHYS_OFFSET</span><br><span class="line"> */</span><br><span class="line">SYM_FUNC_START_LOCAL(__primary_switched)</span><br><span class="line">adr_lx4, init_task</span><br><span class="line">init_cpu_task x4, x5, x6</span><br><span class="line"></span><br><span class="line">adr_lx8, vectors// load VBAR_EL1 with virtual</span><br><span class="line">msrvbar_el1, x8// vector table address</span><br><span class="line">isb</span><br><span class="line"></span><br><span class="line">stpx29, x30, [sp, #-16]!</span><br><span class="line">movx29, sp</span><br><span class="line"></span><br><span class="line">str_lx21, __fdt_pointer, x5// Save FDT pointer</span><br><span class="line"></span><br><span class="line">ldr_lx4, kimage_vaddr// Save the offset between</span><br><span class="line">subx4, x4, x0// the kernel virtual and</span><br><span class="line">str_lx4, kimage_voffset, x5// physical mappings</span><br><span class="line"></span><br><span class="line">// Clear BSS</span><br><span class="line">adr_lx0, __bss_start</span><br><span class="line">movx1, xzr</span><br><span class="line">adr_lx2, __bss_stop</span><br><span class="line">subx2, x2, x0</span><br><span class="line">bl__pi_memset</span><br><span class="line">dsbishst// Make zero page visible to PTW</span><br><span class="line"></span><br><span class="line">#if defined(CONFIG_KASAN_GENERIC) || defined(CONFIG_KASAN_SW_TAGS)</span><br><span class="line">blkasan_early_init</span><br><span class="line">#endif</span><br><span class="line">movx0, x21// pass FDT address in x0</span><br><span class="line">blearly_fdt_map// Try mapping the FDT early</span><br><span class="line">blinit_feature_override// Parse cpu feature overrides</span><br><span class="line">#ifdef CONFIG_RANDOMIZE_BASE</span><br><span class="line">tstx23, ~(MIN_KIMG_ALIGN - 1)// already running randomized?</span><br><span class="line">b.ne0f</span><br><span class="line">blkaslr_early_init// parse FDT for KASLR options</span><br><span class="line">cbzx0, 0f// KASLR disabled? just proceed</span><br><span class="line">orrx23, x23, x0// record KASLR offset</span><br><span class="line">ldpx29, x30, [sp], #16// we must enable KASLR, return</span><br><span class="line">ret// to __primary_switch()</span><br><span class="line">0:</span><br><span class="line">#endif</span><br><span class="line">blswitch_to_vhe// Prefer VHE if possible</span><br><span class="line">ldpx29, x30, [sp], #16</span><br><span class="line">blstart_kernel</span><br><span class="line">ASM_BUG()</span><br><span class="line">SYM_FUNC_END(__primary_switched)</span><br></pre></td></tr></tbody></table></figure><h1 id="ftrace">ftrace</h1><p>frace æœ€æ—©å‡ºç°åœ¨ Linux2.6.27 å†…æ ¸ä¸­ï¼Œå…¶è®¾è®¡ç›®æ ‡ç®€å•ï¼ŒåŸºäºé™æ€ä»£ç æ’æ¡©ï¼ˆstubï¼‰æŠ€æœ¯ï¼Œä¸éœ€è¦ç”¨æˆ·é€šè¿‡é¢å¤–çš„ç¼–ç¨‹æ¥å®šä¹‰ trace è¡Œä¸ºã€‚é™æ€ä»£ç æ’æ¡©æŠ€æœ¯æ¯”è¾ƒå¯é ï¼Œä¸ä¼šå› ä¸ºç”¨æˆ·ä½¿ç”¨ä¸å½“è€Œå¯¼è‡´å†…æ ¸å´©æºƒã€‚ ftrace çš„åå­—æºäº function trace åˆ©ç”¨ GCC çš„ profile ç‰¹æ€§åœ¨æ‰€æœ‰å‡½æ•°å…¥å£å¤„æ·»åŠ ä¸€æ®µæ’æ¡©ä»£ç ï¼Œ ftrace é‡è½½è¿™æ®µä»£ç æ¥å®ç° trace åŠŸèƒ½ã€‚GCC çš„-pg é€‰é¡¹ä¼šåœ¨æ¯ä¸ªå‡½æ•°å…¥å£å¤„åŠ å…¥ mcount çš„è°ƒç”¨ä»£ç ï¼ŒåŸæœ¬ mcount æœ‰ libc å®ç°ï¼Œè€Œå†…æ ¸ä¸ä¼šé“¾æ¥ libc åº“ï¼Œå› æ­¤ frace ç¼–å†™äº†è‡ªå·±çš„ mcount stub å‡½æ•°ã€‚ åœ¨ä½¿ç”¨ ftrace ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿å†…æ ¸ç¼–è¯‘é…ç½®é€‰é¡¹ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_FTRACE=y</span><br><span class="line">ONIFIG_HAVE_FUNCTION_TRACE=y</span><br><span class="line">CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y</span><br><span class="line">CONFIG_HAVE_DYNAMIC_FTRACE=y</span><br><span class="line">CONFIG_FUNCTIONL_TRACER=y</span><br><span class="line">CONFIG_IRQSOFE_TRACER=Y</span><br><span class="line">CONEIG_SCHED_TRACER=y</span><br><span class="line">CONFIG_ENABLE_DEFAULT_TRACERS=y</span><br><span class="line">CONFIG_FTRACE_SYSCALLS=y</span><br><span class="line">CONFIG_PREEMPT_TRACER=y</span><br></pre></td></tr></tbody></table></figure><p>ftrace çš„ç›¸å…³é…ç½®é€‰é¡¹æ¯”è¾ƒå¤šï¼Œé’ˆå¯¹ä¸åŒçš„è·Ÿè¸ªå™¨æœ‰å„è‡ªå¯¹åº”çš„é…ç½®é€‰é¡¹ã€‚ ftrace é€šè¿‡ debugfs æ–‡ä»¶ç³»ç»Ÿå‘ç”¨æˆ·ç©ºé—´æä¾›è®¿é—´æ¥å£ï¼Œå› æ­¤éœ€è¦åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æŒ‚è½½ debugfsï¼Œå¯ä»¥ä¿®æ”¹ç³»ç»Ÿçš„ /etc/fstab æ–‡ä»¶æˆ–æ‰‹åŠ¨æŒ‚è½½ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t debugfs debugfs/sys/kernel/debug</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ sys/kernel/debug/trace ç›®å½•ä¸‹æä¾›äº†å„ç§è·Ÿè¸ªå™¨ï¼ˆ tracerï¼‰å’Œäº‹ä»¶ï¼ˆ eventï¼‰ï¼Œä¸€äº›å¸¸ç”¨çš„é€‰é¡¹å¦‚ä¸‹ã€‚</p><ul><li>available_tracersï¼šåˆ—å‡ºå½“å‰ç³»ç»Ÿæ”¯æŒçš„è·Ÿè¸ªå™¨</li><li>available_eventsï¼šåˆ—å‡ºå½“å‰ç³»ç»Ÿæ”¯æŒçš„äº‹ä»¶</li><li>current_tracerï¼šè®¾ç½®å’Œæ˜¾ç¤ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„è·Ÿè¸ªå™¨ã€‚ä½¿ç”¨ echo å‘½ä»¤æŠŠè·Ÿè¸ªå™¨çš„åå­—å†™å…¥è¯¥æ–‡ä»¶ï¼Œå³å¯åˆ‡æ¢ä¸åŒçš„è·Ÿè¸ªå™¨ã€‚é»˜è®¤ä¸º nopï¼Œå³ä¸åšä»»ä½•è·Ÿè¸ªæ“ä½œ</li><li>trace: è¯»å–è·Ÿè¸ªä¿¡æ¯ã€‚é€šè¿‡ cat å‘½ä»¤æŸ¥çœ‹ ftrace è®°å½•ä¸‹æ¥çš„çœ¼è¸ªä¿¡æ¯</li><li>tracing_onï¼šç”¨äºå¼€å§‹æˆ–æš‚åœè·Ÿè¸ª</li><li>trace_optionsï¼šè®¾ç½® ftrace çš„ä¸€äº›ç›¸å…³é€‰é¡¹</li></ul><p>ftrace å½“å‰åŒ…å«å¤šä¸ªè·Ÿè¸ªå™¨ï¼Œæ–¹ä¾¿ç”¨æˆ·è·Ÿè¸ªä¸åŒç±»å‹çš„ä¿¡æ¯ï¼Œå¦‚è¿›ç¨‹ç¡çœ ã€å”¤é†’ã€æŠ¢å ã€å»¶è¿Ÿçš„ä¿¡æ¯ã€‚æŸ¥çœ‹ available_tracers å¯ä»¥çŸ¥é“å½“å‰ç³»ç»Ÿæ”¯æŒå“ªäº›è·Ÿè¸ªå™¨ï¼Œå¦‚æœç³»ç»Ÿæ”¯æŒçš„è·Ÿè¸ªå™¨ä¸Šæ²¡æœ‰ç”¨æˆ·æƒ³è¦çš„ã€‚é‚£å°±å¿…é¡»åœ¨é…ç½®å†…æ ¸æ—¶æ‰“å¼€ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ã€‚å¸¸ç”¨çš„ ftrace è·Ÿè¸ªå™¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>nopï¼šä¸è·Ÿè¸ªä»»ä½•ä¿¡æ¯ã€‚å°† nop å†™å…¥ current_tracer æ–‡ä»¶å¯ä»¥æ¸…ç©ºä¹‹å‰æ”¶é›†åˆ°çš„è·Ÿè¸ªä¿¡æ¯</li><li>functionï¼šè·Ÿè¸ªå†…æ ¸å‡½æ•°æ‰§è¡Œæƒ…å†µ</li><li>function_graphï¼šå¯ä»¥æ˜¾ç¤ºç±»ä¼¼äº C è¯­è¨€çš„å‡½æ•°è°ƒç”¨å…³ç³»å›¾ï¼Œæ¯”è¾ƒç›´è§‚</li><li>hwlatï¼šç”¨æ¥è·Ÿè¸ªä¸ç¡¬ä»¶ç›¸å…³çš„å»¶æ—¶</li><li>blkï¼šè·Ÿè¸ªå—è®¾å¤‡çš„å‡½æ•°</li><li>mmiotraceï¼šç”¨äºè·Ÿè¸ªå†…å­˜æ˜ å°„ I/O æ“ä½œ</li><li>wakeupï¼šè·Ÿè¸ªæ™®é€šä¼˜å…ˆçº§çš„è¿›ç¨‹ä»è·å¾—è°ƒåº¦åˆ°è¢«å”¤é†’çš„æœ€é•¿å»¶è¿Ÿæ—¶é—´</li><li>weakup_rtï¼šè·Ÿè¸ª RT ç±»å‹çš„ä»»åŠ¡ä»è·å¾—è°ƒåº¦åˆ°è¢«å”¤é†’çš„æœ€é•¿å»¶è¿Ÿæ—¶é—´</li><li>irqoffï¼šè·Ÿè¸ªå…³é—­ä¸­æ–­çš„ä¿¡æ¯ï¼Œå¹¶è®°å½•å…³é—­çš„æœ€å¤§æ—¶é•¿</li><li>preemptoffï¼šè·Ÿè¸ªå…³é—­ç¦æ­¢æŠ¢å çš„ä¿¡æ¯ï¼Œå¹¶è®°å½•å…³é—­çš„æœ€å¤§æ—¶é•¿</li></ul><h1 id="irqs-è·Ÿè¸ªå™¨">irqs è·Ÿè¸ªå™¨</h1><p>å½“ä¸­æ–­å…³é—­ï¼ˆä¿—ç§°å…³ä¸­æ–­ï¼‰åï¼ŒCPU å°±ä¸èƒ½å“åº”å…¶ä»–çš„äº‹ä»¶ã€‚å¦‚æœè¿™æ—¶æœ‰ä¸€ä¸ªé¼ æ ‡ä¸­æ–­ï¼Œè¦åœ¨ä¸‹ä¸€æ¬¡å¼€ä¸­æ–­æ—¶æ‰èƒ½å“åº”è¿™ä¸ªä¸­æ–­ï¼Œè¿™æ®µå»¶æ—¶ç§°ä¸ºä¸­æ–­å»¶è¿Ÿã€‚å‘ current_tracer æ–‡ä»¶å†™å…¥ irqsoff å­—ç¬¦ä¸²å³å¯æ‰“å¼€ irqsoff æ¥è·Ÿè¸ªä¸­æ–­å»¶è¿Ÿã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/kernel/debug/tracing/</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; options/function-trace //å…³é—­ funct-trace å¯ä»¥å‡å°‘ä¸€äº›å»¶é€€</span><br><span class="line"><span class="built_in">echo</span> irqsoff &gt; current_trace</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; tracing_on</span><br><span class="line">[...] //åœé¡¿ä¸€ä¼šå„¿</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; tracing_on</span><br><span class="line"><span class="built_in">cat</span> trace</span><br></pre></td></tr></tbody></table></figure><h1 id="function-tracing---no-modification-necessary">Function tracing - no modification necessary</h1><p>Ftrace æœ€å¼ºå¤§çš„è¿½è¸ªå™¨ä¹‹ä¸€æ˜¯å‡½æ•°è¿½è¸ªå™¨ã€‚å®ƒä½¿ç”¨ gcc çš„-pg é€‰é¡¹è®©å†…æ ¸ä¸­çš„æ¯ä¸ªå‡½æ•°è°ƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°â€œ mcount() â€ã€‚è¯¥å‡½æ•°å¿…é¡»åœ¨æ±‡ç¼–ä¸­å®ç°ï¼Œå› ä¸ºè°ƒç”¨ä¸éµå¾ªæ­£å¸¸çš„ C ABIã€‚</p><p>å½“é…ç½® CONFIG_DYNAMIC_FTRACE æ—¶ï¼Œè°ƒç”¨ä¼šåœ¨å¯åŠ¨æ—¶è½¬æ¢ä¸º NOPï¼Œä»¥ä¿æŒç³»ç»Ÿä»¥ 100% çš„æ€§èƒ½è¿è¡Œã€‚åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè®°å½•äº† mcount() è°ƒç”¨ç«™ç‚¹ã€‚è¯¥åˆ—è¡¨åœ¨å¯åŠ¨æ—¶ç”¨äºå°†è¿™äº›ç«™ç‚¹è½¬æ¢ä¸º NOPã€‚ç”±äº NOP å¯¹è·Ÿè¸ªæ¯«æ— ç”¨å¤„ï¼Œå› æ­¤å½“å¯ç”¨å‡½æ•°ï¼ˆæˆ–å‡½æ•°å›¾ï¼‰è·Ÿè¸ªå™¨æ—¶ï¼Œä¿å­˜è¯¥åˆ—è¡¨ä»¥å°†è°ƒç”¨ç«™ç‚¹è½¬æ¢å›è·Ÿè¸ªè°ƒç”¨ã€‚</p><p>ç”±äºæ­¤æ€§èƒ½å¢å¼ºï¼Œå¼ºçƒˆå»ºè®®å¯ç”¨ CONFIG_DYNAMIC_FTRACEã€‚æ­¤å¤–ï¼ŒCONFIG_DYNAMIC_FTRACE æä¾›äº†ç­›é€‰åº”è·Ÿè¸ªå“ªä¸ªå‡½æ•°çš„èƒ½åŠ›ã€‚è¯·æ³¨æ„ï¼Œå³ä½¿ NOP åœ¨åŸºå‡†æµ‹è¯•ä¸­æ²¡æœ‰æ˜¾ç¤ºä»»ä½•å½±å“ï¼Œä½†å·²çŸ¥æ·»åŠ -pg é€‰é¡¹é™„å¸¦çš„å¸§æŒ‡é’ˆä¼šå¯¼è‡´è½»å¾®çš„å¼€é”€ã€‚</p><p>è¦æ‰¾å‡ºå“ªäº›è·Ÿè¸ªå™¨å¯ç”¨ï¼Œåªéœ€åœ¨è·Ÿè¸ªç›®å½•ä¸­æŸ¥æ‰¾ available_tracers æ–‡ä»¶å³å¯ ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat available_tracers</span></span><br><span class="line">function_graph <span class="keyword">function</span> sched_switch nop</span><br></pre></td></tr></tbody></table></figure><p>è¦å¯ç”¨å‡½æ•°è·Ÿè¸ªå™¨ï¼Œåªéœ€å°†â€œfunctionâ€ echo åˆ° current_tracer æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo function &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># cat current_tracer</span></span><br><span class="line"><span class="keyword">function</span></span><br><span class="line"></span><br><span class="line">[tracing]<span class="comment"># cat trace | head -10</span></span><br><span class="line"><span class="comment"># tracer: function</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#           TASK-PID    CPU#    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |          |         |</span></span><br><span class="line">            bash-16939 [000]  6075.461561: mutex_unlock &lt;-tracing_set_tracer</span><br><span class="line">          &lt;idle&gt;-0     [001]  6075.461561: _spin_unlock_irqrestore &lt;-hrtimer_get_next_event</span><br><span class="line">          &lt;idle&gt;-0     [001]  6075.461562: rcu_needs_cpu &lt;-tick_nohz_stop_sched_tick</span><br><span class="line">            bash-16939 [000]  6075.461563: inotify_inode_queue_event &lt;-vfs_write</span><br><span class="line">          &lt;idle&gt;-0     [001]  6075.461563: mwait_idle &lt;-cpu_idle</span><br><span class="line">            bash-16939 [000]  6075.461563: __fsnotify_parent &lt;-vfs_write</span><br></pre></td></tr></tbody></table></figure><p>æ ‡é¢˜å¾ˆå¥½åœ°è§£é‡Šäº†è¾“å‡ºçš„æ ¼å¼ã€‚å‰ä¸¤é¡¹æ˜¯è·Ÿè¸ªçš„ä»»åŠ¡åç§°å’Œ PIDã€‚æ‰§è¡Œè·Ÿè¸ªçš„ CPU ä½äºæ‹¬å·å†…ã€‚æ—¶é—´æˆ³æ˜¯è‡ªå¯åŠ¨ä»¥æ¥çš„æ—¶é—´ï¼Œåè·Ÿå‡½æ•°åç§°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°æ˜¯è¢«è·Ÿè¸ªçš„å‡½æ•°ï¼Œå…¶çˆ¶å‡½æ•°è·Ÿåœ¨â€œ &lt;- â€ç¬¦å·ä¹‹åã€‚</p><p>è¿™äº›ä¿¡æ¯éå¸¸å¼ºå¤§ï¼Œå¹¶ä¸”å¾ˆå¥½åœ°æ˜¾ç¤ºäº†å‡½æ•°çš„æµç¨‹ã€‚ä½†è¿™å¯èƒ½æœ‰ç‚¹éš¾ä»¥éµå¾ªã€‚ç”± Frederic Weisbecker åˆ›å»ºçš„å‡½æ•°å›¾è·Ÿè¸ªå™¨è·Ÿè¸ªå‡½æ•°çš„è¿›å…¥å’Œé€€å‡ºï¼Œè¿™ä½¿è·Ÿè¸ªå™¨èƒ½å¤Ÿäº†è§£è¢«è°ƒç”¨å‡½æ•°çš„æ·±åº¦ã€‚å‡½æ•°å›¾è·Ÿè¸ªå™¨å¯ä»¥ä½¿äººçœ¼æ›´å®¹æ˜“è·Ÿè¸ªå†…æ ¸ä¸­çš„æ‰§è¡Œæµç¨‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># cat trace | head -20</span></span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |   |                     |   |   |   |</span></span><br><span class="line"> 1)   1.015 us    |        _spin_lock_irqsave();</span><br><span class="line"> 1)   0.476 us    |        internal_add_timer();</span><br><span class="line"> 1)   0.423 us    |        wake_up_idle_cpu();</span><br><span class="line"> 1)   0.461 us    |        _spin_unlock_irqrestore();</span><br><span class="line"> 1)   4.770 us    |      }</span><br><span class="line"> 1)   5.725 us    |    }</span><br><span class="line"> 1)   0.450 us    |    mutex_unlock();</span><br><span class="line"> 1) + 24.243 us   |  }</span><br><span class="line"> 1)   0.483 us    |  _spin_lock_irq();</span><br><span class="line"> 1)   0.517 us    |  _spin_unlock_irq();</span><br><span class="line"> 1)               |  <span class="function"><span class="title">prepare_to_wait</span></span>() {</span><br><span class="line"> 1)   0.468 us    |    _spin_lock_irqsave();</span><br><span class="line"> 1)   0.502 us    |    _spin_unlock_irqrestore();</span><br><span class="line"> 1)   2.411 us    |  }</span><br><span class="line"> 1)   0.449 us    |  kthread_should_stop();</span><br><span class="line"> 1)               |  <span class="function"><span class="title">schedule</span></span>() {</span><br></pre></td></tr></tbody></table></figure><p>è¿™ç»™å‡ºäº†ä¸€ä¸ªå‡½æ•°çš„å¼€å§‹å’Œç»“æŸï¼Œç”¨ç±»ä¼¼ C çš„æ³¨é‡Šâ€œ { â€æ¥å¯åŠ¨ä¸€ä¸ªå‡½æ•°ï¼Œâ€œ } â€åœ¨æœ«å°¾ã€‚å¶å‡½æ•°ä¸è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œåªæ˜¯ä»¥â€œ ; â€ç»“å°¾ã€‚DURATION åˆ—æ˜¾ç¤ºåœ¨ç›¸åº”å‡½æ•°ä¸­èŠ±è´¹çš„æ—¶é—´ã€‚å‡½æ•°å›¾è·Ÿè¸ªå™¨è®°å½•å‡½æ•°è¿›å…¥å’Œé€€å‡ºçš„æ—¶é—´ï¼Œå¹¶å°†å·®å¼‚æŠ¥å‘Šä¸ºæŒç»­æ—¶é—´ã€‚è¿™äº›æ•°å­—åªå‡ºç°åœ¨å¶å‡½æ•°å’Œâ€œ }" ç¬¦å·ã€‚æ³¨æ„ï¼Œè¿™æ¬¡è¿˜åŒ…æ‹¬åµŒå¥—å‡½æ•°å†…æ‰€æœ‰å‡½æ•°çš„å¼€é”€ä»¥åŠå‡½æ•°å›¾è·Ÿè¸ªå™¨æœ¬èº«çš„å¼€é”€ã€‚å‡½æ•°å›¾è·Ÿè¸ªå™¨åŠ«æŒäº†å‡½æ•°çš„è¿”å›åœ°å€ï¼Œä»¥ä¾¿ä¸ºå‡½æ•°æ’å…¥è·Ÿè¸ªå›è°ƒå‡½æ•°é€€å‡ºã€‚è¿™ä¼šç ´å CPU çš„åˆ†æ”¯é¢„æµ‹å¹¶å¯¼è‡´æ¯”å‡½æ•°è·Ÿè¸ªå™¨æ›´å¤šçš„å¼€é”€ã€‚æœ€æ¥è¿‘çš„çœŸå®æ—¶åºä»…å‘ç”Ÿåœ¨å¶å‡½æ•°ä¸­ã€‚</p><p>å­¤ç‹¬çš„â€œ + â€æ˜¯æœ‰ä¸€ä¸ªæ³¨é‡Šæ ‡è®°ã€‚å½“æŒç»­æ—¶é—´å¤§äº 10 å¾®ç§’æ—¶ï¼Œæ˜¾ç¤ºâ€œ + â€ã€‚å¦‚æœæŒç»­æ—¶é—´å¤§äº 100 å¾®ç§’ï¼Œå°†æ˜¾ç¤ºâ€œ ï¼ â€ã€‚</p><h1 id="using-trace_printk">Using trace_printk()</h1><p>printk() æ˜¯æ‰€æœ‰è°ƒè¯•å™¨ä¹‹ç‹ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœæ‚¨æ­£åœ¨è°ƒè¯•è¯¸å¦‚å®šæ—¶å™¨ä¸­æ–­ã€è°ƒåº¦ç¨‹åºæˆ–ç½‘ç»œä¹‹ç±»çš„å¤§å®¹é‡åŒºåŸŸï¼Œprintk() å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿé™·å…¥å›°å¢ƒï¼Œç”šè‡³å¯èƒ½ä¼šåˆ›å»ºå®æ—¶é”ã€‚æ·»åŠ ä¸€äº› printk() æ—¶ï¼Œçœ‹åˆ°é”™è¯¯â€œæ¶ˆå¤±â€ä¹Ÿå¾ˆå¸¸è§ã€‚è¿™æ˜¯ç”±äº printk() å¼•å…¥çš„ç»å¯¹å¼€é”€ã€‚</p><p>Ftrace å¼•å…¥äº†ä¸€ç§æ–°å½¢å¼çš„ printk() ç§°ä¸º trace_printk()ã€‚å®ƒå¯ä»¥åƒ printk() ä¸€æ ·ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»ä½•ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼ˆä¸­æ–­ä»£ç ã€NMI ä»£ç å’Œè°ƒåº¦ç¨‹åºä»£ç ï¼‰ã€‚æ˜¯ä»€ä¹ˆæ ·çš„å¥½çš„ trace_printk() æ˜¯ï¼Œå®ƒä¸ä¼šè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚ç›¸åï¼Œå®ƒå†™å…¥ Ftrace ç¯å½¢ç¼“å†²åŒºï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è·Ÿè¸ªæ–‡ä»¶è¯»å–ã€‚</p><p>ä½¿ç”¨ trace_printk() å†™å…¥ç¯å½¢ç¼“å†²åŒºåªéœ€è¦å¤§çº¦ååˆ†ä¹‹ä¸€å¾®ç§’å·¦å³ã€‚ä½†æ˜¯ä½¿ç”¨ printk()ï¼Œå°¤å…¶æ˜¯åœ¨å†™å…¥ä¸²è¡Œæ§åˆ¶å°æ—¶ï¼Œæ¯æ¬¡å†™å…¥å¯èƒ½éœ€è¦å‡ æ¯«ç§’ã€‚trace_printk() çš„æ€§èƒ½ä¼˜åŠ¿ ä½¿æ‚¨å¯ä»¥è®°å½•å†…æ ¸ä¸­æœ€æ•æ„Ÿçš„åŒºåŸŸï¼Œè€Œå‡ ä¹æ²¡æœ‰å½±å“ã€‚</p><p>ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†è¿™æ ·çš„å†…å®¹æ·»åŠ åˆ°å†…æ ¸æˆ–æ¨¡å—ä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace_printk(<span class="string">"read foo %d out of bar %p\n"</span>, bar-&gt;foo, bar);</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åé€šè¿‡æŸ¥çœ‹è·Ÿè¸ªæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ‚¨çš„è¾“å‡ºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat trace</span></span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#           TASK-PID    CPU#    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |          |         |</span></span><br><span class="line">           &lt;...&gt;-10690 [003] 17279.332920: : <span class="built_in">read</span> foo 10 out of bar ffff880013a5bef8</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹æ˜¯é€šè¿‡æ·»åŠ ä¸€ä¸ªå®é™…ä¸Šå…·æœ‰ foo å’Œ bar æ„é€ çš„æ¨¡å—æ¥å®Œæˆçš„ ã€‚</p><p>trace_printk() è¾“å‡ºå°†å‡ºç°åœ¨ä»»ä½•è·Ÿè¸ªå™¨ä¸­ï¼Œç”šè‡³æ˜¯å‡½æ•°å’Œå‡½æ•°å›¾è·Ÿè¸ªå™¨ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># insmod ~/modules/foo.ko</span></span><br><span class="line">[tracing]<span class="comment"># cat trace</span></span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |   |                     |   |   |   |</span></span><br><span class="line"> 3) + 16.283 us   |      }</span><br><span class="line"> 3) + 17.364 us   |    }</span><br><span class="line"> 3)               |    <span class="function"><span class="title">do_one_initcall</span></span>() {</span><br><span class="line"> 3)               |      /* <span class="built_in">read</span> foo 10 out of bar ffff88001191bef8 */</span><br><span class="line"> 3)   4.221 us    |    }</span><br><span class="line"> 3)               |    <span class="function"><span class="title">__wake_up</span></span>() {</span><br><span class="line"> 3)   0.633 us    |      _spin_lock_irqsave();</span><br><span class="line"> 3)   0.538 us    |      __wake_up_common();</span><br><span class="line"> 3)   0.563 us    |      _spin_unlock_irqrestore();</span><br></pre></td></tr></tbody></table></figure><p>æ˜¯çš„ï¼Œtrace_printk() è¾“å‡ºçœ‹èµ·æ¥åƒå‡½æ•°å›¾è·Ÿè¸ªå™¨ä¸­çš„æ³¨é‡Šã€‚</p><h1 id="starting-and-stopping-the-trace">Starting and stopping the trace</h1><p>æ˜¾ç„¶ï¼Œæœ‰æ—¶æ‚¨åªæƒ³è·Ÿè¸ªç‰¹å®šçš„ä»£ç è·¯å¾„ã€‚ä¹Ÿè®¸æ‚¨åªæƒ³è·Ÿè¸ªè¿è¡Œç‰¹å®šæµ‹è¯•æ—¶å‘ç”Ÿçš„æƒ…å†µã€‚æ–‡ä»¶ tracing_on ç”¨äºç¦æ­¢ç¯å½¢ç¼“å†²åŒºè®°å½•æ•°æ®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; tracking_on</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™å°†ç¦ç”¨ Ftrace ç¯å½¢ç¼“å†²åŒºçš„è®°å½•ã€‚å…¶ä»–æ‰€æœ‰äº‹æƒ…ä»ç„¶å‘ç”Ÿåœ¨è·Ÿè¸ªå™¨ä¸Šï¼Œå®ƒä»¬ä»ç„¶ä¼šäº§ç”Ÿå¤§éƒ¨åˆ†å¼€é”€ã€‚ä»–ä»¬ç¡®å®æ³¨æ„åˆ°ç¯å½¢ç¼“å†²åŒºæ²¡æœ‰è®°å½•ï¼Œä¹Ÿä¸ä¼šå°è¯•å†™å…¥ä»»ä½•æ•°æ®ï¼Œä½†ä»ä¼šæ‰§è¡Œè·Ÿè¸ªå™¨å‘å‡ºçš„è°ƒç”¨ã€‚</p><p>è¦é‡æ–°å¯ç”¨ç¯å½¢ç¼“å†²åŒºï¼Œåªéœ€å°†â€œ1â€å†™å…¥è¯¥æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 1 &gt;tracing_on</span></span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œåœ¨æ•°å­—å’Œå¤§äºå·â€œ &gt; â€ä¹‹é—´æœ‰ä¸€ä¸ªç©ºæ ¼éå¸¸é‡è¦ã€‚å¦åˆ™ï¼Œæ‚¨å¯èƒ½æ­£åœ¨å°†æ ‡å‡†è¾“å…¥æˆ–è¾“å‡ºå†™å…¥è¯¥æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0&gt;tracing_on /* è¿™è¡Œä¸é€šï¼*/</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸€ä¸ªå¸¸è§çš„è¿è¡Œå¯èƒ½æ˜¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; tracing_on</span></span><br><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># echo 1 &gt; tracing_on; run_test; echo 0 &gt; tracing_on</span></span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ä¸€è¡Œç¦æ­¢ç¯å½¢ç¼“å†²åŒºè®°å½•ä»»ä½•æ•°æ®ã€‚æ¥ä¸‹æ¥å¯ç”¨å‡½æ•°å›¾è·Ÿè¸ªå™¨ã€‚å‡½æ•°å›¾è·Ÿè¸ªå™¨çš„å¼€é”€ä»ç„¶å­˜åœ¨ï¼Œä½†ä¸ä¼šå°†ä»»ä½•å†…å®¹è®°å½•åˆ°è·Ÿè¸ªç¼“å†²åŒºä¸­ã€‚æœ€åä¸€è¡Œå¯ç”¨ç¯å½¢ç¼“å†²åŒºï¼Œè¿è¡Œæµ‹è¯•ç¨‹åºï¼Œç„¶åç¦ç”¨ç¯å½¢ç¼“å†²åŒºã€‚è¿™ç¼©å°äº†å‡½æ•°å›¾è·Ÿè¸ªå™¨å­˜å‚¨çš„æ•°æ®èŒƒå›´ï¼Œä»¥ä»…åŒ…æ‹¬ run_test ç¨‹åºç§¯ç´¯çš„æ•°æ® ã€‚</p><h1 id="trace-markers">Trace Markers</h1><p>æŸ¥çœ‹å†…æ ¸å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…å¯ä»¥è®©ç”¨æˆ·æ›´å¥½åœ°äº†è§£ä»–ä»¬çš„ç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ä½†æœ‰æ—¶éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å‘ç”Ÿçš„äº‹æƒ…å’Œå†…æ ¸å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ä¹‹é—´è¿›è¡Œåè°ƒã€‚è·Ÿè¸ªä¸­æ˜¾ç¤ºçš„æ—¶é—´æˆ³éƒ½ä¸è·Ÿè¸ªä¸­å‘ç”Ÿçš„äº‹æƒ…æœ‰å…³ï¼Œä½†å®ƒä»¬ä¸å¢™æ—¶é—´ä¸å¤ªå¯¹åº”ã€‚</p><p>ä¸ºäº†å¸®åŠ©åŒæ­¥ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¸­çš„æ“ä½œï¼Œåˆ›å»ºäº† trace_marker æ–‡ä»¶ã€‚å®ƒæä¾›äº†ä¸€ç§ä»ç”¨æˆ·ç©ºé—´å†™å…¥ Ftrace ç¯å½¢ç¼“å†²åŒºçš„æ–¹æ³•ã€‚è¯¥æ ‡è®°éšåå°†å‡ºç°åœ¨è½¨è¿¹ä¸­ï¼Œä»¥ç»™å‡ºè½¨è¿¹ä¸­ç‰¹å®šäº‹ä»¶å‘ç”Ÿçš„ä½ç½®ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo hello world &gt; trace_marker</span></span><br><span class="line">[tracing]<span class="comment"># cat trace</span></span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#           TASK-PID    CPU#    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |          |         |</span></span><br><span class="line">           &lt;...&gt;-3718  [001]  5546.183420: 0: hello world</span><br></pre></td></tr></tbody></table></figure><p>åœ¨&lt;...&gt;è¡¨ç¤ºè¯¥å†™çš„æ ‡è®°ä»»åŠ¡çš„åå­—æ²¡æœ‰è®°å½•ã€‚æœªæ¥çš„ç‰ˆæœ¬å¯èƒ½ä¼šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="starting-stopping-and-recording-in-a-program">Starting, Stopping and Recording in a Program</h1><p>è¯¥ tracing_on å’Œ trace_marker æ–‡ä»¶çš„å·¥ä½œå¾ˆå¥½åœ°è·Ÿè¸ªåº”ç”¨ç¨‹åºçš„æ´»åŠ¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºçš„æºå¯ç”¨ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸­å­˜åœ¨é—®é¢˜å¹¶ä¸”æ‚¨éœ€è¦æ‰¾å‡ºåº”ç”¨ç¨‹åºç‰¹å®šä½ç½®çš„å†…æ ¸å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><p>åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‚¨å¯ä»¥æ‰“å¼€è¿™äº›æ–‡ä»¶ä»¥å‡†å¤‡å¥½æ–‡ä»¶æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> trace_fd = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> marker_fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">{</span><br><span class="line"> <span class="type">char</span> *debugfs;</span><br><span class="line"> <span class="type">char</span> path[<span class="number">256</span>];</span><br><span class="line"> [...]</span><br><span class="line"></span><br><span class="line"> debugfs = find_debugfs();</span><br><span class="line"> <span class="keyword">if</span> (debugfs) {</span><br><span class="line">  <span class="built_in">strcpy</span>(path, debugfs);  <span class="comment">/* BEWARE buffer overflow */</span></span><br><span class="line">  <span class="built_in">strcat</span>(path,<span class="string">"/tracing/tracing_on"</span>);</span><br><span class="line">  trace_fd = open(path, O_WRONLY);</span><br><span class="line">  <span class="keyword">if</span> (trace_fd &gt;= <span class="number">0</span>)</span><br><span class="line">   write(trace_fd, <span class="string">"1"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(path, debugfs);</span><br><span class="line">  <span class="built_in">strcat</span>(path,<span class="string">"/tracing/trace_marker"</span>);</span><br><span class="line">  marker_fd = open(path, O_WRONLY);</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åï¼Œåœ¨ä»£ç ä¸­çš„æŸä¸ªå…³é”®ä½ç½®ï¼Œå¯ä»¥æ”¾ç½®æ ‡è®°ä»¥æ˜¾ç¤ºåº”ç”¨ç¨‹åºå½“å‰æ‰€åœ¨çš„ä½ç½®ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (marker_fd &gt;= <span class="number">0</span>)</span><br><span class="line"> write(marker_fd, <span class="string">"In critical area\n"</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (critical_function() &lt; <span class="number">0</span>) {</span><br><span class="line"> <span class="comment">/* we failed! */</span></span><br><span class="line"> <span class="keyword">if</span> (trace_fd &gt;= <span class="number">0</span>)</span><br><span class="line">  write(trace_fd, <span class="string">"0"</span>, <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨æŸ¥çœ‹ç¤ºä¾‹æ—¶ï¼Œæ‚¨é¦–å…ˆä¼šçœ‹åˆ°ä¸€ä¸ªåä¸ºâ€œfind_debugfs()â€çš„å‡½æ•°ã€‚æŒ‚è½½è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿçš„æ­£ç¡®ä½ç½®æ˜¯/sys/kernel/debug ä½†å¼ºå¤§çš„å·¥å…·ä¸åº”ä¾èµ–äºæŒ‚è½½åœ¨é‚£é‡Œçš„è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿã€‚find_debugfs() çš„ç¤ºä¾‹ ä½äºæ­¤å¤„ã€‚æ–‡ä»¶æè¿°ç¬¦è¢«åˆå§‹åŒ–ä¸º -1 ä»¥å…è®¸æ­¤ä»£ç åœ¨å¯ç”¨å’Œä¸å¯ç”¨è·Ÿè¸ªçš„å†…æ ¸çš„æƒ…å†µä¸‹å·¥ä½œã€‚</p><p>å½“æ£€æµ‹åˆ°é—®é¢˜æ—¶ï¼Œå°† ASCII å­—ç¬¦â€œ0â€å†™å…¥ trace_fd æ–‡ä»¶æè¿°ç¬¦å°†åœæ­¢è·Ÿè¸ªã€‚æ­£å¦‚åœ¨ç¬¬ 1 éƒ¨åˆ†ä¸­è®¨è®ºçš„é‚£æ ·ï¼Œè¿™åªä¼šç¦ç”¨è®°å½•åˆ° Ftrace ç¯å½¢ç¼“å†²åŒºä¸­ï¼Œä½†è·Ÿè¸ªå™¨ä»ç„¶ä¼šäº§ç”Ÿå¼€é”€ã€‚</p><p>ä½¿ç”¨ä¸Šé¢çš„åˆå§‹åŒ–ä»£ç æ—¶ï¼Œè·Ÿè¸ªå°†åœ¨åº”ç”¨ç¨‹åºå¼€å§‹æ—¶å¯ç”¨ï¼Œå› ä¸ºè·Ÿè¸ªå™¨ä»¥è¦†ç›–æ¨¡å¼è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è·Ÿè¸ªç¼“å†²åŒºå¡«æ»¡æ—¶ï¼Œå®ƒå°†åˆ é™¤æ—§æ•°æ®å¹¶ç”¨æ–°æ•°æ®æ›¿æ¢å®ƒã€‚ç”±äºåœ¨å‡ºç°é—®é¢˜æ—¶åªæœ‰æœ€è¿‘çš„è·Ÿè¸ªä¿¡æ¯æ˜¯ç›¸å…³çš„ï¼Œå› æ­¤åœ¨åº”ç”¨ç¨‹åºæ­£å¸¸è¿è¡ŒæœŸé—´æ— éœ€åœæ­¢å’Œå¯åŠ¨è·Ÿè¸ªã€‚åªæœ‰åœ¨æ£€æµ‹åˆ°é—®é¢˜æ—¶æ‰éœ€è¦ç¦ç”¨è·Ÿè¸ªå™¨ï¼Œä»¥ä¾¿è·Ÿè¸ªè®°å½•å¯¼è‡´é”™è¯¯çš„å†å²è®°å½•ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸­éœ€è¦é—´éš”è·Ÿè¸ªï¼Œå®ƒå¯ä»¥å°† ASCIIâ€œ1â€å†™å…¥ trace_fd ä»¥å¯ç”¨è·Ÿè¸ªã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåä¸º simple_trace.c çš„ç®€å•ç¨‹åºç¤ºä¾‹ï¼Œ å®ƒä½¿ç”¨ä¸Šè¿°åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">req.tv_sec = <span class="number">0</span>;</span><br><span class="line">req.tv_nsec = <span class="number">1000</span>;</span><br><span class="line">write(marker_fd, <span class="string">"before nano\n"</span>, <span class="number">12</span>);</span><br><span class="line">nanosleep(&amp;req, <span class="literal">NULL</span>);</span><br><span class="line">write(marker_fd, <span class="string">"after nano\n"</span>, <span class="number">11</span>);</span><br><span class="line">write(trace_fd, <span class="string">"0"</span>, <span class="number">1</span>);</span><br></pre></td></tr></tbody></table></figure><p>ï¼ˆç”±äºè¿™æ˜¯ä¸€ä¸ªä»…ç”¨äºç¤ºä¾‹ç›®çš„çš„ç®€å•ç¨‹åºï¼Œå› æ­¤æœªæ·»åŠ é”™è¯¯æ£€æŸ¥ã€‚ï¼‰ è¿™æ˜¯è·Ÿè¸ªè¿™ä¸ªç®€å•ç¨‹åºçš„è¿‡ç¨‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; tracing_on</span></span><br><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># ~/simple_trace</span></span><br><span class="line">[tracing]<span class="comment"># cat trace</span></span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ä¸€è¡Œç¦ç”¨è·Ÿè¸ªï¼Œå› ä¸ºç¨‹åºå°†åœ¨å¯åŠ¨æ—¶å¯ç”¨å®ƒã€‚æ¥ä¸‹æ¥é€‰æ‹©å‡½æ•°å›¾è·Ÿè¸ªå™¨ã€‚ç¨‹åºè¢«æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹ã€‚è¯·æ³¨æ„ï¼Œè¾“å‡ºå¯èƒ½æœ‰ç‚¹å†—é•¿ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†å†…å®¹å·²è¢«åˆ é™¤å¹¶æ›¿æ¢ä¸º [...]ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">  0)               |      <span class="function"><span class="title">__kmalloc</span></span>() {</span><br><span class="line">  0)   0.528 us    |        get_slab();</span><br><span class="line">  0)   2.271 us    |      }</span><br><span class="line">  0)               |      /* before nano */</span><br><span class="line">  0)               |      <span class="function"><span class="title">kfree</span></span>() {</span><br><span class="line">  0)   0.475 us    |        __phys_addr();</span><br><span class="line">  0)   2.062 us    |      }</span><br><span class="line">  0)   0.608 us    |      inotify_inode_queue_event();</span><br><span class="line">  0)   0.485 us    |      __fsnotify_parent();</span><br><span class="line"> [...]</span><br><span class="line">  1)   0.523 us    |          _spin_unlock();</span><br><span class="line">  0)   0.495 us    |    current_kernel_time();</span><br><span class="line">  1)               |          <span class="function"><span class="title">it_real_fn</span></span>() {</span><br><span class="line">  0)   1.602 us    |  }</span><br><span class="line">  1)   0.728 us    |            __rcu_read_lock();</span><br><span class="line">  0)               |  <span class="function"><span class="title">sys_nanosleep</span></span>() {</span><br><span class="line">  0)               |    <span class="function"><span class="title">hrtimer_nanosleep</span></span>() {</span><br><span class="line">  0)   0.526 us    |      hrtimer_init();</span><br><span class="line">  1)   0.418 us    |            __rcu_read_lock();</span><br><span class="line">  0)               |      <span class="function"><span class="title">do_nanosleep</span></span>() {</span><br><span class="line">  1)   1.114 us    |            _spin_lock_irqsave();</span><br><span class="line"> [...]</span><br><span class="line">  0)               |      <span class="function"><span class="title">__kmalloc</span></span>() {</span><br><span class="line">  1)   2.760 us    |  }</span><br><span class="line">  0)   0.556 us    |        get_slab();</span><br><span class="line">  1)               |  <span class="function"><span class="title">mwait_idle</span></span>() {</span><br><span class="line">  0)   1.851 us    |      }</span><br><span class="line">  0)               |      /* after nano */</span><br><span class="line">  0)               |      <span class="function"><span class="title">kfree</span></span>() {</span><br><span class="line">  0)   0.486 us    |        __phys_addr();</span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œå¯¹ trace_marker çš„å†™å…¥åœ¨å‡½æ•°å›¾è·Ÿè¸ªå™¨ä¸­æ˜¾ç¤ºä¸ºæ³¨é‡Šã€‚ è¿™é‡Œçš„ç¬¬ä¸€åˆ—ä»£è¡¨ CPUã€‚å½“æˆ‘ä»¬åƒè¿™æ ·äº¤é”™ CPU è·Ÿè¸ªæ—¶ï¼Œå¯èƒ½å¾ˆéš¾è¯»å–è·Ÿè¸ªã€‚å·¥å…· grep å¯ä»¥å¾ˆå®¹æ˜“åœ°è¿‡æ»¤å®ƒï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ per_cpu è·Ÿè¸ªæ–‡ä»¶ã€‚ per_cpu è·Ÿè¸ªæ–‡ä»¶ä½äº per_cpu ä¸‹çš„ debugfs è·Ÿè¸ªç›®å½•ä¸­ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># ls per_cpu</span></span><br><span class="line">cpu0  cpu1  cpu2  cpu3  cpu4  cpu5  cpu6  cpu7</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™äº› CPU ç›®å½•ä¸­çš„æ¯ä¸€ä¸ªç›®å½•ä¸­éƒ½å­˜åœ¨ä¸€ä¸ªè·Ÿè¸ªæ–‡ä»¶ï¼Œä»…æ˜¾ç¤ºè¯¥ CPU çš„è·Ÿè¸ªã€‚ è¦åœ¨ä¸å—å…¶ä»– CPU å¹²æ‰°çš„æƒ…å†µä¸‹æ›´å¥½åœ°äº†è§£å‡½æ•°å›¾è·Ÿè¸ªå™¨ï¼Œåªéœ€æŸ¥çœ‹ per_cpu/cpu0/traceã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat per_cpu/cpu0/trace</span></span><br><span class="line"> 0)               |      <span class="function"><span class="title">__kmalloc</span></span>() {</span><br><span class="line"> 0)   0.528 us    |        get_slab();</span><br><span class="line"> 0)   2.271 us    |      }</span><br><span class="line"> 0)               |      /* before nano */</span><br><span class="line"> 0)               |      <span class="function"><span class="title">kfree</span></span>() {</span><br><span class="line"> 0)   0.475 us    |        __phys_addr();</span><br><span class="line"> 0)   2.062 us    |      }</span><br><span class="line"> 0)   0.608 us    |      inotify_inode_queue_event();</span><br><span class="line"> 0)   0.485 us    |      __fsnotify_parent();</span><br><span class="line"> 0)   0.488 us    |      inotify_dentry_parent_queue_event();</span><br><span class="line"> 0)   1.106 us    |      fsnotify();</span><br><span class="line">[...]</span><br><span class="line"> 0)   0.721 us    |    _spin_unlock_irqrestore();</span><br><span class="line"> 0)   3.380 us    |  }</span><br><span class="line"> 0)               |  <span class="function"><span class="title">audit_syscall_entry</span></span>() {</span><br><span class="line"> 0)   0.495 us    |    current_kernel_time();</span><br><span class="line"> 0)   1.602 us    |  }</span><br><span class="line"> 0)               |  <span class="function"><span class="title">sys_nanosleep</span></span>() {</span><br><span class="line"> 0)               |    <span class="function"><span class="title">hrtimer_nanosleep</span></span>() {</span><br><span class="line"> 0)   0.526 us    |      hrtimer_init();</span><br><span class="line"> 0)               |      <span class="function"><span class="title">do_nanosleep</span></span>() {</span><br><span class="line"> 0)               |        <span class="function"><span class="title">hrtimer_start_range_ns</span></span>() {</span><br><span class="line"> 0)               |          <span class="function"><span class="title">__hrtimer_start_range_ns</span></span>() {</span><br><span class="line"> 0)               |            <span class="function"><span class="title">lock_hrtimer_base</span></span>() {</span><br><span class="line"> 0)   0.866 us    |              _spin_lock_irqsave();</span><br><span class="line">[...]</span><br><span class="line"> 0)               |      <span class="function"><span class="title">__kmalloc</span></span>() {</span><br><span class="line"> 0)               |        <span class="function"><span class="title">get_slab</span></span>() {</span><br><span class="line"> 0)   1.851 us    |      }</span><br><span class="line"> 0)               |      /* after nano */</span><br><span class="line"> 0)               |      <span class="function"><span class="title">kfree</span></span>() {</span><br><span class="line"> 0)   0.486 us    |        __phys_addr();</span><br></pre></td></tr></tbody></table></figure><h1 id="disabling-the-tracer-within-the-kernel">Disabling the Tracer Within the Kernel</h1><p>åœ¨å†…æ ¸é©±åŠ¨ç¨‹åºçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå­˜åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°çš„å¥‡æ€ªé”™è¯¯ã€‚ä¹Ÿè®¸é©±åŠ¨é™·å…¥ç¡çœ çŠ¶æ€ï¼Œæ°¸è¿œä¸ä¼šé†’æ¥ã€‚å½“å†…æ ¸äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¯•å›¾ä»ç”¨æˆ·ç©ºé—´ç¦ç”¨è·Ÿè¸ªå™¨æ˜¯å¾ˆå›°éš¾çš„ï¼Œé€šå¸¸ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºå’Œç›¸å…³ä¿¡æ¯ä¸¢å¤±ï¼Œç„¶åç”¨æˆ·æ‰èƒ½åœæ­¢è·Ÿè¸ªã€‚</p><p>æœ‰ä¸¤ä¸ªåœ¨å†…æ ¸ä¸­è¿è¡Œè‰¯å¥½çš„å‡½æ•°ï¼š tracing_on() å’Œ tracking_off()ã€‚è¿™ä¸¤ä¸ªè¡Œä¸ºå°±åƒåˆ†åˆ«å°†â€œ1â€æˆ–â€œ0â€ echo åˆ° tracing_on æ–‡ä»¶ä¸­ä¸€æ ·ã€‚å¦‚æœå†…æ ¸ä¸­å­˜åœ¨å¯ä»¥æ£€æŸ¥çš„æŸäº›æ¡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡æ·»åŠ å¦‚ä¸‹å†…å®¹æ¥åœæ­¢è·Ÿè¸ªå™¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (test_for_error())</span><br><span class="line"> tracking_off();</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥ï¼Œæ·»åŠ å‡ ä¸ª trace_printk() sï¼ˆå‚è§ç¬¬ 1 éƒ¨åˆ†ï¼‰ï¼Œé‡æ–°ç¼–è¯‘å¹¶å¼•å¯¼å†…æ ¸ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥å¯ç”¨å‡½æ•°æˆ–å‡½æ•°å›¾è·Ÿè¸ªå™¨ï¼Œç„¶åç­‰å¾…é”™è¯¯æ¡ä»¶å‘ç”Ÿã€‚æ£€æŸ¥ tracing_on æ–‡ä»¶å°†è®©æ‚¨çŸ¥é“é”™è¯¯æ¡ä»¶ä½•æ—¶å‘ç”Ÿã€‚å½“å†…æ ¸è°ƒç”¨ tracking_off() æ—¶ï¼Œå®ƒå°†ä»â€œ1â€åˆ‡æ¢åˆ°â€œ0â€ ã€‚</p><p>æ£€æŸ¥è·Ÿè¸ªåï¼Œæˆ–å°†å…¶ä¿å­˜åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> trace &gt; ~/trace.sav</span><br></pre></td></tr></tbody></table></figure><p>æ‚¨å¯ä»¥ç»§ç»­è·Ÿè¸ªä»¥æ£€æŸ¥å¦ä¸€ä¸ªå‘½ä¸­ã€‚ä¸ºæ­¤ï¼Œåªéœ€å°†â€œ1â€ echo åˆ° tracing_on ä¸­ï¼Œè·Ÿè¸ªå°†ç»§ç»­ã€‚å¦‚æœå¯ä»¥åˆæ³•è§¦å‘è§¦å‘ tracing_off() è°ƒç”¨çš„æ¡ä»¶ï¼Œè¿™ä¹Ÿå¾ˆæœ‰ç”¨ ã€‚å¦‚æœæ¡ä»¶æ˜¯ç”±æ­£å¸¸æ“ä½œè§¦å‘çš„ï¼Œåªéœ€é€šè¿‡åœ¨ tracing_on ä¸­ echo â€œ1â€æ¥é‡æ–°å¯åŠ¨è·Ÿè¸ªï¼Œå¸Œæœ›ä¸‹æ¬¡é‡åˆ°æ¡ä»¶æ—¶å°†æ˜¯å› ä¸ºå¼‚å¸¸ã€‚</p><h1 id="ftrace_dump_on_oops">ftrace_dump_on_oops</h1><p>æœ‰æ—¶å†…æ ¸ä¼šå´©æºƒï¼Œæ£€æŸ¥å†…å­˜å’Œå´©æºƒçŠ¶æ€æ›´åƒæ˜¯ä¸€é—¨ CSI ç§‘å­¦ï¼Œè€Œä¸æ˜¯ç¨‹åºè°ƒè¯•ç§‘å­¦ã€‚å°† kdump / kexec ä¸ crash å®ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨æ˜¯æ£€æŸ¥å´©æºƒç‚¹ç³»ç»ŸçŠ¶æ€çš„ä¸€ç§æœ‰ä»·å€¼çš„æ–¹æ³•ï¼Œä½†å®ƒä¸ä¼šè®©æ‚¨çœ‹åˆ°åœ¨å¯¼è‡´å´©æºƒçš„äº‹ä»¶ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><p>åœ¨å†…æ ¸å¼•å¯¼å‚æ•°ä¸­é…ç½® Ftrace å¹¶å¯ç”¨ ftrace_dump_on_oopsï¼Œæˆ–è€…é€šè¿‡åœ¨/proc/sys/kernel/ftrace_dump_on_oops ä¸­ echo â€œ1â€ ï¼Œå°†ä½¿ Ftrace èƒ½å¤Ÿåœ¨ oops æˆ– panic æ—¶ä»¥ ASCII æ ¼å¼å°†æ•´ä¸ªè·Ÿè¸ªç¼“å†²åŒºè½¬å‚¨åˆ°æ§åˆ¶å°ã€‚å°†æ§åˆ¶å°è¾“å‡ºåˆ°ä¸²è¡Œæ—¥å¿—ä½¿è°ƒè¯•å´©æºƒæ›´å®¹æ˜“ã€‚æ‚¨ç°åœ¨å¯ä»¥è¿½æº¯å¯¼è‡´å´©æºƒçš„äº‹ä»¶ã€‚</p><p>è½¬å‚¨åˆ°æ§åˆ¶å°å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå› ä¸ºé»˜è®¤çš„ Ftrace ç¯å½¢ç¼“å†²åŒºæ¯ä¸ª CPU è¶…è¿‡ 1 å…†å­—èŠ‚ã€‚è¦ç¼©å°ç¯å½¢ç¼“å†²åŒºçš„å¤§å°ï¼Œè¯·å°†å¸Œæœ›ç¯å½¢ç¼“å†²åŒºçš„åƒå­—èŠ‚æ•°å†™å…¥ buffer_size_kbã€‚è¯·æ³¨æ„ï¼Œè¯¥å€¼æ˜¯æ¯ä¸ª CPUï¼Œè€Œä¸æ˜¯ç¯å½¢ç¼“å†²åŒºçš„æ€»å¤§å°ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 50 &gt; buffer_size_kb</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šå°†æŠŠ Ftrace ç¯å½¢ç¼“å†²åŒºç¼©å°åˆ°æ¯ä¸ª CPU 50 KBã€‚ æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ sysrq-z å°† Ftrace ç¼“å†²åŒºçš„è½¬å‚¨è§¦å‘åˆ°æ§åˆ¶å° ã€‚</p><p>è¦ä¸ºå†…æ ¸è½¬å‚¨é€‰æ‹©ç‰¹å®šä½ç½®ï¼Œå†…æ ¸å¯ä»¥ç›´æ¥è°ƒç”¨ ftrace_dump()ã€‚è¯·æ³¨æ„ï¼Œè¿™å¯èƒ½ä¼šæ°¸ä¹…ç¦ç”¨ Ftraceï¼Œå¯èƒ½éœ€è¦é‡æ–°å¯åŠ¨æ‰èƒ½å†æ¬¡å¯ç”¨å®ƒã€‚è¿™æ˜¯å› ä¸º ftrace_dump() è¯»å–ç¼“å†²åŒºã€‚ç¼“å†²åŒºè¢«å†™å…¥æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼ˆä¸­æ–­ã€NMIã€è°ƒåº¦ï¼‰ï¼Œä½†ç¼“å†²åŒºçš„è¯»å–éœ€è¦é”å®šã€‚ä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œ ftrace_dump() é”å®šè¢«ç¦ç”¨å¹¶ä¸”ç¼“å†²åŒºå¯èƒ½æœ€ç»ˆåœ¨è¾“å‡ºåè¢«ç ´åã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following code will lock up the box, so we dump out the</span></span><br><span class="line"><span class="comment"> * trace before we hit that location.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ftrace_dump();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* code that locks up */</span></span><br></pre></td></tr></tbody></table></figure><h1 id="stack-tracing">Stack Tracing</h1><p>æœ€åè¦è®¨è®ºçš„ä¸»é¢˜æ˜¯æ£€æŸ¥å†…æ ¸å †æ ˆå¤§å°ä»¥åŠæ¯ä¸ªå‡½æ•°ä½¿ç”¨å¤šå°‘å †æ ˆç©ºé—´çš„èƒ½åŠ›ã€‚å¯ç”¨å †æ ˆè·Ÿè¸ªå™¨ ( CONFIG_STACK_TRACER ) å°†æ˜¾ç¤ºå †æ ˆçš„æœ€å¤§ä½¿ç”¨å‘ç”Ÿåœ¨å“ªé‡Œã€‚</p><p>å †æ ˆè·Ÿè¸ªå™¨æ˜¯ä»å‡½æ•°è·Ÿè¸ªå™¨åŸºç¡€ç»“æ„æ„å»ºçš„ã€‚å®ƒä¸ä½¿ç”¨ Ftrace ç¯å½¢ç¼“å†²åŒºï¼Œä½†ç¡®å®ä½¿ç”¨å‡½æ•°è·Ÿè¸ªå™¨æ¥æŒ‚é’©æ¯ä¸ªå‡½æ•°è°ƒç”¨ã€‚å› ä¸ºå®ƒä½¿ç”¨å‡½æ•°è·Ÿè¸ªå™¨åŸºç¡€ç»“æ„ï¼Œæ‰€ä»¥åœ¨æœªå¯ç”¨æ—¶ä¸ä¼šå¢åŠ å¼€é”€ã€‚è¦å¯ç”¨å †æ ˆè·Ÿè¸ªå™¨ï¼Œè¯·å°† 1 echo åˆ° /proc/sys/kernel/stack_tracer_enabled ä¸­ã€‚è¦æŸ¥çœ‹å¯åŠ¨æœŸé—´çš„æœ€å¤§å †æ ˆå¤§å°ï¼Œè¯·å°†â€œ stacktrace â€æ·»åŠ åˆ°å†…æ ¸â€‹â€‹å¯åŠ¨å‚æ•°ã€‚</p><p>å †æ ˆè·Ÿè¸ªå™¨åœ¨æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥å †æ ˆçš„å¤§å°ã€‚å¦‚æœå®ƒå¤§äºæœ€åè®°å½•çš„æœ€å¤§å€¼ï¼Œå®ƒä¼šè®°å½•å †æ ˆè·Ÿè¸ªå¹¶ä½¿ç”¨æ–°å¤§å°æ›´æ–°æœ€å¤§å€¼ã€‚è¦æŸ¥çœ‹å½“å‰æœ€å¤§å€¼ï¼Œè¯·æŸ¥çœ‹ stack_max_size æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 1 &gt; /proc/sys/kernel/stack_tracer_enabled</span></span><br><span class="line">[tracing]<span class="comment"># cat stack_max_size</span></span><br><span class="line">2928</span><br><span class="line">[tracing]<span class="comment"># cat stack_trace</span></span><br><span class="line">        Depth    Size   Location    (34 entries)</span><br><span class="line">        -----    ----   --------</span><br><span class="line">  0)     2952      16   mempool_alloc_slab+0x15/0x17</span><br><span class="line">  1)     2936     144   mempool_alloc+0x52/0x104</span><br><span class="line">  2)     2792      16   scsi_sg_alloc+0x4a/0x4c [scsi_mod]</span><br><span class="line">  3)     2776     112   __sg_alloc_table+0x62/0x103</span><br><span class="line">[...]</span><br><span class="line"> 13)     2072      48   __elv_add_request+0x98/0x9f</span><br><span class="line"> 14)     2024     112   __make_request+0x43e/0x4bb</span><br><span class="line"> 15)     1912     224   generic_make_request+0x424/0x471</span><br><span class="line"> 16)     1688      80   submit_bio+0x108/0x115</span><br><span class="line"> 17)     1608      48   submit_bh+0xfc/0x11e</span><br><span class="line"> 18)     1560     112   __block_write_full_page+0x1ee/0x2e8</span><br><span class="line"> 19)     1448      80   block_write_full_page_endio+0xff/0x10e</span><br><span class="line"> 20)     1368      16   block_write_full_page+0x15/0x17</span><br><span class="line"> 21)     1352      16   blkdev_writepage+0x18/0x1a</span><br><span class="line"> 22)     1336      32   __writepage+0x1a/0x40</span><br><span class="line"> 23)     1304     304   write_cache_pages+0x241/0x3c1</span><br><span class="line"> 24)     1000      16   generic_writepages+0x27/0x29</span><br><span class="line">[...]</span><br><span class="line"> 30)      424      64   bdi_writeback_task+0x3f/0xb0</span><br><span class="line"> 31)      360      48   bdi_start_fn+0x76/0xd7</span><br><span class="line"> 32)      312     128   kthread+0x7f/0x87</span><br><span class="line"> 33)      184     184   child_rip+0xa/0x20</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ä»…ä¸ºæ‚¨æä¾›äº†æ‰¾åˆ°çš„æœ€å¤§å †æ ˆçš„å¤§å°ï¼Œè¿˜æ˜¾ç¤ºäº†æ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„å †æ ˆå¤§å°çš„ç»†åˆ†ã€‚è¯·æ³¨æ„ï¼Œ write_cache_pages çš„å †æ ˆæœ€å¤§ï¼Œä½¿ç”¨äº† 304 ä¸ªå­—èŠ‚ï¼Œå…¶æ¬¡æ˜¯ generic_make_requestï¼Œä½¿ç”¨äº† 224 ä¸ªå­—èŠ‚çš„å †æ ˆã€‚</p><p>è¦é‡ç½®æœ€å¤§å€¼ï¼Œè¯·å°†â€œ0â€å›æ˜¾åˆ° stack_max_size æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; stack_max_size</span></span><br></pre></td></tr></tbody></table></figure><p>ä¿æŒè¿è¡Œä¸€æ®µæ—¶é—´å°†æ˜¾ç¤ºå†…æ ¸ä½¿ç”¨è¿‡å¤šå †æ ˆçš„ä½ç½®ã€‚ä½†è¯·è®°ä½ï¼Œå †æ ˆè·Ÿè¸ªå™¨åªæœ‰åœ¨æœªå¯ç”¨æ—¶æ‰æ²¡æœ‰å¼€é”€ã€‚å½“å®ƒè¿è¡Œæ—¶ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°æ€§èƒ½æœ‰æ‰€ä¸‹é™ã€‚</p><p>è¯·æ³¨æ„ï¼Œå½“å†…æ ¸ä½¿ç”¨å•ç‹¬çš„å †æ ˆæ—¶ï¼Œå †æ ˆè·Ÿè¸ªå™¨ä¸ä¼šè·Ÿè¸ªæœ€å¤§å †æ ˆå¤§å°ã€‚å› ä¸ºä¸­æ–­æœ‰è‡ªå·±çš„å †æ ˆï¼Œå®ƒä¸ä¼šè·Ÿè¸ªé‚£é‡Œçš„å †æ ˆä½¿ç”¨æƒ…å†µã€‚åŸå› æ˜¯å½“å †æ ˆä¸æ˜¯å½“å‰ä»»åŠ¡çš„å †æ ˆæ—¶ï¼Œç›®å‰æ²¡æœ‰ç®€å•çš„æ–¹æ³•å¯ä»¥å¿«é€ŸæŸ¥çœ‹å †æ ˆçš„é¡¶éƒ¨æ˜¯ä»€ä¹ˆã€‚ä½¿ç”¨æ‹†åˆ†å †æ ˆæ—¶ï¼Œè¿›ç¨‹å †æ ˆå¯èƒ½æ˜¯ä¸¤é¡µï¼Œè€Œä¸­æ–­å †æ ˆå¯èƒ½åªæœ‰ä¸€é¡µã€‚è¿™å¯èƒ½ä¼šåœ¨æœªæ¥ä¿®å¤ï¼Œä½†åœ¨ä½¿ç”¨å †æ ˆè·Ÿè¸ªå™¨æ—¶è¯·è®°ä½è¿™ä¸€ç‚¹ã€‚</p><h1 id="function-filtering">Function filtering</h1><p>è¿è¡Œå‡½æ•°è·Ÿè¸ªå™¨å¯èƒ½ä¼šè®©äººä¸çŸ¥æ‰€æªã€‚æ•°æ®é‡å¯èƒ½å¾ˆå¤§ï¼Œäººè„‘å¾ˆéš¾æŒæ¡ã€‚Ftrace æä¾›äº†ä¸€ç§æ–¹æ³•æ¥é™åˆ¶æ‚¨çœ‹åˆ°çš„åŠŸèƒ½ã€‚å­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯è®©æ‚¨é™åˆ¶è·Ÿè¸ªçš„åŠŸèƒ½ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set_ftrace_filter</span><br><span class="line">set_ftrace_notrace</span><br></pre></td></tr></tbody></table></figure><p>è¿™äº›è¿‡æ»¤åŠŸèƒ½å–å†³äº CONFIG_DYNAMIC_FTRACE é€‰é¡¹ã€‚å¦‚å‰å‡ ç¯‡æ–‡ç« æ‰€è¿°ï¼Œå½“å¯ç”¨æ­¤é…ç½®æ—¶ï¼Œæ‰€æœ‰ mcount è°ƒç”¨è€…ä½ç½®éƒ½å°†è¢«å­˜å‚¨ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶è½¬æ¢ä¸º NOPã€‚è¿™äº›ä½ç½®è¢«ä¿å­˜å¹¶ç”¨äºåœ¨åŠŸèƒ½è·Ÿè¸ªå™¨è¢«æ¿€æ´»æ—¶å¯ç”¨è·Ÿè¸ªã€‚ä½†è¿™ä¹Ÿæœ‰ä¸€ä¸ªå¾ˆå¥½çš„å‰¯ä½œç”¨ï¼šå¹¶éæ‰€æœ‰åŠŸèƒ½éƒ½å¿…é¡»å¯ç”¨ã€‚ä¸Šè¿°æ–‡ä»¶å°†ç¡®å®šå“ªäº›åŠŸèƒ½è¢«å¯ç”¨ï¼Œå“ªäº›ä¸å¯ç”¨ã€‚</p><p>å½“ set_ftrace_filter ä¸­åˆ—å‡ºä»»ä½•å‡½æ•°æ—¶ï¼Œåªä¼šè·Ÿè¸ªé‚£äº›å‡½æ•°ã€‚å½“è·Ÿè¸ªå¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œè¿™å°†æœ‰åŠ©äºç³»ç»Ÿçš„æ€§èƒ½ã€‚è·Ÿè¸ªæ¯ä¸ªå‡½æ•°ä¼šäº§ç”Ÿå¾ˆå¤§çš„å¼€é”€ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ set_ftrace_filter æ—¶ï¼Œåªæœ‰è¯¥æ–‡ä»¶ä¸­åˆ—å‡ºçš„é‚£äº›å‡½æ•°æ‰ä¼šæ›´æ”¹ NOP ä»¥è°ƒç”¨è·Ÿè¸ªå™¨ã€‚æ ¹æ®æ­£åœ¨è·Ÿè¸ªçš„åŠŸèƒ½ï¼Œä»…å¯ç”¨å‡ ç™¾ä¸ªåŠŸèƒ½å‡ ä¹ä¸ä¼šå¼•èµ·æ³¨æ„ã€‚</p><p>è¯¥ set_ftrace_notrace æ–‡ä»¶æ˜¯ç›¸å set_ftrace_filterã€‚ä¸æ˜¯å°†è·Ÿè¸ªé™åˆ¶ä¸ºä¸€ç»„å‡½æ•°ï¼Œè€Œæ˜¯ä¸ä¼šè·Ÿè¸ª set_ftrace_notrace ä¸­åˆ—å‡ºçš„å‡½æ•°ã€‚æŸäº›å‡½æ•°ç»å¸¸å‡ºç°ï¼Œè·Ÿè¸ªè¿™äº›å‡½æ•°ä¸ä»…ä¼šå‡æ…¢ç³»ç»Ÿé€Ÿåº¦ï¼Œè¿˜ä¼šå¡«æ»¡è·Ÿè¸ªç¼“å†²åŒºï¼Œå¹¶ä½¿åˆ†ææ‚¨å…³å¿ƒçš„å‡½æ•°å˜å¾—æ›´åŠ å›°éš¾ã€‚rcu_read_lock() å’Œ spin_lock() ç­‰å‡½æ•° å±äºè¿™ä¸€ç±»ã€‚</p><p>å‘è¿™äº›æ–‡ä»¶æ·»åŠ å‡½æ•°çš„è¿‡ç¨‹é€šå¸¸ä½¿ç”¨ bash é‡å®šå‘ã€‚ä½¿ç”¨ç¬¦å·â€œ&gt;â€å°†åˆ é™¤æ–‡ä»¶ä¸­çš„æ‰€æœ‰ç°æœ‰å‡½æ•°å¹¶å°†æ­£åœ¨å›æ˜¾çš„å†…å®¹æ·»åŠ åˆ°æ–‡ä»¶ä¸­ã€‚ä½¿ç”¨â€œ&gt;&gt;â€é™„åŠ åˆ°æ–‡ä»¶å°†ä¿ç•™ç°æœ‰åŠŸèƒ½å¹¶æ·»åŠ æ–°åŠŸèƒ½ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo sys_read &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line">sys_read</span><br><span class="line">[tracing]<span class="comment"># echo sys_write &gt;&gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line">sys_write</span><br><span class="line">sys_read</span><br><span class="line">[tracing]<span class="comment"># echo sys_open &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line">sys_open</span><br></pre></td></tr></tbody></table></figure><p>è¦åˆ é™¤æ‰€æœ‰åŠŸèƒ½ï¼Œåªéœ€åœ¨è¿‡æ»¤å™¨æ–‡ä»¶ä¸­å›æ˜¾ä¸€ä¸ªç©ºè¡Œå³å¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo sys_read sys_open sys_write &gt; set_ftrace_notrace</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_notrace</span></span><br><span class="line">sys_open</span><br><span class="line">sys_write</span><br><span class="line">sys_read</span><br><span class="line">[tracing]<span class="comment"># echo &gt; set_ftrace_notrace</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_notrace</span></span><br><span class="line">[tracing]<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™äº›æ–‡ä»¶ä¸­åˆ—å‡ºçš„å‡½æ•°ä¹Ÿå¯ä»¥åœ¨å†…æ ¸å‘½ä»¤è¡Œä¸Šè®¾ç½®ã€‚é€‰é¡¹ ftrace_notrace å’Œ ftrace_filter å°†é€šè¿‡åˆ—å‡ºé€—å·åˆ†éš”çš„å‡½æ•°é›†æ¥é¢„è®¾è¿™äº›æ–‡ä»¶ã€‚</p><pre><code>ftrace_notrace=rcu_read_lock,rcu_read_unlock,spin_lock,spin_unlockftrace_filter=kfree,kmalloc,schedule,vmalloc_fault,spurious_fault</code></pre><p>å†…æ ¸å‘½ä»¤è¡Œæ·»åŠ çš„å‡½æ•°è®¾ç½®äº†ç›¸åº”è¿‡æ»¤å™¨æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚è¿™äº›é€‰é¡¹ä»…é¢„åŠ è½½æ–‡ä»¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨å¦‚ä¸Šæ‰€è¿°çš„ bash é‡å®šå‘æ¥åˆ é™¤æˆ–æ·»åŠ åŠŸèƒ½ã€‚ set_ftrace_notrace ä¸­åˆ—å‡ºçš„å‡½æ•°ä¼˜å…ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åŒæ—¶åˆ—åœ¨ set_ftrace_notrace å’Œ set_ftrace_filter ä¸­ï¼Œåˆ™ä¸ä¼šè·Ÿè¸ªè¯¥å‡½æ•°ã€‚</p><h1 id="wildcard-filters">Wildcard filters</h1><p>å¯ä»¥æ·»åŠ åˆ°è¿‡æ»¤å™¨æ–‡ä»¶çš„å‡½æ•°åˆ—è¡¨æ˜¾ç¤ºåœ¨ available_filter_functions æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå‡½æ•°åˆ—è¡¨æºè‡ªå‰é¢æåˆ°çš„å­˜å‚¨çš„ mcount è°ƒç”¨è€…åˆ—è¡¨ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat available_filter_functions | head -8</span></span><br><span class="line">_stext</span><br><span class="line">do_one_initcall</span><br><span class="line">run_init_process</span><br><span class="line">init_post</span><br><span class="line">name_to_dev_t</span><br><span class="line">create_dev</span><br><span class="line">T.627</span><br><span class="line">set_personality_64bit</span><br></pre></td></tr></tbody></table></figure><p>æ‚¨å¯ä»¥ grep æ­¤æ–‡ä»¶å¹¶å°†ç»“æœé‡å®šå‘åˆ°è¿‡æ»¤å™¨æ–‡ä»¶ä¹‹ä¸€ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># grep sched available_filter_functions &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter | head -8</span></span><br><span class="line">save_stack_address_nosched</span><br><span class="line">mce_schedule_work</span><br><span class="line">smp_reschedule_interrupt</span><br><span class="line">native_smp_send_reschedule</span><br><span class="line">sys32_sched_rr_get_interval</span><br><span class="line">sched_avg_update</span><br><span class="line">proc_sched_set_task</span><br><span class="line">sys_sched_get_priority_max</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¸å¹¸çš„æ˜¯ï¼Œå‘è¿‡æ»¤æ–‡ä»¶æ·»åŠ å¤§é‡å‡½æ•°å¾ˆæ…¢ï¼Œæ‚¨ä¼šæ³¨æ„åˆ°ä¸Šé¢çš„ grep éœ€è¦å‡ ç§’é’Ÿæ‰èƒ½æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸ºå†™å…¥è¿‡æ»¤å™¨æ–‡ä»¶çš„æ¯ä¸ªå‡½æ•°åç§°å°†è¢«å•ç‹¬å¤„ç†ã€‚ä¸Šé¢çš„ grep äº§ç”Ÿäº† 300 å¤šä¸ªå‡½æ•°åã€‚è¿™ 300 ä¸ªåç§°ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†ä¸å†…æ ¸ä¸­çš„æ¯ä¸ªå‡½æ•°åç§°è¿›è¡Œæ¯”è¾ƒï¼ˆä½¿ç”¨ strcmp()ï¼‰ï¼Œè¿™ç›¸å½“å¤šã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># wc -l  available_filter_functions</span></span><br><span class="line">24331 available_filter_functions</span><br></pre></td></tr></tbody></table></figure><p>æ‰€ä»¥ä¸Šé¢çš„ grep å¯¼è‡´ set_ftrace_filter ç”Ÿæˆè¶…è¿‡ 300 * 24331 (7,299,300) æ¬¡æ¯”è¾ƒï¼</p><p>å¹¸è¿çš„æ˜¯ï¼Œè¿™äº›æ–‡ä»¶ä¹Ÿä½¿ç”¨é€šé…ç¬¦ï¼›ä»¥ä¸‹ glob è¡¨è¾¾å¼æ˜¯æœ‰æ•ˆçš„ï¼š</p><p>value* - é€‰æ‹©æ‰€æœ‰ä»¥ value å¼€å¤´çš„å‡½æ•°ã€‚ *value* - é€‰æ‹©æ‰€æœ‰åŒ…å«æ–‡æœ¬ value çš„å‡½æ•°ã€‚ *value - é€‰æ‹©æ‰€æœ‰ä»¥ value ç»“å°¾çš„å‡½æ•°ã€‚</p><p>å†…æ ¸åŒ…å«ä¸€ä¸ªç›¸å½“ç®€å•çš„è§£æå™¨ï¼Œä¸ä¼šä»¥é¢„æœŸçš„æ–¹å¼å¤„ç† value*valueã€‚å®ƒå°†å¿½ç•¥ç¬¬äºŒä¸ª å€¼å¹¶é€‰æ‹©æ‰€æœ‰ä»¥ value å¼€å¤´çš„å‡½æ•°ï¼Œè€Œä¸ç®¡å®ƒä»¥ä»€ä¹ˆç»“å°¾ã€‚ä¼ é€’ç»™è¿‡æ»¤å™¨æ–‡ä»¶çš„é€šé…ç¬¦ç›´æ¥é’ˆå¯¹æ¯ä¸ªå¯ç”¨å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œè¿™æ¯”åœ¨åˆ—è¡¨ä¸­ä¼ é€’å•ä¸ªå‡½æ•°è¦å¿«å¾—å¤šã€‚</p><p>å› ä¸º bash ä¹Ÿä½¿ç”¨æ˜Ÿå· (*)ï¼Œæ‰€ä»¥æœ€å¥½ç”¨å¼•å·å°†è¾“å…¥æ‹¬èµ·æ¥ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo set* &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">[tracing]<span class="comment"># echo 'set*' &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter | head -5</span></span><br><span class="line">set_personality_64bit</span><br><span class="line">set_intr_gate_ist</span><br><span class="line">set_intr_gate</span><br><span class="line">set_tsc_mode</span><br></pre></td></tr></tbody></table></figure><p>è¿‡æ»¤å™¨è¿˜å¯ä»¥é€šè¿‡åœ¨è¿‡æ»¤å™¨æ–‡ä»¶çš„è¾“å…¥ä¸­ä½¿ç”¨â€œmodâ€å‘½ä»¤æ¥ä»…é€‰æ‹©å±äºç‰¹å®šæ¨¡å—çš„é‚£äº›å‡½æ•°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo ':mod:tg3' &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter |head -8</span></span><br><span class="line">tg3_write32</span><br><span class="line">tg3_read32</span><br><span class="line">tg3_write_flush_reg32</span><br><span class="line">tw32_mailbox_flush</span><br><span class="line">tg3_write32_tx_mbox</span><br><span class="line">tg3_read32_mbox_5906</span><br><span class="line">tg3_write32_mbox_5906</span><br><span class="line">tg3_disable_ints</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ‚¨æ­£åœ¨è°ƒè¯•å•ä¸ªæ¨¡å—ï¼Œå¹¶ä¸”åªæƒ³åœ¨è·Ÿè¸ªä¸­æŸ¥çœ‹å±äºè¯¥æ¨¡å—çš„å‡½æ•°ï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚</p><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œå¯ç”¨å’Œç¦ç”¨è®°å½•åˆ°ç¯å½¢ç¼“å†²åŒºæ˜¯ä½¿ç”¨ tracing_on æ–‡ä»¶ä»¥åŠ tracing_on() å’Œ tracing_off() å†…æ ¸å‡½æ•°å®Œæˆçš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä¸æƒ³é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œå¹¶ä¸”æƒ³åœ¨ç‰¹å®šå‡½æ•°å¤„åœæ­¢è·Ÿè¸ªï¼Œåˆ™ set_ftrace_filter æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è¿™æ ·åšã€‚ ä½¿åŠŸèƒ½è·Ÿè¸ªå¯ç”¨æˆ–ç¦ç”¨ç¯å½¢ç¼“å†²åŒºçš„å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><pre><code>function:command[:count]</code></pre><p>è¿™å°†åœ¨å‡½æ•°å¼€å§‹ æ—¶æ‰§è¡Œå‘½ä»¤ã€‚è¯¥å‘½ä»¤æ˜¯ traceon æˆ– traceoffï¼Œå¹¶ä¸”å¯ä»¥æ·»åŠ ä¸€ä¸ªå¯é€‰çš„è®¡æ•°ä»¥ä½¿å‘½ä»¤åªæ‰§è¡Œç»™å®šçš„æ¬¡æ•°ã€‚å¦‚æœè®¡æ•°è¢«ä¿ç•™ï¼ˆåŒ…æ‹¬å‰å¯¼å†’å·ï¼‰ï¼Œåˆ™æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶éƒ½ä¼šæ‰§è¡Œè¯¥å‘½ä»¤ã€‚</p><p>ä¸ä¹…å‰ï¼Œæˆ‘æ­£åœ¨è°ƒè¯•å¯¹å†…æ ¸æ‰€åšçš„æ›´æ”¹ï¼Œè¯¥æ›´æ”¹å¯¼è‡´æŸäº›ç¨‹åºå‡ºç°åˆ†æ®µé”™è¯¯ã€‚æˆ‘å¾ˆéš¾æ•æ‰åˆ°è·Ÿè¸ªï¼Œå› ä¸ºå½“æˆ‘çœ‹åˆ°åˆ†æ®µé”™è¯¯åèƒ½å¤Ÿåœæ­¢è·Ÿè¸ªæ—¶ï¼Œæ•°æ®å·²ç»è¢«è¦†ç›–äº†ã€‚ä½†æ˜¯æ§åˆ¶å°ä¸Šçš„å›æº¯æ˜¾ç¤ºæ­£åœ¨è°ƒç”¨å‡½æ•°__bad_area_nosemaphoreã€‚ç„¶åæˆ‘å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœæ­¢è·Ÿè¸ªå™¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo '__bad_area_nosemaphore:traceoff' &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">__bad_area_nosemaphore:traceoff:unlimited</span><br><span class="line">[tracing]<span class="comment"># echo function &gt; current_tracer</span></span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œå¸¦æœ‰å‘½ä»¤çš„å‡½æ•°ä¸ä¼šå½±å“ä¸€èˆ¬è¿‡æ»¤å™¨ã€‚å³ä½¿å·²å°†å‘½ä»¤æ·»åŠ åˆ° __bad_area_nosemaphoreï¼Œè¿‡æ»¤å™¨ä»å…è®¸è·Ÿè¸ªæ‰€æœ‰å‡½æ•°ã€‚å‘½ä»¤å’Œè¿‡æ»¤å™¨åŠŸèƒ½æ˜¯åˆ†å¼€çš„ï¼Œäº’ä¸å½±å“ã€‚å°†ä¸Šè¿°å‘½ä»¤é™„åŠ åˆ°å‡½æ•° __bad_area_nosemaphore åï¼Œä¸‹æ¬¡å‘ç”Ÿåˆ†æ®µé”™è¯¯æ—¶ï¼Œè·Ÿè¸ªåœæ­¢å¹¶åŒ…å«è°ƒè¯•æƒ…å†µæ‰€éœ€çš„æ•°æ®ã€‚</p><h1 id="removing-functions-from-the-filters">Removing functions from the filters</h1><p>å¦‚å‰æ‰€è¿°ï¼Œç”¨â€œ&gt;â€å›æ˜¾å°†æ¸…é™¤è¿‡æ»¤å™¨æ–‡ä»¶ã€‚ä½†æ˜¯å¦‚æœæ‚¨åªæƒ³ä»è¿‡æ»¤å™¨ä¸­åˆ é™¤ä¸€äº›åŠŸèƒ½æ€ä¹ˆåŠï¼Ÿ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter &gt; /tmp/filter</span></span><br><span class="line">[tracing]<span class="comment"># grep -v lock /tmp/filter &gt; set_ftrace_filter</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°å·¥ä½œï¼Œä½†å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœ set_ftrace_filter ä¸­å·²æœ‰å¤šä¸ªå‡½æ•°ï¼Œåˆ™å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½å®Œæˆã€‚ä»¥ä¸‹æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä½†é€Ÿåº¦è¦å¿«å¾—å¤šï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo '!*lock*' &gt;&gt; set_ftrace_filter</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™ 'ï¼'ç¬¦å·å°†åˆ é™¤è¿‡æ»¤å™¨æ–‡ä»¶ä¸­åˆ—å‡ºçš„å‡½æ•°ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œâ€œï¼â€ä¸é€šé…ç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œä½†ä¹Ÿå¯ä»¥ä¸å•ä¸ªå‡½æ•°ä¸€èµ·ä½¿ç”¨ã€‚è‡ªä» 'ï¼'åœ¨ bash ä¸­å…·æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå®ƒå¿…é¡»ç”¨å•å¼•å·æ‹¬èµ·æ¥ï¼Œå¦åˆ™ bash å°†å°è¯•æ‰§è¡Œå…¶åçš„å†…å®¹ã€‚å¦è¯·æ³¨æ„ä½¿ç”¨äº†â€œ&gt;&gt;â€ã€‚å¦‚æœæ‚¨é”™è¯¯åœ°ä½¿ç”¨äº†â€œ&gt;â€ï¼Œåˆ™è¿‡æ»¤å™¨æ–‡ä»¶ä¸­å°†æ²¡æœ‰ä»»ä½•åŠŸèƒ½ã€‚ å› ä¸ºå‘½ä»¤å’Œè¿‡æ»¤å™¨ä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¸…é™¤ set_ftrace_filter ä¸ä¼šæ¸…é™¤å‘½ä»¤ã€‚å‘½ä»¤å¿…é¡»ç”¨â€œï¼â€æ¸…é™¤è±¡å¾ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 'sched*' &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># echo 'schedule:traceoff' &gt;&gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat trace | tail -5</span></span><br><span class="line">schedule_console_callback</span><br><span class="line">schedule_bh</span><br><span class="line">schedule_iso_resource</span><br><span class="line">schedule_reallocations</span><br><span class="line">schedule:traceoff:unlimited</span><br><span class="line">[tracing]<span class="comment"># echo &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">schedule:traceoff:unlimited</span><br><span class="line">[tracing]<span class="comment"># echo '!schedule:traceoff' &gt;&gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line"><span class="comment">#### all functions enabled ####</span></span><br><span class="line">[tracing]<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™å¯èƒ½çœ‹èµ·æ¥å¾ˆåˆ«æ‰­ï¼Œä½†æ˜¯ä½¿ç”¨â€œ&gt;â€å’Œâ€œ&gt;&gt;â€åªå½±å“è¦è·Ÿè¸ªçš„å‡½æ•°è€Œä¸å½±å“å‡½æ•°å‘½ä»¤ï¼Œå®é™…ä¸Šç®€åŒ–äº†è¿‡æ»¤å‡½æ•°å’Œæ·»åŠ å’Œåˆ é™¤å‘½ä»¤ä¹‹é—´çš„æ§åˆ¶ã€‚</p><h1 id="tracing-a-specific-process">Tracing a specific process</h1><p>ä¹Ÿè®¸æ‚¨åªéœ€è¦è·Ÿè¸ªä¸€ä¸ªç‰¹å®šçš„è¿›ç¨‹æˆ–ä¸€ç»„è¿›ç¨‹ã€‚æ–‡ä»¶ set_ftrace_pid å…è®¸æ‚¨æŒ‡å®šè¦è·Ÿè¸ªçš„ç‰¹å®šè¿›ç¨‹ã€‚è¦ä»…è·Ÿè¸ªå½“å‰çº¿ç¨‹ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo $$ &gt; set_ftrace_pid</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢å°†è®¾ç½®å‡½æ•° tracer åªè·Ÿè¸ªæ‰§è¡Œ echo å‘½ä»¤çš„ bash shellã€‚å¦‚æœè¦è·Ÿè¸ªç‰¹å®šè¿›ç¨‹ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª shell è„šæœ¬åŒ…è£…ç¨‹åºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat ~/bin/ftrace-me</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">DEBUGFS=`grep debugfs /proc/mounts | awk <span class="string">'{ print $2; }'</span>`</span><br><span class="line"><span class="built_in">echo</span> $$ &gt; <span class="variable">$DEBUGFS</span>/tracing/set_ftrace_pid</span><br><span class="line"><span class="built_in">echo</span> <span class="keyword">function</span> &gt; <span class="variable">$DEBUGFS</span>/tracing/current_tracer</span><br><span class="line"><span class="built_in">exec</span> $*</span><br><span class="line">[tracing]<span class="comment"># ~/bin/ftrace-me ls -ltr</span></span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œå¦‚æœè¦åœ¨æ‰§è¡Œä¸Šè¿°æ“ä½œåè¿”å›é€šç”¨å‡½æ•°è·Ÿè¸ªï¼Œåˆ™å¿…é¡»æ¸…é™¤ set_ftrace_pid æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo -1 &gt; set_ftrace_pid</span></span><br></pre></td></tr></tbody></table></figure><h1 id="what-calls-a-specific-function">What calls a specific function?</h1><p>æœ‰æ—¶äº†è§£ä»€ä¹ˆåœ¨è°ƒç”¨ç‰¹å®šå‡½æ•°å¾ˆæœ‰ç”¨ã€‚ç›´æ¥å‰ä»»å¾ˆæœ‰å¸®åŠ©ï¼Œä½†æ•´ä¸ªå›æº¯ç”šè‡³æ›´å¥½ã€‚å‡½æ•°è·Ÿè¸ªå™¨åŒ…å«ä¸€ä¸ªé€‰é¡¹ï¼Œè¯¥é€‰é¡¹å°†ä¸ºè·Ÿè¸ªå™¨è°ƒç”¨çš„æ¯ä¸ªå‡½æ•°åœ¨ç¯å½¢ç¼“å†²åŒºä¸­åˆ›å»ºä¸€ä¸ªå›æº¯ã€‚ç”±äºä¸ºæ¯ä¸ªå‡½æ•°åˆ›å»ºå›æº¯å…·æœ‰å¾ˆå¤§çš„å¼€é”€ï¼Œè¿™å¯èƒ½ä¼šå®æ—¶é”å®šç³»ç»Ÿï¼Œå› æ­¤åœ¨ä½¿ç”¨æ­¤åŠŸèƒ½æ—¶å¿…é¡»å°å¿ƒã€‚æƒ³è±¡ä¸€ä¸‹è¿è¡Œåœ¨ 1000 HZ çš„è¾ƒæ…¢ç³»ç»Ÿä¸Šçš„å®šæ—¶å™¨ä¸­æ–­ã€‚å¾ˆå¯èƒ½è®©å®šæ—¶å™¨ä¸­æ–­è°ƒç”¨äº§ç”Ÿå›æº¯çš„æ¯ä¸ªå‡½æ•°éœ€è¦ 1 æ¯«ç§’æ‰èƒ½å®Œæˆã€‚åˆ°å®šæ—¶å™¨ä¸­æ–­è¿”å›æ—¶ï¼Œå°†åœ¨ä»»ä½•å…¶ä»–å·¥ä½œå®Œæˆä¹‹å‰è§¦å‘ä¸€ä¸ªæ–°çš„ä¸­æ–­ï¼Œä»è€Œå¯¼è‡´æ´»é”ã€‚</p><p>è¦ä½¿ç”¨å‡½æ•°è·Ÿè¸ªå™¨å›æº¯åŠŸèƒ½ï¼Œè¢«è°ƒç”¨çš„å‡½æ•°å¿…é¡»å—åˆ°å‡½æ•°è¿‡æ»¤å™¨çš„é™åˆ¶ã€‚å¯ç”¨å‡½æ•°å›æº¯çš„é€‰é¡¹æ˜¯å‡½æ•°è·Ÿè¸ªå™¨ç‹¬æœ‰çš„ï¼Œåªæœ‰åœ¨å¯ç”¨å‡½æ•°è·Ÿè¸ªå™¨æ—¶æ‰èƒ½æ¿€æ´»å®ƒã€‚è¿™æ„å‘³ç€æ‚¨å¿…é¡»å…ˆå¯ç”¨å‡½æ•°è·Ÿè¸ªå™¨ï¼Œç„¶åæ‰èƒ½è®¿é—®è¯¥é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo kfree &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># cat set_ftrace_filter</span></span><br><span class="line">kfree</span><br><span class="line">[tracing]<span class="comment"># echo function &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># echo 1 &gt; options/func_stack_trace</span></span><br><span class="line">[tracing]<span class="comment"># cat trace | tail -8</span></span><br><span class="line"> =&gt; sys32_execve</span><br><span class="line"> =&gt; ia32_ptregs_common</span><br><span class="line">             cat-6829  [000] 1867248.965100: kfree &lt;-free_bprm</span><br><span class="line">             cat-6829  [000] 1867248.965100: &lt;stack trace&gt;</span><br><span class="line"></span><br><span class="line"> =&gt; free_bprm</span><br><span class="line"> =&gt; compat_do_execve</span><br><span class="line"> =&gt; sys32_execve</span><br><span class="line"> =&gt; ia32_ptregs_common</span><br><span class="line">[tracing]<span class="comment"># echo 0 &gt; options/func_stack_trace</span></span><br><span class="line">[tracing]<span class="comment"># echo &gt; set_ftrace_filter</span></span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œåœ¨å¯ç”¨ func_stack_trace é€‰é¡¹ä»¥ç¡®ä¿å¯ç”¨è¿‡æ»¤å™¨ä¹‹å‰ï¼Œæˆ‘å°å¿ƒåœ°å¯¹ set_ftrace_filter è¿›è¡Œåˆ†ç±»ã€‚æœ€åï¼Œæˆ‘åœ¨ç¦ç”¨è¿‡æ»¤å™¨ä¹‹å‰ç¦ç”¨äº† options/func_stack_traceã€‚è¿˜è¦æ³¨æ„è¯¥é€‰é¡¹æ˜¯éæ˜“å¤±æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æ‚¨åœ¨ current_tracer ä¸­å¯ç”¨äº†å¦ä¸€ä¸ªè·Ÿè¸ªå™¨æ’ä»¶ï¼Œå¦‚æœæ‚¨é‡æ–°å¯ç”¨è·Ÿè¸ªå™¨åŠŸèƒ½ï¼Œè¯¥é€‰é¡¹ä»ç„¶ä¼šå¯ç”¨ã€‚</p><h1 id="the-function_graph-tracer">The function_graph tracer</h1><p>å‡½æ•°è·Ÿè¸ªå™¨éå¸¸å¼ºå¤§ï¼Œä½†å¯èƒ½å¾ˆéš¾ç†è§£å®ƒäº§ç”Ÿçš„çº¿æ€§æ ¼å¼ã€‚Frederic Weisbecker å·²å°†å‡½æ•°è·Ÿè¸ªå™¨æ‰©å±•åˆ° function_graph è·Ÿè¸ªå™¨ã€‚function_graph è·Ÿè¸ªå™¨æ­è½½äº†å¤§éƒ¨åˆ†ç”±å‡½æ•°è·Ÿè¸ªå™¨åˆ›å»ºçš„ä»£ç ï¼Œä½†åœ¨ mcount è°ƒç”¨ä¸­æ·»åŠ äº†è‡ªå·±çš„é’©å­ã€‚å› ä¸ºå®ƒä»ç„¶ä½¿ç”¨ mcount è°ƒç”¨æ–¹æ³•ï¼Œæ‰€ä»¥ä¸Šé¢è§£é‡Šçš„å¤§éƒ¨åˆ†å‡½æ•°è¿‡æ»¤ä¹Ÿé€‚ç”¨äº function_graph è·Ÿè¸ªå™¨ï¼Œä½† traceon / traceoff å‘½ä»¤å’Œ set_ftrace_pid é™¤å¤–ï¼ˆå°½ç®¡åè€…å°†æ¥å¯èƒ½ä¼šæ”¹å˜ï¼‰ã€‚ function_graph tracer åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä¹Ÿæœ‰è¯´æ˜ï¼Œä½†æ˜¯ set_graph_function æ–‡ä»¶æ²¡æœ‰è¯´æ˜ã€‚ä¸Šä¸€èŠ‚ä¸­ä½¿ç”¨çš„ func_stack_trace å¯ä»¥çœ‹åˆ°ä»€ä¹ˆå¯èƒ½è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ set_graph_function å¯ä»¥ç”¨æ¥æŸ¥çœ‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨äº†ä»€ä¹ˆï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo kfree &gt; set_graph_function</span></span><br><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># cat trace</span></span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |   |                     |   |   |   |</span></span><br><span class="line"> 0)               |  <span class="function"><span class="title">kfree</span></span>() {</span><br><span class="line"> 0)               |    <span class="function"><span class="title">virt_to_cache</span></span>() {</span><br><span class="line"> 0)               |      <span class="function"><span class="title">virt_to_head_page</span></span>() {</span><br><span class="line"> 0)   0.955 us    |        __phys_addr();</span><br><span class="line"> 0)   2.643 us    |      }</span><br><span class="line"> 0)   4.299 us    |    }</span><br><span class="line"> 0)   0.855 us    |    __cache_free();</span><br><span class="line"> 0)   ==========&gt; |</span><br><span class="line"> 0)               |    <span class="function"><span class="title">smp_apic_timer_interrupt</span></span>() {</span><br><span class="line"> 0)               |      <span class="function"><span class="title">apic_write</span></span>() {</span><br><span class="line"> 0)   0.849 us    |        native_apic_mem_write();</span><br><span class="line"> 0)   2.853 us    |      }</span><br><span class="line">[tracing]<span class="comment"># echo &gt; set_graph_function</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™å°†æ˜¾ç¤ºä»…ç”± kfree() æ‰§è¡Œçš„è°ƒç”¨å›¾ã€‚â€œ ==========&gt; â€è¡¨ç¤ºé€šè¯è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸­æ–­ã€‚è·Ÿè¸ªè®°å½• kfree() å—ä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œç”šè‡³æ˜¯é‚£äº›åœ¨ kfree() èŒƒå›´å†…è§¦å‘çš„ä¸­æ–­è°ƒç”¨çš„å‡½æ•°ã€‚</p><p>function_graph è·Ÿè¸ªå™¨æ˜¾ç¤ºå‡½æ•°åœ¨æŒç»­æ—¶é—´å­—æ®µä¸­èŠ±è´¹çš„æ—¶é—´ã€‚åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æåˆ°ï¼Œåªæœ‰å¶å­å‡½æ•°ï¼Œå³ä¸è°ƒç”¨å…¶ä»–å‡½æ•°çš„å¶å‡½æ•°ï¼Œæ‰æœ‰å‡†ç¡®çš„æŒç»­æ—¶é—´ï¼Œå› ä¸ºçˆ¶å‡½æ•°çš„æŒç»­æ—¶é—´è¿˜åŒ…æ‹¬ function_graph è·Ÿè¸ªå™¨è°ƒç”¨å­å‡½æ•°çš„å¼€é”€ã€‚é€šè¿‡ä½¿ç”¨ set_ftrace_filter æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥å¼ºåˆ¶ä»»ä½•å‡½æ•°æˆä¸º function_graph è·Ÿè¸ªå™¨ä¸­çš„å¶å‡½æ•°ï¼Œè¿™å°†å…è®¸æ‚¨æŸ¥çœ‹è¯¥å‡½æ•°çš„å‡†ç¡®æŒç»­æ—¶é—´ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo smp_apic_timer_interrupt &gt; set_ftrace_filter</span></span><br><span class="line">[tracing]<span class="comment"># echo function_graph &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># cat trace | head</span></span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |   |                     |   |   |   |</span></span><br><span class="line"> 1)   ==========&gt; |</span><br><span class="line"> 1) + 16.433 us   |  smp_apic_timer_interrupt();</span><br><span class="line"> 1)   ==========&gt; |</span><br><span class="line"> 1) + 25.897 us   |  smp_apic_timer_interrupt();</span><br><span class="line"> 1)   ==========&gt; |</span><br><span class="line"> 1) + 24.764 us   |  smp_apic_timer_interrupt();</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢æ˜¾ç¤ºå®šæ—¶å™¨ä¸­æ–­éœ€è¦ 16 åˆ° 26 å¾®ç§’æ‰èƒ½å®Œæˆã€‚</p><h1 id="function-profiling">Function profiling</h1><p>oprofile å’Œ perf æ˜¯éå¸¸å¼ºå¤§çš„åˆ†æå·¥å…·ï¼Œå®ƒä»¬å®šæœŸå¯¹ç³»ç»Ÿè¿›è¡Œé‡‡æ ·ï¼Œå¹¶å¯ä»¥æ˜¾ç¤ºå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ä»€ä¹ˆåœ°æ–¹ã€‚ä½¿ç”¨å‡½æ•°åˆ†æå™¨ï¼Œå¯ä»¥å¾ˆå¥½åœ°æŸ¥çœ‹å®é™…çš„å‡½æ•°æ‰§è¡Œæƒ…å†µï¼Œè€Œä¸ä»…ä»…æ˜¯ç¤ºä¾‹ã€‚å¦‚æœå†…æ ¸ä¸­é…ç½®äº† CONFIG_FUNCTION_GRAPH_TRACERï¼Œåˆ™å‡½æ•°åˆ†æå™¨å°†ä½¿ç”¨å‡½æ•°å›¾åŸºç¡€ç»“æ„æ¥è®°å½•å‡½æ•°æ‰§è¡Œäº†å¤šé•¿æ—¶é—´ã€‚å¦‚æœåªé…ç½®äº† CONFIG_FUNCTION_TRACERï¼Œå‡½æ•°åˆ†æå™¨å°†åªè®¡ç®—è¢«è°ƒç”¨çš„å‡½æ•°ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo nop &gt; current_tracer</span></span><br><span class="line">[tracing]<span class="comment"># echo 1 &gt; function_profile_enabled</span></span><br><span class="line">[tracing]<span class="comment"># cat trace_stat/function 0 |head</span></span><br><span class="line">  Function                               Hit    Time            Avg</span><br><span class="line">  --------                               ---    ----            ---</span><br><span class="line">  schedule                             22943    1994458706 us     86931.03 us</span><br><span class="line">  poll_schedule_timeout                 8683    1429165515 us     164593.5 us</span><br><span class="line">  schedule_hrtimeout_range              8638    1429155793 us     165449.8 us</span><br><span class="line">  sys_poll                             12366    875206110 us     70775.19 us</span><br><span class="line">  do_sys_poll                          12367    875136511 us     70763.84 us</span><br><span class="line">  compat_sys_select                     3395    527531945 us     155384.9 us</span><br><span class="line">  compat_core_sys_select                3395    527503300 us     155376.5 us</span><br><span class="line">  do_select                             3395    527477553 us     155368.9 us</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¿˜åŒ…æ‹¬å‡½æ•°è¢«æŠ¢å æˆ– schedule() è¢«è°ƒç”¨ä»¥åŠä»»åŠ¡è¢«æ¢å‡ºçš„æ¬¡æ•°ã€‚è¿™å¯èƒ½çœ‹èµ·æ¥æ²¡ç”¨ï¼Œä½†å®ƒç¡®å®å¯ä»¥è®©æˆ‘ä»¬äº†è§£å“ªäº›å‡½æ•°ç»å¸¸è¢«æŠ¢å ã€‚ Ftrace è¿˜åŒ…æ‹¬å…è®¸æ‚¨è®©å‡½æ•°å›¾è·Ÿè¸ªå™¨å¿½ç•¥ä»»åŠ¡è®¡åˆ’æ—¶é—´çš„é€‰é¡¹ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; options/sleep-time</span></span><br><span class="line">[tracing]<span class="comment"># echo 0 &gt; function_profile_enabled</span></span><br><span class="line">[tracing]<span class="comment"># echo 1 &gt; function_profile_enabled</span></span><br><span class="line">[tracing]<span class="comment"># cat trace_stat/function0  | head</span></span><br><span class="line">  Function                               Hit    Time            Avg</span><br><span class="line">  --------                               ---    ----            ---</span><br><span class="line">  default_idle                          2493    6763414 us     2712.962 us</span><br><span class="line">  native_safe_halt                      2492    6760641 us     2712.938 us</span><br><span class="line">  sys_poll                              4723    714243.6 us     151.226 us</span><br><span class="line">  do_sys_poll                           4723    692887.4 us     146.704 us</span><br><span class="line">  sys_read                              9211    460896.3 us     50.037 us</span><br><span class="line">  vfs_read                              9243    434521.2 us     47.010 us</span><br><span class="line">  smp_apic_timer_interrupt              3940    275747.4 us     69.986 us</span><br><span class="line">  sock_poll                            80613    268743.2 us     3.333 us</span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œsleep-time é€‰é¡¹åŒ…å«â€œ-â€ï¼Œè€Œä¸æ˜¯ sleep_timeã€‚</p><p>ç¦ç”¨åŠŸèƒ½åˆ†æå™¨ç„¶åé‡æ–°å¯ç”¨å®ƒä¼šå¯¼è‡´æ•°å­—é‡ç½®ã€‚è¯¥åˆ—è¡¨æŒ‰å¹³å‡æ—¶é—´æ’åºï¼Œä½†ä½¿ç”¨è„šæœ¬æ‚¨å¯ä»¥è½»æ¾åœ°æŒ‰ä»»ä½•æ•°å­—æ’åºã€‚æ‰€è¿° trace_stat / function0 ä»…è¡¨ç¤ºå­˜åœ¨ä¸€ä¸ª CPU 0 trace_stat /åŠŸèƒ½ï¼ƒä¸ºç³»ç»Ÿä¸Šçš„æ¯ä¸ª CPUã€‚æ‰€æœ‰è¢«è¿½è¸ªå’Œå‘½ä¸­çš„å‡½æ•°éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># cat trace_stat/function0  | wc -l</span></span><br><span class="line">2978</span><br></pre></td></tr></tbody></table></figure><p>æœªå‘½ä¸­çš„å‡½æ•°æœªåˆ—å‡ºã€‚ä»¥ä¸Šæ˜¾ç¤ºè‡ªæˆ‘å¼€å§‹åˆ†æä»¥æ¥ï¼Œå·²å‘½ä¸­ 2978 ä¸ªå‡½æ•°ã€‚</p><p>å½±å“åˆ†æçš„å¦ä¸€ä¸ªé€‰é¡¹æ˜¯å›¾å½¢æ—¶é—´ï¼ˆå†æ¬¡ä½¿ç”¨â€œ-â€ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯å¯ç”¨çš„ã€‚å¯ç”¨åï¼Œå‡½æ•°çš„æ—¶é—´åŒ…æ‹¬å‡½æ•°å†…è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°çš„æ—¶é—´ã€‚ä»ä¸Šé¢ç¤ºä¾‹çš„è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œåˆ—å‡ºäº†å‡ ä¸ªç³»ç»Ÿè°ƒç”¨çš„å¹³å‡å€¼æœ€é«˜ã€‚ç¦ç”¨æ—¶ï¼Œæ¬¡æ•°åªåŒ…æ‹¬å‡½æ•°æœ¬èº«çš„æ‰§è¡Œæ¬¡æ•°ï¼Œä¸åŒ…æ‹¬ä»å‡½æ•°è°ƒç”¨å‡½æ•°çš„æ¬¡æ•°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[tracing]<span class="comment"># echo 0 &gt; options/graph-time</span></span><br><span class="line">[tracing]<span class="comment"># echo 0 &gt; function_profile_enabled</span></span><br><span class="line">[tracing]<span class="comment"># echo 1 &gt; function_profile_enabled</span></span><br><span class="line">[tracing]<span class="comment"># cat trace_stat/function0  | head</span></span><br><span class="line">  Function                               Hit    Time            Avg</span><br><span class="line">  --------                               ---    ----            ---</span><br><span class="line">  mwait_idle                           10132    246835458 us     24361.96 us</span><br><span class="line">  tg_shares_up                        154467    389883.5 us     2.524 us</span><br><span class="line">  _raw_spin_lock_irqsave              343012    263504.3 us     0.768 us</span><br><span class="line">  _raw_spin_unlock_irqrestore         351269    175205.6 us     0.498 us</span><br><span class="line">  walk_tg_tree                         14087    126078.4 us     8.949 us</span><br><span class="line">  __set_se_shares                     274937    88436.65 us     0.321 us</span><br><span class="line">  _raw_spin_lock                      100715    82692.61 us     0.821 us</span><br><span class="line">  kstat_irqs_cpu                      257500    80124.96 us     0.311 us</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>è¯·æ³¨æ„ï¼Œç¡çœ æ—¶é—´å’Œå›¾å½¢æ—¶é—´ä¹Ÿä¼šå½±å“ function_graph è·Ÿè¸ªå™¨æ˜¾ç¤ºçš„æŒç»­æ—¶é—´ã€‚</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>å‡½æ•°è·Ÿè¸ªå™¨éå¸¸å¼ºå¤§ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„é€‰é¡¹ã€‚å®ƒå·²ç»åœ¨ä¸»çº¿ Linux ä¸­å¯ç”¨ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨å¤§å¤šæ•°å‘è¡Œç‰ˆä¸­é»˜è®¤å¯ç”¨ã€‚å®ƒå…è®¸æ‚¨æ·±å…¥äº†è§£å†…æ ¸åŠå…¶åŠŸèƒ½åº“ï¼Œè®©æ‚¨å¾ˆå¥½åœ°äº†è§£äº‹æƒ…å‘ç”Ÿçš„åŸå› ã€‚å¼€å§‹ä½¿ç”¨å‡½æ•°è·Ÿè¸ªå™¨æ‰“å¼€æˆ‘ä»¬ç§°ä¹‹ä¸ºå†…æ ¸çš„é»‘â€‹â€‹åŒ£å­ã€‚ç©å¾—å¼€å¿ƒï¼</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzM2NTgzNS8=">https://lwn.net/Articles/365835/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzM2Njc5Ni8=">https://lwn.net/Articles/366796/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzM3MDQyMy8=">https://lwn.net/Articles/370423/<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å¹¶å‘ä¸åŒæ­¥ï¼ˆå››ï¼‰RCU</title>
      <link href="/2021/LinuxKernel/LinuxSyncRCU/"/>
      <url>/2021/LinuxKernel/LinuxSyncRCU/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/syncRCU.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5YWMzNzBlM2U3NDA3NGNmODlhMDI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="rcu-æ¦‚è¿°">RCU æ¦‚è¿°</h1><p>RCU çš„å…¨ç§° Read-Copy-Updateï¼Œå®ƒæ˜¯ Linux å†…æ ¸ä¸­ä¸€ç§é‡è¦çš„åŒæ­¥æœºåˆ¶ã€‚Linux å†…æ ¸ä¸­å·²æœ‰äº†åŸå­æ“ä½œã€è‡ªæ—‹é”ã€è¯»å†™è‡ªæ—‹é”ã€è¯»å†™ä¿¡å·é‡ã€äº’æ–¥é”ç­‰é”æœºåˆ¶ï¼Œä¸ºä»€ä¹ˆè¦å•ç‹¬è®¾è®¡ä¸€ä¸ªæ¯”å®ƒä»¬å¤æ‚å¾—å¤šçš„æ–°æœºåˆ¶å‘¢ï¼Ÿå›å¿†è‡ªæ—‹é”ã€è¯»å†™ä¿¡å·é‡å’Œäº’æ–¥é”çš„å®ç°ï¼Œå®ƒä»¬éƒ½ä½¿ç”¨äº†åŸå­æ“ä½œæŒ‡ä»¤ï¼Œå³åŸå­åœ°è®¿é—®å†…å­˜ï¼Œå¤š CPU äº‰ç”¨å…±äº«çš„å˜é‡ä¼šè®©é«˜é€Ÿç¼“å­˜ä¸€è‡´æ€§å˜å¾—å¾ˆç³Ÿï¼Œä½¿å¾—æ€§èƒ½ä¸‹é™ã€‚</p><p>ä»¥è¯»å†™ä¿¡å·é‡ä¸ºä¾‹ï¼Œé™¤äº†ä¸Šè¿°ç¼ºç‚¹å¤–ï¼Œè¯»å†™ä¿¡å·é‡è¿˜æœ‰ä¸€ä¸ªè‡´å‘½å¼±ç‚¹ï¼Œå®ƒå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶å­˜åœ¨ï¼Œä½†æ˜¯è¯»è€…å’Œå†™è€…ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚å› æ­¤ RCU æœºåˆ¶è¦å®ç°çš„ç›®æ ‡æ˜¯ï¼Œè¯»è€…çº¿ç¨‹æ²¡æœ‰åŒæ­¥å¼€é”€ï¼Œæˆ–è€…è¯´åŒæ­¥å¼€é”€å˜å¾—å¾ˆå°ï¼Œç”šè‡³å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä¸éœ€è¦é¢å¤–çš„é”ï¼Œä¸éœ€è¦ä½¿ç”¨åŸå­æ“ä½œæŒ‡ä»¤å’Œå†…å­˜å±éšœæŒ‡ä»¤ï¼Œå³å¯ç•…é€šæ— é˜»åœ°è®¿é—®ï¼›è€ŒæŠŠéœ€è¦åŒæ­¥çš„ä»»åŠ¡äº¤ç»™å†™è€…çº¿ç¨‹ï¼Œå†™è€…çº¿ç¨‹ç­‰å¾…æ‰€æœ‰è¯»è€…çº¿ç¨‹å®Œæˆåæ‰ä¼šæŠŠæ—§æ•°æ®é”€æ¯ã€‚</p><p>åœ¨ RCU ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªå†™è€…åŒæ—¶å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦é¢å¤–çš„ä¿æŠ¤æœºåˆ¶ã€‚RCU æœºåˆ¶çš„åŸç†å¯ä»¥æ¦‚æ‹¬ä¸º RCU è®°å½•äº†æ‰€æœ‰æŒ‡å‘å…±äº«æ•°æ®çš„æŒ‡é’ˆçš„ä½¿ç”¨è€…ï¼Œå½“è¦ä¿®æ”¹å…±äº«æ•°æ®æ—¶ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œåœ¨å‰¯æœ¬ä¸­ä¿®æ”¹ã€‚æ‰€æœ‰è¯»è€…çº¿ç¨‹ç¦»å¼€è¯»è€…ä¸´ç•ŒåŒºä¹‹åï¼ŒæŒ‡é’ˆæŒ‡å‘ä¿®æ”¹åçš„å‰¯æœ¬ï¼Œå¹¶ä¸”åˆ é™¤æ—§æ•°æ®ã€‚</p><p>RCU çš„ä¸€ä¸ªé‡è¦çš„åº”ç”¨åœºæ™¯æ˜¯é“¾è¡¨ï¼Œé“¾è¡¨å¯ä»¥æœ‰æ•ˆåœ°æé«˜éå†è¯»å–æ•°æ®çš„æ•ˆç‡ã€‚è¯»å–é“¾è¡¨æˆå‘˜æ•°æ®æ—¶é€šå¸¸åªéœ€è¦ rcu_read_lock() å‡½æ•°ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–è¯¥é“¾è¡¨ï¼Œå¹¶ä¸”å…è®¸ä¸€ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹é“¾è¡¨ã€‚é‚£ä¸ºä»€ä¹ˆè¿™ä¸ªè¿‡ç¨‹èƒ½ä¿è¯é“¾è¡¨è®¿é—®çš„æ­£ç¡®æ€§å‘¢ï¼Ÿ åœ¨è¯»è€…éå†é“¾è¡¨æ—¶ï¼Œå‡è®¾å¦å¤–ä¸€ä¸ªçº¿ç¨‹åˆ é™¤äº†ä¸€ä¸ªèŠ‚ç‚¹ã€‚åˆ é™¤çº¿ç¨‹ä¼šæŠŠè¿™ä¸ªèŠ‚ç‚¹ä»é“¾è¡¨ä¸­ç§»å‡ºï¼Œä½†ä¸ä¼šç›´æ¥é”€æ¯å®ƒã€‚RCU ä¼šç­‰åˆ°æ‰€æœ‰è¯»çº¿ç¨‹è¯»å–å®Œæˆåï¼Œæ‰é”€æ¯è¿™ä¸ªèŠ‚ç‚¹ã€‚ RCU æä¾›çš„æ¥å£å¦‚ä¸‹ã€‚</p><ul><li>rcu_read_lock()/ rcu_read_unlock()ï¼šç»„æˆä¸€ä¸ª RCU è¯»è€…ä¸´ç•ŒåŒº</li><li>rcu_dereference()ï¼šç”¨äºè·å–è¢« RCU ä¿æŠ¤çš„æŒ‡é’ˆï¼Œè¯»è€…çº¿ç¨‹è¦è®¿é—® RCU ä¿æŠ¤çš„å…±äº«æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨è¯¥å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°æŒ‡é’ˆï¼Œå¹¶ä¸”æŒ‡å‘è¢« RCU ä¿æŠ¤çš„æŒ‡é’ˆ</li><li>rcu_assign_pointer()ï¼šé€šå¸¸ç”¨äºå†™è€…çº¿ç¨‹ã€‚åœ¨å†™è€…çº¿ç¨‹å®Œæˆæ–°æ•°æ®çš„ä¿®æ”¹åï¼Œè°ƒç”¨è¯¥æ¥å£å¯ä»¥è®©è¢« RCU ä¿æŠ¤çš„æŒ‡é’ˆæŒ‡å‘æ–°åˆ›å»ºçš„æ•°æ®ï¼Œç”¨ RCU çš„æœ¯è¯­æ˜¯å‘å¸ƒäº†æ›´æ–°åçš„æ•°æ®</li><li>synchronize_rcu()ï¼šåŒæ­¥ç­‰å¾…æ‰€æœ‰ç°å­˜çš„è¯»è®¿é—®å®Œæˆ</li><li>call_rcu()ï¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“æ‰€æœ‰ç°å­˜çš„è¯»è®¿é—®å®Œæˆåï¼Œè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°é”€æ¯æ—§æ•°æ®</li></ul><h1 id="å…³äº-rcu-çš„ä¸€ä¸ªç®€å•ä¾‹å­">å…³äº RCU çš„ä¸€ä¸ªç®€å•ä¾‹å­</h1><p>ä¸‹é¢é€šè¿‡å…³äº RCU çš„ä¸€ä¸ªç®€å•ä¾‹å­æ¥ç†è§£ä¸Šè¿°æ¥å£çš„å«ä¹‰ï¼Œè¯¥ä¾‹å­æ¥æºäºå†…æ ¸æºä»£ç ä¸­çš„ Documents/RCU/whatisrcu.rstï¼Œå¹¶ä¸”çœç•¥äº†ä¸€äº›å¼‚å¸¸å¤„ç†æƒ…å†µã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">ã€Šå…³äº RCU çš„ä¸€ä¸ªç®€å•ä¾‹å­ã€‹</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;linux/rcupdate.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    <span class="type">int</span> a:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">g_ptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myrcu_reader_thread</span><span class="params">(<span class="type">void</span>* data)</span> <span class="comment">//è¯»è€…çº¿ç¨‹</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        msleep(<span class="number">200</span>);</span><br><span class="line">        rcu_read_lock();</span><br><span class="line">        p = rcu_dereference(g_ptr);</span><br><span class="line">        <span class="keyword">if</span> (p) {</span><br><span class="line">            printk(<span class="string">"%s: read a = %d\n"</span>, __func__, p-&gt;a);</span><br><span class="line">        }</span><br><span class="line">        rcu_read_unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myrcu_del</span><span class="params">(<span class="keyword">struct</span> rcu_head *rh)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">p</span> =</span> container_of(rh, <span class="keyword">struct</span> foo, rcu);</span><br><span class="line">    printk(<span class="string">"%s: read a = %d\n"</span>, __func__, p-&gt;a);</span><br><span class="line">    kfree(p);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">myrcu_writer_thread</span><span class="params">(<span class="type">void</span>* p)</span> <span class="comment">//å†™è€…çº¿ç¨‹</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">new</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">old</span>;</span></span><br><span class="line">    <span class="type">int</span> value = (<span class="type">unsigned</span> <span class="type">int</span>)p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        msleep(<span class="number">400</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">new_ptr</span> =</span> kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> foo), GFP_KERNEL);</span><br><span class="line">        old = g_ptr;</span><br><span class="line">        printk(<span class="string">"%s: read a = %d\n"</span>, __func__, value);</span><br><span class="line">        *new_ptr = *old;</span><br><span class="line">        new_ptr-&gt;a = value;</span><br><span class="line">        rcu_assign_pointer(g_ptr, new_ptr);</span><br><span class="line">        call_rcu(&amp;old_rcu, myrcu_del);</span><br><span class="line">        value++;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">my_test_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">reader_thread</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">writer_thread</span>;</span></span><br><span class="line">    <span class="type">int</span> value = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">"BEN: my module init\n"</span>);</span><br><span class="line"></span><br><span class="line">    g_ptr = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> foo), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    read_thread = kthread_run(myrcu_reader_thread, <span class="literal">NULL</span>, <span class="string">"rcu_reader"</span>);</span><br><span class="line">    writer_thread = kthread_run(myrcu_writer_thread, (<span class="type">void</span>*)(<span class="type">unsigned</span> <span class="type">long</span>)value, <span class="string">"rcu_writer"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">my_test_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    printk(<span class="string">"GoodBye\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(g_ptr)</span><br><span class="line">        kfree(g_ptr);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">MODULE_LICENCE(<span class="string">"GPL);</span></span><br><span class="line"><span class="string">module_init(my_test_init);</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥ä¾‹å­çš„ç›®çš„æ˜¯é€šè¿‡ RCU æœºåˆ¶ä¿æŠ¤ my_test_init() å‡½æ•°åˆ†é…çš„å…±äº«æ•°æ®ç»“æ„ g_ptrï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¯»è€…çº¿ç¨‹å’Œä¸€ä¸ªå†™è€…çº¿ç¨‹æ¥æ¨¡æ‹ŸåŒæ­¥åœºæ™¯ã€‚å¯¹äº myrcu_reader_threadï¼Œæ³¨æ„ä»¥ä¸‹å‡ ç‚¹ã€‚</p><ul><li>é€šè¿‡ rcu_read_lock() å‡½æ•°å’Œ rcu_read_unlock() å‡½æ•°æ¥æ„å»ºä¸€ä¸ªè¯»è€…ä¸´ç•ŒåŒº</li><li>è°ƒç”¨ rcu_dereference() å‡½æ•°è·å–è¢«ä¿æŠ¤æ•°æ®çš„å‰¯æœ¬ï¼Œå³æŒ‡é’ˆ pï¼Œè¿™æ—¶ p å’Œ g_ptr éƒ½æŒ‡å‘æ—§çš„è¢«ä¿æŠ¤æ•°æ®</li><li>è¯»è€…çº¿ç¨‹æ¯éš” 200ms è¯»å–ä¸€æ¬¡è¢«ä¿æŠ¤æ•°æ®</li></ul><p>å¯¹äº myrcu_writer_threadï¼Œæ³¨æ„ä»¥ä¸‹å‡ ç‚¹ã€‚</p><ul><li>åˆ†é…æ–°çš„ä¿æŠ¤æ•°æ®ï¼Œå¹¶ä¿®æ”¹ç›¸åº”æ•°æ®</li><li>rcu_assign_pointer() å‡½æ•°è®© g_ptr æŒ‡å‘æ–°æ•°æ®</li><li>call_rcu() å‡½æ•°æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰å¯¹æ—§æ•°æ®çš„å¼•ç”¨éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰è°ƒç”¨å›è°ƒå‡½æ•°æ¥åˆ é™¤æ—§æ•°æ®</li><li>å†™è€…çº¿ç¨‹æ¯éš” 400ms ä¿®æ”¹è¢«ä¿æŠ¤æ•°æ®</li></ul><p>ä¸Šè¿°è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/RCU.png"></p><p>åœ¨æ‰€æœ‰è®¿é—®ç»“æŸä¹‹åï¼Œå†…æ ¸å¯ä»¥é‡Šæ”¾æ—§æ•°æ®ï¼Œå…³äºä½•æ—¶é‡Šæ”¾æ—§æ•°æ®ï¼Œå†…æ ¸æä¾›äº†ä¸¤ä¸ªæ¥å£å‡½æ•°--synchronize_rcu() å’Œ call_rcu()ã€‚</p><h1 id="ç»å…¸-rcu-å’Œ-tree-rcu">ç»å…¸ RCU å’Œ Tree RCU</h1><p>æœ¬èŠ‚é‡ç‚¹ä»‹ç»ç»å…¸ RCU å’Œ Tree RCU çš„å®ç°ï¼Œå¯ç¡çœ  RCU å’Œå¯æŠ¢å  RCU ç•™ç»™è¯»è€…å­¦ä¹ ã€‚RCU é‡Œæœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯å®½é™æœŸï¼ˆ Grace Periodï¼ŒGPï¼‰å’Œé™æ­¢çŠ¶æ€ï¼ˆQuiescent State, QSï¼‰ã€‚</p><ul><li>å®½é™æœŸï¼šGP æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œæœ‰å¼€å§‹å’Œç»“æŸä¹‹åˆ†ã€‚ä» GP å¼€å§‹ç®—èµ·ï¼Œå¦‚æœæ‰€æœ‰å¤„äºè¯»è€…ä¸´ç•ŒåŒºçš„ CPU éƒ½ç¦»å¼€äº†ä¸´ç•ŒåŒºï¼Œä¹Ÿå°±æ˜¯éƒ½è‡³å°‘ç»å†äº†ä¸€æ¬¡ QSï¼Œé‚£ä¹ˆè®¤ä¸ºä¸€ä¸ª GP å¯ä»¥ç»“æŸäº†ã€‚GP ç»“æŸåï¼ŒRCU ä¼šè°ƒç”¨æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå¦‚é”€æ¯æ—§æ•°æ®ç­‰ã€‚</li><li>é™æ­¢çŠ¶æ€ï¼šåœ¨ RCU è®¾è®¡ä¸­ï¼Œå¦‚æœä¸€ä¸ª CPU å¤„äº RCU è¯»è€…ä¸´ç•ŒåŒºä¸­ï¼Œè¯´æ˜å®ƒçš„çŠ¶æ€æ˜¯æ´»è·ƒçš„ï¼šå¦‚æœåœ¨æ—¶é’Ÿæ»´ç­”ä¸­æ£€æµ‹åˆ°è¯¥ CPU å¤„äºç”¨æˆ·æ¨¡å¼æˆ–ç©ºé—²çŠ¶æ€ï¼Œè¯´æ˜è¯¥ CPU å·²ç»ç¦»å¼€äº†è¯»è€…ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆå®ƒæ˜¯ QSã€‚åœ¨ä¸æ”¯æŒæŠ¢å çš„ RCU å®ç°ä¸­ï¼Œåªè¦æ£€æµ‹åˆ° CPU æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¯ä»¥çŸ¥é“ç¦»å¼€äº†è¯»è€…ä¸´ç•ŒåŒºã€‚</li></ul><p>RCU åœ¨å¼€å‘ Linux2.5 å†…æ ¸æ—¶å·²ç»è¢«æ·»åŠ åˆ° Linux å†…æ ¸ä¸­ï¼Œä½†æ˜¯åœ¨ Linux2.6.29 å†…æ ¸ä¹‹å‰çš„ RCU é€šå¸¸ç§°ä¸ºç»å…¸ RCUï¼ˆ Classic RCUï¼‰ã€‚ç»å…¸ RCU åœ¨å¤§å‹ç³»ç»Ÿä¸­é‡åˆ°äº†æ€§èƒ½é—®é¢˜ï¼Œåæ¥åœ¨ Linux2.6.29 å†…æ ¸ä¸­ IBM çš„å†…æ ¸ä¸“å®¶ Paul E. Mckenney æå‡ºäº† Tree RCU çš„å®ç°ï¼Œ Tree RCU ä¹Ÿç§°ä¸º Hierarchical RCUã€‚</p><p>ç»å…¸ RCU çš„å®ç°åœ¨è¶…çº§å¤§ç³»ç»Ÿä¸­é‡åˆ°äº†é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯æœ‰äº›ç³»ç»Ÿçš„ CPU å†…æ ¸è¶…è¿‡äº† 1024 ä¸ªï¼Œç”šè‡³è¾¾åˆ° 4096 ä¸ªã€‚ç»å…¸ RCU åœ¨åˆ¤æ–­æ˜¯å¦å®Œæˆä¸€æ¬¡ GP æ—¶é‡‡ç”¨å…¨å±€çš„ cpumask å›¾ã€‚å¦‚æœæ¯ä½è¡¨ç¤ºä¸€ä¸ª CPUï¼Œé‚£ä¹ˆåœ¨ 1024 ä¸ª CPU å†…æ ¸çš„ç³»ç»Ÿä¸­ï¼Œ cpumask ä½å›¾å°±æœ‰ 1024 ä½ã€‚æ¯ä¸ª CPU åœ¨ GP å¼€å§‹æ—¶è¦è®¾ç½®ä½å›¾ä¸­å¯¹åº”çš„ä½ï¼ŒGP ç»“æŸæ—¶è¦æ¸…é™¤ç›¸åº”çš„ä½ã€‚å…¨å±€çš„ cpumask ä½å›¾ä¼šå¯¼è‡´å¾ˆå¤š CPU ç«äº‰ä½¿ç”¨ï¼Œå› æ­¤éœ€è¦è‡ªæ—‹é”æ¥ä¿æŠ¤ä½å›¾ã€‚è¿™æ ·å¯¼è‡´é”äº‰ç”¨å˜å¾—å¾ˆæ¿€çƒˆï¼Œæ¿€çƒˆç¨‹åº¦éšç€ CPU çš„ä¸ªæ•°çº¿æ€§é€’å¢ã€‚ä»¥ 4 æ ¸ CPU ä¸ºä¾‹ï¼Œç»å…¸ RCU çš„å®ç¾å¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/rcu1.png"></p><p>è€Œ Tree RCU çš„å®ç°å·§å¦™åœ°è§£å†³äº† cpumask ä½å›¾ç«äº‰é”çš„é—®é¢˜ï¼Œä»¥ä¸Šè¿° 4 æ ¸ CPU ä¸ºä¾‹ï¼Œå‡è®¾ Tree RCU ä»¥ä¸¤ä¸ª CPU ä¸ºä¸€ä¸ª rcu_node, è¿™æ · 4 ä¸ª CPU è¢«åˆ†é…åˆ°ä¸¤ä¸ª rcu_nodeï¼Œä½¿ç”¨å¦å¤–ä¸€ä¸ª rcu_node æ¥ç®¡ç†è¿™ä¸¤ä¸ª rcu_nodeã€‚èŠ‚ç‚¹ 1 ç®¡ç† pu0 å’Œ cpu1ï¼ŒèŠ‚ç‚¹ 2 ç®¡ç† pu2 å’Œ cpu3ã€‚è€ŒèŠ‚ç‚¹ 0 æ˜¯æ ¹èŠ‚ç‚¹ï¼Œç®¡ç†èŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 2ã€‚æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸¤ä½çš„ä½å›¾å°±å¯ä»¥ç®¡ç†å„è‡ªçš„ CPU æˆ–è€…èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½é€šè¿‡å„è‡ªçš„è‡ªæ—‹é”æ¥ä¿æŠ¤ç›¸åº”çš„ä½å›¾ã€‚</p><p>å‡è®¾ 4 ä¸ª CPU éƒ½ç»å†è¿‡ä¸€ä¸ª QSï¼Œé‚£ä¹ˆ 4 ä¸ª CPU é¦–å…ˆåœ¨ Leve0 çš„èŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 2 ä¸Šä¿®æ”¹ä½å›¾ã€‚å¯¹äºèŠ‚ç‚¹ 1 æˆ–è€…èŠ‚ç‚¹ 2 æ¥è¯´ï¼Œåªæœ‰ä¸¤ä¸ª CPU ç«äº‰é”ï¼Œè¿™æ¯”ç»å…¸ RCU ä¸Šçš„é”äº‰ç”¨è¦å‡å°‘ä¸€åŠã€‚å½“èŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 2 ä¸Šçš„ä½å›¾éƒ½è¢«æ¸…é™¤å¹²æµ„åï¼Œæ‰ä¼šæ¸…é™¤ä¸Šä¸€çº§èŠ‚ç‚¹çš„ä½å›¾ï¼Œå¹¶ä¸”åªæœ‰æœ€åæ¸…é™¤èŠ‚ç‚¹çš„ CPU æ‰æœ‰æœºä¼šå°è¯•æ¸…é™¤ä¸Šä¸€çº§èŠ‚ç‚¹çš„ä½å›¾ã€‚å› æ­¤å¯¹äºèŠ‚ç‚¹ 0 æ¥è¯´ï¼Œè¿˜æ˜¯ä¸¤ä¸ª CPU äº‰ç”¨é”ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­åªæœ‰ä¸¤ä¸ª CPU äº‰ç”¨ä¸€ä¸ªé”ã€‚è¿™ç±»ä¼¼äºè¶³çƒæ¯”èµ›ï¼Œè¿›å…¥å››å¼ºçš„ 4 æ”¯çƒé˜Ÿè¢«åˆ†æˆä¸Šä¸‹åŠåŒºï¼Œæ¯ä¸ªåŠåŒºæœ‰ä¸¤æ”¯çƒé˜Ÿï¼Œåªæœ‰åŠå†³èµ›è·èƒœçš„çƒé˜Ÿæ‰èƒ½è¿›å…¥å†³èµ›ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/rcu2.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Sync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å¹¶å‘ä¸åŒæ­¥ï¼ˆä¸‰ï¼‰äº’æ–¥é”</title>
      <link href="/2021/LinuxKernel/LinuxSyncMutex/"/>
      <url>/2021/LinuxKernel/LinuxSyncMutex/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/SyncMutex.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5YTdkMzA3OTEyOTA2ZjUxMGZiNDA=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>äº’æ–¥é”ç±»ä¼¼äº count å€¼ç­‰äº 1 çš„ä¿¡å·é‡ï¼Œä¸ºä»€ä¹ˆå†…æ ¸ç¤¾åŒºè¦é‡æ–°å¼€å‘äº’æ–¥é”ï¼Œmutex æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>mutex æ•°æ®ç»“æ„çš„å®šä¹‰æ¯”ä¿¡å·é‡å°</li><li>äº’æ–¥é”ç›¸å¯¹äºä¿¡å·é‡è¦ç®€å•è½»ä¾¿ä¸€äº›ï¼Œåœ¨é”äº‰ç”¨æ¿€çƒˆçš„æµ‹è¯•åœºæ™¯ä¸‹ï¼Œäº’æ–¥é”æ¯”ä¿¡å·é‡æ‰§è¡Œé€Ÿåº¦æ›´å¿«</li><li>å¯æ‰©å±•æ€§æ›´å¥½</li></ul><h1 id="mutex-æ•°æ®ç»“æ„">mutex æ•°æ®ç»“æ„</h1><p>ä¸‹é¢æ¥çœ‹ mutex æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/mutex.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> {</span></span><br><span class="line"><span class="type">atomic_long_t</span>owner;</span><br><span class="line"><span class="type">raw_spinlock_t</span>wait_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MUTEX_SPIN_ON_OWNER</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_queue</span> <span class="title">osq</span>;</span> <span class="comment">/* Spinner MCS lock */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">wait_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span></span><br><span class="line"><span class="type">void</span>*magic;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span><span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>wait_lockï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¿æŠ¤ wait_list ç¡çœ ç­‰å¾…é˜Ÿåˆ—</li><li>wait_listï¼šç”¨äºç®¡ç†æ‰€æœ‰åœ¨äº’æ–¥é”ä¸Šç¡çœ çš„è¿›ç¨‹ï¼Œæ²¡æœ‰æˆåŠŸè·å–é”çš„è¿›ç¨‹ä¼šåœ¨æ­¤é“¾è¡¨ä¸Šç¡çœ </li><li>ownerï¼š Linux4.10 å†…æ ¸æŠŠåŸæ¥çš„ count æˆå‘˜å’Œ owner æˆå‘˜åˆå¹¶æˆä¸€ä¸ªã€‚åŸæ¥çš„ count æ˜¯ä¸€ä¸ªåŸå­å€¼ï¼Œ1 è¡¨ç¤ºé”æ²¡æœ‰è¢«æŒæœ‰ï¼Œ0 è¡¨ç¤ºé”è¢«æŒæœ‰ï¼Œè´Ÿæ•°è¡¨ç¤ºé”è¢«æŒæœ‰ä¸”æœ‰ç­‰å¾…è€…åœ¨æ’é˜Ÿã€‚ç°åœ¨æ–°ç‰ˆæœ¬çš„ owner ä¸­ï¼Œ0 è¡¨ç¤ºé”æ²¡æœ‰æœªè¢«æŒæœ‰ï¼Œéé›¶å€¼åˆ™è¡¨ç¤ºé”æŒæœ‰è€…çš„ task_struct æŒ‡é’ˆçš„å€¼ã€‚å¦å¤–ï¼Œæœ€ä½ 3 ä½æœ‰ç‰¹æ®Šçš„å«ä¹‰</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_FLAG_WAITERS0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_FLAG_HANDOFF0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_FLAG_PICKUP0x04</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_FLAGS0x07</span></span><br></pre></td></tr></tbody></table></figure><ul><li>osqï¼šç”¨äºå®ç° MCS é”æœºåˆ¶ MUTEX_FLAG_WAITERSï¼šè¡¨ç¤ºäº’æ–¥é”çš„ç­‰å¾…é˜Ÿåˆ—é‡Œæœ‰ç­‰å¾…è€…ï¼Œè§£é”çš„æ—¶å€™å¿…é¡»å”¤é†’è¿™äº›ç­‰å€™çš„è¿›ç¨‹ã€‚ MUTEX_FLAG_HANDOFFï¼šå¯¹äº’æ–¥é”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç­‰å¾…è€…ä¼šè®¾ç½®è¿™ä¸ªæ ‡å¿—ä½ï¼Œé”æŒæœ‰è€…åœ¨è§£é”çš„æ—¶å€™æŠŠé”ç›´æ¥ä¼ é€’ç»™ç¬¬ä¸€ä¸ªç­‰å¾…è€…ã€‚ MUTEX_FLAG_PICKUPï¼šè¡¨ç¤ºé”çš„ä¼ é€’å·²ç»å®Œæˆã€‚</li></ul><p>äº’æ–¥é”å®ç°äº†ä¹è§‚è‡ªæ—‹ï¼ˆ optimistic spinnigï¼‰ç­‰å¾…æœºåˆ¶ã€‚å‡†ç¡®åœ°è¯´ï¼Œäº’æ–¥é”æ¯”è¯»å†™ä¿¡å·é‡æ›´æ—©åœ°å®ç°äº†è‡ªæ—‹ç­‰å¾…æœºåˆ¶ã€‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶çš„æ ¸å¿ƒåŸç†æ˜¯å½“å‘ç°é”æŒæœ‰è€…æ­£åœ¨ä¸´ç•ŒåŒºæ‰§è¡Œå¹¶ä¸”æ²¡æœ‰å…¶å®ƒä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹è¦è°ƒåº¦æ—¶ï¼Œå½“å‰è¿›ç¨‹åšä¿¡é”æŒæœ‰è€…ä¼šå¾ˆå¿«ç¦»å¼€ä¸´ç•ŒåŒºå¹¶é‡Šæ”¾é”ï¼Œå› æ­¤ä¸å…¶ç¡çœ ç­‰å¾…ä¸å¦‚ä¹è§‚åœ°è‡ªæ—‹ç­‰å¾…ï¼Œä»¥å‡å°‘é™²çœ å”¤é†’çš„å¼€é”€ã€‚åœ¨å®ç°è‡ªæ—‹ç­‰å¾…æœºåˆ¶æ—¶ï¼Œå†…æ ¸å®ç°äº†ä¸€å¥— MCS é”æœºåˆ¶æ¥ä¿è¯åªæœ‰ä¸€ä¸ªç­‰å¾…è€…è‡ªæ—‹ç­‰å¾…é”æŒæœ‰è€…é‡Šæ”¾é”ã€‚</p><h1 id="äº’æ–¥é”çš„å¿«é€Ÿé€šé“">äº’æ–¥é”çš„å¿«é€Ÿé€šé“</h1><p>äº’æ–¥é”çš„åˆåŒ–æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é™æ€ä½¿ç”¨ DEFINE_MUTE å®ï¼Œå¦ä¸€ç§æ˜¯åœ¨å†…æ ¸ä»£ç ä¸­åŠ¨æ€ä½¿ç”¨ mutex_init() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __MUTEX_INITIALIZER(lockname) \</span></span><br><span class="line"><span class="meta">{ .owner = ATOMIC_LONG_INIT(0) \</span></span><br><span class="line"><span class="meta">, .wait_lock = __RAW_SPIN_LOCK_UNLOCKED(lockname.wait_lock) \</span></span><br><span class="line"><span class="meta">, .wait_list = LIST_HEAD_INIT(lockname.wait_list) \</span></span><br><span class="line"><span class="meta">__DEBUG_MUTEX_INITIALIZER(lockname) \</span></span><br><span class="line"><span class="meta">__DEP_MAP_MUTEX_INITIALIZER(lockname) }</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_MUTEX(mutexname) \</span></span><br><span class="line"><span class="meta">struct mutex mutexname = __MUTEX_INITIALIZER(mutexname)</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢æ¥çœ‹ mutex_lock() å‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __sched <span class="title function_">mutex_lock</span><span class="params">(<span class="keyword">struct</span> mutex *lock)</span></span><br><span class="line">{</span><br><span class="line">might_sleep();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!__mutex_trylock_fast(lock))</span><br><span class="line">__mutex_lock_slowpath(lock);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(mutex_lock);</span><br></pre></td></tr></tbody></table></figure><p>__mutex_trylock_fast() å‡½æ•°åˆ¤æ–­æ˜¯å¦å¯ä»¥å¿«é€Ÿè·å–é”è‹¥ä¸èƒ½é€šè¿‡å¿«é€Ÿé€šé“è·å–é”ï¼Œé‚£ä¹ˆè¦è¿›å…¥æ…¢é€Ÿé€šé“ __mutex_lock_slowpath().</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">bool</span> __mutex_trylock_fast(<span class="keyword">struct</span> mutex *lock)</span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> curr = (<span class="type">unsigned</span> <span class="type">long</span>)current;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> zero = <span class="number">0UL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (atomic_long_try_cmpxchg_acquire(&amp;lock-&gt;owner, &amp;zero, curr))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>__mutex_trylock_fast() å‡½æ•°å®ç°çš„é‡ç‚¹æ˜¯ atomic_long_try_cmpxchg_acquire() å‡½æ•°ï¼Œå¦‚æœä»¥ cmpxchg() å‡½æ•°çš„è¯­ä¹‰æ¥ç†è§£ï¼Œä¼šå¾—å‡ºé”™è¯¯çš„ç»“è®ºã€‚æ¯”å¦‚ï¼Œå½“ lock-&gt;owner å’Œ zero ç›¸ç­‰æ—¶ï¼Œè¯´æ˜ lock è¿™ä¸ªé”æ²¡æœ‰è¢«æŒæœ‰ï¼Œé‚£ä¹ˆå¯ä»¥æˆåŠŸè·å–é”ï¼ŒæŠŠå½“å‰è¿›ç¨‹çš„ task_struct-&gt;curr çš„å€¼èµ‹ç»™ lock-&gt;ownerï¼Œç„¶åå‡½æ•°è¿”å› lock-&gt;owner çš„æ—§å€¼ï¼Œä¹Ÿå°±æ˜¯ 0ã€‚è¿™æ—¶ if åˆ¤æ–­è¯­å¥åº”è¯¥åˆ¤æ–­ atomic_long_try_cmpxchg_acquire() å‡½æ•°æ˜¯å¦è¿”å› 0 ã‚ªå¯¹ã€‚ä½†æ˜¯åœ¨ Linux5.0 å†…æ ¸çš„ä»£ç é‡Œå’Œæˆ‘ä»¬æƒ³çš„å®Œå…¨ç›¸åï¼Œé‚£æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ ç»†å¿ƒçš„è¯»è€…å¯ä»¥é€šè¿‡ç¿»é˜… Linux å†…æ ¸çš„ git æ—¥å¿—ä¿¡æ¯æ‰¾åˆ°ç­”æ¡ˆã€‚åœ¨ Linux4.18 å†…æ ¸ä¸­æœ‰ä¸ªä¼˜åŒ–çš„è¡¥ä¸ã€‚é”çš„å­ç³»ç»Ÿç»´æŠ¤è€… Peter Zijlstra é€šè¿‡æ¯”è¾ƒåæ±‡ç¼–ä»£ç å‘ç°åœ¨ x86_64 æ¶æ„ä¸‹ä½¿ç”¨ try_cmpxchg() ä»£æ›¿ cmpxchg() æ•°å¯ä»¥å°‘æ‰§è¡Œãƒ¼æ¬¡ test æŒ‡ä»¤ã€‚try_cmpxchg() å‡½æ•°çš„æ ¸å¿ƒè¿˜æ˜¯è°ƒç”¨ cmpxchg() å‡½æ•°ï¼Œä½†æ˜¯è¿”å›å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤º cmpxchg() å‡½æ•°çš„è¿”å›å€¼æ˜¯å¦å’Œç¬¬äºŒä¸ªå‚æ•°çš„å€¼ç›¸ç­‰ã€‚ å› æ­¤ï¼Œå½“åŸå­åœ°åˆ¤æ–­å‡º lock-&gt;owr å­—æ®µä¸º 0 æ—¶ï¼Œè¯´æ˜é”æ²¡æœ‰è¢«è¿›ç¨‹æŒæœ‰ï¼Œé‚£ä¹ˆå¯ä»¥è¿›å…¥å¿«é€Ÿé€šé“ä»¥è¿…é€Ÿè·å–é”ï¼ŒæŠŠå½“å‰è¿›ç¨‹çš„ task_struct æŒ‡é’ˆçš„å€¼åŸå­è®¾ç½®åˆ° lock-&gt;owner å­—æ®µä¸­ã€‚è‹¥ lock-&gt;owner å­—æ®µä¸ä¸º 0ï¼Œåˆ™è¯´æ˜è¯¥é”å·²ç»è¢«è¿›ç¨‹æŒæœ‰ï¼Œé‚£ä¹ˆè¦è¿›å…¥æ…¢é€Ÿé€šé“__mutex_lock_slowpath()ã€‚</p><h1 id="äº’æ–¥é”çš„æ…¢é€Ÿé€šé“">äº’æ–¥é”çš„æ…¢é€Ÿé€šé“</h1><p>__mutex_lock_slowpath() å‡½æ•°è°ƒç”¨__mutex_lock()--&gt;__mutex_lock_common() å‡½æ•°æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lock a mutex (possibly interruptible), slowpath:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">int</span> __sched</span><br><span class="line">__mutex_lock_common(<span class="keyword">struct</span> mutex *lock, <span class="type">unsigned</span> <span class="type">int</span> state, <span class="type">unsigned</span> <span class="type">int</span> subclass,</span><br><span class="line">    <span class="keyword">struct</span> lockdep_map *nest_lock, <span class="type">unsigned</span> <span class="type">long</span> ip,</span><br><span class="line">    <span class="keyword">struct</span> ww_acquire_ctx *ww_ctx, <span class="type">const</span> <span class="type">bool</span> use_ww_ctx)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex_waiter</span> <span class="title">waiter</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ww_mutex</span> *<span class="title">ww</span>;</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!use_ww_ctx)</span><br><span class="line">ww_ctx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">might_sleep();</span><br><span class="line"></span><br><span class="line">MUTEX_WARN_ON(lock-&gt;magic != lock);</span><br><span class="line"></span><br><span class="line">ww = container_of(lock, <span class="keyword">struct</span> ww_mutex, base);</span><br><span class="line"><span class="keyword">if</span> (ww_ctx) {</span><br><span class="line"><span class="keyword">if</span> (unlikely(ww_ctx == READ_ONCE(ww-&gt;ctx)))</span><br><span class="line"><span class="keyword">return</span> -EALREADY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ww_ctx-&gt;acquired == <span class="number">0</span>)</span><br><span class="line">ww_ctx-&gt;wounded = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line">nest_lock = &amp;ww_ctx-&gt;dep_map;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">preempt_disable();</span><br><span class="line">mutex_acquire_nest(&amp;lock-&gt;dep_map, subclass, <span class="number">0</span>, nest_lock, ip);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__mutex_trylock(lock) ||</span><br><span class="line">    mutex_optimistic_spin(lock, ww_ctx, <span class="literal">NULL</span>)) {</span><br><span class="line"><span class="comment">/* got the lock, yay! */</span></span><br><span class="line">lock_acquired(&amp;lock-&gt;dep_map, ip);</span><br><span class="line"><span class="keyword">if</span> (ww_ctx)</span><br><span class="line">ww_mutex_set_context_fastpath(ww, ww_ctx);</span><br><span class="line">preempt_enable();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">raw_spin_lock(&amp;lock-&gt;wait_lock);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * After waiting to acquire the wait_lock, try again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (__mutex_trylock(lock)) {</span><br><span class="line"><span class="keyword">if</span> (ww_ctx)</span><br><span class="line">__ww_mutex_check_waiters(lock, ww_ctx);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> skip_wait;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">debug_mutex_lock_common(lock, &amp;waiter);</span><br><span class="line">waiter.task = current;</span><br><span class="line"><span class="keyword">if</span> (use_ww_ctx)</span><br><span class="line">waiter.ww_ctx = ww_ctx;</span><br><span class="line"></span><br><span class="line">lock_contended(&amp;lock-&gt;dep_map, ip);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!use_ww_ctx) {</span><br><span class="line"><span class="comment">/* add waiting tasks to the end of the waitqueue (FIFO): */</span></span><br><span class="line">__mutex_add_waiter(lock, &amp;waiter, &amp;lock-&gt;wait_list);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">ret = __ww_mutex_add_waiter(&amp;waiter, lock, ww_ctx);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> err_early_kill;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">set_current_state(state);</span><br><span class="line"><span class="keyword">for</span> (;;) {</span><br><span class="line"><span class="type">bool</span> first;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__mutex_trylock(lock))</span><br><span class="line"><span class="keyword">goto</span> acquired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (signal_pending_state(state, current)) {</span><br><span class="line">ret = -EINTR;</span><br><span class="line"><span class="keyword">goto</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ww_ctx) {</span><br><span class="line">ret = __ww_mutex_check_kill(lock, &amp;waiter, ww_ctx);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">raw_spin_unlock(&amp;lock-&gt;wait_lock);</span><br><span class="line">schedule_preempt_disabled();</span><br><span class="line"></span><br><span class="line">first = __mutex_waiter_is_first(lock, &amp;waiter);</span><br><span class="line"></span><br><span class="line">set_current_state(state);</span><br><span class="line"><span class="keyword">if</span> (__mutex_trylock_or_handoff(lock, first) ||</span><br><span class="line">    (first &amp;&amp; mutex_optimistic_spin(lock, ww_ctx, &amp;waiter)))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">raw_spin_lock(&amp;lock-&gt;wait_lock);</span><br><span class="line">}</span><br><span class="line">raw_spin_lock(&amp;lock-&gt;wait_lock);</span><br><span class="line">acquired:</span><br><span class="line">__set_current_state(TASK_RUNNING);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ww_ctx) {</span><br><span class="line"><span class="keyword">if</span> (!ww_ctx-&gt;is_wait_die &amp;&amp;</span><br><span class="line">    !__mutex_waiter_is_first(lock, &amp;waiter))</span><br><span class="line">__ww_mutex_check_waiters(lock, ww_ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">__mutex_remove_waiter(lock, &amp;waiter);</span><br><span class="line"></span><br><span class="line">debug_mutex_free_waiter(&amp;waiter);</span><br><span class="line"></span><br><span class="line">skip_wait:</span><br><span class="line"><span class="comment">/* got the lock - cleanup and rejoice! */</span></span><br><span class="line">lock_acquired(&amp;lock-&gt;dep_map, ip);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ww_ctx)</span><br><span class="line">ww_mutex_lock_acquired(ww, ww_ctx);</span><br><span class="line"></span><br><span class="line">raw_spin_unlock(&amp;lock-&gt;wait_lock);</span><br><span class="line">preempt_enable();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">__set_current_state(TASK_RUNNING);</span><br><span class="line">__mutex_remove_waiter(lock, &amp;waiter);</span><br><span class="line">err_early_kill:</span><br><span class="line">raw_spin_unlock(&amp;lock-&gt;wait_lock);</span><br><span class="line">debug_mutex_free_waiter(&amp;waiter);</span><br><span class="line">mutex_release(&amp;lock-&gt;dep_map, ip);</span><br><span class="line">preempt_enable();</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å°†å…¶ç»˜åˆ¶å‡ºä¸€å¼ å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mutex.png"></p><h1 id="ä¹è§‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶">ä¹è§‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶</h1><p>ä¹è§‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶æ˜¯äº’æ–¥é”çš„ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚ä¹è§‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶å…¶å®å°±æ˜¯åˆ¤æ–­é”æŒæœ‰è€…æ­£åœ¨ä¸´ç•ŒåŒºæ‰§è¡Œæ—¶ï¼Œå¯ä»¥æ–­å®šé”æŒæœ‰è€…ä¼šå¾ˆå¿«é€€å‡ºä¸´ç•ŒåŒºå¹¶ä¸”é‡Šæ”¾é”ï¼Œä¸å…¶è¿›å…¥ç¡çœ é˜Ÿåˆ—ï¼Œä¸å¦‚åƒè‡ªæ—‹é”ä¸€æ ·è‡ªæ—‹ç­‰å¾…ï¼Œå› ä¸ºç¡çœ ä¸å”¤é†’çš„ä»£ä»·å¯èƒ½æ›´é«˜ã€‚ä¹è§‚è‡ªæ—‹ç­‰å¾…æœºåˆ¶çš„å®ç°åœ¨ mutex_optimistic_spin() å‡½æ•°é‡Œã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">bool</span></span><br><span class="line"><span class="title function_">mutex_optimistic_spin</span><span class="params">(<span class="keyword">struct</span> mutex *lock, <span class="keyword">struct</span> ww_acquire_ctx *ww_ctx,</span></span><br><span class="line"><span class="params">      <span class="keyword">struct</span> mutex_waiter *waiter)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!waiter) {</span><br><span class="line"><span class="keyword">if</span> (!mutex_can_spin_on_owner(lock))</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!osq_lock(&amp;lock-&gt;osq))</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Try to acquire the mutex... */</span></span><br><span class="line">owner = __mutex_trylock_or_owner(lock);</span><br><span class="line"><span class="keyword">if</span> (!owner)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mutex_spin_on_owner(lock, owner, ww_ctx, waiter))</span><br><span class="line"><span class="keyword">goto</span> fail_unlock;</span><br><span class="line"></span><br><span class="line">cpu_relax();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!waiter)</span><br><span class="line">osq_unlock(&amp;lock-&gt;osq);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>é‡‡ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/optimistic_lock.png"></p><p>è¯¦ç»†å†…å®¹ä¸åšåˆ†æã€‚</p><h1 id="è¯»å†™é”">è¯»å†™é”</h1><p>ä¸Šè¿°ä»‹ç»çš„ä¿¡å·é‡æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹--æ²¡æœ‰åŒºåˆ†ä¸´ç•ŒåŒºçš„è¯»å†™å±æ€§ã€‚è¯»å†™é”é€šå¸¸å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°è¯»è®¿é—®ä¸´ç•ŒåŒºï¼Œä½†æ˜¯å†™è®¿é—®åªé™åˆ¶äºä¸€ä¸ªçº¿ç¨‹ã€‚è¯»å†™é”èƒ½æœ‰æ•ˆåœ°æé«˜å¹¶å‘æ€§ï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­å…è®¸æœ‰å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œä½†å†™è€…æ˜¯æ’ä»–æ€§çš„ï¼Œè¯»å†™é”å…·æœ‰å¦‚ç‰¹æ€§ã€‚</p><ul><li>å…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œä½†åŒä¸€æ—¶åˆ»å†™è€…ä¸èƒ½è¿›å…¥</li><li>åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªå†™è€…è¿›å…¥ä¸´ç•ŒåŒº</li><li>è¯»è€…å’Œå†™è€…ä¸èƒ½åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒº</li></ul><p>è¯»å†™é”æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯è¯»è€…è‡ªæ—‹é”ç±»å‹å’Œè¯»è€…ä¿¡å·é‡ã€‚è‡ªæ—‹é”ç±»å‹çš„è¯»å†™é”æ•°æ®ç»“æ„å®šä¹‰åœ¨ include/linux/rwlock_types.h å¤´æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/rwlock_types.h&gt;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="type">arch_rwlock_t</span> raw_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SPINLOCK</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> magic, owner_cpu;</span><br><span class="line"><span class="type">void</span> *owner;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} <span class="type">rwlock_t</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The queue read/write lock data structure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">qrwlock</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="type">atomic_t</span> cnts;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __LITTLE_ENDIAN</span></span><br><span class="line">u8 wlocked;<span class="comment">/* Locked for write? */</span></span><br><span class="line">u8 __lstate[<span class="number">3</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">u8 __lstate[<span class="number">3</span>];</span><br><span class="line">u8 wlocked;<span class="comment">/* Locked for write? */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br><span class="line">};</span><br><span class="line"><span class="type">arch_spinlock_t</span>wait_lock;</span><br><span class="line">} <span class="type">arch_rwlock_t</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¸¸ç”¨çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li>rwlock_init()ï¼šåˆå§‹åŒ– rwlock</li><li>write_lock()ï¼šç”³è¯·å†™è€…é”</li><li>write_unlock()ï¼šé‡Šæ”¾å†™è€…é”</li><li>read_lock()ï¼šç”³è¯·è¯»è€…é”</li><li>read_unlock()ï¼šé‡Šæ”¾è¯»è€…é”</li><li>read_lock_irq()ï¼šå…³é—­ä¸­æ–­å¹¶ä¸”ç”³è¯·è¯»è€…é”</li><li>write_lock_irg()ï¼šå…³é—­ä¸­æ–­å¹¶ä¸”ç”³è¯·å†™è€…é”</li><li>write_unlock_irq()ï¼šæ‰“å¼€ä¸­æ–­å¹¶ä¸”é‡Šæ”¾å†™è€…é”</li></ul><p>å’Œè‡ªæ—‹é”ä¸€æ ·ï¼Œè¯»å†™é”æœ‰å…³é—­ä¸­æ–­å’Œä¸‹åŠéƒ¨çš„ç‰ˆæœ¬ã€‚è‡ªæ—‹é”ç±»å‹çš„è¯»å†™é”å®ç°æ¯”è¾ƒç®€å•ã€‚</p><h1 id="æ€»ç»“">æ€»ç»“</h1><ul><li>äº’æ–¥é”æœ€å…ˆå®ç°è‡ªæ—‹ç­‰å¾…æœºåˆ¶</li><li>äº’æ–¥é”åœ¨ç¡çœ ä¹‹å‰å°è¯•è·å–é”</li><li>äº’æ–¥é”é€šè¿‡å®ç° MCS é”æ¥é¿å…å¤šä¸ª CPU äº‰ç”¨é”è€Œå¯¼è‡´ CPU é«˜é€Ÿç¼“å­˜è¡Œé¢ ç°¸ç°è±¡ï¼Œæ­£æ˜¯å› ä¸ºäº’æ–¥é”çš„ç®€æ´æ€§å’Œé«˜æ•ˆæ€§ï¼Œæ‰€ä»¥äº’æ–¥é”çš„ä½¿ç”¨åœºæ™¯æ¯”ä¿¡å·é‡è¦æ›´ä¸¥æ ¼</li></ul><p>ä½¿ç”¨äº’æ–¥é”éœ€è¦æ³¨æ„çš„çº¦æŸæ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>åŒãƒ¼æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰äº’æ–¥é”</li><li>åªæœ‰é”æŒæœ‰è€…å¯ä»¥è§£é”ã€‚ä¸èƒ½åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æŒæœ‰äº’æ–¥é”ï¼Œè€Œåœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹é‡Šæ”¾å®ƒã€‚å› æ­¤äº’æ–¥é”ä¸é€‚åˆå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å¤æ‚çš„åŒæ­¥åœºæ™¯ï¼Œä¿¡å·é‡å’Œè¯»å†™ä¿¡å·é‡åˆ™æ¯”è¾ƒåˆé€‚</li><li>ä¸å…è®¸é€’å½’åœ°åŠ é”å’Œè§£é”</li><li>å½“è¿›ç¨‹æŒæœ‰äº’æ–¥é”æ—¶ï¼Œè¿›ç¨‹ä¸å¯ä»¥é€€å‡º</li><li>äº’æ–¥é”å¿…é¡»ä½¿ç”¨å®˜æ–¹æ¥å£å‡½æ•°æ¥åˆå§‹åŒ–</li><li>äº’æ–¥é”å¯ä»¥ç¡çœ ï¼Œæ‰€ä»¥ä¸å…è®¸åœ¨ä¸­æ–­å¤„ç†ç¨‹åºæˆ–è€…ä¸­æ–­ä¸‹åŠéƒ¨ï¼ˆå¦‚ taskletã€å®šæ—¶å™¨ï¼‰ä¸­ä½¿ç”¨</li></ul><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¯¥å¦‚ä½•é€‰æ‹©è‡ªæ—‹é”ã€ä¿¡å·é‡å’Œäº’æ–¥é”å‘¢ï¼Ÿ åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­å¯ä»¥æ¯«ä¸çŠ¹è±«åœ°ä½¿ç”¨è‡ªæ—‹é”ï¼Œå¦‚æœä¸´ç•ŒåŒºæœ‰ç¡çœ ã€éšå«ç¡çœ çš„åŠ¨ä½œåŠå†…æ ¸æ¥å£å‡½æ•°ï¼Œåº”é¿å…é€‰æ‹©è‡ªæ—‹é”ã€‚åœ¨ä¿¡å·é‡å’Œäº’æ–¥é”ä¸­è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿé™¤éä»£ç åœºæ™¯ä¸ç¬¦åˆä¸Šè¿°äº’æ–¥é”çš„çº¦æŸä¸­çš„æŸä¸€æ¡ï¼Œå¦åˆ™å¯ä»¥ä¼˜å…ˆä½¿ç”¨äº’æ–¥é”ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Sync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å¹¶å‘ä¸åŒæ­¥ï¼ˆäºŒï¼‰ä¿¡å·é‡</title>
      <link href="/2021/LinuxKernel/LinuxSyncSem/"/>
      <url>/2021/LinuxKernel/LinuxSyncSem/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/EventSeq.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5OTFiYzYzNzY4OTA3MTA2MTQ3N2M=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä¿¡å·é‡">ä¿¡å·é‡</h1><p>ä¿¡å·é‡ï¼ˆ semaphoreï¼‰æ˜¯æ“ä½œç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„åŒæ­¥åŸè¯­ä¹‹ä¸€ã€‚è‡ªæ—‹é”æ˜¯ä¸€ç§å®ç°å¿™ç­‰å¾…çš„é”ï¼Œè€Œä¿¡å·é‡åˆ™å…è®¸è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ç®€å•æ¥è¯´ï¼Œä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå®ƒæ”¯æŒä¸¤ä¸ªæ“ä½œåŸè¯­ï¼Œå³ P å’Œ V æ“ä½œã€‚</p><h1 id="ä¿¡å·é‡å®ç°">ä¿¡å·é‡å®ç°</h1><p>semaphore æ•°æ®ç»“æ„çš„å®šä¹‰å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/semaphore.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> {</span></span><br><span class="line"><span class="type">raw_spinlock_t</span>lock;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">wait_list</span>;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>lock æ˜¯è‡ªæ—‹é”å˜é‡ï¼Œç”¨äºä¿æŠ¤ semaphore æ•°æ®ç»“æ„é‡Œçš„ count å’Œ wait_list æˆå‘˜</li><li>count ç”¨äºè¡¨ç¤ºå…è®¸è¿›å…¥ä¸´ç•ŒåŒºçš„å†…æ ¸æ‰§è¡Œè·¯å¾„ä¸ªæ•°</li><li>wait_list é“¾è¡¨ç”¨äºç®¡ç†æ‰€æœ‰åœ¨è¯¥ä¿¡å·é‡ä¸Šç¡çœ çš„è¿›ç¨‹ï¼Œæ²¡æœ‰æˆåŠŸè·å–é”çš„è¿›ç¨‹ä¼šåœ¨è¿™ä¸ªé“¾è¡¨ä¸Šç¡çœ </li></ul><p>é€šå¸¸é€šè¿‡ sema_init() å‡½æ•°è¿›è¡Œä¿¡å·é‡çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­ __SEMAPHORE_INITIALIZER() å®Œæˆå¯¹ semaphore æ•°æ¤ç»“æ„çš„å¡«å……ï¼Œval å€¼é€šå¸¸è®¾ä¸º 1ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __SEMAPHORE_INITIALIZER(name, n)\</span></span><br><span class="line"><span class="meta">{\</span></span><br><span class="line"><span class="meta">.lock= __RAW_SPIN_LOCK_UNLOCKED((name).lock),\</span></span><br><span class="line"><span class="meta">.count= n,\</span></span><br><span class="line"><span class="meta">.wait_list= LIST_HEAD_INIT((name).wait_list),\</span></span><br><span class="line"><span class="meta">}</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_SEMAPHORE(name)\</span></span><br><span class="line"><span class="meta">struct semaphore name = __SEMAPHORE_INITIALIZER(name, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">sema_init</span><span class="params">(<span class="keyword">struct</span> semaphore *sem, <span class="type">int</span> val)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> __<span class="title">key</span>;</span></span><br><span class="line">*sem = (<span class="keyword">struct</span> semaphore) __SEMAPHORE_INITIALIZER(*sem, val);</span><br><span class="line">lockdep_init_map(&amp;sem-&gt;lock.dep_map, <span class="string">"semaphore-&gt;lock"</span>, &amp;__key, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢æ¥çœ‹ down() å‡½æ•°ã€‚down() å‡½æ•°æœ‰å¦‚ä¸‹ä¸€äº›å˜ä½“ã€‚å…¶ä¸­ down() å‡½æ•°å’Œ down_interruptible() å‡½æ•°çš„åŒºåˆ«åœ¨äºï¼Œ down_interruptible() å‡½æ•°åœ¨äº‰ç”¨ä¿¡å·é‡å¤±è´¥æ—¶è¿›å…¥å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ï¼Œè€Œ down() å‡½æ•°è¿›å…¥ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ã€‚è‹¥ down_trylock() å‡½æ•°è¿”å› 0ï¼Œè¡¨ç¤ºæˆåŠŸè·å–é”ï¼šè‹¥è¿”å› 1 è·å–é”å¤±è´¥ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">down</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __must_check <span class="title function_">down_interruptible</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __must_check <span class="title function_">down_killable</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __must_check <span class="title function_">down_trylock</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __must_check <span class="title function_">down_timeout</span><span class="params">(<span class="keyword">struct</span> semaphore *sem, <span class="type">long</span> jiffies)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">up</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span>;</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥çœ‹ down_interruptible() å‡½æ•°çš„å®ç°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * down_interruptible - acquire the semaphore unless interrupted</span></span><br><span class="line"><span class="comment"> * @sem: the semaphore to be acquired</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Attempts to acquire the semaphore.  If no more tasks are allowed to</span></span><br><span class="line"><span class="comment"> * acquire the semaphore, calling this function will put the task to sleep.</span></span><br><span class="line"><span class="comment"> * If the sleep is interrupted by a signal, this function will return -EINTR.</span></span><br><span class="line"><span class="comment"> * If the semaphore is successfully acquired, this function returns 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">down_interruptible</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">might_sleep();</span><br><span class="line">raw_spin_lock_irqsave(&amp;sem-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (likely(sem-&gt;count &gt; <span class="number">0</span>))</span><br><span class="line">sem-&gt;count--;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">result = __down_interruptible(sem);</span><br><span class="line">raw_spin_unlock_irqrestore(&amp;sem-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(down_interruptible);</span><br></pre></td></tr></tbody></table></figure><p>é¦–å…ˆï¼Œç¬¬ 6~9 è¡Œä»£ç åˆ¤æ–­æ˜¯å¦è¿›å…¥è‡ªæ—‹é”çš„ä¸´ç•ŒåŒºã€‚æ³¨æ„ï¼Œåé¢çš„æ“ä½œä¼šä¸´æ—¶æ‰“å¼€è‡ªæ—‹é”ï¼Œè‹¥æ¶‰åŠå¯¹ä¿¡å·é‡ä¸­æœ€é‡è¦çš„ cout çš„æ“ä½œï¼Œéœ€è¦è‡ªæ—‹é”æ¥ä¿æŠ¤ï¼Œå¹¶ä¸”åœ¨æŸäº›ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ä¹Ÿå¯èƒ½ä¼šæ“ä½œè¯¥ä¿¡å·é‡ã€‚ç”±äºéœ€è¦å…³é—­æœ¬åœ° CPU ä¸­æ–­ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ raw_spin_lock_irqsave() å‡½æ•°ã€‚å½“æˆåŠŸè¿›å…¥è‡ªæ—‹é”çš„ä¸´ç•ŒåŒºä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­ sem-&gt;count æ˜¯å¦å¤§äº 0ã€‚å¦‚æœå¤§äº 0ï¼Œåˆ™è¡¨æ˜å½“å‰è¿›ç¨‹å¯ä»¥æˆåŠŸåœ°è·å¾—ä¿¡å·é‡ï¼Œå¹¶å°† sem-&gt;count å€¼å‡ 1ï¼Œç„¶åé€€å‡ºã€‚å¦‚æœ sem-&gt;count å°äºæˆ–ç­‰äº 0ï¼Œè¡¨æ˜å½“å‰è¿›ç¨‹æ— æ³•è·å¾—è¯¥ä¿¡å·é‡ï¼Œåˆ™è°ƒç”¨ __down_interruptible() å‡½æ•°æ¥æ‰§è¡Œç¡çœ æ“ä½œã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> noinline <span class="type">int</span> __sched __down_interruptible(<span class="keyword">struct</span> semaphore *sem)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> __down_common(sem, TASK_INTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>__down_interruptible() å‡½æ•°å†…éƒ¨è°ƒç”¨__down_common() å‡½æ•°æ¥å®ç° state å‚æ•°ä¸º TASK_INTERRUPTIBLEã€‚ timeout å‚æ•°ä¸º MAX_SCHEDULE_TIMEOUTï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ LONG_MAX å€¼ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;down_interruptible()-&gt;__down_interruptible()-&gt;down_common()&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Because this function is inlined, the 'state' parameter will be</span></span><br><span class="line"><span class="comment"> * constant, and thus optimised away by the compiler.  Likewise the</span></span><br><span class="line"><span class="comment"> * 'timeout' parameter for the cases without timeouts.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __sched __down_common(<span class="keyword">struct</span> semaphore *sem, <span class="type">long</span> state,</span><br><span class="line"><span class="type">long</span> timeout)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore_waiter</span> <span class="title">waiter</span>;</span></span><br><span class="line"></span><br><span class="line">list_add_tail(&amp;waiter.<span class="built_in">list</span>, &amp;sem-&gt;wait_list);</span><br><span class="line">waiter.task = current;</span><br><span class="line">waiter.up = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) {</span><br><span class="line"><span class="keyword">if</span> (signal_pending_state(state, current))</span><br><span class="line"><span class="keyword">goto</span> interrupted;</span><br><span class="line"><span class="keyword">if</span> (unlikely(timeout &lt;= <span class="number">0</span>))</span><br><span class="line"><span class="keyword">goto</span> timed_out;</span><br><span class="line">__set_current_state(state);</span><br><span class="line">raw_spin_unlock_irq(&amp;sem-&gt;lock);</span><br><span class="line">timeout = schedule_timeout(timeout);</span><br><span class="line">raw_spin_lock_irq(&amp;sem-&gt;lock);</span><br><span class="line"><span class="keyword">if</span> (waiter.up)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> timed_out:</span><br><span class="line">list_del(&amp;waiter.<span class="built_in">list</span>);</span><br><span class="line"><span class="keyword">return</span> -ETIME;</span><br><span class="line"></span><br><span class="line"> interrupted:</span><br><span class="line">list_del(&amp;waiter.<span class="built_in">list</span>);</span><br><span class="line"><span class="keyword">return</span> -EINTR;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>semaphore_waiter æ•°æ®ç»“æ„ç”¨äºæè¿°è·å–ä¿¡å·é‡å¤±è´¥çš„è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ä¼šæœ‰ä¸€ä¸ª semaphore_waiter æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”æŠŠå½“å‰è¿›ç¨‹æ”¾åˆ°ä¿¡å·é‡ sem çš„æˆå‘˜å˜é‡ wait_list é“¾è¡¨ä¸­ï¼Œæ¥ä¸‹æ¥çš„ for å¾ªç¯å°†å½“å‰è¿›ç¨‹çš„ task_structã€çŠ¶æ€è®¾ç½®æˆ TASK_INTERRUPTIBLEï¼Œç„¶åè°ƒç”¨ schedule_timeout() å‡½æ•°ä¸»åŠ¨è®©å‡º CPUï¼Œç›¸å½“äºå½“å‰è¿›ç¨‹ç¡çœ ã€‚æ³¨æ„ schedule_timeou() å‡½æ•°çš„å‚æ•°æ˜¯ MAX_SCHEDULE_TIMEOUTï¼Œå®ƒå¹¶æ²¡æœ‰å®é™…ç­‰å¾… MAX_SCHEDULE_TIMEOUT çš„æ—¶é—´ã€‚å½“è¿›ç¨‹å†æ¬¡è¢«è°ƒåº¦å›æ¥æ‰§è¡Œæ—¶ï¼Œ schedule_timeout() å‡½æ•°è¿”å›å¹¶åˆ¤æ–­å†æ¬¡è¢«è°ƒåº¦çš„åŸå› ï¼Œå½“ waiter.up ä¸º true æ—¶ï¼Œè¯´æ˜ç¡çœ åœ¨ wait_list é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹è¢«è¯¥ä¿¡å·é‡çš„ UP æ“ä½œå”¤é†’ï¼Œè¿›ç¨‹å¯ä»¥è·å¾—è¯¥ä¿¡å·é‡ã€‚å¦‚æœè¿›ç¨‹è¢«å…¶å®ƒ CPU å‘é€çš„ä¿¡å·æˆ–è€…ç”±äºè¶…æ—¶ç­‰è€Œå”¤é†’ï¼Œåˆ™è·³è½¬åˆ° timed_out æˆ– interrupted æ ‡ç­¾å¤„å¹¶ä¸”è¿”å›é”™è¯¯ä»£ç ã€‚</p><p>down_interruptible() å‡½æ•°ä¸­ï¼Œåœ¨è°ƒç”¨ __down_interruptible() å‡½æ•°æ—¶åŠ å…¥ sem-&gt;lock çš„è‡ªæ—‹é”ï¼Œè¿™æ˜¯è‡ªæ—‹é”çš„ä¸€ä¸ªä¸´ç•ŒåŒºã€‚å‰é¢æåˆ°ï¼Œè‡ªæ—‹é”ä¸´ç•ŒåŒºä¸­ç»å¯¹ä¸èƒ½ç¡çœ ï¼Œéš¾é“è¿™æ˜¯ä¾‹å¤–ï¼Ÿä»”ç»†é˜…è¯»__down_common() å‡½æ•°ï¼Œä¼šå‘ç° for å¾ªç¯åœ¨è°ƒç”¨ schedule_timeout() å‡½æ•°ä¸»åŠ¨è®©å‡º CPU æ—¶ï¼Œå…ˆè°ƒç”¨ raw_spin_unlock_irq() å‡½æ•°é‡Šæ”¾äº†è¯¥é”ï¼Œå³è°ƒç”¨ schedule_timeout() å‡½æ•°æ—¶å·²ç»æ²¡æœ‰è‡ªæ—‹é”äº†ï¼Œå¯ä»¥è®©è¿›ç¨‹å…ˆç¡çœ ï¼Œâ€œé†’æ¥æ—¶â€å†è¡¥åŠ ä¸€ä¸ªé”ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹çš„å¸¸ç”¨æŠ€å·§ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸ dowm() å‡½æ•°å¯¹åº”çš„ up() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * up - release the semaphore</span></span><br><span class="line"><span class="comment"> * @sem: the semaphore to release</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Release the semaphore.  Unlike mutexes, up() may be called from any</span></span><br><span class="line"><span class="comment"> * context and even by tasks which have never called down().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">up</span><span class="params">(<span class="keyword">struct</span> semaphore *sem)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">raw_spin_lock_irqsave(&amp;sem-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (likely(list_empty(&amp;sem-&gt;wait_list)))</span><br><span class="line">sem-&gt;count++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">__up(sem);</span><br><span class="line">raw_spin_unlock_irqrestore(&amp;sem-&gt;lock, flags);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(up);</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä¿¡å·é‡ä¸Šçš„ç­‰å¾…é˜Ÿåˆ—ï¼ˆsem-&gt;wait_listï¼‰ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ²¡æœ‰è¿›ç¨‹åœ¨ç­‰å¾…è¯¥ä¿¡å·é‡ï¼Œç›´æ¥æŠŠ sem-&gt;count åŠ  1 å³å¯ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜æœ‰è¿›ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œç¡æ°‘ï¼Œéœ€è¦è°ƒç”¨__up() å”¤é†’å®ƒä»¬ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> noinline <span class="type">void</span> __sched __up(<span class="keyword">struct</span> semaphore *sem)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore_waiter</span> *<span class="title">waiter</span> =</span> list_first_entry(&amp;sem-&gt;wait_list,</span><br><span class="line"><span class="keyword">struct</span> semaphore_waiter, <span class="built_in">list</span>);</span><br><span class="line">list_del(&amp;waiter-&gt;<span class="built_in">list</span>);</span><br><span class="line">waiter-&gt;up = <span class="literal">true</span>;</span><br><span class="line">wake_up_process(waiter-&gt;task);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>é¦–å…ˆæ¥çœ‹ sm-&gt;wait_list ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜ waiterï¼Œè¿™ä¸ªç­‰å¾…é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œåœ¨ dowm() å‡½æ•°ä¸­é€šè¿‡ list_add_tail() å‡½æ•°æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ã€‚æŠŠ waiter-&gt;up è®¾ç½®ä¸º true, æŠŠç„¶åè°ƒç”¨ wake_up_process() å‡½æ•°å”¤é†’ wite-&gt;task è¿›ç¨‹ã€‚åœ¨ down() å‡½æ•°ä¸­ï¼Œ walter-&gt;task è¿›ç¨‹é†’æ¥åä¼šåˆ¤æ–­ waiter-&gt;up å˜é‡æ˜¯å¦ä¸º true å¦‚æœä¸º true åˆ™ç›´æ¥å› 0ï¼Œè¡¨ç¤ºè¯¥è¿‡å¾—æˆåŠŸè·å–ä¿¡å·é‡ã€‚</p><h1 id="è¯»å†™ä¿¡å·é‡">è¯»å†™ä¿¡å·é‡</h1><h2 id="rw_semaphore-æ•°æ®ç»“æ„">rw_semaphore æ•°æ®ç»“æ„</h2><p>rw_semaphore æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> {</span></span><br><span class="line"><span class="type">atomic_long_t</span> count;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Write owner or one of the read owners as well flags regarding</span></span><br><span class="line"><span class="comment"> * the current state of the rwsem. Can be used as a speculative</span></span><br><span class="line"><span class="comment"> * check to see if the write owner is running on the cpu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">atomic_long_t</span> owner;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_RWSEM_SPIN_ON_OWNER</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_queue</span> <span class="title">osq</span>;</span> <span class="comment">/* spinner MCS lock */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">raw_spinlock_t</span> wait_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">wait_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_RWSEMS</span></span><br><span class="line"><span class="type">void</span> *magic;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span><span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>count ç”¨äºè¡¨ç¤ºè¯»å†™ä¿¡å·é‡çš„è®¡æ•°ã€‚ä»¥å‰è¯»å†™ä¿¡å·é‡çš„å®ç°ç”¨ activity æ¥è¡¨ç¤ºã€‚è‹¥ activity ä¸º 0ï¼Œè¡¨ç¤ºæ²¡æœ‰è¯»è€…å’Œå†™è€…ï¼šè‹¥ activity ä¸ºãƒ¼ 1ï¼Œè¡¨ç¤ºæœ‰å†™è€…ï¼Œè‹¥ activity å¤§äº 0ï¼Œè¡¨ç¤ºæœ‰è¯»è€…ã€‚ç°åœ¨ count çš„è®¡æ•°æ–¹æ³•å·²ç»å‘ç”Ÿäº†å˜åŒ–</li><li>wait_list é“¾è¡¨ç”¨äºç®¡ç†æ‰€æœ‰åœ¨è¯¥ä¿¡å·é‡ä¸Šç¡çœ çš„è¿›ç¨‹ï¼Œæ²¡æœ‰æˆåŠŸè·å–é”çš„è¿›ç¨‹ä¼šç¡çœ åœ¨è¿™ä¸ªé“¾è¡¨ä¸Š</li><li>wait_lock æ˜¯ä¸€ä¸ªè‡ªæ—‹é”å˜é‡ï¼Œç”¨äºå®ç°å¯¹ rw_semaphore æ•°æ®ç»“æ„ä¸­ count æˆå‘˜çš„åŸå­æ“ä½œå’Œä¿æŠ¤</li><li>osqï¼šMCS é”</li><li><p>ownerï¼šå½“å†™è€…æˆåŠŸè·å–é”æ—¶ï¼Œ owner æŒ‡å‘é”æŒæœ‰è€…çš„ task_struct æ•°æ®ç»“æ„</p></li><li>è‹¥ count åˆå§‹åŒ–ä¸º 0ï¼Œè¡¨ç¤ºæ²¡æœ‰è¯»è€…ä¹Ÿæ²¡æœ‰å†™è€…</li><li>è‹¥ count ä¸ºæ­£æ•°ï¼Œè¡¨ç¤ºæœ‰ count ä¸ªè¯»è€…</li><li>å½“æœ‰å†™è€…ç”³è¯·é”æ—¶ï¼Œcount å€¼è¦åŠ ä¸Š RWSEM_ACTIVE_WIRTE_BIAS</li><li>å½“æœ‰è¯»è€…ç”³è¯·é”æ—¶ï¼Œè‹¥ count å€¼è¦åŠ ä¸Š RWSEM_ACTIVE_READ_BIASï¼Œå³ count å€¼åŠ ä¸€</li><li>å½“æœ‰å¤šä¸ªå†™è€…ä¸­è¯·æ—¶ï¼Œåˆ¤æ–­ count å€¼æ˜¯å¦ç­‰äº RWSEM_ACTIVE_WIRTE_BIASï¼ˆ-65535ï¼‰è‹¥ä¸ç›¸ç­‰ï¼Œè¯´æ˜å·²ç»æœ‰å†™è€…æŠ¢å…ˆæŒæœ‰é”ï¼Œè¦è‡ªæ—‹ç­‰å¾…æˆ–è€…ç¡çœ </li><li><p>å½“è¯»è€…ç”³è¯·é”æ—¶ï¼Œè‹¥ count å€¼åŠ ä¸Š RWSEM_ACTIVE_READ_BIASï¼ˆ1ï¼‰åè¿˜å°äº 0ï¼Œè¯´æ˜å·²ç»æœ‰ä¸ªå†™è€…å·²ç»æˆåŠŸç”³è¯·é”ï¼Œåªèƒ½ç­‰å¾…å†™è€…é‡Šæ”¾é”</p></li></ul><p>æŠŠ count å€¼å½“ä½œåå…­è¿›åˆ¶æˆ–è€…åè¿›åˆ¶æ•°ä¸æ˜¯å¼€å‘äººå‘˜çš„åŸæœ¬è®¾è®¡æ„å›¾ï¼Œå…¶å®åº”è¯¥æŠŠ count å€¼åˆ†æˆä¸¤ä¸ªå­—æ®µï¼šBit[0:31] ä¸ºä½å­—æ®µï¼Œè¡¨ç¤ºæ­£åœ¨æŒæœ‰é”çš„è¯»è€…æˆ–è€…å†™è€…çš„ä¸ªæ•°ï¼›Bit[32:63] ä¸ºé«˜å­—æ®µï¼Œé€šå¸¸ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªæ­£åœ¨æŒæœ‰æˆ–è€…å¤„äº pending çŠ¶æ€çš„å†™è€…ï¼Œä»¥åŠç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰è¯»å†™è€…åœ¨ç­‰å¾…ã€‚å› æ­¤ count å€¼å¯ä»¥çœ‹ä½œä¸€ä¸ªäºŒå…ƒæ•°ï¼Œå«ä¹‰å¦‚ä¸‹</p><ul><li>RWSEM_ACTIVE_READ_BIAS=0x000 0001 =[0ï¼Œ1]ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªè¯»è€…</li><li>RWSEM_ACTIVE_WRITE_BIAS=0xFFFF 0000 =[-1ï¼Œ1]ï¼Œè¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªæ´»è·ƒçš„å†™è€…</li><li>RWSEM_WAITING_BIAS=0xFFFF 0000=[-1ï¼Œ0]ï¼Œè¡¨ç¤ºç¡çœ ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰è¯»å†™è€…åœ¨ç¡çœ ç­‰å¾…</li></ul><p>kernel/locking/rwsem-xadd.c ä»£ç ä¸­æœ‰å¦‚ä¸‹ä¸€æ®µå…³äº count å€¼å«ä¹‰çš„æ¯”è¾ƒå…¨é¢çš„ä»‹ç»ã€‚</p><ul><li>0x0000 0000 åˆå§‹åŒ–å€¼ï¼Œè¡¨ç¤ºæ²¡æœ‰è¯»è€…å’Œå†™è€…</li><li>0x0000 000Xï¼šè¡¨ç¤ºæœ‰ X ä¸ªæ´»è·ƒçš„è¯»è€…æˆ–è€…æ­£åœ¨ç”³è¯·çš„è¯»è€…ï¼Œæ²¡æœ‰å†™è€…å¹²æ‰°</li><li>0xFFFF 000Xï¼šæˆ–è€…è¡¨ç¤ºå¯èƒ½æœ‰ X ä¸ªæ´»è·ƒè¯»è€…ï¼Œè¿˜æœ‰å†™è€…æ­£åœ¨ç­‰å¾…ï¼›æˆ–è€…è¡¨ç¤ºæœ‰äºŒä¸ªå†™è€…æŒæœ‰é”ï¼Œè¿˜æœ‰å¤šä¸ªè¯»è€…æ­£åœ¨ç­‰å¾…</li><li>0xFFFF 0001ï¼šæˆ–è€…è¡¨ç¤ºå½“å‰åªæœ‰ä¸€ä¸ªæ´»è·ƒçš„å†™è€…ï¼›æˆ–è€…è¡¨ç¤ºä¸€ä¸ªæ´»è·ƒæˆ–è€…ç”³è¯·ä¸­çš„è¯»è€…ï¼Œè¿˜æœ‰å†™è€…æ­£åœ¨ç¡çœ ç­‰å¾…</li><li>0xFFFF 0000 è¡¨ç¤º WAITING_BIASï¼Œæœ‰è¯»è€…æˆ–è€…å†™è€…æ­£åœ¨ç­‰å¾…ï¼Œä½†æ˜¯å®ƒä»¬éƒ½è¿˜æ²¡æˆåŠŸè·å–é”ã€‚</li></ul><h2 id="ç”³è¯·è¯»è€…ç±»å‹ä¿¡å·é‡">ç”³è¯·è¯»è€…ç±»å‹ä¿¡å·é‡</h2><p>ä¸‹é¢æ¥çœ‹ down_read() å‡½æ•°çš„å®ç°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __sched <span class="title function_">down_read</span><span class="params">(<span class="keyword">struct</span> rw_semaphore *sem)</span></span><br><span class="line">{</span><br><span class="line">might_sleep();</span><br><span class="line">rwsem_acquire_read(&amp;sem-&gt;dep_map, <span class="number">0</span>, <span class="number">0</span>, _RET_IP_);</span><br><span class="line"></span><br><span class="line">LOCK_CONTENDED(sem, __down_read_trylock, __down_read);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rwsem_acquire_read(l, s, t, i)lock_acquire_shared(l, s, t, NULL, i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> lock_acquire_shared(l, s, t, n, i)lock_acquire(l, s, t, 1, 1, n, i)</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We are not always called with irqs disabled - do that here,</span></span><br><span class="line"><span class="comment"> * and also avoid lockdep recursion:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock_acquire</span><span class="params">(<span class="keyword">struct</span> lockdep_map *lock, <span class="type">unsigned</span> <span class="type">int</span> subclass,</span></span><br><span class="line"><span class="params">  <span class="type">int</span> trylock, <span class="type">int</span> read, <span class="type">int</span> check,</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> lockdep_map *nest_lock, <span class="type">unsigned</span> <span class="type">long</span> ip)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">trace_lock_acquire(lock, subclass, trylock, read, check, nest_lock, ip);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!debug_locks)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!lockdep_enabled())) {</span><br><span class="line"><span class="comment">/* XXX allow trylock from NMI ?!? */</span></span><br><span class="line"><span class="keyword">if</span> (lockdep_nmi() &amp;&amp; !trylock) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">held_lock</span> <span class="title">hlock</span>;</span></span><br><span class="line"></span><br><span class="line">hlock.acquire_ip = ip;</span><br><span class="line">hlock.instance = lock;</span><br><span class="line">hlock.nest_lock = nest_lock;</span><br><span class="line">hlock.irq_context = <span class="number">2</span>; <span class="comment">// XXX</span></span><br><span class="line">hlock.trylock = trylock;</span><br><span class="line">hlock.read = read;</span><br><span class="line">hlock.check = check;</span><br><span class="line">hlock.hardirqs_off = <span class="literal">true</span>;</span><br><span class="line">hlock.references = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">verify_lock_unused(lock, &amp;hlock, subclass);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">raw_local_irq_save(flags);</span><br><span class="line">check_flags(flags);</span><br><span class="line"></span><br><span class="line">lockdep_recursion_inc();</span><br><span class="line">__lock_acquire(lock, subclass, trylock, read, check,</span><br><span class="line">       irqs_disabled_flags(flags), nest_lock, ip, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">lockdep_recursion_finish();</span><br><span class="line">raw_local_irq_restore(flags);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL_GPL(lock_acquire);</span><br></pre></td></tr></tbody></table></figure><p>ç”³è¯·è¯»è€…é”æµç¨‹å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/read_lock.png"></p><h2 id="é‡Šæ”¾è¯»è€…ç±»å‹ä¿¡å·é‡">é‡Šæ”¾è¯»è€…ç±»å‹ä¿¡å·é‡</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">up_read</span><span class="params">(<span class="keyword">struct</span> rw_semaphore *sem)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> perf_singlethreaded ? <span class="number">0</span> : pthread_rwlock_unlock(&amp;sem-&gt;lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å…³äºå†™ä¿¡å·é‡è¿™é‡Œä¸åšè¯¦ç»†åˆ†æäº†ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>è¯»å†™ä¿¡å·é‡åœ¨å†…æ ¸ä¸­åº”ç”¨å¹¿æ³›ï¼Œç‰¹åˆ«æ˜¯åœ¨å†…å­˜ç®¡ç†ä¸­ï¼Œé™¤äº†å‰é¢ä»‹ç»çš„ mm-&gt;mmap_sem è¿˜æœ‰ RMAP ç³»ç»Ÿä¸­çš„çš„ anon_vma-&gt;rwsemã€ address_space æ•°æ®ç»“æ„ä¸­çš„ i_mmap_rwsem ç­‰ã€‚ æ€»ç»“è¯»å†™ä¿¡å·é‡çš„é‡è¦ç‰¹æ€§ï¼š</p><ul><li>down_read()ï¼šå¦‚æœä¸€ä¸ªè¿›ç¨‹æŒæœ‰è¯»è€…é”ï¼Œé‚£ä¹ˆå…è®¸ç»§ç»­ç”³è¯·å¤šä¸ªè¯»è€…é”ï¼Œç”³è¯·çš„å†™è€…é”åˆ™è¦ç­‰å¾…</li><li>down_write()ï¼šå¦‚æœä¸€ä¸ªè¿›ç¨‹æŒæœ‰å†™è€…é”ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªè¿›ç¨‹ç”³è¯·è¯¥å†™è€…é”è¦è‡ªæ—‹ç­‰å¾…ç”³è¯·è¯»è€…é”åˆ™è¦ç­‰å¾…</li><li>up_write() up_read()ï¼šå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯å†™è€…ï¼Œé‚£ä¹ˆå”¤é†’è¯¥å†™è€…ï¼›å¦åˆ™å”¤é†’æ’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­æœ€å‰é¢è¿ç»­çš„å‡ ä¸ªè¯»è€…</li></ul><h1 id="æ€»ç»“">æ€»ç»“</h1><p>ä¿¡å·é‡æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç‰¹ç‚¹ï¼Œå®ƒå¯ä»¥åŒæ—¶å…è®¸ä»»æ„æ•°é‡çš„é”æŒæœ‰è€…ã€‚ä¿¡å·é‡åˆå§‹åŒ–å‡½æ•°ä¸º sema_init(struct semaphore *sem, int val)ï¼Œå…¶ä¸­ val çš„å€¼å¯ä»¥å¤§äºæˆ–ç­‰äº 1ã€‚å½“ val å¤§äº 1 æ—¶ï¼Œè¡¨ç¤ºå…è®¸åœ¨åŒä¸€æ—¶åˆ»è‡³å¤šæœ‰ val ä¸ªé”æŒæœ‰è€…ï¼Œè¿™ç§ä¿¡å·é‡å«ä½œè®¡æ•°ä¿¡å·é‡ï¼ˆ counting semaphoreï¼‰ï¼›å½“ val ç­‰äº 1 æ—¶ï¼ŒåŒä¸€æ—¶åˆ»ä»…å…è®¸ä¸€ä¸ª CPU æŒæœ‰é”ï¼Œè¿™ç§ä¿¡å·é‡å«ä½œäº’æ–¥ä¿¡å·é‡æˆ–è€…äºŒè¿›åˆ¶ä¿¡å·é‡ï¼ˆ binary semaphoreï¼‰ã€‚åœ¨ Linux å†…æ ¸ä¸­ï¼Œå¤§å¤šä½¿ç”¨ val å€¼ä¸º 1 çš„ä¿¡å·é‡ã€‚ç›¸æ¯”è‡ªæ—‹é”ï¼Œä¿¡å·é‡æ˜¯ä¸€ä¸ªå…è®¸ç¡çœ çš„é”ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Sync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å¹¶å‘ä¸åŒæ­¥ï¼ˆä¸€ï¼‰è‡ªæ—‹é”</title>
      <link href="/2021/LinuxKernel/LinuxSyncSpinLock/"/>
      <url>/2021/LinuxKernel/LinuxSyncSpinLock/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/EventSpinLock.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM5ODMzMDFlZmFkNDA3NTI1N2M2ZDA=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ç»å…¸è‡ªæ—‹é”">ç»å…¸è‡ªæ—‹é”</h1><p>å¦‚æœä¸´ç•ŒåŒºä¸­åªæœ‰ä¸€ä¸ªå¤‰é‡ï¼Œé‚£ä¹ˆåŸå­å˜é‡å¯ä»¥è§£æ±ºé—®é¢˜ï¼Œä½†æ˜¯ä¸´ç•ŒåŒºæœ‰ä¸€ä¸ªæ•°æ®æ“ä½œçš„é›†åˆï¼Œéœ€è¦é€šè¿‡é”æœºåˆ¶æ¥ä¿éšœï¼Œè‡ªæ—‹é”ï¼ˆ spinlockï¼‰æ˜¯ Linux å†…æ ¸ä¸­æœ€å¸¸è§çš„é”æœºåˆ¶ã€‚</p><ul><li>å¿™ç­‰å¾…çš„é”æœºåˆ¶ã€‚æ“ä½œç³»ç»Ÿä¸­é”çš„æœºåˆ¶åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å¿™ç­‰å¾…ï¼Œå¦ä¸€ç±»æ˜¯ç¡çœ ç­‰å¾…</li><li>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå†…æ ¸ä»£ç è·¯å¾„å¯ä»¥è·å¾—è¯¥é”</li><li>è¦æ±‚è‡ªæ—‹é”æŒæœ‰è€…å°½å¿«å®Œæˆä¸´ç•ŒåŒºçš„æ‰§è¡Œä»»åŠ¡ï¼Œç‰¹åˆ«æ˜¯è‡ªæ—‹é”ä¸´ç•ŒåŒºé‡Œä¸èƒ½ç¡çœ </li><li>è‡ªæ—‹é”å¯ä»¥åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨</li></ul><h2 id="è‡ªæ—‹é”çš„å®ç°">è‡ªæ—‹é”çš„å®ç°</h2><p>å…ˆçœ‹ spinlock æ•°æ®ç»“æ„çš„å®šä¹‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/spinlock_types.h&gt;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> <span class="title">rlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> LOCK_PADSIZE (offsetof(struct raw_spinlock, dep_map))</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">u8 __padding[LOCK_PADSIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line">};</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br><span class="line">} <span class="type">spinlock_t</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> {</span></span><br><span class="line"><span class="type">arch_spinlock_t</span> raw_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SPINLOCK</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> magic, owner_cpu;</span><br><span class="line"><span class="type">void</span> *owner;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} <span class="type">raw_spinlock_t</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">u32 slock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">raw_tickets</span> {</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARMEB__</span></span><br><span class="line">u16 next;</span><br><span class="line">u16 owner;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">u16 owner;</span><br><span class="line">u16 next;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} tickets;</span><br><span class="line">};</span><br><span class="line">} <span class="type">arch_spinlock_t</span>;</span><br></pre></td></tr></tbody></table></figure><p>spinlock æ•°æ®ç»“æ„çš„å®šä¹‰æ—¢è€ƒè™‘åˆ°äº†ä¸åŒå¤„ç†å™¨æ¶æ„çš„æ”¯æŒå’Œå®æ—¶æ€§å†…æ ¸çš„è¦æ±‚ï¼Œè¿˜å®šä¹‰äº† raw_spinlock å’Œ arch_spinlock_t æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ arch_spinlock_t æ•°æ®ç»“æ„å’Œæ¶æ„æœ‰å…³ã€‚åœ¨ Linux2.6.25 å†…æ ¸ä¹‹å‰ï¼Œ spinlock æ•°æ®ç»“æ„å°±æ˜¯ä¸€ä¸ªç®€å•çš„æ— ç¬¦å·ç±»å‹å˜é‡ã€‚è‹¥ slock å€¼ä¸º 1ï¼Œè¡¨ç¤ºé”æœªè¢«æŒæœ‰ï¼›è‹¥ä¸º 0ï¼Œè¡¨ç¤ºé”è¢«æŒæœ‰ã€‚è¿™ä¼šå­˜åœ¨ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼Œä¸å…¬å¹³å’Œæ•ˆç‡ä½ä¸‹ã€‚å› æ­¤åœ¨ Liux2.6.25 å†…æ ¸åï¼Œè‡ªæ—‹é”å®ç°äº†â€œåŸºäºæ’é˜Ÿçš„ FIFOâ€ç®—æ³•çš„è‡ªæ—‹é”æœºåˆ¶ï¼Œç§°ä¸ºåŸºäºæ’é˜Ÿçš„è‡ªæ—‹é”ã€‚</p><p>åŸºäºæ’é˜Ÿçš„è‡ªæ—‹é”ä»ç„¶ä½¿ç”¨åŸæ¥çš„æ•°æ®ç»“æ„ï¼Œä½† slock åŸŸè¢«æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slock.png"></p><p>owner è¡¨ç¤ºè‡ªæ—‹é”æŒæœ‰è€…çš„ç‰Œå·ï¼Œnext è¡¨ç¤ºå¤–é¢æ’é˜Ÿçš„é˜Ÿåˆ—ä¸­æœ«å°¾è€…çš„ç‰Œå·ã€‚å½“æœ‰çº¿ç¨‹è¦è·å–é”æ—¶ next++ï¼Œå½“æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”æ—¶ owner++ã€‚å½“ owner å’Œ next ç›¸ç­‰æ—¶ï¼Œè¯¥çº¿ç¨‹å°†è·å¾—è‡ªæ—‹é”ã€‚</p><p>è‡ªæ—‹é”çš„åŸå‹å®šä¹‰åœ¨ include/linux/spinlock.h å¤´æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/spin_lock. h&gt;</span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> <span class="title function_">spin_lock</span><span class="params">(<span class="type">spinlock_t</span> *lock)</span></span><br><span class="line">{</span><br><span class="line">raw_spin_lock(&amp;lock-&gt;rlock);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> raw_spin_lock(lock)_raw_spin_lock(lock)</span></span><br><span class="line"><span class="type">void</span> __lockfunc _raw_spin_lock(<span class="type">raw_spinlock_t</span> *lock)</span><br><span class="line">{</span><br><span class="line">__raw_spin_lock(lock);</span><br><span class="line">}</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __raw_spin_lock(<span class="type">raw_spinlock_t</span> *lock)</span><br><span class="line">{</span><br><span class="line">preempt_disable();</span><br><span class="line">spin_acquire(&amp;lock-&gt;dep_map, <span class="number">0</span>, <span class="number">0</span>, _RET_IP_);</span><br><span class="line">LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>spin_locke å‡½æ•°æœ€ç»ˆè°ƒç”¨ __raw_spin_lock() å‡½æ•°æ¥å®ç¾ã€‚é¦–å…ˆå…³é—­å†…æ ¸æŠ¢å ï¼Œè¿™æ˜¯è‡ªæ—‹é”å®ç°çš„å…³é”®ç‚¹ä¹‹ä¸€ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè‡ªæ—‹é”ä¸´ç•ŒåŒºä¸­ä¸å…è®¸å‘ç”ŸæŠ¢å å‘¢ï¼Ÿå¦‚æœè‡ªæ—‹é”ä¸´ç•ŒåŒºä¸­å…è®¸æŠ¢å ï¼Œå‡è®¾åœ¨ä¸´ç•ŒåŒºå†…å‘ç”Ÿä¸­æ–­ï¼Œä¸­æ–­è¿”å›æ—¶ä¼šæ£€æŸ¥æŠ¢å è°ƒåº¦ï¼Œè¿™é‡Œå°†æœ‰ä¸¤ä¸ªé—®é¢˜ã€ä¸€æ˜¯æŠ¢å è°ƒåº¦ä¼šå¯¼è‡´æŒæœ‰é”çš„è¿›ç¨‹ç¡çœ ï¼Œè¿™è¿èƒŒäº†è‡ªæ—‹é”ä¸èƒ½ç¡çœ å’Œå¿«é€Ÿæ‰§è¡Œå®Œæˆçš„è®¾è®¡è¯­ä¹‰ï¼›äºŒæ˜¯æŠ¢å è°ƒåº¦è¿›ç¨‹ä¹Ÿå¯èƒ½ä¼šç”³è¯·è‡ªæ—‹é”ï¼Œè¿™æ ·ä¼šå¯¼è‡´å‘ç”Ÿæ­»é”ã€‚</p><h2 id="è‡ªæ—‹é”çš„å˜ä½“">è‡ªæ—‹é”çš„å˜ä½“</h2><p>åœ¨é©±åŠ¨ä¸­å¾ˆå¤šæ“ä½œéƒ½éœ€è¦è®¿é—®å’Œæ›´æ–°é“¾è¡¨ï¼Œå¦‚ openã€ ioctl ç­‰ï¼Œå› æ­¤æ“ä½œé“¾è¡¨çš„åœ°æ–¹å°±æ˜¯ä¸€ä¸ªä¸´ç•ŒåŒºï¼Œéœ€è¦è‡ªæ—‹é”æ¥ä¿æŠ¤ã€‚è‹¥åœ¨ä¸´ç•ŒåŒºä¸­å‘ç”Ÿäº†å¤–éƒ¨ç¡¬ä»¶ä¸­æ–­ï¼Œç³»ç»Ÿæš‚åœå½“å‰è¿›ç¨‹çš„æ‰§è¡Œè½¬è€Œå¤„ç†è¯¥ä¸­æ–­ã€‚å‡è®¾ä¸­æ–­å¤„ç†ç¨‹åºæ°å·§ä¹Ÿè¦æ“ä½œè¯¥é“¾è¡¨ï¼Œé“¾è¡¨çš„æ“ä½œæ˜¯ä¸€ä¸ªä¸´ç•ŒåŒºï¼Œæ‰€ä»¥åœ¨æ“ä½œä¹‹å‰è¦è°ƒç”¨ spin_lock() å‡½æ•°æ¥å¯¹è¯¥é“¾è¡¨è¿›è¡Œä¿æŠ¤ã€‚ä¸­æ–­å¤„ç†ç¨‹åºè¯•å›¾è·å–è¯¥è‡ªæ—‹é”ï¼Œä½†å› ä¸ºå®ƒå·±ç»è¢«å…¶ä»– CPU æŒæœ‰äº†ï¼Œäºæ˜¯ä¸­æ–­å¤„ç†ç¨‹åºè¿›å…¥å¿™ç­‰å¾…çŠ¶æ€æˆ–è€… wfe ç¡çœ çŠ¶æ€ã€‚åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­å‡ºç°å¿™ç­‰å¾…æˆ–è€…ç¡çœ çŠ¶æ€æ˜¯è‡´å‘½çš„ï¼Œä¸­æ–­å¤„ç†ç¨‹åºè¦æ±‚â€œçŸ­â€å’Œâ€œå¿«â€ï¼Œè‡ªæ—‹é”çš„æŒæœ‰è€…å› ä¸ºè¢«ä¸­æ–­æ‰“æ–­è€Œä¸èƒ½å°½å¿«é‡Šæ”¾é”ï¼Œè€Œä¸­æ–­å¤„ç†ç¨‹åºä¸€ç›´åœ¨å¿™ç­‰å¾…è¯¥é”ï¼Œä»è€Œå¯¼è‡´æ­»é”çš„å‘ç”Ÿã€‚ Linux å†…æ ¸çš„è‡ªæ—‹é”çš„å˜ä½“ spin_lock_irq() å‡½æ•°é€šè¿‡åœ¨è·å–è‡ªæ—‹é”æ—¶å…³é—­æœ¬åœ° CPU ä¸­æ–­ï¼Œå¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> <span class="title function_">spin_lock_irq</span><span class="params">(<span class="type">spinlock_t</span> *lock)</span></span><br><span class="line">{</span><br><span class="line">raw_spin_lock_irq(&amp;lock-&gt;rlock);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> raw_spin_lock_irq(lock)_raw_spin_lock_irq(lock)</span></span><br><span class="line">...</span><br><span class="line"><span class="type">void</span> __lockfunc _raw_spin_lock_irq(<span class="type">raw_spinlock_t</span> *lock)</span><br><span class="line">{</span><br><span class="line">__raw_spin_lock_irq(lock);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __raw_spin_lock_irq(<span class="type">raw_spinlock_t</span> *lock)</span><br><span class="line">{</span><br><span class="line">local_irq_disable();</span><br><span class="line">preempt_disable();</span><br><span class="line">spin_acquire(&amp;lock-&gt;dep_map, <span class="number">0</span>, <span class="number">0</span>, _RET_IP_);</span><br><span class="line">LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>spin_lock_irq() å‡½æ•°çš„å®ç°æ¯” spin_lock() å‡½æ•°å¤šäº†ä¸€ä¸ª local_irq_disable() å‡½æ•°ã€‚local_irq_disable() å‡½æ•°ç”¨äºå…³é—­æœ¬åœ°å¤„ç†å™¨ä¸­æ–­ï¼Œè¿™æ ·åœ¨è·å–è‡ªæ—‹é”æ—¶å¯ä»¥ç¡®ä¿ä¸ä¼šå‘ç”Ÿä¸­æ–­ï¼Œä»è€Œé¿å…å‘ç”Ÿæ­»é”é—®é¢˜ï¼Œå³ local_irq_disable() å‡½æ•°ä¸»è¦é˜²æ­¢æœ¬åœ°ä¸­æ–­å¤„ç†ç¨‹åºå’Œè‡ªæ—‹é”æŒæœ‰è€…ä¹‹é—´äº§ç”Ÿé”çš„äº‰ç”¨ã€‚</p><p>å¯èƒ½æœ‰çš„è¯»è€…ä¼šæœ‰ç–‘é—®ï¼Œæ—¢ç„¶å…³é—­äº†æœ¬åœ° CPU çš„ä¸­æ–­ï¼Œé‚£ä¹ˆåˆ«çš„ CPU ä¾ç„¶å¯ä»¥å“åº”å¤–éƒ¨ä¸­æ–­ï¼Œè¿™ä¼šä¸ä¼šä¹Ÿå¯èƒ½å¯¼è‡´æ­»é”å‘¢ï¼Ÿè‡ªæ—‹é”æŒæœ‰è€…åœ¨ CPUO ä¸Šï¼ŒCPU1 å“åº”äº†å¤–éƒ¨ä¸­æ–­ä¸”ä¸­æ–­å¤„ç†ç¨‹åºåŒæ ·è¯•å›¾å»è·å–è¯¥é”ï¼Œå› ä¸º CPU0 ä¸Šçš„è‡ªæ—‹é”æŒæœ‰è€…ä¹Ÿåœ¨ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒå¾ˆå¿«ä¼šç¦»å¼€ä¸´ç•ŒåŒºå¹¶é‡Šæ”¾é”ï¼Œè¿™æ · CPU1 ä¸Šçš„ä¸­æ–­å¤„ç†ç¨‹åºå¯ä»¥å¾ˆå¿«è·å¾—è¯¥é”ã€‚</p><p>è‡ªæ—‹é”è¿˜æœ‰å¦å¤–ä¸€ä¸ªå¸¸ç”¨çš„å˜ä½“-- spin_lock_bh() å‡½æ•°ï¼Œç”¨äºå¤„ç†è¿›ç¨‹å’Œå»¶è¿Ÿå¤„ç†æœºåˆ¶å¯¼è‡´çš„å¹¶å‘è®¿é—®çš„äº’æ–¥é—®é¢˜ã€‚</p><h2 id="spin_lock-å’Œ-raw_spin_lock-å‡½æ•°">spin_lock() å’Œ raw_spin_lock() å‡½æ•°</h2><p>è¿™è¦ä» Linux å†…æ ¸çš„å®æ—¶è¡¥ä¸ï¼ˆ Rt-patchï¼‰è¯´èµ·ã€‚å®æ—¶è¡¥ä¸æ—¨åœ¨æå‡ Linux å†…æ ¸çš„å®æ—¶æ€§å®ƒå…è®¸åœ¨è‡ªæ—‹é”çš„ä¸´ç•ŒåŒºå†…æŠ¢å é”ï¼Œä¸”åœ¨ä¸´ç•ŒåŒºå†…å…è®¸è¿›ç¨‹ç¡çœ ã€‚è¿™æ ·ä¼šå¯¼è‡´è‡ªæ—‹é”è¯­ä¹‰è¢«ä¿®æ”¹ã€‚å½“æ—¶å†…æ ¸ä¸­å¤§çº¦æœ‰ 10000 å¤„ä½¿ç”¨äº†è‡ªæ—‹é”ï¼Œç›´æ¥ä¿®æ”¹è‡ªæ—‹é”çš„å·¥ä½œé‡å·¨å¤§ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹é‚£äº›çœŸæ­£ä¸å…è®¸æŠ¢å å’Œç¡çœ çš„åœ°æ–¹ï¼Œå¤§æ¦‚æœ‰ 100 å¤„ï¼Œå› æ­¤æ”¹ä¸ºä½¿ç”¨ raw_spin_lock()ã€‚</p><p>spin_lock() å’Œ raw_spin_lock() å‡½æ•°çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ç»å¯¹ä¸å…è®¸æŠ¢å å’Œç¡çœ çš„ä¸´ç•ŒåŒºï¼Œåº”è¯¥ä½¿ç”¨ raw_spin_lock() å‡½æ•°ï¼Œå¦åˆ™ä½¿ç”¨ spin_lock()ã€‚</li><li>å¯¹äºæ²¡æœ‰æ›´æ–°å®æ—¶è¡¥ä¸çš„ Linux å†…æ ¸æ¥è¯´ï¼Œspin_lock() å‡½æ•°å¯ä»¥ç›´æ¥è°ƒç”¨ raw_spin_lock()ï¼Œå¯¹äºæ›´æ–°å®æ—¶è¡¥ä¸çš„ Linux å†…æ ¸æ¥è¯´ï¼Œ spin_lock() ä¼šå˜æˆå¯æŠ¢å å’Œç¡çœ çš„é”ï¼Œè¿™éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</li></ul><h2 id="æ•ˆç‡">æ•ˆç‡</h2><p>æ ¹æ®ç¡¬ä»¶ç»´æŠ¤çš„ cache ä¸€è‡´æ€§åè®®ï¼Œå¦‚æœ spinlock çš„å€¼æ²¡æœ‰æ›´æ”¹ï¼Œé‚£ä¹ˆåœ¨ busy wait æ—¶ï¼Œè¯•å›¾è·å– spinlock çš„ CPUï¼Œåªéœ€è¦ä¸æ–­åœ°è¯»å–è‡ªå·±åŒ…å«è¿™ä¸ª spinlock å˜é‡çš„ cache line ä¸Šçš„å€¼å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦ä» spinlock å˜é‡æ‰€åœ¨çš„å†…å­˜ä½ç½®è¯»å–ã€‚</p><p>ä½†æ˜¯ï¼Œå½“ spinlock çš„å€¼è¢«æ›´æ”¹æ—¶ï¼Œæ‰€æœ‰è¯•å›¾è·å– spinlock çš„ CPU å¯¹åº”çš„ cache line éƒ½ä¼šè¢« invalidateï¼Œå› ä¸ºè¿™äº› CPU ä¼šä¸åœåœ°è¯»å–è¿™ä¸ª spinlock çš„å€¼ï¼Œæ‰€ä»¥"invalidate"çŠ¶æ€æ„å‘³ç€æ­¤æ—¶ï¼Œå®ƒä»¬å¿…é¡»é‡æ–°ä»å†…å­˜è¯»å–æ–°çš„ spinlock çš„å€¼åˆ°è‡ªå·±çš„ cache line ä¸­ã€‚</p><p>è€Œäº‹å®ä¸Šï¼Œå…¶ä¸­åªä¼šæœ‰ä¸€ä¸ª CPUï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—ä¸­æœ€å…ˆè¾¾åˆ°çš„é‚£ä¸ª CPUï¼Œæ¥ä¸‹æ¥å¯ä»¥è·å¾— spinlockï¼Œä¹Ÿåªæœ‰å®ƒçš„ cache line è¢« invalidate æ‰æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå¯¹äºå…¶ä»–çš„ CPU æ¥è¯´ï¼Œè¿™å°±æ˜¯åšæ— ç”¨åŠŸã€‚å†…å­˜æ¯” cache æ…¢é‚£ä¹ˆå¤šï¼Œå¼€é”€å¯ä¸å°ã€‚</p><h1 id="mcs-é”">MCS é”</h1><p>å‡è®¾åœ¨ä¸€ä¸ªé”äº‰ç”¨æ¿€çƒˆçš„ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰ç­‰å¾…è‡ªæ—‹é”çš„çº¿ç¨‹éƒ½åœ¨åŒä¸€ä¸ªå…±äº«å˜é‡ä¸Šè‡ªæ—‹ï¼Œç”³è¯·å’Œé‡Šæ”¾é”éƒ½åœ¨åŒä¸€ä¸ªå˜é‡ä¸Šä¿®æ”¹ï¼Œé«˜é€Ÿå†…å­˜ä¸€è‡´æ€§åŸç†ï¼ˆå¦‚ MESI åè®®ï¼‰å¯¼è‡´å‚ä¸è‡ªæ—‹çš„ CPU ä¸­çš„é«˜é€Ÿç¼“å­˜è¡Œå˜å¾—æ— æ•ˆã€‚åœ¨é”äº‰ç”¨çš„æ¿€çƒˆè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¼è‡´ä¸¥é‡çš„ CPU é«˜é€Ÿç¼“å­˜è¡Œé¢ ç°¸ç°è±¡ï¼ˆ CPU cacheline bouncingï¼‰ï¼Œå³å¤šä¸ª CPU ä¸Šçš„é«˜é€Ÿç¼“å­˜è¡Œåå¤å¤±æ•ˆï¼Œå¤§å¤§é™ä½ç³»ç»Ÿæ•´ä½“æ€§èƒ½ã€‚</p><blockquote><p>MCS ç®—æ³•å¯ä»¥è§£å†³è‡ªæ—‹é”é‡åˆ°çš„é—®é¢˜ï¼Œæ˜¾è‘—ç¼“è§£ CPU é«˜é€Ÿç¼“å­˜è¡Œé¢ ç°¸é—®é¢˜ã€‚</p></blockquote><p>MCS ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯æ¯ä¸ªé”çš„ç”³è¯·è€…åªåœ¨æœ¬åœ° CPU çš„å˜é‡ä¸Šè‡ªæ—‹ï¼Œè€Œä¸æ˜¯å…¨å±€çš„å˜é‡ä¸Šï¼Œå¤§å¤§é™ä½é”çš„äº‰ç”¨ã€‚</p><h1 id="osq-é”">OSQ é”</h1><p>æ—©æœŸ MCS ç®—æ³•çš„å®ç°éœ€è¦æ¯”è¾ƒå¤§çš„æ•°æ®ç»“æ„ï¼Œåœ¨ Linux4.2 å†…æ ¸ä¸­å¼•è¿›äº†åŸºäº MCS ç®—æ³•çš„æ’é˜Ÿè‡ªæ—‹é”ï¼ˆOne Spinlock, Qspinlockï¼‰OSQ é”çš„å®ç°éœ€è¦ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/osq_lock.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * An MCS like lock especially tailored for optimistic spinning for sleeping</span></span><br><span class="line"><span class="comment"> * lock implementations (mutex, rwsem, etc).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_node</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_node</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line"><span class="type">int</span> locked; <span class="comment">/* 1 if lock acquired */</span></span><br><span class="line"><span class="type">int</span> cpu; <span class="comment">/* encoded CPU # + 1 value */</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_queue</span> {</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Stores an encoded value of the CPU # of the tail node in the queue.</span></span><br><span class="line"><span class="comment"> * If the queue is empty, then it's set to OSQ_UNLOCKED_VAL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">atomic_t</span> tail;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ¯ä¸ª MCS é”æœ‰ä¸€ä¸ª optimistic_spin_queue æ•°æ®ç»“æ„ï¼Œè¯¥æ•°æ®ç»“æ„åªæœ‰ä¸€ä¸ªæˆå‘˜ tail, åˆå§‹åŒ–ä¸º 0ã€‚ optimistic_spin_node æ•°æ®ç»“æ„è¡¨ç¤ºæœ¬åœ° CPU ä¸Šçš„èŠ‚ç‚¹ï¼Œå®ƒå¯ä»¥ç»„ç»‡æˆä¸€ä¸ªåŒå‘é“¾è¡¨åŒ…å« next å’Œ prev æŒ‡é’ˆï¼Œ locked æˆå‘˜ç”¨äºè¡¨ç¤ºåŠ é”çŠ¶æ€ï¼Œcpu æˆå‘˜ç”¨äºé‡æ–°ç¼–ç  CPU ç¼–å·ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹åœ¨å“ªä¸ª CPU ä¸Šã€‚ optimistic_spin_node æ•°æ®ç»“æ„ä¼šå®šä¹‰æˆ per-CPU å˜é‡ï¼Œå³æ¯ä¸ª CPU æœ‰ä¸€ä¸ªèŠ‚ç‚¹ç»“æ„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/locking/osq_lock.c&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * An MCS like lock especially tailored for optimistic spinning for sleeping</span></span><br><span class="line"><span class="comment"> * lock implementations (mutex, rwsem, etc).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Using a single mcs node per CPU is safe because sleeping locks should not be</span></span><br><span class="line"><span class="comment"> * called from interrupt context and we have preemption disabled while</span></span><br><span class="line"><span class="comment"> * spinning.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU_SHARED_ALIGNED</span><span class="params">(<span class="keyword">struct</span> optimistic_spin_node, osq_node)</span>;</span><br></pre></td></tr></tbody></table></figure><p>MCS é”åœ¨ osq_lock_init() å‡½æ•°ä¸­åˆå§‹åŒ–ã€‚å¦‚äº’æ–¥é”ä¼šåˆå§‹åŒ–ä¸ºä¸€ä¸ª MCS é”ï¼Œå› ä¸º __mutex_init() å‡½æ•°ä¼šè°ƒç”¨ osq_lock_init() å‡½æ•°</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/locking/mutex.c&gt;</span><br><span class="line"><span class="type">void</span></span><br><span class="line">__mutex_init(<span class="keyword">struct</span> mutex *lock, <span class="type">const</span> <span class="type">char</span> *name, <span class="keyword">struct</span> lock_class_key *key)</span><br><span class="line">{</span><br><span class="line">atomic_long_set(&amp;lock-&gt;owner, <span class="number">0</span>);</span><br><span class="line">raw_spin_lock_init(&amp;lock-&gt;wait_lock);</span><br><span class="line">INIT_LIST_HEAD(&amp;lock-&gt;wait_list);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MUTEX_SPIN_ON_OWNER</span></span><br><span class="line">osq_lock_init(&amp;lock-&gt;osq);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">debug_mutex_init(lock, name, key);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(__mutex_init);</span><br></pre></td></tr></tbody></table></figure><p>OSQ è‡ªæ—‹é”çš„ç‰¹ç‚¹ï¼š</p><ul><li>é›†æˆ MCS ç®—æ³•åˆ°è‡ªæ—‹é”ä¸­ï¼Œç»§æ‰¿äº† MCS ç®—æ³•çš„æ‰€æœ‰ä¼˜ç‚¹ï¼Œæœ‰æ•ˆè§£å†³äº† CPU é«˜é€Ÿç¼“å­˜è¡Œé¢ ç°¸é—®é¢˜ã€‚</li><li>æ²¡æœ‰å¢åŠ  spinlock æ•°æ®ç»“æ„çš„å¤§å°ï¼ŒæŠŠ val ç»†åˆ†æˆå¤šä¸ªåŸŸï¼Œå®Œç¾å®ç°äº† MCS ç®—æ³•ã€‚</li><li>å½“åªæœ‰ä¸¤ä¸ª CPU è¯•å›¾è·å–è‡ªæ—‹é”æ—¶ï¼Œä½¿ç”¨ pending åŸŸå°±å¯ä»¥å®Œç¾è§£å†³é—®é¢˜ï¼Œç¬¬ 2CPU åªéœ€è¦è®¾ç½® pending åŸŸï¼Œç„¶åè‡ªæ—‹ç­‰å¾…é”é‡Šæ”¾ã€‚å½“æœ‰ç¬¬ 3 ä¸ªæˆ–è€…æ›´å¤š CPU æ¥äº‰ç”¨æ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨é¢å¤–çš„ MCS èŠ‚ç‚¹ã€‚ç¬¬ 3 ä¸ª CPU ä¼šè‡ªæ—‹ç­‰å¾…é”è¢«é‡Šæ”¾ï¼Œå³ pending åŸŸå’Œ locked åŸŸè¢«æ¸…é›¶ï¼Œè€Œç¬¬ 4 ä¸ª CPU å’Œåé¢çš„ CPU åªèƒ½åœ¨ MCS èŠ‚ç‚¹ä¸­è‡ªæ—‹ç­‰å¾… locked åŸŸè¢«ç½® 1ï¼Œç›´åˆ°å‰ç»§èŠ‚ç‚¹æŠŠ locked æ§åˆ¶å™¨è¿‡ç»§ç»™è‡ªå·±æ‰èƒ½æœ‰æœºä¼šè‡ªæ—‹ç­‰å¾…è‡ªæ—‹é”çš„é‡Šæ”¾ï¼Œä»è€Œå®Œç¾è§£å†³æ¿€çƒˆé”äº‰ç”¨å¸¦æ¥çš„é«˜é€Ÿç¼“å­˜è¡Œé¢ ç°¸é—®é¢˜ 16 ä¿¡å·é‡ã€‚</li><li>è§£å†³ MCS é”å å†…å­˜å¤§çš„é—®é¢˜ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84MDcyNzExMQ==">https://zhuanlan.zhihu.com/p/80727111<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84OTA1ODcyNg==">https://zhuanlan.zhihu.com/p/89058726<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDA1NDY5MzU=">https://zhuanlan.zhihu.com/p/100546935<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Sync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆåäºŒï¼‰å†…å­˜è°ƒä¼˜</title>
      <link href="/2021/LinuxKernel/LinuxMemoryOptimization/"/>
      <url>/2021/LinuxKernel/LinuxMemoryOptimization/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryOptimization.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM4OTk5NWU0MDFmZDA3MGJiNzI0OGI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å†…å­˜ç®¡ç†è°ƒä¼˜å‚æ•°">å†…å­˜ç®¡ç†è°ƒä¼˜å‚æ•°</h1><p>å¯¹æœåŠ¡å™¨æˆ–è€…åµŒå…¥å¼äº§å“åšæ€§èƒ½è°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œé¿å…ä¸äº†éœ€è¦æ·±å…¥äº†è§£å’Œä½¿ç”¨ Linux å†…å†…å­˜ç®¡ç†æ¨¡å—æä¾›çš„è°ƒä¼˜å‚æ•°ã€‚Linux å†…æ ¸æ”¯æŒçš„å†…å­˜ç®¡ç†è°ƒä¼˜å‚æ•°éƒ½åœ¨/proc/sys/vm ç›®å½•ä¸‹é¢ï¼Œå…±æœ‰ 40 å¤šä¸ªè°ƒä¼˜å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/proc/sys/vm<span class="comment"># ls</span></span><br><span class="line">admin_reserve_kbytes         dirty_ratio                lowmem_reserve_ratio       mmap_rnd_bits            oom_kill_allocating_task  stat_refresh</span><br><span class="line">block_dump                   dirtytime_expire_seconds   max_map_count              mmap_rnd_compat_bits     overcommit_kbytes         swappiness</span><br><span class="line">compact_memory               dirty_writeback_centisecs  memory_failure_early_kill  nr_hugepages             overcommit_memory         unprivileged_userfaultfd</span><br><span class="line">compact_unevictable_allowed  drop_caches                memory_failure_recovery    nr_hugepages_mempolicy   overcommit_ratio          user_reserve_kbytes</span><br><span class="line">dirty_background_bytes       extfrag_threshold          min_free_kbytes            nr_overcommit_hugepages  page-cluster              vfs_cache_pressure</span><br><span class="line">dirty_background_ratio       hugetlb_shm_group          min_slab_ratio             numa_stat                panic_on_oom              watermark_boost_factor</span><br><span class="line">dirty_bytes                  laptop_mode                min_unmapped_ratio         numa_zonelist_order      percpu_pagelist_fraction  watermark_scale_factor</span><br><span class="line">dirty_expire_centisecs       legacy_va_layout           mmap_min_addr              oom_dump_tasks           stat_interval             zone_reclaim_mode</span><br></pre></td></tr></tbody></table></figure><p>å†…å­˜ç®¡ç†çš„è°ƒä¼˜å‚æ•°å®šä¹‰åœ¨ kerne.c æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ proc æ–‡ä»¶ç³»ç»Ÿæœºåˆ¶æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ctl_table</span> <span class="title">vm_table</span>[] =</span> {</span><br><span class="line">{</span><br><span class="line">.procname= <span class="string">"overcommit_memory"</span>,</span><br><span class="line">.data= &amp;sysctl_overcommit_memory,</span><br><span class="line">.maxlen= <span class="keyword">sizeof</span>(sysctl_overcommit_memory),</span><br><span class="line">.mode= <span class="number">0644</span>,</span><br><span class="line">.proc_handler= overcommit_policy_handler,</span><br><span class="line">.extra1= SYSCTL_ZERO,</span><br><span class="line">.extra2= &amp;two,</span><br><span class="line">},</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>procnameï¼šè¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹çš„åç§°ï¼Œæ˜¾ç¤ºåœ¨ proc/sys/vm ç›®å½•ä¸‹é¢</li><li>dataï¼šä¼ é€’çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯æŸä¸ªå…¨å±€å˜é‡ï¼Œå¦‚ sysctl_overcommit_memory</li><li>maxlenï¼šå‚æ•° data çš„é•¿åº¦ã€‚</li><li>mode èŠ‚ç‚¹çš„æ–‡ä»¶æƒé™ã€‚0644 è¡¨ç¤ºç”¨æˆ·å…·æœ‰è¯»å†™æƒé™ï¼Œç»„ç”¨æˆ·å’Œå…¶ä»–ç”¨æˆ·å…·æœ‰åªè¯»æƒ</li><li>proc_handlerï¼šè¯¥èŠ‚ç‚¹åœ¨å†…æ ¸ä¸­çš„å›è°ƒå‡½æ•°</li><li>extralï¼šè¡¨ç¤ºè¿™ä¸ªå‚æ•°çš„æœ€å°å€¼</li><li>exra2ï¼šè¡¨ç¤ºè¿™ä¸ªå‚æ•°çš„æœ€å¤§å€¼ï¼Œå¦‚ã€‚ overcommit_memory è°ƒä¼˜å‚æ•°çš„æœ€å¤§å€¼ä¸º 2ï¼Œæœ€å°å€¼ä¸º 0</li></ul><h2 id="å½±å“å†…å­˜ç®¡ç†åŒºæ°´ä½çš„è°ƒä¼˜å‚æ•°-min_free_kbytes">å½±å“å†…å­˜ç®¡ç†åŒºæ°´ä½çš„è°ƒä¼˜å‚æ•° min_free_kbytes</h2><p>Linux å†…æ ¸ä¸ºäº†é˜²æ­¢å†…å­˜è¢«æ¶æ„è¿›ç¨‹å ç”¨ï¼Œåœ¨æ¯ä¸ªå†…å­˜ç®¡ç†åŒºè®¾ç½®äº†ä¸€éƒ¨åˆ†é¢„ç•™å†…å­˜ï¼Œå³æœ€ä½è­¦æˆ’æ°´ä½ï¼ˆwatermark[WMARK_MIN]ï¼‰ã€‚è¿›ç¨‹åˆ†é…å†…å­˜çš„è¡Œä¸ºæ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œå¯¹äºæ™®é€šä¼˜å…ˆçº§çš„åˆ†é…è¡Œä¸ºï¼Œæ˜¯ä¸èƒ½è®¿é—®é¢„ç•™å†…å­˜çš„ï¼Œåªæœ‰å¯¹äºé«˜ä¼˜å…ˆçº§çš„åˆ†é…è¡Œä¸ºï¼Œæ‰èƒ½è®¿é—®ï¼Œå¦‚é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹å¯ä»¥é€šè¿‡è®¾ç½® __GFP_HIGHã€__GFP_ATOMIC ç”šè‡³ __GFP_MEMALLOC æ¥è®¿é—®é¢„ç•™å†…å­˜ã€‚è‹¥ç³»ç»Ÿé¢„ç•™å†…å­˜å°äº 1024KBï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå‡ºé—®é¢˜ï¼Œå…·æœ‰é«˜ä¼˜å…ˆçº§åˆ†é…è¡Œä¸ºçš„è¿›ç¨‹æ²¡åŠæ³•å¾—åˆ°å†…å­˜ã€‚ ç³»ç»Ÿåˆå§‹åŒ–æ—¶é€šè¿‡ init_per_zone_wmark_min() å‡½æ•°æ¥è®¡ç®— min_free_kbytes çš„å¤§å°ï¼Œç„¶åè®¡ç®—æ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„æ°´ä½ã€‚ min_free_kbytes çš„è®¡ç®—å…¬å¼å¦‚ä¸‹</p><pre><code>min_free_bytes = 4 sqrt(lowmem_kbytes)</code></pre><p>lommen_kbytes æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰å†…å­˜ç®¡ç†åŒºçš„ç®¡ç†é¡µé¢æ•°é‡å‡å»é«˜æ°´ä½é¡µé¢æ•°é‡ï¼ˆ managed_pages - high_pagesï¼‰çš„æ€»å’Œã€‚æœ€åè®¡ç®—å‡ºæ¥çš„ min_free_kbytes æœ‰èŒƒå›´é™åˆ¶ï¼Œæœ€å°å€¼ä¸º 128KB, æœ€å¤§å€¼ä¸º 64MB. min_free_kbytes çš„å€¼ä¼šå½±å“æ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„æ°´ä½ï¼Œå®ƒæ˜¯åœ¨ __setup_per_zone_marks() å‡½æ•°ä¸­è®¾ç½®çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __setup_per_zone_wmarks(<span class="type">void</span>)</span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pages_min = min_free_kbytes &gt;&gt; (PAGE_SHIFT - <span class="number">10</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> lowmem_pages = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">for_each_zone(zone) {</span><br><span class="line"><span class="keyword">if</span> (!is_highmem(zone))</span><br><span class="line">lowmem_pages += zone_managed_pages(zone);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">for_each_zone(zone) {</span><br><span class="line">u64 tmp;</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line">tmp = (u64)pages_min * zone_managed_pages(zone);</span><br><span class="line">do_div(tmp, lowmem_pages);</span><br><span class="line"><span class="keyword">if</span> (is_highmem(zone)) {</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> min_pages;</span><br><span class="line"></span><br><span class="line">min_pages = zone_managed_pages(zone) / <span class="number">1024</span>;</span><br><span class="line">min_pages = clamp(min_pages, SWAP_CLUSTER_MAX, <span class="number">128UL</span>);</span><br><span class="line">zone-&gt;_watermark[WMARK_MIN] = min_pages;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">zone-&gt;_watermark[WMARK_MIN] = tmp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">tmp = <span class="type">max_t</span>(u64, tmp &gt;&gt; <span class="number">2</span>,</span><br><span class="line">    mult_frac(zone_managed_pages(zone),</span><br><span class="line">      watermark_scale_factor, <span class="number">10000</span>));</span><br><span class="line"></span><br><span class="line">zone-&gt;watermark_boost = <span class="number">0</span>;</span><br><span class="line">zone-&gt;_watermark[WMARK_LOW]  = min_wmark_pages(zone) + tmp;</span><br><span class="line">zone-&gt;_watermark[WMARK_HIGH] = min_wmark_pages(zone) + tmp * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* update totalreserve_pages */</span></span><br><span class="line">calculate_totalreserve_pages();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å†…å­˜ç®¡ç†åŒºçš„ 3 ä¸ªæ°´ä½çš„è®¡ç®—éƒ½å’Œ min_free_kbytes æœ‰å…³ã€‚å½“ç³»ç»Ÿåªæœ‰ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºæ—¶æœ€ä½è­¦æˆ’æ°´ä½ï¼ˆwatermark[WMARK_MIN]ï¼‰ç­‰äº min_free_kbytes ä½æ°´ä½ã€é«˜æ°´ä½ä¸ watermark_scale_factor å‚æ•°ã€å†…å­˜ç®¡ç†åŒºç®¡ç†çš„å†…å­˜å¤§å°ï¼ˆ managed_pagesï¼‰æœ‰å…³ã€‚ watermark_boost è¡¨ç¤ºä¸´æ—¶æé«˜çš„æ°´ä½ï¼ˆå®ƒæ˜¯åœ¨ Linux5.0 å†…æ ¸ä¸­å¼•å…¥çš„ï¼‰ã€‚ è¯»è€…å¯ä»¥é€šè¿‡æŸ¥çœ‹ proc/zoneinfo èŠ‚ç‚¹æ¥è·å–æ¯ä¸ªå†…å­˜ç®¡ç†åŒºæ°´ä½çš„å€¼ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~/workspace/blog$ <span class="built_in">cat</span> /proc/zoneinfo</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  per-node stats</span><br><span class="line">      nr_inactive_anon 161</span><br><span class="line">      nr_active_anon 376283</span><br><span class="line">      nr_inactive_file 1510629</span><br><span class="line">      nr_active_file 1654655</span><br><span class="line">      nr_unevictable 0</span><br><span class="line">      nr_slab_reclaimable 206993</span><br><span class="line">      nr_slab_unreclaimable 106507</span><br><span class="line">      nr_isolated_anon 0</span><br><span class="line">      nr_isolated_file 0</span><br><span class="line">      workingset_nodes 0</span><br><span class="line">      workingset_refault 0</span><br><span class="line">      workingset_activate 0</span><br><span class="line">      workingset_restore 0</span><br><span class="line">      workingset_nodereclaim 0</span><br><span class="line">      nr_anon_pages 377602</span><br><span class="line">      nr_mapped    54793</span><br><span class="line">      nr_file_pages 3164200</span><br><span class="line">      nr_dirty     0</span><br><span class="line">      nr_writeback 0</span><br><span class="line">      nr_writeback_temp 0</span><br><span class="line">      nr_shmem     1299</span><br><span class="line">      nr_shmem_hugepages 0</span><br><span class="line">      nr_shmem_pmdmapped 0</span><br><span class="line">      nr_file_hugepages 0</span><br><span class="line">      nr_file_pmdmapped 0</span><br><span class="line">      nr_anon_transparent_hugepages 0</span><br><span class="line">      nr_unstable  0</span><br><span class="line">      nr_vmscan_write 0</span><br><span class="line">      nr_vmscan_immediate_reclaim 0</span><br><span class="line">      nr_dirtied   6882886</span><br><span class="line">      nr_written   6439960</span><br><span class="line">      nr_kernel_misc_reclaimable 0</span><br></pre></td></tr></tbody></table></figure><p>åœ¨å®é™…å†…å­˜è°ƒä¼˜è¿‡ç¨‹ä¸­ï¼Œè®¾ç½® min_free_kbytes å€¼è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰ç›¸åº”çš„å‰¯ä½œç”¨ã€‚è‹¥ min_free_kbytes å€¼è¿‡å¤§ï¼Œä¼šå½±å“å†…å­˜ç®¡ç†åŒºçš„ 3 ä¸ªæ°´ä½ï¼Œå› æ­¤æŠŠè¯¥å€¼è®¾ç½®è¿‡å¤§ï¼Œç›¸å½“äºæé«˜äº†ä½æ°´ä½ã€‚è‹¥é¡µé¢åˆ†é…å™¨åœ¨ä½æ°´ä½æƒ…å†µä¸‹åˆ†é…å¤±è´¥ï¼Œåˆ™å”¤é†’ kswapd å†…æ ¸çº¿ç¨‹å¼‚æ­¥æ‰«æ LRU é“¾è¡¨å’Œå›æ”¶å†…å­˜ã€‚è¿™ç›¸å½“äºæå‰å”¤é†’äº† kswapd å†…æ ¸çº¿ç¨‹ã€‚å¦å¤–ï¼Œç•™ç»™æ™®é€šä¼˜å…ˆçº§åˆ†é…è¯·æ±‚çš„å†…å­˜å°±å°‘äº†ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´è¿›ç¨‹æå‰ä½¿ç”¨ OOM Killer æœºåˆ¶ã€‚ä½†æ˜¯å‡¡äº‹éƒ½ä¸èƒ½å¤ªç»å¯¹ï¼Œå½“ç³»ç»Ÿå‘ç°æœ‰å¤–ç¢ç‰‡åŒ–ç°è±¡å‘ç”Ÿæ—¶ï¼Œä¸´æ—¶æé«˜æ°´ä½å¹¶ä¸”æå‰å”¤é†’ kswapd å†…æ ¸çº¿ç¨‹ï¼Œåè€Œå¯ä»¥ç¼“è§£å¤–ç‰‡åŒ–çš„è¿›ä¸€æ­¥æ¶åŒ–ï¼Œè¿™æ˜¯ Linux5.0 å†…æ ¸æ–°å¢çš„ä¼˜åŒ–ç‰¹æ€§ã€‚</p><p>è‹¥ min_free_kbytes å€¼è¿‡å°ï¼Œå†…å­˜ç®¡ç†åŒºä¸­é¢„ç•™çš„å†…å­˜å°±è¶Šå°‘ï¼Œè¿™æ ·å¯¼è‡´ç³»ç»Ÿæœ‰ä¸€äº›é«˜ä¼˜å…ˆçº§åˆ†é…è¡Œä¸ºçš„è¿›ç¨‹ï¼ˆæˆ–å†…æ ¸è·¯å¾„ï¼‰åœ¨ç‰¹åˆ«ç´§æ€¥æƒ…å†µä¸‹åˆ†é…å†…å­˜å¤±è´¥ã€‚è‹¥è®¿å‘é¢„ç•™å†…å­˜ä¹Ÿå¤±é‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè¿›å…¥æ­»é”çŠ¶æ€ï¼Œå¦‚ kswapd å†…æ ¸çº¿ç¨‹ç­‰é€šè¿‡æ²¡ç½® PF_MEMALLOC æ ‡å¿—ä½æ¥å‘Šè¯‰é¡µé¢åˆ†é…å™¨ï¼Œå®ƒä»¬åœ¨ç´§æ€¥æƒ…å†µä¸‹è®¿é—´å°‘é‡çš„ç³»ç»Ÿé¢„ç•™å†…å­˜ä»¥ä¿è¯ç¨‹åºçš„æ­£ç¡®è¿è¡Œã€‚</p><h2 id="å½±å“é¡µé¢åˆ†é…çš„å‚æ•°-lowmem_reserve_ratio">å½±å“é¡µé¢åˆ†é…çš„å‚æ•° lowmem_reserve_ratio</h2><p>Linux å†…æ ¸æŠŠå†…å­˜èŠ‚ç‚¹åˆ†æˆäº†å¤šä¸ªå†…å­˜ç®¡ç†åŒºï¼Œä½äºä½åœ°å€çš„ç§°ä¸ºä½ç«¯å†…å­˜ç®¡ç†åŒºï¼Œä½äºé«˜åœ°å€çš„ç§°ä¸ºé«˜ç«¯å†…å­˜ç®¡ç†åŒºã€‚åœ¨ä¸€ä¸ª x86_64 è®¡ç®—æœºä¸Šï¼Œé€šå¸¸åˆ†æˆå¦‚ä¸‹å‡ ä¸ªå†…å­˜ç®¡ç†åŒº</p><ul><li>ZONE_DMA</li><li>ZONE_DMA32</li><li>ZONE_NORMAL</li><li>ZONE_MOVAR</li><li>ONE_DEVICBLE</li></ul><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹/proc/zoneinfo èŠ‚ç‚¹æ¥è·å–æ¯ä¸ªå†…å­˜ç®¡ç†åŒºä¸­çš„ä¸€äº›é‡è¦å‚æ•°ï¼Œå¦‚å†…å­˜ç®¡ç†åŒºçš„ç©ºé—²å†…å­˜ã€æœ€ä½è­¦æˆ’æ°´ä½ã€ä½æ°´ä½ã€é«˜æ°´ä½ã€ç®¡ç†é¡µé¢æ•°é‡ç­‰ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pages free     3971</span><br><span class="line">      min      8</span><br><span class="line">      low      11</span><br><span class="line">      high     14</span><br><span class="line">      spanned  4095</span><br><span class="line">      present  3999</span><br><span class="line">      managed  3971</span><br><span class="line">      protection: (0, 1776, 31892, 31892, 31892)</span><br></pre></td></tr></tbody></table></figure><p>ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°å°±æ˜¯ protectionï¼Œå®ƒè¯»å–å†…å­˜ç®¡ç†åŒºä¸­ lowmem_reserve[] æ•°ç»„çš„å€¼ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/mmzone h&gt;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> {</span></span><br><span class="line"><span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* zone watermarks, access with *_wmark_pages(zone) macros */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> _watermark[NR_WMARK];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> watermark_boost;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We don't know if the memory that we're going to allocate will be</span></span><br><span class="line"><span class="comment"> * freeable or/and it will be released eventually, so to avoid totally</span></span><br><span class="line"><span class="comment"> * wasting several GB of ram we must reserve some of the lower zone</span></span><br><span class="line"><span class="comment"> * memory (otherwise we risk to run OOM on the lower zones despite</span></span><br><span class="line"><span class="comment"> * there being tons of freeable ram on the higher zones).  This array is</span></span><br><span class="line"><span class="comment"> * recalculated at runtime if the sysctl_lowmem_reserve_ratio sysctl</span></span><br><span class="line"><span class="comment"> * changes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> lowmem_reserve[MAX_NR_ZONES];</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>lowmem_reserve[] æ•°ç»„çš„å•ä½æ˜¯é¡µé¢ï¼Œè®¾ç½® lowmem_reserve[] æ•°ç»„æ˜¯ä¸ºäº†é˜²æ­¢é¡µé¢åˆ†é…å™¨è¿‡åº¦åœ°ä»ä½ç«¯å†…å­˜ç®¡ç†åŒºä¸­åˆ†é…å†…å­˜ï¼Œå› ä¸ºä½ç«¯å†…å­˜ç®¡ç†åŒºçš„å†…å­˜ä¸€èˆ¬æ˜¯æœ‰ç‰¹æ®Šç”¨é€”çš„ï¼Œå¦‚ ZONE_DMA ç”¨äº ISA æ€»çº¿çš„è®¾å¤‡ã€‚é€šå¸¸æœ‰äº›åº”ç”¨ç¨‹åºåˆ†é…å†…å­˜ä¹‹åä¼šä½¿ç”¨ mlock() æ¥é”ä½è¿™éƒ½åˆ†å†…å­˜ï¼Œå› æ­¤è¿™äº›å†…å­˜å°±ä¸èƒ½è¢«äº¤æ¢åˆ°äº¤æ¢åˆ†åŒºï¼Œä»è€Œå¯¼è‡´ ZONE_DMA å˜å°‘äº†ã€‚å¦å¤–ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡æ—©åœ¨ä½ç«¯å†…å­˜ç®¡ç†åŒºä¸­è§¦å‘ OOM Killer æœºåˆ¶ï¼Œè€Œç³»ç»Ÿçš„é«˜ç«¯å†…å­˜ç®¡ç†åŒºå´æœ‰å¤§é‡ç©ºå†…å­˜ã€‚å› æ­¤ï¼Œ Linux å†…æ ¸è®¾ç½® lowmem_reserve[] æ•°ç»„ä¸ºäº†é˜²æ­¢è¿›ç¨‹è¿‡åº¦ä½¿ç”¨ä½ç«¯å†…å­˜ç®¡ç†åŒºçš„å†…å­˜ã€‚ é‚£ Linux å†…æ ¸æ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ•°ç»„å‘¢ï¼Ÿ ä» /proc/zoneinfo èŠ‚ç‚¹å¯ä»¥çœ‹åˆ°ï¼ŒZONE_DMA çš„ lowmem_reserve[] æ•°ç»„å€¼è¦æ¯” ZONE_DMA32 çš„å¤§ã€‚å¦å¤–ï¼Œ ZONE_NORMAL çš„ lowmem_reserve[] æ•°ç»„å…ƒç´ å…¨æ˜¯ 0ï¼Œè¿™è¯´æ˜ä¸éœ€è¦åšé¢å¤–ä¿æŠ¤ã€‚ åˆ¤æ–­ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºæ˜¯å¦æ»¡è¶³è¿™æ¬¡åˆ†é…ä»»åŠ¡çš„å‡½æ•°æ˜¯__zone_watermark_ok()ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/page_alloc.c&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Return true if free base pages are above 'mark'. For high-order checks it</span></span><br><span class="line"><span class="comment"> * will return true of the order-0 watermark is reached and there is at least</span></span><br><span class="line"><span class="comment"> * one free page of a suitable size. Checking now avoids taking the zone lock</span></span><br><span class="line"><span class="comment"> * to check in the allocation paths if no pages are free.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> __zone_watermark_ok(<span class="keyword">struct</span> zone *z, <span class="type">unsigned</span> <span class="type">int</span> order, <span class="type">unsigned</span> <span class="type">long</span> mark,</span><br><span class="line"> <span class="type">int</span> highest_zoneidx, <span class="type">unsigned</span> <span class="type">int</span> alloc_flags,</span><br><span class="line"> <span class="type">long</span> free_pages)</span><br><span class="line">{</span><br><span class="line"><span class="type">long</span> min = mark;</span><br><span class="line"><span class="type">int</span> o;</span><br><span class="line"><span class="type">const</span> <span class="type">bool</span> alloc_harder = (alloc_flags &amp; (ALLOC_HARDER|ALLOC_OOM));</span><br><span class="line"></span><br><span class="line">free_pages -= __zone_watermark_unusable_free(z, order, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_HIGH)</span><br><span class="line">min -= min / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(alloc_harder)) {</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_OOM)</span><br><span class="line">min -= min / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">min -= min / <span class="number">4</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (free_pages &lt;= min + z-&gt;lowmem_reserve[highest_zoneidx])</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If this is an order-0 request then the watermark is fine */</span></span><br><span class="line"><span class="keyword">if</span> (!order)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (o = order; o &lt; MAX_ORDER; o++) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> *<span class="title">area</span> =</span> &amp;z-&gt;free_area[o];</span><br><span class="line"><span class="type">int</span> mt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!area-&gt;nr_free)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (mt = <span class="number">0</span>; mt &lt; MIGRATE_PCPTYPES; mt++) {</span><br><span class="line"><span class="keyword">if</span> (!free_area_empty(area, mt))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alloc_harder &amp;&amp; !free_area_empty(area, MIGRATE_HIGHATOMIC))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ z è¡¨ç¤ºå½“å‰æ‰«æçš„å†…å­˜ç®¡ç†åŒºï¼Œ classzone_idx è¡¨ç¤ºè¿™æ¬¡åˆ†é…è¯·æ±‚é€šè¿‡åˆ†é…æ©ç è®¡ç®—å‡ºæ¥çš„é¦–é€‰çš„å†…å­˜ç®¡ç†åŒºï¼Œå¦‚ GFP_KERNEL ä¼šé¦–é€‰ ZONE_NOMALã€‚min è¡¨ç¤º z å†…å­˜ç®¡ç†åŒºä¸­åˆ¤æ–­æ°´ä½çš„æ¡ä»¶ï¼Œfree_pages è¡¨ç¤º z å†…å­˜ç®¡ç†åŒºçš„ç©ºé—²å†…å­˜ã€‚ å‡è®¾ç°åœ¨åˆ†é…è¯·æ±‚ä¸­ order ä¸º 2ï¼Œåˆ†é…æ©ç ä¸º GFP_KERNELï¼Œä¸ºäº†åˆ¤æ–­å½“å‰çš„ ZONE_DMA æ˜¯å¦é€‚åˆè¿™æ¬¡åˆ†é…è¯·æ±‚ï¼Œå‡è®¾åˆ¤æ–­æ°´ä½æ¡ä»¶ä¸ºä½æ°´ä½ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦è¯»å– ZONE_DMA ä¸­ lowmem_reserve[] çš„å€¼ï¼Œä» /proc/zoneinfo èŠ‚ç‚¹ä¸­æˆ‘ä»¬å¯ä»¥è¯»å‡ºå€¼ä¸º 7610ï¼Œ7610KBx4=30440KBï¼ŒåŠ ä¸Š 43KBï¼Œå› æ­¤å†…å­˜ç®¡ç†åŒºçš„ç©ºé—²é¡µ é¢å¿…é¡»è¦å¤§äº 30484KB æ‰èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚ã€‚ æ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„ lowmem_reserve[] å€¼å¯ä»¥é€šè¿‡è®¾ç½® lowmem_reserve_ratio èŠ‚ç‚¹çš„å€¼æ¥ä¿®æ”¹ï¼Œæœ€ç»ˆå®ƒæ˜¯è°ƒç”¨ setup_per_zone_lowmem_reserver[] å‡½æ•°æ¥å®ç°çš„ã€‚</p><h1 id="å½±å“é¡µé¢å›æ”¶çš„å‚æ•°">å½±å“é¡µé¢å›æ”¶çš„å‚æ•°</h1><h2 id="sappiness">sappiness</h2><p>swampiness ç”¨äºæ§åˆ¶ kswapd å†…æ ¸çº¿ç¨‹æŠŠé¡µé¢å†™å…¥äº¤æ¢åˆ†åŒºçš„æ´»è·ƒç¨‹åº¦ï¼Œè¯¥å€¼å¯ä»¥è®¾ç½®ä¸º 0~100 è¯¥å€¼è¶Šå°ï¼Œè¯´æ˜å†™å…¥äº¤æ¢åˆ†åŒºçš„æ´»è·ƒåº¦è¶Šä½ï¼Œè¿™æ ·æœ‰åŠ©äºæé«˜ç³»ç»Ÿçš„ I/O æ€§èƒ½è¯¥å€¼è¶Šå¤§ï¼Œè¯´æ˜è¶Šæ¥è¶Šå¤šè¿›ç¨‹çš„åŒ¿åé¡µé¢è¢«å†™å…¥äº¤æ›åˆ†åŒºäº†ï¼Œè¿™æ ·æœ‰åˆ©äºç³»ç»Ÿè…¾å‡ºå†…å­˜ç©ºé—´ï¼Œä½†æ˜¯å‘ç”Ÿç£ç›˜äº¤æ¢ä¼šå¯¼è‡´å¤§é‡çš„ I/Oï¼Œå½±å“ç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½ã€‚0 è¡¨ç¤ºä¸å†™å…¥åŒ¿åé¡µé¢åˆ°ç£ç›˜ï¼Œç›´åˆ°ç³»ç»Ÿçš„ç©ºé—²é¡µé¢åŠ ä¸Šæ–‡ä»¶æ˜ å°„é¡µé¢çš„æ€»æ•°å°‘äºå†…å­˜ç®¡ç†åŒºçš„é«˜æ°´ä½ã‚ªå¯åŠ¨åŒ¿åé¡µé¢å›æ”¶å¹¶å°†å…¶å†™å…¥äº¤æ¢ç£ç›˜ã€‚ swampiness çš„é»˜è®¤å€¼ä¸º 60ã€‚</p><h2 id="zone_reclaim_mode">zone_reclaim_mode</h2><p>å½“é¡µé¢åˆ†é…å™¨åœ¨ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºé‡Œåˆ†é…å¤±è´¥æ—¶ï¼Œè‹¥ zone_reclaim_mode ä¸º 0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä»ä¸‹ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºæˆ–è€…ä¸‹ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹ä¸­åˆ†é…å†…å­˜ï¼›å¦åˆ™ï¼Œè¡¨ç¤ºå¯ä»¥åœ¨è¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­è¿›è¡Œä¸€äº›å†…å­˜å›æ”¶ï¼Œç„¶åç»§ç»­å°è¯•åœ¨è¯¥å†…å­˜ç®¡ç†åŒºä¸­åˆ†åˆ†é…å†…å­˜ã€‚ åœ¨ kernel/sysctl.c æ–‡ä»¶ä¸­ï¼Œ zone_reclaim_mode çš„å€¼ç”± node_reclaim_mode å»æ¥å­˜å‚¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ctl_table</span> <span class="title">vm_table</span>[] =</span> {</span><br><span class="line">{</span><br><span class="line">.procname= <span class="string">"overcommit_memory"</span>,</span><br><span class="line">.data= &amp;sysctl_overcommit_memory,</span><br><span class="line">.maxlen= <span class="keyword">sizeof</span>(sysctl_overcommit_memory),</span><br><span class="line">.mode= <span class="number">0644</span>,</span><br><span class="line">.proc_handler= overcommit_policy_handler,</span><br><span class="line">.extra1= SYSCTL_ZERO,</span><br><span class="line">.extra2= &amp;two,</span><br><span class="line">},</span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">{</span><br><span class="line">.procname       = <span class="string">"nr_hugepages_mempolicy"</span>,</span><br><span class="line">.data           = <span class="literal">NULL</span>,</span><br><span class="line">.maxlen         = <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>),</span><br><span class="line">.mode           = <span class="number">0644</span>,</span><br><span class="line">.proc_handler   = &amp;hugetlb_mempolicy_sysctl_handler,</span><br><span class="line">},</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ get_page_from_freelist() å‡½æ•°ä¸­ï¼Œå½“ zone_watermark_fast() åˆ¤æ–­å½“å‰çš„å†…å­˜ç®¡ç†åŒºä¸èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚æ—¶ï¼Œè‹¥ node_reclaim_mode çš„å€¼ä¸ä¸º 0ï¼Œåˆ™è°ƒç”¨ node_reclaim() å‡½æ•°å¯¹è¯¥å†…å­˜ç®¡ç†åŒºè¿›è¡Œé¡µé¢å›æ”¶ã€‚ä¸‹é¢æ˜¯ get page_ from freelis å‡½æ•°çš„ä»£ç ç‰‡æ®µã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *</span><br><span class="line"><span class="title function_">get_page_from_freelist</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order, <span class="type">int</span> alloc_flags,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> alloc_context *ac)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">last_pgdat_dirty_limit</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">bool</span> no_fallback;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT;</span><br><span class="line">z = ac-&gt;preferred_zoneref;</span><br><span class="line">for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,</span><br><span class="line">ac-&gt;nodemask) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled() &amp;&amp;</span><br><span class="line">(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;</span><br><span class="line">!__cpuset_zone_allowed(zone, gfp_mask))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (ac-&gt;spread_dirty_pages) {</span><br><span class="line"><span class="keyword">if</span> (last_pgdat_dirty_limit == zone-&gt;zone_pgdat)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!node_dirty_ok(zone-&gt;zone_pgdat)) {</span><br><span class="line">last_pgdat_dirty_limit = zone-&gt;zone_pgdat;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">    zone != ac-&gt;preferred_zoneref-&gt;zone) {</span><br><span class="line"><span class="type">int</span> local_nid;</span><br><span class="line"></span><br><span class="line">local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);</span><br><span class="line"><span class="keyword">if</span> (zone_to_nid(zone) != local_nid) {</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);</span><br><span class="line"><span class="keyword">if</span> (!zone_watermark_fast(zone, order, mark,</span><br><span class="line">       ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">       gfp_mask)) {</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!node_reclaim_enabled() ||</span><br><span class="line">    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);</span><br><span class="line"><span class="keyword">switch</span> (ret) {</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_NOSCAN:</span><br><span class="line"><span class="comment">/* did not scan */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_FULL:</span><br><span class="line"><span class="comment">/* scanned but unreclaimable */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">/* did we reclaim enough */</span></span><br><span class="line"><span class="keyword">if</span> (zone_watermark_ok(zone, order, mark,</span><br><span class="line">ac-&gt;highest_zoneidx, alloc_flags))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">try_this_zone:</span><br><span class="line">page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,</span><br><span class="line">gfp_mask, alloc_flags, ac-&gt;migratetype);</span><br><span class="line"><span class="keyword">if</span> (page) {</span><br><span class="line">prep_new_page(page, order, gfp_mask, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(order &amp;&amp; (alloc_flags &amp; ALLOC_HARDER)))</span><br><span class="line">reserve_highatomic_pageblock(page, zone, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (no_fallback) {</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>zone_reclaim_mode æ˜¯ä¸€ä¸ªæŒ‰ä½æˆ–æ“ä½œçš„æ•°å€¼ï¼Œè¯»è€…å¯ä»¥æ ¹æ®å¦‚ä¸‹ä½æ¥è®¾ç½®ä¸åŒçš„ç»„åˆã€‚</p><ul><li>1(bit[0])ï¼šè¡¨ç¤ºæ‰“å¼€å†…å­˜ç®¡ç†åŒºå›æ”¶æ¨¡å¼ãƒ»æ‰«æè¯¥å†…å­˜ç®¡ç†åŒºçš„é¡µé¢å¹¶è¿›è¡Œé¡µé¢å›æ”¶ã€‚</li><li>2(bit[1]ï¼‰ï¼šè¡¨ç¤ºåªå›æ”¶è¯¥å†…å­˜ç®¡ç†åŒºçš„å†…å®¹ç¼“å­˜é¡µé¢ï¼Œå°†è„çš„å†…å®¹ç¼“å­˜é¡µé¢å›å†™åˆ°ç£ç›˜ï¼Œä»è€Œå›æ”¶é¡µé¢ã€‚</li><li>4(bit[2]ï¼‰ï¼šè¡¨ç¤ºåªå›æ”¶è¯¥å†…å­˜ç®¡ç†åŒºçš„åŒ¿åé¡µé¢ã€‚</li></ul><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œ zone_reclaim_mode æ¨¡å¼æ˜¯å…³é—­çš„ã€‚ä½†æ˜¯ï¼Œè¯»è€…å¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯æ¥é€‰æ‹©æ‰“å¼€æˆ–è€…å…³é—­ã€‚</p><ul><li>æ‰“å¼€çš„åœºæ™¯ã€‚å¦‚æœåº”ç”¨åœºæ™¯å¯¹è·¨ NUMA å†…å­˜èŠ‚ç‚¹çš„è®¿é—®å»¶æ—¶æ¯”è¾ƒæ•æ„Ÿï¼Œå¯ä»¥æ‰“å¼€ zone_reclaim_mode æ¨¡å¼ï¼Œè¿™æ ·é¡µé¢åˆ†é…å™¨ä¼šä¼˜å…ˆä»æœ¬åœ°å†…å­˜èŠ‚ç‚¹å›æ”¶å†…å­˜å¹¶åˆ†é…å†…å­˜ã€‚</li><li>å…³é—­çš„åœºæ™¯ã€‚å¦‚æ–‡ä»¶æœåŠ¡å™¨ä¸­ï¼Œç³»ç»Ÿéœ€è¦å¤§é‡çš„å†…å®¹æ¥ä½œä¸ºå†…å®¹ç¼“å­˜ï¼Œå³ä½¿å†…å®¹ç¼“å­˜åœ¨è¿œç«¯ NUMA èŠ‚ç‚¹ä¸Šï¼Œè¯»å…¶ä¸­çš„å†…å®¹ä¹Ÿæ¯”ç›´æ¥è¯»ç£ç›˜ä¸­çš„å†…å®¹è¦å¿«ã€‚</li></ul><h2 id="watermark_boost_factor">watermark_boost_factor</h2><p>watermark_boost_factor ç”¨äºä¼˜åŒ–å†…å­˜å¤–ç¢ç‰‡åŒ–ã€‚å®ƒä¸´æ—¶æé«˜å†…å­˜ç®¡ç†åŒºçš„æ°´ä½ï¼Œå³ zone-&gt;watermark_boost ä»è€Œæé«˜å†…å­˜ç®¡ç†åŒºçš„é«˜æ°´ä½ï¼ˆ WMARK_HIGHï¼‰ï¼Œè¿™æ · kswapd å¯ä»¥å›æ”¶æ›´å¤šå†…å­˜ï¼Œå†…å­˜è§„æ•´æ¨¡å—ï¼ˆ compactd å†…æ ¸çº¿ç¨‹ï¼‰å°±æ¯”è¾ƒå®¹æ˜“åˆå¹¶å¤§å—çš„è¿ç»­ç‰©ç†å†…å­˜ã€‚ watermark_boost_factor çš„é»˜è®¤å€¼æ˜¯ 15000ï¼Œè¡¨ç¤ºä¼šä¸´æ—¶æŠŠåŸæ¥çš„é«˜æ°´ä½æå‡åˆ° 150%ã€‚è‹¥æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º 0ï¼Œåˆ™å…³é—­ä¸´æ—¶æé«˜å†…å­˜ç®¡ç†åŒºæ°´ä½çš„æœºåˆ¶ã€‚ä¸´æ—¶æé«˜ zone-&gt;watermark_boost æ˜¯åœ¨ boost_watermark() å‡½æ•°ä¸­å®ç°çš„ã€‚</p><h2 id="watermark_scale_factor">watermark_scale_factor</h2><p>é™¤äº†å’Œ min_free_kbyt æœ‰å…³å¤–ï¼Œ watermark_scale_factor è¿˜ä¼šå½±å“æ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„ä½æ°´ä½ WMARK_LOWï¼‰å’Œé«˜æ°´ä½ å†…å­˜ç®¡ç†åŒºçš„ä½æ°´ä½ä¼šå½±å“ kswapd å†…æ ¸çº¿ç¨‹å”¤é†’çš„æ—¶æœºï¼Œå†…å­˜ç®¡ç†åŒºçš„é«˜æ°´ä½ä¼šå½±å“ kswapd å†…æ ¸çº¿ç¨‹è¿›å…¥ç¡çœ çš„æ—¶æœºã€‚é€šå¸¸ï¼Œå½“é¡µé¢åˆ†é…å™¨å‘ç°åœ¨ä½æ°´ä½åˆ†é…å¤±è´¥æ—¶ï¼Œä¼šå”¤é†’ kswapd å†…æ ¸çº¿ç¨‹ï¼šè€Œå½“å†…å­˜ç®¡ç†åŒºæ°´ä½é«˜äºé«˜æ°´ä½æ—¶ï¼Œä¼šè®© kswapd å†…æ ¸çº¿ç¨‹åœæ­¢å·¥ä½œå¹¶è¿›å…¥ç¡çœ çŠ¶æ€ã€‚</p><p>åœ¨__setup_per_zone_marks() å‡½æ•°ä¸­ï¼Œwatermark_scale_factor çš„é»˜è®¤å€¼ä¸º 10ï¼Œåˆ†æ¯ä¸º 10000 å› æ¯”è¡¨ç¤ºä¸¤ä¸ªæ°´ä½ä¹‹é—´çš„è·ç¦»æ˜¯ç³»ç»Ÿæ€»å†…å­˜çš„ 0.1%ï¼Œå¦‚æœ€ä½è­¦æˆ’æ°´ä½ä¸ä½æ°´ä½çš„å·®è·æ˜¯æ€»å†…å­˜çš„ 0.1% watermark_scale_factor æœ€å¤§å¯ä»¥è®¾ç½®ä¸º 1000 å³ä¸¤ä¸ªæ°´ä½ä¹‹é—´çš„å·®è·æœ€å¤§ä¸ºæ€»å†…å­˜çš„ 10%ã€‚</p><h1 id="å½±å“è„é¡µå›å†™çš„å‚æ•°">å½±å“è„é¡µå›å†™çš„å‚æ•°</h1><p>å†…å­˜çš„å›æ”¶å’Œèƒœé¡µå›å†™æœ‰å¯†åˆ‡çš„å…³ç³»ï¼Œå°½ç®¡æœ¬èŠ‚æ²¡æœ‰ä»‹ç»æ–‡ä»¶ç³»ç»Ÿçš„ç›¸å…³å†…å®¹ï¼Œä½†æ˜¯å¯¹äºç³»ç»Ÿè°ƒä¼˜æ¥è¯´ï¼Œå½±å“è„é¡µå›å†™çš„å‚æ•°ä¸å¯å¿½è§†ã€‚</p><ul><li>dirty_background_bytesï¼šå½“è„é¡µæ‰€å çš„å†…å­˜æ•°é‡ï¼ˆæŒ‡æ‰€æœ‰å¯ç”¨å†…å­˜ï¼Œå³ç©ºé—²é¡µé¢+å¯å›æ”¶å†…å­˜é¡µé¢ï¼‰è¶…è¿‡ dirty_background_bytes æ—¶ï¼Œå†…æ ¸å›å†™çº¿ç¨‹ï¼ˆ writeback threadï¼‰å¼€å§‹å›å†™è„é¡µã€‚</li><li>dirty_background_ratioï¼šå½“è„é¡µæ‰€å çš„ç™¾åˆ†æ¯”è¾¾åˆ° dirty_background_ratio æ—¶ï¼Œå†…æ ¸å›å†™çº¿ç¨‹å¼€å§‹å›å†™è„é¡µæ•°æ®ï¼Œç›´åˆ°è„é¡µæ¯”ä¾‹ä½äºæ­¤å€¼ã€‚æ³¨æ„ï¼Œå¯¹äº dirty_backgound_byts å’Œ dirty_background_ratioï¼Œæˆ‘ä»¬åªèƒ½è®¾ç½®å…¶ä¸­ä¸€ä¸ªã€‚å½“è®¾ç½®å…¶ä¸­ä¸€ä¸ªæ—¶ã€‚å¦å¤–ä¸€ä¸ªç«‹å³å˜æˆ 0ã€‚ dirty_background_ratio çš„é»˜è®¤å€¼ä¸º 10ã€‚</li><li>diry_bytesï¼šå½“ç³»ç»Ÿçš„è„é¡µæ€»æ•°è¾¾åˆ° diry_bytes å€¼æ—¶ï¼Œ wrte ç³»ç»Ÿè°ƒç”¨ä¼šè¢«é˜»å¡ï¼Œå¹¶å¼€å§‹å›å†™è„é¡µæ•°æ®ï¼Œç›´åˆ°è„é¡µæ€»æ•°ä½äºæ­¤å€¼ã€‚æ³¨æ„ï¼Œè¯¥å€¼ä¸èƒ½è®¾ç½®ä¸ºå°äºä¸¤ä¸ªé¡µé¢å¤§å°çš„å­—èŠ‚æ•°ï¼Œå¦åˆ™ï¼Œè®¾ç½®ä¸ç”Ÿæ•ˆå¹¶ä¸”ç³»ç»Ÿä¼šé»˜è®¤åŠ è½½ä¹‹å‰çš„æ—§å€¼ã€‚</li><li>dirty_ratioï¼šå½“è„é¡µæ‰€å çš„ç™¾åˆ†æ¯”ï¼ˆç©ºé—²å†…å­˜é¡µ+å¯å›æ”¶å†…å­˜é¡µï¼‰è¾¾åˆ° dirty_ratio æ—¶ï¼Œwrite ç³»ç»Ÿè°ƒç”¨è¢«é˜»å¡å¹¶å¼€å§‹å›å†™è„é¡µæ•°æ®ï¼Œç›´åˆ°è„é¡µæ¯”ä¾‹ä½äºæ­¤å€¼ã€‚ dirty_ratio çš„é»˜è®¤å€¼ä¸º 20ã€‚æ³¨æ„ï¼Œå¯¹äº dirty_ratio å’Œ dirty_bytesï¼Œæˆ‘ä»¬åªèƒ½è®¾ç½®å…¶ä¸­ä¸€ä¸ªã€‚</li><li>dirty_expire_centisecsï¼šè„æ•°æ®çš„è¿‡æœŸæ—¶é—´ã€‚å½“å†…æ ¸å›å†™çº¿ç¨‹è¢«å”¤é†’åä¼šæ£€æŸ»å“ªäº›æ•°æ®çš„å­˜åœ¨æ—¶é—´è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œå¹¶å°†è¿™äº›è„æ•°æ®å›å†™åˆ°ç£ç›˜ï¼Œå•ä½æ˜¯ç™¾åˆ†ä¹‹ä¸€ç§’ï¼Œä¹Ÿå°±æ˜¯ 10msã€‚è¯¥å€¼é»˜è®¤æ˜¯ 3000ï¼Œå³è‹¥è„æ•°æ®çš„å­˜åœ¨æ—¶é—´è¶…è¿‡ 30sï¼Œé‚£ä¹ˆå†…æ ¸å›å†™çº¿ç¨‹å”¤é†’ä¹‹åä¼˜å…ˆå›å†™è¿™äº›è„æ•°æ®ã€‚</li><li>dirty_writeback_centisecsï¼šå†…æ ¸å›å†™çº¿ç¨‹å‘¨æœŸæ€§å”¤é†’çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯ 5ã€‚</li><li><p>drop_cachesï¼šç”¨æ¥å›æ”¶å¹²å‡€çš„é¡µé¢é«˜é€Ÿç¼“å­˜å’Œä¸€äº›å¯ä»¥å›æ”¶çš„ sab å¯¹è±¡ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿä¸­ inodeã€dentries ç­‰ã€‚å…¶é»˜è®¤å€¼çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>1ã€å›æ”¶å’Œé‡Šæ”¾å†…å®¹ç¼“å­˜é¡µé¢</li><li>2ã€å›æ”¶å’Œé‡Šæ”¾å¯å›æ”¶çš„ sab å¯¹è±¡ã€‚</li><li>3ã€åŒæ—¶å›æ”¶å’Œé‡Šæ”¾å†…å®¹ç¼“å­˜é¡µé¢ã€slb å¯¹è±¡</li></ul></li></ul><p>è¯»è€…å¯èƒ½ä¼šå¯¹ dirty_background_* å’Œ dirty_* è¿™ä¸¤ç»„å‚æ•°äº§ç”Ÿç–‘æ„Ÿã€‚å…¶å®å®ƒä»¬ä¹‹é—´ä¸å†²çªï¼Œä¸‹é¢ä»¥ ratio ä¸ºä¾‹æ¥è¯´æ˜ï¼Œ dirty_background_ratio æ˜¯å†…å­˜å¯ä»¥äº§ç”Ÿè„é¡µçš„ç™¾åˆ†æ¯”ã€‚è‹¥ç³»ç»Ÿè„é¡µè¶…è¿‡è¿™ä¸ªæ¯”ä¾‹ï¼Œè¿™äº›è„é¡µä¼šåœ¨ç¨åæŸä¸ªæ—¶åˆ»å›å†™åˆ°ç£ç›˜é‡Œï¼Œè¿™ç”±å†…æ ¸å›å†™çº¿ç¨‹æ¥å®Œæˆã€‚è€Œ dirty_ratio çš„è¯­ä¹‰æ˜¯è„é¡µçš„é™åˆ¶ï¼Œå³è„é¡µçš„ç™¾åˆ†æ¯”ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼ã€‚å¦‚æœè„æ•°æ®è¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œæ–°çš„ I/O è¯·æ±‚ï¼ˆ write ç³»ç»Ÿè°ƒç”¨ï¼‰å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è„æ•°æ®è¢«å†™è¿›ç£ç›˜ã€‚è¿™æ˜¯é€ æˆ I/O å»¶è¿Ÿçš„é‡è¦åŸå› ï¼Œä½†è¿™æ˜¯ä¿è¯å†…å­˜ä¸­ä¸ä¼šå­˜åœ¨è¿‡é‡è„æ•°æ®çš„ä¿æŠ¤æœºåˆ¶</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆåä¸€ï¼‰è°ƒè¯•ä¿¡æ¯</title>
      <link href="/2021/LinuxKernel/LinuxMemoryDebug/"/>
      <url>/2021/LinuxKernel/LinuxMemoryDebug/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryDebug.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM4OTE1MGYzNDZmYjA3MjVmYmIzZjM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="procmeminfo">/proc/meminfo</h1><p>åœ¨ Linux ç³»ç»Ÿä¸­æŸ¥çœ‹å†…å­˜ä¿¡æ¯æœ€å‡†ç¡®çš„æ–¹æ³•æ˜¯æŸ¥çœ‹/proc/meminfo èŠ‚ç‚¹ä¿¡æ¯ï¼Œä»–åŒ…å«å½“å‰æ—¶åˆ»ç³»ç»Ÿçš„æ‰€æœ‰çš„ç‰©ç†é¡µé¢ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~/workspace/blog$ <span class="built_in">cat</span> /proc/meminfo</span><br><span class="line">MemTotal:       32766544 kB</span><br><span class="line">MemFree:        18617392 kB</span><br><span class="line">MemAvailable:   31598252 kB</span><br><span class="line">Buffers:          829808 kB</span><br><span class="line">Cached:         11869936 kB</span><br><span class="line">SwapCached:            0 kB</span><br><span class="line">Active:          7991876 kB</span><br><span class="line">Inactive:        4838568 kB</span><br><span class="line">Active(anon):     125680 kB</span><br><span class="line">Inactive(anon):      628 kB</span><br><span class="line">Active(file):    7866196 kB</span><br><span class="line">Inactive(file):  4837940 kB</span><br><span class="line">Unevictable:           0 kB</span><br><span class="line">Mlocked:               0 kB</span><br><span class="line">SwapTotal:      92274680 kB</span><br><span class="line">SwapFree:       92274680 kB</span><br><span class="line">Dirty:               248 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">AnonPages:        130960 kB</span><br><span class="line">Mapped:           164660 kB</span><br><span class="line">Shmem:              5180 kB</span><br><span class="line">KReclaimable:     746412 kB</span><br><span class="line">Slab:            1116388 kB</span><br><span class="line">SReclaimable:     746412 kB</span><br><span class="line">SUnreclaim:       369976 kB</span><br><span class="line">KernelStack:       11840 kB</span><br><span class="line">PageTables:         3800 kB</span><br><span class="line">NFS_Unstable:          0 kB</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:    108657952 kB</span><br><span class="line">Committed_AS:    1769632 kB</span><br><span class="line">VmallocTotal:   34359738367 kB</span><br><span class="line">VmallocUsed:       56828 kB</span><br><span class="line">VmallocChunk:          0 kB</span><br><span class="line">Percpu:            58368 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:         0 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">ShmemPmdMapped:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">FilePmdMapped:         0 kB</span><br><span class="line">CmaTotal:              0 kB</span><br><span class="line">CmaFree:               0 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">Hugetlb:               0 kB</span><br><span class="line">DirectMap4k:      722824 kB</span><br><span class="line">DirectMap2M:    16992256 kB</span><br><span class="line">DirectMap1G:    17825792 kB</span><br></pre></td></tr></tbody></table></figure><p>meminfo èŠ‚ç‚¹å®ç°åœ¨ meminfo_proc_show() å‡½æ•°é‡Œï¼Œè¯¥å‡½æ•°åœ¨ fs/proc/meminfo.c æ–‡ä»¶é‡Œã€‚</p><ul><li>MemTotalï¼šç³»ç»Ÿå½“å‰å¯ç”¨ç‰©ç†å†…å­˜æ€»é‡ï¼Œé€šè¿‡è¯»å–å…¨å±€å˜é‡ _totalram_pages æ¥è·å¾—</li><li>MemFree: ç³»ç»Ÿå½“å‰å‰©ä½™ç©ºé—²ç‰©ç†å†…å­˜ï¼Œé€šè¿‡è¯»å–å…¨å±€å˜é‡ wm_zone_stat[] æ•°ç»„ä¸­çš„ NR_FREE_PAGES æ¥è·å¾—</li><li>Memavailable: ç³»ç»Ÿä¸­å¯ä½¿ç”¨é¡µé¢çš„æ•°é‡ï¼Œç”± si_mem_available() å‡½æ•°è®¡ç®—è€Œæ¥ï¼Œè®¡ç®—å…¬å¼ä¸º Available= memfree + pagecache + reclaimable - totalreserve_pagesã€‚è¿™é‡ŒåŒ…æ‹¬äº†ç©ºé—²é¡µé¢ï¼ˆ memfreeï¼‰ã€æ–‡ä»¶æ˜ å°„é¡µé¢ï¼ˆ pagecacheï¼‰ã€å¯å›æ”¶çš„é¡µé¢ï¼ˆ reclaimableï¼‰ï¼Œæœ€åå‡å»ç³»ç»Ÿä¿ç•™çš„é¡µé¢</li><li>Buffersï¼šç”¨äºå—å±‚çš„ç¼“å­˜ï¼Œç”± nr_blockdev_pages() å‡½æ•°æ¥è®¡ç®—</li><li>Cached: ç”¨äºé¡µé¢é«˜é€Ÿç¼“å­˜çš„é¡µé¢ã€‚è®¡ç®—å…¬å¼ä¸º Cached= NR_FILE_PAGES - swap_cache - Buffers</li><li>SwapCached: è¿™é‡Œç»Ÿè®¡äº¤æ¢ç¼“å­˜çš„æ•°é‡ï¼Œäº¤æ¢ç¼“å­˜ç±»ä¼¼äºå†…å®¹ç¼“å­˜ï¼Œåªä¸è¿‡å®ƒå¯¹åº”çš„æ˜¯äº¤æ¢åˆ†åŒºï¼Œè€Œå†…å®¹ç¼“å­˜å¯¹åº”çš„æ˜¯æ–‡ä»¶ã€‚è¿™é‡Œè¡¨ç¤ºåŒ¿åé¡µé¢æ›¾ç»è¢«äº¤æ›å‡ºå»ï¼Œç°åœ¨åˆè¢«äº¤æ›å›æ¥ï¼Œä½†æ˜¯é¡µé¢å†…å®¹è¿˜åœ¨äº¤æ¢ç¼“å­˜ä¸­</li><li>Activeï¼šæ´»è·ƒçš„åŒ¿åé¡µé¢ï¼ˆ LRU_ACTIVE_ANONï¼‰å’Œæ´»è·ƒçš„æ–‡ä»¶æ˜ å°„é¡µé¢ï¼ˆ LRU_ACTIVE_FILEï¼‰</li><li>Inactive: ä¸æ´»è·ƒçš„åŒ¿åé¡µé¢ï¼ˆ LRU_INACTIVE_ANONï¼‰å’Œä¸æ´»è·ƒçš„æ–‡ä»¶æ˜ å°„é¡µé¢ï¼ˆ LRU_INACTIVE_FILEï¼‰</li><li>Active(anon): æ´»è·ƒçš„åŒ¿åé¡µé¢ï¼ˆ LRU_ACTIVE_ANONï¼‰</li><li>Inactive(anon): ä¸æ´»è·ƒçš„åŒ¿åé¡µé¢ï¼ˆ LRU_INACTIVE_ANONï¼‰</li><li>Active(file): æ´»è·ƒçš„æ–‡ä»¶æ˜ å°„é¡µé¢ï¼ˆ LRU_ACTIVE_FILEï¼‰</li><li>Inactive(file): ä¸æ´»è·ƒçš„æ–‡ä»¶æ˜ å°„é¡µé¢ï¼ˆ LRU_INACTIVE_FILEï¼‰</li><li>Unevictable: ä¸èƒ½å›æ”¶çš„é¡µé¢ï¼ˆ LRU_UNEVICTABLEï¼‰</li><li>Mlocked: ä¸ä¼šè¢«äº¤æ¢åˆ°äº¤æ¢åˆ†åŒºçš„é¡µé¢ï¼Œç”±å…¨å±€çš„ vm_zone_stat[] ä¸­çš„ NR_MLOCK æ¥ç»Ÿè®¡</li><li>SwapTotal: äº¤æ¢åˆ†åŒºçš„å¤§å°</li><li>Swapfree: äº¤æ¢åˆ†åŒºçš„ç©ºé—²ç©ºé—´å¤§å°</li><li>Dirty: è„é¡µçš„æ•°é‡ï¼Œç”±å…¨å±€çš„ vm_node_stat[] ä¸­çš„ NR_FILE_DIRTY æ¥ç»Ÿè®¡</li><li>Writeback: æ­£åœ¨å›å†™çš„é¡µé¢æ•°é‡ï¼Œç”±å…¨å±€çš„ vm_node_stat[] ä¸­çš„ NR_WRITEBACK æ¥ç»Ÿè®¡</li><li>Anonpages: ç»Ÿè®¡æœ‰åå‘æ˜ å°„ï¼ˆRMAPï¼‰çš„é¡µé¢ï¼Œé€šå¸¸è¿™äº›é¡µé¢éƒ½æ˜¯åŒ¿åé¡µé¢å¹¶ä¸”éƒ½æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰åŒ¿åé¡µé¢éƒ½é…ç½®äº†åå‘æ˜ å°„ï¼Œå¦‚éƒ¨åˆ†çš„ shmem å’Œ tmps é¡µé¢å°±æ²¡æœ‰è®¾ç½®åå‘æ˜ å°„ã€‚è¿™ä¸ªè®¡æ•°ç”±å…¨å±€çš„ vm_node_stat[] ä¸­çš„ NR_ANON_MAPPED æ¥ç»Ÿè®¡</li><li>Mapped: ç»Ÿè®¡æ‰€æœ‰æ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´çš„å†…å®¹çº§å­˜é¡µé¢ï¼Œç”±å…¨å±€çš„ vm_node_stat[] ä¸­çš„ NR_FILE_MAEED æ¥ç»Ÿè®¡</li><li>Shmem: å…±äº«å†…å­˜ï¼ˆåŸºäº tmps å®ç°çš„ shmemã€ devtmfs ç­‰ï¼‰é¡µé¢çš„æ•°é‡ï¼Œç”±å…¨å±€çš„ vm_node_stat[] ä¸­çš„ NR_SHMEM æ¥ç»Ÿè®¡</li><li>KReclaimable: å†…æ ¸å¯å›æ”¶çš„å†…å­˜ï¼ŒåŒ…æ‹¬å¯å›æ”¶çš„ slab é¡µé¢ï¼ˆ NR_SLAB_RECLAIMABLEï¼‰å’Œå…¶ä»–çš„å¯å›æ”¶çš„å†…æ ¸é¡µé¢ï¼ˆ NR_KERNEL_MISC_RECLAIMABLEï¼‰</li><li>Slab: æ‰€æœ‰ slab é¡µé¢ï¼ŒåŒ…æ‹¬å¯å›æ”¶çš„ slab é¡µé¢ï¼ˆ NR_SLAB_RECLAIMABLEï¼‰å’Œä¸å¯å›æ”¶çš„ slab é¡µé¢ (NR_SLAB_UNRECLAIMABLE)</li><li>Reclaimable: å¯å›æ”¶çš„ slab é¡µé¢ï¼ˆ NR_SLAB_RECLAIMABLEï¼‰</li><li>SUnreclaim: ä¸å¯å›æ”¶çš„ slab é¡µé¢ï¼ˆNR_SLAB_UNRECLAIMABLEï¼‰</li><li>Kernelstack: æ‰€æœ‰è¿›ç¨‹å†…æ ¸æ ˆçš„æ€»å¤§å°ï¼Œç”±å…¨å±€çš„ vm_zone_stat[] ä¸­çš„ NR_KERNEL_STACK_KB æ¥ç»Ÿè®¡</li><li>Pagetables: æ‰€æœ‰ç”¨äºé¡µè¡¨çš„é¡µé¢æ•°é‡ï¼Œç”±å…¨å±€çš„ vm_zone_stat[] ä¸­çš„ NR_PAGETABLE æ¥ç»Ÿè®¡</li><li>NFS_Unstable: åœ¨ NFS ä¸­ï¼Œå‘é€åˆ°æœåŠ¡å™¨ç«¯ä½†æ˜¯è¿˜æ²¡æœ‰å†™å…¥ç£ç›˜çš„é¡µé¢ï¼ˆINR_UNSTABLE_NFSï¼‰</li><li>WritebackTmp: å›å†™è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸´æ—¶ç¼“å­˜ï¼ˆ NR_WRITEBACK_TEMPï¼‰</li><li>VmallocTotal: vmalloc åŒºåŸŸçš„æ€»å¤§å°</li><li>VmallocUsed: å·²ç»ä½¿ç”¨çš„ vmalloc åŒºåŸŸæ€»å¤§å°</li><li>Percpuï¼š percpu æœºåˆ¶ä½¿ç”¨çš„é¡µé¢ï¼Œç”± pcpu_nr_pages() å‡½æ•°ç»Ÿè®¡</li><li>AnonHugePageï¼š ç»Ÿè®¡é€æ˜å·¨é¡µçš„æ•°é‡</li><li>ShmemHugePagesï¼š ç»Ÿè®¡åœ¨ shmem æˆ–è€… tmpfs ä¸­ä½¿ç”¨çš„é€æ˜å·¨é¡µçš„æ•°é‡</li><li>ShmemPmdMappedï¼š ä½¿ç”¨é€æ˜å·¨é¡µå¹¶ä¸”æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„ shmem æˆ–è€… tmps çš„é¡µé¢æ•°é‡</li><li>CmaTotalï¼š CMA æœºåˆ¶ä½¿ç”¨çš„å†…å­˜</li><li>CmaFreeï¼š CMA æœºåˆ¶ä¸­ç©ºé—²çš„å†…å­˜</li><li>HugePages_Total: æ™®é€šå·¨é¡µçš„æ•°é‡ï¼Œæ™®é€šå·¨é¡µçš„é¡µé¢æ˜¯é¢„åˆ†é…çš„</li><li>Hugepages_Free: ç©ºé—²çš„æ™®é€šå·¨é¡µçš„æ•°é‡</li><li>Hugepageslze: æ™®é€šå·¨é¡µçš„å¤§å°ï¼Œé€šå¸¸æ˜¯ 2MB æˆ–è€… 1GB</li><li>Hugetlb: æ™®é€šå·¨é¡µçš„æ€»å¤§å°ï¼Œå•ä½æ˜¯ KB</li></ul><p>è¯»è€…å¯èƒ½ä¼šå¯¹ä¸Šè¿°å†…å®¹æ„Ÿåˆ°ç–‘æƒ‘ï¼Œä¸‹é¢å½’çº³å¸¸è§çš„é—®é¢˜ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-memtotal-ä¸ç­‰äº-qemu-è™šæ‹Ÿæœºä¸­åˆ†é…çš„å†…å­˜å¤§å°">ä¸ºä»€ä¹ˆ MemTotal ä¸ç­‰äº QEMU è™šæ‹Ÿæœºä¸­åˆ†é…çš„å†…å­˜å¤§å°ï¼Ÿ</h2><p>è¯»è€…å¯èƒ½ä¼šå‘ç° MemTotal æ˜¾ç¤ºçš„æ€»å†…å­˜å¤§å°å¹¶ä¸ç­‰äºç‰©ç†ç³»ç»Ÿä¸­çœŸå®çš„å†…å­˜å¤§å°æˆ–è€… QEMU è™šæ‹Ÿæœºä¸­åˆ†é…çš„å†…å­˜å¤§å°ï¼Œå¦‚åœ¨ QEMU è™šæ‹Ÿæœºå¯åŠ¨å‚æ•°ä¸­æŒ‡å®šå†…å­˜å¤§å°ä¸º 1GB è¿›å…¥ QEMU è™šæ‹Ÿæœºåå‘ç° MemTotal ä¸ºâ€œ99984KB"ã€‚è¿™æ˜¯å› ä¸ºå†…æ ¸é™æ€ä½¿ç”¨çš„å†…å­˜ï¼ˆå¦‚å†…æ ¸ä»£ç ç­‰ï¼‰åœ¨å¯åŠ¨é˜¶æ®µéœ€è¦ç”¨åˆ°ï¼Œå®ƒæ²¡æœ‰è®¡å…¥ MemTotal ç»Ÿè®¡é¡¹ä¸­ï¼Œè€Œæ˜¯ç»Ÿè®¡åˆ° reserved ä¸­ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè®¡ç®—æœºçš„å†…æ ¸å¯åŠ¨æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[0.000000] Memory: 929640K/1048576K available(23228K kernel code, 1090K rwdata, 3872K rodata, 4608K init, 503K bss, 53400K reserved, 65536K cma-reserved)</span><br><span class="line">[8.910031] Freeing unused kernel memory: 4608K</span><br></pre></td></tr></tbody></table></figure><p>ä»ä¸Šè¿°å†…æ ¸æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¯åŠ¨åˆå§‹åŒ–æ—¶æœ‰ 53400 å¤§å°çš„å†…å®¹è¢«ä¿ç•™äº†ï¼Œç”¨äºå†…æ ¸ä»£ç ç­‰ã€‚åœ¨å†…æ ¸åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œinit æ®µçš„å†…å­˜ä¼šè¢«é‡Šæ”¾ï¼Œå› æ­¤è¢«ä¿ç•™çš„å†…å­˜å¤§å°ä¸º 53400KB-4608KB=48792KBï¼ŒåŠ ä¸Š MemTotal æ­£å¥½æ˜¯ 1GB å†…å­˜</p><h2 id="memavailable-ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ„æ€">MemAvailable ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h2><p>MemavAilable è¡¨ç¤ºç³»ç»Ÿä¸­æœ‰å¤šå°‘å¯ä»¥åˆ©ç”¨çš„å†…å­˜ï¼Œè¿™äº›å†…å­˜ä¸åŒ…æ‹¬äº¤æ¢åˆ†åŒºã€‚ MemAvailable çš„è®¡ç®—å’Œ MemFreeã€å¯å›æ”¶çš„ slab é¡µé¢ã€å†…å®¹é¡µé¢ä»¥åŠæ¯ä¸ªå†…å­˜ç®¡ç†åŒºçš„æœ€ä½æ°´ä½ç­‰æœ‰å¯†åˆ‡å…³ç³»ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-sab-åˆ†é…å™¨è¦åŒºåˆ†-sreclaimable-å’Œ-sunreclaim">ä¸ºä»€ä¹ˆ sab åˆ†é…å™¨è¦åŒºåˆ† SReclaimable å’Œ SUnreclaim</h2><p>ä¸€ä¸ª slab åˆ†é…å™¨ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿ç»­çš„ç‰©ç†é¡µé¢ç»„æˆã€‚åœ¨ä¸º slab åˆ†é…å™¨åˆ†é…ç‰©ç†é¡µé¢æ—¶æ ¹æ® slab æè¿°ç¬¦ï¼ˆ cache-&gt;flagsï¼‰æ˜¯å¦è®¾ç½®äº† SLAB_RECLAIM_ACCOUNT æ ‡å¿—ä½æ¥åˆ¤æ–­è¿™äº›é¡µé¢æ˜¯å±äº SReclaimable è¿˜æ˜¯å±äº SUnreclaim.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/slab.c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">kmem_getpages</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (cachep-&gt;flags &amp; SLAB_RECLAIM_ACCOUNT)</span><br><span class="line">        mod_lruvec_page_state(page, NR_SLAB_RECLAIMABLE, nr_pages);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE, nr_pages);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è€Œåœ¨åˆ›å»º sab æè¿°ç¬¦æ—¶è‹¥å‘ç°è®¾ç½®äº† SLAB_RECLAIM_ACCOUNTï¼Œé‚£ä¹ˆåˆ†é…ç‰©ç†é¡µé¢çš„è¡Œä¸ºå°±æ˜¯å¯å›æ”¶çš„ï¼Œå³è®¾ç½® __GFP_RECLAIMABLEï¼Œè¡¨ç¤ºè¿™äº›é¡µé¢æ˜¯å¯ä»¥è¢« sab æœºåˆ¶çš„æ”¶å‰²æœºå›æ”¶çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/slab.c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __kmem_cache_create(<span class="keyword">struct</span> kmem_cache *cachep, <span class="type">slab_flags_t</span> flags)</span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; SLAB_RECLAIM_ACCOUNT)</span><br><span class="line">        cachp-&gt;allocflags |= __GFP_RECLAIMABLE;</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å› æ­¤ï¼Œè¿™äº› slb åˆ†é…å™¨çš„é¡µé¢çš„è¿ç§»ç±»å‹æ˜¯ MIGRATE_RECLAIMABLEã€‚åœ¨é¡µé¢å›æ”¶æœºä¸­ä¼šè°ƒç”¨ slab æ”¶å‰²æœºçš„å›è°ƒå‡½æ•°ï¼ˆ shrinker-&gt;scan_objectsï¼‰æ¥å›æ”¶ä¸€äº› slab å¯¹è±¡ï¼Œä½†æ˜¯åœ¨ scan_objects å›è°ƒå‡½æ•°çš„å®ç°ä¸­å¹¶æ²¡æœ‰åˆ¤æ–­å“ªäº› slab åˆ†é…å™¨çš„é¡µé¢è®¾ç½®äº†__GFP_RECLAIMABLEï¼Œå“ªäº›é¡µé¢æ²¡æœ‰è®¾ç½®__GFP_RECLAIMABLEã€‚åœ¨ slab æœºåˆ¶é‡Œï¼Œæœ‰ä¸€ä¸ªå®šæ—¶å™¨ä¼šå®šæ—¶æ‰«æå’Œæ£€æŸ¥å“ªäº› slab åˆ†é…å™¨å¯ä»¥è¢«é”€æ¯ï¼Œå¦‚æœä¸€ä¸ª slab åˆ†é…å™¨ä¸­éƒ½æ˜¯ç©ºé—²çš„ slab å¯¹è±¡é‚£ä¹ˆè¿™ä¸ª slab åˆ†é…å™¨å°±å¯ä»¥è¢«å›æ”¶ï¼Œå¹¶ä¸” slab åˆ†é…å™¨å ç”¨çš„é¡µé¢ä¼šè¢«é‡Šæ”¾ï¼Œè§ cache_reap() æ•°ã€‚å› æ­¤ï¼Œç»Ÿè®¡ SReclaimable å’Œ SUnreclaim é¡µé¢çš„å«ä¹‰æ˜¯åœ¨äºè®¡ç®—ç³»ç»Ÿå¯ç”¨çš„æ€»å†…å­˜æ•° meminfo ä¸­çš„ MemAvailableï¼Œè¯¦è§ si_mem_available() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/page_alloc.c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">si_mem_available</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    reclaimable = global_node_page_state(NR_SLAB_RECLAIMABLE) +</span><br><span class="line">        global_node_page_state(NR_KERNEL_MISC_RECLAIMABLE);</span><br><span class="line">    available += reclaimable  - min(reclaimable / <span class="number">2</span>, wmar_low);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> available;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸ºä»€ä¹ˆ-activeanon-nactiveanonä¸ç­‰äº-anonpages">ä¸ºä»€ä¹ˆ Activeï¼ˆanonï¼‰+ nactiveï¼ˆanonï¼‰ä¸ç­‰äº Anonpages</h2><p>æˆ‘ä»¬çŸ¥é“ Activeï¼ˆanonï¼‰è¡¨ç¤º LRU é“¾è¡¨ä¸­çš„æ´»è·ƒåŒ¿åé¡µé¢ï¼Œ Inactiveï¼ˆanonï¼‰è¡¨ç¤ºä¸æ´»è·ƒåŒ¿åé¡µé¢ï¼Œè¿™ä¸¤ä¸ªå€¼ç›¸åŠ ï¼Œè¡¨ç¤ºç³»ç»Ÿçš„ LRU é“¾è¡¨ä¸­çš„æ€»åŒ¿åé¡µé¢æ•°é‡ã€‚è€Œ AnonPages è¡¨ç¤ºå’Œç”¨æˆ·æ€è¿›ç¨‹åœ°å€ç©ºé—´å»ºç«‹æ˜ å°„å…³ç³»ã€‚å½“ä¸€ä¸ªåŒ¿åé¡µé¢å’Œè¿›ç¨‹åœ°å€ç©ºé—´å»ºç«‹æ˜ å°„å…³ç³»æ—¶ä¼šè°ƒç”¨ page_add_new_anon_mmap() å‡½æ•°æ¥æ–°å¢ä¸€ä¸ª RMAPã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">page_add_new_anon_rmap</span> <span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    __mod_node_page_state(page_pgdat(page), NR_ANON_MAPPED, nr);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯ shmemï¼ˆåŸºäº tmpfs å®ç°ï¼‰ä½¿ç”¨çš„é¡µé¢ä¼šè¢«æ·»åŠ åˆ°ç³»ç»Ÿçš„åŒ¿åé¡µé¢çš„ LRU é“¾è¡¨ä¸­å› æ­¤å®ƒä¼šè¢«è®¡å…¥ Activeï¼ˆanonï¼‰æˆ–è€… Inactiveï¼ˆanonï¼‰ä¹‹ä¸­ã€‚ä¸»è¦åŸå› æ˜¯ shmem ä½¿ç”¨çš„é¡µé¢åŸºäº RAM å†…å­˜ï¼Œå®ƒå¯ä»¥è¢«å†™å…¥äº¤æ¢åˆ†åŒºé‡Œã€‚åœ¨åˆ†é… shmem é¡µé¢æ—¶è®¾ç½®äº† PG_SwapBacked æ ‡å¿—ä½ï¼Œè§ shmem_alloc_and_acct_page() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">shmem_alloc_and_acct_page</span> <span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    page =shmem_alloc_page(gfp, info, index);</span><br><span class="line">    __SetPageLocked(page);</span><br><span class="line">    __SetPageSwapbacd(page);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡åˆ¤æ–­ PG_SwapBacked æ ‡å¿—ä½æ¥å®šå°†é¡µé¢åŠ åˆ°åé¡µé¢çš„ LRU é“¾è¡¨ä¸­è¿˜æ˜¯æ–‡ä»¶æ˜ å°„çš„ LRU é“¾è¡¨ä¸­ï¼Œè§ page_is_file_cache() å‡½æ•°ã€‚è‹¥æ²¡æœ‰è®¾ç½® PG_SwapBacked æ ‡å¿—ä½ï¼Œåˆ™é¡µé¢æ˜¯æ–‡ä»¶æ˜ å°„çš„é¡µé¢ï¼Œä¼šè¢«æ·»åŠ åˆ°æ–‡ä»¶æ˜ å°„çš„ LRU é“¾è¡¨ä¸­å¦åˆ™ï¼Œè¢«æ·»åŠ åˆ°åé¡µé¢çš„ LRU é“¾è¡¨ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">page_is_file_cache</span><span class="params">(<span class="keyword">struct</span> page * page)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> !PageSwapBacked(page);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦å¤–ï¼Œ shmem é¡µé¢å¹¶æ²¡æœ‰è®¡å…¥ Anonpages ä¸­ï¼Œè€Œæ˜¯è®¡å…¥äº† MM_SHMEMPAGES ç±»å‹çš„è®¡æ•°å€¼ï¼ˆå³ Shmemï¼‰ä¸­ï¼Œè§ do_shared_fault()-&gt;finish_fault()-&gt;alloc_set_pte() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vm_fault_t</span> <span class="title function_">alloc_set_pte</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    inc_mm_counter_fast(vma-&gt;vm_mm, mm_counter_file(page));</span><br><span class="line">    page_add_file_rmap(page, <span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ page_add_file_rmap() ä¸­ä¼šæŠŠè¿™ä¸ªé¡µé¢è®¡å…¥ NR_FILE_MAPPED è®¡æ•°å€¼ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">page_add_file_rmap</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    mod_lruvec_page_state(page, NR_FILE_MAPPED, nr);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æ€»ä¹‹ï¼Œ shmem é¡µé¢ä¸€æ–¹é¢è¢«æ·»åŠ åˆ°äº†ç½®åé¡µé¢çš„ LRU é“¾è¡¨é‡Œï¼Œå¦ä¸€æ–¹é¢è¢«ç»Ÿè®¡åˆ°æ–‡ä»¶æ˜ å°„é¡µé¢çš„è®¡æ•°ä¸­ï¼ŒçœŸæ˜¯ä¸ªâ€œå¦ç±»çš„â€é¡µé¢ã€‚</p><h2 id="ä¸ºä»€ä¹ˆ-activefile-inactivefile-ä¸ç­‰äº-mapped">ä¸ºä»€ä¹ˆ Activeï¼ˆfile) + Inactiveï¼ˆfile) ä¸ç­‰äº Mapped?</h2><p>Activeï¼ˆfileï¼‰+ nactive(file) è¡¨ç¤ºç³»ç»Ÿ LRU é“¾è¡¨ä¸­æ‰€æœ‰æ–‡ä»¶æ˜ å°„é¡µé¢çš„æ€»å’Œï¼Œè€Œ Mapped è¡¨ç¤ºç»Ÿè®¡æ‰€æœ‰æ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´çš„å†…å®¹ç¼“å­˜é¡µé¢ï¼Œç”± NR_FILE_MAPPED æ¥ç»Ÿè®¡ã€‚å½“ä¸€ä¸ªå†…å®¹ç¼“å­˜æ˜ å°„åˆ°ç”¨æˆ·æ€çš„è¿›ç¨‹åœ°å€ç©ºé—´æ—¶ï¼Œä¼šè°ƒç”¨ page_add_file_map() å‡½æ•°æ¥å»ºç«‹ RMAPï¼Œå¹¶å¢åŠ  NR_FILE_MAPPED è®¡æ•°å€¼ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">page_add_file_rmap</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    __mod_lruvec_page_state(page, NR_FILE_MAPPED, nr);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µéœ€è¦è€ƒè™‘ï¼Œå°±æ˜¯ shmem é¡µé¢ã€‚å®ƒä¼šè¢«è®¡å…¥ NR_FILE_MAPPED è®¡æ•°å€¼ä¸­ä½†æ˜¯å®ƒä¼šè®¾ç½® PG_SwapBacked æ ‡å¿—ä½ï¼Œå› æ­¤å®ƒä¼šè¢«è®¡å…¥åŒ¿åé¡µé¢ã€‚ å½“åˆ›å»ºä¸€ä¸ª shmem é¡µé¢æ—¶ä¼šæŠŠå®ƒè®¡å…¥ NR_FILE_PAGES å’Œ NR_SHMEM è®¡æ•°å€¼ä¸­ï¼Œè§ shmem_add_to_page_cache() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">shmem_add_to_page_cache</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    __mod_node_page_state(page_pgdat(page), NR_FILE_PAGES, nr);</span><br><span class="line">    __mod_node_page_state(page_pgdat(page), NR_SHMEM, nr);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸ºä»€ä¹ˆ-activefile-inactivefileä¸ç­‰äº-cached">ä¸ºä»€ä¹ˆ Activeï¼ˆfileï¼‰+ Inactiveï¼ˆfileï¼‰ä¸ç­‰äº Cachedï¼Ÿ</h2><p>Cached è®¡æ•°å€¼çš„è®¡ç®—å…¬å¼æ˜¯ Cached = NR_FILE_PAGES - swap_cache - Buffersã€‚ä½†æ˜¯ shmem é¡µé¢è¢«è®¡å…¥ NR_FILE_PAGES é‡Œï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿåœ¨åŒ¿åé¡µé¢ LRU é“¾è¡¨çš„è®¡æ•°å€¼é‡Œ Active(file) + Inactiveï¼ˆfileï¼‰è¡¨ç¤ºç³»ç»Ÿçš„ LRU é“¾è¡¨ä¸­æ‰€æœ‰æ–‡ä»¶æ˜ å°„é¡µé¢çš„æ€»å’Œï¼Œå› æ­¤ LRU è¡¨æ‰€æœ‰æ–‡ä»¶æ˜ å°„é¡µé¢æ€»å’Œä¸ç­‰äº Cached è®¡æ•°å€¼ã€‚</p><h1 id="ä¼™ä¼´ç³»ç»Ÿä¿¡æ¯">ä¼™ä¼´ç³»ç»Ÿä¿¡æ¯</h1><p>/proc/buddyinfo èŠ‚ç‚¹åŒ…å«å½“å‰ç³»ç»Ÿçš„ä¼™ä»¶ç³»ç»Ÿç®€è¦ä¿¡æ¯ è€Œ proc/pagetypeinfo èŠ‚ç‚¹åˆ™åŒ…å«å½“å‰ç³»ç»Ÿçš„ä¼™ä¼´ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ä¸ªè¿ç§»ç±»å‹å’Œæ¯ä¸ªé“¾è¡¨çš„æˆå‘˜æ•°é‡ç­‰ã€‚å½“å‰ç³»ç»Ÿåªæœ‰ä¸€ä¸ª DMA32 çš„å†…å­˜ç®¡ç†åŒºï¼Œæ”¯æŒçš„è¿ç§»ç±»å‹æœ‰ Unmovableã€ Movableã€Reclaimableã€ HighAtomicã€CMA ä»¥åŠ Isolate ç­‰è¿ç§»ç±»å‹ï¼Œå…¶ä¸­é¡µé¢æ•°é‡æœ€å¤šçš„è¿ç§»ç±»å‹æ˜¯ Movable ç±»å‹ã€‚è¿ç§»ç±»å‹çš„æœ€å°çš„å•ä½æ˜¯é¡µå—ï¼Œåœ¨ ARM64 æ¶æ„ä¸­ï¼Œé¡µå—çš„å¤§å°æ˜¯ 2MBï¼Œå³ order ä¸º 9 å…¶ä¸­ä¸€å…±æœ‰ 512 ä¸ªé¡µé¢ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/home/vooxle/workspace/blog<span class="comment"># cat /proc/pagetypeinfo</span></span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>    Unmovable      1      1      0      0      2      1      1      0      1      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Movable      0      0      0      0      0      0      0      0      0      1      3</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>  Reclaimable      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>   HighAtomic      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>    Unmovable      1      0      0      0      0      0      1      1      1      1      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Movable      9      5      5      5      4      6      6      5      5      3    459</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>  Reclaimable      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>   HighAtomic      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>    Unmovable      1    499    477    515    204     39     28      5      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Movable   8557  24298  10230   7542   2723    231    664    257    371     94   3641</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>  Reclaimable      8      1     62     35     38     12      0      1      0      1      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>   HighAtomic      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable      Movable  Reclaimable   HighAtomic          CMA      Isolate</span><br><span class="line">Node 0, zone      DMA            1            7            0            0            0            0</span><br><span class="line">Node 0, zone    DMA32            2         1014            0            0            0            0</span><br><span class="line">Node 0, zone   Normal          394        14596          370            0            0            0</span><br></pre></td></tr></tbody></table></figure><p>è¯»è€…éœ€è¦æ³¨æ„ï¼Œé¡µå—çš„å¤§å°å’Œæ™®é€šå·¨é¡µæœ‰å…³ã€‚å½“ç³»ç»Ÿé…ç½®äº† CONFIG_HUGETLB_PAGE æ—¶ï¼Œé¡µå—çš„ order å¤§å°ç­‰äº HUGETLB_PAGE_ORDERï¼Œé€šå¸¸æ˜¯ 9ï¼šå¦åˆ™ï¼Œé¡µå—çš„ order å¤§å°æ˜¯ 10ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HUGETLB_PAGE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pageblock_order HUGETLB_PAGE_ORDER</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pageblock_order (MAX_ORDER-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><h2 id="æŸ¥çœ‹å†…å­˜ç®¡ç†åŒºçš„ä¿¡æ¯">æŸ¥çœ‹å†…å­˜ç®¡ç†åŒºçš„ä¿¡æ¯</h2><p>/proc/zoneinfo èŠ‚ç‚¹åŒ…å«å½“å‰ç³»ç»Ÿæ‰€æœ‰å†…å­˜ç®¡ç†åŒºçš„ä¿¡æ¯ã€‚/proc/zoneinfo èŠ‚ç‚¹æ˜¯æ˜¾ç¤ºå¦‚ä¸‹å‡ éƒ¨åˆ†ä¿¡æ¯ã€‚</p><h4 id="å½“å‰å†…å­˜èŠ‚ç‚¹çš„å†…å­˜ç»Ÿè®¡ä¿¡æ¯">å½“å‰å†…å­˜èŠ‚ç‚¹çš„å†…å­˜ç»Ÿè®¡ä¿¡æ¯</h4><p>ä¸‹é¢æ˜¯/proc/zoneinfo èŠ‚ç‚¹çš„ç¬¬ä¸€éƒ¨åˆ†ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/home/vooxle/workspace/blog<span class="comment"># cat /proc/zoneinfo</span></span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  per-node stats</span><br><span class="line">      nr_inactive_anon 157</span><br><span class="line">      nr_active_anon 31943</span><br><span class="line">      nr_inactive_file 1209487</span><br><span class="line">      nr_active_file 1968292</span><br><span class="line">      nr_unevictable 0</span><br><span class="line">      ...</span><br><span class="line">      nr_kernel_misc_reclaimable 0</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ç¬¬ 2 è¡Œä¸­ï¼Œè¡¨ç¤ºå½“å‰å†…å­˜èŠ‚ç‚¹æ˜¯ç¬¬ 0 ä¸ªå†…å­˜èŠ‚ç‚¹ï¼Œå½“å‰å†…å­˜ç®¡ç†åŒºä¸º DMAã€‚ åœ¨ç¬¬ 3 è¡Œä¸­ï¼Œè¡¨ç¤ºä¸‹é¢æ˜¯è¯¥å†…å­˜èŠ‚ç‚¹çš„æ€»ä½“ä¿¡æ¯ã€‚å¦‚æœå½“å‰å†…å­˜ç®¡ç†åŒºæ˜¯å†…å­˜èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºï¼Œé‚£ä¹ˆä¼šæ˜¾ç¤ºè¯¥å†…å­˜èŠ‚ç‚¹çš„æ€»ä¿¡æ¯ã€‚å®ƒé€šè¿‡ node_page_state() å‡½æ•°æ¥è¯»å–å†…å­˜èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ plist_data ä¸­çš„ vm_stat è®¡æ•°å€¼ã€‚ ä¸Šè¿°ä¿¡æ¯æ˜¯åœ¨ zoneinfo_show_print() å‡½æ•°ä¸­è¾“å‡ºçš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/vmstat.c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">zoneinfo_show_print</span><span class="params">(<span class="keyword">struct</span> seq_file * m, <span class="type">pg_data_t</span> *pgdat,</span></span><br><span class="line"><span class="params">                                <span class="keyword">struct</span> zone *zone)</span></span><br></pre></td></tr></tbody></table></figure><h4 id="å½“å‰å†…å­˜ç®¡ç†åŒºçš„æ€»ä¿¡æ¯ä¸‹é¢ç»§ç»­çœ‹proczoneinfo-èŠ‚ç‚¹çš„ä¿¡æ¯">å½“å‰å†…å­˜ç®¡ç†åŒºçš„æ€»ä¿¡æ¯ä¸‹é¢ç»§ç»­çœ‹/proc/zoneinfo èŠ‚ç‚¹çš„ä¿¡æ¯</h4><p>ä¸‹é¢ç»§ç»­çœ‹/proc/zoneinfo èŠ‚ç‚¹çš„ç¬¬äºŒéƒ¨åˆ†ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pages free     3971</span><br><span class="line">      min      8</span><br><span class="line">      low      11</span><br><span class="line">      high     14</span><br><span class="line">      spanned  4095</span><br><span class="line">      present  3999</span><br><span class="line">      managed  3971</span><br><span class="line">      protection: (0, 1776, 31892, 31892, 31892)</span><br></pre></td></tr></tbody></table></figure><ul><li>pages free: è¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­ç©ºé—²é¡µé¢çš„æ•°é‡</li><li>minï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­å¤„äºæœ€ä½è­¦æˆ’æ°´ä½çš„é¡µé¢æ•°é‡</li><li>lowï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­å¤„äºä½æ°´ä½çš„é¡µé¢æ•°é‡</li><li>highï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­å¤„äºé«˜æ°´ä½çš„é¡µé¢æ•°é‡</li><li>spannedï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºåŒ…å«çš„é¡µé¢æ•°é‡</li><li>presentï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºé‡Œå®é™…ç®¡ç†é¡µé¢çš„æ•°é‡</li><li>managedï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºä¸­è¢«ä¼™ä¼´ç³»ç»Ÿç®¡ç†çš„é¡µé¢æ•°é‡</li><li>protectionï¼šè¡¨ç¤ºè¿™ä¸ªå†…å­˜ç®¡ç†åŒºé¢„ç•™çš„å†…å­˜</li></ul><h3 id="å†…å­˜ç®¡ç†åŒºè¯¦ç»†çš„é¡µé¢ä¿¡æ¯">å†…å­˜ç®¡ç†åŒºè¯¦ç»†çš„é¡µé¢ä¿¡æ¯</h3><p>æ¥ä¸‹æ¥æ˜¯å†…å­˜ç®¡ç†åŒºè¯¦ç»†çš„é¡µé¢ä¿¡æ¯/proc/zoneinfo èŠ‚ç‚¹çš„ç¬¬ä¸‰éƒ¨åˆ†ä¿¡æ¯</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">nr_free_pages 3971</span><br><span class="line">nr_zone_inactive_anon 0</span><br><span class="line">nr_zone_active_anon 0</span><br><span class="line">nr_zone_inactive_file 0</span><br><span class="line">nr_zone_active_file 0</span><br><span class="line">nr_zone_unevictable 0</span><br><span class="line">nr_zone_write_pending 0</span><br><span class="line">nr_mlock     0</span><br><span class="line">nr_page_table_pages 0</span><br><span class="line">nr_kernel_stack 0</span><br><span class="line">nr_bounce    0</span><br><span class="line">nr_zspages   0</span><br><span class="line">nr_free_cma  0</span><br><span class="line">numa_hit     0</span><br><span class="line">numa_miss    0</span><br><span class="line">numa_foreign 0</span><br><span class="line">numa_interleave 0</span><br><span class="line">numa_local   0</span><br><span class="line">numa_other   0</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°æ˜¯è¿™ä¸ªå†…å­˜ç®¡ç†åŒºè¯¦ç»†çš„é¡µé¢ä¿¡æ¯ã€‚å®ƒé€šè¿‡ zone_page_state() å‡½æ•°æ¥è¯»å– zone æ•°æ®ç»“æ„ä¸­çš„ vm_stat è®¡æ•°å€¼ã€‚</p><h4 id="æ¯ä¸ª-cpu-å†…å­˜åˆ†é…å™¨çš„ä¿¡æ¯">æ¯ä¸ª CPU å†…å­˜åˆ†é…å™¨çš„ä¿¡æ¯</h4><p>æœ€åæ˜¯æ¯ä¸ª C å†…å­˜åˆ†é…å™¨çš„/proc/zonelnfã€‚èŠ‚ç‚¹çš„ç¬¬å››éƒ¨åˆ†ä¿¡æ¯</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pagesets</span><br><span class="line">  cpu: 0</span><br><span class="line">            count: 0</span><br><span class="line">            high:  0</span><br><span class="line">            batch: 1</span><br><span class="line">vm stats threshold: 12</span><br><span class="line">  cpu: 1</span><br><span class="line">            count: 0</span><br><span class="line">            high:  0</span><br><span class="line">            batch: 1</span><br><span class="line">  ...</span><br><span class="line">vm stats threshold: 12</span><br><span class="line">node_unreclaimable:  0</span><br><span class="line">start_pfn:           1</span><br></pre></td></tr></tbody></table></figure><ul><li>pagesetsï¼šè¡¨ç¤ºæ¯ä¸ª CPU å†…å­˜åˆ†é…å™¨ä¸­æ¯ä¸ª CPU ç¼“å­˜çš„é¡µé¢ä¿¡æ¯ã€‚</li><li>node_unreclaimableï¼šè¡¨ç¤ºé¡µé¢å›æ”¶å¤±è´¥çš„æ¬¡æ•°ã€‚</li><li>start_pfnï¼šè¡¨ç¤ºå†…å­˜ç®¡ç†åŒºçš„èµ·å§‹é¡µå¸§å·</li></ul><h2 id="æŸ¥çœ‹ä¸è¿›ç¨‹ç›¸å…³çš„å†…å­˜ä¿¡æ¯">æŸ¥çœ‹ä¸è¿›ç¨‹ç›¸å…³çš„å†…å­˜ä¿¡æ¯</h2><p>è¿›ç¨‹çš„ mm_struct æ•°æ®ç»“æ„ä¸­æœ‰ä¸€ä¸ª rss_stat æˆå‘˜ï¼Œå®ƒç”¨äºè®°å½•è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When updating this, please also update struct resident_page_types[] in</span></span><br><span class="line"><span class="comment"> * kernel/fork.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> {</span></span><br><span class="line">MM_FILEPAGES,<span class="comment">/* Resident file mapping pages */</span></span><br><span class="line">MM_ANONPAGES,<span class="comment">/* Resident anonymous pages */</span></span><br><span class="line">MM_SWAPENTS,<span class="comment">/* Anonymous swap entries */</span></span><br><span class="line">MM_SHMEMPAGES,<span class="comment">/* Resident shared memory pages */</span></span><br><span class="line">NR_MM_COUNTERS</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_SPLIT_PTE_PTLOCKS &amp;&amp; defined(CONFIG_MMU)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPLIT_RSS_COUNTING</span></span><br><span class="line"><span class="comment">/* per-thread cached information, */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_rss_stat</span> {</span></span><br><span class="line"><span class="type">int</span> events;<span class="comment">/* for synchronization threshold */</span></span><br><span class="line"><span class="type">int</span> count[NR_MM_COUNTERS];</span><br><span class="line">};</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* USE_SPLIT_PTE_PTLOCKS */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_rss_stat</span> {</span></span><br><span class="line"><span class="type">atomic_long_t</span> count[NR_MM_COUNTERS];</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span></span></span><br></pre></td></tr></tbody></table></figure><p>è¿›ç¨‹çš„ mm_struct æ•°æ®ç»“æ„ä¼šè®°å½•ä¸‹é¢ 4 ç§é¡µé¢çš„æ•°é‡</p><ul><li>MM_FILEPAGESï¼šè¿›ç¨‹ä½¿ç”¨çš„æ–‡ä»¶æ˜ å°„çš„é¡µé¢æ•°é‡ã€‚</li><li>MM_ANONPAGESï¼šè¿›ç¨‹ä½¿ç”¨çš„åŒ¿åé¡µé¢æ•°é‡ã€‚</li><li>MM_SWAPENTSï¼šè¿›ç¨‹ä½¿ç”¨çš„äº¤æ¢åˆ†åŒºçš„åŒ¿åé¡µé¢æ•°é‡</li><li>MM_SHMEMPAGESï¼šè¿›ç¨‹å…±äº«çš„å†…å­˜çš„é¡µé¢æ•°é‡</li></ul><p>å¢åŠ å’Œå‡å°è¿›ç¨‹å†…å­˜è®¡æ•°çš„æ¥å£å‡½æ•°æœ‰å¦‚ä¸‹å‡ ä¸ªã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#è·å– member è®¡æ•°å€¼</span><br><span class="line">unsigned long get_mm_counter(struct mm_struct *mm, int member)</span><br><span class="line"># ä½¿ member è®¡æ•°å€¼å¢åŠ  value</span><br><span class="line">void add_mm_counter(struct mm_struct *mm, int member, long value)</span><br><span class="line">#ä½¿ member è®¡æ•°å€¼å¢åŠ  1</span><br><span class="line">void inc_mm_counter(struct mm_struct *mm, int member)</span><br><span class="line">#ä½¿ member è®¡æ•°å€¼å‡å° 1</span><br><span class="line">roid dec_mm_counter(struct mm_struct *mm, int member)</span><br><span class="line">#å½“ page ä¸æ˜¯åŒ¿åé¡µé¢æ—¶ï¼Œè‹¥ page è®¾ç½®äº† PageSwapbackedï¼Œé‚£ä¹ˆè¿”å› MM_SHMEMPAGESï¼Œå¦åˆ™è¿”å› MM_EILEPAGES</span><br><span class="line">int mm_counter_file(struct page *page)</span><br><span class="line">#è¿”å› page å¯¹åº”çš„ç»Ÿè®¡ç±»å‹</span><br><span class="line">int mm_counter(struct page *page)</span><br></pre></td></tr></tbody></table></figure><p>proc æ–‡ä»¶ç³»ç»ŸåŒ…å«æ¯ä¸ªè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼Œå…¶ä¸­ /proc/PID/status èŠ‚ç‚¹æœ‰ä¸å°‘å’Œå…·ä½“è¿›ç¨‹å†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ sshd çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œåªæˆªå–äº†å’Œå†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/proc/2<span class="comment"># cat status</span></span><br><span class="line">Name:kthreadd</span><br><span class="line">Umask:0000</span><br><span class="line">State:S (sleeping)</span><br><span class="line">Tgid:2</span><br><span class="line">Ngid:0</span><br><span class="line">Pid:2</span><br><span class="line">PPid:0</span><br><span class="line">TracerPid:0</span><br><span class="line">Uid:0000</span><br><span class="line">Gid:0000</span><br><span class="line">FDSize:64</span><br><span class="line">Groups:</span><br><span class="line">NStgid:2</span><br><span class="line">NSpid:2</span><br><span class="line">NSpgid:0</span><br><span class="line">NSsid:0</span><br><span class="line">Threads:1</span><br><span class="line">SigQ:0/127633</span><br><span class="line">SigPnd:0000000000000000</span><br><span class="line">ShdPnd:0000000000000000</span><br><span class="line">SigBlk:0000000000000000</span><br><span class="line">SigIgn:ffffffffffffffff</span><br><span class="line">SigCgt:0000000000000000</span><br><span class="line">CapInh:0000000000000000</span><br><span class="line">CapPrm:0000003fffffffff</span><br><span class="line">CapEff:0000003fffffffff</span><br><span class="line">CapBnd:0000003fffffffff</span><br><span class="line">CapAmb:0000000000000000</span><br><span class="line">NoNewPrivs:0</span><br><span class="line">Seccomp:0</span><br><span class="line">Speculation_Store_Bypass:thread vulnerable</span><br><span class="line">Cpus_allowed:ffff,ffffffff</span><br><span class="line">Cpus_allowed_list:0-47</span><br><span class="line">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">Mems_allowed_list:0</span><br><span class="line">voluntary_ctxt_switches:3335</span><br><span class="line">nonvoluntary_ctxt_switches:0</span><br></pre></td></tr></tbody></table></figure><ul><li>Nameï¼šè¿›ç¨‹çš„åç§°</li><li>Pid:PIDã€‚</li><li>VmPeakï¼šè¿›ç¨‹ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ï¼Œé€šå¸¸æƒ…å†µä¸‹å®ƒç­‰äºè¿›ç¨‹çš„å†…å­˜æè¿°ç¬¦ mm ä¸­çš„ total_vm</li><li>VmSizeï¼šè¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œå®ƒç­‰äº mm-&gt;total_vm</li><li>VmLckï¼šè¿›ç¨‹é”ä½çš„å†…å­˜ï¼Œå®ƒç­‰äº m-&gt;locked_vmï¼Œè¿™é‡ŒæŒ‡ä½¿ç”¨ mlock() é”ä½çš„å†…å­˜ã€‚</li><li>VmPinï¼šè¿›ç¨‹å›ºå®šä½çš„å†…å­˜ï¼Œå®ƒç­‰äº mm-&gt;pinned_vmï¼Œè¿™é‡ŒæŒ‡ä½¿ç”¨ get_user_page() å›ºå®šä½çš„å†…å­˜ã€‚</li><li>VmHWMï¼šè¿›ç¨‹ä½¿ç”¨çš„æœ€å¤§ç‰©ç†å†…å­˜ï¼Œå®ƒé€šå¸¸ç­‰äºè¿›ç¨‹ä½¿ç”¨çš„åŒ¿åé¡µé¢ã€æ–‡ä»¶æ˜ å°„é¡µé¢ä»¥åŠå…±äº«å†…å­˜é¡µé¢çš„å¤§å°æ€»å’Œ</li><li>VmRSSï¼šè¿›ç¨‹ä½¿ç”¨çš„æœ€å¤§ç‰©ç†å†…å­˜ï¼Œå®ƒå¸¸å¸¸ç­‰äº VmHWMï¼Œè®¡ç®—å…¬å¼ä¸º VmRSS = RssAnon + RssFile + RssShmem</li><li>RssAnonï¼šè¿›ç¨‹ä½¿ç”¨çš„åŒ¿åé¡µé¢ï¼Œé€šè¿‡ get_mm_counterï¼ˆmmï¼Œ MM_ANONPAGESï¼‰è·å–ã€‚</li><li>RssFileï¼šè¿›ç¨‹ä½¿ç”¨çš„æ–‡ä»¶æ˜ å°„é¡µé¢ï¼Œé€šè¿‡ get_mm_counterï¼ˆmmï¼Œ MM_FILEPAGESï¼‰è·å–</li><li>RssShmemï¼šè¿›ç¨‹ä½¿ç”¨çš„å…±äº«å†…å­˜é¡µé¢ï¼Œé€šè¿‡ get_mm_counterï¼ˆmmï¼Œ MM_SHMEMPAGESï¼‰è·å–ã€‚</li><li>VmDataï¼šè¿›ç¨‹ç§æœ‰æ•°æ®æ®µçš„å¤§å°ï¼Œå®ƒç­‰äº mm-&gt;data_vm</li><li>VmStkï¼šè¿›ç¨‹ç”¨æˆ·æ ˆçš„å¤§å°ï¼Œå®ƒç­‰äº mm-&gt;stack_vm</li><li>VmExeï¼šè¿›ç¨‹ä»£ç æ®µçš„å¤§å°ï¼Œé€šè¿‡å†…å­˜æè¿°ç¬¦ mm ä¸­çš„ start_code å’Œ end_code ä¸¤ä¸ªæˆå‘˜è·å–</li><li>VmLibï¼šè¿›ç¨‹å…±äº«åº“çš„å¤§å°ï¼Œé€šè¿‡å†…å­˜æè¿°ç¬¦ mm ä¸­çš„ exec_vm å’Œ VmExe è®¡ç®—ã€‚</li><li>VmPTEï¼šè¿›ç¨‹é¡µè¡¨å¤§å°ï¼Œé€šè¿‡å†…å­˜æè¿°ç¬¦ mm ä¸­çš„ pgtables_byes æˆå‘˜è·å–ã€‚</li><li>VmSwapï¼šè¿›ç¨‹ä½¿ç”¨çš„äº¤æ¢åˆ†åŒºçš„å¤§å°ï¼Œé€šè¿‡ get_mm_counter(mmï¼Œ MM_SWAPENTS) è·å–</li><li>HugetlbPagesï¼šè¿›ç¨‹ä½¿ç”¨å·¨é¡µçš„å¤§å°ï¼Œé€šè¿‡å†…å­˜æè¿°ç¬¦ mm ä¸­çš„ hugetlb_usage æˆå‘˜è·å–</li></ul><h2 id="ä¸ºä»€ä¹ˆ-s_swap-ä¸-p_swap-ä¸ç›¸ç­‰">ä¸ºä»€ä¹ˆ S_swap ä¸ P_swap ä¸ç›¸ç­‰</h2><p>proc/meminfo èŠ‚ç‚¹ä¸­ SwapTotal å‡å» SwapFree ç­‰äºç³»ç»Ÿä¸­å·²ç»ä½¿ç”¨çš„äº¤æ¢å†…å­˜å¤§å°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º S_swapã€‚å¦å¤–ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªå°ç¨‹åºæ¥éå†ç³»ç»Ÿä¸­æ‰€æœ‰çš„è¿›ç¨‹ï¼Œå¹¶æŠŠè¿›ç¨‹ä¸­ /proc/PID/status èŠ‚ç‚¹çš„ VmSwap å€¼éƒ½ç´¯åŠ èµ·æ¥ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º P_swapã€‚ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå€¼ä¸ç›¸ç­‰ï¼Ÿåœ¨ Linux å†…æ ¸ä¸­é€šè¿‡ si_mapinfo() å‡½æ•°æ¥æŸ¥çœ‹ S_swap çš„å€¼ï¼Œç”± nr_swap_pages å’Œ swap_info_struct ä¸­çš„ flags æ¥ç»Ÿè®¡ï¼Œè§ si_swapinfo() å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/swapfile. c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">si_swapinfo</span><span class="params">(<span class="keyword">struct</span> sysinfo *val)</span></span><br></pre></td></tr></tbody></table></figure><p>å½“ä¸€ä¸ªé¡µé¢éœ€è¦è¢«äº¤æ¢åˆ°äº¤æ¢åˆ†åŒºæ—¶ï¼Œå®ƒéœ€è¦åœ¨ kswapd å†…æ ¸çº¿ç¨‹ä¸­ç»å†æ´»è·ƒå’Œä¸æ´»è·ƒ LRU é“¾è¡¨è€åŒ–è¿‡ç¨‹ã€‚ä¸€ä¸ªé¡µé¢è¢«é€‰ä¸ºå€™é€‰äº¤æ¢é¡µé¢åï¼Œå®ƒéœ€è¦è°ƒç”¨ try_to_unmap_one() å‡½æ•°æ¥æ–­å¼€æ‰€æœ‰å’Œç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´æ˜ å°„çš„ PTEã€‚ try_to_unmap_one() å‡½æ•°çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static bool try_to_unmap_one()</span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    if (PageAnon(page)) {</span><br><span class="line">        dec_mm_counter(mm, MM_ANONPAGES);</span><br><span class="line">        inc_mm_counter(mm, MM_SWAPENTS);</span><br><span class="line">        swp_pte = swp_entry_to_pte(entry);</span><br><span class="line">        set_pte_at(mm, address, pvmw.pte, swp_pte);</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ try_to_unmap_one() å‡½æ•°ä¸­ï¼Œå¯¹äºåŒ¿åé¡µé¢ï¼Œä¼šå‡å°è¿›ç¨‹çš„ MM_ANONPAGES è®¡æ•°ï¼Œå¢åŠ  MM_SWAPENTS è®¡æ•°ï¼Œè¿™é‡Œé€šè¿‡ PageAnon() æ¥åˆ¤æ–­é¡µé¢æ˜¯å¦ä¸ºåŒ¿åé¡µé¢ã€‚ shmemï¼ˆå…±äº«å†…å­˜ï¼‰æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ˜¯åŸºäº tmpfs æ¥å®ç°çš„ï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯åŸºäº RAM çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤å®ƒå…·æœ‰æ–‡ä»¶çš„å±æ€§ï¼Œå¦‚æœ‰æ–‡ä»¶èŠ‚ç‚¹ã€é¡µé¢é«˜é€Ÿç¼“å­˜ç­‰ã€‚å¦å¤–ï¼Œå®ƒçš„å†…å®¹ä¸èƒ½éšä¾¿ä¸¢å¼ƒã€‚å½“ç³»ç»Ÿå†…å­˜çŸ­ç¼ºæ—¶ä¼šæŠŠ shmem æš‚æ—¶å†™å…¥äº¤æ¢åˆ†åŒºä»¥ä¾¿è…¾å‡ºå†…å­˜ï¼Œå› æ­¤å®ƒæœ‰éƒ¨åˆ†åŒ¿åé¡µé¢çš„å±æ€§ã€‚é‚£å®ƒç©¶ç«Ÿå±äºåŒ¿åé¡µé¢è¿˜æ˜¯æ–‡ä»¶æ˜ å°„é¡µé¢å‘¢ï¼Ÿ</p><p>åˆ›å»º shmem é¡µé¢æ—¶ï¼Œä½¿ç”¨ shmem_fault() å‡½æ•°ï¼Œå®ƒçš„ page-&gt;mmaping å­—æ®µæŒ‡å‘ inode-&gt;i_mappingï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•é€šè¿‡ PageAnon() æ¥åˆ¤å®šå®ƒæ˜¯å¦æ˜¯ä¼ ç»Ÿçš„åŒ¿åé¡µé¢ã€‚åœ¨ try_to_unmap_one() å‡½æ•°ä¸­ï¼Œ shmem é¡µé¢å¹¶æ²¡æœ‰è¢«ç»Ÿè®¡åˆ°è¿›ç¨‹çš„ MM_SWAPENTS è®¡æ•°ä¸­ï¼Œ/proc/PID/status èŠ‚ç‚¹ä¸­çš„ VmSwap ä¸åŒ…å«è¢«å†™å…¥äº¤æ¢åˆ†åŒºçš„ shmem é¡µé¢ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆåï¼‰KSM</title>
      <link href="/2021/LinuxKernel/LinuxMemoryKSM/"/>
      <url>/2021/LinuxKernel/LinuxMemoryKSM/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryKSM.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM4NjUyOGYzNDZmYjA3MjVmYjQ1YmI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>KSM æŒ‡ Kernel SamePage Mergingï¼Œå³å†…æ ¸åŒé¡µåˆå¹¶ï¼Œç”¨äºåˆå¹¶å†…å®¹ç›¸åŒçš„é¡µé¢ã€‚KSM çš„å‡ºç°æ˜¯ä¸ºäº†ä¼˜åŒ–è™šæ‹ŸåŒ–ä¸­äº§ç”Ÿçš„å†—ä½™é¡µé¢ã€‚ KSM å…è®¸åˆå¹¶åŒä¸€ä¸ªè¿›ç¨‹æˆ–ä¸åŒè¿›ç¨‹ä¹‹é—´å†…å®¹ç›¸åŒçš„åŒ¿åé¡µé¢ï¼Œè¿™å¯¹åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚æŠŠè¿™äº›ç›¸åŒçš„é¡µé¢åˆå¹¶æˆä¸€ä¸ªåªè¯»çš„é¡µé¢ï¼Œä»è€Œé‡Šæ”¾å‡ºå¤šä½™çš„ç‰©ç†é¡µé¢ï¼Œå½“åº”ç”¨ç¨‹åºéœ€è¦æ”¹å˜é¡µé¢å†…å®¹æ—¶ï¼Œä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ã€‚</p><h1 id="ä½¿èƒ½-ksm">ä½¿èƒ½ KSM</h1><p>KSM åªä¼šå¤„ç†é€šè¿‡ madvise ç³»ç»Ÿè°ƒç”¨æ˜¾å¼æŒ‡å®šçš„ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå› æ­¤ç”¨æˆ·ç¨‹åºæƒ³ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½å°±å¿…é¡»åœ¨åˆ†é…åœ°å€ç©ºé—´æ—¶æ˜¾å¼åœ°è°ƒç”¨ madviseï¼ˆaddrï¼Œlengthï¼ŒMADV_MERGEA BLEï¼‰ã€‚å¦‚æœç”¨æˆ·æƒ³åœ¨ KSM ä¸­å–æ¶ˆæŸä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´çš„åˆå¹¶åŠŸèƒ½ï¼Œä¹Ÿéœ€è¦æ˜¾å¼åœ°è°ƒç”¨ madviseï¼ˆaddrï¼Œlength,MADV_UNMERGEABLE)ã€‚ ä¸‹é¢æ˜¯æµ‹è¯• KSM çš„ test.c ç¨‹åºçš„ä»£ç ç‰‡æ®µï¼Œä½¿ç”¨ mmap()ï¼šæ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„ç§æœ‰æ˜ å°„ï¼Œå¹¶ä¸”è°ƒç”¨ memset() å†™å…¥è¿™äº›ç§æœ‰æ˜ å°„çš„å†…å®¹ç¼“å­˜é¡µé¢ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ã€Šæµ‹è¯• KSM çš„ test.c ç¨‹åºçš„ä»£ç ç‰‡æ®µã€‹</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">char</span> filename[<span class="number">64</span>]=<span class="string">""</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat</span>;</span></span><br><span class="line">    <span class="type">int</span> size =<span class="number">100</span>*<span class="number">4096</span>;</span><br><span class="line">    <span class="type">int</span> fd =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(filename, argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fd = open(filename,O_RDWR | O_CREAT,<span class="number">0664</span>);</span><br><span class="line"></span><br><span class="line">    fstat(fd, &amp;stat);</span><br><span class="line"></span><br><span class="line">    buf = mmap (<span class="literal">NULL</span>,stat.st_size,PROT_WRITE,MAP_PRIVATE,fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0x55</span>,stat.st_size);</span><br><span class="line"></span><br><span class="line">    madvise(buf,stat.st_size, MADV_MERGEABLE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¯‘ä¸Šè¿° test.c ç¨‹åºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o <span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ dd å‘½ä»¤åˆ›å»ºä¸€ä¸ª ksm.dat æ–‡ä»¶ï¼Œå³åˆ›å»º 100MB å¤§å°çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=ksm.dat bs=1M count=100</span><br></pre></td></tr></tbody></table></figure><p>ä½¿èƒ½ KSMã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/sys/kernel/mm/ksm/run</span><br></pre></td></tr></tbody></table></figure><p>è¿è¡Œ test.c ç¨‹åºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#./test ksm.dat</span></span><br></pre></td></tr></tbody></table></figure><p>è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒæŸ¥çœ‹ç³»ç»Ÿæœ‰å¤šå°‘é¡µé¢åˆå¹¶äº†ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@benshushu#cat /sys/kernel/mm/ksm/pages_sharing</span><br><span class="line">25500</span><br><span class="line">root@benshushu#cat /sys/kernel/mm/ksm/pages_shared</span><br><span class="line">100</span><br><span class="line">root@benshushu:/home#cat /sys/kernel/mm/ksm/pages_unshared</span><br><span class="line">0</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ° pages_shared ä¸º 100 è¯´æ˜ç³»ç»Ÿæœ‰ 100 ä¸ªå…±äº«çš„é¡µé¢ã€‚è‹¥æœ‰ 100 ä¸ªé¡µé¢çš„å†…åŒï¼Œå®ƒä»¬å¯ä»¥åˆå¹¶æˆä¸€ä¸ªé¡µé¢ï¼Œè¿™æ—¶ pages_shared ä¸º 1ã€‚ pages_sharing ä¸º 25500 è¯´æ˜æœ‰ 25500 ä¸ªé¡µé¢åˆå¹¶äº†ã€‚ 100MB çš„å†…å­˜å¯å­˜æ”¾ 25600 ä¸ªé¡µé¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒKSM æŠŠè¿™ 25600 ä¸ªé¡µé¢åˆ†åˆ«åˆå¹¶æˆ 1 å…±äº«çš„é¡µé¢ï¼Œæ¯ä¸€ä¸ªå…±äº«é¡µé¢é‡Œå…±äº«äº†å…¶ä»–çš„ 255 ä¸ªé¡µé¢ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿæˆ‘ä»¬ç¨åè¯¦ç»†è§£æã€‚ pages_unshared è¡¨ç¤ºå½“å‰æœªåˆå¹¶é¡µé¢çš„æ•°é‡ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rootebenshushut cat /sys/kernel/mn/ksm/stable_node_chains</span><br><span class="line">1</span><br><span class="line">rootebenshushut cat /sys/kernel/mm/ksm/stable_node_dups</span><br><span class="line">100</span><br></pre></td></tr></tbody></table></figure><p>stable_node_chains è¡¨ç¤ºåŒ…å«äº†é“¾å¼çš„ç¨³å®šèŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œå½“å‰ç³»ç»Ÿä¸­ä¸º 1ï¼Œè¯´æ˜åªæœ‰ä¸€ä¸ªé“¾å¼çš„ç¨³å®šèŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™ä¸ªç¨³å®šçš„èŠ‚ç‚¹é‡ŒåŒ…å«äº†é“¾è¡¨ã€‚ stable_node_dups è¡¨ç¤ºç¨³å®šçš„èŠ‚ç‚¹æ‰€åœ¨çš„é“¾è¡¨åŒ…å«çš„å…ƒç´ æ€»æ•°ã€‚ KSM çš„ sysfs èŠ‚ç‚¹åœ¨/sys/kernel/mm/ksm/ç›®å½•ä¸‹ï¼Œå…¶ä¸»è¦èŠ‚ç‚¹çš„æè¿°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>runï¼šå¯ä»¥è®¾ç½®ä¸º 0~2ã€‚è‹¥è®¾ç½® 0ï¼Œæš‚åœ ksmd å†…æ ¸çº¿ç¨‹ï¼›è‹¥è®¾ç½® 1ï¼Œå¯åŠ¨ ksmd å†…æ ¸çº¿ç¨‹ï¼›è‹¥è®¾ç½® 2ï¼Œå–æ¶ˆæ‰€æœ‰å·²ç»åˆå¹¶å¥½çš„é¡µé¢</li><li>full_scans: å®Œæ•´æ‰«æå’Œåˆå¹¶åŒºåŸŸçš„æ¬¡æ•°</li><li>pages_volatile: è¡¨ç¤ºè¿˜æ²¡æ‰«æå’Œåˆå¹¶çš„é¡µé¢æ•°é‡ã€‚è‹¥ç”±äºé¡µé¢å†…å®¹æ›´æ”¹è¿‡å¿«å¯¼è‡´ä¸¤æ¬¡è®¡ç®—çš„æ ¡éªŒå€¼ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆè¿™äº›é¡µé¢æ˜¯æ— æ³•æ·»åŠ åˆ°çº¢é»‘æ ‘é‡Œçš„</li><li>sleep_millisecs: ksmd å†…æ ¸çº¿ç¨‹æ‰«æä¸€æ¬¡çš„æ—¶é—´é—´éš”</li><li>pages_to_scan: å•æ¬¡æ‰«æé¡µé¢çš„æ•°é‡</li><li>pages_shared: åˆå¹¶åçš„é¡µé¢æ•°ã€‚å¦‚æœ 100 ä¸ªé¡µé¢çš„å†…å®¹ç›¸åŒï¼Œé‚£ä¹ˆå¯ä»¥æŠŠå®ƒä»¬åˆå¹¶æˆä¸€ä¸ªé¡µé¢ï¼Œè¿™æ—¶ pages_shared çš„å€¼ä¸º 1</li><li>pages_sharing: å…±äº«çš„é¡µé¢æ•°ã€‚å¦‚æœä¸¤ä¸ªé¡µé¢çš„å†…å®¹ç›¸åŒï¼Œå®ƒä»¬å¯ä»¥åˆå¹¶æˆä¸€ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªé¡µé¢è¦ä½œä¸ºç¨³å®šçš„èŠ‚ç‚¹ï¼Œè¿™æ—¶ pages_shared çš„å€¼ä¸º 1ï¼Œpages_sharing ä¹Ÿä¸º 1ã€‚ç¬¬ 3 ä¸ªé¡µé¢ä¹Ÿåˆå¹¶è¿›æ¥åï¼Œpages_sharing çš„å€¼ä¸º 2ï¼Œè¡¨ç¤ºä¸¤ä¸ªé¡µé¢å…±äº«åŒä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹</li><li>pages_unshared: å½“å‰æœªåˆå¹¶é¡µé¢æ•°é‡</li><li>max_page_sharing: è¿™æ˜¯åœ¨ Linux4.3 å†…æ ¸ä¸­æ–°å¢çš„å‚æ•°ï¼Œè¡¨ç¤ºä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹æœ€å¤šå¯ä»¥åˆå¹¶çš„é¡µé¢æ•°é‡ã€‚è¿™ä¸ªå€¼é»˜è®¤æ˜¯ 256</li><li>stable_node_chains: é“¾è¡¨ç±»å‹çš„ç¨³å®šèŠ‚ç‚¹çš„ä¸ªæ•°ã€‚æ¯ä¸ªé“¾å¼çš„ç¨³å®šèŠ‚ç‚¹ä»£è¡¨é¡µé¢å†…å®¹ç›¸åŒçš„ KM é¡µé¢ã€‚è¿™ä¸ªé“¾å¼çš„ç¨³å®šèŠ‚ç‚¹å¯ä»¥åŒ…å«å¤šä¸ª dup æˆå‘˜ï¼Œæ¯ä¸ª dup æˆå‘˜æœ€å¤šåŒ…å« 256 ä¸ªå…±äº«çš„é¡µé¢</li><li>stable_node_dups: é“¾è¡¨ä¸­ dup æˆå‘˜çš„ä¸ªæ•°ã€‚è¿™äº› dup æˆå‘˜ä¼šè¿æ¥åˆ°é“¾å¼çš„ç¨³å®šèŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­</li></ul><p>KSM åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºä¸€ä¸ªåä¸º ksmd çš„å†…æ ¸çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/ksm.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ksm_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    ksm_thread = kthread_run(ksm_scan_thread, <span class="literal">NULL</span>, <span class="string">"ksmd"</span>);</span><br><span class="line">}</span><br><span class="line">subsys_initcall(ksm_init);</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ tes.c ç¨‹åºä¸­åˆ›å»ºç§æœ‰æ˜ å°„ï¼ˆMAP_PRIVATEï¼‰ä¹‹åï¼Œæ˜¾å¼åœ°è°ƒç”¨ madvise ç³»ç»Ÿè°ƒç”¨æŠŠç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´æ·»åŠ åˆ° Linux å†…æ ¸çš„ KSM ç³»ç»Ÿä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;madvise()-&gt;ksm_madvise()-&gt; ksm_enter()&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __ksm_enter(<span class="keyword">struct</span> mm_struct *mm)</span><br><span class="line">{</span><br><span class="line">    mm_slot = alloc_mm_slot();</span><br><span class="line">    insert_to_mm_slots_hash(mm, mm_slot);</span><br><span class="line">    list_add_tail(&amp;mm slot-&gt;mm_list, &amp;ksm_scan.mm_slot-&gt;mm <span class="built_in">list</span>);</span><br><span class="line">    set_bit(MME_VM_MERGEABLE, &amp;mm-&gt;flags);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ksm_enter() å‡½æ•°ä¼šæŠŠå½“å‰çš„ mm_struct æ•°æ®ç»“æ„æ·»åŠ åˆ° mm_slots_hash å“ˆå¸Œè¡¨ä¸­ã€‚å¦å¤–æŠŠ mm_slot æ·»åŠ åˆ° ksm_scan.mm_slot-&gt;mm_list é“¾è¡¨ä¸­ã€‚æœ€åï¼Œè®¾ç½® mm-&gt;flags ä¸­çš„ MMF_VM_MERGEABLE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿›ç¨‹å·²ç»è¢«æ·»åŠ åˆ° KSM ç³»ç»Ÿä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;ksm å†…æ ¸çº¿ç¨‹&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ksm_scan_thread</span><span class="params">(<span class="type">void</span> *nothing)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">while</span> (!kthread_should_stop())</span><br><span class="line">        <span class="keyword">if</span> (ksmd_should_run())</span><br><span class="line">            ksm_do_scan(ksm_thread_pages_to_scan)</span><br><span class="line">    <span class="keyword">if</span> (ksmd_should_run()) {</span><br><span class="line">        sleep_ms =READ_ONCE(ksm_thread_sleep_millisecs);</span><br><span class="line">        wait_event_interruptible_timeout(ksm_iter_wait,</span><br><span class="line">        sleep_ms != READ_ONCE(ksm_thread_sleep_millisecs),</span><br><span class="line">        secs_to_jiffies(sleep_ms));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ksm_scan_thread() æ˜¯ ksmd å†…æ ¸çº¿ç¨‹çš„ä¸»å¹²ï¼Œå®ƒè¿è¡Œ ksm_do_scan() å‡½æ•°ï¼Œæ‰«æå’Œåˆå¹¶ 100 ä¸ªé¡µé¢ï¼Œè§ ksm_thread_pages_to_scan å‚æ•°ï¼Œç„¶åç­‰å¾… 20msï¼Œè§ ksm_thread_sleep_millisecs å‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥åœ¨/sys/kernel/mm/ksm ç›®å½•ä¸‹è®¾ç½®å’Œä¿®æ”¹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;ksmd å†…æ ¸çº¿ç¨‹&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ksm_do_scan</span><span class="params">(unsignd <span class="type">int</span> scan_npages)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">while</span>(scan_npages-- &amp;&amp; likely(!freezing(current))) {</span><br><span class="line">        cond_resched();</span><br><span class="line">        rmap_item = scan_get_next_rmap_item(&amp;page);</span><br><span class="line">        <span class="keyword">if</span> (!rmap_item)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        cmp_and_merge_page(page, rmap_item);</span><br><span class="line">        put_page(page)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ksm_do_scan() å‡½æ•°åœ¨ while å¾ªç¯ä¸­å°è¯•åˆå¹¶ scan_npages ä¸ªé¡µé¢ï¼Œ scan_get_next_rmap_item() è·å–ä¸€ä¸ªåˆé€‚çš„åŒ¿åé¡µé¢ã€‚ cmp_and_merge_page() å‡½æ•°ä¼šè®©é¡µé¢åœ¨ KSM ä¸­ç¨³å®šå’Œä¸ç¨³å®šçš„ä¸¤æ£µçº¢é»‘æ ‘ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°è¯•åˆå¹¶ä»–ä»¬ã€‚</p><h1 id="ksm-åŸºæœ¬å®ç°">KSM åŸºæœ¬å®ç°</h1><p>ä¸ºäº†è®©è¯»è€…å…ˆæœ‰ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œæœ¬èŠ‚å…ˆä»‹ç» Lnux4.13 å†…æ ¸ä¹‹å‰çš„ KSM å®ç°ï¼Œåæ–‡ä¼šä»‹ç» Linux5.0 å†…æ ¸ä¸­çš„å®ç°ã€‚</p><p>KSM æœºåˆ¶ä¸‹é‡‡ç”¨ä¸¤æ£µçº¢é»‘æ ‘æ¥ç®¡ç†æ‰«æçš„é¡µé¢å’Œå·±ç»åˆå¹¶çš„é¡µé¢ã€‚ç¬¬ä¸€æ£µçº¢é»‘æ ‘ç§°ä¸ºä¸ç¨³å®šçº¢é»‘æ ‘ï¼Œé‡Œé¢å­˜æ”¾äº†è¿˜æ²¡æœ‰åˆå¹¶çš„é¡µé¢ï¼›ç¬¬äºŒæ£µçº¢é»‘æ ‘ç§°ä¸ºç¨³å®šçº¢é»‘æ ‘ï¼Œå·²ç»åˆå¹¶çš„é¡µé¢ä¼šç”Ÿæˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸ºç¨³å®šèŠ‚ç‚¹ã€‚å¦‚ä¸¤ä¸ªé¡µé¢çš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼ŒKSM æ‰«æå¹¶å‘ç°äº†å®ƒä»¬ï¼Œå› æ­¤è¿™ä¸¤ä¸ªé¡µé¢å°±å¯ä»¥åˆå¹¶æˆä¸€ä¸ªé¡µé¢ã€‚å¯¹äºè¿™ä¸ªåˆå¹¶åçš„é¡µé¢ï¼Œä¼šè®¾ç½®åªè¯»å±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªé¡µé¢ä¼šä½œä¸ºç¨³å®šçš„èŠ‚ç‚¹æŒ‚è½½åˆ°ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªé¡µé¢å°±ä¼šè¢«é‡Šæ”¾äº†ã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªé¡µé¢çš„ rmap_item æ•°æ®ç»“æ„ä¼šè¢«æ·»å¦‚åˆ°ç¨³å®šèŠ‚ç‚¹ä¸­çš„ hist é“¾è¡¨ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm1.png"></p><p>æˆ‘ä»¬å‡è®¾æœ‰ 3 ä¸ª VMAï¼ˆè¡¨ç¤ºè¿›ç¨‹åœ°å€ç©ºé—´ï¼ŒVMA çš„å¤§å°æ­£å¥½æ˜¯ä¸€ä¸ªé¡µé¢çš„å¤§å°ï¼Œåˆ†åˆ«æœ‰ 3 ä¸ªé¡µé¢æ˜ å°„è¿™ 3 ä¸ª VMAã€‚è¿™ 3 ä¸ªé¡µé¢å‡†å¤‡é€šè¿‡ KSM æ¥æ‰«æå’Œåˆå¹¶ï¼Œè¿™ 3 ä¸ªé¡µé¢çš„å†…å®¹æ˜¯ç›¸åŒçš„ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚</p><ul><li>3 ä¸ªé¡µé¢ä¼šè¢«æ·»åŠ åˆ° KSM ä¸­ï¼Œç¬¬ä¸€è½®æ‰«æä¸­åˆ†åˆ«ç»™è¿™ 3 ä¸ªé¡µé¢åˆ†é… rmap_item æ•°æ®ç»“æ„æ¥æè¿°å®ƒä»¬ï¼Œå¹¶ä¸”åˆ†åˆ«ç»™å®ƒè®¡ç®—æ ¡éªŒå’Œï¼Œå¦‚å›¾ï¼ˆaï¼‰æ‰€ç¤º</li><li>ç¬¬äºŒè½®æ‰«æä¸­ï¼Œå…ˆæ‰«æ page0ï¼Œè‹¥å½“å‰ç¨³å®šçš„çº¢é»‘æ ‘æ²¡æœ‰æˆå‘˜ï¼Œé‚£ä¹ˆä¸èƒ½æ¯”è¾ƒå’ŒåŠ å…¥ç¨³å®šçš„çº¢é»‘æ ‘ã€‚æ¥ç€ï¼Œç¬¬äºŒæ¬¡è®¡ç®—æ ¡éªŒå€¼ï¼Œå¦‚æœ page0 çš„æ ¡éªŒå€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæŠŠ page0 çš„ rmap_item() æ·»åŠ åˆ°ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ï¼Œå¦‚å›¾ï¼ˆbï¼‰æ‰€ç¤ºã€‚å¦‚æœæ­¤æ—¶æ ¡éªŒå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè¯´æ˜é¡µé¢å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œè¿™ç§é¡µé¢ä¸é€‚åˆæ·»åŠ åˆ°ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­</li><li>æ‰«æ page1ï¼Œå½“å‰ç¨³å®šçš„çº¢é»‘æ ‘ä¸­æ²¡æœ‰æˆå‘˜ï¼Œç•¥è¿‡ç¨³å®šçš„çº¢é»‘æ ‘çš„æœç´¢ã€‚æœç´¢ä¸ç¨³å®šçš„çº¢é»‘æ ‘ï¼Œéå†çº¢é»‘æ ‘ä¸­æ‰€æœ‰æˆå‘˜ã€‚ page1 å‘ç°è‡ªå·±çš„å†…å®¹ä¸ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­çš„ rmap_item() ä¸€è‡´ï¼Œå› æ­¤å°è¯•å°† page0 å’Œ page1 åˆå¹¶æˆä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ï¼Œåˆå¹¶è¿‡ç¨‹å°±æ˜¯è®© WMA0 å¯¹æ˜ çš„è™šæ‹Ÿåœ°å€ã€vaddr0 æ˜ æ—¶åˆ° page1 ä¸Šã€‚ï¼Œå¹¶ä¸”æŠŠå¯¹åº”çš„ PTE å±æ€§ä¿®æ”¹æˆåªè¯»å±•æ€§ã€‚å¦å¤–ï¼ŒVMA1 æ˜ å°„åˆ° page1 çš„ PTE å±æ€§ä¹Ÿè®¾ç½®ä¸ºåªè¯»å±æ€§ã€‚æ–°åˆ›å»ºä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åŒ…å«äº† page1 çš„é¡µå¸§å·ç­‰ä¿¡æ¯ï¼ŒæŠŠè¿™ä¸ªç¨³å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ã€‚æŠŠä»£è¡¨ page0 çš„ map _item0 å’Œ page1 çš„ rmap_item1 æ·»åŠ åˆ°è¿™ä¸ªç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­ï¼Œæœ€åé‡Šæ”¾ page0 é¡µé¢ï¼Œå¦‚å›¾ï¼ˆcï¼‰æ‰€ç¤º</li><li>æ‰«æ page2ã€‚å› ä¸ºç¨³å®šçš„çº¢é»‘æ ‘ä¸­æœ‰æˆå‘˜ï¼Œå› æ­¤ï¼Œå…ˆå’Œç¨³å®šçš„çº¢é»‘æ ‘ä¸­çš„æˆå‘˜è¿›è¡Œæ¯”è¾ƒï¼Œæ£€æŸ»æ˜¯å¦å¯ä»¥åˆå¹¶ã€‚è‹¥å‘ç° page2 çš„å†…å®¹å’Œç¨³å®šçš„èŠ‚ç‚¹å†…å®¹ä¸€è‡´ï¼Œé‚£ä¹ˆæŠŠ VMA2 ä¸­çš„ vaddr2 æ˜ å°„åˆ°ç¨³å®šçš„èŠ‚ç‚¹å¯¹åº”çš„ page1 ä¸Šï¼Œå¹¶ä¸”æŠŠ PTE å±æ€§è®¾ç½®ä¸ºåªè¯»å±æ€§ã€‚æŠŠä»£è¡¨ page2 çš„ rmap_item2 æ·»åŠ åˆ°ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­ï¼Œæœ€åé‡Šæ”¾ page2 é¡µé¢ï¼Œå¦‚å›¾ï¼ˆdï¼‰æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm2.png"></li></ul><p>ä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹åï¼ŒVMAO~VMA2 è¿™ 3 ä¸ª VMA å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼ˆvadrï¼‰éƒ½æ˜ å°„åˆ° page1 ä¸Šï¼Œå¹¶ä¸”æ˜ å°„çš„ 3 ä¸ª PTE å±æ€§éƒ½æ˜¯åªè¯»å±æ€§ï¼Œpage1 ç”Ÿæˆä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹å¹¶è¢«æ·»åŠ åˆ°äº†ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ï¼Œpage0 å’Œ page2 è¢«é‡Šæ”¾äº†ã€‚</p><h1 id="æ–°ç‰ˆæœ¬-ksm-çš„æ–°ç‰¹æ€§">æ–°ç‰ˆæœ¬ KSM çš„æ–°ç‰¹æ€§</h1><p>æ–°ç‰ˆæœ¬çš„ KSMï¼ˆå¦‚ Linux5.0 å†…æ ¸çš„ KSMï¼‰æ¯” Linux4.0 å†…æ ¸çš„ KSM æ–°å¢äº†ä¸¤é¡¹ç‰¹æ€§ã€‚</p><ul><li>å¯¹å†…å®¹å…¨æ˜¯é›¶çš„é¡µé¢è¿›è¡Œç‰¹æ®Šå¤„ç†</li><li>å¯¹ç¨³å®šçš„èŠ‚ç‚¹çš„ hlis é“¾è¡¨è¿›è¡Œæ”¹é€ ï¼Œä»¥é˜²æ­¢å¤§é‡çš„ç›¸åŒçš„é¡µé¢èšé›†åœ¨ä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ä¸­ï¼Œå¯¼è‡´é¡µé¢è¿ç§»ã€å†…å­˜è§„æ•´ç­‰æœºåˆ¶é•¿æ—¶é—´ç­‰å¾…è¿™ä¸ªé¡µé¢</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm3.png"></p><p>æ–°ç‰¹æ€§ä¸­ï¼Œç¬¬ä¸€é¡¹å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç³»ç»Ÿä¸­å·±ç»å­˜åœ¨äº†ç³»ç»Ÿé›¶é¡µï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªç³»ç»Ÿé›¶é¡µé¢„å…ˆè®¡ç®—æ£€æŸ»å’Œã€‚è‹¥åœ¨æ‰«æé¡µé¢æ—¶å‘ç°é¡µé¢çš„æ£€æŸ»å’Œç­‰äºç³»ç»Ÿé›¶é¡µçš„æ£€æŸ¥å’Œï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹è¿™ä¸ªé¡µé¢çš„æ˜ å°„å…³ç³»ï¼Œè®©å…¶æ˜ å°„åˆ°ç³»ç»Ÿé›¶é¡µï¼Œè¿™æ ·å¯ä»¥é‡Šæ”¾è¿™ä¸ªé¡µé¢ã€‚ ç¬¬äºŒé¡¹æ–°ç‰¹æ€§å®ç°èµ·æ¥å°±æ¯”è¾ƒå¤æ‚äº†ã€‚ä¸»è¦åŸå› æ˜¯åœ¨ä¸€äº›å¤§å‹çš„æœåŠ¡å™¨ä¸­ï¼Œä¼šæŠŠå¤§é‡çš„é¡µé¢ï¼ˆå¦‚å‡ ç™¾ä¸‡ä¸ªé¡µé¢ï¼‰åˆå¹¶åˆ°ä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ä¸­ã€‚ é¡µé¢è¿ç§»æœºåˆ¶ä¼šè°ƒç”¨ RMAP æœºåˆ¶æ¥éå†è¿™ä¸ªç¨³å®šèŠ‚ç‚¹ä¸­æ‰€æœ‰çš„ rmap_itemï¼Œå¦‚å›¾æ‰€ç¤ºã€‚åœ¨ try_to_unmap_one() å‡½æ•°è§£é™¤é¡µè¡¨æ˜ å°„å…³ç³»æ—¶ï¼Œéœ€è¦è°ƒç”¨ flush_tlb_page() å‡½æ•°æ¥åˆ·æ–° TLBã€‚CPU å†…éƒ¨å‘é€ IPI å¹¿æ’­æ¥é€šçŸ¥å…¶ä»– CPU åšäº†è¿™ä¸ª TLB åˆ·æ–°åŠ¨ä½œï¼Œè¿™ä¸ªé¡µé¢çš„ PTE å·²ç»è¢«è§£é™¤æ˜ å°„å…³ç³»ï¼Œå¤§æ¦‚éœ€è¦ 10pus çš„æ—¶é—´ã€‚è‹¥éœ€è¦éå† 1 ä¸‡ä¸ªé¡µè¡¨é¡¹ï¼Œé‚£ä¹ˆå°†æŒç»­ 100msï¼›è‹¥éœ€è¦éå†å‡ åä¸‡ç”šè‡³å‡ ç™¾ä¸‡ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆå°†æŒç»­æ›´é•¿æ—¶é—´ã€‚åœ¨è°ƒç”¨ my_to_unmap() å‡½æ•°ä¹‹å‰éœ€è¦ç”³è¯·è¿™ä¸ªé¡µé¢çš„é”ï¼Œä½†æ˜¯å…¶ä»–è¿›ç¨‹æœ‰å¯èƒ½åœ¨ç­‰å¾…è¿™ä¸ªé¡µé”ï¼Œé‚£å°†ä¼šæ˜¯ä¸€åœºâ€œç¾éš¾â€ï¼Œè¶³ä»¥è®©æœåŠ¡å™¨å®•æœºã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">grate_pages ()</span><br><span class="line">  -&gt;unmap_and_move()</span><br><span class="line">    -&gt;unmap_and_move()</span><br><span class="line">      -&gt;ç”³è¯·é¡µé”</span><br><span class="line">        -&gt;try_to_unmap()</span><br><span class="line">          -&gt;rmap_walk()</span><br><span class="line">            -&gt;rmap_walk_ksm()</span><br><span class="line">            éå†ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­å‡ ç™¾ä¸‡ä¸ª rmap_items</span><br><span class="line">              -&gt;try_to_unmap_one()</span><br><span class="line">                -&gt;ptep_clear_flush()</span><br><span class="line">                  -&gt;flush_tlb_page()</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ Linux4.13 å†…æ ¸ä¸­ï¼Œ Red Hat å·¥ç¨‹å¸ˆ Andrea Arcangeli å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†ä¿®å¤ã€‚æ–°åŠæ³•æ˜¯é™åˆ¶å…±äº«é¡µé¢çš„æ•°é‡åœ¨ 256 ä»¥å†…ï¼Œè¿™æ ·éå† 256 ä¸ªé¡µè¡¨é¡¹çš„æ—¶é—´å°†ä¼šé™åˆ¶åœ¨æ¯«ç§’ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå®•æœºã€‚æ–°çš„è§£å†³æ–¹æ¡ˆæ‰©å……äº†ç¨³å®šèŠ‚ç‚¹çš„ hlist é“¾è¡¨ç»“æ„ï¼Œ rmap_items è¶…è¿‡ 256 ä¸ªä¹‹åï¼Œæ‰©å±•ç¨³å®šçš„èŠ‚ç‚¹ä¸ºé“¾è¡¨ã€‚æ¯ä¸ªé“¾è¡¨çš„æˆå‘˜éƒ½æ˜¯ä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªç¨³å®šçš„èŠ‚ç‚¹æœ‰ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ª hlist é“¾è¡¨ä¸­å¯ä»¥æ·»åŠ æ–°çš„ rmap_itemsã€‚å¦å¤–ï¼Œè¿˜éœ€è¦æŠŠç¨³å®šçš„èŠ‚ç‚¹å’Œé“¾è¡¨çš„å¤´åœ¨çº¢é»‘æ ‘ä¸­åšä¸€ä¸ªäº¤æ¢ã€‚ æ–°ç‰ˆæœ¬çš„ç¨³å®šçš„èŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªå½¢æ€ï¼Œè€Œä¸”å®ƒä»¬åŒæ—¶å­˜æ”¾åœ¨ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm4.png"></p><ul><li>ä¼ ç»Ÿçš„ç¨³å®šçš„èŠ‚ç‚¹ï¼šå…¼å®¹æ—§ç‰ˆæœ¬çš„ç¨³å®šçš„èŠ‚ç‚¹æ ¼å¼ã€‚</li><li>é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ï¼šæ–°ç‰ˆæœ¬çš„é“¾å¼èŠ‚ç‚¹æ ¼å¼ã€‚</li></ul><p>ä¸‹é¢ä»¥ test.c ç¨‹åºä¸ºä¾‹ï¼Œå‡è®¾ç°åœ¨ç³»ç»Ÿäº§ç”Ÿäº† 1000 ä¸ªé¡µé¢ï¼Œå¹¶ä¸”è¿™ 1000 ä¸ªé¡µé¢çš„å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ¯ä¸ªé¡µé¢å¯¹åº”ä¸åŒçš„ VMAï¼Œè¿™äº› VMA çš„å¤§å°æ­£å¥½æ˜¯ä¸€ä¸ªé¡µé¢å¤§å°ã€‚æ¥ä¸‹æ¥è§‚å¯Ÿæ–°ç‰ˆæœ¬çš„ KSM å¦‚ä½•å¤„ç†è¿™äº›é¡µé¢ï¼Œå¦‚ä½•åˆ›å»ºæ–°ç‰ˆæœ¬çš„é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ã€‚</p><p>ç¬¬ 1 æ¬¡æ‰«æè¿™ 1000 ä¸ªé¡µé¢ã€‚ç¬¬ 1 æ¬¡æ‰«æé¡µé¢æ—¶ä¼šè®¡ç®—æ¯ä¸ªé¡µé¢çš„æ£€éªŒå’Œã€‚éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">statc <span class="type">void</span> <span class="title function_">cmp_and_merge_page</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="keyword">struct</span> rmap_item *rmap_item)</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    checksum =calc_checksum(page);</span><br><span class="line">    <span class="keyword">if</span>(rmap_item-&gt;oldchecksum != checksum) {</span><br><span class="line">        rmap_item-&gt;oldchecksum = checksum;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ 2 æ¬¡æ‰«æä¸­ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªé¡µé¢ï¼ˆç¼–å·ä¸º page0ï¼Œä»¥æ­¤ç±»æ¨ï¼‰çš„æƒ…å†µï¼Œå®ƒé¦–å…ˆè¿›å…¥ cmp_and_merge_page() å‡½æ•°ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>cmp_and_merge_page() å‡½æ•°ä¼šéå†ç¨³å®šçš„çº¢é»‘æ ‘ä¸­æ¯ä¸ªç¨³å®šçš„èŠ‚ç‚¹ï¼Œå¹¶å’Œ page0 è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­å†…å®¹æ˜¯å¦ä¸€è‡´ã€‚è‹¥å†…å®¹ä¸€è‡´ï¼Œåˆ™å°†é¡µé¢åˆå¹¶åˆ°ç¨³å®šçš„èŠ‚ç‚¹ä¸­ã€‚å› ä¸ºè¿™æ—¶ stable çº¢é»‘æ ‘è¿˜æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è·³è¿‡ stable_tree_searche() å‡½æ•°</li><li>å¦‚æœé¡µé¢æ ¡éªŒå€¼ä¸å˜ï¼Œåˆ™éå† unstable çº¢é»‘æ ‘ä¸­çš„æ¯ä¸€ä¸ª rmap_item èŠ‚ç‚¹ã€‚è¿™æ—¶ï¼Œä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¹Ÿè¿˜æ˜¯ç©ºçš„ï¼Œå› æ­¤ç›´æ¥æŠŠ rmap_item0 æ·»åŠ åˆ°ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ï¼Œæ‰«æç¬¬ i ä¸ªé¡µé¢ï¼Œå¦‚å›¾æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm5.png"></li></ul><p>éƒ¨åˆ†ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> rmap_item * <span class="title function_">unstable_tree_search_insert</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    rmap_item-&gt;address |= UNSTABLE_FLAGA;</span><br><span class="line">    rmap_item-&gt;address |= (ksm_scan.seqnr &amp; SEONR_MASKD);</span><br><span class="line">    DO_NUMA(rmap_item-&gt;nid = nid);</span><br><span class="line">    rb_link_node(&amp;rmap_item-&gt;node, parent, new);</span><br><span class="line">    rb_insert_color(&amp;rmap_item-&gt;node, root);</span><br><span class="line">    ...</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 2 ä¸ªé¡µé¢ï¼ˆpgeï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>ç•¥è¿‡ç¨³å®šçš„çº¢é»‘æ ‘</li><li>éå†ä¸ç¨³å®šçš„çº¢é»‘æ ‘ï¼Œç°åœ¨ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­æœ‰ä¸ªæˆå‘˜ rmap_item0, unstable_tree_search_insert() å‡½æ•°å–å‡º rmap_item0ï¼Œç„¶åå’Œ page1 è¿›è¡Œå†…å®¹æ¯”è¾ƒã€‚ try_to_merge_two_page() å‡½æ•°ä¼šæ¯”è¾ƒ rmap_item0 å¯¹åº”çš„ page0 å’Œ page1ï¼Œè‹¥å‘ç°å†…å®¹ä¸€è‡´ï¼Œåˆ™å°†å…¶åˆå¹¶æˆä¸€ä¸ªé¡µé¢ã€‚è¿‡ç¨‹å°±æ˜¯è®© VMA0 å¯¹åº”çš„è™šæ‹Ÿåœ°å€ vaddr0 æ˜ å°„åˆ° page1 ä¸Šï¼Œå¹¶ä¸”æŠŠå¯¹åº”çš„ PTE å±æ€§ä¿®æ”¹æˆåªè¯»å±æ€§ã€‚å¦å¤–ï¼ŒWMA1 æ˜ å°„åˆ° page1 çš„ PTE å±æ€§ä¹Ÿè®¾ç½®ä¸ºåªè¯»å±æ€§</li><li>åœ¨ stable_tree_inserter() å‡½æ•°ä¸­ï¼Œå› ä¸º stable çº¢é»‘æ ‘ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šæ–°å»ºä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ (stable node æ•°æ®ç»“æ„ï¼‰ï¼Œæˆ‘ä»¬ç§°å®ƒä¸º stable_node_dup0 æˆ–è€… node_dup0</li><li>page1 çš„é¡µå¸§å·ä¹Ÿä¼šè®°å½•åœ¨ stable_node_dup0-&gt;kpfn ä¸­ï¼Œå¹¶ä¸” rmap_list_len å€¼ä¸º 0. è°ƒç”¨ set_page_stable_node() æ•°æŠŠ page1 è®¾ç½®æˆ KSM é¡µé¢ï¼Œè¯¦è§ mm/ksm.c æ–‡ä»¶ä¸­çš„ä»£ç </li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/ksm.c&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span>  <span class="title function_">set_page_stable_node</span><span class="params">(<span class="keyword">struct</span> page page, <span class="keyword">struct</span> stable_node *stable_node)</span></span><br><span class="line">{</span><br><span class="line">    page-&gt;mapping =(<span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">long</span>)stable_node | PAGE_MAPPING_KSM);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>ç”±äºè¿™æ—¶ä¸éœ€è¦ä¸ºç¨³å®šçš„èŠ‚ç‚¹å»ºç«‹é“¾è¡¨ï¼Œå› æ­¤ç¬¬ 1884 è¡Œä»£ç çš„ need_chain ä¸º ifalse æœ€åç›´æ¥æŠŠ stable_node_dup0 æ·»åŠ åˆ°ç¨³å®šçš„çº¢é»‘æ ‘ä¸­</li><li>è°ƒç”¨ stable_tree_append()ï¼Œåˆ†åˆ«æŠŠ page0 å¯¹åº”çš„ rmap_item0 å’Œ page1 å¯¹åº”çš„ rmap_item1 æ·»åŠ åˆ° stable_node_dup0-&gt;hlist é“¾è¡¨ä¸­ã€‚å¢åŠ  ksm_pages_ shared å’Œ ksm_pages_sharing è®¡æ•°ï¼Œè¿™æ—¶ ksm_pages_sharing ä¸º 1ï¼Œ ksm_pages_shared ä¸º 1ï¼Œ stable_node_dup0-&gt;rmap_hlist_len ä¸º 2</li><li>é‡Šæ”¾ page0ã€‚</li></ul><p>åˆå¹¶è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm6.png"></p><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 3 ä¸ªé¡µé¢ï¼ˆpage2ï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ã€‚</p><ul><li>éå† stable çº¢é»‘æ ‘ï¼Œè§ stable_tree_search() å‡½æ•°ã€‚é€šè¿‡ rb_entry() å–å‡ºç¨³å®šçš„çº¢é»‘æ ‘èŠ‚ç‚¹è¿™æ—¶ï¼Œç¨³å®šçš„çº¢é»‘æ ‘åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£å°±æ˜¯ stable_node_dup()</li><li>è°ƒç”¨ chain_prune() å‡½æ•°ã€‚åœ¨å†…éƒ¨è°ƒç”¨__stable_node_chain() å‡½æ•°æ—¶ä¼šå¯¹ç¨³å®šçš„ç‚¹è¡Œåˆ¤æ–­</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;chain_prune()-&gt;__stable_node_chain()&gt;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> * __<span class="title">stable_node_chain</span>()</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stable_node</span> *<span class="title">stable_node</span> =</span>*_stable_node;</span><br><span class="line">    <span class="keyword">if</span> (!is_stable_node_chain(stable_node)) {</span><br><span class="line">        <span class="keyword">if</span> (is_page_sharing_candidate(stable_node)) {</span><br><span class="line">            *stable_node_dup = stable_node;</span><br><span class="line">            <span class="keyword">return</span> get_ksm_page(stable_node, <span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    ...</span><br></pre></td></tr></tbody></table></figure><ul><li>is_stable_node_chain åˆ¤æ–­è¿™ä¸ªç¨³å®šçš„èŠ‚ç‚¹æ˜¯å¦ä¸ºé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ã€‚åˆ¤æ–­ä¾æ®æ˜¯ rmap_hlist_len æ˜¯å¦ä¸º STABLE_NODE_CHAINã€‚é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹æ‰€åœ¨çš„ hlist é“¾è¡¨æ˜¯ä¸å­˜æ”¾ rmap_item çš„ï¼Œå¹¶ä¸”å®ƒçš„ rmap_hlist_len ä¼šåˆå§‹åŒ–ä¸ºä¸€ä¸ªå›ºå®šå€¼ï¼Œ STABLE_NODE_CHAINï¼ˆé»˜è®¤åˆå§‹å€¼ä¸º-1024ï¼‰ï¼Œæˆ‘ä»¬ç”±æ­¤æ¥åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦ä¸ºé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define STABLE_NODE_CHAIN <span class="number">-1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">is_stable_node_chain</span><span class="params">(<span class="keyword">struct</span> stable node *chain)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">return</span> chain-&gt;rmap_hlist_len == STABLE_NODE_CHATNI;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>stable_node_dup0 æ˜¾ç„¶ä¸æ˜¯é“¾å¼çš„ç¨³å®šçš„èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¼ ç»Ÿçš„ç¨³å®šçš„èŠ‚ç‚¹ã€‚ is_page_sharing_candidate() åˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹ä¸­æ˜¯å¦è¿˜èƒ½å­˜æ”¾ rmap_itemã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è§„å®šæ¯ä¸ªèŠ‚ç‚¹çš„ hlist é“¾è¡¨æœ€å¤šåªèƒ½å­˜æ”¾ 256 ä¸ªæˆå‘˜</li><li>è°ƒç”¨ get_ksm_page() å‡½æ•°è¿”å› stable_node_dup0 èŠ‚ç‚¹å¯¹åº”çš„ page æ•°æ®ç»“æ„</li><li>æ¯”è¾ƒ stable_node_dup0 å¯¹åº”çš„é¡µé¢ï¼ˆå³ tree_pageï¼‰å’Œ page2 çš„é¡µé¢å†…å®¹æ˜¯å¦ä¸€æ ·ï¼Œè‹¥ä¸€æ ·ï¼Œ stable_tree_searche() å‡½æ•°ä¼šè¿”å› tree_page</li><li>è°ƒç”¨ ty_to_merge_with_ksm_page() å‡½æ•°å°è¯•åˆå¹¶ tree_page å’Œ pge2ã€‚è‹¥èƒ½åˆå¹¶ï¼Œé‚£ä¹ˆè°ƒç”¨ stable_tree_append() å‡½æ•°æŠŠ page2 å¯¹åº”çš„ rmap_item2 æ·»åŠ åˆ° stable_node_dup0-&gt;hlist é“¾è¡¨ä¸­ã€‚å¢åŠ  ksm_pages_sharing çš„å€¼ï¼Œæ­¤æ—¶ ksm_pages_sharing çš„å€¼ä¸º 2ã€‚è¿™æ—¶ï¼Œ stable_node_dup0-&gt;hlist_len ä¸º 3</li><li>é‡Šæ”¾ page2</li></ul><p>ä¸Šè¿°è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm7.png"></p><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 4 ä¸ªé¡µé¢ï¼Œä¸€ç›´åˆ°ç¬¬ 256 ä¸ªé¡µé¢ã€‚å’Œæ‰«æç¬¬ 3 ä¸ªé¡µé¢ä¸€æ ·ï¼Œè¿™äº›é¡µé¢éƒ½ä¼šåˆå¹¶åˆ° stable_node_dup0 å¯¹åº”çš„ tree_page ä¸­ï¼Œå…¶å¯¹åº”çš„ rmap_item éƒ½ä¼šè¢«æ·»åŠ åˆ° stable_node_dup0-&gt;hlist é“¾è¡¨ä¸­ï¼Œè¿™æ—¶ stable_node_dupO-&gt;rmap_hlist_len çš„å€¼ä¸º 256ï¼Œ ksm_pages_sharing çš„å€¼ä¸º 255.</p><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 257 ä¸ªé¡µé¢ï¼ˆp2ge256ï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>éå†ç¨³å®šçš„çº¢é»‘æ ‘ï¼Œè§ stable_tree_search() å‡½æ•°</li><li>å¦‚æœåœ¨ chain_prune-&gt;__stable_node_chain()-&gt;is_page_sharing_candidate() å‡½æ•°ä¸­å‘ç° hlist é“¾è¡¨çš„æˆå‘˜ä¸ªæ•°å·²ç»åˆ°è¾¾æœ€å¤§å€¼ï¼ˆ ksm_max_page_ sharingï¼‰ï¼Œé‚£ä¹ˆä¼šè¿”å› NULLï¼Œå¹¶ä¸” stable_node_dup å‚æ•°ä¹Ÿè¿”å› NULL</li><li>stable_tree_search() å‡½æ•°è°ƒç”¨ stable_node_dup_any() æ¥è·å–ç¨³å®šçš„èŠ‚ç‚¹ï¼Œget_ksm_page() è·å–è¿™ä¸ªç¨³å®šçš„èŠ‚ç‚¹å¯¹åº”çš„ tree_pageã€‚æ¯”è¾ƒ tree_page å’Œ page256 çš„å†…å®¹æ—¶å‘ç°äºŒè€…æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å› ä¸º stable_node_dup å‚æ•°ä¸º NULLï¼Œæ‰€ä»¥åœ¨ç¬¬ 1653~1666 è¡Œé‡Œä¼šè¿”å› NULLã€‚è¿™é‡Œåœ¨æ³¨é‡Šé‡Œå¯¹ä»£ç åšäº†è§£é‡Šï¼Œå½“æˆ‘ä»¬å‘ç°è¢«æ‰«æé¡µé¢çš„å†…å®¹å’Œç¨³å®šçš„èŠ‚ç‚¹çš„é¡µé¢å†…å®¹ä¸€è‡´æ—¶ï¼Œä½†æ˜¯å› ä¸ºè¿™æ—¶ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä»ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­æ‰¾åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ã€è¿›è¡Œåˆå¹¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ KSM å…±äº«é¡µé¢</li><li>å› ä¸º stable_tree_search() å‡½æ•°è¿”å› NULLï¼Œæ‰€ä»¥ç›´æ¥éå†ä¸ç¨³å®šçš„çº¢é»‘æ ‘ã€‚æ­¤æ—¶ï¼Œä¸ç¨³å®šçš„çº¢é»‘æ ‘æ²¡æœ‰æˆå‘˜ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æŠŠ page256 å¯¹åº”çš„ map_item æ·»åŠ åˆ°ä¸ç¨³å®šçš„çº¢é»‘æ ‘ä¸­</li></ul><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 258 ä¸ªé¡µé¢ï¼ˆpage257ï¼‰ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ã€‚</p><ul><li>éå†ç¨³å®šçš„çº¢é»‘æ ‘ï¼Œè§ stable_tree_search() å‡½æ•°ã€‚å’Œæ­¥éª¤ï¼ˆ6ï¼‰ä¸€æ ·ï¼Œå› ä¸º stable_node_dup0-&gt;hlist é“¾è¡¨æ»¡äº†ï¼Œæ‰€ä»¥ç›´æ¥è¿”å› NULL</li><li>è°ƒç”¨ unstable_tree_search_insert() å‡½æ•°ã€‚è‹¥å‘ç° page257 å’Œä¸ç¨³å®šçº¢é»‘æ ‘çš„æˆå‘˜å†…å®¹ä¸€è‡´ï¼Œè¿”å› tree_rmap_item</li><li>è°ƒç”¨ tyy_merge_two_pages() å‡½æ•°å°è¯•åˆå¹¶ pge257 å’Œ tree_pageã€‚å‡å¦‚å®ƒä»¬ç¬¦åˆåˆå¹¶æ¡ä»¶ï¼Œé‚£ä¹ˆå°è¯•å°†å…¶åˆå¹¶æˆä¸€ä¸ªé¡µé¢</li><li>è°ƒç”¨ stable_tree æŠŠè¿™ä¸ªåˆå¹¶åçš„é¡µé¢æ·»åŠ åˆ°ç¨³å®šçš„çº¢é»‘æ ‘ä¸­ã€‚åœ¨ stable_tree_insert() å‡½æ•°ä¸­ï¼Œéå†ç¨³å®šçš„çº¢é»‘æ ‘ä¸­çš„æ‰€æœ‰æˆå‘˜ï¼Œå½“å‘ç°ç¨³å®šçš„èŠ‚ç‚¹çš„é¡µé¢å†…å®¹å’Œå½“å‰é¡µé¢å†…å®¹ä¸€è‡´æ—¶ï¼Œè®¾ç½® need_chain ä¸º true å¹¶é€€å‡ºéå†ï¼Œè¯´æ˜æ‰¾åˆ°ä¸€ä¸ªå†…å®¹ç›¸åŒçš„â€œå°ä¼™ä¼´â€äº†ï¼ˆè§ 1870 è¡Œä»£ç ï¼‰</li><li>åœ¨ç¬¬ 1875 è¡Œä¸­ï¼Œæ–°å¥ä¸€ä¸ªç¨³å®šçš„èŠ‚ç‚¹ï¼Œç§°ä¸º stable_node_dup1 æˆ–è€… node_dup1ã€‚è®¾ç½®æ–°åˆå¹¶é¡µé¢çš„é¡µå¸§å·åˆ° stable_node_dup1-&gt;kpfn ä¸­ã€‚ set_page_stable_node() å‡½æ•°æŠŠè¿™ä¸ªæ–°åˆå¹¶é¢è®¾ç½®ä¸º KSM é¡µé¢ã€‚è¿™æ—¶ stable_node_dup1-&gt;rmap_hlist_len çš„å€¼ä¸º 0</li><li>åœ¨ç¬¬ 188 è¡Œä¸­ï¼Œç¨³å®šçš„çº¢é»‘æ ‘çš„èŠ‚ç‚¹ä¸º stable_node_dup0ï¼Œå®ƒæ˜¯ä¼ ç»Ÿçš„ç¨³å®šçš„èŠ‚ç‚¹åœ¨ç¬¬ 1891 è¡Œä¸­ï¼Œè°ƒç”¨ alloc_stable_node_chain() å‡½æ•°é‡æ–°åˆ›å»ºä¸€ä¸ªé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ã€‚ chain-&gt;rmap_hlist_len çš„å€¼åˆå§‹åŒ–ä¸º STABLE_NODE_CHANï¼Œè¡¨æ˜è¯¥èŠ‚ç‚¹æ˜¯é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ã€‚å¢—åŠ  ksm_stable_node_chains è®¡æ•°</li><li>æŠŠé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹æ›¿æ›åˆ°ç¨³å®šçš„çº¢é»‘æ ‘ä¸Šçš„ stable_node_dup0 èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠ stable_node_dup0 èŠ‚ç‚¹æ·»åŠ åˆ°é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹æ‰€åœ¨çš„ hlist é“¾è¡¨ä¸­ï¼Œè¿™æ ·ä¸€ä¸ªæ–°çš„é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹å°±åˆ›å»ºæˆåŠŸäº†</li><li>åœ¨ç¬¬ 1897 è¡Œä¸­ï¼ŒæŠŠåˆšæ‰æ–°åˆ›å»ºçš„ stable_node_dup1 èŠ‚ç‚¹ä¹Ÿæ·»åŠ åˆ°é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­ã€‚æ­¤æ—¶ï¼Œé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯ stable_node_dup0 èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªæ˜¯ stable_node_dup1 èŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œ ksm_stable_node_chain ä¸º 1 ksm_stable_node_dups ä¸º 2</li><li>åœ¨ç¬¬ 2145~2147 è¡Œä¸­ï¼Œåˆ†åˆ«è°ƒç”¨ stable_tree_append() å‡½æ•°ï¼ŒæŠŠ rmap_item257 å’Œ tree_rmap_item æ·»åŠ åˆ° table_node_dup1-&gt;hlist é“¾è¡¨ä¸­ã€‚æ­¤æ—¶ï¼Œ stable_nodde_dup1-&gt;rmap_hist_len çš„å€¼ä¸º 2ï¼Œ ksm_pages_shared ä¸º 2ï¼Œ ksm_pages_sharing ä¸º 256 æ•´ä¸ªè¿‡ç¨‹å¦‚å›¾æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm8.png"></li></ul><p>æ¥ä¸‹æ¥ï¼Œæ‰«æç¬¬ 259 ä¸ªé¡µé¢ï¼ˆpage258ï¼‰ã€‚å…·ä¼‘è¿‡ç¨‹å¦‚ä¸‹ã€‚</p><ul><li>éå† stable çº¢é»‘æ ‘ï¼Œè§ stable_tree_searen() å‡½æ•°ã€‚</li><li>è°ƒç”¨ chain_prune()-&gt;__stable_node_chain() å‡½æ•°ï¼Œç”±äºå½“å‰çš„èŠ‚ç‚¹æ˜¯é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥è°ƒç”¨ stabie_node_dup() å‡½æ•°ï¼Œè¯¦è§ stable_node_dup() å‡½æ•°</li><li>åœ¨ stabie_node_dup() å‡½æ•°ä¸­éå†ç¨³å®šçš„èŠ‚ç‚¹æ‰€åœ¨çš„ hlist é“¾è¡¨ä¸­æ‰€æœ‰çš„ rmap_itemï¼ŒæŸ¥æ‰¾ä¸€ä¸ª hlist é“¾è¡¨ä¸­è¿˜æœ‰ç©ºé—´çš„ rmap_itemã€‚ç„¶åè¿”å›è¿™ä¸ª rmap_item å¯¹åº”çš„é¡µé¢ï¼Œå¦å¤– stabie_node_dup æŒ‡å‘ rmap_item. æ­¤æ—¶ï¼Œé“¾å¼ç¨³å®šçš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ª stable_nale_dup() åˆ†åˆ«æ˜¯ stabie_node_dup0 å’Œ stabie_node_dup1ï¼Œåªæœ‰ stable_node_dup1 è¿˜æœ‰ç©ºé—´å®¹çº³ rmap_item, å› æ­¤è¿”å› stabie_node_dup1 å¯¹åº”çš„é¡µé¢ã€‚</li><li>åœ¨ stable_tree_search() å‡½æ•°ä¸­ï¼Œå‘ç°ç¬¬ 259 ä¸ªé¡µé¢å’Œ stabie_node_dup1 å¯¹åº”çš„é¡µé¢å†…å®¹ç›¸åŒï¼Œå› æ­¤è¿”å› stabie_node_dup1 å¯¹åº”çš„é¡µé¢ï¼Œå®ƒç§°ä¸º tree_page</li><li>è°ƒç”¨ try_to_merge_with_ksm_page() å°è¯•åˆå¹¶ page258 åˆ° tree_page ä¸­ã€‚è°ƒç”¨ stable_tree_append() å‡½æ•°æŠŠ rmap_item258 æ·»åŠ åˆ° stable_node_dup1 çš„ hlist é“¾è¡¨ä¸­ï¼Œ rmap_hlist_len çš„å€¼å˜æˆäº† 3ï¼Œksages_sharing å˜æˆäº† 257 æ•´ä¸ªè¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ksm9.png"></li></ul><p>æ¥ä¸‹æ¥ï¼Œæ‰«æå…¶ä»–é¡µé¢ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ã€‚</p><p>ï¼ˆ1ï¼‰ç»§ç»­æ‰«æå…¶ä»–é¡µé¢ï¼Œç›´åˆ° stable_node_dup1-&gt;hlist é“¾è¡¨æ»¡å‘˜ä¸ºæ­¢ã€‚ ï¼ˆ2ï¼‰é‡å¤æ‰«æç¬¬ 257 ä¸ªå’Œç¬¬ 258 ä¸ªé¡µé¢ï¼Œæ–°åˆ›å»ºä¸€ä¸ª node_dup2 èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾å¼ç¨³å®šçš„èŠ‚ç‚¹çš„ hlist é“¾è¡¨ä¸­ï¼Œæ–°çš„ rmap_item å°±å¯ä»¥ç»§ç»­æ·»åŠ åˆ° node_dup2-&gt;hlist é“¾è¡¨ä¸­äº†ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬ä»¬å‘ç°æ–°ç‰ˆæœ¬çš„ KSM æœºåˆ¶æœ‰ï¼š</p><ul><li>ä¸Šè¿° 1000 ä¸ªç›¸åŒé¡µé¢ä¼šç”Ÿæˆå¤šä¸ª KSM é¡µé¢ï¼Œä¸Šå›¾ 9 æ‰€ç¤ºçš„ page1 æ˜¯ç¬¬ä¸€ä¸ª KSM é¡µé¢ï¼Œpage257 æ˜¯ç¬¬äºŒä¸ª KSM é¡µé¢ï¼Œä»¥æ­¤ç±»æ¨ã€‚è€Œåœ¨æ—§ç‰ˆæœ¬çš„ KSM æœºåˆ¶ä¸­ï¼Œ1000 ä¸ªé¡µé¢ä¼šç”Ÿæˆä¸€ä¸ª KSM é¡µé¢ï¼Œå¦å¤–çš„ 999 ä¸ªé¡µé¢éƒ½ä¼šåˆå¹¶åˆ°è¿™ä¸ª KSM é¡µé¢ä¸­ã€‚</li><li>æ¯ä¸ª KSM é¡µé¢æœ€å¤šæŠŠ 256 ä¸ªé¡µé¢åˆå¹¶åœ¨ä¸€èµ·ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬ KSM é¡µé¢è‡ªå·±ï¼Œå³æœ€å¤šæœ‰ 255 ä¸ªå…¶ä»–çš„é¡µé¢è¢«åˆå¹¶ã€‚</li></ul><p>å½“ RMAP æœºåˆ¶éœ€è¦éå† KSM é¡µé¢æ—¶ï¼Œå®ƒåªéœ€è¦éå† 256 ä¸ª rmap_items å³å¯ã€‚å¦‚å½“éœ€è¦è¿ç§» page1 æ—¶ï¼Œå¯ä»¥é€šè¿‡ page1 æ‰¾åˆ° stable_node_dup0 èŠ‚ç‚¹ï¼Œå› æ­¤åªéœ€è¦éå†å’Œå¤„ç† node_dup0-&gt;hlist é“¾è¡¨ä¸­çš„ç¬¬ 256 ä¸ª rmap_items å°±å¯ä»¥è¿ç§» page1.</p><blockquote><p>malloc å‡½æ•°åˆ†é…çš„å†…å­˜æ˜¯ä¸èƒ½è¢« KSM æ‰«æçš„ï¼Œmalloc() å‡½æ•°åˆ†é…çš„è™šæ‹Ÿå†…å­˜æ²¡åŠæ³•ä¿è¯ä¸€å®šæ˜¯æŒ‰ç…§é¡µé¢å¯¹é½çš„ï¼Œä½†åœ¨ madvise ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œè¦æ±‚èµ·å§‹åœ°å€æ˜¯æŒ‰ç…§é¡µé¢å¯¹é½çš„ã€‚</p></blockquote><h1 id="å°ç»“">å°ç»“</h1><p>KSM çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³åŸºäºå†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å†…å®¹ç›¸åŒçš„é¡µé¢å¯ä»¥åˆå¹¶æˆä¸€ä¸ªåªè¯»é¡µé¢ï¼Œä»è€Œé‡Šæ”¾ç©ºé—²é¡µé¢ã€‚ KSM æœ€æ—©æ˜¯ä¸ºäº† KVM è™šæ‹Ÿæœºè€Œè®¾è®¡çš„ï¼ŒKVM è™šæ‹Ÿæœºåœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨çš„é¡µé¢å¤§éƒ¨åˆ†æ˜¯åŒ¿åé¡µé¢ï¼Œå¹¶ä¸”å®ƒä»¬åœ¨å®¿ä¸»æœºä¸­å­˜åœ¨å¤§é‡çš„å†—ä½™å†…å­˜ã€‚å¯¹äºå…¸å‹çš„åº”ç”¨ç¨‹åºï¼ŒKSM åªè€ƒè™‘è¿›ç¨‹åˆ†é…ä½¿ç”¨çš„åŒ¿åé¡µé¢ï¼Œæš‚æ—¶ä¸è€ƒè™‘é¡µé¢é«˜é€Ÿç¼“å­˜çš„æƒ…å†µã€‚ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ç¨‹åºå¯ä»¥ç”±ä»¥ä¸‹ 5 ä¸ªå†…å­˜éƒ¨åˆ†ç»„æˆ</p><ul><li>å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜æ˜ å°„ï¼ˆé¡µé¢é«˜é€Ÿç¼“å­˜ï¼‰</li><li>ç¨‹åºæ‰“å¼€ä½¿ç”¨çš„åŒ¿åé¡µé¢</li><li>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ˜ å°„ï¼ˆåŒ…æ‹¬å¸¸ç”¨çš„æˆ–è€…ä¸å¸¸ç”¨çš„ï¼Œç”šè‡³åªç”¨ä¸€æ¬¡çš„é¡µé¢é«˜é€Ÿç¼“å­˜ï¼‰</li><li>è¿›ç¨‹è®¿é—®æ–‡ä»¶ç³»ç»Ÿæ—¶äº§ç”Ÿçš„å†…å®¹ç¼“å­˜</li><li>è¿›ç¨‹è®¿é—®å†…æ ¸äº§ç”Ÿæ—¶çš„å†…æ ¸ç¼“å†²å™¨ï¼ˆå¦‚ slabï¼‰ç­‰</li></ul><p>è®¾è®¡çš„å…³é”®æ˜¯å¦‚ä½•å¯»æ‰¾å’Œæ¯”è¾ƒä¸¤ä¸ªç›¸åŒçš„é¡µé¢ï¼Œå¦‚ä½•è®©è¿™ä¸ªè¿‡ç¨‹å˜å¾—é«˜æ•ˆè€Œä¸”å ç”¨çš„ç³»ç»Ÿèµ„æºæœ€å°‘ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¥½çš„è®¾è®¡äººå‘˜åº”è¯¥æ€è€ƒçš„é—®é¢˜ã€‚é¦–å…ˆä¸èƒ½ç”¨å“ˆå¸Œç®—æ³•æ¥æ¯”è¾ƒä¸¤ä¸ªé¡µé¢çš„ä¸“åˆ©é—®é¢˜ã€‚KSM è™½ç„¶ä½¿ç”¨äº† memcmp æ¥æ¯”è¾ƒï¼Œæœ€ç³Ÿç³•çš„æƒ…å†µæ˜¯ä¸¤ä¸ªé¡µé¢æœ€åçš„ 4 å­—èŠ‚ä¸ä¸€æ ·ä½†æ˜¯ KSM ä½¿ç”¨çº¢é»‘æ ‘æ¥è®¾è®¡äº†ä¸¤æ£µæ ‘ï¼Œåˆ†åˆ«æ˜¯ç¨³å®šçš„çº¢é»‘æ ‘å’Œä¸ç¨³å®šçš„çº¢é»‘æ ‘ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…æœ€ç³Ÿç³•çš„æƒ…å†µã€‚å¦å¤–ï¼ŒKSM ä¹Ÿå·§å¦™åœ°åˆ©ç”¨é¡µé¢çš„æ ¡éªŒå’Œæ¥æ¯”è¾ƒä¸ç¨³å®šçš„çº¢é»‘æ ‘çš„é¡µé¢æœ€è¿‘æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œä»è€Œé¿å¼€äº†è¯¥ä¸“åˆ©çš„ç¼ºé™·ã€‚ é¡µé¢åˆ†ä¸ºç‰©ç†é¡µé¢å’Œè™šæ‹Ÿé¡µé¢ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥åŒæ—¶æ˜ å°„åˆ°ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå› æ­¤éœ€è¦æŠŠæ˜ å°„åˆ°è¯¥é¡µé¢çš„æ‰€æœ‰ PTE éƒ½è§£é™¤åï¼Œæ‰æ˜¯ç®—çœŸæ­£é‡Šæ”¾ï¼ˆè¿™é‡Œè¯´çš„ PTE æ˜¯æŒ‡ç”¨æˆ·è¿›ç¨‹åœ°æ­¢ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜ å°„çš„è¯¥é¡µé¢çš„ PTEï¼Œç®€ç§°ç”¨æˆ· PTEï¼Œå› æ­¤ page-&gt;__mapcount æˆå‘˜é‡Œæè¿°çš„ PTE æ•°é‡ä¸åŒ…å«å†…æ ¸çº¿æ€§æ˜ å°„çš„ PTEï¼‰ã€‚ç›®å‰æœ‰ä¸¤ç§åšæ³•ï¼Œä¸€ç§åšæ³•æ˜¯æ‰«ææ¯ä¸ªè¿›ç¨‹ä¸­ç”¨æˆ·åœ°å€è¿›ç¨‹ç©ºé—´ï¼Œç”±ç”¨æˆ·åœ°å€è¿›ç¨‹ç©ºé—´çš„è™šæ‹Ÿåœ°å€æŸ¥è¯¢ MMU é¡µè¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„ page æ•°æ®ç»“æ„ï¼Œè¿™æ ·å°±æ‰¾åˆ°äº†ç”¨æˆ· PTEã€‚ç„¶åå¯¹æ¯” KSM ä¸­çš„ç¨³å®šæ ‘å’Œä¸ç¨³å®šæ ‘ï¼Œå¦‚æœæ‰¾åˆ°é¡µé¢å†…å®¹ç›¸åŒçš„ï¼Œå°±æŠŠè¯¥ PTE è®¾ç½®æˆå†™æ—¶å¤åˆ¶ï¼Œæ˜ å°„åˆ° KSM é¡µé¢ä¸­ï¼Œä»è€Œé‡Šæ”¾å‡ºä¸€ä¸ª PTEã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯é‡Šæ”¾å‡ºä¸€ä¸ªç”¨æˆ· PTEï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç‰©ç†é¡µé¢ï¼ˆå¦‚æœè¯¥ç‰©ç†é¡µé¢åªæœ‰ä¸€ä¸ª PTE æ˜ å°„ï¼Œé‚£å°±æ˜¯é‡Šæ”¾è¯¥é¡µï¼‰ã€‚å¦å¤–ä¸€ç§åšæ³•æ˜¯ç›´æ¥æ‰«æç³»ç»Ÿä¸­çš„ç‰©ç†é¡µé¢ï¼Œç„¶åé€šè¿‡ RMAP æ¥è§£é™¤è¯¥é¡µé¢æ‰€æœ‰çš„ç”¨æˆ· PTEï¼Œä»è€Œä¸€æ¬¡æ€§åœ°é‡Šæ”¾å‡ºç‰©ç†é¡µé¢ã€‚æ˜¾ç„¶ï¼Œç›®å‰å†…æ ¸çš„ KSM æ˜¯åŸºäºç¬¬ä¸€ç§åšæ³•ã€‚ KSM çš„ä½œè€…åœ¨ä»–çš„è®ºæ–‡ä¸­æœ‰å®æµ‹æ•°æ®ï¼Œä½†ä½œè€…ä¾ç„¶è¦šå¾—æœ‰ä¸€äº›æƒ…å†µä¸‹ä¼šæ¯”è¾ƒç³Ÿç³•ã€‚å¦‚åœ¨ä¸€ä¸ªå¾ˆå¤§å†…å­˜çš„æœåŠ¡å™¨ä¸Šï¼Œå¾ˆå¤šçš„åŒ¿åé¡µé¢éƒ½åŒæ—¶æ˜ å°„äº†å¤šä¸ªè™šæ‹Ÿé¡µé¢ã€‚å‡è®¾æ¯ä¸ªåŒ¿åé¡µé¢éƒ½æ˜ å°„äº† 1000 ä¸ªè™šæ‹Ÿé¡µé¢ï¼Œè¿™äº›è™šæ‹Ÿé¡µé¢åˆåŒæ—¶åˆ†å¸ƒåœ¨ä¸åŒçš„å­è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆè¦é‡Šæ”¾ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œéœ€è¦æ‰«æå®Œ 1000 ä¸ªè™šæ‹Ÿé¡µé¢æ‰€åœ¨çš„ç”¨æˆ·åœ°å€è¿›ç¨‹ç©ºé—´ï¼Œæ¯æ¬¡éƒ½è¦åˆ©ç”¨ follow_page()&nbsp;æŸ¥è¯¢é¡µè¡¨ï¼Œç„¶åæŸ»è¯¢ç¨³å®šæ ‘ï¼Œè¿˜éœ€è¦å¤šæ¬¡æ‰§è¡Œ memcmp æ¯”è¾ƒï¼Œåˆå¹¶ 10000 æ¬¡ PTE ä¹Ÿå°±æ„å‘³ç€ memcmp è¦æ‰§è¡Œ 10000 æ¬¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¾ˆæ¼«é•¿ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæœ‰å¾ˆå¤šäººæŠ±æ€¨ KSM çš„æ•ˆç‡ä½ï¼Œåœ¨å¾ˆå¤šé¡¹ç›®æ˜¯å…³é—­è¯¥ç‰¹æ€§çš„ã€‚ä¹Ÿæœ‰å¾ˆå¤šäººåœ¨æ€è€ƒå¦‚ä½•æé«˜ KSM çš„æ•ˆç‡ï¼ŒåŒ…æ‹¬åˆ©ç”¨æ–°çš„è½¯ä»¶ç®—æ³•æˆ–è€…åˆ©ç”¨ç¡¬ä»¶æœºåˆ¶ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆä¹ï¼‰é¡µé¢è¿ç§»å’Œå†…å­˜è§„æ•´</title>
      <link href="/2021/LinuxKernel/LinuxMemorymigrate/"/>
      <url>/2021/LinuxKernel/LinuxMemorymigrate/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Memorymigrate.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM4NjE3MTYzNzY4OTA3MTA1ZTU2Mzk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><blockquote><p>å£°æ˜æœ¬æ–‡è½¬è½½è‡ªçŸ¥ä¹ <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yNzAzNjY4Mjc=">Linux å†…å­˜ç®¡ç†ï¼šé¡µé¢è¿ç§»<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmJzbWF4LmNvbS9BL1pPSlByUWdvZHYv">Linux å†…å­˜ç®¡ç† (16) å†…å­˜è§„æ•´<i class="fa fa-external-link-alt"></i></span> å†…å­˜ç›¸å…³æ–‡ç« </p></blockquote><h1 id="é¡µé¢è¿ç§»">é¡µé¢è¿ç§»</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>é¡µé¢è¿ç§» (migrate) æ˜¯å†…å­˜ç®¡ç†ä¸­å¾ˆå¤šåŠŸèƒ½å®ç°çš„åŸºç¡€ï¼Œæ¯”æ–¹è¯´å†…å­˜è§„æ•´ã€NUMA balanceã€å†…å­˜çƒ­æ’æ‹”ã€CMAã€HugeTLBã€å†…å­˜æ°”çƒç­‰ç­‰ï¼Œæœ¬æ–‡ä¸»è¦è®²ä¸€ä¸‹é¡µé¢è¿ç§»çš„ä¸»è¦æµç¨‹å’Œåº”ç”¨ã€‚</p><h2 id="é¡µé¢è¿ç§»çš„-api">é¡µé¢è¿ç§»çš„ API</h2><p>migrate_pages( ) è¿™æ˜¯é¡µé¢è¿ç§»åœ¨å†…æ ¸æ€çš„ä¸»è¦æ¥å£ï¼Œå†…æ ¸ä¸­æ¶‰åŠåˆ°é¡µé¢è¿ç§»çš„åŠŸèƒ½å¤§éƒ½ä¼šè°ƒåˆ°å®ƒã€‚å½“ç„¶ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ä¹Ÿå­˜åœ¨ç€å†…å­˜è¿ç§»ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆä¹Ÿä¼šè°ƒåˆ°å®ƒã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡ migrate_pages( ) çš„å‡ ä¸ªå½¢å‚å±•å¼€å…¨æ–‡ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * migrate_pages - migrate the pages specified in a list, to the free pages</span></span><br><span class="line"><span class="comment"> *                 supplied as the target for the page migration</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @from:               The list of pages to be migrated.</span></span><br><span class="line"><span class="comment"> * @get_new_page:       The function used to allocate free pages to be used</span></span><br><span class="line"><span class="comment"> *                      as the target of the page migration.</span></span><br><span class="line"><span class="comment"> * @put_new_page:       The function used to free target pages if migration</span></span><br><span class="line"><span class="comment"> *                      fails, or NULL if no special handling is necessary.</span></span><br><span class="line"><span class="comment"> * @private:            Private data to be passed on to get_new_page()</span></span><br><span class="line"><span class="comment"> * @mode:               The migration mode that specifies the constraints for</span></span><br><span class="line"><span class="comment"> *                      page migration, if any.</span></span><br><span class="line"><span class="comment"> * @reason:             The reason for page migration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">migrate_pages</span><span class="params">(<span class="keyword">struct</span> list_head *from, <span class="type">new_page_t</span> get_new_page,</span></span><br><span class="line"><span class="params">                <span class="type">free_page_t</span> put_new_page, <span class="type">unsigned</span> <span class="type">long</span> private,</span></span><br><span class="line"><span class="params">                <span class="keyword">enum</span> migrate_mode mode, <span class="type">int</span> reason)</span></span><br></pre></td></tr></tbody></table></figure><p>å½¢å‚å«ä¹‰æ ¹æ®ä¸Šé¢çš„æ³¨é‡Šå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å•ç‹¬è¯´ä¸‹ mode å’Œ reasonï¼Œä»–ä»¬åˆ†åˆ«è¡¨ç¤ºè¿ç§»æ¨¡å¼å’Œè¿ç§»åŸå› ã€‚</p><h2 id="è¿ç§»æ¨¡å¼">è¿ç§»æ¨¡å¼</h2><p>è¿ç§»æ¨¡å¼ä¸»è¦ä¼šå½±å“è¿ç§»è¿‡ç¨‹ä¸­å¯¹ä¸€äº›è¡Œä¸ºçš„è¿‡æ»¤ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIGRATE_ASYNC        <span class="comment">//å¼‚æ­¥è¿ç§»ï¼Œè¿‡ç¨‹ä¸­ä¸ä¼šå‘ç”Ÿé˜»å¡</span></span><br><span class="line">MIGRATE_SYNC_LIGHT   <span class="comment">//è½»åº¦åŒæ­¥è¿ç§»ï¼Œå…è®¸å¤§éƒ¨åˆ†çš„é˜»å¡æ“ä½œï¼Œå”¯ç‹¬ä¸å…è®¸è„é¡µçš„å›å†™æ“ä½œ</span></span><br><span class="line">MIGRATE_SYNC         <span class="comment">//åŒæ­¥è¿ç§»ï¼Œè¿ç§»è¿‡ç¨‹ä¼šå‘ç”Ÿé˜»å¡ï¼Œè‹¥éœ€è¦è¿ç§»çš„æŸä¸ª page æ­£åœ¨ writeback æˆ–è¢« locked ä¼šç­‰å¾…å®ƒå®Œæˆ</span></span><br><span class="line">MIGRATE_SYNC_NO_COPY <span class="comment">//åŒæ­¥è¿ç§»ï¼Œä½†ä¸ç­‰å¾…é¡µé¢çš„æ‹·è´è¿‡ç¨‹ã€‚é¡µé¢çš„æ‹·è´é€šè¿‡å›è°ƒ migratepage()ï¼Œè¿‡ç¨‹å¯èƒ½ä¼šæ¶‰åŠ DMA</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸¾ä¾‹ï¼šå†…å­˜è§„æ•´ (compact) ä¸­ä¼šè°ƒç”¨ migrate_pages()ï¼ŒåŒæ—¶ä¹Ÿä¼šè®¾ç½®è¿ç§»æ¨¡å¼ï¼ˆä½äº compact_control-&gt;mode)ã€‚è‹¥æ˜¯ sysfs ä¸»åŠ¨è§¦å‘çš„å†…å­˜è§„æ•´ä¼šç”¨ MIGRATE_SYNC æ¨¡å¼ï¼›è‹¥æ˜¯ kcompactd è§¦å‘çš„è§„æ•´ä¼šç”¨ MIGRATE_SYNC_LIGHT æ¨¡å¼ï¼›è‹¥æ˜¯å†…å­˜åˆ†é… slowpath ä¸­è§¦å‘çš„ä¼šæ ¹æ® compact prior å»è®¾ç½®ç”¨ MIGRATE_ASYNC æˆ– MIGRATE_SYNC_LIGHT æ¨¡å¼ã€‚</p><h2 id="è¿ç§»åŸå› ">è¿ç§»åŸå› </h2><p>è¿ç§»åŸå› ä¸»è¦ä½¿ç”¨æ¥è®°å½•æ˜¯ä»€ä¹ˆåŠŸèƒ½è§¦å‘äº†è¿ç§»çš„è¡Œä¸ºï¼Œæ¯•ç«Ÿé¡µé¢è¿ç§»å¯¹ç³»ç»Ÿæœ¬èº«æ˜¯ä¸ªä¸å°çš„ overheadï¼Œæ‰€ä»¥çŸ¥é“è¿ç§»çš„åŸå› å¾ˆæœ‰å¿…ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MR_COMPACTION      <span class="comment">//å†…å­˜è§„æ•´å¯¼è‡´çš„è¿ç§»</span></span><br><span class="line">MR_MEMORY_FAILURE  <span class="comment">//å½“å†…å­˜å‡ºç°ç¡¬ä»¶é—®é¢˜ (ECC æ ¡éªŒå¤±è´¥ç­‰ï¼‰æ—¶è§¦å‘çš„é¡µé¢è¿ç§»ã€‚ å‚è€ƒ memory-failure.c</span></span><br><span class="line">MR_MEMORY_HOTPLUG  <span class="comment">//å†…å­˜çƒ­æ’æ‹”å¯¼è‡´çš„è¿ç§»</span></span><br><span class="line">MR_SYSCALL         <span class="comment">//åº”ç”¨å±‚ä¸»åŠ¨è°ƒç”¨ migrate_pages() æˆ– move_pages() è§¦å‘çš„è¿ç§»</span></span><br><span class="line">MR_MEMPOLICY_MBIND <span class="comment">//è°ƒç”¨ mbind ç³»ç»Ÿè°ƒç”¨è®¾ç½® memory policy æ—¶è§¦å‘çš„è¿ç§»</span></span><br><span class="line">MR_NUMA_MISPLACED  <span class="comment">//numa balance è§¦å‘çš„é¡µé¢è¿ç§» (node ä¹‹é—´ï¼‰</span></span><br><span class="line">MR_CONTIG_RANGE    <span class="comment">//è°ƒç”¨ alloc_contig_range() ä¸º CMA æˆ– HugeTLB åˆ†é…è¿ç»­å†…å­˜æ—¶è§¦å‘çš„è¿ç§»ï¼ˆå’Œ compact ç›¸å…³ï¼‰</span></span><br></pre></td></tr></tbody></table></figure><p>å»¶ä¼¸ï¼šå¯¹ä¸Šé¢ MR_SYSCALL è¿ç§»åŸå› ä¸­æåˆ°çš„ä¸¤ä¸ª APIï¼ˆä½äº libnuma åº“ï¼‰çš„ç®€å•ä»‹ç»ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å«ä¹‰ï¼šæŠŠæŸ pid è¿›ç¨‹çš„æ‰€æœ‰é¡µé¢ä»æº numa node è¿ç§»åˆ°ç›®æ ‡ numa nodes ç»„ä¸­ï¼Œå¯¹åº”ç³»ç»Ÿè°ƒç”¨ sys_migrate_pages()</span></span><br><span class="line">migrate_pages()  <span class="comment">//å’Œ kernel ä¸­æ¥å£åŒåï¼Œåˆ«ææ··äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å«ä¹‰ï¼šæŠŠè¿›ç¨‹åˆ°éƒ¨åˆ†é¡µé¢è¿ç§»ç›®æ ‡ numa node ä¸­ï¼Œå¯¹åº”ç³»ç»Ÿè°ƒç”¨ sys_move_pages()</span></span><br><span class="line">move_pages()</span><br></pre></td></tr></tbody></table></figure><h2 id="migrate_pages-ä»‹ç»">migrate_pages() ä»‹ç»</h2><p>é€šè¿‡ä¸Šé¢å¯¹è¿ç§»åŸå› çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“äº†é¡µé¢è¿ç§»çš„åŸå› å„ç§å„æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡å†…å­˜è§„æ•´ (memory compact) è¿™æ ·ä¸€ä¸ªå®é™…çš„ä¾‹å­å±•å¼€ä»‹ç»ï¼Œä¸‹å›¾ä¸»è¦ä½“ç°äº†å†…å­˜è§„æ•´å’Œé¡µé¢è¿ç§»çš„å…³ç³»ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/migrate1.jpg"></p><p>é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬çœ‹å‡ºé¡µé¢è¿ç§»åœ¨å†…å­˜è§„æ•´ä¸­ä¸¾è¶³è½»é‡çš„åœ°ä½ã€‚ä¸‹é¢åˆ™æ˜¯å†…å­˜è§„æ•´è°ƒç”¨ migrate_pages() çš„å‡½æ•°å…³ç³»ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compact_zone           <span class="comment">//å†…å­˜è§„æ•´</span></span><br><span class="line">  -&gt;migrate_pages      <span class="comment">//é¡µé¢è¿ç§»çš„å…¥å£å‡½æ•°</span></span><br><span class="line">    -&gt;unmap_and_move   <span class="comment">//é¡µé¢è¿ç§»çš„æ ¸å¿ƒå®ç°</span></span><br></pre></td></tr></tbody></table></figure><p>ç°åœ¨åˆ‡å…¥é‡ç‚¹ï¼Œé¡µé¢è¿ç§» (migrate) è¿‡ç¨‹åšäº†é‚£äº›äº‹æƒ…ï¼š</p><h2 id="è¿ç§»å‰çš„å‡†å¤‡">è¿ç§»å‰çš„å‡†å¤‡</h2><ul><li>è·å– old page çš„é¡µé¢é” PG_locked ï¼ˆå¼‚æ­¥æ¨¡å¼æ‹¿ä¸åˆ°é”å°±ç›´æ¥è·³è¿‡æ­¤é¡µé¢ï¼‰</li><li>è‹¥æ˜¯æ­£åœ¨ writeback çš„é¡µé¢ï¼Œåˆ™æ ¹æ®è¿ç§»æ¨¡å¼åˆ¤æ–­æ˜¯å¦ç­‰å¾…é¡µé¢ wirtebackï¼ˆMIGRATE_SYNC_LIGHT å’Œ MIGRATE_ASYNC ä¸ç­‰å¾…ï¼‰</li><li>è·å– new page çš„é¡µé¢é” PG_locked (new page æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šè·å–å¤±è´¥ï¼‰</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/migrate2.jpg"></p><h2 id="è§£é™¤-old-page-çš„é¡µè¡¨æ˜ å°„">è§£é™¤ old page çš„é¡µè¡¨æ˜ å°„</h2><p>è°ƒç”¨ try_to_unmap()ï¼Œé€šè¿‡åå‘æ˜ å°„æœºåˆ¶è§£é™¤ old page æ‰€æœ‰ç›¸å…³çš„ PTEs <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/migrate3.jpg"></p><h2 id="è®¾ç½®-new-page-çš„é¡µé¢å†…å®¹å…ƒæ•°æ®åŠæ˜ å°„å…³ç³»">è®¾ç½® new page çš„é¡µé¢å†…å®¹ã€å…ƒæ•°æ®åŠæ˜ å°„å…³ç³»</h2><p>è°ƒç”¨ move_to_new_page æ‹·è´ old page çš„å†…å®¹å’Œ struct page å…ƒæ•°æ®åˆ° new pageï¼Œå¹¶é€šè¿‡åå‘æ˜ å°„æœºåˆ¶å»ºç«‹ new page çš„æ˜ å°„å…³ç³»ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/migrate4.jpg"></p><h2 id="é¡µé¢è¿ç§»çš„æ”¶å°¾å·¥ä½œ">é¡µé¢è¿ç§»çš„æ”¶å°¾å·¥ä½œ</h2><ul><li>è¿ç§»å®Œæˆé‡Šæ”¾æ–°æ—§é¡µé¢çš„ PG_locked</li><li>è®¾ç½®è¿ç§»åŸå› </li><li>è°ƒç”¨ put_page é‡Šæ”¾ old page å¼•ç”¨è®¡æ•° (_refcount å‡ 1)</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/migrate5.jpg"></p><p>è¡¥å……ï¼šä»€ä¹ˆæ ·çš„é¡µé¢æ‰æ”¯æŒè¿ç§»å‘¢ï¼Ÿ</p><ul><li>lru ä¸Šçš„ pageï¼Œå› ä¸ºä¸Šé¢æŒ‚çš„æ˜¯ user spcace ç”¨çš„ pagesï¼Œéƒ½æ˜¯ä» buddy åˆ†é…å™¨ migrate type ä¸º movable æˆ– reclaim çš„ pageblock ä¸Šåˆ†æ¥çš„</li><li>no-lru ä½†æ˜¯ movable çš„é¡µé¢ã€‚no-lru çš„é¡µé¢é€šå¸¸æ˜¯ä¸º kernel space åˆ†é…çš„ pageï¼Œè¿™ç§é¡µé¢é€šå¸¸æ˜¯ unmovable çš„ï¼Œä½†æ˜¯ä¸‹é¢è¿™ä¸ª commit ä½¿å¾—é©±åŠ¨ä¸­ç”¨åˆ°çš„é¡µé¢ä¹Ÿå¯ä»¥æ”¯æŒè¿ç§»ã€‚ä½†æ˜¯åœ¨é©±åŠ¨å®ç°çš„è¿‡ç¨‹ä¸­éœ€è¦ç½®ä½ page-&gt;mapping ä¸­çš„ second bitï¼Œå¹¶ä¸”å®ç° page-&gt;mapping-&gt;a_ops ä¸­çš„ç›¸å…³æ–¹æ³•</li></ul><h1 id="å†…å­˜è§„æ•´">å†…å­˜è§„æ•´</h1><p>å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿï¼šä¼™ä¼´ç³»ç»Ÿä»¥é¡µä¸ºå•ä½è¿›è¡Œç®¡ç†ï¼Œç»è¿‡å¤§é‡ç”³è¯·é‡Šæ”¾ï¼Œé€ æˆå¤§é‡ç¦»æ•£ä¸”ä¸è¿ç»­çš„é¡µé¢ã€‚è¿™æ—¶å°±äº§ç”Ÿäº†å¾ˆå¤šç¢ç‰‡ã€‚ n å†…å­˜è§„æ•´ä¹Ÿå³å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå†…å­˜ç¢ç‰‡ä¹Ÿæ˜¯ä»¥é¡µé¢ä¸ºå•ä½çš„ã€‚å®ç°åŸºç¡€æ˜¯å†…å­˜é¡µé¢æŒ‰ç…§å¯ç§»åŠ¨æ€§è¿›è¡Œåˆ†ç»„ã€‚å†…å­˜è§„æ•´çš„å®ç°åŸºç¡€æ˜¯é¡µé¢è¿ç§»ã€‚ Linux å†…æ ¸ä»¥ pageblock ä¸ºå•ä½æ¥ç®¡ç†é¡µçš„è¿ç§»å±æ€§ã€‚</p><h2 id="å†…å­˜è§„æ•´çš„è§¦å‘">å†…å­˜è§„æ•´çš„è§¦å‘</h2><p>ä¸‹é¢æ˜¯å†…å­˜é¡µé¢åˆ†é…ï¼Œä»¥åŠåˆ†é…å¤±è´¥ä¹‹åé‡‡å–çš„æªæ–½ï¼Œä»¥ä¾¿ä¿ƒæˆåˆ†é…æˆåŠŸã€‚ å¯ä»¥çœ‹å‡ºé‡‡å–çš„æªæ–½ï¼Œè¶Šæ¥è¶Šé‡ã€‚é¦–å…ˆé‡‡ç”¨ kswapd æ¥è¿›è¡Œé¡µé¢å›æ”¶ï¼Œç„¶åå°è¯•é¡µé¢è§„æ•´ã€ç›´æ¥é¡µé¢å›æ”¶ï¼Œæœ€åæ˜¯ OOM æ€æ­»è¿›ç¨‹æ¥è·å–æ›´å¤šå†…å­˜ç©ºé—´</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alloc_pages-------------------------------------é¡µé¢åˆ†é…çš„å…¥å£</span><br><span class="line">  -&gt;__alloc_pages_nodemask</span><br><span class="line">    -&gt;get_page_from_freelist--------------------ç›´æ¥ä» zonelist çš„ç©ºé—²åˆ—è¡¨ä¸­åˆ†é…é¡µé¢</span><br><span class="line">    -&gt;__alloc_pages_slowpath--------------------åœ¨åˆæ¬¡å°è¯•åˆ†é…å¤±è´¥åï¼Œè¿›å…¥ slowpath è·¯å¾„åˆ†é…é¡µé¢</span><br><span class="line">      -&gt;wake_all_kswapds------------------------å”¤é†’ kswapd å†…æ ¸çº¿ç¨‹è¿›è¡Œé¡µé¢å›æ”¶</span><br><span class="line">      -&gt;get_page_from_freelist------------------kswapd é¡µé¢å›æ”¶åå†æ¬¡è¿›è¡Œé¡µé¢åˆ†é…</span><br><span class="line">      -&gt;__alloc_pages_direct_compact------------è¿›è¡Œé¡µé¢è§„æ•´ï¼Œç„¶åè¿›è¡Œé¡µé¢åˆ†é…</span><br><span class="line">      -&gt;__alloc_pages_direct_reclaim------------ç›´æ¥é¡µé¢å›æ”¶ï¼Œç„¶åè¿›è¡Œé¡µé¢åˆ†é…</span><br><span class="line">      -&gt;__alloc_pages_may_oom-------------------å°è¯•è§¦å‘ OOM</span><br></pre></td></tr></tbody></table></figure><p>å¦ä¸€æ¡è·¯å¾„æ˜¯åœ¨ kswapd çš„ balance_pgdat ä¸­ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œå†…å­˜è§„æ•´ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kswapd</span><br><span class="line">  -&gt;balance_pgdat-------------------------------éå†å†…å­˜èŠ‚ç‚¹çš„ zoneï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºå¹³è¡¡çŠ¶æ€å³ WMARK_HIGHã€‚</span><br><span class="line">    -&gt;compact_pgdat-----------------------------é’ˆå¯¹æ•´ä¸ªå†…å­˜èŠ‚ç‚¹è¿›è¡Œå†…å­˜è§„æ•´</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ compact_pddat-&gt;__compact_pgdat-&gt;compact_zoneï¼Œæœ€ç»ˆçš„å®ç°å’Œ__alloc_pages_direct_compact è°ƒç”¨ compact_zone ä¸€æ ·ã€‚</p><h2 id="å†…å­˜è§„æ•´ç›¸å…³èŠ‚ç‚¹">å†…å­˜è§„æ•´ç›¸å…³èŠ‚ç‚¹</h2><p>å†…å­˜è§„æ•´ç›¸å…³æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œcompact_memory ç”¨äºè§¦å‘å†…å­˜è§„æ•´ï¼›extfrag_threshold å½±å“å†…æ ¸å†³ç­–æ˜¯é‡‡ç”¨å†…å­˜è§„æ•´è¿˜æ˜¯ç›´æ¥å›æ”¶æ¥æ»¡è¶³å¤§å†…å­˜åˆ†é…ã€‚</p><p>èŠ‚ç‚¹å…¥å£ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ctl_table</span> <span class="title">vm_table</span>[] =</span> {</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">    {</span><br><span class="line">        .procname    = <span class="string">"compact_memory"</span>,</span><br><span class="line">        .data        = &amp;sysctl_compact_memory,</span><br><span class="line">        .maxlen        = <span class="keyword">sizeof</span>(<span class="type">int</span>),</span><br><span class="line">        .mode        = ,</span><br><span class="line">        .proc_handler    = sysctl_compaction_handler,</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">        .procname    = <span class="string">"extfrag_threshold"</span>,</span><br><span class="line">        .data        = &amp;sysctl_extfrag_threshold,</span><br><span class="line">        .maxlen        = <span class="keyword">sizeof</span>(<span class="type">int</span>),</span><br><span class="line">        .mode        = ,</span><br><span class="line">        .proc_handler    = sysctl_extfrag_handler,</span><br><span class="line">        .extra1        = &amp;min_extfrag_threshold,</span><br><span class="line">        .extra2        = &amp;max_extfrag_threshold,</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_COMPACTION */</span></span></span><br><span class="line">...</span><br><span class="line">    { }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><p>/proc/sys/vm/compact_memoryï¼š æ‰“å¼€ compaction Tracepointï¼šecho 1 &gt; /sys/kernel/debug/tracing/events/compaction/enable<br>è§¦å‘å†…å­˜è§„æ•´ï¼šsysctl -w vm.compact_memory=1<br>æŸ¥çœ‹ Tracepointï¼šcat /sys/kernel/debug/tracing/trace</p></li><li><p>/proc/sys/vm/extfrag_thresholdï¼š åœ¨ compact_zone ä¸­è°ƒç”¨å‡½æ•° compaction_suitable-&gt;__compaction_suitable è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿›è¡Œå†…å­˜è§„æ•´<br>å’Œ extfrag_threshold ç›¸å…³éƒ¨åˆ†å¦‚ä¸‹ï¼Œå¦‚æœå½“å‰ fragindex ä¸è¶…è¿‡ sysctl_extfrag_thresholdï¼Œåˆ™ä¸ä¼šç»§ç»­è¿›è¡Œå†…å­˜è§„æ•´<br>æ‰€ä»¥è¿™ä¸ªå‚æ•°è¶Šå°è¶Šå€¾å‘äºè¿›è¡Œå†…å­˜è§„æ•´ï¼Œè¶Šå¤§è¶Šä¸å®¹æ˜“è¿›è¡Œå†…å­˜è§„æ•´</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> __compaction_suitable(<span class="keyword">struct</span> zone *zone, <span class="type">int</span> order,</span><br><span class="line">                    <span class="type">int</span> alloc_flags, <span class="type">int</span> classzone_idx)</span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line">    fragindex = fragmentation_index(zone, order);</span><br><span class="line">    <span class="keyword">if</span> (fragindex &gt;= <span class="number">0</span> &amp;&amp; fragindex &lt;= sysctl_extfrag_threshold)</span><br><span class="line">        <span class="keyword">return</span> COMPACT_NOT_SUITABLE_ZONE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> COMPACT_CONTINUE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>è®¾ç½® extfrag_thresholdï¼šsysctl -w vm.extfrag_threshold=500</p></li><li><p>å…¶å®ƒ Debug ä¿¡æ¯ï¼š /sys/kernel/debug/extfrag/extfrag_index /sys/kernel/debug/extfrag/unusable_index</p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yNzAzNjY4Mjc=">https://zhuanlan.zhihu.com/p/270366827<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmJzbWF4LmNvbS9BL1pPSlByUWdvZHYv">https://www.bbsmax.com/A/ZOJPrQgodv/<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆå…«ï¼‰é¡µé¢å›æ”¶</title>
      <link href="/2021/LinuxKernel/LinuxMemoryPageRecycle/"/>
      <url>/2021/LinuxKernel/LinuxMemoryPageRecycle/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryRecycle.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM4NTkyMDFlMDg1MzA2ZjhjODBhY2Q=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><p>Linux æ“ä½œç³»ç»Ÿä¼šä½¿ç”¨å­˜å‚¨è®¾å¤‡ä½œä¸ºäº¤æ¢åˆ†åŒºï¼Œå†…æ ¸å°†å¾ˆå°‘ä½¿ç”¨çš„å†…å­˜æ¢å‡ºåˆ°äº¤æ¢åˆ†åŒºï¼Œä»¥ä¾¿é‡Šæ”¾å‡ºç‰©ç†å†…å­˜ï¼Œè¿™ä¸ªæœºåˆ¶ç§°ä¸ºé¡µäº¤æ¢ï¼ˆswappingï¼‰ï¼Œè¿™äº›å¤„ç†æœºåˆ¶ç»Ÿç§°ä¸ºé¡µé¢å›æ”¶ (pagereclaim)ã€‚</p><h1 id="lru-é“¾è¡¨">LRU é“¾è¡¨</h1><p>Linux å†…æ ¸ä¸­é‡‡ç”¨çš„é¡µäº¤æ¢ç®—æ³•ä¸»è¦æ˜¯ç»å…¸ LRU é“¾è¡¨ç®—æ³•å’Œç¬¬äºŒæ¬¡æœºä¼šï¼ˆsecondchanceï¼‰æ³•ã€‚ LRU æ˜¯ Least Recently Used çš„ç¼©å†™ï¼Œæ„ä¸ºæœ€è¿‘æœ€å°‘ä½¿ç”¨ã€‚æ ¹æ®å±€éƒ¨æ€§åŸç†ï¼ŒLRU å‡å®šæœ€è¿‘ä¸ä½¿ç”¨çš„é¡µé¢åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…ä¹Ÿä¸ä¼šé¢‘ç¹ä½¿ç”¨ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼Œè¿™äº›é¡µé¢å°†æˆä¸ºè¢«æ¢å‡ºçš„å€™é€‰è€…ã€‚å†…æ ¸ä½¿ç”¨åŒå‘é“¾è¡¨æ¥å®šä¹‰ LRU é“¾è¡¨ï¼Œå¹¶ä¸”æ ¹æ®é¡µé¢çš„ç±»å‹å°† LRU é“¾è¡¨åˆ†ä¸º LRU_ANON å’Œ LRU_FILEã€‚æ¯ç§ç±»å‹æ ¹æ®é¡µé¢çš„æ´»è·ƒæ€§åˆ†ä¸ºæ´»è·ƒ LRU é“¾è¡¨å’Œä¸æ´»è·ƒ LRU é“¾è¡¨ï¼Œæ‰€ä»¥å†…æ ¸ä¸­ä¸€å…±æœ‰å¦‚ä¸‹ 5 ä¸ª LRU é“¾è¡¨ã€‚</p><ul><li>ä¸æ´»è·ƒåŒ¿åé¡µé¢é“¾è¡¨ LRU_INACTIVE_ANON</li><li>æ´»è·ƒåŒ¿åé¡µé¢é“¾è¡¨ LRU_ACTIVE_ANON</li><li>ä¸æ´»è·ƒæ–‡ä»¶æ˜ å°„é¡µé¢é“¾è¡¨ LRU_INACTIVE_FILE</li><li>æ´»è·ƒæ–‡ä»¶æ˜ å°„é¡µé¢é“¾è¡¨ LRU_ACTIVE_FILE</li><li>ä¸å¯å›æ”¶é¡µé¢é“¾è¡¨ LRU_UNEVICTABLE</li></ul><p>LRU é“¾è¡¨ä¹‹æ‰€ä»¥è¦åˆ†æˆè¿™æ ·ï¼Œæ˜¯å› ä¸ºå½“å†…å­˜ç´§ç¼ºæ—¶æ€»æ˜¯ä¼˜å…ˆæ¢å‡ºæ–‡ä»¶æ˜ å°„çš„æ–‡ä»¶ç¼“å­˜é¡µé¢ï¼ˆLRU FILE é“¾è¡¨ä¸­çš„é¡µé¢ï¼‰è€ŒåŒ¿åé¡µé¢æ€»æ˜¯è¦åœ¨å†™å…¥äº¤æ¢åˆ†åŒºä¹‹åï¼Œæ‰èƒ½è¢«æ¢å‡ºã€‚</p><p>LRU é“¾è¡¨æŒ‰ç…§å†…å­˜èŠ‚ç‚¹ï¼ˆä¹‹å‰ç‰ˆæœ¬æ˜¯ zponeï¼‰é…ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå†…å­˜èŠ‚ç‚¹ä¸­éƒ½æœ‰ä¸€æ•´å¥— LRU é“¾è¡¨ï¼Œå› æ­¤å†…å­˜èŠ‚ç‚¹çš„æè¿°ç¬¦æ•°æ®ç»“æ„ï¼ˆpglist_dataï¼‰ä¸­æœ‰ä¸€ä¸ªæˆå‘˜ lruvec æŒ‡å‘è¿™äº›é“¾è¡¨ã€‚æšä¸¾ç±»å‹å˜é‡ lru_list åˆ—ä¸¾å‡ºä¸Šè¿°å„ç§ LRU é“¾è¡¨çš„ç±»å‹ï¼Œlruvec æ•°æ®ç»“æ„ä¸­å®šä¹‰äº†ä¸Šè¿°å„ç§ LRU ç±»å‹çš„é“¾è¡¨ã€‚</p><h1 id="ç¬¬äºŒæ¬¡æœºä¼šæ³•">ç¬¬äºŒæ¬¡æœºä¼šæ³•</h1><p>ç¬¬äºŒæ¬¡æœºä¼šæ³•çš„æ”¹è¿›æ˜¯ä¸ºäº†é¿å…æŠŠç»å¸¸ä½¿ç”¨çš„é¡µé¢ç½®æ¢å‡ºå»ã€‚å½“é€‰æ‹©ç½®æ¢é¡µé¢æ—¶ï¼Œä¾ç„¶å’Œç»å…¸ LRU é“¾è¡¨ç®—æ³•ä¸€æ ·ï¼Œé€‰æ‹©æœ€æ—©ç½®å…¥é“¾è¡¨çš„é¡µé¢ï¼Œç¬¬äºŒæ¬¡æœºä¼šæ³•è®¾ç½®äº†ä¸€ä¸ªè®¿é—®çŠ¶æ€ä½ï¼ˆç¡¬ä»¶æ§åˆ¶çš„ä½ï¼‰ï¼Œæ‰€ä»¥è¦æ£€æŸ¥é¡µé¢çš„è®¿é—®ä½ã€‚å¦‚æœè®¿é—®ä½æ˜¯ 0ï¼Œå°±æ·˜æ±°è¿™ä¸ªé¡µé¢ï¼›å¦‚æœè®¿é—®ä½æ˜¯ 1ï¼Œå°±ç»™å®ƒç¬¬äºŒæ¬¡æœºä¼šï¼Œå¹¶é€‰æ‹©ä¸‹ä¸€ä¸ªé¡µé¢æ¥æ¢å‡ºã€‚å½“è¯¥é¡µé¢å¾—åˆ°ç¬¬äºŒæ¬¡æœºä¼šæ—¶ï¼Œå®ƒçš„è®¿é—®ä½è¢«æ¸…é›¶ï¼Œå¦‚æœè¯¥é¡µé¢åœ¨æ­¤æœŸé—´å†æ¬¡è¢«è®¿é—®è¿‡ï¼Œåˆ™è®¿é—®ä½è®¾ç½®ä¸º 1ã€‚äºæ˜¯ï¼Œç»™äº†ç¬¬äºŒæ¬¡æœºä¼šçš„é¡µé¢å°†ä¸ä¼šè¢«æ·˜æ±°ï¼Œç›´è‡³å…¶ä»–é¡µé¢è¢«æ·˜æ±°ï¼ˆæˆ–è€…ä¹Ÿç»™äº†ç¬¬äºŒæ¬¡æœºä¼šï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªé¡µé¢ç»å¸¸è¢«ä½¿ç”¨ï¼Œå…¶è®¿é—®ä½æ€»ä¿æŒä¸º 1ï¼Œå®ƒä¸€ç›´ä¸ä¼šè¢«æ·˜æ±°ã€‚</p><p>Linux å†…æ ¸ä½¿ç”¨ PG_active å’Œ PG_referenced è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ¥å®ç°ç¬¬äºŒæ¬¡æœºä¼šæ³•ã€‚PG_active è¡¨ç¤ºè¯¥é¡µé¢æ˜¯å¦æ´»è·ƒï¼ŒPG_referenced è¡¨ç¤ºè¯¥é¡µé¢æ˜¯å¦è¢«å¼•ç”¨è¿‡ã€‚</p><h1 id="å®ç°">å®ç°</h1><h2 id="lru-é“¾è¡¨ç»´æŠ¤">LRU é“¾è¡¨ç»´æŠ¤</h2><p>æˆ‘ä»¬éœ€è¦æœ‰ timestamp æ¥æ ‡è¯†ä¸€ä¸ª page æœ€è¿‘è¢«è®¿é—®çš„æ—¶é—´ï¼Œç„¶è€Œåƒ x86 è¿™æ ·çš„æ¶æ„å¹¶æ²¡æœ‰ä»ç¡¬ä»¶ä¸Šæä¾›è¿™ç§æœºåˆ¶ã€‚</p><p>Linux é‡‡ç”¨çš„æ–¹æ³•æ˜¯ç»´æŠ¤ 2 ä¸ªåŒå‘é“¾è¡¨ï¼Œä¸€ä¸ªæ˜¯åŒ…å«äº†æœ€è¿‘ä½¿ç”¨é¡µé¢çš„ active listï¼Œå¦ä¸€ä¸ªæ˜¯åŒ…å«äº†æœ€è¿‘ä¸ä½¿ç”¨é¡µé¢çš„ inactive listï¼Œå¹¶ä¸”åœ¨ struct page çš„ page flags ä¸­ä½¿ç”¨äº† PG_referenced å’Œ PG_active ä¸¤ä¸ªæ ‡å¿—ä½æ¥æ ‡è¯†é¡µé¢çš„æ´»è·ƒç¨‹åº¦ã€‚</p><ul><li>PG_active æ ‡å¿—ä½å†³å®š page åœ¨å“ªä¸ªé“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ active list ä¸­çš„ pages çš„ PG_active éƒ½ä¸º 1ï¼Œè€Œ inactive list ä¸­çš„ pages çš„ PG_active éƒ½ä¸º 0ã€‚</li><li>PG_referenced æ ‡å¿—ä½åˆ™æ˜¯è¡¨æ˜ page æœ€è¿‘æ˜¯å¦è¢«ä½¿ç”¨è¿‡ã€‚å½“ä¸€ä¸ª page è¢«è®¿é—®ï¼Œmark_page_accessed() ä¼šæ£€æµ‹è¯¥ page çš„ PG_referenced ä½ï¼Œå¦‚æœ PG_referenced ä¸º 0ï¼Œåˆ™å°†å…¶ç½®ä¸º 1ã€‚</li></ul><p>å¦‚æœ inactive list ä¸Š PG_referenced ä¸º 1 çš„ page åœ¨å›æ”¶ä¹‹å‰è¢«å†æ¬¡è®¿é—®åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåœ¨ inactive list ä¸­æ—¶è¢«è®¿é—®äº† 2 æ¬¡ï¼Œmark_page_accessed() å°±ä¼šè°ƒç”¨ activate_page() å°†å…¶ç½®æ¢åˆ° active list çš„å¤´éƒ¨ï¼ŒåŒæ—¶å°†å…¶ PG_active ä½ç½® 1ï¼ŒPG_referenced ä½æ¸… 0ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸¤ä¸ª PG_referenced æ‰æ¢æ¥ä¸€ä¸ª PG_activeï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš promotionï¼ˆé€†è¢­ï¼‰ã€‚</p><p>è¿™ 3 ç§æƒ…æ™¯çš„ä»£ç å®ç°æ˜¯è¿™æ ·çš„ï¼ˆä¸ºäº†æ¼”ç¤ºéœ€è¦åœ¨æºä»£ç çš„åŸºç¡€ä¸Šåšäº†ç®€åŒ–å’Œä¿®æ”¹ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">mark_page_accessed</span><span class="params">(<span class="keyword">struct</span> page *page)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!PageActive(page) &amp;&amp; PageReferenced(page)) {</span><br><span class="line">    activate_page(page);</span><br><span class="line">}</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!PageReferenced(page)) {</span><br><span class="line">    SetPageReferenced(page);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ active list ä¸­çš„ä¸€ä¸ª page åœ¨åˆ°è¾¾é“¾è¡¨å°¾ç«¯æ—¶ï¼Œå¦‚æœå…¶ PG_referenced ä½ä¸º 1ï¼Œåˆ™è¢«æ”¾å›é“¾è¡¨å¤´éƒ¨ï¼Œä½†åŒæ—¶å…¶ PG_referenced ä¼šè¢«æ¸… 0ã€‚å¦‚æœå…¶ PG_referenced ä½ä¸º 0ï¼Œé‚£ä¹ˆå°±ä¼šè¢«æ”¾å…¥ inactive list çš„å¤´éƒ¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš demotionã€‚å¯è§ï¼ŒLinux é‡‡ç”¨çš„è¿™ç§ active list å’Œ inactive list å¹¶ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§æ—¶é—´é¡ºåºæ¥ç½®æ¢ page çš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ç§ä¼ª LRU ç®—æ³•ã€‚</p><p>Inactive list ä¸­å°¾ç«¯çš„é¡µé¢ä¸æ–­è¢«é‡Šæ”¾ï¼Œç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œactive list åˆ™ä¸æ–­åœ°å°†å°¾ç«¯ PG_referenced ä¸º 0 çš„é¡µé¢æ”¾å…¥ inactive listï¼Œç›¸å½“äºä¸€ä¸ªç”Ÿäº§è€…ã€‚ä¸éš¾æƒ³è±¡ï¼Œè¿™ 2 ä¸ªé“¾è¡¨çš„é”ï¼ˆlru_lockï¼‰åº”è¯¥æ˜¯é«˜åº¦ç«äº‰çš„ï¼Œå¦‚æœä» active list å‘ inactive list çš„é¡µé¢è½¬ç§»æ˜¯ä¸€ä¸ªä¸€ä¸ªè¿›è¡Œçš„ï¼Œé‚£å¯¹é”çš„äº‰æŠ¢å°†ä¼šååˆ†ä¸¥é‡ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå†…æ ¸åŠ å…¥äº†ä¸€ä¸ª per-CPU çš„ lru cacheï¼ˆç”¨ struct pagevec è¡¨ç¤ºï¼‰ï¼Œä» active list æ¢å‡ºçš„é¡µé¢å…ˆæ”¾å…¥å½“å‰ CPU çš„ lru cache ä¸­ï¼Œç›´åˆ° lru cache ä¸­å·²ç»ç§¯ç´¯äº† PAGEVEC_SIZEï¼ˆ15ï¼‰ä¸ªé¡µé¢ï¼Œå†è·å– lru_lockï¼Œå°†è¿™äº›é¡µé¢æ‰¹é‡æ”¾å…¥ inactive list ä¸­ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru1.jpg"></p><p>å¦‚æœ inactive list æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆæ¯ä¸ªé¡µé¢åœ¨è¢«å›æ”¶ä¹‹å‰æœ‰å……åˆ†çš„æ—¶é—´è¢«å†æ¬¡è®¿é—®ï¼Œä»è€Œè¢« promote åˆ° active listï¼Œè¿™æ ·å¯ä»¥å‡å°‘åˆšåˆšè¢«å›æ”¶åˆå‘ç”Ÿ refault çš„é¡µé¢æ•°é‡ï¼ˆpage thrashingï¼‰ã€‚ä½†æ˜¯ç”±äºå†…å­˜æ€»é‡æœ‰é™ï¼Œinactive list è¾ƒé•¿å°±æ„å‘³ç€ active list ç›¸å¯¹è¾ƒçŸ­ï¼Œé‚£è¿™ 2 ä¸ªé“¾è¡¨åº”è¯¥åˆ†åˆ«å¤šé•¿æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªé¡µé¢è¢«å›æ”¶æ—¶è®°å½•ä¸€ä¸ª timestampï¼Œå½“è¿™ä¸ªé¡µé¢ refault è¢«æ¢å…¥æ—¶å†è®°å½•ä¸€ä¸ª timestampï¼Œå¦‚æœå°† inactive list çš„é•¿åº¦å¢åŠ ï¼Œä½¿å¾—é¡µé¢å›æ”¶å¢é•¿çš„æ—¶é—´è¶…è¿‡è¿™ 2 ä¸ª timestamp çš„å·®å€¼æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªé¡µé¢å°±å¯ä»¥å› ä¸ºåœ¨ inactive list ä¸­è¢«å†æ¬¡è®¿é—®ï¼Œé¿å…äº†è¢«å›æ”¶çš„å‘½è¿ï¼Œä¹Ÿå‡å°äº† refault é€ æˆçš„å¼€é”€ã€‚</p><p>å¯æ˜¯å‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œç”±äºç¡¬ä»¶çš„é™åˆ¶ï¼Œç»™æ¯ä¸ª page ç»´æŠ¤ä¸€ä¸ª timestamp æ˜¯ä¸ç°å®çš„ã€‚è¿˜æ˜¯ç±»ä¼¼çš„è§£å†³åŠæ³•ï¼Œç”¨ inactive ä¸­å›æ”¶é¡µé¢çš„ä¸ªæ•°æ¥æ›¿ä»£ timestampï¼Œæ¯å›æ”¶ä¸€ä¸ªé¡µé¢ï¼Œè®¡æ•°å™¨åŠ  1ï¼ˆç›¸å½“äºç”¨ counter æ›¿ä»£äº† timerï¼‰ã€‚é‚£è¿™ä¸ª counter çš„å€¼ä¿å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>å¯¹äºå±äº page cache çš„é¡µé¢ï¼Œç”±äºå…¶è¢«æ¢å‡ºä¹‹å‰æ˜¯æ”¾åœ¨ radix tree/xarray ä¸­çš„ï¼Œå½“é¡µé¢è¢«å›æ”¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ›¾ç»æ‰€åœ¨çš„ entry åˆ©ç”¨èµ·æ¥ï¼Œè®°å½•ä¸€ä¸‹å½“å‰çš„ counter å€¼ï¼Œé¡µé¢è¢«æ¢å…¥çš„æ—¶å€™å†æ¯”è¾ƒä¸€ä¸‹ entry ä¸­çš„ counter å€¼ï¼Œè¿™ç§ entry è¢«ç§°ä¸º shadow entryã€‚</p><p>å¯¹äºä¸€ä¸ªåŸºäºæ–‡ä»¶çš„ page frameï¼Œå¥½åƒå®ƒæ—¢åœ¨ page cache ç»“æ„ä¸­ï¼Œåˆåœ¨ active/inactive list ç»“æ„ä¸­ï¼Ÿæ²¡é”™ï¼Œæ”¾åœ¨ page cache ä¸­ä»¥ radix tree/xarray çš„æ–¹å¼ç»„ç»‡ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾å’Œè¯»å†™å®ƒçš„å†…å®¹ï¼Œæ”¾åœ¨ active/inactive list ä¸­åˆ™æ˜¯ä¸ºäº†æ–¹ä¾¿å†…å­˜å›æ”¶ã€‚å½“ä¸€ä¸ªåŸºäºæ–‡ä»¶çš„ page frame è¢«åˆ›å»ºæ—¶ï¼Œå®ƒå°±å·²ç»è¢«åŠ å…¥åˆ°è¿™ 2 ä¸ªç»“æ„ä¸­äº†ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add_to_page_cache_lru</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="keyword">struct</span> address_space *mapping,</span></span><br><span class="line"><span class="params">  <span class="type">pgoff_t</span> offset, <span class="type">gfp_t</span> gfp_mask)</span></span><br><span class="line">{</span><br><span class="line">    __add_to_page_cache_locked(page, mapping, offset,  gfp_mask, &amp;shadow);</span><br><span class="line">    lru_cache_add(page);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡ŒåŒæ ·æ˜¯å…ˆæ”¾å…¥ lru cacheï¼Œè€Œä¸æ˜¯ç›´æ¥æ”¾è¿› active/inactive list ä¸­ã€‚</p><h2 id="åŒ¿åé¡µé¢çš„å¤„ç†">åŒ¿åé¡µé¢çš„å¤„ç†</h2><p>å¯¹äº anonymous pagesï¼Œæ€»æ˜¯éœ€è¦å…ˆå†™å…¥ swap area æ‰èƒ½å›æ”¶ã€‚è€Œå¯¹äº page cacheï¼Œæœ‰ä¸€äº›å¯ä»¥ç›´æ¥ discardï¼ˆæ¯”å¦‚ elf çš„ text æ®µå¯¹åº”çš„é¡µé¢ï¼Œdata æ®µå¯¹åº”çš„é¡µé¢ä¸­ clean çš„éƒ¨åˆ†ï¼‰ï¼Œæœ‰ä¸€äº› dirty çš„é¡µé¢éœ€è¦å…ˆ write back åŒæ­¥åˆ°ç£ç›˜ã€‚</p><p>ç”±äºæœ‰ flusher thread å®šæœŸçš„ write backï¼Œå›æ”¶æ—¶è¿˜æ˜¯ dirty çš„ page cache é¡µé¢ä¸ä¼šå¤ªå¤šã€‚è€Œä¸”ï¼Œpage cache ä¸­çš„é¡µé¢æœ‰å¯¹åº”çš„æ–‡ä»¶å’Œåœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œéœ€è¦æ¢å…¥æ¢å¤çš„æ—¶å€™ä¹Ÿæ›´åŠ å®¹æ˜“ã€‚</p><p>å› æ­¤ï¼Œå†…æ ¸é€šå¸¸æ›´å€¾å‘äºæ¢å‡º page cache ä¸­çš„é¡µé¢ï¼Œåªæœ‰å½“å†…å­˜å‹åŠ›å˜å¾—ç›¸å¯¹ä¸¥é‡æ—¶ï¼Œæ‰ä¼šé€‰æ‹©å›æ”¶ anonymous pagesã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯çš„éœ€è¦ï¼Œé€šè¿‡"/proc/sys/vm/swappiness"è°ƒèŠ‚å†…å­˜å›æ”¶æ—¶ anonymous pages å’Œ page cache çš„æ¯”é‡ã€‚</p><p>swappiness çš„å€¼ä» 0 åˆ° 100 ä¸ç­‰ï¼ˆé»˜è®¤ä¸€èˆ¬æ˜¯ 60ï¼‰ï¼Œè¿™ä¸ªå€¼è¶Šé«˜ï¼Œåˆ™å›æ”¶çš„æ—¶å€™è¶Šä¼˜å…ˆé€‰æ‹© anonymous pagesã€‚å½“ swappiness ç­‰äº 100 çš„æ—¶å€™ï¼Œanonymous pages å’Œ page cache å°±å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ã€‚è‡³äºä¸ºä»€ä¹ˆä¸ä»å¼€é”€æœ€å°çš„è§’åº¦å°† swappiness è®¾ä¸º 0ï¼Œå°†åœ¨åé¢ç»™å‡ºç­”æ¡ˆã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * With swappiness at 100, anonymous and file have the same priority.</span></span><br><span class="line"><span class="comment"> * This scanning priority is essentially the inverse of IO cost.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">anon_prio = swappiness;</span><br><span class="line">file_prio = <span class="number">200</span> - anon_prio</span><br></pre></td></tr></tbody></table></figure><p>æ—©æœŸçš„ Linux å®ç°ä¸­ï¼Œæ¯ä¸ª zone ä¸­æœ‰ active å’Œ inactive ä¸¤ä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸Šå­˜æ”¾çš„é¡µé¢ä¸åŒºåˆ†ç±»å‹ã€‚ä¸ºäº†å®ç°ä¼˜å…ˆå›æ”¶ page cacheï¼Œä¹‹åæ¯ä¸ªé“¾è¡¨æ‹†åˆ†æˆäº† LRU_ANON å’Œ LRU_FILEï¼Œå› æ­¤å½¢æˆäº† LRU_INACTIVE_ANON, LRU_ACTIVE_ANON, LRU_INACTIVE_FILE å’Œ LRU_ACTIVE_FILE å››ç§é“¾è¡¨ï¼Œè€Œä¸”æ”¹æˆäº†ä¸€ä¸ª node å¯¹åº”ä¸€ç»„é“¾è¡¨ï¼ˆper-nodeï¼‰ï¼Œç”±ä»£è¡¨ node çš„ struct pglist_data ä¸­çš„ struct lruvec åŒ…å«å„ä¸ªé“¾è¡¨çš„å¤´ç»“ç‚¹ ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LRU_BASE 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LRU_ACTIVE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LRU_FILE 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">lru_list</span> {</span></span><br><span class="line">LRU_INACTIVE_ANON = LRU_BASE,</span><br><span class="line">LRU_ACTIVE_ANON = LRU_BASE + LRU_ACTIVE,</span><br><span class="line">LRU_INACTIVE_FILE = LRU_BASE + LRU_FILE</span><br><span class="line">LRU_ACTIVE_FILE = LRU_BASE + LRU_FILE + LRU_ACTIVE,</span><br><span class="line">LRU_UNEVICTABLE,</span><br><span class="line">NR_LRU_LISTS</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lruvec</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">NR_LRU_LISTS</span>];</span></span><br><span class="line">        ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª LRU_UNEVICTABLE é“¾è¡¨ã€‚è¿™ä¸ªé“¾è¡¨å­˜å‚¨äº† flag ä¸º PG_unevictable çš„é¡µé¢ï¼Œå› ä¸º unevictable çš„é¡µé¢æ˜¯ä¸å¯ä»¥å›æ”¶çš„ï¼Œæ‰«æçš„æ—¶å€™å¿½ç•¥ LRU_UNEVICTABLE é“¾è¡¨ï¼Œå°†å¯ä»¥å‡å°‘å›æ”¶æ—¶æ‰«æé¡µé¢çš„æ€»ä½“æ—¶é—´ã€‚</p><p>å¯ä»¥é€šè¿‡"/proc/zoneinfo"æŸ¥çœ‹è¿™ 4 ç§é“¾è¡¨åœ¨ node çš„å„ä¸ª zone ä¸Šçš„åˆ†å¸ƒï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru2.jpg"></p><p>æ›´ä¸°å¯Œçš„ä¿¡æ¯åˆ™åŒ…å«åœ¨"/proc/meminfo"ä¸­ï¼Œæ¯”å¦‚"Dirty"è¡¨ç¤ºä¿®æ”¹åè¿˜æ²¡æœ‰ write back çš„é¡µé¢ï¼Œ"Writeback"è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œ I/O æ“ä½œè¿›è¡Œå›å†™çš„é¡µé¢ï¼Œè¿˜æœ‰å°±æ˜¯ç³»ç»Ÿæ‰€æœ‰"active"å’Œ"inactive"çš„ page cache å’Œ anonymous page çš„ç»Ÿè®¡æ•°æ®ã€‚</p><p>å¦‚æœ swappiness çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆå†…æ ¸åœ¨å¯åŠ¨å†…å­˜å›æ”¶æ—¶ï¼Œå°†å®Œå…¨å¿½ç•¥ anonymous pagesï¼Œè¿™å°†å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å†…æ ¸åªéœ€è¦æ‰«æ page cache å¯¹åº”çš„ inactive listï¼ˆLRU_ACTIVE_FILEï¼‰å°±å¯ä»¥äº†ï¼Œæ ¹æœ¬ä¸ç”¨æ‰«æ anonymous pages å¯¹åº”çš„ inactive listï¼ˆLRU_ACTIVE_ANONï¼‰ï¼Œè¿™æ ·èƒ½æå¤§çš„èŠ‚çº¦å†…å­˜å›æ”¶æ—¶èŠ±åœ¨æ‰«æ LRU é“¾è¡¨ä¸Šçš„æ—¶é—´ã€‚</p><p>ä½†æ˜¯ï¼Œswappiness è®¾ç½®ä¸º 0 åªé€‚ç”¨äºç³»ç»Ÿä¸­ page cache æ¯”è¾ƒå¤šçš„åœºæ™¯ï¼Œå¦‚æœç³»ç»Ÿä¸­ anonymous pages æ¯” page cache å¤šå¾ˆå¤šï¼Œåªå›æ”¶ page cache çš„è¯ï¼Œå¯èƒ½æ— æ³•æ»¡è¶³ direct relaim æˆ–è€… kswapd çš„éœ€æ±‚ã€‚</p><p>è¿™æ—¶æœ¬æ¥ç³»ç»Ÿä¸­è¿˜æœ‰å¾ˆå¤š anonymous pages å¯ä¾›å›æ”¶ä»¥é‡Šæ”¾å†…å­˜ï¼Œç”±äº swappiness çš„é™åˆ¶ï¼Œå†…æ ¸ä¹Ÿè®¸åªæœ‰é€‰æ‹© OOM killer äº†ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨è®¾ç½® swappiness å‚æ•°çš„æ—¶å€™ï¼Œéœ€è¦å¯¹è‡ªå·±çš„åº”ç”¨åœºæ™¯å’Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µæœ‰æ¯”è¾ƒæ·±å…¥çš„äº†è§£ï¼Œè¦ä¸ç„¶ä½ å¯èƒ½ä¼šå›°æƒ‘ï¼šæ˜æ˜ available çš„å†…å­˜è¿˜å¾ˆå¤šå•Šï¼Œä¸ºå•¥è€æœ‰è¿›ç¨‹è¢« OOM kill å‘¢ã€‚</p><h1 id="è§¦å‘æœºåˆ¶">è§¦å‘æœºåˆ¶</h1><p>Linux å†…æ ¸ä¸­è§¦å‘é¡µé¢å›æ”¶çš„æœºåˆ¶å¤§è‡´æœ‰ 3 ä¸ªã€‚</p><ul><li>ç›´æ¥é¡µé¢å›æ”¶æœºåˆ¶ã€‚åœ¨å†…æ ¸æ€é‡Œè°ƒç”¨é¡µé¢åˆ†é…æ¥å£å‡½æ•° alloe_pages() åˆ†é…ç‰©ç†é¡µé¢æ—¶ï¼Œç”±äºç³»ç»Ÿå†…å­˜çŸ­ç¼ºï¼Œä¸èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œå› æ­¤å†…æ ¸ä¼šç›´æ¥è‡ªé™·åˆ°é¡µé¢å›æ”¶æœºåˆ¶ï¼Œè¿™ç§°ä¸ºç›´æ¥é¡µé¢å›æ”¶</li><li>å‘¨æœŸæ€§å›æ”¶å†…å­˜æœºåˆ¶ã€‚è¿™æ˜¯ kswapd å†…æ ¸çº¿ç¨‹çš„å·¥ä½œèŒè´£ã€‚å½“å†…æ ¸è·¯å¾„è°ƒç”¨ alloc_pages() åˆ†é…ç‰©ç†é¡µé¢æ—¶ï¼Œç”±äºç³»ç»Ÿå†…å­˜çŸ­ç¼ºï¼Œæ²¡æ³•åœ¨ä½æ°´ä½æƒ…å†µä¸‹åˆ†é…å‡ºå†…å­˜ï¼Œå› æ­¤ä¼šå”¤é†’ kswapd å†…æ ¸çº¿ç¨‹æ¥å¼‚æ­¥å›æ”¶å†…å­˜</li><li>slab æ”¶å‰²æœºï¼ˆslab shrinkerï¼‰æœºåˆ¶ã€‚è¿™æ˜¯ç”¨æ¥å›æ”¶ slb å¯¹è±¡çš„ã€‚å½“å†…å­˜çŸ­ç¼ºæ—¶ï¼Œç›´æ¥é¡µé¢å›æ”¶å’Œå‘¨æœŸæ€§å›æ”¶å†…å­˜ä¸¤ç§æœºåˆ¶éƒ½ä¼šè°ƒç”¨ slab æ”¶å‰²æœºæœºåˆ¶æ¥å›æ”¶ slab å¯¹è±¡ã€‚slab æœºåˆ¶åˆ†é…çš„å†…å­˜ä¸»è¦ç”¨äº slab å¯¹è±¡å’Œ kmalloc æ¥å£ï¼Œä¹Ÿå¯ç”¨äºå†…æ ¸ç©ºé—´çš„å†…å­˜åˆ†é…ï¼Œè€Œæœ¬èŠ‚é‡ç‚¹ä»‹ç»çš„æ˜¯ç”¨æˆ·å†…å­˜çš„å›æ”¶</li></ul><p>è¯»è€…éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›´æ¥å›æ”¶å†…å­˜çš„è¿›ç¨‹ä¸»ä½“æ˜¯è°ƒç”¨è€…æœ¬èº«ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹ç‚¹ä¸€ç›´æ¥å›æ”¶å†…å­˜æ˜¯åŒæ­¥å›æ”¶ï¼Œè¿™ä¼šé˜»å¡è°ƒç”¨è€…è¿›ç¨‹çš„æ‰§è¡Œã€‚ kswapd æœ¬èº«æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå®ƒå’Œè°ƒç”¨è€…çš„å…³ç³»æ˜¯å¼‚æ­¥çš„ã€‚</p><p>ä¸€ä¸ªç†æƒ³çš„æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬èƒ½åœ¨å†…å­˜å‹åŠ›ä¸é‚£ä¹ˆå¤§çš„æ—¶å€™ï¼Œå°±æå‰å¯åŠ¨å†…å­˜å›æ”¶ã€‚è€Œä¸”ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚åœ¨ interrupt context æˆ–æŒæœ‰ spinlock æ—¶ï¼‰ï¼Œå†…å­˜åˆ†é…æ ¹æœ¬å°±æ˜¯ä¸èƒ½ç­‰å¾…çš„ã€‚å› æ­¤ï¼ŒLinux ä¸­å¦ä¸€ç§æ›´ä¸ºå¸¸è§çš„å†…å­˜å›æ”¶æœºåˆ¶æ˜¯ä½¿ç”¨ kswapdã€‚</p><p>æ¯ä¸ª node å¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ kswapdï¼Œkswapd åœ¨è¢«å”¤é†’åå°†æ‰«æå„ä¸ª zone çš„å†…å­˜ä½¿ç”¨çŠ¶æ€ï¼Œå¹¶æ®æ­¤è¿›è¡Œå¿…è¦çš„å†…å­˜å›æ”¶æ“ä½œï¼Œå› æ­¤ kswapd çš„å›æ”¶æ–¹å¼åˆè¢«ç§°ä¸º"background reclaim"ã€‚è‡³äºä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘ direct reclaimï¼Œä»€ä¹ˆæƒ…å†µä¸‹åˆä¼šè§¦å‘ background reclaimï¼Œæ˜¯ç”±å†…å­˜çš„"watermark"å†³å®šçš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru3.jpg"></p><p>Kswapd è™½ç„¶åå­—ä¸­å«æœ‰"swap"ï¼Œä½†å®ƒä¸å…‰å¤„ç† anonymous page çš„ swap out å›æ”¶ï¼ŒåŒæ ·å¤„ç† page cache çš„å›æ”¶ï¼Œè€Œä¸”å®ƒè¿˜è‚©è´Ÿç€å¹³è¡¡ active list å’Œ inactive list çš„é‡ä»»ï¼Œæ‰€ä»¥è¢«å®ƒè°ƒç”¨çš„å‡½æ•°å«åš balance_pgdat()ã€‚</p><p>ä¸ç®¡æ˜¯ direct reclaimï¼Œè¿˜æ˜¯ kswapdï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ shrink_zone() --&gt; shrink_page_list() è¿›è¡Œå›æ”¶æ“ä½œã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">shrink_list</span><span class="params">(<span class="keyword">enum</span> lru_list lru, <span class="type">unsigned</span> <span class="type">long</span> nr_to_scan,</span></span><br><span class="line"><span class="params"> <span class="keyword">struct</span> lruvec *lruvec, <span class="keyword">struct</span> scan_control *sc)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (is_active_lru(lru)) {</span><br><span class="line"><span class="keyword">if</span> (inactive_list_is_low(lruvec, is_file_lru(lru), sc, <span class="literal">true</span>))</span><br><span class="line">shrink_active_list(nr_to_scan, lruvec, sc, lru);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> shrink_inactive_list(nr_to_scan, lruvec, sc, lru);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ inactive list ä¸­çš„é¡µé¢æ¯”è¾ƒå°‘æ—¶ï¼Œshrink_active_list() ä¼šä» active list å°¾ç«¯è½¬ç§»ä¸€éƒ¨åˆ†é¡µé¢åˆ° inactive list ä¸­ã€‚è¿™é‡Œçš„â€œå°‘â€æ˜¯ç›¸å¯¹çš„ï¼Œé€šå¸¸ç‰©ç†å†…å­˜è¶Šå¤§ï¼Œinactive list çš„é¡µé¢å æ¯”å¯ä»¥è¶Šå°ï¼ˆé¡µé¢æ€»æ•°è¿˜æ˜¯å¢åŠ çš„ï¼‰ï¼Œå› ä¸º inactive list çš„é•¿åº¦ä¸»è¦æ˜¯ç”¨æ¥å‡å°‘çŸ­æ—¶é—´å†… refault çš„ã€‚</p><p>shrink_inactive_list --&gt; shrink_page_list å°†ä» inactive list å°¾ç«¯ç§»é™¤é€‰å®šæ•°ç›®çš„é¡µé¢ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru4.jpg"></p><p>å›æ”¶ä¸€ä¸ªé¡µé¢ä¹‹å‰ï¼Œå¦‚æœè¯¥é¡µé¢å½“å‰æ˜¯è¢«æ˜ å°„çš„ï¼ˆæ ¹æ® struct page çš„_mapcount åŸŸåˆ¤æ–­ï¼‰ï¼Œéœ€è¦è°ƒç”¨ try_to_unmap()ï¼Œé€šè¿‡ reserve mapping æ›´æ”¹æ‰€æœ‰æŒ‡å‘è¿™ä¸ªé¡µé¢çš„ PTEsã€‚å¯¹äº anonymous pageï¼Œè¿˜éœ€è¦åœ¨ swap space ä¸­åˆ†é… slotï¼Œå¹¶ä¸”å°†è¿™ä¸ª page æ ‡è®°ä¸º dirty çš„ã€‚anonymous page æ˜¯æ²¡æœ‰ backing store çš„ï¼Œä» dirty çš„è§’åº¦ï¼Œå®ƒå¯ä»¥ç®—æ˜¯ä¸€ç›´ dirty çš„ã€‚</p><p>å‰é¢æåˆ°è¿‡ï¼Œä¸æ˜¯æ‰€æœ‰çš„é¡µé¢éƒ½å¯ä»¥è¢«å›æ”¶çš„ã€‚å¦‚æœæ£€æµ‹åˆ°é¡µé¢çš„ flag æ˜¯ PG_locked æˆ–è€…æ˜¯ PG_reserved çš„ï¼Œåˆ™åªèƒ½è·³è¿‡ã€‚å¯¹äºæ­£åœ¨å›å†™çš„ï¼ˆflag æ˜¯ PG_writeback çš„ï¼‰ï¼Œé€šå¸¸ä¹Ÿæ˜¯æ”¾å¼ƒå›æ”¶ï¼Œæœ‰è¿™åŠŸå¤«å»ç­‰å¾…å›å†™å®Œæˆï¼Œè¿˜ä¸å¦‚å»æ‰¾é“¾è¡¨ä¸Šå…¶ä»–çš„ clean pageã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru5.jpg"></p><p>ä¹‹åï¼Œå¯¹äº flag æ˜¯ PG_dirty çš„é¡µé¢ï¼Œå¯åŠ¨ pageout() å°†è¿™äº›é¡µé¢å¤‡ä»½æˆ–è€…åŒæ­¥åˆ°å¤–éƒ¨ç£ç›˜ï¼Œè¿™é‡Œâ€œå¤‡ä»½â€é’ˆå¯¹çš„æ˜¯ anonymous pageï¼Œâ€œåŒæ­¥â€é’ˆå¯¹çš„æ˜¯ page cacheã€‚</p><h2 id="è®¾ç½®ä¸å›æ”¶">è®¾ç½®ä¸å›æ”¶</h2><p>è¿›ç¨‹å¯ä»¥ç”¨ç”³è¯· swap tokenï¼Œæ‹¥æœ‰äº† swap tokenï¼Œå°±å¯ä»¥è¢«å†…å­˜å›æ”¶ç®—æ³•æš‚æ—¶è±å…ï¼Œé™¤éï¼Œå†…å­˜å®åœ¨å·²ç»ç´§å¼ çš„ä¸è¡Œäº†ã€‚åœ¨ 3.4 ç‰ˆæœ¬ä¸­è¢«ç§»é™¤äº†ã€‚</p><h2 id="oom">OOM</h2><p>è™½ç„¶ OOM killer æœ‰æ—¶å€™å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æŸå¤±ï¼Œä½†æ€»æ¯”ç³»ç»Ÿå®Œå…¨å´©æºƒè¦å¥½ã€‚è¿™ä¸ªæ— è¾œçš„ bad process å¯ä¸æ˜¯éšä¾¿æŒ‘çš„ï¼Œåº”è¯¥ä¼˜å…ˆé€‰æ‹©è¿™äº›ï¼š</p><ul><li>å æœ‰ page frames æ¯”è¾ƒå¤šçš„ï¼Œå æœ‰çš„å¤šé‡Šæ”¾çš„æ‰å¤šï¼Œkill æ‰æ‰æœ‰æ„ä¹‰</li><li>é™æ€ä¼˜å…ˆçº§æ¯”è¾ƒä½çš„</li></ul><p>è€Œä¸èƒ½é€‰æ‹©è¿™äº›ï¼š</p><ul><li>å†…æ ¸çº¿ç¨‹ï¼Œå› ä¸ºå†…æ ¸çº¿ç¨‹å¾€å¾€æ‰§è¡Œçš„éƒ½æ˜¯æ¯”è¾ƒå…³é”®çš„ä»»åŠ¡</li><li>è¿›ç¨‹å·ä¸º 1 çš„ init è¿›ç¨‹ã€‚å¦‚æœçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè¿™äº›å­è¿›ç¨‹å°†è¢« init è¿›ç¨‹æ‰˜ç®¡ï¼Œkill æ‰ init è¿›ç¨‹æ˜¯å†…æ ¸ä¸å…è®¸çš„è¡Œä¸º</li><li>ç›´æ¥è®¿é—®ç¡¬ä»¶è®¾å¤‡çš„è¿›ç¨‹ï¼Œå¦‚æœå¼ºè¡Œç»ˆç»“è¿™æ ·çš„è¿›ç¨‹ï¼Œå¯èƒ½å°†ç¡¬ä»¶ç½®äºä¸€ä¸ªä¸ç¡®å®šçš„çŠ¶æ€</li></ul><h1 id="refault-distance-ç®—æ³•">Refault Distance ç®—æ³•</h1><p>åœ¨å­¦æœ¯ç•Œå’Œ Linux å†…æ ¸ç¤¾åŒºï¼Œé¡µé¢å›æ”¶ç®—æ³•çš„ä¼˜åŒ–ä¸€ç›´æ²¡æœ‰åœæ­¢è¿‡ï¼Œå…¶ä¸­ Refault Distance ç®—æ³•åœ¨ Linux3.15 å†…æ ¸ä¸­åŠ å…¥ï¼Œä½œè€…æ˜¯ç¤¾åŒºä¸“å®¶ Johannes Weinerï¼Œè¯¥ç®—æ³•ç›®å‰åªé’ˆå¯¹é¡µé¢é«˜é€Ÿç¼“å­˜ç±»å‹çš„é¡µé¢ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯¹äºå†…å®¹ç¼“å­˜ç±»å‹çš„ LRU é“¾è¡¨æ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªé“¾è¡¨å€¼å¾—å…³æ³¨ï¼Œåˆ†åˆ«æ˜¯æ´»è·ƒ LRU é“¾è¡¨å’Œä¸æ´»è·ƒ LRU é“¾è¡¨ã€‚æ–°äº§ç”Ÿçš„é¡µé¢æ€»æ˜¯è¢«æ·»åŠ åˆ°ä¸æ´»è·ƒ LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œé¡µé¢å›æ”¶ä¹Ÿæ€»æ˜¯ä»ä¸æ´»è·ƒ LRU é“¾è¡¨çš„å°¾éƒ¨å¼€å§‹ã€‚ä¸æ´»è·ƒ LRU é“¾è¡¨çš„é¡µé¢ç¬¬äºŒæ¬¡è®¿é—®æ—¶ä¼šå‡çº§ï¼ˆpromoteï¼‰ä¸ºæ´»è·ƒ LRU é“¾è¡¨çš„é¡µé¢ï¼Œé˜²æ­¢è¢«å›æ”¶ï¼›å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ´»è·ƒ LRU é“¾è¡¨å¢é•¿å¤ªå¿«ï¼Œé‚£ä¹ˆæ´»è·ƒé¡µé¢ä¹Ÿä¼šè¢«é™çº§ï¼ˆdemoteï¼‰åˆ°ä¸æ´»è·ƒ LRU é“¾è¡¨ä¸­ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/lru6.png"></p><p>å®é™…ä¸Šï¼Œä¸€äº›åœºæ™¯ä¸‹ï¼ŒæŸäº›é¡µé¢ç»å¸¸è¢«è®¿é—®ï¼Œä½†æ˜¯åœ¨ä¸‹ä¸€æ¬¡è®¿é—®ä¹‹å‰åœ¨ä¸æ´»è·ƒ LRU é“¾è¡¨ä¸­å›æ”¶å¹¶é‡Šæ”¾äº†å®ƒä»¬ï¼Œå› æ­¤é¡»ä»å­˜å‚¨ç³»ç»Ÿä¸­è¯»å–è¿™äº›å†…å®¹ç¼“å­˜é¡µé¢ï¼Œè¿™ä¼šäº§ç”Ÿé¢ ç°¸ï¼ˆthrashingï¼‰ç°è±¡ã€‚å½“æˆ‘ä»¬è§‚å¯Ÿæ–‡ä»¶ç¼“å­˜ä¸­ä¸æ´»è·ƒ LRU é“¾è¡¨çš„è¡Œä¸ºç‰¹å¾æ—¶ï¼Œä¼šå‘ç°å¦‚ä¸‹æœ‰è¶£ç‰¹å¾ã€‚</p><ul><li>ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªæ–‡ä»¶ç¼“å­˜é¡µé¢æ—¶ï¼Œå®ƒè¢«æ·»åŠ åˆ°ä¸æ´»è·ƒ LRU é“¾è¡¨å¤´ï¼Œç„¶åæ…¢æ…¢ä»é“¾è¡¨å¤´å‘é“¾è¡¨å°¾æ–¹å‘ç§»åŠ¨ï¼Œé“¾è¡¨å°¾çš„å†…å®¹ç¼“å­˜ä¼šè¢«ç§»å‡º LRU é“¾è¡¨ä¸”é‡Šæ”¾é¡µé¢ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ä½œç§»å‡º</li><li>å½“ç¬¬äºŒæ¬¡è®¿é—®æ—¶ï¼Œé¡µé¢é«˜é€Ÿç¼“å­˜è¢«å‡çº§ä¸ºæ´»è·ƒ LRU é“¾è¡¨ä¸­çš„é¡µé¢é«˜é€Ÿç¼“å­˜ï¼Œè¿™æ ·ä¸æ´»è·ƒ LRU é“¾è¡¨ä¹Ÿç©ºå‡ºä¸€ä¸ªä½ç½®ï¼Œåœ¨ä¸æ´»è·ƒ LRU é“¾è¡¨çš„é¡µé¢æ•´ä½“ç§»åŠ¨äº†ä¸€ä¸ªä½ç½®ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ä½œæ¿€æ´»</li><li>ä»å®è§‚æ—¶é—´è½´æ¥çœ‹ï¼Œç§»å‡ºè¿‡ç¨‹å¤„ç†çš„é¡µé¢æ•°é‡ä¸æ¿€æ´»è¿‡ç¨‹å¤„ç†çš„é¡µé¢æ•°é‡çš„æ€»å’Œç­‰äºä¸æ´»è·ƒ LRU é“¾è¡¨çš„é•¿åº¦ NR_inactive</li><li>è¦ä»ä¸æ´»è·ƒ LRU é“¾è¡¨ä¸­é‡Šæ”¾ä¸€ä¸ªé¡µé¢ï¼Œéœ€è¦ç§»åŠ¨ N ä¸ªé¡µé¢ï¼ˆN è¡¨ç¤ºä¸æ´»è·ƒé“¾è¡¨é•¿åº¦ï¼‰</li></ul><p>ç»¼åˆä¸Šé¢çš„ä¸€äº›è¡Œä¸ºç‰¹å¾ï¼Œå®šä¹‰äº† Refault Distance çš„æ¦‚å¿µã€‚ç¬¬ä¸€æ¬¡è®¿é—®å†…å®¹ç¼“å­˜ç§°ä¸º faultï¼Œç¬¬äºŒæ¬¡è®¿é—®è¯¥é¡µç§°ä¸º refaultã€‚å†…å®¹ç¼“å­˜é¡µé¢ç¬¬ä¸€æ¬¡è¢«ç§»å‡º LRU é“¾è¡¨å¹¶å›æ”¶çš„æ—¶åˆ»ç§°ä¸º Eï¼Œç¬¬äºŒæ¬¡å†è®¿é—®è¯¥é¡µé¢çš„æ—¶åˆ»ç§°ä¸º Rï¼Œé‚£ä¹ˆ R-E çš„æ—¶é—´é‡Œéœ€è¦ç§»åŠ¨çš„é¡µé¢ä¸ªæ•°ç§°ä¸º Refault Distanceã€‚</p><p>Refault Distance æ¦‚å¿µå†åŠ ä¸Šç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶åˆ»ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªå…¬å¼æ¥æ¦‚æ‹¬ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è®¿é—®çš„é—´éš™ï¼ˆread distanceï¼‰ã€‚</p><pre><code>read_distance=nr_inactive + (R - E)</code></pre><p>å¦‚æœé¡µé¢æƒ³ä¸€ç›´ä¿æŒåœ¨ LRU é“¾è¡¨ä¸­ï¼Œé‚£ä¹ˆ read_distance ä¸åº”è¯¥æ¯”å†…å­˜çš„å¤§å°è¿˜å¤§ï¼›å¦åˆ™ï¼Œè¯¥é¡µé¢æ°¸è¿œä¼šè¢«ç§»å‡º LRU é“¾è¡¨ã€‚å› æ­¤ï¼Œä¸‹å¼æˆç«‹ã€‚</p><pre><code>NR_inactive + (R - E) â‰¤ NR_inactive + NR_active(R - E) â‰¤ NR_active</code></pre><p>æ¢å¥è¯è¯´ï¼ŒRefault Distance å¯ä»¥ç†è§£ä¸ºä¸æ´»è·ƒ LRU é“¾è¡¨çš„â€œè´¢æ”¿èµ¤å­—â€ã€‚å¦‚æœä¸æ´»è·ƒ LRU é“¾è¡¨çš„é•¿åº¦è‡³å°‘å†å»¶é•¿åˆ° Refault Distanceï¼Œå°±å¯ä»¥ä¿è¯è¯¥å†…å®¹ç¼“å­˜åœ¨ç¬¬äºŒæ¬¡è®¿é—´ä¹‹å‰ä¸ä¼šè¢«ç§»å‡º LRU é“¾è¡¨å¹¶é‡Šæ”¾å†…å­˜ï¼šå¦åˆ™ï¼Œå°±è¦æŠŠè¯¥å†…å®¹ç¼“å­˜é‡æ–°åŠ å…¥æ´»è·ƒ LRU é“¾è¡¨åŠ ä»¥ä¿æŠ¤ï¼Œä»¥é˜²é¢ ç°¸ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå†…å®¹ç¼“å­˜çš„å¹³å‡è®¿é—®é—´éš™è¦å¤§äºä¸æ´»è·ƒ LRU é“¾è¡¨çš„å¤§å°ã€å°äºæ€»çš„å†…å­˜å¤§å°ã€‚ ä¸Šè¿°å†…å®¹è®¨è®ºäº†ä¸¤æ¬¡è¯»çš„é—´éš™å°äºæˆ–ç­‰äºå†…å­˜å¤§å°çš„æƒ…å†µï¼Œå³ NR_inactive+ï¼ˆR-Eï¼‰â‰¤ NR_inactive - NR_activeã€‚å¦‚æœä¸¤æ¬¡è¯»çš„é—´éš™å¤§äºå†…å­˜å¤§å°å‘¢ï¼Ÿè¿™ç§ç‰¹æ®Šæƒ…å†µä¸æ˜¯ Refault Distance ç®—æ³•èƒ½è§£å†³çš„ï¼Œå› ä¸ºå®ƒåœ¨ç¬¬äºŒæ¬¡è®¿é—®æ—¶å·±ç»æ°¸è¿œè¢«ç§»å‡º LRU é“¾è¡¨ï¼Œå¯ä»¥å‡è®¾ç¬¬äºŒæ¬¡è®¿å‘å‘ç”Ÿåœ¨é¥è¿œçš„æœ«æ¥ï¼Œä½†è°éƒ½æ— æ³•ä¿è¯å®ƒåœ¨ LRU é“¾è¡¨ä¸­ã€‚å…¶å® Refault Distance ç®—æ³•ç”¨äºåœ¨ç¬¬äºŒæ¬¡è®¿é—®æ—¶ï¼Œäººä¸ºåœ°æŠŠå†…å®¹ç¼“å­˜æ·»åŠ åˆ°æ´»è·ƒ LRU é“¾è¡¨ä¸­ï¼Œä»è€Œé˜²æ­¢è¯¥å†…å®¹ç¼“å­˜è¢«ç§»å‡º LRU é“¾è¡¨è€Œå¸¦æ¥çš„å†…å­˜é¢ ç°¸ã€‚</p><p>Refault Distanceï¼šç®—æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚T0 æ—¶åˆ»è¡¨ç¤ºç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªå†…å®¹ç¼“å­˜è¿™æ—¶ä¼šè°ƒç”¨ add_to_page_cache_lru è€Œé…ä¸€ä¸ª shadow æ¥å­˜å‚¨ zone-&gt;inactive_age å€¼ã€‚æ¯å½“æœ‰é¡µé¢è¢«å‡çº§ä¸ºæ´»è·ƒ LRU é“¾è¡¨ä¸­çš„é¡µé¢æ—¶ï¼Œzone-&gt;inactive_age å€¼ä¼šåŠ  1 æ¯å½“æœ‰é¢è¢«ç§»å‡ºä¸æ´»è·ƒ LU è¡¨æ—¶ï¼Œzone-&gt;inactive_age å€¼ä¹ŸåŠ  1. T1 æ—¶åˆ»ï¼Œè¯¥é¡µé¢è¢«ç§»å‡º LRU é“¾è¡¨å¹¶ä» LRU é“¾è¡¨ä¸­å›æ”¶é‡Šæ”¾å› æ­¤æŠŠå½“å‰ T1 æ—¶åˆ»çš„ zone-&gt;inactive_age çš„å€¼ç¼–ç å­˜æ”¾åˆ° shadow ä¸­ã€‚T2 æ—¶åˆ»ï¼Œç¬¬äºŒæ¬¡è®¿é—®è¯¥é¡µé¢ï¼Œå› æ­¤è¦è®¡ç®— Refault Distanceï¼ŒRefault Distanceï¼š=T2-T1ï¼Œå¦‚æœ Retault Distances â‰¤ NR_active. è¯´æ˜è¯¥å†…å®¹ç¼“å­˜ææœ‰å¯èƒ½åœ¨ä¸‹ä¸€æ¬¡è¯»æ—¶å·²ç»è¢«ç§»å‡º LRU é“¾è¡¨ï¼Œå› æ­¤è¦äººä¸ºåœ°æ¿€æ´»è¯¥é¡µé¢å¹¶ä¸”å°†å…¶åŠ å…¥æ´»è·ƒ LRU é“¾è¡¨ä¸­ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/RefaultDistance.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83MDk2NDE5NQ==">https://zhuanlan.zhihu.com/p/70964195<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83Mjk5ODYwNQ==">https://zhuanlan.zhihu.com/p/72998605<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆä¸ƒï¼‰è¿›ç¨‹åœ°å€ç©ºé—´</title>
      <link href="/2021/LinuxKernel/LinuxMemoryProcessSpace/"/>
      <url>/2021/LinuxKernel/LinuxMemoryProcessSpace/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryProcessSpace.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM3NDZmYzU2NTNiYjA3MWU3MTM0NTc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><h1 id="è¿›ç¨‹åœ°å€ç©ºé—´">è¿›ç¨‹åœ°å€ç©ºé—´</h1><p>è¿›ç¨‹åœ°å€ç©ºé—´åœ¨å†…æ ¸ä¸­ä½¿ç”¨ vm_area_struct æ•°æ®ç»“æ„æ¥æè¿°ï¼Œç®€ç§° VMAï¼Œè¡¨ç¤ºè¿›ç¨‹åœ°å€ç©ºé—´æˆ–è¿›ç¨‹çº¿æ€§åŒºã€‚ç”±äºè¿™äº›åœ°å€ç©ºé—´å±äºå„ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œå› æ­¤åœ¨ç”¨æˆ·è¿›ç¨‹çš„ mm_struct æ•°æ®ç»“æ„ä¸­æœ‰ç›¸åº”çš„æˆå‘˜ï¼Œç”¨äºå¯¹è¿™äº› VMA è¿›è¡Œç®¡ç†ã€‚</p><span id="more"></span><h2 id="å†…å­˜åŒºåŸŸ">å†…å­˜åŒºåŸŸ</h2><p>è¿›ç¨‹åœ°å€ç©ºé—´ï¼ˆprocess address spaceï¼‰æ˜¯æŒ‡è¿›ç¨‹å¯å¯»å€çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡å†…æ ¸çš„å†…å­˜ç®¡ç†æœºåˆ¶åŠ¨æ€åœ°æ·»åŠ å’Œåˆ é™¤å†…å­˜åŒºåŸŸï¼Œè¿™äº›å†…å­˜åŒºåŸŸåœ¨ Linux å†…æ ¸é‡‡ç”¨ VMA æ•°æ®ç»“æ„æ¥æŠ½è±¡æè¿°ã€‚</p><p>æ¯ä¸ªå†…å­˜åŒºåŸŸå…·æœ‰ç›¸å…³çš„æƒé™ï¼Œå¦‚å¯è¯»ã€å¯å†™æˆ–è€…å¯æ‰§è¡Œæƒé™ã€‚è‹¥ä¸€ä¸ªè¿›ç¨‹è®¿é—®äº†ä¸åœ¨æœ‰æ•ˆèŒƒå›´çš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…éæ³•è®¿é—®äº†å†…å­˜åŒºåŸŸï¼Œæˆ–è€…ä»¥ä¸æ­£ç¡®çš„æ–¹å¼è®¿é—®äº†å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šæŠ¥å‘Šç¼ºé¡µå¼‚å¸¸ã€‚åœ¨ Linux å†…æ ¸çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ä¸­ä¼šå¤„ç†è¿™äº›æƒ…å†µï¼Œä¸¥é‡çš„ä¼šæŠ¥å‘Šâ€œSegmentFault'â€å¹¶ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚</p><p>å†…å­˜åŒºåŸŸä¸»è¦åŒ…å«å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>ä»£ç æ®µæ˜ å°„ï¼šå¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«åªè¯»å¹¶å¯æ‰§è¡Œçš„ç¨‹åºå¤´ï¼Œå¦‚ä»£ç æ®µå’Œ init æ®µç­‰</li><li>æ•°æ®æ®µæ˜ å°„ï¼šå¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«å¯è¯»/å¯å†™çš„ç¨‹åºå¤´ï¼Œå¦‚æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µç­‰</li><li>ç”¨æˆ·è¿›ç¨‹æ ˆï¼šé€šå¸¸ä½äºç”¨æˆ·ç©ºé—´çš„æœ€é«˜åœ°å€ï¼Œä»ä¸Šå¾€ä¸‹å»¶ä¼¸ã€‚å®ƒåŒ…å«æ ˆå¸§ï¼Œé‡Œé¢åŒ…å«äº†å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨å‚æ•°ç­‰</li><li>mmap æ˜ å°„åŒºåŸŸï¼šä½äºç”¨æˆ·è¿›ç¨‹æ ˆä¸‹é¢ï¼Œä¸»è¦ç”¨äº mmap ç³»ç»Ÿè°ƒç”¨</li><li>å †æ˜ å°„åŒºåŸŸï¼šmalloc() å‡½æ•°åˆ†é…çš„è¿›ç¨‹è™šæ‹Ÿåœ°å€å°±æ˜¯è¿™æ®µåŒºåŸŸ</li></ul><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€å¥—é¡µè¡¨ï¼Œè¿™æ ·æ¯ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´å°±æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚å³ä½¿ä¸¤ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ç»è¿‡ä¸¤å¥—ä¸åŒé¡µè¡¨çš„è½¬æ¢ä¹‹åï¼Œå®ƒä»¬ä¹Ÿä¼šå¯¹åº”ä¸åŒçš„ç‰©ç†åœ°å€ã€‚</p><h2 id="mm_struct-æ•°æ®ç»“æ„">mm_struct æ•°æ®ç»“æ„</h2><p>Linux å†…æ ¸éœ€è¦ç®¡ç†æ¯ä¸ªè¿›ç¨‹æ‰€æœ‰çš„å†…å­˜åŒºåŸŸä»¥åŠå®ƒä»¬å¯¹åº”çš„é¡µè¡¨æ˜ å°„ï¼Œæ‰€ä»¥å¿…é¡»æŠ½è±¡å‡ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œè¿™å°±æ˜¯ mm_struct æ•°æ®ç»“æ„ã€‚è¿›ç¨‹æ§åˆ¶å—ï¼ˆProcess Control Blockï¼ŒPCBï¼‰æ•°æ®ç»“æ„ task_struct ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ mmï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘è¿™ä¸ª mm_struct æ•°æ®ç»“æ„ã€‚mm_struct æ•°æ®ç»“æ„å®šä¹‰åœ¨ include/linux/mm_types.h æ–‡ä»¶ä¸­ï¼Œä¸‹é¢æ˜¯å®ƒçš„ä¸»è¦æˆå‘˜ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">mmap</span>;</span><span class="comment">/* list of VMAs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">mm_rb</span>;</span></span><br><span class="line">u64 vmacache_seqnum;                   <span class="comment">/* per-thread vmacache */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span> <span class="params">(<span class="keyword">struct</span> file *filp,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">unsigned</span> <span class="type">long</span> len,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> pgoff, <span class="type">unsigned</span> <span class="type">long</span> flags)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mmap_base;<span class="comment">/* base of mmap area */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mmap_legacy_base;<span class="comment">/* base of mmap area in bottom-up allocations */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAVE_ARCH_COMPAT_MMAP_BASES</span></span><br><span class="line"><span class="comment">/* Base addresses for compatible mmap() */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mmap_compat_base;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mmap_compat_legacy_base;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> task_size;<span class="comment">/* size of task vm space */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> highest_vm_end;<span class="comment">/* highest vma end address */</span></span><br><span class="line"><span class="type">pgd_t</span> * pgd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMBARRIER</span></span><br><span class="line"><span class="type">atomic_t</span> membarrier_state;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">atomic_t</span> mm_users;</span><br><span class="line"></span><br><span class="line"><span class="type">atomic_t</span> mm_count;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line"><span class="type">atomic_long_t</span> pgtables_bytes;<span class="comment">/* PTE page table pages */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">int</span> map_count;<span class="comment">/* number of VMAs */</span></span><br><span class="line"></span><br><span class="line"><span class="type">spinlock_t</span> page_table_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">mmap_lock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mmlist</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> hiwater_rss; <span class="comment">/* High-watermark of RSS usage */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> hiwater_vm;  <span class="comment">/* High-water virtual memory usage */</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> total_vm;   <span class="comment">/* Total pages mapped */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> locked_vm;   <span class="comment">/* Pages that have PG_mlocked set */</span></span><br><span class="line"><span class="type">atomic64_t</span>    pinned_vm;   <span class="comment">/* Refcount permanently increased */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> data_vm;   <span class="comment">/* VM_WRITE &amp; ~VM_SHARED &amp; ~VM_STACK */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> exec_vm;   <span class="comment">/* VM_EXEC &amp; ~VM_WRITE &amp; ~VM_STACK */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> stack_vm;   <span class="comment">/* VM_STACK */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> def_flags;</span><br><span class="line"></span><br><span class="line"><span class="type">seqcount_t</span> write_protect_seq;</span><br><span class="line"></span><br><span class="line"><span class="type">spinlock_t</span> arg_lock; <span class="comment">/* protect the below fields */</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> start_code, end_code, start_data, end_data;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> start_brk, brk, start_stack;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> arg_start, arg_end, env_start, env_end;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> saved_auxv[AT_VECTOR_SIZE]; <span class="comment">/* for /proc/PID/auxv */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_rss_stat</span> <span class="title">rss_stat</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_binfmt</span> *<span class="title">binfmt</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Architecture-specific MM context */</span></span><br><span class="line"><span class="type">mm_context_t</span> context;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags; <span class="comment">/* Must use atomic bitops to access */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">core_state</span> *<span class="title">core_state</span>;</span> <span class="comment">/* coredumping support */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AIO</span></span><br><span class="line"><span class="type">spinlock_t</span>ioctx_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kioctx_table</span> __<span class="title">rcu</span>*<span class="title">ioctx_table</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* store ref to file /proc/&lt;pid&gt;/exe symlink points to */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> *<span class="title">exe_file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMU_NOTIFIER</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmu_notifier_subscriptions</span> *<span class="title">notifier_subscriptions</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_TRANSPARENT_HUGEPAGE) &amp;&amp; !USE_SPLIT_PMD_PTLOCKS</span></span><br><span class="line"><span class="type">pgtable_t</span> pmd_huge_pte; <span class="comment">/* protected by page_table_lock */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> numa_next_scan;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Restart point for scanning and setting pte_numa */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> numa_scan_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* numa_scan_seq prevents two threads setting pte_numa */</span></span><br><span class="line"><span class="type">int</span> numa_scan_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">atomic_t</span> tlb_flush_pending;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH</span></span><br><span class="line"><span class="comment">/* See flush_tlb_batched_pending() */</span></span><br><span class="line"><span class="type">bool</span> tlb_flush_batched;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uprobes_state</span> <span class="title">uprobes_state</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HUGETLB_PAGE</span></span><br><span class="line"><span class="type">atomic_long_t</span> hugetlb_usage;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">async_put_work</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IOMMU_SUPPORT</span></span><br><span class="line">u32 pasid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> cpu_bitmap[];</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>mm_struct æ•°æ®ç»“æ„ä¸­ä¸»è¦æˆå‘˜çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>mmapï¼šè¿›ç¨‹é‡Œæ‰€æœ‰çš„ VMA å½¢æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œè¿™æ˜¯è¯¥é“¾è¡¨çš„å¤´</li><li>mmrbï¼šVMA çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹</li><li>get_unmapped_areaï¼šç”¨äºåˆ¤æ–­è™šæ‹Ÿå†…å­˜ç©ºé—´æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè¿”å›ä¸€æ®µæ²¡æœ‰æ˜ å°„è¿‡çš„ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨å…·ä½“çš„å¤„ç†å™¨æ¶æ„çš„å®ç°</li><li>mmap_baseï¼šæŒ‡å‘ mmap ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚åœ¨ 32 ä½å¤„ç†å™¨ä¸­ï¼Œmmap ç©ºé—´çš„èµ·å§‹åœ°æ˜¯ 0x4000 0000</li><li>pgdï¼šæŒ‡å‘è¿›ç¨‹çš„ PGDï¼ˆä¸€çº§é¡µè¡¨ï¼‰</li><li>mm_usersï¼šè®°å½•æ­£åœ¨ä½¿ç”¨è¯¥è¿›ç¨‹åœ°å€ç©ºé—´çš„è¿›ç¨‹æ•°ç›®ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹å…±äº«è¯¥åœ°å€ç©ºé—´é‚£ä¹ˆ mm_users çš„å€¼ç­‰äº 2</li><li>mm_countï¼šmm_struct ç»“æ„ä½“çš„ä¸»å¼•ç”¨è®¡æ•°</li><li>mmap_semï¼šä¿æŠ¤ VMA çš„ä¸€ä¸ªè¯»å†™ä¿¡å·é‡</li><li>mmlistï¼šæ‰€æœ‰çš„ mm_struct æ•°æ®ç»“æ„éƒ½è¿æ¥åˆ°ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œè¯¥é“¾è¡¨çš„å¤´æ˜¯ init_mm å†…å­˜æè¿°ç¬¦ï¼Œå®ƒæ˜¯ init è¿›ç¨‹çš„åœ°å€ç©ºé—´</li><li>start_codeï¼Œend_codeï¼šä»£ç æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€</li><li>start_dataï¼Œend_dataï¼šæ•°æ®æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€</li><li>start_brkï¼šå †ç©ºé—´çš„èµ·å§‹åœ°å€</li><li>brkï¼šè¡¨ç¤ºå½“å‰å †ä¸­çš„ VMA çš„ç»“æŸåœ°å€</li><li>total_vmï¼šå·²ç»ä½¿ç”¨çš„è¿›ç¨‹åœ°å€ç©ºé—´æ€»å’Œ</li></ul><p>ä»è¿›ç¨‹çš„è§’åº¦æ¥è§‚å¯Ÿå†…å­˜ç®¡ç†ï¼Œå¯ä»¥æ²¿ç€ mm_struct æ•°æ®ç»“æ„è¿›è¡Œå»¶ä¼¸å’Œæ€è€ƒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma1.png"></p><h2 id="vma-æ•°æ®ç»“æ„">VMA æ•°æ®ç»“æ„</h2><p>VMAï¼ˆvm_area_structï¼‰æ•°æ®ç»“æ„å®šä¹‰åœ¨ mm_types.h æ–‡ä»¶ä¸­ï¼Œå…¶ä¸»è¦æˆå‘˜å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">include/<span class="number">1</span>inux/mm_types.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> {</span></span><br><span class="line"><span class="comment">/* The first cache line has the info for VMA tree walking. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> vm_start;<span class="comment">/* Our start address within vm_mm. */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> vm_end;<span class="comment">/* The first byte after our end address</span></span><br><span class="line"><span class="comment">   within vm_mm. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* linked list of VM areas per task, sorted by address */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vm_next</span>, *<span class="title">vm_prev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">vm_rb</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rb_subtree_gap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Second cache line starts here. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span><span class="comment">/* The address space we belong to. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">pgprot_t</span> vm_page_prot;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> vm_flags;<span class="comment">/* Flags, see mm.h. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rb_subtree_last;</span><br><span class="line">} shared;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">anon_vma_chain</span>;</span> <span class="comment">/* Serialized by mmap_lock &amp;</span></span><br><span class="line"><span class="comment">  * page_table_lock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">anon_vma</span> *<span class="title">anon_vma</span>;</span><span class="comment">/* Serialized by page_table_lock */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function pointers to deal with this struct. */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Information about our backing store: */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;<span class="comment">/* Offset (within vm_file) in PAGE_SIZE</span></span><br><span class="line"><span class="comment">   units */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span><span class="comment">/* File we map to (can be NULL). */</span></span><br><span class="line"><span class="type">void</span> * vm_private_data;<span class="comment">/* was vm_pte (shared mem) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SWAP</span></span><br><span class="line"><span class="type">atomic_long_t</span> swap_readahead_info;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_region</span> *<span class="title">vm_region</span>;</span><span class="comment">/* NOMMU mapping region */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mempolicy</span> *<span class="title">vm_policy</span>;</span><span class="comment">/* NUMA policy for the VMA */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_userfaultfd_ctx</span> <span class="title">vm_userfaultfd_ctx</span>;</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure><p>VMA æ•°æ®ç»“æ„ä¸­å„ä¸ªæˆå‘˜çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>vm_start å’Œ vm_endï¼šæŒ‡å®š VMA åœ¨è¿›ç¨‹åœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€</li><li>vm_next å’Œ vm_prevï¼šè¿›ç¨‹çš„ VMA éƒ½è¿æ¥æˆä¸€ä¸ªé“¾è¡¨</li><li>vmrbï¼šVMA ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥çº¢é»‘æ ‘ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ mm_struct æ•°æ®ç»“æ„ä¸­éƒ½æœ‰ä¸€æ£µçº¢é»‘æ ‘ mm-&gt;mm_rb</li><li>vm_mmï¼šæŒ‡å‘è¯¥ VMA æ‰€å±è¿›ç¨‹çš„ mm_struct æ•°æ®ç»“æ„</li><li>vm_page_protï¼šVMA çš„è®¿é—®æƒé™</li><li>vm_flagsï¼šæè¿°è¯¥ VMA çš„ä¸€ç»„æ ‡å¿—ä½</li><li>anon_vma_chain å’Œ anon_vmaï¼šç”¨äºç®¡ç†åå‘æ˜ å°„ï¼ˆReverse Mappingï¼ŒRMAPï¼‰</li><li>vm_opsï¼šæŒ‡å‘è®¸å¤šæ–¹æ³•çš„é›†åˆï¼Œè¿™äº›æ–¹æ³•ç”¨äºåœ¨ VMA ä¸­æ‰§è¡Œå„ç§æ“ä½œï¼Œé€šå¸¸ç”¨äºæ–‡ä»¶æ˜ å°„</li><li>vm_pgoffï¼šæŒ‡å®šæ–‡ä»¶æ˜ å°„çš„åç§»é‡ï¼Œè¿™ä¸ªå˜é‡çš„å•ä½ä¸æ˜¯å­—èŠ‚ï¼Œè€Œæ˜¯é¡µé¢çš„å¤§å°ä»¶æ˜ å°„ã€‚ï¼ˆPAGE SIZEï¼‰ã€‚å¯¹äºåŒ¿åé¡µé¢æ¥è¯´ï¼Œå®ƒçš„å€¼å¯ä»¥æ˜¯ 0 æˆ–è€… vm_addr/PAGE_SIZE</li><li>vm_fileï¼šæŒ‡å‘ file çš„å®ä¾‹ï¼Œæè¿°ä¸€ä¸ªè¢«æ˜ å°„çš„æ–‡ä»¶</li></ul><p>mm_struct æ•°æ®ç»“æ„æ˜¯æè¿°è¿›ç¨‹å†…å­˜ç®¡ç†çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œè¯¥æ•°æ®ç»“æ„æä¾›äº†ç®¡ç† VMA æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œæ¯ä¸ª VMA éƒ½è¦è¿æ¥åˆ° mm_struct ä¸­çš„é“¾è¡¨å’Œçº¢é»‘æ ‘ï¼Œä»¥æ–¹ä¾¿æŸ¥æ‰¾ã€‚</p><p>VMA æŒ‰ç…§èµ·å§‹åœ°å€ä»¥é€’å¢çš„æ–¹å¼æ’å…¥ mm_struct-&gt;mmp é“¾è¡¨ä¸­ã€‚å½“è¿›ç¨‹æ‹¥æœ‰å¤§é‡çš„ VMA æ—¶ï¼Œæ‰«æé“¾è¡¨å’ŒæŸ¥æ‰¾ç‰¹å®šçš„ VMA æ˜¯éå¸¸ä½æ•ˆçš„æ“ä½œï¼Œå¦‚åœ¨äº‘è®¡ç®—çš„æœºå™¨ä¸­ï¼Œæ‰€ä»¥å†…æ ¸ä¸­é€šå¸¸éœ€è¦çº¢é»‘æ ‘æ¥ååŠ©ï¼Œä»¥ä¾¿æé«˜æŸ¥æ‰¾é€Ÿåº¦ã€‚ ç«™åœ¨è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿›ç¨‹æ§åˆ¶å—ã€‚task_struct æ•°æ®ç»“æ„é‡Œé¡ºè—¤æ‘¸ç“œæ‰¾åˆ°è¯¥è¿›ç¨‹æ‰€æœ‰çš„ VMAï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma1.png"></p><ul><li>task_struct ç»“ç»“æ„ä¸­æœ‰ä¸€ä¸ª mm æˆå‘˜æŒ‡å‘è¿›ç¨‹çš„å†…å­˜ç®¡ç†æè¿°ç¬¦ mm_struct æ•°æ®ç»“æ„</li><li>å¯ä»¥é€šè¿‡ mm_struct æ•°æ®ç»“æ„ä¸­çš„ mmap æˆå‘˜æ¥éå†æ‰€æœ‰çš„ VMA</li><li>ä¹Ÿå¯ä»¥é€šè¿‡ mm_struct æ•°æ®ç»“æ„ä¸­çš„ mm_rb æˆå‘˜æ¥éå†å’ŒæŸ¥æ‰¾ VMA</li><li>mm_struct æ•°æ®ç»“æ„çš„ pgd æˆå‘˜æŒ‡å‘è¿›ç¨‹çš„é¡µè¡¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä»½ç‹¬ç«‹çš„é¡µè¡¨</li><li>å½“ CPU ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´æ—¶ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ã€‚åœ¨ç¼ºé¡µå¼‚å¸¸å¤„ç†ä¸­ï¼Œåˆ†é…ç‰©ç†é¡µé¢ï¼Œåˆ©ç”¨åˆ†é…çš„ç‰©ç†é¡µé¢æ¥åˆ›å»ºé¡µè¡¨é¡¹å¹¶ä¸”å¡«å……é¡µè¡¨ï¼Œå®Œæˆè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»çš„å»ºç«‹</li></ul><h2 id="vma-çš„å±æ€§">VMA çš„å±æ€§</h2><p>ä½œä¸ºä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´çš„åŒºé—´ï¼ŒVMA æ˜¯æœ‰å±æ€§çš„ï¼Œå¦‚å¯è¯»/å¯å†™ã€å…±äº«ç­‰å±æ€§ã€‚vm_flags æˆå‘˜æè¿°è¿™äº›å±æ€§ï¼Œæè¿°äº†è¯¥ VMA çš„å…¨éƒ¨é¡µé¢ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¦‚ä½•æ˜ å°„é¡µé¢ã€è®¿é—®æ¯ä¸ªé¡µé¢çš„æƒé™ç­‰ä¿¡æ¯ï¼ŒVMA å±æ€§çš„æ ‡å¿—ä½å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>VM_READ: å¯è¯»å±æ€§</li><li>VM_WRITE: å¯å†™å±æ€§</li><li>VM_EXEC: å¯æ‰§è¡Œ</li><li>VM_SHARED: å…è®¸è¢«å¤šä¸ªè¿›ç¨‹å…±äº«</li><li>VM_MAYREAD: å…è®¸è®¾ç½® VM_READ å±æ€§</li><li>VM_MAYWRITE: å…è®¸è®¾ç½® VM WRITE å±æ€§</li><li>VM_MAYEXEC: å…è®¸è®¾ç½® VM EXEC å±æ€§</li><li>VM_MAYSHARE: å…è®¸è®¾ç½® VM SHARED å±æ€§</li><li>VM_GROWSDOWN: è¯¥ VMA å…è®¸å‘ä½åœ°å€å¢é•¿</li><li>VM_UFFD_MISSING: è¡¨ç¤ºè¯¥ VMA é€‚ç”¨äºç”¨æˆ·æ€çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†</li><li>VM_PFNMAP: è¡¨ç¤ºä½¿ç”¨çº¯æ­£çš„ PFNï¼Œä¸éœ€è¦ä½¿ç”¨å†…æ ¸çš„ page æ•°æ®ç»“æ„æ¥ç®¡ç†ç‰©ç†é¡µé¢</li><li>VM_DENYWRITE: è¡¨ç¤ºä¸å…è®¸å†™å…¥</li><li>VM_UFFD_WP: ç”¨äºé¡µé¢çš„å†™ä¿æŠ¤è·Ÿè¸ª</li><li>VM_LOCKED: è¡¨ç¤ºè¯¥ VMA çš„å†…å­˜ä¼šç«‹åˆ»åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¹¶ä¸”é¡µé¢è¢«é”å®šï¼Œä¸ä¼šè¢«äº¤æ¢åˆ°äº¤æ¢åˆ†åŒº</li><li>VM_IO: è¡¨ç¤º I/0 å†…å­˜æ˜ å°„</li><li>VM_SEQ_READ: è¡¨ç¤ºåº”ç”¨ç¨‹åºä¼šé¡ºåºè¯»è¯¥ VMA çš„å†…å®¹</li><li>VM_RAND_READ: è¡¨ç¤ºåº”ç”¨ç¨‹åºä¼šéšæœºè¯»è¯¥ VMA çš„å†…å®¹</li><li>VM_DONTCOPY: è¡¨ç¤ºåœ¨åˆ›å»ºåˆ†æ”¯æ—¶ä¸è¦å¤åˆ¶è¯¥ VMA</li><li>VM_DONTEXPAND: é€šè¿‡ mremapo ç³»ç»Ÿè°ƒç”¨ç¦æ­¢ VMA æ‰©å±•</li><li>VM_ACCOUNT: åœ¨åˆ›å»º IPC ä»¥å…±äº« VMA æ—¶ï¼Œæ£€æµ‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜ç”¨äºæ˜ å°„</li><li>VM_HUGETLB: ç”¨äºå·¨é¡µçš„æ˜ å°„</li><li>VM_SYNC: è¡¨ç¤ºåŒæ­¥çš„ç¼ºé¡µå¼‚å¸¸</li><li>VM_ARCH_1: ä¸æ¶æ„ç›¸å…³çš„æ ‡å¿—ä½</li><li>VM_WIPEONFORK: è¡¨ç¤ºä¸ä¼šä»çˆ¶è¿›ç¨‹ç›¸åº”çš„ VMA ä¸­å¤åˆ¶é¡µè¡¨åˆ°å­è¿›ç¨‹çš„ VMA ä¸­</li><li>VM_DONTDUMP: è¡¨ç¤ºè¯¥ VMA ä¸åŒ…å«åˆ°æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ä¸­</li><li>VM_SOFTDIRTY: è½¯ä»¶æ¨¡æ‹Ÿå®ç°çš„è„ä½ã€‚ç”¨äºä¸€äº›ç‰¹æ®Šçš„æ¶æ„ï¼Œéœ€è¦æ‰“å¼€ CONFIG_MEM_SOFT_DIRTY</li><li>VM_MIXEDMAP: è¡¨ç¤ºæ··åˆä½¿ç”¨äº†çº¯ PFN ä»¥åŠ page æ•°æ®ç»“æ„çš„é¡µé¢ï¼Œå¦‚ä½¿ç”¨ vm_insert_page() å‡½æ•°æ’å…¥ VMA</li><li>VM_HUGEPAGE: è¡¨ç¤ºåœ¨ madvise ç³»ç»Ÿè°ƒç”¨ä¸­ä½¿ç”¨ MADV_HUGEPAGE æ ‡å¿—ä½æ¥æ ‡è®°è¯¥ VMA</li><li>VM_NOHUGEPAGE: è¡¨ç¤ºåœ¨ madvise ç³»ç»Ÿè°ƒç”¨ä¸­ä½¿ç”¨ MADV_NOHUGEPAGE æ ‡å¿—ä½æ¥æ ‡è®°è¯¥ VMA</li><li>VM_MERGEABLE: è¡¨ç¤ºè¯¥ VMA æ˜¯å¯ä»¥åˆå¹¶çš„ï¼Œç”¨äº KSM æœºåˆ¶</li><li>VM_SPECIAL: è¡¨ç¤ºè¯¥ VMA æ˜¯ä¸å¯ä»¥åˆå¹¶çš„</li></ul><p>VMA å±æ€§çš„æ ‡å¿—ä½å¯ä»¥ä»»æ„ç»„åˆï¼Œä½†æ˜¯æœ€ç»ˆè¦è½å®åˆ°ç¡¬ä»¶æœºåˆ¶ä¸Šï¼Œå³é¡µè¡¨é¡¹çš„å±æ€§ä¸­ã€‚VMA å±æ€§åˆ°é¡µè¡¨å±æ€§çš„è½¬æ¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚vm_area_struct æ•°æ®ç»“æ„ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å’Œå±æ€§ç›¸å…³ï¼šä¸€ä¸ªæ˜¯ vm_flags æˆå‘˜ï¼Œç”¨äºæè¿° VMA çš„å±æ€§ï¼›å¦å¤–ä¸€ä¸ªæ˜¯ vm_page_prot æˆå‘˜ï¼Œç”¨äºå°† VMA å±æ€§æ ‡å¿—ä½è½¬æ¢æˆä¸å¤„ç†å™¨ç›¸å…³çš„é¡µè¡¨é¡¹çš„å±æ€§ï¼Œå®ƒå’Œå…·ä½“æ¶æ„ç›¸å…³ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma2.png"></p><p>åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ VMA æ—¶ä½¿ç”¨ vm_get_page_prot() å‡½æ•°å¯ä»¥æŠŠ vm_flags æ ‡å¿—ä½è½¬åŒ–æˆå…·é¡µè¡¨é¡¹çš„ç¡¬ä»¶æ ‡å¿—ä½ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/mmap.c&gt;</span><br><span class="line"><span class="type">pgprot_t</span> <span class="title function_">vm_get_page_prot</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> vm_flags)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">pgprot_t</span> ret = __pgprot(pgprot_val(protection_map[vm_flags &amp;</span><br><span class="line">(VM_READ|VM_WRITE|VM_EXEC|VM_SHARED)]) |</span><br><span class="line">pgprot_val(arch_vm_get_page_prot(vm_flags)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> arch_filter_pgprot(ret);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(vm_get_page_prot);</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹å¾—ç›Šäºå†…æ ¸é¢„å…ˆå®šä¹‰äº†ä¸€ä¸ªå†…å­˜å±æ€§æ•°ç»„ protection_map[], æˆ‘ä»¬åªéœ€è¦æ ¹æ® vm_flag æ ‡å¿—ä½æ¥æŸ¥è¯¢è¿™ä¸ªæ•°ç»„å³å¯ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œé€šè¿‡æŸ¥è¯¢ protection_map[] æ•°ç»„å¯ä»¥è·å¾—é¡µè¡¨å±æ€§ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pgprot_t</span> protection_map[<span class="number">16</span>] __ro_after_init = {</span><br><span class="line">__P000, __P001, __P010, __P011, __P100, __P101, __P110, __P111,</span><br><span class="line">__S000, __S001, __S010, __S011, __S100, __S101, __S110, __S111</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>protection_map[] æ•°ç»„çš„æ¯ä¸ªæˆå‘˜ä»£è¡¨ä¸€ä¸ªå±æ€§çš„ç»„åˆï¼Œå¦‚__P000 è¡¨ç¤ºæ— æ•ˆçš„ PTE å±æ€§ï¼Œ__P001 è¡¨ç¤ºåªè¯»å±æ€§ï¼Œ__P1O0 è¡¨ç¤ºå¯æ‰§è¡Œå±æ€§ï¼ˆPAGE_EXECONLYï¼‰ç­‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __P000PAGE_NONE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P001__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_READABLE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P010__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_WRITABLE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P011__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_READABLE \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_WRITABLE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P100__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_EXEC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P101__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_READABLE \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_EXEC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P110__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_WRITABLE \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_EXEC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __P111__pgprot(CF_PAGE_VALID \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_ACCESSED \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_READABLE \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_WRITABLE \</span></span><br><span class="line"><span class="meta"> | CF_PAGE_EXEC)</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢ä»¥åªè¯»å±æ€§ï¼ˆPAGE_READONLYï¼‰æ¥çœ‹ï¼Œå®ƒç©¶ç«ŸåŒ…å«å“ªäº›é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_READONLY__pgprot(_PAGE_DEFAULT | PTE_USER | PTE_RDONLY | PTE_NG | PTE_PXN | PTE_UXN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PAGE_DEFAULT(_PROT_DEFAULT | PTE_ATTRINDX(MT_NORMAL))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PROT_DEFAULT(PTE_TYPE_PAGE | PTE_AF | PTE_SHARED)</span></span><br></pre></td></tr></tbody></table></figure><p>æŠŠä¸Šè¿°çš„å®å…¨éƒ¨å±•å¼€ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ã€‚</p><ul><li>PTE_TYPE_PAGEï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåŸºäºé¡µé¢çš„é¡µè¡¨é¡¹ï¼Œå³è®¾ç½®é¡µè¡¨é¡¹çš„ Bit[1:O]</li><li>PTE_AFï¼šè®¾ç½®è®¿é—®ä½</li><li>PTE_SHAREDï¼šè®¾ç½®å†…å­˜å…±äº«å±æ€§</li><li>MT_NORMALï¼šè®¾ç½®å†…å­˜å±æ€§ä¸º normal</li><li>PTE_USERï¼šè®¾ç½® AP è®¿é—®ä½ï¼Œå…è®¸é€šè¿‡ç”¨æˆ·æƒé™è®¿é—®è¯¥å†…å­˜</li><li>PTE_NGï¼šè®¾ç½®è¯¥å†…å­˜å¯¹åº”çš„ TLB åªå±äºè¯¥è¿›ç¨‹</li><li>PTE_PXNï¼šè¡¨ç¤ºè¯¥å†…å­˜ä¸èƒ½åœ¨ç‰¹æƒæ¨¡å¼ä¸‹æ‰§è¡Œ</li><li>PTE_UXNï¼šè¡¨ç¤ºè¯¥å†…å­˜ä¸èƒ½åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œ</li><li>PTE_RDONLYï¼šè¡¨ç¤ºåªè¯»å±æ€§</li></ul><h1 id="å†…æ ¸å¦‚ä½•ç®¡ç†å†…å­˜">å†…æ ¸å¦‚ä½•ç®¡ç†å†…å­˜</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma100.png"></p><p>Linux è¿›ç¨‹åœ¨å†…æ ¸ä¸­ä½œä¸ºè¿›ç¨‹æè¿°ç¬¦ task_struct çš„å®ä¾‹å®ç°ã€‚task_struct ä¸­çš„ mm å­—æ®µæŒ‡å‘å†…å­˜æè¿°ç¬¦ mm_struct ï¼Œå®ƒæ˜¯ç¨‹åºå†…å­˜çš„æ‰§è¡Œå†…å®¹ã€‚å®ƒå­˜å‚¨äº†å¦‚ä¸Šæ‰€ç¤ºçš„å†…å­˜æ®µçš„å¼€å§‹å’Œç»“æŸã€è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜é¡µæ•°ï¼ˆrss ä»£è¡¨ Resident Set Sizeï¼‰ã€ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ ä»¥åŠå…¶ä»–ä¿¡æ¯ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma101.png"> æ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰æ˜¯ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿåœ°å€èŒƒå›´ï¼›è¿™äº›åŒºåŸŸæ°¸è¿œä¸ä¼šé‡å ã€‚vm_area_struct çš„å®ä¾‹å®Œæ•´åœ°æè¿°äº†ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼ŒåŒ…æ‹¬å…¶èµ·å§‹å’Œç»“æŸåœ°å€ã€ç”¨äºç¡®å®šè®¿é—®æƒé™å’Œè¡Œä¸ºçš„æ ‡å¿—ï¼Œä»¥åŠç”¨äºæŒ‡å®šè¯¥åŒºåŸŸæ˜ å°„çš„æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰çš„ vm_file å­—æ®µã€‚ä¸æ˜ å°„æ–‡ä»¶çš„ VMA æ˜¯åŒ¿åçš„ã€‚é™¤äº†å†…å­˜æ˜ å°„æ®µä¹‹å¤–ï¼Œä¸Šé¢çš„æ¯ä¸ªå†…å­˜æ®µï¼ˆä¾‹å¦‚ï¼Œå †ã€å †æ ˆï¼‰å¯¹åº”äºå•ä¸ª VMAã€‚è¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œå°½ç®¡è¿™åœ¨ x86 æœºå™¨ä¸­å¾ˆå¸¸è§ã€‚VMA ä¸å…³å¿ƒå®ƒä»¬ä½äºå“ªä¸ªæ®µã€‚ ç¨‹åºçš„ VMA éƒ½ä»¥é“¾è¡¨å½¢å¼å­˜å‚¨åœ¨å…¶å†…å­˜æè¿°ç¬¦ä¸­ mmap å­—æ®µï¼ŒæŒ‰èµ·å§‹è™šæ‹Ÿåœ°å€æ’åºï¼Œå¹¶ä½œä¸ºä»¥ mm_rb å­—æ®µä¸ºæ ¹çš„çº¢é»‘æ ‘ ã€‚çº¢é»‘æ ‘å…è®¸å†…æ ¸å¿«é€Ÿæœç´¢è¦†ç›–ç»™å®šè™šæ‹Ÿåœ°å€çš„å†…å­˜åŒºåŸŸã€‚å½“æ‚¨è¯»å–æ–‡ä»¶/proc/pid_of_process/maps æ—¶ï¼Œå†…æ ¸åªæ˜¯éå†è¿›ç¨‹çš„ VMA é“¾æ¥åˆ—è¡¨å¹¶æ‰“å°æ¯ä¸€ä¸ª VMAã€‚</p><p>VMA çš„å¤§å°å¿…é¡»æ˜¯é¡µé¢å¤§å°çš„å€æ•°ã€‚å¤„ç†å™¨æŸ¥é˜…é¡µè¡¨ä»¥å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†å†…å­˜åœ°å€ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„é¡µè¡¨ï¼›æ¯å½“å‘ç”Ÿè¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œç”¨æˆ·ç©ºé—´çš„é¡µè¡¨ä¹Ÿä¼šåˆ‡æ¢ã€‚Linux åœ¨å†…å­˜æè¿°ç¬¦çš„ pgd å­—æ®µä¸­å­˜å‚¨æŒ‡å‘è¿›ç¨‹é¡µè¡¨çš„æŒ‡é’ˆã€‚é¡µè¡¨ä¸­çš„æ¯ä¸ªè™šæ‹Ÿé¡µéƒ½å¯¹åº”ä¸€ä¸ªé¡µè¡¨é¡¹ (PTE)ï¼Œåœ¨å¸¸è§„ x86 åˆ†é¡µä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ 4 å­—èŠ‚è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vma102.png"></p><h1 id="malloc-å‡½æ•°">malloc å‡½æ•°</h1><p>malloc() å‡½æ•°æ˜¯ C æ ‡å‡†åº“å°è£…çš„ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ï¼ŒC æ ‡å‡†åº“åšä¸€äº›å¤„ç†åä¼šè°ƒç”¨ Linux çš„ç³»çº¿è°ƒç”¨æ¥å£ brk å‘ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</p><h2 id="brk-ç³»ç»Ÿè°ƒç”¨">brk ç³»ç»Ÿè°ƒç”¨</h2><p>brk ç³»ç»Ÿè°ƒç”¨ä¸»è¦å®ç°åœ¨ mm/mmap.c æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE1(brk, <span class="type">unsigned</span> <span class="type">long</span>, brk)</span><br></pre></td></tr></tbody></table></figure><p>è¯¦ç»†æµç¨‹è¿™é‡Œä¸ä¸€ä¸€åˆ—å‡ºæ¥äº†ï¼Œä¸‹é¢ç”¨ä¸€å¼ å›¾æ¦‚æ‹¬ brk çš„æµç¨‹ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/brk.png"></p><h2 id="malloc-æµç¨‹">malloc æµç¨‹</h2><p>å‡è®¾ä¸è€ƒè™‘ libc çš„å› ç´ ï¼Œmalloc() åˆ†é… 100 å­—èŠ‚ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šåˆ†é…å¤šå°‘å­—èŠ‚å‘¢ï¼Ÿå¤„ç†å™¨çš„ MMU çš„æœ€å°å¤„ç†å•å…ƒæ˜¯é¡µé¢ï¼Œæ‰€ä»¥å†…æ ¸åˆ†é…å†…å­˜ã€å»ºç«‹è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„å…³ç³»éƒ½ä»¥é¡µé¢ä¸ºå•ä½ï¼ŒPAGE_ALIGNï¼ˆaddrï¼‰å®è®©åœ°å€æŒ‰é¡µé¢å¤§å°å¯¹é½ã€‚ ä¸‹å›¾æ‰€ç¤ºä¸º malloc() å‡½æ•°çš„å®ç°æµç¨‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/malloc.png"></p><h1 id="mmap-å‡½æ•°">mmap å‡½æ•°</h1><p>mmap/munmap å‡½æ•°æ˜¯ç”¨æˆ·ç©ºé—´ä¸­å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œæ— è®ºæ˜¯åœ¨ç”¨æˆ·ç¨‹åºä¸­åˆ†é…å†…å­˜ã€è¯»å†™å¤§æ–‡ä»¶ã€é“¾æ¥åŠ¨æ€åº“æ–‡ä»¶ï¼Œè¿˜æ˜¯å¤šè¿›ç¨‹é—´å…±äº«å†…å­˜ï¼Œéƒ½å¯ä»¥çœ‹åˆ° mmp/munmap() å‡½æ•°çš„èº«å½±ã€‚mmp/munmap å‡½æ•°çš„å£°æ˜å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span> <span class="params">(<span class="type">void</span> *addr,<span class="type">size_t</span> length,<span class="type">int</span> prot,<span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> fd,<span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr,<span class="type">size_t</span> length)</span>;</span><br></pre></td></tr></tbody></table></figure><p>mmap/munmap å‡½æ•°çš„å‚æ•°å¦‚ä¸‹ã€‚</p><ul><li>addrï¼šç”¨äºæŒ‡å®šæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œä¸ºäº†æé«˜åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼Œä¸€èˆ¬è®¾ç½®ä¸º NULLï¼Œè®©å†…æ ¸æ¥åˆ†é…ä¸€ä¸ªåˆé€‚çš„åœ°å€</li><li>lengthï¼šè¡¨ç¤ºæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„å¤§å°</li><li>protï¼šç”¨äºè®¾ç½®å†…å­˜æ˜ å°„åŒºåŸŸçš„è¯»å†™å±æ€§ç­‰</li><li>flagsï¼šç”¨äºè®¾ç½®å†…å­˜æ˜ å°„çš„å±æ€§ï¼Œå¦‚å…±äº«æ˜ å°„ã€ç§æœ‰æ˜ å°„ç­‰</li><li>fdï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶æ˜ å°„ï¼Œfd æ˜¯æ‰“å¼€çš„æ–‡ä»¶çš„å¥æŸ„</li><li>offsetï¼šåœ¨æ–‡ä»¶æ˜ å°„æ—¶ï¼Œè¡¨ç¤ºæ–‡ä»¶çš„åç§»é‡ã€‚prot å‚æ•°é€šå¸¸è¡¨ç¤ºæ˜ å°„é¡µé¢çš„è¯»å†™æƒé™ï¼Œæœ‰å¦‚ä¸‹å‚æ•°ç»„åˆ</li><li>PROT_EXECï¼šè¡¨ç¤ºæ˜ å°„çš„é¡µé¢æ˜¯å¯ä»¥æ‰§è¡Œçš„</li><li>PROT_READï¼šè¡¨ç¤ºæ˜ å°„çš„é¡µé¢æ˜¯å¯ä»¥è¯»å–çš„</li><li>PROT_WRITEï¼šè¡¨ç¤ºæ˜ å°„çš„é¡µé¢æ˜¯å¯ä»¥å†™å…¥çš„</li><li>PROT_NONEï¼šè¡¨ç¤ºæ˜ å°„çš„é¡µé¢æ˜¯ä¸å¯è®¿é—®çš„</li></ul><p>flags å‚æ•°æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°ï¼Œå¯ä»¥è®¾ç½®ä¸ºä»¥ä¸‹å€¼ã€‚</p><ul><li>MAP_SHAREDï¼šåˆ›å»ºä¸€ä¸ªå…±äº«æ˜ å°„çš„åŒºåŸŸã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡å…±äº«æ˜ å°„æ–¹å¼æ¥æ˜ å°„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å…¶ä»–è¿›ç¨‹ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜ å°„å†…å®¹çš„æ”¹å˜ï¼Œä¿®æ”¹åçš„å†…å®¹ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­</li><li>MAP_PRIVATEï¼šåˆ›å»ºä¸€ä¸ªç§æœ‰çš„å†™æ—¶å¤åˆ¶çš„æ˜ å°„ã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ç§æœ‰æ˜ å°„çš„æ–¹å¼æ¥æ˜ å°„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å…¶ä»–è¿›ç¨‹ä¸ä¼šçœ‹åˆ°æ˜ å°„å†…å®¹çš„æ”¹å˜ï¼Œä¿®æ”¹åçš„å†…å®¹ä¹Ÿä¸ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­</li><li>MAP_ANONYMOUSï¼šåˆ›å»ºä¸€ä¸ªåŒ¿åæ˜ å°„ï¼Œå³æ²¡æœ‰å…³è”åˆ°æ–‡ä»¶çš„æ˜ å°„</li><li>MAP_FIXEDï¼šä½¿ç”¨å‚æ•° addr åˆ›å»ºæ˜ å°„ï¼Œå¦‚æœåœ¨å†…æ ¸ä¸­æ— æ³•æ˜ å°„æŒ‡å®šçš„åœ°å€ï¼Œé‚£ä¹ˆ mmap ä¼šè¿”å›å¤±è´¥ï¼Œå‚æ•° addr è¦æ±‚æŒ‰é¡µå¯¹é½ã€‚å¦‚æœ addr å’Œ length æŒ‡å®šçš„è¿›ç¨‹åœ°å€ç©ºé—´å’Œå·²æœ‰çš„ VMA é‡å ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šè°ƒç”¨ do_munmapO å‡½æ•°æŠŠè¿™æ®µé‡å åŒºåŸŸé”€æ¯ï¼Œç„¶åé‡æ–°æ˜ å°„æ–°çš„å†…å®¹</li><li>MAP_POPULATEï¼šå¯¹äºæ–‡ä»¶æ˜ å°„æ¥è¯´ï¼Œä¼šæå‰é¢„è¯»æ–‡ä»¶å†…å®¹åˆ°æ˜ å°„åŒºåŸŸï¼Œè¯¥ç‰¹æ€§åªæ”¯æŒç§ç”¨æ˜ å°„</li></ul><p>é€šè¿‡å‚æ•° fd å¯ä»¥çœ‹å‡º mmap æ˜ å°„æ˜¯å¦å’Œæ–‡ä»¶ç›¸å…³è”ï¼Œå› æ­¤åœ¨ Linux å†…æ ¸ä¸­ï¼Œæ˜ å°„å¯ä»¥åˆ†æˆåŒ¿åæ˜ å°„å’Œæ–‡ä»¶æ˜ å°„ã€‚</p><ul><li>åŒ¿åæ˜ å°„ï¼šæ²¡æœ‰æ˜ å°„å¯¹åº”çš„ç›¸å…³æ–‡ä»¶ï¼ŒåŒ¿åæ˜ å°„çš„å†…å­˜åŒºåŸŸçš„å†…å®¹ä¼šåˆå§‹åŒ–ä¸º 0</li><li>æ–‡ä»¶æ˜ å°„ï¼šæ˜ å°„å’Œå®é™…æ–‡ä»¶ç›¸å…³è”ï¼Œé€šå¸¸æŠŠæ–‡ä»¶å†…å®¹æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºå°±å¯ä»¥åƒæ“ä½œè¿›ç¨‹åœ°å€ç©ºé—´ä¸€æ ·è¯»å†™æ–‡ä»¶</li></ul><h2 id="ç§æœ‰åŒ¿åæ˜ å°„">ç§æœ‰åŒ¿åæ˜ å°„</h2><p>å½“ä½¿ç”¨å‚æ•° fd=-1 ä¸” flags = MAP_ANONYMOUS|MAP_PRIVATE æ—¶ï¼Œåˆ›å»ºçš„ mmap æ˜ å°„æ˜¯ç§æœ‰åŒ¿åæ˜ å°„ã€‚ç§æœ‰åŒ¿åæ˜ å°„å¸¸è§çš„ç”¨é€”æ˜¯åœ¨ glbc åˆ†é…å¤§å†…å­˜å—æ—¶ï¼Œå¦‚æœéœ€è¦åˆ†é…çš„å†…å­˜å¤§ MMAP_THREASHOLDï¼ˆ128KBï¼‰ï¼Œglibc ä¼šé»˜è®¤ä½¿ç”¨ mmap ä»£æ›¿ brk æ¥åˆ†é…å†…å­˜ã€‚</p><h2 id="å…±äº«åŒ¿åæ˜ å°„">å…±äº«åŒ¿åæ˜ å°„</h2><p>å½“ä½¿ç”¨å‚æ•° fd=-1 ä¸” flags = MAP_ANONYMOUS | MAP_SHARED æ—¶ï¼Œåˆ›å»ºçš„ mmap æ˜ å°„æ˜¯å…±äº«åŒ¿åæ˜ å°„ã€‚å…±äº«åŒ¿åæ˜ å°„è®©ç›¸å…³è¿›ç¨‹å…±äº«ä¸€å—å†…å­˜åŒºåŸŸï¼Œé€šå¸¸ç”¨äºçˆ¶ã€å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡åˆ›å»ºå…±äº«åŒ¿åæ˜ å°„æœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ã€‚</p><ul><li>ä½¿ fd=-1 ä¸” flags = MAP_ANONYMOUS | MAP_SHAREDã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œdo_mmap_pgoffO-&gt;mmap_region() å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ shmem_zero_setup()ï¼šæ¥æ‰“å¼€ä¸€ä¸ªç‰¹æ®Šçš„â€œ/dev/zeroâ€è®¾å¤‡æ–‡ä»¶</li><li>ç›´æ¥æ‰“å¼€â€œ/dev/zeroâ€è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªæ–‡ä»¶å¥æŸ„æ¥åˆ›å»º mmap</li></ul><p>ä¸Šè¿°ä¸¤ç§æ–¹å¼æœ€ç»ˆéƒ½è°ƒç”¨ shmem æ¨¡å—æ¥åˆ›å»ºå…±äº«åŒ¿åæ˜ å°„ã€‚</p><h2 id="ç§æœ‰æ–‡ä»¶æ˜ å°„">ç§æœ‰æ–‡ä»¶æ˜ å°„</h2><p>åˆ›å»ºæ–‡ä»¶å°„æ—¶å¦‚æœ flags è®¾ç½®ä¸º MAPP_PRIVATEï¼Œå°±ä¼šåˆ›å»ºç§æœ‰æ–‡ä»¶æ˜ å°„ã€‚ç§æœ‰æ–‡ä»¶æ˜ å°„å¸¸ç”¨çš„åœºæ™¯æ˜¯åŠ è½½åŠ¨æ€å…±äº«åº“ã€‚</p><h2 id="å…±äº«æ–‡ä»¶æ˜ å°„">å…±äº«æ–‡ä»¶æ˜ å°„</h2><p>åˆ›å»ºæ–‡ä»¶æ˜ å°„æ—¶ï¼Œå¦‚æœ flags è®¾ç½®ä¸º MAP_SHAREDï¼Œå°±ä¼šåˆ›å»ºå…±äº«æ–‡ä»¶æ˜ å°„ã€‚å¦‚æœ prot å‚æ•°æŒ‡å®šäº† PROT_WRITEï¼Œé‚£ä¹ˆæ‰“å¼€æ–‡ä»¶æ—¶éœ€è¦æŒ‡å®š O_RDWR æ ‡å¿—ä½ã€‚å…±äº«æ–‡ä»¶æ˜ å°„é€šå¸¸æœ‰ mmap å¦‚ä¸‹ä¸¤ä¸ªå¸¸ç”¨çš„åœºæ™¯ã€‚</p><ul><li>è¯»å†™æ–‡ä»¶ã€‚æŠŠæ–‡ä»¶å†…å®¹æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼ŒåŒæ—¶å¯¹æ˜ å°„çš„å†…å®¹åšäº†ä¿®æ”¹ï¼Œå†…æ ¸çš„å›å†™ï¼ˆwritebackï¼‰æœºåˆ¶æœ€ç»ˆä¼šæŠŠä¿®æ”¹çš„å†…å®¹åŒæ­¥åˆ°ç£ç›˜ä¸­</li><li>è¿›ç¨‹é—´é€šä¿¡ã€‚è¿›ç¨‹ä¹‹é—´çš„è¿›ç¨‹åœ°å€ç©ºé—´ç›¸äº’éš”ç¦»ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸èƒ½è®¿é—®å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚å¦‚æœå¤šä¸ªè¿›ç¨‹åŒæ—¶æ˜ å°„åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±å®ç°äº†å¤šè¿›ç¨‹é—´çš„å…±äº«å†…å­˜é€šä¿¡ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹å¯¹æ˜ å°„å†…å®¹åšäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–çš„è¿›ç¨‹æ˜¯å¯ä»¥çœ‹åˆ°çš„</li></ul><h2 id="å°ç»“">å°ç»“</h2><p>mmap æœºåˆ¶åœ¨ Linux å†…æ ¸ä¸­å®ç°çš„ä»£ç æ¡†æ¶å’Œ brk æœºåˆ¶éå¸¸ç±»ä¼¼ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šå…³äº VMA çš„æ“ä½œã€‚mmap æœºåˆ¶å’Œç¼ºé¡µä¸­æ–­æœºåˆ¶ç»“åˆåœ¨ä¸€èµ·ä¼šå˜å¾—å¤æ‚å¾ˆå¤šã€‚mmap æœºåˆ¶åœ¨ Linux å†…æ ¸ä¸­çš„å®ç°æµç¨‹å¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mmap.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9sZXRydW5ndGhhbmcuYmxvZ3Nwb3QuY29tLzIwMTAvMTIvY2h1eWVuLXRpZXQta2llbS1tdWEtbmhhLWN1YS1naW9pLmh0bWw=">https://letrungthang.blogspot.com/2010/12/chuyen-tiet-kiem-mua-nha-cua-gioi.html<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆå…­ï¼‰ä¼™ä¼´ç³»ç»Ÿå’Œ slab åˆ†é…å™¨</title>
      <link href="/2021/LinuxKernel/LinuxMemoryslab/"/>
      <url>/2021/LinuxKernel/LinuxMemoryslab/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Memoryslab.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM3NDI1M2YzNDZmYjA3MjVmODQ0Yjg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><blockquote><p>å£°æ˜æœ¬æ–‡è½¬è½½è‡ªçŸ¥ä¹ <span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9sYW4teGluLXl1">å…°æ–°å®‡<i class="fa fa-external-link-alt"></i></span> å†…å­˜ç›¸å…³æ–‡ç« </p></blockquote><h1 id="å†…å­˜æ± ">å†…å­˜æ± </h1><h2 id="ç©ºé—²é“¾è¡¨free-list">ç©ºé—²é“¾è¡¨ï¼ˆfree listï¼‰</h2><p>å°†å†…å­˜ä¸­æ‰€æœ‰çš„ç©ºé—²å†…å­˜å—é€šè¿‡é“¾è¡¨çš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼Œå°±å½¢æˆäº†æœ€åŸºç¡€çš„ free listã€‚å†…å­˜åˆ†é…æ—¶ï¼Œæ‰«æ free list çš„å„ä¸ªç©ºé—²å†…å­˜å—ï¼Œä»ä¸­æ‰¾åˆ°ä¸€ä¸ªå¤§å°æ»¡è¶³è¦æ±‚çš„å†…å­˜å—ï¼Œå¹¶å°†è¯¥å†…å­˜å—ä» free list ä¸­ç§»é™¤ã€‚å†…å­˜é‡Šæ”¾æ—¶ï¼Œé‡Šæ”¾çš„å†…å­˜å—è¢«é‡æ–°æ’å…¥åˆ° free list ä¸­ã€‚</p><p>å‡è®¾ç°åœ¨å†…å­˜çš„ä½¿ç”¨æƒ…å†µæ˜¯è¿™æ ·çš„ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list1.jpg"></p><p>ç°è‰²éƒ¨åˆ†ä»£è¡¨å·²ç»è¢«åˆ†é…çš„å†…å­˜å—ï¼Œç™½è‰²éƒ¨åˆ†ä»£è¡¨ç©ºé—²çš„å†…å­˜å—ï¼Œå¤§å°åˆ†åˆ«æ˜¯ 48 å­—èŠ‚ï¼Œ16 å­—èŠ‚å’Œ 96 å­—èŠ‚ã€‚å¦‚æœæ­¤æ—¶å†…å­˜åˆ†é…çš„ç”³è¯·æ˜¯ 12 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°†æœ‰ä»¥ä¸‹ä¸‰ç§ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼š</p><ul><li><p>First fitï¼ˆæœ€å…ˆé€‚é…ï¼‰ï¼Œå°±æ˜¯ä» free list å¤´éƒ¨å¼€å§‹æ‰«æï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³å¤§å°çš„ç©ºé—²å†…å­˜å—ï¼Œè¿™é‡Œç¬¬ä¸€ä¸ª 48 å­—èŠ‚çš„å†…å­˜å—å°±å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ç›¸å¯¹å¿«ä¸€äº›ï¼Œå°¤å…¶æ˜¯æ»¡è¶³è¦æ±‚çš„ç©ºé—²å†…å­˜å—ä½äºé“¾è¡¨å‰éƒ¨çš„æ—¶å€™ï¼Œä½†æ˜¯åœ¨æ§åˆ¶ç¢ç‰‡æ•°é‡ä¸Šä¸æ˜¯æœ€ä¼˜çš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list2.jpg"></p></li><li><p>Best fitï¼ˆæœ€ä½³é€‚é…ï¼‰ï¼Œå°±æ˜¯éå† free list çš„æ‰€æœ‰ç©ºé—²å†…å­˜å—ï¼Œä»ä¸­æ‰¾åˆ°å’Œæ‰€ç”³è¯·çš„å†…å­˜å¤§å°æœ€æ¥è¿‘çš„ç©ºé—²å†…å­˜å—ï¼Œè¿™é‡Œç¬¬äºŒä¸ª 16 å­—èŠ‚çš„å†…å­˜å—æ˜¯æœ€æ¥è¿‘ 12 å­—èŠ‚çš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list3.jpg"></p></li><li><p>Worst fitï¼ˆæœ€å·®é€‚é…ï¼‰ï¼Œä¹Ÿæ˜¯éå† free list çš„æ‰€æœ‰ç©ºé—²å†…å­˜å—ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¤§å°åˆšå¥½åŒ¹é…çš„ï¼Œå°±ä»æœ€å¤§çš„ç©ºé—²å†…å­˜å—ä¸­åˆ†é…ã€‚åˆçœ‹èµ·æ¥å¾ˆåç›´è§‰æ˜¯ä¸æ˜¯ï¼Ÿä½†å‡è®¾æ¥ä¸‹æ¥çš„å†…å­˜ç”³è¯·æ˜¯ 64 ä¸ªå­—èŠ‚ï¼Œé‚£åªæœ‰ worst fit çš„è¿™ç§æ–¹æ³•æ‰èƒ½æ»¡è¶³éœ€æ±‚ï¼Œæ‰€ä»¥å…¶ä»·å€¼ä½“ç°åœ¨ï¼šåˆ†é…ä¹‹åå‰©ä¸‹çš„ç©ºé—²å†…å­˜å—å¾ˆå¯èƒ½ä»ç„¶è¶³å¤Ÿå¤§ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list4.jpg"></p></li></ul><p>ä»¥ä¸Šè®¨è®ºçš„æ˜¯å†…å­˜åˆ†é…çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å†…å­˜é‡Šæ”¾çš„æ“ä½œæ˜¯æ€æ ·çš„ã€‚å‡è®¾ä»ç¬¬ 80 å­—èŠ‚åˆ°ç¬¬ 100 å­—èŠ‚ä¸­é—´çš„ 20 å­—èŠ‚å†…å­˜è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆå®ƒå°†å’Œå‰é¢ç›¸é‚»çš„ç©ºé—²å†…å­˜å—åˆå¹¶ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list5.jpg"></p><p>æ¥ä¸‹æ¥ä»ç¬¬ 100 å­—èŠ‚åˆ°ç¬¬ 112 å­—èŠ‚ä¸­é—´çš„ 12 å­—èŠ‚å†…å­˜ä¹Ÿè¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆå®ƒå°†åŒæ—¶å’Œå‰åç›¸é‚»çš„ç©ºé—²å†…å­˜å—åˆå¹¶ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list6.jpg"></p><p>ä¸è¿‡ï¼Œæ—¢ç„¶ç”¨åˆ°äº†é“¾è¡¨ï¼Œé‚£å°±éœ€è¦æŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆæœ¬èº«ä¹Ÿæ˜¯è¦å ç”¨å†…å­˜ç©ºé—´çš„ã€‚è€Œä¸”åœ¨å†…å­˜é‡Šæ”¾æ—¶ï¼Œè¦åˆ¤æ–­è¢«é‡Šæ”¾çš„å†…å­˜å—å‰åçš„å†…å­˜å—æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œè¿™å°±éœ€è¦æ¯ä¸ªå†…å­˜å—æœ‰ä¸€ä¸ªç©ºé—²çŠ¶æ€çš„æ ‡å¿—ä½ã€‚å¯ä»¥é‡‡ç”¨çš„ä¸€ç§æ–¹å¼æ˜¯ bitmapï¼Œå‡è®¾ä»¥ 4 ä¸ªå­—èŠ‚ä¸ºæœ€å°åˆ†é…å•ä½ï¼Œé‚£ä¹ˆæ¯ 4 å­—èŠ‚éœ€è¦ä¸€ä¸ª bitï¼Œå› æ­¤é¢å¤–æ¶ˆè€—çš„å†…å­˜ä¸º 1/32ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_list7.jpg"></p><h2 id="å†…å­˜æ± memory-pool">å†…å­˜æ± ï¼ˆmemory poolï¼‰</h2><p>ç©ºé—²é“¾è¡¨çš„åˆ†é…æ–¹å¼ç®€å•ï¼Œä½†åˆ†é…æ•ˆç‡ä¸é«˜ï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åå®¹æ˜“äº§ç”Ÿå¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼Œä»è€Œæ¶åŒ–äº†å†…å­˜åˆ©ç”¨ç‡ã€‚</p><p>å¦‚æœèƒ½å°†ä¸€å¤§å—å†…å­˜åˆ†æˆå¤šä¸ªå°å†…å­˜ï¼ˆç§°ä¸ºå†…å­˜æ± ï¼‰ï¼Œä¸åŒçš„å†…å­˜æ± åˆæŒ‰ç…§ä¸åŒçš„ã€Œå°ºå¯¸ã€åˆ†æˆå¤§å°ç›¸åŒçš„å†…å­˜å—ï¼ˆæ¯”å¦‚åˆ†åˆ«æŒ‰ç…§ 32, 64, 128â€¦â€¦å­—èŠ‚ï¼‰ï¼ŒåŒä¸€å†…å­˜æ± ä¸­çš„ç©ºé—²å†…å­˜å—æŒ‰ç…§ free list çš„æ–¹å¼è¿æ¥ã€‚</p><p>æ¯æ¬¡åˆ†é…çš„æ—¶å€™ï¼Œé€‰æ‹©å’Œç”³è¯·çš„çš„å†…å­˜åœ¨ã€Œå°ºå¯¸ã€ä¸Šæœ€æ¥è¿‘çš„å†…å­˜æ± ï¼Œæ¯”å¦‚ç”³è¯· 60 å­—èŠ‚çš„å†…å­˜ï¼Œå°±ç›´æ¥ä»å•ä¸ªå†…å­˜å—å¤§å°ä¸º 64 å­—èŠ‚çš„å†…å­˜æ± çš„ free list ä¸Šåˆ†é…ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_pool1.jpg"></p><p>è¿™æ ·å‡å°‘äº† free list é“¾è¡¨çš„é•¿åº¦ï¼Œèƒ½å¤Ÿç¼©çŸ­æ¯æ¬¡å†…å­˜åˆ†é…æ‰€éœ€çš„çº¿æ€§æœç´¢çš„æ—¶é—´ï¼Œç‰¹åˆ«é€‚åˆå¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚ RTOSï¼‰ã€‚ä½†è¦æƒ³å–å¾—å¥½çš„æ•ˆæœï¼Œéœ€è¦ç»“åˆç³»ç»Ÿå®é™…çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œå¯¹å†…å­˜æ± çš„å¤§å°è¿›è¡Œåˆç†çš„åˆ’åˆ†ã€‚æ¯”å¦‚ä¸€ä¸ªç³»ç»Ÿå¸¸ç”¨çš„æ˜¯ 256 å­—èŠ‚ä»¥ä¸‹çš„å†…å­˜ç”³è¯·ï¼Œé‚£è®¾ç½®è¿‡å¤šçš„ 256 å­—èŠ‚ä»¥ä¸Šçš„å†…å­˜æ± ï¼Œå°±ä¼šé€ æˆå†…å­˜èµ„æºçš„é—²ç½®å’Œæµªè´¹ã€‚</p><p>ä¼¼ä¹ä¸æ˜¯å¾ˆå¥½æŠŠæ§åˆ°åº•æ€æ ·åˆ’åˆ†å†…å­˜æ± æœ€ä¸ºåˆé€‚ï¼Ÿä¸‹æ–‡å°†è¦ä»‹ç»çš„ Linux ä¸­çš„ buddy åˆ†é…ç³»ç»Ÿï¼Œå°†åŸºäºæ™®é€šçš„å†…å­˜æ± è¿›è¡Œä¼˜åŒ–ï¼Œä»¥æ›´è´´åˆå¤§å‹æ“ä½œç³»ç»Ÿå¯¹å†…å­˜ç®¡ç†çš„éœ€æ±‚ã€‚</p><h1 id="buddy-åˆ†é…ç®—æ³•">Buddy åˆ†é…ç®—æ³•</h1><p>ä¸Šæ–‡ä»‹ç»äº†å†…å­˜æ± ï¼Œå®ƒçš„åˆ†é…å¿«é€Ÿï¼Œä½†è¿™ç§â€œäº‹å…ˆå°±åˆ’åˆ†å¥½â€çš„æ–¹æ³•å¯¹ç³»ç»Ÿçš„é€‚åº”æ€§è¾ƒå·®ï¼Œä¸åŒã€Œå°ºå¯¸ã€çš„å†…å­˜æ± ä¹‹é—´ä¸èƒ½â€œäº’é€šæœ‰æ— â€ã€‚è€Œ buddy åˆ†é…ç³»ç»Ÿåœ¨æ™®é€šå†…å­˜æ± çš„åŸºç¡€ä¸Šï¼Œå…è®¸ä¸¤ä¸ªå¤§å°ç›¸åŒä¸”ç›¸é‚»çš„å†…å­˜å—åˆå¹¶ï¼Œåˆå¹¶ä¹‹åçš„å†…å­˜å—çš„ã€Œå°ºå¯¸ã€å¢å¤§ï¼Œå› è€Œå°†è¢«ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå†…å­˜æ± çš„ free list ä¸Šã€‚</p><p>æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå†…å­˜å…±æœ‰ 1024 å­—èŠ‚ï¼Œç”± 32, 64, 128, 256, 512 å­—èŠ‚ä¸ºã€Œå°ºå¯¸ã€çš„ 5 ä¸ª free list ç»„ç»‡èµ·æ¥ï¼Œæœ€å°åˆ†é…å•ä½ä¸º 32 å­—èŠ‚ï¼ˆå¯¹åº”ä½å›¾ä¸­çš„ 1 ä¸ª bitï¼‰ã€‚å‡è®¾ç°åœ¨ 0 åˆ° 448 å­—èŠ‚çš„å†…å­˜å·²ä½¿ç”¨ï¼Œ448 åˆ° 1024 å­—èŠ‚çš„å†…å­˜ä¸ºç©ºé—²ï¼ˆå­—æ¯ç¼–å·ä» A å¼€å§‹ï¼Œè¡¨ç¤ºåˆ†é…é¡ºåºï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/buddy1.jpg"></p><p>ç°åœ¨æˆ‘ä»¬è¦ç”³è¯· 128 å­—èŠ‚çš„å†…å­˜ï¼Œé‚£ä¹ˆé¦–å…ˆåº”è¯¥æŸ¥çœ‹ã€Œå°ºå¯¸ã€ä¸º 128 å­—èŠ‚çš„ free listï¼Œä½†å¾ˆå¯æƒœæ²¡æœ‰ï¼Œé‚£å†çœ‹çœ‹ 256 å­—èŠ‚çš„ free listï¼Œè¿˜æ˜¯æ²¡æœ‰ï¼Œåªèƒ½å†å¾€ä¸Šæ‰¾ï¼Œåˆ° 512 å­—èŠ‚çš„ free list è¿™å„¿ï¼Œç»ˆäºæœ‰äº†ä¸€ä¸ªç©ºé—²çš„å†…å­˜å— A'ã€‚</p><p>é‚£ä¹ˆå°† A'åˆ’åˆ†ä¸º 256 å­—èŠ‚çš„ E å’Œ E'ï¼Œå†å°†å†…å­˜å— E åˆ’åˆ†æˆ 128 å­—èŠ‚çš„ F å’Œ F'ï¼Œå†…å­˜å— F å³æ˜¯æˆ‘ä»¬éœ€è¦çš„å†…å­˜ã€‚ä¹‹åï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ E'å’Œ F'å°†åˆ†åˆ«è¢«æŒ‚æ¥åˆ°ã€Œå°ºå¯¸ã€ä¸º 256 å­—èŠ‚å’Œ 128 å­—èŠ‚çš„ free list ä¸Šï¼Œä½å›¾ä¸­ bits çš„å€¼ä¹Ÿä¼šç›¸åº”å˜åŒ–ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/buddy2.jpg"></p><p>æ¥ä¸‹æ¥é‡Šæ”¾ 128 å­—èŠ‚çš„å†…å­˜å— Cï¼Œç”±äº C ç›¸é‚»çš„ä¸¤ä¸ªå†…å­˜å—éƒ½ä¸æ˜¯ç©ºé—²çŠ¶æ€ï¼Œå› æ­¤ä¸èƒ½åˆå¹¶ï¼Œä¹‹å C ä¹Ÿå°†è¢«æŒ‚æ¥åˆ°ã€Œå°ºå¯¸ã€ä¸º 128 å­—èŠ‚çš„ free list ä¸Šã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/buddy3.jpg"></p><p>ç„¶åé‡Šæ”¾ 64 å­—èŠ‚çš„å†…å­˜å— Dï¼Œåˆ†é…å™¨æ ¹æ®ä½å›¾å¯çŸ¥ï¼Œå³ä¾§çš„ D'ä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œä¸” D å’Œ D'çš„å¤§å°ç›¸åŒï¼Œå› æ­¤ D å’Œ D'å°†åˆå¹¶ã€‚æŒ‰ç†åˆå¹¶åçš„ç©ºé—²å†…å­˜å— C'ä¸º 128 å­—èŠ‚ï¼Œåº”è¯¥è¢«æ·»åŠ åˆ°ã€Œå°ºå¯¸ã€ä¸º 128 å­—èŠ‚çš„ free list ä¸Šï¼Œä½†å› ä¸ºå·¦ä¾§çš„ C ä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œä¸” C å’Œ C'çš„å¤§å°ç›¸åŒï¼Œå› æ­¤ C å’Œ C'è¿˜å°†åˆå¹¶å½¢æˆ B'ï¼Œåˆå¹¶åçš„ç©ºé—²å†…å­˜å—å°†è¢«æŒ‚æ¥åˆ°ã€Œå°ºå¯¸ã€ä¸º 256 å­—èŠ‚çš„ free list ä¸Šã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/buddy4.jpg"></p><p>åœ¨ buddy åˆ†é…ç³»ç»Ÿä¸­ï¼Œä»ç‰©ç†ä¸Šï¼Œå†…å­˜å—æŒ‰åœ°å€ä»å°åˆ°å¤§æ’åˆ—ï¼›ä»é€»è¾‘ä¸Šï¼Œå†…å­˜å—é€šè¿‡ free list ç»„ç»‡ã€‚é€šè¿‡å¯¹ç›¸é‚»å†…å­˜å—çš„åˆå¹¶ï¼Œå¢åŠ äº†å†…å­˜ä½¿ç”¨çš„çµæ´»æ€§ï¼Œå‡å°‘äº†å†…å­˜ç¢ç‰‡ã€‚</p><p>ä½†æ˜¯å®ç°åˆå¹¶æœ‰ä¸€ä¸ªå‰æï¼Œå°±æ˜¯å†…å­˜å—çš„å°ºå¯¸å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼ˆç§°ä¸º"order"ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ buddy ç³»ç»Ÿåˆ’åˆ†å†…å­˜å—çš„ä¾æ®ã€‚æ­¤å¤–ï¼Œæ¯æ¬¡å†…å­˜é‡Šæ”¾éƒ½è¦æŸ¥æ‰¾å·¦å³çš„ buddy æ˜¯å¦å¯ä»¥åˆå¹¶ï¼Œè¿˜å¯èƒ½éœ€è¦åœ¨ free list ä¹‹é—´ç§»åŠ¨ï¼Œä¹Ÿæ˜¯ä¸€ç¬”ä¸å°çš„å¼€é”€ã€‚</p><h1 id="slab">Slab</h1><p>Linux ä¸­çš„ buddy åˆ†é…å™¨æ˜¯ä»¥ page frame ä¸ºæœ€å°ç²’åº¦çš„ï¼Œè€Œç°å®çš„åº”ç”¨å¤šæ˜¯ä»¥å†…æ ¸ objectsï¼ˆæ¯”å¦‚æè¿°æ–‡ä»¶çš„"struct inode"ï¼‰çš„å¤§å°æ¥ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„ï¼Œè¿™äº›å†…æ ¸ objects çš„å¤§å°é€šå¸¸ä»å‡ åå­—èŠ‚åˆ°å‡ ç™¾å­—èŠ‚ä¸ç­‰ï¼Œè¿œè¿œå°äºä¸€ä¸ª page çš„å¤§å°ã€‚</p><p>é‚£å¯ä¸å¯ä»¥æŠŠä¸€ä¸ª page frame å†æŒ‰ç…§ buddy çš„åŸç†ï¼Œä»¥æ›´å°çš„å°ºå¯¸ï¼ˆæ¯”å¦‚ 128 å­—èŠ‚ï¼Œ256 å­—èŠ‚ï¼‰ç»„ç»‡èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªäºŒçº§åˆ†é…ç³»ç»Ÿå‘¢ï¼Ÿè¿™å°±æ˜¯ slab åˆ†é…å™¨ã€‚</p><h2 id="cache-å’Œ-slab">cache å’Œ slab</h2><p>åœ¨ slab åˆ†é…å™¨ä¸­ï¼Œæ¯ä¸€ç±» objects æ‹¥æœ‰ä¸€ä¸ª"cache"ï¼ˆæ¯”å¦‚ inode_cache, dentry_cacheï¼‰ã€‚ä¹‹æ‰€ä»¥å«åš"cache"ï¼Œæ˜¯å› ä¸ºæ¯åˆ†é…ä¸€ä¸ª objectï¼Œéƒ½ä»åŒ…å«è‹¥å¹²ç©ºé—²çš„åŒç±» objects çš„åŒºåŸŸè·å–ï¼Œé‡Šæ”¾æ—¶ä¹Ÿç›´æ¥å›åˆ°è¿™ä¸ªåŒºåŸŸï¼Œè¿™æ ·å¯ä»¥ç¼“å­˜å’Œå¤ç”¨ç›¸åŒçš„ objectsï¼ŒåŠ å¿«åˆ†é…å’Œé‡Šæ”¾çš„é€Ÿåº¦ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab1.jpg"></p><p>object ä»"cache"è·å–å†…å­˜ï¼Œé‚£"cache"çš„å†…å­˜åˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿè¿˜æ˜¯å¾—ä» buddy åˆ†é…å™¨æ¥ã€‚slab å±‚ç›´æ¥é¢å‘ç¨‹åºçš„åˆ†é…éœ€æ±‚ï¼Œç›¸å½“äºæ˜¯å‰ç«¯ï¼Œè€Œ buddy ç³»ç»Ÿåˆ™æˆä¸º slab åˆ†é…å™¨çš„åç«¯ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab2.jpg"></p><p>ç”±äº"cache"çš„å†…å­˜æ˜¯ä» buddy ç³»ç»Ÿè·å¾—çš„ï¼Œå› æ­¤åœ¨ç‰©ç†ä¸Šæ˜¯è¿ç»­çš„ã€‚å¦‚æœä¸€ä¸ª"cache"ä¸­ objects çš„æ•°ç›®è¾ƒå¤šï¼Œé‚£ä¹ˆ"cache"çš„ä½“ç§¯è¾ƒå¤§ï¼Œéœ€è¦å ç”¨çš„è¿ç»­ç‰©ç†å†…å­˜è¾ƒå¤šã€‚å½“ object çš„æ•°é‡å¢åŠ æˆ–å‡å°‘æ—¶ï¼Œä¹Ÿä¸åˆ©äºåŠ¨æ€è°ƒæ•´ã€‚å› æ­¤ï¼Œä¸€ä¸ª"cache"åˆ†æˆäº†è‹¥å¹²ä¸ª slabsã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab3.jpg"></p><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>ä¸€ä¸ª"cache"åœ¨ Linux ä¸­ç”±"struct kmem_cache"ç»“æ„ä½“æè¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> {</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> gfporder;    <span class="comment">/* order of pages per slab (2^n) */</span></span><br><span class="line">    <span class="type">gfp_t</span> allocflags;         <span class="comment">/* force GFP flags */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> num;         <span class="comment">/* objects per slab */</span></span><br><span class="line">    <span class="type">int</span> object_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> colour_off;  <span class="comment">/* colour offset */</span></span><br><span class="line">    <span class="type">size_t</span> colour;            <span class="comment">/* cache colouring range */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>    <span class="comment">/* cache creation &amp; removal */</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸€ä¸ª slab ç”±ä¸€ä¸ªæˆ–å¤šä¸ª page frame ç»„æˆï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªï¼‰ï¼Œæ ¹æ® buddy ç³»ç»Ÿçš„é™åˆ¶ï¼Œåœ¨æ•°é‡ä¸Šå¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼Œ"gfporder"å®é™…å°±å®šä¹‰äº†ä¸€ä¸ª"cache"ä¸­æ¯ä¸ª slab çš„å¤§å°ã€‚</p><p>æ—¢ç„¶æ¶‰åŠåˆ° page frame çš„åˆ†é…ï¼Œé‚£è‡ªç„¶ç¦»ä¸å¼€ GFP flagsï¼Œæ¯”å¦‚è¦æ±‚ä» DMA ä¸­åˆ†é…ï¼Œå°±éœ€è¦æŒ‡å®š"GFP_DMA"ã€‚</p><pre><code>   sï¼Œæ•°é‡ç”±"num"è¡¨ç¤ºï¼Œæ¯ä¸ª object çš„å¤§å°ç”±"object_size"ç»™å‡ºã€‚ä¸€ä¸ª object å¯èƒ½è·¨è¶Š 2 ä¸ª page framesã€‚</code></pre><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab4.jpg"></p><p>å¦‚æœ object çš„å†…å­˜åœ°å€èƒ½æŒ‰ä¸€å®šå­—èŠ‚æ•°ï¼ˆæ¯”å¦‚æ€»çº¿å®½åº¦ï¼‰æˆ–è€…æŒ‰ç¡¬ä»¶ cache line çš„å¤§å°å¯¹é½ï¼Œå°†å¯ä»¥æé«˜è¯»å†™æ€§èƒ½ã€‚æ­¤å¤–ï¼Œä¸åŒ slabs ä¸­å…·æœ‰ç›¸åŒåç§»çš„ objectsï¼Œå¤§æ¦‚ç‡ä¼šè½åœ¨åŒä¸€ cache line ä¸Šï¼Œé€ æˆ cache line çš„äº‰ç”¨ï¼Œæ‰€ä»¥æœ€å¥½åŠ ä¸Šä¸åŒçš„å¡«å……ï¼Œä»¥é”™å¼€å¯¹ cache line çš„ä½¿ç”¨ã€‚è¿™äº›åç§»å’Œå¡«å……ï¼Œå…±åŒæ„æˆäº† slab çš„ coloring æœºåˆ¶ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab5.jpg"></p><p>å¯è§å•Šï¼Œslab cache é™¤äº†å’Œç¡¬ä»¶ cache ä¸€æ ·éƒ½ä½¿ç”¨äº†â€œç¼“å­˜â€çš„æ€æƒ³ï¼Œå®ƒè¿˜åœ¨å®ç°ä¸­å……åˆ†åˆ©ç”¨äº†ç¡¬ä»¶ cache æä¾›çš„ç‰¹æ€§ï¼Œä»¥è¿›ä¸€æ­¥æé«˜è¿è¡Œæ•ˆç‡ã€‚ä½†ä»˜å‡ºçš„ä»£ä»·å°±æ˜¯ï¼Œä¸ç®¡å¯¹é½è¿˜æ˜¯å¡«å……ï¼Œéƒ½éœ€è¦é¢å¤–çš„å­—èŠ‚ï¼Œè¿™å¯¹å†…å­˜èµ„æºä¹Ÿä¼šé€ æˆä¸€å®šçš„æ¶ˆè€—ã€‚</p><h2 id="ç»Ÿè®¡ä¿¡æ¯">ç»Ÿè®¡ä¿¡æ¯</h2><p>å¯é€šè¿‡"slabtop"å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„ slab åˆ†é…æƒ…å†µï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab6.jpg"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç³»ç»Ÿä¸­ slab åˆ†é…å™¨ä¸€å…±å æ®äº† 46059.92KB å†…å­˜ï¼ŒåŒ…æ‹¬ 115 ä¸ª"caches"ï¼Œ12126 ä¸ª"slabs"ï¼ˆå¹³å‡æ¯ä¸ª cache æ‹¥æœ‰ 105 ä¸ª slabsï¼‰ï¼Œ170077 ä¸ª"objects"ï¼ˆå¹³å‡æ¯ä¸ª slabs æ‹¥æœ‰ 14 ä¸ª objectsï¼‰ã€‚åœ¨æ‰€æœ‰çš„ objects ä¸­ï¼Œæœ€å°çš„ä¸º 0.02KBï¼Œæœ€å¤§çš„ä¸º 4096KBï¼Œå¹³å‡å€¼æ˜¯ 0.27KBã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ç»†åˆ†çš„æ¯ç±» objects çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä»"inode cache"å¯ä»¥å¾—çŸ¥æ‰“å¼€äº† 9150 ä¸ªæ–‡ä»¶ï¼Œä»"vm_area_struct"å¯ä»¥å¾—çŸ¥æ‰€æœ‰è¿›ç¨‹ä¸€å…±ä½¿ç”¨äº† 2140 ä¸ª VMAã€‚å¹¶ä¸”ï¼Œè¿˜èƒ½å¤§è‡´çŸ¥é“æ¯ç±» object çš„æ§åˆ¶ç»“æ„çš„å¤§å°ï¼Œæ¯”å¦‚ä¸€ä¸ª"struct dentry"å¤§çº¦å æ® 0.19KB çš„å†…å­˜ç©ºé—´ã€‚</p><p>è™½ç„¶æ²¡æœ‰ per-slab åŒ…å«çš„ pages æ•°ç›®ä¿¡æ¯ï¼Œä¸è¿‡å®Œå…¨å¯ä»¥é€šè¿‡"OBJ/SLAB"ä¹˜ä»¥"SIZE"è®¡ç®—å‡ºæ¥ã€‚æ¯”å¦‚é€šè¿‡è¿™ç§æ–¹æ³•ç®—å‡ºæ¥"dentry"çš„å°±æ˜¯å¤§çº¦ 4KBï¼Œè¯´æ˜æ¯ä¸ª"dentry"çš„ slab åŒ…å«ä¸€ä¸ª page frameã€‚</p><p>å…¶æ›´é‡è¦çš„æ„ä¹‰æ˜¯ä½“ç°åœ¨è°ƒè¯•çš„æ—¶å€™ï¼šå½“ä½ å‘ç°å½“å‰å†…å­˜èµ„æºæ¯”è¾ƒç´§å¼ ï¼Œé€šè¿‡"/proc/meminfo"æŸ¥åˆ°æ˜¯"Slab"å æ®äº†è¾ƒå¤§å†…å­˜ï¼Œæ ¹æ®"slabtop"å°±å¯ä»¥å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸€ç±» object æ¶ˆè€—çš„æœ€å¤šï¼ˆæ¯”å¦‚å»ºç«‹äº†è¿‡å¤šçš„ socketï¼‰ã€‚</p><p>"slabtop"å…¶å®å’Œå¯ä»¥æ˜¾ç¤º CPU å’Œå†…å­˜å ç”¨ç‡çš„"top"å‘½ä»¤æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯åŠ¨æ€åœ°æ˜¾ç¤ºç›®å‰èµ„æºå ç”¨ç‡æœ€é«˜çš„ï¼Œåªä¸è¿‡"top"é’ˆå¯¹çš„æ˜¯è¿›ç¨‹ï¼Œè€Œ"slabtop"é’ˆå¯¹çš„æ˜¯"caches"ã€‚å¦‚æœè¦è·å–å…¨éƒ¨"caches"çš„ä¿¡æ¯ï¼Œåº”æŸ¥çœ‹"/proc/slabinfo"æ–‡ä»¶ã€‚</p><h2 id="åˆ›å»ºå’Œåˆå§‹åŒ–">åˆ›å»ºå’Œåˆå§‹åŒ–</h2><p>åˆ›å»ºä¸€ä¸ªæ–°çš„"cache"çš„å‡½æ•°æ¥å£æ˜¯ kmem_cache_create()ï¼Œä¸»è¦å°±æ˜¯ä¸º"kmem_cache"çš„æ§åˆ¶ç»“æ„åˆ†é…å†…å­˜ç©ºé—´å¹¶åˆå§‹åŒ–ã€‚è€Œè¿™ä¸ªæ§åˆ¶ç»“æ„æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå†…æ ¸ objectï¼ŒæŒ‰ç†ä¹Ÿåº”è¯¥ä» slab cache ä¸­è·å–ï¼Œé‚£ç¬¬ä¸€ä¸ª"kmem_cache"ä»å“ªé‡Œæ¥ï¼Ÿè¿™å°±å½¢æˆäº†ä¸€ä¸ªâ€œå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹â€çš„é—®é¢˜ï¼Œè§£å†³çš„åŠæ³•æ˜¯åœ¨ slab å­ç³»ç»Ÿç”Ÿæ•ˆä¹‹å‰çš„å¯åŠ¨é˜¶æ®µï¼Œç”¨ä¸€æ®µç‰¹æ®Šçš„ boot cache æ¥åˆ†é…ã€‚</p><p>"cache"åˆ›å»ºåï¼Œä¸€å¼€å§‹ä¸å«æœ‰ä»»ä½•çš„ slabï¼Œä¹Ÿå°±æ²¡æœ‰ä»»ä½•ç©ºé—²çš„ objectsï¼Œåªæœ‰å½“äº§ç”Ÿåˆ†é…ä¸€ä¸ªæ–°çš„ object çš„éœ€æ±‚æ—¶ï¼Œæ‰å¼€å§‹åˆ›å»º slabã€‚åˆ›å»ºä¸€ä¸ª slab é™¤äº†éœ€è¦åˆ†é…å®¹çº³ objects çš„å†…å­˜ï¼ˆç›¸å½“äº user dataï¼‰ï¼Œè¿˜éœ€è¦ç”Ÿæˆç®¡ç†è¿™ä¸ª slab çš„æ§åˆ¶ä¿¡æ¯ï¼ˆç›¸å½“äº meta dataï¼Œè¿™é‡Œç§°ä¸º slab descriptorï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab7.jpg"></p><p>ä¸€ä¸ª slab åŒºåŸŸåŒ…æ‹¬è‹¥å¹²ä¸ªå¤§å°ç›¸åŒçš„ objectsï¼Œä»¥åŠå®ƒä»¬çš„ coloring æ¶ˆè€—çš„å­—èŠ‚ã€‚ä¸€ä¸ª"cache"çš„å¤šä¸ª slabs é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥ï¼Œå› è€Œéœ€è¦å­˜å‚¨é“¾è¡¨æŒ‡é’ˆçš„ç©ºé—´ã€‚</p><p>æ ¹æ® object çš„å¤§å°ä¸åŒï¼Œslab descriptor æœ¬èº«å æ®çš„å†…å­˜å¯ä»¥ä½äºå…¶ç®¡ç†çš„ slab å†…å­˜åŒºåŸŸå†…éƒ¨ï¼Œä¹Ÿå¯ä»¥ä½äºå¤–éƒ¨ï¼ˆoff-slabï¼‰ ã€‚å½“ä½äºå†…éƒ¨æ—¶ï¼Œé“¾è¡¨æŒ‡é’ˆå­˜å‚¨åœ¨ä¸€ä¸ª slab åŒºåŸŸçš„æœ«å°¾ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (OFF_SLAB(cachep)) {</span><br><span class="line">    <span class="comment">/* Slab management obj is off-slab */</span></span><br><span class="line">    freelist = kmem_cache_alloc_node(cachep-&gt;freelist_cache, ...);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">/* We will use last bytes at the slab for freelist */</span></span><br><span class="line">    freelist = addr + (PAGE_SIZE &lt;&lt; cachep-&gt;gfporder) - cachep-&gt;freelist_size;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†é…-object">åˆ†é… object</h2><p>å†…æ ¸ç¼–ç¨‹ä¸­å¦‚æœéœ€è¦ç”³è¯·åœ¨ç‰©ç†ä¸Šè¿ç»­çš„å†…å­˜ï¼Œæœ€å¸¸ç”¨çš„å‡½æ•°å°±æ˜¯ kmalloc() äº†ï¼Œè€Œå®ƒçš„åº•å±‚å®ç°ä¾é çš„æ­£æ˜¯ slab cacheã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *__do_kmalloc(<span class="type">size_t</span> size, <span class="type">gfp_t</span> flags, ...)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cachep</span> =</span> kmalloc_slab(size, flags);</span><br><span class="line">    <span class="type">void</span> * ret = slab_alloc(cachep, flags, ...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯"sizeof(struct inode)"è¿™æ ·çš„ï¼Œå¯èƒ½åˆšå¥½æœ‰ object å¤§å°å®Œå…¨åŒ¹é…çš„ cacheã€‚å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªæ™®é€šçš„æ•´æ•°ï¼ˆæ¯”å¦‚ 100ï¼‰ï¼Œé‚£å°±éœ€è¦éå† cacheï¼Œå¹¶è¿›è¡Œä¸€å®šçš„è®¡ç®—ï¼Œä»¥å¯»æ‰¾æœ€åˆé€‚çš„ã€‚</p><h3 id="ç¬¬ä¸€çº§åˆ†é…fast-path">ç¬¬ä¸€çº§åˆ†é…ï¼ˆfast pathï¼‰</h3><p>æ¯ä¸ª"kmem_cache"é™¤äº†åŒ…å«å¤šä¸ª slabs å¤–ï¼Œè¿˜åŒ…å«ä¸€ç»„"cpu_cache"ï¼Œè¿™æ˜¯ä¸€ç§ per-CPU çš„ cacheï¼Œæ˜¯ slab çš„ cacheã€‚è¿™ä¹ˆè¯´å¯èƒ½æœ‰ç‚¹ç»•å£ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªè½¯ä»¶å±‚é¢çš„äºŒçº§ cacheã€‚æ‹¿ç¡¬ä»¶ cache æ¥ç±»æ¯”ï¼Œ"cpu_cache"å°±æ˜¯ L1 cacheï¼Œslab å°±æ˜¯ L2 cacheã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> __<span class="title">percpu</span> *<span class="title">cpu_cache</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> {</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> avail;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> limit;</span><br><span class="line">    <span class="type">void</span> *entry[];</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>"entry[]"è¡¨ç¤ºäº†ä¸€ä¸ªéµå¾ª LIFO é¡ºåºçš„æ•°ç»„ï¼ˆLast In, First Outï¼‰ï¼Œ"avail"å’Œ"limit"åˆ†åˆ«æŒ‡å®šäº†å½“å‰å¯ç”¨ objects çš„æ•°ç›®å’Œå…è®¸å®¹çº³çš„æœ€å¤§æ•°ç›®ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab8.jpg"></p><p>æ¯å½“ object è¯•å›¾ä» slab ä¸­åˆ†é…å†…å­˜æ—¶ï¼Œéƒ½å…ˆä»æ‰€åœ¨ CPU å¯¹åº”çš„"entry[]"æ•°ç»„ä¸­è·å–ã€‚per-CPU çš„è®¾è®¡å¯ä»¥å‡å°‘ SMP ç³»ç»Ÿå¯¹å…¨å±€ slab çš„é”çš„ç«äº‰ï¼Œä¸€äº› CPU bound çš„çº¿ç¨‹å°¤å…¶é€‚åˆä½¿ç”¨ CPU bound çš„å†…å­˜åˆ†é…ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *____cache_alloc(<span class="keyword">struct</span> kmem_cache *cachep, <span class="type">gfp_t</span> flags)</span><br><span class="line">{</span><br><span class="line">    <span class="type">void</span> *objp;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span> =</span> cpu_cache_get(cachep);</span><br><span class="line">    <span class="keyword">if</span> (likely(ac-&gt;avail)) {</span><br><span class="line">        objp = ac-&gt;entry[--ac-&gt;avail];</span><br><span class="line">        <span class="keyword">return</span> objp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    objp = cache_alloc_refill(cachep, flags);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¬¬äºŒçº§åˆ†é…slow-path">ç¬¬äºŒçº§åˆ†é…ï¼ˆslow pathï¼‰</h3><p>å¦‚æœåœ¨ç”³è¯·æ—¶æ•°ç»„ä¸ºç©ºï¼Œé‚£ä¹ˆå°±éœ€è¦ä»å…¨å±€çš„ slab ä¸­ refillï¼Œé‚£é€‰æ‹©å“ªä¸ª slab å‘¢ï¼Ÿä¸ºäº†å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œä¸€ä¸ª cache çš„ slabs åœ¨æ¯ä¸ªå†…å­˜ node ä¸­ï¼ˆper-nodeï¼‰ï¼Œæ ¹æ®ä½¿ç”¨çŠ¶æ€è¢«åˆ†æˆäº†ä¸‰ç±»ï¼š</p><ul><li>å…¨éƒ¨åˆ†é…å®Œï¼Œæ²¡æœ‰ç©ºé—² objects çš„ full slabsã€‚</li><li>åˆ†é…äº†ä¸€éƒ¨åˆ†ï¼Œå°šæœ‰éƒ¨åˆ†ç©ºé—²çš„ partial slabsã€‚</li><li>å®Œå…¨ç©ºé—²å¯ç”¨çš„ free slabsã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åº”é¦–å…ˆä» partial slabs ä¸­é€‰æ‹©ï¼Œç­‰ partial slabs éƒ½æ»¡äº†ï¼Œæˆä¸ºäº† full slabï¼Œè¿™æ—¶å†ä» free slabs ä¸­é€‰æ‹©ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab9.jpg"></p><p>åˆæ˜¯ per CPUï¼Œåˆæ˜¯ per nodeï¼Œåœ¨å¤§å‹ç³»ç»Ÿä¸­ï¼Œè¿™æ˜¯ä¸€ç¬”ä¸å°çš„å¼€é”€ã€‚</p><h3 id="ç¬¬ä¸‰çº§åˆ†é…very-slow-path">ç¬¬ä¸‰çº§åˆ†é…ï¼ˆvery slow pathï¼‰</h3><p>å¦‚æœä¸€ä¸ª cache è¿ free slab éƒ½æ²¡æœ‰äº†ï¼Œé‚£å°±éœ€è¦æ–°å¢ä¸€ä¸ª slab æ¥â€œæ‰©å®¹â€äº†ã€‚æ–°å¢ slab çš„æ–¹æ³•åœ¨ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œæœ€ç»ˆæ˜¯å‘ buddy ç³»ç»Ÿç”³è¯·ï¼Œå›åˆ°è¿™ç¯‡æ–‡ç« æè¿°çš„ page level åˆ†é…å™¨çš„ä»£ç è·¯å¾„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab10.jpg"></p><h2 id="é‡Šæ”¾-object">é‡Šæ”¾ object</h2><p>é‡Šæ”¾æ—¶ä¹Ÿå½’è¿˜åˆ°æ‰€åœ¨ CPU çš„"cpu_cache"æ•°ç»„ï¼Œå¦‚æœé‡Šæ”¾å¯¼è‡´æ•°ç»„æº¢å‡ºï¼Œåˆ™æ•°ç»„ä¸­çš„ä¸€éƒ¨åˆ† entries å°†è¢«è¿”è¿˜åˆ°å…¨å±€çš„ slab ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> ___cache_free(<span class="keyword">struct</span> kmem_cache *cachep, <span class="type">void</span> *objp, ..)</span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">ac</span> =</span> cpu_cache_get(cachep);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ac-&gt;avail &gt;= ac-&gt;limit) {</span><br><span class="line">        <span class="comment">// å½’è¿˜åˆ°å¯¹åº”çš„ slab</span></span><br><span class="line">        cache_flusharray(cachep, ac);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ac-&gt;entry[ac-&gt;avail++] = objp;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¹³æ—¶å¸¸è°ƒç”¨çš„æ¥å£æ˜¯ kfree()ï¼Œåªæœ‰ä¸€ä¸ªè¡¨ç¤ºåœ°å€çš„å‚æ•°ï¼Œé‚£å¦‚ä½•çŸ¥é“åº”è¯¥å½’è¿˜åˆ°å“ªä¸ª slab ä¸­ï¼Ÿå¯»æ‰¾çš„æ–¹æ³•æ˜¯é¦–å…ˆæ ¹æ® object çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ° object æ‰€åœ¨çš„ page frameï¼Œè¿›è€Œæ‰¾åˆ°è¿™ä¸ª page frame æ‰€åœ¨ compound page çš„ä¸­çš„ head pageï¼Œè€Œ head page ä¸­çš„"slab_cache"æŒ‡é’ˆå°±æŒ‡å‘äº†è¿™ä¸ª object æ‰€å±çš„ slabã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *objp)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">c</span> =</span> virt_to_cache(objp);</span><br><span class="line">    __cache_free(c, (<span class="type">void</span> *)objp, _RET_IP_);</span><br><span class="line">    ...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> kmem_cache *<span class="title function_">virt_to_cache</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *obj)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> virt_to_head_page(obj);</span><br><span class="line">    <span class="keyword">return</span> page-&gt;slab_cache;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> page *<span class="title function_">virt_to_head_page</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *x)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// object æ‰€åœ¨çš„ page frame</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> virt_to_page(x);</span><br><span class="line">    <span class="comment">// æ‰€åœ¨ compound page çš„ head page</span></span><br><span class="line">    <span class="keyword">return</span> compound_head(page);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å€ŸåŠ©è¿™æ¡è·¯å¾„ï¼Œè¿›è€Œè¿˜å¯ä»¥çŸ¥é“ä¸€ä¸ª object çš„å¤§å°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> __ksize(<span class="type">const</span> <span class="type">void</span> *objp)</span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">c</span>=</span> virt_to_cache(objp);</span><br><span class="line">    <span class="type">size_t</span> size = c ? c-&gt;object_size : <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>è‡³æ­¤ï¼Œslab åˆ†é…å™¨çš„åŸç†å’Œåœ¨ Linux ä¸­çš„å®ç°å°±ç²—ç•¥çš„ä»‹ç»å®Œäº†ï¼Œå¯ä»¥å€ŸåŠ©ä¸‹é¢è¿™å¼ å›¾æ¥ä¸€è§ˆå®ƒçš„æ„æˆï¼ŒåŒ…æ‹¬ kernel object, page frame å’Œ slab cache çš„å…³ç³»ï¼Œç‰©ç†å†…å­˜çš„ç»„ç»‡å’Œåˆ†é…ç­‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/slab11.jpg"></p><p>slab åˆ†é…å™¨å¯¹å†…å­˜çš„åˆ©ç”¨ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå› ä¸ºå……åˆ†å€ŸåŠ©äº†å„ç§ç¼“å­˜æœºåˆ¶ï¼Œåˆ†é…å’Œé‡Šæ”¾çš„é€Ÿåº¦ä¹Ÿæ¯”è¾ƒç†æƒ³ã€‚å­˜åœ¨çš„ç¼ºç‚¹å°±æ˜¯è¦ä¸ºå†…æ ¸ä¸­ä¼—å¤šçš„ objects ç»´æŠ¤ç‹¬ç«‹çš„ cacheï¼Œè¿™ä¼šå¸¦æ¥ç›¸å½“çš„ç®¡ç†ä¸Šçš„å¼€é”€ã€‚</p><h1 id="kmalloc">kmalloc</h1><p>å†…æ ¸ä¸­å¸¸ç”¨çš„ kmalloc() å‡½æ•°çš„æ ¸å¿ƒå®ç°æ˜¯ slab æœºåˆ¶ã€‚ç±»ä¼¼äºä¼™ä¼´ç³»ç»Ÿæœºåˆ¶ï¼Œåœ¨å†…å­˜å—ä¸­æŒ‰ç…§$ 2^{order} $å­—èŠ‚æ¥åˆ›å»ºå¤šä¸ª slab æè¿°ç¬¦ï¼Œå¦‚ 16 å­—èŠ‚ã€32 å­—èŠ‚ã€64 å­—èŠ‚ã€128 å­—èŠ‚ç­‰å¤§å°ï¼Œç³»ç»Ÿä¼šåˆ†åˆ«åˆ›å»º kmalloc-16ã€kmalloc-32ã€kmalloc-64 ç­‰ slab æè¿°ç¬¦ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è¿™åœ¨ create_kmalloc_caches() å‡½æ•°ä¸­å®Œæˆã€‚ä¾‹å¦‚ï¼Œè¦åˆ†é… 30 å­—èŠ‚çš„ä¸€ä¸ªå°å†…å­˜å—ï¼Œå¯ä»¥ç”¨â€œkmalloc(30ï¼ŒGFP_KERNEL) å®ç°ï¼Œä¹‹åç³»ç»Ÿä¼šä» kmalloc-32 slab æè¿°ç¬¦ä¸­åˆ†é…ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *<span class="title function_">kmalloc</span><span class="params">(<span class="type">size_t</span> size, <span class="type">gfp_t</span> flags)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) {</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> index;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!index)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmem_cache_alloc_trace(</span><br><span class="line">kmalloc_caches[kmalloc_type(flags)][index],</span><br><span class="line">flags, size);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>kmalloc_index å¯ä»¥ç”¨äºæŸ¥æ‰¾ä½¿ç”¨çš„æ˜¯å“ªä¸ª slab ç¼“å†²åŒºï¼Œè¿™å¾ˆå½¢è±¡çš„å±•ç¤ºäº† kmalloc çš„è®¾è®¡æ€æƒ³ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> kmalloc_index(s) __kmalloc_index(s, true)</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">int</span> __kmalloc_index(<span class="type">size_t</span> size,</span><br><span class="line">    <span class="type">bool</span> size_is_constant)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)</span><br><span class="line"><span class="keyword">return</span> KMALLOC_SHIFT_LOW;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">32</span> &amp;&amp; size &gt; <span class="number">64</span> &amp;&amp; size &lt;= <span class="number">96</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">64</span> &amp;&amp; size &gt; <span class="number">128</span> &amp;&amp; size &lt;= <span class="number">192</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=          <span class="number">8</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">16</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">32</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">64</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">128</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">256</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">512</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=       <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">2</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">4</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">8</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">128</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">512</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">23</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((IS_ENABLED(CONFIG_CC_IS_GCC) || CONFIG_CLANG_VERSION &gt;= <span class="number">110000</span>)</span><br><span class="line">    &amp;&amp; !IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)</span><br><span class="line">BUILD_BUG_ON_MSG(<span class="number">1</span>, <span class="string">"unexpected size in kmalloc_index()"</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">BUG();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Will never be reached. Needed because the compiler may complain */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸ vmalloc åŒºåˆ«ï¼ˆéƒ½æ˜¯åˆ†é…å†…æ ¸ç©ºé—´å†…å­˜ï¼‰ï¼š</p><ul><li>kmalloc åˆ†é…ç‰©ç†è¿ç»­çš„åœ°å€ï¼Œè€Œ vmalloc åˆ†é…è™šæ‹Ÿåœ°å€è¿ç»­çš„ç©ºé—´ã€‚</li><li>kmalloc å¯ä»¥é€šè¿‡ gfp_mask æ ‡å¿—æ§åˆ¶åˆ†é…å†…å­˜æ—¶ä¸èƒ½ä¼‘çœ ï¼Œå› æ­¤å¯ä»¥ç”¨äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆsoftirq å’Œ tasklet ä¹Ÿå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼‰ï¼Œè€Œ vmalloc çš„è°ƒç”¨å¯èƒ½å¼•èµ·ç¡çœ ä¸èƒ½ç”¨äºä¸­æ–­ä¸Šä¸‹æ–‡ã€‚</li><li>kmalloc æ€§èƒ½æ›´å¥½ï¼ˆå†…æ ¸ç©ºé—´æ›´å¤šå®ç”¨è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œè€Œ vmalloc ä¸ºäº†æŠŠç‰©ç†ä¸Šä¸è¿ç»­çš„é¡µè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šè¿ç»­çš„é¡µï¼Œéœ€è¦å»ºç«‹ä¸“é—¨çš„é¡µè¡¨é¡¹ï¼Œä¼šå¯¼è‡´ TLB æŠ–åŠ¨ç­‰é—®é¢˜ï¼Œæ€§èƒ½ä¸ä½³ï¼ˆä¸»è¦ç”¨äºç”¨æˆ·ç©ºé—´åˆ†é…å†…å­˜ï¼‰ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDYxMDYwMDg=">https://zhuanlan.zhihu.com/p/106106008<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆäº”ï¼‰é¡µé¢åˆ†é…å™¨</title>
      <link href="/2021/LinuxKernel/LinuxMemoryPageAllocate/"/>
      <url>/2021/LinuxKernel/LinuxMemoryPageAllocate/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryPageAllocate.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM3MmRhZDA3OTEyOTA2ZjUwYTdmYWI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><p>åˆ†é…ç‰©ç†é¡µé¢æ˜¯å†…å­˜ç®¡ç†ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œå®ƒæ¶‰åŠé¡µé¢å›æ”¶ã€å†…å­˜è§„æ•´ã€ç›´æ¥å›æ”¶å†…å­˜ç­‰ç›¸å½“é”™ç»¼å¤æ‚çš„æœºåˆ¶ã€‚æœ¬èŠ‚å…³æ³¨åœ¨å†…å­˜å……è¶³çš„æƒ…å†µä¸‹å¦‚ä½•åˆ†é…è¿ç»­ç‰©ç†å†…å­˜ã€‚</p><h1 id="page-æ•°æ®ç»“æ„">page æ•°æ®ç»“æ„</h1><p>Linux å†…æ ¸å†…å­˜ç®¡ç†çš„å®ç°ä»¥ page æ•°æ®ç»“æ„ä¸ºæ ¸å¿ƒï¼Œå…¶ä»–çš„å†…å­˜ç®¡ç†è®¾æ–½éƒ½åŸºäº page æ•°æ®ç»“æ„ï¼Œå¦‚ VMA ç®¡ç†ã€ç¼ºé¡µä¸­æ–­ã€RMAPã€é¡µé¢åˆ†é…ä¸å›æ”¶ç­‰ã€‚page æ•°æ®ç»“æ„å®šä¹‰åœ¨ include/linux/mm_types.h å¤´æ–‡ä»¶ä¸­ã€‚</p><h2 id="refcount-_refcount-å’Œ__mapcount-æ˜¯-page-æ•°æ®ç»“æ„ä¸­éå¸¸é‡è¦çš„ä¸¤ä¸ªå¼•ç”¨è®¡æ•°ä¸”éƒ½æ˜¯-atomic_t-ç±»å‹çš„å˜é‡-_refcount-è¡¨ç¤ºå†…æ ¸ä¸­å¼•ç”¨è¯¥é¡µé¢çš„æ¬¡æ•°">_refcount _refcount å’Œ__mapcount æ˜¯ page æ•°æ®ç»“æ„ä¸­éå¸¸é‡è¦çš„ä¸¤ä¸ªå¼•ç”¨è®¡æ•°ï¼Œä¸”éƒ½æ˜¯ atomic_t ç±»å‹çš„å˜é‡ã€‚ _refcount è¡¨ç¤ºå†…æ ¸ä¸­å¼•ç”¨è¯¥é¡µé¢çš„æ¬¡æ•°ã€‚</h2><ul><li>å½“_refcount çš„å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥é¡µé¢ä¸ºç©ºé—²é¡µé¢æˆ–å³å°†è¦è¢«é‡Šæ”¾çš„é¡µé¢</li><li>å½“_refcount çš„å€¼å¤§äº 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥é¡µé¢å·²ç»åˆ†é…ç»™å†…æ ¸æ­£åœ¨ä½¿ç”¨ï¼Œæš‚æ—¶ä¸ä¼šè¢«é‡Šæ”¾</li></ul><h2 id="mapcount-_mapcount-è¡¨ç¤ºè¿™ä¸ªé¡µé¢è¢«è¿›ç¨‹æ˜ å°„çš„ä¸ªæ•°å³å·²ç»æ˜ å°„äº†å¤šå°‘ä¸ªç”¨æˆ·-pteæ¯ä¸ªç”¨æˆ·è¿›ç¨‹éƒ½æ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´256tbå’Œä¸€ä»½ç‹¬ç«‹çš„é¡µè¡¨æ‰€ä»¥å¯èƒ½å‡ºç°å¤šä¸ªç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´åŒæ—¶æ˜ å°„åˆ°ä¸€ä¸ªç‰©ç†é¡µé¢çš„æƒ…å†µrmap-ç³»ç»Ÿå°±æ˜¯åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥å®ç°çš„_mapcount-ä¸»è¦ç”¨äº-rmap-ç³»ç»Ÿä¸­">_mapcount _mapcount è¡¨ç¤ºè¿™ä¸ªé¡µé¢è¢«è¿›ç¨‹æ˜ å°„çš„ä¸ªæ•°ï¼Œå³å·²ç»æ˜ å°„äº†å¤šå°‘ä¸ªç”¨æˆ· PTEã€‚æ¯ä¸ªç”¨æˆ·è¿›ç¨‹éƒ½æ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´ï¼ˆ256TBï¼‰å’Œä¸€ä»½ç‹¬ç«‹çš„é¡µè¡¨ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°å¤šä¸ªç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´åŒæ—¶æ˜ å°„åˆ°ä¸€ä¸ªç‰©ç†é¡µé¢çš„æƒ…å†µï¼ŒRMAP ç³»ç»Ÿå°±æ˜¯åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥å®ç°çš„ã€‚_mapcount ä¸»è¦ç”¨äº RMAP ç³»ç»Ÿä¸­ã€‚</h2><ul><li>è‹¥_mapcount ç­‰äº-1ï¼Œè¡¨ç¤ºæ²¡æœ‰ PTE æ˜ å°„åˆ°é¡µé¢</li><li>è‹¥_mapcount ç­‰äº Oï¼Œè¡¨ç¤ºåªæœ‰çˆ¶è¿›ç¨‹æ˜ å°„åˆ°é¡µé¢ã€‚åŒ¿åé¡µé¢åˆšåˆ†é…æ—¶ï¼Œ_mapcount åˆå§‹åŒ–ä¸º Oã€‚ä¾‹å¦‚ï¼Œå½“ do_anonymous_page() äº§ç”Ÿçš„åŒ¿åé¡µé¢é€šè¿‡ page_add_new_anonrmap() æ·»åŠ åˆ° rmap ç³»ç»Ÿä¸­æ—¶ï¼Œä¼šè®¾ç½®_mapcount ä¸º Oï¼Œè¿™è¡¨æ˜åŒ¿åé¡µé¢å½“å‰åªæœ‰çˆ¶è¿›ç¨‹çš„ PTE æ˜ å°„åˆ°é¡µé¢</li></ul><h2 id="rmap">RMAP</h2><p>ç”¨æˆ·è¿›ç¨‹åœ¨ä½¿ç”¨è™šæ‹Ÿå†…å­˜è¿‡ç¨‹ä¸­ï¼Œä»è™šæ‹Ÿå†…å­˜é¡µé¢æ˜ å°„åˆ°ç‰©ç†å†…å­˜é¡µé¢æ—¶ï¼ŒPTE ä¿ç•™äº†è¿™ä¸ªè®°å½•ã€‚page æ•°æ®ç»“æ„ä¸­çš„_mapcount è®°å½•æœ‰å¤šå°‘ä¸ªç”¨æˆ· PTE æ˜ å°„åˆ°ç‰©ç†é¡µé¢ã€‚æœ‰çš„é¡µé¢éœ€è¦è¿ç§»ï¼Œæœ‰çš„é¡µé¢éœ€è¦äº¤æ¢åˆ°ç£ç›˜ï¼Œåœ¨äº¤æ¢ä¹‹å‰ï¼Œå¿…é¡»æ‰¾å‡ºå“ªäº›è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªé¡µé¢ï¼Œç„¶åè§£é™¤è¿™äº›æ˜ å°„çš„ç”¨æˆ· PTEã€‚</p><p>RMAP çš„ä¸»è¦ç›®çš„æ˜¯ä»ç‰©ç†é¡µé¢çš„ page æ•°æ®ç»“æ„ä¸­æ‰¾åˆ°æœ‰å“ªäº›æ˜ å°„çš„ç”¨æˆ· PTEï¼Œè¿™æ ·é¡µé¢å›æ”¶æ¨¡å—å°±å¯ä»¥å¾ˆå¿«é€Ÿå’Œé«˜æ•ˆåœ°æŠŠè¿™ä¸ªç‰©ç†é¡µé¢æ˜ å°„çš„æ‰€æœ‰ç”¨æˆ· PTE æ­£éƒ½è§£é™¤å¹¶å›æ”¶è¿™ä¸ªé¡µé¢ã€‚</p><p>RMAP çš„å…¸å‹åº”ç”¨åœºæ™¯å¦‚ä¸‹ã€‚</p><ul><li>kswapd å†…æ ¸çº¿ç¨‹ä¸ºäº†å›æ”¶é¡µé¢ï¼Œéœ€è¦æ–­å¼€æ‰€æœ‰æ˜ å°„åˆ°è¯¥åŒ¿åé¡µé¢çš„ç”¨æˆ· PTE</li><li>é¡µé¢è¿ç§»æ—¶ï¼Œéœ€è¦æ–­å¼€æ‰€æœ‰æ˜ å°„åˆ°åŒ¿åé¡µé¢çš„ç”¨æˆ· PTE</li></ul><h1 id="åˆ†é…ç‰©ç†é¡µé¢çš„æ¥å£å‡½æ•°æ‰©å±•">åˆ†é…ç‰©ç†é¡µé¢çš„æ¥å£å‡½æ•°ï¼ˆæ‰©å±•ğŸ™ˆï¼‰</h1><p>å†…æ ¸ä¸­åˆ†é…ç‰©ç†å†…å­˜é¡µé¢çš„å¸¸ç”¨æ¥å£å‡½æ•°æ˜¯ alloc_pages()ï¼Œå®ƒç”¨äºåˆ†é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿ç»­çš„ç‰©ç†é¡µé¢ï¼Œåˆ†é…çš„é¡µé¢ä¸ªæ•°åªèƒ½æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ã€‚</p><h2 id="åˆ†é…ç‰©ç†é¡µé¢çš„æ ¸å¿ƒæ¥å£å‡½æ•°">åˆ†é…ç‰©ç†é¡µé¢çš„æ ¸å¿ƒæ¥å£å‡½æ•°</h2><p>aloc_pages() å‡½æ•°çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œgfp_mask è¡¨ç¤ºåˆ†é…æ©ç ï¼Œorder è¡¨ç¤ºåˆ†é…çº§æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/gfp.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">alloc_pages</span>(<span class="title">gfp_t</span> <span class="title">gfp</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">preferred_nid</span>,</span></span><br><span class="line"><span class="class"><span class="title">nodemask_t</span> *<span class="title">nodemask</span>);</span></span><br></pre></td></tr></tbody></table></figure><p>alloc_paes() å‡½æ•°ç”¨æ¥åˆ†é… 2 çš„ order æ¬¡å¹‚ä¸ªè¿ç»­çš„ç‰©ç†é¡µé¢ï¼Œè¿”å›å€¼æ˜¯ç¬¬ä¸€ä¸ªç‰©ç†é¡µé¢ page æ•°æ®ç»“æ„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ gfp_maskï¼šç¬¬äºŒä¸ªå‚æ•°æ˜¯ orderï¼Œè¯·æ±‚çš„ order éœ€è¦å°äº MAX_ORDERï¼ŒMAX_ORDER é€šå¸¸é»˜è®¤æ˜¯ 11ã€‚ å¦ä¸€ä¸ªå¾ˆå¸¸è§çš„æ¥å£å‡½æ•°æ˜¯__get_free_pages()ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;mm/page_alloc.c&gt;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __get_free_pages(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>) page_address(page);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>__get_free_pages() å‡½æ•°è¿”å›çš„æ˜¯æ‰€åˆ†é…å†…å­˜çš„å†…æ ¸ç©ºé—´è™šæ‹Ÿåœ°å€ã€‚å¦‚æœæ‰€åˆ†é…å†…å­˜æ˜¯çº¿æ€§æ˜ å°„çš„ç‰©ç†å†…å­˜ï¼Œåˆ™ç›´æ¥è¿”å›çº¿æ€§æ˜ å°„åŒºåŸŸçš„å†…æ ¸ç©ºé—´è™šæ‹Ÿåœ°å€ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">page_address</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> page *page)</span></span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢">åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢</h2><p>å¦‚æœéœ€è¦åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä¸¤ä¸ªå°è£…å¥½çš„æ¥å£å‡½æ•°ï¼Œå®ƒä»¬æœ€åä»è°ƒç”¨ alloc_pages()ï¼Œåªæ˜¯ order çš„å€¼ä¸º 0.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_pages_vma(gfp_mask, order, vma, addr, node, false)\</span></span><br><span class="line"><span class="meta">alloc_pages(gfp_mask, order)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __get_free_page(gfp_mask) \</span></span><br><span class="line"><span class="meta">__get_free_pages((gfp_mask), 0)</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœéœ€è¦è¿”å›ä¸€ä¸ªå…¨å¡«å……ä¸º 0 çš„é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ¥å£å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">get_zeroed_page</span><span class="params">(<span class="type">gfp_t</span> gfp_mask)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> __get_free_pages(gfp_mask | __GFP_ZERO, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ alloc_page() åˆ†é…çš„ç‰©ç†é¡µé¢ç†è®ºä¸Šå¯èƒ½è¢«éšæœºåœ°å¡«å……äº†æŸäº›åƒåœ¾ä¿¡æ¯ï¼Œå› æ­¤åœ¨æœ‰äº›æ•æ„Ÿçš„åœºåˆä¸‹éœ€è¦å…ˆæŠŠåˆ†é…çš„å†…å­˜æ¸…é›¶å†ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p><h2 id="é¡µé¢é‡Šæ”¾å‡½æ•°">é¡µé¢é‡Šæ”¾å‡½æ•°</h2><p>é¡µé¢é‡Šæ”¾å‡½æ•°ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> __free_pages(<span class="keyword">struct</span> page *page, <span class="type">unsigned</span> <span class="type">int</span> order);</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">free_pages</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">unsigned</span> <span class="type">int</span> order)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __free_page(page) __free_pages((page), 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free_page(addr) free_pages((addr), 0)</span></span><br></pre></td></tr></tbody></table></figure><p>é‡Šæ”¾æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„å‚æ•°ï¼Œä¼ é€’é”™è¯¯çš„ page æŒ‡é’ˆæˆ–è€…é”™è¯¯çš„ order å€¼ä¼šå¼•èµ·ç³»ç»Ÿå´©æºƒã€‚</p><h1 id="åˆ†é…æ©ç ">åˆ†é…æ©ç </h1><p>åˆ†é…æ©ç æ˜¯æè¿°é¡µé¢åˆ†é…æ–¹æ³•çš„æ ‡å¿—ï¼Œå®ƒå½±å“ç€é¡µé¢åˆ†é…çš„æ•´ä¸ªæµç¨‹ã€‚å› ä¸º Linux å†…æ ¸æ˜¯ä¸€ä¸ªé€šç”¨çš„æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥é¡µé¢åˆ†é…å™¨è¢«è®¾è®¡æˆä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿã€‚å®ƒæ—¢è¦é«˜æ•ˆï¼Œåˆè¦å…¼é¡¾å¾ˆå¤šç§æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹çš„å†…å­˜åˆ†é…ã€‚gfp_mask å…¶å®è¢«å®šä¹‰æˆä¸€ä¸ª unsigned ç±»å‹çš„å˜é‡ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> __bitwise__ <span class="type">gfp_t</span>;</span><br></pre></td></tr></tbody></table></figure><p>gfp_mask å®šä¹‰åœ¨ include/inux/gfp.h æ–‡ä»¶ä¸­ã€‚ä¿®é¥°ç¬¦åœ¨ Linux4.4 å†…æ ¸ä¸­è¢«é‡æ–°å½’ç±»ï¼Œå¤§è‡´å¯ä»¥åˆ†æˆå¦‚ä¸‹å‡ ç±»ã€‚</p><ul><li>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ï¼ˆzone modifierï¼‰</li><li>ç§»åŠ¨ä¿®é¥°ç¬¦ï¼ˆmobility and placement modifierï¼‰</li><li>æ°´ä½ä¿®é¥°ç¬¦ï¼ˆwatermark modifierï¼‰</li><li>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦ï¼ˆpage reclaim modifierï¼‰</li><li>è¡Œä¸ºä¿®é¥°ç¬¦ï¼ˆaction modifierï¼‰</li></ul><p>ä¸‹é¢è¯¦ç»†ä»‹ç»å„ç§ä¿®é¥°ç¬¦çš„æ ‡å¿—ã€‚</p><h2 id="å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦çš„æ ‡å¿—">å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦çš„æ ‡å¿—</h2><p>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦ç”¨äºè¡¨ç¤ºåº”å½“ä»å“ªäº›å†…å­˜ç®¡ç†åŒºä¸­æ¥åˆ†é…ç‰©ç†å†…å­˜ã€‚å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä½¿ç”¨ gfp_mask çš„ä½ 4 ä½æ¥è¡¨ç¤ºï¼Œå…¶æ ‡å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>__GFP_DMA: ä» ZONE_DMA ä¸­åˆ†é…å†…å­˜</li><li>__GFP_DMA32: ä» ZONE DMA32 ä¸­åˆ†é…å†…å­˜</li><li>__GFP_HIGHMEM: ä¼˜å…ˆä» ZONE_HIGHMEM ä¸­åˆ†é…å†…å­˜</li><li>__GFP_MOVABLE: é¡µé¢å¯ä»¥è¢«è¿ç§»æˆ–è€…å›æ”¶ï¼Œå¦‚ç”¨äºå†…å­˜è§„æ•´æœºåˆ¶</li></ul><h2 id="ç§»åŠ¨ä¿®é¥°ç¬¦çš„æ ‡å¿—">ç§»åŠ¨ä¿®é¥°ç¬¦çš„æ ‡å¿—</h2><p>ç§»åŠ¨ä¿®é¥°ç¬¦ä¸»è¦ç”¨äºæŒ‡ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§ï¼Œå…¶æ ‡å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨ Linux2.6.24 å†…æ ¸ä¸­ï¼Œä¸ºäº†è§£å†³å¤–ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œå¼•å…¥äº†è¿ç§»ç±»å‹ï¼Œå› æ­¤åœ¨åˆ†é…å†…å­˜æ—¶éœ€è¦æŒ‡å®šæ‰€åˆ†é…çš„é¡µé¢å…·æœ‰å“ªäº›è¿ç§»å±æ€§ã€‚</p><ul><li>__GFP_RECLAIMABLE: åœ¨ slab åˆ†é…å™¨ä¸­æŒ‡å®šäº† SLAB_RECLAIM_ACCOUNT æ ‡å¿—ä½ï¼Œè¡¨ç¤º slab åˆ†é…å™¨ä¸­ä½¿ç”¨çš„é¡µé¢å¯ä»¥é€šè¿‡æ”¶å‰²æœºæ¥å›æ”¶</li><li>__GFP_HARDWALL: ä½¿èƒ½ cpuset å†…å­˜åˆ†é…ç­–ç•¥</li><li>__GFP_THISNODE: ä»æŒ‡å®šçš„å†…å­˜èŠ‚ç‚¹ä¸­åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”æ²¡æœ‰å›é€€æœºåˆ¶</li><li>__GFP_ACCOUNT: åˆ†é…è¿‡ç¨‹ä¼šè¢« kmemcg è®°å½•</li></ul><h2 id="æ°´ä½ä¿®é¥°ç¬¦çš„æ ‡å¿—">æ°´ä½ä¿®é¥°ç¬¦çš„æ ‡å¿—</h2><p>æ°´ä½ä¿®é¥°ç¬¦ç”¨äºæ§åˆ¶æ˜¯å¦å¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™çš„å†…å­˜ã€‚æ‰€è°“ç³»ç»Ÿé¢„ç•™å†…å­˜æŒ‡çš„æ˜¯æœ€ä½è­¦æˆ’æ°´ä½ä»¥ä¸‹çš„å†…å­˜ï¼Œä¸€èˆ¬ä¼˜å…ˆçº§çš„åˆ†é…è¯·æ±‚æ˜¯ä¸èƒ½è®¿é—®å®ƒä»¬çš„ï¼Œåªæœ‰é«˜ä¼˜å…ˆçº§çš„åˆ†é…è¯·æ±‚æ‰èƒ½è®¿é—®ï¼Œå¦‚__GFP_HIGHã€__GFP_ATOMIC ç­‰ã€‚æ°´ä½ä¿®é¥°ç¬¦çš„æ ‡å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>__GFP_HIGH: è¡¨ç¤ºåˆ†é…å†…å­˜å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”è¿™ä¸ªåˆ†é…è¯·æ±‚æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œåˆ†é…å™¨å¯ä»¥ä½¿ç”¨ç³»ç»Ÿé¢„ç•™çš„å†…å­˜ï¼ˆå³æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜ï¼‰</li><li>__GFP_ATOMIC: è¡¨ç¤ºåˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸èƒ½æ‰§è¡Œé¡µé¢å›æ”¶æˆ–è€…ç¡çœ åŠ¨ä½œï¼Œå¹¶ä¸”å…·æœ‰å¾ˆé«˜çš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™çš„å†…å­˜ã€‚å¸¸è§çš„ä¸€ä¸ªåœºæ™¯æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­åˆ†é…å†…å­˜</li><li>__GFP_MEMALLOC: åˆ†é…è¿‡ç¨‹ä¸­å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé¢„ç•™çš„å†…å­˜ã€‚åˆ†é…å†…å­˜è¿›ç¨‹é€šå¸¸è¦ä¿è¯åœ¨åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¾ˆå¿«ä¼šæœ‰å†…å­˜è¢«é‡Šæ”¾ï¼Œå¦‚è¿›ç¨‹é€€å‡ºæˆ–è€…é¡µé¢å›æ”¶</li><li>__GFP_NOMEMALLOC: åˆ†é…è¿‡ç¨‹ä¸å…è®¸è®¿é—®ç³»ç»Ÿé¢„ç•™çš„å†…å­˜</li></ul><h2 id="é¡µé¢å›æ”¶ä¿®é¥°ç¬¦çš„æ ‡å¿—">é¡µé¢å›æ”¶ä¿®é¥°ç¬¦çš„æ ‡å¿—</h2><p>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦çš„å¸¸ç”¨æ ‡å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>__GFP_IO: å…è®¸å¼€å¯ I/O ä¼ è¾“</li><li>__GFP_FS: å…è®¸è°ƒç”¨åº•å±‚çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ªæ ‡å¿—æ¸…é›¶é€šå¸¸æ˜¯ä¸ºäº†é¿å…æ­»é”çš„å‘ç”Ÿï¼Œå¦‚æœç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œè·¯å¾„ä¸Šå·²ç»æŒæœ‰äº†é”ï¼Œåˆ†é…å†…å­˜è¿‡ç¨‹åˆé€’å½’åœ°è°ƒç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç›¸åº”æ“ä½œè·¯å¾„ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ­»é”</li><li>__GFP_DIRECT_RECLAIM: åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­å…è®¸ä½¿ç”¨é¡µé¢ç›´æ¥å›æ”¶æœºåˆ¶</li><li>__GFP_KSWAPD_RECLAIM: è¡¨ç¤ºå½“åˆ°è¾¾å†…å­˜ç®¡ç†åŒºçš„ä½æ°´ä½æ—¶ä¼šå”¤é†’ kswapd å†…æ ¸çº¿ç¨‹ï¼Œä»¥å¼‚æ­¥åœ°å›æ”¶å†…å­˜ï¼Œç›´åˆ°å†…å­˜ç®¡ç†åŒºæ¢å¤åˆ°äº†é«˜æ°´ä½ä¸ºæ­¢</li><li>__GFP_RECLAIM: ç”¨äºå…è®¸æˆ–è€…ç¦æ­¢ç›´æ¥é¡µé¢å›æ”¶å’Œ kswapd å†…æ ¸çº¿ç¨‹</li><li>__GFP_REPEAT: å½“åˆ†é…å¤±è´¥æ—¶ä¼šç»§ç»­å°è¯•</li><li>__GFP_NOFAIL: å½“åˆ†é…å¤±è´¥æ—¶ä¼šæ— é™åœ°å°è¯•ä¸‹å»ï¼Œç›´åˆ°åˆ†é…æˆåŠŸä¸ºæ­¢ã€‚å½“åˆ†é…è€…å¸Œæœ›åˆ†é…å†…å­˜ä¸å¤±è´¥æ—¶ï¼Œåº”è¯¥ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½ï¼Œè€Œä¸æ˜¯è‡ªå·±å†™ä¸€ä¸ª while å¾ªç¯æ¥ä¸æ–­åœ°è°ƒç”¨é¡µé¢åˆ†é…æ¥å£å‡½æ•°</li><li>__GFP_NORETRY: å½“ä½¿ç”¨äº†ç›´æ¥é¡µé¢å›æ”¶å’Œå†…å­˜è§„æ•´ç­‰æœºåˆ¶è¿˜æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œæœ€å¥½ä¸è¦é‡å¤å°è¯•åˆ†é…äº†ï¼Œç›´æ¥è¿”å› NULL</li></ul><h2 id="è¡Œä¸ºä¿®é¥°ç¬¦çš„æ ‡å¿—">è¡Œä¸ºä¿®é¥°ç¬¦çš„æ ‡å¿—</h2><p>è¡Œä¸ºä¿®é¥°ç¬¦çš„å¸¸è§æ ‡å¿—å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>__GFP_COLD: åˆ†é…çš„å†…å­˜ä¸ä¼šé©¬ä¸Šè¢«ä½¿ç”¨ã€‚é€šå¸¸ä¼šè¿”å›ä¸€ä¸ªç©ºçš„é«˜é€Ÿç¼“å­˜é¡µé¢</li><li>__GFP_NOWARN: å…³é—­åˆ†é…è¿‡ç¨‹ä¸­çš„ä¸€äº›é”™è¯¯æŠ¥å‘Š</li><li>__GFP_ZERO: è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º 0 çš„é¡µé¢</li><li>__GFP_NOTRACK: ä¸è¢« kmemcheck æœºåˆ¶è·Ÿè¸ª</li><li>__GFP_OTHER_NODE: åœ¨è¿œç«¯çš„ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹ä¸Šåˆ†é…ã€‚é€šå¸¸åœ¨ khugepaged å†…æ ¸çº¿ç¨‹ä¸­ä½¿ç”¨</li></ul><p>å‰æ–‡åˆ—å‡ºäº† 5 å¤§ç±»ä¿®é¥°ç¬¦çš„æ ‡å¿—ï¼Œå¯¹äºå†…æ ¸å¼€å‘è€…æˆ–è€…é©±åŠ¨å¼€å‘è€…æ¥è¯´ï¼Œè¦æ­£ç¡®ä½¿ç”¨è¿™äº›æ ‡å¿—æ˜¯ä¸€ä»¶å¾ˆå›°éš¾çš„äº‹æƒ…ï¼Œå› æ­¤å®šä¹‰äº†ä¸€äº›å¸¸ç”¨çš„æ ‡å¿—çš„ç»„åˆç±»å‹æ ‡å¿—ï¼ˆtype flagï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ç±»å‹æ ‡å¿—æä¾›äº†å†…æ ¸å¼€å‘ä¸­å¸¸ç”¨çš„æ ‡å¿—çš„ç»„åˆï¼Œæ¨èå¼€å‘è€…ä½¿ç”¨è¿™äº›ç±»å‹æ ‡å¿—ã€‚</p><ul><li>GFP_KERNEL: å†…æ ¸åˆ†é…å†…å­˜å¸¸ç”¨çš„æ ‡å¿—ä¹‹ä¸€ã€‚å®ƒå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œå³åˆ†é…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¡çœ </li><li>GFP_ATOMIC: è°ƒç”¨è€…ä¸èƒ½ç¡çœ å¹¶ä¸”ä¿è¯åˆ†é…ä¼šæˆåŠŸã€‚å®ƒå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™çš„å†…å­˜</li><li>GFP_NOWAIT: åˆ†é…ä¸­ä¸å…è®¸ç¡çœ ç­‰å¾…</li><li>GFP_NOFS: ä¸ä¼šè®¿é—®ä»»ä½•çš„æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£å’Œæ“ä½œ</li><li>GFP_NOIO: ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„ I/O æ“ä½œã€‚å¦‚ä½¿ç”¨ç›´æ¥å›æ”¶æœºåˆ¶ä¸¢å¼ƒå¹²å‡€çš„é¡µé¢æˆ–è€…ä¸º slab åˆ†é…çš„é¡µé¢</li><li>GFP_USER: é€šå¸¸ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ç”¨æ¥åˆ†é…å†…å­˜ï¼Œè¿™äº›å†…å­˜å¯ä»¥è¢«å†…æ ¸æˆ–è€…ç¡¬ä»¶ä½¿ç”¨ã€‚å¸¸ç”¨çš„ä¸€ä¸ªåœºæ™¯æ˜¯ç¡¬ä»¶ä½¿ç”¨çš„ DMA ç¼“å†²å™¨è¦æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¦‚æ˜¾å¡çš„ç¼“å†²å™¨</li><li>GFP_DMA/ GFP_DMA32: ä½¿ç”¨ ZONE_DMA æˆ–è€… ZONE_DMA32 æ¥åˆ†é…å†…å­˜</li><li>GFP_HIGHUSER: ç”¨æˆ·ç©ºé—´è¿›ç¨‹ç”¨æ¥åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ ZONE_HIGHMEMï¼Œè¿™äº›å†…å­˜å¯ä»¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå†…æ ¸ç©ºé—´ä¸ä¼šç›´æ¥è®¿é—®è¿™äº›å†…å­˜ã€‚å¦å¤–ï¼Œè¿™äº›å†…å­˜ä¸èƒ½è¿ç§»</li><li>GFP_HIGHUSER_MOVABLE: ç±»ä¼¼äº GFP_HIGHUSERï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</li><li>GFP_TRANSHUGE / GFP_TRANSHUGE_LIGHT: é€šå¸¸ç”¨äºé€æ˜é¡µé¢åˆ†é…</li></ul><p>ä¸Šé¢è¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„ç±»å‹æ ‡å¿—ï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹ã€‚</p><ul><li>GFP_KERNEL ä¸»è¦ç”¨äºåˆ†é…å†…æ ¸ä½¿ç”¨çš„å†…å­˜ï¼Œåœ¨åˆ†é…è¿‡ç¨‹ä¸­ä¼šå¼•èµ·ç¡çœ ï¼Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡å’Œä¸èƒ½ç¡çœ çš„å†…æ ¸è·¯å¾„é‡Œä½¿ç”¨è¯¥ç±»å‹æ ‡å¿—éœ€è¦ç‰¹åˆ«è­¦æƒ•ï¼Œå› ä¸ºè¿™ä¼šå¼•èµ·æ­»é”æˆ–è€…å…¶ä»–ç³»ç»Ÿå¼‚å¸¸ã€‚</li><li>GFP_ATOMIC æ­£å¥½å’Œ GFP_KERNEL ç›¸åï¼Œå®ƒå¯ä»¥ä½¿ç”¨åœ¨ä¸èƒ½ç¡çœ çš„å†…å­˜åˆ†é…è·¯å¾„ï¼ˆå¦‚ä¸­æ–­å¤„ç†ç¨‹åºã€è½¯ä¸­æ–­ä»¥åŠ tasklet ç­‰ï¼‰ä¸­ã€‚GFP_KERNEL å¯ä»¥è®©è°ƒç”¨è€…ç¡çœ ç­‰å¾…ç³»ç»Ÿé¡µé¢å›æ”¶æ¥é‡Šæ”¾ä¸€æ­¤å†…å­˜ï¼Œä½† GFP_ATOMIC ä¸å¯ä»¥ï¼Œæ‰€ä»¥å¯èƒ½ä¼šåˆ†é…å¤±è´¥ã€‚</li><li>GFP_USERã€ GFP_HIGHUSER å’Œ GFP_HIGHUSER_MOVABLE è¿™å‡ ä¸ªç±»å‹æ ‡å¿—éƒ½æ˜¯ä¸ºç”¨æˆ·ç©ºé—´è¿›ç¨‹åˆ†é…å†…å­˜çš„ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒGFP_HIGHUSER é¦–å…ˆä½¿ç”¨é«˜ç«¯å†…å­˜ï¼ŒGFP_HIGHUSER MOVABLE ä¼˜å…ˆä½¿ç”¨é«˜ç«¯å†…å­˜å¹¶ä¸”åˆ†é…çš„å†…å­˜å…·æœ‰å¯ç§»åŠ¨å±æ€§ã€‚</li><li>GFP_NOIO å’Œ GFP_NOFS éƒ½ä¼šäº§ç”Ÿé˜»å¡ï¼Œå®ƒä»¬ç”¨äºé¿å…æŸäº›å…¶ä»–çš„æ“ä½œã€‚GFPNOIO è¡¨ç¤ºåˆ†é…è¿‡ç¨‹ä¸­ç»ä¸ä¼šå¯åŠ¨ä»»ä½•ç£ç›˜ I/O çš„æ“ä½œã€‚GFP_NOFS è¡¨ç¤ºå¯ä»¥å¯åŠ¨ç£ç›˜ I/Oï¼Œä½†æ˜¯ä¸ä¼šå¯åŠ¨æ–‡ä»¶ç³»ç»Ÿçš„ç›¸å…³æ“ä½œã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾è¿›ç¨‹ A åœ¨æ‰§è¡Œæ‰“å¼€æ–‡ä»¶çš„æ“ä½œä¸­éœ€è¦åˆ†é…å†…å­˜ä½†å†…å­˜çŸ­ç¼ºï¼Œé‚£ä¹ˆè¿›ç¨‹ A ä¼šç¡çœ ç­‰å¾…ï¼Œç³»ç»Ÿçš„ OOM Killer æœºåˆ¶ä¼šé€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥ç»ˆæ­¢ã€‚å‡è®¾é€‰æ‹©äº†è¿›ç¨‹ Bï¼Œè€Œè¿›ç¨‹ B é€€å‡ºæ—¶éœ€è¦æ‰§è¡Œä¸€äº›æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œï¼Œè¿™äº›æ“ä½œå¯èƒ½ä¼šç”³è¯·é”ï¼Œè€Œæ°å·§è¿›ç¨‹ A æŒæœ‰è¿™ä¸ªé”ï¼Œæ‰€ä»¥æ­»é”å°±å‘ç”Ÿäº†ã€‚</li><li>GFP_KERNEL åˆ†é…çš„é¡µé¢é€šå¸¸æ˜¯ä¸å¯è¿ç§»çš„ï¼ŒGFP_HIGHUSER_MOVABLE åˆ†é…çš„é¡µé¢æ˜¯å¯è¿ç§»çš„ã€‚</li></ul><h1 id="alloc_pages-å‡½æ•°">alloc_pages() å‡½æ•°</h1><p>ä¸‹é¢ä»¥ GFP_KERNEL ä¸ºä¾‹ï¼Œçœ‹åœ¨ç†æƒ³æƒ…å†µä¸‹ alloc_pages() å‡½æ•°æ˜¯å¦‚ä½•åˆ†é…ç‰©ç†å†…å­˜çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€Šåˆ†é…ç‰©ç†å†…å­˜çš„ä¾‹å­ã€‹</span><br><span class="line">page = alloc_pages(GFP_KERNEL, order);</span><br></pre></td></tr></tbody></table></figure><p>GFP_KERNEL ç±»å‹æ ‡å¿—å®šä¹‰åœ¨ gfp.h å¤´æ–‡ä»¶ä¸­ï¼Œæ˜¯ä¸€ä¸ªæ ‡å¿—ç»„åˆã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_KERNEL(__GFP_RECLAIM | __GFP_IO | __GFP_FS)</span></span><br></pre></td></tr></tbody></table></figure><p>æ‰€ä»¥ GFP_KERNEL ç±»å‹æ ‡å¿—åŒ…å«äº†__GFP_RECLAIMã€__GFP_IO å’Œ__GFP_FS è¿™ 3 ä¸ªæ ‡å¿—ï¼Œå…¶åœ°å€æ¢ç®—æˆåå…­è¿›åˆ¶æ˜¯ 0x60 00 C0ã€‚</p><p>å…¶å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/alloc_pages.png"></p><h1 id="å°ç»“">å°ç»“</h1><p>é¡µé¢åˆ†é…å™¨æ˜¯ Linux å†…æ ¸å†…å­˜ç®¡ç†ä¸­æœ€åŸºæœ¬çš„åˆ†é…å™¨ï¼Œä¼™ä¼´ç³»ç»Ÿåˆ†é…é¡µé¢å°±æ˜¯ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œç†è§£é¡µé¢åˆ†é…å™¨éœ€è¦å…³æ³¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ã€‚</p><ul><li>ä»åˆ†é…æ©ç ä¸­çŸ¥é“å¯ä»¥ä»å“ªäº› zone ä¸­åˆ†é…å†…å­˜ï¼Œåˆ†é…å†…å­˜çš„å±æ€§å±äºå“ªäº› MIGRATE_TYPES ç±»å‹ã€‚</li><li>é¡µé¢åˆ†é…æ—¶åº”ä»å“ªä¸ªæ–¹å‘æ¥æ‰«æ zoneã€‚</li><li>zone æ°´ä½çš„åˆ¤æ–­ã€‚</li></ul><p>æœ¬èŠ‚ä»‹ç»äº†ç†æƒ³æƒ…å†µä¸‹é¡µé¢åˆ†é…å™¨å¦‚ä½•åˆ†é…ç‰©ç†é¡µé¢ï¼Œä½†æ˜¯åœ¨ Linux å†…æ ¸å¤„äºå†…å­˜çŸ­ç¼ºçš„æƒ…å†µä¸‹åˆè¯¥å¦‚ä½•åˆ†é…å†…å­˜å‘¢ï¼Ÿè¿™æ¶‰åŠå†…å­˜ç®¡ç†ä¸­æœ€éš¾çš„å‡ ä¸ªä¸»é¢˜ï¼Œå¦‚é¡µé¢å›æ”¶ã€ç›´æ¥å†…å­˜å›æ”¶å†…å­˜è§„æ•´å’Œ OOM Killer æœºåˆ¶ç­‰ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆå››ï¼‰è™šæ‹Ÿå†…å­˜ç®¡ç†</title>
      <link href="/2021/LinuxKernel/LinuxMemoryPageMngr/"/>
      <url>/2021/LinuxKernel/LinuxMemoryPageMngr/</url>
      
        <content type="html"><![CDATA[<h1 id="é¡µè¡¨å¯»å€è¿‡ç¨‹">é¡µè¡¨å¯»å€è¿‡ç¨‹</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/pagefindAddress.png"></p><p>è¿™é‡Œå°±æ˜¯ cpu å°†ä¸€ä¸ªè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€çš„è¿‡ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒç¹çè€—æ—¶çš„ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬åœ¨ä¸€ä¸ªä¸“é—¨çš„ç¡¬ä»¶ä¸­å®Œæˆå°±æ˜¯ MMUã€MMU ä¸­ä¸ºäº†å¯ä»¥åŠ å¿«é€Ÿåº¦å¼•å…¥äº† TLB cache å¿«é€ŸæŸ¥æ‰¾ pteã€‚æˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°ä¸€ç‚¹å°±æ˜¯åˆ°äº† PTE è¿™ä¸€çº§éœ€è¦æä¾›çš„æ˜¯ç‰©ç†åœ°å€çš„é¡µèµ·å§‹åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä»¥ page size ä¸ºå•ä½çš„ï¼Œå¯¹äº 4k çš„ pageï¼Œé‚£ä¹ˆ pte çš„ä½ 12bit å°±æ˜¯æ²¡æœ‰ä½¿ç”¨çš„ï¼Œè€Œè¿™ 12bit å°±æ­£å¥½ç”¨æ¥ä½œä¸º page çš„æƒé™æ§åˆ¶ä½ï¼Œå¯¹äº ARM64ï¼ˆ39bit vaï¼‰å…¶é«˜ä½ [40-63] ä¹Ÿæ²¡æœ‰ä½¿ç”¨å› æ­¤ä¹Ÿå¯ä»¥ç”¨æ¥åšä¸€äº›å…¶ä»–äº‹æƒ…ã€‚è¿™é‡Œæ¥çœ‹çœ‹ arm-v8 å¯¹ä½ 12bit çš„å®šä¹‰ï¼š</p><span id="more"></span><p>ã€ŠArchitecture Reference Manual ARMv8, for ARMv8-A architecture profileã€‹é‡Œçš„ D4.3.2 ARMv8 translation table level 3 descriptor formats ä¸€èŠ‚ä¸­æœ‰ç›¸å…³æè¿°ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/VMSAV8-64.png"></p><p>ARM-v8 æ”¯æŒ 5 ç§ L3 é¡µè¡¨æ ¼å¼ï¼Œå…¶ä¸­æˆ‘ä»¬å…³å¿ƒçš„æ˜¯ Page 4K granule è¿™ä¸€ç§ï¼Œå¯¹æ­¤æœ‰å¦‚ä¸‹è¯´æ˜ï¼š</p><ul><li><strong>Bit 0ï¼š</strong> Value bitï¼Œ1 is valued and 0 is invaled</li><li><strong>Bit 1ï¼š</strong> identifies the descriptor typeï¼› 0 is Reserved, invalid and 1 is Page<ul><li><p><strong>4KB translation granule</strong></p><p>Bits[47:12] are bits[47:12] of the output address for a page of memory.</p></li><li><p><strong>16KB translation granule</strong></p><p>Bits[47:14] are bits[47:14] of the output address for a page of memory.</p></li><li><p><strong>64KB translation granule</strong></p><p>Bits[47:16] are bits[47:16] of the output address for a page of memory.</p></li></ul></li><li><p><strong>Lower attributesï¼š</strong>ï¼ˆAttribute fields in stage 1 VMSAv8-64 Block and Page descriptorsï¼‰ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/AttributeFieldsForVMSAv8.png"></p></li><li><p><strong>UXN or XN, bit[54] ï¼ˆ</strong>é¡µé¢åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ä¸èƒ½æ‰§è¡Œ<strong>ï¼‰</strong></p><p>This bit is called UXN (Unprivileged execute never) in the EL1&amp;0 translation regime, where it only determines whether execution at EL0 of instructions fetched from the region is permitted. In the other translation regimes the bit is called XN (Execute never).</p></li><li><p>**PXN, bit<a href="**è¯¥é¡µé¢åœ¨ç‰¹æƒæ¨¡å¼ä¸‹ä¸èƒ½æ‰§è¡Œ">53</a></p><p>The Privileged execute-never bit. Determines whether the region is executable at EL1ã€‚</p></li><li><p><strong>Contiguous, bit[52] ï¼ˆ</strong>è¡¨ç¤ºå½“å‰é¡µè¡¨é¡¹å¤„åœ¨ä¸€ä¸ªè¿ç»­ç‰©ç†é¡µé¢é›†åˆä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•ä¸€çš„ TLB è¡¨é¡¹è¿›è¡Œä¼˜åŒ–<strong>ï¼‰</strong></p><p>A hint bit indicating that the translation table entry is one of a contiguous set or entries, that might be cached in a single TLB entryã€‚</p></li><li><p><strong>nG, bit<a href="éå…¨å±€æ¯”ç‰¹ä½ï¼Œ**ç”¨äº%20TLB%20ç®¡ç†ã€‚TLB%20çš„è¡¨é¡¹åˆ†æˆå…¨å±€çš„å’Œè¿›ç¨‹æŒæœ‰çš„ã€‚å½“è®¾ç½®è¯¥æ¯”ç‰¹ä½æ—¶è¡¨ç¤ºè¿™ä¸ªé¡µé¢å¯¹åº”çš„%20TLB%20è¡¨é¡¹æ˜¯è¿›ç¨‹æŒæœ‰çš„**">11</a></strong></p><p>The not global bit. Determines whether the TLB entry applies to all ASID values, or only to the current ASID valueã€‚</p></li><li><p>**AF, bit<a href="**å½“ç¬¬ä¸€æ¬¡è®¿é—®é¡µé¢æ—¶ç¡¬ä»¶ä¼šè‡ªåŠ¨è®¾ç½®è¿™ä¸ªè®¿é—®æ¯”ç‰¹ä½">10</a></p><p>The Access flagã€‚</p></li><li><p><strong>SH å†…å­˜ç¼“å­˜å…±äº«å±æ€§</strong></p><p>Shareability field</p><ul><li>00ï¼šæ²¡æœ‰å…±äº«</li><li>01ï¼šä¿ç•™</li><li>10ï¼šOuter Shareable</li><li>11ï¼šInner Shareable</li></ul></li><li><strong>AP[2:1]</strong><ul><li>AP[1]: è¡¨ç¤ºè¯¥å†…å­˜å…è®¸ç”¨æˆ·æƒé™ (EL0) è¿˜æ˜¯æ›´é«˜æƒé™çš„ç‰¹æƒå¼‚å¸¸ç­‰çº§ (EL1) æ¥è®¿é—®ã€‚<ul><li>1ï¼šè¡¨ç¤ºå¯ä»¥è¢« EL0 ä»¥åŠæ›´é«˜ç‰¹æƒçš„å¼‚å¸¸ç­‰çº§è®¿é—®</li><li>0ï¼šè¡¨ç¤ºä¸èƒ½è¢« EL0 è®¿é—®ï¼Œä½†æ˜¯å¯ä»¥è¢« EL1 è®¿é—®</li></ul></li><li>AP[2]: åªè¯»æƒé™è¿˜æ˜¯å¯è¯»å¯å†™æƒé™<ul><li>1ï¼šè¡¨ç¤ºåªè¯»</li><li>0ï¼šè¡¨ç¤ºå¯è¯»å¯å†™</li></ul></li></ul><p>Data Access Permissions bits</p></li><li><p><strong>NS, bit[5] ï¼ˆ</strong>éå®‰å…¨æ¯”ç‰¹ä½ã€‚å½“å¤„äºå®‰å…¨æ¨¡å¼æ—¶ç”¨æ¥æŒ‡å®šè®¿é—®çš„å†…å­˜åœ°å€æ˜¯å®‰å…¨æ˜ å°„çš„è¿˜æ˜¯éå®‰å…¨æ˜ å°„çš„<strong>ï¼‰</strong></p><p>Non-secure bit. For memory accesses from Secure state, specifies whether the output address is in the Secure or Non-secure address map</p></li><li><p><strong>AttrIndx[2:0], bits<a href="å†…å­˜çš„å±æ€§ã€è®¾å¤‡å†…å­˜ã€æ™®é€šå†…å­˜ç­‰">4:2</a></strong></p><p>Stage 1 memory attributes index field</p><ul><li>0ï¼šDEVICE_nGnRnE</li><li>1ï¼šDEVICE_nGnRE</li><li>2ï¼šDEVICE_GRE</li><li>3ï¼šNORMAL_NC</li><li>4ï¼šNORMAL</li><li>5ï¼šNORMAL_WT</li></ul></li></ul><h1 id="åœ¨-linux-ä¸‹çš„å®šä¹‰">åœ¨ linux ä¸‹çš„å®šä¹‰</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/pgtable-hwdef.h&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Level 3 descriptor (PTE).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_VALID(_AT(pteval_t, 1) &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_TYPE_MASK(_AT(pteval_t, 3) &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_TYPE_PAGE(_AT(pteval_t, 3) &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_TABLE_BIT(_AT(pteval_t, 1) &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_USER(_AT(pteval_t, 1) &lt;&lt; 6)<span class="comment">/* AP[1] */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_RDONLY(_AT(pteval_t, 1) &lt;&lt; 7)<span class="comment">/* AP[2] */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_SHARED(_AT(pteval_t, 3) &lt;&lt; 8)<span class="comment">/* SH[1:0], inner shareable */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_AF(_AT(pteval_t, 1) &lt;&lt; 10)<span class="comment">/* Access Flag */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_NG(_AT(pteval_t, 1) &lt;&lt; 11)<span class="comment">/* nG */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_GP(_AT(pteval_t, 1) &lt;&lt; 50)<span class="comment">/* BTI guarded */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_DBM(_AT(pteval_t, 1) &lt;&lt; 51)<span class="comment">/* Dirty Bit Management */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_CONT(_AT(pteval_t, 1) &lt;&lt; 52)<span class="comment">/* Contiguous range */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_PXN(_AT(pteval_t, 1) &lt;&lt; 53)<span class="comment">/* Privileged XN */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_UXN(_AT(pteval_t, 1) &lt;&lt; 54)<span class="comment">/* User XN */</span></span></span><br></pre></td></tr></tbody></table></figure><h2 id="æ•´ä½“åˆå§‹åŒ–æµç¨‹">æ•´ä½“åˆå§‹åŒ–æµç¨‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/VMMstartKernel.png"></p><h1 id="idmp-æ˜ å°„æ’ç­‰æ˜ å°„ä¸ºäº†å¼€å¯-mmu">idmp æ˜ å°„ï¼ˆæ’ç­‰æ˜ å°„ï¼Œä¸ºäº†å¼€å¯ MMUï¼‰</h1><p>textï¼š__idmap_text_start~__idmap_text_end</p><p>dataï¼šidmap_pg_dir~idmap_pg_end</p><p>ä¸€æ—¦å¯åŠ¨ MMU å°±éœ€è¦ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œç°ä»£å¤„ç†å™¨å¤§å¤šæ•°æ˜¯å¤šçº§æµæ°´çº¿ï¼Œå¤„ç†å™¨ä¼šæå‰é¢„å–å¤šæ¡æŒ‡ä»¤åˆ°æµæ°´çº¿ä¸­ï¼Œæ‰“å¼€ MMU æ—¶ï¼Œè¿™äº›æŒ‡ä»¤éƒ½æ˜¯ç‰©ç†åœ°å€é¢„å–çš„ï¼›åœ¨ MMU å¼€å¯åï¼Œå°†ä»¥è™šæ‹Ÿåœ°å€è®¿é—®ï¼Œè¿™æ ·å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥å¼•å…¥äº†â€œæ’ç­‰æ˜ å°„â€ï¼Œå³åœ¨è¿‡æ¸¡é˜¶æ®µçš„ä»£ç ï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ç›¸ç­‰ã€‚æ’ç­‰æ˜ å°„å®Œæˆåï¼Œå°±å¯åŠ¨ MMUï¼Œè¿›å…¥è™šæ‹Ÿåœ°å€è®¿é—®é˜¶æ®µã€‚æ’ç­‰æ˜ å°„çš„ä»£ç åœ¨ __idmap_text_start~__idmap_text_endï¼Œå¯ä»¥ä» System.map æ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ffffffc081206000 T __idmap_text_start</span><br><span class="line">ffffffc081206000 t enter_vhe</span><br><span class="line">ffffffc081206038 T cpu_resume</span><br><span class="line">ffffffc081206068 T primary_entry</span><br><span class="line">ffffffc0812060a8 T init_kernel_el</span><br><span class="line">ffffffc0812060b8 t init_el1</span><br><span class="line">ffffffc0812060e0 t init_el2</span><br><span class="line">ffffffc0812062f0 T secondary_holding_pen</span><br><span class="line">ffffffc081206318 t pen</span><br><span class="line">ffffffc081206330 T secondary_entry</span><br><span class="line">ffffffc081206340 t secondary_startup</span><br><span class="line">ffffffc081206368 T __enable_mmu</span><br><span class="line">ffffffc0812063b0 T __cpu_secondary_check52bitva</span><br><span class="line">ffffffc0812063b8 t __no_granule_support</span><br><span class="line">ffffffc0812063e0 t __relocate_kernel</span><br><span class="line">ffffffc081206430 t __primary_switch</span><br><span class="line">ffffffc0812064a0 T idmap_cpu_replace_ttbr1</span><br><span class="line">ffffffc0812064d0 T idmap_kpti_install_ng_mappings</span><br><span class="line">ffffffc08120667c t __idmap_kpti_secondary</span><br><span class="line">ffffffc0812066c8 T __cpu_setup</span><br><span class="line">ffffffc0812067bc T __idmap_text_end</span><br></pre></td></tr></tbody></table></figure><p>æ’ç­‰æ˜ å°„ç›®çš„å°±æ˜¯ä¸º__idmap_text_start~__idmap_text_end è¿™æ®µä»£ç åˆ›å»ºä¸€ä¸ªæ˜ å°„é¡µè¡¨ï¼Œä½¿å…¶è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ç›¸ç­‰çš„ã€‚åœ¨ vmlinux.lds.S ä¸­ï¼Œäº‹å…ˆå·²ç»åˆ†é…äº† IDMAP_DIR_SIZE çš„ç©ºé—´ç”¨äºå­˜å‚¨é¡µè¡¨ï¼Œé€šå¸¸é¡µè¡¨ä¸º 3 ä¸ªè¿ç»­çš„ 4KB é¡µé¢ï¼Œåˆ†åˆ«å¯¹äº PGD,PUD,PMD é¡µè¡¨ï¼Œè¿™é‡Œæ²¡æœ‰ä½¿ç”¨ PTEï¼Œæ‰€ä»¥ç²’åº¦æ˜¯ 2MB çš„å¤§å°ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init_idmap_pg_dir = .;</span><br><span class="line">. += INIT_IDMAP_DIR_SIZE;</span><br><span class="line">init_idmap_pg_end = .;</span><br></pre></td></tr></tbody></table></figure><h1 id="ç²—ç²’åº¦çš„å†…æ ¸æ˜ åƒæ˜ å°„ä¸ºäº†è¿›å…¥å†…æ ¸ç©ºé—´">ç²—ç²’åº¦çš„å†…æ ¸æ˜ åƒæ˜ å°„ï¼ˆä¸ºäº†è¿›å…¥å†…æ ¸ç©ºé—´ï¼‰</h1><p>text: kernel_text</p><p>dataï¼šinit_pg_dir~init_pg_endï¼ˆå®šä¹‰åœ¨ arch/arm64/kernel/vmlinux.lds.S é“¾æ¥æ–‡ä»¶ä¸­ï¼‰</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">init_pg_dir = .;</span><br><span class="line">. += INIT_DIR_SIZE;</span><br><span class="line">init_pg_end = .;</span><br><span class="line">/* end of zero-init region */</span><br></pre></td></tr></tbody></table></figure><p>ä¹‹æ‰€ä»¥è¦åˆ›å»ºç¬¬äºŒä¸ªé¡µè¡¨ï¼Œæ˜¯å› ä¸º cpu åˆšå¯åŠ¨æ—¶ï¼Œç‰©ç†å†…å­˜ä¸€èˆ¬éƒ½åœ¨ä½åœ°å€ï¼ˆä¸ä¼šè¶…è¿‡ 256TBï¼‰ï¼Œæ’ç­‰æ˜ å°„çš„åœ°å€å®é™…ä¹Ÿåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå³ MMU å¯ç”¨å idmap_pg_dir ä¼šå¡«å…¥ TTBR0ï¼Œè€Œå†…æ ¸ç©ºé—´é“¾æ¥åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰éƒ½æ˜¯åœ¨é«˜åœ°å€ï¼Œéœ€è¦å¡«å…¥ TTBR1ï¼Œå› æ­¤éœ€è¦å†åˆ›å»ºä¸€å¼ è¡¨ï¼Œæ˜ å°„æ•´ä¸ªå†…æ ¸é•œåƒï¼Œä¸”è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯åœ¨é«˜åœ°å€ 0xffff xxxx xxxx xxxxarch/arm64/kernel/head.S:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adrp x1, _text</span><br><span class="line">adrp x2, init_pg_dir</span><br><span class="line">adrp x3, init_pg_end</span><br><span class="line">bic x4, x2, #SWAPPER_BLOCK_SIZE - 1</span><br><span class="line">mov_q x5, SWAPPER_RW_MMUFLAGS</span><br><span class="line">mov x6, #SWAPPER_BLOCK_SHIFT</span><br><span class="line">bl remap_region</span><br></pre></td></tr></tbody></table></figure><h2 id="æµç¨‹">æµç¨‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/primaryEntry.png"></p><h1 id="fixmap-æ˜ å°„">fixmap æ˜ å°„</h1><p>Linux å†…æ ¸è¦è®¿é—®ç‰©ç†å†…å­˜ï¼Œä¸€æ—¦å¼€å¯ MMU åï¼Œå°±åªèƒ½é€šè¿‡è™šæ‹Ÿåœ°å€æŸ¥è¯¢é¡µè¡¨æ‰¾åˆ°ç‰©ç†åœ°å€è¿›è¡Œè®¿é—®ï¼Œä¸Šä¸€ç« èŠ‚ä¸­å»ºç«‹æ’ç­‰æ˜ å°„å’Œç²—ç²’åº¦å†…æ ¸æ˜ åƒæ˜ å°„çš„é¡µè¡¨ï¼Œå› æ­¤åªèƒ½ä¿è¯å†…æ ¸é•œåƒæ­£å¸¸è®¿é—®ã€‚å¦‚æœè¦è§£æ DTBï¼Œè®¿é—®è®¾å¤‡ I/O ç­‰ä¾ç„¶æ˜¯æ— æ³•è®¿é—®çš„ï¼Œå› ä¸ºæŸ¥è¯¢ä¸åˆ°å¯¹åº”çš„é¡µè¡¨ã€‚å› æ­¤å†…æ ¸å¼•å…¥äº† fixmap æœºåˆ¶ï¼Œå°±æ˜¯äº‹å…ˆåˆ†é…ä¸€æ®µè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åç»™å®šå…¶è™šæ‹Ÿåœ°å€åˆ›å»ºå¥½é¡µè¡¨ï¼Œé¡µè¡¨ä¸­çš„è¡¨é¡¹æœ€åä¸€çº§æŒ‡å‘çš„ç‰©ç†é¡µå¸§å·å…ˆä¸å¡«å……ï¼Œç­‰åˆ°å®é™…è¦è®¿é—®é‚£æ®µç‰©ç†å†…å­˜åå†å°†å…¶å¡«å……ï¼Œç„¶åé€šè¿‡ fixmap è¿™æ®µè™šæ‹Ÿåœ°å€èŒƒå›´å°±å¯ä»¥é€šè¿‡æŸ¥è¯¢é¡µè¡¨è®¿é—®åˆ°ç‰©ç†å†…å­˜ã€‚ Fixmap æœ€å…³é”®è¦å®ç°çš„ç›®çš„å°±æ˜¯å°†ä¸€æ®µç©ºé—´çš„è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€å¯¹åº”ä¸Šï¼Œlinux å†…æ ¸é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®åˆ°ç‰©ç†ç©ºé—´ï¼Œé‚£æ—¢ç„¶æ˜¯é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®åˆ°ç‰©ç†åœ°å€ï¼Œé‚£å¿…é¡»æ„å»ºå¡«å……è¿™æ®µè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„é¡µè¡¨ï¼Œè¿™æ · Linux å†…æ ¸ç»è¿‡ MMU åˆ©ç”¨æŸ¥æ‰¾é¡µè¡¨æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€è¿›è¡Œè®¿é—®ã€‚</p><p>fixmap è™šæ‹Ÿåœ°å€ç©ºé—´åˆè¢«å¹³å‡åˆ†æˆä¸¤ä¸ªéƒ¨åˆ† permanent fixed addresses å’Œ temporary fixed addressesã€‚permanent fixed addresses æ˜¯æ°¸ä¹…æ˜ å°„ï¼Œtemporary fixed addresses æ˜¯ä¸´æ—¶æ˜ å°„ã€‚æ°¸ä¹…æ˜ å°„æ˜¯æŒ‡åœ¨å»ºç«‹çš„æ˜ å°„å…³ç³»åœ¨ kernel é˜¶æ®µä¸ä¼šæ”¹å˜ï¼Œä»…ä¾›ç‰¹å®šæ¨¡å—ä¸€ç›´ä½¿ç”¨ã€‚ä¸´æ—¶æ˜ å°„å°±æ˜¯æ¨¡å—ä½¿ç”¨å‰åˆ›å»ºæ˜ å°„ï¼Œä½¿ç”¨åè§£é™¤æ˜ å°„ã€‚</p><p>fixmap åŒºåŸŸåˆè¢«ç»§ç»­ç»†åˆ†ï¼Œåˆ†é…ç»™ä¸åŒæ¨¡å—ä½¿ç”¨ã€‚kernel ä¸­å®šä¹‰æšä¸¾ç±»å‹ä½œä¸º indexï¼Œæ ¹æ® index å¯ä»¥è®¡ç®—è¯¥æ¨¡æ‹Ÿåœ¨ fixmap åŒºåŸŸçš„è™šæ‹Ÿåœ°å€ã€‚ </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fixed_addresses</span> {</span></span><br><span class="line">FIX_HOLE,</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Reserve a virtual window for the FDT that is a page bigger than the</span></span><br><span class="line"><span class="comment"> * maximum supported size. The additional space ensures that any FDT</span></span><br><span class="line"><span class="comment"> * that does not exceed MAX_FDT_SIZE can be mapped regardless of</span></span><br><span class="line"><span class="comment"> * whether it crosses any page boundary.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FIX_FDT_END,</span><br><span class="line">FIX_FDT = FIX_FDT_END + DIV_ROUND_UP(MAX_FDT_SIZE, PAGE_SIZE) + <span class="number">1</span>, <span class="comment">// æ˜ å°„è®¾å¤‡æ ‘ä½¿ç”¨ã€‚åœ¨ ARM64 æ¶æ„ï¼Œå¤§å°æ˜¯ 4M</span></span><br><span class="line"></span><br><span class="line">FIX_EARLYCON_MEM_BASE, <span class="comment">// console ä½¿ç”¨ï¼Œå¤§å° 1 é¡µã€‚1 é¡µè™šæ‹Ÿåœ°å€ç©ºé—´å®Œå…¨å¤Ÿäº†</span></span><br><span class="line">FIX_TEXT_POKE0,</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ACPI_APEI_GHES</span></span><br><span class="line"><span class="comment">/* Used for GHES mapping from assorted contexts */</span></span><br><span class="line">FIX_APEI_GHES_IRQ,</span><br><span class="line">FIX_APEI_GHES_SEA,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM_SDE_INTERFACE</span></span><br><span class="line">FIX_APEI_GHES_SDEI_NORMAL,</span><br><span class="line">FIX_APEI_GHES_SDEI_CRITICAL,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_ACPI_APEI_GHES */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_UNMAP_KERNEL_AT_EL0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_RELOCATABLE</span></span><br><span class="line">FIX_ENTRY_TRAMP_TEXT4,<span class="comment">/* one extra slot for the data page */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">FIX_ENTRY_TRAMP_TEXT3,</span><br><span class="line">FIX_ENTRY_TRAMP_TEXT2,</span><br><span class="line">FIX_ENTRY_TRAMP_TEXT1,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRAMP_VALIAS(__fix_to_virt(FIX_ENTRY_TRAMP_TEXT1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_UNMAP_KERNEL_AT_EL0 */</span></span></span><br><span class="line">__end_of_permanent_fixed_addresses,</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Temporary boot-time mappings, used by early_ioremap(),</span></span><br><span class="line"><span class="comment"> * before ioremap() is functional.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_FIX_BTMAPS(SZ_256K / PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIX_BTMAPS_SLOTS7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOTAL_FIX_BTMAPS(NR_FIX_BTMAPS * FIX_BTMAPS_SLOTS)</span></span><br><span class="line"></span><br><span class="line">FIX_BTMAP_END = __end_of_permanent_fixed_addresses,</span><br><span class="line">FIX_BTMAP_BEGIN = FIX_BTMAP_END + TOTAL_FIX_BTMAPS - <span class="number">1</span>, <span class="comment">// early_ioremap() æ¥å£ä½¿ç”¨ï¼Œè¿™éƒ¨åˆ†å±äºåŠ¨æ€æ˜ å°„ã€‚å¤§å°æ˜¯ 7 Ã— 256KB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Used for kernel page table creation, so unmapped memory may be used</span></span><br><span class="line"><span class="comment"> * for tables.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FIX_PTE,</span><br><span class="line">FIX_PMD,</span><br><span class="line">FIX_PUD,</span><br><span class="line">FIX_P4D,</span><br><span class="line">FIX_PGD,</span><br><span class="line"></span><br><span class="line">__end_of_fixed_addresses</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="fixmap-æ˜ å°„æµç¨‹">Fixmap æ˜ å°„æµç¨‹</h2><p>fixmap åˆå§‹åŒ–æ“ä½œåœ¨ early_fixmap_init å‡½æ•°ä¸­å®Œæˆã€‚ä¸»è¦æ˜¯å»ºç«‹ PGD/PUD/PMD é¡µè¡¨ã€‚fixmap æ˜ å°„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">start_kernel</span><br><span class="line">--&gt;setup_arch</span><br><span class="line">--&gt;early_fixmap_init</span><br><span class="line">--&gt;early_fixmap_init_pud <span class="comment">// é¡µè¡¨å­˜åœ¨ bm_pud</span></span><br><span class="line">--&gt;early_fixmap_init_pmd <span class="comment">// é¡µè¡¨å­˜åœ¨ bm_pmd</span></span><br><span class="line">--&gt;early_fixmap_init_pte <span class="comment">// é¡µè¡¨å­˜åœ¨ bm_pte</span></span><br><span class="line">--&gt;early_ioremap_init <span class="comment">// kernel å¯åŠ¨æ—©æœŸä¸èƒ½ä½¿ç”¨ ioremap æ“ä½œï¼Œæˆ‘ä»¬å¿…é¡»å€ŸåŠ© early_ioremap æ¥å£</span></span><br><span class="line">--&gt;early_ioremap_setup</span><br><span class="line">--&gt;slot_virt[i] = __fix_to_virt(FIX_BTMAP_BEGIN - NR_FIX_BTMAPS*i)</span><br></pre></td></tr></tbody></table></figure><p>early ioremap åˆ©ç”¨ slot ç®¡ç†æ˜ å°„ï¼Œæœ€å¤šæ”¯æŒ FIX_BTMAPS_SLOTS ä¸ªæ˜ å°„ï¼Œæ¯ä¸ªæ˜ å°„æœ€å¤§æ”¯æŒæ˜ å°„ 256KBã€‚slot_virt æ•°ç»„å­˜å‚¨æ¯ä¸ª slot çš„è™šæ‹Ÿåœ°å€é¦–åœ°å€ã€‚prev_map æ•°ç»„ç”¨æ¥è®°å½•å·²ç»åˆ†é…å‡ºå»çš„è™šæ‹Ÿåœ°å€ï¼Œæ•°ç»„å€¼ä¸º 0 ä»£è¡¨æ²¡æœ‰åˆ†é…ã€‚prev_size è®°å½•æ˜ å°„çš„ sizeã€‚ å…¶ä¸­ bm_pudã€bm_pmd å’Œ bm_pte éƒ½åœ¨å†…æ ¸ image çš„å…¨å±€æ•°ç»„ä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨ã€‚data æ®µä¸­ï¼Œåœ¨ idmp æ˜ å°„é˜¶æ®µå¯¹å†…æ ¸åšä¸€ä¸ªç²—ç²’åº¦çš„æ˜ å°„ï¼Œåœ¨è¿™ä¸ªæ˜ å°„åå°±å¯ä»¥é€šè¿‡ mmu è®¿é—®å†…æ ¸æ•°æ®äº†ã€‚è¿™é‡Œæ­£å¥½åˆ©ç”¨è¿™ä¸ªå»ºç«‹ fixmap æ˜ å°„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_index(a)  (((a) &gt;&gt; PGDIR_SHIFT) &amp; (PTRS_PER_PGD - 1)) <span class="comment">// PGDIR_SHIFT = 30  PTRS_PER_PGD = 512</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">pgd_t</span> *<span class="title function_">pgd_offset_pgd</span><span class="params">(<span class="type">pgd_t</span> *pgd, <span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> (pgd + pgd_index(address));</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_offset(mm, address)pgd_offset_pgd((mm)-&gt;pgd, (address))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> <span class="title">init_mm</span> =</span> {</span><br><span class="line">.mm_mt= MTREE_INIT_EXT(mm_mt, MM_MT_FLAGS, init_mm.mmap_lock),</span><br><span class="line">.pgd= swapper_pg_dir,</span><br><span class="line">.mm_users= ATOMIC_INIT(<span class="number">2</span>),</span><br><span class="line">.mm_count= ATOMIC_INIT(<span class="number">1</span>),</span><br><span class="line">.write_protect_seq = SEQCNT_ZERO(init_mm.write_protect_seq),</span><br><span class="line">MMAP_LOCK_INITIALIZER(init_mm)</span><br><span class="line">.page_table_lock =  __SPIN_LOCK_UNLOCKED(init_mm.page_table_lock),</span><br><span class="line">.arg_lock=  __SPIN_LOCK_UNLOCKED(init_mm.arg_lock),</span><br><span class="line">.mmlist= LIST_HEAD_INIT(init_mm.mmlist),</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PER_VMA_LOCK</span></span><br><span class="line">.mm_lock_seq= <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.user_ns= &amp;init_user_ns,</span><br><span class="line">.cpu_bitmap= CPU_BITS_NONE,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IOMMU_SVA</span></span><br><span class="line">.pasid= IOMMU_PASID_INVALID,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">INIT_MM_CONTEXT(init_mm)</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_offset_k(address)pgd_offset(&amp;init_mm, (address))</span></span><br></pre></td></tr></tbody></table></figure><h2 id="fixmap-è™šæ‹Ÿåœ°å€ç©ºé—´è§†å›¾">Fixmap è™šæ‹Ÿåœ°å€ç©ºé—´è§†å›¾</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/FixmapAddress.png"></p><h2 id="fixmap-å¯»å€æµç¨‹">Fixmap å¯»å€æµç¨‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/FixmapAddressFind.png"> ä»¥ä¸Šå°±æ˜¯ Fixmap çš„åœ°å€ç©ºé—´å’Œå¯»å€æµç¨‹ã€‚å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ BITMAP åŒºåŸŸå§‹äº IO æ˜ å°„åŒºåŸŸï¼Œè€Œ FDT å±äºè®¾å¤‡æ ‘æ˜ å°„åŒºåŸŸï¼Œç»è¿‡ FixedMap æ˜ å°„åå°± kernel å°±å¯ä»¥è®¿é—® dtb å’Œ io äº†ã€‚</p><h1 id="çº¿æ€§æ˜ å°„">çº¿æ€§æ˜ å°„</h1><h2 id="æ„å»º-pgd-æ˜ å°„è¡¨">æ„å»º PGD æ˜ å°„è¡¨</h2><p>é¡µç›®å½•ç›´æ¥ä½¿ç”¨çš„æ˜¯ swapper_pg_dirï¼Œä¸€ä¸ªæ¡ç›®æ˜ å°„çš„ç©ºé—´æœ¬èº«å°±å¾ˆå¤§ï¼Œä¸€ä¸ª entry å¯¹åº”èŒƒå›´æœ‰ 512GBã€‚ </p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">arch/arm64/kernel/vmlinux.lds.S</span><br><span class="line">    swapper_pg_dir = .;</span><br><span class="line">. += PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">swapper_pg_dir æ˜¯å®ç°åˆ†é…çš„ä¸€æ®µç©ºé—´ï¼Œå¤„äºå†…æ ¸é•œåƒçš„ data æ®µã€‚</span><br></pre></td></tr></tbody></table></figure><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/pgtable.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __fix_to_virt(x)(FIXADDR_TOP - ((x) &lt;&lt; PAGE_SHIFT))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_fix(x)((FIXADDR_TOP - ((x)&amp;PAGE_MASK)) &gt;&gt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">fix_to_virt</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> idx)</span></span><br><span class="line">{</span><br><span class="line">BUILD_BUG_ON(idx &gt;= __end_of_fixed_addresses);</span><br><span class="line"><span class="keyword">return</span> __fix_to_virt(idx);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return a pointer with offset calculated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __set_fixmap_offset(idx, phys, flags)\</span></span><br><span class="line"><span class="meta">({\</span></span><br><span class="line"><span class="meta">unsigned long ________addr;\</span></span><br><span class="line"><span class="meta">__set_fixmap(idx, phys, flags);\</span></span><br><span class="line"><span class="meta">________addr = fix_to_virt(idx) + ((phys) &amp; (PAGE_SIZE - 1));\</span></span><br><span class="line"><span class="meta">________addr;\</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_fixmap_offset(idx, phys) \</span></span><br><span class="line"><span class="meta">__set_fixmap_offset(idx, phys, FIXMAP_PAGE_NORMAL)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_set_fixmap(addr)((pgd_t *)set_fixmap_offset(FIX_PGD, addr))</span></span><br><span class="line"></span><br><span class="line"><span class="type">pgd_t</span> *pgdp = pgd_set_fixmap(__pa_symbol(swapper_pg_dir));</span><br></pre></td></tr></tbody></table></figure><p>fixmap åŒºåŸŸå¯ä»¥æƒ³è±¡æˆä¸€å—å†…å­˜ä»¥é¡µä¸ºå•ä½è¢«å¹³å‡åˆ†æˆ__end_of_permanent_fixed_addresses å—ã€‚è€Œè¿™äº›æšä¸¾å€¼å°±æ˜¯è¿™å—å†…å­˜çš„ indexã€‚å› æ­¤è™šæ‹Ÿåœ°å€å¯ä»¥æ ¹æ® index è¿›è¡Œè®¡ç®—ã€‚ é€šè¿‡__pa_symbol å…ˆå°† swapper_pg_dir è½¬åŒ–ä¸ºç‰©ç†åœ°å€ï¼Œç„¶åé€šè¿‡ pgd_set_fixmap å¯¹å…¶è¿›è¡Œæ˜ å°„ï¼Œæ˜ å°„å·¥ä½œä¸»è¦åœ¨__set_fixmap é‡Œï¼Œæ˜ å°„å®Œæˆåè¿”å› FIX_PGD çš„è™šæ‹Ÿåœ°å€+swapper_pg_dir ç‰©ç†åœ°å€çš„ offset éƒ¨åˆ†ä½œä¸º pgdpã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/LineMapAddressFind.png"> æœ‰äº† pgdp ä¹‹åå°±å¯ä»¥å¯¹ kernelã€memblock ç­‰è¿›è¡Œä¸‹ä¸€æ­¥çš„æ˜ å°„äº†ã€‚</p><h2 id="ä¸¤ä¸ªé‡è¦çš„å®__pa-å’Œ__va-__pa-å®åˆ†æ">ä¸¤ä¸ªé‡è¦çš„å®__pa å’Œ__va ### __pa å®åˆ†æ <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/memory.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys_nodebug(x) ({\</span></span><br><span class="line"><span class="meta">phys_addr_t __x = (phys_addr_t)(__tag_reset(x));\</span></span><br><span class="line"><span class="meta">__is_lm_address(__x) ? __lm_to_phys(__x) : __kimg_to_phys(__x);\</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __virt_to_phys(x)__virt_to_phys_nodebug(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pa(x)__virt_to_phys((unsigned long)(x))</span></span><br></pre></td></tr></tbody></table></figure></h2><h4 id="tag_reset-å®-__tag_resetx-æ˜¯å»æ‰è™šæ‹Ÿåœ°å€ä¸­çš„-tagå¦‚æœæœ‰-tag-çš„è¯.">__tag_reset å® __tag_reset(x) æ˜¯å»æ‰è™šæ‹Ÿåœ°å€ä¸­çš„ tagï¼ˆå¦‚æœæœ‰ tag çš„è¯ï¼‰.</h4><h4 id="is_lm_addressç”¨äºåˆ¤æ–­è™šæ‹Ÿåœ°å€-addr-æ˜¯å¦åœ¨-arm64-çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„çº¿æ€§åœ°å€åŒºåŸŸ">__is_lm_addressï¼ˆç”¨äºåˆ¤æ–­è™šæ‹Ÿåœ°å€ addr æ˜¯å¦åœ¨ arm64 çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„çº¿æ€§åœ°å€åŒºåŸŸï¼‰ <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check whether an arbitrary address is within the linear map, which</span></span><br><span class="line"><span class="comment"> * lives in the [PAGE_OFFSET, PAGE_END) interval at the bottom of the</span></span><br><span class="line"><span class="comment"> * kernel's TTBR1 address range.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __is_lm_address(addr)(((u64)(addr) - PAGE_OFFSET) &lt; (PAGE_END - PAGE_OFFSET)</span></span><br></pre></td></tr></tbody></table></figure></h4><p>å…ˆçœ‹ PAGE_OFFSET å®šä¹‰ï¼š </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.config é‡Œ</span><br><span class="line">CONFIG_ARM64_VA_BITS=<span class="number">39</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VA_BITS(CONFIG_ARM64_VA_BITS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PAGE_OFFSET(va)(-(UL(1) &lt;&lt; (va)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_OFFSET(_PAGE_OFFSET(VA_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•å¼€å°±æ˜¯</span></span><br><span class="line">PAGE_OFFSET= (UL(<span class="number">-1</span>) &lt;&lt; <span class="number">39</span>) <span class="comment">// 0xFFFFFF80 00000000</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å†çœ‹ PAGE_END å®šä¹‰ï¼š </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_ARM64_VA_BITS=<span class="number">39</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VA_BITS(CONFIG_ARM64_VA_BITS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VA_BITS_MIN(VA_BITS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PAGE_END(va)(-(UL(1) &lt;&lt; ((va) - 1)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_END(_PAGE_END(VA_BITS_MIN))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•å¼€å°±æ˜¯</span></span><br><span class="line">PAGE_END= (UL(<span class="number">-1</span>) &lt;&lt; (<span class="number">39</span> - <span class="number">1</span>)) <span class="comment">// 0xFFFFFFC0 00000000</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>çº¿æ€§åœ°å€ç©ºé—´ä¸º [0xFFFFFF80 00000000, 0xFFFFFFC0 00000000].</p><h4 id="lm_to_physçº¿æ€§åœ°å€ç©ºé—´å†…è™šæ‹Ÿåœ°å€è½¬ç‰©ç†åœ°å€">__lm_to_physï¼ˆçº¿æ€§åœ°å€ç©ºé—´å†…è™šæ‹Ÿåœ°å€è½¬ç‰©ç†åœ°å€ï¼‰ <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __lm_to_phys(addr)(((addr) - PAGE_OFFSET) + PHYS_OFFSET)</span></span><br></pre></td></tr></tbody></table></figure></h4><p>è¿™é‡Œä¸»è¦æ˜¯ PHYS_OFFSET å®çš„å®šä¹‰ï¼š </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PHYS_OFFSET({ VM_BUG_ON(memstart_addr &amp; 1); memstart_addr; })</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>memstart_addr åœ¨ arch/arm64/mm/init.c é‡Œè®¾ç½® (DRAM çš„èµ·å§‹åœ°å€ï¼‰ï¼š </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">arm64_memblock_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Select a suitable value for the base of physical memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">memstart_addr = round_down(memblock_start_of_DRAM(),</span><br><span class="line">   ARM64_MEMSTART_ALIGN);</span><br><span class="line">...</span><br><span class="line"><span class="comment">/* å¦‚æœçº¿æ€§åœ°å€ç©ºé—´å°äºå®é™…ç‰©ç†åœ°å€éœ€è¦è°ƒæ•´ memstart_addr */</span></span><br><span class="line"><span class="keyword">if</span> (memstart_addr + linear_region_size &lt; memblock_end_of_DRAM()) {</span><br><span class="line"><span class="comment">/* ensure that memstart_addr remains sufficiently aligned */</span></span><br><span class="line">memstart_addr = round_up(memblock_end_of_DRAM() - linear_region_size,</span><br><span class="line"> ARM64_MEMSTART_ALIGN);</span><br><span class="line">memblock_remove(<span class="number">0</span>, memstart_addr);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¿™é‡Œæ‰“å°å‡ºæ¥å°±æ˜¯ 0. åˆ°è¿™é‡Œå°±æ˜¯åˆ†ææ¸…æ¥šã€‚</p><h4 id="kimg_to_physå†…æ ¸-image-ç‰©ç†åœ°å€è½¬è™šæ‹Ÿåœ°å€">__kimg_to_physï¼ˆå†…æ ¸ image ç‰©ç†åœ°å€è½¬è™šæ‹Ÿåœ°å€ï¼‰ <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* the offset between the kernel virtual and physical mappings */</span></span><br><span class="line"><span class="keyword">extern</span> u64kimage_voffset;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __kimg_to_phys(addr)((addr) - kimage_voffset)</span></span><br></pre></td></tr></tbody></table></figure></h4><p>è¿™é‡ŒçŸ¥é“ kimage_voffset æ˜¯å†…æ ¸é•œåƒçš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´çš„åç§»å°±å¯ä»¥äº†ï¼Œæš‚æ—¶ç”¨ä¸åˆ°ä¸ç”¨åˆ†æï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å†…æ ¸åŠ è½½åˆ°å†…å­˜ä¸­ååœ¨å†…å­˜çš„ç‰©ç†åœ°å€ä¸é“¾æ¥åœ°å€ä¹‹é—´çš„åå·®ã€‚</p><h3 id="va-å®åˆ†æ-åˆ†æå®Œ__pa-ä¹‹åçœ‹__va-å°±ç®€å•å¤šäº†è¿™é‡Œåªåšçº¿æ€§åŒºåŸŸçš„æ˜ å°„ä¸”-phys_offset-å’Œ-page_offset-éƒ½å·²ç»åˆ†æè¿‡äº†è¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜äº†">__va å®åˆ†æ <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __phys_to_virt(x)((unsigned long)((x) - PHYS_OFFSET) | PAGE_OFFSET)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __va(x)((void *)__phys_to_virt((phys_addr_t)(x)))</span></span><br></pre></td></tr></tbody></table></figure> åˆ†æå®Œ__pa ä¹‹åçœ‹__va å°±ç®€å•å¤šäº†ï¼Œè¿™é‡Œåªåšçº¿æ€§åŒºåŸŸçš„æ˜ å°„ï¼Œä¸” PHYS_OFFSET å’Œ PAGE_OFFSET éƒ½å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜äº†</h3><h2 id="æ˜ å°„è¿‡ç¨‹mem_map">æ˜ å°„è¿‡ç¨‹ï¼ˆmem_mapï¼‰</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">map_mem(pgdp)</span><br><span class="line">--&gt;__map_memblock(pgdp, start, __phys_to_virt(start), end - start,</span><br><span class="line">     prot, early_pgtable_alloc, flags)</span><br><span class="line">--&gt;__create_pgd_mapping(pgdp, start, __phys_to_virt(start), end - start,</span><br><span class="line">     prot, early_pgtable_alloc, flags)</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­__create_pgd_mapping çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/createpgdMappingLocked.png"></p><p>é€šè¿‡__create_pgd_mapping å‡½æ•°å»ºç«‹çº¿æ€§æ˜ å°„çš„é¡µè¡¨ï¼Œå…¶ä¸­å‚æ•°è™šæ‹Ÿåœ°å€é€šè¿‡ __phys_to_virt(start) æ¥è½¬æ¢ï¼Œè€Œ __phys_to_virt å°±æ˜¯__va å®çš„å®ç°å¯¹ç‰©ç†åœ°å€åšä¸€ä¸ªå›ºå®šçš„åç§» PAGE_OFFSETï¼ˆ 0xFFFFFF80 00000000ï¼‰ã€‚æœ‰äº†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€åå‰©ä¸‹çš„å°±æ˜¯å»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å°±å¯ä»¥äº†ï¼Œå°±æ˜¯å¡«å…… pudã€pmdã€pte é¡µè¡¨ã€‚</p><h2 id="çº¿æ€§æ˜ å°„åœ°å€ç©ºé—´">çº¿æ€§æ˜ å°„åœ°å€ç©ºé—´</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/LineMapSpace.png"> æ•´ä¸ª ddr ç©ºé—´ä¸­é™¤äº† secmonã€kernel image å¤–å…¶ä»–éƒ½æ˜¯çº¿æ€§æ˜ å°„èŒƒå›´ã€‚</p><h1 id="vmalloc-æ˜ å°„">VMALLOC æ˜ å°„</h1><h2 id="vmalloc-å‡½æ•°">vmalloc() å‡½æ•°</h2><ul><li>vmalloc ç”¨äºåˆ†é…è™šæ‹Ÿåœ°å€è¿ç»­ï¼ˆç‰©ç†åœ°å€ä¸è¿ç»­ï¼‰çš„å†…å­˜ç©ºé—´ï¼Œvzmalloc ç›¸å¯¹äº vmalloc å¤šäº†ä¸ª 0 åˆå§‹åŒ–</li><li>vmalloc/vzmalloc åˆ†é…çš„è™šæ‹Ÿåœ°å€èŒƒå›´åœ¨ VMALLOC_START/VMALLOC_END ä¹‹é—´</li><li>linux ç®¡ç† vmalloc åˆ†åˆ«æœ‰ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼švm_struct,&nbsp;vm_area_structï¼›å‰è€…æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œåè€…æ˜¯åº”ç”¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„</li><li>å†…æ ¸ vmalloc åŒºå…·ä½“åœ°å€ç©ºé—´çš„ç®¡ç†æ˜¯é€šè¿‡ vmap_area ç®¡ç†çš„ï¼Œè¯¥ç»“æ„ä½“è®°å½•æ•´ä¸ªåŒºé—´çš„èµ·å§‹å’Œç»“æŸ</li><li>vmalloc åœ¨ç”³è¯·å†…å­˜æ—¶é€é¡µåˆ†é…ï¼Œç¡®ä¿åœ¨ç‰©ç†å†…å­˜æœ‰ä¸¥é‡ç¢ç‰‡çš„æƒ…å†µä¸‹ï¼Œvmalloc ä»ç„¶å¯ä»¥å·¥ä½œ</li><li>vmalloc&nbsp;() å‡½æ•°çš„å·¥ä½œæ–¹å¼ä¸ kmalloc() ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒåˆ†é…çš„å†…å­˜åªæ˜¯è™šæ‹Ÿè¿ç»­çš„ï¼Œè€Œä¸ä¸€å®šç‰©ç†è¿ç»­ã€‚ç”¨æˆ·ç©ºé—´åˆ†é…å‡½æ•°çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼šmalloc() è¿”å›çš„é¡µé¢åœ¨å¤„ç†å™¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ˜¯è¿ç»­çš„ï¼Œä½†ä¸èƒ½ä¿è¯å®ƒä»¬åœ¨ç‰©ç† RAM ä¸­å®é™…ä¸Šæ˜¯è¿ç»­çš„ã€‚kmalloc&nbsp;() å‡½æ•°ä¿è¯é¡µé¢åœ¨ç‰©ç†ä¸Šæ˜¯è¿ç»­çš„ï¼ˆå¹¶ä¸”è™šæ‹Ÿè¿ç»­ï¼‰ã€‚vmalloc&nbsp;() å‡½æ•°ä»…ç¡®ä¿é¡µé¢åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ˜¯è¿ç»­çš„ã€‚å®ƒé€šè¿‡åˆ†é…å¯èƒ½ä¸è¿ç»­çš„ç‰©ç†å†…å­˜å—å¹¶â€œä¿®å¤â€é¡µè¡¨ä»¥å°†å†…å­˜æ˜ å°„åˆ°é€»è¾‘åœ°å€ç©ºé—´çš„è¿ç»­å—æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</li></ul><h2 id="æ•°æ®ç»„ç»‡å½¢å¼">æ•°æ®ç»„ç»‡å½¢å¼</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/vmapAreaList.png"></p><p>åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/mmCoreInit.png"></p><h1 id="vmap-å’Œ-vmalloc">vmap() å’Œ vmalloc()</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/vmapmap.png"> vmalloc æµç¨‹ä¸ vmap å·®ä¸å¤šï¼Œåªæ˜¯ page ç»“æ„ä½“åœ¨ vmap ä¸­æ˜¯é€šè¿‡å‚æ•°ä¼ é€’è¿‡å»çš„ï¼Œè€Œ vmalloc æ˜¯é€šè¿‡ page_alloc å·· buddy system ç”³è¯·çš„ã€‚</p><h1 id="vmemmap-æ˜ å°„">VMEMMAP æ˜ å°„</h1><p>vmemmap æ˜¯å†…æ ¸ä¸­ page æ•°æ®çš„è™šæ‹Ÿåœ°å€ï¼Œé’ˆå¯¹ sparse å†…å­˜æ¨¡å‹ã€‚å†…æ ¸ç”³è¯· page è·å–çš„ page åœ°å€ä»æ­¤å¼€å§‹ã€‚vmemmap åŒºåŸŸæ˜¯ä¸€å—èµ·å§‹åœ°å€æ˜¯ VMEMMAP_STARTï¼ŒèŒƒå›´æ˜¯ 2TB çš„è™šæ‹Ÿåœ°å€åŒºåŸŸï¼Œä½äº kernel spaceã€‚ä»¥ section ä¸ºå•ä½æ¥å­˜æ”¾ strcut page ç»“æ„çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åçº¿æ€§æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚è¯¦ç»†è¿‡ç¨‹å¯å‚è€ƒå¦‚ä¸‹è¿æ¥ï¼š</p><h1 id="é™„å½•ä¸€å®å®šä¹‰å¿«æŸ¥">é™„å½•ä¸€ï¼šå®å®šä¹‰å¿«æŸ¥</h1><h2 id="config-é…ç½®">config é…ç½®</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_PGTABLE_LEVELS=<span class="number">3</span></span><br><span class="line">CONFIG_ARM64_VA_BITS_39=y</span><br><span class="line">CONFIG_ARM64_VA_BITS=<span class="number">39</span></span><br><span class="line">CONFIG_ARM64_PA_BITS_48=y</span><br><span class="line">CONFIG_ARM64_PA_BITS=<span class="number">48</span></span><br><span class="line">CONFIG_ARM64_4K_PAGES=y</span><br><span class="line">CONFIG_HZ_250=y</span><br><span class="line">CONFIG_HZ=<span class="number">250</span></span><br><span class="line">CONFIG_ARM64_PAGE_SHIFT=<span class="number">12</span></span><br><span class="line">CONFIG_ARM64_CONT_PTE_SHIFT=<span class="number">4</span></span><br><span class="line">CONFIG_ARM64_CONT_PMD_SHIFT=<span class="number">4</span></span><br></pre></td></tr></tbody></table></figure><h2 id="page-å®šä¹‰">PAGE å®šä¹‰</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/page-def.h&gt;</span><br><span class="line"><span class="comment">/* PAGE_SHIFT determines the page size */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFTCONFIG_ARM64_PAGE_SHIFT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE(_AC(1, UL) &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MASK(~(PAGE_SIZE-1))</span></span><br></pre></td></tr></tbody></table></figure><p>PAGE å  12bitï¼Œä¸€é¡µå¤§å°æ˜¯ 2^12=4096 = 4k</p><h2 id="pte-å®šä¹‰">PTE å®šä¹‰ï¼š</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTRS_PER_PTE(1 &lt;&lt; (PAGE_SHIFT - 3))</span></span><br></pre></td></tr></tbody></table></figure><p>PTRS_PER_PTE = 1 &lt;&lt; (12 - 3) = 512</p><h2 id="pmd-å®šä¹‰">PMD å®šä¹‰</h2><p>å› ä¸º CONFIG_PGTABLE_LEVELS å®šä¹‰ä¸º 3 æ‰€ä»¥æœ‰å¦‚ä¸‹å®šä¹‰ï¼š </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PMD_SHIFT determines the size a level 2 page table entry can map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_PGTABLE_LEVELS &gt; 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMD_SHIFTARM64_HW_PGTABLE_LEVEL_SHIFT(2) <span class="comment">//21</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMD_SIZE(_AC(1, UL) &lt;&lt; PMD_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMD_MASK(~(PMD_SIZE-1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTRS_PER_PMD(1 &lt;&lt; (PAGE_SHIFT - 3))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>PMD_SHIFT = (PAGE_SHIFT - 3) * (4 - 2) + 3 = 21</li><li>PTRS_PER_PMD = 1 &lt;&lt; (12 - 3) = 512</li></ul><h2 id="pud-å®šä¹‰">PUD å®šä¹‰</h2><p>åªæœ‰ 4 çº§é¡µè¡¨æ‰æœ‰ PUDï¼Œä¸‰çº§é¡µè¡¨æ²¡æœ‰ PUD: </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PUD_SHIFT determines the size a level 1 page table entry can map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_PGTABLE_LEVELS &gt; 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUD_SHIFTARM64_HW_PGTABLE_LEVEL_SHIFT(1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUD_SIZE(_AC(1, UL) &lt;&lt; PUD_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUD_MASK(~(PUD_SIZE-1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTRS_PER_PUD(1 &lt;&lt; (PAGE_SHIFT - 3))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><ul><li>PUD_SHIFT = (PAGE_SHIFT - 3) * (4 - 1) + 3 = 30</li><li>PTRS_PER_PUD = 1 &lt;&lt; (12 - 3) = 512</li></ul><h2 id="pgd-å®šä¹‰">PGD å®šä¹‰</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PGDIR_SHIFT determines the size a top-level page table entry can map</span></span><br><span class="line"><span class="comment"> * (depending on the configuration, this level can be 0, 1 or 2).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGDIR_SHIFTARM64_HW_PGTABLE_LEVEL_SHIFT(4 - CONFIG_PGTABLE_LEVELS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGDIR_SIZE(_AC(1, UL) &lt;&lt; PGDIR_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGDIR_MASK(~(PGDIR_SIZE-1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTRS_PER_PGD(1 &lt;&lt; (VA_BITS - PGDIR_SHIFT))</span></span><br></pre></td></tr></tbody></table></figure><ul><li>PGDIR_SHIFT = (PAGE_SHIFT - 3) * (4 - 1) + 3 = 30</li><li>PTRS_PER_PGD = 1 &lt;&lt; (39 - 30) = 512</li></ul><h1 id="é™„å½•äºŒç›¸å…³æ•°æ®ç±»å‹å®šä¹‰">é™„å½•äºŒï¼šç›¸å…³æ•°æ®ç±»å‹å®šä¹‰</h1><h2 id="è¡¨é¡¹æ•°æ®ç±»å‹å®šä¹‰">è¡¨é¡¹æ•°æ®ç±»å‹å®šä¹‰</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/pgtable-types.h&gt;</span><br><span class="line"><span class="keyword">typedef</span> u64 <span class="type">pteval_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> u64 <span class="type">pmdval_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> u64 <span class="type">pudval_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> u64 <span class="type">p4dval_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> u64 <span class="type">pgdval_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are used to make use of C type-checking..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> <span class="type">pteval_t</span> pte; } <span class="type">pte_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pte_val(x)((x).pte)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pte(x)((pte_t) { (x) } )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_PGTABLE_LEVELS &gt; 2</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> <span class="type">pmdval_t</span> pmd; } <span class="type">pmd_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pmd_val(x)((x).pmd)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pmd(x)((pmd_t) { (x) } )</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_PGTABLE_LEVELS &gt; 3</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> <span class="type">pudval_t</span> pud; } <span class="type">pud_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pud_val(x)((x).pud)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pud(x)((pud_t) { (x) } )</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> <span class="type">pgdval_t</span> pgd; } <span class="type">pgd_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_val(x)((x).pgd)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pgd(x)((pgd_t) { (x) } )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span> <span class="type">pteval_t</span> pgprot; } <span class="type">pgprot_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgprot_val(x)((x).pgprot)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pgprot(x)((pgprot_t) { (x) } )</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è·å–è¡¨é¡¹ç´¢å¼•å€¼">è·å–è¡¨é¡¹ç´¢å¼•å€¼</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/pgtable.h&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_index(a)  (((a) &gt;&gt; PGDIR_SHIFT) &amp; (PTRS_PER_PGD - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> pud_index</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pud_index</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> (address &gt;&gt; PUD_SHIFT) &amp; (PTRS_PER_PUD - <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pud_index pud_index</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> pmd_index</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pmd_index</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> (address &gt;&gt; PMD_SHIFT) &amp; (PTRS_PER_PMD - <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pmd_index pmd_index</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pte_index</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> (address &gt;&gt; PAGE_SHIFT) &amp; (PTRS_PER_PTE - <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="è·å–è¡¨é¡¹åœ°å€">è·å–è¡¨é¡¹åœ°å€</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">pgd_t</span> *<span class="title function_">pgd_offset_pgd</span><span class="params">(<span class="type">pgd_t</span> *pgd, <span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> (pgd + pgd_index(address));</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * a shortcut to get a pgd_t in a given mm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> pgd_offset</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pgd_offset(mm, address)pgd_offset_pgd((mm)-&gt;pgd, (address))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Find an entry in the second-level page table.. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> pmd_offset</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">pmd_t</span> *<span class="title function_">pmd_offset</span><span class="params">(<span class="type">pud_t</span> *pud, <span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> pud_pgtable(*pud) + pmd_index(address);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pmd_offset pmd_offset</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> pud_offset</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">pud_t</span> *<span class="title function_">pud_offset</span><span class="params">(<span class="type">p4d_t</span> *p4d, <span class="type">unsigned</span> <span class="type">long</span> address)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> p4d_pgtable(*p4d) + pud_index(address);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pud_offset pud_offset</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ pgd_offset_pgd å°±å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€åœ¨ PGD ä¸­çš„é¡µç›®å½•é¡¹äº†ã€‚</p><blockquote><p>è¯´æ˜ï¼šè¿™é‡Œçš„ PGDã€PUDã€PMD ä¸ºä»€ä¹ˆéƒ½æ˜¯ä½¿ç”¨ 9bitï¼Œè¿™ä¸ªæ˜¯å› ä¸ºåœ¨ 64bit ç³»ç»Ÿä¸‹ï¼Œæ¯ä¸ªåœ°å€è¦å  8 å­—èŠ‚ï¼Œè€Œå¯¹äº page size=4k å¤§å°çš„é¡µé¢ï¼Œä¸€ä¸ªé¡µé¢æ‰€èƒ½å®¹çº³çš„åœ°å€æ•°é‡æ­£å¥½æ˜¯ 4096 / 8 = 512ï¼Œè€Œè¦å¯»å€è¿™ 512 ä¸ªç´¢å¼•éœ€è¦ 2^9=512 ä¹Ÿå°±æ˜¯éœ€è¦ 9bitã€‚è¿™é‡Œä¹Ÿæ˜¯ä½¿ç”¨ 9bit çš„åŸå› ï¼Œå¦‚æœç”¨æ›´å¤§çš„ page size åˆ™æ›´åˆç†çš„åšæ³•æ˜¯ç›¸åº”çš„å¢å¤§ PGDã€PUDã€PMD å çš„ bit æ•°ï¼Œè¿™æ ·å¯ä»¥æ›´å……åˆ†çš„åˆ©ç”¨ç©ºé—´ã€‚</p></blockquote><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆä¸‰ï¼‰ç‰©ç†åœ°å€ç®¡ç†</title>
      <link href="/2021/LinuxKernel/LinuxMemoryBasic/"/>
      <url>/2021/LinuxKernel/LinuxMemoryBasic/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Memorybasic1.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM3MjRjNTU2NTNiYjA3MWU3MGVjMmY=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å†…å­˜ç®¡ç†å‘å±•å²">å†…å­˜ç®¡ç†å‘å±•å²</h1><h2 id="å†…å­˜ç®¡ç†çš„è¿œå¤æ—¶ä»£">å†…å­˜ç®¡ç†çš„â€œè¿œå¤æ—¶ä»£â€</h2><p>åœ¨åˆ†é¡µæœºåˆ¶å‡ºç°ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿæœ‰å¾ˆå¤šä¸åŒçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¦‚åŠ¨æ€åˆ†åŒºæ³•ã€‚å¦‚å›¾ï¼ˆaï¼‰æ‰€ç¤ºã€‚å‰©ä½™çš„ 4MB å†…å­˜ä¸è¶³ä»¥è£…è½½è¿›ç¨‹ Dï¼Œå¦‚å›¾ï¼ˆbï¼‰æ‰€ç¤ºï¼Œå› ä¸ºè¿›ç¨‹ D éœ€è¦ 5MB å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜æœ«å°¾å°±æˆäº†ç¬¬ä¸€ä¸ªç©ºæ´ï¼ˆå†…å­˜ç¢ç‰‡ï¼‰ã€‚å‡è®¾æŸä¸ªæ—¶åˆ»ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦è¿è¡Œè¿›ç¨‹ Dï¼Œå› ä¸ºç³»ç»Ÿä¸­æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥æ¢å‡ºï¼Œä¸ºè¿›ç¨‹ D è…¾å‡ºè¶³å¤Ÿçš„ç©ºé—´ã€‚å‡è®¾æ“ä½œç³»ç»Ÿé€‰æ‹©è¿›ç¨‹ B æ¥æ¢å‡ºï¼Œè¿™æ ·è¿›ç¨‹ D å°±è£…è½½åˆ°äº†åŸæ¥è¿›ç¨‹ B çš„åœ°å€ç©ºé—´é‡Œï¼Œäºæ˜¯äº§ç”Ÿäº†ç¬¬äºŒä¸ªç©ºæ´ï¼Œå¦‚å›¾ï¼ˆcï¼‰æ‰€ç¤ºã€‚å‡è®¾æ“ä½œç³»ç»ŸæŸä¸ªæ—¶åˆ»éœ€è¦è¿è¡Œè¿›ç¨‹ Bï¼Œä¹Ÿéœ€è¦é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥æ¢å‡ºï¼Œå‡è®¾è¿›ç¨‹ A è¢«æ¢å‡ºï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿä¸­åˆäº§ç”Ÿäº†ç¬¬ä¸‰ä¸ªç©ºæ´ï¼Œå¦‚å›¾ï¼ˆdï¼‰æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Dynamic_partition.png"></p><p>è¿™ç§åŠ¨æ€åˆ†åŒºæ³•åœ¨å¼€å§‹æ—¶æ˜¯å¾ˆå¥½çš„ï¼Œä½†æ˜¯éšç€æ—¶é—´çš„æ¨ç§»ä¼šå‡ºç°å¾ˆå¤šå†…å­˜ç©ºæ´ï¼Œå†…å­˜çš„åˆ©ç”¨ç‡éšä¹‹ä¸‹é™ï¼Œè¿™äº›å†…å­˜ç©ºæ´ä¾¿æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å†…å­˜ç¢ç‰‡ï¼ŒåŠ¨æ€åˆ†åŒºæ³•ä¾ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ã€‚</p><ul><li>è¿›ç¨‹åœ°å€ç©ºé—´ä¿æŠ¤é—®é¢˜ã€‚æ‰€æœ‰çš„è¿›ç¨‹éƒ½å¯ä»¥è®¿é—®å…¨éƒ¨çš„ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥æ¶æ„çš„ç¨‹åºå¯ä»¥ä¿®æ”¹å…¶ä»–ç¨‹åºçš„å†…å­˜æ•°æ®ï¼Œè¿™ä½¿è¿›ç¨‹ä¸€ç›´å¤„äºå±é™©çš„çŠ¶æ€ä¸‹ã€‚</li><li>å†…å­˜ä½¿ç”¨æ•ˆç‡ä½ã€‚å¦‚æœå³å°†è¿è¡Œçš„è¿›ç¨‹æ‰€éœ€è¦çš„å†…å­˜ç©ºé—´ä¸è¶³ï¼Œå°±éœ€è¦é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹ä»¥è¿›è¡Œæ•´ä½“æ¢å‡ºï¼Œè¿™ç§æœºåˆ¶å¯¼è‡´å¤§é‡çš„æ•°æ®éœ€è¦æ¢å‡ºå’Œæ¢å…¥ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚</li><li>ç¨‹åºè¿è¡Œåœ°å€é‡å®šä½é—®é¢˜ã€‚ä»ä¸Šå›¾ä¸­çœ‹åˆ°ï¼Œè¿›ç¨‹åœ¨æ¯æ¬¡æ¢å‡ºã€æ¢å…¥æ—¶ä½¿ç”¨çš„åœ°å€éƒ½æ˜¯ä¸å›ºå®šçš„ï¼Œè¿™ç»™ç¨‹åºçš„ç¼–å†™å¸¦æ¥ä¸€å®šçš„éº»çƒ¦ï¼Œå› ä¸ºè®¿é—®æ•°æ®å’ŒæŒ‡ä»¤è·³è½¬æ—¶çš„ç›®æ ‡åœ°å€é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œè¿™å°±éœ€è¦é‡å®šä½æŠ€æœ¯ã€‚</li></ul><p>å› æ­¤äº§ç”Ÿäº†åˆ†æ®µæœºåˆ¶å’Œåˆ†é¡µæœºåˆ¶ã€‚</p><h2 id="åˆ†æ®µæœºåˆ¶">åˆ†æ®µæœºåˆ¶</h2><ul><li>æŠŠç¨‹åºæ‰€éœ€çš„å†…å­˜ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°æŸä¸ªç‰©ç†åœ°å€ç©ºé—´ä¸­ï¼Œè§£å†³åœ°å€ç©ºé—´ä¿æŠ¤é—®é¢˜ã€‚</li><li>åˆ†æ®µæœºåˆ¶æŠŠè¿›ç¨‹åˆ†æˆè‹¥å¹²æ®µï¼ˆä»£ç æ®µã€æ•°æ®æ®µæ ˆæ®µä¸å †æ®µç­‰ï¼‰ï¼Œæ¯ä¸ªæ®µçš„å¤§å°æ˜¯ä¸å›ºå®šçš„ï¼Œæœ‰ç‚¹ç±»ä¼¼äºåŠ¨æ€åˆ†åŒºæ³•ï¼Œè¿™äº›æ®µçš„ç‰©ç†åœ°å€å¯ä»¥ä¸è¿ç»­è¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</li></ul><p>åˆ†æ®µæœºåˆ¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„æ”¹è¿›ï¼Œä½†æ˜¯å®ƒçš„å†…å­˜ä½¿ç”¨æ•ˆç‡ä¾ç„¶æ¯”è¾ƒä½ã€‚åˆ†æ®µæœºåˆ¶å¯¹è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ä¾ç„¶ä»¥è¿›ç¨‹ä¸ºå•ä½ã€‚è¿›ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œæ ¹æ®å±€éƒ¨æ€§åŸç†ï¼Œåªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯ä¸€ç›´åœ¨ä½¿ç”¨çš„ï¼Œè‹¥æŠŠé‚£äº›ä¸å¸¸ç”¨çš„æ•°æ®äº¤æ¢å‡ºç£ç›˜ï¼Œå°±å¯ä»¥èŠ‚çœå¾ˆå¤šç³»ç»Ÿå¸¦å®½ã€‚</p><h2 id="åˆ†é¡µæœºåˆ¶">åˆ†é¡µæœºåˆ¶</h2><p>åˆ†é¡µæœºåˆ¶æŠŠåˆ†æ®µæœºåˆ¶çš„å•ä½ç»§ç»­ç»†åˆ†æˆå›ºå®šå¤§å°çš„é¡µé¢ï¼ˆpageï¼‰ï¼Œè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¹ŸæŒ‰ç…§é¡µé¢æ¥åˆ†å‰²ï¼Œè¿™æ ·å¸¸ç”¨çš„æ•°æ®å’Œä»£ç å°±å¯ä»¥ä»¥é¡µé¢ä¸ºå•ä½é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œè€Œé‚£äº›ä¸å¸¸ç”¨çš„é¡µé¢å¯ä»¥äº¤æ¢åˆ°ç£ç›˜ä¸­ã€‚ç‰©ç†å†…å­˜ä¹Ÿä»¥é¡µé¢ä¸ºå•ä½æ¥ç®¡ç†ï¼Œè¿™äº›ç‰©ç†å†…å­˜ç§°ä¸ºç‰©ç†é¡µé¢ï¼ˆphysical pageï¼‰æˆ–è€…é¡µå¸§ï¼ˆpage frameï¼‰ã€‚è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„é¡µé¢ç§°ä¸ºè™šæ‹Ÿé¡µé¢ï¼ˆvirtualpageï¼‰ã€‚æ“ä½œç³»ç»Ÿä¸ºäº†ç®¡ç†è¿™äº›é¡µå¸§éœ€è¦æŒ‰ç…§ç‰©ç†åœ°å€ç»™æ¯ä¸ªé¡µå¸§ç¼–å·ï¼Œè¿™ä¸ªç¼–å·ç§°ä¸ºé¡µå¸§å·ï¼ˆPage Frame Numberï¼ŒPFNï¼‰ã€‚</p><h1 id="ä»è¿›ç¨‹çš„è§’åº¦çœ‹å†…å­˜ç®¡ç†">ä»è¿›ç¨‹çš„è§’åº¦çœ‹å†…å­˜ç®¡ç†</h1><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºå¸¸ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼æ˜¯å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ï¼ˆExecutable Linkable Formatï¼ŒELFï¼‰ã€‚ELF æœ€å¼€å§‹çš„éƒ¨åˆ†æ˜¯ ELF æ–‡ä»¶å¤´ï¼ˆELF Headerï¼‰ï¼Œå®ƒåŒ…å«äº†æè¿°æ•´ä¸ªæ–‡ä»¶çš„åŸºæœ¬å±æ€§ï¼Œå¦‚ ELF æ–‡ä»¶ç‰ˆæœ¬ã€ç›®æ ‡è®¡ç®—æœºå‹å·ã€ç¨‹åºå…¥å£åœ°å€ç­‰ä¿¡æ¯ã€‚ELF æ–‡ä»¶å¤´åé¢æ˜¯ç¨‹åºçš„å„ä¸ªæ®µï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€æœªåˆå§‹åŒ–æ•°æ®æ®µç­‰ã€‚åé¢æ˜¯æ®µå¤´è¡¨ï¼Œç”¨äºæè¿° ELF æ–‡ä»¶ä¸­åŒ…å«çš„æ‰€æœ‰æ®µçš„ä¿¡æ¯ï¼Œå¦‚æ¯ä¸ªæ®µçš„åå­—ã€æ®µçš„é•¿åº¦ã€åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€è¯»å†™æƒé™ä»¥åŠæ®µçš„å…¶ä»–å±æ€§ç­‰ï¼Œåé¢ç´§è·Ÿç€æ˜¯å­—ç¬¦ä¸²è¡¨å’Œç¬¦å·è¡¨ç­‰ã€‚ELF ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ELF.png"></p><p>ä¸‹é¢ä»‹ç»å¸¸è§çš„å‡ ä¸ªæ®µï¼Œè¿™äº›æ®µä¸å†…æ ¸æ˜ åƒä¸­çš„æ®µä¹Ÿæ˜¯åŸºæœ¬ç±»ä¼¼çš„ã€‚</p><ul><li>ä»£ç æ®µï¼šå­˜æ”¾ç¨‹åºæºä»£ç ç¼–è¯‘åçš„æœºå™¨æŒ‡ä»¤ã€‚</li><li>æ•°æ®æ®µï¼šå­˜æ”¾å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå·²åˆå§‹åŒ–çš„å±€éƒ¨é™æ€å˜é‡ã€‚</li><li>æœªåˆå§‹åŒ–æ•°æ®æ®µï¼šå­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä»¥åŠæœªåˆå§‹åŒ–çš„å±€éƒ¨é™æ€å˜é‡ã€‚ä¸‹é¢ç¼–å†™ä¸€ä¸ªç®€å•çš„ C ç¨‹åºã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE (100*1024)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> * buf = <span class="built_in">malloc</span>(SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x58</span>, SIZE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc buffer 0x%p\n"</span>, buf);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ª C ç¨‹åºå¾ˆç®€å•ï¼Œé¦–å…ˆé€šè¿‡ malloc() å‡½æ•°æ¥åˆ†é… 100KB çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ memset() å‡½å†™å…¥è¿™å—å†…å­˜ï¼Œæœ€åç”¨ while å¾ªç¯æ˜¯ä¸ºäº†ä¸è®©è¿™ä¸ªç¨‹åºé€€å‡ºã€‚æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŠŠå®ƒç¼–æˆ ELF æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aarch64-linux-gnu-gcc-static test.c -o test.elf</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥ä½¿ç”¨ objdump æˆ–è€… readelf å·¥å…·æ¥æŸ¥çœ‹ ELF æ–‡ä»¶åŒ…å«å“ªäº›æ®µã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ aarch64-linux-gnu-readelf -S test.elf</span><br><span class="line">There are 29 section headers, starting at offset 0x92548:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .note.gnu.build-i NOTE             0000000000400190  00000190</span><br><span class="line">       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE             00000000004001b4  000001b4</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">  [ 3] .rela.plt         RELA             00000000004001d8  000001d8</span><br><span class="line">       00000000000000a8  0000000000000018  AI       0    21     8</span><br><span class="line">  [ 4] .init             PROGBITS         0000000000400280  00000280</span><br><span class="line">       0000000000000014  0000000000000000  AX       0     0     4</span><br><span class="line">  [ 5] .plt              PROGBITS         00000000004002a0  000002a0</span><br><span class="line">       0000000000000070  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 6] .text             PROGBITS         0000000000400340  00000340</span><br><span class="line">       00000000000516ac  0000000000000000  AX       0     0     64</span><br><span class="line">  [ 7] __libc_freeres_fn PROGBITS         00000000004519f0  000519f0</span><br><span class="line">       0000000000000b44  0000000000000000  AX       0     0     8</span><br><span class="line">  [ 8] .fini             PROGBITS         0000000000452534  00052534</span><br><span class="line">       0000000000000010  0000000000000000  AX       0     0     4</span><br><span class="line">  [ 9] .rodata           PROGBITS         0000000000452550  00052550</span><br><span class="line">       000000000001be28  0000000000000000   A       0     0     16</span><br><span class="line">  [10] __libc_subfreeres PROGBITS         000000000046e378  0006e378</span><br><span class="line">       0000000000000048  0000000000000000   A       0     0     8</span><br><span class="line">  [11] __libc_IO_vtables PROGBITS         000000000046e3c0  0006e3c0</span><br><span class="line">       00000000000005e8  0000000000000000   A       0     0     8</span><br><span class="line">  [12] __libc_atexit     PROGBITS         000000000046e9a8  0006e9a8</span><br><span class="line">       0000000000000008  0000000000000000   A       0     0     8</span><br><span class="line">  [13] .eh_frame         PROGBITS         000000000046e9b0  0006e9b0</span><br><span class="line">       000000000000a158  0000000000000000   A       0     0     8</span><br><span class="line">  [14] .gcc_except_table PROGBITS         0000000000478b08  00078b08</span><br><span class="line">       000000000000009e  0000000000000000   A       0     0     1</span><br><span class="line">  [15] .tdata            PROGBITS         0000000000489978  00079978</span><br><span class="line">       0000000000000020  0000000000000000 WAT       0     0     8</span><br><span class="line">  [16] .tbss             NOBITS           0000000000489998  00079998</span><br><span class="line">       0000000000000040  0000000000000000 WAT       0     0     8</span><br><span class="line">  [17] .init_array       INIT_ARRAY       0000000000489998  00079998</span><br><span class="line">       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">  [18] .fini_array       FINI_ARRAY       00000000004899a0  000799a0</span><br><span class="line">       0000000000000010  0000000000000008  WA       0     0     8</span><br><span class="line">  [19] .data.rel.ro      PROGBITS         00000000004899b0  000799b0</span><br><span class="line">       0000000000000594  0000000000000000  WA       0     0     8</span><br><span class="line">  [20] .got              PROGBITS         0000000000489f48  00079f48</span><br><span class="line">       00000000000000a0  0000000000000008  WA       0     0     8</span><br><span class="line">  [21] .got.plt          PROGBITS         0000000000489fe8  00079fe8</span><br><span class="line">       0000000000000050  0000000000000008  WA       0     0     8</span><br><span class="line">  [22] .data             PROGBITS         000000000048a038  0007a038</span><br><span class="line">       0000000000001950  0000000000000000  WA       0     0     8</span><br><span class="line">  [23] .bss              NOBITS           000000000048b988  0007b988</span><br><span class="line">       00000000000015d0  0000000000000000  WA       0     0     8</span><br><span class="line">  [24] __libc_freeres_pt NOBITS           000000000048cf58  0007b988</span><br><span class="line">       0000000000000028  0000000000000000  WA       0     0     8</span><br><span class="line">  [25] .comment          PROGBITS         0000000000000000  0007b988</span><br><span class="line">       000000000000002a  0000000000000001  MS       0     0     1</span><br><span class="line">  [26] .symtab           SYMTAB           0000000000000000  0007b9b8</span><br><span class="line">       0000000000010110  0000000000000018          27   1726     8</span><br><span class="line">  [27] .strtab           STRTAB           0000000000000000  0008bac8</span><br><span class="line">       0000000000006954  0000000000000000           0     0     1</span><br><span class="line">  [28] .shstrtab         STRTAB           0000000000000000  0009241c</span><br><span class="line">       0000000000000128  0000000000000000           0     0     1</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°åˆšæ‰ç¼–è¯‘çš„ test.elf æ–‡ä»¶ä¸€å…±æœ‰ 28 ä¸ªæ®µï¼Œé™¤äº†å¸¸è§çš„ä»£ç æ®µã€æ•°æ®æ®µä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ®µï¼Œè¿™äº›æ®µåœ¨è¿›ç¨‹åŠ è½½æ—¶èµ·è¾…åŠ©ä½œç”¨ï¼Œæš‚æ—¶å…ˆä¸ç”¨å…³æ³¨å®ƒä»¬ã€‚ç¨‹åºåœ¨ç¼–è¯‘ã€é“¾æ¥æ—¶ä¼šå°½é‡æŠŠç›¸åŒæƒé™å±æ€§çš„æ®µåˆ†é…åœ¨åŒä¸€ä¸ªç©ºé—´é‡Œï¼Œå¦‚æŠŠå¯è¯»ã€å¯æ‰§è¡Œçš„æ®µæ”¾åœ¨ä¸€èµ·ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€init æ®µç­‰ï¼›æŠŠå¯è¯»ã€å¯å†™çš„æ®µæ”¾åœ¨ä¸€èµ·ï¼ŒåŒ…æ‹¬æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µç­‰ã€‚ELF æŠŠè¿™äº›å±æ€§ç›¸ä¼¼å¹¶ä¸”é“¾æ¥åœ¨ä¸€èµ·çš„æ®µå«ä½œåˆ†æ®µï¼ˆsegmentï¼‰ï¼Œè¿›ç¨‹åœ¨åŠ è½½æ—¶æ˜¯æŒ‰ç…§è¿™äº›åˆ†æ®µæ¥æ˜ å°„å¯æ‰§è¡Œæ–‡ä»¶çš„ã€‚æè¿°è¿™äº›åˆ†æ®µçš„ç»“æ„å«ä½œç¨‹åºå¤´ï¼ˆprogram headerï¼‰ï¼Œå®ƒæè¿°äº† ELF æ–‡ä»¶æ˜¯å¦‚ä½•æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„ï¼Œè¿™æ˜¯æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒçš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ readelf -l å‘½ä»Šæ¥æŸ¥çœ‹è¿™äº›ç¨‹åºå¤´ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~$ aarch64-linux-gnu-readelf -l test.elf</span><br><span class="line"></span><br><span class="line">Elf file <span class="built_in">type</span> is EXEC (Executable file)</span><br><span class="line">Entry point 0x400558</span><br><span class="line">There are 6 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x0000000000078ba6 0x0000000000078ba6  R E    0x10000</span><br><span class="line">  LOAD           0x0000000000079978 0x0000000000489978 0x0000000000489978</span><br><span class="line">                 0x0000000000002010 0x0000000000003608  RW     0x10000</span><br><span class="line">  NOTE           0x0000000000000190 0x0000000000400190 0x0000000000400190</span><br><span class="line">                 0x0000000000000044 0x0000000000000044  R      0x4</span><br><span class="line">  TLS            0x0000000000079978 0x0000000000489978 0x0000000000489978</span><br><span class="line">                 0x0000000000000020 0x0000000000000060  R      0x8</span><br><span class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000000 0x0000000000000000  RW     0x10</span><br><span class="line">  GNU_RELRO      0x0000000000079978 0x0000000000489978 0x0000000000489978</span><br><span class="line">                 0x0000000000000688 0x0000000000000688  R      0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.gnu.build-id .note.ABI-tag .rela.plt .init .plt .text __libc_freeres_fn .fini .rodata __libc_subfreeres __libc_IO_vtables __libc_atexit .eh_frame .gcc_except_table</span><br><span class="line">   01     .tdata .init_array .fini_array .data.rel.ro .got .got.plt .data .bss __libc_freeres_ptrs</span><br><span class="line">   02     .note.gnu.build-id .note.ABI-tag</span><br><span class="line">   03     .tdata .tbss</span><br><span class="line">   04</span><br><span class="line">   05     .tdata .init_array .fini_array .data.rel.ro .got</span><br></pre></td></tr></tbody></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ä¹‹å‰çš„ 28 ä¸ªæ®µè¢«åˆ†æˆäº† 6 ä¸ªåˆ†æ®µï¼Œæˆ‘ä»¬åªå…³æ³¨å…¶ä¸­ä¸¤ä¸ª LOAD ç±»å‹çš„åˆ†æ®µã€‚å› ä¸ºåœ¨åŠ è½½æ—¶éœ€è¦æ˜ å°„å®ƒï¼Œå…¶ä»–çš„åˆ†æ®µåœ¨åŠ è½½æ—¶èµ·è¾…åŠ©ä½œç”¨ã€‚ å…ˆçœ‹ç¬¬ä¸€ä¸ª LOAD ç±»å‹çš„åˆ†æ®µï¼Œå®ƒæ˜¯å…·æœ‰åªè¯»å’Œå¯æ‰§è¡Œçš„æƒé™ï¼ŒåŒ…å«ã€‚init æ®µã€ä»£ç æ®µã€åªè¯»æ•°æ®æ®µç­‰å¸¸è§çš„æ®µï¼Œå®ƒæ˜ å°„çš„è™šæ‹Ÿåœ°å€æ˜¯ 0x400000ï¼Œé•¿åº¦æ˜¯ 0x78ba6ã€‚ ç¬¬äºŒä¸ª LOAD ç±»å‹çš„åˆ†æ®µå…·æœ‰å¯è¯»å’Œå¯å†™çš„æƒé™ï¼ŒåŒ…å«æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µç­‰å¸¸è§çš„æ®µï¼Œå®ƒæ˜ å°„çš„è™šæ‹Ÿåœ°å€æ˜¯ 0x489978ï¼Œé•¿åº¦æ˜¯ 0x3608 ä¸Šé¢ä»é™æ€çš„è§’åº¦æ¥çœ‹è¿›ç¨‹çš„å†…å­˜ç®¡ç†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»åŠ¨æ€çš„è§’åº¦æ¥çœ‹ã€‚Linux æ“ä½œç³»ç»Ÿæä¾›äº†â€œprocâ€æ–‡ä»¶ç³»ç»Ÿæ¥çª¥æ¢ Linux å†…æ ¸çš„æ‰§è¡Œæƒ…å†µï¼Œæ¯ä¸ªè¿›ç¨‹æ‰§è¡Œä¹‹åï¼Œåœ¨/proc/pid/maps èŠ‚ç‚¹ä¼šåˆ—å‡ºå½“å‰è¿›ç¨‹çš„åœ°å€æ˜ å°„æƒ…å†µã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/721/maps</span><br><span class="line">00400000-0046000 r-xp 00000000 00:26 52559883   test.elf</span><br><span class="line">0047e000-00481000 rw-p 0006e000 00:26 52559883  test.elf</span><br><span class="line">272dd000-272ff000 rw-p 00000000 00:00 0         [heap]</span><br><span class="line">ffffa97ea000-ffffa97eb000 r--p 00000000 00:00 0 [vvar]</span><br><span class="line">ffffa97eb000-ffffa97ec000 r-xp 00000000 00:00 0 [vdso]</span><br><span class="line">ffffcb6c6000-ffffcb6e7000 rw-p 00000000 00:00 0 [stack]</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ 1 è¡Œæ˜¾ç¤ºäº†åœ°å€ 0x400000~0x46f000ï¼Œè¿™æ®µè¿›ç¨‹åœ°å€ç©ºé—´çš„å±æ€§æ˜¯åªè¯»å’Œå¯æ‰§è¡Œçš„ï¼Œç”±æ­¤æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯ä»£ç æ®µï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çœ‹åˆ°çš„ä»£ç æ®µçš„ç¨‹åºå¤´ã€‚<br>ç¬¬ 2 è¡Œæ˜¾ç¤ºäº†åœ°å€ 0x47e000~0x48100ï¼Œè¿™æ®µè¿›ç¨‹åœ°å€ç©ºé—´çš„å±æ€§æ˜¯å¯è¯»å’Œå¯å†™çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„æ•°æ®æ®µçš„ç¨‹åºå¤´ã€‚<br>ç¬¬ 3 è¡Œæ˜¾ç¤ºäº†åœ°å€ 0x272dd00~0x272ff000ï¼Œè¿™æ®µè¿›ç¨‹åœ°å€ç©ºé—´å«ä½œå †ï¼ˆheapï¼‰ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸ä½¿ç”¨ malloc() åˆ†é…çš„å†…å­˜ï¼Œå¤§å°æ˜¯ 140KBã€‚test è¿›ç¨‹ä¸»è¦ä½¿ç”¨ malloc() åˆ†é… 100KB çš„å†…å­˜ï¼Œè¿™é‡Œçœ‹åˆ° Linux å†…æ ¸ä¼šåˆ†é…æ¯” 100KB ç¨å¾®å¤§ä¸€ç‚¹çš„å†…å­˜ç©ºé—´ã€‚<br>ç¬¬ 4 è¡Œæ˜¾ç¤ºäº†åä¸º vvar çš„ç‰¹æ®Šæ˜ å°„ã€‚<br>ç¬¬ 5 è¡Œæ˜¾ç¤ºäº†åä¸º vdso çš„ç‰¹æ®Šæ˜ å°„ï¼ŒVDSO æŒ‡ Virtual Dynamic Shared Objectï¼Œç”¨äºè§£å†³å†…æ ¸å’Œ libc ä¹‹é—´çš„ç‰ˆæœ¬é—®é¢˜ã€‚<br>ç¬¬ 6 è¡Œæ˜¾ç¤ºäº† test è¿›ç¨‹çš„æ ˆï¼ˆstackï¼‰ç©ºé—´ã€‚<br>å¯¹äºè¿™é‡Œçš„è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œåœ¨ Linux å†…æ ¸ä¸­ä½¿ç”¨ä¸€ä¸ªå«ä½œ VMA çš„æœ¯è¯­æ¥æè¿°å®ƒï¼Œå®ƒæ˜¯ vm_area_struct æ•°æ®ç»“æ„çš„ç®€ç§°ã€‚ å¦å¤–ï¼Œ/proc/pid/smaps èŠ‚ç‚¹ä¼šæä¾›æ›´å¤šåœ°å€æ˜ å°„çš„ç»†èŠ‚ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/test_process.png"></p><h1 id="ç‰©ç†å†…å­˜ç®¡ç†ä¹‹é¢„å¤‡çŸ¥è¯†">ç‰©ç†å†…å­˜ç®¡ç†ä¹‹é¢„å¤‡çŸ¥è¯†</h1><h2 id="å†…å­˜æ¶æ„ä¹‹-uma-å’Œ-numa">å†…å­˜æ¶æ„ä¹‹ UMA å’Œ NUMA</h2><ul><li><p>UMA ç»Ÿä¸€å†…å­˜è®¿é—®æ¶æ„ï¼šå†…å­˜æœ‰ç»Ÿä¸€çš„ç»“æ„å¹¶ä¸”å¯ä»¥ç»Ÿä¸€å¯»å€ã€‚ç›®å‰å¤§éƒ¨åˆ†åµŒå…¥å¼ç³»ç»Ÿã€æ‰‹æœºæ“ä½œç³»ç»Ÿä»¥åŠå°å¼æœºæ“ä½œç³»ç»Ÿç­‰é‡‡ç”¨ UMA æ¶æ„ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/UMA.png"></p></li><li><p>NUMA éç»Ÿä¸€å†…å­˜è®¿é—®æ¶æ„ï¼šç³»ç»Ÿä¸­æœ‰å¤šä¸ªå†…å­˜èŠ‚ç‚¹å’Œå¤šä¸ª CPU ç°‡ï¼ŒCPU è®¿é—®æœ¬åœ°å†…å­˜èŠ‚ç‚¹çš„é€Ÿåº¦æœ€å¿«ï¼Œè®¿é—®è¿œç«¯çš„å†…å­˜èŠ‚ç‚¹çš„é€Ÿåº¦è¦æ…¢ä¸€ç‚¹ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/NUMA.png"></p></li></ul><h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h2><p>ä» Linux å†…æ ¸çš„è§’åº¦æ¥çœ‹ï¼ŒDDR å­˜å‚¨è®¾å¤‡å…¶å®å°±æ˜¯ä¸€æ®µç‰©ç†å†…å­˜ç©ºé—´ã€‚åœ¨ Linux å†…æ ¸ä¸­ï¼Œå’Œå†…å­˜ç¡¬ä»¶ç‰©ç†ç‰¹æ€§ç›¸å…³çš„ä¸€äº›æ•°æ®ç»“æ„ä¸»è¦é›†ä¸­åœ¨ MMUï¼ˆå¦‚é¡µè¡¨ã€é«˜é€Ÿç¼“å­˜/TLB æ“ä½œç­‰ï¼‰ä¸­ã€‚å› æ­¤å¤§éƒ¨åˆ†çš„ Linux å†…æ ¸ä¸­å…³äºå†…å­˜ç®¡ç†çš„ç›¸å…³æ•°æ®ç»“æ„æ˜¯è½¯ä»¶å±‚é¢çš„æ¦‚å¿µï¼Œå¦‚ mmã€VMAã€å†…å­˜ç®¡ç†åŒºï¼ˆzoneï¼‰ã€é¡µé¢ã€pg_data ç­‰ã€‚Linux å†…æ ¸å†…å­˜ç®¡ç†ä¸­çš„æ•°æ®ç»“æ„é”™ç»¼å¤æ‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_struct.png"></p><p>å’Œç‰©ç†å†…å­˜ç®¡ç†ç›¸å…³çš„æ•°æ®ç»“æ„æœ‰å†…å­˜èŠ‚ç‚¹ï¼ˆpglist dataï¼‰ã€å†…å­˜ç®¡ç†åŒºã€ç‰©ç†é¡µé¢ï¼ˆpageï¼‰ã€mem_map[] æ•°ç»„ã€é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ã€é¡µå¸§å·ï¼ˆPFNï¼‰ã€ç‰©ç†åœ°å€ï¼ˆpaddressï¼‰ã€‚</p><p>å…¶ä¸­ï¼Œpglist data æ•°æ®ç»“æ„ç”¨æ¥æè¿°ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹çš„æ‰€æœ‰èµ„æºã€‚åœ¨ UMA æ¶æ„ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹ï¼Œå³ç³»ç»Ÿæœ‰ä¸€ä¸ªå…¨å±€çš„å˜é‡ contig_page_data æ¥æè¿°è¿™ä¸ªå†…å­˜èŠ‚ç‚¹ã€‚åœ¨ NUMA æ¶æ„ä¸­ï¼Œæ•´ä¸ªç³»ç»Ÿçš„å†…å­˜ç”±ä¸€ä¸ª pglist_data *çš„æŒ‡é’ˆæ•°ç»„ node_data[] æ¥ç®¡ç†ï¼Œåœ¨ç³»ç»Ÿåˆå§‹åŒ–æšä¸¾ BIOS å›ºä»¶ï¼ˆACPIï¼‰æ¥å®Œæˆã€‚</p><p>Linux å†…æ ¸ç”¨å†…å­˜ç®¡ç†åŒºæ¥åˆ’åˆ†ç‰©ç†å†…å­˜æ˜¯æœ‰ä»¥ä¸‹å†å²åŸå› çš„ã€‚</p><ul><li>ç”±äºåœ°å€æ•°æ®çº¿ä½å®½çš„é™åˆ¶ï¼Œ32 ä½å¤„ç†å™¨é€šå¸¸æœ€å¤šæ”¯æŒ 4GB çš„ç‰©ç†å†…å­˜ï¼Œå¦‚æœæ‰“å¼€äº† LPAE ç‰¹æ€§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤§çš„ç‰©ç†å†…å­˜ã€‚åœ¨ 4Gb çš„åœ°å€ç©ºé—´ä¸­ï¼Œé€šå¸¸å†…æ ¸ç©ºé—´åªæœ‰ 1GB å¤§å°ï¼Œå› æ­¤å¯¹äºå¤§å°ä¸º 4GB çš„ç‰©ç†å†…å­˜æ˜¯æ— æ³•è¿›è¡Œ--çº¿æ€§æ˜ å°„çš„ã€‚Linux å†…æ ¸çš„åšæ³•æ˜¯æŠŠç‰©ç†å†…å­˜åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯çº¿æ€§æ˜ å°„çš„ã€‚å¦‚æœç”¨ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºæ¥æè¿°å®ƒï¼Œé‚£å°±æ˜¯ ZONE_NORMALã€‚å‰©ä½™çš„éƒ¨åˆ†å«ä»é«˜ç«¯å†…å­˜ï¼ˆhigh memoryï¼‰åŒæ ·ä½¿ç”¨ä¸€ä¸ªå†…å­˜ç®¡ç†åŒºæ¥æè¿°å®ƒï¼Œç§°ä¸º ZONE_HIGHMEMã€‚</li><li>å†…å­˜ç®¡ç†åŒºçš„åˆ†å¸ƒå’Œæ¶æ„ç›¸å…³ï¼Œå¦‚åœ¨ x86 æ¶æ„ä¸­ï¼ŒISA è®¾å¤‡åªèƒ½è®¿é—®ç‰©ç†å†…å­˜çš„å‰ 16MBï¼Œæ‰€ä»¥åœ¨ x86 æ¶æ„ä¸­ä¼šæœ‰ä¸€ä¸ªåä¸º ZONE_DMA çš„ç®¡ç†åŒºåŸŸã€‚åœ¨ x86_64 æ¶æ„ä¸­ï¼Œç”±äºæœ‰è¶³å¤Ÿå¤§çš„å†…æ ¸ç©ºé—´å¯ä»¥çº¿æ€§æ˜ å°„ç‰©ç†å†…å­˜ï¼Œå› æ­¤å°±ä¸éœ€è¦ ZONE_HIGHMEM è¿™ä¸ªç®¡ç†åŒºåŸŸäº†ã€‚</li></ul><p>åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­å¸¸è§çš„å†…å­˜ç®¡ç†åŒºå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>ZONE_DMAï¼šç”¨äº ISA è®¾å¤‡çš„ DMA æ“ä½œï¼ŒèŒƒå›´æ˜¯ 0~16MBï¼Œåªé€‚ç”¨äº Intel x86 æ¶æ„ï¼ŒARM æ¶æ„æ²¡æœ‰è¿™ä¸ªå†…å­˜ç®¡ç†åŒºã€‚</li><li>ZONE_DMA32ï¼šç”¨äºæœ€ä½ 4GB çš„å†…å­˜è®¿é—®çš„è®¾å¤‡ï¼Œå¦‚åªæ”¯æŒ 32 ä½çš„ DMA è®¾å¤‡ã€‚</li><li>ZONE_NORMALï¼š4GB ä»¥åçš„ç‰©ç†å†…å­˜ï¼Œç”¨äºçº¿æ€§æ˜ å°„ç‰©ç†å†…å­˜ã€‚è‹¥ç³»ç»Ÿå†…å­˜å°äº 4GBï¼Œåˆ™æ²¡æœ‰è¿™ä¸ªå†…å­˜ç®¡ç†åŒºã€‚</li><li>ZONE_HIGHMEMï¼šç”¨äºç®¡ç†é«˜ç«¯å†…å­˜ï¼Œè¿™äº›é«˜ç«¯å†…å­˜æ˜¯ä¸èƒ½çº¿æ€§æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´çš„ã€‚æ³¨æ„ï¼Œåœ¨ 64 ä½ Linux æ“ä½œç³»ç»Ÿä¸­æ²¡æœ‰è¿™ä¸ªå†…å­˜ç®¡ç†åŒºã€‚</li></ul><p>Linux å†…æ ¸ä¸­ä½¿ç”¨ä¸€ä¸ª page æ•°æ®ç»“æ„æ¥æè¿°ä¸€ä¸ªç‰©ç†é¡µé¢ã€‚Linux å†…æ ¸ä¸ºæ¯ä¸ªç‰©ç†é¡µé¢éƒ½åˆ†é…äº†ä¸€ä¸ª page æ•°æ®ç»“æ„ï¼Œé‡‡ç”¨ mem_map[] æ•°ç»„æ¥å­˜æ”¾è¿™äº› page æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”å®ƒä»¬å’Œç‰©ç†é¡µé¢æ˜¯ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_map.png"></p><p>æ¯ä¸ª node ç”±ä¸€ä¸ªæˆ–å¤šä¸ª zone ç»„æˆï¼Œæ¯ä¸ª zone åˆç”±è‹¥å¹² page frames ç»„æˆï¼ˆä¸€èˆ¬ page frame éƒ½æ˜¯æŒ‡ç‰©ç†é¡µé¢ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/framebuffer.jpg"></p><h1 id="memblock">Memblock</h1><p>Linuxå†…æ ¸ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿç®¡ç†å†…å­˜ï¼Œåœ¨ä¼™ä¼´ç³»ç»Ÿä¹‹å‰ï¼Œå†…æ ¸é€šè¿‡memblockæ¥ç®¡ç†å†…å­˜ã€‚åœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µï¼Œä½¿ç”¨memblockè®°å½•ç†å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥åˆ†æˆå¥½å‡ å—ã€‚</p><ul><li>æ°¸ä¹…åˆ†é…ç»™ç³»ç»Ÿå†…æ ¸ï¼šå†…æ ¸é•œåƒå ç”¨çš„éƒ¨åˆ†ï¼Œå¦‚ä»£ç ã€æ•°æ®æ®µã€è®¾å¤‡æ ‘DTBç­‰ã€‚</li><li>é¢„ç•™ç»™å¤–è®¾çš„è¿ç»­å†…å­˜ï¼šå¦‚GPU/Camera/å¤šæ ¸å…±äº«ç­‰éœ€è¦é¢„ç•™å¤§é‡è¿ç»­å†…å­˜ã€‚</li><li>å…¶ä»–éƒ¨åˆ†ï¼šä»¥ä¸Šçš„å‰©ä½™éƒ¨åˆ†å†…å­˜ï¼Œéœ€è¦è¿›è¡Œå†…å­˜ç®¡ç†ã€‚</li></ul><h2 id="åˆå§‹åŒ–æµç¨‹">åˆå§‹åŒ–æµç¨‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/MemoryStartKernelMemblock.png"></p><ul><li>è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ /memory èŠ‚ç‚¹, å°†æ‰€æœ‰ç‰©ç†å†…å­˜çº³å…¥åˆ° memblock åˆ†é…å™¨ç®¡ç†ä¹‹ä¸‹ã€‚</li><li>å°†kernelã€dtbä»¥åŠmemoryèŠ‚ç‚¹ä¸‹çš„reservedå†…å­˜ç»„ç»‡ä¸ºreservedå†…å­˜ï¼Œæä¾›ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„æ¥å£ï¼Œé¿å…ä½¿ç”¨åˆ°reservedå†…å­˜ã€‚</li></ul><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/MemoryBlockStruct.png"> struct memblockç»“æ„ä½“é€šè¿‡struct memblock_typeç®¡ç†memå’Œreservedå†…å­˜ï¼Œmemblock_typeé‡Œé€šè¿‡struct memblock_regionsæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ç³»ç»Ÿçš„å¯ä»¥å†…å­˜å’Œreserverå†…å­˜ã€‚å¦‚ä¸Šå›¾Memblockå°†Secmonã€DSPã€dtbå’Œkernelçš„å†…å­˜ç»„ç»‡ä½reserverï¼Œå…¶ä»–å†…å­˜ä¸ºmemã€‚</p><h2 id="memblock_allocæ¥å£">memblock_allocæ¥å£</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">memblock_alloc</span><br><span class="line">- memblock_alloc_try_nid</span><br><span class="line">- memblock_alloc_internal</span><br><span class="line">- kzalloc_node (exec it <span class="keyword">if</span> slab is enable and then <span class="keyword">return</span>)</span><br><span class="line">- memblock_alloc_range_nid</span><br><span class="line">- memblock_find_in_range_node</span><br><span class="line">- phys_to_virt</span><br></pre></td></tr></tbody></table></figure><p>å¯è§&nbsp;memblock_alloc&nbsp;å‡½æ•°å’Œ&nbsp;memblock_phy_alloc&nbsp;å‡½æ•°å‡æ˜¯è°ƒç”¨&nbsp;memblock_find_in_range_node&nbsp;å®ç°ç‰©ç†å†…å­˜çš„åˆ†é…ï¼Œä¸åŒçš„æ˜¯&nbsp;memblock_alloc&nbsp;ä¼šåœ¨åˆ†é…åè°ƒç”¨äº†&nbsp;phys_to_virt&nbsp;å‡½æ•°å°†ç‰©ç†åœ°å€è½¬æ¢æˆè™šæ‹Ÿåœ°å€ã€‚è¿™é‡Œæœ‰ä¸ªç–‘é—®phys_to_virt&nbsp;æ˜¯è½¬ä¸ºçº¿æ€§æ˜ å°„åŒºï¼Œæ­¤æ—¶çº¿æ€§æ˜ å°„åŒºä»¥åŠæ˜ å°„å¥½äº†ï¼Ÿ</p><blockquote><p>å¯¹äºPaging_initä¹‹å‰åº”è¯¥æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨phys_to_virt&nbsp;çš„å› ä¸ºè¿™ä¸ªæ—¶å€™çº¿æ€§æ˜ å°„è¿˜æ²¡å®Œæˆï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥æ˜¯åˆ©ç”¨fixedmapæ˜ å°„åŒºçš„fix_{pudã€pmdã€pte}é¡µè¡¨å®Œæˆæ˜ å°„ï¼Œåœ¨paging_initä¹‹åå› ä¸ºå®Œæˆäº†çº¿æ€§æ˜ å°„ï¼Œè¿™ä¸ªddrï¼ˆé™¤äº†no mapå¤–ï¼‰éƒ½åœ¨çº¿æ€§æ˜ å°„èŒƒå›´å†…ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯å¯ä»¥ç›´æ¥è°ƒç”¨phys_to_virt&nbsp;å°†Memblockåˆ†é…çš„ç‰©ç†å†…å­˜è½¬ä¸ºè™šæ‹Ÿåœ°å€ä¾›å†…æ ¸ä½¿ç”¨çš„.</p></blockquote><p>å¦å¤–ï¼Œè°ƒç”¨&nbsp;memblock_alloc_range_nid&nbsp;ä¹‹å‰ä¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨äº† slab åˆ†é…å™¨ï¼Œå¦‚æœå·²å¯ç”¨ï¼Œè¯´æ˜&nbsp;memblock&nbsp;å·²å°†ç®¡ç†æƒç§»äº¤ç»™ä¼™ä¼´ç³»ç»Ÿã€‚è¿™æ—¶ä¼šç›´æ¥è°ƒç”¨&nbsp;kzalloc_node&nbsp;ä» slab åˆ†é…å™¨åˆ†é…å†…å­˜ã€‚</p><h2 id="memblockè°ƒè¯•">memblockè°ƒè¯•</h2><p>åœ¨å†…æ ¸å¯åŠ¨bootargsï¼Œå¯ä»¥åŠ å…¥"memblock=debug"ï¼Œä¼šæ‰“å¼€memblockçš„dbgæ‰“å°ï¼Œé€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºmemblockçš„é¢„ç•™ã€åˆ†é…ç­‰æ“ä½œã€‚ åœ¨å†…æ ¸ç¼–è¯‘æ—¶ä½¿èƒ½äº†å†…æ ¸debugåŠŸèƒ½åï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œæŸ¥çœ‹memblockä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/memblock/memory </span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/memblock/reserved</span><br></pre></td></tr></tbody></table></figure><h1 id="node-zone-pagelinuxæŒç®¡ç‰©ç†å†…å­˜çš„ç¥">Node-Zone-Pageï¼ˆLinuxæŒç®¡ç‰©ç†å†…å­˜çš„ç¥ï¼‰</h1><p>ä¸ºä»€ä¹ˆæœ‰äº†Memblockåè¿˜è¦è®¾è®¡Node-Zoneæ¥ç®¡ç†å†…å­˜å‘¢ï¼ŒMemblockç®¡ç†å†…å­˜å¤ªç²—ç³™äº†ï¼Œæ²¡æœ‰å¯¹å†…å­˜çš„è®¿é—®æƒé™åˆ’åˆ†ï¼Œä»¥åŠå†…å­˜å±æ€§ç­‰è¿›è¡Œç®¡ç†ã€‚ä¸ºäº†å¯¹ç‰©ç†å†…å­˜è¿›è¡Œæ›´ç²¾ç»†çš„åˆ’åˆ†ç®¡ç†äºæ˜¯æœ‰äº†Node-Zoneï¼Œåœ¨å¤šcpué˜µåˆ—ä¸­ä¸åŒcpuå¯¹ç›¸åŒå†…å­˜æˆ–ç›¸åŒcpuå¯¹ä¸åŒå†…å­˜çš„è®¿é—®æƒé™é€Ÿåº¦å¯èƒ½ä¸åŒï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å¯¹å†…å­˜è¿›è¡Œåˆ’åˆ†ç®¡ç†ï¼Œè®¾å¤‡DMAå¯èƒ½ä¸èƒ½è®¿é—®æ‰€æœ‰å†…å­˜ç©ºé—´ï¼Œåªèƒ½è®¿é—®éƒ¨åˆ†ç©ºé—´è¿™ä¸ªæ—¶å€™DMAè®¿é—®çš„åœ°å€ç©ºé—´éœ€è¦åˆ’åˆ†å‡ºæ¥ç®¡ç†ï¼Œå¯¹äºæ”¯æŒå†…å­˜æ’æ‹”çš„åœºæ™¯ä¹Ÿéœ€è¦ä¸€å¥—æœºåˆ¶æ¥ç®¡ç†è€Œè¿™äº›æ˜¯Memblockåšä¸åˆ°çš„ã€‚</p><h2 id="å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</h2><p>Linuxä½¿ç”¨ä¸¤ç§å†…å­˜æ¨¡å‹FLATMEMå’ŒSPARSEMã€‚æ‰€æœ‰çš„å†…å­˜æ¨¡å‹éƒ½ä½¿ç”¨æ’åˆ—åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªæ•°ç»„ä¸­çš„ struct page æ¥è·Ÿè¸ªç‰©ç†é¡µå¸§çš„çŠ¶æ€ã€‚ æ— è®ºé€‰æ‹©å“ªç§å†…å­˜æ¨¡å‹ï¼Œç‰©ç†é¡µæ¡†å·ï¼ˆPFNï¼‰å’Œç›¸åº”çš„ struct page ä¹‹é—´éƒ½å­˜åœ¨ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ã€‚ æ¯ä¸ªå†…å­˜æ¨¡å‹éƒ½å®šä¹‰äº† pfn_to_page å’Œ page_to_pfn helperå‡½æ•°ï¼Œå…è®¸ä»PFNåˆ° struct page çš„è½¬æ¢ï¼Œåä¹‹äº¦ç„¶ã€‚</p><h3 id="flatmem">FLATMEM</h3><p>åœ¨FLATMEMå†…å­˜æ¨¡å‹ä¸­ï¼Œæœ‰ä¸€ä¸ªå…¨å±€çš„ mem_map æ•°ç»„æ¥æ˜ å°„æ•´ä¸ªç‰©ç†å†…å­˜ã€‚å¯¹äºå¤§å¤šæ•°æ¶æ„ï¼Œå­”éš™åœ¨ mem_map æ•°ç»„ä¸­éƒ½æœ‰æ¡ç›®ã€‚ä¸å­”æ´ç›¸å¯¹åº”çš„ struct pageå¯¹è±¡ä»æœªè¢«å®Œå…¨åˆå§‹åŒ–ã€‚</p><h3 id="sparsemem">SPARSEMEM</h3><p>SPARSEMEMæ˜¯Linuxä¸­æœ€é€šç”¨çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒæ˜¯å”¯ä¸€æ”¯æŒè‹¥å¹²é«˜çº§åŠŸèƒ½çš„å†…å­˜æ¨¡å‹ï¼Œå¦‚ç‰©ç†å†…å­˜çš„çƒ­æ’æ‹”ã€éæ˜“å¤±æ€§å†…å­˜è®¾å¤‡çš„æ›¿ä»£å†…å­˜å›¾å’Œè¾ƒå¤§ç³»ç»Ÿçš„å†…å­˜å›¾çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p><p>SPARSEMEMæ¨¡å‹å°†ç‰©ç†å†…å­˜æ˜¾ç¤ºä¸ºä¸€ä¸ªéƒ¨åˆ†çš„é›†åˆã€‚ä¸€ä¸ªåŒºæ®µç”¨mem_sectionç»“æ„ä½“è¡¨ç¤ºï¼Œå®ƒåŒ…å« section_mem_map ï¼Œä»é€»è¾‘ä¸Šè®²ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ struct pageé˜µåˆ—çš„æŒ‡é’ˆã€‚ç„¶è€Œï¼Œå®ƒè¢«å­˜å‚¨åœ¨ä¸€äº›å…¶ä»–çš„magicä¸­ï¼Œä»¥å¸®åŠ©åˆ†åŒºç®¡ç†ã€‚åŒºæ®µçš„å¤§å° å’Œæœ€å¤§åŒºæ®µæ•°æ˜¯ä½¿ç”¨ SECTION_SIZE_BITS å’Œ MAX_PHYSMEM_BITS å¸¸é‡æ¥æŒ‡å®šçš„ï¼Œè¿™ä¸¤ä¸ªå¸¸é‡æ˜¯ç”±æ¯ä¸ªæ”¯æŒSPARSEMEMçš„æ¶æ„å®šä¹‰çš„ã€‚ MAX_PHYSMEM_BITSæ˜¯ä¸€ä¸ªæ¶æ„æ‰€æ”¯æŒçš„ç‰©ç†åœ°å€çš„å®é™…å®½åº¦ï¼Œè€Œ SECTION_SIZE_BITS æ˜¯ä¸€ä¸ªä»»æ„çš„å€¼ã€‚</p><p>mem_section å¯¹è±¡è¢«å®‰æ’åœ¨ä¸€ä¸ªå«åš mem_sections çš„äºŒç»´æ•°ç»„ä¸­ã€‚è¿™ä¸ªæ•°ç»„çš„å¤§å°å’Œä½ç½®å–å†³äº CONFIG_SPARSEM_EXTREME å’Œå¯èƒ½çš„æœ€å¤§æ®µæ•°:</p><ul><li>å½“ CONFIG_SPARSEMEM_EXTREME è¢«ç¦ç”¨æ—¶ï¼Œ mem_sections æ•°ç»„æ˜¯é™æ€çš„ï¼Œæœ‰NR_MEM_SECTIONS è¡Œã€‚æ¯ä¸€è¡ŒæŒæœ‰ä¸€ä¸ª mem_section å¯¹è±¡ã€‚</li><li>å½“ CONFIG_SPARSEMEM_EXTREME è¢«å¯ç”¨æ—¶ï¼Œ mem_sections æ•°ç»„è¢«åŠ¨æ€åˆ†é…ã€‚æ¯ä¸€è¡ŒåŒ…å«ä»·å€¼ PAGE_SIZE çš„ mem_section å¯¹è±¡ï¼Œè¡Œæ•°çš„è®¡ç®—æ˜¯ä¸ºäº†é€‚åº”æ‰€æœ‰çš„å†…å­˜åŒºã€‚</li></ul><p>æ¶æ„è®¾ç½®ä»£ç åº”è¯¥è°ƒç”¨sparse_init()æ¥åˆå§‹åŒ–å†…å­˜åŒºå’Œå†…å­˜æ˜ å°„ã€‚</p><p>é€šè¿‡SPARSEMEMï¼Œæœ‰ä¸¤ç§å¯èƒ½çš„æ–¹å¼å°†PFNè½¬æ¢ä¸ºç›¸åº”çš„ struct page --"classic sparse"å’Œ"sparse vmemmap"ã€‚é€‰æ‹©æ˜¯åœ¨æ„å»ºæ—¶è¿›è¡Œçš„ï¼Œå®ƒç”± CONFIG_SPARSEMEM_VMEMMAP çš„å€¼å†³å®šã€‚</p><p>Classic sparseåœ¨page-&gt;flagsä¸­ç¼–ç äº†ä¸€ä¸ªé¡µé¢çš„æ®µå·ï¼Œå¹¶ä½¿ç”¨PFNçš„é«˜ä½æ¥è®¿é—®æ˜ å°„è¯¥é¡µæ¡†çš„æ®µã€‚åœ¨ä¸€ä¸ªåŒºæ®µå†…ï¼ŒPFNæ˜¯æŒ‡å‘é¡µæ•°ç»„çš„ç´¢å¼•ã€‚</p><p>Sparse vmemmapvmemmapä½¿ç”¨è™šæ‹Ÿæ˜ å°„çš„å†…å­˜æ˜ å°„æ¥ä¼˜åŒ–pfn_to_pageå’Œpage_to_pfnæ“ä½œã€‚æœ‰ä¸€ä¸ªå…¨å±€çš„ struct page *vmemmap æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªè™šæ‹Ÿè¿ç»­çš„ struct pageå¯¹è±¡é˜µåˆ—ã€‚PFNæ˜¯è¯¥æ•°ç»„çš„ä¸€ä¸ªç´¢å¼•ï¼Œstruct page ä» vmemmap çš„åç§»é‡æ˜¯è¯¥é¡µçš„PFNã€‚</p><p>ä¸ºäº†ä½¿ç”¨vmemmapï¼Œä¸€ä¸ªæ¶æ„å¿…é¡»ä¿ç•™ä¸€ä¸ªè™šæ‹Ÿåœ°å€çš„èŒƒå›´ï¼Œä»¥æ˜ å°„åŒ…å«å†…å­˜æ˜ å°„çš„ç‰©ç†é¡µï¼Œå¹¶ç¡®ä¿ vmemmapæŒ‡å‘è¯¥èŒƒå›´ã€‚æ­¤å¤–ï¼Œæ¶æ„åº”è¯¥å®ç° vmemmap_populate æ–¹æ³•ï¼Œå®ƒå°†åˆ†é…ç‰©ç†å†…å­˜å¹¶ä¸ºè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ›å»ºé¡µè¡¨ã€‚å¦‚æœä¸€ä¸ªæ¶æ„å¯¹vmemmapæ˜ å°„æ²¡æœ‰ä»»ä½•ç‰¹æ®Šè¦æ±‚ï¼Œå®ƒå¯ä»¥ä½¿ç”¨é€šç”¨å†…å­˜ç®¡ç†æä¾›çš„é»˜è®¤ vmemmap_populate_basepagesã€‚</p><h2 id="mem_sectionç»„ç»‡ä¸‹çš„å†…å­˜">mem_sectionç»„ç»‡ä¸‹çš„å†…å­˜</h2><h3 id="sectionç›¸å…³å®å®šä¹‰">Sectionç›¸å…³å®å®šä¹‰</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SECTIONS_PER_ROOT       (PAGE_SIZE / sizeof (struct mem_section)) <span class="comment">// sizeof (struct mem_section) = 16  SECTIONS_PER_ROOT = 4096 / 16 = 256</span></span></span><br><span class="line"></span><br><span class="line">CONFIG_ARM64_PA_BITS=<span class="number">48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTION_SIZE_BITS 27</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PHYSMEM_BITSCONFIG_ARM64_PA_BITS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTIONS_SHIFT(MAX_PHYSMEM_BITS - SECTION_SIZE_BITS) <span class="comment">// 48 - 27 = 21</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_MEM_SECTIONS(1UL &lt;&lt; SECTIONS_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_SECTION_ROOTSDIV_ROUND_UP(NR_MEM_SECTIONS, SECTIONS_PER_ROOT) <span class="comment">// NR_SECTION_ROOTS = 2^21 / 256 = 8192</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTION_NR_TO_ROOT(sec)((sec) / SECTIONS_PER_ROOT)</span></span><br></pre></td></tr></tbody></table></figure><p>SECTION_SIZE_BITS ä¸ºä»€ä¹ˆè¦å®šä¹‰æˆ27å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„PAGE_SIZEæ˜¯4096ï¼Œè€Œ2^27 / 4096 = 32768ï¼Œè¿™åˆšå¥½æ˜¯ä¸€ä¸ªs16ç±»å‹èƒ½è¡¨ç¤ºçš„èŒƒå›´è¿™ä¸ªæ˜¯section_to_node_tableçš„æ•°æ®ç±»å‹ã€‚</p><p>æ¯ä¸€ä¸ªmem_sectionå¯ä»¥ç”¨æ¥æè¿°SECTION_SIZE_BITSä¸ªbitä½çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯2^27 = 32768 * 4k = 128M ç”¨ä¸€ä¸ªpageæ¥è¡¨ç¤ºSECTIONS_PER_ROOTï¼Œæ¯ä¸ªSECTIONS_PER_ROOTé‡Œé¢æœ‰256ä¸ªstruct mem_sectionç»“æ„ä½“ï¼Œæ¯ä¸ªstruct mem_sectionç»“æ„ä½“å¯ä»¥æè¿°ä¸€ä¸ª128Mï¼Œåˆ™SECTIONS_PER_ROOTèƒ½æè¿°çš„åœ°å€ç©ºé—´æ˜¯256 * 128M = 32G</p><p>32 * 8192 = 262144G = 256T = 2^48</p><h3 id="æ•°æ®ç»“æ„ä¸ç»„ç»‡å½¢å¼æ¦‚è§ˆ">æ•°æ®ç»“æ„ä¸ç»„ç»‡å½¢å¼æ¦‚è§ˆ</h3><p>å…ˆæ¥ä¸€å¼ æ•´ä½“å›¾ï¼Œè¡¨ç¤ºmem_sectionæ˜¯æ€ä¹ˆç»„ç»‡å†…å­˜çš„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/MemorySectionStruct.png"></p><p>é€šè¿‡ä¸€ä¸ªstruct mem_sectionæŒ‡é’ˆæ•°ç»„æ¥è¡¨ç¤ºæ‰€æœ‰PAèŒƒå›´ï¼Œå½“ç„¶å®é™…å†…å­˜æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œé‚£ä¹ˆä¼šæµªè´¹æ‰ä¸€äº›æŒ‡é’ˆå ç”¨çš„ç©ºé—´ï¼Œè€Œè¿™ä¸ªæµªè´¹ç›¸å¯¹è€Œè¨€å°±æ¯”è¾ƒå°äº†ã€‚mem_sectionæŒ‡é’ˆæ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æŒ‡å‘ä¸€ä¸ªmem_sectionç»“æ„ä½“ï¼Œä¸€ä¸ªmem_sectionç»“æ„ä½“ç®¡ç†128MByteå†…å­˜ã€‚mem_sectioné€šè¿‡ä¸€å®šçš„ç¼–ç æ–¹å¼å¯ä»¥æ‰¾åˆ°å¯¹äºçš„struct pageç»“æ„ä½“ï¼Œè€Œæ¯ä¸€ä¸ªstruct pageå¯¹åº”ç€ä¸€å—ç‰©ç†å†…å­˜ï¼Œè€Œstruct pageç»“æ„ä½“çš„è™šæ‹Ÿåœ°å€ç©ºé—´åœ¨vmemmapæ˜ å°„åŒºåŸŸï¼Œstruct pageçš„ç‰©ç†åœ°å€å¯èƒ½ä¸è¿ç»­ï¼Œä½†æ˜¯è™šæ‹Ÿåœ°å€è¿ç»­ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿å°†pageä¸pfnè¿›è¡Œå¿«é€Ÿè½¬æ¢ã€‚</p><h2 id="æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/MemorySectionStruct2.png"></p><h2 id="ç»„ç»‡å½¢å¼">ç»„ç»‡å½¢å¼</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/pglistOrigin.png"></p><p>pglist_dataå°±æ˜¯nodeèŠ‚ç‚¹ï¼Œå¯¹äºUMAå†…å­˜æ¥è®²å°±æ˜¯ä¸€ä¸ªnodeï¼Œnodeä¸‹ç®¡ç†æ•°ä¸ªzoneï¼Œåœ¨æˆ‘çš„ARM64è®¾å¤‡ä¸Šå®é™…å°±ä¸€ä¸ªzoneå°±æ˜¯Zone DMAï¼ˆARM64ä¸‹æ²¡æœ‰ZONE HIGHTï¼Œå› ä¸ºè™šæ‹Ÿå†…å­˜è¶³å¤Ÿå¤§ï¼Œä¸éœ€è¦ï¼‰ZONE DMAæŒ‰ç…§2^orderæ¬¡æ–¹ç»„ç»‡pageï¼Œæœ‰MAX_ORDER-1ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„ä¸‹åˆæ ¹æ®pageæ˜¯å¦å¯ç§»åŠ¨ã€æ˜¯å¦å¯å›æ”¶ç­‰æƒé™åˆ†MIGRATE_MAXä¸ªé“¾è¡¨æ¥ç»„ç»‡pageï¼Œè¿™ä¸ºä¼™ä¼´ç³»ç»Ÿæä¾›äº†pageçš„ç»„ç»‡å’Œç®¡ç†å½¢å¼ã€‚</p><h2 id="è°ƒè¯•">è°ƒè¯•</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/zoneinfo</span><br><span class="line"><span class="built_in">cat</span> /proc/pagetypeinfo</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82ODQ2NTk1Mg==">https://zhuanlan.zhihu.com/p/68465952<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82ODQ3MzQyOA==">https://zhuanlan.zhihu.com/p/68473428<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ARM64 çš„è™šæ‹Ÿåœ°å€è½¬æ¢åœ¨ linux ä¸­çš„å®ç°</title>
      <link href="/2021/LinuxKernel/LinuxMemoryARM64linux/"/>
      <url>/2021/LinuxKernel/LinuxMemoryARM64linux/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MemoryARM64linux.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM3MTc1NjFlMDg1MzA2ZjhjNGRlZDk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="arm64-å†…å­˜ç®¡ç†">arm64 å†…å­˜ç®¡ç†</h1><p>å¦‚å›¾æ‰€ç¤ºï¼ŒARM å¤„ç†å™¨å†…æ ¸çš„ MMU åŒ…æ‹¬ TLB å’Œé¡µè¡¨éå†å•å…ƒï¼ˆTable Walk Unitï¼‰ä¸¤ä¸ªéƒ¨ä»¶ã€‚TLB æ˜¯ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ã€‚ä¸€ä¸ªå®Œæ•´çš„é¡µè¡¨ç¿»è¯‘å’ŒæŸ¥æ‰¾çš„è¿‡ç¨‹å«ä½œé¡µè¡¨æŸ¥è¯¢ï¼Œé¡µè¡¨æŸ¥è¯¢çš„è¿‡ç¨‹ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆï¼Œä½†æ˜¯é¡µè¡¨çš„ç»´æŠ¤éœ€è¦è½¯ä»¶æ¥å®Œæˆã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mmu.png"></p><p>ä¸‹å›¾ä¸ºè¿›ç¨‹åœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„å…³ç³»ï¼Œå·¦è¾¹æ˜¯è¿›ç¨‹åœ°å€ç©ºé—´è§†å›¾ï¼Œå³è¾¹æ˜¯ç‰©ç†åœ°å€ç©ºé—´è§†å›¾ã€‚è¿›ç¨‹åœ°å€ç©ºé—´åˆåˆ†æˆå†…æ ¸ç©ºé—´ï¼ˆKermel Spaceï¼‰å’Œç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰ã€‚æ— è®ºæ˜¯å†…æ ¸ç©ºé—´è¿˜æ˜¯ç”¨æˆ·ç©ºé—´éƒ½å¯ä»¥é€šè¿‡å¤„ç†å™¨æä¾›çš„é¡µè¡¨æœºåˆ¶æ˜ å°„åˆ°å®é™…çš„ç‰©ç†åœ°å€ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/process_address.png"></p><h2 id="é¡µè¡¨">é¡µè¡¨</h2><p>åœ¨ AArch64 æ¶æ„ä¸­çš„ MMU æ”¯æŒå•ä¸€é˜¶æ®µçš„é¡µè¡¨è½¬æ¢ï¼ŒåŒæ ·ä¹Ÿæ”¯æŒè™šæ‹ŸåŒ–æ‰©å±•ä¸­ä¸¤é˜¶æ®µçš„é¡µè¡¨è½¬æ¢ã€‚</p><ul><li>å•ä¸€é˜¶æ®µçš„é¡µè¡¨è½¬æ¢ï¼ŒæŠŠè™‘è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ã€‚</li><li>ä¸¤é˜¶æ®µçš„é¡µè¡¨è½¬æ¢ï¼šåŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µã€‚åœ¨é˜¶æ®µ 1ï¼ŒæŠŠè™šæ‹Ÿåœ°å€ç¿»è¯‘æˆä¸­é—´ç‰© ï¼ˆIntermediate Phvsical Addressï¼ŒIPAï¼‰ï¼›åœ¨é˜¶æ®µ 2ï¼ŒæŠŠ IPA ç¿»è¯‘æˆæœ€ç»ˆ PA å¦å¤–ï¼ŒARMv8 æ¶æ„æ”¯æŒå¤šç§é¡µè¡¨æ ¼å¼ã€‚å…·ä½“å¦‚ä¸‹ã€‚<ul><li>ARMv8 æ¶æ„çš„é•¿æè¿°ç¬¦é¡µè¡¨æ ¼å¼ï¼ˆLong Descriptor Translation Table Formatï¼‰</li><li>ARMv7 æ¶æ„çš„é•¿æè¿°ç¬¦é¡µè¡¨æ ¼å¼ï¼Œéœ€è¦æ‰“å¼€å¤§ç‰©ç†åœ°å€æ‰©å±•ï¼ˆLarge PhysicalA Extention, LPAEï¼‰</li><li>ARMv7 åŠ æ„çš„çŸ­æè¿°ç¬¦é¡µè¡¨æ ¼å¼ï¼ˆShort Descriptor Translation Table Formatï¼‰</li></ul></li></ul><p>ARMv8 æ¶æ„è¿˜æ”¯æŒ 4KBã€16KB æˆ– 64KB è¿™ 3 ç§é¡µé¢ç²’åº¦ã€‚</p><h2 id="é¡µè¡¨æ˜ å°„">é¡µè¡¨æ˜ å°„</h2><p>åœ¨ AArch64 æ¶æ„ä¸­ï¼Œå› ä¸ºåœ°å€æ€»çº¿ä½å®½æœ€å¤šæ”¯æŒ 48 ä½ï¼Œæ‰€ä»¥ VA è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªç©ºé—´ï¼Œæ¯ä¸ªç©ºé—´æœ€å¤šæ”¯æŒ 256TBã€‚</p><ul><li>ä½ä½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä½äº 0x0000 0000 0000 0000 åˆ° 0x0000 FFFF FFFF FFFFã€‚è™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½ç­‰äº 0ï¼Œå°±ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨ TTBRO_ELx æ¥å­˜æ”¾çš„åŸºåœ°å€ã€‚</li><li>é«˜ä½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä½äº 0xFFFF 0000 0000 0000 åˆ° 0xFFFF FFFF FFFF FFFFã€‚è™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½ç­‰äº 1ï¼Œå°±ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨ TTBR1_ELx æ¥å­˜æ”¾çš„åŸºåœ°å€ã€‚</li></ul><p>AArch64 æ¶æ„ä¸­çš„é¡µè¡¨æ”¯æŒå¦‚ä¸‹ç‰¹æ€§ã€‚</p><ul><li>æœ€å¤šå¯ä»¥æ”¯æŒ 4 çº§é¡µè¡¨</li><li>è¾“å…¥åœ°å€çš„æœ€å¤§æœ‰æ•ˆä½å®½ä¸º 48 ä½</li><li>è¾“å‡ºåœ°å€çš„æœ€å¤§æœ‰æ•ˆä½å®½ä¸º 48 ä½</li><li>ç¿»è¯‘çš„é¡µé¢ç²’åº¦å¯ä»¥æ˜¯ 4KBã€16KB æˆ– 64KB</li></ul><p>æ³¨æ„ï¼Œæœ¬æ–‡ä»¥ 4KB å¤§å°çš„é¡µé¢å’Œ 48 ä½åœ°å€å®½åº¦ä¸ºä¾‹æ¥è¯´æ˜ AArch64 æ¶æ„é¡µè¡¨æ˜ å°„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºä¸º AArch64 æ¶æ„çš„åœ°å€æ˜ å°„ï¼Œå…¶ä¸­é¡µé¢æ˜¯ 4KB çš„å°é¡µé¢ã€‚å½“ TLB æœªå‘½ä¸­æ—¶ï¼Œå¤„ç†å™¨æŸ¥è¯¢é¡µè¡¨çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/aarch64_addr.png"></p><ul><li>å¤„ç†å™¨æ ¹æ®é¡µè¡¨åŸºåœ°å€æ§åˆ¶å¯„å­˜å™¨å’Œè™šæ‹Ÿåœ°å€æ¥åˆ¤æ–­ä½¿ç”¨å“ªä¸ªé¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ TTBRO è¿˜æ˜¯ TTBR1ã€‚å½“è™šæ‹Ÿåœ°å€ç¬¬ 63 ä½ç®€ç§° VA[63] ä¸º 1 æ—¶é€‰æ‹© TTBR1ï¼›å½“ VA[63] ä¸º 0 æ—¶é€‰æ‹© TTBR0ã€‚é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ä¸­å­˜æ”¾ç€ 1 çº§é¡µè¡¨</li><li>å¤„ç†å™¨å°† VA[47:39] ä½œä¸º L0 ç´¢å¼•ï¼Œåœ¨ 1 çº§é¡µè¡¨ï¼ˆL0 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°é¡µè¡¨é¡¹ï¼Œ1 çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹</li><li>1 çº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€ 2 çº§é¡µè¡¨ï¼ˆL1 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨å°† VA[38] ä½œä¸º L1 ç´¢å¼•ï¼Œåœ¨ 2 çº§é¡µè¡¨ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼Œ2 çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹</li><li>2 çº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€ 3 çº§é¡µè¡¨ï¼ˆL2 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨ä»¥ VA[29:21] ä½œä¸º L2 ç´¢å¼•ï¼Œåœ¨ 3 çº§é¡µè¡¨ï¼ˆL2 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼Œ3 çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹</li><li>3 çº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€ 4 çº§é¡µè¡¨ï¼ˆL3 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨ä»¥ VA[20:12] ä½œä¸º L3 ç´¢å¼•ï¼Œåœ¨ 4 çº§é¡µè¡¨ï¼ˆL3 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼Œ4 çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹</li><li>4 çº§é¡µè¡¨çš„é¡µè¡¨é¡¹é‡Œå­˜æ”¾ç€ 4KB é¡µé¢çš„ç‰©ç†åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š VA[11ï¼š0]ï¼Œå°±æ„æˆäº†æ–°çš„ç‰©ç†åœ°å€ï¼Œå› æ­¤å¤„ç†å™¨å°±å®Œæˆäº†é¡µè¡¨çš„æŸ¥è¯¢å’Œç¿»è¯‘å·¥ä½œ</li></ul><h2 id="é¡µè¡¨é¡¹æè¿°ç¬¦">é¡µè¡¨é¡¹æè¿°ç¬¦</h2><p>ä»ä¸‹å›¾å¯çŸ¥ï¼ŒAArch64 æ¶æ„é¡µè¡¨åˆ†æˆ 4 çº§é¡µè¡¨ï¼Œæ¯ä¸€çº§é¡µè¡¨éƒ½æœ‰é¡µè¡¨é¡¹ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ç§°ä¸ºé¡µè¡¨é¡¹æè¿°ç¬¦ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹æè¿°ç¬¦å  8 å­—èŠ‚ï¼Œé‚£ä¹ˆè¿™äº›é¡µè¡¨é¡¹æè¿°ç¬¦çš„æ ¼å¼å’Œå†…å®¹æ˜¯å¦éƒ½ä¸€æ ·ï¼Ÿ</p><h3 id="l0l2-é¡µè¡¨é¡¹æè¿°ç¬¦">L0~L2 é¡µè¡¨é¡¹æè¿°ç¬¦</h3><p>AArch64 æ¶æ„ä¸­ L0 ~ L3 é¡µè¡¨é¡¹æè¿°ç¬¦çš„æ ¼å¼ä¸å®Œå…¨ä¸€æ ·ï¼Œå…¶ä¸­ L0 ~ L2 é¡µè¡¨é¡¹çš„å†…å®¹æ¯”è¾ƒç±»ä¼¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/l0_l2.png"></p><p>L0~L2 é¡µè¡¨é¡¹æ ¹æ®å†…å®¹å¯ä»¥åˆ†æˆ 3 ç±»ï¼Œä¸€æ˜¯æ— æ•ˆçš„é¡µè¡¨é¡¹ï¼ŒäºŒæ˜¯å—ï¼ˆblockï¼‰ç±»å‹çš„é¡µè¡¨é¡¹ï¼Œä¸‰æ˜¯é¡µè¡¨ï¼ˆtableï¼‰ç±»å‹çš„é¡µè¡¨é¡¹ã€‚</p><ul><li>å½“é¡µè¡¨é¡¹æè¿°ç¬¦ Bit[0] ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºæœ‰æ•ˆçš„æè¿°ç¬¦ï¼›å½“ Bit[0] ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæ— æ•ˆæè¿°ç¬¦</li><li>é¡µè¡¨é¡¹æè¿°ç¬¦ Bit[1] ç”¨æ¥è¡¨ç¤ºç±»å‹<ul><li>é¡µè¡¨ç±»å‹ï¼šå½“ Bit[1] ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºè¯¥æè¿°ç¬¦åŒ…å«äº†æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨çš„åŸºåœ°å€ï¼Œæ˜¯ä¸€ä¸ªé¡µè¡¨ç±»å‹çš„é¡µè¡¨é¡¹</li><li>å—ç±»å‹ï¼Œå½“ Bit[1] ä¸º 0 æ—¶è¡¨ç¤ºä¸€ä¸ªå¤§å†…å­˜å—ï¼ˆmemory blockï¼‰çš„é¡µè¡¨é¡¹ï¼Œå…¶ä¸­åŒ…å«äº†æœ€ç»ˆçš„ç‰©ç†åœ°å€ã€‚å¤§å†…å­˜å—é€šå¸¸æ˜¯ç”¨æ¥æè¿°å¤§çš„è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå¦‚ 2MBit æˆ–è€… 1GB å¤§å°çš„è¿ç»­ç‰©ç†å†…å­˜</li></ul></li><li>åœ¨å—ç±»å‹çš„é¡µè¡¨é¡¹ä¸­ï¼ŒBit[47ï¼šn] è¡¨ç¤ºæœ€ç»ˆè¾“å‡ºçš„ç‰©ç†åœ°å€<ul><li>è‹¥é¡µé¢ç²’åº¦æ˜¯ 4KBï¼Œåœ¨ L1 é¡µè¡¨é¡¹æè¿°ç¬¦ä¸­ n ä¸º 30ï¼Œè¡¨ç¤º 1GB å¤§å°çš„è¿ç»­ç‰©å­˜ã€‚åœ¨ L2 é¡µè¡¨é¡¹æè¿°ç¬¦ä¸­ n ä¸º 21ï¼Œç”¨æ¥è¡¨ç¤º 2MB å¤§å°çš„è¿ç»­ç‰©ç†å†…å­˜</li><li>è‹¥é¡µé¢ç²’åº¦ä¸º 16KBï¼Œåœ¨ L2 é¡µè¡¨é¡¹æè¿°ç¬¦ä¸­ n ä¸º 25ï¼Œç”¨æ¥è¡¨ç¤º 32MB å¤§å°çš„è¿ç»­ç‰©ç†å†…å­˜</li></ul></li><li>åœ¨å—ç±»å‹çš„é¡µè¡¨é¡¹ä¸­ï¼ŒBit[11ï¼š2] æ˜¯ä½ä½å±æ€§ï¼ˆlower attributeï¼‰ï¼ŒBit[63:52] æ˜¯é«˜ä½å±æ€§ (upper attribute)</li><li>åœ¨é¡µè¡¨ç±»å‹çš„é¡µè¡¨é¡¹æè¿°ç¬¦ä¸­ï¼ŒBit[47ï¼šm] ç”¨æ¥æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨çš„åŸºåœ°å€<ul><li>å½“é¡µé¢ç²’åº¦ä¸º 4KB æ—¶ m ä¸º 12</li><li>å½“é¡µé¢ç²’åº¦ä¸º 16KB æ—¶ m ä¸º 14</li><li>å½“é¡µé¢ç²’åº¦ä¸º 64KB æ—¶ m ä¸º 16</li></ul></li></ul><h3 id="l3-é¡µè¡¨é¡¹æè¿°ç¬¦">L3 é¡µè¡¨é¡¹æè¿°ç¬¦</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒL3 é¡µè¡¨é¡¹æè¿°ç¬¦åŒ…å« 5 ç§é¡µè¡¨é¡¹ï¼Œåˆ†åˆ«æ˜¯æ— æ•ˆçš„é¡µè¡¨é¡¹ã€ä¿ç•™çš„é¡µè¡¨é¡¹ 4KB ç²’åº¦çš„é¡µè¡¨é¡¹ã€16KB ç²’åº¦çš„é¡µè¡¨é¡¹ã€64KB ç²’åº¦çš„é¡µè¡¨é¡¹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/l3.png"></p><p>L3 é¡µè¡¨é¡¹æè¿°ç¬¦çš„æ ¼å¼å¦‚ä¸‹ã€‚</p><ul><li>å½“é¡µè¡¨é¡¹æè¿°ç¬¦ Bit[0] ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºæœ‰æ•ˆçš„æè¿°ç¬¦ï¼›å½“ Bit[0] ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæ— æ•ˆæè¿°ç¬¦</li><li>å½“é¡µè¡¨é¡¹æè¿°ç¬¦ Bit[1] ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºä¿ç•™é¡µè¡¨é¡¹ï¼›å½“ Bit[1] ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºé¡µè¡¨ç±»å‹çš„é¡µè¡¨é¡¹</li><li>é¡µè¡¨æè¿°ç¬¦ Bit[11ï¼š2] æ˜¯ä½ä½å±æ€§ï¼ŒBit[63:51] æ˜¯é«˜ä½å±æ€§</li><li>é¡µè¡¨æè¿°ç¬¦ä¸­é—´çš„ä½åŸŸä¸­åŒ…å«äº†è¾“å‡ºåœ°å€ï¼ˆoutput addressï¼‰ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆç‰©ç†é¡µé¢çš„é«˜åœ°å€æ®µ<ul><li>å½“é¡µé¢ç²’åº¦ä¸º 4KB æ—¶è¾“å‡ºåœ°å€ä¸º Bit[47:12]</li><li>å½“é¡µé¢ç²’åº¦ä¸º 16KB æ—¶è¾“å‡ºåœ°å€ä¸º Bit[47:14]</li><li>å½“é¡µé¢ç²’åº¦ä¸º 64KB æ—¶è¾“å‡ºåœ°å€ä¸º Bit[47:16]</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/page_attr.png"></p><h1 id="linux-å†…æ ¸ä¸­çš„é¡µè¡¨">Linux å†…æ ¸ä¸­çš„é¡µè¡¨</h1><p>åœ¨ ARM64 çš„ Linux å†…æ ¸ä¸­é‡‡ç”¨ä»¥ä¸‹ 4 çº§åˆ†é¡µæ¨¡å‹ï¼š</p><ul><li>é¡µå…¨å±€ç›®å½•ï¼ˆPage Global Directoryï¼ŒPGDï¼‰</li><li>é¡µä¸Šçº§ç›®å½•ï¼ˆPage Upper Directoryï¼ŒPUDï¼‰</li><li>é¡µä¸­é—´ç›®å½•ï¼ˆPage Middle Directoryï¼ŒPMDï¼‰</li><li>é¡µè¡¨ï¼ˆPage Tableï¼ŒPTï¼‰</li></ul><p>ä¸Šè¿° 4 çº§åˆ†é¡µæ¨¡å‹åˆ†åˆ«å¯¹åº” ARMv8 æ¶æ„é¡µè¡¨çš„ L0~L3 é¡µè¡¨ã€‚ä¸Šè¿° 4 çº§åˆ†é¡µæ¨¡å‹åœ¨ 64 ä½è™šæ‹Ÿåœ°å€çš„åˆ’åˆ†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Linux_page.png"></p><p>64 ä½çš„è™šæ‹Ÿåœ°å€åˆ†æˆå¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ã€‚</p><ul><li>Bit[63]ï¼šç”¨æ¥é€‰æ‹©é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨</li><li>Bit[62:48]ï¼šä¿ç•™</li><li>Bit[47:39]ï¼šè¡¨ç¤º PGD ç´¢å¼•ï¼Œå³ ARM64 ä¸­çš„ L0 ç´¢å¼•</li><li>Bit[38:30]ï¼šè¡¨ç¤º PUD ç´¢å¼•ï¼Œå³ ARM64 ä¸­çš„ L1 ç´¢å¼•</li><li>Bit[29:21]ï¼šè¡¨ç¤º PMD ç´¢å¼•ï¼Œå³ ARM64 ä¸­çš„ L2 ç´¢å¼•</li><li>Bit[20:12]ï¼šè¡¨ç¤º PT ç´¢å¼•ï¼Œå³ ARM64 ä¸­çš„ L3 ç´¢å¼•</li><li>Bit[11:0]ï¼šè¡¨ç¤ºé¡µé¢å†…çš„åç§»é‡</li></ul><p>åŸºäº ARMv8-A æ¶æ„çš„å¤„ç†å™¨å¯ä»¥é€šè¿‡é…ç½® ARM64_VA_BITS å®æ¥è®¾ç½®è™šæ‹Ÿåœ°å€çš„å®½åº¦ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/Kconfig&gt;</span><br><span class="line">config ARM64_VA_BITS</span><br><span class="line">    int</span><br><span class="line">    default 39 if ARM64_VA_BITS_39</span><br><span class="line">    default 42 if ARM64_VA_BITS_42</span><br><span class="line">    default 48 if ARM64_VA_BITS_48</span><br></pre></td></tr></tbody></table></figure><p>å¦å¤–ï¼ŒåŸºäº ARMv8-A æ¶æ„çš„å¤„ç†å™¨æ”¯æŒçš„æœ€å¤§ç‰©ç†åœ°å€å®½åº¦ä¹Ÿæ˜¯ 48 ä½ã€‚ Linux å†…å­˜ç©ºé—´å¸ƒå±€ä¸åœ°å€æ˜ å°„çš„ç²’åº¦å’Œåœ°å€æ˜ å°„çš„å±‚çº§æœ‰å…³ã€‚åŸºäº ARMv8-A æ¶æ„çš„å¤„ç†å™¨æ”¯æŒçš„é¡µé¢ç²’åº¦å¯ä»¥æ˜¯ 4KBã€16KB æˆ–è€… 64KBã€‚æ˜ å°„çš„å±‚çº§å¯ä»¥æ˜¯ 3 çº§æˆ–è€… 4 çº§ã€‚</p><h2 id="aarch64-åœ¨-linux-ä¸­çš„å†…å­˜å¸ƒå±€">AArch64 åœ¨ Linux ä¸­çš„å†…å­˜å¸ƒå±€</h2><p>AArch64 Linux ä½¿ç”¨ 3 çº§æˆ– 4 çº§è½¬æ¢è¡¨ï¼Œå…¶é¡µå¤§å°é…ç½®ä¸º 4KBï¼Œå¯¹äºç”¨æˆ·å’Œå†…æ ¸åˆ†åˆ«éƒ½æœ‰ 39-bit (512GB) æˆ– 48-bit (256TB) çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å¯¹äºé¡µå¤§å°ä¸º 64KB çš„é…ç½®ï¼Œä»…ä½¿ç”¨ 2 çº§è½¬æ¢è¡¨ï¼Œæœ‰ 42-bit (4TB) çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½†å†…å­˜å¸ƒå±€ç›¸åŒã€‚</p><p>ç”¨æˆ·åœ°å€ç©ºé—´çš„ 63:48 ä½ä¸º 0ï¼Œè€Œå†…æ ¸åœ°å€ç©ºé—´çš„ç›¸åº”ä½ä¸º 1ã€‚TTBRx çš„é€‰æ‹©ç”±è™šæ‹Ÿåœ°å€çš„ 63 ä½ç»™å‡ºã€‚swapper_pg_dir ä»…åŒ…å«å†…æ ¸ï¼ˆå…¨å±€ï¼‰æ˜ å°„ï¼Œè€Œç”¨æˆ· pgd ä»…åŒ…å«ç”¨æˆ·ï¼ˆéå…¨å±€ï¼‰æ˜ å°„ã€‚swapper_pg_dir åœ°å€è¢«å†™å…¥ TTBR1 ä¸­ï¼Œä¸”ä»ä¸å†™å…¥ TTBR0ã€‚</p><p>AArch64 Linux åœ¨é¡µå¤§å°ä¸º 4KBï¼Œå¹¶ä½¿ç”¨ 4 çº§è½¬æ¢è¡¨æ—¶çš„å†…å­˜å¸ƒå±€ï¼š</p><pre><code>èµ·å§‹åœ°å€            ç»“æŸåœ°å€            å¤§å°      ç”¨é€”-----------------------------------------------------------------------0000000000000000    0000ffffffffffff     256TB      ç”¨æˆ·ç©ºé—´ffff000000000000    ffffffffffffffff     256TB      å†…æ ¸ç©ºé—´</code></pre><p>AArch64 Linux åœ¨é¡µå¤§å°ä¸º 64KBï¼Œå¹¶ä½¿ç”¨ 2 çº§è½¬æ¢è¡¨æ—¶çš„å†…å­˜å¸ƒå±€ï¼š</p><pre><code>èµ·å§‹åœ°å€            ç»“æŸåœ°å€            å¤§å°      ç”¨é€”-----------------------------------------------------------------------0000000000000000    000003ffffffffff       4TB      ç”¨æˆ·ç©ºé—´fffffc0000000000    ffffffffffffffff       4TB      å†…æ ¸ç©ºé—´</code></pre><p>æ›´è¯¦ç»†çš„å†…æ ¸è™šæ‹Ÿå†…å­˜å¸ƒå±€ï¼Œè¯·å‚é˜…å†…æ ¸å¯åŠ¨ä¿¡æ¯ã€‚</p><p>4KB é¡µå¤§å°çš„è½¬æ¢è¡¨æŸ¥æ‰¾ï¼š</p><pre><code>+--------+--------+--------+--------+--------+--------+--------+--------+|63    56|55    48|47    40|39    32|31    24|23    16|15     8|7      0|+--------+--------+--------+--------+--------+--------+--------+--------+ |                 |         |         |         |         | |                 |         |         |         |         v |                 |         |         |         |   [11:0]  é¡µå†…åç§» |                 |         |         |         +-&gt; [20:12] L3 ç´¢å¼• |                 |         |         +-----------&gt; [29:21] L2 ç´¢å¼• |                 |         +---------------------&gt; [38:30] L1 ç´¢å¼• |                 +-------------------------------&gt; [47:39] L0 ç´¢å¼• +-------------------------------------------------&gt; [63] TTBR0/1</code></pre><p>64KB é¡µå¤§å°çš„è½¬æ¢è¡¨æŸ¥æ‰¾ï¼š</p><pre><code>+--------+--------+--------+--------+--------+--------+--------+--------+|63    56|55    48|47    40|39    32|31    24|23    16|15     8|7      0|+--------+--------+--------+--------+--------+--------+--------+--------+ |                 |    |               |              | |                 |    |               |              v |                 |    |               |            [15:0]  é¡µå†…åç§» |                 |    |               +----------&gt; [28:16] L3 ç´¢å¼• |                 |    +--------------------------&gt; [41:29] L2 ç´¢å¼• |                 +-------------------------------&gt; [47:42] L1 ç´¢å¼• +-------------------------------------------------&gt; [63] TTBR0/1</code></pre><p>å½“ä½¿ç”¨ KVM æ—¶ï¼Œç®¡ç†ç¨‹åºï¼ˆhypervisorï¼‰åœ¨ EL2 ä¸­é€šè¿‡ç›¸å¯¹å†…æ ¸è™šæ‹Ÿåœ°å€çš„ä¸€ä¸ªå›ºå®šåç§»æ¥æ˜ å°„å†…æ ¸é¡µï¼ˆå†…æ ¸è™šæ‹Ÿåœ°å€çš„é«˜ 24 ä½è®¾ä¸ºé›¶ï¼‰:</p><pre><code>èµ·å§‹åœ°å€            ç»“æŸåœ°å€            å¤§å°      ç”¨é€”-----------------------------------------------------------------------0000004000000000    0000007fffffffff     256GB      åœ¨ HYP ä¸­æ˜ å°„çš„å†…æ ¸å¯¹è±¡</code></pre><h1 id="é«˜é€Ÿç¼“å­˜ç®¡ç†">é«˜é€Ÿç¼“å­˜ç®¡ç†</h1><p>ARM64 æŒ‡ä»Šé›†æä¾›äº†å¯¹é«˜é€Ÿç¼“å­˜è¿›è¡Œç®¡ç†çš„æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ç®¡ç†æ— æ•ˆé«˜é€Ÿç¼“å­˜å’Œæ¸…é™¤é«˜é€Ÿç¼“å­˜çš„æŒ‡ä»¤ã€‚é«˜é€Ÿç¼“å­˜çš„ç®¡ç†ä¸»è¦æœ‰å¦‚ä¸‹ 3 ç§æƒ…å†µã€‚</p><ul><li>ä½¿æ•´ä¸ªé«˜é€Ÿç¼“å­˜æˆ–è€…æŸä¸ªé«˜é€Ÿç¼“å­˜è¡Œæ— æ•ˆã€‚</li><li>æ¸…é™¤ï¼ˆcleanï¼‰æ•´ä¸ªé«˜é€Ÿç¼“å­˜æˆ–è€…æŸä¸ªé«˜é€Ÿç¼“å­˜è¡Œã€‚ä¹‹åï¼Œç›¸åº”çš„é«˜é€Ÿç¼“å­˜è¡Œä¼šè¢«æ ‡ä¸ºè„çš„ï¼Œæ•°æ®ä¼šå†™å›åˆ°ä¸‹ä¸€çº§é«˜é€Ÿç¼“å­˜ä¸­æˆ–è€…ä¸»å­˜å‚¨å™¨ä¸­ã€‚</li><li>æ¸…é›¶ï¼ˆzeroï¼‰æ“ä½œã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯¹é«˜é€Ÿç¼“å­˜è¿›è¡Œæ¸…é›¶æ“ä½œä»¥èµ·åˆ°ä¸€ä¸ªé¢„å–å’ŒåŠ é€Ÿçš„ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œå½“ç¨‹åºéœ€è¦ä½¿ç”¨è¾ƒå¤§çš„ä¸´æ—¶å†…å­˜æ—¶ï¼Œå¦‚æœåœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹è¿™ä¸ªå†…å­˜è¡Œæ¸…é›¶æ“ä½œï¼Œé«˜é€Ÿç¼“å­˜æ§åˆ¶å™¨å°±ä¼šä¸»åŠ¨æŠŠè¿™äº›é›¶æ•°æ®å†™å…¥é«˜é€Ÿç¼“å­˜è¡Œä¸­ã€‚è‹¥ç¨‹åºä¸»åŠ¨ä½¿ç”¨é«˜é€Ÿç¼“å­˜çš„æ¸…é›¶æ“ä½œï¼Œé‚£ä¹ˆå°†å¤§å¤§å‡å°‘ç³»ç»Ÿå†…éƒ¨æ€»çº¿çš„å¸¦å®½ã€‚</li></ul><p>å¯¹é«˜é€Ÿç¼“å­˜çš„æ“ä½œå¯ä»¥æŒ‡å®šå¦‚ä¸‹ä¸åŒçš„èŒƒå›´ã€‚</p><ul><li>æ•´å—é«˜é€Ÿç¼“å­˜</li><li>æŸä¸ªè™šæ‹Ÿåœ°å€</li><li>ç‰¹å®šçš„é«˜é€Ÿç¼“å­˜è¡Œæˆ–è€…ç»„å’Œè·¯</li></ul><p>å¦å¤–ï¼Œåœ¨ ARMv8 æ¶æ„ä¸­æœ€å¤šå¯ä»¥æ”¯æŒ 7 çº§çš„é«˜é€Ÿç¼“å­˜ï¼Œå³ L1~L7 é«˜é€Ÿç¼“å­˜ã€‚å½“å¯¹ä¸€ä¸ªé«˜é€Ÿç¼“å­˜è¡Œè¿›è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“é«˜é€Ÿç¼“å­˜æ“ä½œçš„èŒƒå›´ã€‚ARMv8 æ¶æ„ä¸­å°†ä»ä»¥ä¸‹è§’åº¦è§‚å¯Ÿå†…å­˜ã€‚</p><ul><li>å…¨å±€ç¼“å­˜ä¸€è‡´æ€§è§’åº¦ï¼ˆPoint of Coherencyï¼ŒPoCï¼‰ï¼šç³»ç»Ÿä¸­æ‰€æœ‰å¯ä»¥å‘èµ·å†…å­˜è®¿é—®çš„ç¡¬ä»¶å•å…ƒï¼ˆå¦‚å¤„ç†å™¨ã€DMA è®¾å¤‡ã€GPU ç­‰ï¼‰éƒ½èƒ½ä¿è¯è§‚å¯Ÿåˆ°çš„æŸä¸€ä¸ªåœ°å€ä¸Šçš„æ•°æ®æ˜¯ä¸€è‡´çš„æˆ–è€…æ˜¯ç›¸åŒçš„å‰¯æœ¬ã€‚é€šå¸¸ PoC è¡¨ç¤ºç«™åœ¨ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹é«˜é€Ÿç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜ã€‚</li><li><p>å¤„ç†å™¨ç¼“å­˜ä¸€è‡´æ€§è§’åº¦ï¼ˆPoint of Unificationï¼ŒPoUï¼‰ï¼šè¡¨ç¤ºç«™åœ¨å¤„ç†å™¨è§’åº¦æ¥çœ‹é«˜é€Ÿç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜ã€‚å¯¹äºä¸€ä¸ªå†…éƒ¨å…±äº«ï¼ˆinner shareableï¼‰çš„ PoUï¼Œæ‰€æœ‰çš„å¤„ç†å™¨éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„å†…å­˜å‰¯æœ¬ å‡è®¾åœ¨ä¸€ä¸ªåŒæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½æœ‰ç‹¬è‡ªçš„ L1 é«˜é€Ÿç¼“å­˜ï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ª L2 é«˜é€Ÿç¼“å­˜ï¼Œå®ƒä»¬éƒ½å¯ä»¥å…±åŒè®¿é—® DDR4 å†…å­˜ã€‚å¦å¤–ï¼Œç³»ç»Ÿä¸­è¿˜æœ‰ GPU ç­‰ç¡¬ä»¶å•å…ƒã€‚</p></li><li>å¦‚æœä»¥ PoU çœ‹é«˜é€Ÿç¼“å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªè§‚å¯Ÿç‚¹å°±æ˜¯ L2 é«˜é€Ÿç¼“å­˜ï¼Œå› ä¸ºä¸¤ä¸ªå¤„ç†å™¨éƒ½å¯ä»¥åœ¨ L2 é«˜é€Ÿç¼“å­˜ä¸­çœ‹åˆ°ç›¸åŒçš„å‰¯æœ¬ã€‚</li><li><p>å¦‚æœä»¥ PoC çœ‹é«˜é€Ÿç¼“å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªè§‚å¯Ÿç‚¹æ˜¯ DDR4 å†…å­˜ï¼Œå› ä¸º CPU å’Œ GPU éƒ½èƒ½å…±åŒè®¿é—® DDR4 å†…å­˜ã€‚</p></li></ul><p>ARMv8 æ¶æ„æä¾› DC å’Œ IC ä¸¤æ¡ä¸é«˜é€Ÿç¼“å­˜ç›¸å…³çš„æŒ‡ä»¤ï¼Œå®ƒä»¬æ ¹æ®ä¸åŒçš„è¾…åŠ©æ“ä½œç¬¦å¯ä»¥æœ‰ä¸åŒçš„å«ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//DC æŒ‡ä»¤çš„æ ¼å¼</span><br><span class="line">DC &lt;dc_op&gt;, &lt;Xt&gt;</span><br><span class="line">//IC æŒ‡ä»¤çš„æ ¼å¼</span><br><span class="line">Ic &lt;ic_op&gt; &lt;Xt&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>DCï¼š<ul><li>ciswï¼šæ¸…é™¤å¹¶ä½¿æŒ‡å®šçš„ç»„å’Œè·¯çš„é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li><li>civacï¼šä» PoCï¼Œæ¸…é™¤å¹¶ä½¿æŒ‡å®šçš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li><li>cswï¼šæ¸…é™¤æŒ‡å®šçš„ç»„æˆ–è·¯çš„é«˜é€Ÿç¼“å­˜</li><li>cvacï¼šä» PoCï¼Œæ¸…é™¤æŒ‡å®šçš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„é«˜é€Ÿç¼“å­˜</li><li>cvauï¼šä» PoUï¼Œæ¸…é™¤æŒ‡å®šçš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„é«˜é€Ÿç¼“å­˜</li><li>iswï¼šä½¿æŒ‡å®šçš„ç»„æˆ–è·¯çš„é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li><li>ivacï¼šä» PoCï¼Œä½¿æŒ‡å®šçš„è™šæ‹Ÿåœ°å€ä¸­å¯¹åº”çš„é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li><li>zvaï¼šæŠŠè™šæ‹Ÿåœ°å€ä¸­çš„é«˜é€Ÿç¼“å­˜æ¸…é›¶</li></ul></li><li>ICï¼š<ul><li>ialluisï¼šä» PoUï¼Œä½¿æ‰€æœ‰çš„æŒ‡ä»¤é«˜é€Ÿç¼“å­˜æ— æ•ˆï¼Œå†…éƒ¨å…±äº«å±æ€§</li><li>ialluï¼šä» PoUï¼Œä½¿æ‰€æœ‰çš„æŒ‡ä»¤é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li><li>ivauï¼šä» PoUï¼Œä½¿æŒ‡å®šè™šæ‹Ÿåœ°å€å¯¹åº”çš„æŒ‡ä»¤é«˜é€Ÿç¼“å­˜æ— æ•ˆ</li></ul></li></ul><p>Linux å†…æ ¸æä¾›äº†å¤šä¸ªä¸é«˜é€Ÿç¼“å­˜ç®¡ç†ç›¸å…³çš„æ¥å£å‡½æ•°ï¼Œå®ƒä»¬å®šä¹‰åœ¨ arch/arm64/include/asm/cacheflush.h å¤´æ–‡ä»¶ä¸­ï¼Œå®ƒä»¬å®ç°åœ¨ arch/arm64/mm/cache.S æ±‡ç¼–æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flush_cache_mm(mm) <span class="comment">//åœ¨ä¿®æ”¹é¡µè¡¨ä¹‹å‰æ¸…é™¤å’Œæ— æ•ˆè¯¥è¿›ç¨‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­æ‰€æœ‰çš„é«˜é€Ÿç¼“å­˜é¡µè¡¨é¡¹</span></span><br><span class="line">flush_icache_range(start, end)<span class="comment">//ç”¨äºåŒæ­¥ç”±è™šæ‹Ÿåœ°å€ start å’Œ end ç»„æˆçš„åŒºåŸŸçš„æŒ‡ä»¤é«˜é€Ÿç¼“å­˜ä¸æ•°æ®é«˜é€Ÿç¼“å­˜çš„-è‡´æ€§</span></span><br><span class="line">flush_cache_page(vma, addr, pfin)<span class="comment">//ç”¨äºæ¸…é™¤ç”±è™šæ‹Ÿåœ°å€ addr å’Œé¡µå¸§å· pfn å¯¹åº”çš„é«˜é€Ÿç¼“å­˜é¡µè¡¨é¡¹</span></span><br><span class="line">flush_cache_range(vma, start, end)<span class="comment">//ç”¨äºæ¸…é™¤ç”±è™šæ‹Ÿåœ°å€ start å’Œ end ç»„æˆçš„åŒºåŸŸä¸­æ‰€æœ‰çš„é«˜é€Ÿç¼“å­˜</span></span><br></pre></td></tr></tbody></table></figure><h1 id="å†…å­˜å±æ€§">å†…å­˜å±æ€§</h1><p>ARMv8 æ¶æ„å¤„ç†å™¨å®ç°äº†å¼±ä¸€è‡´æ€§å†…å­˜æ¨¡å‹ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¤„ç†å™¨åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶ä¸ä¸€å®šå®Œå…¨æŒ‰ç…§ç¨‹åºå‘˜ç¼–å†™çš„æŒ‡ä»¤é¡ºåºæ¥æ‰§è¡Œã€‚å¤„ç†å™¨ä¸ºäº†æé«˜æŒ‡ä»¤æ‰§è¡Œæ•ˆç‡ä¼šä¹±åºæ‰§è¡ŒæŒ‡ä»¤å’Œé¢„æµ‹æŒ‡ä»¤ã€‚ç°ä»£å¤„ç†å™¨ä¸ºäº†æé«˜ç³»ç»Ÿååç‡éƒ½ä¼šåšå¦‚ä¸‹ä¼˜åŒ–ã€‚</p><ul><li>å¹¶å‘æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼ˆmultiple issue ofinstructionsï¼‰ã€‚å¤„ç†å™¨å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å‘å°„å’Œæ‰§è¡Œå¤šæ¡æŒ‡ä»¤ã€‚</li><li>ä¹±åºæ‰§è¡Œï¼ˆout of order executionï¼‰ã€‚å¤„ç†å™¨å¯ä»¥ä¹±åºæ‰§è¡Œæ²¡æœ‰ä¾èµ–å…³ç³»çš„æŒ‡ä»¤ã€‚</li><li>é¢„æµ‹æ‰§è¡Œï¼ˆspeculationï¼‰ã€‚å¤„ç†å™¨åœ¨é‡åˆ°ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­æ—¶ä¼šé¢„æµ‹å°†æ¥å¯èƒ½å‘ç”Ÿçš„æƒ…å†µå¹¶ä¸”æå‰æ‰§è¡Œåˆ†æ”¯ä»£ç ã€‚</li><li>é¢„æµ‹åŠ è½½ã€‚è‹¥å¯ä»¥é¢„æµ‹ä¸€ä¸ªåŠ è½½æŒ‡ä»¤ï¼Œé‚£ä¹ˆé«˜é€Ÿç¼“å­˜å°±å¯ä»¥æå‰æŠŠæ•°æ®é¢„å–åˆ°é«˜é€Ÿç¼“å­˜è¡Œä¸­ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚</li><li>åŠ è½½å’Œå­˜å‚¨ä¼˜åŒ–ã€‚è¯»å†™å¤–éƒ¨å†…å­˜æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œå¤„ç†å™¨åº”è¯¥å°½é‡å‡å°‘è¯»å†™æ¬¡æ•°ï¼Œå¦‚å¤„ç†å™¨å°†å¤šæ¬¡è®¿é—®å†…å­˜çš„æ“ä½œåˆå¹¶ä¸ºä¸€æ¬¡ä¼ è¾“ï¼Œè¿™æ ·å¯ä»¥æé«˜ç³»ç»Ÿæ•ˆç‡ã€‚</li></ul><p>åœ¨ä¸€ä¸ªå•æ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼ŒæŒ‡ä»¤ä¹±åºå’Œå¹¶å‘æ‰§è¡Œå¯¹äºç¨‹åºå‘˜æ¥è¯´æ˜¯é€æ˜çš„ï¼Œå› ä¸ºå¤„ç†å™¨ä¼šå¤„ç†è¿™äº›æ•°æ®ä¾èµ–å…³ç³»ã€‚ä½†æ˜¯ï¼Œåœ¨å¤šæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªå¤„ç†å™¨å†…æ ¸åŒæ—¶è®¿é—®å…±äº«æ•°æ®æˆ–å†…å­˜æ—¶ï¼Œä¸å¤„ç†å™¨ç›¸å…³çš„ä¹±åºå’Œé¢„æµ‹æ‰§è¡Œç­‰ä¼˜åŒ–æ‰‹æ®µå°±å¯èƒ½ä¼šå¯¹ç¨‹åºé€ æˆæ„æƒ³ä¸åˆ°çš„éº»çƒ¦ã€‚å› æ­¤ï¼Œäº†è§£å†…å­˜å±æ€§å’Œå†…å­˜å±éšœå°±æ˜¾å¾—éå¸¸é‡è¦ã€‚</p><h2 id="å†…å­˜å±æ€§-1">å†…å­˜å±æ€§</h2><h3 id="æ™®é€šå†…å­˜">æ™®é€šå†…å­˜</h3><p>æ™®é€šå†…å­˜æ˜¯å¼±ä¸€è‡´æ€§çš„ï¼ˆweakly orderedï¼‰ï¼Œæ²¡æœ‰é¢å¤–çš„çº¦æŸï¼Œå¯ä»¥æä¾›æœ€é«˜çš„å†…å­˜è®¿é—®æ€§èƒ½ã€‚é€šå¸¸ä»£ç æ®µã€æ•°æ®æ®µä»¥åŠå…¶ä»–æ•°æ®éƒ½ä¼šæ”¾åœ¨æ™®é€šå†…å­˜ä¸­ã€‚æ™®é€šå†…å­˜å¯ä»¥è®©å¤„ç†å™¨åšå¾ˆå¤šçš„ä¼˜åŒ–ï¼Œå¦‚åˆ†æ”¯é¢„æµ‹ã€æ•°æ®é¢„å–ã€é«˜é€Ÿç¼“å­˜è¡Œé¢„å–å’Œå¡«å……ã€ä¹±åºåŠ è½½ç­‰ç¡¬ä»¶ä¼˜åŒ–ã€‚</p><h3 id="è®¾å¤‡å†…å­˜">è®¾å¤‡å†…å­˜</h3><p>å¤„ç†å™¨è®¿é—®è®¾å¤‡å†…å­˜ä¼šæœ‰å¾ˆå¤šé™åˆ¶ï¼Œå¦‚ä¸èƒ½è¿›è¡Œé¢„æµ‹è®¿é—®ç­‰ã€‚è®¾å¤‡å†…å­˜æ˜¯ä¸¥æ ¼æŒ‰ç…§æŒ‡ä»¤é¡ºåºæ¥æ‰§è¡Œçš„ã€‚ARMv8 æ¶æ„å®šä¹‰äº†å¤šç§è®¾å¤‡å†…å­˜çš„å±æ€§ï¼š</p><ul><li>Device-nGnRnE</li><li>Device-nGnRE</li><li>Device-nGRE</li><li>Device-GRE</li></ul><p>Device åçš„å­—æ¯æ˜¯æœ‰ç‰¹æ®Šå«ä¹‰çš„ã€‚</p><ul><li>G å’Œ nGï¼šåˆ†åˆ«è¡¨ç¤ºèšåˆï¼ˆGatheringï¼‰ä¸ä¸èšåˆï¼ˆnon Gatheringï¼‰ã€‚èšåˆè¡¨ç¤ºåœ¨åŒä¸€ä¸ªå†…å­˜å±æ€§çš„åŒºåŸŸä¸­å…è®¸æŠŠå¤šæ¬¡è®¿é—®å†…å­˜çš„æ“ä½œåˆå¹¶æˆä¸€æ¬¡æ€»çº¿ä¼ è¾“ï¼š<ul><li>è‹¥ä¸€ä¸ªå†…å­˜åœ°å€æ ‡è®°ä¸ºâ€œnGâ€ï¼Œåˆ™ä¼šä¸¥æ ¼æŒ‰ç…§è®¿é—®å†…å­˜çš„æ¬¡æ•°å’Œå¤§å°æ¥è®¿é—®å†…å­˜ï¼Œä¸ä¼šåšåˆå¹¶ä¼˜åŒ–</li><li>è‹¥ä¸€ä¸ªå†…å­˜åœ°å€æ ‡è®°ä¸ºâ€œGâ€ï¼Œåˆ™ä¼šåšæ€»çº¿åˆå¹¶è®¿é—®ï¼Œå¦‚åˆå¹¶ä¸¤ä¸ªç›¸é‚»çš„å­—èŠ‚è®¿é—®ä¸ºä¸€æ¬¡å¤šå­—èŠ‚è®¿é—®ã€‚è‹¥ç¨‹åºè®¿é—®åŒä¸€ä¸ªå†…å­˜åœ°å€ä¸¤æ¬¡ï¼Œé‚£ä¹ˆå¤„ç†å™¨åªä¼šè®¿é—®å†…å­˜ä¸€æ¬¡ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è®¿é—®å†…å­˜æŒ‡ä»¤åè¿”å›ç›¸åŒçš„å€¼ã€‚è‹¥è¿™ä¸ªå†…å­˜åŒºåŸŸæ ‡è®°ä¸ºâ€œnGâ€ï¼Œé‚£ä¹ˆå¤„ç†å™¨åˆ™ä¼šè®¿é—®å†…å­˜ä¸¤æ¬¡</li></ul></li><li>R å’Œ nRï¼šåˆ†åˆ«è¡¨ç¤ºæŒ‡ä»¤é‡æ’ï¼ˆRe-orderingï¼‰ä¸ä¸é‡æ’ï¼ˆnon Re-orderingï¼‰ã€‚</li><li>E å’Œ nEï¼šåˆ†åˆ«è¡¨ç¤ºæå‰å†™åº”ç­”ï¼ˆEarly Write Acknowledgementï¼‰ä¸ä¸æå‰å†™åº”ç­” Early Write Acknowledgementï¼‰å¾€å¤–éƒ¨è®¾å¤‡å†™æ•°æ®æ—¶ï¼Œå¤„ç†å™¨å…ˆæŠŠæ•°æ®å†™å…¥å†™ç»ˆ ï¼ˆwrite hufferï¼‰ä¸­ï¼Œè‹¥ä½¿èƒ½äº†æå‰å†™åº”ç­”ï¼Œåˆ™æ•°æ®åˆ°è¾¾å†™ç¼“å†²åŒºæ—¶ä¼šå‘é€å†™åº”ç­”ï¼š æœ‰ä½¿èƒ½æå‰å†™åº”ç­”ï¼Œåˆ™æ•°æ®åˆ°è¾¾å¤–è®¾æ—¶æ‰å‘é€å†™åº”ç­”ã€‚ Linux å†…æ ¸ä¸­å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªå†…å­˜å±æ€§ã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MT_NORMAL    0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_NORMAL_TAGGED1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_NORMAL_NC2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_DEVICE_nGnRnE3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_DEVICE_nGnRE4</span></span><br></pre></td></tr></tbody></table></figure><ul><li>MT_DEVICE_nGnRnEï¼šè®¾å¤‡å†…å­˜å±æ€§ï¼Œä¸æ”¯æŒèšåˆæ“ä½œï¼Œä¸æ”¯æŒæŒ‡ä»¤é‡æ’ï¼Œä¸æ”¯æå‰å†™åº”ç­”</li><li>MT_DEVICE_nGnREï¼šè®¾å¤‡å†…å­˜å±æ€§ï¼Œä¸æ”¯æŒèšåˆæ“ä½œï¼Œä¸æ”¯æŒæŒ‡ä»¤é‡æ’ï¼Œæ”¯æŒæå†™åº”ç­”</li><li>MT_DEVICE_GREï¼šè®¾å¤‡å†…å­˜å±æ€§ï¼Œæ”¯æŒèšåˆæ“ä½œï¼Œæ”¯æŒæŒ‡ä»¤é‡æ’ï¼Œæ”¯æŒæå‰å†™åº”</li><li>MT_NORMAL_NCï¼šæ™®é€šå†…å­˜å±æ€§ï¼Œå…³é—­é«˜é€Ÿç¼“å­˜ï¼Œå…¶ä¸­ NC æ˜¯ Non-Cacheable æ„æ€</li><li>MT_NORMALï¼šæ™®é€šå†…å­˜å±æ€§</li><li>MT_NORMAL_WTï¼šæ™®é€šå†…å­˜å±æ€§ï¼Œé«˜é€Ÿç¼“å­˜çš„å›å†™ç­–ç•¥ä¸ºç›´å†™ï¼ˆwrite throughï¼‰ç­–å†…å­˜å±æ€§å¹¶æ²¡æœ‰å­˜æ”¾åœ¨é¡µè¡¨é¡¹ä¸­ï¼Œè€Œæ˜¯å­˜æ”¾åœ¨ MAIR_ELn ï¼ˆMemory Attribute IndirectRegister Elnï¼‰ä¸­ã€‚é¡µè¡¨é¡¹ä¸­ä½¿ç”¨ä¸€ä¸ª 3 ä½çš„ç´¢å¼•å€¼æ¥æŸ¥æ‰¾ MAIR_ELn</li></ul><p>MAIR_ELn åˆ†æˆ 8 æ®µï¼Œæ¯ä¸€æ®µéƒ½å¯ä»¥ç”¨äºæè¿°ä¸åŒçš„å†…å­˜å±æ€§ã€‚</p><h2 id="é«˜é€Ÿç¼“å­˜å…±äº«å±æ€§">é«˜é€Ÿç¼“å­˜å…±äº«å±æ€§</h2><p>æ™®é€šå†…å­˜å¯ä»¥è®¾ç½®é«˜é€Ÿç¼“å­˜ä¸ºå¯ç¼“å­˜çš„å’Œä¸å¯ç¼“å­˜çš„ã€‚è¿›ä¸€æ­¥åœ°ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é«˜é€Ÿç¼“ä¸ºå†…éƒ¨å…±äº«å’Œå¤–éƒ¨å…±äº«çš„é«˜é€Ÿç¼“å­˜ã€‚ä¸€ä¸ªå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œé™¤äº†å¤„ç†å™¨ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„å¯ä»¥è®¿é—®å†…å­˜çš„ç¡¬ä»¶å•å…ƒï¼Œè¿™äº›ç¡¬ä»¶å•å…ƒé€šå¸¸å…·æœ‰è®¿é—®å†…å­˜æ€»çº¿ï¼ˆbus masterï¼‰çš„èƒ½åŠ›ï¼Œå¦‚ DMA è®¾å¤‡ã€GPU ç­‰ï¼Œè¿™äº›ç¡¬ä»¶å•å…ƒå¯ä»¥ç§°ä¸ºå¤„ç†å™¨ä¹‹å¤–çš„è§‚å¯Ÿç‚¹ã€‚åœ¨ä¸€ä¸ªå¤šæ ¸ç³»ç»Ÿä¸­ï¼ŒDMA è®¾å¤‡å’Œ GPU é€šè¿‡ç³»ç»Ÿæ€»çº¿è¿æ¥åˆ° DDR å†…å­˜ï¼Œè€Œå¤„ç†å™¨ä¹Ÿé€šè¿‡ç³»ç»Ÿæ€»çº¿è¿æ¥åˆ° DDR å†…å­˜ï¼Œå®ƒä»¬éƒ½èƒ½åŒæ—¶é€šè¿‡ç³»ç»Ÿæ€»çº¿è®¿é—®åˆ°å†…å­˜ã€‚</p><ul><li>å¦‚æœä¸€ä¸ªå†…å­˜åŒºåŸŸè¢«æ ‡è®°ä¸ºâ€œä¸å¯å…±äº«çš„â€è¡¨ç¤ºå®ƒåªèƒ½è¢«ä¸€ä¸ªå¤„ç†å™¨è®¿é—®ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå†…å­˜åŒºåŸŸã€‚</li><li>å¦‚æœä¸€ä¸ªå†…å­˜åŒºåŸŸè¢«æ ‡è®°ä¸ºâ€œå†…éƒ¨å…±äº«çš„â€ï¼Œè¡¨ç¤ºå®ƒå¯ä»¥è¢«å¤šä¸ªå¤„ç†å™¨è®¿é—®å’Œå…±äº«ï¼Œä½†æ˜¯ç³»ç»Ÿä¸­å…¶ä»–çš„è®¿é—®å†…å­˜çš„ç¡¬ä»¶å•å…ƒå°±ä¸èƒ½è®¿é—®äº†ï¼Œå¦‚ DMA è®¾å¤‡ã€GPU ç­‰ã€‚</li><li>å¦‚æœä¸€ä¸ªå†…å­˜åŒºåŸŸè¢«æ ‡è®°ä¸ºâ€œå¤–éƒ¨å…±äº«çš„â€ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­å¾ˆå¤šè®¿é—®å†…å­˜çš„å•å…ƒï¼ˆå¦‚ DMA è®¾å¤‡ã€GPU ç­‰ï¼‰éƒ½å¯ä»¥å’Œå¤„ç†å™¨ä¸€æ ·è®¿é—®è¿™ä¸ªå†…å­˜åŒºåŸŸã€‚</li></ul><h1 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ</h1><h2 id="å†…å­˜å±éšœæŒ‡ä»¤">å†…å­˜å±éšœæŒ‡ä»¤</h2><p>ARMv8 æŒ‡ä»¤é›†æä¾›äº† 3 æ¡å†…å­˜å±éšœæŒ‡ä»¤ã€‚</p><ul><li>æ•°æ®å­˜å‚¨å±éšœï¼ˆData Memory Barrierï¼ŒDMBï¼‰æŒ‡ä»¤ï¼šä»…å½“æ‰€æœ‰åœ¨å®ƒå‰é¢çš„å­˜å‚¨å™¨è®¿é—®æ“ä½œéƒ½æ‰§è¡Œå®Œæ¯•åï¼Œæ‰æäº¤ï¼ˆcommitï¼‰åœ¨å®ƒåé¢çš„è®¿é—®æŒ‡ä»¤ã€‚DMB æŒ‡ä»¤ä¿è¯çš„æ˜¯ DMB æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤å’Œ DMB æŒ‡ä»¤ä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤çš„é¡ºåºã€‚</li><li>æ•°æ®åŒæ­¥å±éšœï¼ˆData synchronization Barrierï¼ŒDSBï¼‰æŒ‡ä»¤ï¼šæ¯” DMB æŒ‡ä»¤è¦ä¸¥æ ¼ä¸€äº›ï¼Œä»…å½“æ‰€æœ‰åœ¨å®ƒå‰é¢çš„è®¿é—®æŒ‡ä»¤éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šæ‰§è¡Œåœ¨å®ƒåé¢çš„æŒ‡ä»¤ï¼Œå³ä»»ä½•æŒ‡ä»¤éƒ½è¦ç­‰å¾… DSB æŒ‡ä»¤å‰é¢çš„è®¿é—®æŒ‡ä»¤å®Œæˆã€‚ä½äºæ­¤æŒ‡ä»¤å‰çš„æ‰€æœ‰ç¼“å­˜ï¼Œå¦‚åˆ†æ”¯é¢„æµ‹å’Œ TLB ç»´æŠ¤æ“ä½œéœ€å…¨éƒ¨å®Œæˆã€‚</li><li>æŒ‡ä»¤åŒæ­¥å±éšœï¼ˆInstruction synchronization Barrierï¼ŒISBï¼‰æŒ‡ä»¤ï¼šæ¯” DMB æŒ‡ä»¤å’Œ DSB æŒ‡ä»¤ä¸¥æ ¼ï¼Œåˆ·æ–°æµæ°´çº¿ï¼ˆflush pipelineï¼‰å’Œé¢„å–ç¼“å†²åŒºåï¼Œæ‰ä¼šä»é«˜é€Ÿç¼“å­˜æˆ–è€…å†…å­˜ä¸­é¢„å– ISB æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤ã€‚ISB æŒ‡ä»¤é€šå¸¸ç”¨æ¥ä¿è¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ•ˆæœï¼Œå¦‚ ASID æ›´æ”¹ã€TLB ç»´æŠ¤æ“ä½œå’Œ C15 å¯„å­˜å™¨çš„ä¿®æ”¹ç­‰ã€‚</li></ul><p>DMB æŒ‡ä»¤å’Œ DSB æŒ‡ä»¤è¿˜å¯ä»¥å¸¦å‚æ•°ï¼Œæ¥æŒ‡å®šå†…å­˜å±éšœæŒ‡ä»¤çš„é¡ºåºä»¥åŠå…±äº«å±æ€§ç­‰ä¿¡æ¯ã€‚ å†…å­˜å±éšœæŒ‡ä»¤å‚æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>å…¨ç³»ç»Ÿå…±äº«ï¼š<ul><li>SYï¼šå†…å­˜è¯»å†™æŒ‡ä»¤</li><li>STï¼šå†…å­˜å†™æŒ‡ä»¤</li><li>LDï¼šå†…å­˜è¯»æŒ‡ä»¤</li></ul></li><li>å†…éƒ¨å…±äº«ï¼š<ul><li>ISHï¼šå†…å­˜è¯»å†™æŒ‡ä»¤</li><li>ISHSTï¼šå†…å­˜å†™æŒ‡ä»¤</li><li>ISHLDï¼šå†…å­˜è¯»æŒ‡ä»¤</li></ul></li><li>ä¸å…±äº«ï¼š<ul><li>NSHï¼šå†…å­˜è¯»å†™æŒ‡ä»¤</li><li>NSHSTï¼šå†…å­˜å†™æŒ‡ä»¤</li><li>NSHLDï¼šå†…å­˜è¯»æŒ‡ä»¤</li></ul></li><li>å¤–éƒ¨å…±äº«ï¼š<ul><li>OSHï¼šå†…å­˜è¯»å†™æŒ‡ä»¤</li><li>OSHSTï¼šå†…å­˜å†™æŒ‡ä»¤</li><li>OSHLDï¼šå†…å­˜è¯»æŒ‡ä»¤</li></ul></li></ul><h2 id="åŠ è½½-è·å–å±éšœåŸè¯­ä¸å­˜å‚¨-é‡Šæ”¾å±éšœåŸè¯­">åŠ è½½-è·å–å±éšœåŸè¯­ä¸å­˜å‚¨-é‡Šæ”¾å±éšœåŸè¯­</h2><p>ARMv8 æŒ‡ä»¤é›†è¿˜æ”¯æŒéšå«å†…å­˜å±éšœåŸè¯­çš„åŠ è½½å’Œå­˜å‚¨æŒ‡ä»¤ï¼Œè¿™äº›å†…å­˜å±éšœåŸè¯­å½±å“äº†åŠ å’Œå­˜å‚¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œå®ƒä»¬å¯¹æ‰§è¡Œé¡ºåºçš„å½±å“æ˜¯å•æ–¹å‘çš„ã€‚</p><ul><li>è·å–ï¼ˆacquireï¼‰å±éšœåŸè¯­ï¼šè¯¥å±éšœåŸè¯­ä¹‹åçš„è¯»å†™æ“ä½œä¸èƒ½é‡æ’åˆ°è¯¥å±éšœåŸè¯­å‰é¢ï¼Œé€šå¸¸è¯¥å±éšœåŸè¯­å’ŒåŠ è½½æŒ‡ä»¤ç»“åˆ</li><li>é‡Šæ”¾ï¼ˆreleaseï¼‰å±éšœåŸè¯­ï¼šè¯¥å±éšœåŸè¯­ä¹‹å‰çš„è¯»å†™æ“ä½œä¸èƒ½é‡æ’åˆ°è¯¥å±éšœåŸè¯­åé¢é€šå¸¸è¯¥å±éšœåŸè¯­å’Œå­˜å‚¨æŒ‡ä»¤ç»“åˆ</li><li>åŠ è½½-è·å–ï¼ˆload-acquireï¼‰å±éšœåŸè¯­ï¼šå«æœ‰è·å–å±éšœåŸè¯­çš„è¯»æ“ä½œï¼Œç›¸å½“äºå•æ–¹å‘å‘åçš„å±éšœæŒ‡ä»¤ã€‚æ‰€æœ‰åŠ è½½-è·å–å†…å­˜å±éšœæŒ‡ä»¤åé¢çš„å†…å­˜è®¿é—®æŒ‡ä»¤åªèƒ½åœ¨åŠ è½½-è·å–å†…å­˜å±éšœæŒ‡ä»¤æ‰§è¡Œåæ‰èƒ½å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”è¢«å…¶ä»– CPU è§‚å¯Ÿåˆ°ã€‚æ™®é€šçš„è¯»å’Œå†™æ“ä½œå¯ä»¥å‘åè¶Šè¿‡è¯¥å±éšœæŒ‡ä»¤ï¼Œä½†æ˜¯ä¹‹åçš„è¯»å’Œå†™æ“ä½œä¸èƒ½å‘å‰è¶Šè¿‡è¯¥å±éšœæŒ‡ä»¤</li><li>å­˜å‚¨-é‡Šæ”¾ï¼ˆstore-releaseï¼‰å±éšœåŸè¯­ï¼šå«æœ‰é‡Šæ”¾å±éšœåŸè¯­çš„å†™æ“ä½œï¼Œç›¸å½“äºå•æ–¹å‘å‰çš„å±éšœæŒ‡ä»¤ã€‚åªæœ‰æ‰€æœ‰å­˜å‚¨-é‡Šæ”¾å±éšœåŸè¯­ä¹‹å‰çš„æŒ‡ä»¤å®Œæˆäº†ï¼Œæ‰èƒ½æ‰§è¡Œå­˜å‚¨-é‡Šå±éšœåŸè¯­ä¹‹åçš„æŒ‡ä»¤ï¼Œè¿™æ ·å…¶ä»– CPU å¯ä»¥è§‚å¯Ÿåˆ°å­˜å‚¨-é‡Šæ”¾å±éšœåŸè¯­ä¹‹å‰çš„æŒ‡ä»¤å·²æ‰§è¡Œå®Œã€‚æ™®é€šçš„è¯»å’Œå†™å¯ä»¥å‘å‰è¶Šè¿‡å­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤ï¼Œä½†æ˜¯ä¹‹å‰çš„è¯»å’Œå†™æ“ä½œä¸èƒ½å‘åè¶Šè¿‡å­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤</li></ul><p>åŠ è½½-è·å–å’Œå­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤ç›¸å½“äºæ˜¯å•æ–¹å‘çš„åŠæ¡ DMB æŒ‡ä»¤ï¼Œè€Œ DMB æŒ‡ä»¤ç›¸å½“äºæ˜¯å…¨æ–¹å‘çš„æ …éšœã€‚ä»»ä½•è¯»å†™æ“ä½œéƒ½ä¸èƒ½è·¨è¶Šè¯¥æ …éšœã€‚å®ƒä»¬ç»„åˆä½¿ç”¨å¯ä»¥å¢å¼ºä»£ç çµæ´»æ€§å¹¶æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å¦‚å›¾æ‰€ç¤ºï¼ŒåŠ è½½-è·å–å±éšœæŒ‡ä»¤å’Œå­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤ç»„æˆäº†ä¸€ä¸ªä¸´ç•ŒåŒºï¼Œè¿™ç›¸å½“äºä¸€ä¸ªæ …æ ã€‚åœ¨åŠ è½½-è·å–å±éšœæŒ‡ä»¤ä¹‹å‰çš„å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆå¦‚è¯»æŒ‡ä»¤ 1 å’Œå†™æŒ‡ä»¤ 1ï¼‰å¯ä»¥æŒªåˆ°åŠ è½½-è·å–å±éšœæŒ‡ä»¤åé¢æ‰§è¡Œï¼Œä½†æ˜¯ä¸èƒ½å‘å‰è¶Šè¿‡å­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤ã€‚è€Œå­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤åé¢çš„å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆå¦‚è¯»æŒ‡ä»¤ 2 å’Œå†™æŒ‡ä»¤ 2ï¼‰ä¸èƒ½å‘å‰ç©¿è¶Šè¿‡åŠ è½½-è·å–å±éšœæŒ‡ä»¤ã€‚åœ¨ä¸´ç•ŒåŒºä¸­çš„å†…å­˜ä¸èƒ½è¶Šè¿‡ä¸´ç•ŒåŒºï¼Œå¦‚è¯»æŒ‡ä»¤ 2 å¿…é¡»åœ¨åŠ è½½-è·å–å±éšœæŒ‡ä»¤åå¼€å§‹æ‰§è¡Œï¼›å¦‚è¯»æŒ‡ä»¤ 2 å’Œå†™æŒ‡ä»¤ 2 å¿…é¡»åœ¨å­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤ä¹‹å‰å®Œæˆï¼Œå³ä¿è¯å…¶ä»– CPU åœ¨å­˜å‚¨-é‡Šæ”¾å±éšœæŒ‡ä»¤æ‰§è¡Œå®Œæˆæ—¶èƒ½è§‚å¯Ÿåˆ°è¯»æŒ‡ä»¤ 1 å’Œå†™æŒ‡ä»¤ 1ã€è¯»æŒ‡ä»¤ 2 å’Œå†™æŒ‡ä»¤ 2 å·²ç»å®Œæˆã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/mem_barrier.png"></p><p>ARM64 æŒ‡ä»¤é›†ä¸­æä¾›äº†å¦‚ä¸‹æŒ‡ä»¤ã€‚</p><ul><li>LDAR å’Œ STLR æŒ‡ä»¤ï¼šç”¨äºåŠ è½½å’Œå­˜å‚¨</li><li>CAS æŒ‡ä»¤ï¼šç”¨äºæ¯”è¾ƒå’Œäº¤æ¢</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9hcm12OC1yZWYuY29kaW5nYmVsaWVmLmNvbS96aC9jaGFwdGVyX2Q0L2Q0M18zX21lbW9yeV9hdHRyaWJ1dGVfZmllbGRzX2luX3RoZV92bXNhdjgtNjRfdHJhbnNsYXRpb25fdGFibGVfZm9ybWF0c19kZXNjcmlwdG9ycy5odG1s">https://armv8-ref.codingbelief.com/zh/chapter_d4/d43_3_memory_attribute_fields_in_the_vmsav8-64_translation_table_formats_descriptors.html<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ç®¡ç†ï¼ˆä¸€ï¼‰Cache</title>
      <link href="/2021/LinuxKernel/LinuxMemoryCache/"/>
      <url>/2021/LinuxKernel/LinuxMemoryCache/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MMCache.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2ZDczZDdkOWMwODA3MGU1MjAzMDM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><blockquote><p>å£°æ˜ï¼š æœ¬æ–‡è½¬è½½è‡ª <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDIyOTM0Mzc=">Cache çš„åŸºæœ¬åŸç†<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDcwOTYxMzA=">Cache ç»„ç»‡æ–¹å¼<i class="fa fa-external-link-alt"></i></span></p></blockquote><h1 id="å¤šçº§-cache-å­˜å‚¨ç»“æ„">å¤šçº§ cache å­˜å‚¨ç»“æ„</h1><p>æˆ‘ä»¬åœ¨ L1 cache åé¢è¿æ¥ L2 cacheï¼Œåœ¨ L2 cache å’Œä¸»å­˜ä¹‹é—´è¿æ¥ L3 cacheã€‚ç­‰çº§è¶Šé«˜ï¼Œé€Ÿåº¦è¶Šæ…¢ï¼Œå®¹é‡è¶Šå¤§ã€‚ä¸åŒç­‰çº§ cache é€Ÿåº¦ä¹‹é—´å…³ç³»å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache4.jpg"></p><p>ç»è¿‡ 3 çº§ cache çš„ç¼“å†²ï¼Œå„çº§ cache å’Œä¸»å­˜ä¹‹é—´çš„é€Ÿåº¦æœ€èŒå·®ä¹Ÿé€çº§å‡å°ã€‚åœ¨ä¸€ä¸ªçœŸå®çš„ç³»ç»Ÿä¸Šï¼Œå„çº§ cache ä¹‹é—´ç¡¬ä»¶ä¸Šæ˜¯å¦‚ä½•å…³è”çš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹ Cortex-A53 æ¶æ„ä¸Šå„çº§ cache ä¹‹é—´çš„ç¡¬ä»¶æŠ½è±¡æ¡†å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache5.jpg"></p><p>åœ¨ Cortex-A53 æ¶æ„ä¸Šï¼ŒL1 cache åˆ†ä¸ºå•ç‹¬çš„ instruction cacheï¼ˆICacheï¼‰å’Œ data cacheï¼ˆDCacheï¼‰ã€‚L1 cache æ˜¯ CPU ç§æœ‰çš„ï¼Œæ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ª L1 cacheã€‚ä¸€ä¸ª cluster å†…çš„æ‰€æœ‰ CPU å…±äº«ä¸€ä¸ª L2 cacheï¼ŒL2 cache ä¸åŒºåˆ†æŒ‡ä»¤å’Œæ•°æ®ï¼Œéƒ½å¯ä»¥ç¼“å­˜ã€‚æ‰€æœ‰ cluster ä¹‹é—´å…±äº« L3 cacheã€‚L3 cache é€šè¿‡æ€»çº¿å’Œä¸»å­˜ç›¸è¿ã€‚</p><h1 id="å¤šçº§-cache-ä¹‹é—´çš„é…åˆå·¥ä½œ">å¤šçº§ cache ä¹‹é—´çš„é…åˆå·¥ä½œ</h1><p>é¦–å…ˆå¼•å…¥ä¸¤ä¸ªåè¯æ¦‚å¿µï¼Œå‘½ä¸­å’Œç¼ºå¤±ã€‚ CPU è¦è®¿é—®çš„æ•°æ®åœ¨ cache ä¸­æœ‰ç¼“å­˜ï¼Œç§°ä¸ºâ€œå‘½ä¸­â€ (hit)ï¼Œåä¹‹åˆ™ç§°ä¸ºâ€œç¼ºå¤±â€ (miss)ã€‚å¤šçº§ cache ä¹‹é—´æ˜¯å¦‚ä½•é…åˆå·¥ä½œçš„å‘¢ï¼Ÿæˆ‘ä»¬å‡è®¾ç°åœ¨è€ƒè™‘çš„ç³»ç»Ÿåªæœ‰ä¸¤çº§ cacheã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache6.jpg"></p><ul><li><p>inclusive cacheï¼ˆæŸä¸€åœ°å€çš„æ•°æ®å¯èƒ½å­˜åœ¨å¤šçº§ç¼“å­˜ä¸­ï¼‰ å½“ CPU è¯•å›¾ä»æŸåœ°å€ load æ•°æ®æ—¶ï¼Œé¦–å…ˆä» L1 cache ä¸­æŸ¥è¯¢æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœå‘½ä¸­åˆ™æŠŠæ•°æ®è¿”å›ç»™ CPU å¦‚æœ L1 cache ç¼ºå¤±ï¼Œåˆ™ç»§ç»­ä» L2 cache ä¸­æŸ¥æ‰¾ã€‚å½“ L2 cache å‘½ä¸­æ—¶ï¼Œæ•°æ®ä¼šè¿”å›ç»™ L1 cache ä»¥åŠ CPU å¦‚æœ L2 cache ä¹Ÿç¼ºå¤±ï¼Œå¾ˆä¸å¹¸ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸»å­˜ä¸­ load æ•°æ®ï¼Œå°†æ•°æ®è¿”å›ç»™ L2 cacheã€L1 cache åŠ CPU</p></li><li><p>exclusive cache è¿™ç§ cache ä¿è¯æŸä¸€åœ°å€çš„æ•°æ®ç¼“å­˜åªä¼šå­˜åœ¨äºå¤šçº§ cache å…¶ä¸­ä¸€çº§</p></li></ul><h2 id="ç›´æ¥æ˜ å°„ç¼“å­˜-direct-mapped-cache">ç›´æ¥æ˜ å°„ç¼“å­˜ (Direct mapped cache)</h2><p>cache çš„å¤§å°ç§°ä¹‹ä¸º cahe sizeã€‚æˆ‘ä»¬å°† cache å¹³å‡åˆ†æˆç›¸ç­‰çš„å¾ˆå¤šå—ï¼Œæ¯ä¸€ä¸ªå—å¤§å°ç§°ä¹‹ä¸º cache lineã€‚ç°åœ¨çš„ç¡¬ä»¶è®¾è®¡ä¸­ï¼Œä¸€èˆ¬ cache line çš„å¤§å°æ˜¯ 4-128 Bytsã€‚</p><blockquote><p>æ³¨æ„ï¼Œcache line æ˜¯ cache å’Œä¸»å­˜ï¼ˆé CPUï¼‰ä¹‹é—´æ•°æ®ä¼ è¾“çš„æœ€å°å•ä½ã€‚</p></blockquote><p>æˆ‘ä»¬å‡è®¾ä¸‹é¢çš„è®²è§£éƒ½æ˜¯é’ˆå¯¹ 64 Bytes å¤§å°çš„ cacheï¼Œå¹¶ä¸” cache line å¤§å°æ˜¯ 8 å­—èŠ‚ã€‚æˆ‘ä»¬å¯ä»¥ç±»ä¼¼æŠŠè¿™å— cache æƒ³æƒ³æˆä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„æ€»å…± 8 ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ å¤§å°æ˜¯ 8 å­—èŠ‚ã€‚å°±åƒä¸‹å›¾è¿™æ ·ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache7.jpg"></p><p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼ŒCPU ä» 0x0654 åœ°å€è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œcache æ§åˆ¶å™¨æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨ cache ä¸­å‘½ä¸­å‘¢ï¼Ÿç°åœ¨ç¡¬ä»¶é‡‡å–çš„åšæ³•æ˜¯å¯¹åœ°å€è¿›è¡Œæ•£åˆ—ï¼ˆå¯ä»¥ç†è§£æˆåœ°å€å–æ¨¡æ“ä½œï¼‰ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache8.jpg"></p><p>æˆ‘ä»¬ä¸€å…±æœ‰ 8 è¡Œ cache lineï¼Œcache line å¤§å°æ˜¯ 8 Bytesã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åœ°å€ä½ 3 bitsï¼ˆå¦‚ä¸Šå›¾åœ°å€è“è‰²éƒ¨åˆ†ï¼‰ç”¨æ¥å¯»å€ 8 bytes ä¸­æŸä¸€å­—èŠ‚ï¼Œæˆ‘ä»¬ç§°è¿™éƒ¨åˆ† bit ç»„åˆä¸º offsetã€‚åŒç†ï¼Œ8 è¡Œ cache lineï¼Œä¸ºäº†è¦†ç›–æ‰€æœ‰è¡Œã€‚æˆ‘ä»¬éœ€è¦ 3 bitsï¼ˆå¦‚ä¸Šå›¾åœ°å€é»„è‰²éƒ¨åˆ†ï¼‰æŸ¥æ‰¾æŸä¸€è¡Œï¼Œè¿™éƒ¨åˆ†åœ°å€éƒ¨åˆ†ç§°ä¹‹ä¸º indexã€‚</p><p>å¦‚æœä¸¤ä¸ªä¸åŒçš„åœ°å€ï¼Œå…¶åœ°å€çš„ bit3-bit5 å¦‚æœå®Œå…¨ä¸€æ ·çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªåœ°å€ç»è¿‡ç¡¬ä»¶æ•£åˆ—ä¹‹åéƒ½ä¼šæ‰¾åˆ°åŒä¸€ä¸ª cache lineã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åˆå¼•å…¥ tag array åŒºåŸŸã€‚æ¯ä¸€ä¸ª cache line éƒ½å¯¹åº”å”¯ä¸€ä¸€ä¸ª tagï¼Œtag ä¸­ä¿å­˜çš„æ˜¯æ•´ä¸ªåœ°å€ä½å®½å»é™¤ index å’Œ offset ä½¿ç”¨çš„ bit å‰©ä½™éƒ¨åˆ†ï¼ˆå¦‚ä¸Šå›¾åœ°å€ç»¿è‰²éƒ¨åˆ†ï¼‰ã€‚</p><p>tagã€index å’Œ offset ä¸‰è€…ç»„åˆå°±å¯ä»¥å”¯ä¸€ç¡®å®šä¸€ä¸ªåœ°å€äº†ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬æ ¹æ®åœ°å€ä¸­ index ä½æ‰¾åˆ° cache line åï¼Œå–å‡ºå½“å‰ cache line å¯¹åº”çš„ tagï¼Œç„¶åå’Œåœ°å€ä¸­çš„ tag è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œè¿™è¯´æ˜ cache å‘½ä¸­ã€‚å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜å½“å‰ cache line å­˜å‚¨çš„æ˜¯å…¶ä»–åœ°å€çš„æ•°æ®ï¼Œè¿™å°±æ˜¯ cache ç¼ºå¤±ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä»å›¾ä¸­çœ‹åˆ° tag æ—è¾¹è¿˜æœ‰ä¸€ä¸ª valid bitï¼Œè¿™ä¸ª bit ç”¨æ¥è¡¨ç¤º cache line ä¸­æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼š1 ä»£è¡¨æœ‰æ•ˆï¼›0 ä»£è¡¨æ— æ•ˆï¼‰ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°æ¯”è¾ƒ tag ç¡®è®¤ cache line æ˜¯å¦å‘½ä¸­ä¹‹å‰è¿˜ä¼šæ£€æŸ¥ valid bit æ˜¯å¦æœ‰æ•ˆã€‚åªæœ‰åœ¨æœ‰æ•ˆçš„æƒ…å†µä¸‹ï¼Œæ¯”è¾ƒ tag æ‰æœ‰æ„ä¹‰ã€‚å¦‚æœæ— æ•ˆï¼Œç›´æ¥åˆ¤å®š cache ç¼ºå¤±ã€‚</p><ul><li>offset ç”¨äºåœ¨ä¸€ä¸ª cache line é‡Œç¡®å®šæ˜¯å“ªä¸€ä¸ªå­—èŠ‚</li><li>index å¯»å€ cache lineï¼ˆç¡®å®šæ˜¯å“ªä¸€ä¸ª cache lineï¼‰</li><li>tag array å…¨åœ°å€åŒ¹é…</li><li>valid bit è¡¨ç¤º cache ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ</li></ul><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œcache size æ˜¯ 64 Bytes å¹¶ä¸” cache line size æ˜¯ 8 bytesã€‚offsetã€index å’Œ tag åˆ†åˆ«ä½¿ç”¨ 3 bitsã€3 bits å’Œ 42 bitsï¼ˆå‡è®¾åœ°å€å®½åº¦æ˜¯ 48 bitsï¼‰ã€‚æˆ‘ä»¬ç°åœ¨å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š512 Bytes cache sizeï¼Œ64 Bytes cache line sizeã€‚æ ¹æ®ä¹‹å‰çš„åœ°å€åˆ’åˆ†æ–¹æ³•ï¼Œoffsetã€index å’Œ tag åˆ†åˆ«ä½¿ç”¨ 6 bitsã€3 bits å’Œ 39 bitsã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache9.jpg"></p><h2 id="ç›´æ¥æ˜ å°„ç¼“å­˜çš„ä¼˜ç¼ºç‚¹">ç›´æ¥æ˜ å°„ç¼“å­˜çš„ä¼˜ç¼ºç‚¹</h2><p>ç›´æ¥æ˜ å°„ç¼“å­˜åœ¨ç¡¬ä»¶è®¾è®¡ä¸Šä¼šæ›´åŠ ç®€å•ï¼Œå› æ­¤æˆæœ¬ä¸Šä¹Ÿä¼šè¾ƒä½ã€‚æ ¹æ®ç›´æ¥æ˜ å°„ç¼“å­˜çš„å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”»å‡ºä¸»å­˜åœ°å€ 0x00-0x88 åœ°å€å¯¹åº”çš„ cache åˆ†å¸ƒå›¾ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache10.jpg"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ°å€ 0x00-0x3f åœ°å€å¤„å¯¹åº”çš„æ•°æ®å¯ä»¥è¦†ç›–æ•´ä¸ª cacheã€‚0x40-0x7f åœ°å€çš„æ•°æ®ä¹ŸåŒæ ·æ˜¯è¦†ç›–æ•´ä¸ª cacheã€‚æˆ‘ä»¬ç°åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºè¯•å›¾ä¾æ¬¡è®¿é—®åœ°å€ 0x00ã€0x40ã€0x80ï¼Œcache ä¸­çš„æ•°æ®ï¼Œæ¯æ¬¡è®¿é—®æ•°æ®éƒ½è¦ä»ä¸»å­˜ä¸­è¯»å–ï¼Œæ‰€ä»¥ cache çš„å­˜åœ¨å¹¶æ²¡æœ‰å¯¹æ€§èƒ½æœ‰ä»€ä¹ˆæå‡ã€‚è¿™ç§ç°è±¡å«åš cache é¢ ç°¸ï¼ˆcache thrashingï¼‰ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥å¤šè·¯ç»„ç›¸è¿ç¼“å­˜ã€‚</p><h2 id="ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜-two-way-set-associative-cache">ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜ (Two-way set associative cache)</h2><p>æˆ‘ä»¬ä¾ç„¶å‡è®¾ 64 Bytes cache sizeï¼Œcache line size æ˜¯ 8 Bytesã€‚ä»€ä¹ˆæ˜¯è·¯ï¼ˆwayï¼‰çš„æ¦‚å¿µã€‚æˆ‘ä»¬å°† cache å¹³å‡åˆ†æˆå¤šä»½ï¼Œæ¯ä¸€ä»½å°±æ˜¯ä¸€è·¯ã€‚å› æ­¤ï¼Œä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜å°±æ˜¯å°† cache å¹³å‡åˆ†æˆ 2 ä»½ï¼Œæ¯ä»½ 32 Bytesã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache11.jpg"></p><p>cache è¢«åˆ†æˆ 2 è·¯ï¼Œæ¯è·¯åŒ…å« 4 è¡Œ cache lineã€‚æˆ‘ä»¬å°†æ‰€æœ‰ç´¢å¼•ä¸€æ ·çš„ cache line ç»„åˆåœ¨ä¸€èµ·ç§°ä¹‹ä¸ºç»„ã€‚ä¾‹å¦‚ï¼Œä¸Šå›¾ä¸­ä¸€ä¸ªç»„æœ‰ä¸¤ä¸ª cache lineï¼Œæ€»å…± 4 ä¸ªç»„ã€‚æˆ‘ä»¬ä¾ç„¶å‡è®¾ä»åœ°å€ 0x0654 åœ°å€è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®ã€‚ç”±äº cache line size æ˜¯ 8 Bytesï¼Œå› æ­¤ offset éœ€è¦ 3 bitsï¼Œè¿™å’Œä¹‹å‰ç›´æ¥æ˜ å°„ç¼“å­˜ä¸€æ ·ã€‚ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯ indexï¼Œåœ¨ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜ä¸­ï¼Œindex åªéœ€è¦ 2 bitsï¼Œå› ä¸ºä¸€è·¯åªæœ‰ 4 è¡Œ cache lineã€‚ä¸Šé¢çš„ä¾‹å­æ ¹æ® index æ‰¾åˆ°ç¬¬ 2 è¡Œ cache lineï¼ˆä» 0 å¼€å§‹è®¡ç®—ï¼‰ï¼Œç¬¬ 2 è¡Œå¯¹åº” 2 ä¸ª cache lineï¼Œåˆ†åˆ«å¯¹åº” way 0 å’Œ way 1ã€‚å› æ­¤ index ä¹Ÿå¯ä»¥ç§°ä½œ set indexï¼ˆç»„ç´¢å¼•ï¼‰ã€‚å…ˆæ ¹æ® index æ‰¾åˆ° setï¼Œç„¶åå°†ç»„å†…çš„æ‰€æœ‰ cache line å¯¹åº”çš„ tag å–å‡ºæ¥å’Œåœ°å€ä¸­çš„ tag éƒ¨åˆ†å¯¹æ¯”ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç›¸ç­‰å°±æ„å‘³ç€å‘½ä¸­ã€‚</p><p>å› æ­¤ï¼Œä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜è¾ƒç›´æ¥æ˜ å°„ç¼“å­˜æœ€å¤§çš„å·®å¼‚å°±æ˜¯ï¼šç¬¬ä¸€ä¸ªåœ°å€å¯¹åº”çš„æ•°æ®å¯ä»¥å¯¹åº” 2 ä¸ª cache lineï¼Œè€Œç›´æ¥æ˜ å°„ç¼“å­˜ä¸€ä¸ªåœ°å€åªå¯¹åº”ä¸€ä¸ª cache lineã€‚é‚£ä¹ˆè¿™ç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ</p><h2 id="ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜ä¼˜ç¼ºç‚¹">ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜ä¼˜ç¼ºç‚¹</h2><p>ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜çš„ç¡¬ä»¶æˆæœ¬ç›¸å¯¹äºç›´æ¥æ˜ å°„ç¼“å­˜æ›´é«˜ã€‚å› ä¸ºå…¶æ¯æ¬¡æ¯”è¾ƒ tag çš„æ—¶å€™éœ€è¦æ¯”è¾ƒå¤šä¸ª cache line å¯¹åº”çš„ tagï¼ˆæŸäº›ç¡¬ä»¶å¯èƒ½è¿˜ä¼šåšå¹¶è¡Œæ¯”è¾ƒï¼Œå¢åŠ æ¯”è¾ƒé€Ÿåº¦ï¼Œè¿™å°±å¢åŠ äº†ç¡¬ä»¶è®¾è®¡å¤æ‚åº¦ï¼‰ã€‚å¥½å¤„æ˜¯å¯ä»¥æœ‰åŠ©äºé™ä½ cache é¢ ç°¸å¯èƒ½æ€§ã€‚æ ¹æ®ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜çš„å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”»å‡ºä¸»å­˜åœ°å€ 0x00-0x4f åœ°å€å¯¹åº”çš„ cache åˆ†å¸ƒå›¾ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache12.jpg"></p><h2 id="å…¨ç›¸è¿ç¼“å­˜-full-associative-cache">å…¨ç›¸è¿ç¼“å­˜ (Full associative cache)</h2><p>æ—¢ç„¶ç»„ç›¸è¿ç¼“å­˜é‚£ä¹ˆå¥½ï¼Œå¦‚æœæ‰€æœ‰çš„ cache line éƒ½åœ¨ä¸€ä¸ªç»„å†…ã€‚å²‚ä¸æ˜¯æ€§èƒ½æ›´å¥½ã€‚æ˜¯çš„ï¼Œè¿™ç§ç¼“å­˜å°±æ˜¯å…¨ç›¸è¿ç¼“å­˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache13.jpg"></p><p>è¿™å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é™ä½ cache é¢ ç°¸çš„é¢‘ç‡ã€‚ä½†æ˜¯ç¡¬ä»¶æˆæœ¬ä¸Šä¹Ÿæ˜¯æ›´é«˜ã€‚</p><h1 id="cache-åˆ†é…ç­–ç•¥-cache-allocation-policy">Cache åˆ†é…ç­–ç•¥ (Cache allocation policy)</h1><p>cache çš„åˆ†é…ç­–ç•¥æ˜¯æŒ‡æˆ‘ä»¬ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä¸ºæ•°æ®åˆ†é… cache lineã€‚cache åˆ†é…ç­–ç•¥åˆ†ä¸ºè¯»å’Œå†™ä¸¤ç§æƒ…å†µã€‚</p><ul><li><p>è¯»åˆ†é… (read allocation) å½“ CPU è¯»æ•°æ®æ—¶ï¼Œå‘ç”Ÿ cache ç¼ºå¤±ï¼Œè¿™ç§æƒ…å†µä¸‹éƒ½ä¼šåˆ†é…ä¸€ä¸ª cache line ç¼“å­˜ä»ä¸»å­˜è¯»å–çš„æ•°æ®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œcache éƒ½æ”¯æŒè¯»åˆ†é…</p></li><li><p>å†™åˆ†é… (write allocation) å½“ CPU å†™æ•°æ®å‘ç”Ÿ cache ç¼ºå¤±æ—¶ï¼Œæ‰ä¼šè€ƒè™‘å†™åˆ†é…ç­–ç•¥ã€‚å½“æˆ‘ä»¬ä¸æ”¯æŒå†™åˆ†é…çš„æƒ…å†µä¸‹ï¼Œå†™æŒ‡ä»¤åªä¼šæ›´æ–°ä¸»å­˜æ•°æ®ï¼Œç„¶åå°±ç»“æŸäº†ã€‚å½“æ”¯æŒå†™åˆ†é…çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆä»ä¸»å­˜ä¸­åŠ è½½æ•°æ®åˆ° cache line ä¸­ï¼ˆç›¸å½“äºå…ˆåšä¸ªè¯»åˆ†é…åŠ¨ä½œï¼‰ï¼Œç„¶åä¼šæ›´æ–° cache line ä¸­çš„æ•°æ®</p></li></ul><h1 id="cache-æ›´æ–°ç­–ç•¥-cache-update-policy">Cache æ›´æ–°ç­–ç•¥ (Cache update policy)</h1><p>cache æ›´æ–°ç­–ç•¥æ˜¯æŒ‡å½“å‘ç”Ÿ cache å‘½ä¸­æ—¶ï¼Œå†™æ“ä½œåº”è¯¥å¦‚ä½•æ›´æ–°æ•°æ®ã€‚cache æ›´æ–°ç­–ç•¥åˆ†æˆä¸¤ç§ï¼šå†™ç›´é€šå’Œå›å†™ã€‚</p><ul><li><p>å†™ç›´é€š (write through) å½“ CPU æ‰§è¡Œ store æŒ‡ä»¤å¹¶åœ¨ cache å‘½ä¸­æ—¶ï¼Œæˆ‘ä»¬æ›´æ–° cache ä¸­çš„æ•°æ®å¹¶ä¸”æ›´æ–°ä¸»å­˜ä¸­çš„æ•°æ®ã€‚cache å’Œä¸»å­˜çš„æ•°æ®å§‹ç»ˆä¿æŒä¸€è‡´</p></li><li><p>å†™å› (write back) å½“ CPU æ‰§è¡Œ store æŒ‡ä»¤å¹¶åœ¨ cache å‘½ä¸­æ—¶ï¼Œæˆ‘ä»¬åªæ›´æ–° cache ä¸­çš„æ•°æ®ã€‚å¹¶ä¸”æ¯ä¸ª cache line ä¸­ä¼šæœ‰ä¸€ä¸ª bit ä½è®°å½•æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œç§°ä¹‹ä¸º dirty bitï¼ˆç¿»ç¿»å‰é¢çš„å›¾ç‰‡ï¼Œcache line æ—è¾¹æœ‰ä¸€ä¸ª D å°±æ˜¯ dirty bitï¼‰ã€‚æˆ‘ä»¬ä¼šå°† dirty bit ç½®ä½ã€‚ä¸»å­˜ä¸­çš„æ•°æ®åªä¼šåœ¨ cache line è¢«æ›¿æ¢æˆ–è€…æ˜¾ç¤ºçš„ clean æ“ä½œæ—¶æ›´æ–°ã€‚å› æ­¤ï¼Œä¸»å­˜ä¸­çš„æ•°æ®å¯èƒ½æ˜¯æœªä¿®æ”¹çš„æ•°æ®ï¼Œè€Œä¿®æ”¹çš„æ•°æ®èººåœ¨ cache ä¸­ã€‚cache å’Œä¸»å­˜çš„æ•°æ®å¯èƒ½ä¸ä¸€è‡´</p></li></ul><p>åŒæ—¶æ€è€ƒä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆ cache line å¤§å°æ˜¯ cache æ§åˆ¶å™¨å’Œä¸»å­˜ä¹‹é—´æ•°æ®ä¼ è¾“çš„æœ€å°å•ä½å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯å› ä¸ºæ¯ä¸ª cache line åªæœ‰ä¸€ä¸ª dirty bitã€‚è¿™ä¸€ä¸ª dirty bit ä»£è¡¨ç€æ•´ä¸ª cache line æ˜¯å¦è¢«ä¿®æ”¹çš„çŠ¶æ€ã€‚</p><h1 id="cache-åœ°å€">Cache åœ°å€</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ cache æ§åˆ¶å™¨æ ¹æ®åœ°å€æŸ¥æ‰¾åˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œè¿™é‡Œçš„åœ°å€ç©¶ç«Ÿæ˜¯è™šæ‹Ÿåœ°å€ (virtual addressï¼ŒVA) è¿˜æ˜¯ç‰©ç†åœ°å€ (physical addressï¼ŒPA)ï¼Ÿ</p><h2 id="è™šæ‹Ÿé«˜é€Ÿç¼“å­˜-vivt">è™šæ‹Ÿé«˜é€Ÿç¼“å­˜ (VIVT)</h2><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»çš„æ˜¯è™šæ‹Ÿé«˜é€Ÿç¼“å­˜ï¼Œè¿™ç§ cache ç¡¬ä»¶è®¾è®¡ç®€å•ã€‚åœ¨ cache è¯ç”Ÿä¹‹åˆï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†å™¨éƒ½ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚è™šæ‹Ÿé«˜é€Ÿç¼“å­˜ä»¥è™šæ‹Ÿåœ°å€ä½œä¸ºæŸ¥æ‰¾å¯¹è±¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache14.jpg"></p><p>è™šæ‹Ÿåœ°å€ç›´æ¥é€åˆ° cache æ§åˆ¶å™¨ï¼Œå¦‚æœ cache hitã€‚ç›´æ¥ä» cache ä¸­è¿”å›æ•°æ®ç»™ CPUã€‚å¦‚æœ cache missï¼Œåˆ™æŠŠè™šæ‹Ÿåœ°å€å‘å¾€ MMUï¼Œç»è¿‡ MMU è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œæ ¹æ®ç‰©ç†åœ°å€ä»ä¸»å­˜ (main memory) è¯»å–æ•°æ®ã€‚ ä½†æ˜¯ï¼Œæ­£æ˜¯ä½¿ç”¨äº†è™šæ‹Ÿåœ°å€ä½œä¸º tagï¼Œæ‰€ä»¥å¼•å…¥å¾ˆå¤šè½¯ä»¶ä½¿ç”¨ä¸Šçš„é—®é¢˜ã€‚ æ“ä½œç³»ç»Ÿåœ¨ç®¡ç†é«˜é€Ÿç¼“å­˜æ­£ç¡®å·¥ä½œçš„è¿‡ç¨‹ä¸­ï¼Œä¸»è¦ä¼šé¢ä¸´ä¸¤ä¸ªé—®é¢˜ã€‚æ­§ä¹‰ (ambiguity) å’Œåˆ«å (alias)ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„æ­£ç¡®å·¥ä½œï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£é¿å…å‡ºç°æ­§ä¹‰å’Œåˆ«åã€‚</p><ul><li><p>æ­§ä¹‰ (ambiguity)<br>æ­§ä¹‰æ˜¯æŒ‡ä¸åŒçš„æ•°æ®åœ¨ cache ä¸­å…·æœ‰ç›¸åŒçš„ tag å’Œ indexï¼Œè¿™å°±äº§ç”Ÿäº†æ­§ä¹‰ï¼ˆä¸åŒè¿›ç¨‹ç›¸åŒè™šæ‹Ÿåœ°å€æ˜ å°„äº†ä¸åŒç‰©ç†åœ°å€ï¼‰ã€‚å½“æˆ‘ä»¬åˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹© flush æ‰€æœ‰çš„ cacheã€‚flush cache æ“ä½œæœ‰ä¸¤ç§ï¼š<br>- ä½¿ä¸»å­˜å‚¨å™¨æœ‰æ•ˆã€‚é’ˆå¯¹ write back é«˜é€Ÿç¼“å­˜ï¼Œé¦–å…ˆåº”è¯¥ä½¿ä¸»å­˜å‚¨å™¨æœ‰æ•ˆï¼Œä¿è¯å·²ç»ä¿®æ”¹æ•°æ®çš„ cacheline å†™å›ä¸»å­˜å‚¨å™¨ï¼Œé¿å…ä¿®æ”¹çš„æ•°æ®ä¸¢å¤±<br>- ä½¿é«˜é€Ÿç¼“å­˜æ— æ•ˆã€‚ä¿è¯åˆ‡æ¢åçš„è¿›ç¨‹ä¸ä¼šé”™è¯¯çš„å‘½ä¸­ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ç¼“å­˜æ•°æ®</p><p>å› æ­¤ï¼Œåˆ‡æ¢åçš„è¿›ç¨‹åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå°†ä¼šç”±äºå¤§é‡çš„ cache miss å¯¼è‡´æ€§èƒ½æŸå¤±ã€‚</p></li><li><p>åˆ«å (alias) å½“ä¸åŒçš„è™šæ‹Ÿåœ°å€æ˜ å°„ç›¸åŒçš„ç‰©ç†åœ°å€ï¼Œé€šä¿—ç‚¹æ¥è¯´å°±æ˜¯æŒ‡åŒä¸€ä¸ªç‰©ç†åœ°å€çš„æ•°æ®è¢«åŠ è½½åˆ°ä¸åŒçš„ cacheline ä¸­å°±ä¼šå‡ºç°åˆ«åç°è±¡ã€‚</p></li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache15.jpg"></p><p>é’ˆå¯¹å…±äº«æ•°æ®æ‰€åœ¨é¡µçš„æ˜ å°„æ–¹å¼é‡‡ç”¨ nocache æ˜ å°„ã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ0x2000 å’Œ 0x4000 æ˜ å°„ç‰©ç†åœ°å€ 0x8000 çš„æ—¶å€™éƒ½é‡‡ç”¨ nocache çš„æ–¹å¼ï¼Œè¿™æ ·ä¸é€šè¿‡ cache çš„è®¿é—®ï¼Œè‚¯å®šå¯ä»¥é¿å…è¿™ç§é—®é¢˜ã€‚</p><h2 id="ç‰©ç†é«˜é€Ÿç¼“å­˜-pipt">ç‰©ç†é«˜é€Ÿç¼“å­˜ (PIPT)</h2><p>åŸºäºå¯¹ VIVT é«˜é€Ÿç¼“å­˜çš„è®¤è¯†ï¼Œæˆ‘ä»¬çŸ¥é“ VIVT é«˜é€Ÿç¼“å­˜å­˜åœ¨æ­§ä¹‰å’Œååˆ«ä¸¤å¤§é—®é¢˜ã€‚ä¸»è¦é—®é¢˜åŸå› æ˜¯ï¼štag å–è‡ªè™šæ‹Ÿåœ°å€å¯¼è‡´æ­§ä¹‰ï¼Œindex å–è‡ªè™šæ‹Ÿåœ°å€å¯¼è‡´åˆ«åã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³è®©æ“ä½œç³»ç»Ÿå°‘æ“å¿ƒï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ tag å’Œ index éƒ½å–è‡ªç‰©ç†åœ°å€ã€‚ç‰©ç†çš„åœ°å€ tag éƒ¨åˆ†æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå› æ­¤è‚¯å®šä¸ä¼šå¯¼è‡´æ­§ä¹‰ã€‚è€Œé’ˆå¯¹åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œindex ä¹Ÿæ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤åŠ è½½åˆ° cache ä¸­ä¹Ÿæ˜¯å”¯ä¸€çš„ cachelineï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå­˜åœ¨åˆ«åã€‚æˆ‘ä»¬ç§°è¿™ç§ cache ä¸ºç‰©ç†é«˜é€Ÿç¼“å­˜ï¼Œç®€ç§° PIPT(Physically Indexed Physically Tagged)ã€‚PIPT å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache16.jpg"></p><p>CPU å‘å‡ºçš„è™šæ‹Ÿåœ°å€ç»è¿‡ MMU è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œç‰©ç†åœ°å€å‘å¾€ cache æ§åˆ¶å™¨æŸ¥æ‰¾ç¡®è®¤æ˜¯å¦å‘½ä¸­ cacheã€‚è™½ç„¶ PIPT æ–¹å¼åœ¨è½¯ä»¶å±‚é¢åŸºæœ¬ä¸éœ€è¦ç»´æŠ¤ï¼Œä½†æ˜¯ç¡¬ä»¶è®¾è®¡ä¸Šæ¯” VIVT å¤æ‚å¾ˆå¤šã€‚å› æ­¤ç¡¬ä»¶æˆæœ¬ä¹Ÿæ›´é«˜ã€‚åŒæ—¶ï¼Œç”±äºè™šæ‹Ÿåœ°å€æ¯æ¬¡éƒ½è¦ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼Œå› æ­¤åœ¨æŸ¥æ‰¾æ€§èƒ½ä¸Šæ²¡æœ‰ VIVT æ–¹å¼ç®€æ´é«˜æ•ˆï¼Œæ¯•ç«Ÿ PIPT æ–¹å¼éœ€è¦ç­‰å¾…è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€å®Œæˆåæ‰èƒ½å»æŸ¥æ‰¾ cacheã€‚ åœ¨ Linux å†…æ ¸ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é’ˆå¯¹ PIPT é«˜é€Ÿç¼“å­˜çš„ç®¡ç†å‡½æ•°éƒ½æ˜¯ç©ºå‡½æ•°ï¼Œæ— éœ€ä»»ä½•çš„ç®¡ç†ã€‚</p><h2 id="ç‰©ç†æ ‡è®°çš„è™šæ‹Ÿé«˜é€Ÿç¼“å­˜-vipt">ç‰©ç†æ ‡è®°çš„è™šæ‹Ÿé«˜é€Ÿç¼“å­˜ (VIPT)</h2><p>ä¸ºäº†æå‡ cache æŸ¥æ‰¾æ€§èƒ½ï¼Œæˆ‘ä»¬ä¸æƒ³ç­‰åˆ°è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€å®Œæˆåæ‰èƒ½æŸ¥æ‰¾ cacheã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è™šæ‹Ÿåœ°å€å¯¹åº”çš„ index ä½æŸ¥æ‰¾ cacheï¼Œä¸æ­¤åŒæ—¶ï¼ˆç¡¬ä»¶ä¸ŠåŒæ—¶è¿›è¡Œï¼‰å°†è™šæ‹Ÿåœ°å€å‘åˆ° MMU è½¬æ¢æˆç‰©ç†åœ°å€ã€‚å½“ MMU è½¬æ¢å®Œæˆï¼ŒåŒæ—¶ cache æ§åˆ¶å™¨ä¹ŸæŸ¥æ‰¾å®Œæˆï¼Œæ­¤æ—¶æ¯”è¾ƒ cacheline å¯¹åº”çš„ tag å’Œç‰©ç†åœ°å€ tag åŸŸï¼Œä»¥æ­¤åˆ¤æ–­æ˜¯å¦å‘½ä¸­ cacheã€‚æˆ‘ä»¬ç§°è¿™ç§é«˜é€Ÿç¼“å­˜ä¸º VIPT(Virtually Indexed Physically Tagged)ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cache17.jpg"></p><p>VIPT ä»¥ç‰©ç†åœ°å€éƒ¨åˆ†ä½ä½œä¸º tagï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šå­˜åœ¨æ­§ä¹‰é—®é¢˜ã€‚ä½†æ˜¯ï¼Œé‡‡ç”¨è™šæ‹Ÿåœ°å€ä½œä¸º indexï¼Œæ‰€ä»¥å¯èƒ½ä¾ç„¶å­˜åœ¨åˆ«åé—®é¢˜ã€‚æ˜¯å¦å­˜åœ¨åˆ«åé—®é¢˜ï¼Œéœ€è¦è€ƒè™‘ cache çš„ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æƒ…å†µè€ƒè™‘ã€‚</p><ul><li><p>VIPT Cache ä¸ºä»€ä¹ˆä¸å­˜åœ¨æ­§ä¹‰ åœ¨è¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‹ä¸ºä»€ä¹ˆ VIPT Cache ä¸å­˜åœ¨æ­§ä¹‰ã€‚å‡è®¾ä»¥ 32 ä½ CPU ä¸ºä¾‹ï¼Œé¡µè¡¨æ˜ å°„æœ€å°å•ä½æ˜¯ 4KBã€‚æˆ‘ä»¬å‡è®¾è™šæ‹Ÿåœ°å€&lt;12:4&gt;ä½ï¼ˆè¿™æ˜¯ä¸€ä¸ªæœ‰åˆ«åé—®é¢˜çš„ VIPT Cache) ä½œä¸º indexï¼Œäºæ­¤åŒæ—¶å°†è™šæ‹Ÿåœ°å€&lt;31:12&gt;å‘é€åˆ° MMU è½¬æ¢å¾—åˆ°ç‰©ç†åœ°å€çš„&lt;31:12&gt;ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠ&lt;31:12&gt;ä½œä¸º tagï¼Œå¹¶ä¸æ˜¯&lt;31:13&gt;ã€‚è¿™åœ°æ–¹å¾ˆå…³é”®ï¼Œä¹Ÿå°±æ˜¯è¯´ VIPT çš„ tag å–å†³äºç‰©ç†é¡µå¤§å°çš„å‰©ä½™ä½æ•°ï¼Œè€Œä¸æ˜¯å»æ‰ index å’Œ offset çš„å‰©ä½™ä½æ•°ã€‚ç‰©ç† tag æ˜¯æƒŸä¸€çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ­§ä¹‰ã€‚</p></li><li><p>VIPT Cache ä»€ä¹ˆæƒ…å†µä¸å­˜åœ¨åˆ«å æˆ‘ä»¬çŸ¥é“ VIPT çš„ä¼˜ç‚¹æ˜¯æŸ¥æ‰¾ cache å’Œ MMU è½¬æ¢è™šæ‹Ÿåœ°å€åŒæ—¶è¿›è¡Œï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šæœ‰æ‰€æå‡ã€‚æ­§ä¹‰é—®é¢˜è™½ç„¶ä¸å­˜åœ¨äº†ï¼Œä½†æ˜¯åˆ«åé—®é¢˜ä¾æ—§å¯èƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹åˆ«åé—®é¢˜ä¸ä¼šå­˜åœ¨å‘¢ï¼ŸLinux ç³»ç»Ÿä¸­æ˜ å°„æœ€å°çš„å•ä½æ˜¯é¡µï¼Œä¸€é¡µå¤§å°æ˜¯ 4KBã€‚é‚£ä¹ˆæ„å‘³ç€è™šæ‹Ÿåœ°å€å’Œå…¶æ˜ å°„çš„ç‰©ç†åœ°å€çš„ä½&lt;11...0&gt;æ˜¯ä¸€æ ·çš„ã€‚é’ˆå¯¹ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ï¼Œå¦‚æœ cache çš„ size å°äºç­‰äº 4KBï¼Œæ˜¯å¦å°±æ„å‘³ç€æ— è®ºä½¿ç”¨è™šæ‹Ÿåœ°å€è¿˜æ˜¯ç‰©ç†åœ°å€çš„ä½ä½æŸ¥æ‰¾ cache ç»“æœéƒ½æ˜¯ä¸€æ ·å‘¢ï¼Ÿæ˜¯çš„ï¼Œå› ä¸ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€å¯¹åº”çš„ index æ˜¯ä¸€æ ·çš„ã€‚è¿™ç§æƒ…å†µï¼ŒVIPT å®é™…ä¸Šç›¸å½“äº PIPTï¼Œè½¯ä»¶ç»´æŠ¤ä¸Šå’Œ PIPT ä¸€æ ·ã€‚å¦‚æœç¤ºä¾‹æ˜¯ä¸€ä¸ªå››è·¯ç»„ç›¸è¿é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿåªè¦æ»¡è¶³ä¸€è·¯çš„ cache çš„å¤§å°å°äºç­‰äº 4KBï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šå‡ºç°åˆ«åé—®é¢˜ã€‚</p></li><li><p>VIPT Cache çš„åˆ«åé—®é¢˜ å‡è®¾ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ï¼Œcache å¤§å°æ˜¯ 8KBï¼Œcacheline å¤§å°æ˜¯ 256 å­—èŠ‚ã€‚è¿™ç§æƒ…å†µä¸‹çš„ VIPT å°±å­˜åœ¨åˆ«åé—®é¢˜ã€‚å› ä¸º index æ¥è‡ªè™šæ‹Ÿåœ°å€ä½&lt;12...8&gt;ï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„ä½&lt;11...8&gt;æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ bit12 å´ä¸ä¸€å®šç›¸ç­‰ã€‚ å‡è®¾è™šæ‹Ÿåœ°å€ 0x0000 å’Œè™šæ‹Ÿåœ°å€ 0x1000 éƒ½æ˜ å°„ç›¸åŒçš„ç‰©ç†åœ°å€ 0x4000ã€‚é‚£ä¹ˆç¨‹åºè¯»å– 0x0000 æ—¶ï¼Œç³»ç»Ÿå°†ä¼šä»ç‰©ç†åœ°å€ 0x4000 çš„æ•°æ®åŠ è½½åˆ°ç¬¬ 0x00 è¡Œ cachelineã€‚ç„¶åç¨‹åºè¯»å– 0x1000 æ•°æ®ï¼Œå†æ¬¡æŠŠç‰©ç†åœ°å€ 0x4000 çš„æ•°æ®åŠ è½½åˆ°ç¬¬ 0x10 è¡Œ cachelineã€‚è¿™ä¸ï¼Œåˆ«åå‡ºç°äº†ã€‚ç›¸åŒç‰©ç†åœ°å€çš„æ•°æ®è¢«åŠ è½½åˆ°ä¸åŒ cacheline ä¸­ã€‚</p></li></ul><h2 id="å¦‚ä½•è§£å†³-vipt-cache-åˆ«åé—®é¢˜">å¦‚ä½•è§£å†³ VIPT Cache åˆ«åé—®é¢˜</h2><p>æˆ‘ä»¬æ¥ç€ä¸Šé¢çš„ä¾‹å­è¯´æ˜ã€‚é¦–å…ˆå‡ºç°é—®é¢˜çš„åœºæ™¯æ˜¯å…±äº«æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªè™šæ‹Ÿåœ°å€æ˜ å°„åŒä¸€ä¸ªç‰©ç†åœ°å€æ‰å¯èƒ½å‡ºç°é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•é¿å…ç›¸åŒçš„ç‰©ç†åœ°å€æ•°æ®åŠ è½½åˆ°ä¸åŒçš„ cacheline ä¸­ã€‚å¦‚ä½•åšåˆ°å‘¢ï¼Ÿé‚£æˆ‘ä»¬å°±é¿å…ä¸Šä¸ªä¾‹å­ä¸­ 0x1000 æ˜ å°„ 0x4000 çš„æƒ…å†µå‘ç”Ÿã€‚æˆ‘ä»¬å¯ä»¥å°†è™šæ‹Ÿåœ°å€ 0x2000 æ˜ å°„åˆ°ç‰©ç†åœ°å€ 0x4000ï¼Œè€Œä¸æ˜¯ç”¨è™šæ‹Ÿåœ°å€ 0x1000ã€‚0x2000 å¯¹åº”ç¬¬ 0x00 è¡Œ cachelineï¼Œè¿™æ ·å°±é¿å…äº†åˆ«åç°è±¡å‡ºç°ã€‚å› æ­¤ï¼Œåœ¨å»ºç«‹å…±äº«æ˜ å°„çš„æ—¶å€™ï¼Œè¿”å›çš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯æŒ‰ç…§ cache å¤§å°å¯¹é½çš„åœ°å€ï¼Œè¿™æ ·å°±æ²¡é—®é¢˜äº†ã€‚å¦‚æœæ˜¯å¤šè·¯ç»„ç›¸è¿é«˜é€Ÿç¼“å­˜çš„è¯ï¼Œè¿”å›çš„è™šæ‹Ÿåœ°å€å¿…é¡»æ˜¯æ»¡è¶³ä¸€è·¯ cache å¤§å°å¯¹é½ã€‚åœ¨ Linux çš„å®ç°ä¸­ï¼Œå°±æ˜¯é€šè¿‡è¿™ç§æ–¹æ³•è§£å†³åˆ«åé—®é¢˜ã€‚</p><h2 id="ä¸å­˜åœ¨çš„-pivt-é«˜é€Ÿç¼“å­˜">ä¸å­˜åœ¨çš„ PIVT é«˜é€Ÿç¼“å­˜</h2><p>æŒ‰ç…§æ’åˆ—ç»„åˆæ¥è¯´ï¼Œåº”è¯¥è¿˜å­˜åœ¨ä¸€ç§ PIVT æ–¹å¼çš„é«˜é€Ÿç¼“å­˜ã€‚å› ä¸º PIVT æ²¡æœ‰ä»»ä½•ä¼˜ç‚¹ï¼Œå´åŒ…å«ä»¥ä¸Šçš„æ‰€æœ‰ç¼ºç‚¹ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>VIVT Cache é—®é¢˜å¤ªå¤šï¼Œè½¯ä»¶ç»´æŠ¤æˆæœ¬è¿‡é«˜ï¼Œæ˜¯æœ€éš¾ç®¡ç†çš„é«˜é€Ÿç¼“å­˜ã€‚æ‰€ä»¥ç°åœ¨åŸºæœ¬åªå­˜åœ¨å†å²çš„æ–‡ç« ä¸­ã€‚ç°åœ¨æˆ‘ä»¬åŸºæœ¬çœ‹ä¸åˆ°ç¡¬ä»¶è¿˜åœ¨ä½¿ç”¨è¿™ç§æ–¹å¼çš„ cacheã€‚ç°åœ¨ä½¿ç”¨çš„æ–¹å¼æ˜¯ PIPT æˆ–è€… VIPTã€‚å¦‚æœå¤šè·¯ç»„ç›¸è¿é«˜é€Ÿç¼“å­˜çš„ä¸€è·¯çš„å¤§å°å°äºç­‰äº 4KBï¼Œä¸€èˆ¬ç¡¬ä»¶é‡‡ç”¨ VIPT æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ç›¸å½“äº PIPTï¼Œå²‚ä¸ç¾å“‰ã€‚å½“ç„¶ï¼Œå¦‚æœä¸€è·¯å¤§å°å¤§äº 4KBï¼Œä¸€èˆ¬é‡‡ç”¨ PIPT æ–¹å¼ï¼Œä¹Ÿä¸æ’é™¤ VIPT æ–¹å¼ï¼Œè¿™å°±éœ€è¦æ“ä½œç³»ç»Ÿå¤šæ“ç‚¹å¿ƒäº†ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDIyOTM0Mzc=">https://zhuanlan.zhihu.com/p/102293437<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDcwOTYxMzA=">https://zhuanlan.zhihu.com/p/107096130<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆç•ªå¤–ç¯‡ï¼‰è°ƒåº¦ç®—æ³•çš„æ¼”å˜</title>
      <link href="/2021/LinuxKernel/LinuxTaskExt/"/>
      <url>/2021/LinuxKernel/LinuxTaskExt/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskSchAlgoHistory.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2MDJmYTYzNzY4OTA3MTA1OWI5Mjk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="onè°ƒåº¦å™¨">Oï¼ˆnï¼‰è°ƒåº¦å™¨</h1><h2 id="å¦‚ä½•ç»„ç»‡-task">å¦‚ä½•ç»„ç»‡ task</h2><p>è°ƒåº¦å™¨æ¨¡å—å®šä¹‰äº†ä¸€ä¸ª runqueue_head çš„é“¾è¡¨å¤´å˜é‡ï¼Œæ— è®ºè¿›ç¨‹æ˜¯æ™®é€šè¿›ç¨‹è¿˜æ˜¯å®æ—¶è¿›ç¨‹ï¼Œåªè¦è¿›ç¨‹çŠ¶æ€å˜æˆå¯è¿è¡ŒçŠ¶æ€çš„æ—¶å€™ï¼Œå®ƒä¼šè¢«æŒ‚å…¥è¿™ä¸ªå…¨å±€ runqueue é“¾è¡¨ä¸­ã€‚ç”±äºæ•´ä¸ªç³»ç»Ÿä¸­çš„æ‰€æœ‰ CPU å…±äº«ä¸€ä¸ª runqueueï¼Œä¸ºäº†è§£å†³åŒæ­¥é—®é¢˜ï¼Œè°ƒåº¦å™¨æ¨¡å—å®šä¹‰äº†ä¸€ä¸ªè‡ªæ—‹é”æ¥ä¿æŠ¤å¯¹è¿™ä¸ªå…¨å±€ runqueue çš„å¹¶å‘è®¿é—®ã€‚</p><p>é™¤äº†è¿™ä¸ª runqueue é˜Ÿåˆ—ï¼Œç³»ç»Ÿè¿˜æœ‰ä¸€ä¸ªå›Šæ‹¬æ‰€æœ‰ taskï¼ˆä¸ç®¡å…¶è¿›ç¨‹çŠ¶æ€ä¸ºä½•ï¼‰çš„é“¾è¡¨ï¼Œé“¾è¡¨å¤´å®šä¹‰ä¸º init_taskï¼Œåœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸç»“æŸåï¼Œé‡æ–°ä¸º task èµ‹åˆå§‹æ—¶é—´ç‰‡å€¼çš„æ—¶å€™ä¼šç”¨åˆ°è¯¥é“¾è¡¨ã€‚</p><h2 id="åŠ¨æ€ä¼˜å…ˆçº§">åŠ¨æ€ä¼˜å…ˆçº§</h2><p>å¯¹äºæ™®é€šè¿›ç¨‹ï¼Œè®¡ç®—åŠ¨æ€ä¼˜å…ˆçº§çš„ç­–ç•¥å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœè¯¥è¿›ç¨‹çš„æ—¶é—´ç‰‡å·²ç»è€—å°½ï¼Œé‚£ä¹ˆåŠ¨æ€ä¼˜å…ˆçº§æ˜¯ 0ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨æœ¬æ¬¡è°ƒåº¦å‘¨æœŸä¸­è¯¥è¿›ç¨‹å·²ç»å†ä¹Ÿæ²¡æœ‰æœºä¼šè·å– CPU èµ„æºäº†ã€‚</li><li>å¦‚æœè¯¥è¿›ç¨‹çš„æ—¶é—´ç‰‡è¿˜æœ‰å‰©ä½™ï¼Œé‚£ä¹ˆå…¶åŠ¨æ€ä¼˜å…ˆçº§ç­‰äºè¯¥è¿›ç¨‹å‰©ä½™çš„æ—¶é—´ç‰‡å’Œé™æ€ä¼˜å…ˆçº§ä¹‹å’Œã€‚ä¹‹æ‰€ä»¥ç”¨ï¼ˆ20-nice valueï¼‰è¡¨ç¤ºé™æ€ä¼˜å…ˆçº§ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®©é™æ€ä¼˜å…ˆçº§å˜æˆå•è°ƒä¸Šå‡ã€‚ä¹‹æ‰€ä»¥è¦è€ƒè™‘å‰©ä½™æ—¶é—´ç‰‡æ˜¯ä¸ºäº†å¥–åŠ±ç¡çœ çš„è¿›ç¨‹ï¼Œå› ä¸ºç¡çœ çš„è¿›ç¨‹å‰©ä½™çš„æ—¶é—´ç‰‡è¾ƒå¤šï¼Œå› æ­¤åŠ¨æ€ä¼˜å…ˆçº§ä¹Ÿå°±ä¼šé«˜ä¸€äº›ï¼Œæ›´å®¹æ˜“è¢«è°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œã€‚</li></ul><p>åœ¨è®¡ç®—æ™®é€šè¿›ç¨‹çš„åŠ¨æ€ä¼˜å…ˆçº§çš„æ—¶å€™ï¼Œé™¤äº†è€ƒè™‘è¿›ç¨‹å‰©ä½™æ—¶é—´ç‰‡ä¿¡æ¯å’Œé™æ€ä¼˜å…ˆçº§ï¼Œè°ƒåº¦å™¨ä¹Ÿä¼šé…Œæƒ…è€ƒè™‘ cache å’Œ TLB çš„æ€§èƒ½é—®é¢˜ã€‚ä¾‹å¦‚ A å’Œ B è¿›ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œå‰©ä½™çš„æ—¶é—´ç‰‡éƒ½æ˜¯ 3 ä¸ª tickï¼Œä½†æ˜¯ A è¿›ç¨‹ä¸Šä¸€æ¬¡å°±æ˜¯è¿è¡Œåœ¨æœ¬ CPU ä¸Šï¼Œå¦‚æœé€‰æ‹© Aï¼Œå¯èƒ½ä¼šæœ‰æ›´å¥½çš„ cache å’Œ TLB çš„å‘½ä¸­ç‡ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒåº¦å™¨ä¼šæå‡ A è¿›ç¨‹çš„åŠ¨æ€ä¼˜å…ˆçº§ã€‚æ­¤å¤–ï¼Œå¦‚æœå¤‡é€‰è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«åŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œé‚£ä¹ˆåœ¨è®¡ç®—è°ƒåº¦æŒ‡æ•°çš„æ—¶å€™ä¹Ÿä¼šåšå°å°çš„å€¾æ–œã€‚</p><h2 id="ä¸»è°ƒåº¦å™¨ç®—æ³•">ä¸»è°ƒåº¦å™¨ç®—æ³•</h2><p>ä¸»è°ƒåº¦å™¨ï¼ˆschedule å‡½æ•°ï¼‰æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">list_for_each(tmp, &amp;runqueue_head) {</span><br><span class="line">    p = list_entry(tmp, <span class="keyword">struct</span> task_struct, run_list);</span><br><span class="line">    <span class="type">int</span> weight = goodness(p, this_cpu, prev-&gt;active_mm);</span><br><span class="line">    <span class="keyword">if</span> (weight &gt; c)</span><br><span class="line">        c = weight, next = p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>list_for_each ç”¨æ¥éå† runqueue_head é“¾è¡¨ä¸Šçš„æ‰€æœ‰çš„è¿›ç¨‹ï¼Œä¸´æ—¶å˜é‡ p å°±æ˜¯æœ¬æ¬¡éœ€è¦æ£€æŸ¥çš„è¿›ç¨‹æè¿°ç¬¦ã€‚å¦‚ä½•åˆ¤æ–­å“ªä¸€ä¸ªè¿›ç¨‹æ˜¯æœ€é€‚åˆè°ƒåº¦æ‰§è¡Œçš„è¿›ç¨‹å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦è®¡ç®—è¿›ç¨‹çš„åŠ¨æ€ä¼˜å…ˆçº§ï¼ˆå¯¹åº”ä¸Šé¢ç¨‹åºä¸­çš„å˜é‡ weightï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡ goodness å‡½æ•°å®ç°çš„ã€‚åŠ¨æ€ä¼˜å…ˆçº§æœ€å¤§çš„é‚£ä¸ªè¿›ç¨‹å°±æ˜¯å½“å‰æœ€é€‚åˆè°ƒåº¦åˆ° CPU æ‰§è¡Œçš„è¿›ç¨‹ã€‚ä¸€æ—¦é€‰ä¸­ï¼Œè°ƒåº¦å™¨ä¼šå¯åŠ¨è¿›ç¨‹åˆ‡æ¢ï¼Œè¿è¡Œè¯¥è¿›ç¨‹ä»¥æ›¿æ¢ä¹‹å‰çš„é‚£ä¸ªè¿›ç¨‹ã€‚</p><h2 id="æ—¶é—´ç‰‡å¤„ç†">æ—¶é—´ç‰‡å¤„ç†</h2><p>æ™®é€šè¿›ç¨‹çš„æ—¶é—´ç‰‡å¤„ç†æ€è·¯æ˜¯è¿™æ ·ï¼š</p><ul><li>æ¯ä¸ªè¿›ç¨‹æ ¹æ®å…¶é™æ€ä¼˜å…ˆçº§å¯ä»¥å›ºå®šåˆ†é…ä¸€ä¸ªç¼ºçœçš„æ—¶é—´ç‰‡ï¼Œé™æ€ä¼˜å…ˆçº§è¶Šå¤§ï¼Œåˆ†é…çš„æ—¶é—´ç‰‡å°±è¶Šå¤§ã€‚</li><li>ä¸€æ—¦ Runqueue ä¸­çš„è¿›ç¨‹è¢«è°ƒåº¦æ‰§è¡Œï¼Œé‚£ä¹ˆå…¶æ—¶é—´ç‰‡å°±ä¼šåœ¨ tick åˆ°æ¥çš„æ—¶å€™é€’å‡ï¼Œå¦‚æœè¿›ç¨‹æ—¶é—´ç‰‡è€—å°½ï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹å°†å¤±å»åˆ†é… CPU èµ„æºçš„èµ„æ ¼ã€‚</li><li>Runqueue ä¸­çš„è¿›ç¨‹çš„æ—¶é—´ç‰‡å…¨éƒ¨è¢«ç”¨å®Œä¹‹åï¼Œæˆ‘ä»¬ç§°ä¸€ä¸ªè°ƒåº¦å‘¨æœŸç»“æŸï¼Œè¿™æ—¶å€™éœ€è¦ä¸º runqueue ä¸­çš„è¿›ç¨‹é‡æ–°è®¾å®šå…¶ç¼ºçœæ—¶é—´ç‰‡ï¼Œè¿™æ ·ï¼Œä¸€ä¸ªæ–°çš„è°ƒåº¦å‘¨æœŸåˆå¼€å§‹äº†ã€‚</li></ul><h1 id="o1è°ƒåº¦å™¨">Oï¼ˆ1ï¼‰è°ƒåº¦å™¨</h1><h2 id="why-o1è°ƒåº¦å™¨">Why Oï¼ˆ1ï¼‰è°ƒåº¦å™¨</h2><p>è®©æˆ‘ä»¬ä¸€èµ·æ¥æ§è¯‰ Oï¼ˆnï¼‰è°ƒåº¦å™¨çš„â€œä¸ƒå®—ç½ªâ€ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ Ingo Molnar å‘èµ· Oï¼ˆ1ï¼‰è°ƒåº¦å™¨é¡¹ç›®èƒŒåçš„åŸå› ã€‚</p><ul><li><p>ç®—æ³•å¤æ‚åº¦é—®é¢˜ï¼š è®©äººæœ€ä¸çˆ½çš„å°±æ˜¯å¯¹ runqueue é˜Ÿåˆ—çš„éå†ï¼Œéšç€ç³»ç»Ÿä¸­ runnable çŠ¶æ€çš„è¿›ç¨‹æ•°ç›®å¢å¤šï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ select next çš„è¿ç®—é‡ä¹Ÿéšä¹‹å‘ˆçº¿æ€§çš„å¢é•¿ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆå«å®ƒ Oï¼ˆnï¼‰è°ƒåº¦å™¨çš„åŸå› ã€‚æ­¤å¤–ï¼Œè°ƒåº¦å‘¨æœŸç»“æŸåï¼Œè°ƒåº¦å™¨ä¼šä¸ºæ‰€æœ‰è¿›ç¨‹çš„æ—¶é—´ç‰‡è¿›è¡Œâ€œå……å€¼â€œçš„åŠ¨ä½œï¼Œä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹è®¡ç®—å…¶æ—¶é—´ç‰‡çš„è¿‡ç¨‹å¤ªè€—è´¹æ—¶é—´ã€‚</p></li><li>SMP æ‰©å±•æ€§é—®é¢˜ï¼Œ2.4 å†…æ ¸çš„ Oï¼ˆnï¼‰è°ƒåº¦å™¨æœ‰éå¸¸å·®çš„ SMP æ‰©å±•æ€§ã€‚</li><li><p>CPU ç©ºè½¬é—®é¢˜ï¼š æ¯å½“ runqueue é“¾è¡¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹è€—å°½äº†å…¶æ—¶é—´ç‰‡ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¯åŠ¨å¯¹ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹æ—¶é—´ç‰‡é‡æ–°è®¡ç®—çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè®¡ç®—è¿‡ç¨‹å¼‚å¸¸ä¸‘é™‹ï¼Œéœ€è¦éå†ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œä¸ºè¿›ç¨‹æè¿°ç¬¦çš„ counter æˆå‘˜èµ‹ä¸€ä¸ªæ–°å€¼ã€‚è€Œè¿™ä¸ªæ“ä½œè¶³ä»¥æŠŠè¯¥ CPU ä¸Šçš„ L1 cache å…¨éƒ¨å¹²æ‰ï¼Œè¿™æ—¶å€™ L1 cache çš„å‘½ä¸­ç‡æ€¥å‰§ä¸‹é™åœ¨åªå‰©æœ€åä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™å¤šä¸ª cpu ä¸­å°±ä¼šæœ‰ cpu å¤„äº idle çŠ¶æ€ï¼Œå‡ºç° cpu ç©ºè½¬é—®é¢˜</p></li><li><p>task bouncing issueï¼š ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªè¿›ç¨‹æœ€å¥½æ˜¯ä»ä¸€è€Œç»ˆï¼Œè¿è¡Œåœ¨ä¸€ä¸ª cpu ä¸Šï¼Œåœ¨ Oï¼ˆnï¼‰è°ƒåº¦å™¨ä¸‹å¾ˆå¤šäººéƒ½åæ˜ æœ‰è¿›ç¨‹åœ¨ CPU ä¹‹é—´è·³æ¥è·³å»çš„ç°è±¡å¯¼è‡´ cache å‘½ä¸­ç‡ä¸‹é™</p></li><li><p>RT è¿›ç¨‹è°ƒåº¦æ€§èƒ½é—®é¢˜ï¼š å®æ—¶è¿›ç¨‹å’Œæ™®é€šè¿›ç¨‹æŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚å½“è°ƒåº¦å®æ—¶è¿›ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦éå†æ•´ä¸ª runqueue åˆ—è¡¨ï¼Œæ‰«æå¹¶è®¡ç®—æ‰€æœ‰è¿›ç¨‹çš„è°ƒåº¦æŒ‡æ•°ï¼Œä»è€Œé€‰æ‹©å‡ºå¿ƒä»ªçš„é‚£ä¸ªå®æ—¶è¿›ç¨‹</p><p>å½“ç„¶ï¼Œä¸Šé¢çš„è¿™äº›è¿˜ä¸æ˜¯å…³é”®ï¼Œæœ€é‡è¦çš„æ˜¯æ•´ä¸ª linux å†…æ ¸ä¸æ˜¯æŠ¢å å¼å†…æ ¸ï¼Œåœ¨æ•´ä¸ªå†…æ ¸æ€éƒ½ä¸èƒ½è¢«æŠ¢å ã€‚é™¤äº†å†…æ ¸æŠ¢å æ€§ä¹‹å¤–ï¼Œä¼˜å…ˆçº§ç¿»è½¬é—®é¢˜ä¹Ÿéœ€è¦å¼•èµ·è°ƒåº¦å™¨çš„é‡è§†ï¼Œå¦åˆ™å³ä¾¿ä¸€ä¸ª rt è¿›ç¨‹å˜æˆ runnable çŠ¶æ€äº†ï¼Œä½†æ˜¯ä¹Ÿåªèƒ½çœ¼çççš„çœ‹ç€æ¯”å®ƒä¼˜å…ˆçº§ä½çš„è¿›ç¨‹è¿è¡Œï¼Œç›´åˆ°è¯¥ rt è¿›ç¨‹ç­‰å¾…çš„èµ„æºè¢«é‡Šæ”¾ã€‚</p></li><li><p>äº¤äº’å¼æ™®é€šè¿›ç¨‹çš„è°ƒåº¦å»¶è¿Ÿé—®é¢˜ï¼š Oï¼ˆnï¼‰å¹¶ä¸åŒºåˆ†äº¤äº’å¼è¿›ç¨‹å’Œæ‰¹å¤„ç†è¿›ç¨‹ï¼Œå®ƒåªæ˜¯å¥–åŠ±ç»å¸¸ç¡çœ çš„é‚£äº›è¿›ç¨‹</p></li><li><p>æ—¶é—´ç‰‡ç²’åº¦é—®é¢˜ï¼š éšç€ runnable è¿›ç¨‹å¢å¤§ï¼Œè°ƒåº¦å‘¨æœŸä¹Ÿå˜å¤§ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è€—å°½å…¶æ—¶é—´ç‰‡ä¹‹åï¼Œåªèƒ½ç­‰å¾…ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸåˆ°æ¥ã€‚å› æ­¤éšç€è°ƒåº¦å‘¨æœŸå˜å¤§ï¼Œç³»ç»Ÿå“åº”ä¹Ÿä¼šå˜çš„è¾ƒå·®</p></li></ul><p>è™½ç„¶ Oï¼ˆnï¼‰è°ƒåº¦å™¨å­˜åœ¨ä¸å°‘çš„ issueï¼Œä½†æ˜¯ç¤¾åŒºçš„äººè¿˜æ˜¯åŸºæœ¬è®¤å¯è¿™å¥—ç®—æ³•çš„ï¼ŒOï¼ˆ1ï¼‰åŸºäº Oï¼ˆnï¼‰è°ƒåº¦å™¨è¿›è¡Œæ”¹è¿›ã€‚é‰´äº Oï¼ˆ1ï¼‰è°ƒåº¦å™¨å’Œ Oï¼ˆnï¼‰è°ƒåº¦å™¨æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œå› æ­¤æˆ‘ä»¬åªæ˜¯æè¿°å®ƒä»¬ä¹‹é—´ä¸åŒçš„åœ°æ–¹ã€‚</p><h2 id="o1è°ƒåº¦å™¨çš„è½¯ä»¶åŠŸèƒ½åˆ’åˆ†">Oï¼ˆ1ï¼‰è°ƒåº¦å™¨çš„è½¯ä»¶åŠŸèƒ½åˆ’åˆ†</h2><p>ä¸‹å›¾æ˜¯ä¸€ä¸ª Oï¼ˆ1ï¼‰è°ƒåº¦å™¨çš„è½¯ä»¶æ¡†æ¶ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/O1_sched.png"></p><p>Oï¼ˆnï¼‰è°ƒåº¦å™¨ä¸­åªæœ‰ä¸€ä¸ªå…¨å±€çš„ runqueueï¼Œä¸¥é‡å½±å“äº†æ‰©å±•æ€§ï¼Œå› æ­¤åœ¨ Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ä¸­å¼•å…¥äº† per-CPU runqueue çš„æ¦‚å¿µã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„å¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹é¦–å…ˆç»è¿‡è´Ÿè½½å‡è¡¡æ¨¡å—æŒ‚å…¥å„ä¸ª CPU çš„ runqueueï¼Œç„¶åç”±ä¸»è°ƒåº¦å™¨å’Œ tick è°ƒåº¦å™¨é©±åŠ¨è¯¥ CPU ä¸Šçš„è°ƒåº¦è¡Œä¸ºã€‚</p><p>ç”±äºå¼•å…¥äº† per-CPU runqueueï¼ŒOï¼ˆ1ï¼‰è°ƒåº¦å™¨åˆ é™¤äº†å…¨å±€ runqueue çš„ spin lockï¼Œè€Œæ˜¯æŠŠè¿™ä¸ª spin lock æ”¾å…¥åˆ° per-CPU runqueue æ•°æ®ç»“æ„ä¸­ï¼ˆrq-&gt;lockï¼‰ï¼Œé€šè¿‡æŠŠä¸€ä¸ªå¤§é”ç»†åˆ†æˆå°é”ï¼Œå¯ä»¥å¤§å¤§é™ä½è°ƒåº¦å»¶è¿Ÿï¼Œæå‡ç³»ç»Ÿå“åº”æ—¶é—´ã€‚è¿™ç§æ–¹æ³•åœ¨å†…æ ¸ä¸­ç»å¸¸ä½¿ç”¨ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ã€‚</p><p>é€šè¿‡ä¸Šé¢çš„è½¯ä»¶ç»“æ„åˆ’åˆ†å¯ä»¥è§£å†³ Oï¼ˆnï¼‰è°ƒåº¦çš„ SMP æ‰©å±•æ€§é—®é¢˜å’Œ CPU ç©ºè½¬é—®é¢˜ã€‚æ­¤å¤–ï¼Œå¥½çš„å¤æ‚å‡è¡¡ç®—æ³•ä¹Ÿå¯ä»¥è§£å†³ Oï¼ˆnï¼‰è°ƒåº¦å™¨çš„ task bouncing é—®é¢˜ã€‚</p><h2 id="o1è°ƒåº¦å™¨çš„-runqueue-ç»“æ„">Oï¼ˆ1ï¼‰è°ƒåº¦å™¨çš„ runqueue ç»“æ„</h2><p>Oï¼ˆ1ï¼‰è°ƒåº¦å™¨çš„åŸºæœ¬ä¼˜åŒ–æ€è·¯å°±æ˜¯æŠŠåŸæ¥ runqueue ä¸Šçš„å•é“¾è¡¨å˜æˆå¤šä¸ªé“¾è¡¨ï¼Œå³æ¯ä¸€ä¸ªä¼˜å…ˆçº§çš„è¿›ç¨‹è¢«æŒ‚å…¥ä¸åŒé“¾è¡¨ä¸­ã€‚ç›¸å…³çš„è½¯ä»¶ç»“æ„å¯ä»¥å‚è€ƒä¸‹é¢çš„å›¾ç‰‡ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/O1_runqueue.png"></p><p>åœ¨è°ƒåº¦å™¨ä¸­ï¼Œrunqueue æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ€é‡è¦çš„ä½œç”¨æ˜¯ç®¡ç†é‚£äº›å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹ã€‚Oï¼ˆ1ï¼‰è°ƒåº¦å™¨å¼•å…¥äº†ä¼˜å…ˆçº§é˜Ÿåˆ—çš„æ¦‚å¿µæ¥ç®¡ç† taskï¼Œå…·ä½“ç”± struct prio_array æŠ½è±¡ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> {</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nr_active;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> bitmap[BITMAP_SIZE];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>[<span class="title">MAX_PRIO</span>];</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ç”±äºæ”¯æŒ 140 ä¸ªä¼˜å…ˆçº§ï¼Œå› æ­¤ queue æˆå‘˜ä¸­æœ‰ 140 ä¸ªåˆ†åˆ«è¡¨ç¤ºå„ä¸ªä¼˜å…ˆçº§çš„é“¾è¡¨å¤´ï¼Œä¸åŒä¼˜å…ˆçº§çš„è¿›ç¨‹æŒ‚å…¥ä¸åŒçš„é“¾è¡¨ä¸­ã€‚bitmap æ˜¯è¡¨ç¤ºå„ä¸ªä¼˜å…ˆçº§è¿›ç¨‹é“¾è¡¨æ˜¯ç©ºè¿˜æ˜¯éç©ºã€‚ nr_active è¡¨ç¤ºè¿™ä¸ªé˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ª taskã€‚åœ¨è¿™äº›é˜Ÿåˆ—ä¸­ï¼Œ100ï½139 æ˜¯æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå…¶ä»–çš„æ˜¯å®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚å› æ­¤ï¼Œåœ¨ Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ä¸­ï¼ŒRT è¿›ç¨‹å’Œæ™®é€šè¿›ç¨‹è¢«åŒºåˆ†å¼€äº†ï¼Œæ™®é€šè¿›ç¨‹æ ¹æœ¬ä¸ä¼šå½±å“ RT è¿›ç¨‹çš„è°ƒåº¦ã€‚ Runqueue ä¸­æœ‰ä¸¤ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆstruct prio_arrayï¼‰åˆ†åˆ«ç”¨æ¥ç®¡ç† activeï¼ˆå³æ—¶é—´ç‰‡è¿˜æœ‰å‰©ä½™ï¼‰å’Œ expiredï¼ˆæ—¶é—´ç‰‡è€—å°½ï¼‰çš„è¿›ç¨‹ã€‚Runqueue ä¸­æœ‰ä¸¤ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—çš„æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘è¿™ä¸¤ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œactive é˜Ÿåˆ—çš„ task ä¸€ä¸ªä¸ªçš„è€—å°½å…¶æ—¶é—´ç‰‡ï¼ŒæŒ‚å…¥åˆ° expired é˜Ÿåˆ—ã€‚å½“ active é˜Ÿåˆ—çš„ task ä¸ºç©ºçš„æ—¶å€™ï¼Œåˆ‡æ¢ active å’Œ expired é˜Ÿåˆ—ï¼Œå¼€å§‹ä¸€è½®æ–°çš„è°ƒåº¦è¿‡ç¨‹ã€‚</p><p>è™½ç„¶åœ¨ Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ä¸­ task ç»„ç»‡çš„å½¢å¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯å…¶æ ¸å¿ƒæ€æƒ³ä»ç„¶å’Œ Oï¼ˆnï¼‰è°ƒåº¦å™¨ä¸€è‡´çš„ã€‚</p><h2 id="æ ¸å¿ƒè°ƒåº¦ç®—æ³•">æ ¸å¿ƒè°ƒåº¦ç®—æ³•</h2><p>ä¸»è°ƒåº¦å™¨ï¼ˆå°±æ˜¯ schedule å‡½æ•°ï¼‰çš„ä¸»è¦åŠŸèƒ½æ˜¯ä»è¯¥ CPU çš„ runqueue æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è¿›ç¨‹è°ƒåº¦æ‰§è¡Œã€‚å…¶åŸºæœ¬çš„æ€è·¯å°±æ˜¯ä» active ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­å¯»æ‰¾ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idx = sched_find_first_bit(<span class="built_in">array</span>-&gt;bitmap);</span><br><span class="line"><span class="built_in">queue</span> = <span class="built_in">array</span>-&gt;<span class="built_in">queue</span> + idx;</span><br><span class="line">next = list_entry(<span class="built_in">queue</span>-&gt;next, <span class="type">task_t</span>, run_list);</span><br></pre></td></tr></tbody></table></figure><p>é¦–å…ˆåœ¨å½“å‰ active ä¼˜å…ˆçº§é˜Ÿåˆ—çš„ bitmap å¯»æ‰¾ç¬¬ä¸€ä¸ªéç©ºçš„è¿›ç¨‹é“¾è¡¨ï¼Œç„¶åä»è¯¥é“¾è¡¨ä¸­æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æœ€é€‚åˆä¸‹ä¸€ä¸ªè°ƒåº¦æ‰§è¡Œçš„è¿›ç¨‹ã€‚ç”±äºæ²¡æœ‰éå†æ•´ä¸ªé“¾è¡¨çš„æ“ä½œï¼Œå› æ­¤è¿™ä¸ªè°ƒåº¦å™¨çš„ç®—æ³•å¤æ‚åº¦æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä»è€Œè§£å†³äº† Oï¼ˆnï¼‰ç®—æ³•å¤æ‚åº¦çš„ issueã€‚</p><p>å¦‚æœå½“å‰ active ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­â€œç©ºæ— ä¸€äººâ€ï¼ˆnr_active ç­‰äº 0ï¼‰ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±éœ€è¦åˆ‡æ¢ active å’Œ expired ä¼˜å…ˆçº§é˜Ÿåˆ—äº†ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(!<span class="built_in">array</span>-&gt;nr_active)) {</span><br><span class="line">    rq-&gt;active = rq-&gt;expired;</span><br><span class="line">    rq-&gt;expired = <span class="built_in">array</span>;</span><br><span class="line">    <span class="built_in">array</span> = rq-&gt;active;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>åˆ‡æ¢å¾ˆå¿«ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªéå†æ‰€æœ‰è¿›ç¨‹é‡æ–°èµ‹ default æ—¶é—´ç‰‡çš„æ“ä½œï¼ˆå¤§å¤§ç¼©å‡äº† runqueue ä¸´ç•ŒåŒºçš„ sizeï¼‰ã€‚è¿™äº›éƒ½é¿å…äº† Oï¼ˆnï¼‰è°ƒåº¦å™¨å¸¦æ¥çš„ç§ç§é—®é¢˜ï¼Œä»è€Œæé«˜äº†è°ƒåº¦å™¨çš„æ€§èƒ½ã€‚</li><li>å¯¹äº Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ï¼Œæ—¶é—´ç‰‡çš„é‡æ–°èµ‹å€¼æ˜¯åˆ†æ•£å¤„ç†çš„ï¼Œåœ¨å„ä¸ª task è€—å°½å…¶æ—¶é—´ç‰‡ä¹‹åç«‹åˆ»è¿›è¡Œçš„ã€‚è¿™æ ·çš„æ”¹åŠ¨ä¹Ÿä¿®æ­£äº† Oï¼ˆnï¼‰è°ƒåº¦å™¨ä¸€æ¬¡æ€§çš„éå†ç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹ï¼Œé‡æ–°ä¸ºæ—¶é—´ç‰‡èµ‹å€¼çš„è¿‡ç¨‹ã€‚</li><li>Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ä½¿ç”¨éå¸¸å¤æ‚çš„ç®—æ³•æ¥åˆ¤æ–­è¿›ç¨‹çš„ç”¨æˆ·äº¤äº’æŒ‡æ•°ä»¥åŠè¿›ç¨‹æ˜¯å¦æ˜¯äº¤äº’å¼è¿›ç¨‹ï¼Œå®ƒæ€»æ˜¯æ¯”ä»…ä»…è€ƒè™‘ç¡çœ æ—¶é—´çš„ Oï¼ˆnï¼‰è°ƒåº¦å™¨æ€§èƒ½è¦å¥½ã€‚</li><li>Linux å¼•å…¥äº†æŠ¢å å¼å†…æ ¸çš„æ¦‚å¿µï¼ˆCONFIG_PREEMPTï¼‰ï¼Œå¦‚æœæ²¡æœ‰é…ç½®è¯¥é€‰é¡¹ï¼Œé‚£ä¹ˆä¸€åˆ‡å’Œ 2.4 å†…æ ¸ä¿æŒä¸€è‡´ã€‚</li></ul><h3 id="ç•ªå¤–ä¹‹ç•ªå¤–-å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•">ç•ªå¤–ä¹‹ç•ªå¤–-å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•</h3><p>å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯æŠŠè¿›ç¨‹æŒ‰ç…§ä¼˜å…ˆçº§åˆ†æˆå¤šä¸ªé˜Ÿåˆ—ï¼Œç›¸åŒä¼˜å…ˆçº§çš„è¿›ç¨‹åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œç³»ç»Ÿä¸­æœ‰ 5 ä¸ªä¼˜å…ˆçº§ï¼Œæ¯ä¸ªä¼˜å…ˆçº§æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ— 5 çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œé˜Ÿåˆ— 1 çš„ä¼˜å…ˆçº§æœ€ä½ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/MLFQ.png"></p><p>å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•æœ‰å¦‚ä¸‹å‡ æ¡åŸºæœ¬è§„åˆ™ã€‚</p><ul><li>è§„åˆ™ 1ï¼šå¦‚æœè¿›ç¨‹ A çš„ä¼˜å…ˆçº§å¤§äºè¿›ç¨‹ B çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨é€‰æ‹©è¿›ç¨‹ Aã€‚</li><li>è§„åˆ™ 2ï¼šå¦‚æœè¿›ç¨‹ A å’Œè¿›ç¨‹ B çš„ä¼˜å…ˆçº§ä¸€æ ·ï¼Œé‚£ä¹ˆå®ƒä»¬åŒå±ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯ä½¿ç”¨è½®è½¬è°ƒåº¦ç®—æ³•æ¥é€‰æ‹©ã€‚</li><li>è§„åˆ™ 3ï¼šå½“ä¸€ä¸ªæ–°è¿›ç¨‹è¿›å…¥è°ƒåº¦å™¨æ—¶ï¼ŒæŠŠå®ƒæ”¾å…¥ä¼˜å…ˆçº§æœ€é«˜çš„é˜Ÿåˆ—é‡Œã€‚</li><li>è§„åˆ™ 4aï¼šå½“ä¸€ä¸ªè¿›ç¨‹åƒæ»¡æ—¶é—´ç‰‡æ—¶ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ª CPU æ¶ˆè€—å‹çš„è¿›ç¨‹ï¼Œéœ€è¦æŠŠä¼˜å…ˆçº§é™ä¸€çº§ï¼Œä»é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­è¿ç§»åˆ°ä½ä¸€çº§çš„é˜Ÿåˆ—é‡Œã€‚</li><li>è§„åˆ™ 4bï¼šå½“ä¸€ä¸ªè¿›ç¨‹åœ¨æ—¶é—´ç‰‡è¿˜æ²¡æœ‰ç»“æŸä¹‹å‰æ”¾å¼ƒ CPU æ—¶ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ª I/O æ¶ˆè€—å‹çš„è¿›ç¨‹ï¼Œä¼˜å…ˆçº§ä¿æŒä¸å˜ï¼Œç»´æŒåŸæ¥çš„é«˜ä¼˜å…ˆçº§ã€‚</li></ul><blockquote><p>å…¶å®å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•çš„ç²¾é«“åœ¨äºâ€œåé¦ˆâ€äºŒå­—ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒåº¦å™¨å¯ä»¥åŠ¨æ€åœ°ä¿®æ”¹è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿›ç¨‹å¯ä»¥å¤§è‡´åˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ I/O æ¶ˆè€—å‹è¿™ç±»è¿›ç¨‹å¾ˆå°‘ä¼šå®Œå…¨å ç”¨æ—¶é—´ç‰‡ï¼Œé€šå¸¸æƒ…å†µä¸‹åœ¨å‘é€ I/O è¯·æ±‚æˆ–è€…åœ¨ç­‰å¾… I/O è¯·æ±‚ï¼Œæ¯”å¦‚ç­‰å¾…é¼ æ ‡æ“ä½œã€ç­‰å¾…é”®ç›˜è¾“å…¥ç­‰ï¼Œè¿™é‡Œè¿›ç¨‹å’Œç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒå¾ˆç›¸å…³ï¼šå¦ä¸€ç±»æ˜¯ CPU æ¶ˆè€—å‹è¿™ç±»è¿›ç¨‹ä¼šå®Œå…¨å ç”¨æ—¶é—´ç‰‡ï¼Œæ¯”å¦‚è®¡ç®—å¯†é›†å‹çš„åº”ç”¨ç¨‹åºã€æ‰¹å¤„ç†åº”ç”¨ç¨‹åºç­‰ã€‚å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•éœ€è¦åŒºåˆ†è¿›ç¨‹å±äºå“ªç§ç±»å‹ï¼Œç„¶ååšå‡ºä¸åŒçš„åé¦ˆã€‚</p></blockquote><p>å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•çœ‹èµ·æ¥å¾ˆä¸é”™ï¼Œå¯æ˜¯åœ¨å®é™…åº”ç”¨è¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰ä¸å°‘é—®é¢˜çš„ã€‚</p><ul><li>ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯äº§ç”Ÿé¥¥é¥¿ï¼Œå½“ç³»ç»Ÿä¸­æœ‰å¤§é‡çš„ I/O æ¶ˆè€—å‹çš„è¿›ç¨‹æ—¶ï¼Œè¿™äº› I/O æ¶ˆè€—å‹çš„è¿›ç¨‹ä¼šå®Œå…¨å ç”¨ CPUï¼Œå®ƒä»¬çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œé‚£äº› CPU æ¶ˆè€—å‹çš„è¿›ç¨‹å°±å¾—ä¸åˆ° CPU æ—¶é—´ç‰‡ï¼Œäº§ç”Ÿé¥¥é¥¿ã€‚</li><li>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯æœ‰äº›è¿›ç¨‹ä¼šæ¬ºéª—è°ƒåº¦å™¨ã€‚æ¯”å¦‚ï¼Œæœ‰çš„è¿›ç¨‹åœ¨æ—¶é—´ç‰‡å¿«è¦ç»“æŸæ—¶çªç„¶å‘èµ·ä¸€ä¸ª I/O è¯·æ±‚å¹¶ä¸”æ”¾å¼ƒ CPUã€‚</li><li>ç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯ï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œæœ‰å¯èƒ½ä¸€ä¼šå„¿æ˜¯ I/O æ¶ˆè€—å‹çš„ï¼Œä¸€ä¼šå„¿æ˜¯ CPU æ¶ˆè€—å‹çš„ï¼Œæ‰€ä»¥å¾ˆéš¾åˆ¤æ–­ä¸€ä¸ªè¿›ç¨‹ç©¶ç«Ÿæ˜¯å“ªç§ç±»å‹ã€‚</li></ul><p>é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•æå‡ºäº†ä¸€ç§æ”¹è‰¯æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€å®šçš„æ—¶é—´å‘¨æœŸåï¼ŒæŠŠç³»ç»Ÿä¸­çš„å…¨éƒ¨è¿›ç¨‹éƒ½æå‡åˆ°æœ€é«˜ä¼˜å…ˆçº§ï¼Œç›¸å½“äºç³»ç»Ÿä¸­çš„è¿›ç¨‹è¿‡äº†ä¸€æ®µæ—¶é—´åˆé‡æ–°å¼€å§‹ä¸€æ ·ã€‚</p><ul><li>è§„åˆ™ 5ï¼šæ¯éš”æ—¶é—´å‘¨æœŸ S ä¹‹åï¼ŒæŠŠç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹çš„ä¼˜å…ˆçº§éƒ½æåˆ°æœ€é«˜çº§åˆ«ã€‚è§„åˆ™ 5 å¯ä»¥è§£å†³è¿›ç¨‹é¥¥é¥¿çš„é—®é¢˜ï¼Œç„¶è€Œï¼Œå°†æ—¶é—´å‘¨æœŸ S è®¾ç½®ä¸ºå¤šå°‘åˆé€‚å‘¢ï¼Ÿå¦‚æœ S å¤ªé•¿ï¼Œé‚£ä¹ˆ CPU æ¶ˆè€—å‹çš„è¿›ç¨‹ä¼šé¥¥é¥¿ï¼›å¦‚æœ S å¤ªçŸ­ï¼Œé‚£ä¹ˆä¼šå½±å“ç³»ç»Ÿçš„äº¤äº’æ€§ã€‚</li></ul><p>é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œéœ€è¦å¯¹è§„åˆ™ 4 åšä¸€äº›æ”¹è¿›ï¼š</p><ul><li>æ–°çš„è§„åˆ™ 4ï¼šå½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨å®Œæ—¶é—´ç‰‡åï¼Œä¸ç®¡å®ƒæ˜¯å¦åœ¨æ—¶é—´ç‰‡çš„æœ€æœ«å°¾å‘ç”Ÿ I/O è¯·æ±‚ä»è€Œæ”¾å¼ƒ CPUï¼Œéƒ½æŠŠå®ƒçš„ä¼˜å…ˆçº§é™ä¸€çº§ã€‚ç»è¿‡æ”¹è¿›åçš„è§„åˆ™ 4 å¯ä»¥æœ‰æ•ˆåœ°é¿å…è¿›ç¨‹çš„æ¬ºéª—è¡Œä¸ºã€‚</li></ul><p>åœ¨ä»‹ç»å®Œå¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•çš„æ ¸å¿ƒå®ç°åï¼Œåœ¨å®é™…å·¥ç¨‹åº”ç”¨ä¸­è¿˜æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒå’Œè§£å†³ï¼Œå…¶ä¸­ä¸€ä¸ªæœ€éš¾çš„é—®é¢˜æ˜¯å‚æ•°å¦‚ä½•ç¡®å®šå’Œä¼˜åŒ–ã€‚æ¯”å¦‚ï¼Œç³»ç»Ÿéœ€è¦è®¾è®¡å¤šå°‘ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Ÿæ—¶é—´ç‰‡åº”è¯¥è®¾ç½®æˆå¤šå°‘ï¼Ÿè§„åˆ™ 5 ä¸­çš„æ—¶é—´é—´éš” S åˆåº”è¯¥è®¾ç½®æˆå¤šå°‘ï¼Œæ‰èƒ½å®ç°æ—¢ä¸ä¼šè®©è¿›ç¨‹é¥¥é¥¿ï¼Œä¹Ÿä¸ä¼šé™ä½ç³»ç»Ÿçš„äº¤äº’æ€§ï¼Ÿè¿™äº›é—®é¢˜å¾ˆéš¾å›ç­”ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcHJvY2Vzc19tYW5hZ2VtZW50L3NjaGVkdWxlci1oaXN0b3J5Lmh0bWw=">http://www.wowotech.net/process_management/scheduler-history.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆå…­ï¼‰æ€»ç»“</title>
      <link href="/2021/LinuxKernel/LinuxTaskSummery/"/>
      <url>/2021/LinuxKernel/LinuxTaskSummery/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskSummery.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2ZDNiYzYzNzY4OTA3MTA1YTYyZTE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h1><p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç»¼åˆæ¡ˆä¾‹ï¼Œåœ¨ä¸€ä¸ªåŒæ ¸å¤„ç†å™¨çš„ç³»ç»Ÿä¸­ï¼Œåœ¨ Shell ç•Œé¢ä¸‹è¿è¡Œ test ç¨‹åºã€‚CPUO çš„å°±ç»ªé˜Ÿåˆ—ä¸­æœ‰ 4 ä¸ªè¿›ç¨‹ï¼Œè€Œ CPU1 çš„å°±ç»ªç¼“é˜Ÿåˆ—ä¸­æœ‰ 1 ä¸ªè¿›ç¨‹ã€‚test ç¨‹åºå’Œè¿™ 5 ä¸ªè¿›ç¨‹çš„ nice å€¼éƒ½ä¸º 0ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i = O</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line">        i++;</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">return</span> O;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç«™åœ¨ç”¨æˆ·ç©ºé—´çš„è§’åº¦çœ‹é—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ° test ç¨‹åºè¢«è¿è¡Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹ä¸åˆ°æ–°è¿›ç¨‹æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€å®ƒä¼šæ·»åŠ åˆ°å“ªä¸ª CPU é‡Œã€å®ƒæ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œä»¥åŠ CPU0 å’Œ CPU1 ä¹‹é—´å¦‚ä½•åšè´Ÿè½½å‡è¡¡ç­‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/test.png"></p><p>å…¶ä¸­çš„æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ fork() æ¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹</li><li>ä½¿ç”¨ do_fork() åˆ›å»ºæ–°è¿›ç¨‹ï¼š<ul><li>åˆ›å»ºæ–°è¿›ç¨‹çš„ task_struct æ•°æ®ç»“æ„</li><li>å¤åˆ¶çˆ¶è¿›ç¨‹çš„ task_struct æ•°æ®ç»“æ„åˆ°æ–°è¿›ç¨‹</li><li>å¤åˆ¶çˆ¶è¿›ç¨‹ç›¸å…³çš„é¡µè¡¨é¡¹åˆ°æ–°è¿›ç¨‹</li><li>è®¾ç½®æ–°è¿›ç¨‹çš„å†…æ ¸æ ˆ</li></ul></li><li>çˆ¶è¿›ç¨‹è°ƒç”¨ wake_up_new_task() å°è¯•å»å”¤é†’æ–°è¿›ç¨‹ï¼š<ul><li>è°ƒç”¨è°ƒåº¦ç±»çš„ select_taskirq()ï¼Œä¸ºæ–°è¿›ç¨‹å¯»æ‰¾ä¸€ä¸ªè´Ÿè½½æœ€è½»çš„ CPUï¼Œè¿™é‡Œé€‰æ‹© CPU1</li><li>è°ƒç”¨è°ƒåº¦ç±»çš„ enqueue_task() æŠŠæ–°è¿›ç¨‹æ·»åŠ åˆ° CPU1 çš„å°±ç»ªé˜Ÿåˆ—é‡Œ</li></ul></li><li>CPU1 é‡æ–°é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è¿›ç¨‹æ¥è¿è¡Œï¼š<ul><li>æ¯æ¬¡æ—¶é’ŸèŠ‚æ‹åˆ°æ¥æ—¶ï¼Œscheduler_tick() ä¼šè°ƒç”¨è°ƒåº¦ç±»çš„ task_tick() æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è°ƒåº¦ã€‚check_preempt_tick() ä¼šåšæ£€æŸ¥ï¼Œå½“éœ€è¦é‡æ–°è°ƒåº¦æ—¶ä¼šè®¾ç½®å½“å‰è¿›ç¨‹çš„ thread_info ä¸­çš„ TIF_NEED_RESCHED æ ‡å¿—ä½ã€‚å‡è®¾è¿™æ—¶ CPU1 å‡†å¤‡è°ƒåº¦æ–°è¿›ç¨‹ï¼Œå°±ä¼šè®¾ç½®å½“å‰è¿›ç¨‹çš„ thread_info ä¸­çš„ TIF_NEED_RESCHED æ ‡å¿—ä½</li><li>åœ¨ä¸­æ–­è¿”å›å‰ä¼šæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚å¦‚æœéœ€è¦è°ƒåº¦ï¼Œè°ƒç”¨ preempt_schedule_irq() æ¥åˆ‡æ¢è¿›ç¨‹è¿è¡Œ</li><li>è°ƒåº¦å™¨çš„ schedule() å‡½æ•°ä¼šè°ƒç”¨è°ƒåº¦ç±»çš„ pick_next_task() æ¥é€‰æ‹©ä¸‹ä¸€ä¸ªæœ€åˆé€‚è¿è¡Œçš„è¿›ç¨‹ã€‚åœ¨è¯¥åœºæ™¯ä¸­ï¼Œé€‰æ‹©æ–°è¿›ç¨‹</li><li>switch_mm() åˆ‡æ¢çˆ¶è¿›ç¨‹å’Œæ–°è¿›ç¨‹çš„é¡µè¡¨</li><li>åœ¨ CPU1 ä¸Šï¼Œswitch_to() åˆ‡æ¢æ–°è¿›ç¨‹æ¥è¿è¡Œ</li></ul></li><li>è¿è¡Œæ–°è¿›ç¨‹ï¼š<ul><li>æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¼šè°ƒç”¨ ret_from_fork() å‡½æ•°</li><li>è¿”å›ç”¨æˆ·ç©ºé—´è¿è¡Œ Shell ç¨‹åº</li><li>Shell ç¨‹åºè°ƒç”¨ exec() æ¥è¿è¡Œ test ç¨‹åºï¼Œæœ€ç»ˆæ–°è¿›ç¨‹å˜æˆäº† test è¿›ç¨‹</li></ul></li><li>å®ç°è´Ÿè½½å‡è¡¡ï¼š<ul><li>åœ¨æ¯ä¸ªæ—¶é’ŸèŠ‚æ‹åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘è½¯ä¸­æ–­æ¥å®ç° SMP è´Ÿè½½å‡è¡¡ï¼Œå³è°ƒç”¨ scheduler_tick()-&gt; trigger_load_balance()ã€‚ä¸‹ä¸€æ¬¡å®ç°è´Ÿè½½å‡è¡¡çš„æ—¶é—´ç‚¹å­˜æ”¾åœ¨å°±ç»ªé˜Ÿåˆ—çš„ next_balance æˆå‘˜é‡Œã€‚</li><li>è§¦å‘ SCHED_SOFTIRQ è½¯ä¸­æ–­</li><li>åœ¨è½¯ä¸­æ–­å¤„ç†å‡½æ•° run_rebalance_domains() é‡Œï¼Œä»å½“å‰ CPU å¼€å§‹éå† CPU æ‹“æ‰‘å…³ç³»ï¼Œä»è°ƒåº¦åŸŸçš„ä½å±‚å¾€é«˜å±‚éå†è°ƒåº¦åŸŸï¼Œå¹¶å¯»æ‰¾æœ‰è´Ÿè½½ä¸å‡åŒ€çš„è°ƒåº¦ç»„ã€‚æœ¬ä¾‹å­ä¸­çš„ CPU æ‹“æ‰‘å…³ç³»å¾ˆç®€å•ï¼Œåªæœ‰ä¸€å±‚ MC å±‚çº§çš„è°ƒåº¦åŸŸ</li><li>CPU0 å¯¹åº”çš„è°ƒåº¦åŸŸæ˜¯ domain_mc_0ï¼Œå¯¹åº”çš„è°ƒåº¦ç»„æ˜¯ group_mc_0ï¼›CPU1 å¯¹åº”çš„è°ƒåº¦åŸŸæ˜¯ domain_mc_1ï¼Œå¯¹åº”çš„è°ƒåº¦ç»„æ˜¯ group_mc_1ã€‚CPU0 çš„è°ƒåº¦åŸŸ domain_mc_0 ç®¡è¾– CPU0 å’Œ CPU1ï¼Œå…¶ä¸­ group_mc_0 å’Œ group_mc_1 è¿™ä¸¤ä¸ªè°ƒåº¦ç»„ä¼šè¢«é“¾æ¥åˆ° domain_mc_0 çš„ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚åŒç†ï¼ŒCPU1 çš„è°ƒåº¦åŸŸ domain_mc_1 ç®¡ç†ç€ group_mc_1 å’Œ group_mc_0 è¿™ä¸¤ä¸ªè°ƒåº¦ç»„</li><li>å‡è®¾å½“å‰è¿è¡Œçš„ CPU æ˜¯ CPU1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿è¡Œ run_rebalance_domains() å‡½æ•°çš„ CPU ä¸º CPU1ï¼Œé‚£ä¹ˆåœ¨å½“å‰ MC çš„è°ƒåº¦åŸŸï¼ˆdomain_mc_1ï¼‰é‡Œæ‰¾å“ªä¸ªè°ƒåº¦ç»„æ˜¯æœ€ç¹å¿™çš„ã€‚å¾ˆå®¹æ˜“å‘ç° CPU0 çš„è°ƒåº¦ç»„ï¼ˆgroup_mc_0ï¼‰æ˜¯æœ€ç¹å¿™çš„ï¼Œç„¶åè®¡ç®—éœ€è¦è¿ç§»å¤šå°‘è´Ÿè½½åˆ° CPU1 ä¸Šæ‰èƒ½ä¿æŒä¸¤ä¸ªè°ƒåº¦ç»„è´Ÿè½½å¹³è¡¡</li><li>ä» CPU0 è¿ç§»éƒ¨åˆ†è¿›ç¨‹åˆ° CPU1</li></ul></li></ul><h1 id="è°ƒåº¦çš„æµç¨‹">è°ƒåº¦çš„æµç¨‹</h1><p>å‡è®¾ Linux å†…æ ¸åªæœ‰ 3 ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ 0 åˆ›å»ºäº†çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2ï¼Œå®ƒä»¬æ°¸è¿œä¸ä¼šé€€å‡ºã€‚å½“ç³»ç»Ÿæ—¶é’Ÿä¸­æ–­åˆ°æ¥æ—¶ï¼Œæ—¶é’Ÿä¸­æ–­å¤„ç†å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹éœ€è¦è°ƒåº¦ã€‚å½“æœ‰è¿›ç¨‹éœ€è¦è°ƒåº¦æ—¶ï¼Œè°ƒåº¦å™¨ä¼šé€‰æ‹©è¿è¡Œçº¿ç¨‹ 1 æˆ–è€…çº¿ç¨‹ 2ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/thread_example.png"></p><p>å‡è®¾çº¿ç¨‹ 0 å…ˆè¿è¡Œï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ è¿™æ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œæ¶‰åŠè°ƒåº¦å™¨çš„å®ç°æœºåˆ¶ã€ä¸­æ–­å¤„ç†ã€å†…æ ¸æŠ¢å ã€æ–°å»ºè¿›ç¨‹å¦‚ä½•è¢«è°ƒåº¦ã€è¿›ç¨‹åˆ‡æ¢ç­‰çŸ¥è¯†ç‚¹ã€‚æˆ‘ä»¬åªæœ‰æŠŠè¿™äº›çŸ¥è¯†ç‚¹éƒ½å¼„æ˜ç™½äº†ï¼Œæ‰èƒ½çœŸæ­£ææ˜ç™½è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="åœºæ™¯åˆ†æ">åœºæ™¯åˆ†æ</h2><p>è¿™ä¸ªåœºæ™¯ä¸­çš„ä¸»è¦æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>start_kernel() è¿è¡Œåœ¨çº¿ç¨‹ 0 é‡Œã€‚çº¿ç¨‹ 0 åˆ›å»ºäº†çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2ã€‚å‡½æ•°è°ƒç”¨å…³ç³»æ˜¯ start_kernel()-&gt;kerne_thread()-&gt;_do_fork()ã€‚åœ¨_do_fortk() å‡½æ•°ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¹¶ä¸”æŠŠæ–°çº¿ç¨‹æ·»åŠ åˆ°è°ƒåº¦å™¨çš„å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚çº¿ç¨‹ 0 åˆ›å»ºçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 åï¼Œè¿›å…¥ while æ­»å¾ªç¯ï¼Œçº¿ç¨‹ 0 ä¸ä¼šé€€å‡ºï¼Œå®ƒæ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦å‡ºå»</li><li>äº§ç”Ÿæ—¶é’Ÿä¸­æ–­ã€‚æ—¶é’Ÿä¸­æ–­æ˜¯æ™®é€šå¤–è®¾ä¸­æ–­çš„ä¸€ç§ï¼Œè°ƒåº¦å™¨åˆ©ç”¨æ—¶é’Ÿä¸­æ–­æ¥å®šæ—¶æ£€æµ‹å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦</li><li>å½“æ—¶é’Ÿä¸­æ–­æ£€æµ‹åˆ°å½“å‰çº¿ç¨‹éœ€è¦è°ƒåº¦æ—¶ï¼Œè®¾ç½® need_resched æ ‡å¿—ä½</li><li>å½“æ—¶é’Ÿä¸­æ–­è¿”å›æ—¶ï¼Œæ ¹æ® Linux å†…æ ¸æ˜¯å¦æ”¯æŒå†…æ ¸æŠ¢å æ¥ç¡®å®šæ˜¯å¦éœ€è¦è°ƒåº¦ï¼Œä¸‹é¢åˆ†ä¸¤ç§æƒ…å†µæ¥è®¨è®º<ul><li>æ”¯æŒå†…æ ¸æŠ¢å çš„å†…æ ¸ï¼šå‘ç”Ÿåœ¨å†…æ ¸æ€çš„ä¸­æ–­è¿”å›æ—¶ï¼Œæ£€æŸ¥å½“å‰çº¿ç¨‹çš„ need_resched æ ‡å¿—ä½æ˜¯å¦ç½®ä½ï¼Œå¦‚æœç½®ä½ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹éœ€è¦è°ƒåº¦</li><li>ä¸æ”¯æŒå†…æ ¸æŠ¢å çš„å†…æ ¸ï¼šå‘ç”Ÿåœ¨å†…æ ¸æ€çš„ä¸­æ–­åœ¨è¿”å›æ—¶ä¸ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒåº¦</li></ul></li></ul><p>åœ¨ä¸æ”¯æŒå†…æ ¸æŠ¢å åŠŸèƒ½çš„ Linux å†…æ ¸é‡Œï¼Œå³ä½¿çº¿ç¨‹ 0 çš„ need_resched æ ‡å¿—ä½ç½®ä½ç½®ä½äº†ï¼ŒLinux å†…æ ¸ä¹Ÿä¸ä¼šè°ƒåº¦çº¿ç¨‹ 1 æˆ–è€…çº¿ç¨‹ 2ã€‚åªæœ‰å‘ç”Ÿåœ¨ç”¨æˆ·æ€çš„ä¸­æ–­è¿”å›æˆ–è€…ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼Œæ‰ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚åœ¨ä¸æ”¯æŒæŠ¢å çš„ Linux å†…æ ¸ä¸­ï¼Œåˆ¤æ–­ä¸è°ƒåº¦çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/sched_example1.png"></p><ul><li>å‘ç”Ÿæ—¶é’Ÿä¸­æ–­ã€‚è§¦å‘æ—¶é’Ÿä¸­æ–­æ—¶å½“å‰è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰æœ‰å¯èƒ½åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½åœ¨å†…æ ¸æ€æ‰§è¡Œã€‚å¦‚æœè¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€æ—¶å‘ç”Ÿäº†ä¸­æ–­ï¼Œé‚£ä¹ˆä¼šè¿›å…¥å¼‚å¸¸å‘é‡è¡¨çš„ el0_irq æ±‡ç¼–å‡½æ•°ï¼šå¦‚æœè¿›ç¨‹è¿è¡Œåœ¨å†…æ ¸æ€æ—¶å‘ç”Ÿäº†ä¸­æ–­ï¼Œé‚£ä¹ˆä¼šè¿›å…¥å¼‚å¸¸å‘é‡è¡¨çš„ el1_irq æ±‡ç¼–å‡½æ•°ä¸­ã€‚åœ¨æœ¬åœºæ™¯ä¸­ï¼Œå› ä¸º 3 ä¸ªçº¿ç¨‹éƒ½æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œæ‰€ä»¥æ—¶é’Ÿä¸­æ–­åªèƒ½è·³è½¬åˆ° el1_irq æ±‡ç¼–å‡½æ•°é‡Œã€‚å½“è¿›å…¥ä¸­æ–­æ—¶ CPU ä¼šè‡ªåŠ¨å…³é—­ä¸­æ–­</li><li>åœ¨ el1_irq æ±‡ç¼–å‡½æ•°é‡Œï¼Œé¦–å…ˆä¼šä¿å­˜ä¸­æ–­ç°åœºï¼ˆä¹Ÿç§°ä¸ºä¸­æ–­ä¸Šä¸‹æ–‡ï¼‰åˆ°å½“å‰è¿›ç¨‹çš„æ ˆä¸­ï¼ŒLinux å†…æ ¸ä½¿ç”¨ pt_regs æ•°æ®ç»“æ„æ¥å®ç° pt_regs æ ˆæ¡†ï¼Œç”¨æ¥ä¿å­˜ä¸­æ–­ç°åœº</li><li>ä¸­æ–­å¤„ç†è¿‡ç¨‹åŒ…æ‹¬åˆ‡æ¢åˆ° Linux å†…æ ¸çš„ä¸­æ–­æ ˆã€ç¡¬ä»¶ä¸­æ–­å·çš„æŸ¥è¯¢ã€ä¸­æ–­æœåŠ¡ç¨‹åºçš„å¤„ç†ç­‰</li><li>å½“ç¡®å®šå½“å‰ä¸­æ–­æºæ˜¯æ—¶é’Ÿä¸­æ–­åï¼Œscheduler_tick() å‡½æ•°ä¼šå»æ£€æŸ¥å½“å‰è¿›ç¨‹çš„æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚å¦‚æœéœ€è¦è°ƒåº¦ï¼Œåˆ™è®¾ç½®å½“å‰è¿›ç¨‹çš„ need_resched æ ‡å¿—ä½ï¼ˆthread_info ä¸­çš„ TIF_NEED_RESCHED æ ‡å¿—ä½ï¼‰</li><li>ä¸­æ–­è¿”å›ã€‚è¿™é‡Œéœ€è¦ç»™ä¸­æ–­æ§åˆ¶å™¨è¿”å›ä¸€ä¸ªä¸­æ–­ç»“æŸï¼ˆEnd Of Interruptï¼ŒEOIï¼‰ä¿¡å·</li><li>åœ¨ el1_irq æ±‡ç¼–å‡½æ•°ç›´æ¥æ¢å¤ä¸­æ–­ç°åœºï¼Œè¿™é‡Œä¼šä½¿ç”¨çº¿ç¨‹ 0 çš„ pt_regs æ¥æ¢å¤ä¸­æ–­ç°åœºåœ¨ä¸æ”¯æŒå†…æ ¸æŠ¢å çš„ç³»ç»Ÿé‡Œï¼Œel1_irq æ±‡ç¼–å‡½æ•°ä¸ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚åœ¨ä¸­æ–­è¿”å›æ—¶ï¼ŒCPU æ‰“å¼€ä¸­æ–­ï¼Œç„¶åä»ä¸­æ–­çš„åœ°æ–¹å¼€å§‹ç»§ç»­æ‰§è¡Œè¿›ç¨‹ 0</li></ul><p>åœ¨æ”¯æŒå†…æ ¸æŠ¢å åŠŸèƒ½çš„ Linux å†…æ ¸ä¸­ï¼Œä¸­æ–­è¿”å›æ—¶ä¼šæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦è®¾ç½®äº† need_resched æ ‡å¿—ä½ç½®ä½ã€‚å¦‚æœç½®ä½ï¼Œé‚£ä¹ˆè°ƒç”¨ preempt schedule_irq() å‡½æ•°ä»¥è°ƒåº¦å…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰å¹¶è¿è¡Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨æ”¯æŒå†…æ ¸æŠ¢å çš„ Linux å†…æ ¸ä¸­ï¼Œä¸­æ–­ä¸è°ƒåº¦çš„æµç¨‹å’Œä¸‹å›¾ç•¥æœ‰ä¸ä¸€æ ·ã€‚åœ¨ el1_irq æ±‡ç¼–å‡½æ•°å³å°†è¿”å›ä¸­æ–­ç°åœºæ—¶ï¼Œåˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚å¦‚æœéœ€è¦è°ƒåº¦ï¼Œè°ƒåº¦å™¨ä¼šé€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”è¿›è¡Œè¿›ç¨‹çš„åˆ‡æ¢ã€‚å¦‚æœé€‰æ‹©äº†çº¿ç¨‹ 1ï¼Œåˆ™ä»çº¿ç¨‹ 1 çš„ pt_regs ä¸­æ¢å¤ä¸­æ–­ç°åœºå¹¶æ‰“å¼€ä¸­æ–­ï¼Œç„¶åç»§ç»­æ‰§è¡Œå†…æ ¸çº¿ç¨‹ 1 çš„ä»£ç ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/sched_example2.png"></p><h2 id="å¦‚ä½•è®©æ–°è¿›ç¨‹æ‰§è¡Œ">å¦‚ä½•è®©æ–°è¿›ç¨‹æ‰§è¡Œ</h2><p>å¯èƒ½è¯»è€…ä¼šæœ‰å¦‚ä¸‹ç–‘é—®ï¼š</p><ul><li>å¦‚æœçº¿ç¨‹ 1 æ˜¯æ–°åˆ›å»ºçš„ï¼Œå®ƒçš„æ ˆåº”è¯¥æ˜¯ç©ºçš„ï¼Œé‚£å®ƒç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å¦‚ä½•æ¢å¤ä¸­æ–­ç°åœºå‘¢ï¼Ÿ</li><li>å¦‚æœä¸èƒ½ä»çº¿ç¨‹ 1 çš„æ ˆä¸­æ¢å¤ä¸­æ–­ç°åœºï¼Œé‚£æ˜¯ä¸æ˜¯çº¿ç¨‹ 1 ä¸€ç›´åœ¨å…³é—­ä¸­æ–­çš„çŠ¶æ€ä¸‹è¿è¡Œï¼Ÿ</li></ul><p>å¯¹äºå†…æ ¸çº¿ç¨‹æ¥è¯´ï¼Œåœ¨åˆ›å»ºæ—¶ä¼šå¯¹å¦‚ä¸‹ä¸¤éƒ¨åˆ†å†…å®¹è¿›è¡Œè®¾ç½®ä¸ä¿å­˜ã€‚</p><ul><li>è¿›ç¨‹çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡ã€‚å®ƒæ˜¯ä¿å­˜åœ¨è¿›ç¨‹ä¸­çš„ cpu_context æ•°æ®ç»“æ„ï¼Œè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡åŒ…æ‹¬ X19~X28 å¯„å­˜å™¨ã€FP å¯„å­˜å™¨ã€SP å¯„å­˜å™¨ä»¥åŠ PC å¯„å­˜å™¨ã€‚å¯¹äº ARM64 å¤„ç†å™¨æ¥è¯´ï¼Œè®¾ç½® PC å¯„å­˜å™¨ä¸º ret_from_forkï¼Œå³æŒ‡å‘ ret_from_fork æ±‡ç¼–å‡½æ•°ã€‚è®¾ç½® SP å¯„å­˜å™¨æŒ‡å‘æ ˆçš„ pt_regs æ ˆæ¡†</li><li>ptregs æ ˆæ¡†</li></ul><p>ä¸Šè¿°æ“ä½œæ˜¯åœ¨ copy_thread() å‡½æ•°é‡Œå®ç°çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/kernel/process.c&gt;</span><br><span class="line"><span class="type">int</span> <span class="title function_">copy_thread</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    ...</span><br><span class="line">    childregs-&gt;pstate = PSR_MODE_EL1h;</span><br><span class="line">    p-&gt;thread.cpu_context.x19 = stack_start;</span><br><span class="line">    p-&gt;thread.cpu_context.x20 = stk sz;</span><br><span class="line">    p-&gt;thread.cpu context.pc = (<span class="type">unsigned</span> <span class="type">long</span>)ret_from_fork;</span><br><span class="line">    p-&gt;thread.cpu_context.sp = (<span class="type">unsigned</span> <span class="type">long</span>)childregs;</span><br><span class="line">    ...</span><br></pre></td></tr></tbody></table></figure><p>stack_stat æŒ‡å‘å†…æ ¸çº¿ç¨‹çš„å›è°ƒå‡½æ•°ï¼Œè€Œ x20 æŒ‡å‘å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚ åœ¨è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œswitch_to() å‡½æ•°ä¼šå®Œæˆè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œå³æŠŠä¸‹ä¸€ä¸ªè¿›ç¨‹ (next è¿›ç¨‹ï¼‰çš„ cpu_context æ•°æ®ç»“æ„ä¿å­˜çš„å†…å®¹æ¢å¤åˆ°å¤„ç†å™¨çš„å¯„å­˜å™¨ä¸­ï¼Œä»è€Œå®Œæˆè¿›ç¨‹çš„åˆ‡æ¢ã€‚æ­¤æ—¶ï¼Œå¤„ç†å™¨å¼€å§‹è¿è¡Œ next è¿›ç¨‹äº†ã€‚æ ¹æ® PC å¯„å­˜å™¨çš„å€¼ã€å¤–ç†å™¨ä¼šä» ret_from_fork æ±‡ç¼–å‡½æ•°é‡Œå¼€å§‹æ‰§è¡Œï¼Œæ–°è¿›ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/sched_context.png"></p><p>ret_from_fork æ±‡ç¼–å‡½æ•°å®ç°åœ¨ arch/arm64/kernel/entry.S æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SYM_CODE_START(ret_from_fork)</span><br><span class="line">blschedule_tail</span><br><span class="line">cbzx19, 1f// not a kernel thread</span><br><span class="line">movx0, x20</span><br><span class="line">blrx19</span><br><span class="line">1:get_current_task tsk</span><br><span class="line">movx0, sp</span><br><span class="line">blasm_exit_to_user_mode</span><br><span class="line">bret_to_user</span><br><span class="line">SYM_CODE_END(ret_from_fork)</span><br><span class="line">NOKPROBE(ret_from_fork)</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ç¬¬ 2 è¡Œä¸­ï¼Œè°ƒç”¨ schedule_tail() å‡½æ•°æ¥å¯¹ prev è¿›ç¨‹åšæ”¶å°¾å·¥ä½œã€‚åœ¨ finish_lock_switch() å‡½æ•°é‡Œä¼šè°ƒç”¨ raw_spin_unlock_irq() å‡½æ•°æ¥æ‰“å¼€æœ¬åœ°ä¸­æ–­ã€‚å› æ­¤ï¼Œnext è¿›ç¨‹æ˜¯è¿è¡Œåœ¨æ‰“å¼€ä¸­æ–­çš„ç¯å¢ƒä¸‹çš„ã€‚ åœ¨ç¬¬ 3 è¡Œä¸­ï¼Œåˆ¤æ–­ next çº¿ç¨‹æ˜¯å¦ä¸ºå†…æ ¸çº¿ç¨‹ã€‚å¦‚æœ next è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œåœ¨åˆ›å»ºæ—¶ä¼šè®¾ç½® X19 å¯„å­˜å™¨æŒ‡å‘ stack_startã€‚å¦‚æœ X19 å¯„å­˜å™¨çš„å€¼ä¸º 0ï¼Œè¯´æ˜è¿™ä¸ª next è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œç›´æ¥è·³è½¬åˆ°ç¬¬ 6 è¡Œï¼Œè°ƒç”¨ ret_to_user æ±‡ç¼–å‡½æ•°ï¼Œè¿”å›ç”¨æˆ·ç©ºé—´ åœ¨ç¬¬ 4~5 è¡Œä¸­ï¼Œå¦‚æœ next è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è·³è½¬åˆ°å†…æ ¸çº¿ç¨‹çš„å›è°ƒå‡½æ•°é‡Œã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œå½“å¤„ç†å™¨åˆ‡æ¢åˆ°å†…æ ¸çº¿ç¨‹ 1 æ—¶ï¼Œå®ƒä» ret_from_fork æ±‡ç¼–å‡½æ•°å¼€å§‹æ‰§è¡Œ Schedule_tail() å‡½æ•°ä¼šæ‰“å¼€ä¸­æ–­ï¼Œå› æ­¤ï¼Œä¸ç”¨æ‹…å¿ƒå†…æ ¸çº¿ç¨‹ 1 åœ¨å…³é—­ä¸­æ–­çš„çŠ¶æ€ä¸‹è¿è¡Œã€‚å¦å¤–ï¼Œæ­¤æ—¶ï¼Œçº¿ç¨‹ 1 ä¸ä¼šä»ä¸­æ–­ç°åœºè¿”å›ï¼Œå› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢ï¼Œçº¿ç¨‹ 1 è¿˜æ²¡æœ‰è§¦å‘ä»»ä½•ä¸€ä¸ªä¸­æ–­ã€‚é‚£ä¹ˆå¯¹äºçº¿ç¨‹ 0 è§¦å‘çš„ä¸­æ–­ç°åœºæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿä¸­æ–­ç°åœºä¿å­˜åœ¨ä¸­æ–­è¿›ç¨‹çš„æ ˆé‡Œï¼Œåªæœ‰å½“è°ƒåº¦å™¨å†ã€æ¬¡è°ƒåº¦è¯¥è¿›ç¨‹æ—¶ï¼Œå®ƒæ‰ä¼šä»æ ˆä¸­æ¢å¤ä¸­æ–­ç°åœºï¼Œç„¶åç»§ç»­è¿è¡Œè¯¥è¿›ç¨‹ã€‚</p><h2 id="è°ƒåº¦çš„æœ¬è´¨">è°ƒåº¦çš„æœ¬è´¨</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¸è§çš„æ€è€ƒé¢˜</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raw_local_irq_disable()<span class="comment">//å…³é—­æœ¬åœ°ä¸­æ–­</span></span><br><span class="line">schedule()<span class="comment">//è°ƒç”¨ schedule() å‡½æ•°æ¥åˆ‡æ¢è¿›ç¨‹</span></span><br><span class="line">raw_local_irq_enable() <span class="comment">//æ‰“å¼€æœ¬åœ°ä¸­æ–­</span></span><br></pre></td></tr></tbody></table></figure><p>æœ‰è¯»è€…è¿™ä¹ˆè®¤ä¸ºï¼Œå‡è®¾è¿›ç¨‹ A åœ¨å…³é—­æœ¬åœ°ä¸­æ–­çš„æƒ…å†µä¸‹åˆ‡æ¢åˆ°è¿›ç¨‹ B æ¥è¿è¡Œï¼Œè¿›ç¨‹ B ä¼šåœ¨å…³é—­ä¸­æ–­çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå¦‚æœè¿›ç¨‹ B ä¸€ç›´å ç”¨ CPUï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šä¸€ç›´æ²¡æœ‰åŠæ³•å“åº”æ—¶é’Ÿä¸­æ–­ï¼Œç³»ç»Ÿå°±å¤„äºç˜«ç—ªçŠ¶æ€ã€‚ æ˜¾ç„¶ï¼Œä¸Šè¿°åˆ†ææ˜¯ä¸æ­£ç¡®çš„ã€‚å› ä¸ºè¿›ç¨‹ B åˆ‡æ¢æ‰§è¡Œæ—¶ä¼šæ‰“å¼€æœ¬åœ°ä¸­æ–­ï¼Œä»¥é˜²æ­¢ç³»ç»Ÿç˜«ç—ªæˆ‘ä»¬æ¥ä¸‹æ¥è¯¦ç»†åˆ†æè¿™ä¸ªé—®é¢˜ã€‚ è°ƒåº¦ä¸ä¸­æ–­å¯†ä¸å¯åˆ†ï¼Œè€Œè°ƒåº¦çš„æœ¬è´¨æ˜¯é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œã€‚ç†è§£è°ƒåº¦æœ‰å¦‚ä¸‹å‡ ä¸ªå…³é”®ç‚¹ã€‚</p><ul><li>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘è°ƒåº¦ï¼Ÿ</li><li>å¦‚ä½•åˆç†å’Œé«˜æ•ˆé€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Ÿ</li><li>å¦‚ä½•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œï¼Ÿ</li><li>ä¸‹ä¸€ä¸ªè¿›ç¨‹å¦‚ä½•è¿”å›ä¸Šä¸€æ¬¡æš‚åœçš„åœ°æ–¹ï¼Ÿ</li></ul><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªåœºæ™¯ä¸ºä¾‹ï¼Œå‡è®¾ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ A å’Œä¸€ä¸ªå†…æ ¸çº¿ç¨‹ Bï¼Œåœ¨ä¸è€ƒè™‘è‡ªæ„¿è°ƒåº¦å’Œç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œè¯·æè¿°è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰æ˜¯å¦‚ä½•ç›¸äº’åˆ‡æ¢å¹¶è¿è¡Œçš„ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œç”¨æˆ·è¿›ç¨‹ A åˆ‡æ¢åˆ°å†…æ ¸çº¿ç¨‹ B çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚</p><ul><li>å‡è®¾åœ¨ T0 æ—¶åˆ»ä¹‹å‰ï¼Œç”¨æˆ·è¿›ç¨‹ A æ­£åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œ</li><li>åœ¨ T0 æ—¶åˆ»ï¼Œæ—¶é’Ÿä¸­æ–­å‘ç”Ÿ</li><li>CPU æ‰“æ–­æ­£åœ¨è¿è¡Œçš„ç”¨æˆ·è¿›ç¨‹ Aï¼Œå¤„äºå¼‚å¸¸æ¨¡å¼ã€‚CPU ä¼šè·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨ä¸­çš„ el0_irq é‡Œã€‚åœ¨ el0_irq æ±‡ç¼–å‡½æ•°é‡Œï¼Œé¦–å…ˆæŠŠä¸­æ–­ç°åœºä¿å­˜åˆ°è¿›ç¨‹ A çš„ pt_regs æ ˆæ¡†ä¸­</li><li>å¤„ç†ä¸­æ–­</li><li>è°ƒåº¦æ»´ç­”å¤„ç†å‡½æ•°ã€‚åœ¨è°ƒåº¦æ»´ç­”å¤„ç†ä¸­ï¼Œæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚å¦‚æœéœ€è¦è°ƒåº¦ï¼Œåˆ™è®¾ç½®å½“å‰è¿›ç¨‹çš„ need_resched æ ‡å¿—ä½ï¼ˆthread_info ä¸­çš„ TIF_NEED_RESCHED æ ‡å¿—ä½ï¼‰</li><li>ä¸­æ–­å¤„ç†å®Œæˆä¹‹åï¼Œè¿”å› el0_irq æ±‡ç¼–å‡½æ•°é‡Œã€‚åœ¨å³å°†è¿”å›ä¸­æ–­ç°åœºå‰ï¼Œret_to_user æ±‡ç¼–å‡½æ•°ä¼šæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦</li><li>è‹¥å½“å‰è¿›ç¨‹åºéœ€è¦è°ƒåº¦ï¼Œåˆ™è°ƒç”¨ schedule() å‡½æ•°æ¥é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹å¹¶è¿›è¡Œè¿›ç¨‹åˆ‡æ¢</li><li>åœ¨ switch_to() å‡½æ•°é‡Œè¿›è¡Œè¿›ç¨‹åˆ‡æ¢</li><li>T1 æ—¶åˆ»ï¼Œswitch_to() å‡½æ•°è¿”å›æ—¶ï¼ŒCPU å¼€å§‹è¿è¡Œå†…æ ¸çº¿ç¨‹ B äº†</li><li>CPU æ²¿ç€å†…æ ¸çº¿ç¨‹ B ä¿å­˜çš„æ ˆå¸§å›æº¯ï¼Œä¸€ç›´è¿”å›ã€‚è¿”å›è·¯å¾„ä¸º finish_task_switch()-&gt;el1_preempt()-&gt;el1_irq</li><li>åœ¨ el1_irq æ±‡ç¼–å‡½æ•°é‡ŒæŠŠä¸Šä¸€æ¬¡å‘ç”Ÿä¸­æ–­æ—¶ä¿å­˜åœ¨æ ˆé‡Œçš„ä¸­æ–­ç°åœºè®²è¡Œæ¢å¤ï¼Œæœ€åä»ä¸Šä¸€æ¬¡ä¸­æ–­çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œå†…æ ¸çº¿ç¨‹ B çš„ä»£ç </li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/thread1.png"></p><p>ä»æ ˆå¸§çš„è§’åº¦æ¥è§‚å¯Ÿï¼Œè¿›ç¨‹è°ƒåº¦çš„æ ˆå¸§å˜åŒ–æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/thread1_stk.png"></p><p>é¦–å…ˆï¼Œå¯¹äºç”¨æˆ·è¿›ç¨‹ Aï¼Œä»ä¸­æ–­è§¦å‘åˆ°è¿›ç¨‹åˆ‡æ¢è¿™æ®µæ—¶é—´å†…ï¼Œå†…æ ¸æ ˆçš„å˜åŒ–æƒ…å†µå¦‚å›¾ 9.20 å·¦è¾¹è§†å›¾æ‰€ç¤ºï¼Œæ ˆçš„æœ€é«˜åœ°å€ä½äº pt_regs æ ˆæ¡†ï¼Œç”¨æ¥ä¿å­˜ä¸­æ–­ç°åœºã€‚ ç„¶åï¼Œä¾æ¬¡ä¿å­˜ el0_irq æ±‡ç¼–å‡½æ•°ã€ret_to_user æ±‡ç¼–å‡½æ•°ã€_schedule() å‡½æ•°ã€context_switch() å‡½æ•°ä»¥åŠ switch_to() å‡½æ•°çš„æ ˆå¸§ï¼Œæ­¤æ—¶ SP å¯„å­˜å™¨æŒ‡å‘ switch_to() å‡½æ•°æ ˆå¸§ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå‹æ ˆã€‚ æ¥ä¸‹æ¥ï¼Œåˆ‡æ¢è¿›ç¨‹ã€‚ switch_to() å‡½æ•°è¿”å›ä¹‹åï¼Œå³å®Œæˆäº†è¿›ç¨‹åˆ‡æ¢ã€‚æ­¤æ—¶ï¼ŒCPU çš„ SP å¯„å­˜å™¨æŒ‡å‘äº†å†…æ ¸çº¿ç¨‹ B çš„å†…æ ¸æ ˆä¸­çš„ switch_to() å‡½æ•°æ ˆå¸§ã€‚CPU æ²¿ç€æ ˆå¸§ä¸€ç›´è¿”å›ï¼Œå¹¶ä¸”æ¢å¤äº†ä¸Šä¸€æ¬¡ä¿å­˜åœ¨ pt_regs æ ˆæ¡†çš„ä¸­æ–­ç°åœºï¼Œæœ€åè·³è½¬åˆ°å†…æ ¸çº¿ç¨‹ B ä¸­æ–­çš„åœ°æ–¹å¹¶å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå‡ºæ ˆã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆäº”ï¼‰è¿›ç¨‹è°ƒåº¦çš„è°ƒè¯•</title>
      <link href="/2021/LinuxKernel/LinuxTaskDebug/"/>
      <url>/2021/LinuxKernel/LinuxTaskDebug/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskDebug.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2Y2ZlMzU2NTNiYjA3MWU3MDI5MDM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>Linux å†…æ ¸ä¸ºå¼€å‘è€…æä¾›äº†ä¸°å¯Œçš„è¿›ç¨‹è°ƒåº¦ä¿¡æ¯ï¼Œè¿™äº›è°ƒåº¦ä¿¡æ¯éƒ½éœ€è¦åœ¨å†…æ ¸é…ç½®æ—¶æ‰“å¼€ CONFIG_SCHED_DEBUG é€‰é¡¹ã€‚</p><h1 id="æŸ¥çœ‹ä¸è¿›ç¨‹ç›¸å…³çš„è°ƒåº¦ä¿¡æ¯">æŸ¥çœ‹ä¸è¿›ç¨‹ç›¸å…³çš„è°ƒåº¦ä¿¡æ¯</h1><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æŸ¥çœ‹è¿›ç¨‹ç›¸å…³çš„è°ƒåº¦ä¿¡æ¯ï¼Œå¦‚è¿›ç¨‹çš„ nice å€¼ã€ä¼˜å…ˆçº§ã€è°ƒåº¦ç­–ç•¥ã€vruntime åŠé‡åŒ–è®¡ç®—èƒ½åŠ›ç­‰ä¿¡æ¯ã€‚åœ¨ Linux çš„ proc ç›®å½•ä¸­ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«äº†ä¸è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vooxle@liushuai:~<span class="comment"># cat /proc/1/sched</span></span><br></pre></td></tr></tbody></table></figure><p>å¾—åˆ°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">systemd (1, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :    5438471989.820758</span><br><span class="line">se.vruntime                                  :          3446.301246</span><br><span class="line">se.sum_exec_runtime                          :         66272.041453</span><br><span class="line">se.nr_migrations                             :                 4998</span><br><span class="line">nr_switches                                  :               172620</span><br><span class="line">nr_voluntary_switches                        :               169241</span><br><span class="line">nr_involuntary_switches                      :                 3379</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  172</span><br><span class="line">se.avg.runnable_load_sum                     :                  172</span><br><span class="line">se.avg.util_sum                              :               176128</span><br><span class="line">se.avg.load_avg                              :                    0</span><br><span class="line">se.avg.runnable_load_avg                     :                    0</span><br><span class="line">se.avg.util_avg                              :                    0</span><br><span class="line">se.avg.last_update_time                      :     5438471989820416</span><br><span class="line">se.avg.util_est.ewma                         :                   10</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                  103</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                    0</span><br><span class="line">total_numa_faults                            :                  806</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=734 task_shared=72 group_private=0 group_shared=0</span><br><span class="line">numa_faults node=1 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢å°±æ˜¯ ID ä¸º 1 çš„è¿›ç¨‹çš„ proc ç›®å½•ï¼Œåœ¨è¿›ç¨‹ proc ç›®å½•é‡Œï¼Œçœ‹åˆ°å’Œè¿›ç¨‹è°ƒåº¦ç›¸å…³çš„èŠ‚ç‚¹ä¸º schedï¼Œè¯»è€…å¯ä»¥ä½¿ç”¨ cat å‘½ä»¤æ¥è¯»å–è¿™ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ˜¯åœ¨ proc_sched_show_task() å‡½æ•°ä¸­è¾“å‡ºçš„ï¼Œè¯¥å‡½æ•°å®ç°åœ¨ kerel/sched/debug.c æ–‡ä»¶ä¸­ã€‚è¿™äº›ä¿¡æ¯å¦‚ä¸‹ï¼š</p><ul><li>è¿›ç¨‹çš„åç§°ä¸º systemdï¼ŒID æ˜¯ 1ï¼Œçº¿ç¨‹æœ‰ 1 ä¸ª</li><li>è¿›ç¨‹çš„ä¼˜å…ˆçº§ä¸º 120</li><li>è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯ SCHED_NORMALï¼Œä½¿ç”¨çš„è°ƒåº¦ç±»æ˜¯ CFS è°ƒåº¦ç±»ï¼ˆfair_sched_classï¼‰</li><li>å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿæ—¶é—´ï¼ˆvruntimeï¼‰æ˜¯ 3446.301246msã€‚æ€»è¿è¡Œæ—¶é—´ä¸º 66272.041453ms</li><li>è¿›ç¨‹å‘ç”Ÿè¿‡ 4998 æ¬¡è¿ç§»ï¼Œ172620 æ¬¡è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå…¶ä¸­ä¸»åŠ¨è°ƒåº¦æœ‰ 169241 æ¬¡ï¼Œè¢«æŠ¢å è°ƒåº¦æœ‰ 3379&nbsp;æ¬¡</li><li>è¿›ç¨‹çš„æƒé‡ se.load.weight å’Œ se.runnable.weight ç›¸ç­‰ï¼Œéƒ½æ˜¯ 1048576ã€‚æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå€¼å‡ä¸ºåŸæœ¬çš„æƒé‡å€¼ä¹˜ä»¥ 1024ã€‚è¿›ç¨‹ä¼˜å…ˆçº§ä¸º 120ï¼Œnice å€¼ä¸º 0ï¼Œå®ƒåŸæœ¬çš„æƒé‡å€¼ä¸º 1024</li><li>å½“å‰æ—¶åˆ»ï¼Œè¿›ç¨‹çš„ se.avg.load_sum å€¼å’Œ se.avg.runnable_load_sum ç›¸ç­‰ï¼Œéƒ½æ˜¯ 172</li><li>è¿›ç¨‹çš„ se.ave.load_avg å’Œ se.avg.runnable_load_avg æ˜¯ç›¸ç­‰çš„éƒ½æ˜¯ 0ã€‚å¯¹äºè¯¥è¿›å’Œæ¥è¯´ï¼Œå®ƒçš„é‡åŒ–è´Ÿè½½çš„æœ€å¤§å€¼å°±ç­‰äºå®ƒçš„æƒé‡å€¼ï¼Œå³ 1024ï¼Œè¿™æ˜¯åœ¨ 100%å ç”¨ CPU çš„æƒ…å†µä¸‹å¾—åˆ°çš„</li><li>è¿›ç¨‹çš„é‡åŒ–è®¡ç®—èƒ½åŠ›ï¼ˆse.avg.util_avgï¼‰ä¸º 0</li></ul><p>Linux å†…æ ¸è¿˜æä¾›ä¸€ä¸ªä¸è°ƒåº¦ä¿¡æ¯ç›¸å…³çš„æ•°æ®ç»“æ„ sched_statisticsï¼Œå…¶ä¸­åŒ…å«äº†éå¸¸å¤šå’Œè°ƒåº¦ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¦æŸ¥çœ‹è¿™äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œéœ€è¦æ‰“å¼€ CONFIG_SCHEDSTATS é…ç½®é€‰é¡¹ã€‚å¦å¤–ï¼Œè¿˜éœ€è¦æ‰“å¼€ sched_schedstats èŠ‚ç‚¹ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/sched_schedstats</span><br></pre></td></tr></tbody></table></figure><p>é‡æ–°æŸ¥çœ‹ ID ä¸º 1 çš„è¿›ç¨‹è°ƒåº¦ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°é‡Œé¢å¤šäº†å¾ˆå¤šç»Ÿè®¡ä¿¡æ¯</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/proc/1<span class="comment"># cat sched</span></span><br><span class="line">systemd (1, <span class="comment">#threads: 1)</span></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">se.exec_start                                :    5439456327.802850</span><br><span class="line">se.vruntime                                  :          3452.764216</span><br><span class="line">se.sum_exec_runtime                          :         66278.504423</span><br><span class="line">se.nr_migrations                             :                 4998</span><br><span class="line">se.statistics.sum_sleep_runtime              :             0.000000</span><br><span class="line">se.statistics.wait_start                     :             0.000000</span><br><span class="line">se.statistics.sleep_start                    :             0.000000</span><br><span class="line">se.statistics.block_start                    :             0.000000</span><br><span class="line">se.statistics.sleep_max                      :             0.000000</span><br><span class="line">se.statistics.block_max                      :             0.000000</span><br><span class="line">se.statistics.exec_max                       :             0.000000</span><br><span class="line">se.statistics.slice_max                      :             0.000000</span><br><span class="line">se.statistics.wait_max                       :             0.000000</span><br><span class="line">se.statistics.wait_sum                       :             0.000000</span><br><span class="line">se.statistics.wait_count                     :                    0</span><br><span class="line">se.statistics.iowait_sum                     :             0.000000</span><br><span class="line">se.statistics.iowait_count                   :                    0</span><br><span class="line">se.statistics.nr_migrations_cold             :                    0</span><br><span class="line">se.statistics.nr_failed_migrations_affine    :                    0</span><br><span class="line">se.statistics.nr_failed_migrations_running   :                    0</span><br><span class="line">se.statistics.nr_failed_migrations_hot       :                    0</span><br><span class="line">se.statistics.nr_forced_migrations           :                    0</span><br><span class="line">se.statistics.nr_wakeups                     :                    0</span><br><span class="line">se.statistics.nr_wakeups_sync                :                    0</span><br><span class="line">se.statistics.nr_wakeups_migrate             :                    0</span><br><span class="line">se.statistics.nr_wakeups_local               :                    0</span><br><span class="line">se.statistics.nr_wakeups_remote              :                    0</span><br><span class="line">se.statistics.nr_wakeups_affine              :                    0</span><br><span class="line">se.statistics.nr_wakeups_affine_attempts     :                    0</span><br><span class="line">se.statistics.nr_wakeups_passive             :                    0</span><br><span class="line">se.statistics.nr_wakeups_idle                :                    0</span><br><span class="line">avg_atom                                     :             0.383900</span><br><span class="line">avg_per_cpu                                  :            13.261005</span><br><span class="line">nr_switches                                  :               172645</span><br><span class="line">nr_voluntary_switches                        :               169266</span><br><span class="line">nr_involuntary_switches                      :                 3379</span><br><span class="line">se.load.weight                               :              1048576</span><br><span class="line">se.runnable_weight                           :              1048576</span><br><span class="line">se.avg.load_sum                              :                  286</span><br><span class="line">se.avg.runnable_load_sum                     :                  286</span><br><span class="line">se.avg.util_sum                              :               293807</span><br><span class="line">se.avg.load_avg                              :                    6</span><br><span class="line">se.avg.runnable_load_avg                     :                    6</span><br><span class="line">se.avg.util_avg                              :                    6</span><br><span class="line">se.avg.last_update_time                      :     5439456327801856</span><br><span class="line">se.avg.util_est.ewma                         :                   10</span><br><span class="line">se.avg.util_est.enqueued                     :                    0</span><br><span class="line">policy                                       :                    0</span><br><span class="line">prio                                         :                  120</span><br><span class="line">clock-delta                                  :                   56</span><br><span class="line">mm-&gt;numa_scan_seq                            :                    0</span><br><span class="line">numa_pages_migrated                          :                    0</span><br><span class="line">numa_preferred_nid                           :                    0</span><br><span class="line">total_numa_faults                            :                  806</span><br><span class="line">current_node=0, numa_group_id=0</span><br><span class="line">numa_faults node=0 task_private=734 task_shared=72 group_private=0 group_shared=0</span><br><span class="line">numa_faults node=1 task_private=0 task_shared=0 group_private=0 group_shared=0</span><br></pre></td></tr></tbody></table></figure><h1 id="æŸ¥çœ‹-cfs-çš„ä¿¡æ¯">æŸ¥çœ‹ CFS çš„ä¿¡æ¯</h1><p>Linux å†…æ ¸åœ¨è°ƒåº¦æ–¹é¢å®ç°äº†ä¸€äº›è°ƒè¯•æ¥å£ï¼Œä¸ºå¼€å‘è€…æä¾›çª¥æ¢è°ƒåº¦å™¨å†…éƒ¨ä¿¡æ¯çš„æ¥å£ã€‚ åœ¨ proc ç›®å½•ä¸‹é¢æœ‰ä¸€ä¸ª sched_debug èŠ‚ç‚¹ï¼Œå…¶ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@liushuai:/proc<span class="comment"># cat sched_debug</span></span><br><span class="line">Sched Debug Version: v0.11, 5.4.0-81-generic <span class="comment">#91-Ubuntu</span></span><br><span class="line">ktime                                   : 5439613876.757507</span><br><span class="line">sched_clk                               : 5439566740.450647</span><br><span class="line">cpu_clk                                 : 5439566596.040965</span><br><span class="line">jiffies                                 : 5654795694</span><br><span class="line">sched_clock_stable()                    : 1</span><br><span class="line"></span><br><span class="line">sysctl_sched</span><br><span class="line">  .sysctl_sched_latency                    : 24.000000</span><br><span class="line">  .sysctl_sched_min_granularity            : 3.000000</span><br><span class="line">  .sysctl_sched_wakeup_granularity         : 4.000000</span><br><span class="line">  .sysctl_sched_child_runs_first           : 0</span><br><span class="line">  .sysctl_sched_features                   : 2059067</span><br><span class="line">  .sysctl_sched_tunable_scaling            : 1 (logarithmic)</span><br><span class="line">...</span><br><span class="line">rt_rq[0]:</span><br><span class="line">  .rt_nr_running                 : 0</span><br><span class="line">  .rt_nr_migratory               : 0</span><br><span class="line">  .rt_throttled                  : 0</span><br><span class="line">  .rt_time                       : 0.000000</span><br><span class="line">  .rt_runtime                    : 950.000000</span><br><span class="line"></span><br><span class="line">dl_rq[0]:</span><br><span class="line">  .dl_nr_running                 : 0</span><br><span class="line">  .dl_nr_migratory               : 0</span><br><span class="line">  .dl_bw-&gt;bw                     : 996147</span><br><span class="line">  .dl_bw-&gt;total_bw               : 0</span><br></pre></td></tr></tbody></table></figure><ul><li>Sched è°ƒè¯•ä¿¡æ¯çš„ç‰ˆæœ¬å·ï¼šv0.11</li><li>Linux å†…æ ¸ç‰ˆæœ¬å·ï¼š5.4.0</li><li>å†…æ ¸æ—¶é—´ï¼ˆktimeï¼‰çš„å€¼ 5439613876.757507</li><li>sched_clock=5439566740.450647 å’Œ cpu_clk=5439566596.040965 çš„å€¼</li><li>å½“å‰ jiffies çš„å€¼ 5654795694</li><li>å’Œè°ƒåº¦ç›¸å…³çš„ sysctl_sched çš„å€¼<ul><li>è°ƒåº¦å‘¨æœŸ sysctl_sched_latency ä¸º 24.000000ms</li><li>è°ƒåº¦æœ€å°ç²’åº¦ä¸º 3.000000ms</li><li>å”¤é†’çš„æœ€å°ç²’åº¦ä¸º 4.000000ms</li><li>fork è°ƒç”¨å®Œæˆä¹‹åç¦æ­¢å­è¿›ç¨‹å…ˆè¿è¡Œ</li><li>è°ƒåº¦æ”¯æŒçš„ç‰¹æ€§</li></ul></li></ul><p>cpu ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cpu<span class="comment">#0, 2500.140 MHz</span></span><br><span class="line">  .nr_running                    : 0</span><br><span class="line">  .nr_switches                   : 57306500</span><br><span class="line">  .nr_load_updates               : 0</span><br><span class="line">  .nr_uninterruptible            : -2994</span><br><span class="line">  .next_balance                  : 5654.795676</span><br><span class="line">  .curr-&gt;pid                     : 0</span><br><span class="line">  .clock                         : 5439566591.813321</span><br><span class="line">  .clock_task                    : 5439566591.813321</span><br><span class="line">  .avg_idle                      : 1000000</span><br><span class="line">  .max_idle_balance_cost         : 500000</span><br><span class="line">  .yld_count                     : 1</span><br><span class="line">  .sched_count                   : 8189</span><br><span class="line">  .sched_goidle                  : 4044</span><br><span class="line">  .ttwu_count                    : 1273</span><br><span class="line">  .ttwu_local                    : 321</span><br></pre></td></tr></tbody></table></figure><ul><li>nr_runningï¼šæœ‰ 0 ä¸ªè¿›ç¨‹åœ¨å°±ç»ªé˜Ÿåˆ—é‡Œ</li><li>nr_switchesï¼šå°±ç»ªé˜Ÿåˆ—å‘ç”Ÿè¿›ç¨‹åˆ‡æ¢çš„æ¬¡æ•° 57306500 æ¬¡</li><li>nr_load_updatesï¼šå°±ç»ªé˜Ÿåˆ—çš„ cpu_load[] å¹³æ»‘è´Ÿè½½æ›´æ–°çš„æ¬¡æ•° 0 æ¬¡</li><li>next_balanceï¼šä¸‹ä¸€æ¬¡åšè´Ÿè½½å‡è¡¡çš„æ—¶é—´ 5654.795676</li><li>curr-&gt;pidï¼šæ­£åœ¨è¿è¡ŒçŠ¶æ€çš„ PID</li><li>clock å’Œ clock_taskï¼šå½“å‰ç³»ç»Ÿé‡‡æ ·çš„æ—¶åˆ»</li></ul><p>cfs å°±ç»ªé˜Ÿåˆ—ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cfs_rq[1]:/user.slice</span><br><span class="line">  .exec_clock                    : 12.379262</span><br><span class="line">  .MIN_vruntime                  : 0.000001</span><br><span class="line">  .min_vruntime                  : 2306434.555699</span><br><span class="line">  .max_vruntime                  : 0.000001</span><br><span class="line">  .spread                        : 0.000000</span><br><span class="line">  .spread0                       : -8049717.704115</span><br><span class="line">  .nr_spread_over                : 0</span><br><span class="line">  .nr_running                    : 1</span><br><span class="line">  .load                          : 1048576</span><br><span class="line">  .runnable_weight               : 1048576</span><br><span class="line">  .load_avg                      : 3</span><br><span class="line">  .runnable_load_avg             : 3</span><br><span class="line">  .util_avg                      : 3</span><br><span class="line">  .util_est_enqueued             : 0</span><br><span class="line">  .removed.load_avg              : 0</span><br><span class="line">  .removed.util_avg              : 0</span><br><span class="line">  .removed.runnable_sum          : 0</span><br><span class="line">  .tg_load_avg_contrib           : 3</span><br><span class="line">  .tg_load_avg                   : 1037</span><br><span class="line">  .throttled                     : 0</span><br><span class="line">  .throttle_count                : 0</span><br><span class="line">  .se-&gt;exec_start                : 5439566596.839807</span><br><span class="line">  .se-&gt;vruntime                  : 7544926.691548</span><br><span class="line">  .se-&gt;sum_exec_runtime          : 2240863.841914</span><br><span class="line">  .se-&gt;statistics.wait_start     : 0.000000</span><br><span class="line">  .se-&gt;statistics.sleep_start    : 0.000000</span><br><span class="line">  .se-&gt;statistics.block_start    : 0.000000</span><br><span class="line">  .se-&gt;statistics.sleep_max      : 0.000000</span><br><span class="line">  .se-&gt;statistics.block_max      : 0.000000</span><br><span class="line">  .se-&gt;statistics.exec_max       : 0.303114</span><br><span class="line">  .se-&gt;statistics.slice_max      : 0.000000</span><br><span class="line">  .se-&gt;statistics.wait_max       : 0.000000</span><br><span class="line">  .se-&gt;statistics.wait_sum       : 0.000000</span><br><span class="line">  .se-&gt;statistics.wait_count     : 143</span><br><span class="line">  .se-&gt;load.weight               : 521740</span><br><span class="line">  .se-&gt;runnable_weight           : 521740</span><br><span class="line">  .se-&gt;avg.load_avg              : 2</span><br><span class="line">  .se-&gt;avg.util_avg              : 3</span><br><span class="line">  .se-&gt;avg.runnable_load_avg     : 2</span><br></pre></td></tr></tbody></table></figure><ul><li>exec_clockï¼šCFS å°±ç»ªé˜Ÿåˆ—çš„æ€»è¿è¡Œæ—¶é—´</li><li>MIN_vruntimeï¼šè¡¨ç¤º CFS å°±ç»ªé˜Ÿåˆ—çš„çº¢é»‘æ ‘ä¸­æœ€å·¦è¾¹èŠ‚ç‚¹çš„ vruntime çš„å€¼</li><li>min_vruntimeï¼šCFS å°±ç»ªé˜Ÿåˆ—é‡Œ min_vruntime çš„å€¼</li><li>max_vruntime: CFS å°±ç»ªé˜Ÿåˆ—çš„çº¢é»‘æ ‘ä¸­æœ€å³è¾¹èŠ‚ç‚¹çš„ vruntime çš„å€¼</li><li>nr_runningï¼šCFS å°±ç»ªé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ•°</li><li>loadï¼šCFS å°±ç»ªé˜Ÿåˆ—çš„æ€»æƒé‡</li><li>runnable_weight.CFS å°±ç»ªé˜Ÿåˆ—ä¸­å¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹æ€»æƒé‡</li><li>load_avg: è°ƒåº¦é˜Ÿåˆ—ä¸­æ€»çš„é‡åŒ–è´Ÿè½½ï¼Œè¿™æ˜¯ CFS å°±ç»ªé˜Ÿåˆ—ä¸­æ‰€æœ‰è¿›ç¨‹çš„é‡åŒ–è´Ÿè½½ä¹‹å’Œ</li><li>runnable_load_avgï¼šCFS å°±ç»ªé˜Ÿåˆ—é‡Œæ‰€æœ‰å¯è¿è¡ŒçŠ¶æ€ä¸‹çš„è¿›ç¨‹æ€»é‡åŒ–è´Ÿè½½ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„å€¼å’Œ load_avg ç›¸ç­‰</li><li>util_avgï¼šCFS å°±ç»ªé˜Ÿåˆ—å½“å‰çš„é‡åŒ–è®¡ç®—èƒ½åŠ›</li></ul><p>æ‰€æœ‰è¿›ç¨‹ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">runnable tasks:</span><br><span class="line"> S           task   PID         tree-key  switches  prio     wait-time             sum-exec        sum-sleep</span><br><span class="line">-----------------------------------------------------------------------------------------------------------</span><br><span class="line"> I         rcu_gp     3        13.968356         2   100         0.000000         0.003216         0.000000 0 0 /</span><br><span class="line"> I     rcu_par_gp     4        15.968978         2   100         0.000000         0.002189         0.000000 0 0 /</span><br><span class="line"> I   kworker/0:0H     6      4826.431210         4   100         0.000000         0.020363         0.000000 0 0 /</span><br><span class="line"> I   mm_percpu_wq    10        24.040288         2   100         0.000000         0.002587         0.000000 0 0 /</span><br><span class="line"> S    ksoftirqd/0    11  10356126.783742    181278   120         0.077741      3101.302842     18658.038816 0 0 /</span><br><span class="line"> S    migration/0    13         0.000000   1360506     0         0.000000     14628.664708         0.000000 0 0 /</span><br><span class="line"> S  idle_inject/0    14         0.000000         3    49         0.000000         0.005710         0.000000 0 0 /</span><br><span class="line"> S        cpuhp/0    15    298446.415933        21   120         0.000000         1.152329         0.000000 0 0 /</span><br><span class="line"> S      watchdogd   369        11.999994         2     0         0.000000         0.000000         0.000000 0 0 /</span><br><span class="line"> Secryptfs-kthrea   418      3181.658188         2   120         0.000000         0.007012         0.000000 0 0 /</span><br><span class="line"> I   kworker/0:1H   771  10354055.277526     23104   100         0.000000       515.468619         0.000000 0 0 /</span><br><span class="line"> S       rsyslogd  1230       100.894491      9129   120         0.000000       325.720995         0.000000 0 1230 /system.slice/rsyslog.service</span><br><span class="line"> S        dockerd 598258     31439.037574     27303   120         0.000000     28928.757364         0.000000 0 597670 /system.slice/snap.docker.dockerd.service</span><br><span class="line"> S     containerd 597865     31427.350714    113110   120         0.000000     13081.711696         0.030330 0 598167 /system.slice/snap.docker.dockerd.service</span><br><span class="line"> I    kworker/0:2 646991  10279557.062806    122739   120         0.000000      3114.131510         0.000000 0 0 /</span><br><span class="line"> I    kworker/0:0 649432  10356141.706616    369586   120         1.089386      9517.253921    103008.678000 0 0 /</span><br><span class="line"> S           smbd 651779   1641474.345475    460050   120        11.539434    246732.864126     64471.275817 0 651779 /system.slice/smbd.service</span><br><span class="line"> S           node 652105   3528667.050423      1354   120         0.000000      2331.451911         0.000000 0 652102 /user.slice</span><br><span class="line"> S       cpptools 652144   3527016.422624         6   120         0.000000         0.203793         0.000000 0 0 /user.slice</span><br><span class="line"> S       cpptools 652162   3527016.384935         6   120         0.000000         0.146937         0.000000 0 0 /user.slice</span><br><span class="line"> S       cpptools 652182   3527016.373736         6   120         0.000000         0.115269         0.000000 0 0 /user.slice</span><br><span class="line"> S       cpptools 652296   3527040.380268         1   120         0.000000         0.047959         0.000000 0 0 /user.slice</span><br><span class="line"> S   cpptools-srv 652246   3527028.332316         1   120         0.000000         0.076723         0.000000 0 0 /user.slice</span><br></pre></td></tr></tbody></table></figure><ul><li>ç¬¬ 1 åˆ—æ˜¾ç¤ºè¿›ç¨‹çš„çŠ¶æ€ã€‚R è¡¨ç¤ºå¯è¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯åœ¨ CFS å°±ç»ªé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ï¼›S è¡¨ç¤ºç¡çœ çŠ¶æ€çš„è¿›ç¨‹</li><li>ç¬¬ 2 åˆ—æ˜¾ç¤ºè¿›ç¨‹çš„åç§°</li><li>ç¬¬ 3 åˆ—æ˜¾ç¤º PID</li><li>ç¬¬ 4 åˆ—æ˜¾ç¤ºè¿›ç¨‹åœ¨ CFS å°±ç»ªé˜Ÿåˆ—çš„çº¢é»‘æ ‘ä¸­çš„é”®å€¼</li><li>ç¬¬ 5 åˆ—æ˜¾ç¤ºè¿›ç¨‹åˆ‡æ¢çš„æ¬¡æ•°</li><li>ç¬¬ 6 åˆ—æ˜¾ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§</li><li>ç¬¬ 7 åˆ—æ˜¾ç¤ºè¿›ç¨‹ç­‰å¾…æ—¶é—´</li><li>ç¬¬ 8 åˆ—æ˜¾ç¤ºè¿›ç¨‹è¿è¡Œçš„æ€»æ—¶é—´</li><li>ç¬¬ 9 åˆ—æ˜¾ç¤ºè¿›ç¨‹ä¼‘çœ çš„æ€»æ—¶é—´</li></ul><h1 id="æŸ¥çœ‹è°ƒåº¦åŸŸä¿¡æ¯">æŸ¥çœ‹è°ƒåº¦åŸŸä¿¡æ¯</h1><p>åœ¨ç†è§£ SMP è´Ÿè½½å‡è¡¡æœºåˆ¶çš„è¿‡ç¨‹ä¸­ï¼ŒCPU çš„æ‹“æ‰‘å…³ç³»æ˜¯ä¸€ä¸ªéš¾ç‚¹ã€‚Linux å†…æ ¸æ–°å¢äº†ä¸€ä¸ªè°ƒè¯•èŠ‚ç‚¹æ¥å¸®åŠ©å¼€å‘è€…ç†è§£ï¼ˆè¯¦è§ kernel/sched/topology.c æ–‡ä»¶ï¼‰ã€‚åœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œä¸ä»…éœ€è¦æ‰“å¼€ CONFIG_SCHED_DEBUG é€‰é¡¹ï¼Œè¿˜éœ€è¦åœ¨å†…æ ¸å¯åŠ¨å‚æ•°é‡Œä¼ é€’ sched_debug å‚æ•°ã€‚ åœ¨å†…æ ¸å¯åŠ¨ä¹‹åï¼Œå¯ä»¥é€šè¿‡ dmesg å‘½ä»¤æ¥å¾—åˆ° CPU æ‹“æ‰‘å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[0.224258] CPUO attaching sched-domain(s)</span><br><span class="line">[0.224422]    domain-0: span=0-3 level=MC</span><br><span class="line">[0.224780]        <span class="built_in">groups</span>: O:{ span=0 },1:{span=1},2:{span=2},3:{span=3}</span><br><span class="line">[0.227045] CPU1 attaching sched-domain(s):</span><br><span class="line">[0.227111]    domain-0: span=0-3 level=MC</span><br><span class="line">[0.227179]        <span class="built_in">groups</span>: 1:{span=1},2:{span=2 },3:{span=3 }, 0:{ span=0}</span><br><span class="line">[0.227347] CPU2 attaching sched-domain(s):</span><br><span class="line">[0.227407]    domain-0: span=0-3 level=MC</span><br><span class="line">[0.227471]        <span class="built_in">groups</span>: 2:{span=2},3:{span=3},0:{span=0},1:{span=1}</span><br><span class="line">[0.228416] CPU3 attaching <span class="built_in">sched</span>- domain(s):</span><br><span class="line">[0.228485]    domain-0: span=0-3 level=MC</span><br><span class="line">[02285530]         <span class="built_in">groups</span>: 3:{span=3 }, 0:{span=0 }, 1:{span=1},2:{span=2}</span><br><span class="line">[0.228757] root domain span: O-3 (max cpucapacity = 1024)</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œè¯¥ç³»ç»Ÿåªæœ‰ MC å±‚çº§ï¼Œä» CPU0 è§’åº¦çœ‹ï¼Œå®ƒå¯¹åº”çš„è°ƒåº¦åŸŸæ˜¯ domain-0ï¼Œç®¡è¾–çš„èŒƒå›´æ˜¯ CPU[0~3]ï¼Œè°ƒåº¦å±‚çº§æ˜¯ MCã€‚åŒç†ï¼Œå¯ä»¥å¾—å‡º CPU1ã€CPU2 ä»¥åŠ CPU3 çš„ CPU æ‹“æ‰‘å…³ç³»ã€‚</p><h1 id="ä¸è°ƒåº¦ç›¸å…³çš„è°ƒè¯•èŠ‚ç‚¹">ä¸è°ƒåº¦ç›¸å…³çš„è°ƒè¯•èŠ‚ç‚¹</h1><p>å’Œè°ƒåº¦ç›¸å…³çš„è°ƒè¯•èŠ‚ç‚¹åœ¨/proc/sys/kernel ç›®å½•ä¸‹ï¼Œä¸‹é¢æ¥ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><ul><li>sched_cfs_bandwidth_slice_usï¼šç”¨äºè®¾ç½® CFS çš„å¸¦å®½é™åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 5ms</li><li>sched_child_runs_firstï¼šé€šè¿‡ fork è°ƒç”¨åˆ›å»ºè¿›ç¨‹ä¹‹åï¼Œsched_child_runs_first å¯ä»¥ç”¨äºæ§åˆ¶æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹å…ˆè¿è¡Œï¼›è‹¥è¯¥å€¼ä¸º 1ï¼Œè¡¨ç¤ºå­è¿›ç¨‹å…ˆè¿è¡Œï¼›é»˜è®¤å€¼ä¸º 0</li><li>sched_domainï¼šä¸è°ƒåº¦åŸŸç›¸å…³çš„ç›®å½•</li><li>sched_latency_nsï¼šè®¾ç½® CFS å°±ç»ªé˜Ÿåˆ—è°ƒåº¦çš„æ€»æ—¶é—´ç‰‡ sysctl_sched_latencyï¼Œé»˜è®¤å€¼ä¸º 6msã€‚ sched_latency_ns è¡¨ç¤ºä¸€ä¸ªè¿è¡Œé˜Ÿåˆ—ä¸­æ‰€æœ‰è¿›ç¨‹è¿è¡Œä¸€æ¬¡çš„æ—¶é—´ç‰‡ï¼Œå®ƒä¸è¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹æ•°æœ‰å…³ã€‚å¦‚æœè¿›ç¨‹æ•°è¶…è¿‡ sched_nr_latencyï¼ˆé»˜è®¤æ˜¯ 8ï¼‰ï¼Œé‚£ä¹ˆè°ƒåº¦å‘¨æœŸå°±æ˜¯ sched_min_granularity_ns ä¹˜ä»¥è¿è¡Œé˜Ÿåˆ—é‡Œçš„è¿›ç¨‹æ•°é‡ï¼›å¦åˆ™ï¼Œå°±æ˜¯ sysctl_sched_latency</li><li>sched_migration_cost_nsï¼šåˆ¤æ–­ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦å¯ä»¥åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„çƒ­åº¦ã€‚å¦‚æœè¿›ç¨‹çš„è¿è¡Œæ—¶é—´ï¼ˆnow-p-&gt;se.exec_startï¼‰å°äºå®ƒï¼Œé‚£ä¹ˆå†…æ ¸è®¤ä¸ºå®ƒçš„æ•°æ®è¿˜åœ¨é«˜é€Ÿç¼“å­˜é‡Œï¼Œæ‰€ä»¥è¯¥è¿›ç¨‹å¯ä»¥åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„çƒ­åº¦ï¼Œåœ¨è¿ç§»çš„æ—¶å€™å°±ä¸ä¼šè€ƒè™‘å®ƒ</li><li>sched_min_granularity_nsï¼šè®¾ç½® CPU å¯†é›†å‹è¿›ç¨‹æœ€å°çš„è°ƒåº¦æ—¶é—´ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹æœ€çŸ­è¿è¡Œæ—¶é—´ï¼Œç”¨äºé˜²æ­¢é¢‘ç¹åˆ‡æ¢ã€‚é»˜è®¤å€¼ä¸º 0.75ms</li><li>sched_nr_migrateï¼šè®¾ç½®åœ¨ SMP è´Ÿè½½å‡è¡¡æœºåˆ¶é‡Œæ¯æ¬¡æœ€å¤šå¯ä»¥ä»ç›®æ ‡ CPU è¿ç§»å¤šå°‘ä¸ªè¿›ç¨‹åˆ°æº CPU é‡Œã€‚åœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­å…³é—­äº†ä¸­æ–­ï¼ŒåŒ…æ‹¬è½¯ä¸­æ–­æœºåˆ¶ï¼Œå› æ­¤å¢å¤§è¯¥å€¼ä¼šå¯¼è‡´ä¸­æ–­å»¶è¿Ÿï¼ŒåŒæ—¶ä¹Ÿå¢å¤§äº†å®æ—¶è¿›ç¨‹çš„å»¶è¿Ÿã€‚è¯¥å€¼é»˜è®¤è®¾ç½®ä¸º 32</li><li>sched_schedstatsï¼šç”¨äºæ‰“å¼€è°ƒåº¦ç»Ÿè®¡ä¿¡æ¯</li><li>sched_wakeup_granularity_nsï¼šå¾…å”¤é†’è¿›ç¨‹ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å å½“å‰è¿›ç¨‹ï¼Œè‹¥å¾…å”¤é†’è¿›ç¨‹çš„ç¡çœ æ—¶é—´çŸ­äº sched_wakeup_granularity_nsï¼Œé‚£ä¹ˆä¸ä¼šæŠ¢å å½“å‰è¿›ç¨‹ã€‚å¢åŠ è¯¥å€¼ä¼šå‡å°å¾…å”¤é†’è¿›ç¨‹çš„æŠ¢å æ¦‚ç‡ã€‚è‹¥å‡å°è¯¥å€¼ï¼Œé‚£ä¹ˆå‘ç”ŸæŠ¢å çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚é»˜è®¤å€¼ä¸º 1ms</li></ul><p>å¦å¤–ï¼Œåœ¨/sys/kermel/debug/ç›®å½•ä¸‹ä¹Ÿæœ‰å‡ ä¸ªå’Œè°ƒåº¦ç›¸å…³çš„èŠ‚ç‚¹ã€‚</p><ul><li>sched_featuresï¼šè¡¨ç¤ºè°ƒåº¦å™¨æ”¯æŒçš„ç‰¹æ€§ï¼Œå¦‚ START_DEBITï¼ˆæ–°è¿›ç¨‹å°½é‡æ—©è°ƒåº¦ï¼‰ï¼ŒWAKEUP_PREEMPTï¼ˆå”¤é†’çš„è¿›ç¨‹æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿è¡Œçš„è¿›ç¨‹ï¼‰ç­‰ã€‚æ‰€æœ‰çš„ç‰¹æ€§è¯¦è§ kerel/sched/sech_features.h æ–‡ä»¶çš„å®šä¹‰</li><li>osched_debugï¼šè°ƒåº¦å™¨çš„è°ƒè¯•ä¿¡æ¯çš„å¼€å…³ã€‚æ³¨æ„ï¼Œè¯¥å€¼ä»…ä»…æ§åˆ¶ sched_debug_enabledï¼Œå¹¶ä¸ä¼šæ§åˆ¶/proc/sched_debug èŠ‚ç‚¹ å…³äº sched_debug_enabled çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">sched_debug_setup</span><span class="params">(<span class="type">char</span> *str)</span></span><br><span class="line">{</span><br><span class="line">    sched_debug_enabled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line">early_param(<span class="string">"sched_debug"</span>, sched_debug_setup);</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆå››ï¼‰å¤šæ ¸è°ƒåº¦</title>
      <link href="/2021/LinuxKernel/LinuxTaskSMP/"/>
      <url>/2021/LinuxKernel/LinuxTaskSMP/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskSMP.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2YjhlYzFlZmFkNDA3NTI1MTE2NDk=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>SMPï¼ˆSymmetrical MultiProcessingï¼‰çš„å…¨ç§°æ˜¯â€œå¯¹ç§°å¤šå¤„ç†â€æŠ€æœ¯ï¼Œæ˜¯æŒ‡åœ¨ä¸€å°è®¡ç®—æœºä¸Šæ±‡é›†äº†ä¸€ç»„å¤„ç†å™¨ï¼Œè¿™äº›å¤„ç†å™¨éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œå®ƒä»¬ä¹‹é—´å…±äº«å†…å­˜å­ç³»ç»Ÿå’Œç³»ç»Ÿæ€»çº¿ã€‚</p><p>ä¸‹å›¾æ‰€ç¤ºä¸º 4 æ ¸çš„ SMP å¤„ç†å™¨æ¶æ„ï¼Œåœ¨ 4 æ ¸å¤„ç†å™¨ä¸­ï¼Œæ¯ä¸ªç‰©ç† CPU æ ¸å¿ƒæ‹¥æœ‰ç‹¬ç«‹çš„ L1 ç¼“å­˜ä¸”ä¸æ”¯æŒè¶…çº¿ç¨‹æŠ€æœ¯ï¼Œåˆ†æˆä¸¤ä¸ªç°‡ï¼ˆclusterï¼‰ç°‡ 0 å’Œç°‡ 1ï¼Œæ¯ä¸ªç°‡åŒ…å«ä¸¤ä¸ªç‰©ç† CPU æ ¸ï¼Œç°‡ä¸­çš„ CPU æ ¸å…±äº« L2 ç¼“å­˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/smp.png"></p><h1 id="è°ƒåº¦åŸŸå’Œè°ƒåº¦ç»„">è°ƒåº¦åŸŸå’Œè°ƒåº¦ç»„</h1><p>æ ¹æ®å¤„ç†å™¨çš„å®é™…ç‰©ç†å±æ€§ï¼ŒCPU å’Œ Linux å†…æ ¸çš„åˆ†ç±»å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li><p>SMTï¼ˆè¶…çº¿ç¨‹ï¼‰ï¼š Linux å†…æ ¸é…ç½®é¡¹ CONFIG_SCHED_SMT ä¸€ä¸ªç‰©ç†æ ¸å¿ƒå¯ä»¥æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šæ‰§è¡Œçº¿ç¨‹ï¼Œè¢«ç§°ä¸ºè¶…çº¿ç¨‹æŠ€æœ¯ã€‚è¶…çº¿ç¨‹ä½¿ç”¨ç›¸åŒçš„ cpu èµ„æºä¸”å…±äº« L1 ç¼“å­˜ï¼Œè¿ç§»è¿›ç¨‹ä¸ä¼šå½±å“é«˜é€Ÿç¼“å­˜çš„åˆ©ç”¨ç‡</p></li><li><p>MCï¼ˆå¤šæ ¸ï¼‰ï¼š Linux å†…æ ¸é…ç½®é¡¹ CONFIG_SCHED_MC æ¯ä¸ªç‰©ç†æ ¸å¿ƒç‹¬äº« L1 é«˜é€Ÿç¼“å­˜ï¼Œå¤šä¸ªç‰©ç†æ ¸å¿ƒå¯ä»¥ç»„æˆæ—ï¼Œæ—é‡Œçš„ cpu å…±äº« L2 é«˜é€Ÿç¼“å­˜</p></li><li><p>SOCï¼ˆå¤„ç†å™¨ï¼‰ï¼š å†…æ ¸ç§°ä¸º DIE SOC çº§åˆ«</p></li></ul><p>Linux å†…æ ¸ä½¿ç”¨æ•°æ®ç»“æ„ sched_domain_topology_level æ¥æè¿° CPU çš„å±‚æ¬¡å…³ç³»ï¼Œæœ¬èŠ‚ä¸­ç®€ç§°ä¸º SDTLã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/sched/topology.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_domain_topology_level</span> {</span></span><br><span class="line">sched_domain_mask_f mask; <span class="comment">//å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šæŸä¸ª SDTL çš„ cpumask ä½å›¾</span></span><br><span class="line">sched_domain_flags_f sd_flags;<span class="comment">//å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šæŸä¸ª SDTL çš„æ ‡å¿—ä½</span></span><br><span class="line"><span class="type">int</span>    flags;</span><br><span class="line"><span class="type">int</span>    numa_level;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sd_data</span>      <span class="title">data</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SCHED_DEBUG</span></span><br><span class="line"><span class="type">char</span>                *name;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å¦å¤–ï¼ŒLinux å†…æ ¸é»˜è®¤å®šä¹‰äº†æ•°ç»„ default_topology[] æ¥æ¦‚æ‹¬ CPU ç‰©ç†åŸŸçš„å±‚æ¬¡ç»“æ„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/sched/topology.c&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Topology list, bottom-up.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_domain_topology_level</span> <span class="title">default_topology</span>[] =</span> {</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SCHED_SMT</span></span><br><span class="line">{ cpu_smt_mask, cpu_smt_flags, SD_INIT_NAME(SMT) },</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SCHED_MC</span></span><br><span class="line">{ cpu_coregroup_mask, cpu_core_flags, SD_INIT_NAME(MC) },</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">{ cpu_cpu_mask, SD_INIT_NAME(DIE) },</span><br><span class="line">{ <span class="literal">NULL</span>, },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>Linux å†…æ ¸ä½¿ç”¨ sched_domain æ•°æ®ç»“æ„æ¥æè¿°è°ƒåº¦å±‚çº§ï¼Œä» defaul_topology[] æ•°ç»„å¯çŸ¥ï¼Œç³»ç»Ÿé»˜è®¤æ”¯æŒ DIE ç±»å‹å±‚çº§ã€SMT ç±»å‹å±‚çº§ä»¥åŠ MC ç±»å‹å±‚çº§ã€‚å¦å¤–ï¼Œå¯åœ¨è°ƒåº¦åŸŸé‡Œåˆ’åˆ†è°ƒåº¦ç»„ï¼Œç„¶åä½¿ç”¨ sched_group æ•°æ®ç»“æ„æ¥æè¿°è°ƒåº¦ç»„ï¼Œè°ƒåº¦ç»„æ˜¯è´Ÿè½½å‡è¡¡è°ƒåº¦çš„æœ€å°å•ä½ã€‚åœ¨æœ€ä½å±‚çº§çš„è°ƒåº¦åŸŸä¸­ï¼Œé€šå¸¸ç”¨è°ƒåº¦ç»„æè¿° CPU æ ¸å¿ƒã€‚ åœ¨æ”¯æŒ NUMA æ¶æ„çš„å¤„ç†å™¨ä¸­ï¼Œå‡è®¾æ”¯æŒ SMT æŠ€æœ¯ï¼Œé‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿçš„è°ƒåº¦åŸŸå’Œè°ƒåº¦ç»„çš„å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼Œå¯åœ¨é»˜è®¤çš„è°ƒåº¦å±‚çº§ä¸­æ–°å¢ NUMA å±‚çº§çš„è°ƒåº¦åŸŸã€‚åœ¨è¶…å¤§ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿä¼šé¢‘ç¹è®¿é—®è°ƒåº¦åŸŸæ•°æ®ç»“æ„ã€‚ä¸ºäº†æå‡ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§ï¼Œè°ƒåº¦åŸŸæ•°æ®ç»“æ„ sched_domain é‡‡ç”¨ Per-CPU å˜é‡æ¥æ„å»º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/sched_domain.png"></p><h1 id="è´Ÿè½½çš„è®¡ç®—">è´Ÿè½½çš„è®¡ç®—</h1><h3 id="ä¾‹-1">ä¾‹ 1</h3><p>å‡è®¾åœ¨å¦‚å›¾æ‰€ç¤ºçš„åŒæ ¸å¤„ç†å™¨é‡Œï¼ŒCPU0 çš„å°±ç»ªé˜Ÿåˆ—é‡Œæœ‰ 4 ä¸ªè¿›ç¨‹ï¼ŒCPU1 çš„å°±ç»ªé˜Ÿåˆ—é‡Œæœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆç©¶ç«Ÿå“ªä¸ª CPU ä¸Šçš„è´Ÿè½½é‡å‘¢ï¼Ÿ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/queue_cpu.png"></p><p>å‡è®¾ä¸Šè¿° 6 ä¸ªè¿›ç¨‹çš„ nice å€¼æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯ä¼˜å…ˆçº§å’Œæƒé‡éƒ½ç›¸åŒï¼Œé‚£ä¹ˆæ˜æ˜¾å¯ä»¥çœ‹å‡º CPU0 çš„å°±ç»ªé˜Ÿåˆ—é‡Œæœ‰ 4 ä¸ªè¿›ç¨‹ï¼Œç›¸æ¯” CPU1 çš„å°±ç»ªé˜Ÿåˆ—é‡Œçš„è¿›ç¨‹æ•°ç›®è¦å¤šï¼Œä»è€Œå¾—å‡º CPU0 ä¸Šçš„è´Ÿè½½ç›¸æ¯” CPU1 æ›´é‡çš„ç»“è®ºã€‚</p><pre><code>CPU ä¸Šçš„è´Ÿè½½=å°±ç»ªé˜Ÿåˆ—çš„æ€»æƒé‡</code></pre><p>ä¸ºäº†è®¡ç®— CPU ä¸Šçš„è´Ÿè½½ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯è®¡ç®— CPU çš„å°±ç»ªé˜Ÿåˆ—ä¸­æ‰€æœ‰è¿›ç¨‹çš„æƒé‡ã€‚</p><p>ä½†æ˜¯ï¼Œä»…è€ƒè™‘ä¼˜å…ˆçº§å’Œæƒé‡æ˜¯æœ‰é—®é¢˜çš„ï¼Œæœ‰çš„æ˜¯ CPU å¯†é›†å‹çš„ï¼Œä¹Ÿæœ‰çš„æ˜¯ I/O å¯†é›†å‹çš„ã€‚å¦‚æœå»¶ä¼¸åˆ°å¤š CPU ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œç»“æœå°±æ˜¾å¾—ä¸å‡†ç¡®äº†ã€‚</p><h3 id="ä¾‹-2">ä¾‹ 2</h3><p>åœ¨å¦‚å›¾æ‰€ç¤ºçš„åŒæ ¸å¤„ç†å™¨é‡Œï¼ŒCPU0 å’Œ CPU1 çš„å°±ç»ªé˜Ÿåˆ—é‡Œéƒ½åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œï¼Œè€Œä¸”è¿›ç¨‹çš„ä¼˜å…ˆçº§å’Œæƒé‡ç›¸åŒã€‚ä½†æ˜¯ï¼ŒCPUO ä¸Šçš„è¿›ç¨‹ä¸€ç›´åœ¨å ç”¨ CPUï¼Œè€Œ CPU1 ä¸Šçš„è¿›ç¨‹èµ°èµ°åœåœï¼Œé‚£ä¹ˆç©¶ç«Ÿ CPU0 å’Œ CPU1 ä¸Šçš„è´Ÿè½½æ˜¯ä¸æ˜¯ç›¸åŒå‘¢ï¼Ÿ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/task_load.png"></p><p>ä»ä¾‹ 1 ä¸­çš„åˆ¤æ–­æ¡ä»¶çœ‹ï¼Œä¸¤ä¸ª CPU ä¸Šçš„è´Ÿè½½æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼Œä»æˆ‘ä»¬çš„ç›´è§‚æ„Ÿå—çœ‹ï¼ŒCPU0 ä¸Šçš„è¿›ç¨‹ä¸€ç›´å ç”¨ CPUï¼ŒCPU0 æ˜¯ä¸€ç›´æ»¡è´Ÿè·è¿è¡Œçš„ï¼Œè€Œ CPU1 ä¸Šçš„è¿›ç¨‹èµ°èµ°åœåœï¼ŒCPU ä½¿ç”¨ç‡ä¸é«˜ã€‚ä¸ºä»€ä¹ˆä¼šå¾—å‡ºä¸ä¸€æ ·çš„ç»“è®ºå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºä¾‹ 1 ä½¿ç”¨çš„è®¡ç®—æ–¹æ³•æ²¡æœ‰è€ƒè™‘è¿›ç¨‹åœ¨æ—¶é—´å› ç´ ä¸‹çš„ä½œç”¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è€ƒè™‘å†å²è´Ÿè½½å¯¹å½“å‰è´Ÿè½½çš„å½±å“ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è®¡ç®—å†å²è´Ÿè½½å¯¹ CPU ä¸Šçš„è´Ÿè½½çš„å½±å“å‘¢ï¼Ÿ</p><p>CPU ä¸Šçš„è´Ÿè½½çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ã€‚ <span class="math display">\[CPU ä¸Šçš„è´Ÿè½½ = \frac{è¿è¡Œæ—¶é—´}{æ€»æ—¶é—´} \times  å°±ç»ªé˜Ÿåˆ—æ€»æƒé‡ \tag{2}\]</span> å…¶ä¸­ï¼Œè¿è¡Œæ—¶é—´æ˜¯æŒ‡å°±ç»ªé˜Ÿåˆ—å ç”¨ CPU çš„æ€»æ—¶é—´ï¼›æ€»æ—¶é—´æ˜¯æŒ‡é‡‡æ ·çš„æ€»æ—¶é—´ï¼ŒåŒ…æ‹¬ CPU å¤„äºç©ºé—²çš„æ—¶é—´ä»¥åŠ CPU æ­£åœ¨è¿è¡Œçš„æ—¶é—´ï¼›å°±ç»ªé˜Ÿåˆ—æ€»æƒé‡æ˜¯æŒ‡å°±ç»ªé˜Ÿåˆ—é‡Œæ‰€æœ‰è¿›ç¨‹çš„æ€»æƒé‡ã€‚</p><p>å¼ 2 æŠŠè´Ÿè½½è¿™ä¸ªæ¦‚å¿µé‡åŒ–åˆ°äº†æƒé‡ï¼Œè¿™æ ·ä¸åŒè¿è¡Œè¡Œä¸ºçš„è¿›ç¨‹å°±æœ‰äº†é‡åŒ–çš„æ ‡å‡†æ¥è¡¡é‡è´Ÿè½½ï¼Œæœ¬ä¹¦æŠŠè¿™ç§ç”¨è¿è¡Œæ—¶é—´ä¸æ€»æ—¶é—´çš„æ¯”å€¼æ¥è®¡ç®—çš„æƒé‡ï¼Œç§°ä¸ºé‡åŒ–è´Ÿè½½ã€‚å¦å¤–ï¼Œæˆ‘ä»¬æŠŠæ—¶é—´ä¸æƒé‡çš„ä¹˜ç§¯ç§°ä¸ºå·¥ä½œè´Ÿè½½ã€‚</p><p>å¼ 2 å¹¶ä¸å®Œç¾ï¼Œå› ä¸ºå®ƒæŠŠå†å²å·¥ä½œè´Ÿè½½å’Œå½“å‰å·¥ä½œè´Ÿè½½å¹³ç­‰å¯¹å¾…äº†ã€‚</p><p>å› æ­¤ï¼Œè‡ª Linux3.8 å†…æ ¸ä»¥åï¼Œè¿›ç¨‹çš„è´Ÿè½½è®¡ç®—ä¸ä»…è¦è€ƒè™‘æƒé‡ï¼Œè€Œä¸”è¦è·Ÿè¸ªæ¯ä¸ªè°ƒåº¦å®ä½“çš„å†å²è´Ÿè½½æƒ…å†µï¼Œå› è€Œç§°ä¸º PELT ï¼ˆPer-Entitv Load Trackingï¼‰ã€‚PELT ç®—æ³•å¼•å…¥äº† "accumulation of an infinite geometric seriesâ€è¿™ä¸ªæ¦‚å¿µï¼Œè‹±æ–‡å­—é¢æ„æ€æ˜¯æ— ç©·å‡ ä½•çº§æ•°çš„ç´¯åŠ ï¼Œæœ¬ä¹¦æŠŠè¿™ä¸ªæ¦‚å¿µç®€å•ç§°ä¸ºå†å²ç´¯è®¡è®¡ç®—ã€‚</p><p>Linux å†…æ ¸ä½¿ç”¨é‡åŒ–è´Ÿè½½è¿™ä¸ªæ¦‚å¿µæ¥è®¡ç®—å’Œæ¯”è¾ƒè¿›ç¨‹ä»¥åŠå°±ç»ªé˜Ÿåˆ—çš„è´Ÿè½½ã€‚ æ ¹æ®é‡åŒ–è´Ÿè½½çš„å®šä¹‰ï¼Œé‡åŒ–è´Ÿè½½çš„è®¡ç®—å¦‚å¼ 3 æ‰€ç¤ºã€‚ <span class="math display">\[decay\_avg\_load = (\frac{decay\_sum\_runnable\_time}{decay\_sum\_runnable\_time}) \times  weight \tag{3}\]</span></p><p>å…¶ä¸­ï¼Œdecay_avg_load è¡¨ç¤ºé‡åŒ–è´Ÿè½½ï¼›decay_sum_runnable_time æŒ‡çš„æ˜¯å°±ç»ªé˜Ÿåˆ—æˆ–è°ƒåº¦å®ä½“åœ¨å¯è¿è¡ŒçŠ¶æ€ä¸‹çš„æ‰€æœ‰å†å²ç´¯è®¡è¡°å‡æ—¶é—´ï¼›decay_sum_period_time æŒ‡çš„æ˜¯å°±ç»ªé˜Ÿåˆ—æˆ–è°ƒåº¦å®ä½“åœ¨æ‰€æœ‰çš„é‡‡æ ·å‘¨æœŸé‡Œå…¨éƒ¨æ—¶é—´çš„ç´¯åŠ è¡°å‡æ—¶é—´ã€‚é€šå¸¸ä»è¿›ç¨‹å¼€å§‹æ‰§è¡Œæ—¶å°±è®¡ç®—å’Œç´¯è®¡è¿™äº›å€¼ã€‚weight è¡¨ç¤ºè°ƒåº¦å®ä½“æˆ–å°±ç»ªé˜Ÿåˆ—çš„æƒé‡ã€‚ è®¡ç®—è¿›ç¨‹çš„é‡åŒ–è´Ÿè½½çš„æ„ä¹‰åœ¨äºèƒ½å¤ŸæŠŠè´Ÿè½½é‡åŒ–åˆ°æƒé‡é‡Œã€‚å½“ä¸€ä¸ªè¿›ç¨‹çš„ decay_sumrunnable_time æ— é™æ¥è¿‘ decay_sum_period_time æ—¶ï¼Œå®ƒçš„é‡åŒ–è´Ÿè½½å°±æ— é™æ¥è¿‘æƒé‡å€¼ï¼Œè¯´æ˜è¿™ä¸ªè¿›ç¨‹ä¸€ç›´åœ¨å ç”¨ CPUï¼Œæ»¡è´Ÿè·å·¥ä½œï¼ŒCPU å ç”¨ç‡å¾ˆé«˜ã€‚ä¸€ä¸ªè¿›ç¨‹çš„ decay_sum_runnable_time è¶Šå°ï¼Œå®ƒçš„é‡åŒ–è´Ÿè½½å°±è¶Šå°ï¼Œè¯´æ˜è¿™ä¸ªè¿›ç¨‹çš„å·¥ä½œè´Ÿè·å¾ˆå°ï¼Œå ç”¨çš„ CPU èµ„æºå¾ˆå°‘ï¼ŒCPU å ç”¨ç‡å¾ˆä½ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯¹è´Ÿè½½å®ç°äº†ç»Ÿä¸€å’Œæ ‡å‡†åŒ–çš„é‡åŒ–è®¡ç®—ï¼Œä¸åŒè¡Œä¸ºçš„è¿›ç¨‹å°±å¯ä»¥è¿›è¡Œæ ‡å‡†åŒ–çš„è´Ÿè½½è®¡ç®—å’Œæ¯”è¾ƒäº†ã€‚</p><h1 id="è´Ÿè½½å‡è¡¡ç®—æ³•">è´Ÿè½½å‡è¡¡ç®—æ³•</h1><p>SMP è´Ÿè½½å‡è¡¡æœºåˆ¶ä»æ³¨å†Œè½¯ä¸­æ–­å¼€å§‹ï¼Œç³»ç»Ÿæ¯æ¬¡è°ƒåº¦ tick ä¸­æ–­æ—¶ï¼Œéƒ½ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦éœ€è¦å¤„ç† SMP è´Ÿè½½å‡è¡¡ã€‚rebalance_domains() å‡½æ•°æ˜¯è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒå…¥å£ã€‚load_balance() å‡½æ•°ä¸­çš„ä¸»è¦æµç¨‹å¦‚ä¸‹ã€‚</p><ul><li>è´Ÿè½½å‡è¡¡ä»¥å½“å‰ CPU å¼€å§‹ï¼Œç”±ä¸‹è‡³ä¸Šåœ°éå†è°ƒåº¦åŸŸï¼Œä»æœ€åº•å±‚çš„è°ƒåº¦åŸŸå¼€å§‹åšè´Ÿè½½å‡è¡¡</li><li>å…è®¸åšè´Ÿè½½å‡è¡¡çš„é¦–è¦æ¡ä»¶æ˜¯å½“å‰ CPU æ˜¯è°ƒåº¦åŸŸä¸­çš„ç¬¬ä¸€ä¸ª CPUï¼Œæˆ–è€…å½“å‰ CPU æ˜¯ç©ºé—² CPUã€‚è¯¦è§ should_we_balance() å‡½æ•°</li><li>åœ¨è°ƒåº¦åŸŸä¸­æŸ¥æ‰¾æœ€ç¹å¿™çš„è°ƒåº¦ç»„ï¼Œæ›´æ–°è°ƒåº¦åŸŸå’Œè°ƒåº¦ç»„çš„ç›¸å…³ä¿¡æ¯ï¼Œæœ€åè®¡ç®—å‡ºè°ƒåº¦åŸŸçš„ä¸å‡è¡¡è´Ÿè½½å€¼</li><li>æœ€ç¹å¿™çš„è°ƒåº¦ç»„ä¸­æ‰¾å‡ºæœ€ç¹å¿™çš„ CPUï¼Œç„¶åæŠŠç¹å¿™ CPU ä¸­çš„è¿›ç¨‹è¿ç§»åˆ°å½“å‰ CPU ä¸Šï¼Œè¿ç§»çš„è´Ÿè½½é‡ä¸ºä¸å‡è¡¡è´Ÿè½½å€¼</li></ul><h1 id="per-cpu-å˜é‡">Per-CPU å˜é‡</h1><p>Per-CPU å˜é‡æ˜¯ Linux å†…æ ¸ä¸­åŒæ­¥æœºåˆ¶çš„ä¸€ç§ã€‚å½“ç³»ç»Ÿä¸­çš„æ‰€æœ‰ CPU éƒ½è®¿é—®å…±äº«çš„ä¸€ä¸ªå˜é‡ v æ—¶ï¼Œå¦‚æœ CPU0 ä¿®æ”¹äº†å˜é‡ v çš„å€¼ï¼Œè€Œ CPU1 ä¹Ÿåœ¨åŒæ—¶ä¿®æ”¹å˜é‡ v çš„å€¼ï¼Œå°±ä¼šå¯¼è‡´å˜é‡ v çš„å€¼ä¸æ­£ç¡®ã€‚ä¸€ç§å¯è¡Œçš„åŠæ³•å°±æ˜¯åœ¨ CPU0 è®¿é—®å˜é‡ v æ—¶ä½¿ç”¨åŸå­åŠ é”æŒ‡ä»¤ï¼Œè¿™æ · CPU1 è®¿é—®å˜é‡ v æ—¶å°±åªèƒ½ç­‰å¾…äº†ï¼Œä½†è¿™æ ·åšæœ‰ä¸¤ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ç¼ºç‚¹ã€‚</p><ul><li>åŸå­æ“ä½œæ˜¯æ¯”è¾ƒè€—æ—¶çš„</li><li>åœ¨ç°ä»£å¤„ç†å™¨ä¸­ï¼Œæ¯ä¸ª CPU éƒ½æœ‰ L1 ç¼“å­˜ï¼Œå› è€Œå¤šä¸ª CPU åŒæ—¶è®¿é—®åŒä¸€ä¸ªå˜é‡å°±ä¼šå¯¼è‡´ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚å½“æŸä¸ª CPU å¯¹å…±äº«çš„æ•°æ®å˜é‡ v è¿›è¡Œä¿®æ”¹åï¼Œå…¶ä»– CPU ä¸Šå¯¹åº”çš„ç¼“å­˜è¡Œéœ€è¦åšæ— æ•ˆæ“ä½œï¼Œè¿™å¯¹æ€§èƒ½æ˜¯æœ‰æŸè€—çš„</li></ul><p>Per-CPU å˜é‡æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜è€Œå‡ºç°çš„ä¸€ç§æœ‰è¶£çš„ç‰¹æ€§ï¼Œå®ƒä¸ºç³»ç»Ÿä¸­çš„æ¯ä¸ªå¤„ç†å™¨éƒ½åˆ†é…è‡ªèº«çš„å‰¯æœ¬ã€‚è¿™æ ·åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå½“å¤„ç†å™¨åªèƒ½è®¿é—®å±äºè‡ªå·±çš„é‚£ä¸ªå˜é‡å‰¯æœ¬æ—¶ï¼Œä¸éœ€è¦è€ƒè™‘ä¸å…¶ä»–å¤„ç†å™¨çš„ç«äº‰é—®é¢˜ï¼Œè¿˜èƒ½å……åˆ†åˆ©ç”¨å¤„ç†å™¨æœ¬åœ°çš„ç¡¬ä»¶ç¼“å­˜æ¥æå‡æ€§èƒ½ã€‚</p><h2 id="per-cpu-å˜é‡çš„å®šä¹‰å’Œå£°æ˜">Per-CPU å˜é‡çš„å®šä¹‰å’Œå£°æ˜</h2><p>Per-CPU å˜é‡çš„å®šä¹‰å’Œå£°æ˜æœ‰ä¸¤ç§æ–¹å¼ã€‚ä¸€ç§æ˜¯é™æ€å£°æ˜ï¼Œå¦ä¸€ç§æ˜¯åŠ¨æ€åˆ†é…ã€‚é™æ€çš„ Per-CPU å˜é‡å¯é€šè¿‡ DEFINE_PER_CPU å’Œ DECLARE_PER_CPU å®æ¥å®šä¹‰å’Œå£°æ˜ã€‚è¿™ç±»å˜é‡ä¸æ™®é€šå˜é‡çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬å­˜æ”¾åœ¨ä¸€ä¸ªç‰¹æ®Šçš„æ®µä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Variant on the per-CPU variable declaration/definition theme used for</span></span><br><span class="line"><span class="comment"> * ordinary per-CPU variables.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_PER_CPU(type, name)\</span></span><br><span class="line"><span class="meta">DECLARE_PER_CPU_SECTION(type, name, <span class="string">""</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_PER_CPU(type, name)\</span></span><br><span class="line"><span class="meta">DEFINE_PER_CPU_SECTION(type, name, <span class="string">""</span>)</span></span><br></pre></td></tr></tbody></table></figure><p>ç”¨äºåŠ¨æ€åˆ†é…å’Œé‡Šæ”¾ per-cpu å˜é‡çš„ API å‡½æ•°å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_percpu(type)\</span></span><br><span class="line"><span class="meta">(typeof(type) __percpu *)__alloc_percpu(sizeof(type),\</span></span><br><span class="line"><span class="meta">__alignof__(type))</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">free_percpu</span><span class="params">(<span class="type">void</span> __percpu *__pdata)</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="ä½¿ç”¨-per-cpu-å˜é‡">ä½¿ç”¨ Per-CPU å˜é‡</h2><p>å¯¹äºé™æ€å®šä¹‰çš„ Per-CPU å˜é‡ï¼Œå¯ä»¥é€šè¿‡ get_cpu_var() å’Œ put_cpu_var() å‡½æ•°æ¥è®¿é—®å’Œä¿®æ”¹ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å†…ç½®äº†å…³é—­å’Œæ‰“å¼€å†…æ ¸æŠ¢å çš„åŠŸèƒ½ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éœ€è¦é…å¯¹ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> get_cpu_var(var)\</span></span><br><span class="line"><span class="meta">(*({\</span></span><br><span class="line"><span class="meta">preempt_disable();\</span></span><br><span class="line"><span class="meta">this_cpu_ptr(&amp;var);\</span></span><br><span class="line"><span class="meta">}))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> put_cpu_var(var)\</span></span><br><span class="line"><span class="meta">do {\</span></span><br><span class="line"><span class="meta">(void)&amp;(var);\</span></span><br><span class="line"><span class="meta">preempt_enable();\</span></span><br><span class="line"><span class="meta">} while (0)</span></span><br></pre></td></tr></tbody></table></figure><p>å¯¹äºåŠ¨æ€åˆ†é…çš„ Per-CPU å˜é‡ï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹æ¥å£æ¥è®¿é—®ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> get_cpu_ptr(var)\</span></span><br><span class="line"><span class="meta">({\</span></span><br><span class="line"><span class="meta">preempt_disable();\</span></span><br><span class="line"><span class="meta">this_cpu_ptr(var);\</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> put_cpu_ptr(var)\</span></span><br><span class="line"><span class="meta">do {\</span></span><br><span class="line"><span class="meta">(void)(var);\</span></span><br><span class="line"><span class="meta">preempt_enable();\</span></span><br><span class="line"><span class="meta">} while (0)</span></span><br></pre></td></tr></tbody></table></figure><h1 id="tlb-å¤„ç†">TLB å¤„ç†</h1><h2 id="å•æ ¸å¤„ç†">å•æ ¸å¤„ç†</h2><p>åœ¨è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œéœ€è¦æœ‰ tlb çš„æ“ä½œï¼Œä»¥ä¾¿æ¸…é™¤æ—§è¿›ç¨‹çš„å½±å“ï¼Œå…·ä½“æ€æ ·åšå‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢ä¸€ä¸€è®¨è®ºã€‚</p><ul><li><p>ç»å¯¹æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½ä¸ä½³çš„æ–¹æ¡ˆï¼š æ‰€æœ‰ TLB å’Œ Cache çš„æ•°æ®éƒ½å…¨éƒ¨ flush æ‰ã€‚å½“ç„¶ï¼Œç¨å¾®æœ‰ä¸€ç‚¹é—æ†¾çš„å°±æ˜¯åœ¨ B è¿›ç¨‹å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼ŒTLB å’Œ Cache éƒ½æ˜¯å†°å†·çš„</p></li><li><p>å¦‚ä½•æé«˜ TLB çš„æ€§èƒ½ï¼š å¯¹äºæ‰€æœ‰çš„è¿›ç¨‹ï¼ˆåŒ…æ‹¬å†…æ ¸çº¿ç¨‹ï¼‰ï¼Œå†…æ ¸åœ°å€ç©ºé—´æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤å¯¹äºè¿™éƒ¨åˆ†åœ°å€ç¿»è¯‘ï¼Œæ— è®ºè¿›ç¨‹å¦‚ä½•åˆ‡æ¢ï¼Œå†…æ ¸åœ°å€ç©ºé—´è½¬æ¢åˆ°ç‰©ç†åœ°å€çš„å…³ç³»æ˜¯æ°¸è¿œä¸å˜çš„ï¼Œä¸éœ€è¦ flush TLBã€‚å¯¹äºç”¨æˆ·åœ°å€ç©ºé—´ï¼Œå„ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œåœ¨è¿›ç¨‹ A åˆ‡æ¢åˆ° B çš„æ—¶å€™ï¼ŒTLB ä¸­çš„å’Œ A è¿›ç¨‹ç›¸å…³çš„ entryï¼ˆä¸Šå›¾ä¸­ï¼Œé’è‰²çš„ blockï¼‰éœ€è¦ flush æ‰ æˆ‘ä»¬å…¶å®éœ€è¦åŒºåˆ† global å’Œ local è¿™ä¸¤ç§ç±»å‹çš„åœ°å€ç¿»è¯‘ï¼Œå› æ­¤ï¼Œåœ¨é¡µè¡¨æè¿°ç¬¦ä¸­å¾€å¾€æœ‰ä¸€ä¸ª bit æ¥æ ‡è¯†è¯¥åœ°å€ç¿»è¯‘æ˜¯ global è¿˜æ˜¯ local çš„ï¼ŒåŒæ ·çš„ï¼Œåœ¨ TLB ä¸­ï¼Œè¿™ä¸ªæ ‡è¯† global è¿˜æ˜¯ local çš„ flag ä¹Ÿä¼šè¢«ç¼“å­˜èµ·æ¥ã€‚æœ‰äº†è¿™æ ·çš„è®¾è®¡ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯è€Œ flush all æˆ–è€…åªæ˜¯ flush local tlb entry</p></li><li><p>ç‰¹æ®Šæƒ…å†µçš„è€ƒé‡ï¼š å¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œåˆ‡æ¢å¯èƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™ï¼Œçº¿ç¨‹åœ¨åŒæ ·çš„åœ°å€ç©ºé—´ï¼Œä¹Ÿæ ¹æœ¬ä¸éœ€è¦ flush tlb</p></li><li><p>è¿›ä¸€æ­¥æå‡ TLB çš„æ€§èƒ½ï¼š è¿™é‡Œæœ‰ä¸€ä¸ªæœ¯è¯­å«åš ASIDï¼ˆaddress space IDï¼‰ã€‚åŸæ¥ TLB æŸ¥æ‰¾æ˜¯é€šè¿‡è™šæ‹Ÿåœ°å€ VA æ¥åˆ¤æ–­æ˜¯å¦ TLB hitã€‚æœ‰äº† ASID çš„æ”¯æŒåï¼ŒTLB hit çš„åˆ¤æ–­æ ‡å‡†ä¿®æ”¹ä¸ºï¼ˆè™šæ‹Ÿåœ°å€ï¼‹ASIDï¼‰ï¼ŒASID æ˜¯æ¯ä¸€ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªï¼Œæ ‡è¯†è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚TLB block å¦‚ä½•çŸ¥é“ä¸€ä¸ª tlb entry çš„ ASID å‘¢ï¼Ÿä¸€èˆ¬ä¼šæ¥è‡ª CPU çš„ç³»ç»Ÿå¯„å­˜å™¨ï¼ˆå¯¹äº ARM64 å¹³å°ï¼Œå®ƒæ¥è‡ª TTBRx_EL1 å¯„å­˜å™¨ï¼‰ï¼Œè¿™æ ·åœ¨ TLB block åœ¨ç¼“å­˜ï¼ˆVA-PA-Global flagï¼‰çš„åŒæ—¶ï¼Œä¹Ÿå°±æŠŠå½“å‰çš„ ASID ç¼“å­˜åœ¨äº†å¯¹åº”çš„ TLB entry ä¸­ï¼Œè¿™æ ·ä¸€ä¸ª TLB entry ä¸­åŒ…æ‹¬äº†ï¼ˆVA-PA-Global flag-ASIDï¼‰</p></li></ul><h2 id="å¤šæ ¸å¤„ç†">å¤šæ ¸å¤„ç†</h2><p>åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼ŒTLB çš„æ“ä½œè¦å¤æ‚ä¸€äº›ï¼ŒåŸå› æ˜¯è¿›ç¨‹å¯ä»¥è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ª cpu core ä¸Šæ‰§è¡Œã€‚</p><p>æ ¹æ®ä¸Šä¸€èŠ‚çš„æè¿°ï¼Œæˆ‘ä»¬äº†è§£åˆ°åœ°å€ç¿»è¯‘æœ‰ globalï¼ˆå„ä¸ªè¿›ç¨‹å…±äº«ï¼‰å’Œ localï¼ˆè¿›ç¨‹ç‰¹å®šçš„ï¼‰çš„æ¦‚å¿µï¼Œå› è€Œ tlb entry ä¹Ÿæœ‰ global å’Œ local çš„åŒºåˆ†ã€‚å¦‚æœåŒºåˆ† global å’Œ localï¼Œé‚£ä¹ˆ tlb æ“ä½œä¹ŸåŸºæœ¬ç±»ä¼¼ï¼Œåªä¸è¿‡è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œä¸æ˜¯ flush è¯¥ cpu ä¸Šçš„æ‰€æœ‰ tlb entryï¼Œè€Œæ˜¯ flush æ‰€æœ‰çš„ tlb local entry å°± OK äº†ã€‚</p><p>å¯¹ local tlb entry è¿˜å¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†ï¼Œé‚£å°±æ˜¯ ASIDï¼ˆaddress space IDï¼‰æˆ–è€… PCIDï¼ˆprocess context IDï¼‰çš„æ¦‚å¿µäº†ï¼ˆglobal tlb entry ä¸åŒºåˆ† ASIDï¼‰ã€‚å¦‚æœæ”¯æŒ ASIDï¼ˆæˆ–è€… PCIDï¼‰çš„è¯ï¼Œtlb æ“ä½œå˜å¾—ç®€å•ä¸€äº›ï¼Œæˆ–è€…è¯´æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ‰§è¡Œ tlb æ“ä½œäº†ï¼Œå› ä¸ºåœ¨ TLB æœç´¢çš„æ—¶å€™å·²ç»å¯ä»¥åŒºåˆ†å„ä¸ª task ä¸Šä¸‹æ–‡äº†ï¼Œè¿™æ ·ï¼Œå„ä¸ª cpu ä¸­æ®‹ç•™çš„ tlb ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œã€‚</p><p>ä¸è¿‡ï¼Œå¯¹äºå¤šæ ¸ç³»ç»Ÿï¼Œè¿™ç§æƒ…å†µæœ‰ä¸€ç‚¹ç‚¹çš„éº»çƒ¦ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„ TLB shootdown å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œå¦‚æœ cpu æ”¯æŒ PCID å¹¶ä¸”åœ¨è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ä¸ flush tlbï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­å„ä¸ª cpu ä¸­çš„ tlb entry åˆ™ä¿ç•™å„ç§ task çš„ tlb entryï¼Œå½“åœ¨æŸä¸ª cpu ä¸Šï¼Œä¸€ä¸ªè¿›ç¨‹è¢«é”€æ¯ï¼Œæˆ–è€…ä¿®æ”¹äº†è‡ªå·±çš„é¡µè¡¨ï¼ˆä¹Ÿå°±æ˜¯ä¿®æ”¹äº† VA PA æ˜ å°„å…³ç³»ï¼‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¯¥ task çš„ç›¸å…³ tlb entry ä»ç³»ç»Ÿä¸­æ¸…é™¤å‡ºå»ã€‚è¿™æ—¶å€™ï¼Œä½ ä¸ä»…ä»…éœ€è¦ flush æœ¬ cpu ä¸Šå¯¹åº”çš„ TLB entryï¼Œè¿˜éœ€è¦ shootdown å…¶ä»– cpu ä¸Šçš„å’Œè¯¥ task ç›¸å…³çš„ tlb æ®‹ä½™ã€‚è€Œè¿™ä¸ªåŠ¨ä½œä¸€èˆ¬æ˜¯é€šè¿‡ IPI å®ç°ï¼ˆä¾‹å¦‚ X86ï¼‰ï¼Œä»è€Œå¼•å…¥äº†å¼€é”€ã€‚æ­¤å¤– PCID çš„åˆ†é…å’Œç®¡ç†ä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤ï¼ŒOS æ˜¯å¦æ”¯æŒ PCIDï¼ˆæˆ–è€… ASIDï¼‰æ˜¯ç”±å„ä¸ª arch ä»£ç è‡ªå·±å†³å®šã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹<br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcHJvY2Vzc19tYW5hZ2VtZW50L2NvbnRleHQtc3dpdGNoLXRsYi5odG1s">http://www.wowotech.net/process_management/context-switch-tlb.html<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆä¸‰ï¼‰CFS è°ƒåº¦å™¨</title>
      <link href="/2021/LinuxKernel/LinuxTaskCFS/"/>
      <url>/2021/LinuxKernel/LinuxTaskCFS/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskCFS.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM2OTgxMzBlM2U3NDA3NGNmMGU2NGU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="å…¬å¹³è°ƒåº¦æ€æƒ³çš„å¼•å…¥">å…¬å¹³è°ƒåº¦æ€æƒ³çš„å¼•å…¥</h1><h2 id="ä¼ ç»Ÿè°ƒåº¦å™¨æ—¶é—´ç‰‡æ‚–è®º">ä¼ ç»Ÿè°ƒåº¦å™¨æ—¶é—´ç‰‡æ‚–è®º</h2><p>åœ¨ Oï¼ˆnï¼‰å’Œ Oï¼ˆ1ï¼‰è°ƒåº¦å™¨ä¸­ï¼Œæ—¶é—´ç‰‡æ˜¯å›ºå®šåˆ†é…çš„ï¼Œé™æ€ä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹è·å–æ›´å¤§çš„ time sliceã€‚é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ä¼šè·å¾—æ›´å¤šçš„è¿ç»­æ‰§è¡Œçš„æœºä¼šï¼Œè¿™æ˜¯ CPU-bound è¿›ç¨‹æœŸæœ›çš„ï¼Œä½†æ˜¯å®é™…ä¸Šï¼ŒCPU-bound è¿›ç¨‹å¾€å¾€åœ¨åå°æ‰§è¡Œï¼Œå…¶ä¼˜å…ˆçº§éƒ½æ˜¯æ¯”è¾ƒä½çš„ã€‚</p><h2 id="rsdl-è°ƒåº¦å™¨">RSDL è°ƒåº¦å™¨</h2><p>RSDL è°ƒåº¦å™¨ä»ç„¶æ²¿ç”¨äº† Oï¼ˆ1ï¼‰è°ƒåº¦çš„æ•°æ®ç»“æ„å’Œè½¯ä»¶ç»“æ„ï¼Œå½“ç„¶åˆ é™¤äº†é‚£äº›ä»¤äººæ¯›éª¨æ‚šç„¶çš„è¯„ä¼°è¿›ç¨‹äº¤äº’æŒ‡æ•°çš„ä»£ç ã€‚æˆ‘ä»¬è¿™ä¸€å°èŠ‚ä¸å¯èƒ½è¯¦ç»†æè¿° RSDL ç®—æ³•ï¼Œä¸è¿‡åªè®²æ¸…æ¥š Rotatingã€Staircase å’Œ Deadline è¿™ä¸‰ä¸ªåŸºæœ¬æ¦‚å¿µã€‚</p><p>é¦–å…ˆçœ‹ Staircase æ¦‚å¿µï¼Œå®ƒæ›´è¯¦ç»†è¡¨è¿°åº”è¯¥æ˜¯ priority staircaseï¼Œå³åœ¨è¿›ç¨‹è°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œå…¶ä¼˜å…ˆçº§ä¼šåƒä¸‹æ¥¼æ¢¯é‚£æ ·ä¸€ç‚¹ç‚¹çš„é™ä½ã€‚åœ¨ä¼ ç»Ÿçš„è°ƒåº¦æ¦‚å¿µä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªå’Œå…¶é™æ€ä¼˜å…ˆçº§ç›¸åŒ¹é…çš„æ—¶é—´ç‰‡ï¼Œåœ¨ RSDL ä¸­ï¼ŒåŒæ ·ä¹Ÿå­˜åœ¨è¿™æ ·çš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯æ—¶é—´ç‰‡æ˜¯æ•£å¸ƒåœ¨å¾ˆå¤šä¼˜å…ˆçº§ä¸­ã€‚ä¾‹å¦‚å¦‚æœä¸€ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜¯ 120ï¼Œé‚£ä¹ˆæ•´ä¸ªæ—¶é—´ç‰‡æ•£å¸ƒåœ¨ 120ï½139 çš„ä¼˜å…ˆçº§ä¸­ï¼Œåœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œè¿›ç¨‹å¼€å§‹æ˜¯æŒ‚å…¥ 120 çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå¹¶åœ¨å…¶ä¸Šè¿è¡Œ 6msï¼Œä¸€æ—¦åœ¨ 120 çº§åˆ«çš„æ—¶é—´é…é¢ä½¿ç”¨å®Œæ¯•ä¹‹åï¼Œè¯¥è¿›ç¨‹ä¼šè½¬å…¥ 121 çš„é˜Ÿåˆ—ä¸­ï¼Œå‘ç”Ÿä¸€æ¬¡ Rotatingï¼Œæ›´å‡†ç¡®çš„è¯´æ˜¯ Priority minor rotatingã€‚ä¹‹åï¼Œè¯¥è¿›ç¨‹æ²¿é˜¶è€Œä¸‹ï¼Œç›´åˆ° 139 çš„ä¼˜å…ˆçº§ï¼Œåœ¨è¿™ä¸ªä¼˜å…ˆçº§ä¸Šå¦‚æœè€—å°½äº† 6ms çš„æ—¶é—´ç‰‡ï¼Œè¿™æ—¶å€™ï¼Œè¯¥è¿›ç¨‹æ‰€æœ‰çš„æ—¶é—´ç‰‡å°±éƒ½è€—å°½äº†ï¼Œå°±ä¼šè¢«æŒ‚å…¥åˆ° expired é˜Ÿåˆ—ä¸­å»ç­‰å¾…ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸã€‚è¿™æ¬¡ rotating è¢«ç§°ä¸º major rotatingã€‚å½“ç„¶ï¼Œè¿™æ—¶å€™è¯¥è¿›ç¨‹ä¼šæŒ‚å…¥å…¶é™æ€ä¼˜å…ˆçº§å¯¹åº”çš„ expired é˜Ÿåˆ—ï¼Œå³ä¸€åˆ‡åˆå›åˆ°äº†è°ƒåº¦çš„èµ·ç‚¹ã€‚</p><p>Deadline æ˜¯æŒ‡åœ¨ RSDL ç®—æ³•ä¸­ï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å‡†ç¡®çš„é¢„ä¼°å…¶è°ƒåº¦å»¶è¿Ÿã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾ runqueue ä¸­æœ‰ä¸¤ä¸ª taskï¼Œé™æ€ä¼˜å…ˆçº§åˆ†åˆ«æ˜¯ 130 çš„ A è¿›ç¨‹å’Œ 139 çš„ B è¿›ç¨‹ã€‚å¯¹äº A è¿›ç¨‹ï¼Œåªæœ‰åœ¨è¿›ç¨‹æ²¿ç€ä¼˜å…ˆçº§æ¥¼æ¢¯ä» 130 èµ°åˆ° 139 çš„æ—¶å€™ï¼ŒB è¿›ç¨‹æ‰æœ‰æœºä¼šæ‰§è¡Œï¼Œå…¶è°ƒåº¦å»¶è¿Ÿæ˜¯ 9 x 6ms ï¼ 54msã€‚</p><p>å¤šä¹ˆç®€æ´çš„ç®—æ³•ï¼Œåªéœ€è¦ç»´æŒå…¬å¹³ï¼Œæ²¡æœ‰å¯¹è¿›ç¨‹ç¡çœ /è¿è¡Œæ—¶é—´çš„ç»Ÿè®¡ï¼Œæ²¡æœ‰å¯¹ç”¨æˆ·äº¤äº’æŒ‡æ•°çš„è®¡ç®—ï¼Œæ²¡æœ‰é‚£äº›å¥‡å¥‡æ€ªæ€ªçš„å¸¸æ•°â€¦â€¦è°ƒåº¦ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚</p><h1 id="cfs-è°ƒåº¦å™¨">CFS è°ƒåº¦å™¨</h1><p>Con Kolivas çš„ RSDL è°ƒåº¦å™¨å§‹ç»ˆæ²¡æœ‰èƒ½å¤Ÿè¿›å…¥ kernel mainlineï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åŒæ ·åŸºäºå…¬å¹³è°ƒåº¦æ€æƒ³çš„ CFS è°ƒåº¦å™¨ï¼Œåœ¨ CFS è°ƒåº¦å™¨å¹¶å…¥ä¸»çº¿çš„åŒæ—¶ï¼Œä»ç„¶æä¾›äº†æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œä¸º RSDL æˆ–è€…å…¶ä»–çš„è°ƒåº¦å™¨å¯ä»¥è¿›å…¥å†…æ ¸æä¾›äº†æ–¹ä¾¿ã€‚æœ¬ç« æˆ‘ä»¬å”¯ä¸€éœ€è¦æè¿°çš„æ˜¯ Ingo Molnar å¦‚ä½•æŠŠå®Œå…¨å…¬å¹³è°ƒåº¦çš„ç†æƒ³ç…§è¿›ç°å®ã€‚</p><h2 id="æ¨¡å—åŒ–æ€æƒ³çš„å¼•å…¥">æ¨¡å—åŒ–æ€æƒ³çš„å¼•å…¥</h2><p>ä» 2.6.23 å†…æ ¸å¼€å§‹ï¼Œè°ƒåº¦å™¨é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡çš„æ€æƒ³ï¼Œä»è€ŒæŠŠè¿›ç¨‹è°ƒåº¦çš„è½¯ä»¶åˆ†æˆäº†ä¸¤ä¸ªå±‚æ¬¡ï¼Œä¸€ä¸ªæ˜¯ core scheduler layerï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ specific scheduler layerï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/scheduler_layer.png"></p><p>ä»åŠŸèƒ½å±‚é¢ä¸Šçœ‹ï¼Œè¿›ç¨‹è°ƒåº¦ä»ç„¶åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯é€šè¿‡è´Ÿè½½å‡è¡¡æ¨¡å—å°†å„ä¸ª runnable task æ ¹æ®è´Ÿè½½æƒ…å†µå¹³å‡åˆ†é…åˆ°å„ä¸ª CPU runqueue ä¸Šå»ã€‚ç¬¬äºŒéƒ¨åˆ†çš„åŠŸèƒ½æ˜¯åœ¨å„ä¸ª CPU çš„ Main scheduler å’Œ Tick scheduler çš„é©±åŠ¨ä¸‹è¿›è¡Œå•ä¸ª CPU ä¸Šçš„è°ƒåº¦ã€‚</p><h2 id="æ—¶é—´ç²’åº¦">æ—¶é—´ç²’åº¦</h2><p>Linux å†…æ ¸çš„ CFS è°ƒåº¦å™¨å·²ç»æ‘’å¼ƒäº†ä¼ ç»Ÿçš„å›ºå®šæ—¶é—´ç‰‡çš„æ¦‚å¿µäº†ï¼ŒOï¼ˆ1ï¼‰è°ƒåº¦å™¨ä¼šä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªç¼ºçœçš„æ—¶é—´ç‰‡ã€‚CFS è°ƒåº¦å™¨æ²¡æœ‰ä¼ ç»Ÿçš„é™æ€æ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œå¥¹çš„æ—¶é—´ç‰‡æ˜¯åŠ¨æ€çš„ï¼Œå’Œå½“å‰ CPU çš„å¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹ä»¥åŠå®ƒä»¬çš„ä¼˜å…ˆçº§ç›¸å…³ï¼Œå› æ­¤ CFS è°ƒåº¦å™¨ä¸­ï¼Œæ—¶é—´ç‰‡æ˜¯åŠ¨æ€å˜åŒ–çš„ã€‚</p><p>CFS è°ƒåº¦å™¨æ˜¯æœ‰ä¸€ä¸ªæ—¶é—´ç²’åº¦çš„å®šä¹‰ï¼Œæˆ‘ä»¬ç§°ä¹‹è°ƒåº¦å‘¨æœŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸå†…ï¼ŒCFS è°ƒåº¦å™¨å¯ä»¥ä¿è¯æ‰€æœ‰çš„å¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹å¹³å‡åˆ†é… CPU æ—¶é—´ã€‚</p><h2 id="å¦‚ä½•ä¿è¯æœ‰ç•Œçš„è°ƒåº¦å»¶è¿Ÿ">å¦‚ä½•ä¿è¯æœ‰ç•Œçš„è°ƒåº¦å»¶è¿Ÿï¼Ÿ</h2><p>ä¼ ç»Ÿçš„è°ƒåº¦å™¨æ— æ³•ä¿è¯è°ƒåº¦å»¶è¿Ÿï¼Œä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜æˆ‘ä»¬è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šCPU runqueue ä¸­æœ‰ä¸¤ä¸ª nice value ç­‰äº 0 çš„ runnable è¿›ç¨‹ A å’Œ Bï¼Œä¼ ç»Ÿè°ƒåº¦å™¨ä¼šä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªå›ºå®šçš„æ—¶é—´ç‰‡ 100msï¼Œè¿™æ—¶å€™ A å…ˆè¿è¡Œï¼Œç›´åˆ° 100ms çš„æ—¶é—´ç‰‡è€—å°½ï¼Œç„¶å B è¿è¡Œã€‚è¿™ä¸¤ä¸ªè¿›ç¨‹ä¼šäº¤æ›¿è¿è¡Œï¼Œè°ƒåº¦å»¶è¿Ÿå°±æ˜¯ 100msã€‚éšç€ç³»ç»Ÿè´Ÿè·çš„åŠ é‡ï¼Œä¾‹å¦‚åˆæœ‰ä¸¤ä¸ªä¸¤ä¸ª nice value ç­‰äº 0 çš„ runnable è¿›ç¨‹ C å’Œ D æŒ‚å…¥ runqueueï¼Œè¿™æ—¶å€™ï¼ŒAã€Bã€Cã€D äº¤æ›¿è¿è¡Œï¼Œè°ƒåº¦å»¶è¿Ÿå°±æ˜¯ 300msã€‚å› æ­¤ï¼Œä¼ ç»Ÿè°ƒåº¦å™¨çš„è°ƒåº¦å»¶è¿Ÿæ˜¯å’Œç³»ç»Ÿè´Ÿè½½ç›¸å…³çš„ï¼Œå½“ç³»ç»Ÿè´Ÿè½½å¢åŠ çš„æ—¶å€™ï¼Œç”¨æˆ·æ›´å®¹æ˜“è§‚å¯Ÿåˆ°å¡é¡¿ç°è±¡ã€‚</p><p>CFS è°ƒåº¦å™¨è®¾è®¡ä¹‹åˆå°±ç¡®å®šäº†è°ƒåº¦å»¶è¿Ÿçš„å‚æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ targeted latencyï¼Œè¿™ä¸ªæ¦‚å¿µç±»ä¼¼ä¼ ç»Ÿè°ƒåº¦å™¨ä¸­çš„è°ƒåº¦å‘¨æœŸçš„æ¦‚å¿µï¼Œåªä¸è¿‡åœ¨è¿‡å»ï¼Œä¸€ä¸ªè°ƒåº¦å‘¨æœŸä¸­çš„æ—¶é—´ç‰‡è¢«å›ºå®šåˆ†é…ç»™äº† runnable çš„è¿›ç¨‹ï¼Œè€Œåœ¨ CFS ä¸­ï¼Œè°ƒåº¦å™¨ä¼šä¸æ–­çš„æ£€æŸ¥åœ¨ä¸€ä¸ª targeted latency ä¸­ï¼Œå…¬å¹³æ€§æ˜¯å¦å¾—åˆ°äº†ä¿è¯ã€‚ä¸‹é¢çš„ä»£ç è¯´æ˜äº† targeted latency çš„è®¡ç®—è¿‡ç¨‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u64 __sched_period(<span class="type">unsigned</span> <span class="type">long</span> nr_running)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (unlikely(nr_running &gt; sched_nr_latency))</span><br><span class="line">    <span class="keyword">return</span> nr_running * sysctl_sched_min_granularity;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> sysctl_sched_latency;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ runqueue ä¸­çš„ runnable è¿›ç¨‹çš„æ•°ç›®å°äº sched_nr_latencyï¼ˆ8 ä¸ªï¼‰çš„æ—¶å€™ï¼Œtargeted latency å°±æ˜¯ sysctl_sched_latencyï¼ˆ6msï¼‰ï¼Œå½“ runqueue ä¸­çš„ runnable è¿›ç¨‹çš„æ•°ç›®å¤§äºç­‰äº sched_nr_latency çš„æ—¶å€™ï¼Œtargeted latency ç­‰äº runnable è¿›ç¨‹æ•°ç›®ä¹˜ä»¥ sysctl_sched_min_granularityï¼ˆ0.75msï¼‰ã€‚æ˜¾ç„¶ sysctl_sched_min_granularity è¿™ä¸ªå‚æ•°å°±æ˜¯ä¸€æ®µä¸€ä¸ªè¿›ç¨‹è¢«è°ƒåº¦æ‰§è¡Œï¼Œå®ƒéœ€è¦è‡³å°‘æ‰§è¡Œçš„æ—¶é—´ç‰‡å¤§å°ï¼Œè®¾ç«‹è¿™ä¸ªå‚æ•°æ˜¯ä¸ºäº†é˜²æ­¢ overscheduling è€Œäº§ç”Ÿçš„æ€§èƒ½ä¸‹é™ã€‚</p><p>CFS è°ƒåº¦å™¨ä¿è¯äº†åœ¨ä¸€ä¸ª targeted latency ä¸­ï¼Œæ‰€æœ‰çš„ runnable è¿›ç¨‹éƒ½ä¼šè‡³å°‘æ‰§è¡Œä¸€æ¬¡ï¼Œä»è€Œä¿è¯äº†æœ‰ç•Œçš„ã€å¯é¢„æµ‹çš„è°ƒåº¦å»¶è¿Ÿã€‚</p><h2 id="ä¸ºä½•å¼•å…¥è™šæ‹Ÿæ—¶é—´">ä¸ºä½•å¼•å…¥è™šæ‹Ÿæ—¶é—´ï¼Ÿ</h2><p>è™½ç„¶ Con Kolivas æå‡ºäº†ç²¾é‡‡ç»ä¼¦çš„è®¾è®¡æ€æƒ³ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°çš„æ—¶å€™ç›¸å¯¹ä¿å®ˆã€‚CFS è°ƒåº¦å™¨åˆ™ä¸ç„¶ï¼Œå®ƒé‡‡ç”¨äº†ç›¸å¯¹æ¿€è¿›çš„æ–¹æ³•ï¼ŒæŠŠ runqueue ä¸­ç®¡ç† task çš„ä¼˜å…ˆçº§é“¾è¡¨å˜æˆäº†çº¢é»‘æ ‘ç»“æ„ã€‚æœ‰äº†è¿™æ ·ä¸€é¢— runnable è¿›ç¨‹çš„çº¢é»‘æ ‘ï¼Œåœ¨æ’å…¥æ“ä½œçš„æ—¶å€™å¦‚ä½•ç¡®å®šè¿›ç¨‹åœ¨çº¢é»‘æ ‘ä¸­çš„ä½ç½®ï¼Ÿä¹Ÿå°±æ˜¯è¯´è¿™æ£µæ ‘çš„â€œkeyâ€æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>CFS çš„çº¢é»‘æ ‘ä½¿ç”¨ vruntimeï¼ˆvirtual runtimeï¼‰ä½œä¸º keyï¼Œä¸ºäº†ç†è§£ vruntimeï¼Œè¿™é‡Œéœ€è¦å¼•å…¥ä¸€ä¸ªè™šæ‹Ÿæ—¶é—´è½´çš„æ¦‚å¿µã€‚åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ¸…æ¥šçš„è¡¨è¿°äº†å…¬å¹³çš„å«ä¹‰ï¼šæŒ‰ç…§è¿›ç¨‹çš„é™æ€ä¼˜å…ˆçº§æ¥åˆ†é… CPU èµ„æºï¼Œå½“ç„¶ï¼ŒCPU èµ„æºä¹Ÿå°±æ˜¯ CPU çš„æ—¶é—´ç‰‡ï¼Œå› æ­¤åœ¨ç‰©ç†ä¸–ç•Œä¸­ï¼Œå…¬å¹³å°±æ˜¯åˆ†é…å’Œé™æ€ä¼˜å…ˆçº§åŒ¹é…çš„ CPU æ—¶é—´ç‰‡ã€‚ä½†æ˜¯çº¢é»‘æ ‘éœ€è¦ä¸€ä¸ªå•ä¸€æ•°è½´ä¸Šçš„é‡è¿›è¡Œæ¯”å¯¹ï¼Œè€Œè¿™é‡Œæœ‰ä¸¤ä¸ªåº¦é‡å› ç´ ï¼šé™æ€ä¼˜å…ˆçº§å’Œç‰©ç†æ—¶é—´ç‰‡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬æ˜ å°„åˆ°ä¸€ä¸ªè™šæ‹Ÿçš„æ—¶é—´è½´ä¸Šï¼Œå±è”½æ‰é™æ€ä¼˜å…ˆçº§çš„å½±å“ï¼š</p><h2 id="å¦‚ä½•è®¡ç®—-virtual-runtime">å¦‚ä½•è®¡ç®— virtual runtime</h2><p>å…·ä½“çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[Virtual runtime ï¼ ï¼ˆphysical runtimeï¼‰ * ï¼ˆnice value 0 çš„æƒé‡ï¼‰/ å½“å‰çº¿ç¨‹çš„æƒé‡\]</span></p><p>ä¸ºäº†è®¡ç®—æ–¹ä¾¿ï¼ŒLinux å†…æ ¸çº¦å®š nice å€¼ 0 å¯¹åº”çš„æƒå€¼ä¸º 1024ï¼Œå…¶ä»– nice å€¼å¯¹åº”çš„æƒé‡å€¼å¯ä»¥é€šè¿‡æŸ¥è¡¨çš„æ–¹å¼æ¥è·å–ã€‚å†…æ ¸é¢„å…ˆè®¡ç®—å¥½äº† sched_prio_to_weight[40]ï¼Œè¡¨çš„ä¸‹æ ‡å¯¹åº” nice å€¼ã€‚CFS è°ƒåº¦å™¨è§„å®š nice å€¼ä¸º 0 çš„è¿›ç¨‹å…·æœ‰åŸºå‡†æƒé‡ï¼Œå¹¶ä¸”å…¶å€¼æ¯å¢åŠ  1 åˆ™å‡å°‘ 10%çš„ CPU æƒé‡ï¼Œæ¯å‡å°‘ 1 åˆ™å¢åŠ  10%çš„ CPU æƒé‡ï¼ˆ1024-1024*20% = 820ï¼‰ã€‚å…¶ä¸­çº¿ç¨‹çš„æƒé‡å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> sched_prio_to_weight[<span class="number">40</span>] = {</span><br><span class="line">    <span class="comment">/* -20 */</span>     <span class="number">88761</span>,     <span class="number">71755</span>,     <span class="number">56483</span>,     <span class="number">46273</span>,     <span class="number">36291</span>,</span><br><span class="line">    <span class="comment">/* -15 */</span>     <span class="number">29154</span>,     <span class="number">23254</span>,     <span class="number">18705</span>,     <span class="number">14949</span>,     <span class="number">11916</span>,</span><br><span class="line">    <span class="comment">/* -10 */</span>      <span class="number">9548</span>,      <span class="number">7620</span>,      <span class="number">6100</span>,      <span class="number">4904</span>,      <span class="number">3906</span>,</span><br><span class="line">    <span class="comment">/*  -5 */</span>      <span class="number">3121</span>,      <span class="number">2501</span>,      <span class="number">1991</span>,      <span class="number">1586</span>,      <span class="number">1277</span>,</span><br><span class="line">    <span class="comment">/*   0 */</span>      <span class="number">1024</span>,       <span class="number">820</span>,       <span class="number">655</span>,       <span class="number">526</span>,       <span class="number">423</span>,</span><br><span class="line">    <span class="comment">/*   5 */</span>       <span class="number">335</span>,       <span class="number">272</span>,       <span class="number">215</span>,       <span class="number">172</span>,       <span class="number">137</span>,</span><br><span class="line">    <span class="comment">/*  10 */</span>       <span class="number">110</span>,        <span class="number">87</span>,        <span class="number">70</span>,        <span class="number">56</span>,        <span class="number">45</span>,</span><br><span class="line">    <span class="comment">/*  15 */</span>        <span class="number">36</span>,        <span class="number">29</span>,        <span class="number">23</span>,        <span class="number">18</span>,        <span class="number">15</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ä¸Šé¢çš„å…¬å¼ï¼Œæˆ‘ä»¬æ„é€ äº†ä¸€ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œã€‚äºŒç»´çš„ï¼ˆload weightï¼Œphysical runtimeï¼‰ç‰©ç†ä¸–ç•Œå˜æˆäº†ä¸€ç»´çš„ virtual runtime çš„è™šæ‹Ÿä¸–ç•Œã€‚åœ¨è¿™ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œä¸­ï¼Œå„ä¸ªè¿›ç¨‹çš„ vruntime å¯ä»¥æ¯”è¾ƒå¤§å°ï¼Œä»¥ä¾¿ç¡®å®šå…¶åœ¨çº¢é»‘æ ‘ä¸­çš„ä½ç½®ï¼Œè€Œ CFS è°ƒåº¦å™¨çš„å…¬å¹³ä¹Ÿå°±æ˜¯ç»´æŠ¤è™šæ‹Ÿä¸–ç•Œ vruntime çš„å…¬å¹³ï¼Œå³å„ä¸ªè¿›ç¨‹çš„ vruntime æ˜¯ç›¸ç­‰çš„ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šå®é™…ä¸Šå¯¹äºé™æ€ä¼˜å…ˆçº§æ˜¯ 120ï¼ˆå³ nice value ç­‰äº 0ï¼‰çš„è¿›ç¨‹ï¼Œå…¶ç‰©ç†æ—¶é—´è½´ç­‰äºè™šæ‹Ÿæ—¶é—´è½´ï¼Œè€Œå…¶ä»–çš„é™æ€ä¼˜å…ˆçº§çš„è™šæ‹Ÿæ—¶é—´éƒ½æ˜¯æ ¹æ®å…¶æƒé‡å’Œ nice 0 çš„æƒé‡è¿›è¡Œå°ºåº¦ç¼©æ”¾ã€‚å¯¹äºæ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼Œå…¶è™šæ‹Ÿæ—¶é—´è½´è¿‡çš„æ¯”è¾ƒæ…¢ï¼Œè€Œå¯¹äºä¼˜å…ˆçº§æ¯”è¾ƒä½çš„è¿›ç¨‹ï¼Œå…¶è™šæ‹Ÿæ—¶é—´è½´è¿‡çš„æ¯”è¾ƒå¿«ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/vruntime.png"></p><p>åœ¨è¿›è¡Œè¿›ç¨‹è°ƒåº¦æ—¶å€™ï¼Œè°ƒåº¦å™¨éœ€è¦é€‰æ‹©ä¸‹ä¸€ä¸ªå ç”¨ CPU èµ„æºçš„é‚£ä¸ª next threadã€‚å¯¹äº CFS è€Œè¨€ï¼Œå…¶ç®—æ³•å°±æ˜¯ä»çº¢é»‘æ ‘ä¸­æ‰¾åˆ° left most çš„é‚£ä¸ª task å¹¶è°ƒåº¦å…¶è¿è¡Œã€‚è¿™æ—¶å€™ï¼Œå¤±å» CPU æ‰§è¡Œæƒçš„é‚£ä¸ª task ä¼šè¢«é‡æ–°æ’å…¥çº¢é»‘æ ‘ï¼Œå…¶åœ¨çº¢é»‘æ ‘ä¸­çš„ä½ç½®æ˜¯ç”± task çš„ vruntime å€¼å†³å®šçš„ã€‚</p><h1 id="è¿›ç¨‹åˆ‡æ¢">è¿›ç¨‹åˆ‡æ¢</h1><h2 id="è°ƒåº¦æ—¶æœº">è°ƒåº¦æ—¶æœº</h2><p>å†…æ ¸ä¸­å®ç°è°ƒåº¦çš„ç»Ÿä¸€ç­–ç•¥æ˜¯ï¼šæ£€æŸ¥è¿›ç¨‹æ˜¯å¦éœ€è¦è°ƒåº¦å’Œå®é™…çš„è°ƒåº¦è¡Œä¸ºæ˜¯åˆ†ç¦»çš„ï¼Œæ¯”å¦‚åœ¨ tick ä¸­æ–­æˆ–è€…å”¤é†’è¿›ç¨‹æ—¶æ£€æŸ¥åˆ°å­˜åœ¨é«˜ä¼˜å…ˆçº§è¿›ç¨‹å¯ä»¥æŠ¢å å½“å‰æ‰§è¡Œè¿›ç¨‹ï¼Œæ­¤æ—¶åªæ˜¯è®¾ç½®æŠ¢å æ ‡å¿— (TIF_NEED_RESCHED)ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹å†æ‰§è¡Œè°ƒåº¦è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰§è¡Œè°ƒåº¦ã€‚æ¯•ç«Ÿåœ¨ä¸­æ–­ä¸­æ˜¯ç»å¯¹ä¸èƒ½ç›´æ¥æ‰§è¡Œè°ƒåº¦çš„ã€‚schedule()ï¼ˆè°ƒç”¨__schedule()ï¼‰æ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒå‡½æ•°ï¼Œä½œç”¨æ˜¯è®©è°ƒåº¦å™¨é€‰æ‹©å’Œåˆ‡æ¢åˆ°ä¸€ä¸ªåˆé€‚çš„è¿›ç¨‹å¹¶è¿è¡Œã€‚è°ƒåº¦çš„æ—¶æœºå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ 3 ç§ã€‚</p><ul><li>é˜»å¡æ“ä½œï¼šæ¯”å¦‚äº’æ–¥é‡ï¼ˆmutexï¼‰ã€ä¿¡å·é‡ï¼ˆsemaphoreï¼‰ã€ç­‰å¾…é˜Ÿåˆ—ï¼ˆwait queueï¼‰sleep ç­‰ã€‚</li><li>åœ¨ä¸­æ–­è¿”å›å‰å’Œç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼Œæ£€æŸ¥ TIF_NEED_RESCHED æ ‡å¿—åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒåº¦ã€‚</li><li>å°†è¦è¢«å”¤é†’çš„è¿›ç¨‹ä¸ä¼šé©¬ä¸Šè°ƒç”¨ schedule()ï¼Œè€Œæ˜¯ä¼šè¢«æ·»åŠ åˆ° CFS å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”è®¾ç½® TIF_NEED_RESCHED æ ‡å¿—ä½ã€‚é‚£ä¹ˆè¢«å”¤é†’çš„è¿›ç¨‹ä»€ä¹ˆæ—¶å€™è¢«è°ƒåº¦å‘¢ï¼Ÿè¿™è¦æ ¹æ®å†…æ ¸æ˜¯å¦å…·æœ‰å¯æŠ¢å åŠŸèƒ½ï¼ˆCONFIG_PREEMPT=yï¼‰åˆ†ä¸¤ç§æƒ…å†µï¼š<ul><li>å†…æ ¸å¯æŠ¢å <ul><li>å¦‚æœå”¤é†’åŠ¨ä½œå‘ç”Ÿåœ¨ç³»ç»Ÿè°ƒç”¨æˆ–è€…å¼‚å¸¸å¤„ç†ä¸Šä¸‹æ–‡ä¸­ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ preempt_enable() æ—¶ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å è°ƒåº¦</li><li>å¦‚æœå”¤é†’åŠ¨ä½œå‘ç”Ÿåœ¨ç¡¬ä¸­æ–­å¤„ç†ä¸Šä¸‹æ–‡ä¸­ï¼Œé‚£ä¹ˆåœ¨ç¡¬ä»¶ä¸­æ–­å¤„ç†è¿”å›å‰ä¼šæ£€æŸ¥æ˜¯å¦è¦æŠ¢å å½“å‰è¿›ç¨‹</li></ul></li><li>å†…æ ¸ä¸å¯æŠ¢å <ul><li>å½“å‰è¿›ç¨‹è°ƒç”¨ cond_resched æ—¶ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒåº¦</li><li>ä¸»åŠ¨è°ƒç”¨ schedule()</li><li>ç³»ç»Ÿè°ƒç”¨æˆ–è€…å¼‚å¸¸å¤„ç†å®Œåè¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li><li>ä¸­æ–­å¤„ç†å®Œæˆåè¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li></ul></li></ul></li></ul><p>å‰æ–‡æåˆ°çš„ç¡¬ä»¶ä¸­æ–­è¿”å›å‰å’Œç¡¬ä»¶ä¸­æ–­è¿”å›ç”¨æˆ·ç©ºé—´å‰æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚å‰è€…åœ¨æ¯æ¬¡ç¡¬ä»¶ä¸­æ–­è¿”å›å‰éƒ½ä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹éœ€è¦è¢«æŠ¢å è°ƒåº¦ï¼Œè€Œä¸ç®¡ä¸­æ–­å‘ç”Ÿç‚¹æ˜¯åœ¨å†…æ ¸ç©ºé—´è¿˜æ˜¯ç”¨æˆ·ç©ºé—´ï¼›åè€…ä»…å½“ä¸­æ–­å‘ç”Ÿç‚¹åœ¨ç”¨æˆ·ç©ºé—´æ—¶æ‰ä¼šæ£€æŸ¥ã€‚</p><p>åœ¨ Linux å†…æ ¸é‡Œï¼Œschedule() æ˜¯å†…éƒ¨ä½¿ç”¨çš„æ¥å£å‡½æ•°ï¼Œæœ‰ä¸å°‘å…¶ä»–å‡½æ•°ä¼šç›´æ¥è°ƒç”¨è¯¥å‡½æ•°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œschedule() å‡½æ•°è¿˜æœ‰ä¸å°‘å˜ç§ã€‚</p><ul><li>preempt_schedule() ç”¨äºå¯æŠ¢å å†…æ ¸çš„è°ƒåº¦ã€‚</li><li>preempt_schedule_irq() ç”¨äºå¯æŠ¢å å†…æ ¸çš„è°ƒåº¦ï¼Œåœ¨ä¸­æ–­ç»“æŸè¿”å›æ—¶ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚</li><li>schedule_timeoutï¼ˆsigned long timeoutï¼‰ï¼Œè¿›ç¨‹ç¡çœ åˆ° timeout æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ä¸ºæ­¢ã€‚ schedule() å‡½æ•°çš„æ ¸å¿ƒä»£ç ç‰‡æ®µå¦‚ä¸‹ã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage __visible <span class="type">void</span> __sched <span class="title function_">schedule</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> =</span> current;</span><br><span class="line"></span><br><span class="line">sched_submit_work(tsk);</span><br><span class="line"><span class="keyword">do</span> {</span><br><span class="line">preempt_disable();</span><br><span class="line">__schedule(SM_NONE);</span><br><span class="line">sched_preempt_enable_no_resched();</span><br><span class="line">} <span class="keyword">while</span> (need_resched());</span><br><span class="line">sched_update_worker(tsk);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(schedule);</span><br></pre></td></tr></tbody></table></figure><h2 id="è¿›ç¨‹åˆ‡æ¢-1">è¿›ç¨‹åˆ‡æ¢</h2><p>æ“ä½œç³»ç»Ÿä¼šæŠŠå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æŒ‚èµ·å¹¶ä¸”æ¢å¤ä»¥å‰æŒ‚èµ·çš„æŸä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢æˆ–è€…ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚Linux å†…æ ¸å®ç°è¿›ç¨‹åˆ‡æ¢çš„æ ¸å¿ƒå‡½æ•°æ˜¯ context_switch() æ¯ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å±äºè‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œä½†æ˜¯æ‰€æœ‰è¿›ç¨‹éƒ½å¿…é¡»å…±äº« CPU çš„å¯„å­˜å™¨ç­‰èµ„æºã€‚æ‰€ä»¥ï¼Œåœ¨åˆ‡æ¢è¿›ç¨‹æ—¶å¿…é¡»æŠŠ next è¿›ç¨‹åœ¨ä¸Šä¸€æ¬¡æŒ‚èµ·æ—¶ä¿å­˜çš„å¯„å­˜å™¨å€¼é‡æ–°è£…è½½åˆ° CPU é‡Œã€‚åœ¨è¿›ç¨‹æ¢å¤æ‰§è¡Œå‰å¿…é¡»è£…å…¥ CPU å¯„å­˜å™¨çš„æ•°æ®ï¼Œåˆ™ç§°ä¸ºç¡¬ä»¶ä¸Šä¸‹æ–‡ã€‚è¿›ç¨‹çš„åˆ‡æ‰§å¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹ä¸¤æ­¥ã€‚</p><ul><li>åˆ‡æ¢è¿›ç¨‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯åˆ‡æ¢ next è¿›ç¨‹çš„é¡µè¡¨åˆ°ç¡¬ä»¶é¡µè¡¨ä¸­ï¼Œè¿™æ˜¯ switch_mm() å‡½æ•°å®ç°çš„ã€‚</li><li>åˆ‡æ¢åˆ° next è¿›ç¨‹çš„å†…æ ¸æ€æ ˆå’Œç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼Œè¿™æ˜¯ç”± switch_to() å‡½æ•°å®ç°çš„ã€‚ç¡¬ä»¶ä¸Šä¸‹æ–‡æä¾›äº†å†…æ ¸æ‰§è¡Œ next è¿›ç¨‹æ‰€éœ€è¦çš„æ‰€æœ‰ç¡¬ä»¶ä¿¡æ¯ã€‚</li></ul><h4 id="switch_mm-å‡½æ•°">switch_mm() å‡½æ•°</h4><p>switch_mm() å‡½æ•°å®è´¨ä¸Šæ˜¯æŠŠæ–°è¿›ç¨‹çš„é¡µè¡¨åŸºåœ°å€è®¾ç½®åˆ°é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ã€‚å¯¹äº ARM64 å¤„ç†å™¨ï¼Œswitch_mm() å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯å®Œæˆ ARM æ¶æ„ç›¸å…³çš„ç¡¬ä»¶è®¾ç½®ï¼Œä¾‹å¦‚åˆ·æ–° TLB ä»¥åŠè®¾ç½®ç¡¬ä»¶é¡µè¡¨ç­‰ã€‚</p><p>åœ¨è¿è¡Œè¿›ç¨‹æ—¶ï¼Œé™¤äº†é«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ä¼šç¼“å­˜è¿›ç¨‹çš„æ•°æ®å¤–ï¼ŒMMU å†…éƒ¨è¿˜æœ‰å«ä½œ TLBï¼ˆTranslation Lookaside Bufferï¼Œå¿«è¡¨ï¼‰çš„ç¡¬ä»¶å•å…ƒï¼ŒTLB ä¼šä¸ºäº†åŠ å¿«è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢é€Ÿåº¦è€Œå°†éƒ¨åˆ†é¡µè¡¨é¡¹å†…å®¹ç¼“å­˜èµ·æ¥ï¼Œé¿å…é¢‘ç¹è®¿é—®é¡µè¡¨ã€‚å› æ­¤åˆšåˆ‡æ¢å®Œè¿›ç¨‹æ—¶ä¼šå‡ºç°å¾ˆä¸¥é‡çš„ TLB æœªå‘½ä¸­å’Œé«˜é€Ÿç¼“å­˜æœªå‘½ä¸­ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ã€‚</p><p>å¦‚ä½•æé«˜ TLB çš„æ€§èƒ½ï¼Ÿè¿™æ˜¯æœ€è¿‘å‡ åå¹´æ¥èŠ¯ç‰‡è®¾è®¡äººå‘˜å’Œæ“ä½œç³»ç»Ÿè®¾è®¡äººå‘˜å…±åŒåŠªåŠ›çš„æ–¹å‘ã€‚ä» Linux å†…æ ¸è§’åº¦çœ‹ï¼Œåœ°å€ç©ºé—´å¯ä»¥åˆ’åˆ†ä¸ºå†…æ ¸åœ°å€ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼›å¯¹äº TLB æ¥è¯´ï¼Œå¯ä»¥åˆ’åˆ†æˆå…¨å±€ï¼ˆglobalï¼‰ç±»å‹å’Œè¿›ç¨‹ç‹¬æœ‰ï¼ˆprocess-specificï¼‰ç±»å‹ã€‚</p><ul><li>å…¨å±€ç±»å‹çš„ TLBï¼šå†…æ ¸ç©ºé—´æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ç©ºé—´ï¼Œå› æ­¤è¿™éƒ¨åˆ†ç©ºé—´çš„è™šæ‹Ÿåœ°å€è‡³ç‰©ç†åœ°å€çš„ç¿»è¯‘æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œå¯ä»¥ç†è§£ä¸ºå…¨å±€çš„ã€‚</li><li>è¿›ç¨‹ç‹¬æœ‰ç±»å‹çš„ TLBï¼šç”¨æˆ·åœ°å€ç©ºé—´æ˜¯æ¯ä¸ªè¿›ç¨‹ç‹¬æœ‰çš„åœ°å€ç©ºé—´ã€‚å°† prev è¿›ç¨‹åˆ‡æ¢åˆ° next è¿›ç¨‹æ—¶ï¼ŒTLB ä¸­ç¼“å­˜çš„ prev è¿›ç¨‹çš„ç›¸å…³æ•°æ®å¯¹äº next è¿›ç¨‹æ˜¯æ— ç”¨çš„ï¼Œå› æ­¤å¯ä»¥åˆ·æ–°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„è¿›ç¨‹ç‹¬æœ‰ç±»å‹çš„ TLBã€‚</li></ul><p>ä¸ºäº†æ”¯æŒè¿›ç¨‹ç‹¬æœ‰ç±»å‹çš„ TLBï¼ŒARM æ¶æ„æå‡ºäº†ä¸€ç§ç¡¬ä»¶è§£å†³æ–¹æ¡ˆï¼Œå« ASIDï¼ˆAddress Space IDï¼‰ï¼Œè¿™æ · TLB å°±å¯ä»¥è¯†åˆ«å“ªäº› TLB é¡¹æ˜¯å±äºæŸä¸ªè¿›ç¨‹çš„ã€‚ASID æ–¹æ¡ˆä½¿å¾—æ¯ä¸ª TLB é¡¹åŒ…å«ä¸€ä¸ª ASIDï¼ŒASID ç”¨äºæ ‡è¯†æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚å› æ­¤ï¼Œæœ‰äº† ASID ç¡¬ä»¶æœºåˆ¶çš„æ”¯æŒï¼Œè¿›ç¨‹çš„åˆ‡æ¢å°±ä¸éœ€è¦åˆ·æ–°æ•´ä¸ª TLBï¼Œåªéœ€è¦åˆ·æ–°è¿›ç¨‹ç‹¬æœ‰çš„ TLBã€‚</p><h4 id="switch_to-å‡½æ•°">switch_to() å‡½æ•°</h4><p>å¤„ç†å®Œ TLB å’Œé¡µè¡¨åŸºåœ°å€åï¼Œè¿˜éœ€è¦è¿›è¡Œæ ˆç©ºé—´çš„åˆ‡æ¢ï¼Œè¿™æ · next è¿›ç¨‹æ‰èƒ½å¼€å§‹è¿è¡Œï¼Œè¿™æ­£æ˜¯ switch_to() å‡½æ•°çš„ç›®çš„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/<span class="keyword">asm</span>-generic/switch_to.h&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> switch_to(prev, next, last)\</span></span><br><span class="line"><span class="meta">do {\</span></span><br><span class="line"><span class="meta">((last) = __switch_to((prev), (next)));\</span></span><br><span class="line"><span class="meta">} while (0)</span></span><br></pre></td></tr></tbody></table></figure><p>switch_to() å‡½æ•°ä¸€å…±æœ‰ 3 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºå°†è¦è¢«è°ƒåº¦å‡ºå»çš„è¿›ç¨‹ prevï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºå°†è¦è¢«è°ƒåº¦è¿›æ¥çš„è¿›ç¨‹ nextï¼Œç¬¬ä¸‰ä¸ªå‚æ•° last æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸ºä»€ä¹ˆ switch_to() å‡½æ•°æœ‰ 3 ä¸ªå‚æ•°ï¼Ÿprev å’Œ next å°±å¤Ÿäº†ï¼Œä¸ºä½•è¿˜éœ€è¦ lastï¼Ÿ</p><p>switch_to å®ç”±æ—§è¿›ç¨‹è°ƒç”¨ï¼Œåœ¨æ–°è¿›ç¨‹ç»“æŸï¼Œæ–°è¿›ç¨‹å¦‚æœæƒ³è·å–æ—§è¿›ç¨‹æè¿°ç¬¦åœ°å€ï¼Œä¸èƒ½ç›´æ¥è¯»å–å±€éƒ¨å˜é‡ prevï¼ˆå› ä¸º prev å­˜æ”¾åœ¨è¯¥å®è°ƒç”¨è€…ï¼Œå³æ—§è¿›ç¨‹çš„å†…æ ¸æ ˆä¸­ï¼Œæ–°è¿›ç¨‹æ— æ³•è®¿é—®æ—§è¿›ç¨‹çš„å†…æ ¸æ ˆï¼‰ï¼Œæ‰€ä»¥å°±éœ€è¦ä¸€ä¸ªè¾“å‡ºå‚æ•°å°†æ—§è¿›ç¨‹æè¿°ç¬¦åœ°å€ä¼ é€’ç»™æ–°è¿›ç¨‹ï¼ˆå®ç°æ–¹æ³•å°±æ˜¯åˆ©ç”¨ cpu å¯„å­˜å™¨%eaxï¼Œåœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­è¯¥å¯„å­˜å™¨çš„å€¼ä¸å˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ—§è¿›ç¨‹ä¸­ï¼Œå°† prev å­˜å…¥%eaxï¼Œåœ¨æ–°è¿›ç¨‹æ¢å¤æ‰§è¡Œåï¼Œå°†%eax çš„å†…å®¹æ”¾å…¥ lastï¼‰ã€‚</p><p>task_struct æ•°æ®ç»“æ„é‡Œçš„ thread_struct ç”¨æ¥å­˜æ”¾å’Œå…·ä½“æ¶æ„ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ã€‚å¯¹äº ARM64 æ¶æ„æ¥è¯´ï¼Œthread_struct æ•°æ®ç»“æ„å®šä¹‰åœ¨ arch/arm64/include/asm/processor.h æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/processor.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu_context</span><span class="title">cpu_context</span>;</span><span class="comment">/* cpu context */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>tp_value;<span class="comment">/* TLS register */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>tp2_value;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_fpsimd_state</span> <span class="title">fpsimd_state</span>;</span></span><br><span class="line">} uw;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>fpsimd_cpu;</span><br><span class="line"><span class="type">void</span>*sve_state;<span class="comment">/* SVE registers, if any */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>sve_vl;<span class="comment">/* SVE vector length */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>sve_vl_onexec;<span class="comment">/* SVE vl after next exec */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>fault_address;<span class="comment">/* fault info */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>fault_code;<span class="comment">/* ESR_EL1 value */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">debug_info</span><span class="title">debug</span>;</span><span class="comment">/* debugging */</span></span><br><span class="line">u64sctlr_user;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><ul><li>cpu_contextï¼šä¿å­˜è¿›ç¨‹ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯åˆ° CPU ç›¸å…³çš„é€šç”¨å¯„å­˜å™¨ä¸­</li><li>tp_valueï¼šTLS å¯„å­˜å™¨ã€‚</li><li>tp2_valueï¼šTLS å¯„å­˜å™¨ã€‚</li><li>fpsimd_stateï¼šä¸ FP å’Œ SMID ç›¸å…³çš„çŠ¶æ€ã€‚</li><li>fpsimd_cpuï¼šFP å’Œ SMID çš„ç›¸å…³ä¿¡æ¯ã€‚</li><li>sve_stateï¼šSVE å¯„å­˜å™¨ã€‚</li><li>sve_vlï¼šSVE å‘é‡çš„é•¿åº¦ã€‚</li><li>sve_vl_onexecï¼šä¸‹ä¸€æ¬¡æ‰§è¡Œä¹‹å SVE å‘é‡çš„é•¿åº¦ã€‚</li><li>fault_addressï¼šå¼‚å¸¸åœ°å€ã€‚</li><li>fault_codeï¼šå¼‚å¸¸é”™è¯¯å€¼ï¼Œä» ESREL1 ä¸­è¯»å‡ºã€‚</li></ul><p>cpu_context æ˜¯ä¸€ç§éå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒå‹¾ç”»äº†åœ¨åˆ‡æ¢è¿›ç¨‹æ—¶ï¼ŒCPU éœ€è¦ä¿å­˜å“ªäº›å¯„å­˜å™¨ï¼Œæˆ‘ä»¬ç§°ä¸ºè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡ã€‚å¯¹äº ARM64 å¤„ç†å™¨æ¥è¯´ï¼Œåœ¨åˆ‡æ¢è¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ prev è¿›ç¨‹çš„ x19~x28 å¯„å­˜å™¨ä»¥åŠ fpã€sp å’Œ pc å¯„å­˜å™¨ä¿å­˜åˆ° cpu_context æ•°æ®ç»“æ„ä¸­ï¼Œç„¶åæŠŠ next è¿›ç¨‹ä¸­ä¸Šä¸€æ¬¡ä¿å­˜çš„ cpu_context æ•°æ®ç»“æ„çš„å€¼æ¢å¤åˆ°å®é™…ç¡¬ä»¶çš„å¯„å­˜å™¨ä¸­ï¼Œè¿™æ ·å°±å®Œæˆäº†è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ cpu_context æ•°æ®ç»“æ„çš„å®šä¹‰å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;arch/arm64/include/<span class="keyword">asm</span>/processor.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu_context</span> {</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x19;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x20;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x21;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x22;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x23;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x24;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x25;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x26;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x27;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> x28;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> fp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> sp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pc;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æµç¨‹å¦‚å›¾æ‰€ç¤ºã€‚åœ¨è¿›ç¨‹åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¸­é‡è¦çš„å¯„å­˜å™¨å·²ä¿å­˜åˆ° prev è¿›ç¨‹çš„ cpu_context æ•°æ®ç»“æ„ä¸­ï¼Œè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡åŒ…æ‹¬ x19~x28 å¯„å­˜å™¨ã€fp å¯„å­˜å™¨ã€sp å¯„å­˜å™¨ä»¥åŠ pc å¯„å­˜å™¨ï¼Œå¦‚å›¾ï¼ˆaï¼‰æ‰€ç¤ºã€‚ç„¶åï¼ŒæŠŠ next è¿›ç¨‹å­˜å‚¨çš„ä¸Šä¸‹æ–‡æ¢å¤åˆ° CPU ä¸­ï¼Œå¦‚å›¾ï¼ˆbï¼‰æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/context.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆäºŒï¼‰è¿›ç¨‹çš„åˆ›å»ºå’Œç»ˆæ­¢</title>
      <link href="/2021/LinuxKernel/LinuxTaskCreate/"/>
      <url>/2021/LinuxKernel/LinuxTaskCreate/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/TaskCreate.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1ZmQxYmYzNDZmYjA3MjVmNjhhYjg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>æœ€æ–°ç‰ˆæœ¬çš„ POSIX æ ‡å‡†ä¸­å®šä¹‰äº†è¿›ç¨‹åˆ›å»ºå’Œç»ˆæ­¢çš„æ“ä½œç³»ç»Ÿå±‚é¢çš„åŸè¯­ã€‚è¿›ç¨‹åˆ›å»ºåŒ…æ‹¬ fork() å’Œ execve() å‡½æ•°æ—ï¼Œè¿›ç¨‹ç»ˆæ­¢åŒ…æ‹¬ wait()ã€waitpid()ã€kill() ä»¥åŠ exit() å‡½æ•°æ—ã€‚Linux åœ¨å®ç°è¿‡ç¨‹ä¸­ä¸ºäº†æé«˜æ•ˆç‡ï¼ŒæŠŠ POSIX æ ‡å‡†çš„ fork åŸè¯­æ‰©å±•æˆäº† vfork å’Œ clone ä¸¤ä¸ªåŸè¯­ã€‚</p><p>æˆ‘ä»¬æœ€å¸¸è§çš„ä¸€ç§åœºæ™¯æ˜¯åœ¨ shell ç•Œé¢ä¸­è¾“å…¥å‘½ä»¤ï¼Œç„¶åç­‰å¾…å‘½ä»¤è¿”å›ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/shell_exec.png"></p><h1 id="ç”¨æˆ·ç©ºé—´å¦‚ä½•åˆ›å»ºè¿›ç¨‹">ç”¨æˆ·ç©ºé—´å¦‚ä½•åˆ›å»ºè¿›ç¨‹</h1><p>åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·ç©ºé—´åˆ›å»ºè¿›ç¨‹æœ‰ä¸¤ç§åœºæ™¯ï¼š</p><ul><li>åˆ›å»ºçš„å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±ç”¨ä¸€ä¸ª elf æ–‡ä»¶ï¼šè¿™ç§æƒ…å†µé€‚åˆäºå¤§å¤šæ•°çš„ç½‘ç»œæœåŠ¡ç¨‹åº</li><li>åˆ›å»ºçš„å­è¿›ç¨‹éœ€è¦åŠ è½½è‡ªå·±çš„ elf æ–‡ä»¶ï¼šä¾‹å¦‚ shell</li></ul><p>åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ fork ç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼Œfork ä¹‹åï¼Œå­è¿›ç¨‹å¤åˆ¶äº†çˆ¶è¿›ç¨‹çš„ç»å¤§éƒ¨åˆ†çš„èµ„æºï¼ˆæ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ã€å½“å‰å·¥ä½œç›®å½•ç­‰ï¼‰ã€‚å®Œå…¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„èµ„æºçš„å¼€é”€éå¸¸å¤§ä¸”æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œç‰¹åˆ«æ˜¯å¯¹äºåœºæ™¯ 2ã€‚ä¸è¿‡ï¼Œåœ¨å¼•å…¥ COW(copy-on-write) æŠ€æœ¯åï¼Œfork çš„å¼€é”€å…¶å®ä¹Ÿä¸ç®—ç‰¹åˆ«å¤§ï¼Œå¤§éƒ¨åˆ†çš„ copy éƒ½æ˜¯é€šè¿‡ share å®Œæˆçš„ï¼Œä¸»è¦çš„å¼€é”€é›†ä¸­åœ¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ä¸Šã€‚linux è¿˜æä¾›äº† vfork å‡½æ•°ï¼Œvfork å’Œ fork æ˜¯ç±»ä¼¼çš„ï¼Œé™¤äº†ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>é˜»å¡çˆ¶è¿›ç¨‹</li><li>ä¸å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨</li></ul><p>ä¹‹æ‰€ä»¥ vfork è¦é˜»å¡çˆ¶è¿›ç¨‹æ˜¯å› ä¸º vfork åçˆ¶å­è¿›ç¨‹ä½¿ç”¨çš„æ˜¯å®Œå…¨ç›¸åŒçš„ memory descriptor, ä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨çš„æ˜¯å®Œå…¨ç›¸åŒçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼ŒåŒ…æ‹¬æ ˆä¹Ÿç›¸åŒã€‚æ‰€ä»¥ä¸¤ä¸ªè¿›ç¨‹ä¸èƒ½åŒæ—¶è¿è¡Œï¼Œå¦åˆ™æ ˆå°±ä¹±æ‰äº†ã€‚é™¤äº† fork å’Œ vforkï¼ŒLinux å†…æ ¸è¿˜æä¾›çš„ clone çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ä¸»è¦ç”¨äºçº¿ç¨‹çš„åˆ›å»ºã€‚å…¶å®é€šè¿‡ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œclone æ¥å£å¯ä»¥å®ç° fork å’Œ vfork çš„åŠŸèƒ½ã€‚</p><h1 id="åˆ›å»ºè¿›ç¨‹">åˆ›å»ºè¿›ç¨‹</h1><p>ç°ä»£æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆCopy On Writeï¼Œcowï¼‰æŠ€æœ¯ã€‚å†™æ—¶å¤åˆ¶æŠ€æœ¯å°±æ˜¯çˆ¶è¿›ç¨‹åœ¨åˆ›å»ºå­è¿›ç¨‹æ—¶ä¸éœ€è¦å¤åˆ¶è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å®¹ç»™å­è¿›ç¨‹ï¼Œåªéœ€è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„è¿›ç¨‹åœ°å€ç©ºé—´çš„é¡µè¡¨ç»™å­è¿›ç¨‹ï¼Œè¿™æ ·çˆ¶å­è¿›ç¨‹å°±å¯ä»¥å…±äº«ç›¸åŒçš„ç‰©ç†å†…å­˜ã€‚å½“çˆ¶å­è¿›ç¨‹ä¸­æœ‰ä¸€æ–¹éœ€è¦ä¿®æ”¹æŸä¸ªç‰©ç†é¡µé¢çš„å†…å®¹æ—¶ï¼Œè§¦å‘å†™ä¿æŠ¤çš„ç¼ºé¡µå¼‚å¸¸ï¼Œç„¶åæ‰æŠŠå…±äº«é¡µé¢çš„å†…å®¹å¤åˆ¶å‡ºæ¥ï¼Œä»è€Œè®©çˆ¶å­è¿›ç¨‹æ‹¥æœ‰å„è‡ªçš„å‰¯æœ¬ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/cow.png"></p><h2 id="fork-å‡½æ•°">fork() å‡½æ•°</h2><p>å¦‚æœä½¿ç”¨ fork() å‡½æ•°æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å°†æ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œä½†æ˜¯å…±äº«ç‰©ç†å†…å­˜èµ„æºï¼ŒåŒ…æ‹¬è¿›ç¨‹ä¸Šä¸‹æ–‡ã€è¿›ç¨‹æ ˆã€å†…å­˜ä¿¡æ¯ã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€è¿›ç¨‹ä¼˜å…ˆçº§ã€èµ„æºé™åˆ¶ç­‰ã€‚åœ¨åˆ›å»ºæœŸé—´ï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå½“å®ƒä»¬å¼€å§‹è¿è¡Œå„è‡ªçš„ç¨‹åºæ—¶ï¼Œå®ƒä»¬çš„è¿›ç¨‹åœ°å€ç©ºé—´å¼€å§‹åˆ†é“æ‰¬é•³ï¼Œè¿™å¾—ç›Šäºå†™æ—¶å¤åˆ¶æŠ€æœ¯çš„ä¼˜åŠ¿ã€‚å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹æœ‰å¦‚ä¸‹ä¸€äº›åŒºåˆ«ã€‚</p><ul><li>å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„ ID ä¸ä¸€æ ·</li><li>å­è¿›ç¨‹ä¸ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„å†…å­˜æ–¹é¢çš„é”ï¼Œæ¯”å¦‚ mlock()</li><li>å­è¿›ç¨‹ä¸ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä¸€äº›å®šæ—¶å™¨ï¼Œæ¯”å¦‚ setitimer()ã€alarm()ã€timer_create()</li><li>å­è¿›ç¨‹ä¸ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä¿¡å·é‡ï¼Œæ¯”å¦‚ semop()</li></ul><p>å°½ç®¡ä½¿ç”¨äº†å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä½†è¿˜æ˜¯éœ€è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ä¼šæ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æœ‰äº†åæ¥çš„ vfork åŸè¯­å’Œ clone åŸè¯­ã€‚</p><h2 id="vfork-å‡½æ•°">vfork() å‡½æ•°</h2><p>vfork() å‡½æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥ Linux å†…æ ¸ï¼Œç„¶åé€šè¿‡ kernel_clone() å‡½æ•°æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE0(vfork)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_clone_args</span> <span class="title">args</span> =</span> {</span><br><span class="line">.flags= CLONE_VFORK | CLONE_VM,</span><br><span class="line">.exit_signal= SIGCHLD,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kernel_clone(&amp;args);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>vfork() çš„å®ç°æ¯” fork() å¤šäº†ä¸¤ä¸ªæ ‡å¿—ä½ï¼Œåˆ†åˆ«æ˜¯ CLONE_VFORK å’Œ CLONE_VMã€‚CLONE_VFORK è¡¨ç¤ºçˆ¶è¿›ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´è‡³å­è¿›ç¨‹é‡Šæ”¾è™šæ‹Ÿå†…å­˜èµ„æºã€‚CLONE_VM è¡¨ç¤ºçˆ¶å­è¿›ç¨‹è¿è¡Œåœ¨ç›¸åŒçš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚vfork() çš„å¦ä¸€ä¸ªä¼˜åŠ¿æ˜¯è¿çˆ¶è¿›ç¨‹çš„é¡µè¡¨é¡¹å¤åˆ¶åŠ¨ä½œä¹Ÿè¢«çœå»äº†ã€‚</p><h2 id="clone-å‡½æ•°">clone() å‡½æ•°</h2><p>clone() å‡½æ•°é€šå¸¸ç”¨æ¥åˆ›å»ºç”¨æˆ·çº¿ç¨‹ã€‚clone() å‡½æ•°åŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥ä¼ é€’ä¼—å¤šå‚æ•°ï¼Œå¯ä»¥æœ‰é€‰æ‹©åœ°ç»§æ‰¿çˆ¶è¿›ç¨‹çš„èµ„æºï¼Œæ¯”å¦‚å¯ä»¥å’Œ vfork() ä¸€æ ·ä¸çˆ¶è¿›ç¨‹å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œä»è€Œåˆ›å»ºçº¿ç¨‹ï¼›ä¹Ÿå¯ä»¥ä¸å’Œçˆ¶è¿›ç¨‹å…±äº«è¿›ç¨‹åœ°ç©ºé—´ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå…„å¼Ÿå…³ç³»è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*glibc åº“çš„å°è£…*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">clone</span><span class="params">(<span class="type">int</span> (*fn) (voia*), voia* child_stack,</span></span><br><span class="line"><span class="params">                    <span class="type">int</span> flags, <span class="type">void</span> *arg, ...)</span>;</span><br><span class="line"><span class="comment">/*åŸå§‹çš„ç³»ç»Ÿè°ƒç”¨*/</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">clone</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> flags, <span class="type">void</span> *child_stack,</span></span><br><span class="line"><span class="params">                    <span class="type">void</span> *ptid, voia* ctid,</span></span><br><span class="line"><span class="params">                    <span class="keyword">struct</span> pt_regs *regs)</span>;</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ glibc å°è£…çš„ clone() å‡½æ•°ä¸ºä¾‹ï¼Œfn æ˜¯å­è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°æŒ‡é’ˆï¼›child_stack ç”¨äºä¸ºå­è¿›ç¨‹åˆ†é…æ ˆï¼›flags ç”¨äºè®¾ç½® clone æ ‡å¿—ä½ï¼Œè¡¨ç¤ºéœ€è¦ä»çˆ¶è¿›ç¨‹ç»§æ‰¿å“ªäº›èµ„æºï¼›arg æ˜¯ä¼ é€’ç»™å­è¿›ç¨‹çš„å‚æ•°ã€‚clone() å‡½æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥ Linux å†…æ ¸ï¼Œç„¶åé€šè¿‡ kernel_clone() å‡½æ•°æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(clone, <span class="type">unsigned</span> <span class="type">long</span>, clone_flags, <span class="type">unsigned</span> <span class="type">long</span>, newsp,</span><br><span class="line"> <span class="type">int</span> __user *, parent_tidptr,</span><br><span class="line"> <span class="type">int</span> __user *, child_tidptr,</span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span>, tls)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_clone_args</span> <span class="title">args</span> =</span> {</span><br><span class="line">.flags= (lower_32_bits(clone_flags) &amp; ~CSIGNAL),</span><br><span class="line">.pidfd= parent_tidptr,</span><br><span class="line">.child_tid= child_tidptr,</span><br><span class="line">.parent_tid= parent_tidptr,</span><br><span class="line">.exit_signal= (lower_32_bits(clone_flags) &amp; CSIGNAL),</span><br><span class="line">.<span class="built_in">stack</span>= newsp,</span><br><span class="line">.tls= tls,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kernel_clone(&amp;args);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="å†…æ ¸çº¿ç¨‹">å†…æ ¸çº¿ç¨‹</h2><p>å†…æ ¸çº¿ç¨‹ï¼ˆkermel threadï¼‰å…¶å®å°±æ˜¯è¿è¡Œåœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„è¿›ç¨‹ï¼Œå®ƒå’Œæ™®é€šç”¨æˆ·è¿›ç¨‹çš„åŒºåˆ«åœ¨äºå†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ task_struct æ•°æ®ç»“æ„ä¸­çš„ mm æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULLï¼Œå› è€Œåªèƒ½è¿è¡Œåœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­ï¼Œå’Œæ™®é€šè¿›ç¨‹ä¸€æ ·å‚ä¸ç³»ç»Ÿè°ƒåº¦ã€‚æ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«å†…æ ¸åœ°å€ç©ºé—´ã€‚å¸¸è§çš„å†…æ ¸çº¿ç¨‹æœ‰é¡µé¢å›æ”¶çº¿ç¨‹â€œkswapdâ€ç­‰ã€‚Linux å†…æ ¸æä¾›äº†å¤šä¸ªæ¥å£å‡½æ•°æ¥åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> kthread_create(threadfn, data, namefmt, arg...) \</span></span><br><span class="line"><span class="meta">kthread_create_on_node(threadfn, data, NUMA_NO_NODE, namefmt, ##arg)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kthread_run(threadfn, data, namefmt, ...)   \</span></span><br><span class="line"><span class="meta">({   \</span></span><br><span class="line"><span class="meta">struct task_struct *__k   \</span></span><br><span class="line"><span class="meta">= kthread_create(threadfn, data, namefmt, ## __VA_ARGS__); \</span></span><br><span class="line"><span class="meta"><span class="keyword">if</span> (!IS_ERR(__k))   \</span></span><br><span class="line"><span class="meta">wake_up_process(__k);   \</span></span><br><span class="line"><span class="meta">__k;   \</span></span><br><span class="line"><span class="meta">})</span></span><br></pre></td></tr></tbody></table></figure><p>kthread_create() æ¥å£å‡½æ•°åˆ›å»ºçš„å†…æ ¸çº¿ç¨‹è¢«å‘½åä¸º namefmtã€‚æ–°å»ºçš„å†…æ ¸çº¿ç¨‹å°†è¿è¡Œ threadfn() å‡½æ•°ã€‚æ–°å»ºçš„å†…æ ¸çº¿ç¨‹å¤„äºä¸å¯è¿è¡ŒçŠ¶æ€ï¼Œéœ€è¦è°ƒç”¨ wake_up_process() å‡½æ•°æ¥å°†å…¶å”¤é†’å¹¶æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œè¦åˆ›å»ºä¸€ä¸ªé©¬ä¸Šå¯ä»¥è¿è¡Œçš„å†…æ ¸çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ kthread_run() å‡½æ•°ã€‚å†…æ ¸çº¿ç¨‹æœ€ç»ˆè¿˜æ˜¯é€šè¿‡ kernel_clone() å‡½æ•°æ¥å®ç°ã€‚</p><p>åœ¨å†…æ ¸ä¸­ï¼Œfork()ã€vfork() ä»¥åŠ clone() è¿™ 3 ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°å³ kernel_clone() å‡½æ•°æ¥å®ç°ï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨ fork.c æ–‡ä»¶ä¸­ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆè°ƒç”¨è°ƒç”¨ copy_process å‡½æ•°ã€‚</p><h2 id="forkvfork-å’Œ-pthread_create-åŒºåˆ«">forkã€vfork å’Œ pthread_create åŒºåˆ«</h2><ul><li><p>forkï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/fork100.png"></p></li><li><p>vforkï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/fork101.png"></p></li><li><p>pthread_createï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/fork102.png"></p></li><li><p>do_fork å®ç°ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/fork103.png"></p></li></ul><h1 id="ç»ˆæ­¢è¿›ç¨‹">ç»ˆæ­¢è¿›ç¨‹</h1><p>è¿›ç¨‹çš„ç»ˆæ­¢æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ–¹å¼æ˜¯ä¸»åŠ¨ç»ˆæ­¢ï¼ŒåŒ…æ‹¬æ˜¾å¼åœ°æ‰§è¡Œ exit() ç³»ç»Ÿè°ƒç”¨æˆ–è€…ä»æŸä¸ªç¨‹åºçš„ä¸»å‡½æ•°è¿”å›ï¼›å¦ä¸€ç§æ–¹å¼æ˜¯è¢«åŠ¨ç»ˆæ­¢ï¼Œåœ¨æ¥æ”¶åˆ°ç»ˆæ­¢çš„ä¿¡å·æˆ–å¼‚å¸¸æ—¶ç»ˆæ­¢ã€‚</p><p>å½“ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼ŒLinux å†…æ ¸ä¼šé‡Šæ”¾å®ƒæ‰€å æœ‰çš„èµ„æºï¼Œå¹¶æŠŠè¿™æ¡æ¶ˆæ¯å‘ŠçŸ¥çˆ¶è¿›ç¨‹ã€‚ä¸€ä¸ªè¿›ç¨‹çš„ç»ˆæ­¢å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µã€‚</p><ul><li>å®ƒæœ‰å¯èƒ½å…ˆäºçˆ¶è¿›ç¨‹ç»ˆæ­¢ï¼Œè¿™æ—¶å­è¿›ç¨‹ä¼šå˜æˆåƒµå°¸è¿›ç¨‹ï¼Œç›´åˆ°çˆ¶è¿›ç¨‹è°ƒç”¨ wait() æ‰ç®—æœ€ç»ˆæ¶ˆäº¡</li><li>å®ƒä¹Ÿæœ‰å¯èƒ½åœ¨çˆ¶è¿›ç¨‹ä¹‹åç»ˆæ­¢ï¼Œè¿™æ—¶ init è¿›ç¨‹å°†æˆä¸ºå­è¿›ç¨‹æ–°çš„çˆ¶è¿›ç¨‹</li></ul><h1 id="åƒµå°¸è¿›ç¨‹å’Œæ‰˜å­¤è¿›ç¨‹">åƒµå°¸è¿›ç¨‹å’Œæ‰˜å­¤è¿›ç¨‹</h1><p>å½“ä¸€ä¸ªè¿›ç¨‹é€šè¿‡ exit() ç³»ç»Ÿè°ƒç”¨è¢«ç»ˆæ­¢ä¹‹åï¼Œè¯¥è¿›ç¨‹å°†å¤„äºåƒµå°¸çŠ¶æ€ã€‚åœ¨åƒµå°¸çŠ¶æ€ä¸­ï¼Œé™¤äº†è¿›ç¨‹æè¿°ç¬¦ä¾ç„¶ä¿ç•™ä¹‹å¤–ï¼Œè¿›ç¨‹çš„æ‰€æœ‰èµ„æºéƒ½å·²ç»å½’è¿˜ç»™å†…æ ¸ã€‚Linux å†…æ ¸è¿™ä¹ˆåšæ˜¯ä¸ºäº†è®©ç³»ç»Ÿå¯ä»¥çŸ¥é“å­è¿›ç¨‹çš„ç»ˆæ­¢åŸå› ç­‰ä¿¡æ¯ï¼Œå› æ­¤è¿›ç¨‹ç»ˆæ­¢æ—¶æ‰€éœ€è¦åšçš„æ¸…ç†å·¥ä½œå’Œé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦æ˜¯åˆ†å¼€çš„ã€‚å½“çˆ¶è¿›ç¨‹é€šè¿‡ wait() ç³»ç»Ÿè°ƒç”¨è·å–äº†å·²ç»ˆæ­¢çš„å­è¿›ç¨‹çš„ä¿¡æ¯ä¹‹åï¼Œå†…æ ¸æ‰ä¼šé‡Šæ”¾å­è¿›ç¨‹çš„ task_struct æ•°æ®ç»“æ„ã€‚</p><p>æ‰€è°“æ‰˜å­¤è¿›ç¨‹ï¼Œæ˜¯æŒ‡å¦‚æœçˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹æ¶ˆäº¡ï¼Œé‚£ä¹ˆå­è¿›ç¨‹å°±å˜æˆå­¤å„¿è¿›ç¨‹ï¼Œè¿™æ—¶ Linux å†…æ ¸ä¼šè®©å®ƒæ‰˜å­¤ç»™ init è¿›ç¨‹ï¼ˆ1 å·è¿›ç¨‹ï¼‰ï¼Œäºæ˜¯ init è¿›ç¨‹å°±æˆäº†å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚</p><h1 id="è¿›ç¨‹-0-å’Œè¿›ç¨‹-1">è¿›ç¨‹ 0 å’Œè¿›ç¨‹ 1</h1><p>è¿›ç¨‹ 0 æ˜¯æŒ‡ Linux å†…æ ¸åœ¨åˆå§‹åŒ–é˜¶æ®µä»æ— åˆ°æœ‰åˆ›å»ºçš„ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œå®ƒæ˜¯æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆï¼Œæœ‰å¥½å‡ ä¸ªåˆ«åï¼Œæ¯”å¦‚è¿›ç¨‹ 0ã€idle è¿›ç¨‹æˆ– swapper è¿›ç¨‹ã€‚è¿›ç¨‹ 0 çš„è¿›ç¨‹æè¿°ç¬¦æ˜¯åœ¨ init/init_task.c æ–‡ä»¶ä¸­é™æ€åˆå§‹åŒ–çš„ã€‚</p><p>åˆå§‹åŒ–å‡½æ•° start_kernel() åœ¨åˆå§‹åŒ–å®Œå†…æ ¸æ‰€éœ€è¦çš„æ‰€æœ‰æ•°æ®ç»“æ„ä¹‹åä¼šåˆ›å»ºå¦ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œè¿™ä¸ªå†…æ ¸çº¿ç¨‹å°±æ˜¯è¿›ç¨‹ 1 æˆ– init è¿›ç¨‹ã€‚ä¸è¿›ç¨‹ 0 å…±äº«æ‰€æœ‰çš„æ•°æ®ç»“æ„ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">noinline <span class="type">void</span> __ref <span class="title function_">rest_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line"><span class="type">int</span> pid;</span><br><span class="line"></span><br><span class="line">rcu_scheduler_starting();</span><br><span class="line"></span><br><span class="line">pid = kernel_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS);</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿›ç¨‹ 1 ä¼šæ‰§è¡Œ kernel_init() å‡½æ•°ï¼Œå®ƒä¼šé€šè¿‡ execve() ç³»ç»Ÿè°ƒç”¨è£…å…¥å¯æ‰§è¡Œç¨‹åº initï¼ˆâ€œsbin/initâ€,â€œ/bin/initâ€æˆ–â€œbin/shâ€ï¼‰ï¼Œè¿›ç¨‹ 1 å˜æˆä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œæ˜¯å†…æ ¸å¯åŠ¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·çº§è¿›ç¨‹ã€‚init æœ‰è®¸å¤šå¾ˆé‡è¦çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åƒå¯åŠ¨ gettyï¼ˆç”¨äºç”¨æˆ·ç™»å½•ï¼‰ã€å®ç°è¿è¡Œçº§åˆ«ã€ä»¥åŠå¤„ç†å­¤ç«‹è¿›ç¨‹ã€‚è¿›ç¨‹ 1 åœ¨ä»å†…æ ¸çº¿ç¨‹å˜æˆæ™®é€šè¿›ç¨‹ init ä¹‹åï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®/etc/inittab æ–‡ä»¶çš„å†…å®¹å¯åŠ¨æ‰€éœ€è¦çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ç³»ç»Ÿé…ç½®ã€å¯åŠ¨ä¸€ä¸ªç™»å½•å¯¹è¯ç­‰ã€‚</p><p>å½“æ£€æµ‹åˆ°æ¥è‡ªç»ˆç«¯çš„è¿æ¥ä¿¡å·æ—¶ï¼Œgetty è¿›ç¨‹å°†é€šè¿‡å‡½æ•° do_execve() æ‰§è¡Œæ³¨å†Œç¨‹åº loginï¼Œæ­¤æ—¶ç”¨æˆ·å°±å¯è¾“å…¥æ³¨å†Œåå’Œå¯†ç è¿›å…¥ç™»å½•è¿‡ç¨‹ï¼Œå¦‚æœæˆåŠŸï¼Œç”± login ç¨‹åºå†é€šè¿‡å‡½æ•° execv() æ‰§è¡Œ shellï¼Œè¯¥ shell è¿›ç¨‹æ¥æ”¶ getty è¿›ç¨‹çš„ pidï¼Œå–ä»£åŸæ¥çš„ getty è¿›ç¨‹ã€‚å†ç”± shell ç›´æ¥æˆ–é—´æ¥åœ°äº§ç”Ÿå…¶ä»–è¿›ç¨‹ã€‚</p><p>ä¸Šè¿°è¿‡ç¨‹å¯æè¿°ä¸ºï¼š0 å·è¿›ç¨‹-&gt;1 å·å†…æ ¸è¿›ç¨‹-&gt;1 å·ç”¨æˆ·è¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰-&gt;getty è¿›ç¨‹-&gt;shell è¿›ç¨‹</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcHJvY2Vzc19tYW5hZ2VtZW50L1Byb2Nlc3MtQ3JlYXRpb24tMS5odG1s">http://www.wowotech.net/process_management/Process-Creation-1.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIwODE3MzI3L2FydGljbGUvZGV0YWlscy8xMDgyODk2NDc=">https://blog.csdn.net/qq_20817327/article/details/108289647<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xODQyMzA3">https://cloud.tencent.com/developer/article/1842307<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è¿›ç¨‹ç®¡ç†ï¼ˆä¸€ï¼‰åŸºæœ¬æ¦‚å¿µ</title>
      <link href="/2021/LinuxKernel/LinuxTaskBasic/"/>
      <url>/2021/LinuxKernel/LinuxTaskBasic/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ProcessBasic.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1ZDg4NDFlMDg1MzA2ZjhjMzUxZjM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><h1 id="è¿›ç¨‹çš„æ¦‚å¿µ">è¿›ç¨‹çš„æ¦‚å¿µ</h1><p>è¿›ç¨‹æ˜¯å¤„äºæ‰§è¡ŒæœŸçš„ç¨‹åºä»¥åŠç›¸å…³çš„èµ„æºçš„æ€»ç§°ã€‚è¿›ç¨‹å¹¶ä¸ä»…ä»…å±€é™äºä¸€æ®µå¯æ‰§è¡Œç¨‹åºä»£ç ï¼Œé€šå¸¸è¿›ç¨‹è¿˜è¦åŒ…å«å…¶ä»–èµ„æºï¼Œåƒæ•°æ®æ®µã€æ‰“å¼€çš„æ–‡ä»¶ã€æŒ‚èµ·çš„ä¿¡å·ã€å¤„ç†å™¨çŠ¶æ€ã€ä¸€ä¸ªæˆ–å¤šä¸ªå…·æœ‰å†…å­˜æ˜ å°„çš„å†…å­˜åœ°å€ç©ºé—´åŠä¸€ä¸ªæˆ–å¤šä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆthread of executionï¼‰ç­‰ã€‚</p><p>çº¿ç¨‹ï¼ˆthreadï¼‰ï¼Œæ˜¯åœ¨è¿›ç¨‹ä¸­æ´»åŠ¨çš„å¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ã€çº¿ç¨‹æ ˆå’Œä¸€ç»„è¿›ç¨‹å¯„å­˜å™¨ï¼Œå†…æ ¸è°ƒåº¦çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è¿›ç¨‹ã€‚</p><p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æä¾›ä¸¤ç§è™šæ‹Ÿæœºåˆ¶ï¼šè™šæ‹Ÿå¤„ç†å™¨å’Œè™šæ‹Ÿå†…å­˜ã€‚</p><ul><li>è™šæ‹Ÿå¤„ç†å™¨ç»™è¿›ç¨‹ä¸€ç§å‡è±¡ï¼Œè®©è¿™äº›è¿›ç¨‹è§‰å¾—è‡ªå·±åœ¨ç‹¬äº«å¤„ç†å™¨</li><li>è™šæ‹Ÿå†…å­˜è®©è¿›ç¨‹åœ¨åˆ†é…å’Œç®¡ç†å†…å­˜æ—¶è§‰å¾—è‡ªå·±æ‹¥æœ‰æ•´ä¸ªç³»ç»Ÿçš„æ‰€æœ‰å†…å­˜èµ„æº</li></ul><span id="more"></span><h1 id="è¿›ç¨‹æè¿°ç¬¦">è¿›ç¨‹æè¿°ç¬¦</h1><p>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­è°ƒåº¦çš„å®ä½“ï¼Œéœ€è¦å¯¹è¿›ç¨‹æ‰€å¿…é¡»æ‹¥æœ‰çš„èµ„æºåšæŠ½è±¡æè¿°ï¼Œè¿™ç§å¯¹è±¡æè¿°ç§°ä¸ºè¿›ç¨‹æ§åˆ¶å—ï¼ˆProcess Control Blockï¼ŒPCBï¼‰ã€‚è¿›ç¨‹æ§åˆ¶å—éœ€è¦æè¿°å¦‚ä¸‹å‡ ç±»ä¿¡æ¯ï¼š</p><ul><li>è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼šåŒ…æ‹¬å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€åƒµå°¸ç­‰çŠ¶æ€</li><li>ç¨‹åºè®¡æ•°å™¨ï¼šè®°å½•å½“å‰è¿›ç¨‹è¿è¡Œåˆ°å“ªæ¡æŒ‡ä»¤äº†</li><li>CPU å¯„å­˜å™¨ï¼šä¸»è¦ä¿å­˜å½“å‰è¿è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œè®°å½• CPU æ‰€æœ‰å¿…é¡»ä¿å­˜ä¸‹æ¥çš„å¯„å­˜å™¨ä¿¡æ¯ï¼Œä»¥ä¾¿å½“å‰è¿›ç¨‹è°ƒåº¦å‡ºå»ä¹‹åè¿˜èƒ½è°ƒåº¦å›æ¥å¹¶æ¥ç€è¿è¡Œ</li><li>CPU è°ƒåº¦ä¿¡æ¯ï¼šåŒ…æ‹¬è¿›ç¨‹ä¼˜å…ˆçº§ã€è°ƒåº¦é˜Ÿåˆ—ç­‰ç›¸å…³ä¿¡æ¯</li><li>å†…å­˜ç®¡ç†ä¿¡æ¯ï¼šè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜ä¿¡æ¯ï¼Œæ¯”å¦‚è¿›ç¨‹çš„é¡µè¡¨ç­‰</li><li>ç»Ÿè®¡ä¿¡æ¯ï¼šåŒ…å«è¿›ç¨‹è¿è¡Œæ—¶é—´ç­‰ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</li><li>æ–‡ä»¶ç›¸å…³ä¿¡æ¯ï¼šåŒ…æ‹¬è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ç­‰</li></ul><p>åœ¨ Linux å†…æ ¸é‡Œé¢é‡‡ç”¨åä¸º task_struct çš„æ•°æ®ç»“æ„æ¥æè¿°ï¼ŒLinux å†…æ ¸åˆ©ç”¨é“¾è¡¨ task_list æ¥å­˜æ”¾æ‰€æœ‰è¿›ç¨‹æè¿°ç¬¦ï¼Œtask_struct æ•°æ®ç»“æ„å®šä¹‰åœ¨ include/inux/sched.h æ–‡ä»¶ä¸­ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/task_list.png"></p><p>task_struct æ•°æ®ç»“æ„å¾ˆå¤§ï¼Œé‡Œé¢åŒ…å«çš„å†…å®¹å¾ˆå¤šï¼Œå¯ä»¥ç®€å•å½’çº³æˆå¦‚ä¸‹å‡ ç±»ï¼š</p><ul><li>è¿›ç¨‹å±æ€§çš„ç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¿›ç¨‹çŠ¶æ€ã€è¿›ç¨‹çš„ PID ç­‰ä¿¡æ¯ï¼‰</li><li>è¿›ç¨‹é—´çš„å…³ç³»ï¼ˆçˆ¶å­ã€å…„å¼Ÿã€è¿›ç¨‹ç»„ç­‰ï¼‰</li><li>è¿›ç¨‹è°ƒåº¦çš„ç›¸å…³ä¿¡æ¯ï¼ˆä¼˜å…ˆçº§ã€è°ƒåº¦ç±»ã€policy è¿›ç¨‹ç±»å‹ç­‰ï¼‰</li><li>å†…å­˜ç®¡ç†çš„ç›¸å…³ä¿¡æ¯ï¼ˆmmï¼‰</li><li>æ–‡ä»¶ç®¡ç†çš„ç›¸å…³ä¿¡æ¯ï¼ˆfsï¼‰</li><li>ä¿¡å·çš„ç›¸å…³ä¿¡æ¯</li><li>èµ„æºé™åˆ¶çš„ç›¸å…³ä¿¡æ¯</li></ul><h1 id="è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h1><p>å…¸å‹çš„æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­åŒ…å«å¦‚ä¸‹çŠ¶æ€ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/task_status.png"></p><ul><li>TASK_RUNNINGï¼ˆå¯è¿è¡Œæ€æˆ–å°±ç»ªæ€ï¼‰ï¼šå®ƒæ˜¯æŒ‡è¿›ç¨‹å¤„äºå¯æ‰§è¡ŒçŠ¶æ€ï¼Œæˆ–è®¸æ­£åœ¨æ‰§è¡Œï¼Œæˆ–è®¸åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ</li><li>TASK_INTERRUPTIBLEï¼ˆå¯ä¸­æ–­ç¡çœ æ€ï¼‰ï¼šè¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼ˆè¢«é˜»å¡ï¼‰ä»¥ç­‰å¾…ï¼Œä¸€æ—¦æ¡ä»¶è¾¾æˆæˆ–è€…èµ„æºå°±ä½ï¼Œå¯ä»¥æŠŠè¿›ç¨‹çš„çŠ¶æ€è®¾ç½®æˆå¯è¿è¡Œæ€ï¼ˆTASK_RUNNINGï¼‰å¹¶åŠ å…¥å°±ç»ªé˜Ÿåˆ—ã€‚ä¹Ÿæœ‰äººå°†è¿™ç§çŠ¶æ€ç§°ä¸ºæµ…ç¡çœ çŠ¶æ€</li><li>TASK_UNINTERRUPTIBLEï¼ˆä¸å¯ä¸­æ–­æ€ï¼‰ï¼šè¿›ç¨‹åœ¨ç¡çœ ç­‰å¾…æ—¶ä¸å—å¹²æ‰°ï¼Œå¯¹ä¿¡å·ä¸åšä»»ä½•ååº”ï¼Œæ‰€ä»¥è¿™ç§çŠ¶æ€åˆç§°ä¸ºä¸å¯ä¸­æ–­æ€ã€‚é€šå¸¸ï¼Œä½¿ç”¨ ps å‘½ä»¤çœ‹åˆ°çš„è¢«æ ‡è®°ä¸º D çŠ¶æ€çš„è¿›ç¨‹å°±æ˜¯å¤„äºä¸å¯ä¸­æ–­æ€çš„è¿›ç¨‹ï¼Œä¸å¯ä»¥å‘é€ SIGKILL ä¿¡å·ç»ˆæ­¢å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬ä¸å“åº”ä¿¡å·ã€‚ä¹Ÿæœ‰äººæŠŠè¿™ç§çŠ¶æ€ç§°ä¸ºæ·±åº¦ç¡çœ çŠ¶æ€</li><li>TASK_STOPPEDï¼ˆç»ˆæ­¢æ€ï¼‰ï¼šè¿›ç¨‹åœæ­¢è¿è¡Œäº†</li><li>EXIT_ZOMBIE ï¼ˆåƒµå°¸æ€ï¼‰ï¼Œè¿›ç¨‹å·²ç»æ¶ˆäº¡ï¼Œä½†æ˜¯ task_struct æ•°æ®ç»“æ„è¿˜æ²¡æœ‰é‡Šæ”¾è¿™ç§çŠ¶æ€å«ä½œåƒµå°¸çŠ¶æ€ï¼Œæ¯ä¸ªè¿›ç¨‹åœ¨è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸä¸­éƒ½è¦ç»å†è¿™ç§çŠ¶æ€ã€‚å­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡ wait() æˆ– waitpid() æ¥è·å–å­è¿›ç¨‹æ¶ˆäº¡çš„åŸå› </li></ul><h1 id="è¿›ç¨‹æ ‡è¯†">è¿›ç¨‹æ ‡è¯†</h1><p>åœ¨åˆ›å»ºæ—¶ä¼šä¸ºè¿›ç¨‹åˆ†é…å”¯ä¸€çš„å·ç æ¥æ ‡è¯†ï¼Œè¿™ä¸ªå·ç å°±æ˜¯è¿›ç¨‹æ ‡è¯†ç¬¦ï¼ˆProcess Identife PIDï¼‰ã€‚</p><p>é™¤äº† PID ä¹‹å¤–ï¼ŒLinux å†…æ ¸è¿˜å¼•å…¥äº†çº¿ç¨‹ç»„çš„æ¦‚å¿µã€‚ä¸€ä¸ªçº¿ç¨‹ç»„ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä½¿ç”¨å’Œè¯¥çº¿ç¨‹ç»„ä¸­ä¸»çº¿ç¨‹ç›¸åŒçš„ PIDï¼Œå³è¯¥çº¿ç¨‹ç»„ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„ PIDï¼Œå®ƒä¼šè¢«å­˜å…¥ task_stuct æ•°æ®ç»“æ„çš„ tgid æˆå‘˜ä¸­ã€‚è¿™ä¸ POSIX 1003.1c æ ‡å‡†é‡Œçš„è§„å®šæœ‰å…³ï¼Œä¸€ä¸ªå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»æœ‰ç›¸åŒçš„ PIDï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ PID æŠŠä¿¡å·å‘é€ç»™çº¿ç¨‹ç»„é‡Œæ‰€æœ‰çš„çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getpid() <span class="comment">// ä¼šè¿”å›å½“å‰è¿›ç¨‹çš„ TGID</span></span><br><span class="line">gettid() <span class="comment">// ä¼šè¿”å›çº¿ç¨‹çš„ PID</span></span><br></pre></td></tr></tbody></table></figure><h1 id="è¿›ç¨‹é—´çš„å®¶æ—å…³ç³»">è¿›ç¨‹é—´çš„å®¶æ—å…³ç³»</h1><p>Linux å†…æ ¸ç»´æŠ¤äº†è¿›ç¨‹ä¹‹é—´çš„å®¶æ—å…³ç³»ï¼Œæ¯”å¦‚ï¼š</p><ul><li>Linux å†…æ ¸åœ¨å¯åŠ¨æ—¶ä¼šæœ‰ä¸€ä¸ª init_task è¿›ç¨‹ï¼Œå®ƒæ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹çš„â€œé¼»ç¥–â€ï¼Œç§°ä¸ºè¿›ç¨‹ 0 æˆ– idle è¿›ç¨‹ã€‚å½“ç³»ç»Ÿæ²¡æœ‰è¿›ç¨‹éœ€è¦è°ƒåº¦æ—¶ï¼Œè°ƒåº¦å™¨å°±ä¼šæ‰§è¡Œ idle è¿›ç¨‹ã€‚idle è¿›ç¨‹åœ¨å†…æ ¸å¯åŠ¨ï¼ˆstart_kernel() å‡½æ•°ï¼‰æ—¶é™æ€åˆ›å»ºï¼Œæ‰€æœ‰çš„æ ¸å¿ƒæ•°æ®ç»“æ„éƒ½é¢„å…ˆé™æ€èµ‹å€¼</li><li>ç³»ç»Ÿåˆå§‹åŒ–å¿«å®Œæˆæ—¶ä¼šåˆ›å»ºä¸€ä¸ª init è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„è¿›ç¨‹ 1ï¼Œå®ƒæ˜¯æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹çš„ç¥–å…ˆï¼Œä»è¿™ä¸ªè¿›ç¨‹å¼€å§‹ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½å°†å‚ä¸è°ƒåº¦</li><li>å¦‚æœè¿›ç¨‹ A åˆ›å»ºäº†è¿›ç¨‹ Bï¼Œé‚£ä¹ˆè¿›ç¨‹ A ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œè¿›ç¨‹ B ç§°ä¸ºå­è¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹ B åˆ›å»ºäº†è¿›ç¨‹ Cï¼Œé‚£ä¹ˆè¿›ç¨‹ A å’Œè¿›ç¨‹ C ä¹‹é—´çš„å…³ç³»å°±æ˜¯ç¥–å­™å…³ç³»</li><li>å¦‚æœè¿›ç¨‹ A åˆ›å»ºäº† Biï¼ˆ1 &lt; i&lt; nï¼‰ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆè¿™äº›è¿›ç¨‹ä¹‹é—´ä¸ºå…„å¼Ÿå…³ç³»</li></ul><h1 id="linux-è¿›ç¨‹è°ƒåº¦">Linux è¿›ç¨‹è°ƒåº¦</h1><h2 id="è¿›ç¨‹çš„åˆ†ç±»">è¿›ç¨‹çš„åˆ†ç±»</h2><p>è¿›ç¨‹å¯ä»¥åˆ†æˆä¸¤ç±»ï¼šä¸€ç±»æ˜¯ CPU æ¶ˆè€—å‹ï¼ˆCPU-Boundï¼‰ï¼Œå¦å¤–ä¸€ç±»æ˜¯ I/O æ¶ˆè€—å‹ï¼ˆI/O-Boundï¼‰ã€‚</p><ul><li>CPU æ¶ˆè€—å‹çš„è¿›ç¨‹ä¼šæŠŠå¤§éƒ¨åˆ†æ—¶é—´ç”¨åœ¨æ‰§è¡Œä»£ç ä¸Šï¼Œä¹Ÿå°±æ˜¯ä¸€ç›´å ç”¨ CPU</li><li>I/O æ¶ˆè€—å‹çš„è¿›ç¨‹å¤§éƒ¨åˆ†æ—¶é—´åœ¨æäº¤ I/O è¯·æ±‚æˆ–è€…ç­‰å¾… I/O è¯·æ±‚ï¼Œæ¯”å¦‚éœ€è¦é”®ç›˜è¾“å…¥çš„è¿›ç¨‹æˆ–è€…ç­‰å¾…ç½‘ç»œ I/O çš„è¿›ç¨‹</li></ul><h2 id="è¿›ç¨‹çš„ä¼˜å…ˆçº§å’Œæƒé‡">è¿›ç¨‹çš„ä¼˜å…ˆçº§å’Œæƒé‡</h2><p>æ“ä½œç³»ç»Ÿä¸­æœ€ç»å…¸çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•æ˜¯åŸºäºä¼˜å…ˆçº§è°ƒåº¦ã€‚è°ƒåº¦å™¨æ€»æ˜¯ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰æ‹©ä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œè€Œä¸”ä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹åˆ†é…çš„æ—¶é—´ç‰‡ä¹Ÿä¼šæ¯”ä¼˜å…ˆçº§ä½çš„è¿›ç¨‹å¤šã€‚</p><p>Linux ç³»ç»Ÿæœ€æ—©é‡‡ç”¨ nice å€¼æ¥è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚èŒƒå›´æ˜¯-20~+19ï¼Œé»˜è®¤å€¼æ˜¯ 0ã€‚</p><p>å†…æ ¸ä½¿ç”¨ 0 ~ 139 çš„æ•°å€¼è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§ (normal_prio)ï¼Œæ•°å€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜ã€‚ä¼˜å…ˆçº§åœ¨ Linux ä¸­çš„åˆ’åˆ†æ–¹å¼å¦‚ä¸‹ã€‚</p><ul><li>æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼š100~139(120 + nice)</li><li>å®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼š0~99 (99 - rt_prio)</li><li>deadline è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼š-1</li></ul><p>task struct æ•°æ®ç»“æ„ä¸­æœ‰ 4 ä¸ªæˆå‘˜ï¼Œç”¨æ¥æè¿°è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> {</span></span><br><span class="line">    <span class="type">int</span> prio;</span><br><span class="line">    <span class="type">int</span> static_prio;</span><br><span class="line">    <span class="type">int</span> normal_prio;</span><br><span class="line">    unsignea <span class="type">int</span> rt_priority;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RT_PRIO100</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __normal_prio(<span class="keyword">struct</span> task_struct *p)</span><br><span class="line">{</span><br><span class="line">   <span class="keyword">return</span> p-&gt;static_prio;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">normal_prio</span><span class="params">(<span class="keyword">struct</span> task_struct *p)</span></span><br><span class="line">{</span><br><span class="line">   <span class="type">int</span> prio;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (task_has_dl_policy(p))</span><br><span class="line">   prio = MAX_DL_PRIO<span class="number">-1</span>;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (task_has_rt_policy(p))</span><br><span class="line">   prio = MAX_RT_PRIO<span class="number">-1</span> - p-&gt;rt_priority;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   prio = __normal_prio(p);</span><br><span class="line">   <span class="keyword">return</span> prio;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>static_prio æ˜¯é™æ€ä¼˜å…ˆçº§ï¼Œåœ¨è¿›ç¨‹å¯åŠ¨æ—¶åˆ†é… [120+nice]</li><li>normal_prio æ˜¯åŸºäº static_prio å’Œè°ƒåº¦ç­–ç•¥è®¡ç®—å‡ºæ¥çš„ä¼˜å…ˆçº§ï¼Œåœ¨åˆ›å»ºè¿›ç¨‹æ—¶ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ normal_prioã€‚å¯¹äºæ™®é€šè¿›ç¨‹æ¥è¯´ï¼Œnormal_prio ç­‰åŒäº static_prioï¼›å¯¹äºå®æ—¶è¿›ç¨‹ï¼Œä¼šæ ¹æ® rt_priority é‡æ–°è®¡ç®— normal_prio[99 - rt_priority]</li><li>prio ä¿å­˜ç€è¿›ç¨‹çš„åŠ¨æ€ä¼˜å…ˆçº§ï¼Œä¹Ÿæ˜¯è°ƒåº¦ç±»è€ƒè™‘ä½¿ç”¨çš„ä¼˜å…ˆçº§ã€‚æœ‰äº›æƒ…å†µä¸‹éœ€è¦æš‚æ—¶æé«˜è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚å®æ—¶äº’æ–¥é‡ç­‰</li><li>rt_priority æ˜¯å®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§</li></ul><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œé™¤äº†ä½¿ç”¨ä¼˜å…ˆçº§æ¥è¡¨ç¤ºè¿›ç¨‹çš„è½»é‡ç¼“æ€¥ä¹‹å¤–ï¼Œåœ¨å®é™…çš„è°ƒåº¦å™¨ä¸­ä¹Ÿä½¿ç”¨æƒé‡çš„æ¦‚å¿µæ¥è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¯¦ç»†çš„æƒé‡å«ä¹‰å°†åœ¨ CFS è°ƒåº¦å™¨ä¸€èŠ‚ä¸­ä»‹ç»ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»äº†ã€‚</p><p>æ¨èé˜…è¯» <span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcHJvY2Vzc19tYW5hZ2VtZW50L3Byb2Nlc3MtcHJpb3JpdHkuaHRtbA==">Linux è°ƒåº¦å™¨ï¼šè¿›ç¨‹ä¼˜å…ˆçº§<i class="fa fa-external-link-alt"></i></span> æ›´è¯¦ç»†ã€‚</p><h2 id="è°ƒåº¦ç­–ç•¥">è°ƒåº¦ç­–ç•¥</h2><p>è¿›ç¨‹è°ƒåº¦ä¾èµ–äºè°ƒåº¦ç­–ç•¥ï¼ˆschedule policyï¼‰ï¼ŒLinux å†…æ ¸æŠŠç›¸åŒçš„è°ƒåº¦ç­–ç•¥æŠ½è±¡æˆäº†è°ƒåº¦ç±»ï¼ˆschedule classï¼‰ã€‚ä¸åŒç±»å‹çš„è¿›ç¨‹é‡‡ç”¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥ï¼Œç›®å‰ Linux å†…æ ¸ä¸­é»˜è®¤å®ç°äº† 5 ä¸ªè°ƒåº¦ç±»ï¼Œåˆ†åˆ«æ˜¯ stopã€ deadlineã€realtimeã€CFS å’Œ idleï¼Œå®ƒä»¬åˆ†åˆ«ä½¿ç”¨ sched_class æ¥å®šä¹‰ï¼Œå¹¶ä¸”é€šè¿‡ next æŒ‡é’ˆä¸²è”åœ¨ä¸€èµ·ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/sched_list.png"></p><ul><li>stopï¼š<ul><li>æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ¯” deadline è¿›ç¨‹çš„ä¼˜å…ˆçº§é«˜</li><li>å¯ä»¥æŠ¢å ä»»ä½•è¿›ç¨‹</li><li>åœ¨æ¯ä¸ª CPU ä¸Šå®ç°ä¸€ä¸ªåä¸ºâ€œmigration/Nâ€çš„å†…æ ¸çº¿ç¨‹ï¼ŒN è¡¨ç¤º CPU çš„ç¼–å·ã€‚è¯¥å†…æ ¸çº¿ç¨‹çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¯ä»¥æŠ¢å ä»»ä½•è¿›ç¨‹çš„æ‰§è¡Œï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡Œç‰¹æ®Šçš„åŠŸèƒ½</li><li>ç”¨äºè´Ÿè½½å‡è¡¡æœºåˆ¶ä¸­çš„è¿›ç¨‹è¿ç§»ã€softlockup æ£€æµ‹ã€CPU çƒ­æ’æ‹”ã€RCU ç­‰</li></ul></li><li>deadline(SCHED_DEADLINE )ï¼š<ul><li>æœ€é«˜ä¼˜å…ˆçº§çš„å®æ—¶è¿›ç¨‹ï¼Œä¼˜å…ˆçº§ä¸º-1</li><li>ç”¨äºè°ƒåº¦æœ‰ä¸¥æ ¼æ—¶é—´è¦æ±‚çš„å®æ—¶è¿›ç¨‹ï¼Œå¦‚è§†é¢‘ç¼–è§£ç ç­‰</li></ul></li><li>realtime(SCHED_FIFOã€SCHED_RR)ï¼š<ul><li>æ™®é€šå®æ—¶è¿›ç¨‹ï¼Œä¼˜å…ˆçº§ä¸º 0~99</li><li>ç”¨äºæ™®é€šçš„å®æ—¶è¿›ç¨‹ï¼Œæ¯”å¦‚ IRQ çº¿ç¨‹åŒ–</li></ul></li><li>CFS(SCHED_NORMALã€SCHED_BATCHã€SCHED_IDLE)ï¼š<ul><li>æ™®é€šè¿›ç¨‹ï¼Œä¼˜å…ˆçº§ä¸º 100~139ï¼Œç”± CFS æ¥è°ƒåº¦</li></ul></li><li>idleï¼š<ul><li>æœ€ä½ä¼˜å…ˆçº§çš„è¿›ç¨‹</li><li>å½“å°±ç»ªé˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶ä»–è¿›ç¨‹æ—¶è¿›å…¥ idle è°ƒåº¦ç±»ï¼Œidle è°ƒåº¦ç±»ä¼šè®© CPU è¿›å…¥ä½åŠŸè€—æ¨¡å¼</li></ul></li></ul><blockquote><p>è¿›ç¨‹è°ƒåº¦çš„å…¥å£æ˜¯ schedule() å‡½æ•°ï¼Œä»–ä¼šè°ƒç”¨ pick_next_task() å‡½æ•°ï¼Œpick_next_task() ä¼šä»¥ä¼˜å…ˆçº§ä¸ºåºï¼Œä»é«˜åˆ°ä½ï¼Œä¾æ¬¡æ£€æŸ¥æ¯ä¸€ä¸ªè°ƒåº¦ç±»ï¼Œå¹¶ä»æœ€é«˜ä¼˜å…ˆçº§çš„è°ƒåº¦ç±»ä¸­é€‰æ‹©æœ€é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹è¿è¡Œã€‚</p></blockquote><p>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ä½¿ç”¨è°ƒåº¦ç­–ç•¥ API å‡½æ•°ï¼Œæ¯”å¦‚ sched_setscheduler() æ¥è®¾å®šç”¨æˆ·è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥ã€‚å…¶ä¸­ï¼ŒSCHED_NORMALã€SCHED_BATCH ä»¥åŠ SCHED_IDLE ä½¿ç”¨å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼ˆCFSï¼‰ï¼ŒSCHED_FIFO å’Œ SCHED_RR ä½¿ç”¨ realtime è°ƒåº¦å™¨ï¼ŒSCHED_DEADLINE ä¸“ç”¨ deadline è°ƒåº¦å™¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_NORMAL0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_FIFO    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_RR    2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_BATCH    3</span></span><br><span class="line"><span class="comment">/* SCHED_ISO: reserved but not implemented yet */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_IDLE    5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCHED_DEADLINE6</span></span><br></pre></td></tr></tbody></table></figure><ul><li>SCHED_RRï¼ˆå¾ªç¯ï¼‰è°ƒåº¦ç­–ç•¥è¡¨ç¤ºä¼˜å…ˆçº§ç›¸åŒçš„è¿›ç¨‹ä»¥å¾ªç¯åˆ†äº«æ—¶é—´çš„æ–¹å¼æ‰§è¡Œã€‚è¿›ç¨‹æ¯æ¬¡ä½¿ç”¨ CPU çš„æ—¶é—´ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ—¶é—´ç‰‡ã€‚è¿›ç¨‹ä¼šä¿æŒå æœ‰ CPUï¼Œç›´åˆ°ä¸‹é¢çš„æŸä¸ªæ¡ä»¶å¾—åˆ°æ»¡è¶³ï¼š<ul><li>æ—¶é—´ç‰‡ç”¨å®Œ</li><li>è‡ªæ„¿æ”¾å¼ƒ CPU</li><li>è¿›ç¨‹ç»ˆæ­¢</li><li>è¢«é«˜ä¼˜å…ˆçº§è¿›ç¨‹æŠ¢å </li></ul></li><li>SCHED_FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è°ƒåº¦ç­–ç•¥ä¸ SCHED_RR è°ƒåº¦ç­–ç•¥ç±»ä¼¼ï¼Œåªä¸è¿‡æ²¡æœ‰æ—¶é—´ç‰‡çš„æ¦‚å¿µã€‚ä¸€æ—¦è¿›ç¨‹è·å–äº† CPU æ§åˆ¶æƒï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°ä¸‹é¢çš„æŸä¸ªæ¡ä»¶å¾—åˆ°æ»¡è¶³ï¼š<ul><li>è‡ªæ„¿æ”¾å¼ƒ CPU</li><li>è¿›ç¨‹ç»ˆæ­¢</li><li>è¢«æ›´é«˜ä¼˜å…ˆçº§è¿›ç¨‹æŠ¢å </li></ul></li><li><p>SCHED_BATCHï¼ˆæ‰¹å¤„ç†ï¼‰è°ƒåº¦ç­–ç•¥æ˜¯æ™®é€šè¿›ç¨‹è°ƒåº¦ç­–ç•¥ã€‚è¿™ç§è°ƒåº¦ç­–ç•¥ä¼šè®©è°ƒåº¦å™¨è®¤ä¸ºè¿›ç¨‹æ˜¯ CPU å¯†é›†å‹çš„ã€‚å› æ­¤ï¼Œè°ƒåº¦å™¨å¯¹è¿™ç±»è¿›ç¨‹çš„å”¤é†’æƒ©ç½šï¼ˆwakeup penaltyï¼‰æ¯”è¾ƒå°ã€‚åœ¨ Linux å†…æ ¸é‡Œï¼Œæ­¤ç±»è°ƒåº¦ç­–ç•¥ä½¿ç”¨å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼š</p></li><li><p>SCHED_NORMALï¼ˆä»¥å‰ç§°ä¸º SCHED_OTHERï¼‰åˆ†æ—¶è°ƒåº¦ç­–ç•¥æ˜¯éå®æ—¶è¿›ç¨‹çš„é»˜åº¦ç­–ç•¥ã€‚æ‰€æœ‰æ™®é€šç±»å‹çš„è¿›ç¨‹çš„é™æ€ä¼˜å…ˆçº§éƒ½ä¸º 0ï¼Œå› æ­¤ï¼Œä»»ä½•ä½¿ç”¨ SCHED_FIFOã€SCHED_RR è°ƒåº¦ç­–ç•¥çš„å°±ç»ªè¿›ç¨‹éƒ½ä¼šæŠ¢å å®ƒä»¬ã€‚Linux å†…æ ¸æ²¡æœ‰å®ç°è¿™ç±»è°ƒåº¦ç­–ç•¥ã€‚</p></li><li><p>SCHED_IDLE ç©ºé—²è°ƒåº¦ç­–ç•¥ç”¨äºè¿è¡Œä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚</p></li></ul><blockquote><p>å…¶ä¸­å®æ—¶è¿›ç¨‹ä¸€æ—¦æ‰§è¡Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œéœ€è¦è¿›ç¨‹è‡ªå·±ä¸»åŠ¨æ”¾å¼ƒ CPU ä½¿ç”¨æƒï¼Œåªè¦æœ‰å®æ—¶è¿›ç¨‹åœ¨è¿è¡Œå…¶ä»–æ™®é€šè¿›ç¨‹å°±æ— æ³•å¾—åˆ°æ‰§è¡Œï¼Œå› æ­¤å®æ—¶è¿›ç¨‹çš„è®¾è®¡éœ€è¦æ ¼å¤–å°å¿ƒï¼Œéœ€è¦ä¸»åŠ¨æ”¾å¼ƒ CPU ä½¿ç”¨æƒã€‚</p></blockquote><h2 id="æ—¶é—´ç‰‡">æ—¶é—´ç‰‡</h2><p>æ—¶é—´ç‰‡ï¼ˆtime sliceï¼‰è¡¨ç¤ºè¿›ç¨‹è¢«è°ƒåº¦è¿›ä¸è¢«è°ƒåº¦å‡ºå»ä¹‹é—´æ‰€èƒ½æŒç»­è¿è¡Œçš„æ—¶é—´é•¿åº¦ã€‚é€šå¸¸æ“ä½œç³»ç»Ÿéƒ½ä¼šè§„å®šé»˜è®¤çš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯å¾ˆéš¾ç¡®å®šå¤šé•¿çš„æ—¶é—´ç‰‡æ˜¯åˆé€‚çš„ã€‚I/O æ¶ˆè€—å‹çš„è¿›ç¨‹ä¸éœ€è¦å¾ˆé•¿çš„æ—¶é—´ç‰‡ï¼Œè€Œ CPU æ¶ˆè€—å‹çš„è¿›ç¨‹åˆ™å¸Œæœ›æ—¶é—´ç‰‡è¶Šé•¿è¶Šå¥½ã€‚</p><p>æ—©æœŸçš„ Linux ä¸­çš„è°ƒåº¦å™¨é‡‡ç”¨çš„æ˜¯å›ºå®šæ—¶é—´ç‰‡ï¼Œä½†æ˜¯ç°åœ¨çš„ CFS å·²ç»æŠ›å¼ƒå›ºå®šæ—¶é—´ç‰‡çš„åšæ³•ï¼Œè€Œæ˜¯é‡‡ç”¨è¿›ç¨‹æƒé‡å æ¯”çš„æ–¹æ³•æ¥å…¬å¹³åœ°åˆ’åˆ† CPU æ—¶é—´ï¼Œè¿™æ ·è¿›ç¨‹è·å¾—çš„ CPU æ—¶é—´å°±ä¸è¿›ç¨‹çš„æƒé‡ä»¥åŠ CPU ä¸Šçš„æ€»æƒé‡æœ‰äº†å…³ç³»ã€‚æƒé‡å’Œä¼˜å…ˆçº§ç›¸å…³ï¼Œä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹æƒé‡ä¹Ÿé«˜ï¼Œæœ‰æœºä¼šå ç”¨æ›´å¤šçš„ CPU æ—¶é—´ï¼›è€Œä¼˜å…ˆçº§ä½çš„è¿›ç¨‹æƒé‡ä¹Ÿä½ï¼Œé‚£ä¹ˆç†åº”å ç”¨è¾ƒå°‘çš„ CPU æ—¶é—´ã€‚</p><h1 id="æŠ¢å ">æŠ¢å </h1><ul><li>æŠ¢å å†…æ ¸ï¼šæ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ä¼šæ‰“æ–­å½“å‰è¿›ç¨‹çš„æ‰§è¡Œï¼Œå¾—åˆ°ä¼˜å…ˆæ‰§è¡Œã€‚</li><li>ä¸å¯æŠ¢å å†…æ ¸ï¼šæ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹éœ€è¦ç­‰åˆ°å½“å‰è¿›ç¨‹ä¸»åŠ¨æ”¾å¼ƒ CPU ä½¿ç”¨æƒæ‰å¯ä»¥å¾—åˆ° CPU ä½¿ç”¨æƒã€‚</li></ul><p>ç”¨æˆ·æŠ¢å æ—¶æœºï¼š</p><ul><li>ä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li><li>ä»ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li></ul><p>å†…æ ¸æŠ¢å æ—¶æœºï¼š</p><ul><li>ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œè¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰</li><li>å†…æ ¸ä»£ç å†ä¸€æ¬¡å…·æœ‰å¯æŠ¢å æ€§çš„æ—¶å€™</li><li>å†…æ ¸æ˜¾å¼è°ƒç”¨ schedule()</li><li>å†…æ ¸ä¸­çš„ä»»åŠ¡ sleep çš„æ—¶å€™ä¼šè°ƒç”¨ schedule()</li></ul><h1 id="ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸Šä¸‹æ–‡åˆ‡æ¢</h1><ul><li><p>CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š CPU ä¸Šä¸‹æ–‡åŒ…æ‹¬ CPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼ŒCPU ä¸Šä¸‹æ–‡åˆ‡æ¢å°±æ˜¯å…ˆæŠŠå‰ä¸€ä¸ªä»»åŠ¡çš„ CPU ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿå°±æ˜¯ CPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼‰ä¿å­˜èµ·æ¥ï¼Œç„¶ååŠ è½½æ–°ä»»åŠ¡çš„ä¸Šä¸‹æ–‡åˆ°è¿™äº›å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼Œæœ€åå†è·³è½¬åˆ°ç¨‹åºè®¡æ•°å™¨æ‰€æŒ‡çš„æ–°ä½ç½®ï¼Œè¿è¡Œæ–°ä»»åŠ¡ã€‚ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šå‘ç”Ÿ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯æ²¡æœ‰åˆ‡æ¢è¿›ç¨‹ï¼Œå§‹ç»ˆåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œè¿è¡Œã€‚</p></li><li><p>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸ä»…åŒ…æ‹¬äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬äº†å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„çŠ¶æ€ã€‚è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å°±æ¯”ç³»ç»Ÿè°ƒç”¨æ—¶å¤šäº†ä¸€æ­¥ï¼šåœ¨ä¿å­˜å†…æ ¸æ€èµ„æºï¼ˆå½“å‰è¿›ç¨‹çš„å†…æ ¸çŠ¶æ€å’Œ CPU å¯„å­˜å™¨ï¼‰ä¹‹å‰ï¼Œéœ€è¦å…ˆæŠŠè¯¥è¿›ç¨‹çš„ç”¨æˆ·æ€èµ„æºï¼ˆè™šæ‹Ÿå†…å­˜ã€æ ˆç­‰ï¼‰ä¿å­˜ä¸‹æ¥ï¼›è€ŒåŠ è½½äº†ä¸‹ä¸€è¿›ç¨‹çš„å†…æ ¸æ€åï¼Œè¿˜éœ€è¦åˆ·æ–°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å’Œç”¨æˆ·æ ˆã€‚</p></li><li><p>ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š ä¸­æ–­ä¸Šä¸‹æ–‡åŒ…æ‹¬ CPU å¯„å­˜å™¨ã€å†…æ ¸å †æ ˆã€ç¡¬ä»¶ä¸­æ–­å‚æ•°ç­‰ã€‚ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢å¹¶ä¸æ¶‰åŠåˆ°è¿›ç¨‹çš„ç”¨æˆ·æ€ã€‚æ‰€ä»¥ï¼Œå³ä¾¿ä¸­æ–­è¿‡ç¨‹æ‰“æ–­äº†ä¸€ä¸ªæ­£å¤„åœ¨ç”¨æˆ·æ€çš„è¿›ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ä¿å­˜å’Œæ¢å¤è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·æ€èµ„æºã€‚åªä¿å­˜ CPU å¯„å­˜å™¨ã€å†…æ ¸å †æ ˆã€ç¡¬ä»¶ä¸­æ–­å‚æ•°ç­‰ä¸­æ–­æœåŠ¡ç¨‹åºæ‰§è¡Œæ‰€å¿…éœ€çš„çŠ¶æ€ã€‚</p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcHJvY2Vzc19tYW5hZ2VtZW50LzE5Lmh0bWw=">http://www.wowotech.net/process_management/19.html<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Task </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ARM64 æ¶æ„åŸºç¡€</title>
      <link href="/2021/Program/ARM64Struct/"/>
      <url>/2021/Program/ARM64Struct/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/ARM64Struct.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1OTNjNzU2NTNiYjA3MWU2ZTllYjE=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="arm64-æ¶æ„ä»‹ç»">ARM64 æ¶æ„ä»‹ç»</h1><h2 id="armv8-a-æ¶æ„ä»‹ç»">ARMv8-A æ¶æ„ä»‹ç»</h2><p>ARMv8-A æ˜¯ ARM å…¬å¸å‘å¸ƒçš„ç¬¬ä¸€ä»£æ”¯æŒ 64 ä½å¤„ç†å™¨çš„æŒ‡ä»¤é›†å’Œæ¶æ„ã€‚ARMv8-A æ¶æ„é™¤äº†æé«˜äº†å¤„ç†èƒ½åŠ›å¤–ï¼Œè¿˜å¼•å…¥äº†å¾ˆå¤šå¸å¼•äººçš„æ–°ç‰¹æ€§ã€‚</p><ul><li>å…·æœ‰ 64 ä½å®½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li><li>æä¾› 31 ä¸ª 64 ä½å®½çš„é€šç”¨å¯„å­˜å™¨ï¼Œå¯ä»¥å‡å°‘å¯¹æ ˆçš„è®¿é—®ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li><li>æä¾› 16KB å’Œ 64KB çš„ pageï¼Œæœ‰åŠ©äºé™ä½ TLB çš„æœªå‘½ä¸­ç‡ï¼ˆmiss rateï¼‰ã€‚</li><li>å…·æœ‰å…¨æ–°çš„å¼‚å¸¸å¤„ç†æ¨¡å‹ï¼Œæœ‰åŠ©äºé™ä½æ“ä½œç³»ç»Ÿå’Œè™šæ‹ŸåŒ–çš„å®ç°å¤æ‚åº¦ã€‚</li><li>å…·æœ‰å…¨æ–°çš„åŠ è½½-è·å–ã€å­˜å‚¨-é‡Šæ”¾æŒ‡ä»¤ï¼ˆload-acquireï¼Œstore-release instructionï¼‰ï¼Œä¸“ä¸º C++11 ä»¥åŠ Java å†…å­˜æ¨¡å‹è€Œè®¾è®¡ã€‚</li></ul><h2 id="arm64-çš„åŸºæœ¬æ¦‚å¿µ">ARM64 çš„åŸºæœ¬æ¦‚å¿µ</h2><p>ARM å¤„ç†å™¨å®ç°çš„æ˜¯ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœºï¼ˆReduced Instruction Set Computerï¼ŒRISCï¼‰æ¶æ„ã€‚æœ¬èŠ‚ä»‹ç» ARMv8-A æ¶æ„ä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p><ul><li><p>å¤„ç†å•å…ƒï¼š ARM å…¬å¸çš„å®˜æ–¹æŠ€æœ¯æ‰‹å†Œä¸­æåˆ°äº†ä¸€ä¸ªæ¦‚å¿µï¼Œå¯ä»¥æŠŠå¤„ç†å™¨å¤„ç†äº‹åŠ¡çš„è¿‡ç¨‹æŠ½è±¡ä¸ºå¤„ç†å•å…ƒï¼ˆProcessing Elementï¼Œï¼ˆPEï¼‰</p></li><li>æ‰§è¡ŒçŠ¶æ€ï¼š æ‰§è¡ŒçŠ¶æ€ï¼ˆexecution stateï¼‰æ˜¯å¤„ç†å™¨è¿è¡Œæ—¶çš„ç¯å¢ƒï¼ŒåŒ…æ‹¬å¯„å­˜å™¨çš„ä½å®½ã€æ”¯æŒçš„æŒ‡ä»¤é›†å¼‚å¸¸æ¨¡å‹ã€å†…å­˜ç®¡ç†ä»¥åŠç¼–ç¨‹æ¨¡å‹ç­‰ã€‚ARMv8 æ¶æ„å®šä¹‰äº†ä¸¤ç§æ‰§è¡Œæ¨¡å¼<ul><li>AArch64:64 ä½çš„æ‰§è¡ŒçŠ¶æ€ã€‚æä¾› 31 ä¸ª 64 ä½çš„é€šç”¨å¯„å­˜å™¨ã€æä¾› 64 ä½çš„ç¨‹åºè®¡æ•°ï¼ˆPCï¼‰å¯„å­˜å™¨ã€æ ˆæŒ‡é’ˆï¼ˆSPï¼‰å¯„å­˜å™¨ä»¥åŠå¼‚å¸¸é“¾æ¥å¯„å­˜å™¨ï¼ˆELRï¼‰ã€‚æä¾› A64 æŒ‡ä»¤é›†ã€å®šä¹‰ ARMv8 å¼‚å¸¸æ¨¡å‹ï¼Œæ”¯æŒ 4 ä¸ªå¼‚å¸¸ç­‰çº§ ELO~EL3</li><li>AArch32:32 ä½çš„æ‰§è¡ŒçŠ¶æ€ã€‚æä¾› 13 ä¸ª 32 ä½çš„é€šç”¨å¯„å­˜å™¨ï¼Œå†åŠ ä¸Š PC å¯„å­˜å™¨ã€SP å¯„å­˜å™¨ã€é“¾æ¥å¯„å­˜å™¨ï¼ˆLRï¼‰ã€‚æ”¯æŒä¸¤å¥—æŒ‡ä»¤é›†ï¼Œåˆ†åˆ«æ˜¯ A32 å’Œ T32 æŒ‡ä»¤é›†ï¼ˆThumb æŒ‡ä»¤é›†ï¼‰</li></ul></li><li>ARMv8 æŒ‡ä»¤é›†ï¼š<ul><li>A64 æŒ‡ä»¤é›†ï¼šè¿è¡Œåœ¨ AArch64 çŠ¶æ€ï¼Œæä¾› 64 ä½æŒ‡ä»¤é›†æ”¯æŒ</li><li>A32 æŒ‡ä»¤é›†ï¼šè¿è¡Œåœ¨ AArch32 çŠ¶æ€ï¼Œæä¾› 32 ä½æŒ‡ä»¤é›†æ”¯æŒ</li><li>T32 æŒ‡ä»¤é›†ï¼šè¿è¡Œåœ¨ AArch32 çŠ¶æ€ï¼Œæä¾› 16 å’Œ 32 ä½æŒ‡ä»¤é›†æ”¯æŒ</li></ul></li><li><p>ç³»ç»Ÿå¯„å­˜å™¨å‘½åï¼š åœ¨ AArch64 çŠ¶æ€ä¸‹ï¼Œå¾ˆå¤šç³»ç»Ÿå¯„å­˜å™¨ä¼šæ ¹æ®ä¸åŒçš„å¼‚å¸¸ç­‰çº§æä¾›ä¸åŒçš„å˜ç§å¯„å­˜å™¨</p><p><register_name>_ELx, where x is 0,1, 2, or 3</register_name></p></li></ul><p>æ¯”å¦‚ï¼ŒSP_ELO è¡¨ç¤º ELO ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒSP_EL1 è¡¨ç¤º EL1 ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ã€‚</p><h2 id="armv8-å¤„ç†å™¨çš„è¿è¡ŒçŠ¶æ€">ARMv8 å¤„ç†å™¨çš„è¿è¡ŒçŠ¶æ€</h2><p>ARMv8 å¤„ç†å™¨æ”¯æŒä¸¤ç§è¿è¡ŒçŠ¶æ€--AArch64 çŠ¶æ€å’Œ AArch32 çŠ¶æ€ã€‚AArch64 æ¶æ„çš„å¼‚å¸¸ç­‰çº§ï¼ˆexception levelï¼‰ç¡®å®šäº†å¤„ç†å™¨å½“å‰è¿è¡Œçš„ç‰¹æƒçº§åˆ«ï¼Œç±»ä¼¼äº ARMv7 æ¶æ„ä¸­çš„ç‰¹æƒç­‰çº§ã€‚</p><ul><li>EL0ï¼šç”¨æˆ·ç‰¹æƒï¼Œç”¨äºè¿è¡Œæ™®é€šç”¨æˆ·ç¨‹åºã€‚</li><li>EL1ï¼šç³»ç»Ÿç‰¹æƒï¼Œé€šå¸¸ç”¨äºè¿è¡Œæ“ä½œç³»ç»Ÿã€‚</li><li>EL2ï¼šè¿è¡Œè™šæ‹ŸåŒ–æ‰©å±•çš„è™šæ‹Ÿç›‘æ§ç¨‹åºï¼ˆhypervisorï¼‰ã€‚</li><li>EL3ï¼šè¿è¡Œå®‰å…¨ä¸–ç•Œä¸­çš„å®‰å…¨ç›‘æ§å™¨ï¼ˆsecure monitorï¼‰ã€‚</li></ul><p>åœ¨ ARMv8 æ¶æ„é‡Œå…è®¸åˆ‡æ¢åº”ç”¨ç¨‹åºçš„è¿è¡Œæ¨¡å¼ã€‚æ¯”å¦‚ï¼Œåœ¨è¿è¡Œ 64 ä½æ“ä½œç³»ç»Ÿçš„ ARMv8 å¤„ç†å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶è¿è¡Œ A64 æŒ‡ä»¤é›†çš„åº”ç”¨ç¨‹åºå’Œ A32 æŒ‡ä»¤é›†çš„åº”ç”¨ç¨‹åºã€‚å½“éœ€è¦æ‰§è¡Œ A32 æŒ‡ä»¤é›†çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œéœ€è¦é€šè¿‡ç®¡ç†å‘˜è°ƒç”¨ï¼ˆSupervisor Call, SVCï¼‰æŒ‡ä»¤åˆ‡æ¢åˆ° EL1 æ“ä½œç³»ç»Ÿä¼šæ‰§è¡Œä»»åŠ¡çš„åˆ‡æ¢å¹¶ä¸”è¿”å›åˆ° AArch32 çš„ ELOï¼Œè¿™æ—¶å€™ç³»ç»Ÿä¾¿ä¸ºè¿™ä¸ªåº”ç”¨ç¨‹åºå¤‡å¥½äº† AArch32 çš„è¿è¡Œç¯å¢ƒã€‚</p><h2 id="ä¸å¯¹é½è®¿é—®">ä¸å¯¹é½è®¿é—®</h2><p>å¯¹é½è®¿é—®æœ‰ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æ˜¯æŒ‡ä»¤å¯¹é½ï¼Œå¦ä¸€ç§æ˜¯æ•°æ®å¯¹é½ã€‚</p><ul><li>A64 æŒ‡ä»¤é›†è¦æ±‚æŒ‡ä»¤å­˜æ”¾çš„ä½ç½®å¿…é¡»ä»¥å­—ï¼ˆwordï¼Œ32 ä½å®½ï¼‰ä¸ºå•ä½å¯¹é½ã€‚è®¿é—®å­˜å‚¨ä½ç½®ä¸æ˜¯ä»¥å­—ä¸ºå•ä½å¯¹é½çš„æŒ‡ä»¤ä¼šå¯¼è‡´ PC å¯¹é½å¼‚å¸¸ï¼ˆPCaligment faultï¼‰ã€‚</li><li>å¯¹äºæ•°æ®è®¿é—®ï¼Œéœ€è¦åŒºåˆ†ä¸åŒçš„å†…å­˜ç±»å‹ã€‚<ul><li>å¯¹å†…å­˜ç±»å‹æ˜¯è®¾å¤‡å†…å­˜çš„ä¸å¯¹é½è®¿é—®ä¼šè§¦å‘å¯¹é½å¼‚å¸¸ï¼ˆalignment faultï¼‰</li><li>å¯¹äºè®¿é—®æ™®é€šå†…å­˜ï¼Œé™¤äº†ä½¿ç”¨ç‹¬å ã€åŠ è½½/ç‹¬å -å­˜å‚¨ï¼ˆload-exclusive/store-exclusiveï¼‰æŒ‡ä»¤æˆ–åŠ è½½-è·å–/å­˜å‚¨-é‡Šæ”¾ï¼ˆload-acquire/store-releaseï¼‰æŒ‡ä»¤å¤–ï¼Œè¿˜å¯ä½¿ç”¨å…¶ä»–çš„ç”¨äºåŠ è½½æˆ–å­˜å‚¨å•ä¸ªæˆ–å¤šä¸ªå¯„å­˜å™¨çš„æ‰€æœ‰æŒ‡ä»¤ã€‚å¦‚æœè®¿é—®åœ°å€å’Œè¦è®¿é—®çš„æ•°æ®å…ƒç´ å¤§å°ä¸å¯¹é½ï¼Œé‚£ä¹ˆå¯ä»¥æ ¹æ®ä»¥ä¸‹ä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š<ul><li>è‹¥å¯¹åº”çš„å¼‚å¸¸ç­‰çº§ä¸­çš„ SCTLR_ELx å¯„å­˜å™¨çš„ A åŸŸè®¾ç½®ä¸º 1ï¼Œåˆ™è¯´æ˜æ‰“å¼€äº†åœ°å€å¯¹é½æ£€æŸ¥åŠŸèƒ½ï¼Œå› è€Œä¼šè§¦å‘å¯¹é½å¼‚å¸¸</li><li>è‹¥å¯¹åº”çš„å¼‚å¸¸ç­‰çº§ä¸­çš„ SCTLRELx å¯„å­˜å™¨çš„ A åŸŸè®¾ç½®ä¸º 0ï¼Œåˆ™è¯´æ˜å¤„ç†å™¨æ”¯æŒä¸å¯¹é½è®¿é—®</li></ul></li></ul></li></ul><p>å½“ç„¶ï¼Œå¤„ç†å™¨æ”¯æŒçš„ä¸å¯¹é½è®¿é—®ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ã€‚</p><ul><li>ä¸èƒ½ä¿è¯å•æ¬¡è®¿é—®åŸå­åœ°å®Œæˆï¼Œæœ‰å¯èƒ½å¤åˆ¶å¤šæ¬¡ã€‚</li><li>ä¸å¯¹é½è®¿é—®æ¯”å¯¹é½è®¿é—®éœ€è¦æ›´å¤šçš„å¤„ç†æ—¶é—´ã€‚</li><li>ä¸å¯¹é½çš„åœ°å€è®¿é—®å¯èƒ½ä¼šå¼•å‘ä¸­æ­¢ï¼ˆabortï¼‰ã€‚</li></ul><h1 id="armv8-å¯„å­˜å™¨">ARMv8 å¯„å­˜å™¨</h1><h2 id="é€šç”¨å¯„å­˜å™¨">é€šç”¨å¯„å­˜å™¨</h2><p>AArch64 è¿è¡ŒçŠ¶æ€æ”¯æŒ 31 ä¸ª 64 ä½çš„é€šç”¨å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ x0~x30 å¯„å­˜å™¨ï¼Œè€Œ AArch32 è¿è¡ŒçŠ¶æ€æ”¯æŒ 16 ä¸ª 32 ä½çš„é€šç”¨å¯„å­˜å™¨ã€‚é€šç”¨å¯„å­˜å™¨é™¤äº†ç”¨äºæ•°æ®è¿ç®—å’Œå­˜å‚¨ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­èµ·åˆ°ç‰¹æ®Šä½œç”¨ï¼ŒARM64 æ¶æ„çš„å‡½æ•°è°ƒç”¨æ ‡å‡†å’Œè§„èŒƒå¯¹æ­¤æœ‰æ‰€çº¦å®šã€‚</p><ul><li>ä¼ é€’å‚æ•°å’Œç»“æœï¼šx0 - x7ã€‚</li><li>é—´æ¥ç»“æœå¯„å­˜å™¨ï¼šx8ã€‚</li><li>ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨çš„å‡½æ•°éœ€è¦ä¿å­˜ï¼‰: x8 - x15ã€‚</li><li>å¹³å°å¯„å­˜å™¨ï¼šx16(IP0) x17(IP1) x18(PR)ã€‚</li><li>è¢«è°ƒç”¨å‡½æ•°éœ€è¦ä¿å­˜ï¼šx19 - x28ã€‚</li><li>æ ˆå¸§å¯„å­˜å™¨ï¼šx29(FP)ã€‚</li><li>é“¾æ¥å¯„å­˜å™¨ï¼šx30(LR)ã€‚</li></ul><p>åœ¨ AArch64 è¿è¡ŒçŠ¶æ€ä¸‹ï¼Œä½¿ç”¨ X æ¥è¡¨ç¤º 64 ä½é€šç”¨å¯„å­˜å™¨ï¼Œæ¯”å¦‚ X0ã€X30 ç­‰ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ W æ¥è¡¨ç¤ºä½ 32 ä½çš„å¯„å­˜å™¨ï¼Œæ¯”å¦‚ W0 è¡¨ç¤º X0 å¯„å­˜å™¨çš„ä½ 32 ä½æ•°æ®ã€‚</p><h2 id="ç‰¹æ®Šå¯„å­˜å™¨">ç‰¹æ®Šå¯„å­˜å™¨</h2><p>ARMv8 æ¶æ„é™¤äº†æ”¯æŒ 31 ä¸ªé€šç”¨å¯„å­˜å™¨ä¹‹å¤–ï¼Œè¿˜æä¾›å„ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/arm64_register.png"></p><h3 id="é›¶å¯„å­˜å™¨">é›¶å¯„å­˜å™¨</h3><p>ARMv8 æ¶æ„æä¾›ä¸¤ä¸ªé›¶å¯„å­˜å™¨ï¼ˆzero registerï¼‰ï¼Œè¿™ä¸¤ä¸ªé›¶å¯„å­˜å™¨çš„å†…å®¹å…¨æ˜¯ 0ï¼Œå¯ä»¥ç”¨ä½œæºå¯„å­˜å™¨ï¼Œä¹Ÿå¯ä»¥å½“ä½œç›®æ ‡å¯„å­˜å™¨ã€‚WZR æ˜¯ 32 ä½çš„é›¶å¯„å­˜å™¨ï¼ŒXZR æ˜¯ 64 ä½çš„é›¶å¯„å­˜å™¨ã€‚</p><h3 id="æ ˆæŒ‡é’ˆå¯„å­˜å™¨">æ ˆæŒ‡é’ˆå¯„å­˜å™¨</h3><p>ARMv8 æ¶æ„æ”¯æŒ 4 ä¸ªå¼‚å¸¸ç­‰çº§ï¼Œæ¯ä¸€ä¸ªå¼‚å¸¸ç­‰çº§éƒ½æœ‰ä¸“é—¨çš„ SP_ELn å¯„å­˜å™¨ï¼Œæ¯”å¦‚å½“å¤„ç†å™¨è¿è¡Œåœ¨ EL1 æ—¶å°±é€‰æ‹© SP_EL1 å¯„å­˜å™¨ä½œä¸ºæ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼ŒSPï¼‰å¯„ä»”å™¨ã€‚</p><ul><li>SP EL0ï¼šEL0 ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ã€‚</li><li>SP EL1ï¼šEL1 ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ã€‚</li><li>SP EL2ï¼šEL2 ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ã€‚</li><li>SP EL3ï¼šEL3 ä¸‹çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ã€‚</li></ul><p>å½“å¤„ç†å™¨è¿è¡Œåœ¨æ¯” EL0 é«˜çš„å¼‚å¸¸ç­‰çº§æ—¶ï¼š</p><ul><li>å¤„ç†å™¨å¯ä»¥è®¿é—®å½“å‰å¼‚å¸¸ç­‰çº§å¯¹åº”çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ SP_ELnã€‚</li><li>EL0 å¯¹åº”çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ SP_ELO å¯ä»¥å½“ä½œä¸´æ—¶å¯„å­˜å™¨ï¼Œæ¯”å¦‚ Linux å†…æ ¸å°±ä½¿ç”¨è¿™ç§ä¸´æ—¶å¯„å­˜å™¨å­˜æ”¾è¿›ç¨‹çš„ task struct æ•°æ®ç»“æ„çš„æŒ‡é’ˆã€‚</li><li>å½“è¿è¡Œåœ¨ ELO æ—¶ï¼Œå¤„ç†å™¨åªèƒ½è®¿é—® SP_EL0 å¯„å­˜å™¨ï¼Œè€Œä¸èƒ½è®¿é—®å…¶ä»–é«˜ç­‰çº§çš„ SP å¯„å­˜å™¨ã€‚</li></ul><h3 id="pc-å¯„å­˜å™¨">PC å¯„å­˜å™¨</h3><p>PC ï¼ˆProgram Counterï¼‰å¯„å­˜å™¨é€šå¸¸ç”¨æ¥æŒ‡å‘å½“å‰è¿è¡ŒæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œç”¨äºæ§åˆ¶ç¨‹åºä¸­æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œä½†æ˜¯ç¼–ç¨‹äººå‘˜ä¸èƒ½é€šè¿‡æŒ‡ä»¤æ¥ç›´æ¥è®¿é—®ã€‚</p><h3 id="å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨">å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨</h3><p>å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨ï¼ˆException Link Registerï¼ŒELRï¼‰ç”¨æ¥å­˜æ”¾å¼‚å¸¸è¿”å›åœ°å€ã€‚</p><h3 id="ä¿å­˜å¤„ç†çŠ¶æ€å¯„å­˜å™¨">ä¿å­˜å¤„ç†çŠ¶æ€å¯„å­˜å™¨</h3><p>å½“æˆ‘ä»¬è¿›è¡Œå¼‚å¸¸å¤„ç†æ—¶ï¼Œå¤„ç†å™¨çš„å¤„ç†çŠ¶æ€ä¼šä¿å­˜åˆ°ä¿å­˜å¤„ç†çŠ¶æ€å¯„å­˜å™¨ï¼ˆSavedProcess Status Registerï¼Œï¼ˆSPSRï¼‰é‡Œï¼Œè¿™ç§å¯„å­˜å™¨éå¸¸ç±»ä¼¼äº ARMv7 æ¶æ„ä¸­çš„ CPSRã€‚å½“å¼‚å¸¸å°†è¦å‘ç”Ÿæ—¶ï¼Œå¤„ç†å™¨ä¼šæŠŠå¤„ç†çŠ¶æ€å¯„å­˜å™¨ï¼ˆPSTATEï¼‰çš„å€¼æš‚æ—¶ä¿å­˜åˆ° SPSR é‡Œï¼›å½“å¼‚å¸¸å¤„ç†å®Œæˆå¹¶è¿”å›æ—¶ï¼Œå†æŠŠ SPSR ä¸­çš„å€¼æ¢å¤åˆ°å¤„ç†å™¨çŠ¶æ€å¯„å­˜å™¨ã€‚SPSR çš„å¸ƒå±€å¦‚å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/pstate_64.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/pstate_32.png"></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/pstate_top.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/pstate_bottom.png"></p><ul><li>CurrentEL å¯„å­˜å™¨ï¼š PSTATE å¯„å­˜å™¨ä¸­çš„ EL å­—æ®µä¿å­˜äº†å½“å‰å¼‚å¸¸ç­‰çº§ã€‚ä½¿ç”¨ MRS æŒ‡ä»¤å¯ä»¥è¯»å–å½“å‰å¼‚ç­‰çº§ã€‚<ul><li>0ï¼šè¡¨ç¤º ELO</li><li>1ï¼šè¡¨ç¤º EL1</li><li>2ï¼šè¡¨ç¤º EL2</li><li>3ï¼šè¡¨ç¤º EL3</li></ul></li><li>DAIF å¯„å­˜å™¨ï¼š è¡¨ç¤º PSTATE å¯„å­˜å™¨ä¸­çš„{Dï¼ŒAï¼ŒIï¼ŒF}å­—æ®µ<ul><li>D Debug exceptions mask</li><li>A SError interrupt Process state mask, for example, asynchronous external abort</li><li>I IRQ interrupt Process state mask</li><li>F FIQ interrupt Process state mask</li></ul></li><li>SPSel å¯„å­˜å™¨ï¼š è¡¨ç¤º PSTATE å¯„å­˜å™¨ä¸­çš„ SP å­—æ®µï¼Œç”¨æ¥åœ¨ SP_EL0 å’Œ SP_ELn ä¸­é€‰æ‹©æ ˆæŒ‡é’ˆå¯„å­˜å™¨</li></ul><h2 id="ç³»ç»Ÿå¯„å­˜å™¨">ç³»ç»Ÿå¯„å­˜å™¨</h2><p>é™¤äº†ä¸Šé¢ä»‹ç»çš„é€šç”¨å¯„å­˜å™¨å’Œç‰¹æ®Šå¯„å­˜å™¨ä¹‹å¤–ï¼ŒARMv8 æ¶æ„è¿˜å®šä¹‰äº†å¾ˆå¤šç³»ç»Ÿå¯„å­˜å™¨ï¼Œå¯é€šè¿‡è®¿é—®å’Œè®¾ç½®è¿™äº›ç³»ç»Ÿå¯„å­˜å™¨æ¥å®Œæˆå¯¹å¤„ç†å™¨ä¸åŒåŠŸèƒ½çš„é…ç½®ã€‚åœ¨ ARMv7 æ¶æ„é‡Œï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è®¿é—® CP15 åå¤„ç†å™¨æ¥é—´æ¥è®¿é—®è¿™äº›ç³»ç»Ÿå¯„å­˜å™¨ï¼šè€Œåœ¨ ARMv8 æ¶æ„ä¸­æ²¡æœ‰åå¤„ç†å™¨ï¼Œå¯ç›´æ¥è®¿é—®ç³»ç»Ÿå¯„å­˜å™¨ã€‚ARMv8 æ¶æ„æ”¯æŒå¦‚ä¸‹ 7 å¤§ç±»çš„ç³»ç»Ÿå¯„å­˜å™¨ï¼š</p><ul><li>é€šç”¨ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨</li><li>è°ƒè¯•å¯„å­˜å™¨</li><li>æ€§èƒ½ç›‘æ§å¯„å­˜å™¨</li><li>æ´»åŠ¨ç›‘æ§å¯„å­˜å™¨</li><li>ç»Ÿè®¡æ‰©å±•å¯„å­˜å™¨</li><li>RAS å¯„å­˜å™¨</li><li>é€šç”¨å®šæ—¶å™¨å¯„å­˜å™¨</li></ul><p>ç³»ç»Ÿå¯„å­˜å™¨æ”¯æŒä¸åŒå¼‚å¸¸ç­‰çº§ä¸‹çš„è®¿é—®ï¼Œé€šå¸¸ç³»ç»Ÿå¯„å­˜å™¨å¯ä½¿ç”¨â€œReg_ELnâ€çš„æ–¹å¼æ¥è¡¨ç¤ºï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p><ul><li>Reg_EL1ï¼šå¤„ç†å™¨å¤„äº EL1ã€EL2 ä»¥åŠ EL3 æ—¶å¯ä»¥è®¿é—®è¯¥å¯„å­˜å™¨ã€‚</li><li>Reg_EL2ï¼šå¤„ç†å™¨å¤„äº EL2 å’Œ EL3 æ—¶å¯ä»¥è®¿é—®è¯¥å¯„å­˜å™¨ã€‚</li></ul><p>å½“å¤„äº EL0 æ—¶ï¼Œå¤§éƒ¨åˆ†ç³»ç»Ÿå¯„å­˜å™¨ä¸æ”¯æŒå¤„ç†å™¨è®¿é—®ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ä¾‹å¤–ï¼Œæ¯”å¦‚ CTR_ELOã€‚å¯ä»¥é€šè¿‡ MSR å’Œ MRS æŒ‡ä»¤æ¥è®¿é—®ç³»ç»Ÿå¯„å­˜å™¨ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mrs x0, TTBRO_EL1 //æŠŠ TTBR0_EL1 çš„å€¼å¤åˆ¶åˆ° x0 å¯„å­˜å™¨</span><br><span class="line">msr TTBROEL1, xO //æŠŠ x0 å¯„å­˜å™¨çš„å€¼å¤åˆ¶åˆ° TTBR0_EL1</span><br></pre></td></tr></tbody></table></figure><h1 id="a64-æŒ‡ä»¤é›†">A64 æŒ‡ä»¤é›†</h1><p>æŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰æ˜¯å¤„ç†å™¨æ¶æ„è®¾è®¡çš„é‡ç‚¹ä¹‹ä¸€ã€‚ARM å…¬å¸å®šä¹‰å’Œå®ç°çš„æŒ‡ä»¤é›†æ¶æ„ä¸€ç›´åœ¨ä¸æ–­å˜åŒ–å’Œå‘å±•ã€‚ARMv8 æ¶æ„æœ€å¤§çš„æ”¹å˜æ˜¯å¢åŠ äº†ä¸€ç§æ–°çš„ 64 ä½çš„æŒ‡ä»¤é›†ï¼Œè¿™æ˜¯å¯¹æ—©å‰ ARM æŒ‡ä»¤é›†çš„æœ‰ç›Šè¡¥å……å’Œå¢å¼ºï¼Œç§°ä¸º A64 æŒ‡ä»¤é›†ã€‚è¿™ç§æŒ‡ä»¤é›†å¯ä»¥å¤„ç† 64 ä½å®½çš„å¯„å­˜å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ 64 ä½çš„æŒ‡é’ˆæ¥è®¿é—®å†…å­˜ï¼Œè¿è¡Œåœ¨ AArch64 çŠ¶æ€ä¸‹ã€‚ARMv8 å…¼å®¹è€çš„ 32 ä½æŒ‡ä»¤é›†ï¼Œåˆç§°ä¸º A32 æŒ‡ä»¤é›†ï¼Œè¿è¡Œåœ¨ AArch32 çŠ¶æ€ä¸‹ã€‚ A64 æŒ‡ä»¤é›†å’Œ A32 æŒ‡ä»¤é›†æ˜¯ä¸å…¼å®¹çš„ï¼Œå®ƒä»¬æ˜¯ä¸¤å¥—å®Œå…¨ä¸ä¸€æ ·çš„æŒ‡ä»¤é›†æ¶æ„ï¼Œå®ƒä»¬çš„æŒ‡ä»¤ç¼–ç ä¹Ÿä¸ä¸€æ ·ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒA64 æŒ‡ä»¤é›†çš„æŒ‡ä»¤ä¸º 32 ä½å®½ï¼Œè€Œä¸æ˜¯ 64 ä½å®½</p><h2 id="aarch64-æ¶æ„å›¾">aarch64 æ¶æ„å›¾</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/arm64_alu.png"></p><h2 id="æŒ‡ä»¤é›†æ¦‚è§ˆ">æŒ‡ä»¤é›†æ¦‚è§ˆï¼š</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/a64_1.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/a64_2.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/a64_3.png"></p><p>è¯¦ç»†å¯ä»¥æŸ¥çœ‹åŸæ–‡ <span class="exturl" data-url="aHR0cHM6Ly9jb3Vyc2VzLmNzLndhc2hpbmd0b24uZWR1L2NvdXJzZXMvY3NlNDY5LzE5d2kvYXJtNjQucGRm">ç‚¹å‡»<i class="fa fa-external-link-alt"></i></span></p><h1 id="arm64-å¼‚å¸¸å¤„ç†">ARM64 å¼‚å¸¸å¤„ç†</h1><p>åœ¨ arm64 æ¶æ„é‡Œï¼Œä¸­æ–­å±äºå¼‚å¸¸çš„ä¸€ç§ã€‚ä¸­æ–­æ˜¯å¤–éƒ¨è®¾å¤‡é€šçŸ¥å¤„ç†å™¨çš„ä¸€ç§æ–¹å¼ï¼Œä»–ä¼šæ‰“æ–­å¤„ç†å™¨æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤æµã€‚åœ¨å‰é¢çš„æè¿°ä¸­æ–­çš„æ–‡ç« ä¸­å·²ç»ä»‹ç»äº†å…³äºå¼‚å¸¸çš„å¤„ç†ï¼Œè¿™é‡Œä¸å†ç»†è¯´ã€‚</p><h1 id="arm64-å†…å­˜ç®¡ç†">ARM64 å†…å­˜ç®¡ç†</h1><p>å¦‚å›¾æ‰€ç¤ºï¼ŒARM å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰åŒ…æ‹¬ TLB å’Œé¡µè¡¨éå†å•å…ƒï¼ˆTable Walk Unitï¼‰ä¸¤ä¸ªéƒ¨ä»¶ã€‚TLB æ˜¯ä¸€å—é«˜é€Ÿç¼“å­˜ï¼Œç”¨äºç¼“å­˜é¡µè¡¨è½¬æ¢ç»“æœï¼Œä»è€Œå‡å°‘é¡µè¡¨æŸ¥è¯¢çš„æ—¶é—´ã€‚å®Œæ•´çš„é¡µè¡¨ç¿»è¯‘å’ŒæŸ¥æ‰¾çš„è¿‡ç¨‹å«ä½œé¡µè¡¨æŸ¥è¯¢ï¼ˆTranslatonTable Walkï¼‰ï¼Œé¡µè¡¨æŸ¥è¯¢çš„è¿‡ç¨‹ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆï¼Œä½†æ˜¯é¡µè¡¨çš„ç»´æŠ¤éœ€è¦ç”±è½¯ä»¶å®Œæˆã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/mmu.png"></p><p>å¯¹äºå¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚è¿™äº›è¿›ç¨‹åœ°å€ç©ºé—´åœ¨è™šåœ°å€èŒƒå›´å†…æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œä½†æ˜¯åœ¨ç‰©ç†åœ°å€ç©ºé—´å†…æœ‰å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œé‚£ä¹ˆè¿™äº›è¿›ç¨‹åœ°å€ç©ºé—´æ˜¯å¦‚ä½•å’Œç‰©ç†åœ°å€ç©ºé—´å‘ç”Ÿæ˜ å°„å…³ç³»çš„å‘¢ï¼Ÿè¿™å°±éœ€è¦å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒæä¾›é¡µè¡¨æ˜ å°„å’Œç®¡ç†çš„åŠŸèƒ½ã€‚</p><h2 id="é¡µè¡¨">é¡µè¡¨</h2><p>AArch64 æ¶æ„ä¸­çš„ MMU ä¸ä»…æ”¯æŒå•ä¸€é˜¶æ®µçš„åœ°å€é¡µè¡¨è½¬æ¢ï¼Œè¿˜æ”¯æŒè™šæ‹ŸåŒ–æ‰©å±•ä¸­çš„ä¸¤é˜¶æ®µé¡µè¡¨è½¬æ¢</p><ul><li>å•ä¸€é˜¶æ®µé¡µè¡¨ï¼šè™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰è¢«ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰</li><li>ä¸¤é˜¶æ®µé¡µè¡¨ï¼ˆè™šæ‹ŸåŒ–æ‰©å±•ï¼‰ é˜¶æ®µ 1 è™šæ‹Ÿåœ°å€è¢«ç¿»è¯‘æˆä¸­é—´ç‰©ç†åœ°å€ï¼ˆIntermediate Physical Adressï¼ŒIPAï¼‰ é˜¶æ®µ 2 ä¸­é—´ç‰©ç†åœ°å€è¢«ç¿»è¯‘æˆæœ€ç»ˆç‰©ç†åœ°å€</li></ul><h2 id="é¡µè¡¨æ˜ å°„">é¡µè¡¨æ˜ å°„</h2><p>åœ¨ AArch64 æ¶æ„ä¸­ï¼Œå› ä¸ºåœ°å€æ€»çº¿ä½å®½æœ€å¤šæ”¯æŒ 48 ä½ï¼Œæ‰€ä»¥è™šæ‹Ÿåœ°å€è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªç©ºé—´ï¼Œæ¯ä¸ªç©ºé—´æœ€å¤šæ”¯æŒ 256TBã€‚</p><ul><li>ä½ä½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä½äº 0x00000000000000~0x0000FFFFFFFFFã€‚å¦‚æœè™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½ç­‰äº 0ï¼Œé‚£å°±ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨ TTBRO_ELx ï¼ˆTranslationTable Base Registerï¼‰æ¥å­˜æ”¾é¡µè¡¨çš„åŸºåœ°å€ã€‚</li><li>é«˜ä½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä»‹äº 0xFFFF00000000000~0xFFFFFFFFFFFFFã€‚å¦‚æœè™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½ç­‰äº 1ï¼Œé‚£å°±ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨ TTBR1_ELx æ¥å­˜æ”¾é¡µè¡¨çš„åŸºåœ°å€ã€‚</li></ul><p>AArch64 æ¶æ„ä¸­çš„é¡µè¡¨æ”¯æŒå¦‚ä¸‹ç‰¹æ€§ã€‚</p><ul><li>æœ€å¤šå¯ä»¥æ”¯æŒ 4 çº§é¡µè¡¨ã€‚</li><li>è¾“å…¥åœ°å€çš„æœ€å¤§æœ‰æ•ˆä½å®½ä¸º 48 ä½ã€‚</li><li>è¾“å‡ºåœ°å€çš„æœ€å¤§æœ‰æ•ˆä½å®½ä¸º 48 ä½ã€‚</li><li>ç¿»è¯‘çš„é¡µé¢ç²’åº¦å¯ä»¥æ˜¯ 4KBã€16KB æˆ– 64KBã€‚</li></ul><p>å½“ TLB æœªå‘½ä¸­æ—¶ï¼Œå¤„ç†å™¨æŸ¥è¯¢é¡µè¡¨çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Program/Language/mmu_table.png"></p><ul><li>å¤„ç†å™¨æ ¹æ® TTBRx å’Œè™šæ‹Ÿåœ°å€æ¥åˆ¤æ–­ä½¿ç”¨å“ªä¸ªé¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼Œæ˜¯ä½¿ç”¨ TTBR0 è¿˜æ˜¯ TTBR1ã€‚å½“è™šæ‹Ÿåœ°å€çš„ç¬¬ 63 ä½ï¼ˆç®€ç§° VA[63]ï¼‰ä¸º 1 æ—¶é€‰æ‹© TTBR1 å½“ VA[63] ä¸º 0 æ—¶é€‰æ‹© TTBR0ã€‚é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ä¸­å­˜æ”¾ç€ä¸€çº§é¡µè¡¨çš„åŸºåœ°å€ã€‚</li><li>å¤„ç†å™¨å°†è™šæ‹Ÿåœ°å€çš„ VA[47:39] ä½œä¸º L0 ç´¢å¼•ï¼Œåœ¨ä¸€çº§é¡µè¡¨ï¼ˆL0 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°é¡µè¡¨é¡¹ï¼Œä¸€çº§é¡µè¡¨ä¸€å…±æœ‰ 512 ä¸ªé¡µè¡¨é¡¹ã€‚</li><li>ä¸€çº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾æœ‰äºŒçº§é¡µè¡¨ï¼ˆL1 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨å°†è™šæ‹Ÿåœ°å€çš„ VA[38:30] ä½œä¸º L1 ç´¢å¼•ï¼Œåœ¨äºŒçº§é¡µè¡¨ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼ŒäºŒçº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹ã€‚</li><li>äºŒçº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾æœ‰ä¸‰çº§é¡µè¡¨ï¼ˆL2 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨å°†è™šæ‹Ÿåœ°å€çš„ VA[29:21] ä½œä¸º L2 ç´¢å¼•ï¼Œåœ¨ä¸‰çº§é¡µè¡¨ï¼ˆL2 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼Œä¸‰çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹ã€‚</li><li>ä¸‰çº§é¡µè¡¨çš„é¡µè¡¨é¡¹ä¸­å­˜æ”¾æœ‰å››çº§é¡µè¡¨ï¼ˆL3 é¡µè¡¨ï¼‰çš„ç‰©ç†åŸºåœ°å€ã€‚å¤„ç†å™¨å°†è™šæ‹Ÿåœ°å€çš„ VA[20:12] ä½œä¸º L3 ç´¢å¼•ï¼Œåœ¨å››çº§é¡µè¡¨ï¼ˆL3 é¡µè¡¨ï¼‰ä¸­æ‰¾åˆ°ç›¸åº”çš„é¡µè¡¨é¡¹ï¼Œå››çº§é¡µè¡¨æœ‰ 512 ä¸ªé¡µè¡¨é¡¹ã€‚</li><li>å››çº§é¡µè¡¨çš„é¡µè¡¨é¡¹é‡Œå­˜æ”¾æœ‰ 4KB é¡µçš„ç‰©ç†åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Šè™šæ‹Ÿåœ°å€çš„ VA[11ï¼š0] å°±æ„æˆäº†æ–°çš„ç‰©ç†åœ°å€ï¼Œäºæ˜¯å¤„ç†å™¨å°±å®Œæˆäº†é¡µè¡¨çš„æŸ¥è¯¢å’Œç¿»è¯‘å·¥ä½œã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE1Mjc4MjE4LzI5MzA5NjM=">https://blog.51cto.com/u_15278218/2930963<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9jb3Vyc2VzLmNzLndhc2hpbmd0b24uZWR1L2NvdXJzZXMvY3NlNDY5LzE5d2kvYXJtNjQucGRm">https://courses.cs.washington.edu/courses/cse469/19wi/arm64.pdf<i class="fa fa-external-link-alt"></i></span><br>ã€ŠARM-Architecture Reference Manualï¼Œfor ARMv8-A Architecture Profileï¼Œv8.4ã€‹<br>ã€Šå¥”è·‘å§ Linux å†…æ ¸-å…¥é—¨ç¯‡ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Principle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> ARM64 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆä¸ƒï¼‰WorkQueue</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptWorkQueue/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptWorkQueue/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQWorkQueue.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1OTA4ZTA3OTEyOTA2ZjUwODBjYjM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>å·¥ä½œé˜Ÿåˆ—ä¸å®Œå…¨æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºçš„ä¸‹åŠéƒ¨ã€‚å†…æ ¸çš„å¾ˆå¤šæ¨¡å—éœ€è¦å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼Œè¿™äº›æ¨¡å—ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ¥å¼‚æ­¥æ‰§è¡Œå‡½æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¯ä¸ªæ¨¡å—éƒ½åˆ›å»ºè‡ªå·±çš„å†…æ ¸çº¿ç¨‹ï¼Œä¼šé€ æˆå†…æ ¸çº¿ç¨‹çš„æ•°é‡è¿‡å¤šï¼Œå†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚æ‰€ä»¥ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯æä¾›ä¸€ç§é€šç”¨æœºåˆ¶ï¼Œè®©è¿™äº›æ¨¡å—æŠŠéœ€è¦å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°äº¤ç»™å·¥ä½œé˜Ÿåˆ—æ‰§è¡Œï¼Œå…±äº«å†…æ ¸çº¿ç¨‹ï¼ŒèŠ‚çœèµ„æºã€‚</p><hr><h1 id="å®ç°æ‰©å±•">å®ç°ï¼ˆæ‰©å±•ğŸ™ˆï¼‰</h1><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹å·¥ä½œé˜Ÿåˆ—ä½¿ç”¨çš„æœ¯è¯­ã€‚</p><ul><li>workï¼šå·¥ä½œï¼Œä¹Ÿç§°ä¸ºå·¥ä½œé¡¹ã€‚</li><li>work_queueï¼šå·¥ä½œé˜Ÿåˆ—ï¼Œå°±æ˜¯å·¥ä½œçš„é›†åˆï¼Œwork_queue å’Œ work æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</li><li>workerï¼šå·¥äººï¼Œä¸€ä¸ªå·¥äººå¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œæˆ‘ä»¬æŠŠå·¥äººå¯¹åº”çš„å†…æ ¸çº¿ç¨‹ç§°ä¸ºå·¥äººçº¿ç¨‹ã€‚</li><li>worker_poolï¼šå·¥äººæ± ï¼Œå°±æ˜¯å·¥äººçš„é›†åˆï¼Œå·¥äººæ± å’Œå·¥äººæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</li><li>pool_workqueueï¼šä¸­ä»‹ï¼Œè´Ÿè´£å»ºç«‹å·¥ä½œé˜Ÿåˆ—å’Œå·¥äººæ± ä¹‹é—´çš„å…³ç³»ã€‚å·¥ä½œé˜Ÿåˆ—å’Œ pool_workqueue æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œpool_workqueue å’Œå·¥äººæ± æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</li></ul><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>å·¥ä½œé˜Ÿåˆ—åˆ†ä¸ºä¸¤ç§ã€‚</p><ul><li>ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—ï¼šé»˜è®¤åˆ›å»ºç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—ï¼Œæ¯ä¸ªå·¥äººçº¿ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªå¤„ç†å™¨</li><li>ä¸ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—ï¼šåˆ›å»ºå·¥ä½œé˜Ÿåˆ—çš„æ—¶å€™éœ€è¦æŒ‡å®šæ ‡å¿—ä½ WO_UNBOUNDï¼Œå·¥äººçº¿ç¨‹ä¸ç»‘å®šåˆ°æŸä¸ªå¤„ç†å™¨ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨ä¹‹é—´è¿ç§»</li></ul><p>ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¥ä½œé˜Ÿåˆ—åœ¨æ¯ä¸ªå¤„ç†å™¨ä¸Šæœ‰ä¸€ä¸ª pool_workqueue å®ä¾‹ï¼Œä¸€ä¸ª pool_workqueue å®ä¾‹å¯¹åº”ä¸€ä¸ªå·¥äººæ± ï¼Œä¸€ä¸ªå·¥äººæ± æœ‰ä¸€æ¡å·¥äººé“¾è¡¨ï¼Œæ¯ä¸ªå·¥äººå¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚å‘å·¥ä½œé˜Ÿåˆ—ä¸­æ·»åŠ å·¥ä½œé¡¹çš„æ—¶å€™ï¼Œé€‰æ‹©å½“å‰å¤„ç†å™¨çš„ pool_workqueue å®ä¾‹ã€å·¥äººæ± å’Œå·¥äººçº¿ç¨‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/workqueue_bind.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE0ZWNkMTM1NjUzYmIyZWE2ZTIzOTUw">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><p>ä¸ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¥ä½œé˜Ÿåˆ—åœ¨æ¯ä¸ªå†…å­˜èŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ª pool_workqueue å®ä¾‹ï¼Œä¸€ä¸ª pool_workqueue å®ä¾‹å¯¹åº”ä¸€ä¸ªå·¥äººæ± ï¼Œä¸€ä¸ªå·¥äººæ± æœ‰ä¸€æ¡å·¥äººé“¾è¡¨ï¼Œæ¯ä¸ªå·¥äººå¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚å‘å·¥ä½œé˜Ÿåˆ—ä¸­æ·»åŠ å·¥ä½œé¡¹çš„æ—¶å€™ï¼Œé€‰æ‹©å½“å‰å¤„ç†å™¨æ‰€å±çš„å†…å­˜èŠ‚ç‚¹çš„ pool_workqueue å®ä¾‹ã€å·¥äººæ± å’Œå·¥äººçº¿ç¨‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/workqueue_unbind.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE0ZWNjZDE2Mzc2ODk0ODFiNjYxMzI0">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><p>ä¸ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—è¿˜æœ‰ä¸€ä¸ªé»˜è®¤çš„ pool_workaueue å®ä¾‹ï¼ˆworkqueue_struct.dfl_pwqï¼‰ï¼Œå½“æŸä¸ªå¤„ç†å™¨ä¸‹çº¿çš„æ—¶å€™ï¼Œä½¿ç”¨é»˜è®¤çš„ pool_workqueue å®ä¾‹ã€‚</p><h2 id="æ·»åŠ å·¥ä½œé¡¹">æ·»åŠ å·¥ä½œé¡¹</h2><p>å‡½æ•° queue_work() ç”¨æ¥å‘å·¥ä½œé˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªå·¥ä½œé¡¹ï¼ŒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•° queue_work_on()ï¼ŒæŠŠç¬¬ä¸€ä¸ªå‚æ•°â€œint cpuâ€è®¾ç½®ä¸º WORK_CPU_UNBOUNDï¼Œæ„æ€æ˜¯ä¸ç»‘å®šåˆ°ä»»ä½•å¤„ç†å™¨ï¼Œä¼˜å…ˆé€‰æ‹©å½“å‰å¤„ç†å™¨ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/workqueue.h&gt;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">queue_work</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq,</span></span><br><span class="line"><span class="params">      <span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> queue_work_on(WORK_CPU_UNBOUND, wq, work);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‡½æ•° queue_work_on çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/workqueue.c&gt;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">queue_work_on</span><span class="params">(<span class="type">int</span> cpu, <span class="keyword">struct</span> workqueue_struct *wq,</span></span><br><span class="line"><span class="params">   <span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">bool</span> ret = <span class="literal">false</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!test_and_set_bit(WORK_STRUCT_PENDING_BIT, work_data_bits(work))) {</span><br><span class="line">__queue_work(cpu, wq, work);</span><br><span class="line">ret = <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">local_irq_restore(flags);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœå·¥ä½œé¡¹æ²¡æœ‰æ·»åŠ è¿‡ï¼Œé‚£ä¹ˆç»™å·¥ä½œé¡¹è®¾ç½®æ ‡å¿—ä½ WORK_STRUCT_PENDING_BIT ç„¶åæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°__queue_work()ã€‚å‡½æ•° queue_work çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __queue_work(<span class="type">int</span> cpu, <span class="keyword">struct</span> workqueue_struct *wq,</span><br><span class="line"> <span class="keyword">struct</span> work_struct *work)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> *<span class="title">pwq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker_pool</span> *<span class="title">last_pool</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">worklist</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> work_flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> req_cpu = cpu;</span><br><span class="line"></span><br><span class="line">lockdep_assert_irqs_disabled();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(wq-&gt;flags &amp; __WQ_DRAINING) &amp;&amp;</span><br><span class="line">    WARN_ON_ONCE(!is_chained_work(wq)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">rcu_read_lock();</span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/* 1. ä»å·¥ä½œé˜Ÿåˆ—ä¸­é€‰æ‹© pool_workqueue å®ä¾‹ã€‚å¦‚æœæ˜¯ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—ï¼Œ</span></span><br><span class="line"><span class="comment">     *    é‚£ä¹ˆé€‰æ‹©å½“å‰å¤„ç†å™¨çš„ pool_workqueue å®ä¾‹å¦‚æœæ˜¯ä¸ç»‘å®šå¤„ç†å™¨çš„å·¥ä½œé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     *    é‚£ä¹ˆé€‰æ‹©å½“å‰å¤„ç†å™¨æ‰€å±çš„å†…å­˜èŠ‚ç‚¹çš„ pool_workqueue å®ä¾‹ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">if</span> (wq-&gt;flags &amp; WQ_UNBOUND) {</span><br><span class="line"><span class="keyword">if</span> (req_cpu == WORK_CPU_UNBOUND)</span><br><span class="line">cpu = wq_select_unbound_cpu(raw_smp_processor_id());</span><br><span class="line">pwq = unbound_pwq_by_node(wq, cpu_to_node(cpu));</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line"><span class="keyword">if</span> (req_cpu == WORK_CPU_UNBOUND)</span><br><span class="line">cpu = raw_smp_processor_id();</span><br><span class="line">pwq = per_cpu_ptr(wq-&gt;cpu_pwqs, cpu);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2. å¦‚æœ@work ä¹‹å‰åœ¨å…¶ä»– pool_workaueue ä¸­ï¼Œå®ƒå¯èƒ½ä»åœ¨é‚£é‡Œè¿è¡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ</span></span><br><span class="line"><span class="comment">     *    å·¥ä½œéœ€è¦åœ¨è¯¥æ± ä¸Šæ’é˜Ÿä»¥ä¿è¯ä¸å¯é‡å…¥ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">last_pool = get_work_pool(work);</span><br><span class="line"><span class="keyword">if</span> (last_pool &amp;&amp; last_pool != pwq-&gt;pool) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker</span> *<span class="title">worker</span>;</span></span><br><span class="line"></span><br><span class="line">raw_spin_lock(&amp;last_pool-&gt;lock);</span><br><span class="line"></span><br><span class="line">worker = find_worker_executing_work(last_pool, work);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (worker &amp;&amp; worker-&gt;current_pwq-&gt;wq == wq) {</span><br><span class="line">pwq = worker-&gt;current_pwq;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line"><span class="comment">/* meh... not running there, queue here */</span></span><br><span class="line">raw_spin_unlock(&amp;last_pool-&gt;lock);</span><br><span class="line">raw_spin_lock(&amp;pwq-&gt;pool-&gt;lock);</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">raw_spin_lock(&amp;pwq-&gt;pool-&gt;lock);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. å¦‚æœ pool_workqueue å®ä¾‹çš„æœªå¤„ç†å·¥ä½œæ•°é‡å°äºé™åˆ¶ï¼Œé‚£ä¹ˆæŠŠå·¥ä½œæ·»åŠ åˆ° pool_workqueue å®ä¾‹</span></span><br><span class="line"><span class="comment">     *    å¯¹åº”çš„å·¥äººæ± çš„é“¾è¡¨ worklist ä¸­ï¼›å¦‚æœ pool_workqueue å®ä¾‹çš„æœªå¤„ç†å·¥ä½œæ•°é‡è¾¾åˆ°é™åˆ¶ï¼Œé‚£ä¹ˆç»™</span></span><br><span class="line"><span class="comment">     *    å·¥ä½œè®¾ç½®æ ‡å¿—ä½ WORK_STRUCT_DELAYEDï¼Œå¹¶æŠŠå·¥ä½œæ·»åŠ åˆ° pool_workqueue å®ä¾‹çš„é“¾è¡¨ delayed_works ä¸­ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(!pwq-&gt;refcnt)) {</span><br><span class="line"><span class="keyword">if</span> (wq-&gt;flags &amp; WQ_UNBOUND) {</span><br><span class="line">raw_spin_unlock(&amp;pwq-&gt;pool-&gt;lock);</span><br><span class="line">cpu_relax();</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* oops */</span></span><br><span class="line">WARN_ONCE(<span class="literal">true</span>, <span class="string">"workqueue: per-cpu pwq for %s on cpu%d has 0 refcnt"</span>,</span><br><span class="line">  wq-&gt;name, cpu);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pwq determined, queue */</span></span><br><span class="line">trace_workqueue_queue_work(req_cpu, pwq, work);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WARN_ON(!list_empty(&amp;work-&gt;entry)))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">pwq-&gt;nr_in_flight[pwq-&gt;work_color]++;</span><br><span class="line">work_flags = work_color_to_flags(pwq-&gt;work_color);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(pwq-&gt;nr_active &lt; pwq-&gt;max_active)) {</span><br><span class="line">trace_workqueue_activate_work(work);</span><br><span class="line">pwq-&gt;nr_active++;</span><br><span class="line">worklist = &amp;pwq-&gt;pool-&gt;worklist;</span><br><span class="line"><span class="keyword">if</span> (list_empty(worklist))</span><br><span class="line">pwq-&gt;pool-&gt;watchdog_ts = jiffies;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">work_flags |= WORK_STRUCT_DELAYED;</span><br><span class="line">worklist = &amp;pwq-&gt;delayed_works;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">debug_work_activate(work);</span><br><span class="line">    <span class="comment">/* 4. æŠŠå·¥ä½œæ·»åŠ åˆ°æ³¨é‡Š 3 ä¸­æè¿°çš„é“¾è¡¨ä¸­ */</span></span><br><span class="line">insert_work(pwq, work, worklist, work_flags);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">raw_spin_unlock(&amp;pwq-&gt;pool-&gt;lock);</span><br><span class="line">rcu_read_unlock();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="å·¥äººå¤„ç†å·¥ä½œ">å·¥äººå¤„ç†å·¥ä½œ</h2><p>æ¯ä¸ªå·¥äººå¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä¸€ä¸ªå·¥äººæ± å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ªå·¥äººã€‚å¤šä¸ªå·¥äººä»å·¥äººæ± çš„æœªå¤„ç†å·¥ä½œé“¾è¡¨ï¼ˆworker_pool.worklistï¼‰ä¸­å–å·¥ä½œå¹¶å¤„ç†ã€‚å·¥äººçº¿ç¨‹çš„å¤„ç†å‡½æ•°æ˜¯ worker_thread()ï¼Œè°ƒç”¨å‡½æ•° process_one_work() å¤„ç†ä¸€ä¸ªå·¥ä½œé¡¹ã€‚å‡½æ•° worker_thread() çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/workqueue.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">worker_thread</span><span class="params">(<span class="type">void</span> *__worker)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker</span> *<span class="title">worker</span> =</span> __worker;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker_pool</span> *<span class="title">pool</span> =</span> worker-&gt;pool;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* tell the scheduler that this is a workqueue worker */</span></span><br><span class="line">set_pf_worker(<span class="literal">true</span>);</span><br><span class="line">woke_up:</span><br><span class="line">raw_spin_lock_irq(&amp;pool-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. å¦‚æœå·¥äººå¤ªå¤šï¼Œæƒ³è¦å‡å°‘å·¥äººçš„æ•°é‡ï¼Œé‚£ä¹ˆå½“å‰å·¥äººçº¿ç¨‹é€€å‡º */</span></span><br><span class="line"><span class="comment">/* am I supposed to die? */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(worker-&gt;flags &amp; WORKER_DIE)) {</span><br><span class="line">raw_spin_unlock_irq(&amp;pool-&gt;lock);</span><br><span class="line">WARN_ON_ONCE(!list_empty(&amp;worker-&gt;entry));</span><br><span class="line">set_pf_worker(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">set_task_comm(worker-&gt;task, <span class="string">"kworker/dying"</span>);</span><br><span class="line">ida_simple_remove(&amp;pool-&gt;worker_ida, worker-&gt;id);</span><br><span class="line">worker_detach_from_pool(worker);</span><br><span class="line">kfree(worker);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. å·¥äººé€€å‡ºç©ºé—²çŠ¶æ€ */</span></span><br><span class="line">worker_leave_idle(worker);</span><br><span class="line">recheck:</span><br><span class="line">    <span class="comment">/* 3. å¦‚æœä¸éœ€è¦æœ¬å·¥äººæ‰§è¡Œå·¥ä½œï¼Œé‚£ä¹ˆæœ¬å·¥äººè¿›å…¥ç©ºé—²çŠ¶æ€ */</span></span><br><span class="line"><span class="comment">/* no more worker necessary? */</span></span><br><span class="line"><span class="keyword">if</span> (!need_more_worker(pool))</span><br><span class="line"><span class="keyword">goto</span> sleep;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. å¦‚æœå·¥äººæ± ä¸­æ²¡æœ‰ç©ºé—²çš„å·¥äººï¼Œé‚£ä¹ˆåˆ›å»ºä¸€äº›å·¥äººä½¿ç”¨*/</span></span><br><span class="line"><span class="comment">/* do we need to manage? */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(!may_start_working(pool)) &amp;&amp; manage_workers(worker))</span><br><span class="line"><span class="keyword">goto</span> recheck;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * -&gt;scheduled list can only be filled while a worker is</span></span><br><span class="line"><span class="comment"> * preparing to process a work or actually processing it.</span></span><br><span class="line"><span class="comment"> * Make sure nobody diddled with it while I was sleeping.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE(!list_empty(&amp;worker-&gt;scheduled));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 5. å®Œæˆå‡†å¤‡é˜¶æ®µã€‚ æˆ‘ä»¬ä¿è¯è‡³å°‘æœ‰ä¸€åé—²ç½®å·¥äººæˆ–å…¶ä»–äººå·²ç»æ‹…ä»»ç®¡ç†è§’è‰²ã€‚</span></span><br><span class="line"><span class="comment">     *    è¿™æ˜¯@worker å¼€å§‹å‚ä¸å¹¶å‘ç®¡ç†ï¼ˆå¦‚æœé€‚ç”¨ï¼‰å¹¶åœ¨åå¼¹åæ¢å¤å¹¶å‘ç®¡ç†çš„åœ°æ–¹ã€‚</span></span><br><span class="line"><span class="comment">     *    æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… rebind_workers()ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">worker_clr_flags(worker, WORKER_PREP | WORKER_REBOUND);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 6. ä»å·¥äººæ± çš„é“¾è¡¨ worklist ä¸­å–ä¸€ä¸ªå·¥ä½œ */</span></span><br><span class="line"><span class="keyword">do</span> {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> *<span class="title">work</span> =</span></span><br><span class="line">list_first_entry(&amp;pool-&gt;worklist,</span><br><span class="line"> <span class="keyword">struct</span> work_struct, entry);</span><br><span class="line"></span><br><span class="line">pool-&gt;watchdog_ts = jiffies;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 7. å¦‚æœæ˜¯æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•° process_one_work() æ‰§è¡Œæ­£å¸¸å·¥ä½œï¼Œ</span></span><br><span class="line"><span class="comment">         *    ç„¶åæ‰§è¡Œå·¥äººçš„é“¾è¡¨ scheduled ä¸­çš„ç‰¹æ®Šå·¥ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="keyword">if</span> (likely(!(*work_data_bits(work) &amp; WORK_STRUCT_LINKED))) {</span><br><span class="line"><span class="comment">/* optimization path, not strictly necessary */</span></span><br><span class="line">process_one_work(worker, work);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!list_empty(&amp;worker-&gt;scheduled)))</span><br><span class="line">process_scheduled_works(worker);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">/* 8. å¦‚æœæ˜¯ç‰¹æ®Šå·¥ä½œï¼Œé‚£ä¹ˆé¦–å…ˆæŠŠå·¥ä½œæ·»åŠ åˆ°å·¥äººçš„é“¾è¡¨ scheduled çš„å°¾éƒ¨ï¼Œ</span></span><br><span class="line"><span class="comment">             *    ç„¶åæ‰§è¡Œå·¥äººçš„é“¾è¡¨ scheduled ä¸­çš„ç‰¹æ®Šå·¥ä½œ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">move_linked_works(work, &amp;worker-&gt;scheduled, <span class="literal">NULL</span>);</span><br><span class="line">process_scheduled_works(worker);</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">while</span> (keep_working(pool)); <span class="comment">//å¦‚æœæœ‰å·¥ä½œéœ€è¦å¤„ç†ï¼Œå¹¶ä¸”å¤„äºè¿è¡ŒçŠ¶æ€çš„å·¥äººæ•°é‡ä¸è¶…è¿‡ 1ï¼Œé‚£ä¹ˆæœ¬å·¥äººç»§ç»­æ‰§è¡Œå·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">worker_set_flags(worker, WORKER_PREP);</span><br><span class="line">sleep: <span class="comment">//å·¥äººè¿›å…¥ç©ºé—²çŠ¶æ€ï¼Œç¡çœ </span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * pool-&gt;lock is held and there's no work to process and no need to</span></span><br><span class="line"><span class="comment"> * manage, sleep.  Workers are woken up only while holding</span></span><br><span class="line"><span class="comment"> * pool-&gt;lock or from local cpu, so setting the current state</span></span><br><span class="line"><span class="comment"> * before releasing pool-&gt;lock is enough to prevent losing any</span></span><br><span class="line"><span class="comment"> * event.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">worker_enter_idle(worker);</span><br><span class="line">__set_current_state(TASK_IDLE);</span><br><span class="line">raw_spin_unlock_irq(&amp;pool-&gt;lock);</span><br><span class="line">schedule();</span><br><span class="line"><span class="keyword">goto</span> woke_up;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢è§£é‡Šä¸€ä¸‹æ­£å¸¸å·¥ä½œå’Œç‰¹æ®Šå·¥ä½œã€‚ å‘å·¥ä½œé˜Ÿåˆ—ä¸­æ·»åŠ æ­£å¸¸å·¥ä½œï¼Œæ˜¯ç›´æ¥æ·»åŠ åˆ°å·¥äººæ± çš„é“¾è¡¨ worklist ä¸­ã€‚ è°ƒç”¨å‡½æ•° flush_work(t) ç­‰å¾…å·¥ä½œ t æ‰§è¡Œå®Œï¼Œå®ç°æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªç‰¹æ®Šå·¥ä½œï¼šå±éšœå·¥ä½œï¼Œæ‰§è¡Œè¿™ä¸ªå±éšœå·¥ä½œçš„æ—¶å€™å°±å¯ä»¥ç¡®å®šå·¥ä½œ t æ‰§è¡Œå®Œã€‚å¦‚æœå·¥ä½œ t æ­£åœ¨è¢«å·¥äºº p æ‰§è¡Œï¼Œé‚£ä¹ˆæŠŠå±éšœå·¥ä½œç›´æ¥æ·»åŠ åˆ°å·¥äºº p çš„é“¾è¡¨ scheduled ä¸­ï¼›å¦‚æœå·¥ä½œ t æ²¡æœ‰æ‰§è¡Œï¼Œé‚£ä¹ˆæŠŠå±éšœå·¥ä½œæ·»åŠ åˆ°å·¥äººæ± çš„é“¾è¡¨ worklist ä¸­ï¼Œå¹¶ä¸”ç»™å±éšœå·¥ä½œè®¾ç½®æ ‡å¿—ä½ WORK_STRUCT_LINKEDã€‚å‡½æ•° process_one_work() è´Ÿè´£å¤„ç†ä¸€ä¸ªå·¥ä½œï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/workqueue.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">process_one_work</span><span class="params">(<span class="keyword">struct</span> worker *worker, <span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line">__<span class="title function_">releases</span><span class="params">(&amp;pool-&gt;lock)</span></span><br><span class="line">__<span class="title function_">acquires</span><span class="params">(&amp;pool-&gt;lock)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> *<span class="title">pwq</span> =</span> get_work_pwq(work);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker_pool</span> *<span class="title">pool</span> =</span> worker-&gt;pool;</span><br><span class="line"><span class="type">bool</span> cpu_intensive = pwq-&gt;wq-&gt;flags &amp; WQ_CPU_INTENSIVE;</span><br><span class="line"><span class="type">int</span> work_color;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker</span> *<span class="title">collision</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ensure we're on the correct CPU */</span></span><br><span class="line">WARN_ON_ONCE(!(pool-&gt;flags &amp; POOL_DISASSOCIATED) &amp;&amp;</span><br><span class="line">     raw_smp_processor_id() != pool-&gt;cpu);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 1. ä¸€ä¸ªå·¥ä½œä¸åº”è¯¥è¢«å¤šä¸ªå·¥äººå¹¶å‘æ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªå·¥ä½œæ­£åœ¨è¢«å·¥äººçš„å…¶ä»–å·¥äººæ‰§è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">      *    é‚£ä¹ˆæŠŠè¿™ä¸ªå·¥ä½œæ·»åŠ åˆ°è¿™ä¸ªå·¥äººçš„é“¾è¡¨ scheduled ä¸­å»¶åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A single work shouldn't be executed concurrently by</span></span><br><span class="line"><span class="comment"> * multiple workers on a single cpu.  Check whether anyone is</span></span><br><span class="line"><span class="comment"> * already processing the work.  If so, defer the work to the</span></span><br><span class="line"><span class="comment"> * currently executing one.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">collision = find_worker_executing_work(pool, work);</span><br><span class="line"><span class="keyword">if</span> (unlikely(collision)) {</span><br><span class="line">move_linked_works(work, &amp;collision-&gt;scheduled, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2. æŠŠå·¥äººæ·»åŠ åˆ°å·¥äººæ± çš„æ•£åˆ—è¡¨ busy_hash ä¸­ã€‚å·¥äººçš„æˆå‘˜ current_work æŒ‡å‘å½“å‰å·¥ä½œï¼Œ</span></span><br><span class="line"><span class="comment">     *    æˆå‘˜ current_func æŒ‡å‘å½“å‰å·¥ä½œçš„å¤„ç†å‡½æ•°ï¼Œæˆå‘˜ current_pwq æŒ‡å‘å½“å‰ pool_workqueue å®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">debug_work_deactivate(work);</span><br><span class="line">hash_add(pool-&gt;busy_hash, &amp;worker-&gt;hentry, (<span class="type">unsigned</span> <span class="type">long</span>)work);</span><br><span class="line">worker-&gt;current_work = work;</span><br><span class="line">worker-&gt;current_func = work-&gt;func;</span><br><span class="line">worker-&gt;current_pwq = pwq;</span><br><span class="line">work_color = get_work_color(work);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Record wq name for cmdline and debug reporting, may get</span></span><br><span class="line"><span class="comment"> * overridden through set_worker_desc().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">strscpy(worker-&gt;desc, pwq-&gt;wq-&gt;name, WORKER_DESC_LEN);</span><br><span class="line"></span><br><span class="line">list_del_init(&amp;work-&gt;entry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. å¦‚æœå·¥ä½œé˜Ÿåˆ—æ˜¯å¤„ç†å™¨å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆç»™å·¥äººè®¾ç½®æ ‡å¿—ä½ WORKER_CPU_INTENSIVEï¼Œ</span></span><br><span class="line"><span class="comment">     *    å·¥äººä¸å†è¢«å·¥äººæ± åŠ¨æ€è°ƒåº¦ã€‚è¿™ä½¿@worker è„±ç¦»äº†å¹¶å‘ç®¡ç†ï¼Œä¸‹ä¸€ä¸ªä»£ç å—å°†é“¾æ¥</span></span><br><span class="line"><span class="comment">     *    æ‰§è¡Œå¾…å¤„ç†çš„å·¥ä½œé¡¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * CPU intensive works don't participate in concurrency management.</span></span><br><span class="line"><span class="comment"> * They're the scheduler's responsibility.  This takes @worker out</span></span><br><span class="line"><span class="comment"> * of concurrency management and the next code block will chain</span></span><br><span class="line"><span class="comment"> * execution of the pending work items.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(cpu_intensive))</span><br><span class="line">worker_set_flags(worker, WORKER_CPU_INTENSIVE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. å¯¹äºä¸ç»‘å®šå¤„ç†å™¨æˆ–å¤„ç†å™¨å¯†é›†å‹çš„å·¥ä½œé˜Ÿåˆ—ï¼Œå”¤é†’æ›´å¤šç©ºé—²çš„å·¥äººå¤„ç†å·¥ä½œ */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Wake up another worker if necessary.  The condition is always</span></span><br><span class="line"><span class="comment"> * false for normal per-cpu workers since nr_running would always</span></span><br><span class="line"><span class="comment"> * be &gt;= 1 at this point.  This is used to chain execution of the</span></span><br><span class="line"><span class="comment"> * pending work items for WORKER_NOT_RUNNING workers such as the</span></span><br><span class="line"><span class="comment"> * UNBOUND and CPU_INTENSIVE ones.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (need_more_worker(pool))</span><br><span class="line">wake_up_worker(pool);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5. è®°å½•æœ€åä¸€ä¸ªæ± å¹¶æ¸…é™¤ PENDINGï¼Œè¿™åº”è¯¥æ˜¯å¯¹@work çš„æœ€åä¸€æ¬¡æ›´æ–°ã€‚ æ­¤å¤–ï¼Œ</span></span><br><span class="line"><span class="comment">     *    åœ¨@pool-&gt;lock ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥ä¾¿åœ¨ç¦ç”¨ IRQ æ—¶åŒæ—¶å‘ç”Ÿ PENDING å’Œæ’é˜ŸçŠ¶æ€æ›´æ”¹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Record the last pool and clear PENDING which should be the last</span></span><br><span class="line"><span class="comment"> * update to @work.  Also, do this inside @pool-&gt;lock so that</span></span><br><span class="line"><span class="comment"> * PENDING and queued state changes happen together while IRQ is</span></span><br><span class="line"><span class="comment"> * disabled.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">set_work_pool_and_clear_pending(work, pool-&gt;id);</span><br><span class="line"></span><br><span class="line">raw_spin_unlock_irq(&amp;pool-&gt;lock);</span><br><span class="line"></span><br><span class="line">lock_map_acquire(&amp;pwq-&gt;wq-&gt;lockdep_map);</span><br><span class="line">lock_map_acquire(&amp;lockdep_map);</span><br><span class="line"></span><br><span class="line">lockdep_invariant_state(<span class="literal">true</span>);</span><br><span class="line">trace_workqueue_execute_start(work);</span><br><span class="line">    <span class="comment">/* 6. æ‰§è¡Œå·¥ä½œçš„å¤„ç†å‡½æ•° */</span></span><br><span class="line">worker-&gt;current_func(work);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * While we must be careful to not use "work" after this, the trace</span></span><br><span class="line"><span class="comment"> * point will only record its address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">trace_workqueue_execute_end(work, worker-&gt;current_func);</span><br><span class="line">lock_map_release(&amp;lockdep_map);</span><br><span class="line">lock_map_release(&amp;pwq-&gt;wq-&gt;lockdep_map);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(in_atomic() || lockdep_depth(current) &gt; <span class="number">0</span>)) {</span><br><span class="line">pr_err(<span class="string">"BUG: workqueue leaked lock or atomic: %s/0x%08x/%d\n"</span></span><br><span class="line">       <span class="string">"     last function: %ps\n"</span>,</span><br><span class="line">       current-&gt;comm, preempt_count(), task_pid_nr(current),</span><br><span class="line">       worker-&gt;current_func);</span><br><span class="line">debug_show_held_locks(current);</span><br><span class="line">dump_stack();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following prevents a kworker from hogging CPU on !PREEMPTION</span></span><br><span class="line"><span class="comment"> * kernels, where a requeueing work item waiting for something to</span></span><br><span class="line"><span class="comment"> * happen could deadlock with stop_machine as such work item could</span></span><br><span class="line"><span class="comment"> * indefinitely requeue itself while all other CPUs are trapped in</span></span><br><span class="line"><span class="comment"> * stop_machine. At the same time, report a quiescent RCU state so</span></span><br><span class="line"><span class="comment"> * the same condition doesn't freeze RCU.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">cond_resched();</span><br><span class="line"></span><br><span class="line">raw_spin_lock_irq(&amp;pool-&gt;lock);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* clear cpu intensive status */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(cpu_intensive))</span><br><span class="line">worker_clr_flags(worker, WORKER_CPU_INTENSIVE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* tag the worker for identification in schedule() */</span></span><br><span class="line">worker-&gt;last_func = worker-&gt;current_func;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* we're done with it, release */</span></span><br><span class="line">hash_del(&amp;worker-&gt;hentry);</span><br><span class="line">worker-&gt;current_work = <span class="literal">NULL</span>;</span><br><span class="line">worker-&gt;current_func = <span class="literal">NULL</span>;</span><br><span class="line">worker-&gt;current_pwq = <span class="literal">NULL</span>;</span><br><span class="line">pwq_dec_nr_in_flight(pwq, work_color);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="å·¥äººæ± åŠ¨æ€ç®¡ç†å·¥äºº">å·¥äººæ± åŠ¨æ€ç®¡ç†å·¥äºº</h2><p>å·¥äººæ± å¯ä»¥åŠ¨æ€å¢åŠ å’Œåˆ é™¤å·¥äººï¼Œç®—æ³•å¦‚ä¸‹ï¼š</p><ul><li>å·¥äººæœ‰ 3 ç§çŠ¶æ€ï¼šç©ºé—²ï¼ˆidleï¼‰ã€è¿è¡Œï¼ˆrunningï¼‰å’ŒæŒ‚èµ·ï¼ˆsuspendï¼‰ã€‚ç©ºé—²æ˜¯æŒ‡æ²¡æœ‰æ‰§è¡Œå·¥ä½œï¼Œè¿è¡Œæ˜¯æŒ‡æ­£åœ¨æ‰§è¡Œå·¥ä½œï¼ŒæŒ‚èµ·æ˜¯æŒ‡åœ¨æ‰§è¡Œå·¥ä½œçš„è¿‡ç¨‹ä¸­ç¡çœ ã€‚</li><li>å¦‚æœå·¥äººæ± ä¸­æœ‰å·¥ä½œéœ€è¦å¤„ç†ï¼Œè‡³å°‘ä¿æŒä¸€ä¸ªå¤„åœ¨è¿è¡ŒçŠ¶æ€çš„å·¥äººæ¥å¤„ç†ã€‚</li><li>å¦‚æœå¤„åœ¨è¿è¡ŒçŠ¶æ€çš„å·¥äººåœ¨æ‰§è¡Œå·¥ä½œçš„è¿‡ç¨‹ä¸­è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œä¸ºäº†ä¿è¯å…¶ä»–å·¥ä½œçš„æ‰§è¡Œï¼Œéœ€è¦å”¤é†’ç©ºé—²çš„å·¥äººå¤„ç†å·¥ä½œã€‚</li><li>å¦‚æœæœ‰å·¥ä½œéœ€è¦æ‰§è¡Œï¼Œå¹¶ä¸”å¤„åœ¨è¿è¡ŒçŠ¶æ€çš„å·¥äººæ•°é‡å¤§äº 1ï¼Œä¼šè®©å¤šä½™çš„å·¥äººè¿›å…¥ç©ºé—²çŠ¶æ€ã€‚</li><li>å¦‚æœæ²¡æœ‰å·¥ä½œéœ€è¦æ‰§è¡Œï¼Œä¼šè®©æ‰€æœ‰å·¥äººè¿›å…¥ç©ºé—²çŠ¶æ€ã€‚</li><li>å¦‚æœåˆ›å»ºçš„å·¥äººè¿‡å¤šï¼Œå·¥äººæ± æŠŠç©ºé—²æ—¶é—´è¶…è¿‡ 300 ç§’ï¼ˆIDLE_WORKER_TIMEOUTï¼‰çš„å·¥äººåˆ é™¤ã€‚</li></ul><p>å·¥äººæ± çš„è°ƒåº¦æ€æƒ³æ˜¯å¦‚æœæœ‰å·¥ä½œéœ€è¦å¤„ç†ï¼Œä¿æŒä¸€ä¸ªå¤„åœ¨è¿è¡ŒçŠ¶æ€çš„å·¥äººæ¥å¤„ç†ï¼Œä¸å¤šä¹Ÿä¸å°‘ã€‚ è¿™ç§åšæ³•æœ‰ä¸ªé—®é¢˜ï¼šå¦‚æœå·¥ä½œæ˜¯å¤„ç†å™¨å¯†é›†å‹çš„ï¼Œè™½ç„¶å·¥äººæ²¡æœ‰è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œä½†æ˜¯ä¼šé•¿æ—¶é—´å ç”¨å¤„ç†å™¨ï¼Œè®©åç»­çš„å·¥ä½œé˜»å¡å¤ªé•¿æ—¶é—´ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨åˆ›å»ºå·¥ä½œé˜Ÿåˆ—çš„æ—¶å€™è®¾ç½®æ ‡å¿—ä½ WQ_CPUINTENSIVEï¼Œå£°æ˜å·¥ä½œé˜Ÿåˆ—æ˜¯å¤„ç†å™¨å¯†é›†çš„ã€‚å½“ä¸€ä¸ªå·¥äººæ‰§è¡Œå·¥ä½œçš„æ—¶å€™ï¼Œè®©è¿™ä¸ªå·¥äººä¸å—å·¥äººæ± åŠ¨æ€è°ƒåº¦ï¼Œåƒæ˜¯è¿›å…¥äº†æŒ‚èµ·çŠ¶æ€ï¼Œå·¥äººæ± åˆ›å»ºæ–°çš„å·¥äººæ¥æ‰§è¡Œåç»­çš„å·¥ä½œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85MTEwNjg0NA==">https://zhuanlan.zhihu.com/p/91106844<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NDU2MTYzMQ==">https://zhuanlan.zhihu.com/p/94561631<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYXJub2xkbHUvcC84NjU5OTg4Lmh0bWw=">https://www.cnblogs.com/arnoldlu/p/8659988.html<i class="fa fa-external-link-alt"></i></span></p><p>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆå…­ï¼‰Tasklet</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptTasklet/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptTasklet/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQTasklet.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1OGVlMzA3OTEyOTA2ZjUwODA4YWM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä¸ºä»€ä¹ˆæœ‰-tasklet">ä¸ºä»€ä¹ˆæœ‰ tasklet</h1><p>linux kernel å·²ç»æŠŠä¸­æ–­å¤„ç†åˆ†æˆäº† top half å’Œ bottom halfï¼Œçœ‹èµ·æ¥å·²ç»ä¸é”™äº†ï¼Œé‚£ä¸ºä½•è¿˜è¦æä¾› softirqã€tasklet å’Œ workqueue è¿™äº› bottom half æœºåˆ¶ã€‚</p><p>workqueue å’Œ softirqã€tasklet æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼š</p><ul><li>workqueue è¿è¡Œåœ¨ process contextï¼Œè€Œ softirq å’Œ tasklet è¿è¡Œåœ¨ interrupt contextã€‚å› æ­¤ï¼Œå‡ºç° workqueue æ˜¯ä¸å¥‡æ€ªçš„ï¼Œåœ¨æœ‰ sleep éœ€æ±‚çš„åœºæ™¯ä¸­éœ€è¦ã€‚</li><li>softirq æ›´å€¾å‘äºæ€§èƒ½ã€‚è½¯ä¸­æ–­çš„ç§ç±»æ˜¯ç¼–è¯‘æ—¶é™æ€å®šä¹‰çš„ï¼Œåœ¨è¿è¡Œæ—¶ä¸èƒ½æ·»åŠ æˆ–åˆ é™¤ï¼ŒåŒä¸€ç§è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°å¯ä»¥åœ¨å¤šä¸ªå¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œï¼Œå¤„ç†å‡½æ•°å¿…é¡»æ˜¯å¯ä»¥é‡å…¥çš„ï¼Œéœ€è¦ä½¿ç”¨é”ä¿æŠ¤ä¸´ç•ŒåŒºã€‚</li><li>tasklet æ›´å€¾å‘äºæ˜“ç”¨æ€§ã€‚Tasklet å¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤ï¼Œä¸€ä¸ª Tasklet åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œï¼Œä¸è¦æ±‚å¤„ç†å‡½æ•°æ˜¯å¯ä»¥é‡å…¥çš„ã€‚</li></ul><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>Tasklet çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/interrupt.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> state;</span><br><span class="line"><span class="type">atomic_t</span> count;</span><br><span class="line"><span class="type">bool</span> use_callback;</span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="type">void</span> (*func)(<span class="type">unsigned</span> <span class="type">long</span> data);</span><br><span class="line"><span class="type">void</span> (*callback)(<span class="keyword">struct</span> tasklet_struct *t);</span><br><span class="line">};</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> data;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æˆå‘˜ next ç”¨æ¥æŠŠ Tasklet æ·»åŠ åˆ°å•å‘é“¾è¡¨ä¸­ã€‚ æˆå‘˜ state æ˜¯ Tasklet çš„çŠ¶æ€ï¼Œå–å€¼å¦‚ä¸‹ï¼š</p><ul><li>0ï¼š Tasklet æ²¡æœ‰è¢«è°ƒåº¦</li><li>(1 &lt;&lt; TASKLET_STATE_SCHED)ï¼š Tasklet è¢«è°ƒåº¦ï¼Œå³å°†è¢«æ‰§è¡Œ</li><li>(1&lt;&lt; TASKLET_STATE_RUN)ï¼šåªåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œè¡¨ç¤º Tasklet æ­£åœ¨æ‰§è¡Œ</li></ul><p>æˆå‘˜ count æ˜¯è®¡æ•°ï¼Œ0 è¡¨ç¤ºå…è®¸ Tasklet è¢«æ‰§è¡Œï¼Œéé›¶å€¼è¡¨ç¤ºç¦æ­¢ Tasklet è¢«æ‰§è¡Œæˆå‘˜ func æ˜¯å¤„ç†å‡½æ•°ï¼Œæˆå‘˜ data æ˜¯ä¼ ç»™å¤„ç†å‡½æ•°çš„å‚æ•°ã€‚ æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸¤æ¡å•å‘é“¾è¡¨ï¼šä½ä¼˜å…ˆçº§ Tasklet é“¾è¡¨å’Œé«˜ä¼˜å…ˆçº§ Tasklet é“¾è¡¨ã€‚</p><h2 id="section"><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_head</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">head</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> **<span class="title">tail</span>;</span></span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU</span><span class="params">(<span class="keyword">struct</span> tasklet_head, tasklet_vec)</span>;</span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU</span><span class="params">(<span class="keyword">struct</span> tasklet_head, tasklet_hi_vec)</span>;</span><br></pre></td></tr></tbody></table></figure></h2><h1 id="å®ç°æ‰©å±•">å®ç°ï¼ˆæ‰©å±•ğŸ™ˆï¼‰</h1><p>Tasklet æ˜¯åŸºäºè½¯ä¸­æ–­å®ç°çš„ï¼Œæ ¹æ®ä¼˜å…ˆçº§åˆ†ä¸ºä¸¤ç§ï¼Œä½ä¼˜å…ˆçº§ Tasklet å’Œé«˜ä¼˜å…ˆçº§ Taskletã€‚è½¯ä¸­æ–­ HI_SOFTIRO æ‰§è¡Œé«˜ä¼˜å…ˆçº§ Taskletï¼Œè½¯ä¸­æ–­ TASKLET_SOFTIRQ æ‰§è¡Œä½ä¼˜å…ˆçº§ Taskletã€‚</p><h2 id="è°ƒåº¦-tasklet">è°ƒåº¦ Tasklet</h2><p>å‡½æ•° tasklet_schedule() ç”¨æ¥è°ƒåº¦ä½ä¼˜å…ˆçº§ Taskletï¼Œå‡½æ•° tasklet_hi_schedule() ç”¨æ¥è°ƒåº¦é«˜ä¼˜å…ˆçº§ Taskletã€‚ä»¥å‡½æ•° tasklet_schedule() ä¸ºä¾‹è¯´æ˜ï¼Œå…¶ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/interrupt.hã€kernel/softirq.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">tasklet_schedule</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (!test_and_set_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state))</span><br><span class="line">__tasklet_schedule(t);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">void</span> __tasklet_schedule(<span class="keyword">struct</span> tasklet_struct *t)</span><br><span class="line">{</span><br><span class="line">__tasklet_schedule_common(t, &amp;tasklet_vec,</span><br><span class="line">  TASKLET_SOFTIRQ);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __tasklet_schedule_common(<span class="keyword">struct</span> tasklet_struct *t,</span><br><span class="line">      <span class="keyword">struct</span> tasklet_head __percpu *headp,</span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> softirq_nr)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_head</span> *<span class="title">head</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags);</span><br><span class="line">head = this_cpu_ptr(headp);</span><br><span class="line">t-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">*head-&gt;tail = t;</span><br><span class="line">head-&gt;tail = &amp;(t-&gt;next);</span><br><span class="line">raise_softirq_irqoff(softirq_nr);</span><br><span class="line">local_irq_restore(flags);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ Tasklet æ²¡æœ‰è¢«è°ƒåº¦è¿‡ï¼Œé‚£ä¹ˆé¦–å…ˆè®¾ç½®è°ƒåº¦æ ‡å¿—ä½ï¼Œç„¶åæŠŠ Tasklet æ·»åŠ åˆ°å½“å‰å¤„ç†å™¨çš„ä½ä¼˜å…ˆçº§ Tasklet é“¾è¡¨çš„å°¾éƒ¨ï¼Œæœ€åè§¦å‘è½¯ä¸­æ–­ TASKLET_SOFTIRQã€‚</p><h2 id="æ‰§è¡Œ-tasklet">æ‰§è¡Œ Tasklet</h2><p>åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒæŠŠè½¯ä¸­æ–­ TASKLET_SOFTIRQ çš„å¤„ç†å‡½æ•°æ³¨å†Œä¸ºå‡½æ•° tasklet_actionï¼ŒæŠŠè½¯ä¸­æ–­ HI_SOFTIRQ çš„å¤„ç†å‡½æ•°æ³¨å†Œä¸ºå‡½æ•° tasklet_hi_action()ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">void</span> __init <span class="title function_">softirq_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">int</span> cpu;</span><br><span class="line"></span><br><span class="line">for_each_possible_cpu(cpu) {</span><br><span class="line">per_cpu(tasklet_vec, cpu).tail =</span><br><span class="line">&amp;per_cpu(tasklet_vec, cpu).head;</span><br><span class="line">per_cpu(tasklet_hi_vec, cpu).tail =</span><br><span class="line">&amp;per_cpu(tasklet_hi_vec, cpu).head;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">open_softirq(TASKLET_SOFTIRQ, tasklet_action);</span><br><span class="line">open_softirq(HI_SOFTIRQ, tasklet_hi_action);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥å‡½æ•° tasklet_action() ä¸ºä¾‹è¯´æ˜ï¼Œå…¶ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">static</span> __latent_entropy <span class="type">void</span> <span class="title function_">tasklet_action</span><span class="params">(<span class="keyword">struct</span> softirq_action *a)</span></span><br><span class="line">{</span><br><span class="line">tasklet_action_common(a, this_cpu_ptr(&amp;tasklet_vec), TASKLET_SOFTIRQ);</span><br><span class="line">}</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tasklet_action_common</span><span class="params">(<span class="keyword">struct</span> softirq_action *a,</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> tasklet_head *tl_head,</span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> <span class="type">int</span> softirq_nr)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">local_irq_disable();</span><br><span class="line"><span class="built_in">list</span> = tl_head-&gt;head;</span><br><span class="line">tl_head-&gt;head = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. æŠŠå½“å‰å¤„ç†å™¨çš„ä½ä¼˜å…ˆçº§ Tasklet é“¾è¡¨ä¸­çš„æ‰€æœ‰ Tasklet ç§»åˆ°ä¸´æ—¶é“¾è¡¨ list ä¸­ */</span></span><br><span class="line">tl_head-&gt;tail = &amp;tl_head-&gt;head;</span><br><span class="line">local_irq_enable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. éå†ä¸´æ—¶é“¾è¡¨ listï¼Œä¾æ¬¡å¤„ç†æ¯ä¸ª Tasklet */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">list</span>) {</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">t</span> =</span> <span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span> = <span class="built_in">list</span>-&gt;next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 3. ï¼Œå°è¯•é”ä½ Taskletï¼Œç¡®ä¿ä¸€ä¸ª Tasklet åŒä¸€æ—¶åˆ»åªåœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œ */</span></span><br><span class="line"><span class="keyword">if</span> (tasklet_trylock(t)) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 4. å¦‚æœ Tasklet çš„è®¡æ•°ä¸º 0ï¼Œè¡¨ç¤ºå…è®¸ Tasklet è¢«æ‰§è¡Œ */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="type">atomic_read</span>(&amp;t-&gt;count)) {</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* 5. æ¸…é™¤ Tasklet çš„è°ƒåº¦æ ‡å¿—ä½ï¼Œå…¶ä»–å¤„ç†å™¨å¯ä»¥è°ƒåº¦è¿™ä¸ª Taskletï¼Œä½†æ˜¯ä¸èƒ½æ‰§è¡Œè¿™ä¸ª Tasklet */</span></span><br><span class="line"><span class="keyword">if</span> (tasklet_clear_sched(t)) {</span><br><span class="line"><span class="keyword">if</span> (t-&gt;use_callback)</span><br><span class="line">                        <span class="comment">/* 6. æ‰§è¡Œ Tasklet çš„å¤„ç†å‡½æ•° */</span></span><br><span class="line">t-&gt;callback(t);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">                        <span class="comment">/* 6. æ‰§è¡Œ Tasklet çš„å¤„ç†å‡½æ•° */</span></span><br><span class="line">t-&gt;func(t-&gt;data);</span><br><span class="line">}</span><br><span class="line">tasklet_unlock(t);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 7. é‡Šæ”¾ Tasklet çš„é”ï¼Œå…¶ä»–å¤„ç†å™¨å°±å¯ä»¥æ‰§è¡Œè¿™ä¸ª Tasklet äº† */</span></span><br><span class="line">tasklet_unlock(t);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 8. å¦‚æœå°è¯•é”ä½ Tasklet å¤±è´¥ï¼ˆè¡¨ç¤º Tasklet æ­£åœ¨å…¶ä»–å¤„ç†å™¨ä¸Šæ‰§è¡Œï¼‰ï¼Œæˆ–è€…ç¦æ­¢ Tasklet è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆæŠŠ Tasklet é‡æ–°æ·»åŠ åˆ°å½“å‰å¤„ç†å™¨çš„ä½ä¼˜å…ˆçº§ Tasklet é“¾è¡¨çš„å°¾éƒ¨ï¼Œç„¶åè§¦å‘è½¯ä¸­æ–­ TASKLET_SOFTIRQ */</span></span><br><span class="line">local_irq_disable();</span><br><span class="line">t-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">*tl_head-&gt;tail = t;</span><br><span class="line">tl_head-&gt;tail = &amp;t-&gt;next;</span><br><span class="line">__raise_softirq_irqoff(softirq_nr);</span><br><span class="line">local_irq_enable();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ä¸Šé¢çš„æ³¨é‡Š 4 å¦‚æœ Tasklet çš„è®¡æ•°ä¸º 0ï¼Œè¡¨ç¤ºå…è®¸ Tasklet è¢«æ‰§è¡Œ ï¼Œtasklet å°±æ˜¯é€šè¿‡è¿™ä¸ªæ¥ä¿è¯åªåœ¨ä¸€ä¸ª cpu ä¸Šæ‰§è¡Œã€‚å¦‚æœè¯¥ tasklet å·²ç»åœ¨åˆ«çš„ cpu ä¸Šæ‰§è¡Œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å…¶æŒ‚å…¥è¯¥ cpu çš„ tasklet é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·ï¼Œåœ¨ä¸‹ä¸€ä¸ª tasklet æ‰§è¡Œæ—¶æœºåˆ°æ¥çš„æ—¶å€™ï¼Œkernel ä¼šå†æ¬¡å°è¯•æ‰§è¡Œè¯¥ taskletï¼Œåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œä¹Ÿè®¸å…¶ä»– cpu ä¸Šçš„è¯¥ tasklet å·²ç»æ‰§è¡Œå®Œæ¯•äº†ã€‚é€šè¿‡è¿™æ ·ä»£ç é€»è¾‘ï¼Œä¿è¯äº†ç‰¹å®šçš„ tasklet åªä¼šåœ¨ä¸€ä¸ª cpu ä¸Šæ‰§è¡Œï¼Œä¸ä¼šåœ¨å¤šä¸ª cpu ä¸Šå¹¶å‘ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvaXJxX3N1YnN5c3RlbS9zb2Z0LWlycS5odG1s">http://www.wowotech.net/irq_subsystem/soft-irq.html<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvaXJxX3N1YnN5c3RlbS90YXNrbGV0Lmh0bWw=">http://www.wowotech.net/irq_subsystem/tasklet.html<i class="fa fa-external-link-alt"></i></span></p><p>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆäº”ï¼‰SoftIRQ</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptSoftIRQ/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptSoftIRQ/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQSoftIRQ.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1OGNkN2U0MDFmZDA3MGJiMGNkYmI=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="è½¯ä¸­æ–­çš„å®šä¹‰">è½¯ä¸­æ–­çš„å®šä¹‰</h1><p>è½¯ä¸­æ–­ï¼ˆsoftirqï¼‰æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºåœ¨å¼€å¯ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œå¯ä»¥è¢«ç¡¬ä¸­æ–­æŠ¢å å†…æ ¸å®šä¹‰äº†ä¸€å¼ è½¯ä¸­æ–­å‘é‡è¡¨ï¼Œæ¯ç§è½¯ä¸­æ–­æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œå¯¹åº”ä¸€ä¸ª softirq_actior å®ä¾‹ï¼Œsoftirq_action å®ä¾‹çš„æˆå‘˜ action æ˜¯å¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span> <span class="title">softirq_vec</span>[<span class="title">NR_SOFTIRQS</span>] __<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">HI_SOFTIRQ=<span class="number">0</span>,</span><br><span class="line">TIMER_SOFTIRQ,</span><br><span class="line">NET_TX_SOFTIRQ,</span><br><span class="line">NET_RX_SOFTIRQ,</span><br><span class="line">BLOCK_SOFTIRQ,</span><br><span class="line">IRQ_POLL_SOFTIRQ,</span><br><span class="line">TASKLET_SOFTIRQ,</span><br><span class="line">SCHED_SOFTIRQ,</span><br><span class="line">HRTIMER_SOFTIRQ,</span><br><span class="line">RCU_SOFTIRQ,    <span class="comment">/* Preferable RCU should always be the last softirq */</span></span><br><span class="line"></span><br><span class="line">NR_SOFTIRQS</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/interrupt.h&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line"><span class="type">void</span>(*action)(<span class="keyword">struct</span> softirq_action *);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>softirq_action è¯¥ç»“æ„ä½“éå¸¸ç®€å•å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘å…·ä½“å®šä¹‰çš„å‡½æ•°ã€‚</p><p>ä¸­æ–­çš„æ¥æºå¾ˆå¤šï¼Œæ‰€ä»¥ softirq çš„ç§ç±»ä¹Ÿä¸å°‘ã€‚å†…æ ¸çš„é™åˆ¶æ˜¯ä¸èƒ½è¶…è¿‡ 32 ä¸ªï¼Œ ç›®å‰å†…æ ¸å®šä¹‰äº† 10 ç§è½¯ä¸­æ–­ï¼Œå„ç§è½¯ä¸­æ–­çš„ç¼–å·å¦‚ä¸‹ï¼š</p><ul><li>HI_SOFTIRQï¼šé«˜ä¼˜å…ˆçº§çš„å°ä»»åŠ¡</li><li>TIMER_SOFTIRQï¼šå®šæ—¶å™¨è½¯ä¸­æ–­</li><li>NET_TX_SOFTIRQï¼šç½‘ç»œæ ˆå‘é€æŠ¥æ–‡çš„è½¯ä¸­æ–­</li><li>NET_RX_SOFTIRQï¼šç½‘ç»œæ ˆæ¥æ”¶æŠ¥æ–‡çš„è½¯ä¸­æ–­</li><li>BLOCK_SOFTIROï¼šå—è®¾å¤‡è½¯ä¸­æ–­</li><li>IRQ_POLL_SOFTIRQï¼šæ”¯æŒ I/O è½®è¯¢çš„å—è®¾å¤‡è½¯ä¸­æ–­</li><li>TASKLET SOFTIRQï¼šä½ä¼˜å…ˆçº§çš„å°ä»»åŠ¡</li><li>SCHED_SOFTIRQï¼šè°ƒåº¦è½¯ä¸­æ–­ï¼Œç”¨äºåœ¨å¤„ç†å™¨ä¹‹é—´è´Ÿè½½å‡è¡¡</li><li>HRTIMER SOFTIRQï¼šé«˜ç²¾åº¦å®šæ—¶å™¨ï¼Œè¿™ç§è½¯ä¸­æ–­å·²ç»è¢«åºŸå¼ƒï¼Œç›®å‰åœ¨ä¸­æ–­å¤„ç†ç¨‹åºçš„ä¸ŠåŠéƒ¨å¤„ç†é«˜ç²¾åº¦å®šæ—¶å™¨</li><li>RCU_SOFTIROï¼šRCU è½¯ä¸­æ–­</li></ul><p>è½¯ä¸­æ–­çš„ç¼–å·å½¢æˆäº†ä¼˜å…ˆçº§é¡ºåºï¼Œç¼–å·å°çš„è½¯ä¸­æ–­ä¼˜å…ˆçº§é«˜ã€‚</p><h1 id="è½¯ä¸­æ–­çš„å®ç°">è½¯ä¸­æ–­çš„å®ç°</h1><h2 id="æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°">æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°</h2><p>å‡½æ•° open_softirq() ç”¨æ¥æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œåœ¨è½¯ä¸­æ–­å‘é‡è¡¨ä¸­ä¸ºæŒ‡å®šçš„è½¯ä¸­æ–­ç¼–å·è®¾ç½®å¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">void</span> <span class="title function_">open_softirq</span><span class="params">(<span class="type">int</span> nr, <span class="type">void</span> (*action)(<span class="keyword">struct</span> softirq_action *))</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>Tips åŒä¸€ç§è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°å¯ä»¥åœ¨å¤šä¸ªå¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œï¼Œå¤„ç†å‡½æ•°å¿…é¡»æ˜¯å¯ä»¥é‡å…¥çš„ï¼Œéœ€è¦ä½¿ç”¨é”ä¿æŠ¤ä¸´ç•ŒåŒºã€‚</p></blockquote><h2 id="è§¦å‘è½¯ä¸­æ–­">è§¦å‘è½¯ä¸­æ–­</h2><p>åœ¨ä¸­æ–­çš„ top half å¤„ç†å®Œåï¼Œå°±ä¼šé€šè¿‡ raise_softirq() è®¾ç½® softirq çš„ pending ä½å›¾ï¼Œè¿™ä¸ª pending ä½å›¾ç”±ä¸€ä¸ªåä¸º"__softirq_pending"çš„ per-CPU å½¢å¼çš„å˜é‡è¡¨ç¤ºã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">raise_softirq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nr)</span> <span class="comment">//nr å‚æ•°æ˜¯è½¯ä¸­æ–­ç¼–å·</span></span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags);</span><br><span class="line">raise_softirq_irqoff(nr);</span><br><span class="line">local_irq_restore(flags);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°è°ƒç”¨ raise_softirq_irqoff(),raise_softirq_irqoff() æ˜¯åœ¨å·²ç»ç¦æ­¢ä¸­æ–­çš„æƒ…å†µä¸‹è°ƒç”¨å‡½æ•°æ¥è§¦å‘è½¯ä¸­æ–­ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">raise_softirq_irqoff</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nr)</span></span><br><span class="line">{</span><br><span class="line">__raise_softirq_irqoff(nr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we're in an interrupt or softirq, we're done</span></span><br><span class="line"><span class="comment"> * (this also catches softirq-disabled code). We will</span></span><br><span class="line"><span class="comment"> * actually run the softirq once we return from</span></span><br><span class="line"><span class="comment"> * the irq or softirq.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise we wake up ksoftirqd to make sure we</span></span><br><span class="line"><span class="comment"> * schedule the softirq soon.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!in_interrupt() &amp;&amp; should_wake_ksoftirqd())</span><br><span class="line">wakeup_softirqd();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è°ƒç”¨__raise_softirq_irqoff å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __raise_softirq_irqoff(<span class="type">unsigned</span> <span class="type">int</span> nr)</span><br><span class="line">{</span><br><span class="line">lockdep_assert_irqs_disabled();</span><br><span class="line">trace_softirq_raise(nr);</span><br><span class="line">or_softirq_pending(<span class="number">1UL</span> &lt;&lt; nr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>æŠŠå® or_softirq_pending å±•å¼€ä»¥åæ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irq_stat[smp <span class="title function_">processor_id</span><span class="params">()</span>].softirq_pending |= (<span class="number">1UL</span> &lt;&lt; nr);</span><br></pre></td></tr></tbody></table></figure><ul><li>__raise_softirq_irqoff å‡½æ•°è®¾å®šæœ¬ CPU ä¸Šçš„__softirq_pending çš„æŸä¸ª bit ç­‰äº 1ï¼Œå…·ä½“çš„ bit æ˜¯ç”± soft irq numberï¼ˆnr å‚æ•°ï¼‰æŒ‡å®šçš„ã€‚</li><li>å¦‚æœåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬åªè¦ set __softirq_pending çš„æŸä¸ª bit å°± OK äº†ï¼Œåœ¨ä¸­æ–­è¿”å›çš„æ—¶å€™è‡ªç„¶ä¼šè¿›è¡Œè½¯ä¸­æ–­çš„å¤„ç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨ context ä¸Šä¸‹æ–‡è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»è¦è°ƒç”¨ wakeup_softirqd å‡½æ•°ç”¨æ¥å”¤é†’æœ¬ CPU ä¸Šçš„ softirqd è¿™ä¸ªå†…æ ¸çº¿ç¨‹ã€‚</li></ul><p>è¿™æ · softirq å°±ç›¸å½“äºå‡†å¤‡å¥½äº†ï¼Œåœ¨åˆé€‚çš„æ—¶æœºå°†ä¼šè°ƒç”¨ softirq çš„å¤„ç†å‡½æ•°ã€‚</p><h2 id="æ‰§è¡Œè½¯ä¸­æ–­">æ‰§è¡Œè½¯ä¸­æ–­</h2><p>å†…æ ¸æ‰§è¡Œè½¯ä¸­æ–­çš„åœ°æ–¹å¦‚ä¸‹ã€‚</p><ul><li>åœ¨ä¸­æ–­å¤„ç†ç¨‹åºçš„ååŠéƒ¨åˆ†æ‰§è¡Œè½¯ä¸­æ–­ï¼Œå¯¹æ‰§è¡Œæ—¶é—´æœ‰é™åˆ¶ï¼šä¸èƒ½è¶…è¿‡ 2 æ¯«ç§’ï¼Œå¹¶ä¸”æœ€å¤šæ‰§è¡Œ 10 æ¬¡ã€‚</li><li>æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè½¯ä¸­æ–­çº¿ç¨‹ï¼Œè°ƒåº¦ç­–ç•¥æ˜¯ SCHED_NORMALï¼Œä¼˜å…ˆçº§æ˜¯ 120ã€‚</li><li>å¼€å¯è½¯ä¸­æ–­çš„å‡½æ•° local_bh_enable()ã€‚</li></ul><p>å¦‚æœå¼€å¯äº†å¼ºåˆ¶ä¸­æ–­çº¿ç¨‹åŒ–çš„é…ç½®å® CONFIG_IRO_FORCED_THREADINGï¼Œå¹¶ä¸”åœ¨å¼•å¯¼å†…æ ¸çš„æ—¶å€™æŒ‡å®šå†…æ ¸å‚æ•°â€œthreadirqsâ€ï¼Œé‚£ä¹ˆæ‰€æœ‰è½¯ä¸­æ–­ç”±è½¯ä¸­æ–­çº¿ç¨‹æ‰§è¡Œ</p><h3 id="ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œè½¯ä¸­æ–­">ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œè½¯ä¸­æ–­</h3><p>åœ¨ä¸­æ–­å¤„ç†ç¨‹åºçš„ååŠéƒ¨åˆ†ï¼Œè°ƒç”¨å‡½æ•° irq_exit() ä»¥é€€å‡ºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå¤„ç†è½¯ä¸­æ–­ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">void</span> <span class="title function_">irq_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">__irq_exit_rcu();</span><br><span class="line">rcu_irq_exit();</span><br><span class="line"> <span class="comment">/* must be last! */</span></span><br><span class="line">lockdep_hardirq_exit();</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __irq_exit_rcu(<span class="type">void</span>)</span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ARCH_IRQ_EXIT_IRQS_DISABLED</span></span><br><span class="line">local_irq_disable();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">lockdep_assert_irqs_disabled();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">account_hardirq_exit(current);</span><br><span class="line">preempt_count_sub(HARDIRQ_OFFSET);</span><br><span class="line"><span class="keyword">if</span> (!in_interrupt() &amp;&amp; local_softirq_pending())</span><br><span class="line">invoke_softirq();</span><br><span class="line"></span><br><span class="line">tick_irq_exit();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ in_interrupt() ä¸ºçœŸï¼Œè¡¨ç¤ºåœ¨ä¸å¯å±è”½ä¸­æ–­ã€ç¡¬ä¸­æ–­æˆ–è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…ç¦æ­¢è½¯ä¸­æ–­ã€‚å¦‚æœæ­£åœ¨å¤„ç†çš„ç¡¬ä¸­æ–­æ²¡æœ‰æŠ¢å æ­£åœ¨æ‰§è¡Œçš„è½¯ä¸­æ–­ï¼Œæ²¡æœ‰ç¦æ­¢è½¯ä¸­æ–­ï¼Œå¹¶ä¸”å½“å‰å¤„ç†å™¨çš„å¾…å¤„ç†è½¯ä¸­æ–­ä½å›¾ä¸æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•° invoke_softirq() æ¥å¤„ç†è½¯ä¸­æ–­ã€‚</p><p>å‡½æ•° invoke_softirq çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">invoke_softirq</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">/* 1. å¦‚æœè½¯ä¸­æ–­çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€æˆ–è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆè®©è½¯ä¸­æ–­çº¿ç¨‹æ‰§è¡Œè½¯ä¸­æ–­ */</span></span><br><span class="line"><span class="keyword">if</span> (ksoftirqd_running(local_softirq_pending()))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. å¦‚æœæ²¡æœ‰å¼ºåˆ¶ä¸­æ–­çº¿ç¨‹åŒ–ï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•°_do_softirq() æ‰§è¡Œè½¯ä¸­æ–­ */</span></span><br><span class="line"><span class="keyword">if</span> (!force_irqthreads || !__this_cpu_read(ksoftirqd)) {</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We can safely execute softirq on the current stack if</span></span><br><span class="line"><span class="comment"> * it is the irq stack, because it should be near empty</span></span><br><span class="line"><span class="comment"> * at this stage.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__do_softirq();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Otherwise, irq_exit() is called on the task stack that can</span></span><br><span class="line"><span class="comment"> * be potentially deep already. So call softirq in its own stack</span></span><br><span class="line"><span class="comment"> * to prevent from any overrun.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">do_softirq_own_stack();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">/* 3. å¦‚æœå¼ºåˆ¶ä¸­æ–­çº¿ç¨‹åŒ–ï¼Œé‚£ä¹ˆå”¤é†’è½¯ä¸­æ–­çº¿ç¨‹æ‰§è¡Œè½¯ä¸­æ–­*/</span></span><br><span class="line">wakeup_softirqd();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‡½æ•°_do_softirq æ˜¯æ‰§è¡Œè½¯ä¸­æ–­çš„æ ¸å¿ƒå‡½æ•°ï¼Œå…¶ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line">asmlinkage __visible <span class="type">void</span> __softirq_entry __do_softirq(<span class="type">void</span>)</span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> end = jiffies + MAX_SOFTIRQ_TIME;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> old_flags = current-&gt;flags;</span><br><span class="line"><span class="type">int</span> max_restart = MAX_SOFTIRQ_RESTART;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span> *<span class="title">h</span>;</span></span><br><span class="line"><span class="type">bool</span> in_hardirq;</span><br><span class="line">__u32 pending;</span><br><span class="line"><span class="type">int</span> softirq_bit;</span><br><span class="line"></span><br><span class="line">current-&gt;flags &amp;= ~PF_MEMALLOC;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. æŠŠå±€éƒ¨å˜é‡ pending è®¾ç½®ä¸ºå½“å‰å¤„ç†å™¨çš„å¾…å¤„ç†è½¯ä¸­æ–­ä½å›¾ */</span></span><br><span class="line">pending = local_softirq_pending();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. softirq_handle_begin è°ƒç”¨__local_bh_disable_ip æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°åŠ  1 */</span></span><br><span class="line">softirq_handle_begin();</span><br><span class="line">in_hardirq = lockdep_softirq_start();</span><br><span class="line">account_softirq_enter(current);</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line"><span class="comment">/* 3. æŠŠå½“å‰å¤„ç†å™¨çš„å¾…å¤„ç†è½¯ä¸­æ–­ä½å›¾é‡æ–°è®¾ç½®ä¸º 0 */</span></span><br><span class="line">set_softirq_pending(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. å¼€å¯ç¡¬ä¸­æ–­ */</span></span><br><span class="line">local_irq_enable();</span><br><span class="line"></span><br><span class="line">h = softirq_vec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5. ä»ä½ä½å‘é«˜ä½æ‰«æå¾…å¤„ç†è½¯ä¸­æ–­ä½å›¾ï¼Œé’ˆå¯¹æ¯ä¸ªè®¾ç½®äº†å¯¹åº”ä½çš„è½¬ä¸­æ–­ç¼–å·ï¼Œæ‰§è¡Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°*/</span></span><br><span class="line"><span class="keyword">while</span> ((softirq_bit = ffs(pending))) {</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> vec_nr;</span><br><span class="line"><span class="type">int</span> prev_count;</span><br><span class="line"></span><br><span class="line">h += softirq_bit - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">vec_nr = h - softirq_vec;</span><br><span class="line">prev_count = preempt_count();</span><br><span class="line"></span><br><span class="line">kstat_incr_softirqs_this_cpu(vec_nr);</span><br><span class="line"></span><br><span class="line">trace_softirq_entry(vec_nr);</span><br><span class="line">        <span class="comment">/* è°ƒç”¨ action */</span></span><br><span class="line">h-&gt;action(h);</span><br><span class="line">trace_softirq_exit(vec_nr);</span><br><span class="line"><span class="keyword">if</span> (unlikely(prev_count != preempt_count())) {</span><br><span class="line">pr_err(<span class="string">"huh, entered softirq %u %s %p with preempt_count %08x, exited with %08x?\n"</span>,</span><br><span class="line">       vec_nr, softirq_to_name[vec_nr], h-&gt;action,</span><br><span class="line">       prev_count, preempt_count());</span><br><span class="line">preempt_count_set(prev_count);</span><br><span class="line">}</span><br><span class="line">h++;</span><br><span class="line">pending &gt;&gt;= softirq_bit;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!IS_ENABLED(CONFIG_PREEMPT_RT) &amp;&amp;</span><br><span class="line">    __this_cpu_read(ksoftirqd) == current)</span><br><span class="line">rcu_softirq_qs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 6. ç¦æ­¢ç¡¬ä¸­æ–­ */</span></span><br><span class="line">local_irq_disable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 7. å¦‚æœè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°åˆè§¦å‘è½¯ä¸­æ–­ï¼Œå¤„ç†å¦‚ä¸‹ */</span></span><br><span class="line">pending = local_softirq_pending();</span><br><span class="line"><span class="keyword">if</span> (pending) {</span><br><span class="line">        <span class="comment">/* 8. å¦‚æœè½¯ä¸­æ–­çš„æ‰§è¡Œæ—¶é—´å°äº 2 æ¯«ç§’ï¼Œä¸éœ€è¦é‡æ–°è°ƒåº¦è¿›ç¨‹ï¼Œå¹¶å£ä¸”è½¯ä¸­æ–­çš„æ‰§è¡Œæ¬¡æ•°æ²¡è¶…è¿‡ 10ï¼Œé‚£ä¹ˆè·³è½¬åˆ° restart ç»§ç»­æ‰§è¡Œè½¯ä¸­æ–­ */</span></span><br><span class="line"><span class="keyword">if</span> (time_before(jiffies, end) &amp;&amp; !need_resched() &amp;&amp;</span><br><span class="line">    --max_restart)</span><br><span class="line"><span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 9. å”¤é†’è½¯ä¸­æ–­çº¿ç¨‹æ‰§è¡Œè½¯ä¸­æ–­ */</span></span><br><span class="line">wakeup_softirqd();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">account_softirq_exit(current);</span><br><span class="line">lockdep_softirq_end(in_hardirq);</span><br><span class="line">    <span class="comment">/* 10. æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°å‡ 1 */</span></span><br><span class="line">softirq_handle_end();</span><br><span class="line">current_restore_flags(old_flags, PF_MEMALLOC);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢å°±æ˜¯è½¯ä¸­æ–­çš„è°ƒç”¨æµç¨‹ã€‚__do_softirq() æ˜¯ç´§æ¥ç€"hardirq"æ‰§è¡Œçš„ï¼Œå®ƒä¹Ÿæ˜¯è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå¦‚æœéè¦å’Œâ€œhardirq ä¸Šä¸‹æ–‡â€æœ‰æ‰€åŒºåˆ†çš„è¯ï¼Œå¯ä»¥è®¤ä¸ºè¿™æ˜¯â€œsoftirq ä¸Šä¸‹æ–‡â€ï¼Œåœ¨ softirq ä¸Šä¸‹æ–‡ä¸­ï¼Œä¹Ÿæ˜¯ä¸èƒ½ç¡çœ çš„ã€‚</p><h3 id="è½¯ä¸­æ–­çº¿ç¨‹">è½¯ä¸­æ–­çº¿ç¨‹</h3><p>æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè½¯ä¸­æ–­çº¿ç¨‹ï¼Œåç§°æ˜¯â€œksofirqd/â€åé¢è·Ÿç€å¤„ç†å™¨ç¼–å·ï¼Œè°ƒåº¦ç­–ç•¥ SCHED_NORMALï¼Œä¼˜å…ˆçº§æ˜¯ 120ã€‚è½¯ä¸­æ–­çº¿ç¨‹çš„æ ¸å¿ƒå‡½æ•°æ˜¯ run_ksoftirqd()ï¼Œå…¶ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;kernel/softirq.c&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">run_ksoftirqd</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> cpu)</span></span><br><span class="line">{</span><br><span class="line">ksoftirqd_run_begin();</span><br><span class="line"><span class="keyword">if</span> (local_softirq_pending()) {</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We can safely run softirq on inline stack, as we are not deep</span></span><br><span class="line"><span class="comment"> * in the task stack here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__do_softirq();</span><br><span class="line">ksoftirqd_run_end();</span><br><span class="line">cond_resched();</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line">ksoftirqd_run_end();</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">smp_hotplug_thread</span> <span class="title">softirq_threads</span> =</span> {</span><br><span class="line">.store= &amp;ksoftirqd,</span><br><span class="line">.thread_should_run= ksoftirqd_should_run,</span><br><span class="line">.thread_fn= run_ksoftirqd,</span><br><span class="line">.thread_comm= <span class="string">"ksoftirqd/%u"</span>,</span><br><span class="line">};</span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">spawn_ksoftirqd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">cpuhp_setup_state_nocalls(CPUHP_SOFTIRQ_DEAD, <span class="string">"softirq:dead"</span>, <span class="literal">NULL</span>,</span><br><span class="line">  takeover_tasklets);</span><br><span class="line">BUG_ON(smpboot_register_percpu_thread(&amp;softirq_threads));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line">early_initcall(spawn_ksoftirqd);</span><br><span class="line">...</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __smpboot_create_thread(<span class="keyword">struct</span> smp_hotplug_thread *ht, <span class="type">unsigned</span> <span class="type">int</span> cpu)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> =</span> *per_cpu_ptr(ht-&gt;store, cpu);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">smpboot_thread_data</span> *<span class="title">td</span>;</span></span><br><span class="line">    ...</span><br><span class="line">tsk = kthread_create_on_cpu(smpboot_thread_fn, td, cpu,</span><br><span class="line">    ht-&gt;thread_comm);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tsk)) {</span><br><span class="line">kfree(td);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(tsk);</span><br><span class="line">}</span><br><span class="line">kthread_set_per_cpu(tsk, cpu);</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åçº¿ç¨‹ä¸­æ‰§è¡Œ run_ksoftirqd å‡½æ•°ï¼Œrun_ksoftirqd å‡½æ•°é‡Œæ‰§è¡Œ__do_softirq() å‡½æ•°ã€‚</p><h1 id="æŠ¢å è®¡æ•°å™¨">æŠ¢å è®¡æ•°å™¨</h1><p>æ¯ä¸ªè¿›ç¨‹çš„ thread_info ç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨ï¼šint preempt_countï¼Œå®ƒç”¨æ¥è¡¨ç¤ºå½“å‰è¿›ç¨‹èƒ½ä¸èƒ½è¢«æŠ¢å ã€‚</p><p>æŠ¢å æ˜¯æŒ‡å½“è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ—¶å€™å¯ä»¥è¢«å…¶ä»–è¿›ç¨‹æŠ¢å ï¼Œå¦‚æœä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¼ºè¡Œå‰¥å¤ºå½“å‰è¿›ç¨‹çš„å¤„ç†å™¨ä½¿ç”¨æƒã€‚</p><p>ä½†æ˜¯æœ‰æ—¶å€™è¿›ç¨‹å¯èƒ½åœ¨æ‰§è¡Œä¸€äº›å…³é”®æ“ä½œï¼Œä¸èƒ½è¢«æŠ¢å ï¼Œæ‰€ä»¥å†…æ ¸è®¾è®¡äº†æŠ¢å è®¡æ•°å™¨ã€‚å¦‚æœæŠ¢å è®¡æ•°å™¨ä¸º 0ï¼Œè¡¨ç¤ºå¯ä»¥è¢«æŠ¢å ï¼›å¦‚æœæŠ¢å è®¡æ•°å™¨ä¸ä¸º 0ï¼Œè¡¨ç¤ºä¸èƒ½è¢«æŠ¢å ã€‚</p><p>å½“ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›çš„æ—¶å€™ï¼Œå¦‚æœè¿›ç¨‹åœ¨è¢«æ‰“æ–­çš„æ—¶å€™æ­£åœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰§è¡Œï¼Œå°±ä¼šæ£€æŸ¥æŠ¢å è®¡æ•°å™¨æ˜¯å¦ä¸º 0ã€‚å¦‚æœæŠ¢å è®¡æ•°å™¨æ˜¯ 0ï¼Œå¯ä»¥è®©ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å å½“å‰è¿›ç¨‹è™½ç„¶æŠ¢å è®¡æ•°å™¨ä¸ä¸º 0 æ„å‘³ç€ç¦æ­¢æŠ¢å ï¼Œä½†æ˜¯å†…æ ¸è¿›ä¸€æ­¥æŒ‰ç…§å„ç§åœºæ™¯å¯¹æŠ¢å è®¡æ•°å™¨çš„ä½è¿›è¡Œäº†åˆ’åˆ†ï¼Œ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/preempt_count.png"></p><p>å…¶ä¸­ç¬¬ 0 ~ 7 ä½æ˜¯æŠ¢å è®¡æ•°ï¼Œç¬¬ 8 ~ 15 ä½æ˜¯è½¯ä¸­æ–­è®¡æ•°ï¼Œç¬¬ 16 ~ 19 ä½æ˜¯ç¡¬ä¸­æ–­è®¡æ•°ç¬¬ 20 ä½æ˜¯ä¸å¯å±è”½ä¸­æ–­ï¼ˆNon Maskable Interruptï¼ŒNMIï¼‰è®¡æ•°ã€‚ </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PREEMPT_MASK(__IRQ_MASK(PREEMPT_BITS) &lt;&lt; PREEMPT_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOFTIRQ_MASK(__IRQ_MASK(SOFTIRQ_BITS) &lt;&lt; SOFTIRQ_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HARDIRQ_MASK(__IRQ_MASK(HARDIRQ_BITS) &lt;&lt; HARDIRQ_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NMI_MASK(__IRQ_MASK(NMI_BITS)     &lt;&lt; NMI_SHIFT)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREEMPT_BITS8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOFTIRQ_BITS8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HARDIRQ_BITS4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NMI_BITS    4</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å„ç§åœºæ™¯åˆ†åˆ«åˆ©ç”¨å„è‡ªçš„ä½ç¦æ­¢æˆ–å¼€å¯æŠ¢å ã€‚</p><ul><li>æ™®é€šåœºæ™¯ï¼ˆPREEMPT_MASKï¼‰ï¼šå¯¹åº”å‡½æ•° preempt_disable() å’Œ preempt_enable()</li><li>è½¯ä¸­æ–­åœºæ™¯ï¼ˆSOFTIRO_MASKï¼‰ï¼šå¯¹åº”å‡½æ•° local_bh_disable() å’Œ local_bh_enabe()</li><li>ç¡¬ä¸­æ–­åœºæ™¯ï¼ˆHARDIRQ_MASKï¼‰ï¼šå¯¹åº”å‡½æ•° _irq_enter() å’Œ_irq_exit()</li><li>ä¸å¯å±è”½ä¸­æ–­åœºæ™¯ï¼ˆNMI MASKï¼‰ï¼šå¯¹åº”å‡½æ•° nmi_enter() å’Œ nmi_exit()</li></ul><p>åè¿‡æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ¢å è®¡æ•°å™¨çš„å€¼åˆ¤æ–­å½“å‰å¤„åœ¨ä»€ä¹ˆåœºæ™¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;include/linux/preempt.h&gt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macros to retrieve the current execution context:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * in_nmi()- We're in NMI context</span></span><br><span class="line"><span class="comment"> * in_hardirq()- We're in hard IRQ context</span></span><br><span class="line"><span class="comment"> * in_serving_softirq()- We're in softirq context</span></span><br><span class="line"><span class="comment"> * in_task()- We're in task context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_nmi()(nmi_count())</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_hardirq()(hardirq_count())</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_serving_softirq()(softirq_count() &amp; SOFTIRQ_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_task()(!(in_nmi() | in_hardirq() | in_serving_softirq()))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following macros are deprecated and should not be used in new code:</span></span><br><span class="line"><span class="comment"> * in_irq()       - Obsolete version of in_hardirq()</span></span><br><span class="line"><span class="comment"> * in_softirq()   - We have BH disabled, or are processing softirqs</span></span><br><span class="line"><span class="comment"> * in_interrupt() - We're in NMI,IRQ,SoftIRQ context or have BH disabled</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_irq()(hardirq_count())</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_softirq()(softirq_count())</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> in_interrupt()(irq_count())</span></span><br></pre></td></tr></tbody></table></figure><ul><li>in_irq() è¡¨ç¤ºç¡¬ä¸­æ–­åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯æ­£åœ¨æ‰§è¡Œç¡¬ä¸­æ–­</li><li>in_softirq() è¡¨ç¤ºè½¯ä¸­æ–­åœºæ™¯ï¼ŒåŒ…æ‹¬ç¦æ­¢è½¯ä¸­æ–­å’Œæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­</li><li>in_interrupt() è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œä¸å¯å±è”½ä¸­æ–­ã€ç¡¬ä¸­æ–­æˆ–è½¯ä¸­æ–­ï¼Œæˆ–è€…ç¦æ­¢è½¯ä¸­æ–­</li><li>in_serving_softirq() è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­</li><li>in_nmi() è¡¨ç¤ºä¸å¯å±è”½ä¸­æ–­åœºæ™¯</li><li>in_task() è¡¨ç¤ºæ™®é€šåœºæ™¯ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹ä¸Šä¸‹æ–‡</li></ul><h1 id="ç¦æ­¢å¼€å¯è½¯ä¸­æ–­">ç¦æ­¢/å¼€å¯è½¯ä¸­æ–­</h1><p>å¦‚æœè¿›ç¨‹å’Œè½¯ä¸­æ–­å¯èƒ½è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿›ç¨‹å’Œè½¯ä¸­æ–­éœ€è¦äº’æ–¥ï¼Œè¿›ç¨‹éœ€è¦ç¦æ­¢è½¯ä¸­æ–­ã€‚ç¦æ­¢è½¯ä¸­æ–­çš„å‡½æ•°æ˜¯ local_bh_disable()ï¼Œæ³¨æ„ï¼šè¿™ä¸ªå‡½æ•°åªèƒ½ç¦æ­¢æœ¬å¤„ç†å™¨çš„è½¯ä¸­æ–­ï¼Œä¸èƒ½ç¦æ­¢å…¶ä»–å¤„ç†å™¨çš„è½¯ä¸­æ–­ã€‚è¯¥å‡½æ•°æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°åŠ  2ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">local_bh_disable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">__local_bh_disable_ip(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOFTIRQ_DISABLE_OFFSET(2 * SOFTIRQ_OFFSET)</span></span><br></pre></td></tr></tbody></table></figure><p>è°ƒç”¨__local_bh_disable_ip å‡½æ•°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> __local_bh_disable_ip(<span class="type">unsigned</span> <span class="type">long</span> ip, <span class="type">unsigned</span> <span class="type">int</span> cnt)</span><br><span class="line">{</span><br><span class="line">preempt_count_add(cnt);</span><br><span class="line">barrier();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¼€å¯è½¯ä¸­æ–­çš„å‡½æ•°æ˜¯ local_bh_enable()ï¼Œè¯¥å‡½æ•°æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°å‡ 2ã€‚ä¸ºä»€ä¹ˆç¦æ­¢è½¯ä¸­æ–­çš„å‡½æ•° local_bh_disable() æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°åŠ  2ï¼Œè€Œä¸æ˜¯åŠ  1 å‘¢ï¼Ÿç›®çš„æ˜¯åŒºåˆ†ç¦æ­¢è½¯ä¸­æ–­å’Œæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­è¿™ä¸¤ç§æƒ…å†µã€‚æ‰§è¡Œè½¯ä¸­æ–­çš„å‡½æ•°__do_sofir() æŠŠæŠ¢å è®¡æ•°å™¨çš„è½¯ä¸­æ–­è®¡æ•°åŠ  1ã€‚å¦‚æœè½¯ä¸­æ–­è®¡æ•°æ˜¯å¥‡æ•°ï¼Œå¯ä»¥ç¡®å®šæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvaXJxX3N1YnN5c3RlbS9zb2Z0LWlycS5odG1s">http://www.wowotech.net/irq_subsystem/soft-irq.html<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84MDM3MTc0NQ==">https://zhuanlan.zhihu.com/p/80371745<i class="fa fa-external-link-alt"></i></span></p><p>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆå››ï¼‰ä¸­æ–­é©±åŠ¨å®ç°</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptFramework/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptFramework/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQLinuxImpl.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1ODljMjYzNzY4OTA3MTA1ODk3YjM=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>ç†è§£ä¸€ä¸ªè½¯ä»¶æ¶æ„æœ€é‡è¦çš„æ˜¯è¦ç†æ¸…æ¥šé‡Œé¢çš„æ•°æ®ç»“æ„çš„å†…å®¹ä»¥åŠæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨æœ¬æ–‡ä¸­åˆ—å‡ºæ•°æ®ç»“æ„ä¹‹å‰å…ˆæ¥è¯´æ˜å‡ ä¸ªé—®é¢˜ã€‚é¦–å…ˆæ˜¯ä¸­æ–­æ§åˆ¶å™¨ irq controller è¿™ä¸ªåœ¨ arm ä¸Šä¸€èˆ¬æ˜¯ gicï¼Œæœ‰å¯èƒ½ä¼šå‡ºç° irq controller é›†è”çš„æƒ…å†µï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸€ä¸ª controllerï¼Œä¸€ä¸ª controller ä¸Šæœ‰å¾ˆå¤šä¸­æ–­çº¿ï¼Œirq line ä¸€èˆ¬å°±æ˜¯è¿æ¥åˆ° gpio æ§åˆ¶å™¨ä¸Šçš„ï¼Œåœ¨ä¸€ä¸ªä¸­æ–­çº¿ä¸Šå¯èƒ½æœ‰å¤šä¸ªè®¾å¤‡ï¼ˆå…±äº«ä¸­æ–­ï¼‰actionï¼Œé‚£ä¹ˆå°±æ¶‰åŠåˆ°è¿™å‡ ç§æ•°æ®ç»“æ„ï¼Œæè¿°ä¸­æ–­æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„å¯ä»¥ç»„æˆé“¾è¡¨ï¼Œæè¿°ä¸­æ–­çº¿ irq line çš„æ•°æ®ç»“æ„å¯ä»¥ç»„æˆé“¾è¡¨ï¼ŒæŒ‚åœ¨ä¸­æ–­çº¿ä¸Šçš„ä¸­æ–­è®¾å¤‡å¯ä»¥ç»„æˆé“¾è¡¨å…³ç³»ã€‚&nbsp;é™¤æ­¤ä¹‹å¤–ç¡¬ä»¶ä¸­æ–­å·äº linux ä¸­æ–­å·ä¹‹é—´æœ‰ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œä¹Ÿéœ€è¦æŠ½è±¡å‡ºæ•°æ®ç»“æ„æ¥æè¿°ã€‚ä¸‹é¢çœ‹ä¸‹ linux å†…æ ¸ä¸‹å¯¹ä¸­æ–­çš„æŠ½è±¡å‡ºçš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQ_Struct.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9kaWFncmFtaW5nLzYxNDg3ODJiMDc5MTI5NDNjMDVhYzg4MA==">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><ul><li><p>irq_descï¼ˆæè¿°ä¸­æ–­çº¿è¿æ¥ä¸­æ–­è®¾å¤‡å’Œä¸­æ–­æ§åˆ¶å™¨ï¼‰<br>irq_desc æ˜¯ä¸­æ–­æè¿°ç¬¦ä¹Ÿå°±æ˜¯ç”¨äºæè¿°ç¡¬ä»¶ä¸­æ–­çº¿çš„æ•°æ®ç»“æ„ã€‚ä»–ä¸€æ–¹é¢é€šè¿‡ irq_data è¿æ¥ä¸­æ–­æ§åˆ¶å™¨ï¼Œä¸€è¾¹è¿æ¥ä¸­æ–­è®¾å¤‡ï¼Œä¸­æ–­è®¾å¤‡çš„æ“ä½œéœ€è¦é€šè¿‡è¯¥ç»“æ„ä½“æ‰¾åˆ° irq_dataï¼Œè¿›è€Œæ‰¾åˆ°ä¸­æ–­æ§åˆ¶å™¨ï¼Œæ¯•ç«Ÿä¸­æ–­ä½¿èƒ½ç­‰æ“ä½œéƒ½æ˜¯ä¸­æ–­æ§åˆ¶å™¨æä¾›çš„æ¥å£ã€‚è¯¥ç»“æ„ä½“åŠŸèƒ½åŒ…æ‹¬è¯¥ç¡¬ä»¶ irq line ä¸­æ–­è§¦å‘æ—¶ï¼Œæ‰§è¡Œçš„å¯¹åº”æ“ä½œï¼Œä»¥åŠä½¿ç”¨è¯¥ irq çš„å¤–è®¾æ³¨å†Œçš„æ“ä½œæ¥å£ï¼ˆå½“ä¸€ä¸ªç¡¬ä»¶ irq line æ˜¯å…±äº«ä¸­æ–­æ—¶ï¼Œå¯æ³¨å†Œå¤šä¸ªæ“ä½œæ¥å£ï¼‰ç­‰ä¿¡æ¯</p></li><li><p>irq_domainï¼ˆæè¿°ä¸­æ–­åŸŸï¼‰<br>ç”¨äºæè¿° irq åŸŸï¼Œè¯¥æ•°æ®ç»“æ„ä¸»è¦ç”¨äºå­˜å‚¨ç¡¬ä»¶ irq line ä¸ linux ä¸­æ–­å·çš„æ˜ å°„å…³ç³»ï¼Œå¹¶æä¾› irq_domain_opsï¼Œå®ç°è¯¥ irq åŸŸä¸‹ç¡¬ä»¶ irq line çš„ top handler çš„è®¾ç½®ç­‰æ“ä½œ</p></li><li><p>irq_chipï¼ˆæè¿°ä¸­æ–­æ§åˆ¶å™¨ï¼‰<br>irq_chip ç»“æ„ä½“æ˜¯ç”¨äºæè¿° irq controller çš„ï¼Œä¸»è¦å°±æ˜¯æä¾›å…·ä½“çš„ä¸­æ–­æ§åˆ¶å™¨æ“ä½œæ¥å£ï¼Œä¸­æ–­æ§åˆ¶å™¨å†…éƒ¨ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åˆ†å‘å™¨ï¼Œä¸€ä¸ªæ˜¯ cpu æ¥å£ï¼Œè€Œè¿™ä¸¤éƒ¨åˆ†æ˜¯å®Œæˆå¯¹ä¸­æ–­çš„æ§åˆ¶çš„ï¼ŒåŒ…æ‹¬ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ï¼Œå±è”½å’Œä½¿èƒ½ç­‰æ“ä½œï¼Œä»¥åŠä¸­æ–­ä¸ cpu ä¹‹é—´çš„ç»‘å®šç­‰æ“ä½œ</p></li><li><p>irqactionï¼ˆæè¿°ä¸­æ–­å¤„ç†æ–¹æ³•ï¼‰<br>irqaction ä¸»è¦å°±æ˜¯æè¿°ä¸­æ–­çº¿ä¸Šçš„è®¾å¤‡ä»¥åŠå¤„ç†æ–¹æ³•äº†ï¼Œæä¾›äº†ä¸­æ–­ä¸Šä¸‹æ–‡å¤„ç† handle ä»¥åŠçº¿ç¨‹åŒ–å¤„ç†çš„ handle</p></li><li><p>irq_data<br>è¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªæ¡¥æ¢ç”¨äºè¿æ¥ irq_desc å’Œ irq_chip ä»¥åŠ irq_domainã€‚</p></li></ul><p>ä¸‹é¢ä»¥ irq_desc é€šè¿‡æ•°ç»„çš„æ–¹å¼ç»„ç»‡ä¸ºä¾‹ï¼Œåˆ—å‡ºä¸Šè¿°æ•°æ®ç»“æ„ä¹‹é—´çš„ç»„ç»‡å…³ç³»ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQ_List.png"> <span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxNDhhYzU4MWUwODUzMTVkYzRkY2JlZC5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°çš„æ˜¯ï¼Œå†…æ ¸é©±åŠ¨ä¸­å…³äºä¸­æ–­ç›¸å…³æ•°æ®ç»“æ„çš„ç»„ç»‡æ–¹å¼ï¼Œä¹Ÿå°±æ¸…æ¥šäº†å†…æ ¸ä¸­å…³äºä¸­æ–­çš„é©±åŠ¨æ¡†æ¶äº†ã€‚</p><hr><h1 id="å®ç°æ‰©å±•">å®ç°ï¼ˆæ‰©å±•ğŸ™ˆï¼‰</h1><p>è®¾å¤‡é©±åŠ¨å¼€å‘äººå‘˜å¸¸ç”¨çš„æ¥å£æ˜¯ request_irq()/request_threaded_irqï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __must_check</span><br><span class="line"><span class="title function_">request_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *dev)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> request_threaded_irq(irq, handler, <span class="literal">NULL</span>, flags, name, dev);</span><br><span class="line">}</span><br><span class="line">...</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __must_check</span><br><span class="line"><span class="title function_">request_threaded_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler,</span></span><br><span class="line"><span class="params">     <span class="type">irq_handler_t</span> thread_fn,</span></span><br><span class="line"><span class="params">     <span class="type">unsigned</span> <span class="type">long</span> flags, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *dev)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ° request_irq å…¶å®å°±æ˜¯è°ƒç”¨ request_threaded_irq å®ç°çš„ï¼Œåªæ˜¯æ²¡æœ‰æä¾› thread_fn æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æä¾›ä¸­æ–­ä¸‹åŠéƒ¨çš„å®ç°å‡½æ•°ã€‚</p><p>è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ irq ä¹Ÿå°±æ˜¯ linux ä¸­æ–­å·ï¼Œè¿™ä¸ªä¸­æ–­å·é©±åŠ¨å¼€å‘äººå‘˜è¯¥å¦‚ä½•è·å¾—å‘¢ï¼Œå…¶å®å°±æ˜¯åœ¨è®¾å¤‡æ ‘é‡ŒæŒ‡å®šçš„ï¼Œå…¶ä¸­ device ç»“æ„ä½“é‡Œæœ‰ device_node ç»“æ„ä½“é‡Œå°±æœ‰è®¾å¤‡æ ‘ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å‡½æ•° platform_get_irq è·å¾—ä¸­æ–­å·ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯æ¥ä¸‹æ¥å°±æ˜¯æ³¨å†Œä¸€ä¸ªä¸­æ–­äº†ï¼Œä¸‹é¢å°†ä¼šè¯¦ç»†åˆ†æä¸€ä¸‹ request_threaded_irq å‡½æ•°çš„å®ç°æ–¹å¼ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">request_threaded_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler,</span></span><br><span class="line"><span class="params"> <span class="type">irq_handler_t</span> thread_fn, <span class="type">unsigned</span> <span class="type">long</span> irqflags,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *devname, <span class="type">void</span> *dev_id)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span> *<span class="title">action</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (irq == IRQ_NOTCONNECTED)</span><br><span class="line"><span class="keyword">return</span> -ENOTCONN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. æ£€æŸ¥ irqflagsï¼Œå¦‚æœæ˜¯ IRQF_SHARED åˆ™å¿…é¡»æä¾› dev_id */</span></span><br><span class="line"><span class="keyword">if</span> (((irqflags &amp; IRQF_SHARED) &amp;&amp; !dev_id) ||</span><br><span class="line">    ((irqflags &amp; IRQF_SHARED) &amp;&amp; (irqflags &amp; IRQF_NO_AUTOEN)) ||</span><br><span class="line">    (!(irqflags &amp; IRQF_SHARED) &amp;&amp; (irqflags &amp; IRQF_COND_SUSPEND)) ||</span><br><span class="line">    ((irqflags &amp; IRQF_NO_SUSPEND) &amp;&amp; (irqflags &amp; IRQF_COND_SUSPEND)))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. é€šè¿‡ä¸­æ–­å·è·å¾— irq_desc ç»“æ„ä½“ */</span></span><br><span class="line">desc = irq_to_desc(irq);</span><br><span class="line"><span class="keyword">if</span> (!desc)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!irq_settings_can_request(desc) ||</span><br><span class="line">    WARN_ON(irq_settings_is_per_cpu_devid(desc)))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!handler) {</span><br><span class="line"><span class="keyword">if</span> (!thread_fn)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">handler = irq_default_primary_handler;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. åˆ†é…å¹¶è®¾ç½® irqaction ç»“æ„ä½“ */</span></span><br><span class="line">action = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> irqaction), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!action)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">action-&gt;handler = handler;</span><br><span class="line">action-&gt;thread_fn = thread_fn;</span><br><span class="line">action-&gt;flags = irqflags;</span><br><span class="line">action-&gt;name = devname;</span><br><span class="line">action-&gt;dev_id = dev_id;</span><br><span class="line"></span><br><span class="line">retval = irq_chip_pm_get(&amp;desc-&gt;irq_data);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>) {</span><br><span class="line">kfree(action);</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. äºå®Œæˆä¸­æ–­çš„ç›¸å…³è®¾ç½®ï¼ŒåŒ…æ‹¬ä¸­æ–­çº¿ç¨‹åŒ–çš„å¤„ç†*/</span></span><br><span class="line">retval = __setup_irq(irq, desc, action);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (retval) {</span><br><span class="line">irq_chip_pm_put(&amp;desc-&gt;irq_data);</span><br><span class="line">kfree(action-&gt;secondary);</span><br><span class="line">kfree(action);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(request_threaded_irq);</span><br></pre></td></tr></tbody></table></figure><p>æ­¤è°ƒç”¨åˆ†é…ä¸­æ–­èµ„æºå¹¶å¯ç”¨ä¸­æ–­çº¿å’Œ IRQ å¤„ç†ã€‚å¦‚æœä½ æƒ³ä¸ºä½ çš„è®¾å¤‡è®¾ç½®ä¸€ä¸ªçº¿ç¨‹ä¸­æ–­å¤„ç†ç¨‹åºï¼Œé‚£ä¹ˆä½ éœ€è¦æä¾›@handler å’Œ@thread_fnã€‚ <span class="citation" data-cites="handler">@handler</span> ä»ç„¶åœ¨ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è¢«è°ƒç”¨ï¼Œå¹¶ä¸”å¿…é¡»æ£€æŸ¥ä¸­æ–­æ˜¯å¦æ¥è‡ªè®¾å¤‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦ç¦ç”¨è®¾å¤‡ä¸Šçš„ä¸­æ–­å¹¶è¿”å› IRQ_WAKE_THREADï¼Œè¿™å°†å”¤é†’å¤„ç†ç¨‹åºçº¿ç¨‹å¹¶è¿è¡Œ <span class="citation" data-cites="thread_fn">@thread_fn</span>ã€‚ è¿™ç§æ‹†åˆ†å¤„ç†ç¨‹åºè®¾è®¡å¯¹äºæ”¯æŒå…±äº«ä¸­æ–­æ˜¯å¿…è¦çš„ã€‚</p><p>dev_id å¿…é¡»æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ é€šå¸¸è®¾å¤‡æ•°æ®ç»“æ„çš„åœ°å€ç”¨ä½œ cookieã€‚å¦‚æœä¸­æ–­æ˜¯å…±äº«çš„ï¼Œåˆ™å¿…é¡»ä¼ é€’ä¸€ä¸ªéç©ºçš„ dev_idï¼Œå› ä¸ºè¿™æ˜¯é‡Šæ”¾ä¸­æ–­æ—¶æ‰€å¿…éœ€çš„å­—æ®µã€‚</p><p>è¯¥å‡½æ•°ä¼šè°ƒç”¨__setup_irq å‡½æ•°ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line">__setup_irq(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="keyword">struct</span> irq_desc *desc, <span class="keyword">struct</span> irqaction *new)</span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span> *<span class="title">old</span>, **<span class="title">old_ptr</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags, thread_mask = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> ret, nested, shared = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!desc)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (desc-&gt;irq_data.chip == &amp;no_irq_chip)</span><br><span class="line"><span class="keyword">return</span> -ENOSYS;</span><br><span class="line"><span class="keyword">if</span> (!try_module_get(desc-&gt;owner))</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">new-&gt;irq = irq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. å¦‚æœæ²¡æœ‰æä¾› flagsï¼Œåˆ™ä½¿ç”¨é»˜è®¤ flags */</span></span><br><span class="line"><span class="keyword">if</span> (!(new-&gt;flags &amp; IRQF_TRIGGER_MASK))</span><br><span class="line">new-&gt;flags |= irqd_get_trigger_type(&amp;desc-&gt;irq_data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. æ£€æŸ¥ä¸­æ–­æ˜¯å¦åµŒå¥—åˆ°å¦ä¸€ä¸ªä¸­æ–­çº¿ç¨‹ä¸­ */</span></span><br><span class="line">nested = irq_settings_is_nested_thread(desc);</span><br><span class="line"><span class="keyword">if</span> (nested) {</span><br><span class="line"><span class="keyword">if</span> (!new-&gt;thread_fn) {</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> out_mput;</span><br><span class="line">}</span><br><span class="line">        <span class="comment">/* 3. å°†é©±åŠ¨ç¨‹åºä¸ºéåµŒå¥—ä¸­æ–­å¤„ç†æä¾›çš„ä¸»å¤„ç†ç¨‹åºæ›¿æ¢ä¸ºåœ¨è°ƒç”¨æ—¶å‘å‡ºè­¦å‘Šçš„è™šæ‹Ÿå‡½æ•°ã€‚*/</span></span><br><span class="line">new-&gt;handler = irq_nested_primary_handler;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line"><span class="keyword">if</span> (irq_settings_can_thread(desc)) {</span><br><span class="line">            <span class="comment">/* 4. å¼ºåˆ¶çº¿ç¨‹åŒ– */</span></span><br><span class="line">ret = irq_setup_forced_threading(new);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out_mput;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5. å½“æä¾›äº†çº¿ç¨‹å‡½æ•°å¹¶ä¸”ä¸­æ–­æ²¡æœ‰åµŒå¥—åˆ°å¦ä¸€ä¸ªä¸­æ–­çº¿ç¨‹ä¸­æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå¤„ç†ç¨‹åºçº¿ç¨‹ã€‚*/</span></span><br><span class="line"><span class="keyword">if</span> (new-&gt;thread_fn &amp;&amp; !nested) {</span><br><span class="line">ret = setup_irq_thread(new, irq, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out_mput;</span><br><span class="line"><span class="keyword">if</span> (new-&gt;secondary) {</span><br><span class="line">ret = setup_irq_thread(new-&gt;secondary, irq, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out_thread;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (desc-&gt;irq_data.chip-&gt;flags &amp; IRQCHIP_ONESHOT_SAFE)</span><br><span class="line">new-&gt;flags &amp;= ~IRQF_ONESHOT;</span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;desc-&gt;request_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 6. è·å–æ€»çº¿é”ï¼Œå› ä¸ºä¸‹é¢çš„ irq_request_resources() å›è°ƒå¯èƒ½ä¾èµ–äºåºåˆ—åŒ–*/</span></span><br><span class="line">chip_bus_lock(desc);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7. ç¬¬ä¸€ä¸ªå®‰è£…çš„åŠ¨ä½œè¯·æ±‚èµ„æº */</span></span><br><span class="line"><span class="keyword">if</span> (!desc-&gt;action) {</span><br><span class="line">ret = irq_request_resources(desc);</span><br><span class="line"><span class="keyword">if</span> (ret) {</span><br><span class="line">pr_err(<span class="string">"Failed to request resources for %s (irq %d) on irqchip %s\n"</span>,</span><br><span class="line">       new-&gt;name, irq, desc-&gt;irq_data.chip-&gt;name);</span><br><span class="line"><span class="keyword">goto</span> out_bus_unlock;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 8. ä¸‹ä»£ç å—å¿…é¡»ä»¥åŸå­æ–¹å¼æ‰§è¡Œï¼Œä»¥é˜²æ­¢å¹¶å‘ä¸­æ–­å’Œä»»ä½•å…¶ä»–æœªé€šè¿‡ desc-&gt;request_mutex æˆ–å¯é€‰æ€»çº¿é”åºåˆ—åŒ–çš„ç®¡ç†è°ƒç”¨ã€‚*/</span></span><br><span class="line">raw_spin_lock_irqsave(&amp;desc-&gt;lock, flags);</span><br><span class="line">old_ptr = &amp;desc-&gt;action;</span><br><span class="line">old = *old_ptr;</span><br><span class="line"><span class="keyword">if</span> (old) {</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> oldtype;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (desc-&gt;istate &amp; IRQS_NMI) {</span><br><span class="line">pr_err(<span class="string">"Invalid attempt to share NMI for %s (irq %d) on irqchip %s.\n"</span>,</span><br><span class="line">new-&gt;name, irq, desc-&gt;irq_data.chip-&gt;name);</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 9. å¦‚æœä¹‹å‰æ²¡æœ‰äººè®¾ç½®è¿‡ï¼Œåˆ™ç»§æ‰¿è¯·æ±‚è€…æä¾›çš„é…ç½®*/</span></span><br><span class="line"><span class="keyword">if</span> (irqd_trigger_type_was_set(&amp;desc-&gt;irq_data)) {</span><br><span class="line">oldtype = irqd_get_trigger_type(&amp;desc-&gt;irq_data);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">oldtype = new-&gt;flags &amp; IRQF_TRIGGER_MASK;</span><br><span class="line">irqd_set_trigger_type(&amp;desc-&gt;irq_data, oldtype);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!((old-&gt;flags &amp; new-&gt;flags) &amp; IRQF_SHARED) ||</span><br><span class="line">    (oldtype != (new-&gt;flags &amp; IRQF_TRIGGER_MASK)) ||</span><br><span class="line">    ((old-&gt;flags ^ new-&gt;flags) &amp; IRQF_ONESHOT))</span><br><span class="line"><span class="keyword">goto</span> mismatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* All handlers must agree on per-cpuness */</span></span><br><span class="line"><span class="keyword">if</span> ((old-&gt;flags &amp; IRQF_PERCPU) !=</span><br><span class="line">    (new-&gt;flags &amp; IRQF_PERCPU))</span><br><span class="line"><span class="keyword">goto</span> mismatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add new interrupt at end of irq queue */</span></span><br><span class="line"><span class="keyword">do</span> {</span><br><span class="line">            <span class="comment">/* 10. æ‰€æœ‰ç°æœ‰çš„ action-&gt;thread_mask ä½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ–°åŠ¨ä½œçš„ä¸‹ä¸€ä¸ªç©ºä½*/</span></span><br><span class="line">thread_mask |= old-&gt;thread_mask;</span><br><span class="line">old_ptr = &amp;old-&gt;next;</span><br><span class="line">old = *old_ptr;</span><br><span class="line">} <span class="keyword">while</span> (old);</span><br><span class="line">shared = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 11. ä¸º ONESHOT è®¾ç½®æ­¤ irqaction çš„çº¿ç¨‹æ©ç */</span></span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_ONESHOT) {</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Unlikely to have 32 resp 64 irqs sharing one line,</span></span><br><span class="line"><span class="comment"> * but who knows.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (thread_mask == ~<span class="number">0UL</span>) {</span><br><span class="line">ret = -EBUSY;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">}</span><br><span class="line">new-&gt;thread_mask = <span class="number">1UL</span> &lt;&lt; ffz(thread_mask);</span><br><span class="line"></span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (new-&gt;handler == irq_default_primary_handler &amp;&amp;</span><br><span class="line">   !(desc-&gt;irq_data.chip-&gt;flags &amp; IRQCHIP_ONESHOT_SAFE)) {</span><br><span class="line">pr_err(<span class="string">"Threaded irq requested with handler=NULL and !ONESHOT for %s (irq %d)\n"</span>,</span><br><span class="line">       new-&gt;name, irq);</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!shared) {</span><br><span class="line">init_waitqueue_head(&amp;desc-&gt;wait_for_threads);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Setup the type (level, edge polarity) if configured: */</span></span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_TRIGGER_MASK) {</span><br><span class="line">ret = __irq_set_trigger(desc,</span><br><span class="line">new-&gt;flags &amp; IRQF_TRIGGER_MASK);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 12. æ¿€æ´»ä¸­æ–­ï¼Œè¯¥æ¿€æ´»å¿…é¡»ç‹¬ç«‹äº IRQ_NOAUTOEN å‘ç”Ÿ*/</span></span><br><span class="line">ret = irq_activate(desc);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">desc-&gt;istate &amp;= ~(IRQS_AUTODETECT | IRQS_SPURIOUS_DISABLED | \</span><br><span class="line">  IRQS_ONESHOT | IRQS_WAITING);</span><br><span class="line">irqd_clear(&amp;desc-&gt;irq_data, IRQD_IRQ_INPROGRESS);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_PERCPU) {</span><br><span class="line">irqd_set(&amp;desc-&gt;irq_data, IRQD_PER_CPU);</span><br><span class="line">irq_settings_set_per_cpu(desc);</span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_NO_DEBUG)</span><br><span class="line">irq_settings_set_no_debug(desc);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (noirqdebug)</span><br><span class="line">irq_settings_set_no_debug(desc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_ONESHOT)</span><br><span class="line">desc-&gt;istate |= IRQS_ONESHOT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exclude IRQ from balancing if requested */</span></span><br><span class="line"><span class="keyword">if</span> (new-&gt;flags &amp; IRQF_NOBALANCING) {</span><br><span class="line">irq_settings_set_no_balancing(desc);</span><br><span class="line">irqd_set(&amp;desc-&gt;irq_data, IRQD_NO_BALANCING);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(new-&gt;flags &amp; IRQF_NO_AUTOEN) &amp;&amp;</span><br><span class="line">    irq_settings_can_autoenable(desc)) {</span><br><span class="line">irq_startup(desc, IRQ_RESEND, IRQ_START_COND);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">WARN_ON_ONCE(new-&gt;flags &amp; IRQF_SHARED);</span><br><span class="line"><span class="comment">/* Undo nested disables: */</span></span><br><span class="line">desc-&gt;depth = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (new-&gt;flags &amp; IRQF_TRIGGER_MASK) {</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> nmsk = new-&gt;flags &amp; IRQF_TRIGGER_MASK;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> omsk = irqd_get_trigger_type(&amp;desc-&gt;irq_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nmsk != omsk)</span><br><span class="line"><span class="comment">/* hope the handler works with current  trigger mode */</span></span><br><span class="line">pr_warn(<span class="string">"irq %d uses trigger mode %u; requested %u\n"</span>,</span><br><span class="line">irq, omsk, nmsk);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">*old_ptr = new;</span><br><span class="line"></span><br><span class="line">irq_pm_install_action(desc, new);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reset broken irq detection when installing new handler */</span></span><br><span class="line">desc-&gt;irq_count = <span class="number">0</span>;</span><br><span class="line">desc-&gt;irqs_unhandled = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 13. æ£€æŸ¥æˆ‘ä»¬ä¹‹å‰æ˜¯å¦ç¦ç”¨äº† irqï¼Œé‡æ–°å¯ç”¨å®ƒ*/</span></span><br><span class="line"><span class="keyword">if</span> (shared &amp;&amp; (desc-&gt;istate &amp; IRQS_SPURIOUS_DISABLED)) {</span><br><span class="line">desc-&gt;istate &amp;= ~IRQS_SPURIOUS_DISABLED;</span><br><span class="line">__enable_irq(desc);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">raw_spin_unlock_irqrestore(&amp;desc-&gt;lock, flags);</span><br><span class="line">chip_bus_sync_unlock(desc);</span><br><span class="line">mutex_unlock(&amp;desc-&gt;request_mutex);</span><br><span class="line"></span><br><span class="line">irq_setup_timings(desc, new);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (new-&gt;thread)</span><br><span class="line">wake_up_process(new-&gt;thread);</span><br><span class="line"><span class="keyword">if</span> (new-&gt;secondary)</span><br><span class="line">wake_up_process(new-&gt;secondary-&gt;thread);</span><br><span class="line"></span><br><span class="line">register_irq_proc(irq, desc);</span><br><span class="line">new-&gt;dir = <span class="literal">NULL</span>;</span><br><span class="line">register_handler_proc(irq, new);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åˆ°è¿™é‡Œä¸­æ–­æ³¨å†Œå°±å®Œæˆäº†ï¼Œä¸‹é¢ä»¥ä¸€å¼ å›¾æ¥æ¢³ç†å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/Request_IRQ.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9kaWFncmFtaW5nLzYxNDk0NWM2NTY1M2JiMzUyNTMwOTg1Nw==">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>åœ¨ä¸Šé¢çš„ä»‹ç»ä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼Œä¸­æ–­æ³¨å†Œå°±æ˜¯æ„å»ºä¸Šé¢çš„æ•°æ®ç»“æ„ï¼Œå°†æ–°çš„ä¸­æ–­æŒ‚åœ¨ç›¸åº”çš„æ•°æ®ç»“æ„ä¸Šï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ä¼šé€šè¿‡å‰é¢ä»‹ç»çš„ä¸­æ–­å‘é‡è¡¨å¼€å§‹æ‰§è¡Œç›¸åº”çš„å‡½æ•°ï¼Œè·å¾—ä¸­æ–­å·ï¼Œæ ¹æ®ä¸­æ–­å·æ‰¾åˆ° irq_desc ç„¶åè°ƒç”¨ irqaction ä¸Šçš„å‡½æ•°ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vTG95ZW5XYW5nL3AvMTI5OTY4MTIuaHRtbA==">https://www.cnblogs.com/LoyenWang/p/12996812.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vTG95ZW5XYW5nL3AvMTMwNTI2NzcuaHRtbA==">https://www.cnblogs.com/LoyenWang/p/13052677.html<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹<br>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆä¸‰ï¼‰Linux ä¸­æ–­å¤„ç†è¿‡ç¨‹</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptLinuxDealWith/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptLinuxDealWith/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQLinuxDealWith.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1ODFjZDU2NTNiYjA3MWU2ZTZkYmU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ä¸­æ–­æ§åˆ¶å™¨">ä¸­æ–­æ§åˆ¶å™¨</h1><p>ARM å…¬å¸æä¾›äº†ä¸€ç§æ ‡å‡†çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œç§°ä¸ºé€šç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼ˆGeneric IntermurControllerï¼ŒGICï¼‰ã€‚ç›®å‰ GIC æ¶æ„è§„èŒƒæœ‰ 4 ä¸ªç‰ˆæœ¬ï¼šv1~v4ã€‚GICv2 æœ€å¤šæ”¯æŒ 8 ä¸ªå¤„ç†å™¨ã€‚GIC v3 æœ€å¤šæ”¯æŒ 128 ä¸ªå¤„ç†å™¨ï¼ŒGICv3 å’Œ GICv4 åªæ”¯æŒ ARM64 å¤„ç†å™¨ã€‚</p><h2 id="gicv2-æ§åˆ¶å™¨çš„ä¸¤ä¸ªä¸»è¦åŠŸèƒ½">GICv2 æ§åˆ¶å™¨çš„ä¸¤ä¸ªä¸»è¦åŠŸèƒ½</h2><ul><li>åˆ†å‘å™¨ï¼ˆDistributorï¼‰ï¼šç³»ç»Ÿä¸­æ‰€æœ‰çš„ä¸­æ–­æºè¿æ¥åˆ°åˆ†å‘å™¨ï¼Œåˆ†å‘å™¨çš„å¯„å­˜å™¨ç”¨æ¥æ§åˆ¶å•ä¸ªä¸­æ–­çš„å±æ€§ï¼šä¼˜å…ˆçº§ã€çŠ¶æ€ã€å®‰å…¨ã€è½¬å‘ä¿¡æ¯ï¼ˆå¯ä»¥è¢«å‘é€åˆ°å“ªäº›å¤„ç†å™¨ï¼‰å’Œä½¿èƒ½çŠ¶æ€ã€‚åˆ†å‘å™¨å†³å®šå“ªä¸ªä¸­æ–­åº”è¯¥é€šè¿‡å¤„ç†å™¨æ¥å£è½¬å‘åˆ°å“ªä¸ªå¤„ç†å™¨</li><li>å¤„ç†å™¨æ¥å£ï¼ˆCPU Interfaceï¼‰ï¼šå¤„ç†å™¨é€šè¿‡å¤„ç†å™¨æ¥å£æ¥æ”¶ä¸­æ–­ã€‚å¤„ç†å™¨æ¥å£æä¾›çš„å¯„å­˜å™¨ç”¨æ¥å±è”½å’Œè¯†åˆ«ä¸­æ–­ï¼Œæ§åˆ¶ä¸­æ–­çš„çŠ¶æ€ã€‚æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªå•ç‹¬çš„å¤„ç†å™¨æ¥å£ã€‚è½¯ä»¶é€šè¿‡ä¸­æ–­å·è¯†åˆ«ä¸­æ–­ï¼Œæ¯ä¸ªä¸­æ–­å·å”¯ä¸€å¯¹åº”ä¸€ä¸ªä¸­æ–­æº</li></ul><h2 id="ä¸­æ–­æœ‰ä»¥ä¸‹-4-ç§ç±»å‹">ä¸­æ–­æœ‰ä»¥ä¸‹ 4 ç§ç±»å‹</h2><ul><li>è½¯ä»¶ç”Ÿæˆçš„ä¸­æ–­ï¼ˆSoftware Generated Interruptï¼ŒSGIï¼‰ï¼šä¸­æ–­å· 0~15ï¼Œé€šå¸¸ç”¨æ¥å®ç°å¤„ç†å™¨é—´ä¸­æ–­ï¼ˆInter-Processor Iterruptï¼ŒIPIï¼‰ã€‚è¿™ç§ä¸­æ–­æ˜¯ç”±è½¯ä»¶å†™åˆ†å‘å™¨çš„è½¯ä»¶ç”Ÿæˆä¸­æ–­å¯„å­˜å™¨ï¼ˆGICD_SGIRï¼‰ç”Ÿæˆçš„</li><li>ç§æœ‰å¤–è®¾ä¸­æ–­ï¼ˆPrivate Peripheral Iterruptï¼ŒPPIï¼‰ï¼šä¸­æ–­å· 16~31ã€‚å¤„ç†å™¨ç§æœ‰çš„ä¸­æ–­æºï¼Œä¸åŒå¤„ç†å™¨çš„ç›¸åŒä¸­æ–­æºæ²¡æœ‰å…³ç³»ï¼Œæ¯”å¦‚æ¯ä¸ªå¤„ç†å™¨çš„å®šæ—¶å™¨</li><li>å…±äº«å¤–è®¾ä¸­æ–­ï¼ˆShared Peripheral Iterruptï¼ŒSPIï¼‰ï¼šä¸­æ–­å· 32~1020ã€‚è¿™ç§ä¸­æ–­å¯ä»¥è¢«ä¸­æ–­æ§åˆ¶å™¨è½¬å‘åˆ°å¤šä¸ªå¤„ç†å™¨</li><li>å±€éƒ¨ç‰¹å®šå¤–è®¾ä¸­æ–­ï¼ˆLocality-specific Peripheral Interruntï¼ŒLPIï¼‰ï¼ŒåŸºäºæ¶ˆæ¯çš„ä¸­æ–­ GICï¼Œ v1 å’Œ GIC v2 ä¸æ”¯æŒ LPI</li></ul><h2 id="ä¸­æ–­æœ‰ä»¥ä¸‹-4-ç§çŠ¶æ€">ä¸­æ–­æœ‰ä»¥ä¸‹ 4 ç§çŠ¶æ€</h2><ul><li>Inactiveï¼šä¸­æ–­æºæ²¡æœ‰å‘é€ä¸­æ–­</li><li>Pendingï¼šä¸­æ–­æºå·²ç»å‘é€ä¸­æ–­ï¼Œç­‰å¾…å¤„ç†å™¨å¤–ç†</li><li>Activeï¼šå¤„ç†å™¨å·²ç»ç¡®è®¤ä¸­æ–­ï¼Œæ­£åœ¨å¤„ç†</li><li>Active and pendingï¼šå¤„ç†å™¨æ­£åœ¨å¤„ç†ä¸­æ–­ï¼Œç›¸åŒçš„ä¸­æ–­æºåˆå‘é€äº†ä¸€ä¸ªä¸­æ–­</li></ul><h1 id="ä¸­æ–­åŸŸ">ä¸­æ–­åŸŸ</h1><p>ä¸€ä¸ªå¤§å‹ç³»ç»Ÿå¯èƒ½æœ‰å¤šä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Œè¿™äº›ä¸­æ–­æ§åˆ¶å™¨å¯ä»¥çº§è”ï¼Œä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨ä½œä¸ºä¸­æ–­æºè¿æ¥åˆ°å¦ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Œä½†åªæœ‰ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨ä½œä¸ºæ ¹æ§åˆ¶å™¨ç›´æ¥è¿æ¥åˆ°å¤„ç†å™¨ã€‚å¦‚ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/HW_IRQ.png"></p><p>ä¸ºäº†æŠŠæ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ¬åœ°çš„ç¡¬ä»¶ä¸­æ–­å·æ˜ å°„åˆ°å…¨å±€å”¯ä¸€çš„ Linux ä¸­æ–­å·ï¼ˆè™šæ‹Ÿä¸­æ–­å·ï¼‰ï¼Œå†…æ ¸å®šä¹‰äº†ä¸­æ–­åŸŸ irq_domainï¼Œæ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ‰è‡ªå·±çš„ä¸­æ–­åŸŸã€‚</p><h2 id="åˆ›å»ºä¸­æ–­åŸŸ">åˆ›å»ºä¸­æ–­åŸŸ</h2><p>ä¸­æ–­æ§åˆ¶å™¨çš„é©±åŠ¨ç¨‹åºä½¿ç”¨åˆ†é…å‡½æ•° irq_domain_add_*() åˆ›å»ºå’Œæ³¨å†Œä¸­æ–­åŸŸã€‚æ¯ç§æ˜ å°„æ–¹æ³•æä¾›ä¸åŒçš„åˆ†é…å‡½æ•°ï¼Œè°ƒç”¨è€…å¿…é¡»ç»™åˆ†é…å‡½æ•°æä¾› irq_domain_ops ç»“æ„ä½“ï¼Œåˆ†é…å‡½åœ¨æ‰§è¡ŒæˆåŠŸçš„æ—¶å€™è¿”å› irq_domain çš„æŒ‡é’ˆã€‚</p><h4 id="ä¸­æ–­åŸŸæ”¯æŒä»¥ä¸‹æ˜ å°„æ–¹æ³•">ä¸­æ–­åŸŸæ”¯æŒä»¥ä¸‹æ˜ å°„æ–¹æ³•</h4><ul><li>çº¿æ€§æ˜ å°„ï¼ˆlinear mapï¼‰</li></ul><p>çº¿æ€§æ˜ å°„ç»´æŠ¤ä¸€ä¸ªå›ºå®šå¤§å°çš„è¡¨ï¼Œç´¢å¼•æ˜¯ç¡¬ä»¶ä¸­æ–­å·ã€‚å¦‚æœç¡¬ä»¶ä¸­æ–­å·çš„æœ€å¤§æ•°é‡å›ºå®šçš„ï¼Œå¹¶ä¸”æ¯”è¾ƒå°ï¼ˆå°äº 256ï¼‰ï¼Œé‚£ä¹ˆçº¿æ€§æ˜ å°„æ˜¯å¥½çš„é€‰æ‹©ã€‚å¯¹äºçº¿æ€§æ˜ å°„ï¼Œåˆ†é…ä¸­æ–­çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> irq_domain *<span class="title function_">irq_domain_add_linear</span><span class="params">(<span class="keyword">struct</span> device_node *of_node,</span></span><br><span class="line"><span class="params"> <span class="type">unsigned</span> <span class="type">int</span> size,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="keyword">struct</span> irq_domain_ops *ops,</span></span><br><span class="line"><span class="params"> <span class="type">void</span> *host_data)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>æ ‘æ˜ å°„ï¼ˆtree mapï¼‰</li></ul><p>æ ‘æ˜ å°„ä½¿ç”¨åŸºæ•°æ ‘ï¼ˆradix treeï¼‰ä¿å­˜ç¡¬ä»¶ä¸­æ–­å·åˆ° Linux ä¸­æ–­å·çš„æ˜ å°„ã€‚å¦‚æœç¡¬ä»¶ä¸­æ–­å·å¯èƒ½éå¸¸å¤§ï¼Œé‚£ä¹ˆæ ‘æ˜ å°„æ˜¯å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºä¸éœ€è¦æ ¹æ®æœ€å¤§ç¡¬ä»¶ä¸­æ–­å·åˆ†é…ä¸€ä¸ªå¾ˆå¤§çš„è¡¨ã€‚å¯¹äºæ ‘æ˜ å°„ï¼Œåˆ†é…ä¸­æ–­åŸŸçš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> irq_domain *<span class="title function_">irq_domain_add_tree</span><span class="params">(<span class="keyword">struct</span> device_node *of_node,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="keyword">struct</span> irq_domain_ops *ops,</span></span><br><span class="line"><span class="params"> <span class="type">void</span> *host_data)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>ä¸æ˜ å°„ï¼ˆno mapï¼‰</li></ul><p>æœ‰äº›ä¸­æ–­æ§åˆ¶å™¨å¾ˆå¼ºï¼Œç¡¬ä»¶ä¸­æ–­å·æ˜¯å¯ä»¥é…ç½®çš„ï¼Œä¾‹å¦‚ PowerPC æ¶æ„ä½¿ç”¨çš„ MPICï¼ˆMuti-PossorIterrupt Controllerï¼‰ã€‚æˆ‘ä»¬ç›´æ¥æŠŠ Linux ä¸­æ–­å·å†™åˆ°ç¡¬ä»¶ï¼Œç¡¬ä»¶ä¸­æ–­å·å°±æ˜¯ Linux ä¸­æ–­å·ï¼Œä¸éœ€è¦æ˜ å°„ã€‚å¯¹äºä¸æ˜ å°„ï¼Œåˆ†é…ä¸­æ–­åŸŸçš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> irq_domain *<span class="title function_">irq_domain_add_nomap</span><span class="params">(<span class="keyword">struct</span> device_node *of_node,</span></span><br><span class="line"><span class="params"> <span class="type">unsigned</span> <span class="type">int</span> max_irq,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="keyword">struct</span> irq_domain_ops *ops,</span></span><br><span class="line"><span class="params"> <span class="type">void</span> *host_data)</span></span><br></pre></td></tr></tbody></table></figure><p>åˆ†é…å‡½æ•°æŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°__irq_domain_add()ã€‚å‡½æ•°__irq_domain_add() çš„æ‰§è¡Œè¿‡æ˜¯ã€åˆ†é…ä¸€ä¸ª irq_domain ç»“æ„ä½“ï¼Œåˆå§‹åŒ–æˆå‘˜ï¼Œç„¶åæŠŠä¸­æ–­åŸŸæ·»åŠ åˆ°å…¨å±€é“¾è¡¨ irq_domain_list ä¸­ã€‚</p><h2 id="åˆ›å»ºæ˜ å°„">åˆ›å»ºæ˜ å°„</h2><p>åˆ›å»ºä¸­æ–­åŸŸä»¥åï¼Œéœ€è¦å‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ° Linux ä¸­æ–­å·çš„æ˜ å°„ï¼Œå†…æ ¸æä¾›äº†å‡½æ•° irq_create_mappingï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">irq_create_mapping</span><span class="params">(<span class="keyword">struct</span> irq_domain *host,</span></span><br><span class="line"><span class="params">      <span class="type">irq_hw_number_t</span> hwirq)</span></span><br></pre></td></tr></tbody></table></figure><p>è¾“å…¥å‚æ•°æ˜¯ä¸­æ–­åŸŸå’Œç¡¬ä»¶ä¸­æ–­å·ï¼Œè¿”å› Linux ä¸­æ–­å·ï¼Œè¯¥å‡½æ•°é¦–å…ˆåˆ†é… Linux ä¸­æ–­å·ç„¶åæŠŠç¡¬ä»¶ä¸­æ–­å·åˆ° Linux ä¸­æ–­å·çš„æ˜ å°„æ·»åŠ åˆ°ä¸­æ–­åŸŸã€‚</p><h2 id="æŸ¥æ‰¾æ˜ å°„">æŸ¥æ‰¾æ˜ å°„</h2><p>ä¸­æ–­å¤„ç†ç¨‹åºéœ€è¦æ ¹æ®ç¡¬ä»¶ä¸­æ–­å·æŸ¥æ‰¾ Linux ä¸­æ–­å·ï¼Œå†…æ ¸æä¾›äº†å‡½æ•° irq_find_mapping å‡½æ•°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * irq_find_mapping() - Find a linux irq from a hw irq number.</span></span><br><span class="line"><span class="comment"> * @domain: domain owning this hardware interrupt</span></span><br><span class="line"><span class="comment"> * @hwirq: hardware irq number in that domain space</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">irq_find_mapping</span><span class="params">(<span class="keyword">struct</span> irq_domain *domain,</span></span><br><span class="line"><span class="params">    <span class="type">irq_hw_number_t</span> hwirq)</span></span><br></pre></td></tr></tbody></table></figure><p>è¾“å…¥å‚æ•°æ˜¯ä¸­æ–­åŸŸå’Œç¡¬ä»¶ä¸­æ–­å·ï¼Œè¿”å› Linux ä¸­æ–­å·ã€‚</p><h1 id="linux-ä¸­æ–­å¤„ç†">Linux ä¸­æ–­å¤„ç†</h1><p>å¯¹äºä¸­æ–­æ§åˆ¶å™¨çš„æ¯ä¸ªä¸­æ–­æºï¼Œå‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ° Linux ä¸­æ–­å·çš„æ˜ å°„æ—¶å†…æ ¸åˆ†é…ä¸€ä¸ª Linux ä¸­æ–­å·å’Œä¸€ä¸ªä¸­æ–­æè¿°ç¬¦ irq_descï¼Œä¸­æ–­æè¿°ç¬¦æœ‰ä¸¤ä¸ªå±‚æ¬¡çš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><ul><li>ç¬¬ä¸€å±‚å¤„ç†å‡½æ•°æ˜¯ä¸­æ–­æè¿°ç¬¦çš„æˆå‘˜ handle_irq()ã€‚</li><li>ç¬¬äºŒå±‚å¤„ç†å‡½æ•°æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºæ³¨å†Œçš„å¤„ç†å‡½æ•°ã€‚ä¸­æ–­æè¿°ç¬¦æœ‰ä¸€ä¸ªä¸­æ–­å¤„ç†é“¾è¡¨ï¼ˆirq_desc.actionï¼‰ï¼Œæ¯ä¸ªä¸­æ–­å¤„ç†æè¿°ç¬¦ï¼ˆirq_actionï¼‰ä¿å­˜è®¾å¤‡é©±åŠ¨ç¨‹åºæ³¨å†Œçš„å¤„ç†å‡½æ•°ã€‚å› ä¸ºå¤šä¸ªè®¾å¤‡å¯ä»¥å…±äº«åŒä¸€ä¸ªç¡¬ä»¶ä¸­æ–­å·ï¼Œæ‰€ä»¥ä¸­æ–­å¤„ç†é“¾è¡¨å¯èƒ½æŒ‚è½½å¤šä¸ªä¸­æ–­å¤„ç†æè¿°ç¬¦ã€‚</li></ul><p>æ€ä¹ˆå­˜å‚¨ Linux ä¸­æ–­å·åˆ°ä¸­æ–­æè¿°ç¬¦çš„æ˜ å°„å…³ç³»ï¼Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚</p><ul><li>å¦‚æœä¸­æ–­ç¼–å·æ˜¯ç¨€ç–çš„ï¼ˆå³ä¸è¿ç»­ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨åŸºæ•°æ ‘ï¼ˆradix treeï¼‰å­˜å‚¨ã€‚éœ€è¦å¼€å¯é…ç½®å® CONFIG_SPARSE_IRQã€‚</li><li>å¦‚æœä¸­æ–­ç¼–å·æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆä½¿ç”¨æ•°ç»„å­˜å‚¨ã€‚</li></ul><p>è®¾å¤‡é©±åŠ¨ç¨‹åºå¯ä»¥ä½¿ç”¨å‡½æ•° request_irq() æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * request_irq - Add a handler for an interrupt line</span></span><br><span class="line"><span class="comment"> * @irq:The interrupt line to allocate</span></span><br><span class="line"><span class="comment"> * @handler:Function to be called when the IRQ occurs.</span></span><br><span class="line"><span class="comment"> *Primary handler for threaded interrupts</span></span><br><span class="line"><span class="comment"> *If NULL, the default primary handler is installed</span></span><br><span class="line"><span class="comment"> * @flags:Handling flags</span></span><br><span class="line"><span class="comment"> * @name:Name of the device generating this interrupt</span></span><br><span class="line"><span class="comment"> * @dev:A cookie passed to the handler function</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This call allocates an interrupt and establishes a handler; see</span></span><br><span class="line"><span class="comment"> * the documentation for request_threaded_irq() for details.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __must_check</span><br><span class="line"><span class="title function_">request_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *dev)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>å‚æ•° irq æ˜¯ Linux ä¸­æ–­å·ã€‚</li><li>å‚æ•° handler æ˜¯å¤„ç†å‡½æ•°ã€‚</li><li><p>å‚æ•° flags æ˜¯æ ‡å¿—ä½ï¼Œå¯ä»¥æ˜¯ 0 æˆ–è€…ä»¥ä¸‹æ ‡å¿—ä½çš„ç»„åˆã€‚</p><p>IRQF_SHAREDï¼šå…è®¸å¤šä¸ªè®¾å¤‡å…±äº«åŒä¸€ä¸ªä¸­æ–­å· IRQF_TIMERï¼šå®šæ—¶å™¨ä¸­æ–­ IRQF_PERCPUï¼šä¸­æ–­æ˜¯æ¯ä¸ªå¤„ç†å™¨ç§æœ‰çš„ IRQF_NOBALANCINGï¼šä¸å…è®¸è¯¥ä¸­æ–­åœ¨å¤„ç†å™¨ä¹‹é—´è´Ÿè½½å‡è¡¡ã€‚ IRQF_NO_THREADï¼šä¸­æ–­ä¸èƒ½çº¿ç¨‹åŒ–</p></li><li>å‚æ•° name æ˜¯è®¾å¤‡åç§°ã€‚</li><li><p>å‚æ•° dev æ˜¯ä¼ ç»™å¤„ç†å‡½æ•°ï¼ˆç”±å‚æ•° handler æŒ‡å®šï¼‰çš„å‚æ•°ã€‚</p></li></ul><p>åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº† ARM64 æ¶æ„ä¸‹çš„å¼‚å¸¸å¤„ç†æµç¨‹ï¼Œå½“å¼‚å¸¸å‘ç”Ÿæ—¶ä¼šè·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨ä¸­æ‰§è¡Œå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œä¸­æ–­æ˜¯å¼‚å¸¸çš„ä¸€ç§ï¼Œå› æ­¤å½“ä¸­æ–­å‘ç”Ÿæ—¶ä¹Ÿä¼šè·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨ä¸­æ‰§è¡Œä¸­æ–­å¤„ç†å‡½æ•°ï¼ŒARM64 å¯¹åº”æœ‰ä¸åŒçš„å¼‚å¸¸çº§åˆ«ï¼Œå…¶ä¸­å†…æ ¸è¿è¡Œåœ¨ EL1 çº§åˆ«ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šä¸€èŠ‚çš„åˆ†æä¸­æ–­ä¼šè·³è½¬åˆ° el1h_64_irq æ ‡å·å¤„è¿è¡Œç¨‹åºï¼Œè¯¥æ ‡å·å¤„çš„å¤„ç†åœ¨ä¸åŒçš„å¼‚å¸¸ä¸‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œä¸åŒçš„æ˜¯è·³è½¬çš„å¤„ç†å‡½æ•°ä¸åŒï¼Œå¯¹äº el1h_64_irq æ ‡å·ä¼šè·³è½¬åˆ° el1h_64_irq_handle å‡½æ•°å¤„å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹è¯¥å‡½æ•°çš„å…·ä½“å¤„ç†å·¥ä½œæ˜¯æ€æ ·çš„å§ï¼š</p><p>åŒæ ·ç”±äºå‡½æ•°è°ƒç”¨å±‚æ¬¡è¾ƒå¤šï¼Œè¿™é‡Œé‡‡ç”¨æµç¨‹å›¾çš„æ–¹å¼å±•ç°ï¼Œå½“ç„¶è¿™å¿…ç„¶ä¼šå¿½ç•¥æ‰å¾ˆå¤šç»†èŠ‚ï¼Œè¯¦ç»†çš„è¯»è€…å¯ä»¥è‡ªå·±è¿½è¸ªæºç æŸ¥çœ‹ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQ_RUN.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9kaWFncmFtaW5nLzYxNDc1NjExZTQwMWZkNzg2MWE3MWFkYw==">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¤§æ¦‚å°±äº†è§£äº†ä¸­æ–­å¤„ç†çš„æ•´ä½“æµç¨‹ã€‚å½“ä¸­æ–­å‘ç”Ÿæ—¶è·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨ï¼Œç„¶åè·³è½¬åˆ°å¯¹åº”çš„æ ‡å·å¤„æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œä¸­æ–­æ§åˆ¶å™¨çš„å¤„ç†å‡½æ•°ï¼Œå†è°ƒç”¨å¤–éƒ¨ä¸­æ–­æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><h1 id="ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–">ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–</h1><p>ä»¥ä¸€å¼ å›¾æ¥æ•´ç†è¿™äº›å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/irq_init1.png"> <span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxNDkzNzU0MWUwODUzMTVkYzRkZTZjOC5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WordPressæ­å»ºåšå®¢</title>
      <link href="/2021/Tools/WordpressUsage/"/>
      <url>/2021/Tools/WordpressUsage/</url>
      
        <content type="html"><![CDATA[<h1 id="å‡†å¤‡-lamp-ç¯å¢ƒ">å‡†å¤‡ LAMP ç¯å¢ƒ</h1><h2 id="å®‰è£…wordpress">å®‰è£…wordpress</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://cn.wordpress.org/latest-zh_CN.zip</span><br><span class="line">unzip latest-zh_CN.zip</span><br></pre></td></tr></tbody></table></figure><h2 id="å®‰è£…mysql">å®‰è£…Mysql</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mysql-server -y</span><br><span class="line">sudo systemctl start mysql</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mysql</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="ä¿®æ”¹å¯†ç æƒé™">ä¿®æ”¹å¯†ç æƒé™</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/mysql/debian.cnf</span><br><span class="line">[client]</span><br><span class="line">host     = localhost</span><br><span class="line">user     = debian-sys-maint</span><br><span class="line">password = ROmgNW5hP8tsSwrB</span><br><span class="line">socket   = /var/run/mysqld/mysqld.sock</span><br><span class="line">[mysql_upgrade]</span><br><span class="line">host     = localhost</span><br><span class="line">user     = debian-sys-maint</span><br><span class="line">password = ROmgNW5hP8tsSwrB</span><br><span class="line">socket   = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†ç </span></span><br><span class="line">mysql -udebian-sys-maint -p</span><br><span class="line"></span><br><span class="line">use mysql;</span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'xxxx'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºwordpressåˆ›å»ºæ•°æ®åº“</span></span><br><span class="line">use mysql;</span><br><span class="line"><span class="keyword">select</span> user,host from user;</span><br><span class="line">CREATE DATABASE wordpress;</span><br><span class="line">CREATE USER wordpressuser;</span><br><span class="line">SET PASSWORD FOR wordpressuser=PASSWORD(<span class="string">"password123"</span>);</span><br><span class="line">ALTER USER <span class="string">'wordpressuser'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'136140@Techliu'</span>;</span><br><span class="line"></span><br><span class="line">grant all on wordpress.* to <span class="string">'wordpressuser'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæ•ˆ</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="built_in">exit</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="å®‰è£…apache2">å®‰è£…apache2</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install apache2</span><br><span class="line">sudo systemctl status apache2</span><br><span class="line">sudo ufw allow <span class="string">'Apache Full'</span></span><br></pre></td></tr></tbody></table></figure><h2 id="å®‰è£…php">å®‰è£…php</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install php -y</span><br><span class="line">sudo apt install libapache2-mod-php -y</span><br><span class="line">sudo apt install php-mysql -y</span><br><span class="line">sudo apt install php-curl -y</span><br><span class="line">sudo apt install php-gd -y</span><br><span class="line">sudo apt install php-xml -y</span><br><span class="line">sudo apt install php-mbstring -y</span><br><span class="line">sudo apt install php-xmlrpc -y</span><br><span class="line">sudo apt install php-zip -y</span><br><span class="line">sudo apt install php-soap -y</span><br><span class="line">sudo apt install php-intl -y</span><br></pre></td></tr></tbody></table></figure><h1 id="é…ç½®wordpress">é…ç½®wordpress</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /var/www/html</span><br><span class="line">sudo <span class="built_in">mv</span> wordpress/* /var/www/html/</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/</span><br><span class="line"></span><br><span class="line">sudo mysql_secure_installation</span><br><span class="line">sudo apt-get install phpmyadmin -y</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/share/phpmyadmin /var/www/html/phpmyadmin</span><br><span class="line">sudo service mysql restart</span><br><span class="line">sudo systemctl restart apache2.service</span><br></pre></td></tr></tbody></table></figure><h1 id="è§£å†³å®‰è£…æ’ä»¶éœ€è¦ftpé—®é¢˜">è§£å†³å®‰è£…æ’ä»¶éœ€è¦FTPé—®é¢˜</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /var/www/html/wp-config.php</span><br><span class="line"><span class="comment"># æ·»åŠ ä»¥ä¸‹å†…å®¹</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">"FS_METHOD"</span>, <span class="string">"direct"</span>);  </span><br><span class="line">define(<span class="string">"FS_CHMOD_DIR"</span>, 0777);  </span><br><span class="line">define(<span class="string">"FS_CHMOD_FILE"</span>, 0777); </span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æƒé™</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 777 -R /var/www/html/wp-content/</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Share </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆäºŒï¼‰ARM64 çš„å¼‚å¸¸å¤„ç†è¿‡ç¨‹</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptARMExcept/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptARMExcept/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/IRQExceptProcess.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1Nzk2NjA3OTEyOTA2ZjUwN2QxMDg=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><h1 id="å¼‚å¸¸çº§åˆ«">å¼‚å¸¸çº§åˆ«</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/ARM64_ELEVEL.png"></p><p>é€šå¸¸ ARM64 çš„è¿›ç¨‹æ‰§è¡Œåœ¨ EL0 çº§åˆ«ï¼Œå†…æ ¸æ‰§è¡Œåœ¨ EL1 çº§åˆ«ã€‚</p><p>è™šæ‹Ÿæœºæ˜¯ç°åœ¨æµè¡Œçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œåœ¨è®¡ç®—æœºä¸Šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºé‡Œå¯ä»¥è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿã€‚å¸¸ç”¨çš„å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯ QEMUï¼ŒQEMU æ”¯æŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº KVMï¼ŒKVM çš„ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æœºçš„æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚</p><p>ARM64 æ¶æ„çš„å®‰å…¨æ‰©å±•å®šä¹‰äº†ä¸¤ç§å®‰å…¨çŠ¶æ€ï¼Œæ­£å¸¸ä¸–ç•Œå’Œå®‰å…¨ä¸–ç•Œï¼Œä¸¤ä¸ªä¸–ç•Œåªèƒ½é€šè¿‡å¼‚å¸¸çº§åˆ« 3 çš„å®‰å…¨ç›‘è§†å™¨åˆ‡æ¢ã€‚</p><span id="more"></span><h1 id="å¼‚å¸¸ç±»å‹">å¼‚å¸¸ç±»å‹</h1><h2 id="ä¸­æ–­">ä¸­æ–­</h2><p>åœ¨ ARM å¤„ç†å™¨ä¸­ï¼ŒFIQï¼ˆFast Interruptre Questï¼‰çš„ä¼˜å…ˆçº§è¦é«˜äº IRQï¼ˆInterrupt ReQuestï¼‰ã€‚åœ¨èŠ¯ç‰‡å†…éƒ¨ï¼Œåˆ†åˆ«ç”± IRQ å’Œ FIQ ä¸¤æ ¹ä¸­æ–­çº¿è¿æ¥åˆ°ä¸­æ–­æ§åˆ¶å™¨å†è¿æ¥åˆ°å¤„ç†å™¨å†…éƒ¨ï¼Œå‘é€ä¸­æ–­ä¿¡å·ç»™å¤„ç†å™¨ã€‚</p><h3 id="ä¸­æ­¢">ä¸­æ­¢</h3><p>ä¸­æ­¢ï¼ˆabortï¼‰ä¸»è¦æœ‰æŒ‡ä»¤ä¸­æ­¢ï¼ˆinstruction abortï¼‰å’Œæ•°æ®ä¸­æ­¢ï¼ˆdata abortï¼‰ä¸¤ç§ï¼Œé€šå¸¸æ˜¯å› ä¸ºè®¿é—®å¤–éƒ¨å­˜å‚¨å•å…ƒæ—¶å‘ç”Ÿäº†é”™è¯¯ï¼Œå¤„ç†å™¨å†…éƒ¨çš„ MMUï¼ˆMemory Management Unitï¼‰èƒ½æ•è·è¿™äº›é”™è¯¯å¹¶ä¸”æŠ¥å‘Šç»™å¤„ç†å™¨ã€‚æŒ‡ä»¤ä¸­æ­¢æ˜¯æŒ‡å½“å¤„ç†å™¨å°è¯•æ‰§è¡ŒæŸæ¡æŒ‡ä»¤æ—¶å‘ç”Ÿäº†é”™è¯¯ï¼Œè€Œæ•°æ®ä¸­æ­¢æ˜¯æŒ‡ä½¿ç”¨åŠ è½½æˆ–å­˜å‚¨æŒ‡ä»¤è¯»å†™å¤–éƒ¨å­˜å‚¨å•å…ƒæ—¶å‘ç”Ÿäº†é”™è¯¯ã€‚</p><h2 id="å¤ä½">å¤ä½</h2><p>å¤ä½ï¼ˆresetï¼‰æ“ä½œæ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ä¸€ç§å¼‚å¸¸å¤„ç†ï¼Œå¤ä½æ“ä½œåŒ…æ‹¬ä¸Šç”µå¤ä½å’Œæ‰‹åŠ¨å¤ä½ä¸¤ç§ã€‚</p><h2 id="è½¯ä»¶äº§ç”Ÿçš„å¼‚å¸¸">è½¯ä»¶äº§ç”Ÿçš„å¼‚å¸¸</h2><p>ARMv8 åŠ æ„æä¾›äº† 3 ç§è½¯ä»¶äº§ç”Ÿçš„å¼‚å¸¸ã€‚å‘ç”Ÿè¿™äº›å¼‚å¸¸é€šå¸¸æ˜¯å› ä¸ºè½¯ä»¶æƒ³å°è¯•è¿›å…¥é«˜çš„å¼‚å¸¸ç­‰çº§ã€‚</p><ul><li>SVC æŒ‡ä»¤ï¼šå…è®¸ç”¨æˆ·æ¨¡å¼ä¸‹çš„ç¨‹åºè¯·æ±‚æ“ä½œç³»ç»ŸæœåŠ¡</li><li>HVC æŒ‡ä»¤ï¼šå…è®¸å®¢æˆ·æœºï¼ˆguestOSï¼‰è¯·æ±‚ä¸»æœºæœåŠ¡</li><li>SMC æŒ‡ä»¤ï¼šå…è®¸æ™®é€šä¸–ç•Œï¼ˆnormal worldï¼‰ä¸­çš„ç¨‹åºè¯·æ±‚å®‰å…¨ç›‘æ§æœåŠ¡</li></ul><h1 id="åŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸">åŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸</h1><p>ARMv8 æ¶æ„æŠŠå¼‚å¸¸åˆ†æˆåŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸ä¸¤ç§ã€‚åŒæ­¥å¼‚å¸¸æ˜¯æŒ‡å¤„ç†å™¨éœ€è¦ç­‰å¾…å¼‚å¸¸å¤„ç†çš„ç»“æœï¼Œç„¶åå†ç»§ç»­æ‰§è¡Œåé¢çš„æŒ‡ä»¤ï¼Œæ¯”å¦‚æ•°æ®ä¸­æ­¢å‘ç”Ÿæ—¶æˆ‘ä»¬çŸ¥é“å‘ç”Ÿæ•°æ®å¼‚å¸¸çš„åœ°å€ï¼Œå› è€Œå¯ä»¥åœ¨å¼‚å¸¸å¤„ç†å‡½æ•°ä¸­ä¿®å¤è¿™ä¸ªåœ°å€ã€‚å¸¸è§çš„åŒæ­¥å¼‚å¸¸å¦‚ä¸‹ã€‚</p><ul><li>å°è¯•è®¿é—®å¼‚å¸¸ç­‰çº§ä¸æ°å½“çš„å¯„å­˜å™¨</li><li>å°è¯•æ‰§è¡Œæ²¡æœ‰å®šä¹‰ï¼ˆUNDEFINEDï¼‰çš„æŒ‡ä»¤</li><li>ä½¿ç”¨æ²¡æœ‰å¯¹é½çš„ SP æˆ–æ‰§è¡Œæ²¡æœ‰å¯¹é½çš„ PC æŒ‡ä»¤</li><li>è½¯ä»¶äº§ç”Ÿçš„å¼‚å¸¸ï¼Œæ¯”å¦‚æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆSVCï¼‰ã€HVC æˆ– SMC æŒ‡ä»¤</li><li>å› åœ°å€ç¿»è¯‘æˆ–æƒé™ç­‰å¯¼è‡´çš„æ•°æ®å¼‚å¸¸æˆ–æŒ‡ä»¤å¼‚å¸¸</li><li>è°ƒè¯•å¯¼è‡´çš„å¼‚å¸¸ï¼Œæ¯”å¦‚æ–­ç‚¹å¼‚å¸¸ã€è§‚å¯Ÿç‚¹å¼‚å¸¸ã€è½¯ä»¶å•æ­¥å¼‚å¸¸ç­‰</li></ul><p>ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œå¤„ç†å™¨æ­£åœ¨å¤„ç†çš„æŒ‡ä»¤å’Œä¸­æ–­æ˜¯å®Œå…¨æ²¡æœ‰å…³ç³»çš„ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»å› æ­¤ï¼ŒæŒ‡ä»¤å¼‚å¸¸å’Œæ•°æ®å¼‚å¸¸ç§°ä¸ºåŒæ­¥å¼‚å¸¸ï¼Œè€Œä¸­æ–­ç§°ä¸ºå¼‚æ­¥å¼‚å¸¸ã€‚å¸¸è§çš„å¼‚æ­¥å¼‚å¸¸åŒ…æ‹¬ç‰©ç†ä¸­æ–­å’Œè™šæ‹Ÿä¸­æ–­ã€‚</p><ul><li>ç‰©ç†ä¸­æ–­åˆ†ä¸ºç³»ç»Ÿé”™è¯¯ã€IRQã€FIQã€‚</li><li>è™šæ‹Ÿä¸­æ–­åˆ†ä¸º vSErrorã€ vIRQã€vFIQã€‚</li></ul><h1 id="å¼‚å¸¸çš„å‘ç”Ÿå’Œé€€å‡º">å¼‚å¸¸çš„å‘ç”Ÿå’Œé€€å‡º</h1><p>å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒCPU ä¼šè‡ªåŠ¨åšå¦‚ä¸‹ä¸€äº›äº‹æƒ…ã€‚</p><ul><li>å°†å¤„ç†å™¨çŠ¶æ€å¯„å­˜å™¨ PSTATE ä¿å­˜åˆ°å¯¹åº”ç›®æ ‡å¼‚å¸¸ç­‰çº§çš„ SPSR_ELx ä¸­</li><li>å°†è¿”å›åœ°å€ä¿å­˜åœ¨å¯¹åº”ç›®æ ‡å¼‚å¸¸ç­‰çº§çš„ ELRELx ä¸­</li><li>æŠŠ PSTATE å¯„å­˜å™¨é‡Œçš„ DAIF åŸŸéƒ½è®¾ç½®ä¸º 1ï¼Œè¿™ç›¸å½“äºæŠŠè°ƒè¯•å¼‚å¸¸ã€ç³»ç»Ÿé”™è¯¯ ï¼ˆSErrorï¼‰ã€IRQ ä»¥åŠ FIQ éƒ½å…³é—­äº†ã€‚å…·ä½“å¼‚å¸¸åŸå› éœ€è¦æŸ¥çœ‹ ESR_ELx</li><li>è®¾ç½®æ ˆæŒ‡é’ˆï¼ŒæŒ‡å‘å¯¹åº”ç›®æ ‡å¼‚å¸¸ç­‰çº§ä¸‹çš„æ ˆï¼Œè‡ªåŠ¨åˆ‡æ¢ SP åˆ° SP_ELx</li><li>CPU å¤„ç†å™¨ä¼šä»å¼‚å¸¸å‘ç”Ÿç°åœºçš„å¼‚å¸¸ç­‰çº§åˆ‡æ¢åˆ°å¯¹åº”ç›®æ ‡å¼‚å¸¸ç­‰çº§ï¼Œç„¶åè·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨å¹¶æ‰§è¡Œ</li></ul><p>ä¸Šè¿°æ˜¯ ARMv8 å¤„ç†å™¨æ£€æµ‹åˆ°å¼‚å¸¸å‘ç”Ÿåè‡ªåŠ¨åšçš„äº‹æƒ…ã€‚æ“ä½œç³»ç»Ÿéœ€è¦åšçš„äº‹æƒ…æ˜¯ä»ä¸­æ–­å‘é‡è¡¨å¼€å§‹ï¼Œæ ¹æ®å¼‚å¸¸å‘ç”Ÿçš„ç±»å‹ï¼Œè·³è½¬åˆ°åˆé€‚çš„å¼‚å¸¸å‘é‡è¡¨ã€‚å¼‚å¸¸å‘é‡è¡¨ä¸­çš„æ¯é¡¹ä¼šä¿å­˜ä¸€ä¸ªå¼‚å¸¸å¤„ç†çš„è·³è½¬å‡½æ•°ï¼Œç„¶åè·³è½¬åˆ°æ°å½“çš„å¼‚å¸¸å¤„ç†å‡½æ•°å¹¶å¤„ç†å¼‚å¸¸ã€‚</p><p>å½“æ“ä½œç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†å®Œæˆåï¼Œæ‰§è¡Œä¸€æ¡ eret æŒ‡ä»¤å³å¯ä»å¼‚å¸¸è¿”å›ã€‚è¿™æ¡æŒ‡ä»¤ä¼šè‡ªåŠ¨å®Œæˆå¦‚ä¸‹å·¥ä½œ</p><ul><li>ä» ELR_ELx ä¸­æ¢å¤ PC æŒ‡é’ˆ</li><li>ä» SPSR_ELx æ¢å¤å¤„ç†å™¨çš„çŠ¶æ€</li></ul><h1 id="å¼‚å¸¸å‘é‡è¡¨">å¼‚å¸¸å‘é‡è¡¨</h1><p>ARMv7 æ¶æ„çš„å¼‚å¸¸å‘é‡è¡¨æ¯”è¾ƒç®€å•ï¼Œæ¯ä¸ªè¡¨é¡¹å ç”¨ 4 å­—èŠ‚ï¼Œå¹¶ä¸”æ¯ä¸ªè¡¨é¡¹é‡Œå­˜æ”¾äº†ä¸€æ¡è·³è½¬æŒ‡ä»¤ã€‚ä½†æ˜¯ ARMv8 æ¶æ„çš„å¼‚å¸¸å‘é‡è¡¨å‘ç”Ÿäº†å˜åŒ–ã€‚æ¯ä¸€ä¸ªè¡¨é¡¹éœ€è¦ 128 å­—èŠ‚ï¼Œè¿™æ ·å¯ä»¥å­˜æ”¾ 32 æ¡æŒ‡ä»¤ã€‚æ³¨æ„ï¼ŒARMv8 æŒ‡ä»¤é›†æ”¯æŒ 64 ä½æŒ‡ä»¤é›†ï¼Œä½†æ˜¯æ¯ä¸€æ¡æŒ‡ä»¤çš„ä½å®½æ˜¯ 32 ä½å®½è€Œä¸æ˜¯ 64 ä½å®½ã€‚</p><p>åœ¨ä¸‹è¡¨ä¸­ï¼Œå¼‚å¸¸å‘é‡è¡¨å­˜æ”¾çš„åŸºåœ°å€å¯ä»¥é€šè¿‡ VBAR ï¼ˆVector Base Address Registerï¼‰æ¥è®¾ç½®ã€‚VBAR æ˜¯å¼‚å¸¸å‘é‡è¡¨çš„åŸºåœ°å€å¯„å­˜å™¨ã€‚è§ã€ŠARM Architecture Reference Manualï¼ŒARMv8ï¼Œfor ARMv8-A architecture profile v8.4ã€‹çš„ D.1.10 èŠ‚ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/armv8_vector.png"></p><hr><h1 id="å¼‚å¸¸å‘é‡è¡¨åœ¨-linux-ä¸­çš„å®ç°æ‰©å±•">å¼‚å¸¸å‘é‡è¡¨åœ¨ Linux ä¸­çš„å®ç°ï¼ˆæ‰©å±•ï¼‰</h1><h2 id="æ±‡ç¼–å®å®šä¹‰">æ±‡ç¼–å®å®šä¹‰</h2><p>è¦ç†è§£ä¸‹é¢è¿™æ®µä»£ç éœ€è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹ä¸€äº›æ±‡ç¼–è¯­æ³•ï¼Œä¸‹é¢åšç®€å•ä»‹ç»ï¼š é¦–å…ˆæ˜¯ã€‚macro å‘½ä»¤ .macro å’Œ .endm ä¹‹é—´å…è®¸æ‚¨å®šä¹‰ç”Ÿæˆæ±‡ç¼–è¾“å‡ºçš„å®ã€‚ä¾‹å¦‚ï¼Œå¦‚ä¸‹è¿™æ®µå®å®šä¹‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.macro  sum from=0, to=5</span><br><span class="line">.long   \from</span><br><span class="line">.if     \to-\from</span><br><span class="line">sum     "(\from+1)",\to</span><br><span class="line">.endif</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><p>æ ¹æ®è¯¥å®šä¹‰ï¼Œâ€œSUM 0,5â€ç­‰æ•ˆäºä»¥ä¸‹ç¨‹åºé›†è¾“å…¥ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.long   0</span><br><span class="line">.long   1</span><br><span class="line">.long   2</span><br><span class="line">.long   3</span><br><span class="line">.long   4</span><br><span class="line">.long   5</span><br></pre></td></tr></tbody></table></figure><p>.macro comm å¼€å§‹å®šä¹‰ä¸€ä¸ªåä¸º comm çš„å®ï¼Œå®ƒä¸å¸¦å‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.macro plus1 p, p1</span><br><span class="line">.macro plus1 p p1</span><br></pre></td></tr></tbody></table></figure><p>ä»»ä¸€è¯­å¥éƒ½å¼€å§‹å®šä¹‰ä¸€ä¸ªåä¸º plus1 çš„å®ï¼Œå®ƒå¸¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼›åœ¨å®å®šä¹‰ä¸­ï¼Œå†™â€œâ€æˆ–â€œ1â€æ¥è®¡ç®—å‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.macro reserve_str p1=0 p2</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸¤ä¸ªå‚æ•°å¼€å§‹ä¸€ä¸ªåä¸º reserve_str çš„å®çš„å®šä¹‰ã€‚ ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œä½†ç¬¬äºŒä¸ªæ²¡æœ‰ã€‚ å®šä¹‰å®Œæˆåï¼Œæ‚¨å¯ä»¥å°†å®è°ƒç”¨ä¸º 'reserve_str a,b'ï¼ˆ'1' è®¡ç®—ä¸º aï¼Œ'2' è®¡ç®—ä¸º bï¼‰ï¼Œæˆ–ä¸º 'reserve_str ,b'ï¼ˆä½¿ç”¨ '1 ' è®¡ç®—ä¸ºé»˜è®¤å€¼ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º '0'ï¼Œ'2' è®¡ç®—ä¸º b)ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.macro m p1:req, p2=0, p3:vararg</span><br></pre></td></tr></tbody></table></figure><p>ä»¥è‡³å°‘ä¸‰ä¸ªå‚æ•°å¼€å§‹ä¸€ä¸ªåä¸º m çš„å®çš„å®šä¹‰ã€‚ ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»å§‹ç»ˆæŒ‡å®šä¸€ä¸ªå€¼ï¼Œä½†ç¬¬äºŒä¸ªå‚æ•°ä¸æ˜¯ï¼Œè€Œæ˜¯å…·æœ‰é»˜è®¤å€¼ã€‚ ç¬¬ä¸‰ä¸ªå½¢å¼å°†è¢«åˆ†é…åœ¨è°ƒç”¨æ—¶æŒ‡å®šçš„æ‰€æœ‰å‰©ä½™å‚æ•°ã€‚</p><p>è°ƒç”¨å®æ—¶ï¼Œå¯ä»¥æŒ‰ä½ç½®æˆ–å…³é”®å­—æŒ‡å®šå‚æ•°å€¼ã€‚ ä¾‹å¦‚ï¼Œâ€œsum 9,17â€ç­‰ä»·äºâ€œsum to=17, from=9â€ã€‚</p><p>è¯·æ³¨æ„ï¼Œç”±äºæ¯ä¸ª macargs éƒ½å¯ä»¥æ˜¯ä¸ç›®æ ‡æ¶æ„å…è®¸çš„ä»»ä½•å…¶ä»–æ ‡è¯†ç¬¦å®Œå…¨ç›¸åŒçš„æ ‡è¯†ç¬¦ï¼Œå› æ­¤å¦‚æœç›®æ ‡åœ¨æŸäº›å­—ç¬¦å‡ºç°åœ¨ç‰¹æ®Šä½ç½®æ—¶å¯¹å…¶åˆ¶ä½œäº†ç‰¹æ®Šå«ä¹‰ï¼Œåˆ™å¯èƒ½ä¼šå¶å°”å‡ºç°é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœå†’å· (:) é€šå¸¸è¢«å…è®¸ä½œä¸ºç¬¦å·åç§°çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ¶æ„ç‰¹å®šä»£ç åœ¨ä½œä¸ºç¬¦å·çš„æœ€åä¸€ä¸ªå­—ç¬¦ï¼ˆä»¥è¡¨ç¤ºæ ‡ç­¾ï¼‰å‡ºç°æ—¶å°†å…¶ç‰¹æ®ŠåŒ–ï¼Œåˆ™å®å‚æ•°æ›¿æ¢ ä»£ç å°†æ— æ³•çŸ¥é“è¿™ä¸€ç‚¹å¹¶å°†æ•´ä¸ªæ„é€ ï¼ˆåŒ…æ‹¬å†’å·ï¼‰è§†ä¸ºæ ‡è¯†ç¬¦ï¼Œå¹¶ä»…æ£€æŸ¥æ­¤æ ‡è¯†ç¬¦æ˜¯å¦å—å‚æ•°æ›¿æ¢ã€‚ ä¾‹å¦‚è¿™ä¸ªå®å®šä¹‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.macro label l</span><br><span class="line">\l:</span><br><span class="line">.endm</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å¯èƒ½æ— æ³•æŒ‰é¢„æœŸå·¥ä½œã€‚ è°ƒç”¨â€œlabel fooâ€å¯èƒ½ä¸ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºâ€œfooâ€çš„æ ‡ç­¾ï¼Œè€Œåªæ˜¯å°†æ–‡æœ¬â€œ:â€æ’å…¥åˆ°æ±‡ç¼–æºä»£ç ä¸­ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå…³äºæ— æ³•è¯†åˆ«çš„æ ‡è¯†ç¬¦çš„é”™è¯¯ã€‚</p><p>ç±»ä¼¼çš„é—®é¢˜å¯èƒ½ä¼šå‡ºç°åœ¨æ“ä½œç åç§°ï¼ˆä»¥åŠæ ‡è¯†ç¬¦åç§°ï¼‰ä¸­é€šå¸¸å…è®¸ä½¿ç”¨çš„å¥ç‚¹å­—ç¬¦ (â€˜.â€™) ä¸­ã€‚ å› æ­¤ï¼Œä¾‹å¦‚æ„é€ ä¸€ä¸ªå®ä»¥æ ¹æ®åŸºæœ¬åç§°å’Œé•¿åº¦è¯´æ˜ç¬¦æ„å»ºæ“ä½œç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.macro opcode base length</span><br><span class="line">       \base.\length</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><p>å¹¶å°†å…¶ä½œä¸ºâ€œopcode store lâ€è°ƒç”¨ä¸ä¼šåˆ›å»ºâ€œstore.lâ€æŒ‡ä»¤ï¼Œè€Œæ˜¯åœ¨æ±‡ç¼–å™¨å°è¯•è§£é‡Šæ–‡æœ¬â€œ.â€æ—¶äº§ç”ŸæŸç§é”™è¯¯ã€‚ æœ‰å‡ ç§å¯èƒ½çš„æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><ul><li>Insert white space</li></ul><p>å¦‚æœå¯ä»¥ä½¿ç”¨ç©ºæ ¼å­—ç¬¦ï¼Œé‚£ä¹ˆè¿™æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.macro label l</span><br><span class="line">\l :</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><ul><li>Use â€˜()â€™</li></ul><p>å­—ç¬¦ä¸²â€œ()â€å¯ç”¨äºå°†å®å‚æ•°çš„ç»“å°¾ä¸ä»¥ä¸‹æ–‡æœ¬åˆ†å¼€ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.macro opcode base length</span><br><span class="line">        \base\().\length</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><ul><li>Use the alternate macro syntax mode</li></ul><p>åœ¨æ›¿ä»£å®è¯­æ³•æ¨¡å¼ä¸­ï¼Œä¸å·å­—ç¬¦ (â€˜&amp;â€™) å¯ç”¨ä½œåˆ†éš”ç¬¦ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.altmacro</span><br><span class="line">.macro label l</span><br><span class="line">l&amp;:</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><p>æ­£ç¡®è¯†åˆ«ä¼ªæ“ä½œçš„å­—ç¬¦ä¸²å‚æ•°çš„è¿™ä¸ªé—®é¢˜ä¹Ÿé€‚ç”¨äº .irp å’Œ .irpc ä¸­ä½¿ç”¨çš„æ ‡è¯†ç¬¦ã€‚</p><p>.endm æ ‡è®°å®å®šä¹‰çš„ç»“å°¾ã€‚</p><h2 id="æºç ">æºç </h2><p>ä¸‹é¢çœ‹ä¸‹ Linux ä¸­ arm64 çš„å¼‚å¸¸å‘é‡è¡¨ï¼Œåœ¨ arch/arm64/kernel/entry.S æ–‡ä»¶ä¸­æœ‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Exception vectors.</span><br><span class="line"> */</span><br><span class="line">.pushsection ".entry.text", "ax"</span><br><span class="line"></span><br><span class="line">.align11</span><br><span class="line">SYM_CODE_START(vectors)</span><br><span class="line">    # ä½¿ç”¨ SP0 å¯„å­˜å™¨çš„å½“å‰çš„å¼‚å¸¸ç±»å‹çš„å¼‚å¸¸å‘é‡è¡¨</span><br><span class="line">kernel_ventry1, t, 64, sync// Synchronous EL1t</span><br><span class="line">kernel_ventry1, t, 64, irq// IRQ EL1t</span><br><span class="line">kernel_ventry1, t, 64, fiq// FIQ EL1h</span><br><span class="line">kernel_ventry1, t, 64, error// Error EL1t</span><br><span class="line"></span><br><span class="line">    # ä½¿ç”¨ SPx å¯„å­˜å™¨çš„å½“å‰å¼‚å¸¸ç±»å‹çš„å¼‚å¸¸å‘é‡è¡¨</span><br><span class="line">kernel_ventry1, h, 64, sync// Synchronous EL1h</span><br><span class="line">kernel_ventry1, h, 64, irq// IRQ EL1h</span><br><span class="line">kernel_ventry1, h, 64, fiq// FIQ EL1h</span><br><span class="line">kernel_ventry1, h, 64, error// Error EL1h</span><br><span class="line"></span><br><span class="line">    # AArch64 ä¸‹ä½å¼‚å¸¸ç­‰çº§çš„å¼‚å¸¸å‘é‡è¡¨</span><br><span class="line">kernel_ventry0, t, 64, sync// Synchronous 64-bit EL0</span><br><span class="line">kernel_ventry0, t, 64, irq// IRQ 64-bit EL0</span><br><span class="line">kernel_ventry0, t, 64, fiq// FIQ 64-bit EL0</span><br><span class="line">kernel_ventry0, t, 64, error// Error 64-bit EL0</span><br><span class="line"></span><br><span class="line">    # AArch32 ä¸‹ä½å¼‚å¸¸ç­‰çº§çš„å¼‚å¸¸å‘é‡è¡¨</span><br><span class="line">kernel_ventry0, t, 32, sync// Synchronous 32-bit EL0</span><br><span class="line">kernel_ventry0, t, 32, irq// IRQ 32-bit EL0</span><br><span class="line">kernel_ventry0, t, 32, fiq// FIQ 32-bit EL0</span><br><span class="line">kernel_ventry0, t, 32, error// Error 32-bit EL0</span><br><span class="line">SYM_CODE_END(vectors)</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°å¼‚å¸¸å‘é‡è¡¨çš„å®šä¹‰å’Œå‰é¢é‚£å¼ å›¾æ˜¯ä¸€è‡´çš„ï¼Œå…¶ä¸­ kernel_ventry æ˜¯ä¸€ä¸ªå®ï¼Œä»–çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">.macro kernel_ventry, el:req, ht:req, regsize:req, label:req</span><br><span class="line">.align 7</span><br><span class="line">#ifdef CONFIG_UNMAP_KERNEL_AT_EL0</span><br><span class="line">.if\el == 0</span><br><span class="line">alternative_if ARM64_UNMAP_KERNEL_AT_EL0</span><br><span class="line">.if\regsize == 64</span><br><span class="line">mrsx30, tpidrro_el0</span><br><span class="line">msrtpidrro_el0, xzr</span><br><span class="line">.else</span><br><span class="line">movx30, xzr</span><br><span class="line">.endif</span><br><span class="line">alternative_else_nop_endif</span><br><span class="line">.endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">subsp, sp, #PT_REGS_SIZE</span><br><span class="line">#ifdef CONFIG_VMAP_STACK</span><br><span class="line">/*</span><br><span class="line"> * Test whether the SP has overflowed, without corrupting a GPR.</span><br><span class="line"> * Task and IRQ stacks are aligned so that SP &amp; (1 &lt;&lt; THREAD_SHIFT)</span><br><span class="line"> * should always be zero.</span><br><span class="line"> */</span><br><span class="line">addsp, sp, x0// sp' = sp + x0</span><br><span class="line">subx0, sp, x0// x0' = sp' - x0 = (sp + x0) - x0 = sp</span><br><span class="line">tbnzx0, #THREAD_SHIFT, 0f</span><br><span class="line">subx0, sp, x0// x0'' = sp' - x0' = (sp + x0) - sp = x0</span><br><span class="line">subsp, sp, x0// sp'' = sp' - x0 = (sp + x0) - x0 = sp</span><br><span class="line">bel\el\ht\()_\regsize\()_\label</span><br><span class="line"></span><br><span class="line">0:</span><br><span class="line">/*</span><br><span class="line"> * Either we've just detected an overflow, or we've taken an exception</span><br><span class="line"> * while on the overflow stack. Either way, we won't return to</span><br><span class="line"> * userspace, and can clobber EL0 registers to free up GPRs.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/* Stash the original SP (minus PT_REGS_SIZE) in tpidr_el0. */</span><br><span class="line">msrtpidr_el0, x0</span><br><span class="line"></span><br><span class="line">/* Recover the original x0 value and stash it in tpidrro_el0 */</span><br><span class="line">subx0, sp, x0</span><br><span class="line">msrtpidrro_el0, x0</span><br><span class="line"></span><br><span class="line">/* Switch to the overflow stack */</span><br><span class="line">adr_this_cpu sp, overflow_stack + OVERFLOW_STACK_SIZE, x0</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Check whether we were already on the overflow stack. This may happen</span><br><span class="line"> * after panic() re-enables interrupts.</span><br><span class="line"> */</span><br><span class="line">mrsx0, tpidr_el0// sp of interrupted context</span><br><span class="line">subx0, sp, x0// delta with top of overflow stack</span><br><span class="line">tstx0, #~(OVERFLOW_STACK_SIZE - 1)// within range?</span><br><span class="line">b.ne__bad_stack// no? -&gt; bad stack pointer</span><br><span class="line"></span><br><span class="line">/* We were already on the overflow stack. Restore sp/x0 and carry on. */</span><br><span class="line">subsp, sp, x0</span><br><span class="line">mrsx0, tpidrro_el0</span><br><span class="line">#endif</span><br><span class="line">bel\el\ht\()_\regsize\()_\label</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><p>.macro kernel_ventry, el:req, ht:req, regsize:req, label:req å®šä¹‰ kernel_ventry å®æœ‰ 4 ä¸ªå‚æ•°ï¼Œå…¶ä¸­ï¼šreq ä»£è¡¨è¿™ä¸ªå‚æ•°å¿…é¡»æä¾›ã€‚æ’‡å¼€å„ç§å®å®šä¹‰æˆ‘ä»¬çœ‹ä¸‹é‡Œé¢å…¶å®ä¸»è¦å°±æ˜¯å¦‚ä¸‹ä¸‰è¡Œä»£ç ï¼Œæˆ‘ä»¬ä¸€ä¸€åˆ†æï¼š</p><ul><li>.align 7</li></ul><p>è¡¨ç¤ºæŠŠä¸€æ¡æŒ‡ä»¤çš„åœ°å€å¯¹å…¶åˆ° 2 çš„ 7 æ¬¡æ–¹ï¼Œå³ 128 å­—èŠ‚ã€‚</p><ul><li>sub sp, sp, #PT_REGS_SIZE</li></ul><p>sp æŒ‡é’ˆå‡å» PT_REGS_SIZEï¼ŒPT_REGS_SIZE çš„å®šä¹‰åœ¨ arch/arm64/kernel/asm_offset.c æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFINE(PT_REGS_SIZE,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pt_regs));</span><br></pre></td></tr></tbody></table></figure><p>pt_regs å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_pt_regs</span> <span class="title">user_regs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">u64 regs[<span class="number">31</span>];</span><br><span class="line">u64 sp;</span><br><span class="line">u64 pc;</span><br><span class="line">u64 pstate;</span><br><span class="line">};</span><br><span class="line">};</span><br><span class="line">u64 orig_x0;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __AARCH64EB__</span></span><br><span class="line">u32 unused2;</span><br><span class="line">s32 syscallno;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">s32 syscallno;</span><br><span class="line">u32 unused2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">u64 sdei_ttbr1;</span><br><span class="line"><span class="comment">/* Only valid when ARM64_HAS_IRQ_PRIO_MASKING is enabled. */</span></span><br><span class="line">u64 pmr_save;</span><br><span class="line">u64 stackframe[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only valid for some EL1 exceptions. */</span></span><br><span class="line">u64 lockdep_hardirqs;</span><br><span class="line">u64 exit_rcu;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¯¥ç»“æ„å®šä¹‰äº†å¼‚å¸¸æœŸé—´å¯„å­˜å™¨åœ¨å †æ ˆä¸Šçš„å­˜å‚¨æ–¹å¼ã€‚ è¯·æ³¨æ„ sizeof(struct pt_regs) å¿…é¡»æ˜¯ 16 çš„å€æ•°ï¼ˆç”¨äºå †æ ˆå¯¹é½ï¼‰ã€‚</p><ul><li>b el()<em>()</em></li></ul><p>ä»¥ kernel_ventry 1, t, 64, sync ä¸ºä¾‹å°†å®å±•å¼€å¾—åˆ°ï¼šel1t_64_sync, ä¸‹é¢æˆ‘ä»¬å»çœ‹çœ‹è¯¥æ ‡å·çš„å®ç°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.macro entry_handler el:req, ht:req, regsize:req, label:req</span><br><span class="line">SYM_CODE_START_LOCAL(el\el\ht\()_\regsize\()_\label)</span><br><span class="line">kernel_entry \el, \regsize</span><br><span class="line">movx0, sp</span><br><span class="line">blel\el\ht\()_\regsize\()_\label\()_handler</span><br><span class="line">.if \el == 0</span><br><span class="line">bret_to_user</span><br><span class="line">.else</span><br><span class="line">bret_to_kernel</span><br><span class="line">.endif</span><br><span class="line">SYM_CODE_END(el\el\ht\()_\regsize\()_\label)</span><br><span class="line">.endm</span><br><span class="line">/*</span><br><span class="line"> * Early exception handlers</span><br><span class="line"> */</span><br><span class="line">entry_handler1, t, 64, sync</span><br><span class="line">entry_handler1, t, 64, irq</span><br><span class="line">entry_handler1, t, 64, fiq</span><br><span class="line">entry_handler1, t, 64, error</span><br><span class="line"></span><br><span class="line">entry_handler1, h, 64, sync</span><br><span class="line">entry_handler1, h, 64, irq</span><br><span class="line">entry_handler1, h, 64, fiq</span><br><span class="line">entry_handler1, h, 64, error</span><br><span class="line"></span><br><span class="line">entry_handler0, t, 64, sync</span><br><span class="line">entry_handler0, t, 64, irq</span><br><span class="line">entry_handler0, t, 64, fiq</span><br><span class="line">entry_handler0, t, 64, error</span><br><span class="line"></span><br><span class="line">entry_handler0, t, 32, sync</span><br><span class="line">entry_handler0, t, 32, irq</span><br><span class="line">entry_handler0, t, 32, fiq</span><br><span class="line">entry_handler0, t, 32, error</span><br></pre></td></tr></tbody></table></figure><p>å°† entry_handler 1, t, 64, sync å®å±•å¼€ï¼Œå¾—åˆ°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">el1t_64_sync:</span><br><span class="line">  kernel_entry \el, \regsize</span><br><span class="line">movx0, sp</span><br><span class="line">blel\el\ht\()_\regsize\()_\label\()_handler</span><br><span class="line">.if \el == 0</span><br><span class="line">bret_to_user</span><br><span class="line">.else</span><br><span class="line">bret_to_kernel</span><br><span class="line">.endif</span><br></pre></td></tr></tbody></table></figure><p>kernel_entry å®å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">.macrokernel_entry, el, regsize = 64</span><br><span class="line">.if\regsize == 32</span><br><span class="line">movw0, w0// zero upper 32 bits of x0</span><br><span class="line">.endif</span><br><span class="line">stpx0, x1, [sp, #16 * 0]</span><br><span class="line">stpx2, x3, [sp, #16 * 1]</span><br><span class="line">stpx4, x5, [sp, #16 * 2]</span><br><span class="line">stpx6, x7, [sp, #16 * 3]</span><br><span class="line">stpx8, x9, [sp, #16 * 4]</span><br><span class="line">stpx10, x11, [sp, #16 * 5]</span><br><span class="line">stpx12, x13, [sp, #16 * 6]</span><br><span class="line">stpx14, x15, [sp, #16 * 7]</span><br><span class="line">stpx16, x17, [sp, #16 * 8]</span><br><span class="line">stpx18, x19, [sp, #16 * 9]</span><br><span class="line">stpx20, x21, [sp, #16 * 10]</span><br><span class="line">stpx22, x23, [sp, #16 * 11]</span><br><span class="line">stpx24, x25, [sp, #16 * 12]</span><br><span class="line">stpx26, x27, [sp, #16 * 13]</span><br><span class="line">stpx28, x29, [sp, #16 * 14]</span><br><span class="line"></span><br><span class="line">.if\el == 0</span><br><span class="line">clear_gp_regs</span><br><span class="line">mrsx21, sp_el0</span><br><span class="line">ldr_this_cputsk, __entry_task, x20</span><br><span class="line">msrsp_el0, tsk</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Ensure MDSCR_EL1.SS is clear, since we can unmask debug exceptions</span><br><span class="line"> * when scheduling.</span><br><span class="line"> */</span><br><span class="line">ldrx19, [tsk, #TSK_TI_FLAGS]</span><br><span class="line">disable_step_tsk x19, x20</span><br><span class="line"></span><br><span class="line">/* Check for asynchronous tag check faults in user space */</span><br><span class="line">check_mte_async_tcf x22, x23</span><br><span class="line">apply_ssbd 1, x22, x23</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM64_PTR_AUTH</span><br><span class="line">alternative_if ARM64_HAS_ADDRESS_AUTH</span><br><span class="line">/*</span><br><span class="line"> * Enable IA for in-kernel PAC if the task had it disabled. Although</span><br><span class="line"> * this could be implemented with an unconditional MRS which would avoid</span><br><span class="line"> * a load, this was measured to be slower on Cortex-A75 and Cortex-A76.</span><br><span class="line"> *</span><br><span class="line"> * Install the kernel IA key only if IA was enabled in the task. If IA</span><br><span class="line"> * was disabled on kernel exit then we would have left the kernel IA</span><br><span class="line"> * installed so there is no need to install it again.</span><br><span class="line"> */</span><br><span class="line">ldrx0, [tsk, THREAD_SCTLR_USER]</span><br><span class="line">tbzx0, SCTLR_ELx_ENIA_SHIFT, 1f</span><br><span class="line">__ptrauth_keys_install_kernel_nosync tsk, x20, x22, x23</span><br><span class="line">b2f</span><br><span class="line">1:</span><br><span class="line">mrsx0, sctlr_el1</span><br><span class="line">orrx0, x0, SCTLR_ELx_ENIA</span><br><span class="line">msrsctlr_el1, x0</span><br><span class="line">2:</span><br><span class="line">isb</span><br><span class="line">alternative_else_nop_endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">mte_set_kernel_gcr x22, x23</span><br><span class="line"></span><br><span class="line">scs_load tsk</span><br><span class="line">.else</span><br><span class="line">addx21, sp, #PT_REGS_SIZE</span><br><span class="line">get_current_task tsk</span><br><span class="line">.endif /* \el == 0 */</span><br><span class="line">mrsx22, elr_el1</span><br><span class="line">mrsx23, spsr_el1</span><br><span class="line">stplr, x21, [sp, #S_LR]</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * For exceptions from EL0, create a final frame record.</span><br><span class="line"> * For exceptions from EL1, create a synthetic frame record so the</span><br><span class="line"> * interrupted code shows up in the backtrace.</span><br><span class="line"> */</span><br><span class="line">.if \el == 0</span><br><span class="line">stpxzr, xzr, [sp, #S_STACKFRAME]</span><br><span class="line">.else</span><br><span class="line">stpx29, x22, [sp, #S_STACKFRAME]</span><br><span class="line">.endif</span><br><span class="line">addx29, sp, #S_STACKFRAME</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM64_SW_TTBR0_PAN</span><br><span class="line">alternative_if_not ARM64_HAS_PAN</span><br><span class="line">bl__swpan_entry_el\el</span><br><span class="line">alternative_else_nop_endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">stpx22, x23, [sp, #S_PC]</span><br><span class="line"></span><br><span class="line">/* Not in a syscall by default (el0_svc overwrites for real syscall) */</span><br><span class="line">.if\el == 0</span><br><span class="line">movw21, #NO_SYSCALL</span><br><span class="line">strw21, [sp, #S_SYSCALLNO]</span><br><span class="line">.endif</span><br><span class="line"></span><br><span class="line">/* Save pmr */</span><br><span class="line">alternative_if ARM64_HAS_IRQ_PRIO_MASKING</span><br><span class="line">mrs_sx20, SYS_ICC_PMR_EL1</span><br><span class="line">strx20, [sp, #S_PMR_SAVE]</span><br><span class="line">movx20, #GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET</span><br><span class="line">msr_sSYS_ICC_PMR_EL1, x20</span><br><span class="line">alternative_else_nop_endif</span><br><span class="line"></span><br><span class="line">/* Re-enable tag checking (TCO set on exception entry) */</span><br><span class="line">#ifdef CONFIG_ARM64_MTE</span><br><span class="line">alternative_if ARM64_MTE</span><br><span class="line">SET_PSTATE_TCO(0)</span><br><span class="line">alternative_else_nop_endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Registers that may be useful after this macro is invoked:</span><br><span class="line"> *</span><br><span class="line"> * x20 - ICC_PMR_EL1</span><br><span class="line"> * x21 - aborted SP</span><br><span class="line"> * x22 - aborted PC</span><br><span class="line"> * x23 - aborted PSTATE</span><br><span class="line">*/</span><br><span class="line">.endm</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œä¸åšè¯¦ç»†åˆ†æäº†ï¼Œé™¤äº†å¯¹ä¸€äº›å¯„å­˜å™¨åšåŸºç¡€å¤„ç†ï¼Œä¿å­˜åŸºæœ¬å’Œç‰¹æ®Šå¯„å­˜å™¨å€¼å¤–æœ€é‡è¦çš„å°±æ˜¯ bl el()<em>()</em>()_handlerï¼ŒåŒæ ·ä»¥ä¸Šé¢ç¬¬ä¸€ä¸ªå®å®šä¹‰ä¸ºä¾‹ï¼Œå±•å¼€ä¸º el1t_64_sync_handlerï¼Œè¿™äº›å‡½æ•°çš„å®šä¹‰å’Œå®ç°åœ¨ linux/arch/arm64/include/asm/exception.h å’Œ linux/arch/arm64/kernel/entry-common.c ä¸­ã€‚</p><p>åœ¨ä¸Šé¢çš„ä¸€ç³»åˆ—å‡½æ•°ä¸­ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªä¸­æ–­å‘é‡è¡¨ï¼ŒåŠå…¶é‡Œé¢çš„å‡½æ•°å®ç°ï¼Œå½“å¤–éƒ¨ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè·³è½¬åˆ°å…·ä½“æ ‡å¤„è¿è¡Œä»£ç ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9iaW51dGlscy9kb2NzL2FzL01hY3JvLmh0bWwjTWFjcm8=">https://sourceware.org/binutils/docs/as/Macro.html#Macro<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2V3YXJlLm9yZy9iaW51dGlscy9kb2NzL2FzLw==">https://sourceware.org/binutils/docs/as/<i class="fa fa-external-link-alt"></i></span><br>ã€Šå¥”è·‘å§ Linux å†…æ ¸ã€‹<br>ã€ŠLinux å†…æ ¸æ·±åº¦è§£æã€‹<br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¸­æ–­å­ç³»ç»Ÿï¼ˆä¸€ï¼‰ç»¼è¿°</title>
      <link href="/2021/LinuxKernel/LinuxKernelInterruptSummery/"/>
      <url>/2021/LinuxKernel/LinuxKernelInterruptSummery/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/KernelInterruptSummery.png"> <span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS9lbWJlZC82MjM1NzIyNWYzNDZmYjA3MjVmNTU0YjU=">åŸå›¾<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h1 id="ç¡¬ä»¶é“¾æ¥ç›¸å…³æè¿°">ç¡¬ä»¶é“¾æ¥ç›¸å…³æè¿°</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Kernel/HW_IRQ.png"></p><p>åœ¨ä¸Šå›¾ä¸­ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œäº§ç”Ÿä¸­æ–­çš„å¤–éƒ¨è®¾å¤‡ï¼ˆä¸­æ–­æºï¼‰ã€ç”¨äºç®¡ç†ä¸­æ–­çš„ä¸­æ–­æ§åˆ¶å™¨ä»¥åŠå¤„ç†ä¸­æ–­ä¿¡å·çš„ cpuã€‚</p><h1 id="ä¸­æ–­å¤„ç†æµç¨‹">ä¸­æ–­å¤„ç†æµç¨‹</h1><p>åœ¨ ARM å¤„ç†å™¨ä¸Šä¼šæœ‰ä¸€ä¸ªä¸­æ–­å‘é‡çš„è¿ç»­åœ°å€ï¼Œä¸€èˆ¬æ˜¯é›¶åœ°å€å¼€å§‹ï¼Œä¹‹ååœ°å€æ¯å¢åŠ  1 çš„åœ°å€ä¸Šå­˜æ”¾ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œç”¨äºå¤„ç†ä¸åŒçš„ä¸­æ–­ä¿¡å·ï¼Œå½“æœ‰ä¸åŒçš„ä¸­æ–­å‘ç”Ÿæ—¶å°±åˆ°å¯¹åº”çš„åœ°å€æ‰§è¡Œè·³è½¬æŒ‡ä»¤ï¼Œè€Œå…·ä½“ä¸åŒçš„ä¸­æ–­ä¿¡å·å°±åœ¨ä¸åŒä¸­æ–­æ ‡å·ä½ç½®è¿›è¡Œå¤„ç†ã€‚</p><p>ä¿å­˜ç°åœºï¼ˆå½“å‰çº¿ç¨‹ç¯å¢ƒï¼‰â€” è·³è½¬æ‰§è¡Œä¸­æ–­æœåŠ¡ç¨‹åº â€” è¿”å›æ¢å¤ç°åœºã€‚</p><h1 id="linux-ç³»ç»Ÿå¯¹ä¸­æ–­å¤„ç†çš„æ–¹å¼">Linux ç³»ç»Ÿå¯¹ä¸­æ–­å¤„ç†çš„æ–¹å¼</h1><p>é¦–å…ˆéœ€è¦å…ˆæ˜ç¡®å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸­æ–­å¤„ç†è¿‡ç¨‹ä¸­æ˜¯å…³å…¨å±€ä¸­æ–­çš„ï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­ç¨‹åºå¤„ç†æœŸé—´ä¸èƒ½å“åº”æ–°çš„ä¸­æ–­ã€‚</li><li>åŸºäºç¬¬ä¸€ç‚¹ï¼ŒLinux å†…æ ¸ä¸å…è®¸ä¸­æ–­åµŒå¥—ï¼Œå…¶å®ç¬¬ä¸€ç‚¹å°±å·²ç»å†³å®šäº†ä¸­æ–­ä¸èƒ½åµŒå¥—ã€‚</li></ul><p>åŸºäºä»¥ä¸Šä¸¤ç‚¹ï¼Œå½“ Linux ç³»ç»Ÿçš„ä¸­æ–­ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ç³»ç»Ÿå“åº”å°±ä¼šæœ‰å¾ˆå¤§å»¶è¿Ÿï¼Œä¸ºæ­¤ Linux ç³»ç»Ÿå°†ä¸­æ–­è®¾è®¡ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ï¼Œä¸ŠåŠéƒ¨å¤„ç†ç´§æ€¥çš„å¿…é¡»è¦å¤„ç†çš„ä»»åŠ¡è€Œè€—æ—¶çš„ä¸ç´§æ€¥çš„ä»»åŠ¡æ”¾åˆ°ä¸­æ–­ä¸‹åŠéƒ¨æ¥å¤„ç†ï¼Œä¸­æ–­ä¸‹åŠéƒ¨å°±æ˜¯æ™®é€šçš„è½¯ä»¶ç¨‹åºï¼ˆä½†æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«å°±æ˜¯ softirq å’Œ tasklet è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œè€Œ workqueue å’Œ threaded irq è¿è¡Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼‰ï¼Œä¸­æ–­ä»ç„¶æ˜¯å¼€å¯çš„ï¼Œåœ¨ä¸­æ–­çš„ä¸‹åŠéƒ¨ä»ç„¶å¯ä»¥å“åº”ä¸­æ–­ã€‚</p><p>ä¸­æ–­ä¸ŠåŠéƒ¨åº”è¯¥ä¸»è¦å¤„ç†å¦‚ä¸‹ä»»åŠ¡ï¼š</p><ul><li>å¯¹å®æ—¶æ€§è¦æ±‚å¼ºçš„ä»»åŠ¡ã€‚</li><li>å’Œç¡¬ä»¶ç›¸å…³çš„æ“ä½œï¼Œåƒæ¸…ä¸­æ–­æ ‡å¿—ä½ï¼Œå¦‚æœæ˜¯å…±äº«ä¸­æ–­åˆ™è·å–ç¡¬ä»¶ä¸­æ–­å·ã€‚</li><li>ä¸èƒ½ä¼‘çœ ï¼Œä¼‘çœ ä¼šå¼•å‘ç³»ç»Ÿä»»åŠ¡è°ƒåº¦ï¼Œè€Œåœ¨ä¸­æ–­çŠ¶æ€ä¸‹ä»»åŠ¡è°ƒåº¦æ˜¯å…³é—­çš„ï¼Œè¿™ä¸ªä¸€å®šä¸èƒ½ä¼‘çœ ã€‚</li></ul><p>ä¸­æ–­ä¸‹åŠéƒ¨å†…æ ¸æä¾›äº†å¤šç§å¤„ç†æœºåˆ¶ï¼Œä¸‹é¢æŒ¨ä¸ªä»‹ç»ä¸­æ–­ä¸‹åŠéƒ¨å¤„ç†æ–¹å¼</p><h2 id="softirqæ€§èƒ½å¥½">softirqï¼ˆæ€§èƒ½å¥½ï¼‰</h2><p>åœ¨æ™®é€šçš„é©±åŠ¨ä¸­ä¸€èˆ¬æ˜¯ä¸ä¼šç”¨åˆ° softirqï¼Œsoftirq ä¸èƒ½åŠ¨æ€åˆ†é…ï¼Œéƒ½æ˜¯é™æ€å®šä¹‰çš„ã€‚å†…æ ¸å·²ç»å®šä¹‰äº†è‹¥å¹²ç§ softirq numberï¼Œä¾‹å¦‚ç½‘ç»œæ•°æ®çš„æ”¶å‘ã€block è®¾å¤‡çš„æ•°æ®è®¿é—®ï¼ˆæ•°æ®é‡å¤§ï¼Œé€šä¿¡å¸¦å®½é«˜ï¼‰ï¼Œtimer çš„ deferable taskï¼ˆæ—¶é—´æ–¹é¢è¦æ±‚é«˜ï¼‰ã€‚softirq çš„ä¸€äº›ç‰¹æ€§ï¼š</p><ul><li>softirq æ˜¯åœ¨ç¼–è¯‘æœŸé—´é™æ€åˆ†é…çš„ã€‚</li><li>äº§ç”Ÿåå¹¶ä¸æ˜¯é©¬ä¸Šå¯ä»¥æ‰§è¡Œï¼Œå¿…é¡»è¦ç­‰å¾…å†…æ ¸çš„è°ƒåº¦æ‰èƒ½æ‰§è¡Œã€‚è½¯ä¸­æ–­ä¸ä¼šæŠ¢å å¦å¤–ä¸€ä¸ªè½¯ä¸­æ–­ï¼Œå”¯ä¸€å¯ä»¥æŠ¢å è½¯ä¸­æ–­çš„æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆç¡¬ä¸­æ–­å¤„ç†å®Œæˆä¼šæ‰“å¼€å…¨å±€ä¸­æ–­ï¼‰ã€‚</li><li>å¯ä»¥å¹¶å‘è¿è¡Œåœ¨å¤šä¸ª CPU ä¸Šï¼ˆå³ä½¿åŒä¸€ç±»å‹çš„ä¹Ÿå¯ä»¥ï¼‰ã€‚æ‰€ä»¥è½¯ä¸­æ–­å¿…é¡»è®¾è®¡ä¸ºå¯é‡å…¥çš„å‡½æ•°ï¼ˆå…è®¸å¤šä¸ª CPU åŒæ—¶æ“ä½œï¼‰ï¼Œ å› æ­¤ä¹Ÿéœ€è¦ä½¿ç”¨è‡ªæ—‹é”æ¥ä¿æŠ¤å…¶æ•°æ®ç»“æ„ã€‚</li><li>è½¯ä¸­æ–­å¯èƒ½è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œè½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ä¸èƒ½ç¡çœ ï¼Œä»ç¡¬ä¸­æ–­è¿”å›çš„æ—¶å€™è°ƒç”¨ do_softirq()ã€‚</li><li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œç”¨ softirq_action ç»“æ„ä½“è¡¨å¾ä¸€ä¸ªè½¯ä¸­æ–­ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«è½¯ä¸­æ–­å¤„ç†å‡½æ•°æŒ‡é’ˆå’Œä¼ é€’ç»™è¯¥å‡½æ•°çš„æŒ‡é’ˆçš„å‚æ•°ã€‚ä½¿ç”¨ open_softirq() å‡½æ•°å¯ä»¥æ³¨å†Œè½¯ä¸­æ–­å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè€Œ raise_softirq() å‡½æ•°å¯ä»¥è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­ã€‚</li></ul><h2 id="taskletæ˜“ç”¨">Taskletï¼ˆæ˜“ç”¨ï¼‰</h2><p>å†…æ ¸æŠŠæ™®é€šä¼˜å…ˆçº§å’Œé«˜ä¼˜å…ˆçº§çš„ tasklet ç»´æŠ¤åœ¨ä¸¤ä¸ªä¸åŒçš„é“¾è¡¨ä¸­ã€‚tasklet_schedule å°† tasklet æ·»åŠ åˆ°æ™®é€šä¼˜å…ˆçº§é“¾è¡¨ä¸­ï¼Œç”¨ TASKLET_SOFTIRQ æ¥æ ‡å¿—è°ƒåº¦ç›¸å…³çš„ softirqã€‚tasklet_hi_schedule å°† tasklet æ·»åŠ åˆ°é«˜ä¼˜å…ˆçº§é“¾è¡¨ä¸­ï¼Œç”¨ HI_SOFTIRQ æ¥æ ‡å¿—è°ƒåº¦ç›¸å…³çš„ softirqã€‚ä¸‹é¢æ˜¯ tasklet çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>ä¸€ä¸ª Tasklet åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œï¼Œä¸è¦æ±‚å¤„ç†å‡½æ•°æ˜¯å¯é‡å…¥çš„ï¼ˆæ˜“ç”¨æ€§çš„ä½“ç°ï¼‰ï¼Œä¸åŒçš„ Tasklet å¯ä»¥åŒæ—¶è¿è¡Œåœ¨ä¸åŒçš„ cpu ä¸Šã€‚</li><li>Tasklet å¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤ï¼ˆæ˜“ç”¨ï¼‰ã€‚</li><li>åœ¨å·²ç»è¢«è°ƒåº¦ä½†è¿˜æœªå¼€å§‹æ‰§è¡Œçš„ tasklet ä¸Šè°ƒç”¨ tasklet_schedule å°†ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼Œè¯¥ tasklet æœ€ç»ˆä¹Ÿåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>å¯ä»¥åœ¨ tasklet ä¸­è°ƒç”¨ tasklet_scheduleï¼Œæ„å‘³ç€ tasklet å¯ä»¥è°ƒåº¦è‡ªå·±ã€‚</li><li>é«˜ä¼˜å…ˆçº§çš„ tasklet æ€»æ˜¯åœ¨æ™®é€šä¼˜å…ˆçº§çš„ tasklet ä¹‹å‰æ‰§è¡Œï¼Œæ»¥ç”¨é«˜ä¼˜å…ˆçº§çš„ tasklet ä¼šå¯¼è‡´ç³»ç»Ÿå»¶æ—¶å¢åŠ ã€‚</li></ul><p>è°ƒç”¨ tasklet_kill å¯ä»¥åœæ­¢ taskletï¼ˆç­‰å¾…å½“å‰æ‰§è¡Œå®Œæ¯•åå†æ€æ‰ï¼‰ã€‚</p><p>x ä¸è½¯ä¸­æ–­å’Œ tasklet ä¸åŒï¼Œä»–ä»¬è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸å¯æŠ¢å ï¼Œè€Œ workqueue è¿è¡Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯ä»¥æŠ¢å ï¼Œå¯ä»¥è°ƒåº¦å½“ç„¶æœ€ç›´æ¥çš„å°±æ˜¯å¯ä»¥ç¡çœ ã€‚è¿™é‡Œçš„ç¡çœ æ˜¯æŒ‡å¯ä»¥æ‰§è¡Œå¯¼è‡´çº¿ç¨‹ç¡çœ çš„æ“ä½œï¼Œæ¯”å¦‚æŒæœ‰äº’æ–¥é”ï¼Œè°ƒç”¨ usleep ç­‰æ“ä½œã€‚ å·¥ä½œé˜Ÿåˆ—æ˜¯æ„å»ºåœ¨å†…æ ¸çº¿ç¨‹ä¹‹ä¸Šçš„ï¼Œå†…æ ¸æœ‰ä¸¤ç§æ–¹æ³•å¤„ç†å·¥ä½œé˜Ÿåˆ—ã€‚</p><ul><li>ä¸€ç§æ˜¯é»˜è®¤çš„å…±äº«å·¥ä½œé˜Ÿåˆ—ï¼Œç”±ä¸€ç»„å†…æ ¸çº¿ç¨‹å¤„ç†ï¼Œæ¯ä¸ªå†…æ ¸çº¿ç¨‹è¿è¡Œåœ¨ä¸€ä¸ª cpu ä¸Šã€‚ä¸€æ—¦æœ‰å·¥ä½œä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œå°±è®©è¯¥å·¥ä½œåˆ°å…¨å±€å·¥ä½œé˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œä»–å°†åœ¨åˆé€‚çš„æ—¶å€™æ‰§è¡Œã€‚</li><li>å¦ä¸€ç§æ˜¯ä¸“ç”¨å†…æ ¸çº¿ç¨‹å†…è¿è¡Œå·¥ä½œé˜Ÿåˆ—ã€‚è¿™æ„å‘³ç€æ— è®ºä½•æ—¶éœ€è¦æ‰§è¡Œå·¥ä½œé˜Ÿåˆ—å¤„ç†ç¨‹åºï¼Œéƒ½ä¼šå”¤é†’ä¸“ç”¨å†…æ ¸çº¿ç¨‹æ¥å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯é»˜è®¤çš„é¢„å®šä¹‰å†…æ ¸çº¿ç¨‹ã€‚</li></ul><h2 id="threaded-irq">threaded irq</h2><p>çº¿ç¨‹åŒ–ä¸­æ–­çš„ä¸»è¦ç›®æ ‡æ˜¯å°†ä¸­æ–­ç¦ç”¨æ—¶é—´å‡å°‘åˆ°æœ€ä½é™åº¦ã€‚ä½¿ç”¨çº¿ç¨‹åŒ–ä¸­æ–­ï¼Œæ³¨å†Œä¸­æ–­å¤„ç†ç¨‹åºçš„æ–¹å¼å°†å¾—åˆ°ç®€åŒ–ã€‚ç”šè‡³ä¸å¿…è‡ªå·±è°ƒåº¦ä¸‹åŠéƒ¨ï¼Œçº¿ç¨‹åŒ–æ ¸å¿ƒä¼šå®Œæˆã€‚ä¸‹åŠéƒ¨åœ¨ä¸“ç”¨å†…æ ¸çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¿™é‡Œä½¿ç”¨ request_threaded_irq() æ¥æ›¿ä»£ request_irq();</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">request_threaded_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler,</span></span><br><span class="line"><span class="params"> <span class="type">irq_handler_t</span> thread_fn, <span class="type">unsigned</span> <span class="type">long</span> irqflags,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *devname, <span class="type">void</span> *dev_id)</span></span><br></pre></td></tr></tbody></table></figure><p>request_threaded_irq() å‡½æ•°åœ¨å…¶å‚æ•°ä¸­æ¥æ”¶ä¸¤ä¸ªå‡½æ•°ã€‚</p><ul><li><p><span class="citation" data-cites="handler">@handler</span> å‡½æ•°ï¼šè¿™ä¸ä½¿ç”¨ request_irq() æ³¨å†Œæ—¶ä½¿ç”¨çš„å‡½æ•°ä¸€æ ·ã€‚å®ƒè¡¨ç¤ºä¸ŠåŠéƒ¨å‡½æ•°ï¼Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆæˆ–åŸå­ä¸Šä¸‹æ–‡ï¼‰ä¸­è¿è¡Œã€‚å¦‚æœå®ƒèƒ½æ›´å¿«åœ°å¤„ç†ä¸­æ–­ï¼Œå°±å¯ä»¥æ ¹æœ¬ä¸ç”¨ä¸‹åŠéƒ¨ï¼Œå®ƒåº”è¯¥è¿”å› IRQ_HANDLEDã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸­æ–­å¤„ç†éœ€è¦ 100us ä»¥ä¸Šï¼Œå¦‚å‰æ‰€è¿°ï¼Œåˆ™åº”è¯¥ä½¿ç”¨ä¸‹åŠéƒ¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåº”è¯¥è¿”å› IRQ_WAKE_THREADï¼Œä»è€Œå¯¼è‡´è°ƒåº¦ thread_fn å‡½æ•°ï¼ˆå¿…é¡»æä¾›ï¼‰ã€‚</p></li><li><p><span class="citation" data-cites="thread_fn">@thread_fn</span> å‡½æ•°ï¼šè¿™ä»£è¡¨ä¸‹åŠéƒ¨ï¼Œç”±ä¸ŠåŠéƒ¨è°ƒåº¦ã€‚å½“ç¡¬ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆhandler å‡½æ•°ï¼‰è¿”å› IRQ_WAKE_THREAD æ—¶ï¼Œå°†è°ƒåº¦ä¸è¯¥ä¸‹åŠéƒ¨ç›¸å…³è”çš„å†…æ ¸çº¿ç¨‹ï¼Œåœ¨å†…æ ¸çº¿ç¨‹è¿è¡Œæ—¶è°ƒç”¨ thread_fn å‡½æ•°ã€‚thread_fn å‡½æ•°å®Œæˆæ—¶å¿…é¡»è¿”å› IRQ_HANDLEDã€‚æ‰§è¡Œåï¼Œå†é‡æ–°è§¦å‘è¯¥ä¸­æ–­ï¼Œå¹¶ä¸”åœ¨ç¡¬ä¸­æ–­è¿”å› IRQWAKE_THREAD ä¹‹å‰ï¼Œå†…æ ¸çº¿ç¨‹ä¸ä¼šè¢«å†æ¬¡è°ƒåº¦ã€‚</p></li></ul><p>åœ¨ä»»ä½•èƒ½å¤Ÿä½¿ç”¨å·¥ä½œé˜Ÿåˆ—è°ƒåº¦ä¸‹åŠéƒ¨çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹åŒ–ä¸­æ–­ã€‚çœŸæ­£çš„çº¿ç¨‹åŒ–ä¸­æ–­å¿…é¡»å®šä¹‰ handler å’Œ thread_fnã€‚å¦‚æœ handler ä¸º NULLï¼Œè€Œ thread_fn ä¸ä¸º NULLï¼Œåˆ™å†…æ ¸å°†å®‰è£…é»˜è®¤çš„ç¡¬ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå®ƒå°†ç®€å•åœ°è¿”å› IRQ_WAKE_THREAD æ¥è°ƒåº¦ä¸‹åŠéƒ¨ã€‚handler æ€»æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œæ— è®ºæ˜¯å¼€å‘äººå‘˜å®šä¹‰è¿˜æ˜¯ç”±å†…æ ¸é»˜è®¤æä¾›ã€‚</p><h1 id="qa">QA</h1><h2 id="softirq-ä¸ºä»€ä¹ˆä¸èƒ½ä¼‘çœ ">SoftIRQ ä¸ºä»€ä¹ˆä¸èƒ½ä¼‘çœ </h2><p>SoftIRQ å¯èƒ½è¿è¡Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ˜¯ä¸èƒ½ sleep çš„ï¼Œå› ä¸º sleep ä¼šè§¦å‘è°ƒåº¦ã€‚è¿™é‡Œè½¯ä¸­æ–­æ˜¯é€šè¿‡ do_softirq() å‡½æ•°æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡Œè¯¥å‡½æ•°çš„æ—¶æœºæ˜¯</p><ul><li>ä»ç¡¬ä¸­æ–­å¤„ç†å‡½æ•°è¿”å›æ—¶ï¼ˆç¡¬ä¸­æ–­è¿”å›æ—¶è°ƒç”¨ irq_exit()-&gt;invoke_softirq()-&gt;do_doftirq(), è¿™ä¸ªæ—¶å€™è¿˜åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ï¼‰ã€‚</li><li>åœ¨ ksoftirq å†…æ ¸çº¿ç¨‹ä¸­ï¼ˆè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼‰ã€‚</li><li>åœ¨æ˜¾ç¤ºè°ƒç”¨è½¯ä¸­æ–­ä¸­ï¼Œæ¯”å¦‚ç½‘ç»œå­ç³»ç»Ÿä¸­çš„ NET_TX_SOFTIRQ å’Œ NET_RX_SOFTIRQï¼ˆè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼‰ã€‚</li></ul><h2 id="isr-é‡Œä¸ºä»€ä¹ˆä¸èƒ½-sleep">ISR é‡Œä¸ºä»€ä¹ˆä¸èƒ½ sleep</h2><p>sleep ä¼šå¯¼è‡´ call scheduler ä»¥é€‰æ‹©å¦ä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œï¼Œå†…æ ¸ä»£ç é‡Œæœ‰å¤§é‡çš„ critical section ï¼ˆä¸´ç•ŒåŒºï¼‰ï¼Œcritical section æœ¬è´¨ä¸Šæ˜¯ä¸€æ®µä¼šè®¿é—®æˆ–æ“ä½œå…±äº«èµ„æºçš„ä»£ç ï¼Œåœ¨ critical section é‡Œï¼Œæ˜¯ä¸èƒ½ call scheduler çš„ã€‚å› ä¸ºå·²ç»æœ‰ä¸€ä¸ªè¿›ç¨‹æŒæœ‰é”äº†ï¼Œå¦‚æœè¿™æ—¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œæœ€å¥½çš„æƒ…å†µä¸‹æ˜¯ç­‰å¾…ä¸€æ®µæ— æ³•é¢„æµ‹çš„æ—¶é—´åå‰ä¸€ä¸ªè¿›ç¨‹ä¼šå°†é”é‡Šæ”¾å‡ºæ¥ï¼Œæœ€åçš„æƒ…å†µæ˜¯æ­»é”ã€‚ç¡¬ä»¶ä¸­æ–­æ˜¯éšæ—¶å¯èƒ½å‘ç”Ÿçš„ï¼Œå³ä¾¿å†…æ ¸æ‰§è¡Œçš„è·¯å¾„æ­£å¤„äº critical section ä¸­ã€‚å¦‚æœæƒ³åœ¨ ISR é‡Œæ”¯æŒ sleepï¼Œä¹Ÿå°±æ˜¯æ”¯æŒ call scheduler çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ critical section éƒ½å¿…é¡»å¾—ç¦ç”¨ä¸­æ–­ï¼Œå¦åˆ™ç¡¬ä»¶ä¸­æ–­ä¸€æ—¦æ¥ä¸´ç³»ç»Ÿå°±ä¼šå‡ºç° race conditionï¼Œæ¥ä¸‹æ¥å¤§æ¦‚ç‡æ˜¯æ­»é”ã€‚</p><p>ç¡¬ä»¶ä¸­æ–­æ˜¯è¶…çº§å®è´µçš„èµ„æºï¼Œæƒ³åœ¨ä¸­æ–­é‡Œç¡çœ çš„è¯å°±å¾—åœ¨å¤§é‡çš„ critical section ä¸­å…³é—­ä¸­æ–­æ‰èƒ½é¿å… race conditionï¼Œè€Œå…³é—­ç¡¬ä»¶ä¸­æ–­å°†ä¼šå¤§å¤§åœ°å¢åŠ ä¸­æ–­å“åº”çš„å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿçš„ååº”é€Ÿåº¦ï¼Œè¿™æ˜¯æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·æ‰€æ— æ³•æ¥å—çš„ï¼Œå› æ­¤å†…æ ¸å¼€å‘è€…é‡‡ç”¨çš„è®¾è®¡æ˜¯åœ¨ä¸­æ–­é‡Œä¸å…è®¸ç¡çœ ï¼Œå¹¶ä¸” ISR åº”å°½å¿«æ‰§è¡Œå¹¶è¿”å›ä»¥ä¾¿ç³»ç»Ÿé‡Œçš„è¿›ç¨‹ç»§ç»­è¿è¡Œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvaXJxX3N1YnN5c3RlbS9pbnRlcnJ1cHRfc3Vic3lzdGVtX2FyY2hpdGVjdHVyZS5odG1s">http://www.wowotech.net/irq_subsystem/interrupt_subsystem_architecture.html<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MDMyNzY1NTI=">https://zhuanlan.zhihu.com/p/403276552<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x1ZG9uZ2d1b2EvYXJ0aWNsZS9kZXRhaWxzLzEyMTIyNjQ4NA==">https://blog.csdn.net/ludongguoa/article/details/121226484<i class="fa fa-external-link-alt"></i></span></p><p>ã€Šlinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Kernel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> Interrupt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·¥å…·æ¨è</title>
      <link href="/2021/Tools/Toolsrecommand/"/>
      <url>/2021/Tools/Toolsrecommand/</url>
      
        <content type="html"><![CDATA[<h1 id="æ•ˆç‡ç±»">æ•ˆç‡ç±»</h1><h2 id="notion">Notion</h2><p>Notion æ˜¯ä¸€æ¬¾æä¾›ç¬”è®°ã€ä»»åŠ¡ã€æ•°æ®åº“ã€çœ‹æ¿ã€ç»´åŸºã€æ—¥å†å’Œæé†’ç­‰ç»„ä»¶çš„åº”ç”¨ç¨‹åºã€‚ç”¨æˆ·å¯ä»¥å°†è¿™äº›ç»„ä»¶è¿æ¥èµ·æ¥ï¼Œæ¥åˆ›å»ºè‡ªå·±çš„ç³»ç»Ÿï¼Œç”¨äºçŸ¥è¯†ç®¡ç†ã€ç¬”è®°è®°å½•ã€æ•°æ®ç®¡ç†ã€é¡¹ç›®ç®¡ç†ç­‰ã€‚è¿™äº›ç»„ä»¶å’Œç³»ç»Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸ä»–äººè¿›è¡Œè·¨å¹³å°åä½œã€‚<span class="exturl" data-url="aHR0cHM6Ly93d3cubm90aW9uLnNvLzJiMmU4NDYxOWE2YjQwN2Q5MWExYzUzZjI4ZmQxOTE1">Notion<i class="fa fa-external-link-alt"></i></span></p><span id="more"></span><h2 id="page">Page</h2><p>Notion çš„ Pageï¼ˆPage æ— å¤„ä¸åœ¨ï¼‰å¯ä»¥åˆ›å»ºå„ç§ Blockï¼Œå¯ä»¥åˆ›å»ºé“¾æ¥åˆ°å…¶ä»–æ–‡ç« ï¼Œå¯ä»¥åˆ›å»ºé“¾æ¥åˆ° Databaseï¼Œå› æ­¤ Page å¯ä»¥ç”¨äºç®¡ç†ä¸€åˆ‡æƒ³è¦ç®¡ç†çš„ä¸œè¥¿ã€‚å®é™…ä¸Š Page æ˜¯ Notion çš„é¡µé¢åŸºæœ¬ç»„æˆå…ƒç´ ä¸å±‚çº§å…³ç³»ï¼Œä½œä¸ºæ–‡ä»¶å¤¹ï¼Œä½œä¸ºæ–‡ç« çš†å¯ã€‚</p><h2 id="block">Block</h2><p>notion ä¸­æœ€åŸºæœ¬çš„æ•°æ®å•ä½è¢«ç§°ä¸ºâ€œå—â€ï¼ˆblockï¼‰ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ä¸€ä¸ªåˆä¸€ä¸ªçš„å—ç»“æ„ï¼Œå¯ä»¥å¯¹è¿™äº›å—ç»“æ„è¿›è¡Œä»»æ„çš„æ’åˆ—ç»„åˆï¼ŒæŒ‰ç…§è‡ªå·±çš„å·¥ä½œéœ€è¦è¿›è¡Œè®¾è®¡å¸ƒå±€ï¼Œå¹¶ä¸”å¯ä»¥åŒæ­¥åˆ°æ‰€æœ‰çš„è®¾å¤‡ç«¯ã€‚notion æä¾›äº†è¶…è¿‡ 40 ç§å—æ•°æ®ç±»å‹ä»¥ä¾›é€‰æ‹©ï¼Œä»æœ€åŸºæœ¬çš„æ–‡å­—ï¼Œåˆ°å›¾ç‰‡ã€æ–‡ä»¶ã€è§†é¢‘ã€ç½‘é¡µã€ç­‰åª’ä½“ ï¼Œæ›´æœ‰è¡¨æ ¼ã€æ•°æ®åº“ã€ä»»åŠ¡è¿½è¸ªç­‰å¤æ‚ç»“æ„ç­‰ç­‰ã€‚ ä¸‹é¢æ˜¯ä¸€äº›åŸºæœ¬çš„ Block ä»‹ç»ï¼š</p><ul><li><p>åˆ—è¡¨ notion æä¾›äº†å‡ ç§åŸºæœ¬çš„åˆ—è¡¨å¯ä»¥è¿›è¡Œä½¿ç”¨ï¼ŒåŒ…æ‹¬ Bulleted listï¼ˆæ— åºåˆ—è¡¨ï¼‰ã€Numbered Listï¼ˆæœ‰åºåˆ—è¡¨ï¼‰ã€to-do listï¼ˆå¾…åŠåˆ—è¡¨ï¼‰ä»¥åŠ toggle listï¼ˆå¯æŠ˜å å†…å®¹åˆ—è¡¨ï¼‰ã€‚</p></li><li><p>å¼ºè°ƒä¸å¼•ç”¨ Notion æä¾›äº†ä¸€äº›å¸®åŠ©æ•´ç†å’Œç¼–è¾‘æ–‡å­—çš„æ–‡å­—å—ä¿®é¥°æ•ˆæœï¼Œæ¯”å¦‚ç”¨äº tips æç¤ºçš„ callout å‘½ä»¤ï¼Œè®°å½•ä»£ç ç‰‡æ®µçš„ code å‘½ä»¤ï¼Œå¼•ç”¨æŸäº›æ–‡ç« æ®µè½çš„ quote å‘½ä»¤ã€‚</p></li><li><p>åª’ä½“ å›¾ç‰‡ã€éŸ³è§†é¢‘ã€ç½‘é¡µã€æ–‡ä»¶ç»Ÿç»Ÿå¯ä»¥å¼•ç”¨è¿›æ¥ã€‚å¯ä»¥å¼•ç”¨åœ¨çº¿èµ„æºï¼Œä¹Ÿå¯ä»¥æœ¬åœ°ä¸Šä¼ ã€‚</p></li></ul><h2 id="database">Database</h2><p>Notion ä¸å¾—ä¸æçš„ä¸€é¡¹åŠŸèƒ½æ˜¯ Databaseï¼Œè¿™ä¸ªæ˜¯æˆ‘é€‰æ‹© Notion æœ€é‡è¦çš„åŸå› ä¹‹ä¸€ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ Notion çš„ Database åŠŸèƒ½ï¼š Database æ€»å…±æœ‰ 5 ç§è§†å›¾ï¼š</p><ul><li>Tableï¼šè¡¨æ ¼è§†å›¾ã€‚ç±»ä¼¼äºå¸¸è§çš„æ–¹æ ¼è¡¨ï¼Œæ¯”è¾ƒæ–¹ä¾¿åšæ•°æ®ç»Ÿè®¡ã€‚æ¯ä¸€è¡Œéƒ½å¯ä»¥å•ç‹¬æ‰“å¼€æˆä¸ºä¸€ä¸ª Pageï¼Œåœ¨å…¶ä¸­æ·»åŠ æ›´å¤šçš„ä¸œè¥¿ã€‚</li><li>Boardï¼šçœ‹æ¿è§†å›¾ã€‚å¯ä»¥ç”¨æ¥è¿›è¡Œä»»åŠ¡åˆ†é…ä¸åˆ†ç±»ã€‚å¡ç‰‡ä¸­çš„é€‰é¡¹å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ï¼Œçœ‹æ¿çš„åˆ†ç»„ä¹Ÿå¯ä»¥ç”¨é€‰é¡¹ç­›é€‰æ¥æ›´æ”¹ã€‚</li><li>Galleryï¼šç”»å»Šè¯•å›¾ã€‚å¯ä»¥æŸ¥çœ‹å¤šå¼ å¡ç‰‡ä¸­çš„å¼€å¤´éƒ¨åˆ†ï¼ŒåŒæ—¶æ·»åŠ ä¸€äº›ç®€è¦å†…å®¹ã€‚</li><li>Listï¼šåˆ—è¡¨è§†å›¾ã€‚å¯ä»¥æŸ¥çœ‹æŸäº›å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´åªæ˜¾ç¤ºåç§°å’ŒçŠ¶æ€ï¼Œæ¥ç¡®ä¿ä»»åŠ¡è¿›åº¦ã€‚</li><li>Calendarï¼šæ—¥å†è§†å›¾ã€‚å¯ä»¥åœ¨æ—¥å†ä¸ŠæŒ‰æ—¶é—´é¡ºåºæŸ¥çœ‹æ·»åŠ çš„å†…å®¹ã€‚</li></ul><p>è¿™æ˜¯äº”ç§å±•ç¤ºè§†å›¾ï¼Œæ„å‘³ç€ä»–ä»¬å…¶å®çš„å†…å®¹å…¶å®æ˜¯ç»Ÿä¸€çš„åªæ˜¯è¡¨ç°å½¢å¼ä¸åŒï¼Œè€Œä¸åŒçš„è¡¨ç°å½¢å¼æ„å‘³ç€ä»–å…·æœ‰æ›´ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ï¼Œä¾‹å¦‚ç”¨äºçŸ¥è¯†ç®¡ç†ã€é¡¹ç›®ç®¡ç†ã€æ¸…å•ç­‰ã€‚å¦‚æœä¸åŒçš„è§†å›¾æ˜¾ç¤ºçš„å†…å®¹å…¨éƒ¨éƒ½ä¸€æ ·åªæ˜¯å±•ç¤ºå½¢å¼ä¸åŒé‚£ä¹ˆå…¶å®ä»–ä¹Ÿå°±æ²¡é‚£ä¹ˆçµæ´»å’Œæœ‰ç”¨äº†ï¼Œåœ¨ä¸åŒçš„è§†å›¾ä¸‹å¯ä»¥ä¿®æ”¹ Property çš„é¡ºåºä»¥åŠæ˜¯å¦æ˜¾ç¤ºï¼Œè¿™é‡Œæœ‰ä¸ª Filter åŠŸèƒ½ï¼ŒFilter å°±æ˜¯æ ¹æ® Property åç§°å’Œ Property å€¼æ¥ä½œä¸ºåˆ¤æ–­ä¾æ®è¿›è¡Œè¿‡æ»¤ï¼Œåªå±•ç¤ºç¬¦åˆæ¡ä»¶çš„é¡¹ç›®ã€‚ä¾‹å¦‚å¯ä»¥å°† Property çš„ name å‘½åä¸ºä¼˜å…ˆçº§ï¼Œç„¶åå€¼å¯ä»¥è®¾ä¸ºï¼Œç´§æ€¥çš„ï¼Œé‡è¦çš„ç­‰ç„¶åé€šè¿‡ Filter åŠŸèƒ½å¿«é€Ÿå±•ç¤ºç´§æ€¥çš„å·¥ä½œé¡¹ã€‚</p><p>åœ¨ä½ é™¤äº†å·¥ä½œä¹‹å¤–è¿˜æœ‰å¾ˆå¤šä¸ªäººå­¦ä¹ ï¼Œé¡¹ç›®æ´»åŠ¨çš„æ—¶å€™é‚£ä¹ˆä¹…å¯ä»¥é€šè¿‡ Database çš„ Filter åŠŸèƒ½å°†å·¥ä½œçš„ã€ç”Ÿæ´»çš„ã€å­¦ä¹ çš„ Database é“¾æ¥åˆ°ä¸€ä¸ª Page ç„¶åé€šè¿‡ Filter è¿‡æ»¤å‡ºæˆªæ­¢æ—¥æœŸæ˜¯å½“å¤©çš„åˆ—è¡¨é¡¹æ¥å®ç°æ¯æ—¥æ¸…å•çš„åŠŸèƒ½ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>Notion ä½œä¸ºä¸€æ¬¾ç”Ÿäº§åŠ›è½¯ä»¶ï¼Œå®ƒå°±åƒçš„ä¹é«˜æ‹¼å—ä¸€æ ·ï¼Œå®ƒèƒ½åšå„ç§å„æ ·çš„äº‹ã€‚å½“ç„¶ Notion ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ªæœ‰å¼ºè¿«ç—‡çš„äººæ¥è¯´ä¸å®Œå…¨çš„ Markdown è¯­æ³•ï¼Œæ²¡æœ‰æ‚¬æµ®ç›®å½•ï¼Œä¸‘é™‹çš„ä»£ç å—ä»¥åŠå¥‡å¥‡æ€ªæ€ªçš„ Formula è¯­æ³•éƒ½æœ‰äº›è®©äººä¸çˆ½ï¼Œä¸è¿‡é€‚åº”ä¹‹åå°±ä¹Ÿè¿˜å¯ä»¥æ¥å—ã€‚</p><h1 id="marginnote">MarginNote</h1><p>MarginNote æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§ä¸”äººæ€§åŒ–çš„é˜…è¯»å’Œå­¦ä¹ è½¯ä»¶ï¼Œé€‚ç”¨äº Apple ç³»è½¯ä»¶ã€‚</p><h2 id="æ–‡æ¡£æ¨¡å¼">æ–‡æ¡£æ¨¡å¼</h2><p>åœ¨ MarginNote 3 ä¸­ï¼Œæ–‡ä»¶ä»å¤–éƒ¨å¯¼å…¥å°†é¦–å…ˆè¿›å…¥ã€Œæ–‡æ¡£æ¨¡å¼ã€åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒMarginNote 3 æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ PDF é˜…è¯»å™¨ï¼Œä½ åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œç®€å•çš„æ ‡è®°å’Œæ‰¹æ³¨ï¼Œé€šè¿‡å¿«é€Ÿæµè§ˆæ–‡æ¡£æ¥ç¡®å®šè‡ªå·±æ˜¯å¦éœ€è¦è¿›è¡Œã€Œç²¾è¯»ã€ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥æŠŠå®ƒå½“åšä½ çš„æ–‡çŒ®ã€Œæ”¶ä»¶ç®±ã€å’Œã€Œä¸­è½¬ç«™ã€ï¼Œå°†è‡ªå·±éœ€è¦é˜…è¯»çš„æ–‡çŒ®æ”¾åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿æ‰¹é‡ç®¡ç†ã€‚</p><h2 id="å­¦ä¹ æ¨¡å¼">å­¦ä¹ æ¨¡å¼</h2><p>åªéœ€è¦ç‚¹å‡»å³ä¸Šè§’çœç•¥å·é‡Œçš„ã€Œè½¬åˆ°å­¦ä¹ æ¨¡å¼ã€ï¼Œå°±èƒ½åˆ›å»ºä¸€ä¸ªåŒ…å«è¯¥æ–‡æ¡£çš„è„‘å›¾ç¬”è®°æœ¬ï¼Œè¿›å…¥åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„ã€Œå­¦ä¹ æ¨¡å¼ã€ã€‚åœ¨è¿™é‡Œä½ å¯ä»¥ä½¿ç”¨é«˜äº®ã€åœˆé€‰ã€é€‰ä¸­ã€æ‰‹ç»˜ç­‰å·¥å…·å¯¹å†…å®¹è¿›è¡Œæ ‡æ³¨ï¼Œè€Œ MarginNote 3 åˆ™ä¼šå°†å®ƒä»¬å‰ªè¾‘ä¸ºå¡ç‰‡ï¼ŒæŒ‰å¤§çº²æ’åˆ—äºå·¦ä¾§ï¼Œå¹¶ç”Ÿæˆæ€ç»´å¯¼å›¾ã€‚</p><blockquote><p>MarginNote æœ€çµé­‚çš„åŠŸèƒ½å°±åœ¨è¿™äº†ï¼Œé˜…è¯»æ–‡çŒ®ä¸€å®šè¦æ•´ç†å‡ºæ–‡ç« çš„æ•´ä½“ç»“æ„ï¼Œè€Œ MarginNote åœ¨å­¦ä¹ æ¨¡å¼ä¸‹é€šè¿‡æ ‡æ³¨å¯ä»¥ç›´æ¥ç”Ÿæˆæ€ç»´å¯¼å›¾ï¼Œè¿™æœ‰åŠ©äºå¸®ä½ å…»æˆæ ‡æ³¨æ–‡ç« ç»“æ„åŠæµç¨‹çš„å¥½ä¹ æƒ¯ï¼Œè€Œä¸”åœ¨ç²¾è¯»åæƒ³å†æ¬¡é˜…è¯»æ—¶å¯ä»¥ç›´æ¥é€šè¿‡æ€ç»´å¯¼å›¾å¿«é€Ÿå¯¼èˆªåˆ°æ–‡ç« å…·ä½“ç« èŠ‚ã€‚</p></blockquote><h2 id="å¤ä¹ æ¨¡å¼">å¤ä¹ æ¨¡å¼</h2><p>è¿™ä¸ªæœ¬äººå·²ç»æ¯•ä¸šä¸éœ€è¦å†è€ƒè¯•äº†ï¼Œä¹Ÿä¸å¸¸ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚</p><h2 id="æ€»ç»“-1">æ€»ç»“</h2><p>é˜…è¯»ä¹¦ç±æ–‡çŒ®çš„å¥½å·¥å…·ï¼Œå¼ºçƒˆæ¨èï¼Œä¸è¿‡è¿™ä¸ªåªåœ¨ Apple ç³»ä¸‹æ‰æœ‰ã€‚</p><h1 id="chrome-æµè§ˆå™¨">Chrome æµè§ˆå™¨</h1><p>è¿™é‡Œæ¨è Chrome æµè§ˆå™¨å®é™…ä¸Šæ˜¯è¦æ¨èé‡Œé¢å‡ ä¸ªå¥½ç”¨çš„æ’ä»¶ã€‚</p><h2 id="google-ç¿»è¯‘">Google ç¿»è¯‘</h2><p>è¿™ä¸ªæ˜¯ç½‘é¡µç¿»è¯‘çš„ç¥å™¨ï¼Œå¯ä»¥è®¾ç½®ä¸ºåœ¨åŒå‡»å•è¯çš„æ—¶å€™ç¿»è¯‘</p><h2 id="infinity">Infinity</h2><p>æ–°æ ‡ç­¾é¡µå¯ä»¥æ›¿ä»£æµè§ˆå™¨ä¸Šçš„ä¹¦ç­¾ï¼Œæœ€ä¸»è¦çš„æ˜¯è¿™ä¸ªç¾è§‚ï¼Œæ¯•ç«Ÿé¢œå€¼å³æ­£ä¹‰ï¼Œæ”¯æŒè‡ªå®šä¹‰ç½‘ç«™å›¾æ ‡åœ†è§’ç­‰ã€‚å¼ºæ¨</p><h2 id="æ ‡ç­¾åˆ†ç»„æ‰©å±•">æ ‡ç­¾åˆ†ç»„æ‰©å±•</h2><p>Chrome æ›´æ–°æ·»åŠ äº†æ ‡ç­¾åˆ†ç»„çš„åŠŸèƒ½ï¼Œæ‡‚å¾—éƒ½æ‡‚ï¼Œä½œä¸ºä¸€åç¨‹åºå‘˜ä¸€ä¸ª chrome ä¸æ‰“å¼€ä¸ªåå‡ äºŒåå‡ ä¸ª table ä¹Ÿéƒ½ä¸å¥½æ„æ€è¯´è‡ªå·±åœ¨å·¥ä½œï¼Œä½¿ç”¨æ ‡ç­¾åˆ†ç»„å¯ä»¥è®©ä½ æ‰“å¼€çš„æ ‡ç­¾é¡µåˆ†ç±»æ’å¸ƒå¹¶ä¸”æš‚æ—¶ä¸éœ€è¦çš„å¯ä»¥æŠ˜å ï¼Œå…¶ä¸åŒçš„æ ‡ç­¾é¢œè‰²çœ‹èµ·æ¥ç‰¹åˆ«èˆ’æœè¿™ä¸ªåº”è¯¥æ˜¯æœ€é‡è¦çš„äº†å§ã€‚</p><h2 id="lastpass">LastPass</h2><p>å¯†ç åŠ©æ‰‹ï¼Œä¸å¿…å¤šè¯´äº†ï¼Œç°åœ¨å„å¤§ç½‘ç«™éƒ½å®åï¼Œå„ç§ç™»å½• xxxã€‚</p><h2 id="ads-killer-adblocker-plus">Ads Killer Adblocker Plus</h2><p>å¹¿å‘Šæ‹¦æˆª xxxoooã€‚</p><h2 id="unsplash-for-chrome">Unsplash For Chrome</h2><p>Unsplash å…è´¹ç²¾ç¾çš„å›¾ç‰‡ä¸å¤šè¯´äº†ï¼Œæ²¡äº‹å¸¸é€›é€›ï¼Œèº«å¿ƒæ„‰æ‚¦ã€‚</p><h1 id="proceson">ProcesOn</h1><p>ä¸€æ¬¾åœ¨çº¿ç»˜å›¾å·¥å…·ï¼Œæ€ç»´å¯¼å›¾ã€UML å›¾ç­‰ã€‚å¼ºæ¨</p><h1 id="surge">Surge</h1><p>ç§‘å­¦ä¸Šç½‘æœ€å¥½çš„å·¥å…·ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚</p><h1 id="magnet">Magnet</h1><p>mac ä¸‹çª—å£æ’åˆ—çš„å¥½å·¥å…·ï¼Œå¼ºæ¨ã€‚</p><h1 id="text-scanner">Text Scanner</h1><p>æ–¹ä¾¿çš„ OCR è½¯ä»¶ã€‚</p><h1 id="ç¼–ç¨‹">ç¼–ç¨‹</h1><h1 id="vscode">vscode</h1><p>vscode çš„çµé­‚æ˜¯å…¶ä¸°å¯Œçš„æ’ä»¶ï¼Œä¸‹é¢æ˜¯ä¸ªäººéå¸¸å–œæ¬¢çš„æ’ä»¶ã€‚</p><h2 id="better-comments">Better Comments</h2><p>ä»£ç æ³¨é‡Šé«˜äº®ï¼Œæ³¨é‡Šä½œä¸ºä»£ç çš„ä¸€éƒ¨åˆ†ä¸èƒ½æŠ›å¼ƒå§ï¼Œç”¨å®ƒï¼Œ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Share/better_comments.png"></p><h2 id="bracket-pair-colorizer">Bracket Pair Colorizer</h2><p>ä¸ºä»£ç ä¸­çš„æ‹¬å·æ·»ä¸Šä¸€æŠ¹äº®è‰²ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Share/bracker_pair_colorizer.png"></p><h2 id="change-case">change-case</h2><p>é€Ÿæ›´æ”¹å½“å‰é€‰æ‹©æˆ–å½“å‰å•è¯çš„å¤§å°å†™</p><ul><li>extension.changeCase.commandsï¼šåˆ—å‡ºæ‰€æœ‰æ›´æ”¹æ¡ˆä¾‹å‘½ä»¤ï¼Œå¦‚æœåªé€‰æ‹©äº†ä¸€ä¸ªå•è¯ï¼Œåˆ™é¢„è§ˆã€‚</li><li>extension.changeCase.camelï¼šChange Case'amell'ï¼šè½¬æ¢ä¸ºå¸¦æœ‰åˆ†éš”ç¬¦çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªå­—æ¯å¤§å†™ã€‚</li><li>extension.changeCase.constantï¼šChange Case'constant'ï¼šè½¬æ¢ä¸ºå¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.dotï¼šChange Case'dot'ï¼šè½¬æ¢ä¸ºå°å†™ï¼Œå¥ç‚¹åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.kebabï¼šChange Case'kebab'ï¼šè½¬æ¢ä¸ºå°å†™ï¼Œç ´æŠ˜å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆparam case çš„åˆ«åï¼‰ã€‚</li><li>extension.changeCase.lowerï¼šChange Case'lower'ï¼šè½¬æ¢ä¸ºå°å†™çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.lowerFirstï¼šæ›´æ”¹å¤§å°å†™'lowerFirst'ï¼šè½¬æ¢ä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦æ›´ä½çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.noï¼šè½¬æ¢å­—ç¬¦ä¸²æ²¡æœ‰ä»»ä½•å¤–å£³ï¼ˆå°å†™ï¼Œç©ºæ ¼åˆ†éš”ï¼‰ã€‚</li><li>extension.changeCase.paramï¼šChange Case'param'ï¼šè½¬æ¢ä¸ºå°å†™ï¼ŒçŸ­åˆ’çº¿å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.pascalï¼šChange Case'pascal'ï¼šè½¬æ¢ä¸ºä»¥ä¸ camelCase ç›¸åŒçš„æ–¹å¼è¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼Œä½†ç¬¬ä¸€ä¸ªå­—æ¯ä¹Ÿå¤§å†™ã€‚</li><li>extension.changeCase.pathï¼šChange Case'path'ï¼šè½¬æ¢ä¸ºå°å†™ï¼Œæ–œæ åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.sentenceï¼šæ›´æ”¹æ¡ˆä¾‹'å¥å­'ï¼šè½¬æ¢ä¸ºå°å†™ï¼Œç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.snakeï¼šæ›´æ”¹æ¡ˆä¾‹'è›‡'ï¼šè½¬æ¢ä¸ºå°å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.swapï¼šæ›´æ”¹å¤§å°å†™'swap'ï¼šè½¬æ¢ä¸ºæ¯ä¸ªå­—ç¬¦å¤§å°å†™é¢ å€’çš„å­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.titleï¼šæ›´æ”¹å¤§å°å†™'æ ‡é¢˜'ï¼šè½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå•è¯çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºå¤§å†™å­—æ¯ã€‚</li><li>extension.changeCase.upperï¼šChange Case'upper'ï¼šä»¥å¤§å†™å½¢å¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</li><li>extension.changeCase.upperFirstï¼šChange Case'upperFirst'ï¼šè½¬æ¢ä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦å¤§å†™çš„å­—ç¬¦ä¸²ã€‚</li></ul><h2 id="clang-format">Clang-Format</h2><ul><li>å®‰è£… clang-formatã€‚</li><li>æ‰“å¼€é¦–é€‰é¡¹è®¾ç½®ï¼ˆctrl + ,ï¼‰ï¼Œæœç´¢ format ï¼Œå‹¾é€‰ format on save è‡ªåŠ¨ä¿å­˜ã€‚</li><li>åœ¨é¡¹ç›®ç›®å½•ä¸‹ç¼–å†™ã€‚clang-format æ–‡ä»¶å¦‚ä¸‹ï¼Œè¿™æ ·æ¯å½“ä¿®æ”¹æ–‡ä»¶ä¿å­˜æ—¶ï¼Œå°±ä¼šä¾æ®ã€‚clang-format ä¸­è§„å®šçš„æ ¼å¼è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚</li></ul><h2 id="compareit">compareit</h2><p>ä½¿ç”¨å¿«æ·é”® ctrl é€‰ä¸­ä¸¤ä¸ªæ–‡ä»¶å³é”®å°†å·²é€‰é¡¹æ¯”è¾ƒã€‚è¿›è¡Œæ–‡ä»¶æ¯”è¾ƒæ—¶å¯æ›¿ä»£ beyond compare</p><h2 id="git-graph">Git Graph</h2><p>ç”¨è¿‡ GitLab çš„éƒ½çŸ¥é“ GitLab é‡Œçš„ git æäº¤å¯ä»¥ä»¥å›¾å½¢åŒ–æ–¹å¼æ˜¾ç¤º git åˆ†æ”¯å’Œæäº¤è®°å½•ï¼Œå…¸å‹çš„ç”¨è¿‡å°±å†å›ä¸å»äº†ï¼ŒGit Graph å¯ä»¥å¸®ä½ åœ¨ vscode é‡Œå®ç°ã€‚</p><h2 id="gitlens">GitLens</h2><p>git å¥½å¸®æ‰‹ï¼Œåšæ–¹ä¾¿çš„åœ¨äºå¯ä»¥åœ¨ vscode é‡Œæ˜¾ç¤ºå½“å‰æ”¹åŠ¨ç›¸è¾ƒäºä¸Šæ¬¡æäº¤çš„æ”¹åŠ¨ï¼Œå…¶ä»–æ“ä½œå…¶å®åœ¨ Termel é‡Œæ“ä½œä¹ æƒ¯äº†ã€‚</p><h2 id="indenticator">Indenticator</h2><p>ä¼šå°†åŒä¸€çº§çš„æ·±åº¦ç”¨ç«–çº¿å¯¹é½å±•ç¤ºï¼Œè¿™æ ·å¾ˆå®¹æ˜“çœ‹å‡ºæ¥å—ç»“æ„ã€‚</p><h2 id="vscode-icons">vscode-icons</h2><p>vscode-icons æ’ä»¶å¯ä»¥å®ç°å¯¹å„ç§æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶å‰çš„å›¾æ ‡è¿›è¡Œä¼˜åŒ–æ˜¾ç¤ºï¼Œå¥½çœ‹è¯¶ã€‚</p><h2 id="korofileheader">koroFileHeader</h2><p>KoroFileHeader æ˜¯ VScode ä¸­è‡ªåŠ¨ç”Ÿæˆç¨‹åºæ³¨é‡Šçš„ä¸€ä¸ªæ’ä»¶ã€‚ <strong>é…ç½®ï¼š</strong></p><p>å¿«æ·é”® shift+ctrl+pï¼Œæ‰“å¼€å¿«æ·æœç´¢é…ç½®ï¼Œè¾“å…¥ settingï¼Œé€‰æ‹© Open User Settingsï¼Œåœ¨ settings ä¸­æœç´¢ Fileheader.cursorModeï¼Œç‚¹å‡»ç¼–è¾‘ jsonï¼Œæ·»åŠ é…ç½®ä¿¡æ¯å³å¯ã€‚</p><h2 id="latex-preview-å’Œ-latex-language-support">Latex Preview å’Œ LaTeX language support</h2><p>latex å…¬å¼ç¼–å†™åˆ©å™¨ã€‚</p><h2 id="markdown-preview-enhanced">Markdown Preview Enhanced</h2><p>markdown å®æ—¶é¢„è§ˆï¼Œé…åˆ vscode è½»æ¾ç¼–å†™ markdown æ–‡æ¡£ã€‚</p><h2 id="one-dark-pro">One Dark Pro</h2><p>ä¸ªäººéå¸¸å–œæ¬¢çš„ä¸€æ¬¾ä¸»é¢˜ã€‚</p><h2 id="project-manager">Project Manager</h2><p>å¤šç›®å½•ï¼Œå¤šå·¥ç¨‹ç®¡ç†å¿…å¤‡å·¥å…·ï¼Œå¿«é€Ÿåˆ‡æ¢é¡¹ç›®ï¼Œå¼ºæ¨ã€‚</p><h2 id="todo-tree">Todo Tree</h2><p>ä»£åŠäº‹é¡¹åˆ©å™¨ï¼Œå¼ºæ¨ã€‚</p><h2 id="remote-ssh">Remote-SSH</h2><p>è¿™ä¸ªæ’ä»¶å¯è°“æ˜¯ Linux ç¨‹åºå‘˜ç¥å™¨ï¼Œåœ¨ç¨‹åºå¼€å‘è¿‡ç¨‹ä¸­ç¨‹åºä¸€èˆ¬è¦æ”¾åˆ°æœåŠ¡å™¨ä¸­ç¼–è¯‘ï¼Œæœ¬åœ°æœºå™¨é€šè¿‡ SSH è¿æ¥åˆ°æœåŠ¡å™¨è¿›è¡Œç¼–è¯‘å¼€å‘ï¼Œä½†æ˜¯æµè§ˆä»£ç ã€ç¼–è¾‘ä»£ç ä¸€èˆ¬é€šè¿‡ Samba æœåŠ¡å™¨å°†æœåŠ¡å™¨ä¸Šçš„ç›®å½•æ˜ å°„åˆ°æœ¬åœ°ç„¶åè¿›è¡Œç¼–è¾‘å¼€å‘ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯åœ¨æµè§ˆå¤§å‹ä»£ç çš„æ—¶å€™è®¿é—®é€Ÿåº¦å¾ˆæ…¢ï¼Œæ¯•ç«Ÿä¸æ˜¯æœ¬åœ°ä»£ç è€Œæ˜¯é€šè¿‡ç½‘ç»œè¿æ¥è¿™å¯¼è‡´æµè§ˆä»£ç é€Ÿåº¦å¾ˆæ…¢ã€‚æˆ–è€…æœ¬åœ°ä¸€ä»½ä»£ç æœåŠ¡å™¨ä¸€ä»½ä»£ç ï¼Œåœ¨æœ¬åœ°ä¿®æ”¹ç„¶åå†ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•ä¸æ¨èå®¹æ˜“å‡ºç°æœ¬åœ°ä¸æœåŠ¡å™¨ä»£ç ä¸åŒæ­¥çš„é—®é¢˜ã€‚å½“ç„¶è¿˜æœ‰ä¸€ç§æ–¹å¼ç›´æ¥é€šè¿‡ SSH ç”¨æœåŠ¡å™¨æœ¬åœ°çš„ VIM æµè§ˆç¼–è¾‘ä»£ç ï¼Œè¿™æ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ³•ã€‚</p><p>æœ¬æ–‡æä¾›ä¸€ç§æ–°çš„æ–¹æ³•ç”¨ vscode é…åˆ Remoter-SSH æ’ä»¶æ¥æµè§ˆç¼–è¾‘ä»£ç çš„æ–¹å¼ï¼Œä¹‹æ‰€ä»¥æŠŠ Remote-SSH ä½œä¸ºæœ€åä¸€ä¸ªæ’ä»¶ä»‹ç»æ˜¯å› ä¸ºå®‰è£…è¿™ä¸ªæ’ä»¶åå‰é¢çš„æ’ä»¶å¯ä»¥å†é€šè¿‡ Remote-SSH å®‰è£…ä¸€éï¼Œä¸è¿‡æ˜¯å®‰è£…åˆ°æœåŠ¡å™¨è€Œä¸æ˜¯æœ¬åœ°ï¼Œè¿™æ ·åœ¨æµè§ˆä»£ç çš„æ—¶å€™å°±å¯ä»¥å……åˆ†åˆ©ç”¨æœåŠ¡å™¨çš„æ€§èƒ½åŠ é€Ÿä»£ç è®¿é—®é€Ÿåº¦ï¼Œå°¤å…¶åœ¨ä»£ç è·³è½¬ä¸Šå¯ä»¥æå¤§åŠ é€Ÿä»£ç è·³è½¬é€Ÿåº¦ã€‚</p><h1 id="windows-å¸¸ç”¨è½¯ä»¶åˆ—è¡¨">Windows å¸¸ç”¨è½¯ä»¶åˆ—è¡¨</h1><h2 id="ç”µè·¯è®¾è®¡">ç”µè·¯è®¾è®¡</h2><ul><li><strong>Altium Desginer</strong></li><li><strong>Cadence allegro</strong></li><li><strong>KiCad</strong></li><li><strong>EAGLE</strong></li></ul><h2 id="è½¯ä»¶è®¾è®¡">è½¯ä»¶è®¾è®¡</h2><ul><li><strong>atlab</strong></li><li><strong>visual studio</strong></li><li><strong>VSCode</strong></li><li><strong>NotePad++</strong></li><li><strong>Xshell</strong></li><li><strong>QT</strong></li><li><strong>Keil</strong></li><li><strong>ST Cubemx</strong></li><li><strong>Beyond Compare</strong></li><li><strong>Everything</strong></li><li><strong>Docker</strong></li></ul><h2 id="d-ç»˜å›¾">3D ç»˜å›¾</h2><ul><li><strong>Fusion360</strong></li></ul><h2 id="base">Base</h2><ul><li><strong>rufus</strong></li><li><strong>diskgenius</strong></li><li><strong>balenaEtcher</strong></li><li><strong>Pot Player</strong></li><li><strong>7zip</strong></li><li><strong>Wireshark</strong></li></ul><h2 id="video">Video</h2><ul><li><strong>YUV Player</strong></li><li><strong>MediaInfo</strong></li><li><strong>ImageJ</strong></li><li><strong>ElecardStreameye</strong></li><li><strong>EasyICE</strong></li></ul><h1 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h1><p><span class="exturl" data-url="aHR0cHM6Ly9zc3BhaS5jb20vcG9zdC81Njc3Nw==">https://sspai.com/post/56777<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9zc3BhaS5jb20vcG9zdC81NzExMA==">https://sspai.com/post/57110<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NTAwODY0OQ==">https://zhuanlan.zhihu.com/p/95008649<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzk4MjU2NDU=">https://zhuanlan.zhihu.com/p/379825645<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODYwNDEzNTI=">https://zhuanlan.zhihu.com/p/386041352<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMjY0Njc0L2FydGljbGUvZGV0YWlscy84MjQ5MjE3Ng==">https://blog.csdn.net/qq_41264674/article/details/82492176<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTYxNDMzOTY=">https://zhuanlan.zhihu.com/p/356143396<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yODgwNGJjZjZkM2Y=">https://www.jianshu.com/p/28804bcf6d3f<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Share </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ç§ç”¨äºå®æ—¶è§†é¢‘ç¨³å®šçš„æ–°å‹ç›¸æœºè·¯å¾„è§„åˆ’ç®—æ³•</title>
      <link href="/2021/Science/ANovelCameraPathPlanningAlgorithmForRealTimeVideoStabilization/"/>
      <url>/2021/Science/ANovelCameraPathPlanningAlgorithmForRealTimeVideoStabilization/</url>
      
        <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1><p>è§†é¢‘ç¨³å®šæ ¹æ®è¿åŠ¨æ¨¡å‹åˆ†ä¸º 2D å’Œ 3D æ–¹æ³•ã€‚ ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ 2D è§†é¢‘ç¨³å®š [2]ï¼Œå®ƒä½¿ç”¨ 2D è¿åŠ¨æ¨¡å‹ï¼ˆä¾‹å¦‚ç®€å•çš„å¹³ç§»æ¨¡å‹ã€2D åˆšæ€§æ¨¡å‹å’Œ 2D ä»¿å°„æ¨¡å‹ [3-12]ï¼‰æè¿°ä¸¤ä¸ªè¿ç»­å¸§ä¹‹é—´çš„å…³ç³»ã€‚ å¦‚æœç›¸æœºåœ¨ 3D ç©ºé—´ä¸­æ²¿ x è½´å’Œ y è½´çš„æ—‹è½¬å¾ˆå°ï¼Œåˆ™ 2D è§†é¢‘ç¨³å®šå¯æä¾›è‰¯å¥½çš„æ€§èƒ½ [13]ã€‚ ç„¶è€Œï¼Œéšç€ç›¸æœºè¿åŠ¨å˜å¾—åŠ¨æ€ï¼ŒäºŒç»´è¿åŠ¨æ¨¡å‹æ— æ³•æè¿°è¿ç»­å¸§ä¹‹é—´çš„å‡ ä½•å…³ç³»ï¼Œæ€§èƒ½éå¸¸æœ‰é™ã€‚ lee ç­‰ æå‡ºäº†ä¸€ç§æ— éœ€æ˜ç¡®ä¼°è®¡ç›¸æœºè¿åŠ¨å³å¯ç›´æ¥ç¨³å®šè§†é¢‘çš„æ–¹æ³• [14]ã€‚ è¯¥æ–¹æ³•æ‰¾åˆ°ä¸€ç»„å˜æ¢æ¥å¹³æ»‘ç‰¹å¾è½¨è¿¹ [15, 16] å¹¶ç¨³å®šè§†é¢‘ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯ Buehler ç­‰äººå¼•å…¥çš„ 3D è§†é¢‘ç¨³å®š [17]ã€‚æ—©æœŸçš„ 3D æ–¹æ³•ä½¿ç”¨æ¥è‡ªè¿åŠ¨çš„ç»“æ„ (SFM) æŠ€æœ¯é‡å»ºåœºæ™¯å’Œç›¸æœºè¿åŠ¨çš„ 3D æ¨¡å‹ [18]ã€‚ç„¶ååœ¨æ–°çš„ 3D ç›¸æœºè·¯å¾„ä¸Šæ¸²æŸ“ç¨³å®šçš„è§†å›¾ [17, 19]ã€‚ 3D è§†é¢‘ç¨³å®šæä¾›æ¯” 2D æ–¹æ³•æ›´å¥½çš„æ€§èƒ½ã€‚ç”±äºè¿™äº› 3D æ–¹æ³•åœ¨å¤„ç†ç¼ºä¹è§†å·®çš„è§†é¢‘æ—¶ç»å¸¸å¤±è´¥ï¼Œå› æ­¤å®ƒä»¬åœ¨è®¸å¤šæƒ…å†µä¸‹å¹¶ä¸å®ç”¨ [20]ã€‚ Liu æå‡ºäº†ç»“åˆ 2D å’Œ 3D è§†é¢‘ç¨³å®šä¼˜ç‚¹çš„å­ç©ºé—´è§†é¢‘ç¨³å®š [21]ï¼Œç„¶è€Œï¼Œç”±äºé•¿ç‰¹å¾è½¨è¿¹çš„æ•°é‡ä¸è¶³ï¼Œè¿™ç§æ–¹æ³•å¯¹äºåŒ…å«åŠ¨æ€è¿åŠ¨çš„è§†é¢‘é€šå¸¸ä¼šå¤±è´¥ [20]ã€‚å› æ­¤ï¼ŒWang [20] é’ˆå¯¹ 3D é‡å»ºå›°éš¾æˆ–é•¿ç‰¹å¾è½¨è¿¹ä¸å¯ç”¨çš„è§†é¢‘æå‡ºäº†è§†é¢‘ç¨³å®šã€‚Liu ç­‰äºº [22] æå‡ºäº†ä¸€ç§è¿åŠ¨æ¨¡å‹ SteadyFlowï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡å¼ºåˆ¶å¼ºç©ºé—´ç›¸å¹²æ€§çš„ç‰¹å®šå…‰æµã€‚Grundmann ç­‰äººåŸºäºå•åº”æ€§æ··åˆæ¨¡å‹ [23]ï¼Œæå‡ºäº†å…æ ¡å‡†æ»šåŠ¨å¿«é—¨å»æŠ–ã€‚ Dong æå‡ºäº†ä½¿ç”¨åŸºäºå¸§é—´å•åº”æ€§ä¼°è®¡çš„è¿åŠ¨æ¨¡å‹çš„å®æ—¶åº”ç”¨è§†é¢‘ç¨³å®š [24]ã€‚Ringaby ç­‰äººæå‡ºäº†ä¸€ç§é€šè¿‡å°†ç›¸æœºæ—‹è½¬å‚æ•°åŒ–ä¸ºè¿ç»­æ›²çº¿æ¥æ ¡æ­£å’Œç¨³å®šè§†é¢‘çš„æ–¹æ³• [25]ã€‚Karpendo ç­‰äººå»ºè®®ä½¿ç”¨é™€èºä»ªè¿›è¡Œè§†é¢‘ç¨³å®šå’Œæ»šåŠ¨å¿«é—¨æ ¡æ­£ [26]ã€‚ Lee æå‡ºäº†åŸºäºäººç±»è§†è§‰ç³»ç»Ÿçš„è§†é¢‘ç¨³å®š [27]ã€‚</p><span id="more"></span><h1 id="background">Background</h1><p>ä¸ºä¾¿äºè§£é‡Šï¼Œæœ¬æ–‡æè¿°äº†åœ¨ç®€å•è§†é¢‘ç¨³å®šä¸‹ç›¸æœºè·¯å¾„è§„åˆ’çš„å»ºè®®ç®—æ³•ï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚ ä¸åŒçš„è¿åŠ¨æ¨¡å‹ï¼Œå¦‚å•åº”æ€§ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc1.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc2.png"></p><p>æ‰‹æŒç›¸æœºæ‹æ‘„çš„è§†é¢‘çš„åŸå§‹ç›¸æœºè·¯å¾„é€šå¸¸æ˜¯ä¸ç¨³å®šçš„ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚ä¸ºäº†æä¾›ç¨³å®šçš„è¾“å‡ºè§†é¢‘ï¼Œæœ‰å¿…è¦ä»åŸå§‹ç›¸æœºè·¯å¾„é¢„æµ‹å¹³æ»‘çš„ç›¸æœºè·¯å¾„ã€‚ä¼°è®¡å¹³æ»‘ç›¸æœºè·¯å¾„çš„æœ€ç®€å•æ–¹æ³•æ˜¯å¯¹åŸå§‹ç›¸æœºè·¯å¾„åº”ç”¨ä½é€šæ»¤æ³¢å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span class="math display">\[P_N(t) = \sum_{k} w(k)P_o(k)  \tag1\]</span></p><p>è¿™é‡Œï¼Œ<span class="math inline">\(P_O(t)\)</span> å’Œ <span class="math inline">\(P_N(t)\)</span> åˆ†åˆ«è¡¨ç¤ºåŸå§‹å’Œæ–°çš„ç›¸æœºä½ç½®ã€‚ <span class="math inline">\(w(k)\)</span> æ˜¯ä½é€šæ»¤æ³¢å™¨çš„ç¬¬ k ä¸ªç³»æ•°ã€‚ ç”±äºä¸Šè¿°ç†æƒ³æ»¤æ³¢å™¨éœ€è¦æ— é™å¤šçš„ä¿¡å·ï¼Œå› æ­¤æ— æ³•å®ç°ã€‚ å®é™…ä¸Šï¼Œä½é€šæ»¤æ³¢å™¨åº”è¯¥è€ƒè™‘æœ‰é™æ•°é‡çš„ä¿¡å·ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨å®æ—¶åº”ç”¨ä¸­è€ƒè™‘ä¾èµ–äºè¿‡å»å’Œç°åœ¨å¸§çš„ç›¸æœºä½ç½®çš„ä¸´æ—¶è¿‡æ»¤å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><span class="math display">\[P_N(t) = \sum_{k=0}{k=t} w(k)P_o(k) \tag2\]</span></p><p>å›¾ 2 æ˜¾ç¤ºäº†å°†ä¸´æ—¶ä½é€šæ»¤æ³¢å™¨åº”ç”¨äºæ²¿ x æ–¹å‘çš„ç›¸æœºè·¯å¾„çš„ç»“æœï¼Œä½é€šæ»¤æ³¢å™¨æ˜¾ç€å¹³æ»‘äº†ç›¸æœºè·¯å¾„ã€‚ åœ¨è¿™é‡Œï¼Œå›¾ 2 ä¸­åŸå§‹å’Œæ–°ç›¸æœºè·¯å¾„ä¹‹é—´çš„å·®å¼‚å¯ä»¥è§£é‡Šä¸ºå›¾ 1 ä¸­æ‰€ç¤ºçš„è£å‰ªçª—å£åç§»é‡ã€‚å¦‚æœåç§»é‡æ˜¯è¶…è¿‡è¾¹è·çš„å®½åº¦æˆ–é«˜åº¦ï¼Œè£å‰ªçª—å£å°†ä¸é€‚åˆåŸå§‹æ¡†æ¶ã€‚ å®½åº¦å’Œé«˜åº¦ä½™é‡ï¼ˆMW å’Œ MHï¼‰å®šä¹‰å¦‚ä¸‹ã€‚</p><p><span class="math display">\[M_W = \frac{W_I - W_O}{2}, M_H = \frac{H_I - H_O}{2} \tag3\]</span></p><p>å…¶ä¸­<span class="math inline">\(W_Iã€H_I\)</span>å’Œ<span class="math inline">\(W_Oã€H_O\)</span>åˆ†åˆ«æ˜¯åŸå§‹å¸§å’Œè¾“å‡ºå¸§çš„å®½åº¦å’Œé«˜åº¦ã€‚ å‡ºç•ŒåŒºåŸŸå°†ä¸å¯è§æˆ–éœ€è¦è¿åŠ¨ä¿®å¤ [10, 33]ã€‚ è¾¹ç•Œå¦‚å›¾ 3 æ‰€ç¤ºã€‚åœ¨å›¾ä¸­ï¼Œç°è‰²åŒºåŸŸè¯´æ˜äº†ç•Œå¤–åŒºåŸŸçš„ç¤ºä¾‹ã€‚ å¯¹äºå®æ—¶åº”ç”¨ï¼Œç”±äºå¤æ‚æ€§ï¼Œè¿åŠ¨ä¿®å¤ä¸æ˜¯ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚ å› æ­¤ï¼Œåº”ç¡®å®šæ–°çš„ç›¸æœºè·¯å¾„ï¼Œä»¥ä¾¿è£å‰ªçª—å£ä½äºåŸå§‹å¸§å†…ã€‚ ç„¶è€Œï¼ŒåŸºäºä½é€šæ»¤æ³¢å™¨çš„æ–¹æ³•ä¸­çš„è£å‰ªçª—å£åç§»é‡æ˜¯ä¸å¯æ§çš„ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ä¸èƒ½ä¿è¯è£å‰ªçª—å£æ€»æ˜¯ä½äºåŸå§‹å¸§å†…ã€‚ å› æ­¤ï¼Œè¿™ç§ç®€å•çš„æ–¹æ³•ä¸èƒ½åº”ç”¨äºè¾“å‡ºè§†é¢‘å¤§å°å›ºå®šçš„å®æ—¶è§†é¢‘ç¨³å®šã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc3.png"></p><p>åœ¨åæœŸå¤„ç†è§†é¢‘ç¨³å®šä¸­ï¼Œåœ¨è§„åˆ’æ–°çš„ç›¸æœºè·¯å¾„ä¹‹å‰ç»™å‡ºæ•´ä¸ªåŸå§‹ç›¸æœºè·¯å¾„ã€‚ å› æ­¤ï¼Œå¯ä»¥ä¼˜åŒ–è§„åˆ’å¹³æ»‘çš„ç›¸æœºè·¯å¾„ï¼Œä»è€Œä¸ä¼šå‡ºç°è¶Šç•ŒåŒºåŸŸã€‚ç„¶è€Œï¼Œç”±äºå®æ—¶è§†é¢‘ç¨³å®šä¸­åç»­å¸§çš„æ‘„åƒæœºä½ç½®æ˜¯æœªçŸ¥çš„ï¼Œå› æ­¤æœ‰æ—¶éš¾ä»¥æ­£ç¡®ç¡®å®šå½“å‰å¸§çš„æ‘„åƒæœºä½ç½®ã€‚å›¾ 4 ä¸¾ä¾‹è¯´æ˜äº†ä¸ºå®æ—¶è§†é¢‘ç¨³å®šè§„åˆ’ç›¸æœºè·¯å¾„çš„å›°éš¾ã€‚åœ¨å›¾ 4a ä¸­ï¼Œæ— æ³•é¢„æµ‹ç›¸æœºè·¯å¾„åœ¨åç»­å¸§ä¸­æ˜¯ä¸Šå‡è¿˜æ˜¯ä¸‹é™ã€‚å¦‚æœç›¸æœºè·¯å¾„åœ¨åç»­å¸§ä¸­å‘ä¸‹è¡Œè¿›ï¼Œåˆ™æ–°çš„ç›¸æœºè·¯å¾„å¯ä»¥æ˜¯ç›´çš„ï¼Œå¦‚å›¾ 4b æ‰€ç¤ºã€‚å¦‚æœç›¸æœºè·¯å¾„åœ¨åç»­å¸§ä¸­å‘ä¸Šç§»åŠ¨ï¼Œåˆ™æ–°ç›¸æœºè·¯å¾„çš„æ–¹å‘åº”è¯¥æ”¹å˜ï¼Œå¦‚å›¾ 4c æ‰€ç¤ºã€‚è¿™ç§çªç„¶çš„ç§»åŠ¨ä¼šé™ä½ç¨³å®šè§†é¢‘çš„è§†è§‰è´¨é‡ã€‚å¦ä¸€æ–¹é¢ï¼Œç”±äºæ•´ä¸ªåŸå§‹ç›¸æœºè·¯å¾„æ˜¯åœ¨åå¤„ç†è§†é¢‘ç¨³å®šä¸­ç»™å‡ºçš„ï¼Œå› æ­¤å¯ä»¥å¦‚å›¾ 4d æ‰€ç¤ºè§„åˆ’æ–°çš„ç›¸æœºè·¯å¾„ã€‚å¦‚æœ¬ä¾‹æ‰€ç¤ºï¼Œå¦‚æœæ²¡æœ‰åç»­å¸§çš„æ‘„åƒæœºä½ç½®ï¼Œå®æ—¶è§†é¢‘ç¨³å®šæ˜¯å¾ˆå›°éš¾çš„ã€‚æ‘„åƒæœºè·¯å¾„è§„åˆ’åœ¨å®æ—¶è§†é¢‘ç¨³å®šæ–¹é¢çš„æ€§èƒ½å°†ä¸å¯é¿å…åœ°å—åˆ°é™åˆ¶ã€‚å› æ­¤ï¼Œç”¨äºå®æ—¶è§†é¢‘ç¨³å®šçš„ç›¸æœºè·¯å¾„è§„åˆ’æ˜¯ä¸€ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„é—®é¢˜ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc4.png"></p><h1 id="methodcamera-path-planning">Methodâ€”camera path planning</h1><h2 id="framework-of-the-proposed-algorithm">Framework of the proposed algorithm</h2><p>åœ¨è§„åˆ’ç›¸æœºè·¯å¾„æ—¶è¦è€ƒè™‘çš„ç¬¬ä¸€ä¸ªå±æ€§æ˜¯æä¾›æ’å®šçš„ç›¸æœºè·¯å¾„ã€‚æ’å®šçš„ç›¸æœºè·¯å¾„è¡¨ç¤ºä¸€æ¡æ–œç‡ä¸ºé›¶çš„çº¿ã€‚ä¸‹ä¸€ä¸ªå±æ€§æ˜¯çº¿æ€§ç›¸æœºè·¯å¾„ï¼Œå…¶ä¸­ç›¸æœºå…·æœ‰æ’å®šé€Ÿåº¦ã€‚è™½ç„¶çº¿æ€§ç›¸æœºè·¯å¾„çš„æ–œç‡ä¸ä¸ºé›¶ï¼Œä½†çº¿æ€§è·¯å¾„ä¹Ÿæ˜¯ä¸€æ¡çº¿ã€‚è™½ç„¶è¿™ä¸¤ä¸ªå±æ€§çš„ç‰©ç†å«ä¹‰åœ¨ç›¸æœºè¿åŠ¨æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œä½†æ’å®šå’Œçº¿æ€§ç›¸æœºè·¯å¾„çš„å½¢çŠ¶åŸºæœ¬ä¸Šæ˜¯ä¸€æ¡çº¿ã€‚å› æ­¤ï¼Œæ‰€æå‡ºçš„ç®—æ³•å°†çº¿è§†ä¸ºåœ¨ç›¸æœºè·¯å¾„ä¸­è¿½æ±‚çš„åŸºæœ¬ç‰¹å¾ã€‚</p><p>æ‰€æå‡ºçš„ç®—æ³•é¦–å…ˆåœ¨æ–°çš„ç›¸æœºè·¯å¾„ä¸Šæ‰¾åˆ°é€šè¿‡æœ€åä¸€ä¸ªç›¸æœºä½ç½®çš„æ‰€æœ‰å¯èƒ½çš„å€™é€‰çº¿ï¼Œå¦‚å›¾ 6 æ‰€ç¤ºã€‚ç”±äºæ–°çš„ç›¸æœºè·¯å¾„åº”è¯¥æ˜¯è¿ç»­çš„ï¼Œå€™é€‰çº¿åº”è¯¥ä»ç¬¬ï¼ˆ n âˆ’ 1) å¸§ï¼Œå®ƒæ˜¯æ–°ç›¸æœºè·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªç›¸æœºä½ç½®ã€‚ç„¶åå®ƒä»¬åœ¨ç¬¬ (n + K) å¸§çš„ä¸Šä¸‹è¾¹ç•Œä¹‹é—´ç»“æŸã€‚æ‰€æœ‰å¯èƒ½çš„å€™é€‰çº¿åœ¨ç¬¬ (n+K) å¸§ä»¥ç›¸é‚»å€™é€‰çº¿ä¹‹é—´çš„é—´éš”ä¸º 1 çš„æ–¹å¼ç”Ÿæˆã€‚å›¾ä¸­ï¼Œå½“å‰å¸§ï¼ˆæˆ–ç¬¬ n å¸§ï¼‰çš„ç›¸æœºä½ç½®å°šæœªç¡®å®šï¼Œç¼“å†²çš„å¸§èŒƒå›´ä»ç¬¬ (n+1) å¸§åˆ°ç¬¬ (n+K) å¸§ã€‚å¯ä»¥é¢„å…ˆé¢„æµ‹ç¼“å†²å¸§çš„ç›¸æœºè¿åŠ¨ï¼Œä»è€Œå¯ä»¥ç¡®å®šç¼“å†²å¸§å¤„çš„åŸå§‹ç›¸æœºä½ç½®å’Œè¾¹ç•Œã€‚å› æ­¤ï¼Œå€™é€‰çº¿çš„ç«¯ç‚¹ç®€å•åœ°ä½äºç¬¬ (n+K) å¸§çš„ä¸¤ä¸ªè¾¹ç•Œä¹‹é—´ã€‚ç„¶åï¼Œæ‰€æå‡ºçš„ç®—æ³•ä½¿ç”¨å°†åœ¨ä¸‹ä¸€å°èŠ‚ä¸­æè¿°çš„æ‰€æå‡ºçš„æˆæœ¬å‡½æ•°æ£€æŸ¥æœç´¢èŒƒå›´å†…æ‰€æœ‰å¯èƒ½çš„å€™é€‰çº¿ï¼Œé€‰æ‹©æˆæœ¬æœ€ä½çš„å€™é€‰çº¿ä½œä¸ºæœ€ä½³çº¿ã€‚æœ€åï¼Œæ ¹æ®æœ€ä½³çº¿è®¡ç®—å½“å‰å¸§çš„ç›¸æœºä½ç½®ï¼Œè¯·æ³¨æ„ï¼Œç¼“å†²å¸§å¤„çš„ç›¸æœºä½ç½®ä¸å±äºæ–°çš„ç›¸æœºè·¯å¾„ã€‚</p><p>å¦‚æœå€™é€‰çº¿ç©¿è¿‡ç•Œå¤–åŒºåŸŸï¼Œåˆ™ä¸åº”å°†å…¶é€‰ä¸ºæœ€ä½³çº¿ã€‚ å›¾ 7 æç»˜äº†ä¸åº”é€‰æ‹©çš„å€™é€‰è¡Œçš„ç¤ºä¾‹ã€‚ åœ¨å›¾ 7a ä¸­ï¼ŒåŒºåŸŸ R ä¸­çš„å€™é€‰çº¿é€šè¿‡äº†ç•Œå¤–åŒºåŸŸã€‚ å› æ­¤ï¼Œä¸åº”é€‰æ‹©åŒºåŸŸ R ä¸­çš„ä»»ä½•å€™é€‰çº¿ä½œä¸ºæœ€ä½³çº¿ã€‚ æœ‰æ—¶ï¼Œæœç´¢èŒƒå›´å†…çš„æ‰€æœ‰å€™é€‰çº¿éƒ½ç»è¿‡ç•Œå¤–åŒºåŸŸï¼Œå¦‚å›¾ 7b æ‰€ç¤ºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“æ‰¾ä¸åˆ°æœ€ä½³è¡Œæ—¶ï¼ŒK çš„å€¼å‡ 1ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ä½³è¡Œã€‚</p><h2 id="cost-function">Cost function</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc6.png"></p><p>æ‰€æå‡ºçš„ç®—æ³•é€‰æ‹©å…·æœ‰æœ€å°æˆæœ¬çš„å€™é€‰çº¿ä½œä¸ºæœ€ä½³çº¿ã€‚ ç¬¬ n å¸§ç¬¬ i æ¡å€™é€‰çº¿çš„ä»£ä»·å‡½æ•°å®šä¹‰å¦‚ä¸‹ã€‚</p><p><span class="math display">\[C(n,i) = w_1C_s(n,i) + w_2C_L(n,i) + w_3C_M(n,i) \tag4\]</span></p><p>å…¶ä¸­ï¼Œw1ã€w2 å’Œ w3 æ˜¯æƒé‡å› å­ã€‚ CS(n, i) å®šä¹‰å¦‚ä¸‹ã€‚</p><p><span class="math display">\[C_S(n,i) = |S(n,i)| \tag5\]</span></p><p><span class="math inline">\(S(n, i)\)</span> æ˜¯ç¬¬ i æ¡å€™é€‰çº¿åœ¨ç¬¬ n å¸§çš„æ–œç‡ã€‚ å€™é€‰çº¿çš„é›¶æ–œç‡è¡¨ç¤ºæ²¡æœ‰ç›¸æœºç§»åŠ¨ã€‚ å› æ­¤<span class="math inline">\(C_S(n, i)\)</span>å¯ä»¥è§£é‡Šä¸ºè¿½æ±‚é™æ€ç›¸æœºè·¯å¾„çš„æœ¯è¯­ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªå±æ€§ã€‚ å¦‚æœå€™é€‰çº¿çš„æ–œç‡é™¡å³­ï¼Œåˆ™æ­¤é¡¹å˜å¤§ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc7.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc8.png"></p><p><span class="math inline">\(C_L(n,i)\)</span>å®šä¹‰å¦‚ä¸‹ï¼š</p><p><span class="math display">\[C_L(n,i) = |S(n,i) - S(n-1, i_{n-1}^{min})| \tag6\]</span></p><p>è¿™é‡Œï¼Œ<span class="math inline">\(i_{n-1}^{min}\)</span>æ˜¯ç¬¬ (n-1) å¸§çš„æœ€ä½³è¡Œçš„ç´¢å¼•ã€‚ å› æ­¤<span class="math inline">\(S(n âˆ’ 1,i_{n-1}^{min})\)</span>è¡¨ç¤ºåœ¨ç¬¬ (n âˆ’ 1) å¸§çš„æœ€ä½³çº¿çš„æ–œç‡ã€‚ å¦‚æœå½“å‰å¸§çš„å€™é€‰çº¿çš„æ–œç‡ä¸å‰ä¸€å¸§çš„æœ€ä½³çº¿çš„æ–œç‡ç›¸åŒï¼Œåˆ™<span class="math inline">\(C_L(n, i)\)</span>å°†ä¸ºé›¶ã€‚ å¯ä»¥ç†è§£ä¸ºï¼Œè¯¥æœ¯è¯­æ—¨åœ¨ä¿æŒç›¸æœºè·¯å¾„çš„çº¿æ€§ï¼Œè¿™æ˜¯ç¬¬äºŒä¸ªå±æ€§ã€‚</p><p>å¦‚æœç›¸æœºè·¯å¾„è§„åˆ’æ–¹æ³•åˆ©ç”¨ä¸Šä¸‹è¾¹ç•Œä½œä¸ºç®€å•çš„çº¦æŸï¼Œè™½ç„¶çº¦æŸä¼šé˜»æ­¢æ–°çš„ç›¸æœºè·¯å¾„è¶…è¿‡å¯ç”¨çš„å›¾åƒè¾¹ç¼˜ï¼Œä½†æ–°çš„ç›¸æœºä½ç½®æœ‰æ—¶ä¼šéå¸¸æ¥è¿‘ä¸‹è¾¹ç•Œï¼Œä¾‹å¦‚æ–°çš„ç›¸æœºä½ç½® å¯¹äºå›¾ 4a ä¸­çš„å½“å‰å¸§ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåŸæ¥çš„ç›¸æœºè·¯å¾„å‘ä¸Šè¡Œè¿›ï¼ˆæƒ…å†µ aï¼‰ï¼Œç”±äºå‘ä¸‹æ–¹å‘æ²¡æœ‰å›¾åƒè¾¹ç¼˜ï¼Œæ–°çš„ç›¸æœºè·¯å¾„åº”è¯¥çªç„¶æ”¹å˜æ–¹å‘ä¸ºå‘ä¸Šã€‚ æ–°ç›¸æœºè·¯å¾„ä¸Šçš„è¿™ç§çªç„¶ç§»åŠ¨ä¼šé™ä½ç¨³å®šè§†é¢‘çš„è§†è§‰è´¨é‡ã€‚ ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæœ¬æ–‡è€ƒè™‘äº†ä¸€ä¸ªæ–°çš„<span class="math inline">\(C_M(n, i)\)</span>é¡¹æ¥ä¿ç•™ä¸Šä¸‹æ–¹å‘çš„å¯ç”¨å›¾åƒè¾¹è·ã€‚</p><p><span class="math display">\[\begin{aligned}C_M(n,i) = \sum_{k=n}^{n+K} (F_{LO}(k,i) + F_{UP}(k,i)) \\&amp;F_{UP}(k,i) = \frac{1}{max(0.01,P_O(n) + M_{UP} - P_N^i(n))^2}  \\&amp;F_{LO}(k,i) = \frac{1}{max(0.01, P_N^i(n) - P_O(n) + M_{UP})^2}\end{aligned}  \tag7\]</span></p><p>å…¶ä¸­<span class="math inline">\(P^i_N(n)\)</span>æ˜¯ç¬¬ i æ¡å€™é€‰çº¿ä¸Šç¬¬ n å¸§çš„ç›¸æœºä½ç½®ã€‚<span class="math inline">\(M_{LO}\)</span> å’Œ<span class="math inline">\(M_{UP}\)</span> åˆ†åˆ«æ˜¯ä¸‹è¾¹è·å’Œä¸Šè¾¹è·çš„å¤§å°ï¼Œè¿™äº›è¾¹è·é€šå¸¸è®¾ç½®ä¸ºç›¸åŒçš„å€¼ã€‚<span class="math inline">\(P_O(n)+M_{UP}âˆ’P_N^i(n)ï¼ˆæˆ– P_N^i(n)+ M_{LO}âˆ’P_O(n)ï¼‰\)</span>æ˜¯<span class="math inline">\(P_N^i(n)\)</span>ä¸ä¸Šè¾¹ç•Œï¼ˆæˆ–ä¸‹è¾¹ç•Œï¼‰ä¹‹é—´çš„æ¬§å‡ é‡Œå¾·è·ç¦»ï¼Œå¦‚å›¾ 8 æ‰€ç¤ºã€‚è¿™é‡Œï¼Œ0.01 è¢«è®¤ä¸ºæ˜¯ä¸ºäº†é˜²æ­¢è¢«é›¶é™¤ã€‚å¦‚æœ<span class="math inline">\(P^i_N(n)\)</span>é è¿‘ä¸Šè¾¹ç•Œï¼ˆæˆ–ä¸‹è¾¹ç•Œï¼‰ï¼Œåˆ™<span class="math inline">\(F_{UP}(n, i)ï¼ˆæˆ– F_{LO}(n, i)ï¼‰\)</span>çš„å€¼å°†å˜å¾—éå¸¸å¤§ã€‚å¦‚æœ<span class="math inline">\(P_N^i(n)\)</span>è¿œç¦»ä¸Šè¾¹ç•Œï¼ˆæˆ–ä¸‹è¾¹ç•Œï¼‰ï¼Œåˆ™<span class="math inline">\(F_{UP}(n, i)ï¼ˆæˆ– F_{LO}(n, i)ï¼‰\)</span>çš„å€¼å°†å˜å¾—éå¸¸å°ã€‚å½“<span class="math inline">\(P_N^i(n)\)</span>ä½äºè·ç¦»ä¸¤ä¸ªè¾¹ç•Œç­‰è·çš„ä½ç½®æ—¶ï¼Œ<span class="math inline">\((F_{UP}(n, i)+F_{LO}(n, i))\)</span>å°†è·å¾—æœ€å°å€¼ã€‚å› æ­¤ï¼Œ<span class="math inline">\(F_{UP}(n, i)\)</span>å’Œ<span class="math inline">\(F_{LO}(n, i)\)</span>å¯ä»¥è§£é‡Šä¸ºä»è¾¹ç•Œæ¨åŠ¨ç›¸æœºä½ç½®ä»¥ä¿æŒå›¾åƒè¾¹ç¼˜çš„åŠ›ã€‚<span class="math inline">\(C_M(n, i)\)</span>åœ¨ç¬¬ i æ¡å€™é€‰çº¿ä¸Šçš„ç›¸æœºä½ç½®å¤„ç´¯ç§¯æ‰€æœ‰<span class="math inline">\(F_{UP}(n, i)\)</span>å’Œ<span class="math inline">\(F_{LO}(n, i)\)</span>ã€‚ç›¸æœºä½ç½®ä¸èƒ½ä½äºè¾¹ç•Œä¹‹å¤–ã€‚å¦‚æœ K å€¼å‡å°<span class="math inline">\(C_M(n, i)\)</span>æˆä¸ºåœ¨å®æ—¶è§†é¢‘ç¨³å®šä¸­å®ç°é«˜è´¨é‡æ–°ç›¸æœºè·¯å¾„çš„é‡è¦æœ¯è¯­ã€‚å®éªŒç»“æœåœ¨ç¬¬ 4 èŠ‚ä¸­ç»™å‡ºäº†è¯¦ç»†ä¿¡æ¯ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anc9.png"></p><p>è®©æˆ‘ä»¬ç®€è¦åœ°è€ƒè™‘ä¸€ä¸‹æ‰€æå‡ºæ–¹æ³•çš„è®¡ç®—è¿‡ç¨‹ã€‚æ‰€æå‡ºç®—æ³•çš„ç¬¬ä¸€æ­¥æ˜¯å¯»æ‰¾å€™é€‰çº¿ã€‚è¿™å¯ä»¥é€šè¿‡è·å–ä»ç¬¬ (n - 1) ä¸ªæ‘„åƒæœºä½ç½®è¿æ¥åˆ°æœç´¢èŒƒå›´å†…çš„ç‚¹çš„çº¿æ¥ç®€å•åœ°å®ç°ï¼Œå¦‚å›¾ 6 æ‰€ç¤ºã€‚ä¸‹ä¸€æ­¥æ¶‰åŠæ’é™¤åŒ…å«åœ¨å¤–çš„å€™é€‰çº¿è¾¹ç•ŒåŒºåŸŸï¼Œå¦‚å›¾ 7 æ‰€ç¤ºã€‚ å¦‚æœç¬¬ i æ¡å€™é€‰çº¿ï¼ˆæˆ– <span class="math inline">\(P^i_N(n)\)</span>ï¼‰ä¸Šçš„ä»»ä½•ç‚¹ä¸åœ¨<span class="math inline">\(P_O(n) âˆ’ M_{LO}\)</span>åˆ°<span class="math inline">\(P_O(n) + M_{UP}\)</span>ä¹‹é—´ï¼Œåˆ™å¯¹åº”çš„å€™é€‰çº¿åº”ä¸ºæ’é™¤åœ¨å¤–ã€‚åœ¨æœ€åä¸€æ­¥ï¼Œè¯¥æ–¹æ³•æ ¹æ®ç­‰å¼è¯„ä¼°æ¯ä¸ªå€™é€‰è¡Œ (4) å¹¶æ‰¾åˆ°æˆæœ¬æœ€ä½çš„å€™é€‰è¡Œã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œæ‰€æå‡ºçš„ç®—æ³•éœ€è¦å¤šæ¬¡ç®—æœ¯è¿ç®—å’Œæ¯”è¾ƒæ¥è§„åˆ’å½“å‰å¸§æ–°ç›¸æœºè·¯å¾„çš„æ–°ç›¸æœºä½ç½®ï¼Œä¸è§†é¢‘ç¨³å®šçš„è®¡ç®—è´Ÿæ‹…ç›¸æ¯”ï¼Œå…¶è®¡ç®—è¿‡ç¨‹æä½ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>&lt; A novel camera path planning algorithm for real-time video stabilization &gt;</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºé™€èºä»ªçš„è§†é¢‘ç¨³å®šéçº¿æ€§æ»¤æ³¢å™¨</title>
      <link href="/2021/Science/GyroscopeBasedNonlinearFilterForVideoStabilization/"/>
      <url>/2021/Science/GyroscopeBasedNonlinearFilterForVideoStabilization/</url>
      
        <content type="html"><![CDATA[<h1 id="abstract">Abstract</h1><p>æˆ‘ä»¬æå‡ºäº†ä¸€ç§å¯¹ç§»åŠ¨è®¾å¤‡ä¸Šæ•è·çš„è§†é¢‘è¿›è¡Œè§†é¢‘ç¨³å®šå’Œæ»šåŠ¨å¿«é—¨æ ¡æ­£çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä½¿ç”¨æ¥è‡ªæœºè½½é™€èºä»ªçš„æ•°æ®æ¥è·Ÿè¸ªç›¸æœºçš„è§’é€Ÿåº¦ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›¸æœºæ•è·æœŸé—´å†…å®æ—¶è¿è¡Œã€‚æˆ‘ä»¬æ¶ˆé™¤äº†ç”±äºæ‰‹æŠ–åŠ¨å¼•èµ·çš„å°æŠ–åŠ¨å’Œæ»šåŠ¨å¿«é—¨å¤±çœŸï¼Œè¥é€ å‡ºåœ¨ä¸‰è„šæ¶ä¸Šæ‹æ‘„çš„è§†é¢‘çš„æ•ˆæœã€‚</p><span id="more"></span><h1 id="introduction">Introduction</h1><p>å¤§å¤šæ•°ä¸­é«˜ç«¯ç§»åŠ¨è®¾å¤‡åŒ…å«ä¸€ä¸ªå¤šæ ¸ CPU å¤åˆä½“ã€ä¸€ä¸ªå›¾å½¢å¤„ç†å•å…ƒ (GPU) å’Œä¸€ä¸ªå¸¦æœ‰ 3 è½´é™€èºä»ªçš„æƒ¯æ€§æµ‹é‡å•å…ƒ (IMU)ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†åœ¨æ­¤ç±»è®¾å¤‡ä¸Šæ‰§è¡Œè§†é¢‘ç¨³å®šçš„æŒ‘æˆ˜ï¼Œä½¿ç”¨é™€èºä»ªè¿›è¡Œè¿åŠ¨è·Ÿè¸ªã€‚ ä¸å¤§å¤šæ•°ç¨³å®šæ–¹æ³•ä¸åŒï¼Œå®ƒä»¬ä½œä¸ºæ•è·è§†é¢‘çš„åå¤„ç†æ­¥éª¤è¿è¡Œï¼Œæˆ‘ä»¬çš„æ–¹æ³•å¯ä»¥ä½œä¸ºç›¸æœºæ•è·çš„ä¸€éƒ¨åˆ†å®æ—¶è¿è¡Œã€‚</p><h1 id="background-and-prior-work">Background and Prior Work</h1><p>è§†é¢‘ç¨³å®šæ¶ˆé™¤äº†è§†é¢‘ä¸­çš„æŠ–åŠ¨ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸‰é˜¶æ®µè¿‡ç¨‹ï¼ŒåŒ…æ‹¬è¿åŠ¨ä¼°è®¡é˜¶æ®µã€å¹³æ»‘æµ‹é‡è¿åŠ¨çš„æ»¤æ³¢é˜¶æ®µå’Œç”Ÿæˆæ–°è§†é¢‘åºåˆ—çš„é‡æ–°åˆæˆé˜¶æ®µã€‚</p><p>å½“æ·±åº¦å˜åŒ–å¼•èµ·åƒç´ è¿åŠ¨æ—¶ï¼ŒåŸºäºå›¾åƒçš„è·Ÿè¸ªæ–¹æ³•ä¼šå—åˆ°å½±å“ï¼Œè§†å·®ï¼Œå•åº”æ€§ä¸å®¹æ˜“å»ºæ¨¡ã€‚æ­¤å¤–ï¼Œæ»šåŠ¨å¿«é—¨æˆåƒä¼ æ„Ÿå™¨å¯ä»¥å¼•å…¥éåˆšæ€§çš„å¸§åˆ°å¸§å¯¹åº”å…³ç³»ï¼Œä¸èƒ½ç®€å•åœ°é€šè¿‡å…¨å±€å¸§åˆ°å¸§è¿åŠ¨æ¨¡å‹è¿›è¡Œå»ºæ¨¡ã€‚ä¸ºäº†è§£å†³æ»šåŠ¨å¿«é—¨é—®é¢˜ï¼ŒBaker ç­‰äºº [8] ä½¿ç”¨ä½é¢‘å…‰æµçš„æ—¶é—´è¶…åˆ†è¾¨ç‡ä¼°è®¡å’Œå»é™¤ç›¸æœºçš„é«˜é¢‘æŠ–åŠ¨ã€‚Grundmann ç­‰äºº [3] å¼€å‘äº†ä¸€ä¸ªåŸºäºæ··åˆå•åº”æ€§çš„æ¨¡å‹ï¼Œè¯¥æ¨¡å‹è·Ÿè¸ªå¸§å†…è¿åŠ¨å¹¶ç”Ÿæˆå…·æœ‰æ ¡æ­£æ»šåŠ¨å¿«é—¨å¤±çœŸçš„ç¨³å®šè§†é¢‘ã€‚ Liu ç­‰äºº [6] é‡‡ç”¨åŸºäºç½‘æ ¼çš„ç©ºé—´å˜åŒ–è¿åŠ¨è¡¨ç¤ºï¼Œç»“åˆè‡ªé€‚åº”æ—¶ç©ºè·¯å¾„ä¼˜åŒ–ï¼Œå¯ä»¥å¤„ç†è§†å·®å¹¶æ ¡æ­£æ»šåŠ¨å¿«é—¨æ•ˆåº”ã€‚</p><p>Karpenko [1] å’Œ Hanning ç­‰äºº [11] æè¿°äº†ä½¿ç”¨å†…ç½®é™€èºä»ªè·Ÿè¸ªç›¸æœºæ–¹å‘çš„ç§»åŠ¨è®¾å¤‡çš„è§†é¢‘ç¨³å®šæŠ€æœ¯ï¼Œå°†çº¿æ€§ä½é€šæ»¤æ³¢å™¨åº”ç”¨äºé™€èºä»ªè¾“å‡ºã€‚Karpenko ç­‰äºº [1] ä½¿ç”¨é«˜æ–¯æ ¸ï¼Œè€Œ Hanning ç­‰äºº [11] åº”ç”¨å¯å˜é•¿åº¦çš„ Hann çª—å£æ¥è‡ªé€‚åº”åœ°å¹³æ»‘ç›¸æœºè·¯å¾„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ç§éçº¿æ€§æ»¤æ³¢æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å®Œå…¨å¹³å¦åŒ–å°è¿åŠ¨ï¼Œè€Œä¸ç®¡é¢‘ç‡å¦‚ä½•ï¼Œå¹¶åœ¨è™šæ‹Ÿæ‘„åƒæœºå¿…é¡»ç§»åŠ¨ä»¥å°†è£å‰ªçª—å£ä¿æŒåœ¨è¾“å…¥å¸§å†…æ—¶æ‰§è¡Œä½é€šå¹³æ»‘ã€‚å½“ç›¸æœºå‡ ä¹é™æ­¢æ—¶ï¼Œæˆ‘ä»¬çš„è™šæ‹Ÿç›¸æœºè¢«å›ºå®šï¼Œæ¶ˆé™¤æ‰€æœ‰æŠ–åŠ¨ã€‚ç§»åŠ¨æ—¶ï¼Œæˆ‘ä»¬çš„æ–¹æ³•å°±åƒä¸€ä¸ªå¯å˜ IIR æ»¤æ³¢å™¨ï¼Œä»¥å¹³æ»‘è¾“å‡ºçš„æ–¹å¼å°†è¾“å…¥é€Ÿåº¦ä¸è™šæ‹Ÿç›¸æœºé€Ÿåº¦æ··åˆï¼ŒåŒæ—¶ä¿è¯å®ƒè·Ÿè¸ªè¾“å…¥ï¼Œä»¥ä¾¿è£å‰ªçª—å£æ°¸è¿œä¸ä¼šç¦»å¼€è¾“å…¥å¸§ã€‚</p><h1 id="algorithm-description">Algorithm Description</h1><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªè£å‰ªçŸ©å½¢æ¥å®ç°è§†é¢‘ç¨³å®šï¼Œè¯¥çŸ©å½¢åœ¨ç›¸æœºå››å¤„æ™ƒåŠ¨æ—¶éšåœºæ™¯å†…å®¹é€å¸§ç§»åŠ¨ã€‚å¦‚å›¾ 1 æ‰€ç¤º <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anl1.png"></p><h2 id="camera-tracking-using-the-gyroscope">Camera Tracking Using the Gyroscope</h2><p>æˆ‘ä»¬å°†ç›¸æœºè¿åŠ¨å»ºæ¨¡ä¸ºå…¨å±€åæ ‡ç³»ä¸­çš„æ—‹è½¬ã€‚é™€èºä»ªæä¾›äº†ä¸€ç³»åˆ—å¸¦æœ‰æ—¶é—´æˆ³çš„ç¦»æ•£è§’é€Ÿåº¦æµ‹é‡å€¼ï¼Œæˆ‘ä»¬å°†å…¶ç§¯åˆ†ä»¥ç”Ÿæˆæè¿°ç›¸æœºæ–¹å‘çš„æ—¶é—´å‡½æ•°ã€‚ ç†è®ºä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨è®¾å¤‡çš„åŠ é€Ÿåº¦è®¡æµ‹é‡å¹³ç§»æ¥æ›´ç²¾ç¡®ï¼Œä½†å®é™…ä¸Šè¿™å¾ˆå›°éš¾ä¸”ä»·å€¼æœ‰é™ã€‚å¦‚æœç›¸æœºè·ç¦»å¹³é¢åœºæ™¯ 3 ç±³ï¼Œé‚£ä¹ˆ 1 å˜ç±³å¹³ç§»å¼•èµ·çš„å›¾åƒè¿åŠ¨ç›¸å½“äºæ—‹è½¬ 0.19 åº¦ã€‚ æ­¤å¤–ï¼Œå¹³ç§»çš„ä½¿ç”¨éœ€è¦äº†è§£åœºæ™¯ä¸­ç‰©ä½“çš„æ·±åº¦ã€‚</p><p>ä¸ºäº†ä¿®å¤å·å¸˜å¿«é—¨å¤±çœŸï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ç‰¹å®šè¡Œæ›å…‰æ—¶ç›¸æœºçš„æ–¹å‘ã€‚ ç»™å®šå¸§ <span class="math inline">\(t_0\)</span> ç¬¬ä¸€è¡Œçš„æ—¶é—´æˆ³ï¼Œç¬¬ r è¡Œçš„æ—¶é—´æˆ³ä¸º</p><p><span class="math display">\[t_r = t_0 + \frac{r}{f_l}f_t \tag1\]</span></p><p>å…¶ä¸­ <span class="math inline">\(f_t\)</span> æ˜¯æ€»å¸§æ—¶é—´ï¼ˆå³ä¸¤ä¸ªè¿ç»­å¸§å¼€å§‹ä¹‹é—´ç»è¿‡çš„æ—¶é—´ï¼‰ï¼Œ<span class="math inline">\(f_l\)</span> æ˜¯å›¾åƒè¡Œä¸­çš„å¸§é•¿åº¦ã€‚ å¸§é•¿æ˜¯å›¾åƒé«˜åº¦ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰åŠ ä¸Šæ¶ˆéšè¡Œæ•°çš„æ€»å’Œã€‚ è¿™ä¸¤ä¸ªå€¼éƒ½å–å†³äºå›¾åƒä¼ æ„Ÿå™¨å’Œæ•è·æ¨¡å¼ï¼Œä½†æˆ‘ä»¬å‡è®¾å®ƒä»¬åœ¨è§†é¢‘æŒç»­æ—¶é—´å†…æ˜¯å·²çŸ¥çš„å¹¶ä¸”æ˜¯æ’å®šçš„ã€‚å¦‚æœè¿™äº›å€¼ä¸æ˜¯ç”±ä¼ æ„Ÿå™¨é©±åŠ¨æä¾›çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ ¡å‡†è·å¾— [13, 14]ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—å…¶å¯¹åº”çš„è¡Œæ—¶é—´æˆ³å¹¶ä»å·²çŸ¥æ ·æœ¬ä¸­æ’å…¥ç›¸æœºæ–¹å‘æ¥æ‰¾åˆ°ä¸å›¾åƒä¸­ç‚¹ x å¯¹åº”çš„è®¾å¤‡æ–¹å‘ã€‚ç”±äºç¡¬ä»¶å’Œè½¯ä»¶å»¶è¿Ÿï¼Œå¸§æ—¶é—´æˆ³å’Œé™€èºä»ªæ—¶é—´æˆ³ä¹‹é—´å­˜åœ¨å°çš„åç§»ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªåç§» <span class="math inline">\(t_d\)</span> æ˜¯å·²çŸ¥çš„ï¼Œå¹¶ä¸”åœ¨æ•è·æœŸé—´æ˜¯æ’å®šçš„ã€‚ åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬æŒ‰ç…§ç¬¬ 3.5 èŠ‚ä¸­çš„è¯¦ç»†è¯´æ˜æ ¡å‡†æ­¤åç§»é‡ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨å…·æœ‰ç„¦è· f å’ŒæŠ•å½±ä¸­å¿ƒ (cx, cy) çš„æŠ•å½±ç›¸æœºæ¨¡å‹ï¼›è¿™ä¸‰ä¸ªå‚æ•°å®šä¹‰äº†ç›¸æœºå›ºæœ‰çŸ©é˜µ Kã€‚è¿™äº›å‚æ•°ä½¿ç”¨ OpenCV åº“è¿›è¡Œç¦»çº¿æ ¡å‡†ã€‚åœ¨å·²çŸ¥ K çŸ©é˜µçš„æƒ…å†µä¸‹ï¼Œæ»šåŠ¨å¿«é—¨ä¼ æ„Ÿå™¨åœ¨æ—‹è½¬è¿åŠ¨ä¸‹æ•è·çš„ä¸¤ä¸ªä¸åŒå¸§ä¸Šçš„å¯¹åº”ç‚¹<span class="math inline">\(x_1\)</span>å’Œ<span class="math inline">\(x_2\)</span>ä¹‹é—´çš„å…³ç³»ä¸º :</p><p><span class="math display">\[x_2 = KR_c(t_2)R_c^{-1}(t_1K^{-1})x_1 \tag2\]</span></p><p>å…¶ä¸­æ—‹è½¬çŸ©é˜µ <span class="math inline">\(R_c\)</span> è¡¨ç¤ºä½œä¸ºæ—¶é—´å‡½æ•°çš„ç›¸æœºåæ ‡ç³»ä¸­çš„ç›¸æœºæ–¹å‘ï¼Œ<span class="math inline">\(t_1\)</span> å’Œ <span class="math inline">\(t_2\)</span> æ˜¯ç‚¹ <span class="math inline">\(x_1\)</span> å’Œ <span class="math inline">\(x_2\)</span> çš„è¡Œæ—¶é—´æˆ³ã€‚ æˆ‘ä»¬å¯ä»¥å°†å…³äºé™€èºä»ªåæ ‡ç³»å’Œæ—¶é—´åŸç‚¹çš„æ–¹ç¨‹ 2 é‡å†™ä¸ºï¼š</p><p><span class="math display">\[x_2 = KTR_g(t_2 + t_d)R_g^{-1}(t_1 + t_d)T^{-1}K^{-1}x_1 \tag3\]</span></p><p>å…¶ä¸­ <span class="math inline">\(R_g\)</span> æ˜¯ä»é™€èºä»ªå¯¼å‡ºçš„æ–¹å‘ï¼ŒT æ˜¯ç›¸æœºå’Œé™€èºä»ªåæ ‡ç³»ä¹‹é—´çš„è½¬æ¢ï¼Œ<span class="math inline">\(t_d\)</span> æ˜¯ä¸Šè¿°é™€èºä»ªå’Œç›¸æœºæ•°æ®æµä¹‹é—´çš„æ—¶é—´åç§»ã€‚ç”±äºå¤§å¤šæ•°ç§»åŠ¨è®¾å¤‡éƒ½å°†é™€èºä»ªå’Œæ‘„åƒå¤´å›ºå®šå®‰è£…åœ¨ä¸€èµ·ï¼Œè½´å½¼æ­¤å¹³è¡Œï¼Œå› æ­¤ T åªæ˜¯ä¸€ä¸ªç½®æ¢çŸ©é˜µã€‚</p><h2 id="motion-model-and-smoothing-algorithm">Motion Model and Smoothing Algorithm</h2><p>æˆ‘ä»¬åœ¨æ¯ä¸€å¸§ç”¨ç›¸æœºçš„æ–¹å‘å’Œè§’é€Ÿåº¦å‚æ•°åŒ–ç›¸æœºè·¯å¾„ã€‚æˆ‘ä»¬ç”¨å››å…ƒæ•°<span class="math inline">\(p(k)\)</span>å’Œ<span class="math inline">\(v(k)\)</span>è¡¨ç¤ºç¬¬ k å¸§çš„ç‰©ç†å’Œè™šæ‹Ÿç›¸æœºæ–¹å‘ã€‚ ç‰©ç†å’Œè™šæ‹Ÿè§’é€Ÿåº¦è®¡ç®—ä¸ºä»ç¬¬ k å¸§åˆ°ç¬¬ k + 1 å¸§çš„ç¦»æ•£è§’å˜åŒ–ï¼Œå¹¶è¡¨ç¤º <span class="math inline">\(p_âˆ†(k)\)</span>å’Œ<span class="math inline">\(v_âˆ†(k)\)</span>ã€‚ç”±äºå¸§é€Ÿç‡æ˜¯æ’å®šçš„ï¼Œå› æ­¤è¿™ç§é€Ÿåº¦è¡¨ç¤ºä¸­éšå«äº†æ—¶é—´ã€‚å¯¹äºæ¯ä¸ªæ–°å¸§ kï¼Œæˆ‘ä»¬çš„å¹³æ»‘ç®—æ³•ä½¿ç”¨æ¥è‡ªæœ€åä¸€å¸§çš„è™šæ‹Ÿå‚æ•°ä»¥åŠæ¥è‡ªæœ€åä¸€å¸§ã€å½“å‰å¸§å’Œå¯é€‰çš„æœªæ¥å°ç¼“å†²åŒºçš„ç‰©ç†ç›¸æœºå‚æ•°è®¡ç®—<span class="math inline">\(v(k)\)</span>å’Œ<span class="math inline">\(v_Î”(k)\)</span>å¸§ï¼ˆ5 ä¸ªæˆ–æ›´å°‘ï¼‰ã€‚</p><p>æˆ‘ä»¬çš„å¹³æ»‘ç®—æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç›¸æœºè·¯å¾„ï¼Œå½“æµ‹é‡åˆ°çš„è¿åŠ¨è¶³å¤Ÿå°ä»¥è¡¨æ˜å®é™…æ„å›¾æ˜¯ä¿æŒç›¸æœºé™æ­¢æ—¶ï¼Œè¯¥è·¯å¾„ä½¿è™šæ‹Ÿç›¸æœºä¿æŒé™æ­¢ï¼Œå¦åˆ™éµå¾ªæµ‹é‡è¿åŠ¨çš„æ„å›¾ï¼Œè§’é€Ÿåº¦å¹³æ»‘å˜åŒ– . ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½®å‡è®¾è™šæ‹Ÿç›¸æœºçš„æ–°æ–¹å‘ã€‚ <span class="math display">\[\hat{v}^(k) = v(k âˆ’ 1) Â· v_âˆ†(k âˆ’ 1) \tag4\]</span> å…¶ä¸­<span class="math inline">\(\cdot\)</span>è¡¨ç¤ºå››å…ƒæ•°ç§¯ã€‚ç®€å•åœ°è¯´ï¼Œè¿™ä¸ªæ–¹ç¨‹æ˜¯é€šè¿‡ä»ä¸Šæ¬¡å·²çŸ¥æ–¹å‘æ—‹è½¬ç›¸æœºï¼ŒåŒæ—¶ä¿æŒå…¶è§’é€Ÿåº¦æ¥è®¡ç®—æ–°çš„ç›¸æœºæ–¹å‘ã€‚ç»™å®šè¿™ä¸ªå‡è®¾çš„ç›¸æœºæ–¹å‘ <span class="math inline">\(\hat{v}^(k)\)</span>ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­‰å¼ 2 æ¥è®¡ç®—ç”Ÿæˆçš„è£å‰ªå¤šè¾¹å½¢çš„è§’åæ ‡ã€‚åœ¨è™šæ‹Ÿç›¸æœºç©ºé—´ä¸­ï¼Œè£å‰ªå¤šè¾¹å½¢æ˜¯ä¸€ä¸ªä»¥å›¾åƒä¸­å¿ƒä¸ºä¸­å¿ƒçš„å›ºå®šçŸ©å½¢ï¼Œä½†åœ¨ç‰©ç†ç›¸æœºç©ºé—´ä¸­ï¼Œå®ƒå¯èƒ½ä¼šå‘ç”Ÿå€¾æ–œæˆ–æ‰­æ›²ï¼Œå¹¶åœ¨å¸§å†…å››å¤„ç§»åŠ¨ï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚è£å‰ªå¤šè¾¹å½¢è¾ƒå°æ¯”è¾“å…¥å¤§å°ï¼Œè¿™åœ¨å¤šè¾¹å½¢è¾¹ç•Œå’Œè¾“å…¥æ¡†æ¶è¾¹ç¼˜ä¹‹é—´ç•™ä¸‹äº†å°‘é‡çš„ "padding"ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚æˆ‘ä»¬å°†æ­¤å¡«å……åˆ†ä¸ºä¸¤ä¸ªåŒå¿ƒåŒºåŸŸï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º "inner region"å’Œ "outer region"ã€‚å½“å‡è®¾çš„è£å‰ªå¤šè¾¹å½¢ä½äºå›¾åƒçš„å†…éƒ¨åŒºåŸŸå†…æ—¶ï¼Œæˆ‘ä»¬æ–­è¨€å‡è®¾ <span class="math inline">\(\hat{v}^(k)\)</span>æ˜¯å¥½çš„ï¼Œå¹¶ä½¿å…¶æˆä¸ºå½“å‰çš„ç›¸æœºæ–¹å‘ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å‘ç°è®©è¿åŠ¨åœ¨è¿™ç§æƒ…å†µä¸‹è¡°å‡ä¸ºé›¶ï¼Œè¿™ä¼šä½¿è™šæ‹Ÿç›¸æœºåœ¨å¯èƒ½çš„æƒ…å†µä¸‹åå‘äºä¿æŒé™æ­¢ã€‚å› æ­¤ï¼Œå¦‚æœè£å‰ªå¤šè¾¹å½¢å®Œå…¨ä¿ç•™åœ¨å†…éƒ¨åŒºåŸŸå†…ï¼Œæˆ‘ä»¬å°†è§’åº¦å˜åŒ–å‡å°‘è¡°å‡å› å­ dï¼Œå¹¶å°†æ–°çš„è™šæ‹Ÿç›¸æœºé…ç½®è®¾ç½®ä¸ºï¼š</p><p><span class="math display">\[v_âˆ†(k) = slerp(q_I; v_âˆ†(k âˆ’ 1); d) \tag5\]</span></p><p>and</p><p><span class="math display">\[v(k) = v(k âˆ’ 1) Â· v_âˆ†(k âˆ’ 1) \tag6\]</span></p><p>è¿™é‡Œ<span class="math inline">\(q_I\)</span>ä»£è¡¨æ’ç­‰å››å…ƒæ•°ï¼Œslerp å‡½æ•°æ˜¯ä¸¤ä¸ªå››å…ƒæ•°ä¹‹é—´çš„çƒé¢çº¿æ€§æ’å€¼ [17]ã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†æ··åˆæƒé‡è®¾ç½®ä¸º d â‰ˆ 0.95ï¼Œè¿™æ ·æ¯ä¸€å¸§çš„è§’åº¦å˜åŒ–åªä¼šç•¥å¾®å‡å°‘ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anl2.png"></p><p>å¦‚æœå‡è®¾è£å‰ªå¤šè¾¹å½¢çš„ä»»ä½•éƒ¨åˆ†ä½äºå†…éƒ¨åŒºåŸŸä¹‹å¤–ï¼Œæˆ‘ä»¬å°†æ›´æ–°è™šæ‹Ÿæ‘„åƒæœºçš„è§’é€Ÿåº¦ä»¥ä½¿å…¶æ›´æ¥è¿‘ç‰©ç†æ‘„åƒæœºçš„å˜åŒ–ç‡ï¼š</p><p><span class="math display">\[v_âˆ†(k) = slerp(p'_âˆ†(k), v(k âˆ’ 1), Î±) \tag7\]</span></p><p>è¿™é‡Œ <span class="math inline">\(p'_âˆ†\)</span> æ˜¯ä¿æŒè£å‰ªå¤šè¾¹å½¢ä»ä¸€å¸§åˆ°ä¸‹ä¸€å¸§çš„ç›¸å¯¹ä½ç½®çš„æ–¹å‘å˜åŒ–ï¼Œè®¡ç®—ä¸ºï¼š</p><p><span class="math display">\[p'_âˆ†(k) = p(k) Â· p^âˆ—(k âˆ’ 1) Â· v(k âˆ’ 1) \tag8\]</span></p><p>å…¶ä¸­<span class="math inline">\(p^âˆ—\)</span>è¡¨ç¤ºåè½¬æ—‹è½¬çš„å››å…ƒæ•°å…±è½­ã€‚ è¯¥æ–¹ç¨‹è®¡ç®—è™šæ‹Ÿæ‘„åƒæœºå‚è€ƒåæ ‡ç³»ä¸­ä»å‰ä¸€å¸§åˆ°å½“å‰å¸§çš„ç‰©ç†æ‘„åƒæœºè¿åŠ¨ã€‚ Î±é¡¹æ˜¯ä¸€ä¸ªæ··åˆæƒé‡ï¼Œå®ƒæ˜¯æ ¹æ®è£å‰ªå¤šè¾¹å½¢å’Œæ¡†æ¶è¾¹ç¼˜ä¹‹é—´å‰©ä½™çš„å¡«å……é‡æ¥é€‰æ‹©çš„ï¼Œå¦‚å›¾ 2 çš„å³ä¾§æ‰€ç¤ºã€‚ç›´è§‚åœ°ï¼Œå¦‚æœè£å‰ªå¤šè¾¹å½¢ä»…ç¨å¾®è¶…å‡ºå†…éƒ¨ åŒºåŸŸï¼ŒÎ± åº”è¯¥æ¥è¿‘ 1ï¼Œä¸ºå½“å‰é€Ÿåº¦åˆ†é…æ›´é«˜çš„æƒé‡ã€‚ ç›¸åï¼Œå¦‚æœå‡è®¾çš„è£å‰ªå¤šè¾¹å½¢é è¿‘è¾¹ç¼˜ï¼ˆç”šè‡³å¤–éƒ¨ï¼‰ï¼Œåˆ™ Î± åº”ä¸º 0ï¼Œè¿™æ ·è¾“å…¥é€Ÿåº¦åŒ¹é…ï¼Œè£å‰ªå¤šè¾¹å½¢ä¿æŒåœ¨ç›¸å¯¹äºè¾“å…¥å¸§çš„ç›¸åŒä½ç½®ã€‚ æˆ‘ä»¬ç”¨</p><p><span class="math display">\[Î± = 1 âˆ’ w^Î² \tag9\]</span> å…¶ä¸­ <span class="math inline">\(w \subseteq (0, 1]\)</span> æ˜¯è£å‰ªå¤šè¾¹å½¢è¶…å‡ºå†…éƒ¨åŒºåŸŸçš„æœ€å¤§çªå‡ºé‡ï¼Œè€Œ Î² æ˜¯å†³å®šå“åº”é”åº¦çš„æŒ‡æ•°ã€‚åœ¨è£å‰ªå¤šè¾¹å½¢çš„ä»»ä½•è§’è½åœ¨è¾“å…¥ä¹‹å¤–çš„æç«¯æƒ…å†µä¸‹ å¸§ï¼Œw å–å€¼ä¸º 1ï¼Œå¼ºåˆ¶ Î± ä¸º 0ï¼Œå¹¶ä½¿è™šæ‹Ÿæ‘„åƒæœºè·Ÿä¸Šç‰©ç†æ‘„åƒæœºã€‚</p><p>è¯¥ç®—æ³•è¿è¡Œè‰¯å¥½ï¼Œä½†å½“è£å‰ªçŸ©å½¢çªç„¶ç¢°åˆ°è¾¹ç¼˜æ—¶ï¼Œå®ƒæœ‰æ—¶å¿…é¡»å¿«é€Ÿæ”¹å˜é€Ÿåº¦ã€‚ å¦‚æœå¸§åœ¨å¤„ç†ä¹‹å‰å¯ä»¥åœ¨ç›¸æœºæµæ°´çº¿ä¸­ç¼“å­˜ä¸€å°æ®µæ—¶é—´ï¼Œé‚£ä¹ˆå¯ä»¥æ£€æŸ¥æ›´å¤§çš„é™€èºä»ªæ•°æ®æ—¶é—´çª—å£ï¼Œå¹¶ä¸”å¯ä»¥æŠ¢å…ˆé¿å…æ€¥å‰§å˜åŒ–ã€‚ åœ¨æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ‰©å±•äº†æˆ‘ä»¬çš„ç®—æ³•ä»¥ä½¿ç”¨æ¥è‡ªå‰ç»ç¼“å†²åŒºçš„æ•°æ®æ¥è®¡ç®—æ›´å¹³æ»‘çš„è·¯å¾„ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anl3.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†è™šæ‹Ÿç›¸æœºçš„æ–¹å‘åŠæ—¶å‘å‰æŠ•å°„å¹¶å°†å…¶ä¸â€œæœªæ¥â€æ—¶é—´çš„å®é™…æ–¹å‘è¿›è¡Œæ¯”è¾ƒæ¥è·¨è¶Šæ›´å¤§çš„å¸§çª—å£ã€‚è®© a æ˜¯å‘å‰çœ‹çš„å¸§æ•°ï¼Œå¹¶å‡è®¾ï¼š</p><p><span class="math display">\[v(k + a) = v(k âˆ’ 1) Â· v_âˆ†(k)^{a+1} \tag{10}\]</span></p><p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—<span class="math inline">\(v_âˆ†(k+a)\)</span> å’Œ <span class="math inline">\(v(k+a)\)</span>ï¼Œå°±åƒæˆ‘ä»¬åœ¨æ— å‰ç»æƒ…å†µä¸‹æè¿°çš„é‚£æ ·ã€‚ å¦‚æœè£å‰ªå¤šè¾¹å½¢ a å¸§åˆ°æœªæ¥çš„æŠ•å½±åœ¨å†…éƒ¨åŒºåŸŸä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°<span class="math inline">\(v_âˆ†(k)\)</span> ä¸ºï¼š</p><p><span class="math display">\[v_âˆ†(k) = slerp(v_âˆ†(k + a); v_âˆ†(k); Î³) \tag{11}\]</span></p><p>å…¶ä¸­ Î³ æ˜¯ä¸€ä¸ªæ··åˆå› å­ï¼Œå®ƒå®šä¹‰äº†æˆ‘ä»¬åº”è¯¥å°†å¤šå°‘å‰ç»è§’åº¦å˜åŒ–ä¸å½“å‰è§’åº¦å˜åŒ–æ··åˆã€‚ ä½¿ç”¨æ¥è¿‘ 1 çš„ Î³ å€¼æä¾›äº†åœ¨æ­£ç¡®æ–¹å‘ä¸Šçš„å…ˆå‘åˆ¶äººçš„æ¨åŠ¨ï¼Œè€Œä¸æ˜¯ç¡¬çº¦æŸã€‚ è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨æ²¡æœ‰å‰ç»çš„æƒ…å†µä¸‹æ›´æ–°æˆ‘ä»¬è®¡ç®—çš„è™šæ‹Ÿæ‘„åƒæœºä½ç½®ï¼Œæˆ‘ä»¬åªä¼šæ›´æ–°æˆ‘ä»¬å°†ç”¨äºä¸‹ä¸€å¸§çš„è™šæ‹Ÿæ‘„åƒæœºé€Ÿåº¦</p><p>å›¾ 3 æ˜¾ç¤ºäº†ä¸€ç³»åˆ—å‰ç»è·ç¦»ï¼ˆä»¥å¸§ä¸ºå•ä½ï¼‰çš„è·¯å¾„æ¯”è¾ƒã€‚ è¾ƒå¤§çš„å‰ç»å€¼ä¼šäº§ç”Ÿæ›´å¹³æ»‘çš„è·¯å¾„ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æœ‰æ•ˆåœ°â€œé¢„æµ‹â€è¾ƒå¤§çš„è¿åŠ¨å¹¶è½»è½»åœ°å¯¼è‡´è¾“å‡ºå¼€å§‹ç§»åŠ¨ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„ç®—æ³•å¯ä»¥åœ¨æ²¡æœ‰å‰ç»çš„æƒ…å†µä¸‹å·¥ä½œå¹¶ä¸”ä»ç„¶äº§ç”Ÿè‰¯å¥½çš„ç»“æœã€‚</p><h2 id="output-synthesis-and-rolling-shutter-correction">Output Synthesis and Rolling-Shutter Correction</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anl4.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/anl5.png"></p><p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—äº†è™šæ‹Ÿæ‘„åƒæœºçš„æ–°æ–¹å‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†è£å‰ªå¤šè¾¹å½¢ä»è§†é¢‘è¾“å…¥æŠ•å½±åˆ°è™šæ‹Ÿæ‘„åƒæœºæ¥åˆæˆè¾“å‡ºã€‚æˆ‘ä»¬çš„è£å‰ªå¤šè¾¹å½¢æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè£å‰ªçŸ©å½¢ï¼Œåœ¨å‚ç›´è¾¹ç¼˜ä¸Šæœ‰å¤šä¸ªæ‹ç‚¹ï¼Œå¦‚å›¾ 4 æ‰€ç¤ºã€‚æ‹ç‚¹å…è®¸æˆ‘ä»¬å¯¹å¤šè¾¹å½¢çš„æ¯ä¸ªåˆ‡ç‰‡ä½¿ç”¨ä¸åŒçš„å˜æ¢å¹¶ä¿®å¤æ»šåŠ¨å¿«é—¨å¤±çœŸã€‚å¯¹äºæ¯ä¸ªåˆ‡ç‰‡ï¼Œæˆ‘ä»¬æ ¹æ®ç­‰å¼ 2 è®¡ç®—å•åº”çŸ©é˜µã€‚ æˆ‘ä»¬å°†æ—‹è½¬çŸ©é˜µ <span class="math inline">\(R_c(t2)\)</span> å›ºå®šåˆ°è™šæ‹Ÿè¾“å‡ºç›¸æœºçš„æ–¹å‘ï¼Œå¹¶é€šè¿‡æ¥è‡ªé™€èºä»ªçš„æ•°æ®è®¡ç®— <span class="math inline">\(R_c(tk)\)</span>ï¼Œè¾“å…¥ç›¸æœºåœ¨æ¯ä¸ªæ‹ç‚¹å¤„çš„æ–¹å‘ã€‚æˆ‘ä»¬å°†è£å‰ªå¤šè¾¹å½¢çš„åæ ‡è®¾ç½®ä¸º OpenGL ç€è‰²å™¨ç¨‹åºçš„çº¹ç†åæ ‡ï¼Œè¯¥ç¨‹åºå°†è£å‰ªå¤šè¾¹å½¢ä»è¾“å…¥å¸§æŠ•å½±æ˜ å°„åˆ°è™šæ‹Ÿç›¸æœºã€‚è¯·æ³¨æ„ï¼Œä¸ºäº†æœ‰æ•ˆæ ¡æ­£æ»šåŠ¨å¿«é—¨æ•ˆåº”ï¼Œé™€èºä»ªé‡‡æ ·ç‡åº”é«˜äºå¸§è¯»å‡ºæ—¶é—´ã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä»¥ 200 Hz çš„é¢‘ç‡å¯¹é™€èºä»ªè¿›è¡Œé‡‡æ ·ï¼Œæ€»å…±ä½¿ç”¨ 10 ä¸ªåˆ‡ç‰‡ï¼Œæˆ–æ¯ä¸ªå‚ç›´è¾¹ç¼˜ 9 ä¸ªæ‹ç‚¹ã€‚</p><h2 id="parameter-selection">Parameter Selection</h2><p>æœ€é‡è¦çš„å‚æ•°æ˜¯è¾“å‡ºè£å‰ªå¤šè¾¹å½¢çš„å¤§å°ä»¥åŠåˆ†é…ç»™å†…éƒ¨å’Œå¤–éƒ¨åŒºåŸŸçš„å¡«å……é‡ã€‚è£å‰ªå¤§å°æ˜¯å¹³æ»‘å’Œå›¾åƒè´¨é‡ä¹‹é—´çš„æƒè¡¡ï¼šè¾ƒå¤§çš„è£å‰ªå¤šè¾¹å½¢ä¿ç•™æ›´å¤šçš„è¾“å…¥å›¾åƒï¼Œä½†ç•™ä¸‹è¾ƒå°‘çš„å¡«å……æ¥å¹³æ»‘è¿åŠ¨ã€‚å¡«å……åˆ†é…æ˜¯å®Œå…¨å»é™¤è¿åŠ¨å’Œå‰©ä½™è¿åŠ¨çš„å¹³æ»‘åº¦ä¹‹é—´çš„æƒè¡¡ã€‚ å¦‚å›¾ 5 æ‰€ç¤ºï¼Œè¾ƒå¤§çš„å†…éƒ¨åŒºåŸŸï¼ˆç»¿è‰²ï¼‰èƒ½å¤Ÿä½¿è¾ƒå¤§çš„è¿åŠ¨ï¼ˆä¾‹å¦‚æ­¥è¡Œï¼‰å˜å¹³ï¼Œä½†å½“è£å‰ªçª—å£æ¥è¿‘æ¡†æ¶è¾¹ç¼˜æ—¶å¿…é¡»æ›´çªç„¶åœ°ç§»åŠ¨ã€‚</p><h2 id="gyroscope-and-camera-calibration">Gyroscope and Camera Calibration</h2><p>æˆ‘ä»¬ä½¿ç”¨ä¸ºæ­¤ç›®çš„å¼€å‘çš„æ ¡å‡†ç¨‹åºæ¥æ±‚è§£æ—¶é—´åç§» <span class="math inline">\(t_d\)</span>ã€‚ æˆ‘ä»¬åœ¨ç›¸æœºå‰é¢æ”¾ç½®äº†ä¸€ä¸ªæ ¡å‡†å›¾æ¡ˆï¼Œå®ƒç”±ä¸€ä¸ªä¸å¯¹ç§°çš„åœ†ç½‘æ ¼ç»„æˆï¼Œç„¶åæˆ‘ä»¬åœ¨å‰§çƒˆæ—‹è½¬ç›¸æœºçš„åŒæ—¶å½•åˆ¶è§†é¢‘å’Œé™€èºä»ªè¯»æ•°ã€‚ å³ä½¿å­˜åœ¨è¿åŠ¨æ¨¡ç³Šå’Œæ»šåŠ¨å¿«é—¨æ•ˆæœï¼Œä¹Ÿå¯ä»¥è½»æ¾åœ°è·¨å¸§è·Ÿè¸ªåœ†åœˆã€‚ æˆ‘ä»¬ä½¿ç”¨æ¯ä¸ªåœ†çš„è´¨å¿ƒä½œä¸ºç‰¹å¾ç‚¹ï¼Œå¹¶æ ¹æ®å…¬å¼ 3 é€šè¿‡æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®çš„æ€»å’Œæ¥è¿­ä»£æ±‚è§£ <span class="math inline">\(t_d\)</span>ã€‚é€šè¿‡åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šé‡å¤æ ¡å‡†ï¼Œæˆ‘ä»¬ç¡®å®šåç§» <span class="math inline">\(t_d\)</span> å‡ ä¹æ˜¯æ’å®šçš„ã€‚ æˆ‘ä»¬è¿˜è€ƒè™‘äº†é€šè¿‡åœ¨æ•è·æ¯ä¸€å¸§æ—¶è·Ÿè¸ªå…³é”®ç‚¹æ¥è¿›è¡Œåœ¨çº¿æ ¡å‡†çš„å¯èƒ½æ€§ [18]ï¼Œä½†äº‹å®è¯æ˜ç¦»çº¿æ–¹æ³•è¶³ä»¥æ»¡è¶³æˆ‘ä»¬çš„ç›®çš„ã€‚</p><p>é™€èºä»ªæµ‹é‡ä¸­ä»»ä½•é™æ€åç§»çš„ç§¯åˆ†å°†å¯¼è‡´ä¼°è®¡çš„æ–¹å‘ç¼“æ…¢åç¦»åœ°é¢å®å†µã€‚ç„¶è€Œï¼Œæˆ‘ä»¬çš„ç¨³å®šç®—æ³•ä¸å—è¿™ç§æ¼‚ç§»çš„å½±å“ï¼Œå› ä¸ºå®ƒå¹³æ»‘äº†æ–¹å‘çš„ç›¸å¯¹å˜åŒ–ã€‚ æˆ‘ä»¬åœ¨ä¸€åˆ°äº”å¸§çš„çª—å£å†…æµ‹é‡æ–¹å‘å˜åŒ–ï¼Œåœ¨å¦‚æ­¤çŸ­çš„æ—¶é—´è·¨åº¦å†…ï¼Œç§¯åˆ†æ¼‚ç§»å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><h1 id="results">Results</h1><p>æˆ‘ä»¬çš„æºè§†é¢‘ã€ç»“æœå’Œè¡¥å……ææ–™è§†é¢‘å¯åœ¨ https://research.nvidia.com/publication/non-linearfilter-gyroscope-based-video-stabilization è·å¾—ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>&lt; A Non-Linear Filter for Gyroscope-Based Video Stabilization &gt;</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨é™€èºä»ªçš„æ•°å­—è§†é¢‘ç¨³å®šå’Œå·å¸˜å¿«é—¨æ ¡æ­£</title>
      <link href="/2021/Science/DigitalVideoStabilizationAndRollingShutterCorrectionUsingGyroscope/"/>
      <url>/2021/Science/DigitalVideoStabilizationAndRollingShutterCorrectionUsingGyroscope/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs1.png"></p><h1 id="abstract">Abstract</h1><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäºå•†ç”¨é™€èºä»ªçš„å¼ºå¤§å®æ—¶è§†é¢‘ç¨³å®šå’Œæ»šåŠ¨å¿«é—¨æ ¡æ­£æŠ€æœ¯ã€‚é¦–å…ˆæ¥å¯¹ç›¸æœºè¿åŠ¨å’Œå·å¸˜å¿«é—¨æ‰­æ›²è¿›è¡Œå»ºæ¨¡ï¼Œç„¶åä»å•ä¸ªè§†é¢‘æ•è·è‡ªåŠ¨æ ¡å‡†é™€èºä»ªå’Œç›¸æœºè¾“å‡ºã€‚ è¿™ç§æ ¡å‡†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä»…ä½¿ç”¨é™€èºä»ªæ•°æ®æ¥æœ‰æ•ˆæ ¡æ­£å·å¸˜å¿«é—¨æ‰­æ›²å¹¶ç¨³å®šè§†é¢‘ã€‚</p><span id="more"></span><h1 id="video-stabilization-and-rolling-shutter-correction">Video Stabilization and Rolling Shutter Correction</h1><p>æˆ‘ä»¬ç³»ç»Ÿä¸­çš„ç›¸æœºè¿åŠ¨ä»…æ ¹æ®æ—‹è½¬è¿›è¡Œå»ºæ¨¡ã€‚ æˆ‘ä»¬å¿½ç•¥å¹³ç§»è¿åŠ¨ï¼ŒåŠ é€Ÿåº¦è®¡æ•°æ®å¿…é¡»è¢«ç§¯åˆ†ä¸¤æ¬¡æ‰èƒ½è·å¾—ä½ç§»ï¼Œå› æ­¤å®ƒä»¬å¾ˆéš¾ä½¿ç”¨ IMU å‡†ç¡®æµ‹é‡ã€‚å³ä½¿æˆ‘ä»¬å¯ä»¥å‡†ç¡®åœ°æµ‹é‡å¹³ç§»ï¼Œè¿™ä¹Ÿæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºåœ¨ç›¸æœºç›¸åŒå¹³ç§»é‡çš„æƒ…å†µä¸‹ä¸åŒæ·±åº¦çš„ç‰©ä½“ç§»åŠ¨çš„é‡ä¸åŒï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸ä¾èµ–ç«‹ä½“æˆ–åŸºäºç‰¹å¾çš„è¿åŠ¨ç»“æ„ï¼ˆSfMï¼‰ç®—æ³•æ¥è·å–æ·±åº¦ä¿¡æ¯ã€‚è¿™äº›æ–¹æ³•å¹¶ä¸å¥å£®ï¼Œè€Œä¸”ç›®å‰åœ¨ç§»åŠ¨å¹³å°ä¸Šå®æ—¶è¿è¡Œè®¡ç®—æˆæœ¬å¤ªé«˜ã€‚</p><p>Forsse Ìn å’Œ Ringaby[2010] è¯•å›¾åœ¨ä»–ä»¬çš„ç³»ç»Ÿä¸­æ¨¡æ‹Ÿç›¸æœºä½ç§»ï¼Œä½†å‘ç°ç»“æœæ¯”åªè€ƒè™‘æ—‹è½¬çš„æ¨¡å‹è¡¨ç°æ›´å·®ã€‚ ä»–ä»¬å‡è®¾ä¼˜åŒ–å™¨åœ¨å°è¯•ä»ç‰¹å¾è·Ÿè¸ªå™¨é‡å»ºä½ç§»æ—¶é™·å…¥å±€éƒ¨æœ€å°å€¼ã€‚ä»–ä»¬çš„ç®—æ³•è¿˜å‡è®¾ç›¸æœºæ­£åœ¨å¯¹çº¯å¹³é¢åœºæ™¯ï¼ˆå³æ’å®šæ·±åº¦ï¼‰è¿›è¡Œæˆåƒã€‚ å› æ­¤ï¼Œç”±äºè§†é¢‘ä¸­çš„æœªå»ºæ¨¡è§†å·®ï¼Œå¹³ç§»é‡å»ºæœ‰æ—¶ä¼šå¤±è´¥ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs2.png"></p><p>ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ²¡æœ‰å°†å¹³ç§»åˆå¹¶åˆ°æˆ‘ä»¬çš„æ¨¡å‹ä¸­ã€‚ å¹¸è¿çš„æ˜¯ï¼Œç›¸æœºæŠ–åŠ¨å’Œå·å¸˜å¿«é—¨æ‰­æ›²ä¸»è¦æ¥è‡ªæ—‹è½¬ã€‚ä¹‹æ‰€ä»¥å¦‚æ­¤ï¼Œæ˜¯å› ä¸ºå¹³ç§»éšç€æ·±åº¦çš„å¢åŠ è€Œè¿…é€Ÿè¡°å‡ï¼Œå¹¶ä¸”ç‰©ä½“é€šå¸¸ç¦»é•œå¤´è¶³å¤Ÿè¿œï¼Œå¹³ç§»ç›¸æœºæŠ–åŠ¨ä¸ä¼šåœ¨å›¾åƒä¸­äº§ç”Ÿæ˜æ˜¾çš„è¿åŠ¨ã€‚ è¿™ä¸€ç»“è®ºå¾—åˆ°äº†æˆ‘ä»¬çš„ç¨³å®šç»“æœçš„æ”¯æŒã€‚</p><h2 id="camera-model">Camera Model</h2><p>æˆ‘ä»¬çš„æ—‹è½¬å·å¸˜å¿«é—¨ç›¸æœºæ¨¡å‹åŸºäºé’ˆå­”ç›¸æœºæ¨¡å‹ã€‚åœ¨é’ˆå­”ç›¸æœºä¸­ï¼Œå›¾åƒä¹‹é—´çš„å…³ç³»åœ¨é½æ¬¡åæ ‡ä¸­çš„ç‚¹ x å’Œå¯¹åº”ç‚¹åœ¨ 3D ä¸–ç•Œåæ ‡ç³»ä¸­çš„ Xï¼ˆå›¾ 2ï¼‰å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¡¨ç¤ºï¼š</p><p><span class="math display">\[x=KX, X=\lambda K^{-1}x \tag1\]</span></p><p>å…¶ä¸­<span class="math inline">\(\lambda\)</span>æ˜¯æœªçŸ¥æ¯”ä¾‹å› å­ï¼Œ<span class="math inline">\(K\)</span>æ˜¯ç›¸æœºå†…å‚çŸ©é˜µï¼Œæˆ‘ä»¬å‡å®šå†…å‚çŸ©é˜µçš„é€†å¦‚ä¸‹ï¼š</p><p><span class="math display">\[K^{-1} = \begin{bmatrix} 1 &amp; 0 &amp; -o_x\\ 0 &amp; 1 &amp; -o_y\\ 0 &amp; 0 &amp; f \end{bmatrix} \tag2\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\((o_x, o_y)\)</span> æ˜¯å›¾åƒå¹³é¢ä¸­ç›¸æœºè½´çš„åŸç‚¹åæ ‡ï¼Œf æ˜¯ç„¦è·ã€‚</p><h2 id="camera-motion">Camera Motion</h2><p>æˆ‘ä»¬å°†ä¸–ç•ŒåŸç‚¹è®¾ç½®åœ¨ç›¸æœºåŸç‚¹ã€‚ç„¶åå¯ä»¥ç”¨ R(t) æ¥æè¿°ç›¸æœºåœ¨æ—¶é—´ t æ—¶åˆ»çš„è¿åŠ¨ã€‚å› æ­¤ï¼Œå¯¹äºä»»ä½•ä¸–ç•Œåæ ‡ç‚¹ç‚¹ Xï¼Œå¯¹åº”çš„å›¾åƒç‚¹ x åœ¨æ—¶é—´ t ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[x = KR(t)X \tag3\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs3.png"></p><p>æ—‹è½¬çŸ©é˜µ<span class="math inline">\(R(t) \in SO(3)\)</span>æ˜¯é€šè¿‡ç›¸æœºæ—‹è½¬è§’åº¦<span class="math inline">\(\Delta \theta (t)\)</span>è®¡ç®—å¾—åˆ°çš„ã€‚ç„¶åå¯¹å…¶ä½¿ç”¨ SLERPï¼ˆçƒå½¢å››å…ƒæ•°çº¿æ€§æ’å€¼ï¼‰æ¥å¹³æ»‘çš„å¾—åˆ°è¶³å¤Ÿå¤šçš„æ—‹è½¬çŸ©é˜µã€‚<span class="math inline">\(\Delta \theta (t)\)</span>å¯ä»¥é€šè¿‡é™€èºä»ªçš„è§’é€Ÿåº¦è·å¾—ï¼š</p><p><span class="math display">\[\Delta \theta (t) = (w(t + t_d) + w_d) * dt \tag4\]</span></p><p>è¿™é‡Œ<span class="math inline">\(w_d\)</span>æ˜¯é™€èºä»ªæ¼‚ç§»ï¼Œ<span class="math inline">\(t_d\)</span>æ˜¯é™€èºä»ªå’Œç›¸æœºæ—¶é—´æˆ³çš„å·®ï¼Œè¿™äº›å‚æ•°éƒ½æ˜¯æœªçŸ¥çš„éœ€è¦è¿›è¡Œæ ¡å‡†è·å¾—ã€‚</p><h2 id="rolling-shutter-compensation">Rolling Shutter Compensation</h2><p>æˆ‘ä»¬ç°åœ¨å°†å·å¸˜å¿«é—¨çš„æ¦‚å¿µå¼•å…¥æˆ‘ä»¬çš„ç›¸æœºæ¨¡å‹ä¸­ã€‚åœ¨ RS ç›¸æœºä¸­ï¼Œæ¯ä¸ªå›¾åƒè¡Œçš„æ›å…‰æ—¶é—´ç•¥æœ‰ä¸åŒï¼Œå› æ­¤æ›å…‰æœŸé—´ç›¸æœºçš„æ—‹è½¬å°†å¯¼è‡´å›¾åƒçš„æ‰­æ›²ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç›¸æœºåœ¨å¿«é—¨æ»šåŠ¨æ—¶å·¦å³æ‘‡æ‘†ï¼Œåˆ™è¾“å‡ºå›¾åƒå°†æ‰­æ›²ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚æ›´æ­£å¼åœ°è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ x åœ¨æ—¶é—´ t(i, y) æœŸé—´æˆåƒï¼š</p><p><span class="math display">\[t(i,y) = t_i + t_s * y / h; where  x = (x,y,1)^T \tag5\]</span></p><p>å…¶ä¸­ y æ˜¯ç‚¹ x å¯¹åº”çš„å›¾åƒè¡Œï¼Œh æ˜¯å¸§ä¸­çš„æ€»è¡Œæ•°ï¼Œ<span class="math inline">\(t_i\)</span>æ˜¯ç¬¬ i å¸§çš„æ—¶é—´æˆ³ã€‚ <span class="math inline">\(t_s\)</span>æ˜¯ä¸€å¸§æ›å…‰æ‰€éœ€æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ä»ä¸Šåˆ°ä¸‹é€è¡Œè¯»å‡ºå®Œæ•´å¸§æ‰€éœ€çš„æ—¶é—´ã€‚</p><h2 id="image-warping">Image Warping</h2><p>ç°åœ¨æˆ‘ä»¬æ¨å¯¼å‡ºä¸€å¸§å›¾åƒä¸¤ä¸ªåæ ‡ç‚¹ä¹‹é—´çš„æ—‹è½¬å…³ç³»ã€‚å¯¹äºåœºæ™¯ç‚¹ Xï¼Œåœ¨ i å¸§å’Œ j å¸§çš„å›¾åƒå¹³é¢ä¸­çš„æŠ•å½±ç‚¹<span class="math inline">\(x_i\)</span>å’Œ<span class="math inline">\(x_j\)</span>ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[x_i = KR(t(i,y_i))X, and x_j = KR(t(j,y_j))X \tag6\]</span></p><p>è”ç«‹ä¸¤å¼æ•´ç†å¾—åˆ°ï¼š</p><p><span class="math display">\[x_j = KR(t(j,y_j))R^{T}(t(i,y_i))K^{-1}x_i \tag7\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs4.png"></p><p>æƒ³åœ¨æˆ‘ä»¬å·²ç»è€ƒè™‘äº†åŒä¸€ä¸ªè§†é¢‘ä¸­çš„ä¸¤å¸§ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬åŠ å…¥é™åˆ¶æ¡ä»¶ä¸¤å¸§å›¾åƒçš„åŸç‚¹ç›¸åŒï¼Œå°†<span class="math inline">\(R(t)\)</span>æ˜ å°„åˆ°<span class="math inline">\(R'(t)\)</span>, ç°åœ¨é‡æ–°å®šä¹‰æ‰­æ›²çŸ©é˜µå°†ä¸€ä¸ªç‚¹æ˜ å°„åˆ°å¦ä¸€ä¸ªç›¸æœºåæ ‡ç³»ä¸‹ï¼š</p><p><span class="math display">\[W(t1,t2) = KR'(t1)R^T(t2)K^{-1} \tag8\]</span></p><p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ï¼š</p><p><span class="math display">\[x_j = W(t(j,y_j),t(i,y_i))x_i, R' = R \tag9\]</span></p><p>è¿˜è¦æ³¨æ„ï¼ŒW åˆ†åˆ«å–å†³äºå›¾åƒç‚¹<span class="math inline">\(x_i\)</span>å’Œ<span class="math inline">\(x_j\)</span>çš„å›¾åƒè¡Œ<span class="math inline">\(y_i\)</span>å’Œ<span class="math inline">\(y_j\)</span>ã€‚è¯¥å˜æ¢çŸ©é˜µå¯ç”¨äºå°†å¸§ i ä¸­çš„ç‚¹ä¸å¸§ j ä¸­çš„å¯¹åº”ç‚¹è¿›è¡ŒåŒ¹é…ï¼ŒåŒæ—¶åœ¨ä¸¤å¸§ä¸­éƒ½è€ƒè™‘å·å¸˜å¿«é—¨çš„å½±å“ã€‚ç»™å®šè¿™ç§å˜å½¢çŸ©é˜µçš„å…¬å¼ï¼Œæ»šåŠ¨å¿«é—¨æ ¡æ­£å’Œè§†é¢‘ç¨³å®šçš„ç®—æ³•å°±å˜å¾—ç®€å•äº†ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰å¹³æ»‘è¿åŠ¨å’Œå…¨å±€å¿«é—¨çš„åˆæˆè§†é¢‘ã€‚è¯¥ç›¸æœºçš„è¿åŠ¨æ˜¯é€šè¿‡å¯¹è¾“å…¥ç›¸æœºçš„è¿åŠ¨åº”ç”¨é«˜æ–¯ä½é€šæ»¤æ³¢å™¨æ¥è®¡ç®—çš„ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ç»„æ–°çš„æ—‹è½¬çŸ©é˜µ R0ã€‚æˆ‘ä»¬å°†åˆæˆç›¸æœºçš„æ»šåŠ¨å¿«é—¨æŒç»­æ—¶é—´ ts è®¾ç½®ä¸º 0ï¼ˆå³å…¨å±€å¿«é—¨ï¼‰ï¼Œç„¶åæˆ‘ä»¬åœ¨å½“å‰å¸§ i çš„æ¯ä¸ªå›¾åƒè¡Œ<span class="math inline">\(y_i\)</span>å¤„è®¡ç®—<span class="math inline">\(W(t_i; t(i; y_i))\)</span>ï¼Œå¹¶å°†æ‰­æ›²åº”ç”¨äºè¯¥è¡Œã€‚ è¯·æ³¨æ„ W çš„ç¬¬ä¸€é¡¹ç°åœ¨ä»…å–å†³äºå¸§æ—¶é—´<span class="math inline">\(t_i\)</span>ã€‚æ­¤æ“ä½œå°†æ‰€æœ‰è¾“å…¥å¸§æ˜ å°„åˆ°æˆ‘ä»¬çš„åˆæˆè§†é¢‘ä¸Šï¼›å› æ­¤å¯ä»¥åŒæ—¶æ¶ˆé™¤æ»šåŠ¨å¿«é—¨æ‰­æ›²å’Œè§†é¢‘æŠ–åŠ¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs5.png"></p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸ä¼šä¸ºæ¯ä¸ªå›¾åƒè¡Œ<span class="math inline">\(y_i\)</span>è®¡ç®—<span class="math inline">\(W(t_i; t(i; y_i))\)</span>ã€‚ç›¸åæˆ‘ä»¬ç»†åˆ†è¾“å…¥å›¾åƒï¼ˆå›¾ 5aï¼‰å¹¶è®¡ç®—æ¯ä¸ªå‚ç›´ç»†åˆ†çš„æ‰­æ›²ï¼ˆå›¾ 5c å’Œ 5dï¼‰ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬ä»è¾“å…¥å›¾åƒåˆ›å»ºä¸€ä¸ªæ‰­æ›²çš„ç½‘æ ¼ï¼Œå®ƒæ˜¯éçº¿æ€§æ‰­æ›²çš„åˆ†æ®µçº¿æ€§è¿‘ä¼¼ã€‚æˆ‘ä»¬å‘ç°åä¸ªç»†åˆ†é€šå¸¸è¶³ä»¥å»é™¤ä»»ä½•å¯è§çš„ RS æ‹–å½±ã€‚Forssen å’Œ Ringaby [2010] å°†è¿™ç§é‡‡æ ·æ–¹æ³•ç§°ä¸ºÂ´é€†æ’å€¼ã€‚ä»–ä»¬è¿˜æå‡ºäº†ä¸¤ç§é¢å¤–çš„æ’å€¼æŠ€æœ¯ï¼Œä»–ä»¬å‡­ç»éªŒè¯æ˜åœ¨åˆæˆè§†é¢‘æ•°æ®é›†ä¸Šè¡¨ç°æ›´å¥½ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä½¿ç”¨é€†æ’å€¼æ˜¯å› ä¸ºä½¿ç”¨é¡¶ç‚¹ç€è‰²å™¨å¾ˆå®¹æ˜“åœ¨ GPU ä¸Šå®ç°ä¸€ä¸ªé«˜æ•ˆçš„ç‰ˆæœ¬ã€‚GPU çš„ç‰‡æ®µç€è‰²å™¨è´Ÿè´£ä½¿ç”¨åŒçº¿æ€§æ’å€¼å¯¹ç½‘æ ¼æ‰­æ›²å›¾åƒè¿›è¡Œé‡æ–°é‡‡æ ·ã€‚æˆ‘ä»¬å‘ç°ï¼Œç”±äºåŒçº¿æ€§é€†æ’å€¼å®é™…è§†é¢‘ä¸­çš„ RS æ‰­æ›²é€šå¸¸ä¸è¶³ä»¥äº§ç”Ÿæ··å æ‹–å½±ï¼Œå› æ­¤é€†æ’å€¼åœ¨å®è·µä¸­æ•ˆæœä¹Ÿå¾ˆå¥½ã€‚</p><h1 id="camera-and-gyroscope-calibration">Camera and Gyroscope Calibration</h1><p>æˆ‘ä»¬ç°åœ¨å±•ç¤ºç”¨äºæ‰¾åˆ°æœªçŸ¥çš„ç›¸æœºå’Œé™€èºä»ªå‚æ•°ã€‚ è¿™ä¸ªæ ¡å‡†æ­¥éª¤æ˜¯å¿…è¦çš„ï¼Œå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥ä»é™€èºä»ªæ•°æ®ä¸­è®¡ç®— Wã€‚ æˆ‘ä»¬æ¨¡å‹ä¸­çš„æœªçŸ¥å‚æ•°æ˜¯ï¼šç›¸æœºçš„ç„¦è· fã€æ»šåŠ¨å¿«é—¨çš„æŒç»­æ—¶é—´ <span class="math inline">\(t_s\)</span>ã€é™€èºä»ªå’Œå¸§æ ·æœ¬æ—¶é—´æˆ³ä¹‹é—´çš„å»¶è¿Ÿ <span class="math inline">\(t_d\)</span> ä»¥åŠé™€èºä»ªæ¼‚ç§» <span class="math inline">\(w_d\)</span></p><p>è¯·æ³¨æ„ï¼Œåˆ¶é€ å•†å¯èƒ½ä¼šç»™å®šå…¶ä¸­ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚ç›¸æœºçš„ç„¦è·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®éªŒæµ‹é‡è¿™äº›å‚æ•°ã€‚ ä¾‹å¦‚ï¼ŒForssen å’Œ Ringaby [2010] ä½¿ç”¨å¿«é€Ÿé—ªçƒçš„æ˜¾ç¤ºå™¨æ¥æµ‹é‡æ»šåŠ¨å¿«é—¨æŒç»­æ—¶é—´ <span class="math inline">\(t_s\)</span>ã€‚ ç„¶è€Œè¿™äº›æŠ€æœ¯å¾€å¾€ä¸ç²¾ç¡®ä¸”å®¹æ˜“å‡ºé”™ï¼›è€Œä¸”å®ƒä»¬ä¹Ÿå¤ªç¹çï¼Œæ™®é€šç”¨æˆ·æ— æ³•æ‰§è¡Œã€‚æ»šåŠ¨å¿«é—¨çš„æŒç»­æ—¶é—´é€šå¸¸åœ¨æ¯«ç§’èŒƒå›´å†…ã€‚å› æ­¤ï¼Œ<span class="math inline">\(t_d\)</span> æˆ–<span class="math inline">\(t_s\)</span>ä¸­çš„å°åå·®å°†å¯¼è‡´å·å¸˜é—¨æ•´æµå¤±è´¥ã€‚</p><p>æˆ‘ä»¬çš„æ–¹æ³•æ˜¯ä»å•ä¸ªè§†é¢‘å’Œé™€èºä»ªæ•è·ä¸­ä¼°è®¡è¿™äº›å‚æ•°ã€‚ç”¨æˆ·è¢«è¦æ±‚è®°å½•è§†é¢‘å’Œé™€èºä»ªè½¨è¿¹ï¼Œåœ¨é‚£é‡Œä»–ä»¬ç«™ç€ä¸åŠ¨å¹¶åœ¨æŒ‡å‘å»ºç­‘ç‰©æ—¶æ™ƒåŠ¨ç›¸æœºã€‚æŒç»­æ—¶é—´çº¦ä¸º 10 ç§’çš„çŸ­ç‰‡é€šå¸¸ä»¥ä¼°è®¡æ‰€æœ‰æœªçŸ¥æ•°ã€‚ è¯·æ³¨æ„ï¼Œè¿™åªéœ€ä¸ºæ¯ä¸ªæ‘„åƒå¤´å’Œé™€èºä»ªè®¾ç½®å®Œæˆä¸€æ¬¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs6.png"></p><p>åœ¨æˆ‘ä»¬çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ SIFT [Lowe 2004] åœ¨è¿ç»­è§†é¢‘å¸§ä¸­æ‰¾åˆ°åŒ¹é…ç‚¹ï¼Œå¹¶ä¸”æˆ‘ä»¬ä½¿ç”¨ RANSAC [Fischler and Bolles 1981] æ¥ä¸¢å¼ƒå¼‚å¸¸å€¼ã€‚ ç»“æœæ˜¯æ•è·è§†é¢‘ä¸­æ‰€æœ‰ç›¸é‚»å¸§çš„ä¸€ç»„ç‚¹å¯¹åº”å…³ç³» <span class="math inline">\(x_i\)</span> å’Œ <span class="math inline">\(x_j\)</span> ï¼ˆå›¾ 6ï¼‰ã€‚é‰´äºè¿™ä¸€åŸºæœ¬äº‹å®ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ ¡å‡†è¡¨è¿°ä¸ºä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›æœ€å°åŒ–æ‰€æœ‰ç‚¹å¯¹åº”çš„å‡æ–¹é‡æŠ•å½±è¯¯å·®ï¼š</p><p><span class="math display">\[J = \sum_{i,j} \left \| x_j - W(t(j,yj); t(i, yi))x_i \right \|^2 \tag{10}\]</span></p><p>è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªéçº¿æ€§ä¼˜åŒ–é—®é¢˜ã€‚è®¸å¤šéçº¿æ€§ä¼˜åŒ–å™¨å¯ç”¨äºæœ€å°åŒ–æˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°ã€‚ ç„¶è€Œï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡ç›´æ¥ç›®æ ‡å‡½æ•°è¯„ä¼°çš„åæ ‡ä¸‹é™å¯ä»¥å¿«é€Ÿæ”¶æ•›ã€‚æ¯æ¬¡æˆ‘ä»¬åœ¨ç›®æ ‡å‡½æ•° J ä¸å‡å°çš„æƒ…å†µä¸‹è¿ˆå‡ºä¸€æ­¥ï¼Œæˆ‘ä»¬å°±åè½¬æ­¥é•¿æ–¹å‘å¹¶å‡å°ç›¸åº”å‚æ•°çš„æ­¥é•¿ã€‚ä¸€æ—¦æ‰€æœ‰å‚æ•°çš„æ­¥é•¿é™åˆ°æ‰€éœ€é˜ˆå€¼ä»¥ä¸‹ï¼ˆå³ï¼Œå½“æˆ‘ä»¬è¾¾åˆ°ç›®æ ‡ç²¾åº¦æ—¶ï¼‰ï¼Œç®—æ³•å°±ä¼šç»ˆæ­¢ã€‚å¯¹äºæ—¶é•¿çº¦ 10 ç§’çš„æ ¡å‡†è§†é¢‘ï¼Œæˆ‘ä»¬çš„ Matlab/C++ å®ç°é€šå¸¸ä¼šåœ¨ 2 ç§’å†…æ”¶æ•›ã€‚</p><p>æˆ‘ä»¬é€šè¿‡å°†ç„¦è·è®¾ç½®ä¸ºç›¸æœºå…·æœ‰ 45Â° çš„è§†é‡æ¥åˆå§‹åŒ–ä¼˜åŒ–ç®—æ³•ï¼Œå¹¶å°†æ‰€æœ‰å…¶ä»–å‚æ•°è®¾ç½®ä¸º 0ã€‚æˆ‘ä»¬å‘ç°åœ¨è¿™äº›åˆå§‹æ¡ä»¶ä¸‹ï¼Œä¼˜åŒ–å™¨æ”¶æ•›åˆ°æˆ‘ä»¬æ•°æ®é›†çš„æ­£ç¡®è§£ã€‚ æ›´ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡æ–°å¯åŠ¨æˆ‘ä»¬çš„åæ ‡ä¸‹é™ç®—æ³•ä»¥è·å–ä¸€ç³»åˆ—åˆç†å‚æ•°å¹¶é€‰æ‹©æœ€ä½³è§£å†³æ–¹æ¡ˆæ¥é¿å…é™·å…¥å±€éƒ¨æœ€å°å€¼ï¼ˆä¾‹å¦‚ï¼Œå½“é™€èºä»ªå’Œå¸§æ—¶é—´æˆ³ä¹‹é—´çš„å»¶è¿Ÿå¾ˆå¤§æ—¶ï¼‰ã€‚æ­£ç¡®æ¢å¤å‚æ•°çš„å¹³å‡é‡æ–°æŠ•å½±è¯¯å·®é€šå¸¸çº¦ä¸º 1 ä¸ªåƒç´ ã€‚</p><p>æˆ‘ä»¬æ¨¡å‹ä¸­çš„å¦ä¸€ä¸ªæœªçŸ¥æ•°æ˜¯é™€èºä»ªä¸ç›¸æœºçš„ç›¸å¯¹æ–¹å‘ã€‚ ä¾‹å¦‚ï¼Œç»•é™€èºä»ª y è½´çš„æ—‹è½¬å¯ä»¥å¯¹åº”äºç»•ç›¸æœº x è½´çš„æ—‹è½¬ã€‚ä¸ºäº†å‘ç°é™€èºä»ªçš„æ–¹å‘ï¼Œæˆ‘ä»¬æ’åˆ—äº†å®ƒçš„ 3 ä¸ªæ—‹è½¬è½´å¹¶ä¸ºæ¯ä¸ªæ’åˆ—è¿è¡Œæˆ‘ä»¬çš„ä¼˜åŒ–å™¨ï¼Œæœ€å°åŒ–ç›®æ ‡çš„æ’åˆ—æœ€å¥½å¯¹åº”äºç›¸æœºçš„è½´é¡ºåºã€‚æˆ‘ä»¬å‘ç°ä¸æ­£ç¡®æ’åˆ—çš„é‡æŠ•å½±è¯¯å·®è¦å¤§å¾—å¤šã€‚ å› æ­¤ï¼Œè¿™ç§æ–¹æ³•åœ¨å®è·µä¸­æ•ˆæœå¾ˆå¥½ã€‚</p><p>åœ¨æˆ‘ä»¬çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç›¸æœºå…·æœ‰å‚ç›´æ»šåŠ¨å¿«é—¨ã€‚RS æ¨¡å‹å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹ä¸ºé€‚ç”¨äºå›¾åƒåˆ—è€Œä¸æ˜¯è¡Œã€‚ æ‰¾åˆ°ä¸¤ç§æƒ…å†µä¸‹çš„æœ€å°é‡æŠ•å½±è¯¯å·®å°†å‘Šè¯‰æˆ‘ä»¬ç›¸æœºæ˜¯å¦å…·æœ‰æ°´å¹³æˆ–å‚ç›´æ»šåŠ¨å¿«é—¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/dvs7.png"></p><p>æœ€åï¼Œä¸ºäº†æ›´å¥½åœ°äº†è§£æ ¡å‡†æ‰€è·å¾—çš„ç»“æœï¼Œæˆ‘ä»¬å±•ç¤ºäº†æ ¡å‡†å‰åè§†é¢‘å’Œé™€èºä»ªä¿¡å·çš„å¯è§†åŒ–æ•ˆæœã€‚ å¦‚æœæˆ‘ä»¬å‡è®¾è¿ç»­å¸§ä¹‹é—´çš„æ—‹è½¬å¾ˆå°ï¼Œé‚£ä¹ˆå›¾åƒä¸­çš„å¹³ç§»å¯ä»¥é€šè¿‡æ—‹è½¬è¿‘ä¼¼è®¡ç®—å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\dot{x} \approx f * \hat{\omega }(t+t_d), where \left\{\begin{matrix}\dot{x} = (\dot{x},\dot{y})^T\\\dot{y} = (w_y,w_x)^T\end{matrix}\right. \tag{11}\]</span></p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜å‡è®¾æ»šåŠ¨å¿«é—¨æ²¡æœ‰å½±å“ï¼ˆå³ <span class="math inline">\(t_s\)</span> = 0ï¼‰ï¼Œå¹¶ä¸”æˆ‘ä»¬å¿½ç•¥ç»• z è½´çš„æ—‹è½¬ï¼ˆå³ <span class="math inline">\(\omega_z\)</span>ï¼‰ã€‚ æˆ‘ä»¬è®© <span class="math inline">\(\dot{x}\)</span> æ˜¯è¿ç»­å¸§ä¸­æ‰€æœ‰ç‚¹å¯¹åº”æ²¿ x å’Œ y çš„å¹³å‡å¹³ç§»ç‡ã€‚ å¦‚æœæˆ‘ä»¬çš„ä¼˜åŒ–å™¨æ”¶æ•›åˆ°æ­£ç¡®çš„ç„¦è· f å’Œé™€èºå»¶è¿Ÿ <span class="math inline">\(t_d\)</span>ï¼Œé‚£ä¹ˆä¸¤ä¸ªä¿¡å·åº”è¯¥å¯¹é½ã€‚ å›¾ 7 ç»˜åˆ¶äº†å¯¹é½å‰åä¿¡å· <span class="math inline">\(\dot{x}\)</span> å’Œ <span class="math inline">\(f âˆ— \hat{\omega }(t + t_d)\)</span> çš„ç¬¬ä¸€ç»´ã€‚ è¯·æ³¨æ„é™€èºä»ªæ•°æ®ä¸å›¾åƒè¿åŠ¨çš„åŒ¹é…ç¨‹åº¦ã€‚ MEMS é™€èºä»ªçš„è¿™ç§æƒŠäººçš„ç²¾åº¦ä½¿æˆ‘ä»¬çš„æ–¹æ³•èƒ½å¤Ÿåœ¨è§†é¢‘ç¨³å®šå’Œæ»šåŠ¨å¿«é—¨æ ¡æ­£ä»»åŠ¡ä¸Šè¡¨ç°è‰¯å¥½ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>&lt; Digital Video Stabilization and Rolling Shutter Correction using Gyroscopes &gt;</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäº IMU ä¼ æ„Ÿå™¨çš„è§†é¢‘ç¨³å®šæ··åˆè¿åŠ¨ä¼°è®¡</title>
      <link href="/2021/Science/HybridMotionEstimationForVideoStabilizationBasedOnIMUSensor/"/>
      <url>/2021/Science/HybridMotionEstimationForVideoStabilizationBasedOnIMUSensor/</url>
      
        <content type="html"><![CDATA[<h2 id="abstract">Abstract</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ··åˆæ–¹æ³•æ¥ä¼°è®¡è¿åŠ¨å¹¶é€šè¿‡åˆ‡æ¢å‡½æ•°ç¨³å®šè§†é¢‘ï¼Œè¯¥æ–¹æ³•åœ¨ Kanade-Lucus-Tomasi (KLT) è·Ÿè¸ªå™¨å’Œ IMU è¾…åŠ©è¿åŠ¨ä¼°è®¡å™¨ä¹‹é—´åˆ‡æ¢ä¼°è®¡çš„è¿åŠ¨ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œç”±äº KLT è·Ÿè¸ªå™¨åœ¨è¾ƒå¤§è¿åŠ¨æœŸé—´çš„æ€§èƒ½ä¸ä½³ï¼Œæˆ‘ä»¬ä½¿ç”¨ KLT è·Ÿè¸ªå™¨æ¥æ ¡æ­£ä½æ—‹è½¬çš„è¿åŠ¨ï¼Œå¹¶ä½¿ç”¨ IMU è¾…åŠ©è¿åŠ¨ä¼°è®¡å™¨æ¥æ ¡æ­£é«˜æ—‹è½¬ï¼Œæ­¤å¤–ï¼Œå¡å°”æ›¼æ»¤æ³¢å™¨ç”¨äºå»é™¤ä¸éœ€è¦çš„è¿åŠ¨ï¼Œä»è€Œå¹³æ»‘è½¨è¿¹ã€‚</p><span id="more"></span><h1 id="introduction">Introduction</h1><p>åœ¨ç›¸æœºå¸‚åœºï¼Œå…‰å­¦å›¾åƒç¨³å®šï¼ˆOISï¼‰ç³»ç»Ÿå®‰è£…åœ¨ç›¸æœºé•œå¤´æˆ–å›¾åƒä¼ æ„Ÿå™¨ä¸Šï¼Œä»·æ ¼ç›¸å½“æ˜‚è´µ [3]ã€‚å¦ä¸€æ–¹é¢ï¼Œæ•°å­—ç¨³å®šç³»ç»Ÿé€šè¿‡åœ¨ç›¸æœºç§»åŠ¨æ—¶è¡¥å¿æ•è·å›¾åƒçš„ç§»åŠ¨æ¥å¤„ç†å›¾åƒï¼Œå®ƒå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œå³è¿åŠ¨ä¼°è®¡ã€è¿åŠ¨å¹³æ»‘å’Œå›¾åƒæ‰­æ›² [4,5]ã€‚</p><p>æ•°å­—è§†é¢‘ç¨³å®šä¸­è¿åŠ¨ä¼°è®¡çš„å¸¸ç”¨æŠ€æœ¯æ˜¯åˆ†åˆ«ä½¿ç”¨å—åŒ¹é… [9]ã€KLT (Kanade-Lucus-Tomasi) è·Ÿè¸ªå™¨ [10,11]ã€SIFT [12] å’Œ SURF [13]ã€‚æœ€è¿‘ï¼ŒDong et al. [14] and Lim ç­‰äºº [15] ä½¿ç”¨ KLT è·Ÿè¸ªå™¨ä»¥é«˜å¸§ç‡å’Œä½è®¡ç®—æˆæœ¬å®æ—¶ä¼°è®¡è¿åŠ¨ï¼Œ KLT è·Ÿè¸ªå™¨é€šè¿‡ Good Feature to Track æ£€æµ‹ç‰¹å¾ç‚¹ï¼Œå¹¶ä½¿ç”¨ Lucas-Kanade æ–¹æ³•ä¼°è®¡è¿ç»­å¸§çš„å…‰æµã€‚è¯¥è·Ÿè¸ªå™¨åœ¨è¯„ä¼°å°è¿åŠ¨ä¸­çš„è¿åŠ¨æ–¹é¢å–å¾—äº†æˆåŠŸï¼Œä½†åœ¨å±€éƒ¨è¿åŠ¨å’Œå…¨å±€è¿åŠ¨å‘ç”Ÿæ˜¾ç€å˜åŒ–æ—¶å¤±è´¥ [15]ï¼Œç„¶è€Œï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ IMUï¼ˆæƒ¯æ€§æµ‹é‡å•å…ƒï¼‰æ•°æ®æ¥ä¼°è®¡å¤§è¿åŠ¨ã€‚</p><p>æˆ‘ä»¬æå‡ºäº†ä¸€ç§æ··åˆå‡½æ•°æ¥åˆ‡æ¢è¿åŠ¨ä¼°è®¡ç®—æ³•ï¼Œä»¥ç¡®å®šä¸¤ä¸ªè¿ç»­å¸§ä¹‹é—´çš„è½¬æ¢ã€‚ åœ¨ä½è¿åŠ¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”ç”¨ KLT è·Ÿè¸ªå™¨æ¥è®¡ç®—ä¸¤ä¸ªè¿ç»­å¸§ä¸Šè¿åŠ¨ç‰©ä½“çš„å…‰æµã€‚ ç„¶è€Œï¼Œåœ¨å¿«é€Ÿæ—‹è½¬çš„æƒ…å†µä¸‹ï¼Œæ¥è‡ª IMU ä¼ æ„Ÿå™¨çš„æ—‹è½¬æ•°æ®ç”¨äºé€šè¿‡è®¡ç®—æ¥è‡ªé¢„å®šä¹‰è¿åŠ¨ç‚¹å’Œå‚è€ƒç‚¹çš„è¿åŠ¨æ¥ä¼°è®¡è¿åŠ¨ã€‚</p><h1 id="related-work">Related Work</h1><p>Karpenko ç­‰äºº [3] ä»…ä½¿ç”¨é™€èºä»ªæ•°æ®åˆ›å»ºæ»šåŠ¨å¿«é—¨ä»¥å®ç°è§†é¢‘ç¨³å®šã€‚æ­¤å¤–ï¼Œä¸€äº›ç ”ç©¶åˆ†åˆ«åŒ…æ‹¬ IMU æ•°æ®å’Œç‰¹å¾è·Ÿè¸ªï¼Œä¾‹å¦‚ Ryu ç­‰äºº [26] æå‡ºäº†é€šè¿‡å°†æ—‹è½¬è¿åŠ¨çº³å…¥ KLT è·Ÿè¸ªçš„è¿åŠ¨ä¼°è®¡ï¼Œå®ƒä½¿ç”¨æ¥è‡ª IMU çš„ä½ç½®æ¥é¢„æµ‹ä¸‹ä¸€å¸§ï¼Œä»è€Œè¯æ˜é€Ÿåº¦å’Œå‡†ç¡®æ€§ã€‚</p><h1 id="proposed-framework">Proposed Framework</h1><p>æœ¬æ–‡çš„æŒ‘æˆ˜æ˜¯å¦‚ä½•ä¼°è®¡è¿ç»­å¸§åœ¨ç§»åŠ¨ç›¸æœºä¸Šçš„è¿åŠ¨ï¼Œä¾‹å¦‚ï¼Œç”±äºç›¸æœºæ—‹è½¬å¼•èµ·çš„å¤§æ—‹è½¬å’ŒåŸºäºåœºæ™¯ä¸­è¿åŠ¨ç‰©ä½“çš„å±€éƒ¨è¿åŠ¨ã€‚ æ ¹æ®æˆ‘ä»¬çš„ç›®æ ‡ï¼Œæˆ‘ä»¬åº”ç”¨äº†ä¸€ç§æ··åˆæ–¹æ³•æ¥è¿‘ä¼¼ç¡®å®šä¼°è®¡ç§»åŠ¨ç›¸æœºè¿åŠ¨çš„æ–¹æ³•ï¼Œå¦‚å›¾ 1 ä¸­çš„æµç¨‹å›¾æ‰€ç¤ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm1.png"></p><p>ä¸ºäº†ä½¿ç”¨æ··åˆæ–¹æ³•ä¼°è®¡è¿åŠ¨ï¼Œæˆ‘ä»¬é‡‡ç”¨ç”± IMU ä¼ æ„Ÿå™¨ <span class="math inline">\(w^{imu}\)</span> æµ‹é‡å’Œç›¸æœº<span class="math inline">\(w^{cam}\)</span>çš„æ—‹è½¬é€Ÿåº¦æ¥ç¡®å®šä¼°è®¡æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œè¿™ä¸¤ä¸ªè®¾å¤‡æ˜¯ä¸åŒçš„ä½ç½®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†<span class="math inline">\(w^{imu}\)</span>è½¬æ¢ä¸ºå…·æœ‰ç›¸å¯¹æ–¹å‘ <span class="math inline">\(R^{ci}\)</span> çš„ <span class="math inline">\(w^{cam}\)</span>ã€‚ å› æ­¤ï¼Œç›¸æœºçš„æ—‹è½¬é€Ÿåº¦å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[w^{cam}(t+t_{off}) = R^{ci}(w^{imu}(t) + b^{imu}) \tag1\]</span></p><p>å…¶ä¸­ <span class="math inline">\(b^{imu}\)</span> æ˜¯é™€èºä»ªåç½®ï¼Œ<span class="math inline">\(t_{off}\)</span> è¡¨ç¤ºæ¥è‡ª IMU çš„æ—¶é—´æˆ³ä¸ Cam æ—¶é—´æˆ³çš„æ—¶é—´åç§»ã€‚ç›¸æœºå’Œ IMU ä¼ æ„Ÿå™¨æ ¡å‡†å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨ OpenCVï¼ˆå¼€æºè®¡ç®—æœºè§†è§‰ï¼‰ä¸­çš„ç›¸æœºæ ¡å‡†æ¨¡å—æ ¡å‡†ç›¸æœºä»¥æ‰¾å‡ºç„¦è·ï¼ˆfï¼‰ã€‚</li><li>æ ¡å‡†é™€èºä»ªä»¥é˜²æ­¢é™€èºä»ªæ¼‚ç§»é—®é¢˜ä¸åç½®åç§»ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æµ‹é‡é™€èºä»ªé•¿æ—¶é—´é™æ­¢æ—¶çš„è¾“å‡ºä¿¡å·æ¥è¯„ä¼°åç½®åç§»ï¼Œå¹¶é€šè¿‡å¡å°”æ›¼æ»¤æ³¢å™¨é™ä½å™ªå£°ã€‚</li><li>ä½¿ç”¨ Li å’Œ Ren [16] æå‡ºçš„é™€èºä»ªæ•°æ®å’Œå…‰æµä¹‹é—´çš„å…³ç³»ä¼°è®¡ <span class="math inline">\(R^{ci}\)</span>ï¼Œä½¿ç”¨ CC+LS13 æ–¹æ³•ã€‚</li><li>ç¡®å®šé™€èºä»ªå’Œç›¸æœºè¾“å…¥ä¹‹é—´çš„ <span class="math inline">\(t_{off}\)</span> æ—¶é—´åå·®ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ­£ç¡®ä¼°è®¡<span class="math inline">\(w^{cam}\)</span>ã€‚</li></ul><h1 id="motion-estimation">Motion Estimation</h1><p>ä¸ºäº†æŒ‘æˆ˜æ¯ä¸ªç¯å¢ƒä¸­çš„è¿åŠ¨ä¼°è®¡ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ç§å¯é ä¸”æœ‰æ•ˆçš„æ–¹æ³•ï¼Œç”¨äºé€šè¿‡æ··åˆç®—æ³•åˆ‡æ¢ç®—æ³•ï¼Œä»¥è®¡ç®—è¿ç»­å¸§çš„è¿åŠ¨æµã€‚ è¯¥æ–¹æ³•åˆ†ä¸ºä¸¤ä¸ªåŠŸèƒ½ï¼Œå…¶ä¸­åŒ…æ‹¬ KLT è·Ÿè¸ªå™¨å’Œ IMU è¾…åŠ©è¿åŠ¨ä¼°è®¡å™¨ã€‚</p><h2 id="a-klt-tracker">A KLT Tracker</h2><p>å¦‚æœ <span class="math inline">\(w^{cam}\)</span> z çš„ç»å¯¹å€¼å°äº 0.5 rad/sï¼Œåˆ™åˆšæ€§å˜æ¢ç”±ç›¸åº”çš„ç‰¹å¾ç‚¹é›†ä¼°è®¡ã€‚ æˆ‘ä»¬ä½¿ç”¨ Good Feature to Trackï¼Œè¿™æ˜¯ä¸€ç§å®æ—¶è®¡ç®—å…‰æµçš„é«˜æ•ˆæ£€æµ‹å™¨ã€‚ç‰¹å¾ç‚¹ç”± Harris è§’ç‚¹æ£€æµ‹å™¨æ£€æµ‹ï¼Œè¯¥æ£€æµ‹å™¨ä½¿ç”¨å¼ºåº¦å·®å¼‚å¯¹ (u, v) åœ¨æ‰€æœ‰æ–¹å‘ä¸Šçš„ä½ç§»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\varepsilon (u,v) = \sum_{x,y}^{} w(x,y)[I(x+u,y+v) - I(x,y)]^2 \\\approx \begin{bmatrix} u &amp; v\end{bmatrix} M \begin{bmatrix} u\\ v \end{bmatrix} \tag2\]</span></p><p>å…¶ä¸­ <span class="math inline">\(I(x, y)\)</span> è¡¨ç¤ºæ¥è‡ªå‚è€ƒå›¾åƒçš„å›¾åƒåƒç´ ï¼Œè€Œ <span class="math inline">\(I(x + u, y + v)\)</span> æ˜¯ä¸‹ä¸€å¼ å›¾åƒçš„å›¾åƒåƒç´ ã€‚ <span class="math inline">\(w(x, y)\)</span> æ˜¯ä¸€ä¸ªé«˜æ–¯å‡½æ•°ï¼Œå®ƒä¸ºå‘¨å›´çš„åƒç´ åˆ†é…æƒé‡ï¼Œ<span class="math inline">\(M\)</span> æ˜¯ä»ç‰¹å¾ç‚¹çš„æŒ‡å®šé‚»åŸŸä¸­å‡½æ•°çš„æ¢¯åº¦å¯¼å‡ºçš„æ±‡æ€»çŸ©é˜µã€‚æ­¤å¤–ï¼Œç”± Shi-Tomasi [29] ä¿®æ”¹çš„ Harris è§’ç‚¹æ£€æµ‹å™¨å¾—åˆ†å‡½æ•°æ˜¯ï¼š</p><p><span class="math display">\[R = min(\lambda _1,\lambda _2) \tag3\]</span></p><p>å…¶ä¸­ <span class="math inline">\(\lambda _1\)</span> å’Œ <span class="math inline">\(\lambda _2\)</span> æ˜¯ M çš„ç‰¹å¾å€¼ã€‚ R çš„ç»“æœå¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ol type="1"><li>å¦‚æœ<span class="math inline">\(\lambda _1\)</span>å’Œ<span class="math inline">\(\lambda _2\)</span>éƒ½å°ï¼Œè¿™æ„å‘³ç€ R ä¹Ÿå°ï¼Œåˆ™è¯¥åŒºåŸŸæ˜¯å¹³å¦çš„ï¼›</li><li>å¦‚æœ<span class="math inline">\(\lambda _1\)</span>å¤§äº<span class="math inline">\(\lambda _2\)</span>ï¼Œåˆ™ R ä¸ºè´Ÿï¼Œåˆ™è¯¥åŒºåŸŸä¸ºè¾¹ï¼›</li><li>å¦‚æœ<span class="math inline">\(\lambda _1\)</span>å’Œ<span class="math inline">\(\lambda _2\)</span>éƒ½å¤§ï¼Œåˆ™ R å¤§ï¼ŒåŒºåŸŸä¸º cornerã€‚</li></ol><p>è¿™ç§æ”¹è¿›åçš„æ–¹æ³•è¢«ç§°ä¸º Good Feature to Trackã€‚</p><p>ç„¶è€Œï¼Œä¸ºäº†å®æ—¶è¿è¡Œç®—æ³•ï¼Œç‰¹å¾ç‚¹å’Œå®ƒä»¬çš„åŒ¹é…åœ¨è®¡ç®—æ—¶é—´å†…å¿…é¡»åœ¨ä¸¤ä¸ªè¿ç»­çš„å¸§å†…ã€‚æˆ‘ä»¬å¯¹æ‹¼æ¥å…¨æ™¯å›¾è¿›è¡Œäº†å®éªŒï¼Œä»¥ç¡®è®¤ä¸€å®šæ•°é‡çš„ç‰¹å¾ç‚¹çš„æ•ˆç‡ï¼Œè¿™å¯¹äºå•åº”çŸ©é˜µæ¥è¯´æ˜¯è¶³å¤Ÿçš„ã€‚ å›¾ 2a æ˜¾ç¤ºäº†æ‹¼æ¥å‰çš„åŸå§‹å›¾åƒï¼Œå›¾ 2bã€c åˆ†åˆ«è¯´æ˜äº†ä½¿ç”¨ 200 ä¸ªç‰¹å¾ç‚¹å’Œ 2000 ä¸ªç‰¹å¾ç‚¹çš„å…¨æ™¯å›¾åƒã€‚ è¿™äº›å›¾åƒæ˜¯ç›¸ä¼¼çš„ï¼Œä½†å¤§ç‰¹å¾ç‚¹è¿‡åº¦è®¡ç®—äº†æ‹¼æ¥å›¾åƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºçš„æ–¹æ³•ä½¿ç”¨å°‘äº 200 ä¸ªç‰¹å¾ç‚¹æ¥å…è®¸å¯¹è¿åŠ¨å˜æ¢çš„åˆç†ä¼°è®¡ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm2.png"></p><p>ä¸¤ä¸ªè¿ç»­å¸§ä¹‹é—´çš„ç‰¹å¾ç‚¹åŒ¹é…éœ€è¦å¿«é€Ÿé€¼è¿‘ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨å…‰æµæ¥åŒ¹é…æ£€æµ‹åˆ°çš„è§’ç‚¹ã€‚å…‰æµæ˜¯å›¾åƒå¯¹è±¡åœ¨è¿ç»­å¸§ä¹‹é—´ç”±äºç‰©ä½“æˆ–ç›¸æœºçš„è¿åŠ¨è€Œäº§ç”Ÿçš„æ˜æ˜¾è¿åŠ¨çš„æ¨¡å¼ã€‚å®ƒè¡¨ç¤ºè§’ç‚¹åœ¨ dt æ—¶é—´åä»å‰ä¸€å¸§ <span class="math inline">\(I(x, y, t)\)</span> ç§»åŠ¨åˆ°å½“å‰å¸§æ—¶ 2D çŸ¢é‡åœº <span class="math inline">\((dx, dy)\)</span> çš„ä½ç§»ã€‚ å…‰æµå‡è®¾äº®åº¦ä¸å˜ï¼Œåˆ™ç»™å‡ºä»¥ä¸‹ç­‰å¼ï¼š</p><p><span class="math display">\[I(x,y,t) = I(x+d_x, y+d_y, t+d_t) \tag4\]</span></p><p>ç­‰å¼ï¼ˆ4ï¼‰å¯ä»¥é€šè¿‡å»é™¤å…¬å…±é¡¹å¹¶åœ¨å³æ‰‹è¾¹é‡‡å–æ³°å‹’çº§æ•°è¿‘ä¼¼åé™¤ä»¥ dt ä»¥ç®€å•çš„å½¢å¼è¡¨è¿°ã€‚ æˆ‘ä»¬è·å¾—äº†å›¾åƒæ¢¯åº¦ <span class="math inline">\(f_x\)</span> å’Œ <span class="math inline">\(f_y\)</span> ä»¥åŠæ²¿æ—¶é—´ <span class="math inline">\(f_t\)</span> çš„æ¢¯åº¦ä»¥ç¼–å†™ä»¥ä¸‹ç­‰å¼ï¼š</p><p><span class="math display">\[f_xu + f_yv + f_t = 0 \tag5\]</span></p><p><span class="math display">\[f_x = \frac{\partial f}{\partial x}; f_y = \frac{\partial f}{\partial y}; u = \frac{d_x}{d_t}; v = \frac{d_y}{d_t} \tag6\]</span></p><p>ç„¶è€Œï¼Œå¼ (5) åœ¨ä¸€ä¸ªæ–¹ç¨‹ä¸­æœ‰ä¸¤ä¸ªæœªçŸ¥æ•° (u, v)ã€‚ ä¸€äº›ç ”ç©¶äººå‘˜æå‡ºäº†è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨äº† Lucas-Kanade æ–¹æ³•ï¼Œè¿™æ˜¯ä¼°è®¡å…‰æµçš„æ ‡å‡†æ–¹æ³•ã€‚ Lucas-Kanade é€šè¿‡åœ¨æ‹è§’ç‚¹å‘¨å›´å– 3 Ã— 3 å—çš„ç›¸é‚»åƒç´ è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå‡è®¾æ‰€æœ‰ 9 ä¸ªç‚¹éƒ½å…·æœ‰ç›¸åŒçš„è¿åŠ¨ã€‚ ç„¶åï¼Œå¯ä»¥ä½¿ç”¨æœ€å°äºŒä¹˜æ‹Ÿåˆæ–¹æ³•æ±‚è§£å…·æœ‰æ­£ç¡®æ–¹ç¨‹çš„ä¸¤ä¸ªæœªçŸ¥æ•°ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix} u \\ v \end{bmatrix} =\begin{bmatrix} \sum_{i}^{}f_{x_i}^2   &amp; \sum_{i}^{}f_{x_i}f_{y_i}  \\ \sum_{i}^{}f_{x_i}f_{y_i}  &amp; \sum_{i}^{}f_{y_i}^2  \end{bmatrix}^{-1}\begin{bmatrix} -\sum_{i}^{}f_{x_i}f_{t_i} \\ -\sum_{i}^{}f_{y_i}f_{t_i} \end{bmatrix}  \tag7\]</span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm3.png"></p><p>ä¾‹å¦‚ï¼Œå›¾ 3aã€b åˆ†åˆ«æ˜¾ç¤ºäº†åœ¨æ­£å¸¸è¿åŠ¨å’Œå¿«é€Ÿè¿åŠ¨æœŸé—´æ¥è‡ª KLT ç‰¹å¾è·Ÿè¸ªå™¨çš„å…‰æµã€‚ åä¸€ç§è¿åŠ¨æƒ…å†µæ˜¯æ— åºçš„ï¼Œå¯¼è‡´å¯¹å•åº”çŸ©é˜µçš„ä¼°è®¡æ•ˆç‡ä½ä¸‹ã€‚åœ¨å¤§è¿åŠ¨æœŸé—´ï¼ŒKLT ç‰¹å¾è·Ÿè¸ªå™¨ç¡®å®å¤±è´¥äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å¤§è¿åŠ¨çš„æƒ…å†µä¸‹ä½¿ç”¨ IMU è¾…åŠ©çš„è¿åŠ¨ä¼°è®¡å™¨æ–¹æ³•æ¥å‡å°‘ä»»ä½•è¿åŠ¨çŸ¢é‡è¯¯å·®ã€‚</p><p>æ€»ä¹‹ï¼ŒKLT è·Ÿè¸ªå™¨å·²ç»æ ¹æ®å‰ä¸€å¸§ä¸­çš„ç‰¹å¾ç‚¹å’Œå½“å‰å¸§ä¸­ç§»åŠ¨åˆ°æ–°ä½ç½®çš„ç‰¹å¾ç‚¹åˆ›å»ºäº†è¿åŠ¨å‘é‡ã€‚ è¿™ä¸¤ç»„æ¥è‡ª KLT è·Ÿè¸ªå™¨çš„ç‰¹å¾ç‚¹ç”¨äºä¼°è®¡åˆšæ€§å˜æ¢çš„å•åº”çŸ©é˜µä»¥ç¨³å®šå›¾åƒå¸§ã€‚</p><h2 id="an-imu-aided-motion-estimator">An IMU-Aided Motion Estimator</h2><p>åœ¨<span class="math inline">\(w_{ğ‘§}^{ğ‘ğ‘ğ‘š}\)</span> çš„ç»å¯¹å€¼å¤§äº 0.5 rad/s çš„æƒ…å†µä¸‹ï¼ŒIMU ä¼ æ„Ÿå™¨å°†ä¼°è®¡è¿åŠ¨ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ä¸€å¼ å›¾åƒ<span class="math inline">\(I_0(x_{ij}, y_{ij})\)</span>ä¸Šåˆ›å»ºå‚è€ƒç‚¹çš„é›†åˆä¸ºå¦‚å›¾ 4 æ‰€ç¤ºï¼Œç”± <span class="math inline">\((i, j)\)</span> çš„å¯¹ç§°åˆ†å¸ƒç‚¹ç»„æˆã€‚ <span class="math inline">\((i, j)\)</span> çš„å¤§å°ç”± $(2e + 1) x(2f + 1), e , f = 1, 2, ..., n $è®¡ç®—ï¼Œå…¶ä¸­ e å’Œ f åº”åœ¨ 5 åˆ° 30 ä¹‹é—´ï¼Œä»¥å‡†ç¡®åœ°è¿‘ä¼¼è¿åŠ¨ åˆ†åˆ«åœ¨ x å’Œ y æ–¹å‘ä¸Šçš„è®¡ç®—è´Ÿè½½ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm4.png"></p><p><span class="math inline">\(I_0(x_{ij}, y_{ij})\)</span> çš„æ‰€æœ‰å‚è€ƒç‚¹éƒ½ä½äºå›¾åƒä¸­å¿ƒ <span class="math inline">\((x0, y0)\)</span> çš„å‘¨å›´ï¼Œç”±ä»¥ä¸‹ç­‰å¼ç¡®å®šï¼š <span class="math display">\[\left\{\begin{matrix}x_{ij} = x_0 - \frac{x_{sp}(2e-1)}{2} + ix_{sp} \\y_{ij} = y_0 - \frac{y_{sp}(2f-1)}{2} + jy_{sp}\end{matrix}\right. \tag8\]</span></p><p>å…¶ä¸­ <span class="math inline">\(x_{sp}\)</span> å’Œ <span class="math inline">\(y_{sp}\)</span> åˆ†åˆ«æ˜¯ x å’Œ y æ–¹å‘å‚è€ƒç‚¹ä¹‹é—´çš„åƒç´ ç©ºé—´ã€‚ä¸‹ä¸€å¸§ä¸Šçš„è¿åŠ¨ç‚¹<span class="math inline">\(I_{imu}(p, q)\)</span>å¯ä»¥ä» (1) ä¸­ z è½´ä¸Šçš„ <span class="math inline">\(w_{cam}\)</span> è®¡ç®—å¾—å‡ºï¼š</p><p><span class="math display">\[\left\{\begin{matrix}p = (x_{ij} - \frac{H}{2} ) \cos \varphi + (y_{ij} - \frac{W}{2} ) \sin \varphi + \frac{H}{2}  \\Q = (x_{ij} - \frac{H}{2} ) \sin \varphi + (y_{ij} - \frac{W}{2} ) \cos \varphi + \frac{W}{2}\end{matrix}\right. \tag9\]</span></p><p>å…¶ä¸­ j ç­‰äº<span class="math inline">\(w_{z}^{cam}\)</span> é™¤ä»¥è¾“å…¥è§†é¢‘çš„å¸§ç‡ï¼ŒH å’Œ W åˆ†åˆ«æ˜¯å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ã€‚ç„¶è€Œï¼ŒLi å’Œ Ren [16] è¿›è¡Œäº† z è½´æ—‹è½¬è¿åŠ¨å…·æœ‰æŠµæ¶ˆä½œç”¨çš„è¿åŠ¨ç‚¹ï¼Œè¡¨ç¤ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\varphi =\left\{\begin{matrix}-\frac{8}{F_{fps}}, w_{z}^{cam} &lt; -6 \\-\frac{4}{F_{fps}}, -6 \le w_{z}^{cam}\le -2\\0,  0.5 \le \left | w_{z}^{cam} \right | \le 2 \\\frac{4}{F_{fps}}, 2 \le w_{z}^{cam}\le 6 \\\frac{8}{F_{fps}}, w_{z}^{cam} &gt; 6\end{matrix}\right. \tag{10}\]</span></p><ol start="9" type="1"><li>å’Œ (10) å¯ä»¥ç”±æ¥è‡ª IMU ä¼ æ„Ÿå™¨çš„è¿åŠ¨çŸ¢é‡åˆæˆã€‚è¿åŠ¨çŸ¢é‡çš„æ–¹å‘å’Œå¤§å°å–å†³äºæµ‹é‡çš„æ—‹è½¬ã€‚ å›¾ 5 æ˜¾ç¤ºäº†ä»ä¸€ç»„å…·æœ‰ä¸åŒ Ï† å€¼çš„ç‚¹è®¡ç®—çš„è¿åŠ¨çŸ¢é‡ï¼Œå¯¹äºå›¾ 5a ä¸­çš„ä½æ—‹è½¬é€Ÿç‡ï¼Œè¿åŠ¨çŸ¢é‡åœ¨æ–¹å‘å’Œå¤§å°æ–¹é¢ç›¸ä¼¼ã€‚å¦å¤–ï¼Œå¿«é€Ÿæ—‹è½¬ä¸­è¿åŠ¨çŸ¢é‡åœ¨ä¸åŒçš„æ–¹å‘å’Œå¤§å°ä¸Šæ˜¯æœ‰åºçš„ï¼Œå¦‚å›¾ 5b,c <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm5.png"></li></ol><p>æ¥è‡ª IMU ä¼ æ„Ÿå™¨çš„ä¸€ç»„å‚è€ƒç‚¹å’Œæ–°ä½ç½®ç‚¹è¢«åº”ç”¨äºä¼°è®¡åˆšæ€§å˜æ¢çš„å•åº”æ€§çŸ©é˜µã€‚ä¸¤ç§æ–¹æ³•çš„è¿åŠ¨æµæ¯”è¾ƒè¿åŠ¨çŸ¢é‡å¦‚å›¾ 6 æ‰€ç¤ºï¼ŒKLT è·Ÿè¸ªå™¨çš„å…‰æµä¸ºå¿«é€Ÿè¿åŠ¨çŸ¢é‡å¦‚å›¾ 6 æ‰€ç¤ºï¼ŒåŒæ—¶ç»„ç»‡ä» IMU æ•°æ®ä¼°è®¡è¿åŠ¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm6.png"></p><p>ä¸Šä¸€æ­¥ä¸­å‚è€ƒå›¾åƒï¼ˆS0ï¼‰å’Œå½“å‰å›¾åƒï¼ˆSnï¼‰çš„è¿‘ä¼¼è®¾å®šç‚¹ç”¨äºå®šä¹‰è¿åŠ¨æ¨¡å‹ã€‚è¿åŠ¨ä¼°è®¡é€šè¿‡æ‰¾åˆ° 2 Ã— 2 çŸ©é˜µ A å’Œ 2 Ã— 1 å‘é‡ t æ¥è¿‘ä¼¼è¿™äº›è®¾å®šç‚¹ä¹‹é—´çš„ä»¿å°„å˜æ¢ [A|t]ï¼Œå…¶å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span class="math display">\[[A^*|t^*] = arg min\sum_{i}^{} \begin{Vmatrix}S_0[i] - AS_n[i]^T - t\end{Vmatrix}^2 \tag{11}\]</span></p><p>ä¸ºäº†æ±‚è§£ï¼ˆ11ï¼‰ä¸­çš„ <span class="math inline">\([A|t]\)</span>ï¼ŒåŒ¹é…å¯¹æœ€å°‘éœ€è¦ä¸‰å¯¹æ‰èƒ½ç”Ÿæˆä»¿å°„å˜æ¢ã€‚ å› æ­¤ï¼Œè¿åŠ¨ä¼°è®¡è¢«å‘ç°ä¸ºä»¿å°„å˜æ¢ï¼Œåº”ç”¨äº <span class="math inline">\(I(x, y)\)</span>ä»¥æ˜ å°„å˜å½¢å›¾åƒ<span class="math inline">\(I_{warp}(x', y')\)</span>ã€‚</p><p><span class="math display">\[\begin{bmatrix} x'\\ y'\\ 1 \end{bmatrix} =\begin{bmatrix} S \cos \theta   &amp; -S \sin \theta   &amp; t_x\\ S \sin \theta  &amp; S \cos \theta &amp; t_y\\ 0  &amp; 0 &amp; 1\end{bmatrix}\begin{bmatrix} x\\ y\\ 1 \end{bmatrix} \tag{12}\]</span></p><p>è‡ªç”±åº¦ (12) åŒ…æ‹¬æ ‡åº¦ (S)ã€æ—‹è½¬è§’åº¦ (q) ä»¥åŠ x è½´å’Œ y è½´ä¸Šçš„å¹³ç§»<span class="math inline">\(t_x\)</span> å’Œ <span class="math inline">\(t_y\)</span>ã€‚ å› æ­¤ï¼Œå¼ (12) ä¸­çš„æ€»è‡ªç”±åº¦ä¸º 4ï¼Œç§°ä¸ºç›¸ä¼¼å˜æ¢ã€‚ ç„¶è€Œï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆšæ€§å˜æ¢æ¥æ‰­æ›²ç¨³å®šçš„æ¡†æ¶ï¼Œä½¿å°ºåº¦ç­‰äº 1ï¼Œä»¥å‡å°‘ç”¨äºè®¡ç®—å°ºåº¦å‘é‡çš„å­˜å‚¨åŒºåŸŸ</p><h1 id="motion-smoothing-and-image-warping">Motion Smoothing and Image Warping</h1><p>ä¸ºäº†ä»ä¼°è®¡çš„è¿åŠ¨ä¸­å»é™¤å™ªå£°ï¼Œæˆ‘ä»¬ä½¿ç”¨å¡å°”æ›¼æ»¤æ³¢å™¨æ¥å‡å°‘å™ªå£°å¹¶è·å¾—å¹³æ»‘çš„è¿åŠ¨ [30]ã€‚ å¡å°”æ›¼æ»¤æ³¢å™¨é€šè¿‡ä½¿ç”¨å‰ä¸€ä¸ªçŠ¶æ€ [31] æ¥è¿‘ä¼¼ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œè¿™é€‚åˆè¿ç»­å¸§çš„åŠ¨æ€ç³»ç»Ÿã€‚<span class="math inline">\(x_k\)</span>çš„é¢„æµ‹çŠ¶æ€ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[x_k = F_{x_{k-1}} + B_{u_k} + w_k \tag{13}\]</span></p><p>å…¶ä¸­ F çŸ©é˜µæ˜¯å‰ä¸€çŠ¶æ€ <span class="math inline">\(x_{kâˆ’1}\)</span> ä¸­çš„çŠ¶æ€è½¬ç§»æ¨¡å‹ï¼ŒB çŸ©é˜µæ˜¯æ§åˆ¶è¾“å…¥æ¨¡å‹ï¼Œ<span class="math inline">\(u_k\)</span>æ˜¯æ§åˆ¶å‘é‡ï¼Œ<span class="math inline">\(w_k\)</span>æ˜¯é«˜æ–¯åˆ†å¸ƒä¸­çš„è¿‡ç¨‹å™ªå£°ã€‚ ç³»ç»ŸçŠ¶æ€<span class="math inline">\(x_k\)</span>åœ¨æ—¶é—´ k çš„çŠ¶æ€<span class="math inline">\(z_k\)</span>ç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[z_k = H_kx_k + v_k \tag{14}\]</span></p><p>å…¶ä¸­ <span class="math inline">\(H_k\)</span> å’Œ<span class="math inline">\(v_k\)</span>åˆ†åˆ«æ˜¯è§‚æµ‹çŸ©é˜µå’Œè§‚æµ‹å™ªå£°ã€‚ æ¥è‡ªå¡å°”æ›¼æ»¤æ³¢å™¨çš„è¿‡æ»¤è¿åŠ¨ä»¥å¹³æ»‘çš„è½¨è¿¹æ‰­æ›²äº†ç¨³å®šçš„æ¡†æ¶ã€‚ å› æ­¤ï¼Œåˆšæ€§å˜æ¢çš„æ ¡æ­£å¯ä»¥å‘ç°ä¸ºï¼š</p><p><span class="math display">\[\begin{bmatrix} x_{sta} \\ y_{sta} \\ 1 \end{bmatrix} = \begin{bmatrix}\cos (\theta - \hat{\theta} )  &amp; -\sin (\theta - \hat{\theta} ) &amp; t_x - \hat{t_x}\\\sin (\theta - \hat{\theta} )  &amp; \cos (\theta - \hat{\theta} ) &amp; t_y - \hat{t_y}\\ 0 &amp; 0 &amp; 1 \end{bmatrix}\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} \tag{15}\]</span></p><p>å…¶ä¸­ <span class="math inline">\((\hat{\theta},\hat{t_x},\hat{t_y})\)</span>æ˜¯æ¥è‡ªå¡å°”æ›¼æ»¤æ³¢å™¨çš„æ»¤æ³¢åçš„è¿åŠ¨ã€‚ ç¨³å®šçš„è§†é¢‘æ˜¯ç”¨è¿™ç§æ ¡æ­£è¿åŠ¨å’Œå¹³æ»‘è½¨è¿¹åˆ›å»ºçš„ã€‚</p><h1 id="experimental-results-and-discussion">Experimental Results and Discussion</h1><p>å‡è®¾ IMU å’Œ Camera ä¹‹é—´çš„å»¶è¿Ÿæ˜¯å¸¸æ•° [32]ã€‚å®ƒå¯ä»¥é€šè¿‡åº”ç”¨å›´ç»• z è½´ç§»åŠ¨ç›¸æœºä»¥æµ‹é‡ <span class="math inline">\(w_z^{cam}\)</span> æ‰€éœ€çš„å°æ­£å¼¦ä¿¡å·æ¥è¯†åˆ«åç§»æ—¶é—´ã€‚ç„¶åï¼Œå¯¹å…‰æµå’Œé™€èºæ•°æ®çš„å¹³å‡å¹…åº¦è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚å›¾ 9 æ‰€ç¤ºï¼Œå…‰æµæ˜¯ç”¨å›¾åƒæ’å€¼ç®—æ³• [33] ä¼°è®¡çš„ï¼Œé™€èºæ•°æ®ç”±ç­‰å¼ï¼ˆ1ï¼‰è®¡ç®—ã€‚ æ¥è‡ªå…‰æµå’Œé™€èºä»ªæ•°æ®çš„å­˜æ¡£æ•°æ®åŒ…å«ç›¸åŒçš„ç›¸ä½ï¼Œå› æ­¤ç”±<span class="math inline">\(t_{off}\)</span> è¡¨ç¤ºçš„ä¸¤ä¸ªæµ‹é‡æ•°æ®ä¹‹é—´çš„æœ€å¤§ç›¸ä½æ»åç­‰äº -0.035 sï¼Œ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/EIS/ahm10.png"></p><p>æˆ‘ä»¬æå‡ºçš„æ–¹æ³•ä¸ç‹¬ç«‹çš„ KTL è·Ÿè¸ªå™¨å’Œ IMU è¾…åŠ©è¿åŠ¨ä¼°è®¡å™¨è¿›è¡Œäº†æ¯”è¾ƒã€‚ ä¸ºäº†åˆç†çš„è¯„ä¼°ç¨³å®šè§†é¢‘çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä½¿ç”¨å¸§é—´å˜æ¢ä¿çœŸåº¦ï¼ˆITFï¼‰[34] é€šè¿‡æ€»ç»“å³°å€¼ä¿¡å™ªæ¯”ï¼ˆPSNRï¼‰ä»¥å•ä¸ªå€¼è¡¨ç¤ºç¨³å®šè§†é¢‘çš„è´¨é‡ ï¼Œç”±ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[ITF = \frac{1}{N_{max}-1} \sum_{k=1}^{N_{max}-1}  PSNR \tag{16}\]</span></p><p>å…¶ä¸­<span class="math inline">\(N_{max}\)</span>æ˜¯å¸§æ•°ï¼ŒPSNR ç”¨äºæ‰§è¡Œç¨³å®šæ–¹æ³•çš„æœ‰æ•ˆæ€§ï¼Œå…¶å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[PSNR(I_n, I_{n+1}) = 10log\frac{I_{max}^2}{MSE(I_n,I_{i+1})}  \tag{17}\]</span></p><p>å…¶ä¸­<span class="math inline">\(I_max\)</span>æ˜¯è§†é¢‘å¸§çš„æœ€å¤§åƒç´ å¼ºåº¦ï¼ŒMSE æ˜¯è¿ç»­ä¸¤ä¸ªå¸§ä¹‹é—´çš„å‡æ–¹è¯¯å·®ï¼Œ<span class="math inline">\(I_n\)</span>å’Œ<span class="math inline">\(I_{n+1}\)</span>ï¼Œåœ¨ç¨³å®šè§†é¢‘ä¸­è¿ç»­å¸§çš„æ¯ä¸ªåƒç´ ä¸­è®¡ç®—ï¼Œå¯ä»¥å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[MSE(I_n,I_{i+1}) = \frac{1}{MN}\sum_{j=1}^{N}\sum_{i=1}^{M}(I_n(i,j) - I_{n+1}(i,j))^2  \tag{18}\]</span></p><p>å…¶ä¸­ N å’Œ M æ˜¯è§†é¢‘å°ºå¯¸ã€‚ ITF å’Œ PSNR çš„é«˜ä»£è¡¨ç¨³å®šè§†é¢‘çš„è´¨é‡ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>&lt; A Hybrid Motion Estimation for Video Stabilization Based on an IMU Sensor &gt;</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EIS ç”µå­é˜²æŠ–åŸºæœ¬åŸç†</title>
      <link href="/2021/Science/BasicPrinciplesOfEISElectronicImageStabilization/"/>
      <url>/2021/Science/BasicPrinciplesOfEISElectronicImageStabilization/</url>
      
        <content type="html"><![CDATA[<h1 id="æŠ•å½±">æŠ•å½±</h1><p>è¿™é‡Œä»¥å°å­”æˆåƒæ¨¡å‹ä¸ºä¾‹ï¼Œå…¨ç›¸æ¨¡å‹æ˜¯ç›¸åŒçš„æµç¨‹åªæ˜¯æŠ•å½±æ¨¡å‹ä¸ä¸€æ ·è€Œå·²ã€‚åœ¨ç›¸æœºæ ¡å‡†æ¨¡å‹ä¸€æ–‡ä¸­å·²ç»ä»‹ç»äº†å°†åƒç´ åæ ‡ç³»å˜æ¢åˆ°ç›¸æœºåæ ‡ç³»ä¸­ <a href="https://carlyleliu.github.io/2021/Camera/CameraCalibrationModel/">ç›¸æœºæ ¡å‡†æ¨¡å‹</a> å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \begin{bmatrix} \frac{1}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{1}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x \\&nbsp; y \\ 1 \end{bmatrix} = \frac{1}{z_c}\begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x_c\\&nbsp; y_c\\&nbsp; z_c \end{bmatrix}\]</span></p><p>è¿™é‡Œæˆ‘ä»¬å– <span class="math inline">\(z_c = 1\)</span> å†åšä¸€ä¸ªå˜æ¢å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{bmatrix} x_c\\&nbsp; y_c\\&nbsp; z_c \end{bmatrix} =\begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} ^{-1} \begin{bmatrix} u \\ v \\ 1 \end{bmatrix}\]</span></p><p>æˆ‘ä»¬è®° ï¼š</p><p><span class="math display">\[K_{å†…å‚}^{-1} = \begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} ^{-1} \]</span></p><p>åˆ™å°†åƒç´ åæ ‡ç³»ä¸è¯¥çŸ©é˜µç›¸ä¹˜å°±å¯ä»¥å°†åƒç´ åæ ‡ç³»è½¬æ¢åˆ°ç›¸æœºåæ ‡ç³»ä¸Šï¼Œå¾…åé¢ä½¿ç”¨ã€‚</p><h1 id="imu-æ•°æ®å¤„ç†">IMU æ•°æ®å¤„ç†</h1><p>å…·ä½“å¯ä»¥å‚è€ƒ <a href="https://carlyleliu.github.io/2020/Algorithm/imuAttitudeCalculation/">imu å§¿æ€è§£ç®—</a> ä¸€æ–‡ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ IMU æ•°æ®åšä¸‰ä»¶äº‹æƒ…ï¼š</p><ul><li>IMU åæ ‡ç³»å¯¹é½ç›¸æœºåæ ‡ç³»ï¼Œè¿™ä¸€æ­¥ç›®çš„ä¸ºäº†å°† IMU çš„æ­£äº¤ä¸‰è½´æ•°æ®ä¸ Camera åæ ‡ç³»å¯¹é½ã€‚</li><li><p>å¡å°”æ›¼æ»¤æ³¢ï¼šä¸ºäº†æ¶ˆé™¤ IMU çš„ç³»ç»Ÿè¯¯å·®ä»¥åŠå¦‚æœè¦åšé‡åŠ›çŸ«æ­£éœ€è¦åšå§¿æ€è§£ç®—ï¼ˆé‡åŠ›å¯¹é½ï¼‰ã€‚è¿™é‡Œå¸¸ç”¨çš„å°±æ˜¯å¡å°”æ›¼æ»¤æ³¢å’Œ mahony æ»¤æ³¢ï¼Œè¿™ä¸€å±‚æ»¤æ³¢çš„ç›®çš„å°±æ˜¯ä¸ºäº†å¾—åˆ°æ›´ä¸ºå‡†ç¡®çš„ç›¸æœºå§¿æ€å’Œç›¸æœºæŠ–åŠ¨çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/lpf.png"></p></li><li><p>å¹³æ»‘æ»¤æ³¢ï¼šåœ¨æˆ‘ä»¬å¾—åˆ°ç›¸æœºçš„æŠ–åŠ¨çŠ¶æ€å°±å¯ä»¥å¯¹ç›¸æœºçš„å§¿æ€åšä¸€ä¸ªå¹³æ»‘æ»¤æ³¢ï¼ˆå¯ä»¥é‡‡ç”¨å››å…ƒæ•°æ±‚å¹³å‡ï¼Œæˆ–è€…é«˜æ–¯æ»¤æ³¢ç­‰ç®—æ³•ï¼‰ï¼Œè¿™ä¸ªå¹³æ»‘æ»¤æ³¢çš„ç›®çš„æ˜¯ä¸ºäº†å¾—åˆ°ç›¸æœºé˜²æŠ–åæƒ³è¦å¾—åˆ°çš„çŠ¶æ€ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ISP/anl5.png"></p></li></ul><p>æˆ‘ä»¬å°†ä» Large inner region æ›²çº¿æˆ–è€… Small inner region æ›²çº¿åˆ° Input æ›²çº¿çš„å˜æ¢çŸ©é˜µè®°ä¸º <span class="math inline">\(M(\alpha, \beta, \gamma)\)</span> ä¸ºäº†ç®€åŒ–æ¨¡å‹è¿™é‡Œé¢çš„æ•°æ®æ˜¯å·²ç»å°† IMU åæ ‡ç³»å˜åŒ–åˆ°ç›¸æœºåæ ‡ç³»ä¸‹çš„å˜æ¢çŸ©é˜µã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸¤æ¡æ›²çº¿å’Œä¸€ä¸ªå˜æ¢çŸ©é˜µã€‚</p><h1 id="æ±‚é€è§†å˜æ¢çŸ©é˜µ">æ±‚é€è§†å˜æ¢çŸ©é˜µ</h1><p>è¿™é‡Œæˆ‘ä»¬è®°æ—‹è½¬çŸ©é˜µä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}M(\alpha, \beta, \gamma) &amp; =\left[\begin{array}{ccc}\cos \gamma &amp; -\sin \gamma &amp; 0 \\\sin \gamma &amp; \cos \gamma &amp; 0 \\0 &amp; 0 &amp; 1\end{array}\right]\left[\begin{array}{ccc}\cos \beta &amp; 0 &amp; \sin \beta \\0 &amp; 1 &amp; 0 \\-\sin \beta &amp; 0 &amp; \cos \beta\end{array}\right]\left[\begin{array}{ccc}1 &amp; 0 &amp; 0 \\0 &amp; \cos \alpha &amp; -\sin \alpha \\0 &amp; \sin \alpha &amp; \cos \alpha\end{array}\right] \\&amp; =\left[\begin{array}{ccc}\cos \gamma \cos \beta &amp; -\sin \gamma &amp; \cos \gamma \sin \beta \\\sin \gamma \cos \beta &amp; \cos \gamma &amp; \sin \gamma \sin \beta \\-\sin \beta &amp; 0 &amp; \cos \beta\end{array}\right]\left[\begin{array}{ccc}1 &amp; 0 &amp; 0 \\0 &amp; \cos \alpha &amp; -\sin \alpha \\0 &amp; \sin \alpha &amp; \cos \alpha\end{array}\right] \\&amp; =\left[\begin{array}{ccc}\cos \gamma \cos \beta &amp; -\sin \gamma \cos \alpha+\cos \gamma \sin \beta \sin \alpha &amp; \sin \gamma \sin \alpha+\cos \gamma \sin \beta \cos \alpha \\\sin \gamma \cos \beta &amp; \cos \gamma \cos \alpha+\sin \gamma \sin \beta \sin \alpha &amp; -\cos \gamma \sin \alpha+\sin \gamma \sin \beta \cos \alpha \\-\sin \beta &amp; \cos \beta \sin \alpha &amp; \cos \beta \cos \alpha\end{array}\right]\end{aligned}\]</span></p><p>ç»¼åˆå‰é¢ä¸¤èŠ‚çš„å†…å®¹æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å…¬å¼å¾—åˆ°æŠ•å½±å˜æ¢çŸ©é˜µ Rï¼š</p><p><span class="math display">\[R = K_{å†…å‚}^{-1} \ast M(\alpha ,\beta ,\gamma ) \ast K_{å†…å‚}\]</span></p><p>æ”¹å†™æˆå®Œæ•´çš„å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[R = \begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix}^{-1} \ast \left[\begin{array}{ccc}\cos \gamma \cos \beta &amp; -\sin \gamma \cos \alpha+\cos \gamma \sin \beta \sin \alpha &amp; \sin \gamma \sin \alpha+\cos \gamma \sin \beta \cos \alpha \\\sin \gamma \cos \beta &amp; \cos \gamma \cos \alpha+\sin \gamma \sin \beta \sin \alpha &amp; -\cos \gamma \sin \alpha+\sin \gamma \sin \beta \cos \alpha \\-\sin \beta &amp; \cos \beta \sin \alpha &amp; \cos \beta \cos \alpha\end{array}\right] \ast \begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix}\]</span></p><p>è¯¥å…¬å¼æ˜¯é€šè¿‡ç›¸æœºçš„å†…å‚çŸ©é˜µå°†åƒç´ åæ ‡ç³»å˜æ¢åˆ°ç›¸æœºåæ ‡ç³»ï¼Œç„¶åé€šè¿‡ IMU å¾—åˆ°ç›¸æœºçš„å§¿æ€ï¼Œå°†ç›¸æœºåæ ‡ç³»å˜æ¢åˆ°ä¸–ç•Œåæ ‡ç³»ä¸‹å¯¹ç›¸æœºçš„å§¿æ€è¿›è¡Œç¨³å®šï¼Œå¾—åˆ°ç¨³å®šåçš„ç›¸æœºå§¿æ€ï¼Œå†å°†ä¸Šè¿°çŸ©é˜µçš„é€†ä¹˜èµ·æ¥å˜æ¢å›åƒç´ åæ ‡ç³»ã€‚è¿™æ ·å°±å¾—åˆ°äº†é€è§†å˜æ¢çš„çŸ©é˜µï¼Œå°†åƒç´ çš„åæ ‡ä¸è¯¥ R çŸ©é˜µç›¸ä¹˜å°±å¾—åˆ°äº†è¯¥åƒç´ é˜²æŠ–åçš„åæ ‡å€¼ï¼ˆå°±æ˜¯ opencv é‡Œçš„ remapï¼‰ã€‚</p><h1 id="ç‰¹åˆ«æ³¨æ„">ç‰¹åˆ«æ³¨æ„</h1><ul><li>åœ¨åš IMU å§¿æ€è§£ç®—çš„æ—¶å€™è¦ç»™é™€èºä»ªè¶³å¤Ÿçš„ç½®ä¿¡åº¦ï¼Œä¸ç„¶å¯èƒ½å¾ˆéš¾å¾—åˆ°è¾ƒå¥½çš„é˜²æŠ–æ•ˆæœã€‚</li><li>è¦å°†è§†é¢‘å¸§çš„æ—¶é—´æˆ³ä¸ IMU çš„æ—¶é—´æˆ³å¯¹é½ï¼Œä¸ç„¶ä¸€å®šä¸èƒ½å¾—åˆ°è¾ƒå¥½çš„æ•ˆæœï¼Œç¬”è€…æ²¡æœ‰ç ”ç©¶å¥½è¿™å—ç®—æ³•æ‰‹åŠ¨è¯•å‡ºæ¥çš„ï¼Œç²¾åº¦è¦åœ¨ 1ms å†…æ‰è¡Œï¼Œå¦å¤–æœ‰é¦™æ¸¯ç§‘æŠ€å¤§å­¦çš„ VIO é¡¹ç›®é‡Œé¢æœ‰ç›¸å…³è®ºæ–‡å’Œå®ç°å¯ä»¥å‚è€ƒã€‚</li><li>rollingshutter éœ€è¦çŸ«æ­£ï¼Œå…¶å®ç®—æ³•ä¸Šéœ€è¦åšçš„å°±æ˜¯æ‰¾åˆ°å¸§æ›å…‰å¼€å§‹å’Œç»“æŸçš„æ—¶åˆ»ï¼Œç„¶åå°†æ—‹è½¬çŸ©é˜µæŒ‰è¡Œè¿›è¡Œæ’å€¼å¾—åˆ°æ¯ä¸€è¡Œçš„çŸ©é˜µç„¶ååˆ†åˆ«å¯¹æ¯ä¸€è¡Œè¿›è¡Œåº”ç”¨ remap å°±å¯ä»¥äº†ã€‚</li><li>è¿™é‡Œæ²¡æœ‰è€ƒè™‘ç ´å›¾é—®é¢˜ï¼Œå®é™…å·¥ç¨‹ä¸­è¦è€ƒè™‘ç ´å›¾é—®é¢˜ã€‚</li><li>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯å°†åŸå›¾ä¹˜é€è§†å˜æ¢çŸ©é˜µå¾—åˆ°çš„åæ ‡å€¼å¤§æ¦‚ç‡æ˜¯æµ®ç‚¹å€¼ï¼Œä½†æ˜¯åƒç´ åæ ‡ç³»ä¸‹åªæœ‰è’¸ç†Ÿç‚¹é‚£ä¹ˆå°±ä¼šé€ æˆç”»è´¨æŸå¤±ï¼Œå¦‚æœæƒ³æ”¹å–„è¿™ä¸ªï¼Œå¯ä»¥é€šè¿‡å°†ç›®æ ‡å›¾åƒä¹˜çŸ©é˜µ R çš„é€†å¾—åˆ°åŸå›¾çš„åæ ‡ç‚¹ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿä¼šå¾—åˆ°æµ®ç‚¹åæ ‡åæ ‡å€¼ï¼Œä½†æ˜¯å¯¹äºåŸå›¾æˆ‘ä»¬å¯ä»¥é€šè¿‡åŒçº¿æ€§æ’å€¼å¾—åˆ°å˜æ¢åçš„å›¾åƒå€¼ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯æ“ä½œå›¾åƒå€¼è€Œä¸æ˜¯åæ ‡å€¼äº†ï¼‰ã€‚</li><li>å®é™…ä½¿ç”¨ä¸­ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨æ—‹è½¬çŸ©é˜µï¼Œä¼šæ”¹ç”¨å››å…ƒæ•°æ¥å¤„ç†ï¼Œä¾¿äºæ’å€¼ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›¸æœºæ ¡å‡†æ¨¡å‹</title>
      <link href="/2021/Camera/CameraCalibrationModel/"/>
      <url>/2021/Camera/CameraCalibrationModel/</url>
      
        <content type="html"><![CDATA[<h1 id="å°å­”æˆåƒæ¨¡å‹">å°å­”æˆåƒæ¨¡å‹</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/CoordinateSystem1.png"></p><span id="more"></span><h1 id="å„åæ ‡ç³»å®šä¹‰åŠç›¸æœºçš„å†…å‚å’Œå¤–å‚">å„åæ ‡ç³»å®šä¹‰åŠç›¸æœºçš„å†…å‚å’Œå¤–å‚</h1><h2 id="åƒç´ åæ ‡ç³»">åƒç´ åæ ‡ç³»</h2><p>åƒç´ åæ ‡å°±æ˜¯åƒç´ åœ¨å›¾åƒä¸­çš„ä½ç½®ã€‚ä¸€èˆ¬åƒç´ åæ ‡ç³»çš„å·¦ä¸Šè§’çš„é¡¶ç‚¹å°±æ˜¯åŸç‚¹ï¼Œæ°´å¹³å‘å³æ˜¯ uï¼Œå‚ç›´å‘ä¸‹æ˜¯ v è½´ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/PixelCoordinateSystem.png"></p><h2 id="å›¾åƒåæ ‡ç³»">å›¾åƒåæ ‡ç³»</h2><p>åœ¨åƒç´ åæ ‡ç³»ä¸­ï¼Œæ¯ä¸ªåƒç´ çš„åæ ‡æ˜¯ç”¨åƒç´ æ¥è¡¨ç¤ºçš„ï¼Œç„¶è€Œï¼Œåƒç´ çš„è¡¨ç¤ºæ–¹æ³•å´ä¸èƒ½ååº”å›¾åƒä¸­ç‰©ä½“çš„ç‰©ç†å°ºå¯¸ï¼Œå› æ­¤ï¼Œæœ‰å¿…è¦å°†åƒç´ åæ ‡è½¬æ¢ä¸ºå›¾åƒåæ ‡ã€‚å°†åƒç´ åæ ‡ç³»çš„åŸç‚¹å¹³ç§»åˆ°å›¾åƒçš„ä¸­å¿ƒï¼Œå°±å®šä¸ºå›¾åƒåæ ‡ç³»çš„åŸç‚¹ï¼Œå›¾åƒåæ ‡ç³»çš„ x è½´ä¸åƒç´ åæ ‡ç³»çš„ u è½´å¹³è¡Œï¼Œæ–¹å‘ç›¸åŒï¼Œè€Œå›¾åƒåæ ‡ç³»çš„ y è½´ä¸åƒç´ åæ ‡ç³»çš„ v è½´å¹³è¡Œï¼Œæ–¹å‘ç›¸åŒã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/ImageCoordinateSystem.png"></p><p>åœ¨å›¾ä¸­ï¼Œå‡è®¾åœ¨åƒç´ åæ ‡ç³»ä¸‹å›¾åƒä¸­å¿ƒçš„åƒç´ åæ ‡æ˜¯ï¼ˆu0,v0ï¼‰ï¼Œç›¸æœºä¸­æ„Ÿå…‰å™¨ä»¶æ¯ä¸ªåƒç´ çš„ç‰©ç†å°ºå¯¸æ˜¯ dx * dyï¼Œé‚£ä¹ˆï¼Œå›¾åƒåæ ‡ç³»çš„åæ ‡ï¼ˆx,yï¼‰ä¸åƒç´ åæ ‡ç³»çš„åæ ‡ï¼ˆu,vï¼‰ä¹‹é—´çš„å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[u = \frac{x}{d_x} + u_0 \\         v = \frac{y}{d_y} + v_0 \]</span></p><p>å†™æˆçŸ©é˜µçš„å½¢å¼å°±ä¸ºï¼š</p><p><span class="math display">\[\begin{bmatrix} u \\  v \end{bmatrix} = \begin{bmatrix} \frac{1}{d_x} &amp; 0 \\ 0 &amp; \frac{1}{d_y} \end{bmatrix}\begin{bmatrix} x \\ y \end{bmatrix} + \begin{bmatrix} u_0\\  v_0 \end{bmatrix}\]</span></p><p>æ”¹å†™ä¸ºé½æ¬¡åæ ‡çš„å½¢å¼ï¼š</p><p><span class="math display">\[\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \begin{bmatrix} \frac{1}{d_x}&amp; 0 &amp;0 \\ 0 &amp; \frac{1}{d_y} &amp; 0\\ 0 &amp; 0 &amp; 0 \end{bmatrix} \begin{bmatrix} x \\  y \\ 0 \end{bmatrix} + \begin{bmatrix} u_o \\  v_o \\ 1 \end{bmatrix} = \begin{bmatrix} \frac{1}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{1}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x \\  y \\ 1 \end{bmatrix}\]</span></p><h2 id="ç›¸æœºåæ ‡ç³»">ç›¸æœºåæ ‡ç³»</h2><p>ç›¸æœºåæ ‡ç³»æ˜¯ä»¥ç›¸æœºçš„å…‰è½´ä½œä¸º Z è½´ï¼Œå…‰çº¿åœ¨ç›¸æœºå…‰å­¦ç³»ç»Ÿçš„ä¸­å¿ƒä½ç½®å°±æ˜¯åŸç‚¹ Ocï¼ˆå®é™…ä¸Šå°±æ˜¯é€é•œçš„ä¸­å¿ƒï¼‰, ç›¸æœºåæ ‡ç³»çš„æ°´å¹³è½´ Xc ä¸å‚ç›´è½´ Yc åˆ†åˆ«äºå›¾åƒåæ ‡ç³»çš„ X è½´å’Œ Y è½´å¹³è¡Œã€‚åœ¨å›¾ä¸­ï¼Œç›¸æœºåæ ‡ç³»çš„åŸç‚¹ä¸å›¾åƒåæ ‡ç³»çš„åŸç‚¹ä¹‹é—´çš„è·ç¦» OcOi ä¹‹é—´çš„è·ç¦»ä¸º fï¼ˆä¹Ÿå°±æ˜¯ç„¦è·ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Camera1CoordinateSystem.png"></p><p>å‡è®¾ï¼Œä¸‰ç»´ç©ºé—´ä¸­ç‚¹ P, å…¶åœ¨ç›¸æœºåæ ‡ç³»ä¸‹åæ ‡ä¸º<span class="math inline">\(P_c = [x_c,y_c,z_c]^T\)</span>; å…¶åƒç‚¹ pï¼Œåœ¨å›¾åƒåæ ‡ç³»ä¸­åæ ‡ä¸ºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/Camera2CoordinateSystem.png"></p><p>ç”±ç›¸ä¼¼ä¸‰è§’å½¢åŸç†ï¼Œå¾—åˆ°</p><p><span class="math display">\[\frac{f}{z_c} = \frac{x}{x_c} = \frac{y}{y_c} \\ x = f \frac{x_c}{z_c},  y = f \frac{y_c}{z_c} \]</span></p><p>ç”¨å‘é‡è¡¨ç¤ºä¸ºï¼š</p><p><span class="math display">\[\begin{bmatrix} x\\ y\\ 1 \end{bmatrix} = \frac{1}{z_c}\begin{bmatrix} f &amp;0&nbsp; &amp;0 \\&nbsp; 0 &amp; f &amp; 0\\&nbsp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x_c\\&nbsp; y_c\\&nbsp; z_c \end{bmatrix}\]</span></p><p>è¿›ä¸€æ­¥å¯ä»¥å†™ä¸ºï¼š</p><p><span class="math display">\[\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \begin{bmatrix} \frac{1}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{1}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x \\&nbsp; y \\ 1 \end{bmatrix} = \frac{1}{z_c}\begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x_c\\&nbsp; y_c\\&nbsp; z_c \end{bmatrix}\]</span></p><p>åˆ°è¿™é‡Œ<span class="math inline">\(\begin{bmatrix} \frac{f}{d_x}&amp; 0 &amp;u_o \\ 0 &amp; \frac{f}{d_y}&amp; v_0\\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span> <strong>å°±æ˜¯ç›¸æœºçš„å†…å‚çŸ©é˜µï¼Œè·Ÿç›¸æœºçš„ç„¦è·å’Œä¼ æ„Ÿå™¨çš„å¤§å°ç­‰å‚æ•°æœ‰å…³</strong>ã€‚</p><h2 id="ä¸–ç•Œåæ ‡ç³»">ä¸–ç•Œåæ ‡ç³»</h2><p>ç•Œåæ ‡ç³»æ˜¯å›¾åƒä¸çœŸå®ç‰©ä½“ä¹‹é—´çš„ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚å¦‚æœæ˜¯å•ç›®è§†è§‰çš„è¯ï¼Œä¸»è¦å°±æ˜¯çœŸå®ç‰©ä½“å°ºå¯¸ä¸å›¾åƒå°ºå¯¸çš„æ˜ å°„å…³ç³»ã€‚å¦‚æœæ˜¯å¤šç›®è§†è§‰çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦çŸ¥é“å¤šä¸ªç›¸æœºä¹‹é—´çš„å…³ç³»ï¼Œè¿™ä¸ªå…³ç³»å°±éœ€è¦åœ¨åŒä¸€ä¸ªåæ ‡ç³»ä¸‹è¿›è¡Œæ¢ç®—ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œä¸–ç•Œåæ ‡ç³»çš„åŸç‚¹æ˜¯ Ow, è€Œ Xw,Yw,Zw è½´å¹¶ä¸æ˜¯ä¸å…¶ä»–åæ ‡ç³»å¹³è¡Œçš„ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„è§’åº¦ï¼Œå¹¶ä¸”æœ‰ä¸€å®šçš„å¹³ç§»ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/CoordinateSystem1.png"></p><p>å¯¹äºä¸–ç•Œåæ ‡ç³»åˆ°ç›¸æœºåæ ‡ç³»çš„è½¬æ¢æ˜¯åˆšä½“å˜æ¢ï¼Œæ˜¯æ—‹è½¬åŠ¨ä½œå’Œå¹³ç§»åŠ¨ä½œçš„ç»“æœï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix} x_c\\&nbsp; y_c\\&nbsp; z_c\\&nbsp; 1 \end{bmatrix} = \begin{bmatrix}R &amp; t\\ 0 &amp; 1 \end{bmatrix}\begin{bmatrix} x_w\\&nbsp; y_w\\&nbsp; z_w\\&nbsp; 1 \end{bmatrix}\]</span></p><p>è¿™é‡Œ<span class="math inline">\(\begin{bmatrix}R &amp; t\\ 0 &amp; 1 \end{bmatrix}\)</span>å°±æ˜¯ç›¸æœºçš„å¤–å‚çŸ©é˜µï¼ŒR æ˜¯ç›¸æœºç›¸å¯¹ä¸–ç•Œåæ ‡ç³»çš„æ—‹è½¬å…³ç³»ï¼Œt æ˜¯ç›¸æœºç›¸å¯¹äºä¸–ç•Œåæ ‡ç³»çš„å¹³ç§»å…³ç³»ï¼Œå½“ç›¸æœºä½å§¿å‘ç”Ÿå˜åŒ–ï¼Œè¯¥å‚æ•°ä¹Ÿç›¸åº”çš„å‘ç”Ÿå˜åŒ–**ã€‚</p><h1 id="å›¾åƒç•¸å˜åŠç•¸å˜çŸ«æ­£">å›¾åƒç•¸å˜åŠç•¸å˜çŸ«æ­£</h1><h2 id="å¾„å‘ç•¸å˜">å¾„å‘ç•¸å˜</h2><p>å¾„å‘ç•¸å˜ï¼šæ˜¯ç”±äºé€é•œå½¢çŠ¶çš„åˆ¶é€ å·¥è‰ºå¯¼è‡´ï¼Œä¸”è¶Šå‘é€é•œè¾¹ç¼˜ç§»åŠ¨å¾„å‘ç•¸å˜è¶Šä¸¥é‡ï¼Œå®é™…æƒ…å†µä¸­æˆ‘ä»¬å¸¸ç”¨ r=0 å¤„çš„æ³°å‹’çº§æ•°å±•å¼€çš„å‰å‡ é¡¹æ¥è¿‘ä¼¼æè¿°å¾„å‘ç•¸å˜ï¼ŒçŸ«æ­£å¾„å‘ç•¸å˜å‰åçš„åæ ‡å…³ç³»ä¸ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/RadialDistortion.png"></p><p>å¾„å‘ç•¸å˜çš„çŸ«æ­£å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;x_{rad}=x(1+k_1r^2+k_2r^4+k_3r^6) \\&amp;y_{rad}=y(1+k_1r^2+k_2r^4+k_3r^6)\end{aligned}\]</span></p><h2 id="åˆ‡å‘ç•¸å˜">åˆ‡å‘ç•¸å˜</h2><p>åˆ‡å‘ç•¸å˜ï¼šæ˜¯ç”±äºé€é•œå’Œ CMOS æˆ–è€… CCD çš„å®‰è£…ä½ç½®è¯¯å·®å¯¼è‡´ï¼Œåˆ‡å‘ç•¸å˜éœ€è¦ä¸¤ä¸ªé¢å¤–çš„ç•¸å˜å‚æ•°æ¥æè¿°ï¼ŒçŸ«æ­£å‰åçš„åæ ‡å…³ç³»ä¸ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/TangentialDistortion.png"></p><p>åˆ‡å‘ç•¸å˜çš„çŸ«æ­£å…¬å¼å¦‚ä¸‹ï¼ˆè¿™é‡Œä¸ç»™å‡ºæ¨å¯¼è¿‡ç¨‹ï¼Œç›´æ¥ä½¿ç”¨ï¼‰ï¼š</p><p><span class="math display">\[x_{tan}=x+2p_1xy+p_2(r^2+2x^2)\\y_{tan}=y+p_1(r^2+2y^2)+2p_2xy\]</span></p><h2 id="ç•¸å˜çŸ«æ­£">ç•¸å˜çŸ«æ­£</h2><p>ç»¼åˆä»¥ä¸Šä¸¤ç§ç•¸å˜ï¼Œå¾—åˆ°ç›¸æœºçš„ç•¸å˜æ¨¡å‹ï¼ˆçº æ­£åçš„å›¾åƒåƒç´ åæ ‡ç³»çš„åæ ‡ï¼‰ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;r^2=x^2+y^2  \\ &amp;x_{distorted}=x(1+k_1r^2+k_2r^4+k_3r^6)+2p_1xy+p_2(r^2+2x^2) \\ &amp;y_{distorted}=y(1+k_1r^2+k_2r^4+k_3r^6)+p_1(r^2+2y^2)+2p_2xy\end{aligned}\]</span></p><p>å…¶ä¸­ x,y æ˜¯æ˜¯å»ç•¸å˜åçš„å›¾åƒåæ ‡ï¼Œå®ƒæ˜¯å½’ä¸€åŒ–çš„åæ ‡ï¼Œä»¥å›¾åƒä¸­å¿ƒä¸ºåŸç‚¹ã€‚r ä¸ºåŠå¾„ã€‚<span class="math inline">\(x_{distorted}y_{distorted}\)</span>æ˜¯å…·æœ‰ç•¸å˜å¾—å›¾åƒåæ ‡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Image </tag>
            
            <tag> Stabilization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ V4L2 å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverV4L2/"/>
      <url>/2020/LinuxDriver/LinuxDriverV4L2/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>V4L2 æ˜¯ä¸“é—¨ä¸º linux è®¾å¤‡è®¾è®¡çš„ä¸€å¥—è§†é¢‘æ¡†æ¶ï¼Œå…¶ä¸»ä½“æ¡†æ¶åœ¨ linux å†…æ ¸ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯æ•´ä¸ª linux ç³»ç»Ÿä¸Šé¢çš„è§†é¢‘æºæ•è·é©±åŠ¨æ¡†æ¶ã€‚å…¶å¹¿æ³›åº”ç”¨åœ¨åµŒå…¥å¼è®¾å¤‡ä»¥åŠç§»åŠ¨ç«¯ã€ä¸ªäººç”µè„‘è®¾å¤‡ä¸Šé¢ï¼Œå¸‚é¢ä¸Šçš„ç¼–ç äº§å“ç±»å¦‚ï¼šSDVã€æ‰‹æœºã€IPCã€è¡Œè½¦è®°å½•ä»ªéƒ½ä¼šç”¨åˆ°è¿™ä¸ªæ¡†æ¶æ¥è¿›è¡Œè§†é¢‘é‡‡é›†ã€‚</p><h1 id="æ¡†æ¶">æ¡†æ¶</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/V4L2_Framework.jpeg"></p><p>è¯¥å›¾æè¿°äº† v4l2 é©±åŠ¨æ¡†æ¶çš„æ•´ä½“ç»“æ„ï¼Œv4l2 æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå›¾ä¸­èŠ¯ç‰‡æ¨¡å—å¯¹åº” Soc çš„å„ä¸ªå­æ¨¡å—ï¼Œvideo_device ç»“æ„ä½“ä¸»è¦ç”¨æ¥æ§åˆ¶ Soc çš„ video æ¨¡å—ï¼Œv4l2_device ä¼šåŒ…å«å¤šä¸ª v4l2_subdev ï¼Œæ¯ä¸ª v4l2_subdev ç”¨æ¥æ§åˆ¶å„è‡ªçš„å­æ¨¡å—ï¼ŒæŸäº›é©±åŠ¨ä¸éœ€è¦ v4l2_subdev ï¼Œä¾é  video æ¨¡å—å°±èƒ½å®ç°åŠŸèƒ½ã€‚</p><ul><li>video_deviceï¼šä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œä¸ºç”¨æˆ·ç©ºé—´æä¾›è®¾å¤‡èŠ‚ç‚¹ï¼ˆ/dev/videoXï¼‰ï¼Œæä¾›ç³»ç»Ÿè°ƒç”¨çš„ç›¸å…³æ“ä½œï¼Œæ˜¯é‡‡é›†è®¾å¤‡çš„æŠ½è±¡æ¥å£ã€‚</li><li>vb2_queueï¼šä¸ vb2_v4l2_buffer ä¸€èµ·ç”¨äºæ•°æ®æµçš„å®é™…é€»è¾‘å’Œ DMA æ“ä½œã€‚</li><li>v4l2_deviceï¼šè¡¨ç¤ºä¸€ä¸ª v4l2 è®¾å¤‡çš„å®ä¾‹ã€‚</li><li>v4l2_subdevï¼šå±äº v4l2 è®¾å¤‡çš„å­è®¾å¤‡ï¼Œä¸€ä¸ª v4l2 è®¾å¤‡å¯ä»¥æ‹¥æœ‰å¤šä¸ªå­è®¾å¤‡ã€‚</li><li>videobufï¼šv4l2 é©±åŠ¨çš„ç¼“å­˜ç®¡ç†ã€‚</li></ul><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>æ•´ä½“æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE3NTE2MTU2Mzc2ODkxMmI1NjMzNGUw">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/V4L2_Struct.png"></p><ul><li><p>v4l2_deviceï¼š<br>è¿™ä¸ªæ˜¯æ•´ä¸ªè¾“å…¥è®¾å¤‡çš„æ€»ç»“æ„ä½“ï¼Œæ˜¯æ‰€æœ‰å­è®¾å¤‡çš„æ ¹èŠ‚ç‚¹ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰å­è®¾å¤‡ã€‚ç”±è¯¥ç»“æ„ä½“å¼•ç”³å‡ºæ¥ v4l2_subdevã€‚ç”¨äºè§†é¢‘è¾“å…¥è®¾å¤‡æ•´ä½“çš„ç®¡ç†ï¼Œæœ‰å¤šå°‘è¾“å…¥è®¾å¤‡å°±æœ‰å¤šå°‘ä¸ª v4l2_device æŠ½è±¡ï¼ˆæ¯”å¦‚ä¸€ä¸ª USB æ‘„åƒå¤´æ•´ä½“å°±å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª V4L2 deviceï¼‰ã€‚å†å¾€ä¸‹åˆ†æ˜¯è¾“å…¥å­è®¾å¤‡ï¼Œå¯¹åº”çš„æ˜¯ä¾‹å¦‚ ISPã€CSIã€MIPI ç­‰è®¾å¤‡ï¼Œå®ƒä»¬æ˜¯ä»å±äºä¸€ä¸ª V4L2 device ä¹‹ä¸‹çš„</p></li><li><p>media_deviceï¼š<br>ç”¨äºè¿è¡Œæ—¶æ•°æ®æµçš„ç®¡ç†ï¼ŒåµŒå…¥åœ¨ V4L2 device å†…éƒ¨ï¼Œè¿è¡Œæ—¶çš„æ„æ€å°±æ˜¯ï¼šä¸€ä¸ª V4L2 device ä¸‹å±å¯èƒ½æœ‰éå¸¸å¤šåŒç±»å‹çš„å­è®¾å¤‡ï¼ˆä¸¤ä¸ªæˆ–è€…å¤šä¸ª sensorã€ISP ç­‰ï¼‰ï¼Œé‚£ä¹ˆåœ¨è®¾å¤‡è¿è¡Œçš„æ—¶å€™æˆ‘æ€ä¹ˆçŸ¥é“æˆ‘çš„æ•°æ®æµéœ€è¦ç”¨åˆ°å“ªä¸€ä¸ªç±»å‹çš„å“ªä¸€ä¸ªå­è®¾å¤‡å‘¢ã€‚è¿™ä¸ªæ—¶å€™å°±è½®åˆ° media_device å‡ºæ‰‹äº†ï¼Œå®ƒä¸ºè¿™ä¸€å¨çš„å­è®¾å¤‡å»ºç«‹ä¸€æ¡è™šæ‹Ÿçš„è¿çº¿ï¼Œå»ºç«‹èµ·æ¥ä¸€ä¸ªè¿è¡Œæ—¶çš„ pipelineï¼ˆç®¡é“ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ”¹å˜ã€ç®¡ç†æ¥å…¥çš„è®¾å¤‡</p></li><li><p>v4l2_ctrl_handlerï¼š<br>æ§åˆ¶æ¨¡å—ï¼Œæä¾›å­è®¾å¤‡ï¼ˆä¸»è¦æ˜¯ video å’Œ ISP è®¾å¤‡ï¼‰åœ¨ç”¨æˆ·ç©ºé—´çš„ç‰¹æ•ˆæ“ä½œæ¥å£ï¼Œæ¯”å¦‚ä½ æƒ³æ”¹å˜ä¸‹è¾“å‡ºå›¾åƒçš„äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ç­‰ç­‰ï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å®Œæˆ</p></li><li><p>v4l2_ctrlï¼š<br>control çš„ç»“æ„ä½“æŠ½è±¡ï¼Œä¸€ä¸ª control å°±ç”¨ä¸€ä¸ªå®ä¾‹åŒ–çš„ v4l2_ctrl å˜é‡æ¥è¡¨ç¤º</p></li><li><p>v4l2_ctrl_refï¼š<br>ä¸€ä¸ªå®ä¾‹åŒ–çš„ v4l2_ctrl çš„å¼•ç”¨ï¼Œå¯ä»¥çœ‹åˆ°è¯¥ç»“æ„ä½“é‡Œé¢åŒ…å«äº†ä¸€ä¸ª struct v4l2_ctrl * ç±»å‹çš„æŒ‡é’ˆå˜é‡æˆå‘˜ï¼Œè¯¥æŒ‡é’ˆæˆå‘˜æŒ‡å‘çš„å°±æ˜¯ä¸ä¹‹ä¸€ä¸€å¯¹åº”çš„ v4l2_ctrl å®ä¾‹åŒ–å¯¹è±¡</p></li><li><p>vb2_queueï¼š<br>ä¾›å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´çš„ buffer æµè½¬æ¥å£ï¼Œè¾“å…¥è®¾å¤‡äº§ç”Ÿäº†ä¸€å¨å›¾åƒæ•°æ®ï¼Œåœ¨å†…æ ¸é‡Œé¢åº”è¯¥æ”¾åœ¨å“ªé‡Œå‘¢ï¼Ÿèƒ½æ”¾å‡ ä¸ªå‘¢ï¼Ÿæ˜¯æ•´æ®µè¿ç»­çš„è¿˜æ˜¯è¿˜æ˜¯åˆ†æ®µè¿ç»­çš„åˆæˆ–è€…æ˜¯ç‰©ç†ä¸è¿ç»­çš„ï¼Ÿç”¨æˆ·æ€ä¹ˆå»å–ç”¨å‘¢ï¼Ÿéƒ½æ˜¯å®ƒåœ¨ç®¡ç†</p></li></ul><p>entityã€link å’Œ pad è¯¥æ€ä¹ˆç†è§£å‘¢ï¼Œè¿™é‡Œåœ¨ç½‘ä¸Šæ‰¾åˆ°ä¸€å¼ å›¾æŒºå½¢è±¡çš„ï¼Œè¿™é‡Œè´´å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/entity.png"></p><p>å¾…ç»­ã€‚..</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXNpb24uY29tL2FydGljbGUvMjEwOTk5NTk5Lw==">https://www.freesion.com/article/210999599/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly95ZWxsb3dtYXguYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvODA3MTg4MzE=">https://yellowmax.blog.csdn.net/article/details/80718831<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly95ZWxsb3dtYXguYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvODMyNDI0NDY=">https://yellowmax.blog.csdn.net/article/details/83242446<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTM5MDQyMjcvYXJ0aWNsZS9kZXRhaWxzLzgwODg5OTQ3">https://blog.csdn.net/u013904227/article/details/80889947<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ Regulator å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverRegulator/"/>
      <url>/2020/LinuxDriver/LinuxDriverRegulator/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>è¯¥æ¡†æ¶æ—¨åœ¨æä¾›æ ‡å‡†å†…æ ¸æ¥å£æ¥æ§åˆ¶ç”µå‹å’Œç”µæµ Regulatorã€‚å…¶ç›®çš„æ˜¯å…è®¸ç³»ç»ŸåŠ¨æ€æ§åˆ¶ Regulator åŠŸç‡è¾“å‡ºï¼Œä»¥èŠ‚çœåŠŸç‡å¹¶å»¶é•¿ç”µæ± å¯¿å‘½ã€‚ è¿™é€‚ç”¨äºç”µå‹ Regulatorï¼ˆç”µå‹è¾“å‡ºå¯æ§ï¼‰å’Œç”µæµ Regulatorï¼ˆç”µæµé™åˆ¶å¯æ§ï¼‰ã€‚</p><span id="more"></span><h2 id="å‘½åæ³•">å‘½åæ³•</h2><ul><li><p>Regulator:<br>ä¸ºå…¶ä»–è®¾å¤‡ä¾›ç”µçš„ç”µå­è®¾å¤‡ã€‚å¤§å¤šæ•°ç¨³å‹å™¨å¯ä»¥å¯ç”¨å’Œç¦ç”¨å…¶è¾“å‡ºï¼Œè€Œæœ‰äº›å¯ä»¥æ§åˆ¶å…¶è¾“å‡ºç”µå‹å’Œ/æˆ–ç”µæµã€‚è¾“å…¥ç”µå‹ -&gt; ç¨³å‹å™¨ -&gt; è¾“å‡ºç”µå‹</p></li><li><p>PMIC:<br>ç”µæºç®¡ç† ICã€‚ åŒ…å«å¤šä¸ªç¨³å‹å™¨ä¸”é€šå¸¸åŒ…å«å…¶ä»–å­ç³»ç»Ÿçš„ IC</p></li><li><p>Consumer:<br>ç”±ç¨³å‹å™¨ä¾›ç”µçš„ç”µå­è®¾å¤‡ã€‚ æ¶ˆè´¹è€…å¯åˆ†ä¸ºä¸¤ç±»ï¼š</p><p>é™æ€ï¼šæ¶ˆè´¹è€…ä¸ä¼šæ”¹å˜å…¶ç”µæºç”µå‹æˆ–ç”µæµé™åˆ¶ã€‚ å®ƒåªéœ€è¦å¯ç”¨æˆ–ç¦ç”¨å…¶ç”µæºã€‚ å…¶ç”µæºç”µå‹ç”±ç¡¬ä»¶ã€å¼•å¯¼åŠ è½½ç¨‹åºã€å›ºä»¶æˆ–å†…æ ¸æ¿åˆå§‹åŒ–ä»£ç è®¾ç½® åŠ¨æ€ï¼šæ¶ˆè´¹è€…éœ€è¦æ”¹å˜å…¶ç”µæºç”µå‹æˆ–ç”µæµé™åˆ¶ä»¥æ»¡è¶³æ“ä½œéœ€æ±‚</p></li><li><p>Power Domain:<br>ç”±ç¨³å‹å™¨ã€å¼€å…³æˆ–å…¶ä»–ç”µæºåŸŸçš„è¾“å‡ºç”µæºæä¾›å…¶è¾“å…¥ç”µæºçš„ç”µå­ç”µè·¯ã€‚ç”µæº Regulator å¯èƒ½ä½äºä¸€ä¸ªæˆ–å¤šä¸ªå¼€å…³åé¢ï¼Œä¾‹å¦‚ï¼š</p><pre><code>  Regulator -+-&gt; Switch-1 -+-&gt; Switch-2 --&gt; [Consumer A]             |             |             |             +-&gt; [Consumer B], [Consumer C]             |             +-&gt; [Consumer D], [Consumer E]</code></pre><p>è¿™æ˜¯ä¸€ä¸ªç¨³å‹å™¨å’Œä¸‰ä¸ªç”µæºåŸŸï¼š</p><pre><code>  Domain 1: Switch-1, Consumers D &amp; E.  Domain 2: Switch-2, Consumers B &amp; C.  Domain 3: Consumer A.</code></pre><p>è¿™ä»£è¡¨äº†ä¸€ç§"supplies"å…³ç³»ï¼š</p><pre><code>  Domain-1 --&gt; Domain-2 --&gt; Domain-3.</code></pre></li><li><p>Constraints:<br>çº¦æŸç”¨äºå®šä¹‰æ€§èƒ½å’Œç¡¬ä»¶ä¿æŠ¤çš„åŠŸç‡çº§åˆ«ã€‚çº¦æŸå­˜åœ¨äºä¸‰ä¸ªå±‚é¢ï¼š 1ã€ç¨³å‹å™¨çº§åˆ«ï¼šè¿™ç”±ç¨³å‹å™¨ç¡¬ä»¶æ“ä½œå‚æ•°å®šä¹‰ï¼Œå¹¶åœ¨ç¨³å‹å™¨æ•°æ®è¡¨ä¸­æŒ‡å®šï¼Œä¾‹å¦‚ï¼š</p><pre><code>  ç”µå‹è¾“å‡ºèŒƒå›´ä¸º 800mV -&gt; 3500mV  ç¨³å‹å™¨ç”µæµè¾“å‡ºé™åˆ¶ä¸º 20mA @ 5Vï¼Œä½†ä¸º 10mA @ 10V</code></pre><p>2ã€åŠŸç‡åŸŸçº§åˆ«ï¼šè¿™æ˜¯ç”±å†…æ ¸çº§æ¿åˆå§‹åŒ–ä»£ç åœ¨è½¯ä»¶ä¸­å®šä¹‰çš„ã€‚ å®ƒç”¨äºå°†åŠŸç‡åŸŸé™åˆ¶åœ¨ç‰¹å®šçš„åŠŸç‡èŒƒå›´å†…ï¼Œä¾‹å¦‚ï¼š</p><pre><code>  Domain-1 ç”µå‹ä¸º 3300mV  Domain-2 ç”µå‹ä¸º 1400mV -&gt; 1600mV  Domain-3 ç”µæµé™åˆ¶ä¸º 0mA -&gt; 20mA</code></pre><p>3ã€Consumer çº§åˆ«ï¼šè¿™æ˜¯ç”± Consumer é©±åŠ¨ç¨‹åºåŠ¨æ€è®¾ç½®ç”µå‹æˆ–ç”µæµé™åˆ¶çº§åˆ«å®šä¹‰çš„ã€‚ä¾‹å¦‚ æ¶ˆè´¹ç±»èƒŒå…‰é©±åŠ¨å™¨è¦æ±‚å°†ç”µæµä» 5mA å¢åŠ åˆ° 10mAï¼Œä»¥å¢åŠ  LCD äº®åº¦ã€‚ è¿™å°†é€šè¿‡ä»¥ä¸‹çº§åˆ«ï¼š</p><pre><code>  Consumerï¼šéœ€è¦å¢åŠ  LCD äº®åº¦ã€‚ åœ¨äº®åº¦è¡¨ä¸­æŸ¥æ‰¾å¹¶è¯·æ±‚ä¸‹ä¸€ä¸ªå½“å‰ mA å€¼ï¼ˆConsumer é©±åŠ¨ç¨‹åºå¯ç”¨äºåŸºäºç›¸åŒå‚è€ƒè®¾å¤‡çš„å¤šä¸ªä¸åŒä¸ªæ€§ï¼‰  ç”µæºåŸŸï¼šæ˜¯æ­¤åŸŸå’Œç³»ç»ŸçŠ¶æ€ï¼ˆä¾‹å¦‚ç”µæ± ç”µæºã€USB ç”µæºï¼‰çš„åŸŸæ“ä½œé™åˆ¶å†…çš„æ–°ç”µæµé™åˆ¶  ç¨³å‹å™¨åŸŸï¼šæ˜¯è¾“å…¥/è¾“å‡ºç”µå‹çš„ç¨³å‹å™¨æ“ä½œå‚æ•°å†…çš„æ–°ç”µæµé™åˆ¶ã€‚</code></pre><p>å¦‚æœ Regulator è¯·æ±‚é€šè¿‡æ‰€æœ‰çº¦æŸæµ‹è¯•ï¼Œåˆ™åº”ç”¨æ–°çš„ Regulator å€¼</p></li></ul><h2 id="design">Design</h2><p>Regulator æ¡†æ¶ä¸“ä¸ºåŸºäº SoC çš„è®¾å¤‡è€Œè®¾è®¡ï¼Œä½†ä¹Ÿå¯èƒ½ä¸é SoC è®¾å¤‡ç›¸å…³ï¼Œå¹¶åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ¥å£ï¼š</p><ul><li><p>Consumer driver interface:<br>è¿™ä½¿ç”¨ä¸å†…æ ¸æ—¶é’Ÿæ¥å£ç±»ä¼¼çš„ APIï¼Œå› ä¸º Consumer é©±åŠ¨ç¨‹åºå¯ä»¥è·å–å’Œæ”¾ç½®ä¸€ä¸ª Regulatorï¼ˆå°±åƒä»–ä»¬å¯ä»¥ä½¿ç”¨æ—¶é’Ÿ atmï¼‰å¹¶è·å–/è®¾ç½®ç”µå‹ã€ç”µæµé™åˆ¶ã€å¯ç”¨å’Œç¦ç”¨ã€‚ è¿™åº”è¯¥å…è®¸ Consumer å®Œå…¨æ§åˆ¶ä»–ä»¬çš„ç”µæºç”µå‹å’Œç”µæµé™åˆ¶</p></li><li><p>Regulator driver interface:<br>è¿™å…è®¸ Regulator é©±åŠ¨ç¨‹åºæ³¨å†Œå…¶ Regulator å¹¶å‘å†…æ ¸æä¾›æ“ä½œã€‚ å®ƒè¿˜å…·æœ‰ç”¨äºå‘å®¢æˆ·ç«¯ä¼ æ’­äº‹ä»¶çš„é€šçŸ¥ç¨‹åºè°ƒç”¨é“¾</p></li><li><p>Machine interface:<br>æ­¤æ¥å£ç”¨äºæœºå™¨ç‰¹å®šä»£ç ï¼Œå¹¶å…è®¸ä¸ºæ¯ä¸ªç¨³å‹å™¨åˆ›å»ºç”µå‹/ç”µæµåŸŸï¼ˆå¸¦çº¦æŸï¼‰ã€‚ å®ƒå¯ä»¥æä¾›ç¨³å‹å™¨çº¦æŸï¼Œä»¥é˜²æ­¢ç”±äºæœ‰ç¼ºé™·çš„å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºå¼•èµ·çš„è¿‡å‹æˆ–è¿‡æµè€ŒæŸåè®¾å¤‡ã€‚ å®ƒè¿˜å…è®¸åˆ›å»º regulators æ ‘ï¼Œå…¶ä¸­ä¸€äº› regulators ç”±å…¶ä»– regulators æä¾›ï¼ˆç±»ä¼¼äºæ—¶é’Ÿæ ‘ï¼‰</p></li><li><p>Userspace ABI:<br>è¯¥æ¡†æ¶è¿˜é€šè¿‡ sysfs å°†è®¸å¤šæœ‰ç”¨çš„ç”µå‹/ç”µæµ/æ“ä½œæ¨¡å¼æ•°æ®å¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´ã€‚ è¿™å¯ç”¨äºå¸®åŠ©ç›‘æ§è®¾å¤‡åŠŸè€—å’ŒçŠ¶æ€</p></li></ul><h1 id="regulator-consumer-driver-interface">Regulator Consumer Driver Interface</h1><p>æœ¬èŠ‚æè¿°äº†æ¶ˆè´¹ç±»è®¾å¤‡é©±åŠ¨ç¨‹åºçš„è°ƒèŠ‚å™¨æ¥å£ã€‚</p><h2 id="consumer-regulator-access-static-dynamic-drivers">Consumer Regulator Access (static &amp; dynamic drivers)</h2><p>æ¶ˆè´¹è€…é©±åŠ¨ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ regulator_get è®¿é—®å…¶ä¾›åº”è°ƒèŠ‚å™¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regulator = regulator_get(dev, <span class="string">"Vcc"</span>);</span><br></pre></td></tr></tbody></table></figure><p>æ¶ˆè´¹è€…ä¼ å…¥å…¶ç»“æ„è®¾å¤‡æŒ‡é’ˆå’Œç”µæº IDã€‚ ç„¶åå†…æ ¸é€šè¿‡æŸ¥è¯¢ç‰¹å®šäºæœºå™¨çš„æŸ¥æ‰¾è¡¨æ‰¾åˆ°æ­£ç¡®çš„è°ƒèŠ‚å™¨ã€‚ å¦‚æœæŸ¥æ‰¾æˆåŠŸï¼Œåˆ™æ­¤è°ƒç”¨å°†è¿”å›ä¸€ä¸ªæŒ‡å‘æä¾›æ­¤ä½¿ç”¨è€…çš„ç»“æ„è°ƒèŠ‚å™¨çš„æŒ‡é’ˆã€‚</p><p>è¦é‡Šæ”¾è°ƒèŠ‚å™¨ï¼Œæ¶ˆè´¹è€…é©±åŠ¨ç¨‹åºåº”è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regulator_put(regulator);</span><br></pre></td></tr></tbody></table></figure><p>æ¶ˆè´¹è€…å¯ä»¥ç”±å¤šä¸ªè°ƒèŠ‚å™¨ä¾›ç”µï¼Œä¾‹å¦‚ å…·æœ‰æ¨¡æ‹Ÿå’Œæ•°å­—ç”µæºçš„ç¼–è§£ç å™¨æ¶ˆè´¹è€…ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">digital = regulator_get(dev, <span class="string">"Vcc"</span>);  <span class="comment">/* digital core */</span></span><br><span class="line">analog = regulator_get(dev, <span class="string">"Avdd"</span>);  <span class="comment">/* analog */</span></span><br></pre></td></tr></tbody></table></figure><p>è°ƒèŠ‚å™¨è®¿é—®å‡½æ•° regulator_get() å’Œ regulator_put() é€šå¸¸ä¼šåˆ†åˆ«åœ¨æ‚¨çš„è®¾å¤‡é©±åŠ¨ç¨‹åº probe() å’Œ remove() ä¸­è°ƒç”¨ã€‚</p><h2 id="regulator-output-enable-disable-static-dynamic-drivers">Regulator Output Enable &amp; Disable (static &amp; dynamic drivers)</h2><p>æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è°ƒç”¨ regulator_enable å¯ç”¨è°ƒèŠ‚å™¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_enable</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>åœ¨è°ƒç”¨ regulator_enabled() ä¹‹å‰ï¼Œç”µæºå¯èƒ½å·²ç»å¯ç”¨ã€‚ å¦‚æœæ¶ˆè´¹è€…å…±äº«è°ƒèŠ‚å™¨æˆ–è°ƒèŠ‚å™¨å…ˆå‰å·²ç”±å¼•å¯¼åŠ è½½ç¨‹åºæˆ–å†…æ ¸æ¿åˆå§‹åŒ–ä»£ç å¯ç”¨ï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p></blockquote><p>æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è°ƒç”¨ regulator_is_enabled åˆ¤æ–­æ˜¯å¦å¯ç”¨äº†è°ƒèŠ‚å™¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_is_enabled</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å½“è°ƒèŠ‚å™¨å¯ç”¨æ—¶ï¼Œè¿™å°†è¿”å›å¤§äºé›¶ã€‚</p><p>æ¶ˆè´¹è€…å¯ä»¥åœ¨ä¸å†éœ€è¦æ—¶é€šè¿‡è°ƒç”¨ç¦ç”¨å…¶ä¾›åº”ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_disable</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>å¦‚æœå®ƒä¸å…¶ä»–æ¶ˆè´¹è€…å…±äº«ï¼Œè¿™å¯èƒ½ä¸ä¼šç¦ç”¨ä¾›åº”ã€‚ ä»…å½“å¯ç”¨çš„å‚è€ƒè®¡æ•°ä¸ºé›¶æ—¶ï¼Œæ‰ä¼šç¦ç”¨è°ƒèŠ‚å™¨ã€‚</p></blockquote><p>æœ€åï¼Œåœ¨ç´§æ€¥æƒ…å†µä¸‹å¯ä»¥å¼ºåˆ¶ç¦ç”¨è°ƒèŠ‚å™¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_force_disable</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>è¿™å°†ç«‹å³å¼ºåˆ¶å…³é—­ç¨³å‹å™¨è¾“å‡ºã€‚ æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å°†æ–­ç”µã€‚</p></blockquote><h2 id="regulator-voltage-control-status-dynamic-drivers">Regulator Voltage Control &amp; Status (dynamic drivers)</h2><p>ä¸€äº›æ¶ˆè´¹ç±»é©±åŠ¨å™¨éœ€è¦èƒ½å¤ŸåŠ¨æ€æ”¹å˜å…¶ç”µæºç”µå‹ä»¥åŒ¹é…ç³»ç»Ÿå·¥ä½œç‚¹ã€‚ ä¾‹å¦‚ CPUfreq é©±åŠ¨ç¨‹åºå¯ä»¥éšé¢‘ç‡è°ƒæ•´ç”µå‹ä»¥èŠ‚çœç”µé‡ï¼ŒSD é©±åŠ¨ç¨‹åºå¯èƒ½éœ€è¦é€‰æ‹©æ­£ç¡®çš„å¡ç”µå‹ç­‰ã€‚</p><p>æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è°ƒç”¨æ¥æ§åˆ¶ä»–ä»¬çš„ç”µæºç”µå‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_set_voltage</span><span class="params">(regulator, min_uV, max_uV)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ min_uV å’Œ max_uV æ˜¯ä»¥å¾®ä¼ä¸ºå•ä½çš„æœ€å°å’Œæœ€å¤§å¯æ¥å—ç”µå‹ã€‚</p><blockquote><p>è¿™å¯ä»¥åœ¨è°ƒèŠ‚å™¨å¯ç”¨æˆ–ç¦ç”¨æ—¶è°ƒç”¨ã€‚å¦‚æœåœ¨å·²å¯ç”¨ regulator æ—¶è°ƒç”¨ï¼Œåˆ™ç”µå‹ä¼šç«‹å³æ›´æ”¹ï¼Œå¦åˆ™ç”µå‹é…ç½®ä¼šæ›´æ”¹ï¼Œå¹¶ä¸”åœ¨ä¸‹ä¸€æ¬¡å¯ç”¨ç¨³å‹å™¨æ—¶ä¼šç‰©ç†è®¾ç½®ç”µå‹ã€‚</p></blockquote><p>è°ƒèŠ‚å™¨é…ç½®çš„ç”µå‹è¾“å‡ºå¯ä»¥é€šè¿‡è°ƒç”¨æ‰¾åˆ°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_get_voltage</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ— è®ºè°ƒèŠ‚å™¨æ˜¯å¯ç”¨è¿˜æ˜¯ç¦ç”¨ï¼Œget_voltage() éƒ½å°†è¿”å›é…ç½®çš„è¾“å‡ºç”µå‹ï¼Œå¹¶ä¸”ä¸åº”ç”¨äºç¡®å®šè°ƒèŠ‚å™¨è¾“å‡ºçŠ¶æ€ã€‚ ç„¶è€Œï¼Œè¿™å¯ä»¥ä¸ is_enabled() ç»“åˆä½¿ç”¨æ¥ç¡®å®šç¨³å‹å™¨ç‰©ç†è¾“å‡ºç”µå‹ã€‚</p></blockquote><h2 id="regulator-current-limit-control-status-dynamic-drivers">Regulator Current Limit Control &amp; Status (dynamic drivers)</h2><p>ä¸€äº›æ¶ˆè´¹ç±»é©±åŠ¨ç¨‹åºéœ€è¦èƒ½å¤ŸåŠ¨æ€æ›´æ”¹å…¶ç”µæºç”µæµé™åˆ¶ä»¥åŒ¹é…ç³»ç»Ÿå·¥ä½œç‚¹ã€‚ ä¾‹å¦‚ LCD èƒŒå…‰é©±åŠ¨ç¨‹åºå¯ä»¥æ›´æ”¹ç”µæµé™åˆ¶ä»¥æ”¹å˜èƒŒå…‰äº®åº¦ï¼ŒUSB é©±åŠ¨ç¨‹åºå¯èƒ½å¸Œæœ›åœ¨ä¾›ç”µæ—¶å°†é™åˆ¶è®¾ç½®ä¸º 500mAã€‚</p><p>æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è°ƒç”¨æ¥æ§åˆ¶ä»–ä»¬çš„ç”µæºç”µæµé™åˆ¶ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_set_current_limit</span><span class="params">(regulator, min_uA, max_uA)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ min_uA å’Œ max_uA æ˜¯ä»¥å¾®å®‰ä¸ºå•ä½çš„æœ€å°å’Œæœ€å¤§å¯æ¥å—ç”µæµé™åˆ¶ã€‚</p><blockquote><p>è¿™å¯ä»¥åœ¨è°ƒèŠ‚å™¨å¯ç”¨æˆ–ç¦ç”¨æ—¶è°ƒç”¨ã€‚å¦‚æœåœ¨å·²å¯ç”¨ç”µæµé™åˆ¶æ—¶è°ƒç”¨ï¼Œåˆ™ç”µæµé™åˆ¶ä¼šç«‹å³æ›´æ”¹ï¼Œå¦åˆ™ç”µæµé™åˆ¶é…ç½®ä¼šæ›´æ”¹ï¼Œå¹¶ä¸”åœ¨ä¸‹ä¸€æ¬¡å¯ç”¨è°ƒèŠ‚å™¨æ—¶ä¼šè®¾ç½®ç”µæµé™åˆ¶ã€‚</p></blockquote><p>é€šè¿‡è°ƒç”¨å¯ä»¥æ‰¾åˆ°è°ƒèŠ‚å™¨ç”µæµé™åˆ¶ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_get_current_limit</span><span class="params">(regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>æ— è®ºè°ƒèŠ‚å™¨æ˜¯å¯ç”¨è¿˜æ˜¯ç¦ç”¨ï¼Œget_current_limit() éƒ½å°†è¿”å›ç”µæµé™åˆ¶ï¼Œå¹¶ä¸”ä¸åº”ç”¨äºç¡®å®šè°ƒèŠ‚å™¨ç”µæµè´Ÿè½½ã€‚</p></blockquote><h2 id="regulator-operating-mode-control-status-dynamic-drivers">Regulator Operating Mode Control &amp; Status (dynamic drivers)</h2><p>ä¸€äº›æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡æ”¹å˜å…¶ç”µæºè°ƒèŠ‚å™¨çš„å·¥ä½œæ¨¡å¼æ¥è¿›ä¸€æ­¥èŠ‚çœç³»ç»ŸåŠŸç‡ï¼Œä»¥ä¾¿åœ¨æ¶ˆè´¹è€…å·¥ä½œçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æé«˜æ•ˆç‡ã€‚ ä¾‹å¦‚ æ¶ˆè´¹è€…é©±åŠ¨ç¨‹åºç©ºé—²ï¼Œéšåæ¶ˆè€—è¾ƒå°‘çš„ç”µæµã€‚è°ƒèŠ‚å™¨æ“ä½œæ¨¡å¼å¯ä»¥é—´æ¥æˆ–ç›´æ¥æ”¹å˜ã€‚</p><ul><li><p>é—´æ¥æ“ä½œæ¨¡å¼æ§åˆ¶ï¼š æ¶ˆè´¹è€…é©±åŠ¨ç¨‹åºå¯ä»¥é€šè¿‡ä»¥ä¸‹è°ƒç”¨è¯·æ±‚æ›´æ”¹å…¶ç”µæºè°ƒèŠ‚å™¨æ“ä½œæ¨¡å¼ï¼š</p><pre><code>  int regulator_set_load(struct regulator *regulator, int load_uA);</code></pre><p>è¿™å°†å¯¼è‡´ core é‡æ–°è®¡ç®—è°ƒèŠ‚å™¨ä¸Šçš„æ€»è´Ÿè½½ï¼ˆåŸºäºå…¶æ‰€æœ‰æ¶ˆè´¹è€…ï¼‰å¹¶æ›´æ”¹æ“ä½œæ¨¡å¼ï¼ˆå¦‚æœå¿…è¦å’Œå…è®¸ï¼‰ä»¥æœ€ä½³åŒ¹é…å½“å‰æ“ä½œè´Ÿè½½ã€‚load_uA å€¼å¯ä»¥ä»æ¶ˆè´¹è€…çš„æ•°æ®è¡¨ä¸­ç¡®å®šã€‚ ä¾‹å¦‚ å¤§å¤šæ•°æ•°æ®è¡¨éƒ½æœ‰è¡¨æ ¼æ˜¾ç¤ºåœ¨æŸäº›æƒ…å†µä¸‹æ¶ˆè€—çš„æœ€å¤§ç”µæµã€‚å¤§å¤šæ•°æ¶ˆè´¹è€…å°†ä½¿ç”¨é—´æ¥æ“ä½œæ¨¡å¼æ§åˆ¶ï¼Œå› ä¸ºä»–ä»¬ä¸äº†è§£è°ƒèŠ‚å™¨æˆ–è°ƒèŠ‚å™¨æ˜¯å¦ä¸å…¶ä»–æ¶ˆè´¹è€…å…±äº«</p></li><li><p>ç›´æ¥æ“ä½œæ¨¡å¼æ§åˆ¶ï¼š å®šåˆ¶æˆ–ç´§å¯†è€¦åˆçš„é©±åŠ¨å™¨å¯èƒ½å¸Œæœ›æ ¹æ®å…¶å·¥ä½œç‚¹ç›´æ¥æ§åˆ¶è°ƒèŠ‚å™¨çš„å·¥ä½œæ¨¡å¼ï¼Œè¿™å¯ä»¥é€šè¿‡è°ƒç”¨ï¼š</p><pre><code>  int regulator_set_mode(struct regulator *regulator, unsigned int mode);  unsigned int regulator_get_mode(struct regulator *regulator);</code></pre><p>ç›´æ¥æ¨¡å¼å°†ä»…ç”±<em>äº†è§£</em>æœ‰å…³è°ƒèŠ‚å™¨ä¸”ä¸ä¸å…¶ä»–æ¶ˆè´¹è€…å…±äº«è°ƒèŠ‚å™¨çš„æ¶ˆè´¹è€…ä½¿ç”¨</p></li></ul><h2 id="regulator-events">Regulator Events</h2><p>ç›‘ç®¡æœºæ„å¯ä»¥å°†å¤–éƒ¨äº‹ä»¶é€šçŸ¥æ¶ˆè´¹è€…ï¼Œåœ¨ç›‘ç®¡æœºæ„å‹åŠ›æˆ–æ•…éšœæ¡ä»¶ä¸‹ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°äº‹ä»¶ã€‚</p><p>æ¶ˆè´¹è€…è°ƒç”¨ä»¥ä¸‹æ¥å£æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_register_notifier</span><span class="params">(<span class="keyword">struct</span> regulator *regulator,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> notifier_block *nb)</span>;</span><br></pre></td></tr></tbody></table></figure><p>æ¶ˆè´¹è€…è°ƒç”¨ä»¥ä¸‹æ¥å£åæ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_unregister_notifier</span><span class="params">(<span class="keyword">struct</span> regulator *regulator,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> notifier_block *nb)</span>;</span><br></pre></td></tr></tbody></table></figure><p>ç›‘ç®¡æœºæ„ä½¿ç”¨å†…æ ¸é€šçŸ¥ç¨‹åºæ¡†æ¶å‘æ„Ÿå…´è¶£çš„æ¶ˆè´¹è€…å‘é€äº‹ä»¶ã€‚</p><h2 id="regulator-direct-register-access">Regulator Direct Register Access</h2><p>æŸäº›ç±»å‹çš„ç”µæºç®¡ç†ç¡¬ä»¶æˆ–å›ºä»¶è¢«è®¾è®¡ä¸ºéœ€è¦å¯¹è°ƒèŠ‚å™¨è¿›è¡Œä½çº§ç¡¬ä»¶è®¿é—®ï¼Œè€Œæ— éœ€å†…æ ¸å‚ä¸ï¼Œæ­¤ç±»è®¾å¤‡çš„ç¤ºä¾‹æœ‰ï¼š</p><ul><li>å¸¦æœ‰å‹æ§æŒ¯è¡å™¨å’Œæ§åˆ¶é€»è¾‘çš„æ—¶é’Ÿæºï¼Œå¯é€šè¿‡ I2C æ”¹å˜ç”µæºç”µå‹ï¼Œä»¥å®ç°æ‰€éœ€çš„è¾“å‡ºæ—¶é’Ÿé€Ÿç‡ã€‚</li><li>çƒ­ç®¡ç†å›ºä»¶ï¼Œå¯å‘å‡ºä»»æ„ I2C äº‹åŠ¡ä»¥åœ¨è¿‡çƒ­æ¡ä»¶ä¸‹æ‰§è¡Œç³»ç»Ÿæ–­ç”µã€‚</li></ul><p>è¦è®¾ç½®è¿™æ ·çš„è®¾å¤‡/å›ºä»¶ï¼Œéœ€è¦ä¸ºå…¶é…ç½®å„ç§å‚æ•°ï¼Œä¾‹å¦‚è°ƒèŠ‚å™¨çš„ I2C åœ°å€ã€å„ç§è°ƒèŠ‚å™¨å¯„å­˜å™¨çš„åœ°å€ç­‰ã€‚ ç›‘ç®¡è€…æ¡†æ¶æä¾›äº†ä»¥ä¸‹æŸ¥è¯¢è¿™äº›è¯¦ç»†ä¿¡æ¯çš„å¸®åŠ©ç¨‹åºã€‚</p><p>ç‰¹å®šäºæ€»çº¿çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚ I2C åœ°å€æˆ–ä¼ è¾“é€Ÿç‡ï¼Œç”± regmap æ¡†æ¶å¤„ç†ã€‚ è¦è·å–ç›‘ç®¡æœºæ„çš„ regmapï¼ˆå¦‚æœæ”¯æŒï¼‰ï¼Œè¯·ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> regmap *<span class="title function_">regulator_get_regmap</span><span class="params">(<span class="keyword">struct</span> regulator *regulator)</span>;</span><br></pre></td></tr></tbody></table></figure><p>è¦è·å–ç¨³å‹å™¨ç”µå‹é€‰æ‹©å™¨å¯„å­˜å™¨çš„ç¡¬ä»¶å¯„å­˜å™¨åç§»é‡å’Œä½æ©ç ï¼Œè¯·ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_get_hardware_vsel_register</span><span class="params">(<span class="keyword">struct</span> regulator *regulator,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> *vsel_reg,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> *vsel_mask)</span>;</span><br></pre></td></tr></tbody></table></figure><p>è¦å°†è°ƒèŠ‚å™¨æ¡†æ¶ç”µå‹é€‰æ‹©å™¨ä»£ç ï¼ˆç”±è°ƒèŠ‚å™¨åˆ—è¡¨ç”µå‹ä½¿ç”¨ï¼‰è½¬æ¢ä¸ºå¯ç›´æ¥å†™å…¥ç”µå‹é€‰æ‹©å™¨å¯„å­˜å™¨çš„ç‰¹å®šäºç¡¬ä»¶çš„ç”µå‹é€‰æ‹©å™¨ï¼Œè¯·ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_list_hardware_vsel</span><span class="params">(<span class="keyword">struct</span> regulator *regulator,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> selector)</span>;</span><br></pre></td></tr></tbody></table></figure><h1 id="regulator-driver-interface">Regulator Driver Interface</h1><h2 id="registration">Registration</h2><p>é©±åŠ¨ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ¥å£æ³¨å†Œ Regulatorï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> regulator_dev *<span class="title function_">regulator_register</span><span class="params">(<span class="keyword">struct</span> regulator_desc *regulator_desc,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> regulator_config *config)</span>;</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¼šå°† regulator çš„èƒ½åŠ›å’Œæ“ä½œæ³¨å†Œåˆ° regulator æ ¸å¿ƒã€‚</p><p>æ³¨é”€æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">regulator_unregister</span><span class="params">(<span class="keyword">struct</span> regulator_dev *rdev)</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="regulator-events-1">Regulator Events</h2><p>è°ƒèŠ‚å™¨å¯ä»¥é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹å¼å‘æ¶ˆè´¹è€…é©±åŠ¨ç¨‹åºå‘é€äº‹ä»¶ï¼ˆä¾‹å¦‚è¿‡çƒ­ã€æ¬ å‹ç­‰ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">regulator_notifier_call_chain</span><span class="params">(<span class="keyword">struct</span> regulator_dev *rdev,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> event, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></tbody></table></figure><h1 id="regulator-api-design-notes">Regulator API design notes</h1><p>æœ¬èŠ‚å¯¹å½±å“è°ƒèŠ‚å™¨ API è®¾è®¡çš„ä¸€äº›è®¾è®¡æ³¨æ„äº‹é¡¹è¿›è¡Œäº†ç®€è¦çš„ã€éƒ¨åˆ†ç»“æ„åŒ–çš„æ¦‚è¿°ã€‚</p><h2 id="safety">Safety</h2><ul><li>è°ƒèŠ‚å™¨é…ç½®ä¸­çš„é”™è¯¯ä¼šå¯¹ç³»ç»Ÿäº§ç”Ÿéå¸¸ä¸¥é‡çš„åæœï¼Œå¯èƒ½åŒ…æ‹¬æŒä¹…çš„ç¡¬ä»¶æŸåã€‚</li><li>æ— æ³•è‡ªåŠ¨ç¡®å®šç³»ç»Ÿçš„ç”µæºé…ç½® - åŒä¸€èŠ¯ç‰‡çš„è½¯ä»¶ç­‰æ•ˆå˜ä½“å¯èƒ½å…·æœ‰ä¸åŒçš„ç”µæºè¦æ±‚ï¼Œå¹¶ä¸”å¹¶éæ‰€æœ‰å…·æœ‰ç”µæºè¦æ±‚çš„ç»„ä»¶å¯¹è½¯ä»¶éƒ½æ˜¯å¯è§çš„ã€‚</li></ul><blockquote><p>API ä¸åº”æ›´æ”¹ç¡¬ä»¶çŠ¶æ€ï¼Œé™¤éå®ƒçŸ¥é“åœ¨æ­¤ç‰¹å®šç³»ç»Ÿä¸Šæ‰§è¡Œè¿™äº›æ›´æ”¹æ˜¯å®‰å…¨çš„ã€‚</p></blockquote><h2 id="consumer-use-cases">Consumer use cases</h2><ul><li>ç³»ç»Ÿä¸­çš„ç»å¤§å¤šæ•°è®¾å¤‡é™¤äº†èƒ½å¤Ÿæ‰“å¼€æˆ–å…³é—­ç”µæºå¤–ï¼Œä¸éœ€è¦å¯¹å…¶ç”µæºè¿›è¡Œä»»ä½•è¿è¡Œæ—¶é…ç½®ã€‚</li><li>ç³»ç»Ÿä¸­çš„è®¸å¤šç”µæºå°†åœ¨è®¸å¤šä¸åŒçš„æ¶ˆè´¹è€…ä¹‹é—´å…±äº«ã€‚</li></ul><blockquote><p>æ¶ˆè´¹è€… API çš„ç»“æ„åº”ä½¿è¿™äº›ç”¨ä¾‹éå¸¸æ˜“äºå¤„ç†ï¼Œå¹¶ä¸”æ¶ˆè´¹è€…æ— éœ€ä»»ä½•é¢å¤–å·¥ä½œå³å¯ä½¿ç”¨å…±äº«çš„ suppliesã€‚</p></blockquote><h1 id="regulator-machine-driver-interface">Regulator Machine Driver Interface</h1><p>è°ƒèŠ‚å™¨æœºå™¨é©±åŠ¨ç¨‹åºæ¥å£ç”¨äºæ¿/æœºå™¨ç‰¹å®šçš„åˆå§‹åŒ–ä»£ç ä»¥é…ç½®è°ƒèŠ‚å™¨å­ç³»ç»Ÿã€‚</p><pre><code>Regulator-1 -+-&gt; Regulator-2 --&gt; [Consumer A @ 1.8 - 2.0V]             |             +-&gt; [Consumer B @ 3.3V]</code></pre><p>æ¶ˆè´¹è€… A å’Œ B çš„é©±åŠ¨å™¨å¿…é¡»æ˜ å°„åˆ°æ­£ç¡®çš„è°ƒèŠ‚å™¨ï¼Œä»¥æ§åˆ¶å®ƒä»¬çš„ç”µæºã€‚ è¿™ç§æ˜ å°„å¯ä»¥åœ¨æœºå™¨åˆå§‹åŒ–ä»£ç ä¸­é€šè¿‡ä¸ºæ¯ä¸ªè°ƒèŠ‚å™¨åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ regulator_consumer_supply æ¥å®ç°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">regulator_consumer_supply</span> {</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *dev_name;<span class="comment">/* consumer dev_name() */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *supply;<span class="comment">/* consumer supply - e.g. "vcc" */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å¯¹äºä¸Šé¢çš„ç”µæºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">regulator_consumer_supply</span> <span class="title">regulator1_consumers</span>[] =</span> {</span><br><span class="line">REGULATOR_SUPPLY(<span class="string">"Vcc"</span>, <span class="string">"consumer B"</span>),</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">regulator_consumer_supply</span> <span class="title">regulator2_consumers</span>[] =</span> {</span><br><span class="line">REGULATOR_SUPPLY(<span class="string">"Vcc"</span>, <span class="string">"consumer A"</span>),</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™å°† Regulator-1 æ˜ å°„åˆ°æ¶ˆè´¹è€… B çš„â€œVccâ€ç”µæºï¼Œå¹¶å°† Regulator-2 æ˜ å°„åˆ°æ¶ˆè´¹è€… A çš„â€œVccâ€ç”µæºã€‚</p><p>ç°åœ¨å¯ä»¥é€šè¿‡ä¸ºæ¯ä¸ªç¨³å‹å™¨ç”µæºåŸŸå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ regulator_init_data æ¥æ³¨å†Œã€‚è¿™ç§ç»“æ„è¿˜å°†æ¶ˆè´¹è€…æ˜ å°„åˆ°ä»–ä»¬çš„ supply regulatorsï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">regulator_init_data</span> <span class="title">regulator1_data</span> =</span> {</span><br><span class="line">.constraints = {</span><br><span class="line">.name = <span class="string">"Regulator-1"</span>,</span><br><span class="line">.min_uV = <span class="number">3300000</span>,</span><br><span class="line">.max_uV = <span class="number">3300000</span>,</span><br><span class="line">.valid_modes_mask = REGULATOR_MODE_NORMAL,</span><br><span class="line">},</span><br><span class="line">.num_consumer_supplies = ARRAY_SIZE(regulator1_consumers),</span><br><span class="line">.consumer_supplies = regulator1_consumers,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>åç§°å­—æ®µåº”è®¾ç½®ä¸ºå¯¹ç”µè·¯æ¿æœ‰ç”¨çš„æè¿°ï¼Œä»¥ä¾¿ä¸ºå…¶ä»–è°ƒèŠ‚å™¨é…ç½®ç”µæºä»¥åŠç”¨äºæ—¥å¿—è®°å½•å’Œå…¶ä»–è¯Šæ–­è¾“å‡ºã€‚ é€šå¸¸ï¼ŒåŸç†å›¾ä¸­ç”¨äº supply rail çš„åç§°æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ å¦‚æœæœªæä¾›åç§°ï¼Œåˆ™å­ç³»ç»Ÿå°†è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªã€‚</p><p>Regulator-1 ä¸º Regulator-2 ä¾›ç”µã€‚ è¿™ç§å…³ç³»å¿…é¡»åœ¨æ ¸å¿ƒä¸­æ³¨å†Œï¼Œä»¥ä¾¿åœ¨æ¶ˆè´¹è€… A å¯ç”¨å…¶ä¾›åº” (Regulator-2) æ—¶ä¹Ÿå¯ç”¨ Regulator-1ã€‚ ç”µæºè°ƒèŠ‚å™¨ç”±ä¸‹é¢çš„ supply_regulator å­—æ®µè®¾ç½®ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">regulator_init_data</span> <span class="title">regulator2_data</span> =</span> {</span><br><span class="line">.supply_regulator = <span class="string">"Regulator-1"</span>,</span><br><span class="line">.constraints = {</span><br><span class="line">.min_uV = <span class="number">1800000</span>,</span><br><span class="line">.max_uV = <span class="number">2000000</span>,</span><br><span class="line">.valid_ops_mask = REGULATOR_CHANGE_VOLTAGE,</span><br><span class="line">.valid_modes_mask = REGULATOR_MODE_NORMAL,</span><br><span class="line">},</span><br><span class="line">.num_consumer_supplies = ARRAY_SIZE(regulator2_consumers),</span><br><span class="line">.consumer_supplies = regulator2_consumers,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æœ€åï¼Œå¿…é¡»ä»¥é€šå¸¸çš„æ–¹å¼æ³¨å†Œè°ƒèŠ‚å™¨è®¾å¤‡ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">regulator_devices</span>[] =</span> {</span><br><span class="line">{</span><br><span class="line">.name = <span class="string">"regulator"</span>,</span><br><span class="line">.id = DCDC_1,</span><br><span class="line">.dev = {</span><br><span class="line">.platform_data = &amp;regulator1_data,</span><br><span class="line">},</span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">.name = <span class="string">"regulator"</span>,</span><br><span class="line">.id = DCDC_2,</span><br><span class="line">.dev = {</span><br><span class="line">.platform_data = &amp;regulator2_data,</span><br><span class="line">},</span><br><span class="line">},</span><br><span class="line">};</span><br><span class="line"><span class="comment">/* register regulator 1 device */</span></span><br><span class="line">platform_device_register(&amp;regulator_devices[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* register regulator 2 device */</span></span><br><span class="line">platform_device_register(&amp;regulator_devices[<span class="number">1</span>]);</span><br></pre></td></tr></tbody></table></figure><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>ä¸Šæ–‡ä¸­å·²ç»å°† Regulatorã€PMICã€Consumerã€Power Domain ç­‰æ¦‚å¿µè¿›è¡Œäº†ä»‹ç»ï¼ŒåŒæ—¶ä¹Ÿå°†ç›¸å…³æ¥å£è¿›è¡Œäº†ä»‹ç»ã€‚åœ¨è¿™ä¸€ç« ä¸­å°†ä»‹ç» regulator çš„å†…éƒ¨å®ç°ã€‚æ•´ä½“çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2ODNmYzg1NjUzYmIxMzM2ZGY2YmYx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Regulator_Struct.png"></p><ul><li><p>regulator_map:<br>ç»„ç»‡ä¸€ä¸ªç³»ç»Ÿå†…æ‰€æœ‰çš„ pmic è®¾å¤‡ã€‚å°†ä»–ä»¬æŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€é“¾è¡¨ä¸­</p></li><li><p>regulator_dev:<br>struct regulator_dev æ˜¯ regulator è®¾å¤‡çš„æŠ½è±¡ï¼Œå½“ driver ä»¥ struct regulator_descã€struct regulator_config ä¸¤ä¸ªç±»å‹çš„å‚æ•°ï¼Œè°ƒç”¨ regulator_register å°† regulator æ³¨å†Œåˆ° kernel ä¹‹åï¼Œregulator å°±ä¼šåˆ†é…ä¸€ä¸ª struct regulator_dev å˜é‡ï¼Œåç»­æ‰€æœ‰çš„ regulator æ“ä½œï¼Œéƒ½å°†ä»¥è¯¥å˜é‡ä¸ºå¯¹è±¡</p></li><li><p>regulator_desc:<br>regulator_desc ç”¨äºæè¿°ä¸€ä¸ªè°ƒèŠ‚å™¨ï¼ˆdcdcã€ldo ç­‰ï¼‰ã€‚ åœ¨æ³¨å†Œ regulator çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨ struct regulator_desc ç»“æ„æä¾›è¯¥ regulator çš„é™æ€æè¿°ã€‚æ‰€è°“çš„é™æ€ï¼Œæ˜¯æŒ‡è¿™äº›æè¿°ä¸ä¼šåœ¨è¿è¡Œæ—¶æ”¹å˜ï¼Œä»£è¡¨äº†è®¾å¤‡çš„ä¸€ç§å±æ€§ã€‚regulator_desc æè¿°è¯¥ regulator device çš„ç±»å‹ï¼ˆç”µå‹ã€ç”µæµã€ç”µæµå’Œç”µå‹ï¼‰ã€ä¸­æ–­ idã€æ”¯æŒçš„è¾“å‡ºç”µå‹ä¸ªæ•°ã€æ“ä½œç±»å‹ï¼ˆå¯æ”¹å˜ç”µå‹ç­‰ï¼‰ã€è¾“å‡ºæ¨¡å¼ï¼ˆfastã€normalã€idleã€standby ç­‰ï¼‰ï¼›è‹¥è¯¥ regulator device åœ¨æ³¨å†Œçš„æ—¶å€™æ”¯æŒé€šè¿‡ regmap è¿›è¡Œé…ç½®ï¼ˆå¦‚è¯¥ regulator device å¯é€šè¿‡ spiã€iic æ¥å£è®¿é—®ï¼Œåˆ™å¯ä»¥é€šè¿‡ spi/iic å¯¹åº”çš„ regmap æ¥å£è®¿é—®è¯¥ regulator device çš„å¯„å­˜å™¨ï¼Œè¿›è¡Œé…ç½®æ“ä½œï¼‰ï¼Œåˆ™éœ€è¦å®šä¹‰ enable_regã€enable_maskã€apply_reg ç­‰å‚æ•°çš„ä¿¡æ¯ï¼Œä»¥ä¾¿é€šè¿‡ regmap è¿›è¡Œé…ç½®</p></li><li><p>regulator_ops:<br>è¿™ä¸ªæ•°æ®ç»“æ„æ˜¯æè¿°è°ƒèŠ‚å™¨çš„æ“ä½œå‡½æ•°é›†çš„æ•°æ®ç»“æ„ã€‚å¯¹äº pmic é‡Œçš„æ¯ä¸€ä¸ªè°ƒèŠ‚å™¨éƒ½éœ€è¦æœ‰è‡ªå·±çš„æ“ä½œæ–¹æ³•ï¼Œè¯¥æ•°æ®ç»“æ„æä¾›å¯¹è°ƒèŠ‚å™¨çš„æ“ä½œå‡½æ•°é›†</p></li><li><p>regulator_config:<br>regulator_config ä¿å­˜äº† regulator çš„åŠ¨æ€ä¿¡æ¯ï¼Œæ‰€è°“çš„åŠ¨æ€ä¿¡æ¯ï¼Œæ˜¯æŒ‡é‚£äº›ä¼šåœ¨ driver è¿è¡Œè¿‡ç¨‹ä¸­æ”¹å˜ã€æˆ–è€… driver è¿è¡Œåæ‰ä¼šç¡®å®šçš„ä¿¡æ¯</p></li><li><p>regulation_constraints:<br>è¯¥æ•°æ®ç»“æ„æè¿° regulator device çš„çº¦æŸä¿¡æ¯ï¼ŒåŒ…æ‹¬è¾“å‡ºç”µå‹èŒƒå›´ã€è¾“å‡ºç”µæµèŒƒå›´ã€regulator device æ”¯æŒçš„æ¨¡å¼ï¼ˆfastã€normalã€idleã€standby ç­‰ï¼‰ã€regulator device æ”¯æŒçš„æ“ä½œæ¨¡å¼ï¼ŒåŒ…æ‹¬ change voltã€change currentã€change bypass mode ç­‰ã€regulator device æ”¯æŒçš„ suspend çŠ¶æ€ä¸‹çš„è¾“å‡ºæ§åˆ¶ï¼ˆå¦‚åœ¨ suspend to disk çŠ¶æ€ä¸‹çš„è¾“å‡ºæ§åˆ¶ç­‰ï¼‰</p></li><li><p>regulator:<br>è¯¥æ•°æ®ç»“æ„è¡¨ç¤ºä¸€ä¸ª regulator device çš„ä½¿ç”¨è€…ï¼ŒåŒ…æ‹¬æ˜¯å¦ä¸€ç›´ä½¿èƒ½ã€æ˜¯å¦ä½¿ç”¨ bypass æ¨¡å¼ï¼ˆbypass æ¨¡å¼æŒ‡ regulator device è¾“å…¥ç”µå‹ç›´æ¥ä½œä¸ºè¾“å‡ºï¼Œä¸åšé™åˆ¶ï¼‰ã€ç”µå‹èŒƒå›´ã€ç”µæµå€¼ã€è®¾å¤‡å±æ€§ä¿¡æ¯ã€è¯¥ regulator å¯¹åº”çš„ supply åç§°ç­‰</p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcG1fc3Vic3lzdGVtL3JlZ3VsYXRvcl9kcml2ZXIuaHRtbA==">http://www.wowotech.net/pm_subsystem/regulator_driver.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDcxMjg4MTg/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/107128818?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDcxMjg4NTc/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/107128857?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux å†…æ ¸æ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ RTC</title>
      <link href="/2020/LinuxDriver/LinuxDriverRTC/"/>
      <url>/2020/LinuxDriver/LinuxDriverRTC/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>RTC å’Œç³»ç»Ÿæ—¶é’Ÿæœ‰ä¸åŒçš„ç”¨é€”ã€‚å‰è€…æ˜¯ç¡¬ä»¶æ—¶é’Ÿï¼Œä»¥éæ˜“å¤±æ–¹å¼ç»´æŠ¤ç»å¯¹æ—¶é—´å’Œæ—¥æœŸï¼Œè€Œåè€…æ˜¯å†…æ ¸ç»´æŠ¤çš„è½¯ä»¶æ—¶é’Ÿï¼Œç”¨äºå®ç° gettimeofdayï¼ˆ2ï¼‰å’Œ timeï¼ˆ2ï¼‰ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠåœ¨æ–‡ä»¶ä¸Šè®¾ç½®æ—¶é—´æˆ³ç­‰ã€‚ç³»ç»Ÿæ—¶é’ŸæŠ¥å‘Šä»èµ·ç‚¹å¼€å§‹çš„ç§’å’Œå¾®ç§’ï¼Œèµ·ç‚¹å®šä¹‰ä¸º POSIX çºªå…ƒï¼š1970-01-0100:00ï¼š00 +0000(UTC)ã€‚</p><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>rtc æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDU5MTYwNzkxMjk1NzEwYjZiNjM0">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/RTC_Struct.png"></p><ul><li><p>rtc_deviceï¼š å†…æ ¸ä¸­ä½¿ç”¨ rtc_device ç»“æ„ä½“æ¥æŠ½è±¡ä¸€ä¸ª rtc è®¾å¤‡ï¼Œrtc_device ç»“æ„ä½“å±è”½äº†ä¸åŒ RTC ç¡¬ä»¶ä¹‹é—´çš„å·®å¼‚ï¼Œé€šè¿‡ rtc_class_ops ç»“æ„ä½“ä¸ºä¸Šå±‚æä¾›äº†è®¿é—®ç¡¬ä»¶è®¾å¤‡çš„ç»Ÿä¸€æ¥å£</p></li><li><p>rtc_class_opsï¼š è¯¥ç»“æ„ä½“æä¾›äº†å¯¹åº•å±‚å·®å¼‚çš„æŠ½è±¡ï¼Œrtc_device ç”¨äºæè¿°ä¸€ä¸ª rtc è®¾å¤‡ï¼Œè€Œè®¿é—®è¯¥è®¾å¤‡çš„æ–¹æ³•å¯¹äºä¸åŒçš„è®¾å¤‡æ˜¯ä¸åŒçš„ï¼Œrtc_class_ops ç”¨äºæŠ½è±¡å¯¹ rtc è®¾å¤‡çš„è®¿é—®ï¼Œå¯¹ä¸Šå±è”½äº†åº•å±‚æ“ä½œçš„å·®å¼‚ã€‚ç¼–å†™ä¸€ä¸ª rtc è®¾å¤‡é©±åŠ¨å°±æ˜¯æ„é€ ä¸€ä¸ª rtc_device ç»“æ„ä½“å¹¶æ³¨å†Œè¿›ç³»ç»Ÿï¼Œrtc çš„è®¿é—®æ–¹æ³•å°±æ˜¯ rtc_class_ops ç»“æ„ä½“</p></li><li><p>rtc_timeï¼š è¿™æ˜¯ä¸€ä¸ªæè¿°æ—¶é—´çš„ç»“æ„ä½“</p></li><li><p>rtc_timerï¼š ç”¨äºå¯¹ rtc è®¾å¤‡çš„ç®¡ç†</p></li></ul><h1 id="å®ç°">å®ç°</h1><p>rtc å®ç°çš„æ•´ä½“æ¡†æ¶å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDYxNzMxZWZhZDQyNDNkNDc0MTA2">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/RTC_Framework.png"></p><ul><li>åœ¨ rtc è®¾å¤‡é©±åŠ¨æ¨¡å‹çš„æœ€ä¸Šå±‚ï¼Œé’ˆå¯¹ procfs æ–‡ä»¶ã€sysfs å±æ€§æ–‡ä»¶ã€å­—ç¬¦è®¾å¤‡æ–‡ä»¶ç›¸å…³çš„å¤„ç†æ¥å£ï¼Œåˆ†åˆ«æŠ½è±¡å‡º rtc-dev ç›¸å…³æ¥å£ã€rtc-sysfs ç›¸å…³æ¥å£ã€rtc-procfs ç›¸å…³æ¥å£ï¼Œåˆ†åˆ«å­˜å‚¨åœ¨ rtc-dev.cã€rtc-sysfs.cã€rtc-proc.c è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­ã€‚</li><li>åœ¨ rtc-dev.cã€rtc-sysfs.cã€rtc-proc.c ä¸­å®šä¹‰äº†è¿™ä¸‰ç±»æ–‡ä»¶çš„æ“ä½œæ¥å£ï¼ˆopenã€readã€writeã€closeâ€¦ï¼‰ã€‚</li><li>ä¸Šè¿°ä¸‰ç±»æ–‡ä»¶çš„æ“ä½œæ¥å£ï¼ˆopenã€readã€writeã€closeâ€¦ï¼‰ï¼Œä¼šå€ŸåŠ© rtc interface æ¥å£ï¼Œè°ƒç”¨å„è®¾å¤‡çš„æ“ä½œæ¥å£ï¼Œrtc interface æ¥å£å¯ä»¥ç†è§£ä¸ºè°ƒç”¨è®¾å¤‡é©±åŠ¨çš„æ¡¥æ¢ï¼› é’ˆå¯¹ rtc è®¾å¤‡é©±åŠ¨ï¼Œå‡éœ€è¦å®ç° rtc class ops ä¸­çš„æ–¹æ³•ï¼Œä»¥ä¾¿è¢« rtc ä¸Šå±‚æ¥å£è°ƒç”¨ï¼Œä»è€Œå®Œæˆä¸ rtc è®¾å¤‡çš„é€šä¿¡æ“ä½œã€‚</li><li>åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å£ã€vfs ç›¸å…³æ¥å£ã€è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿçš„ inode çš„æ“ä½œæ¥å£ã€sysfs æ–‡ä»¶ç³»ç»Ÿçš„ inode çš„æ“ä½œæ¥å£ã€procfs æ–‡ä»¶ç³»ç»Ÿçš„ inode çš„æ“ä½œæ¥å£ï¼Œæ–¹æ‰è¿›å…¥ rtc è®¾å¤‡é©±åŠ¨æ¨¡å‹çš„å¤„ç†æ¥å£ä¸­ã€‚</li></ul><p>å®ç°æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDZjYWExZWZhZDQyNDNkNDc0Zjdk">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/rtc_register.png"></p><p>devm_rtc_device_register å‡½æ•°å°±æ˜¯æ³¨å†Œä¸€ä¸ª rtc è®¾å¤‡çš„ apiã€‚æ³¨å†Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>devm_rtc_allocate_device åˆ†é…å¹¶è®¾ç½® rtc_device ç»“æ„ä½“ã€‚</li><li>devm_rtc_register_device æ³¨å†Œ rtc_device ç»“æ„ä½“ã€‚è¿™é‡Œæ˜¯/linux/drivers/rtc/dev.c æ–‡ä»¶é‡Œæä¾›çš„ cdev çš„ file_operations ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å‡½æ•°æŒ‡é’ˆæä¾›äº†å¯¹ interface çš„è®¿é—®ã€‚</li><li>åœ¨/linux/drivers/rtc/interface.c æ–‡ä»¶é‡Œå‘ä¸Šä¸º/linux/drivers/rtc/dev.c æä¾›æ¥å£ï¼Œå‘ä¸‹æä¾›è®¿é—® rtc_class_ops çš„æ¥å£ã€‚</li><li>rtc_class_ops ç”±å…·ä½“çš„ rtc è®¾å¤‡åœ¨æ³¨å†Œçš„æ—¶å€™æä¾›ã€‚</li></ul><h1 id="sysfs-æ¥å£">sysfs æ¥å£</h1><p>åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œä»ç”¨æˆ·ç©ºé—´æ­£ç¡®ç®¡ç† RTC éœ€è¦å…³æ³¨ä¸¤ä¸ªå†…æ ¸é€‰é¡¹ã€‚è¿™ä¸¤ä¸ªé€‰é¡¹æ˜¯ CONFIG_RTC_HCTOSYS å’Œ CONFIG_RTC_HCTOSYS_DEVICEã€‚ è¦ä½¿ç”¨ CONFIG_RTC_HCTOSYS åº”åœ¨å†…æ ¸æ„å»ºè¿‡ç¨‹ä¸­åŒ…å«ä»£ç æ–‡ä»¶ driversrtc/hctosys.cï¼Œå®ƒåœ¨å¯åŠ¨å’Œæ¢å¤æ—¶ä» RTC è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€‚ä¸€æ—¦å¯ç”¨æ­¤é€‰é¡¹ï¼Œå°±å°†ä½¿ç”¨ä»æŒ‡å®š RTC è®¾å¤‡è¯»å–çš„å€¼è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€‚RTC è®¾å¤‡åº”è¯¥åœ¨ CONFIG_RTC_HCTOSYSDEVICE ä¸­æŒ‡å®šï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_RTC_HCTOSYS=y</span><br><span class="line">CONFIG_RTC_HCTOSYS_DEVICE=<span class="string">"rtcO"</span></span><br></pre></td></tr></tbody></table></figure><p>è´Ÿè´£åœ¨ sysfs ä¸­å®ä¾‹åŒ– RTC å±æ€§çš„å†…æ ¸ä»£ç åœ¨å†…æ ¸æºç æ ‘çš„ drivers/rtc/rtc_sysfs.c ä¸­å®šä¹‰ã€‚ä¸€æ—¦æ³¨å†Œï¼ŒRTC è®¾å¤‡å°±å°†åœ¨/sys/class/rtc ä¸‹åˆ›å»º rtc<id> ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«ä¸€ç»„åªè¯»å±æ€§ï¼Œå…¶ä¸­é‡è¦çš„å±æ€§å¦‚ä¸‹ã€‚</id></p><ul><li><p>date: è¯¥æ–‡ä»¶æ‰“å° RTC æ¥å£çš„å½“å‰æ—¥æœŸï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/rtc/rtc0/date</span><br><span class="line">2017-8-28</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>time: æ‰“å°æ­¤ RTC çš„å½“å‰æ—¶é—´ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/rtc/rtc0/time</span><br><span class="line">14:54:20</span><br></pre></td></tr></tbody></table></figure><p></p></li><li>hctosys: è¯¥å±æ€§æŒ‡å‡º RTC è®¾å¤‡æ˜¯å¦æ˜¯ CONFIG_RTC_HCTOSYS_DEVICE ä¸­æŒ‡å®šçš„è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯åŠ¨å’Œæ¢å¤æ—¶æ˜¯å¦ä½¿ç”¨è¯¥ RTC è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€‚å…¶å€¼ä¸º 1 è¡¨ç¤ºçœŸï¼Œ0 è¡¨ç¤ºå‡ï¼š<br><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/rtc/rtc0/hctosys</span><br><span class="line">1</span><br></pre></td></tr></tbody></table></figure></li><li><p>dev: æ­¤å±æ€§æ˜¾ç¤ºè®¾å¤‡çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚æ•°æ®æ ¼å¼ä¸ºä¸»è®¾å¤‡å·ï¼šæ¬¡è®¾å¤‡å·ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/rtc/rtc0/dev</span><br><span class="line">251:0</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>since_epoch: è¯¥å±æ€§å°†æ˜¾ç¤ºä» UNIX çºªå…ƒï¼ˆè‡ª 1970 å¹´ 1 æœˆ 1 æ—¥èµ·ï¼‰ä»¥æ¥çš„ç§’æ•°ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/rtc/rtc0/since epoch</span><br><span class="line">1503931738</span><br></pre></td></tr></tbody></table></figure><p></p></li></ul><h1 id="hwclock-å·¥å…·">hwclock å·¥å…·</h1><p>ç¡¬ä»¶æ—¶é’Ÿï¼ˆhwclockï¼‰å·¥å…·ç”¨äºè®¿é—® RTC è®¾å¤‡ã€‚man hwclock å‘½ä»¤å¯èƒ½æ¯”æœ¬èŠ‚è®¨è®ºçš„æ‰€æœ‰å†…å®¹éƒ½æ›´æœ‰æ„ä¹‰ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä¸‹é¢è¿˜æ˜¯ç¼–å†™ä¸€äº›å‘½ä»¤ï¼Œä»¥ä»ç³»ç»Ÿæ—¶é’Ÿè®¾ç½® hwclockRTC:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ntpd -q              <span class="comment">#ç¡®ä¿ç³»ç»Ÿæ—¶é’Ÿæ˜¯ä»ç½‘ç»œæ—¶é—´è®¾ç½®çš„</span></span><br><span class="line">$ sudo hwclock --systohc    <span class="comment">#ä»ç³»ç»Ÿæ—¶é’Ÿè®¾ç½® RTC</span></span><br><span class="line">$ sudo hwclock --show       <span class="comment">#è®¾ç½® RTC</span></span><br><span class="line">Sat May 17 17:36:50 2017 -0.671045 seconds</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢çš„ä¾‹å­å‡å®šä¸»æœºå…·æœ‰ç½‘ç»œè¿æ¥ï¼Œå¯ä»¥è®¿é—® NTP æœåŠ¡å™¨ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¾ç½®ç³»ç»Ÿæ—¶é—´ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">date</span> -s <span class="string">'2017-08-28 17:14:00'</span>+s<span class="string">' #æ‰‹åŠ¨è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ</span></span><br><span class="line"><span class="string">$ sudo hwclock ä¸€ systohc                #åœ¨ç³»ç»Ÿæ—¶é—´ä¸ŠåŒæ­¥ RTC èŠ¯ç‰‡</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰ç»™å‡ºå‚æ•°ï¼Œhwclock å‡å®š RTC è®¾å¤‡æ–‡ä»¶æ˜¯/dev/rtcï¼Œå®ƒå®é™…ä¸Šæ˜¯çœŸæ­£ RTC è®¾å¤‡çš„ç¬¦å·é“¾æ¥ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /dev/rtc</span><br><span class="line">lrwxrwxrwx 1 root root 4 aout 27 17:50 /dev/rtc -&gt; rtc0</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vMDUzMTc5aHUvcC8xNDEzMDMwMC5odG1s">https://www.cnblogs.com/053179hu/p/14130300.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDM4NDE5NDE/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/103841941?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ CCF å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverCCF/"/>
      <url>/2020/LinuxDriver/LinuxDriverCCF/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>CCF ä¸»è¦ç”¨äºç³»ç»Ÿ clock çš„ç®¡ç†ç­‰æ“ä½œã€‚clk çš„ç§ç±»è¯´æ˜ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/clk_type.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ—¶é’Ÿæºå¤§æ¦‚å¯åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>æä¾›åŸºç¡€æ—¶é’Ÿæºçš„æ™¶æŒ¯ï¼ˆå¯åˆ†ä¸ºæœ‰æºæ™¶æŒ¯ã€æ— æºæ™¶æŒ¯ä¸¤ç§ï¼‰</li><li>ç”¨äºå€é¢‘çš„é”ç›¸ç¯</li><li>ç”¨äºåˆ†é¢‘çš„ divider</li><li>ç”¨äºå¤šè·¯æ—¶é’Ÿæºé€‰æ‹©çš„ mux</li><li>ç”¨äºæ—¶é’Ÿä½¿èƒ½çš„ä¸é—¨ç”µè·¯ç­‰</li></ul><p>è€Œåœ¨ CCF å­ç³»ç»Ÿçš„æŠ½è±¡ä¸­ï¼Œè¿™äº”ç§å‡æŠ½è±¡ä¸º clkï¼Œä½†æ˜¯é’ˆå¯¹è¿™ 5 ç§ç±»å‹çš„æ—¶é’Ÿä¹Ÿæä¾›äº†å•ç‹¬çš„æ—¶é’Ÿæ³¨å†Œå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯å¯¹ clk_register å‡½æ•°çš„å°è£…ï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„æ—¶é’Ÿç±»å‹å®šä¹‰äº†ä¸åŒçš„ç»“æ„ä½“ï¼‰ã€‚</p><p>åœ¨ CCF å­ç³»ç»Ÿä¸­ï¼Œé’ˆå¯¹ç¡¬ä»¶æ—¶é’Ÿçš„æ“ä½œæ¥å£ï¼Œä¹ŸæŠ½è±¡äº†å¯¹åº”çš„ç»“æ„ä½“ struct clk_opsï¼ŒåŒ…å«æ—¶é’Ÿçš„ä½¿èƒ½æ¥å£ã€æ—¶é’Ÿé¢‘ç‡çš„ä¿®æ”¹æ¥å£ç­‰ç­‰ã€‚è€Œé’ˆå¯¹ä¸Šè¿°æ‰€è¯´çš„ä¸åŒç§ç±»çš„æ—¶é’Ÿæºï¼Œå…¶å¹¶ä¸éœ€è¦å®ç°æ‰€æœ‰ struct clk_ops ä¸­å®šä¹‰çš„æ¥å£ã€‚é’ˆå¯¹â€œæ—¶é’Ÿä½¿èƒ½çš„ä¸é—¨ç”µè·¯â€è€Œè¨€ï¼Œä»…éœ€è¦å®ç° enabelã€disableã€is_enable æ¥å£å³å¯ï¼›é’ˆå¯¹å¤šè·¯æ—¶é’Ÿæºé€‰æ‹©çš„ mux è€Œè¨€ï¼Œåˆ™éœ€è¦å®ç°çˆ¶æ—¶é’Ÿæºçš„è®¾ç½®åŠè·å–çš„æ¥å£ set_parentã€get_parent ç­‰ï¼›å¯¹äºå€é¢‘ã€åˆ†é¢‘è€Œè¨€ï¼Œåˆ™éœ€è¦å®ç°æ—¶é’Ÿé¢‘ç‡ç›¸å…³çš„æ¥å£ set_rateã€recalc_rate ç­‰ã€‚</p><span id="more"></span><h1 id="apiconsumer">APIï¼ˆconsumerï¼‰</h1><h2 id="clock-è·å–æœ‰å…³çš„-api">clock è·å–æœ‰å…³çš„ API</h2><ul><li>ä»¥ device æŒ‡é’ˆæˆ–è€… id å­—ç¬¦ä¸²ï¼ˆå¯ä»¥çœ‹ä½œ nameï¼‰ä¸ºå‚æ•°ï¼ŒæŸ¥æ‰¾ clockã€‚devm_clk_get ä½¿ç”¨äº† device resource managementï¼Œå¯ä»¥è‡ªåŠ¨é‡Šæ”¾</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_get</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *id)</span>;</span><br><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">devm_clk_get</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *id)</span>;</span><br></pre></td></tr></tbody></table></figure><pre><code>dev å’Œ id çš„ä»»æ„ä¸€ä¸ªå¯ä»¥ä¸ºç©ºã€‚å¦‚æœ id ä¸ºç©ºï¼Œåˆ™å¿…é¡»æœ‰ device tree çš„æ”¯æŒæ‰èƒ½è·å¾— device å¯¹åº”çš„ clkï¼›æ ¹æ®å…·ä½“çš„å¹³å°å®ç°ï¼Œid å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„åç§°ï¼Œä¹Ÿå¯ä»¥ æ˜¯ä¸€ä¸ªé¢„å…ˆå®šä¹‰çš„ã€å”¯ä¸€çš„æ ‡è¯†ï¼ˆä¸€èˆ¬åœ¨å¹³å°æä¾›çš„å¤´æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¦‚ mach/clk.hï¼‰ï¼›ä¸å¯ä»¥åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡è°ƒç”¨</code></pre><ul><li>get çš„åå‘æ“ä½œï¼Œä¸€èˆ¬å’Œå¯¹åº”çš„ get API æˆå¯¹è°ƒç”¨</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">clk_put</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">devm_clk_put</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> clk *clk)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>ä½¿ç”¨ device çš„ name æŸ¥æ‰¾ clock</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_get_sys</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *dev_id, <span class="type">const</span> <span class="type">char</span> *con_id)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>device tree ç›¸å…³çš„æ¥å£ï¼Œç›´æ¥ä»ç›¸åº”çš„ DTS node ä¸­ï¼Œä»¥ indexã€name ç­‰ä¸ºç´¢å¼•ï¼Œè·å– clk</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">of_clk_get</span><span class="params">(<span class="keyword">struct</span> device_node *np, <span class="type">int</span> index)</span>;</span><br><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">of_clk_get_by_name</span><span class="params">(<span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">of_clk_get_from_provider</span><span class="params">(<span class="keyword">struct</span> of_phandle_args *clkspec)</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="clock-æ§åˆ¶æœ‰å…³çš„-api">clock æ§åˆ¶æœ‰å…³çš„ API</h2><ul><li>å¯åŠ¨/åœæ­¢ clockã€‚ä¸ä¼šç¡çœ </li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">clk_enable</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clk_disable</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>å¯åŠ¨ clock å‰çš„å‡†å¤‡å·¥ä½œ/åœæ­¢ clock åçš„å–„åå·¥ä½œ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">clk_prepare</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">clk_unprepare</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>clock é¢‘ç‡çš„è·å–å’Œè®¾ç½®ï¼Œå…¶ä¸­ clk_set_rate å¯èƒ½ä¼šä¸æˆåŠŸï¼ˆä¾‹å¦‚æ²¡æœ‰å¯¹åº”çš„åˆ†é¢‘æ¯”ï¼‰ï¼Œæ­¤æ—¶ä¼šè¿”å›é”™è¯¯ã€‚å¦‚æœè¦ç¡®ä¿è®¾ç½®æˆåŠŸï¼Œåˆ™éœ€è¦å…ˆè°ƒç”¨ clk_round_rate æ¥å£ï¼Œå¾—åˆ°å’Œéœ€è¦è®¾ç½®çš„ rate æ¯”è¾ƒæ¥è¿‘çš„é‚£ä¸ªå€¼</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">clk_get_rate</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">clk_set_rate</span><span class="params">(<span class="keyword">struct</span> clk *clk, <span class="type">unsigned</span> <span class="type">long</span> rate)</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">clk_round_rate</span><span class="params">(<span class="keyword">struct</span> clk *clk, <span class="type">unsigned</span> <span class="type">long</span> rate)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>è·å–/é€‰æ‹© clock çš„ parent clock</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_get_parent</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">clk_set_parent</span><span class="params">(<span class="keyword">struct</span> clk *clk, <span class="keyword">struct</span> clk *parent)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>å°† clk_prepare å’Œ clk_enable ç»„åˆèµ·æ¥ï¼Œä¸€èµ·è°ƒç”¨</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">clk_prepare_enable</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span></span><br></pre></td></tr></tbody></table></figure><ul><li>å°† clk_disable å’Œ clk_unprepare ç»„åˆèµ·æ¥ï¼Œä¸€èµ·è°ƒç”¨</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">clk_disable_unprepare</span><span class="params">(<span class="keyword">struct</span> clk *clk)</span></span><br></pre></td></tr></tbody></table></figure><p><strong>prepare/unprepareï¼Œenable/disable çš„è¯´æ˜</strong></p><p>è¿™ä¸¤å¥— API çš„æœ¬è´¨ï¼Œæ˜¯æŠŠ clock çš„å¯åŠ¨/åœæ­¢åˆ†ä¸º atomic å’Œ non-atomic ä¸¤ä¸ªé˜¶æ®µï¼Œä»¥æ–¹ä¾¿å®ç°å’Œè°ƒç”¨ã€‚å› æ­¤ä¸Šé¢æ‰€è¯´çš„â€œä¸ä¼šç¡çœ /å¯èƒ½ä¼šç¡çœ â€ï¼Œæœ‰ä¸¤ä¸ªè§’åº¦çš„å«ä¹‰ï¼šä¸€æ˜¯å‘Šè¯‰åº•å±‚çš„ clock driverï¼Œè¯·æŠŠå¯èƒ½å¼•èµ·ç¡çœ çš„æ“ä½œï¼Œæ”¾åˆ° prepare/unprepare ä¸­å®ç°ï¼Œä¸€å®šä¸èƒ½æ”¾åˆ° enable/disable ä¸­ï¼›äºŒæ˜¯æé†’ä¸Šå±‚ä½¿ç”¨ clock çš„ driverï¼Œè°ƒç”¨ prepare/unprepare æ¥å£æ—¶å¯èƒ½ä¼šç¡çœ å“¦ï¼Œåƒä¸‡ä¸èƒ½åœ¨ atomic ä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚ä¸­æ–­å¤„ç†ä¸­ï¼‰è°ƒç”¨å“¦ï¼Œè€Œè°ƒç”¨ enable/disable æ¥å£åˆ™å¯æ”¾å¿ƒã€‚</p><p>å¦å¤–ï¼Œclock çš„å¼€å…³ä¸ºä»€ä¹ˆéœ€è¦ç¡çœ å‘¢ï¼Ÿè¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œä¾‹å¦‚ enable PLL clkï¼Œåœ¨å¯åŠ¨ PLL åï¼Œéœ€è¦ç­‰å¾…å®ƒç¨³å®šã€‚è€Œ PLL çš„ç¨³å®šæ—¶é—´æ˜¯å¾ˆé•¿çš„ï¼Œè¿™æ®µæ—¶é—´è¦æŠŠ CPU äº¤å‡ºï¼ˆè¿›ç¨‹ç¡çœ ï¼‰ï¼Œä¸ç„¶å°±ä¼šæµªè´¹ CPUã€‚</p><p>æœ€åï¼Œä¸ºä»€ä¹ˆä¼šæœ‰åˆåœ¨ä¸€èµ·çš„ clk_prepare_enable/clk_disable_unprepare æ¥å£å‘¢ï¼Ÿå¦‚æœè°ƒç”¨è€…èƒ½ç¡®ä¿æ˜¯åœ¨ non-atomic ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œå°±å¯ä»¥é¡ºåºè°ƒç”¨ prepare/enableã€disable/unpreparedï¼Œä¸ºäº†ç®€å•ï¼Œframework å°±å¸®å¿™å°è£…äº†è¿™ä¸¤ä¸ªæ¥å£ã€‚</p><h2 id="å…¶å®ƒæ¥å£">å…¶å®ƒæ¥å£</h2><ul><li>æ³¨å†Œ/æ³¨é”€ clock rate æ”¹å˜çš„é€šçŸ¥ã€‚ä¾‹å¦‚æŸä¸ª driver å…³å¿ƒæŸä¸ª clockï¼ŒæœŸæœ›è¿™ä¸ª clock çš„ rate æ”¹å˜æ—¶ï¼Œé€šçŸ¥åˆ°è‡ªå·±ï¼Œå°±å¯ä»¥æ³¨å†Œä¸€ä¸ª notify <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">clk_notifier_register</span><span class="params">(<span class="keyword">struct</span> clk *clk, <span class="keyword">struct</span> notifier_block *nb)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">clk_notifier_unregister</span><span class="params">(<span class="keyword">struct</span> clk *clk, <span class="keyword">struct</span> notifier_block *nb)</span>;</span><br></pre></td></tr></tbody></table></figure></li></ul><h2 id="é€šç”¨-api-çš„ä½¿ç”¨è¯´æ˜">é€šç”¨ API çš„ä½¿ç”¨è¯´æ˜</h2><ul><li><p>é¦–å…ˆï¼Œåœ¨ DTSï¼ˆdevice tree sourceï¼‰ä¸­ï¼ŒæŒ‡å®š device éœ€è¦ä½¿ç”¨çš„ clockï¼Œå¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* DTS */</span><br><span class="line">device {</span><br><span class="line">    clocks = &lt;&amp;osc 1&gt;, &lt;&amp;ref 0&gt;;</span><br><span class="line">    clock-names = "baud", "register";</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>è¯¥ DTS çš„å«ä¹‰æ˜¯ï¼š</p><p>device éœ€è¦ä½¿ç”¨ä¸¤ä¸ª clockï¼Œâ€œbaudâ€å’Œâ€œregitserâ€ï¼Œç”± clock-names å…³é”®å­—æŒ‡å®šï¼›</p><p>baud å–è‡ªâ€œoscâ€çš„è¾“å‡º 1ï¼Œregister å–è‡ªâ€œrefâ€çš„è¾“å‡º 0ï¼Œç”± clocks å…³é”®å­—æŒ‡å®šã€‚</p></li><li><p>ç³»ç»Ÿå¯åŠ¨åï¼Œdevice tree ä¼šè§£æ clock æœ‰å…³çš„å…³é”®å­—ï¼Œå¹¶å°†è§£æåçš„ä¿¡æ¯æ”¾åœ¨ platform_device ç›¸å…³çš„å­—æ®µä¸­</p></li><li><p>å…·ä½“çš„ driver å¯ä»¥åœ¨ probe æ—¶ï¼Œä»¥ clock çš„åç§°ï¼ˆä¸æä¾›ä¹Ÿè¡Œï¼‰ä¸ºå‚æ•°ï¼Œè°ƒç”¨ clk get æ¥å£ï¼Œè·å– clock çš„å¥æŸ„ï¼Œç„¶ååˆ©ç”¨è¯¥å¥æŸ„ï¼Œå¯ç›´æ¥è¿›è¡Œ enableã€set rate ç­‰æ“ä½œï¼Œå¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* driver */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">xxx_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">baud_clk</span>;</span></span><br><span class="line">    <span class="type">int</span> ret; </span><br><span class="line"></span><br><span class="line">    baud_clk = devm_clk_get(&amp;pdev-&gt;dev, â€œbaudâ€);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(clk)) {</span><br><span class="line">            â€¦</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    ret = clk_prepare_enable(baud_clk);</span><br><span class="line">    <span class="keyword">if</span> (ret) {</span><br><span class="line">            â€¦</span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="æ•°æ®ç»“æ„provider">æ•°æ®ç»“æ„ï¼ˆproviderï¼‰</h1><p>CCF å®ç°çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDEyYzgwNzkxMjk1NzEwYjY2NzQ4">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/CCF_Struct.png"></p><ul><li><p>clk_hwï¼š ä¸ºç¡¬ä»¶æ—¶é’Ÿæºçš„é€»è¾‘æŠ½è±¡å¯ä»¥ç†è§£ä¸º clk provider</p></li><li><p>clk_coreï¼š å¯ä»¥ç†è§£ä¸º clk provider çš„ driverï¼ŒåŒ…å«äº† clk provider çš„è®¿é—®æ–¹æ³•ã€æ—¶é’Ÿé¢‘ç‡è®¾å®šã€æ”¯æŒçš„æ—¶é’Ÿé¢‘ç‡ã€çˆ¶æ—¶é’Ÿæºçš„ä¸ªæ•°ä»¥åŠçˆ¶æ—¶é’Ÿæºçš„åç§°ç­‰å†…å®¹</p></li><li><p>clkï¼š å¯ä»¥ç†è§£ clk consumerï¼ŒåŒ…å«äº†æŒ‡å‘ clk provider çš„æŒ‡é’ˆã€ä½¿ç”¨è€…çš„è®¾å¤‡åç§°ã€ä½¿ç”¨è€…æ‰€å®šä¹‰çš„æ—¶é’Ÿåˆ«åï¼ˆcon_idï¼‰</p></li><li><p>clk_opsï¼š ä¸»è¦æ˜¯ clk provider çš„æ“ä½œæ¥å£ï¼ŒåŒ…å« prepare ä¸ unprepare æ“ä½œæ¥å£ï¼ˆè¿™ä¸¤ä¸ªæ¥å£æ‰§è¡Œæ—¶å…è®¸ sleepï¼Œä¸»è¦æ˜¯ç”¨çš„äº’æ–¥é”ï¼‰ã€enable ä¸ disable æ¥å£ï¼ˆè¿™ä¸¤ä¸ªæ¥å£æ‰§è¡Œæ—¶ä¸å…è®¸ sleepï¼Œé‡Œé¢ä½¿ç”¨äº†è‡ªæ—‹é”ï¼‰ï¼Œä¹ŸåŒ…å«äº†é€Ÿç‡è®¾ç½®æ¥å£ã€é‡æ–°è®¡ç®—é€Ÿç‡æ¥å£ã€parent è®¾ç½®ä¸è·å–æ¥å£ç­‰ç­‰ï¼Œé€šè¿‡è¿™äº›æ¥å£å¯å®ç°æ—¶é’Ÿé¢‘ç‡çš„ä¿®æ”¹ã€çˆ¶æ—¶é’Ÿæºçš„é€‰æ‹©ã€æ—¶é’Ÿçš„ä½¿èƒ½ä¸å¦ç­‰åŠŸèƒ½</p></li><li><p>clk_init_dataï¼š æè¿°è¯¥ clock çš„é™æ€æ•°æ®ï¼Œclock provider è´Ÿè´£æŠŠç³»ç»Ÿä¸­æ¯ä¸ª clock çš„é™æ€æ•°æ®å‡†å¤‡å¥½ï¼Œç„¶åäº¤ç»™ clock framework çš„æ ¸å¿ƒé€»è¾‘ï¼Œå‰©ä¸‹çš„äº‹æƒ…ï¼Œclock provider å°±ä¸ç”¨æ“å¿ƒäº†ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯ clock driver çš„ç¼–å†™è¿‡ç¨‹</p></li></ul><p>ccf çš„é©±åŠ¨æ¡†æ¶ä¹Ÿæ˜¯ä¸è®¾å¤‡é©±åŠ¨æ¨¡å‹ç±»ä¼¼çš„ç»“æ„ï¼Œclk_core ç”¨äºæŠ½è±¡è®¾å¤‡æ ‘é©±åŠ¨çš„æ–¹æ³•ç±»ä¼¼äº device_driver è€Œ clk åˆ™æ›´åƒæ˜¯ä¸€ä¸ª deviceï¼Œåœ¨ soc å†…éƒ¨æœ‰å¾ˆå¤šæ§åˆ¶å™¨ï¼Œè¿™äº›æ§åˆ¶å™¨éƒ½æŒ‚è½½åœ¨æ—¶é’Ÿæ ‘ä¸‹é¢ï¼Œè¿™äº›æ§åˆ¶å™¨å°±æ˜¯ consumerï¼Œä»–ä»¬ä¼šç”¨åˆ° clk æ•°æ®ç»“æ„ç”¨äºä½¿èƒ½å¤±èƒ½æ—¶é’Ÿï¼Œä»¥åŠè®¾ç½®æ—¶é’Ÿé¢‘ç‡ç­‰æ“ä½œã€‚è€Œ clk_core ç»“æ„ä½“åˆ™æŠ½è±¡äº†æ—¶é’Ÿæ ‘ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ç»„ç»‡æˆæ ‘çŠ¶ç»“æ„æ¥æè¿°æ•´ä¸ªæ—¶é’Ÿæ ‘ã€‚ä¸‹é¢çœ‹ä¸‹ clk_core åœ¨å†…æ ¸ä¸­çš„ç»„ç»‡å…³ç³»ç»“æ„å›¾ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDI0NjYxZTA4NTMzYTAzMDJmZWRh">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/CLK_Core_List.png"></p><h1 id="å®ç°">å®ç°</h1><h2 id="clock-åˆ†ç±»åŠ-register">clock åˆ†ç±»åŠ register</h2><p>æ ¹æ® clock çš„ç‰¹ç‚¹ï¼Œclock framework å°† clock åˆ†ä¸º fixed rateã€gateã€deviderã€muxã€fixed factorã€composite å…­ç±»ï¼Œæ¯ä¸€ç±» clock éƒ½æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ã€ç›¸ä¼¼çš„æ§åˆ¶æ–¹å¼ï¼Œå› è€Œå¯ä»¥ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ sï¼Œç»Ÿä¸€å¤„ç†ï¼Œè¿™å……åˆ†ä½“ç°äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ã€‚</p><ul><li>fixed rate clocï¼š è¿™ä¸€ç±» clock å…·æœ‰å›ºå®šçš„é¢‘ç‡ï¼Œä¸èƒ½å¼€å…³ã€ä¸èƒ½è°ƒæ•´é¢‘ç‡ã€ä¸èƒ½é€‰æ‹© parentã€ä¸éœ€è¦æä¾›ä»»ä½•çš„ clk_ops å›è°ƒå‡½æ•°ï¼Œæ˜¯æœ€ç®€å•çš„ä¸€ç±» clockã€‚ å¯ä»¥ç›´æ¥é€šè¿‡ DTS é…ç½®çš„æ–¹å¼æ”¯æŒï¼Œclock framework core èƒ½ç›´æ¥ä» DTS ä¸­è§£å‡º clock ä¿¡æ¯ï¼Œå¹¶è‡ªåŠ¨æ³¨å†Œåˆ° kernelï¼Œä¸éœ€è¦ä»»ä½• driver æ”¯æŒã€‚ clock framework ä½¿ç”¨ struct clk_fixed_rate ç»“æ„æŠ½è±¡è¿™ä¸€ç±» clockï¼Œå¦å¤–æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥ç›´æ¥æ³¨å†Œ fixed rate clockï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clk_fixed_rate</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span><span class="title">clk_hw</span> <span class="title">hw</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>fixed_rate;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>fixed_accuracy;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>flags;</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_register_fixed_rate</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *parent_name, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> fixed_rate)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>gate clock<br>è¿™ä¸€ç±» clock åªå¯å¼€å…³ï¼ˆä¼šæä¾›ã€‚enable/.disable å›è°ƒï¼‰ï¼Œå¯ä½¿ç”¨ä¸‹é¢æ¥å£æ³¨å†Œï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_register_gate</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *parent_name, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params"><span class="type">void</span> __iomem *reg, u8 bit_idx,</span></span><br><span class="line"><span class="params">u8 clk_gate_flags, <span class="type">spinlock_t</span> *lock)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>divider clock<br>è¿™ä¸€ç±» clock å¯ä»¥è®¾ç½®åˆ†é¢‘å€¼ï¼ˆå› è€Œä¼šæä¾›ã€‚recalc_rate/.set_rate/.round_rate å›è°ƒï¼‰ï¼Œå¯é€šè¿‡ä¸‹é¢ä¸¤ä¸ªæ¥å£æ³¨å†Œï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> clk_register_divider(dev, name, parent_name, flags, reg, shift, width, \</span></span><br><span class="line"><span class="meta">     clk_divider_flags, lock)       \</span></span><br><span class="line"><span class="meta">clk_register_divider_table((dev), (name), (parent_name), (flags),      \</span></span><br><span class="line"><span class="meta">   (reg), (shift), (width),       \</span></span><br><span class="line"><span class="meta">   (clk_divider_flags), NULL, (lock))</span></span><br></pre></td></tr></tbody></table></figure><ul><li>mux clock<br>è¿™ä¸€ç±» clock å¯ä»¥é€‰æ‹©å¤šä¸ª parentï¼Œå› ä¸ºä¼šå®ç°ã€‚get_parent/.set_parent/.recalc_rate å›è°ƒï¼Œå¯é€šè¿‡ä¸‹é¢ä¸¤ä¸ªæ¥å£æ³¨å†Œï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> clk_register_mux(dev, name, parent_names, num_parents, flags, reg,    \</span></span><br><span class="line"><span class="meta"> shift, width, clk_mux_flags, lock)      \</span></span><br><span class="line"><span class="meta">clk_register_mux_table((dev), (name), (parent_names), (num_parents),  \</span></span><br><span class="line"><span class="meta">       (flags), (reg), (shift), BIT((width)) - 1,     \</span></span><br><span class="line"><span class="meta">       (clk_mux_flags), NULL, (lock))</span></span><br></pre></td></tr></tbody></table></figure><ul><li>fixed factor clock<br>è¿™ä¸€ç±» clock å…·æœ‰å›ºå®šçš„ factorï¼ˆå³ multiplier å’Œ dividerï¼‰ï¼Œclock çš„é¢‘ç‡æ˜¯ç”± parent clock çš„é¢‘ç‡ï¼Œä¹˜ä»¥ mulï¼Œé™¤ä»¥ divï¼Œå¤šç”¨äºä¸€äº›å…·æœ‰å›ºå®šåˆ†é¢‘ç³»æ•°çš„ clockã€‚ç”±äº parent clock çš„é¢‘ç‡å¯ä»¥æ”¹å˜ï¼Œå› è€Œ fix factor clock ä¹Ÿå¯è¯¥æ”¹å˜é¢‘ç‡ï¼Œå› æ­¤ä¹Ÿä¼šæä¾›ã€‚recalc_rate/.set_rate/.round_rate ç­‰å›è°ƒã€‚</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_register_fixed_factor</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *parent_name, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> mult, <span class="type">unsigned</span> <span class="type">int</span> div)</span>;</span><br></pre></td></tr></tbody></table></figure><ul><li>composite clock<br>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ muxã€dividerã€gate ç­‰ clock çš„ç»„åˆï¼Œå¯é€šè¿‡ä¸‹é¢æ¥å£æ³¨å†Œï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> clk *<span class="title function_">clk_register_composite</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> *parent_names, <span class="type">int</span> num_parents,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> clk_hw *mux_hw, <span class="type">const</span> <span class="keyword">struct</span> clk_ops *mux_ops,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> clk_hw *rate_hw, <span class="type">const</span> <span class="keyword">struct</span> clk_ops *rate_ops,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> clk_hw *gate_hw, <span class="type">const</span> <span class="keyword">struct</span> clk_ops *gate_ops,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> flags)</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸Šé¢è¿™äº›æ³¨å†Œæ¥å£çš„å®ç°é€»è¾‘">ä¸Šé¢è¿™äº›æ³¨å†Œæ¥å£çš„å®ç°é€»è¾‘</h2><p>clk æ³¨å†Œæµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDNiNWE1NjUzYmI2NzkxZTRhZWZh">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/clk_register.png"></p><p>é©±åŠ¨é’ˆå¯¹ä¸åŒç±»å‹çš„ clock èŠ‚ç‚¹æä¾›äº†å‡ ç§ä¸åŒçš„æ³¨å†Œå‡½æ•°ï¼Œé©±åŠ¨å¼€å‘äººå‘˜ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±ç¼–å†™å¯¹åº”çš„é©±åŠ¨è€Œæ˜¯å°½å¯èƒ½è°ƒç”¨ç³»ç»Ÿæä¾›çš„æ¥å£ï¼Œè€Œå¯¹äºç³»ç»Ÿè€Œè¨€ä¹Ÿæ˜¯å°½å¯èƒ½çš„å¤ç”¨å‡½æ•°ï¼Œè¿™äº›æ³¨å†Œå‡½æ•°éƒ½æ˜¯é€šè¿‡è°ƒç”¨ clk_hw_register å‡½æ•°æ¥å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ª map æ˜ å°„æ²¡æœ‰æ¶‰åŠï¼Œccf å­ç³»ç»Ÿæä¾›äº† clk provider çš„ mapï¼Œè¿™ç§ map æœºåˆ¶å¯ä»¥ç†è§£ä¸ºå®šä¹‰äº† clk consumer ä¸ clk_provider çš„æ˜ å°„å…³ç³»ï¼Œå³è¯¥ clk provider å¯ä»¥ç»™å“ªäº› clk consumer æä¾›æ—¶é’Ÿï¼ˆå¦‚é’ˆå¯¹éè®¾å¤‡æ ‘æ¨¡å¼ï¼Œåˆ™å®šä¹‰äº† clk consumer çš„è®¾å¤‡åç§°ã€clk consumer çš„æ—¶é’Ÿä½¿ç”¨åç§°ï¼‰ã€‚</p><h2 id="ç³»ç»Ÿå¯åŠ¨é˜¶æ®µå¯¹è®¾å¤‡æ ‘çš„å¤„ç†">ç³»ç»Ÿå¯åŠ¨é˜¶æ®µå¯¹è®¾å¤‡æ ‘çš„å¤„ç†</h2><p>clk åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1ZDQwYmZlNDAxZmQ2YmUwN2YyZGRl">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/clk_init.png"></p><p>ä¸Šé¢ä»‹ç»äº† clk çš„æ³¨å†Œæµç¨‹ï¼Œåœ¨ä¸Šå›¾ä¸­å±•ç¤ºäº†ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè§£æè®¾å¤‡æ ‘æŒ‰ç…§é»˜è®¤é…ç½®æ¥è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿæ ‘çš„æµç¨‹ï¼Œä¸‹é¢ç»™å‡ºè¯¦ç»†è¯´æ˜ï¼š</p><ul><li>é€šå¸¸åœ¨ Clock é©±åŠ¨ä¸­ä¼šæœ‰ä¸€ä¸ª CLK_OF_DECLARE å®ï¼Œè¯¥å®ç”¨äºå£°æ˜ä¸€ä¸ª struct of_device_id æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”æœ€ç»ˆåœ¨é“¾æ¥çš„æ—¶å€™ä¼šå°†æ•°æ®ç»“æ„é“¾æ¥åœ¨ä¸€ä¸ªå«åš__of_clk_table çš„æ®µä¸­ï¼Œè¿™ä¸ªæ®µçš„å®šä¹‰ä½äº vmlinux.lds.h æ–‡ä»¶ä¸­ã€‚</li><li>åœ¨å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° of_clk_init å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šå»è®¿é—®__of_clk_table æ®µä¸­çš„å†…å®¹ï¼Œç”±äºæ­¤æ—¶å†…æ ¸å·²ç»è°ƒç”¨äº† unflatten_device_tree() æ¥å£ï¼Œå®Œæˆäº† Device Tree çš„è§£æè¿‡ç¨‹ï¼Œåœ¨ of_clk_init å‡½æ•°ä¸­ï¼Œä¼šæ ¹æ® struct of_device_id ä¸­çš„å†…å®¹å»åŒ¹é… Device Nodeã€‚</li><li>æœ€ç»ˆè°ƒç”¨__of_clk_table ä¸­åŒ¹é…ä¸Šçš„ struct of_device_id ä¸­çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ Clock é©±åŠ¨çš„å…¥å£å‡½æ•°äº†ï¼Œæ­¤æ—¶é¡ºç€è¿™ä¸ªå…¥å£å‡½æ•°ï¼Œå¯ä»¥å®Œæˆä¸€ç³»åˆ—çš„æ“ä½œï¼Œæ¯”å¦‚ clk_ops ä¸­çš„å‡½æ•°å®ç°ï¼Œæ³¨å†Œè¿› CCF æ¡†æ¶ç­‰ã€‚</li><li>å½“é©±åŠ¨å®Œæˆæ³¨å†Œä¹‹åï¼ŒConsumer Driver çš„ Device Node å’Œ Clock Provider å»ºç«‹äº†è”ç³»ï¼ŒConsumer Driver ä¾¿å¯é€šè¿‡ CCF æ¥å£æ¥æ“ä½œæ—¶é’Ÿäº†ã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcG1fc3Vic3lzdGVtL2Nsa19vdmVydmlldy5odG1s">http://www.wowotech.net/pm_subsystem/clk_overview.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcG1fc3Vic3lzdGVtL2Nsb2NrX3Byb3ZpZGVyLmh0bWw=">http://www.wowotech.net/pm_subsystem/clock_provider.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvcG1fc3Vic3lzdGVtL2Nsb2NrX2ZyYW1ld29ya19jb3JlLmh0bWw=">http://www.wowotech.net/pm_subsystem/clock_framework_core.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDc3MjkxNTY/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/107729156?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cucXRlci5vcmcvcG9ydGFsLnBocD9tb2Q9dmlldyZhaWQ9Nzc3NA==">https://www.qter.org/portal.php?mod=view&amp;aid=7774<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ Input å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverInput/"/>
      <url>/2020/LinuxDriver/LinuxDriverInput/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>æŒ‰é”®è¾“å…¥ã€é”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸å±ç­‰ç­‰è¿™äº›éƒ½å±äºè¾“å…¥è®¾å¤‡ï¼ŒæŒ‰é”®å’Œé”®ç›˜å°±æ˜¯ä»£è¡¨æŒ‰é”®ä¿¡æ¯ï¼Œé¼ æ ‡å’Œè§¦æ‘¸å±ä»£è¡¨åæ ‡ä¿¡æ¯ï¼Œå› æ­¤åœ¨åº”ç”¨å±‚çš„å¤„ç†å°±ä¸åŒã€‚ä¸ºæ­¤ input å­ç³»ç»Ÿåˆ†ä¸º input é©±åŠ¨å±‚ã€ input æ ¸å¿ƒå±‚ã€ input äº‹ä»¶å¤„ç†å±‚ï¼Œæœ€ç»ˆç»™ç”¨æˆ·ç©ºé—´æä¾›å¯è®¿é—®çš„è®¾å¤‡èŠ‚ç‚¹ï¼Œinput å­ç³»ç»Ÿæ¡†æ¶å¦‚å›¾ æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/input.png"></p><ul><li>é©±åŠ¨å±‚ï¼šè¾“å…¥è®¾å¤‡çš„å…·ä½“é©±åŠ¨ç¨‹åºï¼Œæ¯”å¦‚æŒ‰é”®é©±åŠ¨ç¨‹åºï¼Œå‘å†…æ ¸å±‚æŠ¥å‘Šè¾“å…¥å†…å®¹ã€‚</li><li>æ ¸å¿ƒå±‚ï¼šæ‰¿ä¸Šå¯ä¸‹ï¼Œä¸ºé©±åŠ¨å±‚æä¾›è¾“å…¥è®¾å¤‡æ³¨å†Œå’Œæ“ä½œæ¥å£ã€‚é€šçŸ¥äº‹ä»¶å±‚å¯¹è¾“å…¥äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</li><li>äº‹ä»¶å±‚ï¼šä¸»è¦å’Œç”¨æˆ·ç©ºé—´è¿›è¡Œäº¤äº’ã€‚</li></ul><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>Input å­ç³»ç»Ÿå®ç°çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE1NWY2ZTVlMGIzNGQwOTEyMzViN2U1">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Input_Struct.png"></p><ul><li><p>input_dev:<br>input_dev ç»“æ„ä½“ç”¨äºæè¿°ä¸€ä¸ª input è®¾å¤‡ï¼Œä¾‹å¦‚æŒ‰é”®ã€é¼ æ ‡ã€é”®ç›˜ç­‰ï¼Œæˆ‘ä»¬ç¼–å†™è®¾å¤‡é©±åŠ¨ä¸»è¦å°±æ˜¯æ„é€ è¿™ä¸ªç»“æ„ä½“ã€‚è¯¥ç»“æ„ä½“åŒ…å«è®¾å¤‡ç±»å‹ï¼Œæ¶ˆæ¯ç±»å‹ï¼Œäº‹ä»¶ code ç­‰ä¿¡æ¯ã€‚è¯¥æ•°æ®ç»“æ„åœ¨å†…æ ¸é‡Œä¼šæŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€é“¾è¡¨ input_dev_listï¼Œæ‰€æœ‰æ³¨å†Œçš„ input è®¾å¤‡éƒ½ä¼šæŒ‚è½½åˆ°è¯¥é“¾è¡¨ä¸­</p></li><li><p>input_handler:<br>input_handler ç”¨äºè¡¨ç¤ºä¸€ä¸ª input äº‹ä»¶ï¼Œç”¨äºä¸ŠæŠ¥ input äº‹ä»¶ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰æ³¨å†Œçš„ input_handler ä¹Ÿä¼šæŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€é“¾è¡¨ input_handler_list ä¸­ã€‚input_handler å¯ä»¥ç±»æ¯”è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­ driver æ–¹æ³•ï¼Œç”¨äºé©±åŠ¨ deviceï¼Œè¿™é‡Œ input_handler ç”¨äºå¤„ç† input_dev è®¾å¤‡äº§ç”Ÿçš„äº‹ä»¶ã€‚input_dev å’Œ input_handler ä¹‹é—´ä¹Ÿæ˜¯é€šè¿‡ä¸€ç§åŒ¹é…è§„åˆ™æ¥è¿›è¡ŒåŒ¹é…å»ºç«‹è”ç³»ï¼Œå½“ input_dev æ³¨å†Œçš„æ—¶å€™ä¼šéå† input_handler_list é“¾è¡¨ï¼Œé€šè¿‡ id_table æˆ– input_handler çš„ match æ–¹æ³•è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸåä¸¤è€…ä¹‹é—´ä¼šå»ºç«‹è”ç³»ã€‚åŒæ ·å¯¹äº input_handler çš„æ³¨å†Œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå½“ä¸€ä¸ª input_handler æ³¨å†Œæ—¶ä¼šéå† input_dev_list é“¾è¡¨ï¼Œå½“ä¸¤ä¸ªç»“æ„ä½“æ»¡è¶³åŒ¹é…å…³ç³»æ—¶åˆ™å»ºç«‹è”ç³»</p></li><li><p>input_handle:<br>åœ¨ä¸Šé¢çš„ä»‹ç»ä¸­å½“ input_handler å’Œ input_dev åŒ¹é…æˆåŠŸåä¼šå»ºç«‹è”ç³»ï¼Œè¿™ä¸ªè”ç³»å°±æ˜¯é€šè¿‡è¯¥ç»“æ„ä½“æ¥å»ºç«‹çš„ã€‚å½“ input_dev å’Œ input_handler åŒ¹é…æˆåŠŸåä¼šåˆ›å»ºä¸€ä¸ª evdev ç»“æ„ä½“ï¼Œevdev ç»“æ„ä½“ä¸‹æœ‰ä¸€ä¸ª input_handle ç»“æ„ä½“ï¼Œinput_handle ç»“æ„ä½“ä¼šæŒ‡å‘åŒ¹é…æˆåŠŸçš„ input_dev å’Œ input_handlerï¼Œè€Œä¸”å°†è‡ªå·±æŒ‚è½½åˆ° input_dev å’Œ input_handler ç»“æ„ä½“ä¸­</p></li><li><p>evdev_client:<br>evdev_client ç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ª input å®¢æˆ·ï¼Œä¹Ÿå°±æ˜¯ app ç”¨æˆ·ä¼šä½¿ç”¨ input_devï¼Œé‚£ä¹ˆè¿™ä¸ª app ç”¨æˆ·å°±ç”¨ evdev_client ç»“æ„ä½“æ¥æè¿°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¯¥ç»“æ„ä½“æŒ‚è½½åœ¨ evdev ç»“æ„ä½“ä¸‹ï¼Œä¸”æ˜¯ä»¥é“¾è¡¨çš„å½¢å¼ç»„ç»‡ï¼Œä¹Ÿå°±è¯´æ˜ä¸€ä¸ª input è®¾å¤‡å¯ä»¥è¢«å¤šä¸ª client æ‰“å¼€ä½¿ç”¨</p></li><li><p>evdev:<br>é€šè¿‡å¯¹ input_handler å’Œ evdev_client çš„ä»‹ç»å…¶å®ä¹Ÿå°±å·²ç»å°† evdev ä»‹ç»å®Œäº†ï¼Œevdev_client ä½¿ç”¨è®¾å¤‡ï¼Œé‚£ä¹ˆéœ€è¦çŸ¥é“ä½¿ç”¨çš„æ˜¯å“ªä¸ªè®¾å¤‡ input_dev ä»¥åŠå¦‚ä½•é©±åŠ¨è¿™ä¸ªè®¾å¤‡ input_handlerï¼Œè¿™éƒ½æ˜¯é€šè¿‡ input_handler ç»“æ„ä½“å®Œæˆçš„ã€‚evdev æ˜¯å°† input è®¾å¤‡ï¼Œinput è®¾å¤‡çš„é©±åŠ¨æ–¹æ³•å’Œç”¨æˆ· client è”ç³»èµ·æ¥çš„ä¸€ä¸ªç»“æ„ä½“</p></li></ul><p>é€šè¿‡å¯¹ input ç»“æ„ä½“çš„ä»‹ç»ï¼Œå…¶å®æˆ‘ä»¬å°±å·²ç»å¤§è‡´äº†è§£äº†é©±åŠ¨çš„æ•´ä½“æ¡†æ¶ã€‚å…¶å®è·Ÿè®¾å¤‡æ¨¡å‹ä¸­ device å’Œ device_driver ä¹‹é—´çš„å…³ç³»å¾ˆåƒï¼Œdevice å’Œ driver ä¹‹é—´æœ‰ä¸€ä¸ªåŒ¹é…è§„åˆ™ï¼Œå½“åŒ¹é…æˆåŠŸåï¼Œä¸¤è€…ä¹‹é—´å»ºç«‹è”ç³»ï¼Œå®Œæˆé©±åŠ¨è®¾å¤‡çš„åŠŸèƒ½ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œä¸ç›´æ¥ä½¿ç”¨è®¾å¤‡é©±åŠ¨æ¨¡å‹å‘¢ï¼Œä¸ç†è§£ã€‚</p><h1 id="å®ç°">å®ç°</h1><p>input é©±åŠ¨çš„å®ç°æ— éå°±æ˜¯ input_devã€input_handler çš„æ³¨å†Œç­‰æµç¨‹ï¼Œä¸‹é¢ä¸€ä¸ªä¸ªçœ‹ä¸‹å…·ä½“ç›¸å…³æµç¨‹å§ï¼š</p><h2 id="input_dev-æ³¨å†Œæµç¨‹">input_dev æ³¨å†Œæµç¨‹</h2><p>input_register_device å‡½æ•°ç”¨äºæ³¨å†Œä¸€ä¸ª input_dev è®¾å¤‡ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">input_register_device</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code>1ã€ä¸º input_dev åˆ›å»º struct device ç±»å‹çš„å˜é‡ï¼Œå¹¶è®¾ç½®å…¶æ‰€å±çš„ class ä¸º input_classï¼Œå¹¶è°ƒç”¨ device_add å®Œæˆ device ç±»å‹å˜é‡çš„æ³¨å†Œï¼Œè‡³æ­¤å®Œæˆ strcut device ç±»å‹å˜é‡æ³¨å†Œè‡³ input_class ä¸­ï¼Œä¸”å®Œæˆäº† input_dev å¯¹åº”çš„ sysfs å±æ€§æ–‡ä»¶çš„åˆ›å»ºã€‚ 2ã€å°†è¯¥ input_device æ³¨å†Œè‡³ input_dev_listã€‚3ã€éå† input_handler_list é“¾è¡¨ï¼Œé’ˆå¯¹ input_handler_list ä¸Šæ¯ä¸€ä¸ª input_handlerï¼Œå‡ä¸æ³¨å†Œçš„ input_device è¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œè‹¥åŒ¹é…æ£€æµ‹æˆåŠŸï¼Œåˆ™è°ƒç”¨  input_handler-&gt;connect æ¥å£ï¼Œè¿›è¡Œ input_handler ä¸ input_device çš„ç»‘å®šï¼ˆé€šè¿‡è°ƒç”¨ input_register_handle å®ç°ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨ input_handlerã€input_device ä¸Š å®Œæˆ input_handlerã€input_device çš„äº‹ä»¶æ¶ˆæ¯çš„è®¢é˜…æ“ä½œï¼‰ã€‚å›  input_handler å’Œ input_device å¯å®ç°å¤šå¯¹å¤šçš„ç»‘å®šï¼Œå› æ­¤ï¼Œä¼šéå† input_handler_list é“¾è¡¨ä¸Šæ‰€æœ‰å·²æ³¨å†Œçš„ input_handlerï¼Œè€Œä¸æ˜¯æ£€æµ‹åˆ°ä¸€ä¸ª input_handler çš„åŒ¹é…å³è¿”å›ã€‚</code></pre><h2 id="input_handler-çš„æ³¨å†Œæµç¨‹">input_handler çš„æ³¨å†Œæµç¨‹</h2><p>input_handler çš„æ³¨å†Œå‡½æ•°æ˜¯ input_register_handlerï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">input_register_handler</span><span class="params">(<span class="keyword">struct</span> input_handler *handler)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code>1ã€å°†è¯¥ input_device æ³¨å†Œè‡³ input_handler_list      2ã€éå† input_dev_list é“¾è¡¨ï¼Œé’ˆå¯¹ input_dev_list ä¸Šæ¯ä¸€ä¸ª input_devï¼Œå‡ä¸æ³¨å†Œçš„ input_device è¿›è¡ŒåŒ¹é…æ£€æµ‹ï¼Œè‹¥åŒ¹é…æ£€æµ‹æˆåŠŸï¼Œåˆ™è°ƒç”¨ input_handler-&gt;connect æ¥å£ï¼Œè¿›è¡Œ input_handler ä¸ input_device çš„ç»‘å®šï¼ˆé€šè¿‡è°ƒç”¨ input_register_handle å®ç°ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨ input_handlerã€input_device ä¸Šå®Œæˆ input_handlerã€input_device çš„äº‹ä»¶æ¶ˆæ¯çš„è®¢é˜…æ“ä½œï¼‰ã€‚å›  input_handler å’Œ input_device å¯å®ç°å¤šå¯¹å¤šçš„ç»‘å®šï¼Œå› æ­¤ï¼Œä¼šéå† input_dev_list é“¾è¡¨ä¸Šæ‰€æœ‰å·²æ³¨å†Œçš„ input_devï¼Œè€Œä¸æ˜¯æ£€æµ‹åˆ°ä¸€ä¸ª input_dev çš„åŒ¹é…å³è¿”å›</code></pre><h2 id="input_handle-çš„æ³¨å†Œæµç¨‹">input_handle çš„æ³¨å†Œæµç¨‹</h2><p>input_handle çš„æ³¨å†Œå‡½æ•°æ˜¯ input_register_handleï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">input_register_handle</span><span class="params">(<span class="keyword">struct</span> input_handle *handle)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code>1ã€ å®Œæˆ input_handle ä¸ input_handler çš„å…³è”2ã€å®Œæˆ input_handle ä¸ input_dev çš„å…³è”</code></pre><h1 id="ä¸€ä¸ªå®Œæ•´çš„äº‹ä»¶ä¸ŠæŠ¥æµç¨‹">ä¸€ä¸ªå®Œæ•´çš„äº‹ä»¶ä¸ŠæŠ¥æµç¨‹</h1><h2 id="åº”ç”¨æ‰“å¼€å¹¶è¯»è®¾å¤‡">åº”ç”¨æ‰“å¼€å¹¶è¯»è®¾å¤‡</h2><p>å½“åº”ç”¨æ‰“å¼€ä¸€ä¸ª input è®¾å¤‡æ—¶ä¼šé€šè¿‡ vfs è°ƒç”¨åˆ°é©±åŠ¨ç¨‹åºçš„ file_operations, å¯¹äº input è®¾å¤‡å°±æ˜¯ evdev.c ä¸‹çš„ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">evdev_fops</span> =</span> {</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.read= evdev_read,</span><br><span class="line">.write= evdev_write,</span><br><span class="line">.poll= evdev_poll,</span><br><span class="line">.open= evdev_open,</span><br><span class="line">.release= evdev_release,</span><br><span class="line">.unlocked_ioctl= evdev_ioctl,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_ioctl= evdev_ioctl_compat,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.fasync= evdev_fasync,</span><br><span class="line">.llseek= no_llseek,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªå°±æ˜¯ input_dev æ³¨å†Œçš„æ—¶å€™ä¼šå‘ç³»ç»Ÿæ³¨å†Œçš„å­—ç¬¦è®¾å¤‡ï¼Œè¯¥å­—ç¬¦è®¾å¤‡çš„æ³¨å†Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™å‘¢ï¼Œå…ˆæ¥çœ‹ä¸‹ input_handle çš„åˆå§‹åŒ–ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> <span class="title">evdev_handler</span> =</span> {</span><br><span class="line">.event= evdev_event,</span><br><span class="line">.events= evdev_events,</span><br><span class="line">.connect= evdev_connect,</span><br><span class="line">.disconnect= evdev_disconnect,</span><br><span class="line">.legacy_minors= <span class="literal">true</span>,</span><br><span class="line">.minor= EVDEV_MINOR_BASE,</span><br><span class="line">.name= <span class="string">"evdev"</span>,</span><br><span class="line">.id_table= evdev_ids,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">evdev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> input_register_handler(&amp;evdev_handler);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">evdev_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">input_unregister_handler(&amp;evdev_handler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>evdev_handler é‡Œé¢çš„æˆå‘˜ connect çš„æŒ‡é’ˆæŒ‡å‘ evdev_connectï¼Œå½“ input_dev å’Œ input_handler åŒ¹é…æˆåŠŸåå°±ä¼šè°ƒç”¨ connectï¼Œå‡½æ•°ï¼Œè€Œ evdev_connect é‡Œé¢ä¼šè°ƒç”¨</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cdev_init(&amp;evdev-&gt;cdev, &amp;evdev_fops);</span><br><span class="line"></span><br><span class="line">cdev_device_add(&amp;evdev-&gt;cdev, &amp;evdev-&gt;dev);</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>evdev_fops å°±æ˜¯ä¸Šé¢é‚£ä¸ª file_operationsã€‚ç„¶ååº”ç”¨è°ƒç”¨ open å°±ä¼šè°ƒç”¨é©±åŠ¨çš„ evdev_open å‡½æ•°ï¼Œåº”ç”¨è°ƒç”¨ read å°±ä¼šè°ƒç”¨é©±åŠ¨çš„ evdev_read å‡½æ•°ï¼Œä¸‹é¢è¯´æ˜ä¸‹ open å’Œ read å‡½æ•°ä¸»è¦çš„å·¥ä½œï¼š evdev_open çš„å·¥ä½œï¼š</p><pre><code>1ã€ åˆ›å»ºå¹¶åˆ†é…ä¸€ä¸ª evdev_client ç»“æ„ä½“   2ã€ å°† evdev_client æ”¾å…¥ evdev çš„é“¾è¡¨ä¸­   </code></pre><p>evdev_read çš„å·¥ä½œï¼š</p><pre><code>å¦‚æœæ²¡æœ‰æ•°æ®ç­‰å¾…ä¼‘çœ ï¼Œè°ƒç”¨ wait_event_interruptible å‡½æ•°ï¼Œå°†å½“å‰å·¥ä½œæŒ‚è½½åœ¨ evdev_client çš„ wait ç­‰å¾…é˜Ÿåˆ—ä¸­</code></pre><h2 id="äº‹ä»¶äº§ç”Ÿä¸ŠæŠ¥æ•°æ®">äº‹ä»¶äº§ç”Ÿä¸ŠæŠ¥æ•°æ®</h2><p>ä¸€èˆ¬é‡‡ç”¨ä¸­æ–­æ–¹å¼å¤„ç†å¤–éƒ¨äº‹ä»¶ï¼Œå½“æŒ‰é”®æˆ–å…¶ä»–è¾“å…¥äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œäº§ç”Ÿä¸­æ–­ï¼Œæ‰§è¡Œä¸­æ–­æœåŠ¡ç¨‹åºï¼Œä¸­æ–­æœåŠ¡ç¨‹åºä¸€èˆ¬ä¸»è¦å°±æ˜¯å¹²ä¸¤ä»¶äº‹ï¼Œè¯»å–æ•°æ®å’Œä¸ŠæŠ¥æ•°æ®ï¼Œå¯¹äºè¯»å–æ•°æ®æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸‹é¢çœ‹ä¸‹ä¸ŠæŠ¥æ•°æ®æµç¨‹ï¼šä¸ŠæŠ¥æ•°æ®é€šè¿‡ input core å±‚æä¾›çš„ input_event å‡½æ•°å®Œæˆï¼Œå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_event</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,</span></span><br><span class="line"><span class="params"> <span class="type">unsigned</span> <span class="type">int</span> type, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line">{</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_event_supported(type, dev-&gt;evbit, EV_MAX)) {</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">input_handle_event(dev, type, code, value);</span><br><span class="line">spin_unlock_irqrestore(&amp;dev-&gt;event_lock, flags);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‡½æ•°è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">input_event()</span><br><span class="line">    --&gt;input_handle_event()</span><br><span class="line">        --&gt;input_pass_values()</span><br><span class="line">            --&gt;input_to_handler()</span><br></pre></td></tr></tbody></table></figure><p>input_to_handler å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">input_to_handler</span><span class="params">(<span class="keyword">struct</span> input_handle *handle,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> input_value *vals, <span class="type">unsigned</span> <span class="type">int</span> count)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_handler</span> *<span class="title">handler</span> =</span> handle-&gt;handler;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">end</span> =</span> vals;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_value</span> *<span class="title">v</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1ã€ ä½¿ç”¨ filter è¿‡æ»¤äº‹ä»¶ */</span></span><br><span class="line"><span class="keyword">if</span> (handler-&gt;filter) {</span><br><span class="line"><span class="keyword">for</span> (v = vals; v != vals + count; v++) {</span><br><span class="line"><span class="keyword">if</span> (handler-&gt;filter(handle, v-&gt;type, v-&gt;code, v-&gt;value))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (end != v)</span><br><span class="line">*end = *v;</span><br><span class="line">end++;</span><br><span class="line">}</span><br><span class="line">count = end - vals;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!count)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2ã€è°ƒç”¨ handler çš„ events å¤„ç†å¤šä¸ªäº‹ä»¶æˆ–è€…è°ƒç”¨ event ä¸€ä¸ªä¸€ä¸ªå¤„ç†äº‹ä»¶ */</span></span><br><span class="line"><span class="keyword">if</span> (handler-&gt;events)</span><br><span class="line">handler-&gt;events(handle, vals, count);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (handler-&gt;event)</span><br><span class="line"><span class="keyword">for</span> (v = vals; v != vals + count; v++)</span><br><span class="line">handler-&gt;event(handle, v-&gt;type, v-&gt;code, v-&gt;value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ evdev ä¸ºä¾‹ï¼Œåœ¨ä¸Šé¢çš„ evdev_handler ä¸­æä¾›äº† events å‡½æ•° evdev_handlerï¼Œè¯¥å‡½æ•°è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">evdev_events()</span><br><span class="line">    --&gt;evdev_pass_values()</span><br><span class="line">        --&gt;__pass_event()</span><br><span class="line">        --&gt;wake_up_interruptible_poll(&amp;client-&gt;wait,</span><br><span class="line">EPOLLIN | EPOLLOUT | EPOLLRDNORM | EPOLLWRNORM);</span><br></pre></td></tr></tbody></table></figure><p>__pass_event å‡½æ•°å°†è¯»å–çš„äº‹ä»¶ä¼ é€’ç»™ client ç»“æ„ä½“ï¼Œwake_up_interruptible_poll å°†åº”ç”¨ç¨‹åºå”¤é†’ï¼ˆå‰é¢æåˆ°è¯»å–æ•°æ®çš„æ—¶å€™å¦‚æœæ²¡æœ‰æ•°æ®å°±ä¼‘çœ ï¼‰ã€‚</p><h1 id="input-tools">Input Tools</h1><h2 id="getevent-å‘½ä»¤">getevent å‘½ä»¤</h2><p>getevent æŒ‡ä»¤ç”¨äºè·å– input è¾“å…¥äº‹ä»¶ï¼Œæ¯”å¦‚è·å–æŒ‰é”®ä¸ŠæŠ¥ä¿¡æ¯ã€è·å–è§¦æ‘¸å±ä¸ŠæŠ¥ä¿¡æ¯ç­‰ã€‚ getevent -hï¼šæŸ¥çœ‹ getevent å¸®åŠ©ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@rk3288:/ <span class="comment"># getevent -h</span></span><br><span class="line">getevent -h</span><br><span class="line">Usage: getevent [-t] [-n] [-s switchmask] [-S] [-v [mask]] [-d] [-p] [-i] [-l] [-q] [-c count] [-r] [device]</span><br><span class="line">    -t: show time stamps</span><br><span class="line">    -n: don<span class="string">'t print newlines</span></span><br><span class="line"><span class="string">    -s: print switch states for given bits</span></span><br><span class="line"><span class="string">    -S: print all switch states</span></span><br><span class="line"><span class="string">    -v: verbosity mask (errs=1, dev=2, name=4, info=8, vers=16, pos. events=32, props=64)</span></span><br><span class="line"><span class="string">    -d: show HID descriptor, if available</span></span><br><span class="line"><span class="string">    -p: show possible events (errs, dev, name, pos. events)</span></span><br><span class="line"><span class="string">    -i: show all device info and possible events</span></span><br><span class="line"><span class="string">    -l: label event types and names in plain text</span></span><br><span class="line"><span class="string">    -q: quiet (clear verbosity mask)</span></span><br><span class="line"><span class="string">    -c: print given number of events then exit</span></span><br><span class="line"><span class="string">    -r: print rate events are received</span></span><br></pre></td></tr></tbody></table></figure><ul><li>-tï¼šæ˜¾ç¤ºæ—¶é—´æˆ³</li><li>-nï¼šä¸æ¢è¡Œæ‰“å°</li><li>-sï¼šæ˜¾ç¤ºæŒ‡å®šä½çš„å¼€å…³çŠ¶æ€</li><li>-vï¼šæ ¹æ® mask å€¼æ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼Œæ‰§è¡Œåä¼šä¸€ç›´æ˜¾ç¤ºä¸ŠæŠ¥æ•°æ®</li><li>-dï¼šå¦‚æœè®¾å¤‡å¯ç”¨ï¼Œæ˜¾ç¤ºè®¾å¤‡éšè—çš„æè¿°ä¿¡æ¯</li><li>-pï¼šæ˜¾ç¤ºè®¾å¤‡æ”¯æŒçš„äº‹ä»¶ç±»å‹å’Œç¼–ç æ–¹å¼</li><li>-iï¼šæ˜¾ç¤ºè®¾å¤‡çš„æ‰€æœ‰ä¿¡æ¯å’Œæ”¯æŒçš„äº‹ä»¶ï¼Œæ¯” -p æ˜¾ç¤ºæ›´å¤šä¿¡æ¯</li><li>-lï¼šä»¥æ–‡æœ¬å½¢å¼è¾“å‡ºäº‹ä»¶ç±»å‹å’Œåç§°ï¼Œæ¯” -t æ›´æ¸…æ¥šç›´è§‚</li><li>-cï¼šæ‰“å°å›ºå®šæ•°é‡çš„äº‹ä»¶å¹¶é€€å‡º</li><li>-rï¼šæ˜¾ç¤ºäº‹ä»¶ä¸ŠæŠ¥é€Ÿç‡</li></ul><p>å‚æ•°å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œä¸€æ¬¡æ€§æŸ¥çœ‹éœ€è¦çš„è§¦æ‘¸å±ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@rk3288:/ <span class="comment"># getevent -tlr /dev/input/event3</span></span><br><span class="line">getevent -tlr /dev/input/event3</span><br><span class="line">[    2514.550104] EV_ABS       ABS_MT_TRACKING_ID   0000001c</span><br><span class="line">[    2514.550104] EV_ABS       ABS_MT_POSITION_X    00002dac</span><br><span class="line">[    2514.550104] EV_ABS       ABS_MT_POSITION_Y    000018ca</span><br><span class="line">[    2514.550104] EV_KEY       BTN_TOUCH            DOWN</span><br><span class="line">[    2514.550104] EV_ABS       ABS_X                00002dac</span><br><span class="line">[    2514.550104] EV_ABS       ABS_Y                000018ca</span><br><span class="line">[    2514.550104] EV_SYN       SYN_REPORT           00000000             rate 0</span><br><span class="line">[    2514.638845] EV_ABS       ABS_MT_TRACKING_ID   ffffffff</span><br><span class="line">[    2514.638845] EV_KEY       BTN_TOUCH            UP</span><br><span class="line">[    2514.638845] EV_SYN       SYN_REPORT           00000000             rate 11</span><br></pre></td></tr></tbody></table></figure><h2 id="tslib-è°ƒè¯•å·¥å…·">tslib è°ƒè¯•å·¥å…·</h2><h3 id="é…ç½®-tslib">é…ç½® tslib</h3><p>é…ç½®æ–‡ä»¶/etc/ts.confã€‚è§¦æ‘¸æ¨¡å—ä»ä¸Šåˆ°ä¸‹åŠ è½½ã€‚æ¯ä¸€è¡ŒæŒ‡å®šä¸€ä¸ªæ¨¡å—åŠå…¶å‚æ•°ï¼Œæ¨¡å—æŒ‰é¡ºåºå¤„ç†ã€‚åœ¨é¡¶éƒ¨ä½¿ç”¨ä¸€ä¸ª module_rawï¼Œè®¿é—®æ‚¨çš„è®¾å¤‡ï¼Œç„¶åæ˜¯è¿‡æ»¤å™¨æ¨¡å—çš„ä»»æ„ç»„åˆã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Uncomment if you wish to use the one-wire linux input layer S70/A70...</span></span><br><span class="line"><span class="comment"># module_raw one_wire_ts_input</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you wish to use the linux input layer event interface</span></span><br><span class="line">module_raw input</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using a Sharp Zaurus SL-5500/SL-5000d</span></span><br><span class="line"><span class="comment"># module_raw collie</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using a Sharp Zaurus SL-C700/C750/C760/C860</span></span><br><span class="line"><span class="comment"># module_raw corgi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using a device with a UCB1200/1300/1400 TS interface</span></span><br><span class="line"><span class="comment"># module_raw ucb1x00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using an HP iPaq h3600 or similar</span></span><br><span class="line"><span class="comment"># module_raw h3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using a Hitachi Webpad</span></span><br><span class="line"><span class="comment"># module_raw mk712</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you're using an IBM Arctic II</span></span><br><span class="line"><span class="comment"># module_raw arctic2</span></span><br><span class="line"></span><br><span class="line">module pthres pmin=1</span><br><span class="line">module variance delta=30</span><br><span class="line">module dejitter delta=100</span><br><span class="line">module linea</span><br></pre></td></tr></tbody></table></figure><h3 id="æ’ä»¶">æ’ä»¶</h3><ul><li>pthres å‹åŠ›é˜ˆå€¼è¿‡æ»¤å™¨</li><li>variance æ–¹å·®è¿‡æ»¤å™¨ã€‚å°½æœ€å¤§åŠªåŠ›æ»¤é™¤æ¥è‡ªè§¦æ‘¸å± ADC çš„éšæœºå™ªå£°</li><li>dejitter æ¶ˆé™¤ X å’Œ Y åæ ‡ä¸Šçš„æŠ–åŠ¨</li><li>debounce ç®€å•çš„å»æŠ–åŠ¨æœºåˆ¶ï¼Œåœ¨è§¦æ‘¸æ‰‹åŠ¿åœæ­¢åçš„æŒ‡å®šæ—¶é—´å†…ä¸¢å¼ƒè¾“å…¥äº‹ä»¶</li><li>skip nhead æŒ‰ä¸‹åè·³è¿‡æ ·å“ï¼Œntail é‡Šæ”¾å‰è·³è¿‡æ ·å“</li><li>lowpass ç®€å•çš„ä½é€šæŒ‡æ•°å¹³å‡æ»¤æ³¢æ¨¡å—</li><li>linear çº¿æ€§ç¼©æ”¾ - æ ¡å‡† - æ¨¡å—ï¼Œä¸»è¦ç”¨äºå°†è§¦æ‘¸å±åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡</li><li>invert å›´ç»•ç»™å®šå€¼åœ¨ X /Y æ–¹å‘åè½¬å€¼</li><li>median ä¸­å€¼æ»¤æ³¢å™¨å‡å°‘æ ·æœ¬åæ ‡å€¼ä¸­çš„å™ªå£°ã€‚å®ƒèƒ½å¤Ÿè¿‡æ»¤ä¿¡å·ä¸­ä¸éœ€è¦çš„å•ä¸ªå¤§è·³è·ƒ</li><li>iir æ— é™è„‰å†²å“åº”æ»¤æ³¢å™¨</li><li>tslib ä»è§¦æ‘¸å±é©±åŠ¨é‡‡æ ·åˆ°çš„è®¾å¤‡åæ ‡è¿›è¡Œå¤„ç†å†æä¾›ç»™åº”ç”¨ç«¯çš„è¿‡ç¨‹å¤§ä½“å¦‚ä¸‹</li></ul><p>raw device --&gt; variance --&gt; dejitter --&gt; linear --&gt; application</p><h3 id="ts_calibrate-è§¦æ‘¸å±æ ¡å‡†å·¥å…·">ts_calibrate è§¦æ‘¸å±æ ¡å‡†å·¥å…·</h3><p>æ ¡å‡†ç”± linear æ’ä»¶å®Œæˆï¼Œå®ƒä½¿ç”¨è‡ªå·±çš„é…ç½®æ–‡ä»¶ /etc/pointercalã€‚ä¸è¦æ‰‹åŠ¨ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚å®ƒæ˜¯ç”± ts_calibrate ç¨‹åºåˆ›å»ºçš„ ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxTS1.png"></p><p>æµ‹è¯•è¿‡æ»¤åçš„è¾“å…¥è¡Œä¸ºã€‚</p><p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿæµ‹è¯•ç”±é…ç½®çš„è¿‡æ»¤å™¨äº§ç”Ÿçš„è§¦æ‘¸è¡Œä¸º ts_test_mtï¼š ts_test_mtï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxTS2.png"></p><h1 id="æ€»ç»“">æ€»ç»“</h1><ul><li>åº”ç”¨ open ä¸€ä¸ª input è®¾å¤‡ï¼Œé€šè¿‡ vfs è°ƒç”¨åˆ°é©±åŠ¨å­—ç¬¦è®¾å¤‡çš„ open å‡½æ•°ï¼Œè¯¥å‡½æ•°åˆ›å»ºæ„é€ ä¸€ä¸ª evdev_client ç»“æ„ä½“å¹¶å°†è¯¥ç»“æ„ä½“æ”¾å…¥æ‰“å¼€çš„ input è®¾å¤‡çš„ evdev ç»“æ„ä½“é“¾è¡¨ä¸­<br></li><li>åº”ç”¨ read è¯»å–ä¸€ä¸ª input è®¾å¤‡ï¼Œé€šè¿‡ vfs è°ƒç”¨åˆ°é©±åŠ¨çš„å­—ç¬¦è®¾å¤‡ read å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±ä¼‘çœ <br></li><li>äº‹ä»¶å‘ç”Ÿäº§ç”Ÿä¸­æ–­ï¼Œåœ¨ä¸­æ–­å‡½æ•°é‡Œè¯»å–æ•°æ®å¹¶ä¸ŠæŠ¥äº‹ä»¶ï¼Œä¸ŠæŠ¥äº‹ä»¶æµç¨‹æ˜¯é€šè¿‡ input_dev ç»“æ„ä½“æ‰¾åˆ°é©±åŠ¨è¯¥ç»“æ„ä½“çš„ input_handler ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨ input_handler ç»“æ„ä½“çš„ events å‡½æ•°ï¼Œåœ¨ events å‡½æ•°é‡Œï¼Œä¸»è¦å¹²ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯å°†å¤–éƒ¨äº‹ä»¶ä¼ é€’ç»™ evdev_client ç»“æ„ä½“ï¼ŒäºŒæ˜¯å°†åº”ç”¨ç¨‹åºå”¤é†’</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9sZDI0Ni5jb20vYXJ0aWNsZS8xNTk4MDkzMjM3MjM1">https://ld246.com/article/1598093237235<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZGVuZy10YW8vcC82MDk0MDQ5Lmh0bWw=">https://www.cnblogs.com/deng-tao/p/6094049.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDY0NDkxMDQ/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/106449104?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br>ã€ŠéŸ¦ä¸œå±±è€å¸ˆç›¸å…³è¯¾ç¨‹å’Œæ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ Regmap å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverRegmap/"/>
      <url>/2020/LinuxDriver/LinuxDriverRegmap/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>å†…æ ¸ç‰ˆæœ¬ 3.1 ä¸­å¼•å…¥äº† Regmap APIï¼Œç”¨äºç»Ÿä¸€å†…æ ¸å¼€å‘äººå‘˜è®¿é—® SPI/IIC è®¾å¤‡çš„æ–¹å¼ï¼Œæ— è®ºæ˜¯ SPI è®¾å¤‡è¿˜æ˜¯ IIC è®¾å¤‡ï¼Œåªéœ€è¦åˆå§‹åŒ–ï¼Œé…ç½® Regmap å°±å¯ä»¥é€šè¿‡ Regmap è¯»å†™è®¾å¤‡ã€‚Regmap å­ç³»ç»Ÿä¸»è¦æä¾›å¦‚ä¸‹ä¸¤ç§åŠŸèƒ½ï¼š</p><ul><li>ç¬¬ä¸€æ˜¯ä¸º IIC/SPI/MMIO ç­‰æä¾›ç»Ÿä¸€çš„è®¿é—®æ¥å£ï¼Œlinux ä¸­å¤§é‡çš„ iic å’Œ spi è®¾å¤‡å°±å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„æ¥å£è¿›è¡Œè®¿é—®å°¤å…¶å¯¹äºé‚£äº›åŒæ—¶æ”¯æŒ iic å’Œ spi æ¥å£çš„è®¾å¤‡ã€‚</li><li>ç¬¬äºŒæ˜¯æä¾›ç¼“å­˜è®¿é—®æœºåˆ¶ç”¨äºåŠ é€Ÿè®¾å¤‡è®¿é—®è®¾å¤‡ï¼Œå¯¹äºæ”¯æŒç¼“å­˜çš„è®¾å¤‡è¿™å°†å¤§å¤§åŠ å¿«è®¾å¤‡çš„å½“é—®é€Ÿåº¦ã€‚</li></ul><p>ä¸‹é¢çœ‹ä¸€ä¸‹ Regmapz å­ç³»ç»Ÿåœ¨é©±åŠ¨ä¸­çš„ä½ç½®ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTVhMzg1NjUzYmI2NDkzMGMxYzAz">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Regmap.png"></p><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>regmap å­ç³»ç»Ÿçš„å®ç°æ¯”è¾ƒç®€å•ï¼Œæ•°æ®ç»“æ„ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU5YjUwZTNlNzQwNmUyMDI0Njhi">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Regmap_Struct.png"></p><ul><li><p>regmap_bus:<br>regmap_bus æ•°æ®ç»“æ„ç”¨äºå¯¹å…·ä½“çš„ bus è¿›è¡Œå°è£…ï¼Œä¾‹å¦‚å¯¹ IIC æˆ– SPI æ€»çº¿è¿›è¡Œå°è£…ï¼Œè¿™äº› bus ä¸‹å¯ä»¥æŒ‚è½½å¾ˆå¤šè®¾å¤‡ï¼Œä»–ä»¬éƒ½ä»å±äºä¸€ä¸ªæ€»çº¿é‚£ä¹ˆå°±æœ‰å¾ˆå¤šå…±æ€§æ“ä½œï¼Œå¯¹è¿™ä¸ªç»“æ„çš„å°è£…å°±ç”¨ regmap_bus ç»“æ„ã€‚è¯¥ç»“æ„ä¸»è¦æä¾›åŒæ­¥è¯»å†™ã€å¼‚æ­¥è¯»å†™ã€æ ¼å¼åŒ–æ•°æ®ç­‰æ“ä½œæ¥å£</p></li><li><p>regmap:<br>åœ¨ä¸Šé¢çš„ç»“æ„ä¸­è®²åˆ° regmap_bus ç”¨äºå°è£…å…·ä½“çš„ busï¼Œè¿™äº› bus ä¸‹ä¼šæŒ‚è½½å„ç§ä¸åŒçš„è®¾å¤‡ï¼Œè¿™äº›è®¾å¤‡çš„æ“ä½œæœ‰å¾ˆå¤šä¸ä¸€æ ·çš„ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªè®¾å¤‡è¿›è¡Œå°è£…å°±ä½¿ç”¨ regmap ç»“æ„ä½“ã€‚è¯¥ç»“æ„ä¸»è¦æä¾›çš„åŠŸèƒ½æœ‰ï¼šç¼“å­˜åŒºå’Œç¼“å­˜æ“ä½œã€å¼‚æ­¥è¯»å†™é“¾è¡¨å’Œé˜Ÿåˆ—æ“ä½œã€è¯»å†™æƒé™ç®¡ç†ï¼ˆå“ªäº›åœ°å€çš„å¯„å­˜å™¨æ˜¯å¯è¯»çš„ã€å“ªäº›åœ°å€èŒƒå›´æ˜¯å¯å†™çš„ä»¥åŠå“ªäº›åœ°å€èŒƒå›´æ˜¯å¯è¯»å†™çš„ï¼‰ã€è¯»å†™é¡µçš„æ”¯æŒåŠè®¿é—®æ“ä½œä»¥åŠå¯¹å¯„å­˜å™¨å’Œå€¼çš„æ ¼å¼åŒ–æ“ä½œç­‰</p></li><li><p>regmap_config:<br>regmap_config ç»“æ„æ˜¯æœ€æ¥è¿‘ç”¨æˆ·çš„ï¼Œå› æ­¤ä¸Šå›¾ä¸­ä¹Ÿå¯¹è¯¥ç»“æ„åšäº†æœ€è¯¦ç»†çš„æ³¨é‡Šï¼Œè¯¥ç»“æ„ä¸»è¦ç”¨äºç”¨æˆ·é€šè¿‡è¯¥ç»“æ„æ¥åˆå§‹åŒ– regmap ç»“æ„ä½“</p></li><li><p>regmap_range_cfg:<br>regmap_range_cfg æ•°æ®ç»“æ„ç”¨äºæè¿°é¡µèŒƒå›´å’Œé¡µé€‰æ‹©</p></li><li><p>regmap_format:<br>regmap_format æ•°æ®ç»“æ„å°±æ˜¯ä¸Šé¢æåˆ°çš„ç”¨æˆ·æ ¼å¼åŒ–æ•°æ®çš„ç»“æ„ï¼Œå¯¹äºæŸäº›å¯„å­˜å™¨æ˜¯ 12bit æˆ–å…¶ä»–éå¸¸è§„ä½æ•°çš„å¯„å­˜å™¨è¿›è¡Œæ ¼å¼åŒ–æ•°æ®çš„ç»“æ„</p></li><li><p>regmap_access_table:<br>regmap_access_table æ•°æ®ç»“æ„ç”¨äºæè¿°å¯¹å¯„å­˜å™¨è®¿é—®æƒé™çš„æ§åˆ¶ï¼Œyes_ranges æ˜¯å¯è®¿é—®åœ°å€èŒƒå›´è€Œ no_range æ˜¯ä¸å¯è®¿é—®åœ°å€è®¿é—®</p></li><li><p>regcache_ops:<br>regcache_ops ç»“æ„æä¾›ç¼“å­˜æ“ä½œç›¸å…³æ¥å£æè¿°</p></li></ul><h1 id="å®ç°">å®ç°</h1><h2 id="regmap_bus-çš„å®ç°">regmap_bus çš„å®ç°</h2><p>è¿™é‡Œä»¥ spi æ€»çº¿çš„ regmap_bus ä¸ºä¾‹ï¼Œiic ç­‰å…¶ä»–æ€»çº¿æ˜¯ç›¸åŒçš„é€»è¾‘ï¼Œregmap_spi çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">regmap_bus</span> <span class="title">regmap_spi</span> =</span> {</span><br><span class="line">.write = regmap_spi_write,</span><br><span class="line">.gather_write = regmap_spi_gather_write,</span><br><span class="line">.async_write = regmap_spi_async_write,</span><br><span class="line">.async_alloc = regmap_spi_async_alloc,</span><br><span class="line">.read = regmap_spi_read,</span><br><span class="line">.read_flag_mask = <span class="number">0x80</span>,</span><br><span class="line">.reg_format_endian_default = REGMAP_ENDIAN_BIG,</span><br><span class="line">.val_format_endian_default = REGMAP_ENDIAN_BIG,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *__<span class="title">regmap_init_spi</span>(<span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span>,</span></span><br><span class="line"><span class="class"> <span class="title">const</span> <span class="keyword">struct</span> <span class="title">regmap_config</span> *<span class="title">config</span>,</span></span><br><span class="line"><span class="class"> <span class="keyword">struct</span> <span class="title">lock_class_key</span> *<span class="title">lock_key</span>,</span></span><br><span class="line"><span class="class"> <span class="title">const</span> <span class="title">char</span> *<span class="title">lock_name</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line"><span class="keyword">return</span> __regmap_init(&amp;spi-&gt;dev, &amp;regmap_spi, &amp;spi-&gt;dev, config,</span><br><span class="line">     lock_key, lock_name);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶å®å®ç°å¾ˆç®€å•å°±æ˜¯æ„é€ ä¸€ä¸ª regmap_bus æ•°æ®ç»“æ„ regmap_spiï¼Œå¹¶æä¾› spi çš„ç›¸å…³æ“ä½œï¼Œè¿™é‡Œä»¥ write ä¸ºä¾‹çœ‹ä¸‹é‡Œé¢çš„å®ç°ï¼Œå…¶ä»–ç±»ä¼¼ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">regmap_spi_write</span><span class="params">(<span class="type">void</span> *context, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> count)</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> context;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> to_spi_device(dev);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> spi_write(spi, data, count);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å…¶å®å°±æ˜¯æ ‡å‡†çš„ spi æ¥å£çš„è°ƒç”¨ï¼Œè¿™ä¹Ÿè¯æ˜äº† regmap å…¶å®å°±æ˜¯å¯¹ä¸€äº›åº•å±‚ bus è¿›è¡Œè¿›ä¸€æ­¥å°è£…å¹¶å¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£ï¼ŒåŒæ—¶è¿˜æä¾›é¡µæ“ä½œç¼“å­˜ç­‰éå¸¸å¥½ç”¨çš„æ¥å£ã€‚</p><h2 id="regmap-çš„å®ç°">regmap çš„å®ç°</h2><p>åœ¨ä¸Šé¢ä»‹ç»çš„__regmap_init_spi å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ª regmap ç»“æ„ä½“ä¹Ÿå°±æ˜¯ regmap ç»“æ„ä½“çš„åˆ›å»ºè¿‡ç¨‹ </p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__devm_regmap_init</span><br><span class="line">    __regmap_init</span><br></pre></td></tr></tbody></table></figure> __regmap_init å‡½æ•°çš„æµç¨‹æ¯”è¾ƒç¹çè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå¤§è‡´çš„æµç¨‹æ˜¯åˆå§‹åŒ–éœ€è¦ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ regmap_bus å’Œ regmap_configã€‚æ¯ä¸€ä¸ª regmap éƒ½éœ€è¦ä¸€ä¸ª regmap_bus æ•°æ®ç»“æ„ï¼Œregmap çš„åˆå§‹åŒ–å°±æ˜¯è®¾ç½®å…¶ç»“æ„ä½“çš„æˆå‘˜ï¼Œè€Œè®¾ç½®çš„ä¾æ®å°±æ˜¯æ ¹æ® regmap_config ç»“æ„ä½“çš„å†…å®¹æ¥è®¾ç½®ã€‚<p></p><p>å…¶å®åˆ°è¿™é‡Œ regmap çš„ä¸»ä½“ç»“æ„å’Œå®ç°å°±å¤§æ¦‚æ¸…æ¥šäº†ï¼Œè‡³äºå…¶å…·ä½“çš„å®ç°ç»†èŠ‚åƒé¡µçš„è®¿é—®æ“ä½œï¼Œç¼“å­˜çš„æ“ä½œæƒé™çš„ç®¡ç†æ„Ÿå…´è¶£çš„å¯ä»¥å» driver/base/regmap/ç›®å½•ä¸‹å»çœ‹æºç ï¼Œæˆ‘ä¹Ÿæ²¡å»è¯¦ç»†äº†è§£å…·ä½“çš„å®ç°è¿‡ç¨‹ï¼Œåªæ˜¯æ¢³ç†äº†ä¸€ä¸‹ regmap çš„å¤§è‡´å®ç°è¿‡ç¨‹ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDc1OTUzNzM/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/107595373?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDc1OTUzNDA/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/107595340?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ Pinctrl å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverPinctrl/"/>
      <url>/2020/LinuxDriver/LinuxDriverPinctrl/</url>
      
        <content type="html"><![CDATA[<h1 id="pinctrl-æ¦‚è¿°">Pinctrl æ¦‚è¿°</h1><p>å…³äº pinctrl ä¸»è¦å¯ä»¥å½’ç»“ä¸ºä¸¤ç±»è®¾ç½®ï¼Œå…¶ä¸­ä¸€ç±»æ˜¯åŠŸèƒ½é€‰æ‹©ï¼Œå³ä¸€ç»„ gpio æ˜¯ç”¨äº iic è¿˜æ˜¯ uart è¿˜æ˜¯å°±ä½œä¸ºæ™®é€š gpio æ¥ç”¨ï¼Œå¦ä¸€ç±»æ˜¯ gpio çš„ç‰¹æ€§é…ç½®ï¼Œå³ä¸Šæ‹‰ã€ä¸‹æ‹‰ã€é©±åŠ¨èƒ½åŠ›å’Œé€Ÿç‡çš„é…ç½®ã€‚è€Œ pinctrl ä¸»è¦è´Ÿè´£è¿™ä¸¤ç±»é…ç½®çš„ç®¡ç†å·¥ä½œã€‚æ€»ç»“èµ·æ¥ pinctrl ä¸»è¦å®Œæˆä»¥ä¸‹ä¸‰ç§åŠŸèƒ½ï¼š</p><ul><li>å¼•è„šæšä¸¾ä¸å‘½å (Enumerating and naming)</li><li>å¼•è„šå¤ç”¨ (Multiplexing)ï¼šæ¯”å¦‚ç”¨ä½œ GPIOã€I2C æˆ–å…¶ä»–åŠŸèƒ½</li><li>å¼•è„šé…ç½® (Configuration)ï¼šæ¯”å¦‚ä¸Šæ‹‰ã€ä¸‹æ¥ã€open drainã€é©±åŠ¨å¼ºåº¦ç­‰</li></ul><span id="more"></span><h1 id="dts-é…ç½®">dts é…ç½®</h1><p>ä»¥å…¨å¿—å¹³å°çš„å†™æ³•å¦‚ä¸‹ï¼ˆè™šæ„çš„ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">uart0_pins: uart0-pins {</span><br><span class="line">    pins = "PA4", "PA5";</span><br><span class="line">    function = "uart0";</span><br><span class="line">};</span><br><span class="line">uart0_sleep_pins: uart0-pins {</span><br><span class="line">    pins = "PA4", "PA5";</span><br><span class="line">    function = "gpio";</span><br><span class="line">};</span><br><span class="line">...</span><br><span class="line">&amp;uart0 {</span><br><span class="line">    pinctrl-names = "default","sleep";</span><br><span class="line">    pinctrl-0 = &lt;&amp;uart0_pins&gt;;</span><br><span class="line">    pinctrl-1 = &lt;&amp;uart0_sleep_pins&gt;;</span><br><span class="line">    status = "okay";</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>pinctrl-0 å¯¹åº”çš„ pinctrl-names çš„ç¬¬ 0 ä¸ªåç§° defaultï¼Œé»˜è®¤é…ç½®ï¼Œä¹Ÿå°±æ˜¯ uart0 åœ¨ä½¿ç”¨ pinctrl çš„æ—¶å€™çš„é»˜è®¤é…ç½®ï¼Œpinctrl-1 å¯¹åº”çš„æ˜¯ pinctrl-names çš„ç¬¬ä¸€ä¸ªåç§° sleepï¼Œåœ¨ç³»ç»Ÿè¿›å…¥ä¼‘çœ çš„æ—¶å€™ä¼šé€šè¿‡ pinctrl å°† uart0 çš„ pin é…ç½®æˆ gpio åŠŸèƒ½ã€‚</p><h1 id="pinctrl-é‡è¦æ¦‚å¿µ">Pinctrl é‡è¦æ¦‚å¿µ</h1><p>åœ¨è½¯ä»¶ä¸Šå°†ä»–ä»¬åˆ†ä¸º pin controller å’Œ client device ä¸¤ä¸ªè®¾å¤‡ï¼Œä½†æ˜¯ pinctrl ä¸€èˆ¬æ˜¯æ²¡æœ‰å…·ä½“ç¡¬ä»¶çš„æ§åˆ¶å™¨çš„ï¼Œå°±æ˜¯ gpio é‡Œçš„ä¸€äº› config å’Œ data å¯„å­˜å™¨ï¼Œcontrol æ˜¯è½¯ä»¶æŠ½è±¡çš„æ¦‚å¿µã€‚</p><h2 id="pin-controller">Pin Controller</h2><p>pin controller å’Œ GPIO Controller ä¸æ˜¯ä¸€å›äº‹ï¼Œå‰è€…æ§åˆ¶çš„å¼•è„šå¯ç”¨äº GPIO åŠŸèƒ½ã€I2C åŠŸèƒ½ï¼›åè€…åªæ˜¯æŠŠå¼•è„šé…ç½®ä¸ºè¾“å…¥ã€è¾“å‡ºç­‰ç®€å•çš„åŠŸèƒ½ã€‚å³å…ˆç”¨ pin controller æŠŠå¼•è„šé…ç½®ä¸º GPIOï¼Œå†ç”¨ GPIO Controler æŠŠå¼•è„šé…ç½®ä¸ºè¾“å…¥æˆ–è¾“å‡ºã€‚</p><ul><li><p>Pin State<br>å¯¹äºä¸€ä¸ªâ€œclient deviceâ€æ¥è¯´ï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ª UART è®¾å¤‡ï¼Œå®ƒæœ‰å¤šä¸ªâ€œçŠ¶æ€â€ï¼šdefaultã€sleep ç­‰ï¼Œé‚£å¯¹åº”çš„å¼•è„šä¹Ÿæœ‰è¿™äº›çŠ¶æ€ã€‚æ¯”å¦‚é»˜è®¤çŠ¶æ€ä¸‹ï¼ŒUART è®¾å¤‡æ˜¯å·¥ä½œçš„ï¼Œé‚£ä¹ˆæ‰€ç”¨çš„å¼•è„šå°±è¦å¤ç”¨ä¸º UART åŠŸèƒ½ã€‚åœ¨ä¼‘çœ çŠ¶æ€ä¸‹ï¼Œä¸ºäº†çœç”µï¼Œå¯ä»¥æŠŠè¿™äº›å¼•è„šå¤ç”¨ä¸º GPIO åŠŸèƒ½ï¼›æˆ–è€…ç›´æ¥æŠŠå®ƒä»¬é…ç½®è¾“å‡ºé«˜ç”µå¹³</p></li><li><p>Groups å’Œ Function<br>ä¸€ä¸ªè®¾å¤‡ä¼šç”¨åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå¼•è„šï¼Œè¿™äº›å¼•è„šå°±å¯ä»¥å½’ä¸ºä¸€ç»„ (group)ã€‚è¿™äº›å¼•è„šå¯ä»¥å¤ç”¨ä¸ºæŸä¸ªåŠŸèƒ½ï¼šfunction</p></li><li><p>Multiplexing node å’Œ Configuration node<br>å¯ä»¥ç”¨æ¥æè¿°å¤ç”¨ä¿¡æ¯ï¼šå“ªç»„ (group) å¼•è„šå¤ç”¨ä¸ºå“ªä¸ªåŠŸèƒ½ (function) å¯ä»¥ç”¨æ¥æè¿°é…ç½®ä¿¡æ¯ï¼šå“ªç»„ (group) å¼•è„šé…ç½®ä¸ºå“ªä¸ªè®¾ç½®åŠŸèƒ½ (setting)ï¼Œæ¯”å¦‚ä¸Šæ‹‰ã€ä¸‹æ‹‰ç­‰</p></li></ul><h2 id="client-device">Client Device</h2><p>å…·ä½“åˆ°æ¯ä¸ªæ§åˆ¶å™¨ä¸€èˆ¬éƒ½æ˜¯è¦é€šè¿‡ pin è„šä¸å¤–éƒ¨è¿æ¥çš„ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ soc çš„ pin è„šï¼Œé‚£ä¹ˆè¿™ä¸ªæ§åˆ¶å™¨å°±æ˜¯ pinctrl çš„ client deviceï¼Œå…·ä½“çš„ client device ä¼šé€šè¿‡ pinctrl æ¥å°† pin è®¾ç½®ä¸ºç›¸åº”çš„åŠŸèƒ½åŠé…ç½®ã€‚</p><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>pinctrl çš„æ•°æ®ç»“æ„æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ•´ä½“æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjEzYjdiMzlmMzQ2ZmIwNzBiOThkYjdi">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PinCtrlStruct.png"></p><p>ä¸Šå›¾æ˜¯æ•°æ®ç»“æ„çš„æ•´ä½“ç»“æ„å›¾ï¼Œä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œä¸‹é¢æˆ‘å°†åˆ†åˆ«ä»‹ç»æ¯ä¸€éƒ¨åˆ†ï¼š</p><ul><li><p>pin controller:<br>pin controller ä¸»è¦æ˜¯æè¿°è¯¥ soc çš„æ‰€æœ‰å¼•è„šä¿¡æ¯ä»¥åŠä¸€ç³»åˆ—æ“ä½œå‡½æ•°é›†ã€‚è¯¥ç»“æ„é€šè¿‡ pinctrl_dev æ•°æ®ç»“æ„æ¥æè¿°ï¼Œè¯¥ç»“æ„ä½“ä¸»è¦æä¾›çš„åŠŸèƒ½æ˜¯ï¼šå°†æ­¤å¼•è„šæ§åˆ¶å™¨çš„æ¯ä¸ªå¼•è„šæè¿°ç¬¦ä¿å­˜åœ¨ radix_tree æ ‘ä¸­ï¼Œé€šè¿‡ struct pin_desc æ¥æè¿°è¯¥å¼•è„šæ§åˆ¶å™¨ï¼Œpin_desc é‡Œæœ‰æ§åˆ¶å™¨çš„æ¯ä¸ªå¼•è„šé…ç½®ä¿¡æ¯ä»¥åŠè®¿é—®åŠè®¾ç½®è¯¥å¼•è„šæ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ pctlopsã€pmxops å’Œ confopsï¼Œåˆ†åˆ«æ˜¯è®¿é—®æ§åˆ¶å™¨ä¸‹çš„ pin å’Œ group çš„æ–¹æ³•ã€è®¾ç½®å¤ç”¨åŠŸèƒ½å’Œè®¾ç½®é…ç½®å¼•è„šçš„æ“ä½œæ–¹æ³•ï¼Œè¿™ä¸ªä¸€èˆ¬ç”± soc åŸå‚æ¥æä¾›é©±åŠ¨</p></li><li><p>pinctrl_maps:<br>pinctrl_maps ä¸»è¦æ˜¯æè¿°æ¿çº§é…ç½®ä¿¡æ¯ï¼Œå¯¹äºä¸€å—å•æ¿ä¼šä½¿ç”¨çš„ soc çš„ä¸åŒæ§åˆ¶å™¨åŠä¸åŒé…ç½®ï¼Œå¯¹äºåŒä¸€ soc çš„ iic0 æ§åˆ¶å™¨åœ¨ä¸åŒå•æ¿ä¸Šå¯ä»¥æ¥åœ¨ä¸åŒçš„ pin group ä¸Šï¼Œè¿™å°±æ˜¯ pin çš„ç®¡è„šå¤ç”¨åŠŸèƒ½ã€‚åœ¨ dts ä¸­å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;uart0 {</span><br><span class="line">    pinctrl-names = <span class="string">"default"</span>,<span class="string">"sleep"</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;uart0_pins&gt;;</span><br><span class="line">    pinctrl<span class="number">-1</span> = &lt;&amp;uart0_sleep_pins&gt;;</span><br><span class="line">    status = <span class="string">"okay"</span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>pinctrl-0 å’Œ pinctrl-1 ç­‰ä¼šè¢«è§£ææˆä¸€ä¸ªä¸ªçš„ pinctrl_maps ç„¶åé€šè¿‡ pinctrl_register_mappings å‡½æ•°å°†æ¯ä¸€ä¸ªæ§åˆ¶å™¨ç”¨åˆ°çš„å¼•è„šä¿¡æ¯è¿™å†Œåˆ°å†…æ ¸ï¼Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡ä¸€ä¸ªé“¾è¡¨ç»„ç»‡æ•´ä¸ªå•æ¿ä¸Šæ§åˆ¶å™¨çš„å¼•è„šçŠ¶æ€ä¿¡æ¯</p></li><li><p>pinctrl:<br>pinctrl ä¸»è¦æ˜¯æè¿° client è®¾å¤‡ç®¡è„šçš„çŠ¶æ€å’Œä½¿ç”¨æƒ…å†µã€‚ä¾‹å¦‚å¯¹äº uartã€iicã€spi ç­‰è®¾å¤‡éƒ½éœ€è¦é€šè¿‡ pin ä¸å…¶ä»–è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆå°±éœ€è¦é…ç½® pin è¿æ¥åˆ°å¯¹åº”çš„å…·ä½“æ§åˆ¶å™¨ä»¥åŠé…ç½® pin çš„ä¸€äº›ç”µå™¨ç‰¹æ€§ï¼Œä¾‹å¦‚ä¸Šä¸‹æ‹‰ï¼Œé©±åŠ¨èƒ½åŠ›é€Ÿç‡ç­‰ä¿¡æ¯ã€‚è¯¥æ•°æ®ç»“æ„æ—¢ç„¶æ˜¯ client ç«¯çš„æ•°æ®é‚£ä¹ˆå°±éœ€è¦æŒ‚å…¥åˆ°è®¾å¤‡é©±åŠ¨æ¨¡å‹ç»“æ„ä¸­ï¼Œåœ¨ä¸Šå›¾å¯ä»¥çœ‹åˆ°è¯¥ç»“æ„å…ˆæ˜¯æŒ‚å…¥åˆ° dev_pin_info ç»“æ„ï¼Œç„¶å dev_pin_info åˆæ˜¯ struct device ç»“æ„çš„æˆå‘˜ï¼Œè¿™æ˜¯è¯¥ç»“æ„çš„ä¸ŠåŠéƒ¨åˆ†ï¼›ä¸‹åŠéƒ¨åˆ†æ˜¯çŠ¶æ€ä¿¡æ¯çš„æè¿°äº†é¦–å…ˆæ˜¯æŒ‚æ¥æ‰€æœ‰çš„çŠ¶æ€ä¾‹å¦‚ defaultã€sleep çŠ¶æ€ã€‚ç„¶åæ¯ä¸ªçŠ¶æ€ä¸‹å°±æ˜¯é…ç½®ä¿¡æ¯ï¼Œè¿™äº›é…ç½®ä¿¡æ¯æ¥è‡ªä¸Šé¢ä»‹ç»çš„ pinctrl_maps ç»“æ„ä½“ä¸­çš„æ•°æ®</p></li></ul><h1 id="å®ç°">å®ç°</h1><h2 id="pin-controller-çš„æ³¨å†Œ">Pin Controller çš„æ³¨å†Œ</h2><p>pin controller çš„æ³¨å†Œä¸»è¦è°ƒç”¨å§å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pinctrl_dev *<span class="title function_">pinctrl_register</span><span class="params">(<span class="keyword">struct</span> pinctrl_desc *pctldesc,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> device *dev, <span class="type">void</span> *driver_data)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°éœ€è¦æä¾›ä¸€ä¸ª pinctrl_desc ç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ª pinctrl_dev ç»“æ„ä½“ã€‚ç”±äºå‡½æ•°è°ƒç”¨å…³ç³»æ¯”è¾ƒç®€å•è¿™é‡Œå°±ä¸ç”»æµç¨‹å›¾äº†ã€‚è¿™é‡Œæœ€å…³é”®çš„æ˜¯ pinctrl_desc ç»“æ„ä½“ï¼šè¯¥ç»“æ„ä½“ç”¨äºæè¿°ä¸€ä¸ª soc pin controller çš„ä¿¡æ¯ï¼ŒåŒ…å«æ‰€æ”¯æŒçš„ pin å¼•è„šçš„æè¿°ï¼ˆæ¯ä¸€ä¸ªå¼•è„šçš„åç§°ä¸ indexï¼‰ã€pin å¤ç”¨æ“ä½œçš„æ¥å£ï¼ˆä¸»è¦æ˜¯ struct pinmux_ops ç±»å‹çš„å˜é‡ï¼ŒåŒ…å«å¼•è„šçš„ç”³è¯·ä¸é‡Šæ”¾ã€gpio å¼•è„šå¤ç”¨é…ç½®ä»¥åŠæ–¹å‘è®¾ç½®æ¥å£ç­‰ï¼‰ã€pin å¼•è„šæˆ– group ç›¸å…³çš„å¼•è„šé…ç½®æ¥å£ï¼ˆåŒ…å«å¼•è„šé…ç½®æ¥å£ã€å¼•è„šå½“å‰é…ç½®å‚æ•°è·å–æ¥å£ã€group ç›¸å…³å¼•è„šçš„é…ç½®æ¥å£ã€debug æ¥å£ç­‰ï¼‰ã€group ç›¸å…³çš„æ“ä½œæ¥å£ï¼ˆè·å– group çš„ä¸ªæ•°ã€è·å– group çš„åç§°ã€è·å– group å¯¹åº”çš„å¼•è„šå†…å®¹ã€ä»è®¾å¤‡æ ‘è®¾å¤‡èŠ‚ç‚¹ä¸­è§£æ board pin æè¿°ä¿¡æ¯å¹¶è¿›è¡Œ pinctrl map æ³¨å†Œçš„æ¥å£ dt_node_to_mapï¼‰ã€‚ç„¶å pinctrl_register å‡½æ•°å°±æ˜¯åˆ›å»ºä¸€ä¸ª pinctrl_dev ç»“æ„ä½“ç„¶åè®¾ç½®ç›¸å…³æˆå‘˜å˜é‡å¹¶å¯¹ pinctrl_desc ç»“æ„ä½“ä¸­æä¾›çš„ä¸€äº›å‡½æ•°æ“ä½œåšæ£€æŸ¥ï¼ˆå¿…é¡»æä¾›å‡½æ•°å®ç°ï¼‰ï¼Œå†å°† pinctrl_dev é“¾å…¥ pinctrldev_list å…¨å±€é“¾è¡¨ä¸­å³å¯ã€‚</p><p>devm_pinctrl_register æ˜¯ pinctrl_register çš„èµ„æºç®¡ç†ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯è°ƒç”¨ pinctrl_register å®ç°çš„ï¼š</p><h2 id="pinctrl-map-æ³¨å†Œ">Pinctrl Map æ³¨å†Œ</h2><p>pinctrl map çš„æ³¨å†Œå‡½æ•°æ˜¯ pinctrl_register_mappingsï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pinctrl_register_mappings</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> pinctrl_map *maps,</span></span><br><span class="line"><span class="params">      <span class="type">unsigned</span> num_maps)</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œéœ€è¦æä¾›ä¸€ä¸ªéœ€è¦æ³¨å†Œåˆ°å†…æ ¸çš„ pinctrl_map ç»“æ„ä½“ï¼Œç„¶å pinctrl_register_mappings å‡½æ•°å°±å¯¹è¯¥ç»“æ„ä½“è¿›è¡Œ checkï¼Œç„¶åå°†å…¶æŒ‚åœ¨ pinctrl_maps é“¾è¡¨ä¸Šã€‚</p><h2 id="bing-è¿‡ç¨‹">Bing è¿‡ç¨‹</h2><p>åœ¨å‰é¢æåˆ°äº† client é‡Œä¼šé€šè¿‡è®¾å¤‡æ ‘è·å¾—ä¸€ä¸ªä¸ªçš„ pinctrl_maps ç»“æ„ï¼Œè€Œè¯¥ç»“æ„æ˜¯è¦æ ¹ pin controller é‡Œçš„ pin ä¹‹é—´å»ºç«‹è”ç³»çš„ï¼Œå› ä¸ºä¸åŒçš„ soc pin è„šçš„è®¾è®¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…¶é…ç½®æ–¹æ³•ä¹Ÿä¸ä¸€æ ·ï¼Œè€Œåœ¨æ§åˆ¶å™¨åˆå§‹åŒ–é˜¶æ®µéœ€è¦è§£æå‡ºè¯¥æ§åˆ¶å™¨æ‰€ä½¿ç”¨çš„ pin è„šç„¶åä¸ controller æä¾›çš„ pin è„šå»ºç«‹è”ç³»é€šè¿‡ controller çš„ pin æˆ– group æ“ä½œå‡½æ•°é›†æ¥æ“ä½œå…·ä½“çš„ pin é…ç½®ä¸ºæƒ³è¦çš„åŠŸèƒ½ã€‚</p><p>åœ¨å‰é¢ä»‹ç»è®¾å¤‡é©±åŠ¨æ¨¡å‹çš„æ—¶å€™æœ‰ä¸€å¼  device æ³¨å†Œè¿‡ç¨‹çš„æµç¨‹å›¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯åœ¨ driver_probe_device çš„æ—¶å€™ä¼šè°ƒç”¨ really_probe å‡½æ•°ï¼Œè€Œ really_probe å‡½æ•°åˆä¼šè°ƒç”¨ pinctrl_bind_pins å‡½æ•°ç”¨æ¥å¤„ç† pinctrl ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxMTY4ODc1N2Q5YzA4MDZlNGFlZmUzOS5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/DeviceRegister.png"></p><p>ä¸‹é¢æˆ‘ä»¬å°†å…¶ä¸­çš„ pinctrl å¤„ç†è¿‡ç¨‹è¡¥å……å®Œï¼Œpinctrl_bind_pins å‡½æ•°å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU4ZTExZTA4NTMwNmQ3NDFhNjE3">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PinCtrlBingPin.png"></p><p>è¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><ul><li>è§£æè®¾å¤‡æ ‘ï¼Œè§£æ client è®¾å¤‡çš„ pinctrl çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶åˆ›å»ºç›¸å…³ç»“æ„</li><li>é€šè¿‡è®¾å¤‡æ ‘ä¸­çš„ pinctrl çš„ phandle æ‰¾åˆ° controller é…ç½®ä¸­çš„ pinï¼Œå¹¶å°†è®¾å¤‡æ ‘ä¸­çš„æ¯ä¸€ä¸ªçŠ¶æ€è½¬æ¢ä¸º map ç»“æ„ï¼Œè¿™é‡Œç”±äºä¸åŒçš„ soc å…³äº pinctrl çš„è®¾å¤‡æ ‘å†™æ³•ä¸ä¸€è‡´å› æ­¤è¿™é‡Œé€šè¿‡ controller æä¾›çš„å›è°ƒå‡½æ•° dt_node_to_map è½¬æ¢ä¸º map ç»“æ„ï¼ˆå…·ä½“çš„ soc æœ‰è‡ªå·±çš„å®ç°è‡ªç„¶çŸ¥é“è½¬æ¢æ–¹æ³•ï¼‰å¹¶å°†ä¸€ç³»åˆ—çš„ map è½¬æ¢ä¸ºä¸€ç³»åˆ—çš„ä¸ map å¯¹åº”çš„ setting ç»“æ„</li><li>å¯¹æ¯ä¸€ä¸ª map ç»“æ„è¿›è¡Œ pinmux å’Œ pinconf çš„è®¾ç½®ï¼ŒåŒæ ·è®¾ç½®å‡½æ•°ä¹Ÿæ˜¯ç”±å…·ä½“çš„ controller æä¾›å®ç°ï¼Œç„¶åé€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨å…·ä½“çš„å®ç°</li></ul><h1 id="ä¸-gpio-çš„å…³ç³»">ä¸ gpio çš„å…³ç³»</h1><p>åŸåˆ™ä¸Š gpio å­ç³»ç»Ÿæ˜¯ pinctrl çš„ client ç”¨æˆ·ï¼Œgpio å’Œ iicã€spi è¿™äº›ä¸€æ ·ä¼šé€šè¿‡ pinctrl æ¥é…ç½®ï¼Œä½†æ˜¯å®é™…ä¸Š gpio å’Œ pinctrl ä¹‹é—´æœ‰æ›´ä¸ºç´§å¯†çš„è”ç³»ï¼Œå¦‚æœé€šè¿‡ soc çš„ datasheet æˆ‘ä»¬ä¹Ÿå¯ä»¥äº†è§£åˆ°å®é™…çš„ soc ä¸­å¹¶æ²¡æœ‰å…·ä½“çš„ pin controller ç¡¬ä»¶ï¼Œè¿™ä¸ªä¸€èˆ¬éƒ½åœ¨ gpio çš„ç« èŠ‚ä¸­ä»‹ç»ï¼Œä¸ gpio çš„å¯„å­˜å™¨ä¹‹é—´æ˜¯å¯†ä¸å¯åˆ†çš„ã€‚è¿™é‡Œå…³äº gpio å’Œ pinctrl ä¹‹é—´çš„å…³ç³»å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvZ3Bpb19zdWJzeXN0ZW0vcGluY3RybC1hbmQtZ3Bpby5odG1s">çªçªç§‘æŠ€<i class="fa fa-external-link-alt"></i></span> çš„æ–‡ç« ã€‚</p><h2 id="pinctrl-å’Œ-gpio-ä¹‹é—´çš„å¼ºè€¦åˆå®ç°">pinctrl å’Œ gpio ä¹‹é—´çš„å¼ºè€¦åˆå®ç°</h2><p>é¦–å…ˆè¿˜æ˜¯çœ‹ä¸‹ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU5MWIwZTNlNzQwNmUyMDI0NjIz">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/GPIO2Pinctrl.png"></p><p>gpio å’Œ pinctrl é€šè¿‡ gpio_pin_range å»ºç«‹æ˜ å°„å…³ç³»ï¼Œå°† gpio ä¸­çš„ pin æè¿°è½¬æ¢åˆ° pinctrl ä¸­çš„ pin æè¿°ç©ºé—´ï¼Œä»è€Œå°†ä¸¤è€…å»ºç«‹å…³è”ï¼Œè¿™æ · gpio å°±å¯ä»¥ä¸é€šè¿‡ pinctrl æä¾›çš„æ ‡å‡†æ¥å£æ¥è®¾ç½® pin çš„å¤ç”¨å’Œé…ç½®äº†ã€‚gpio_pin_range è¿™ä¸ªæè¿°å…³ç³»é€šè¿‡ dts æ–‡ä»¶æ¥æè¿°ï¼Œè¿™æ ·å°±å¯ä»¥ä¸é€šè¿‡ä»£ç å°†ä»–ä»¬å»ºç«‹è”ç³»ï¼Œå†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qe_pio_e: gpio-controller@<span class="number">1460</span> {</span><br><span class="line">    <span class="meta">#gpio-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line">    compatible = <span class="string">"fsl,qe-pario-bank-e"</span>, <span class="string">"fsl,qe-pario-bank"</span>;</span><br><span class="line">    gpio-controller;</span><br><span class="line">    gpio-ranges = &lt;&amp;pinctrl1 <span class="number">0</span> <span class="number">20</span> <span class="number">10</span>&gt;, &lt;&amp;pinctrl2 <span class="number">10</span> <span class="number">50</span> <span class="number">20</span>&gt;;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ dts èŠ‚ç‚¹ä¸­çš„ gpio-ranges å…³é”®å­—æŒ‡å®šäº†ä¸¤ä¸ª gpio rangeï¼šgpio controller(qe_pio_e) ä¸­çš„ gpio0 ~ 9 å’Œ pinctrl1 ä¸­çš„ pin20 ~ 29 å¯¹åº”ï¼›gpio controller(qe_pio_e) ä¸­çš„ gpio10 ~ 29 å’Œ pinctrl2 ä¸­çš„ pin50 ~ 69 å¯¹åº”ã€‚ è€Œ dts æ–‡ä»¶çš„è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU5M2NlNDAxZmQzYzI0OWUyZjQx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/gpiochip_add_data.png"></p><p>ä»¥ä¸Šè¿‡ç¨‹å°†ç”Ÿæˆ pinctrl_dev ä¸‹ç”± gpio_ranges ç»„ç»‡æˆçš„é“¾è¡¨ã€‚</p><p>ä¸‹é¢ä»¥ gpiod_get å‡½æ•°ä¸ºä¾‹çœ‹ä¸€ä¸‹ gpio ä¸­å…·ä½“æ˜¯å¦‚ä½•ä½¿ç”¨ pinctrl ä¸­çš„æ¥å£çš„ï¼Œgpiod_get å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU5NTZlNDAxZmQzYzI0OWUyZjVk">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/gpiod_get.png"></p><p>è¯¥å‡½æ•°å°±æ˜¯å°† gpio ä¸­çš„ pin æè¿°è½¬æ¢åˆ° pinctrl ä¸­çš„æè¿°ï¼Œè¿›è€Œæ‰¾åˆ°è¯¥ç®¡è„šåœ¨ pinctrl ä¸­çš„æè¿°ç„¶åè°ƒç”¨ pin controller æä¾›çš„å‡½æ•°æ¥è®¾ç½®å¼•è„šå¤ç”¨åŠŸèƒ½å’Œé…ç½®å¼•è„šã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDY2Nzc3ODE=">https://blog.csdn.net/lickylin/article/details/106677781<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpY2t5bGluL2FydGljbGUvZGV0YWlscy8xMDY2Nzc4NTE/c3BtPTEwMDEuMjAxNC4zMDAxLjU1MDE=">https://blog.csdn.net/lickylin/article/details/106677851?spm=1001.2014.3001.5501<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9ncGlvX3N1YnN5c3RlbQ==">çªçªç§‘æŠ€ gpio å­ç³»ç»Ÿç›¸å…³æ–‡ç« <i class="fa fa-external-link-alt"></i></span><br>ã€ŠéŸ¦ä¸œå±±è€å¸ˆçš„ä¹¦ç±å’Œè¯¾ç¨‹ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ GPIO å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverGPIO/"/>
      <url>/2020/LinuxDriver/LinuxDriverGPIO/</url>
      
        <content type="html"><![CDATA[<h1 id="gpio-æ¦‚è¿°">GPIO æ¦‚è¿°</h1><p>ä»¥å‰å­¦ä¹  stm32 çš„æ—¶å€™çœ‹åˆ°æ‰‹å†Œé‡Œæœ‰å…³äº gpio çš„ç”µè·¯å›¾ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/gpio.png"></p><ul><li><p>ä¿æŠ¤äºŒæä½“ï¼š<br>IO å¼•è„šä¸Šä¸‹ä¸¤è¾¹ä¸¤ä¸ªäºŒæä½“ç”¨äºé˜²æ­¢å¼•è„šå¤–éƒ¨è¿‡é«˜ã€è¿‡ä½çš„ç”µå‹è¾“å…¥ã€‚å½“å¼•è„šç”µå‹é«˜äº VDD æ—¶ï¼Œä¸Šæ–¹çš„äºŒæä½“å¯¼é€šï¼›å½“å¼•è„šç”µå‹ä½äº VSS æ—¶ï¼Œä¸‹æ–¹çš„äºŒæä½“å¯¼é€šï¼Œé˜²æ­¢ä¸æ­£å¸¸ç”µå‹å¼•å…¥æ™¶ç‰‡å¯¼è‡´æ™¶ç‰‡çƒ§æ¯</p></li><li><p>P-MOS ç®¡å’Œ N-MOS ç®¡ï¼š<br>ç”± P-MOS ç®¡å’Œ N-MOS ç®¡ç»„æˆçš„å•å…ƒç”µè·¯ä½¿å¾— GPIO å…·æœ‰â€œæ¨æŒ½è¾“å‡ºâ€å’Œâ€œå¼€æ¼è¾“å‡ºâ€çš„æ¨¡å¼</p></li><li><p>TTL è‚–ç‰¹åŸºè§¦å‘å™¨ï¼š<br>ä¿¡å·ç»è¿‡è§¦å‘å™¨åï¼Œæ¨¡æ‹Ÿä¿¡å·è½¬åŒ–ä¸º 0 å’Œ 1 çš„æ•°å­—ä¿¡å·ã€‚ä½†æ˜¯ï¼Œå½“ GPIO å¼•è„šä½œä¸º ADC é‡‡é›†ç”µå‹çš„è¾“å…¥é€šé“æ—¶ï¼Œç”¨å…¶â€œæ¨¡æ‹Ÿè¾“å…¥â€åŠŸèƒ½ï¼Œæ­¤æ—¶ä¿¡å·ä¸å†ç»è¿‡è§¦å‘å™¨è¿›è¡Œ TTL ç”µå¹³è½¬æ¢ã€‚ADC å¤–è®¾è¦é‡‡é›†åˆ°çš„åŸå§‹çš„æ¨¡æ‹Ÿä¿¡å·</p></li></ul><span id="more"></span><p>STM32 çš„ GPIO æ”¯æŒ 4 ç§è¾“å…¥æ¨¡å¼ï¼ˆæµ®ç©ºè¾“å…¥ã€ä¸Šæ‹‰è¾“å…¥ã€ä¸‹æ‹‰è¾“å…¥ã€æ¨¡æ‹Ÿè¾“å…¥ï¼‰å’Œ 4 ç§è¾“å‡ºæ¨¡å¼ï¼ˆå¼€æ¼è¾“å‡ºã€å¼€æ¼å¤ç”¨è¾“å‡ºã€æ¨æŒ½è¾“å‡ºã€æ¨æŒ½å¤ç”¨è¾“å‡ºï¼‰</p><ul><li><p>æµ®ç©ºè¾“å…¥æ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/floatin.png"></p></li><li><p>ä¸Šæ‹‰è¾“å…¥æ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/pullupin.png"></p></li><li><p>ä¸‹æ‹‰è¾“å…¥æ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/pulldownin.png"></p></li><li><p>æ¨¡æ‹Ÿè¾“å…¥æ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/ain.png"></p></li><li><p>å¼€æ¼è¾“å‡ºæ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/openout.png"></p></li></ul><p>å¼€æ¼è¾“å‡ºæ¨¡å¼ä¸‹ï¼Œé€šè¿‡è®¾å®šä½è®¾å®š/æ¸…é™¤å¯„å­˜å™¨æˆ–è€…è¾“å‡ºå¯„å­˜å™¨çš„å€¼ï¼Œé€”ç» N-MOS ç®¡ï¼Œæœ€ç»ˆè¾“å‡ºåˆ° I/O å£ã€‚è¿™é‡Œè¦æ³¨æ„ N-MOS ç®¡ï¼Œå½“è®¾å®šè¾“å‡ºçš„å€¼ä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒN-MOS ç®¡å¤„äºå…³é—­çŠ¶æ€ï¼Œæ­¤æ—¶ I/O å£çš„ç”µå¹³å°±ä¸ä¼šç”±è¾“å‡ºçš„é«˜ä½ç”µå¹³å†³å®šï¼Œè€Œæ˜¯ç”± I/O å£å¤–éƒ¨çš„ä¸Šæ‹‰æˆ–è€…ä¸‹æ‹‰å†³å®šï¼›å½“è®¾å®šè¾“å‡ºçš„å€¼ä¸ºä½ç”µå¹³çš„æ—¶å€™ï¼ŒN-MOS ç®¡å¤„äºå¼€å¯çŠ¶æ€ï¼Œæ­¤æ—¶ I/O å£çš„ç”µå¹³å°±æ˜¯ä½ç”µå¹³ã€‚åŒæ—¶ï¼ŒI/O å£çš„ç”µå¹³ä¹Ÿå¯ä»¥é€šè¿‡è¾“å…¥ç”µè·¯è¿›è¡Œè¯»å–ï¼›æ³¨æ„ï¼ŒI/O å£çš„ç”µå¹³ä¸ä¸€å®šæ˜¯è¾“å‡ºçš„ç”µå¹³ã€‚</p><ul><li>å¼€æ¼å¤ç”¨è¾“å‡ºæ¨¡å¼ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/openflexout.png"></li></ul><h1 id="gpio-é©±åŠ¨ä¸­å‡ ä¸ªæ¦‚å¿µ">GPIO é©±åŠ¨ä¸­å‡ ä¸ªæ¦‚å¿µ</h1><ul><li><p>Active-High and Active-Low<br>ä»¥ LED ä¸ºä¾‹ï¼Œéœ€è¦è®¾ç½® GPIO ç”µå¹³ã€‚ä½†æ˜¯æœ‰äº›ç”µè·¯å¯èƒ½æ˜¯é«˜ç”µå¹³ç‚¹äº® LEDï¼Œæœ‰äº›æ˜¯ä½ç”µå¹³ç‚¹äº® LEDã€‚</p><p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpiod_set_value(gpio, <span class="number">1</span>);  <span class="comment">// è¾“å‡ºé«˜ç”µå¹³ç‚¹äº® LED</span></span><br><span class="line">gpiod_set_value(gpio, <span class="number">0</span>);  <span class="comment">// è¾“å‡ºä½ç”µå¹³ç‚¹äº® LED</span></span><br></pre></td></tr></tbody></table></figure><p>å¯¹åº”åŒä¸€ä¸ªç›®æ ‡ï¼šç‚¹äº® LEDï¼Œå¯¹äºä¸åŒçš„ LEDï¼Œå°±éœ€è¦ä¸åŒçš„ä»£ç ï¼ŒåŸå› åœ¨äºä¸Šé¢çš„ä»£ç ä¸­ 1ã€0 è¡¨ç¤ºçš„æ˜¯"ç‰©ç†å€¼"ã€‚</p><p>å¦‚æœèƒ½ä½¿ç”¨"é€»è¾‘å€¼"ï¼ŒåŒæ ·çš„é€»è¾‘å€¼åœ¨ä¸åŒçš„é…ç½®ä¸‹è¾“å‡ºå¯¹åº”çš„ç‰©ç†å€¼ï¼Œå°±å¯ä»¥ä¿æŒä»£ç ä¸€è‡´ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gpiod_set_value(gpio, <span class="number">1</span>);  <span class="comment">// è¾“å‡ºé€»è¾‘ 1</span></span><br><span class="line">                           <span class="comment">// åœ¨ Active-High çš„æƒ…å†µä¸‹å®ƒä¼šè¾“å‡ºé«˜ç”µå¹³</span></span><br><span class="line">                           <span class="comment">// åœ¨ Active-Low çš„æƒ…å†µä¸‹å®ƒä¼šè¾“å‡ºä½ç”µå¹³</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>Open Drain and Open Source: æœ‰å¤šä¸ª GPIO åŒæ—¶é©±åŠ¨ä¸€ä¸ªç”µè·¯æ—¶ï¼Œå°±éœ€è¦è®¾ç½® Open Drain æˆ– Open Source</p><ul><li>Open Drainï¼šå¼•è„šè¢«è®¾ç½®ä¸ºä½ç”µå¹³æ—¶æ‰ä¼šé©±åŠ¨ç”µè·¯ï¼Œå…¸å‹åœºæ™¯æ˜¯ I2C æ¥å£ã€‚</li><li>Open Sourceï¼šå¼•è„šè¢«è®¾ç½®ä¸ºé«˜ç”µå¹³æ—¶æ‰ä¼šé©±åŠ¨ç”µè·¯ã€‚</li></ul></li></ul><h1 id="gpio-æ•°æ®ç»“æ„">GPIO æ•°æ®ç»“æ„</h1><p>è¦ç†è§£ä¸€ä¸ªé©±åŠ¨æ¡†æ¶çš„è®¾è®¡å°±ä¸€å®šè¦ç†æ¸…æ¥šè¯¥æ¡†æ¶ä¸‹çš„æ•°æ®ç»“æ„ç»„ç»‡å…³ç³»ï¼Œé¦–å…ˆåˆ—å‡º gpio å­ç³»ç»Ÿçš„æ•°æ®ç»“æ„å…³ç³»å›¾å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU2OGI1NjUzYmI2NDkzMGMxOTFj">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/GPIO_Struct.png"></p><ul><li><p>gpio_chip: gpio_chip è¿™ä¸ªæ•°æ®ç»“æ„ç”¨äºæè¿°ä¸€ç»„ gpioï¼Œsoc é‡Œçš„ gpio ä¸€èˆ¬éƒ½æ˜¯åˆ†ä¸ºå‡ ç»„ï¼ŒåŒä¸€ç»„å†…çš„ gpio å…·æœ‰ç›¸åŒçš„æ“ä½œæ–¹å¼</p></li><li><p>gpio_device: gpio_device æ˜¯å…·ä½“çš„ device å®ƒç®¡ç†ä¸€ä¸ª gpio_chip å’Œè¯¥ç»„ä¸‹çš„æ‰€æœ‰ pinã€‚gpio_device é€šè¿‡é“¾è¡¨è¿æ¥èµ·æ¥å°±æ˜¯ soc å†…çš„å¤šç»„ gpio</p></li><li><p>gpio_desc: gpio_desc è¿™ä¸ªç»“æ„ç”¨äºæè¿°ä¸€ä¸ª pinï¼Œä¸€ç»„ gpio é‡Œé¢æœ‰ 32 ä¸ª pin æˆ–è€…å¤šä¸ª pinï¼Œæ¯ä¸€ä¸ª pin ç”± gpio_desc æè¿°ï¼ŒåŒä¸€ç»„çš„ pin æŒ‚è½½åœ¨ gpio_device ä¸‹</p></li></ul><h1 id="gpio-å­ç³»ç»Ÿçš„å±‚æ¬¡å’Œæ¥å£">GPIO å­ç³»ç»Ÿçš„å±‚æ¬¡å’Œæ¥å£</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/gpio_system_level.png"></p><p>ç¡¬ä»¶å±‚ä¹‹ä¸Šæ˜¯ soc åŸå‚æä¾›çš„ gpio controller é©±åŠ¨è¿™éƒ¨åˆ†æä¾›äº†å…·ä½“ soc çš„ pin è„šçš„æè¿°å’Œæ§åˆ¶æ¥å£ï¼Œåœ¨è¿™ä¹‹ä¸Šæ˜¯ gpiolib å±‚ä¸ºå…¶ä»–é©±åŠ¨ç¨‹åºæä¾›ç»Ÿä¸€çš„æ¥å£æ¥é…ç½®å’Œæ§åˆ¶ gpioï¼Œå†å¾€ä¸Šå°±æ˜¯å…¶ä»–é©±åŠ¨ç¨‹åºä½¿ç”¨ gpio çš„æ¥å£å®Œæˆä»–ä»¬æƒ³è¦çš„å·¥ä½œã€‚å½“ç„¶åœ¨ gpiolib ä¹‹ä¸‹è¿˜ä¼šä½¿ç”¨ pinctrl å­ç³»ç»Ÿæ¥ç®¡ç† pin çš„åŠŸèƒ½å¤ç”¨ä¸é…ç½®ï¼Œè¿™ä¸ªåœ¨ pinctrl ä¸€ç¯‡æ–‡ç« é‡Œå†è¯¦ç»†è¯´æ˜ã€‚</p><h1 id="å®ç°">å®ç°</h1><p>gpio_chip æ˜¯æè¿°ä¸€ä¸ª gpio æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„ï¼Œå°†ä¸€ä¸ª gpio æ§åˆ¶å™¨æ·»åŠ åˆ°ç³»ç»Ÿä¸­çš„æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU2Y2YwNzkxMjkwNmIyYTQ0ZGEx">åŸå›¾<i class="fa fa-external-link-alt"></i></span><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/GPIO_CHIP_ADD.png"></p><p>å¯¹äº gpio é©±åŠ¨ä¸€èˆ¬ç”±åŸå‚å†™å¥½ï¼Œå…¶ä»–é©±åŠ¨å·¥ç¨‹å¸ˆä¸éœ€è¦ç¼–å†™å…·ä½“é©±åŠ¨ï¼Œéœ€è¦çš„æ—¶å€™ç›´æ¥åœ¨ dts é‡Œé…ç½®å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å…¶ä¸­ gpio_chip ç»“æ„ä½“çš„æ³¨å†Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ¯ä¸ª gpio_chip éƒ½éœ€è¦ä¸€ä¸ª gpio_device ç»“æ„ï¼Œè¦å…ˆåˆ†é…ä¸€ä¸ª gpio_device ç»“æ„ä½“ï¼Œç„¶åå°±æ˜¯å¤„ç†è¯¥ç»„ä¸‹çš„ pinï¼Œä»¥åŠå„ç§ä¸­æ–­ä¿¡æ¯ã€‚</p><h1 id="sysfs-æ¥å£">sysfs æ¥å£</h1><p><code>/sys/bus/gpio/devices</code>ç›®å½•ä¸‹ï¼Œåˆ—å‡ºäº†æ‰€æœ‰çš„ GPIO æ§åˆ¶å™¨ <code>/sys/class/gpio/gpiochipXXX</code>ä¸‹æœ‰æ¯ä¸ª GPIO æ§åˆ¶å™¨çš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/sys/class/gpio/gpiochip508]# </span><span class="language-bash"><span class="built_in">ls</span> -1</span></span><br><span class="line">base     // è¿™ä¸ª GPIO æ§åˆ¶å™¨çš„ GPIO ç¼–å·</span><br><span class="line">device</span><br><span class="line">label    // åå­—</span><br><span class="line">ngpio    // å¼•è„šä¸ªæ•°</span><br><span class="line">power</span><br><span class="line">subsystem</span><br><span class="line">uevent</span><br></pre></td></tr></tbody></table></figure><p>æŸ¥çœ‹ gpio ä½¿ç”¨æƒ…å†µï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/debug/gpio</span><br></pre></td></tr></tbody></table></figure><p>å¯¼å‡º/è®¾ç½®æ–¹å‘/è¯»å†™å€¼ï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo 509 &gt; /sys/class/gpio/export</span><br><span class="line">echo out &gt; /sys/class/gpio/gpio509/direction</span><br><span class="line">echo 1 &gt; /sys/class/gpio/gpio509/value</span><br><span class="line">echo 509 &gt; /sys/class/gpio/unexport</span><br><span class="line"></span><br><span class="line">echo 509 &gt; /sys/class/gpio/export</span><br><span class="line">echo in &gt; /sys/class/gpio/gpio509/direction</span><br><span class="line">cat /sys/class/gpio/gpio509/value</span><br><span class="line">echo 509 &gt; /sys/class/gpio/unexport</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly9pdGVyMDEuY29tLzUzOTA0MS5odG1s">https://iter01.com/539041.html<i class="fa fa-external-link-alt"></i></span><br>ã€ŠéŸ¦ä¸œå±±è€å¸ˆçš„ä¹¦ç±å’Œè¯¾ç¨‹ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ SPI å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverSPI/"/>
      <url>/2020/LinuxDriver/LinuxDriverSPI/</url>
      
        <content type="html"><![CDATA[<h1 id="linux-spi-é©±åŠ¨æ¡†æ¶">Linux SPI é©±åŠ¨æ¡†æ¶</h1><p>å¯¹äº SPI çš„é©±åŠ¨æ¡†æ¶ä¸ I2C æ˜¯å¤§è‡´ä¸€è‡´çš„ï¼Œä¹Ÿåˆ†ä¸ºä¸¤å±‚ï¼Œæ§åˆ¶å™¨é©±åŠ¨ç¨‹åºå±‚å« spi_controller ï¼Œä¸»è¦æä¾› transfer å‡½æ•°ï¼Œè¿›è¡Œ spi åè®®çš„æ”¶å‘ã€‚</p><p>å¦ä¸€å±‚æ˜¯è®¾å¤‡é©±åŠ¨å±‚ï¼ŒåŸºäº spi_bus_typeï¼Œåœ¨ driver é‡Œåˆ™ä½¿ç”¨ spi_readã€spi_writer ç­‰å‡½æ•°ï¼Œæœ€ç»ˆä¹Ÿä¼šè°ƒç”¨åˆ° controller-&gt;transfer å‡½æ•°è¿›è¡Œå‘é€æ¥æ”¶ã€‚</p><span id="more"></span><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>æ•´ä½“æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTU0NzQ2Mzc2ODkyMWZhMjUwYTJk">åŸå›¾<i class="fa fa-external-link-alt"></i></span><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/SPI_Struct.png"></p><ul><li>spi_controller ç»“æ„ä½“ç”¨äºæè¿°ä¸€ä¸ª spi æ§åˆ¶å™¨ï¼Œå¯ä»¥ç±»æ¯” iic çš„ i2c_adaptã€‚</li><li>spi_device ç»“æ„ä½“ç”¨äºæè¿°ä¸€ä¸ª spi è®¾å¤‡ï¼Œå¯ä»¥ç±»æ¯”äº i2c_client ç»“æ„ä½“ã€‚</li></ul><p>spi_device ç»“æ„é‡Œæœ‰ä¸ª mode å¾ˆé‡è¦ä¸‹é¢æ˜¯å…¶è¯¦ç»†æè¿°ï¼ŒSPI æ¨¡å¼ä¸»è¦æœ‰ä¸¤ä¸ªç‰¹å¾ï¼š</p><ul><li>CPOLï¼šè¿™æ˜¯æ—¶é’Ÿææ€§ï¼š<ul><li>0ï¼šåˆå§‹æ—¶é’ŸçŠ¶æ€ä¸ºä½ç”µå¹³ï¼Œç¬¬ä¸€ä¸ªæ—¶é’Ÿè¾¹æ²¿æ˜¯ä¸Šå‡æ²¿<br></li><li>1ï¼šåˆå§‹æ—¶é’ŸçŠ¶æ€ä¸ºé«˜ç”µå¹³ï¼Œç¬¬ä¸€ä¸ªæ—¶é’Ÿè¾¹æ²¿æ˜¯ä¸‹é™æ²¿</li></ul></li><li>CPHAï¼šè¿™æ˜¯æ—¶é’Ÿç›¸ä½ï¼Œé€‰æ‹©åœ¨å“ªä¸ªè¾¹æ²¿é‡‡æ ·æ•°æ®ï¼š<ul><li>0ï¼šæ•°æ®åœ¨ä¸‹é™æ²¿é”å­˜ï¼Œè¾“å‡ºåœ¨ä¸Šå‡æ²¿æ”¹å˜<br></li><li>1ï¼šæ•°æ®åœ¨ä¸Šå‡æ²¿é”å­˜ï¼Œå¹¶åœ¨ä¸‹é™æ²¿è¾“å‡º</li></ul></li></ul><p>è¿™æœ‰å››ç§ SPI æ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/spi4mode.png"></p><ul><li>spi_driver ç”¨äºé©±åŠ¨ spi è®¾å¤‡ï¼Œå¯ä»¥ç±»æ¯” i2c_driver ç»“æ„ä½“ã€‚</li><li>spi_message ç”¨äºæè¿° spi ä¼ è¾“çš„æ¶ˆæ¯ï¼Œç”±å¤šä¸ª spi_transfer æ®µç»„æˆï¼Œå¯ä»¥ç±»æ¯” i2c_message ç»“æ„ä½“ã€‚</li><li>spi_transfer ä»£è¡¨ä¸€ä¸ªè¯»å†™ç¼“å†²å¯¹ï¼ŒåŒ…å«æ¥æ”¶ç¼“å†²åŒºåŠå‘é€ç¼“å†²åŒºï¼Œå…¶å®ï¼Œspi_transfer çš„å‘é€æ˜¯é€šè¿‡æ„å»º spi_message å®ç°ï¼Œé€šè¿‡å°† spi_transfer ä¸­çš„é“¾ transfer_list é“¾æ¥åˆ° spi_message ä¸­çš„ transfersï¼Œå†ä»¥ spi_message å½¢åŠ¿å‘åº•å±‚å‘é€æ•°æ®ã€‚</li></ul><h2 id="å®ç°">å®ç°</h2><p>å…³äº spi çš„å®ç°å…¶å®ä¹Ÿæ˜¯åˆ†ä¸º controller å’Œè®¾å¤‡åŠè®¾å¤‡é©±åŠ¨è¿™ä¸‰éƒ¨åˆ†ï¼Œcontroller ä¸€èˆ¬ç”± soc å‚å•†ç¼–å†™å¥½äº†é©±åŠ¨é€šè¿‡ spi_register_controller å‘å†…æ ¸æ³¨å†Œä¸€ä¸ª controller è®¾å¤‡å¹¶æŒ‚è½½åœ¨ spi_bus æ€»çº¿ä¸‹ï¼Œè€Œ device å’Œ device_driver çš„å®ç°æ ¹ platform æˆ– iic çš„å®ç°ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œè¿™é‡Œä¸åšè¯¦ç»†çš„åˆ†æäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹å†…æ ¸æºç ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cud2lraXdhbmQuY29tL3poLWNuLyVFNSVCQSU4RiVFNSU4OCU5NyVFNSU5MSVBOCVFOSU4MiU4QSVFNCVCQiU4QiVFOSU5RCVBMg==">https://www.wikiwand.com/zh-cn/%E5%BA%8F%E5%88%97%E5%91%A8%E9%82%8A%E4%BB%8B%E9%9D%A2<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpenVvYmluMi9hcnRpY2xlL2RldGFpbHMvNTE3MzU5NjM=">https://blog.csdn.net/lizuobin2/article/details/51735963<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3V0YW9wb3dlci9hcnRpY2xlL2RldGFpbHMvOTk4NjY3NzM=">https://blog.csdn.net/zhoutaopower/article/details/99866773<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ PWM</title>
      <link href="/2020/LinuxDriver/LinuxDriverPWM/"/>
      <url>/2020/LinuxDriver/LinuxDriverPWM/</url>
      
        <content type="html"><![CDATA[<h1 id="pwm-æ¦‚è¿°">PWM æ¦‚è¿°</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PWM.png"></p><ul><li>Tonï¼šä¿¡å·é«˜ç”µå¹³æŒç»­æ—¶é—´</li><li>Toffï¼šä¿¡å·åº•ç”µå¹³æŒç»­æ—¶é—´</li><li>Periodï¼š å®Œæ•´ pwm å‘¨æœŸ</li><li>Duty cycleï¼špwm ä¿¡å·å‘¨æœŸå†…ä¿æŒä¸º ON çš„æ—¶é—´ç™¾åˆ†æ¯”</li></ul><span id="more"></span><h1 id="linux-ä¸‹-pwm-é©±åŠ¨">Linux ä¸‹ PWM é©±åŠ¨</h1><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>pwm çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTUyODYwZTNlNzQwNmUyMDI0MTMx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PWM_Struct.png"></p><ul><li>pwm_chip ç»“æ„ä½“ç”¨äºæŠ½è±¡ soc çš„ pwm æ§åˆ¶å™¨</li><li>pwm_device ç”¨æ¥æŠ½è±¡è®¾å¤‡</li><li>pwm_state è¡¨ç¤º pwm è®¾å¤‡çš„å‘¨æœŸã€å ç©ºæ¯”ã€ææ€§ç­‰ä¿¡æ¯</li><li>pwm ops ç»“æ„ä½“æä¾›ä¸€ç³»åˆ—å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°çš„æ“ä½œå¯¹è±¡æ˜¯å…·ä½“çš„ pwm device</li></ul><h2 id="å®ç°">å®ç°</h2><p>pwm é©±åŠ¨åˆ†ä¸º consumer å’Œ providerã€‚å…¶ä¸­ consumer æä¾›æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">pwm_config</span><span class="params">(<span class="keyword">struct</span> pwm_device *pwm, <span class="type">int</span> duty_ns, <span class="type">int</span> period_ns)</span> <span class="comment">//é…ç½® pwm device çš„é¢‘ç‡ã€å ç©ºæ¯”ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">pwm_enable</span><span class="params">(<span class="keyword">struct</span> pwm_device *pwm)</span>                            <span class="comment">//ä½¿èƒ½/ç¦æ­¢ pwm ä¿¡å·è¾“å‡º</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">pwm_disable</span><span class="params">(<span class="keyword">struct</span> pwm_device *pwm)</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™äº›æ¥å£å®ç°å¯¹ pwm è®¾å¤‡çš„é…ç½®ï¼Œä½¿èƒ½ç­‰ï¼ˆè¿™äº›æ¥å£æœ€ç»ˆä¼šè°ƒç”¨åˆ° pwm_ops ç»“æ„ä½“æä¾›çš„å‡½æ•°ï¼‰ï¼Œæ“ä½œ struct pwm_device ç»“æ„ä½“ï¼Œä»£è¡¨äº†å…·ä½“çš„ pwm è®¾å¤‡ã€‚è¿™äº› struct pwm_device ç»“æ„ä½“æŒ‡é’ˆç”±ä»¥ä¸‹å‡½æ•°è·å¾—ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pwm_device *<span class="title function_">pwm_get</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *con_id)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pwm_put</span><span class="params">(<span class="keyword">struct</span> pwm_device *pwm)</span></span><br><span class="line"><span class="keyword">struct</span> pwm_device *<span class="title function_">devm_pwm_get</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">char</span> *con_id)</span></span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ pwm_get æ¥å£æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTUyYTUwNzkxMjkwNmIyYTQ0YTI5">åŸå›¾<i class="fa fa-external-link-alt"></i></span><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PWM_Get.png"></p><p>pwm_get/devm_pwm_getï¼Œä»æŒ‡å®šè®¾å¤‡ï¼ˆdevï¼‰çš„ DTS èŠ‚ç‚¹ä¸­ï¼Œè·å¾—å¯¹åº”çš„ PWM å¥æŸ„ã€‚å¯ä»¥é€šè¿‡ con_id æŒ‡å®šä¸€ä¸ªåç§°ï¼Œæˆ–è€…ä¼šè·å–å’Œè¯¥è®¾å¤‡ç»‘å®šçš„ç¬¬ä¸€ä¸ª PWM å¥æŸ„ã€‚</p><p>provider æä¾›ä»¥ä¸‹æ¥å£ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pwmchip_add</span><span class="params">(<span class="keyword">struct</span> pwm_chip *chip)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pwmchip_remove</span><span class="params">(<span class="keyword">struct</span> pwm_chip *chip)</span></span><br></pre></td></tr></tbody></table></figure><p>å°†ä¸€ä¸ª pwm_chip æ³¨å†Œåˆ°å†…æ ¸æ·»åŠ åˆ° pwm_chips é“¾è¡¨ä¸­å»ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvY29tbS9wd21fb3ZlcnZpZXcuaHRtbA==">http://www.wowotech.net/comm/pwm_overview.html<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹ IIC å­ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverIIC/"/>
      <url>/2020/LinuxDriver/LinuxDriverIIC/</url>
      
        <content type="html"><![CDATA[<h1 id="iic-åè®®">IIC åè®®</h1><h2 id="å†™æ“ä½œ">å†™æ“ä½œ</h2><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä¸»èŠ¯ç‰‡è¦å‘å‡ºä¸€ä¸ª start ä¿¡å·</li><li>ç„¶åå‘å‡ºä¸€ä¸ªè®¾å¤‡åœ°å€ï¼ˆç”¨æ¥ç¡®å®šæ˜¯å¾€å“ªä¸€ä¸ªèŠ¯ç‰‡å†™æ•°æ®ï¼‰ï¼Œæ–¹å‘ï¼ˆè¯»/å†™ï¼Œ0 è¡¨ç¤ºå†™ï¼Œ1 è¡¨ç¤ºè¯»ï¼‰</li><li>ä»è®¾å¤‡å›åº”ï¼ˆç”¨æ¥ç¡®å®šè¿™ä¸ªè®¾å¤‡æ˜¯å¦å­˜åœ¨ï¼‰ï¼Œç„¶åå°±å¯ä»¥ä¼ è¾“æ•°æ®</li><li>ä¸»è®¾å¤‡å‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®ç»™ä»è®¾å¤‡ï¼Œå¹¶ç­‰å¾…å›åº”</li><li>æ¯ä¼ è¾“ä¸€å­—èŠ‚æ•°æ®ï¼Œæ¥æ”¶æ–¹è¦æœ‰ä¸€ä¸ªå›åº”ä¿¡å·ï¼ˆç¡®å®šæ•°æ®æ˜¯å¦æ¥å—å®Œæˆï¼‰ï¼Œç„¶åå†ä¼ è¾“ä¸‹ä¸€ä¸ªæ•°æ®</li><li>æ•°æ®å‘é€å®Œä¹‹åï¼Œä¸»èŠ¯ç‰‡å°±ä¼šå‘é€ä¸€ä¸ªåœæ­¢ä¿¡å·</li></ul><p>ä¸‹å›¾ï¼šç™½è‰²èƒŒæ™¯è¡¨ç¤º"ä¸»â†’ä»"ï¼Œç°è‰²èƒŒæ™¯è¡¨ç¤º"ä»â†’ä¸»" <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/007_i2c_write.png"></p><span id="more"></span><h2 id="è¯»æ“ä½œ">è¯»æ“ä½œ</h2><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä¸»èŠ¯ç‰‡è¦å‘å‡ºä¸€ä¸ª start ä¿¡å·</li><li>ç„¶åå‘å‡ºä¸€ä¸ªè®¾å¤‡åœ°å€ï¼ˆç”¨æ¥ç¡®å®šæ˜¯å¾€å“ªä¸€ä¸ªèŠ¯ç‰‡å†™æ•°æ®ï¼‰ï¼Œæ–¹å‘ï¼ˆè¯»/å†™ï¼Œ0 è¡¨ç¤ºå†™ï¼Œ1 è¡¨ç¤ºè¯»ï¼‰</li><li>ä»è®¾å¤‡å›åº”ï¼ˆç”¨æ¥ç¡®å®šè¿™ä¸ªè®¾å¤‡æ˜¯å¦å­˜åœ¨ï¼‰ï¼Œç„¶åå°±å¯ä»¥ä¼ è¾“æ•°æ®</li><li>ä»è®¾å¤‡å‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®ç»™ä¸»è®¾å¤‡ï¼Œå¹¶ç­‰å¾…å›åº”</li><li>æ¯ä¼ è¾“ä¸€å­—èŠ‚æ•°æ®ï¼Œæ¥æ”¶æ–¹è¦æœ‰ä¸€ä¸ªå›åº”ä¿¡å·ï¼ˆç¡®å®šæ•°æ®æ˜¯å¦æ¥å—å®Œæˆï¼‰ï¼Œç„¶åå†ä¼ è¾“ä¸‹ä¸€ä¸ªæ•°æ®</li><li>æ•°æ®å‘é€å®Œä¹‹åï¼Œä¸»èŠ¯ç‰‡å°±ä¼šå‘é€ä¸€ä¸ªåœæ­¢ä¿¡å·</li></ul><p>ä¸‹å›¾ï¼šç™½è‰²èƒŒæ™¯è¡¨ç¤º"ä¸»â†’ä»"ï¼Œç°è‰²èƒŒæ™¯è¡¨ç¤º"ä»â†’ä¸»" <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/008_i2c_read.png"></p><h2 id="iic-ä¿¡å·">IIC ä¿¡å·</h2><p>IIC åè®®ä¸­æ•°æ®ä¼ è¾“çš„å•ä½æ˜¯å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 8 ä½ã€‚ä½†æ˜¯è¦ç”¨åˆ° 9 ä¸ªæ—¶é’Ÿï¼šå‰é¢ 8 ä¸ªæ—¶é’Ÿç”¨æ¥ä¼ è¾“ 8 æ•°æ®ï¼Œç¬¬ 9 ä¸ªæ—¶é’Ÿç”¨æ¥ä¼ è¾“å›åº”ä¿¡å·ã€‚ä¼ è¾“æ—¶ï¼Œå…ˆä¼ è¾“æœ€é«˜ä½ (MSB)ã€‚</p><ul><li>å¼€å§‹ä¿¡å·ï¼ˆSï¼‰ï¼šSCL ä¸ºé«˜ç”µå¹³æ—¶ï¼ŒSDA ä»é«˜ç”µå¹³å‘ä½ç”µå¹³è·³å˜ï¼Œå¼€å§‹ä¼ é€æ•°æ®</li><li>ç»“æŸä¿¡å·ï¼ˆPï¼‰ï¼šSCL ä¸ºé«˜ç”µå¹³æ—¶ï¼ŒSDA ç”±ä½ç”µå¹³å‘é«˜ç”µå¹³è·³å˜ï¼Œç»“æŸä¼ é€æ•°æ®</li><li>å“åº”ä¿¡å· (ACK)ï¼šæ¥æ”¶å™¨åœ¨æ¥æ”¶åˆ° 8 ä½æ•°æ®åï¼Œåœ¨ç¬¬ 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œæ‹‰ä½ SDA</li><li>SDA ä¸Šä¼ è¾“çš„æ•°æ®å¿…é¡»åœ¨ SCL ä¸ºé«˜ç”µå¹³æœŸé—´ä¿æŒç¨³å®šï¼ŒSDA ä¸Šçš„æ•°æ®åªèƒ½åœ¨ SCL ä¸ºä½ç”µå¹³æœŸé—´å˜åŒ–</li></ul><p>IIC åè®®ä¿¡å·å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/009_i2c_signal.png"></p><h2 id="ç¡¬ä»¶å®ç°">ç¡¬ä»¶å®ç°</h2><p>scl å’Œ sda ç®¡è„šéƒ½é‡‡ç”¨å¼€æ¼è¾“å‡ºçš„é©±åŠ¨æ–¹å¼ï¼Œéœ€è¦å¤–æ¥ä¸Šæ‹‰ç”µé˜»æ¥è¾“å‡ºé«˜ç”µå¹³ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/010_i2c_signal_internal.png"></p><p>çœŸå€¼è¡¨å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/011_true_value_table.png"></p><p>ä»çœŸå€¼è¡¨å’Œç”µè·¯å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ul><li>å½“æŸä¸€ä¸ªèŠ¯ç‰‡ä¸æƒ³å½±å“ SDA çº¿æ—¶ï¼Œé‚£å°±ä¸é©±åŠ¨è¿™ä¸ªä¸‰æç®¡</li><li>æƒ³è®© SDA è¾“å‡ºé«˜ç”µå¹³ï¼ŒåŒæ–¹éƒ½ä¸é©±åŠ¨ä¸‰æç®¡ (SDA é€šè¿‡ä¸Šæ‹‰ç”µé˜»å˜ä¸ºé«˜ç”µå¹³ï¼‰</li><li>æƒ³è®© SDA è¾“å‡ºä½ç”µå¹³ï¼Œå°±é©±åŠ¨ä¸‰æç®¡</li></ul><h2 id="ç¡¬ä»¶æ‹“æ‰‘">ç¡¬ä»¶æ‹“æ‰‘</h2><p>soc ä¸­çš„ iic æ§åˆ¶å™¨ä¸æŒ‚è½½åœ¨ iic æ€»çº¿ä¸Šçš„è®¾å¤‡çš„æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/001_i2c_hardware_block.png"></p><h2 id="smbus-åè®®">SMBus åè®®</h2><p>SMBus æ˜¯åŸºäº IIC åè®®çš„ï¼ŒSMBus è¦æ±‚æ›´ä¸¥æ ¼ï¼ŒSMBus æ˜¯ IIC åè®®çš„å­é›†ï¼Œåšäº†ç›¸å…³é™åˆ¶ï¼Œä¾‹å¦‚ VDD çš„æé™å€¼ä¸ä¸€æ ·ã€åœ°å€å›åº” (Address Acknowledge)ã€æ—¶é’Ÿé¢‘ç‡ç­‰éƒ½æœ‰ç›¸å…³é™åˆ¶ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p><h1 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h1><p>é¦–å…ˆé€šè¿‡ä¸€å¼ å›¾æ¥å±•ç¤ºè¿™äº›æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTRjOTQ2Mzc2ODkyMWZhMjUwMWMx">åŸå›¾<i class="fa fa-external-link-alt"></i></span><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/IIC_Struct.png"></p><ul><li><p>bus_type:<br>iic æ˜¯ä¸€ä¸ªæ€»çº¿è®¾å¤‡ï¼Œlinux å¯åŠ¨é˜¶æ®µä¼šåˆ›å»ºä¸€ä¸ª iic æ€»çº¿ i2c_bus_typeï¼Œè¯¥æ€»çº¿ç”¨äºç®¡ç† i2c_client è®¾å¤‡å’Œ i2c_driver é©±åŠ¨ã€‚è¯¥ç»“æ„è·Ÿ linux é©±åŠ¨ä¹‹è®¾å¤‡æ¨¡å‹é‡Œçš„æ€»çº¿ç›¸åŒï¼Œè¿™é‡Œå®ç°äº†å®ƒè‡ªå·±çš„ match å’Œ probe å‡½æ•°</p></li><li><p>i2c_adapter:<br>æ¯ä¸ª soc å†…éƒ¨éƒ½æœ‰è‡ªå·±çš„å¤šä¸ª iic æ§åˆ¶å™¨ï¼Œi2c_adapter ç»“æ„ä½“å°±æ˜¯ç”¨äºæè¿° iic æ§åˆ¶å™¨çš„ç»“æ„ä½“ï¼ˆå°±æ˜¯ iic controlerï¼‰ï¼Œç»“æ„ä½“é‡Œçš„ nr ç”¨äºè¡¨è¿°è¯¥æ§åˆ¶å™¨æ˜¯ç¬¬å‡ ä¸ªæ§åˆ¶å™¨ä¾‹å¦‚ iic-0ï¼Œiic-1 ç­‰ã€‚è¿™é‡Œé¢æœ‰ä¸€ä¸ªæœ€é‡è¦çš„ç»“æ„å°±æ˜¯ i2c_algorithmï¼Œè¯¥ç»“æ„æ˜¯å…·ä½“ controler å®é™… iic ä¼ è¾“çš„å®ç°ï¼Œç”±å…·ä½“çš„å¹³å°å®ç°è‡ªå·±çš„ i2c_algorithm</p></li><li><p>i2c_client:<br>ä¸€ä¸ª iic ä¸‹ä¼šæŒ‚è½½ä¸€ä¸ªæˆ–å¤šä¸ªè®¾å¤‡ï¼Œæ¯ä¸ªè®¾å¤‡çš„ä¿¡æ¯ç”± i2c_client ç»“æ„ä½“æè¿°ï¼Œä¾‹å¦‚è®¾å¤‡åœ°å€ç­‰ä¿¡æ¯ã€‚è¯¥ç»“æ„ä½“è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ i2c_adapterï¼Œè¡¨ç¤ºè¯¥è®¾å¤‡æŒ‚è½½åœ¨å“ªä¸ª iic controler ä¸‹ä»¥ä¾¿åœ¨ iic é€šä¿¡çš„æ—¶å€™é€šè¿‡ i2c_adapter æä¾›çš„ i2c_algorithm æä¾›çš„æ¥å£å®Œæˆå®é™…çš„æ•°æ®ä¼ è¾“</p></li><li><p>i2c_driver:<br>iic ä¸‹æŒ‚è½½çš„è®¾å¤‡ä¾‹å¦‚ tpã€æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ç­‰è®¾å¤‡çš„é©±åŠ¨ç”±è¯¥æ•°æ®ç»“æ„æ¥æè¿°ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬å®é™…ç¼–å†™é©±åŠ¨ä¸­æœ€å¸¸ç”¨çš„ï¼Œé€šè¿‡ iic é©±åŠ¨å…·ä½“çš„æŒ‚è½½åœ¨ iic æ€»çº¿ä¸Šçš„è®¾å¤‡ã€‚i2c_driver è·Ÿ i2c_client åŒ¹é…æˆåŠŸåï¼Œå°±è°ƒç”¨ i2c_driver.probe å‡½æ•°</p></li><li><p>i2c_msg:<br>æœ‰äº† iic è®¾å¤‡å’Œ iic é©±åŠ¨äº†ï¼Œiic æ˜¯é€šä¿¡æ€»çº¿ï¼Œé‚£å°±æ˜¯è¦ç”¨æ¥ä¼ è¾“æ¶ˆæ¯çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªæè¿°å…·ä½“æ¶ˆæ¯çš„ç»“æ„ä½“å°±æ˜¯ i2c_msgï¼Œè¯¥ç»“æ„ä½“æè¿°äº†æ¶ˆæ¯æ–¹å‘ï¼Œä¼ è¾“åœ°å€ï¼Œæ¶ˆæ¯é•¿åº¦ä»¥åŠæ¶ˆæ¯æœ¬èº«å†…å®¹</p></li></ul><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ iic é©±åŠ¨ä¹Ÿæ˜¯ä½¿ç”¨ä¹‹å‰æè¿°çš„è®¾å¤‡é©±åŠ¨æ¨¡å‹ï¼Œbus ä¸‹æŒ‚è½½é“¾æ¡ç»“æ„ä¸€ä¸ªæŒ‚è½½è®¾å¤‡ä¸€ä¸ªæŒ‚è½½é©±åŠ¨é€šè¿‡æ€»çº¿æä¾›çš„ match å‡½æ•°è¿›è¡ŒåŒ¹é…å®ç° device æ‰¾åˆ° device_driver æˆ–åˆ™ device_driver æ‰¾åˆ°è¦é©±åŠ¨çš„ deviceï¼Œç„¶ååœ¨ match æˆåŠŸåé€šè¿‡æ€»çº¿çš„ probe å‡½æ•°è°ƒç”¨åˆ°é©±åŠ¨çš„ probe å‡½æ•°ï¼Œå®é™…é©±åŠ¨å¼€å‘äººå‘˜åªéœ€è¦å¡«å…… i2c_driver ç»“æ„ä½“å¹¶å°†å…¶æ³¨å†Œåˆ°æ€»çº¿å°±å¯ä»¥äº†ã€‚åŒºåˆ«åœ¨äº iic æ€»çº¿æ˜¯ä¸€ä¸ªå…·ä½“å®å®åœ¨åœ¨çš„æ€»çº¿ï¼Œsoc å†…éƒ¨æœ‰ iic æ§åˆ¶å™¨ï¼Œé€šè¿‡ i2c_adapter æè¿°æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œi2c_driver é€šè¿‡ i2c_adapter æä¾›çš„ iic ä¼ è¾“å‡½æ•°æ¥æ“ä½œ i2c_client è®¾å¤‡ï¼Œè¿™å°±æ˜¯ iic æ€»çº¿é©±åŠ¨çš„æ•´ä½“æ¡†æ¶äº†ã€‚</p><h1 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h1><p>i2c_register_adapter å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTRjYjY2Mzc2ODkyMWZhMjUwMWUz">åŸå›¾<i class="fa fa-external-link-alt"></i></span><br><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/IIC_RegisterAdapt.png"></p><p>è¿™é‡Œé¢æœ‰ä¸€ä¸ªå‡½æ•° i2c_detect éœ€è¦æ³¨æ„ï¼Œè¯¥å‡½æ•°ä¼šéå†æ€»çº¿ä¸‹çš„æ¯ä¸€ä¸ª i2c_driver å¹¶è°ƒç”¨ i2c_driver çš„ detect å‡½æ•°ï¼Œå…·ä½“çš„ i2c_driver çš„ detect å‡½æ•°ç”±å…·ä½“çš„é©±åŠ¨å®ç°ã€‚</p><p>i2c_register_driver å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTRjZDM2Mzc2ODkyMWZhMjUwMjA0">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/IIC_RegisterDriver.png"></p><p>i2c_driver åŒ adapt çš„æ³¨å†Œæœ‰ä¸€äº›ç›¸åŒçš„æµç¨‹ï¼Œå…¶ä¸­ detect å‡½æ•°å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæ³¨å†Œ i2c_driver çš„æ—¶å€™ä¹Ÿä¼šéå† bus ä¸‹çš„ i2c_driver å¹¶è°ƒç”¨ç›¸åº”çš„ detect å‡½æ•°ã€‚</p><h1 id="i2c-tools">I2C tools</h1><h2 id="é€‰æ‹©å·¥å…·-i2c_tools">é€‰æ‹©å·¥å…· i2c_tools</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Utilities--&gt;</span><br><span class="line">i2c-tools--&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="ç”¨æ³•">ç”¨æ³•</h2><ul><li><p>i2cdetect:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cdetect [-y] [-a] [-q|-r] I2CBUS [FIRST LAST]</span><br><span class="line">       i2cdetect -F I2CBUS</span><br><span class="line">       i2cdetect -l</span><br><span class="line">  I2CBUS is an <span class="built_in">integer</span> or an I2C bus name</span><br><span class="line">  If provided, FIRST and LAST <span class="built_in">limit</span> the probing range.</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>i2cdump:<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cdump [-f] [-y] [-r first-last] I2CBUS ADDRESS [MODE [BANK [BANKREG]]]</span><br><span class="line">  I2CBUS is an <span class="built_in">integer</span> or an I2C bus name</span><br><span class="line">  ADDRESS is an <span class="built_in">integer</span> (0x03 - 0x77)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    b (byte, default)</span><br><span class="line">    w (word)</span><br><span class="line">    W (word on even register addresses)</span><br><span class="line">    s (SMBus block)</span><br><span class="line">    i (I2C block)</span><br><span class="line">    c (consecutive byte)</span><br><span class="line">    Append p <span class="keyword">for</span> SMBus PEC</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>i2cgetï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cget [-f] [-y] I2CBUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]</span><br><span class="line">  I2CBUS is an <span class="built_in">integer</span> or an I2C bus name</span><br><span class="line">  ADDRESS is an <span class="built_in">integer</span> (0x03 - 0x77)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    b (<span class="built_in">read</span> byte data, default)</span><br><span class="line">    w (<span class="built_in">read</span> word data)</span><br><span class="line">    c (write byte/read byte)</span><br><span class="line">    Append p <span class="keyword">for</span> SMBus PEC</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>i2csetï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cset [-f] [-y] [-m MASK] [-r] I2CBUS CHIP-ADDRESS DATA-ADDRESS [VALUE] ... [MODE]</span><br><span class="line">  I2CBUS is an <span class="built_in">integer</span> or an I2C bus name</span><br><span class="line">  ADDRESS is an <span class="built_in">integer</span> (0x03 - 0x77)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    c (byte, no value)</span><br><span class="line">    b (byte data, default)</span><br><span class="line">    w (word data)</span><br><span class="line">    i (I2C block data)</span><br><span class="line">    s (SMBus block data)</span><br><span class="line">    Append p <span class="keyword">for</span> SMBus PEC</span><br></pre></td></tr></tbody></table></figure><p></p></li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®ï¼š</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9jb21t">http://www.wowotech.net/sort/comm<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGtubGZ5L3AvMzI2NTEwOC5odG1s">https://www.cnblogs.com/lknlfy/p/3265108.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY3h5YmIuY29tL2FydGljbGUvcm9ja3JvY2t3dS83NDM1ODE3">https://www.cxybb.com/article/rockrockwu/7435817<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹è®¾å¤‡æ ‘</title>
      <link href="/2020/LinuxDriver/LinuxDriverDeviceTree/"/>
      <url>/2020/LinuxDriver/LinuxDriverDeviceTree/</url>
      
        <content type="html"><![CDATA[<h1 id="dtb-æ•°æ®è§£æ">dtb æ•°æ®è§£æ</h1><h2 id="å†…æ ¸å¯åŠ¨é˜¶æ®µè·å¾—-dtb-ä½ç½®æŒ‡é’ˆ">å†…æ ¸å¯åŠ¨é˜¶æ®µè·å¾— dtb ä½ç½®æŒ‡é’ˆ</h2><p>ä»¥ arm64 ä¸ºä¾‹ï¼Œå†…æ ¸å¯åŠ¨å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__HEAD</span><br><span class="line">_head:</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_EFI</span><br><span class="line">addx13, x18, #0x16</span><br><span class="line">bstext</span><br><span class="line">#else</span><br><span class="line">bstext// branch to kernel start, magic</span><br><span class="line">.long0// reserved</span><br><span class="line">#endif</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>åœ¨å¼€å¯ UEFI æ”¯æŒæ—¶ï¼Œadd x13, x18, #0x16 è¿™ä¸ª code å®é™…ä¸Šæ˜¯ä¸ºäº†æ»¡è¶³ EFI æ ¼å¼çš„â€MZâ€å¤´ã€‚å¦‚æœä½¿ç”¨ UEFI æ¥å¯åŠ¨ kernel, ä¼šè¯†åˆ«å‡ºæ¥å¹¶èµ° UEFI å¯åŠ¨çš„æµç¨‹ï¼Œå¦‚æœæ˜¯æ™®é€šçš„å¯åŠ¨è¿‡ç¨‹å¦‚ä½¿ç”¨ uboot çš„ booti è¿›è¡Œå¼•å¯¼ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¡æŒ‡ä»¤å°±æ˜¯ä¸€æ¡ dummy æŒ‡ä»¤ï¼Œç¬¬äºŒæ¡å°±è·³è½¬åˆ° stext è¿è¡Œäº†ã€‚</p><span id="more"></span><p>x0 å¯„å­˜å™¨ä¿å­˜çš„æ˜¯ dtb é‡Œ blob å—çš„ç‰©ç†åœ°å€ï¼Œx0 å¯„å­˜å™¨å†…å®¹ç”± uboot è®¾ç½®ï¼Œuboot å°† dtb åœ°å€ä¼ é€’ç»™å†…æ ¸ï¼Œè·³è½¬åˆ° stextï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(stext)</span><br><span class="line">blpreserve_boot_args</span><br><span class="line">blel2_setup// Drop to EL1, w0=cpu_boot_mode</span><br><span class="line">adrpx23, __PHYS_OFFSET</span><br><span class="line">andx23, x23, MIN_KIMG_ALIGN - 1// KASLR offset, defaults to 0</span><br><span class="line">blset_cpu_boot_mode_flag</span><br><span class="line">bl__create_page_tables</span><br><span class="line">bl__cpu_setup// initialise processor</span><br><span class="line">b__primary_switch</span><br><span class="line">ENDPROC(stext)</span><br><span class="line">...</span><br><span class="line">preserve_boot_args:</span><br><span class="line">movx21, x0// x21=FDT</span><br><span class="line"></span><br><span class="line">adr_lx0, boot_args// record the contents of</span><br><span class="line">stpx21, x1, [x0]// x0 .. x3 at kernel entry</span><br><span class="line">stpx2, x3, [x0, #16]</span><br><span class="line"></span><br><span class="line">dmbsy// needed before dc ivac with</span><br><span class="line">// MMU off</span><br><span class="line"></span><br><span class="line">addx1, x0, #0x20// 4 x 8 bytes</span><br><span class="line">b__inval_cache_range// tail call</span><br><span class="line">ENDPROC(preserve_boot_args)</span><br></pre></td></tr></tbody></table></figure><p>arm64 linux å¯„å­˜å™¨è§„å®šå¦‚ä¸‹ï¼š</p><pre><code>x0 = physical address of device tree blob (dtb) in system RAM.x1 = 0 (reserved for future use)x2 = 0 (reserved for future use)x3 = 0 (reserved for future use)</code></pre><p>å°† dtb çš„ç‰©ç†åœ°å€ä¿å­˜åœ¨ x21 å¯„å­˜å™¨ä¸­ã€‚ __inval_cache_range è¿™ä¸ªå‡½æ•°ç”¨æ¥ invalidate æŒ‡å®šåŒºåŸŸçš„ cacheã€‚å¦‚æœæŒ‡å®šå†…å­˜åŒºåŸŸæœ‰è·¨è¶Š cacheline, é‚£ä¹ˆå¯¹ä¸¤è¾¹è·¨è¶Šäº† cacheline çš„åœ°å€ä½¿ç”¨çš„ clean + invalidate, å¯¹äºä¸­é—´åŒºåŸŸå¯ä»¥ç›´æ¥ invalidate ä¸ç”¨å†™å›å†…å­˜ï¼Œä»è€ŒåŠ å¿« invalidate é€Ÿåº¦ã€‚</p><p>è°ƒç”¨__primary_switch å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__primary_switch:</span><br><span class="line"></span><br><span class="line">bl__enable_mmu</span><br><span class="line">#ifdef CONFIG_RELOCATABLE</span><br><span class="line">bl__relocate_kernel</span><br><span class="line">#ifdef CONFIG_RANDOMIZE_BASE</span><br><span class="line">ldrx8, =__primary_switched</span><br><span class="line">adrpx0, __PHYS_OFFSET</span><br><span class="line">blrx8</span><br><span class="line">...</span><br><span class="line">bl__relocate_kernel</span><br><span class="line">#endif</span><br><span class="line">ldrx8, =__primary_switched</span><br><span class="line">adrpx0, __PHYS_OFFSET</span><br><span class="line">brx8</span><br><span class="line">ENDPROC(__primary_switch)</span><br></pre></td></tr></tbody></table></figure><p>è°ƒç”¨__primary_switched å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__primary_switched:</span><br><span class="line">adrpx4, init_thread_union</span><br><span class="line">addsp, x4, #THREAD_SIZE</span><br><span class="line">msrsp_el0, x4// Save thread_info</span><br><span class="line"></span><br><span class="line">adr_lx8, vectors// load VBAR_EL1 with virtual</span><br><span class="line">msrvbar_el1, x8// vector table address</span><br><span class="line">isb</span><br><span class="line"></span><br><span class="line">stpxzr, x30, [sp, #-16]!</span><br><span class="line">movx29, sp</span><br><span class="line"></span><br><span class="line">str_lx21, __fdt_pointer, x5// Save FDT pointer</span><br><span class="line">...</span><br><span class="line">bstart_kernel</span><br><span class="line">ENDPROC(__primary_switched)</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ str_l x21, __fdt_pointer, x5 è¿™å¥å°† dtb çš„åœ°å€ä¿å­˜åœ¨__fdt_pointer æŒ‡é’ˆé‡Œï¼Œä»¥ä¾¿åç»­å†…æ ¸å¯ä»¥æ‰¾åˆ° dtb å¹¶è§£æè®¾å¤‡æ ‘æ–‡ä»¶ã€‚</p><p>å…³äº linux å¯åŠ¨è¿‡ç¨‹å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjEyOWYxZDhlMGIzNGQzNTUwZjBiNjFi">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/StartKernel.png"></p><h2 id="dtb-è§£æè¿‡ç¨‹">dtb è§£æè¿‡ç¨‹</h2><p>start_kernel é˜¶æ®µä¼šå¤„ç† dtb æ–‡ä»¶ç”Ÿæˆ device_node ç»“æ„ä½“ä»¥åŠä»–ä»¬ä¹‹é—´çš„ç»„ç»‡å…³ç³»ã€‚æ•´ä½“çš„è°ƒç”¨é€»è¾‘å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTQ4ZjA2Mzc2ODkyMWZhMjRmY2Vl">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/fdt.png"></p><p>ä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„è®¾å¤‡æ ‘ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/ {</span><br><span class="line">    leds {</span><br><span class="line">        act {</span><br><span class="line">            gpios = &lt;&amp;gpio <span class="number">42</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        pwr {</span><br><span class="line">            label = <span class="string">"PWR"</span>;</span><br><span class="line">            gpios = &lt;&amp;expgpio <span class="number">2</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">            <span class="keyword">default</span>-state = <span class="string">"keep"</span>;</span><br><span class="line">            linux,<span class="keyword">default</span>-trigger = <span class="string">"default-on"</span>;</span><br><span class="line">        };</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    wifi_pwrseq: wifi-pwrseq {</span><br><span class="line">        compatible = <span class="string">"mmc-pwrseq-simple"</span>;</span><br><span class="line">        reset-gpios = &lt;&amp;expgpio <span class="number">1</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¯¥è®¾å¤‡æ ‘ç»è¿‡ populate_node() è§£æå¤„ç†åï¼Œç»“æ„ä½“å…³ç³»å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- /èŠ‚ç‚¹ï¼š</span><br><span class="line">    - parentï¼šNULL</span><br><span class="line">    - siblingï¼šNULL</span><br><span class="line">    - childï¼šwifi_pwrseq</span><br><span class="line">- led èŠ‚ç‚¹ï¼š</span><br><span class="line">    - parentï¼š/</span><br><span class="line">    - siblingï¼šNULL</span><br><span class="line">    - childï¼špwr</span><br><span class="line">- act èŠ‚ç‚¹ï¼š</span><br><span class="line">    - parentï¼šled</span><br><span class="line">    - siblingï¼šNULL</span><br><span class="line">    - childï¼šNULL</span><br><span class="line">- pwr èŠ‚ç‚¹ï¼š</span><br><span class="line">    - parentï¼šled</span><br><span class="line">    - siblingï¼šact</span><br><span class="line">    - childï¼šNULL</span><br><span class="line">- wifi_pwrseq èŠ‚ç‚¹ï¼š</span><br><span class="line">    - parentï¼š/</span><br><span class="line">    - siblingï¼šled</span><br><span class="line">    - childï¼šNULL</span><br></pre></td></tr></tbody></table></figure><h2 id="device_node-ä¸-device-ç»‘å®š">device_node ä¸ device ç»‘å®š</h2><p>kernel ä¼šä¸ºè®¾å¤‡æ ‘ root èŠ‚ç‚¹ä¸‹æ‰€æœ‰å¸¦'compatible' å±æ€§çš„èŠ‚ç‚¹éƒ½åˆ†é…å¹¶æ³¨å†Œä¸€ä¸ª platform_deviceï¼›å¦å¤–ï¼Œå¦‚æœæŸèŠ‚ç‚¹çš„'compatible' ç¬¦åˆæŸäº› matches æ¡ä»¶ï¼Œåˆ™ä¼šä¸ºè¯¥èŠ‚ç‚¹ä¸‹æ‰€æœ‰å¸¦'compatible' å±æ€§çš„å­èŠ‚ç‚¹ï¼ˆchildï¼‰ä¹Ÿåˆ†é…å¹¶æ³¨å†Œä¸€ä¸ª platform_deviceã€‚ æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTQ5MmI2Mzc2ODkyMWZhMjRmZDQx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/FDT_BindDevice.png"></p><p>è‡³æ­¤ï¼Œä¸ºæ‰€æœ‰è®¾å¤‡æ ‘ä¸­æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ node éƒ½åˆ›å»ºäº† platform_device ç»“æ„ä½“ï¼Œnode ä¸‹æè¿°çš„èµ„æºä¹Ÿè§£æåˆ°äº† platform_device ä¸­ï¼Œå¹¶é€šè¿‡ dev æˆå‘˜å°†è¯¥ node æè¿°çš„è®¾å¤‡åŠ å…¥äº†ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ã€‚</p><blockquote><p>&nbsp;è¡¥å……ï¼šæ ‡ç­¾æ˜¯æ ‡è®°èŠ‚ç‚¹çš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨å”¯ä¸€çš„åç§°æ¥æ ‡è¯†èŠ‚ç‚¹ï¼Œåœ¨ dt ç¼–è¯‘å™¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œdt ç¼–è¯‘å™¨å°†è¯¥åç§°è½¬æ¢ä¸ºå”¯ä¸€çš„ 32 ä½å€¼ï¼Œä¹‹åå¯ä»¥ä½¿ç”¨æ ‡ç­¾å¼•ç”¨èŠ‚ç‚¹ï¼Œå› ä¸ºæ ‡ç­¾å¯¹äºèŠ‚ç‚¹æ˜¯å”¯ä¸€çš„ã€‚phandle æ˜¯ä¸èŠ‚ç‚¹ç›¸å…³è”çš„ 32 ä½å€¼ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¯¥èŠ‚ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥ä»å¦ä¸€ä¸ªèŠ‚ç‚¹å±æ€§å¼•ç”¨è¯¥èŠ‚ç‚¹ã€‚ä¸ºäº†åœ¨æŸ¥æ‰¾èŠ‚ç‚¹æ—¶ä¸éå†æ•´ä¸ªæ ‘ï¼Œå¼•å…¥åˆ«åçš„æ¦‚å¿µï¼Œåœ¨ dt ä¸­ï¼Œåˆ«åå¯ä»¥çœ‹ä½œæ˜¯èŠ‚ç‚¹çš„å¿«é€ŸæŸ¥æ‰¾è¡¨ï¼Œå³ä¸€ä¸ªèŠ‚ç‚¹çš„ç´¢å¼•</p></blockquote><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDE2MjMzNzA=">https://zhuanlan.zhihu.com/p/141623370<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDMwOTI4Njg=">https://zhuanlan.zhihu.com/p/143092868<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL2duZ3Nobi5naXRodWIuaW8v">http://gngshn.github.io/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9kZXZpY2VfbW9kZWw=">http://www.wowotech.net/sort/device_model<i class="fa fa-external-link-alt"></i></span><br>ã€ŠLinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹æ–‡ä»¶ç³»ç»Ÿ</title>
      <link href="/2020/LinuxDriver/LinuxDriverFileSystem/"/>
      <url>/2020/LinuxDriver/LinuxDriverFileSystem/</url>
      
        <content type="html"><![CDATA[<h1 id="seq_file">seq_file</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>seq_file åªæ˜¯åœ¨æ™®é€šæ–‡ä»¶ read ä¸­åŠ å…¥äº†å†…æ ¸ç¼“å†²çš„åŠŸèƒ½ï¼Œä»è€Œå®ç°é¡ºåºå¤šæ¬¡éå†è¯»å–å¤§æ•°æ®é‡çš„ç®€å•æ¥å£ï¼Œseq_file ä¸€èˆ¬åªæä¾›åªè¯»æ¥å£ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> {</span></span><br><span class="line"><span class="type">void</span> * (*start) (<span class="keyword">struct</span> seq_file *m, <span class="type">loff_t</span> *pos);</span><br><span class="line"><span class="type">void</span> (*stop) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line"><span class="type">void</span> * (*next) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v, <span class="type">loff_t</span> *pos);</span><br><span class="line"><span class="type">int</span> (*show) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="æ ¸å¿ƒåŠŸèƒ½">æ ¸å¿ƒåŠŸèƒ½</h2><p>seq_file æ¥å£å¯é€šè¿‡ &lt;linux/seq_file.h&gt; è·å¾—ã€‚ seq_file åŒ…å«ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul><li>An iterator interface which lets a virtual file implementation step through the objects it is presenting</li><li>Some utility functions for formatting objects for output without needing to worry about things like output buffers</li><li>A set of canned file_operations which implement most operations on the virtual file</li></ul><p>å®ç°æ–‡ä»¶åœ¨ fs/seq_file.c å’Œ include/linux/seq_file.h ä¸­ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>seq_file æ˜¯ä¸º proc æ–‡ä»¶ç³»ç»Ÿè®¾è®¡çš„ï¼Œä½†ä¸åªæ˜¯ procï¼Œåœ¨éœ€è¦åˆ›å»ºä¸€ä¸ªç”±ä¸€ç³»åˆ—æ•°æ®é¡ºåºç»„åˆè€Œæˆçš„è™šæ‹Ÿæ–‡ä»¶æˆ–ä¸€ä¸ªè¾ƒå¤§çš„è™šæ‹Ÿæ–‡ä»¶æ—¶ï¼Œæ¨èä½¿ç”¨ seq_file æ¥å£ã€‚è¿™æ­£æ˜¯ç¬¦åˆ bin_attribute çš„åœºæ™¯ã€‚ç”¨æˆ·ç©ºé—´é€šè¿‡ openã€read ç­‰å‡½æ•°æ“ä½œæ–‡ä»¶æ—¶é€šè¿‡ç³»ç»Ÿçš„ VFS è°ƒç”¨åˆ°å†…æ ¸å±‚ï¼Œå…¶ä¸­ file ç»“æ„ä½“çš„ private æŒ‡é’ˆæŒ‡å‘ seq_file ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨è¯¥ç»“æ„ä½“é‡Œçš„ op æŒ‡é’ˆæŒ‡å‘çš„ç›¸åº”å‡½æ•°ã€‚</p><h1 id="kernfs">kernfs</h1><h2 id="æ¦‚è¿°-1">æ¦‚è¿°</h2><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œkernfs æä¾›å†…æ ¸å­ç³»ç»Ÿå†…éƒ¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ‰€éœ€çš„åŠŸèƒ½ï¼Œæºäºæ‹†åˆ† sysfs ä½¿ç”¨çš„éƒ¨åˆ†å†…éƒ¨é€»è¾‘ï¼Œå®ƒé€šè¿‡å°†æœ‰å…³ç¡¬ä»¶è®¾å¤‡å’Œç›¸å…³è®¾å¤‡é©±åŠ¨ç¨‹åºçš„ä¿¡æ¯ä»å†…æ ¸çš„è®¾å¤‡æ¨¡å‹å¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´ï¼Œæä¾›ä¸€ç»„è™šæ‹Ÿæ–‡ä»¶ï¼Œä»è€Œå®ç°ç‹¬ç«‹ä¸”å¯é‡ç”¨çš„åŠŸèƒ½ã€‚ å…¶ä»–å†…æ ¸å­ç³»ç»Ÿå¯ä»¥æ›´å®¹æ˜“ï¼Œæ›´ä¸€è‡´åœ°å®ç°è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>å…ˆæ•´ä½“çœ‹ä¸‹æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹å›¾ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2YTQyOTllMGIzNGQ3YzdkYjU1MjU1">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/KernFS.png"></p><p>è¯¥å›¾å±•ç¤ºäº†å„ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ä»¥åŠå®ç°æ–¹å¼ï¼Œkernfs æ˜¯ fs æŠ½è±¡å‡ºæ¥å…¬å…±çš„å±æ€§æ“ä½œï¼Œsysfs åŸºæœ¬å°±æ˜¯è°ƒç”¨è¯¥ç»“æ„çš„æ–¹æ³•æ¥å®ç°ï¼ŒåŒæ—¶ kobject çš„ç›®å½•å’Œå±æ€§æ–‡ä»¶åœ¨ç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶ç»„ç»‡ä¹Ÿæ˜¯é€šè¿‡è¯¥æ•°æ®ç»“æ„å®ç°çš„ã€‚</p><h2 id="å®ç°">å®ç°</h2><p>æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„å®ç°éƒ½æ˜¯é€šè¿‡ file_operations ç»“æ„ä½“å®ç°å…·ä½“çš„æ“ä½œçš„ï¼Œkernfs ä¹Ÿæ˜¯ï¼Œå®ƒåŒæ ·å®ç°äº† file_operations ç»“æ„ä½“ç›¸å…³æ“ä½œï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">kernfs_file_fops</span> =</span> {</span><br><span class="line">.read= kernfs_fop_read,</span><br><span class="line">.write= kernfs_fop_write,</span><br><span class="line">.llseek= generic_file_llseek,</span><br><span class="line">.mmap= kernfs_fop_mmap,</span><br><span class="line">.open= kernfs_fop_open,</span><br><span class="line">.release= kernfs_fop_release,</span><br><span class="line">.poll= kernfs_fop_poll,</span><br><span class="line">.fsync= noop_fsync,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªå¯ä»¥å…³æ³¨ä¸‹ open æˆå‘˜çš„å®ç°å‡½æ•° kernfs_fop_openï¼Œ</p><ul><li><p>((struct seq_file *)file-&gt;private_data)-&gt;private = of: <strong>å¯ä»¥çœ‹åˆ° kernfs_open_file ç»“æ„ä½“æ˜¯æŒ‚åœ¨ seq_file ç»“æ„ä½“çš„ private æŒ‡é’ˆä¸‹çš„ï¼Œç°åœ¨å¯ä»¥æ¢³ç†ä¸‹è¿™ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œfile ç»“æ„ä½“çš„ private_data æŒ‡å‘ seq_fileï¼Œseq_file çš„ private æŒ‡å‘ kernfs_open_fileï¼Œè¿™æ ·ä»–ä»¬å°±éƒ½è”ç³»èµ·æ¥çš„ï¼Œå½“ç„¶è¿™é‡Œæ˜¯åˆ†æç‰¹å®šæ–‡ä»¶ç³»ç»Ÿä¸‹çš„å®ç°ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹å¯ä»¥æŒ‡å‘å…¶ä»–æ•°æ®ç»“æ„</strong></p></li><li><p>seq_open(file, &amp;kernfs_seq_ops): seq_file çš„å®ç°å°±ä½¿ç”¨äº† kernfs ç»“æ„ï¼Œkernfs å®ç°äº† seq_file çš„ file_operations ç»“æ„æˆå‘˜ï¼Œå¦‚ä¸‹ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> <span class="title">kernfs_seq_ops</span> =</span> {</span><br><span class="line">.start = kernfs_seq_start,</span><br><span class="line">.next = kernfs_seq_next,</span><br><span class="line">.stop = kernfs_seq_stop,</span><br><span class="line">.show = kernfs_seq_show,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç„¶åé€šè¿‡è°ƒç”¨ seq_open å°†è¯¥æ•°æ®ç»“æ„è¿å…¥ seq_file ç»“æ„ä½“çš„ op æˆå‘˜ä¸­ã€‚</p></li></ul><h1 id="sysfs">sysfs</h1><h2 id="æ¦‚è¿°-2">æ¦‚è¿°</h2><p>sysfs æ˜¯éæŒä¹…æ€§è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæä¾›ç³»ç»Ÿçš„å…¨å±€è§†å›¾ï¼Œå¹¶é€šè¿‡å®ƒä»¬çš„ kobiect æ˜¾ç¤ºå†…æ ¸å¯¹è±¡çš„å±‚æ¬¡ç»“æ„ï¼ˆæ‹“æ‰‘ï¼‰ã€‚æ¯ä¸ª kobiect æ˜¾ç¤ºä¸ºç›®å½•å’Œç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œç›®å½•ä»£è¡¨ç›¸å…³ kobject å¯¼å‡ºçš„å†…æ ¸å˜é‡ã€‚è¿™äº›æ–‡ä»¶ç§°ä¸ºå±æ€§ï¼Œå¯ä»¥è¯»å–æˆ–å†™å…¥ã€‚</p><p>å¯¹ç³»ç»Ÿä¸Šçš„æ¯ä¸ªå—è®¾å¤‡ï¼Œblock éƒ½åŒ…å«ä¸€ä¸ªç›®å½•ï¼Œç›®å½•ä¸‹åŒ…å«è®¾å¤‡ä¸Šåˆ†åŒºçš„å­ç›®å½•ã€‚bus åŒ…å«ç³»ç»Ÿä¸Šæ³¨å†Œçš„æ€»çº¿ã€‚dev ä»¥åŸå§‹æ–¹å¼ï¼ˆæ— å±‚æ¬¡ç»“æ„ï¼‰åŒ…å«å·²æ³¨å†Œçš„è®¾å¤‡èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯/sys/devices ç›®å½•ä¸­çœŸå®è®¾å¤‡çš„ç¬¦å·é“¾æ¥ã€‚devices ç»™å‡ºç³»ç»Ÿå†…è®¾å¤‡çš„æ‹“æ‰‘ç»“æ„è§†å›¾ã€‚firmware æ˜¾ç¤ºç³»ç»Ÿç›¸å…³çš„ä½å±‚å­ç³»ç»Ÿæ ‘ï¼Œå¦‚ ACPIã€EFIã€OF ï¼ˆDTï¼‰ã€‚fs åˆ—å‡ºç³»ç»Ÿä¸Šå®é™…ä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚kernel ä¿å­˜å†…æ ¸é…ç½®é€‰é¡¹å’ŒçŠ¶æ€ä¿¡æ¯ã€‚module æ˜¯åŠ è½½çš„æ¨¡å—åˆ—è¡¨ã€‚</p><pre><code>kernel_kobjï¼šå¯¹åº”äº/sys/kernelpower_kobjï¼šå¯¹åº”äº/sys/powerfirmware_kobi ï¼šå¯¹åº”äº/sys/firmwareï¼Œå¯¼å‡ºåœ¨ drivers/baselirmware.c æºæ–‡ä»¶ä¸­hvpervisor_kobjï¼šå¯¹åº”äº/sys/hypervisorï¼Œå¯¼å‡ºåœ¨ drivers/base hypervisor.c ä¸­fs_kobjï¼šå¯¹åº”äº/sys/fsï¼Œå¯¼å‡ºåœ¨ fs/namespace.c æ–‡ä»¶ä¸­</code></pre><p>ç„¶è€Œï¼Œclass/ã€dev/ã€devices/æ˜¯åœ¨å¯åŠ¨æœŸé—´ç”±å†…æ ¸æºä»£ç å†… drivers_base/core.c ä¸­çš„ devices_init å‡½æ•°åˆ›å»ºçš„ï¼Œblock/åœ¨ block/genhd.c ä¸­åˆ›å»ºï¼Œbus/ åœ¨ drivers/base/bus.c ä¸­è¢«åˆ›å»ºä¸º ksetã€‚</p><p>kobject ç›®å½•è¢«æ·»åŠ åˆ° sysfsï¼ˆä½¿ç”¨ kobject_addï¼‰æ—¶ï¼Œå…¶æ·»åŠ ä½ç½®å–å†³äº kobject çš„çˆ¶é¡¹ã€‚å¦‚æœå…¶çˆ¶æŒ‡é’ˆå·²è®¾ç½®ï¼Œåˆ™å®ƒå°†è¢«æ·»åŠ ä¸ºçˆ¶ç›®å½•å†…çš„å­ç›®å½•ã€‚å¦‚æœçˆ¶æŒ‡é’ˆä¸º NULLï¼Œåˆ™å°†å…¶æ·»åŠ ä¸º kset-&gt;kobj å†…çš„å­ç›®å½•ã€‚å¦‚æœå…¶çˆ¶å’Œ kset å­—æ®µéƒ½æœªè®¾ç½®ï¼Œå®ƒå°†æ˜ å°„åˆ° sysfs å†…çš„æ ¹ç›®å½•ï¼ˆ/sysï¼‰ã€‚</p><h2 id="æŒ‚è½½-sysfs">æŒ‚è½½ sysfs</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t sysfs sysfs /sys</span><br></pre></td></tr></tbody></table></figure><h2 id="å±æ€§æ–‡ä»¶ä½¿ç”¨">å±æ€§æ–‡ä»¶ä½¿ç”¨</h2><h4 id="å±æ€§æ–‡ä»¶å®šä¹‰">å±æ€§æ–‡ä»¶å®šä¹‰</h4><p>è£¸å±æ€§ä¸åŒ…å«è¯»å–æˆ–å†™å…¥å±æ€§å€¼çš„æ–¹æ³•ã€‚ é¼“åŠ±å­ç³»ç»Ÿå®šä¹‰è‡ªå·±çš„å±æ€§ç»“æ„å’ŒåŒ…è£…å‡½æ•°ï¼Œä»¥ä¾¿ä¸ºç‰¹å®šå¯¹è±¡ç±»å‹æ·»åŠ å’Œåˆ é™¤å±æ€§ã€‚ ä¾‹å¦‚é©±åŠ¨æ¨¡å‹å®šä¹‰ struct device_attribute å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> {</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute</span><span class="title">attr</span>;</span></span><br><span class="line"><span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line"><span class="type">char</span> *buf);</span><br><span class="line"><span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å®ƒè¿˜å®šä¹‰äº†ç”¨äºå®šä¹‰è®¾å¤‡å±æ€§çš„ helper ç¨‹åºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_ATTR(_name, _mode, _show, _store) \</span></span><br><span class="line"><span class="meta">    struct device_attribute dev_attr_##_name = __ATTR(_name, _mode, _show, _store)</span></span><br></pre></td></tr></tbody></table></figure><p>ä¾‹å¦‚åšå¦‚ä¸‹å£°æ˜ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="title function_">DEVICE_ATTR</span><span class="params">(foo, S_IWUSR | S_IRUGO, show_foo, store_foo)</span>;</span><br></pre></td></tr></tbody></table></figure><p>ç›¸å½“äºå®šä¹‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> <span class="title">dev_attr_foo</span> =</span> {</span><br><span class="line">.attr = {</span><br><span class="line">.name = <span class="string">"foo"</span>,</span><br><span class="line">.mode = S_IWUSR | S_IRUGO,</span><br><span class="line">},</span><br><span class="line">.show = show_foo,</span><br><span class="line">.store = store_foo,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h4 id="å­ç³»ç»Ÿå®šä¹‰å›è°ƒ">å­ç³»ç»Ÿå®šä¹‰å›è°ƒ</h4><p>å½“å­ç³»ç»Ÿå®šä¹‰æ–°çš„å±æ€§ç±»å‹æ—¶ï¼Œå®ƒå¿…é¡»å®ç°ä¸€ç»„ sysfs æ“ä½œï¼Œä»¥å°†è¯»å–å’Œå†™å…¥è°ƒç”¨è½¬å‘åˆ°å±æ€§æ‰€æœ‰è€…çš„ show å’Œ store æ–¹æ³•ã€‚è¯»å–æˆ–å†™å…¥æ–‡ä»¶æ—¶ï¼Œsysfs ä¼šè°ƒç”¨è¯¥ç±»å‹çš„é€‚å½“æ–¹æ³•ã€‚ ç„¶åè¯¥æ–¹æ³•å°†é€šç”¨ struct kobject å’Œ struct attribute æŒ‡é’ˆè½¬æ¢ä¸ºé€‚å½“çš„æŒ‡é’ˆç±»å‹ï¼Œå¹¶è°ƒç”¨å…³è”çš„æ–¹æ³•ã€‚</p><p>é˜æ˜ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> to_dev(obj) container_of(obj, struct device, kobj)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> to_dev_attr(_attr) container_of(_attr, struct device_attribute, attr)</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">dev_attr_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> attribute *attr,</span></span><br><span class="line"><span class="params">                             <span class="type">char</span> *buf)</span></span><br><span class="line">{</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> *<span class="title">dev_attr</span> =</span> to_dev_attr(attr);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> to_dev(kobj);</span><br><span class="line">        <span class="type">ssize_t</span> ret = -EIO;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dev_attr-&gt;show)</span><br><span class="line">                ret = dev_attr-&gt;show(dev, dev_attr, buf);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt;= (<span class="type">ssize_t</span>)PAGE_SIZE) {</span><br><span class="line">                print_symbol(<span class="string">"dev_attr_show: %s returned bad count\n"</span>,</span><br><span class="line">                                (<span class="type">unsigned</span> <span class="type">long</span>)dev_attr-&gt;show);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œé€šè¿‡ to_dev_attr å®å®šä¹‰ï¼ˆcontainer_of æ–¹æ³•ï¼‰é€šè¿‡ kobject ç»“æ„ä½“æ‰¾åˆ°å­ç³»ç»Ÿæˆ–è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„æŒ‡é’ˆï¼Œè¿™é‡Œä»¥ device_attribute ä¸ºä¾‹ï¼Œè¯¥æ•°æ®ç»“æ„è¦å®ç°è‡ªå·±çš„ show å’Œ store æ–¹æ³•ã€‚å¾—åˆ° device_attribute æ•°æ®åœ°å€åè°ƒç”¨è¯¥æ•°æ®çš„ show/store æ–¹æ³•ã€‚</p><blockquote><p>å¯ä»¥çœ‹åˆ° kobject å®é™…ä¸Šå®ç°äº†ä¸€å¥—æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å¸®ç»„ç”¨æˆ·æ–¹ä¾¿çš„åˆ›å»ºæ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶å¹¶æä¾›è®¿é—®æ–‡ä»¶çš„æ–¹æ³•ï¼Œè€Œå®ƒæœ¬èº«å¹¶æœªå®ç°å…·ä½“çš„æ“ä½œã€‚</p></blockquote><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥çœ‹çœ‹å…·ä½“çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">show_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span><br><span class="line"><span class="params">                         <span class="type">char</span> *buf)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> scnprintf(buf, PAGE_SIZE, <span class="string">"%s\n"</span>, dev-&gt;name);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">store_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span><br><span class="line"><span class="params">                          <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span></span><br><span class="line">{</span><br><span class="line">        <span class="built_in">snprintf</span>(dev-&gt;name, <span class="keyword">sizeof</span>(dev-&gt;name), <span class="string">"%.*s"</span>,</span><br><span class="line">                 (<span class="type">int</span>)min(count, <span class="keyword">sizeof</span>(dev-&gt;name) - <span class="number">1</span>), buf);</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEVICE_ATTR</span><span class="params">(name, S_IRUGO, show_name, store_name)</span>;</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9kZXZpY2VfbW9kZWw=">çªçªç§‘æŠ€ç›¸-è®¾å¤‡é©±åŠ¨æ¨¡å‹<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW55aW5nMTI2L2FydGljbGUvZGV0YWlscy83ODA3OTk0Mg==">https://blog.csdn.net/chenying126/article/details/78079942<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC9sYXRlc3QvZmlsZXN5c3RlbXMvc2VxX2ZpbGUuaHRtbA==">https://www.kernel.org/doc/html/latest/filesystems/seq_file.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzIyMzU5Lw==">https://lwn.net/Articles/22359/<i class="fa fa-external-link-alt"></i></span><br>ã€Šlinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹<br>ã€Šlinux å†…æ ¸æ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
            <tag> FileSystem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux é©±åŠ¨ä¹‹è®¾å¤‡é©±åŠ¨æ¨¡å‹</title>
      <link href="/2020/LinuxDriver/LinuxDriverDeviceModule/"/>
      <url>/2020/LinuxDriver/LinuxDriverDeviceModule/</url>
      
        <content type="html"><![CDATA[<h1 id="kobject">kobject</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><ul><li>Kobjects æœ‰ä¸€ä¸ª name å’Œä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œè¿˜å…·æœ‰çˆ¶æŒ‡é’ˆï¼ˆå…è®¸å°†å¯¹è±¡æ’åˆ—æˆå±‚æ¬¡ç»“æ„ï¼‰</li><li>ktype æ˜¯åµŒå…¥åœ¨ kobject ç»“æ„ä½“ä¸­çš„å¯¹è±¡ã€‚ æ¯ä¸ª kobject ç»“æ„éƒ½éœ€è¦ä¸€ä¸ªç›¸åº”çš„ ktypeã€‚ ktype æ§åˆ¶ kobject åœ¨åˆ›å»ºå’Œé”€æ¯æ—¶çš„è¡Œä¸º</li><li>kset æ˜¯ä¸€ç»„ kobjects(kset æœ¬èº«åŒ…å«ä¸€ä¸ª kobject), è¿™äº› kobject å¯ä»¥æ‹¥æœ‰ç›¸åŒçš„ ktypeï¼Œkset ä¹Ÿæ˜¯ sysfs ä¸­çš„ä¸€ä¸ªå­ç›®å½•ã€‚Ksets å¯ä»¥æ”¯æŒ kobjects çš„â€œçƒ­æ’æ‹”â€ï¼ˆuevent äº‹ä»¶ï¼‰</li></ul><span id="more"></span><h2 id="kobject-çš„æ•°æ®ç»“æ„å’Œå®ç°">kobject çš„æ•°æ®ç»“æ„å’Œå®ç°</h2><p>ä¸‹å›¾å±•ç¤ºäº† kobjectã€ktype å’Œ kset ä¸‰è€…æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE2ZmU3ZDljMDg2NjUxM2U5ZDA4">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Kobject_Struct.png"></p><ul><li><p>sysfs_ops: show æ˜¯å›è°ƒå‡½æ•°ï¼Œåœ¨è¯»å–å…·æœ‰è¯¥ kobj_type çš„æ‰€æœ‰å±æ€§æ—¶è°ƒç”¨ä»–ã€‚ç¼“å†²åŒºé•¿åº¦å§‹ç»ˆæ˜¯ PAGE_SIZEï¼Œåœ¨æˆåŠŸæ—¶è¿”å›å†™å…¥ç¼“å†²åŒºçš„æ•°æ®å¤§å°ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç ã€‚å†™å…¥çš„æ—¶å€™è°ƒç”¨ store å‡½æ•°ï¼Œå…¶å‚æ•° buf æœ€å¤§ä¸º PAGE_SIZEï¼ŒæˆåŠŸè¿”å›å†™å…¥æ•°æ®å¤§å°ï¼Œå¤±è´¥è¿”å›é”™è¯¯ç </p></li><li><p>uevent_ops: æ˜¯æ­¤ kset çš„ uevent æ“ä½œé›†</p></li><li><p>attribute: æ˜¯ç”± kobject å¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´ sysfs æ–‡ä»¶ï¼Œattribute è¡¨ç¤ºå¯ä»¥ä»ç”¨æˆ·ç©ºé—´è¯»å–ã€å†™å…¥æˆ–åŒæ—¶å…·æœ‰è¿™ä¸¤è€…çš„å¯¹è±¡å±æ€§ï¼Œå±æ€§å°†å†…æ ¸æ•°æ®æ˜ å°„åˆ° sysfs ä¸­çš„æ–‡ä»¶</p></li></ul><p>ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿæ·»åŠ /åˆ é™¤å±æ€§çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __must_check <span class="title function_">sysfs_create_file</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="keyword">struct</span> attribute *attr)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sysfs_remove_file</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">     <span class="type">const</span> <span class="keyword">struct</span> attribute *attr)</span>;</span><br></pre></td></tr></tbody></table></figure><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„ attribute_group å¾ˆå¸¸ç”¨ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*name;</span><br><span class="line"><span class="type">umode_t</span>(*is_visible)(<span class="keyword">struct</span> kobject *,</span><br><span class="line">      <span class="keyword">struct</span> attribute *, <span class="type">int</span>);</span><br><span class="line"><span class="type">umode_t</span>(*is_bin_visible)(<span class="keyword">struct</span> kobject *,</span><br><span class="line">  <span class="keyword">struct</span> bin_attribute *, <span class="type">int</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute</span>**<span class="title">attrs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span>**<span class="title">bin_attrs</span>;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>attrs å­—æ®µæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä»–æŒ‡å‘ä»¥ NULL ç»“å°¾çš„å±æ€§åˆ—è¡¨ï¼Œæ¯ä¸ªå±æ€§ç»„å¿…é¡»èµ‹äºˆä¸€ä¸ªæŒ‡å‘ struct attribute å…ƒç´ åˆ—è¡¨/æ•°ç»„çš„æŒ‡é’ˆï¼Œè¯¥ group åªæ˜¯ä¸€ä¸ª helper åŒ…è£…å™¨ï¼Œä»¥ä¾¿ç®¡ç†å¤šä¸ªå±æ€§ã€‚ åœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªå±æ€§æ–‡ä»¶ç„¶ååµŒå…¥åœ¨ struct attribute_group ç»“æ„ä½“ä¸­ï¼Œä¹‹åè°ƒç”¨å¦‚ä¸‹å‡½æ•°å¯ä»¥ä¸€æ¬¡å°†å¤šä¸ªå±æ€§æ·»åŠ /åˆ é™¤åˆ°ç³»ç»Ÿã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __must_check <span class="title function_">sysfs_create_group</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="keyword">struct</span> attribute_group *grp)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sysfs_remove_group</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">            <span class="type">const</span> <span class="keyword">struct</span> attribute_group *grp)</span>;</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹å›¾å±•ç¤ºäº† kset å’Œ kobject é€šå¸¸çš„ç»„ç»‡å…³ç³»ï¼Œå½¢æˆå±‚çº§å…³ç³»ï¼Œå½“å…¶ä»–ç»“æ„éœ€è¦æ„å»ºå±‚çº§å…³ç³»æˆ–éœ€è¦å¼•ç”¨è®¡æ•°çš„æ—¶å€™éƒ½å¯ä»¥å°†è¿™ä¸ªæ•°æ®ç»“æ„åµŒå…¥è¿›å»ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE3NTIxZWZhZDQxZDgyNWM3Zjc5">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/Kobject_List.png"></p><h2 id="ç”¨æ³•api">ç”¨æ³•ï¼ˆAPIï¼‰</h2><ol type="1"><li>åˆ›å»º kobjec çš„ä»£ç å¿…é¡»åˆå§‹åŒ–è¯¥å¯¹è±¡ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kobject_init</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype)</span>;</span><br></pre></td></tr></tbody></table></figure><ol start="2" type="1"><li>æ­£ç¡®åˆ›å»º kobject éœ€è¦ ktypeï¼Œå› ä¸ºæ¯ä¸ª kobject éƒ½å¿…é¡»æœ‰ä¸€ä¸ªå…³è”çš„ kobj_typeã€‚ è°ƒç”¨ kobject_init() åï¼Œè¦å‘ sysfs æ³¨å†Œ kobjectï¼Œå¿…é¡»è°ƒç”¨å‡½æ•° kobject_add()ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobject *parent, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœ kobject è¦ä¸ç‰¹å®šçš„ kset ç›¸å…³è”ï¼Œkobj-&gt;kset å¿…é¡»åœ¨è°ƒç”¨ kobject_add() ä¹‹å‰èµ‹å€¼ã€‚ å¦‚æœ kset æ˜¯ä¸ kobject ç›¸å…³è”çš„ï¼Œé‚£ä¹ˆ kobject çš„çˆ¶çº§å¯ä»¥åœ¨è°ƒç”¨ kobject_add() æ—¶è®¾ç½®ä¸º NULLï¼Œç„¶å kobject çš„çˆ¶çº§å°†æ˜¯ kset æœ¬èº«ã€‚</p><ol start="3" type="1"><li>ç”±äº kobject çš„åç§°æ˜¯åœ¨æ·»åŠ åˆ°å†…æ ¸æ—¶è®¾ç½®çš„ï¼Œå› æ­¤ä¸åº”ç›´æ¥æ“ä½œ kobject çš„åç§°ã€‚ å¦‚æœå¿…é¡»æ›´æ”¹ kobject çš„åç§°ï¼Œè¯·è°ƒç”¨ kobject_rename()ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_rename</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="type">const</span> <span class="type">char</span> *new_name)</span>;</span><br></pre></td></tr></tbody></table></figure><ol start="4" type="1"><li>æœ‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°å¯ä»¥åˆå§‹åŒ– kobject å¹¶å°†å…¶æ·»åŠ åˆ°å†…æ ¸åŒæ—¶è°ƒç”¨ kobject_init_and_add()ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_init_and_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype,</span></span><br><span class="line"><span class="params">                        <span class="keyword">struct</span> kobject *parent, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br></pre></td></tr></tbody></table></figure><ol start="5" type="1"><li>åœ¨ kobject æ³¨å†Œåˆ° kobject æ ¸å¿ƒåï¼Œæ‚¨éœ€è¦é€šçŸ¥å®ƒå·²è¢«åˆ›é€ ã€‚ è¿™å¯ä»¥é€šè¿‡è°ƒç”¨ kobject_uevent() æ¥å®Œæˆï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_uevent</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">enum</span> kobject_action action)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å½“ kobject ä»å†…æ ¸ä¸­åˆ é™¤æ—¶ï¼Œ KOBJ_REMOVE çš„ uevent å°†ç”± kobject æ ¸å¿ƒè‡ªåŠ¨è°ƒç”¨ï¼Œå› æ­¤è°ƒç”¨è€…ä¸å¿…æ‹…å¿ƒæ‰‹åŠ¨æ‰§è¡Œæ­¤æ“ä½œã€‚</p><ol start="6" type="1"><li>kobject çš„å…³é”®åŠŸèƒ½ä¹‹ä¸€æ˜¯ç”¨ä½œåµŒå…¥å®ƒçš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œç”¨äºæ“ä½œ kobject å¼•ç”¨è®¡æ•°çš„å‡½æ•°æ˜¯ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> kobject *<span class="title function_">kobject_get</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kobject_put</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span>;</span><br></pre></td></tr></tbody></table></figure><p>å½“å¼•ç”¨è¢«é‡Šæ”¾æ—¶ï¼Œå¯¹ kobject_put() çš„è°ƒç”¨å°†å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå¹¶å¯èƒ½é‡Šæ”¾å¯¹è±¡ã€‚</p><ol start="7" type="1"><li>æ¯ä¸ªæ³¨å†Œçš„ kset å¯¹åº” sysfs ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨ kset_create_and_add() å‡½æ•°åˆ›å»ºå’Œæ·»åŠ  ksetï¼Œä½¿ç”¨ kset_unregister() å‡½æ•°å°†å…¶åˆ é™¤</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kset * __must_check <span class="title function_">kset_create_and_add</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> kset_uevent_ops *u,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> kobject *parent_kobj)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">kset_unregister</span><span class="params">(<span class="keyword">struct</span> kset *kset)</span></span><br></pre></td></tr></tbody></table></figure><p>å› ä¸º kobject æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸èƒ½é™æ€å£°æ˜æˆ–åœ¨å †æ ˆä¸Šå£°æ˜ï¼Œè€Œæ˜¯å§‹ç»ˆåŠ¨æ€åˆ†é…ã€‚ å†…æ ¸çš„æœªæ¥ç‰ˆæœ¬å°†åŒ…å«å¯¹é™æ€åˆ›å»ºçš„ kobjects çš„è¿è¡Œæ—¶æ£€æŸ¥ï¼Œå¹¶å°†è­¦å‘Šå¼€å‘äººå‘˜è¿™ç§ä¸æ­£ç¡®çš„ä½¿ç”¨ã€‚</p><h2 id="example">example</h2><p>å‚è€ƒ samples/kobject/kobject-example.c</p><h1 id="busdevice-å’Œ-driver">busã€device å’Œ driver</h1><h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2><p>è¦ç†è§£ linux é©±åŠ¨çš„è®¾è®¡ï¼Œé¦–å…ˆè¦ç†æ¸…æ¥š linux é©±åŠ¨æœ€é‡è¦çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œstruct device, struct device_driver, struct bus è¿™äº›æ•°æ®ç»“æ„æ˜¯ç†è§£ Linux é©±åŠ¨çš„å…³é”®ï¼Œä¸‹é¢å…ˆä»æ•´ä½“ä¸Šçœ‹ä¸€ä¸‹è¿™å‡ ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE3YTFlNDAxZmQzYzI0OWRjZmVj">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/BusStruct.png"></p><ul><li><p>bus: bus ç»“æ„ä½“ç”¨äºæŠ½è±¡ç³»ç»Ÿä¸­æ€»çº¿çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªå¯ä»¥æ˜¯å®é™…çš„æ€»çº¿ï¼Œä¾‹å¦‚ iicã€spi æ€»çº¿ï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæ€»çº¿ platform æ€»çº¿ã€‚struct bus ç»“æ„ä½“ç®¡ç†æŒ‚è½½åœ¨è¯¥ bus ä¸‹çš„ struct device å’Œ struct device_driver, è´Ÿè´£ device å’Œ device_driver çš„åŒ¹é…ï¼Œè°ƒç”¨ probe ç­‰å·¥ä½œã€‚å…¶ä¸­ç®¡ç† struct device å’Œ struct device_driver çš„åŠŸèƒ½ç‹¬ç«‹å‡ºæ¥æˆä¸ºä¸€ä¸ªå­ç³»ç»Ÿå« subsys_privateï¼Œè¯¥æ•°æ®ç»“æ„é™¤äº†ç®¡ç†è¯¥ bus ä¸‹çš„è®¾å¤‡å’Œé©±åŠ¨å¤–è¿˜ç”¨äºå¤„ç† busï¼Œdevice å’Œ device_driver çš„ä¸€äº›é»˜è®¤å±æ€§ï¼ˆå…¬å…±å±æ€§ï¼‰ï¼Œuevent äº‹ä»¶ç­‰ã€‚å¯ä»¥çœ‹åˆ° subsys_private æ•°æ®ç»“æ„ä¸‹æœ‰ä¸¤ä¸ªé“¾è¡¨ä¸€ä¸ªç”¨äºæŒ‚è½½ device å¦ä¸€ä¸ªç”¨äºæŒ‚è½½ device_driver, ä»è€Œå®ç° bus å¯¹ device å’Œ device_driver ç®¡ç†</p></li><li><p>device: device ç»“æ„ä½“ç”¨äºæŠ½è±¡é©±åŠ¨è®¾å¤‡ï¼Œç³»ç»Ÿä¸‹æŒ‚è½½çš„è®¾å¤‡éƒ½æ˜¯é€šè¿‡ struct device ç»“æ„ä½“æ¥æè¿°ï¼Œå…¶ä¸­ dts é‡Œå®šä¹‰çš„å¾ˆå¤šèŠ‚ç‚¹éƒ½ä¼šè½¬æ¢ä¸º struct device ç»“æ„ä½“ï¼Œç”¨äºæè¿°ä¸€ä¸ªè®¾å¤‡ä¿¡æ¯ï¼Œç®¡ç†è®¾å¤‡ç”¨åˆ°çš„èµ„æºç­‰ã€‚device ç»“æ„ä½“ä¸‹ä¸€ä¸ªé‡è¦ç»“æ„æ˜¯ device_privateï¼Œè¯¥ç»“æ„ä½“æˆå‘˜ knode_bus å°±æ˜¯ç”¨äºæŒ‚è½½åˆ°ä¸Šé¢æåˆ°çš„ bus ä¸‹çš„ subsys_private ç»“æ„ä½“ä¸­çš„ klist_devices</p></li><li><p>device_driver: device_driver ç»“æ„ä½“ç”¨äºæè¿°å¯¹ struct device ç»“æ„ä½“æè¿°çš„è®¾å¤‡çš„é©±åŠ¨æ–¹æ³•ï¼Œæ¯”å¦‚å¯¹äºé€šä¿¡åè®®çš„å®ç°ï¼Œå¯¹æ§åˆ¶å™¨çš„æ“ä½œç­‰ã€‚è¿™æ ·è®¾å¤‡å’Œè®¾å¤‡çš„é©±åŠ¨å®ç°åˆ†ç¦»å•ç‹¬ç®¡ç†ï¼Œè€Œè®¾å¤‡å’Œé©±åŠ¨åˆ†ç¦»åä¸¤è€…çš„åŒ¹é…å·¥ä½œå°±æ˜¯ bus å®Œæˆçš„ï¼Œdevice_driver æ˜¯ç”¨æˆ·éœ€è¦ç¼–å†™çš„å…·ä½“æ“ä½œè®¾å¤‡çš„æ–¹æ³•å’Œæµç¨‹ã€‚åŒæ · struct device_driver ç»“æ„ä½“ä¸‹çš„ driver_private çš„ knode_bus ç”¨äºé“¾æ¥åˆ° struct bus ä¸‹ subsys_private ç»“æ„ä½“ä¸­çš„ klist_drivers</p></li></ul><p>ä¸‰è€…æ•°æ®ç»“æ„å®é™…ä½¿ç”¨ä¸­çš„è¿æ¥å…³ç³»å¯èƒ½å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzVlZjMxMWI3MWUwODUzMjYzNzQxNDc3Ny5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/BusList.png"></p><p>bus å’Œ device ä»¥åŠ device_driver ä¸‹éƒ½æœ‰ä¸€ä¸ª private æˆ– subsys ç»“æ„ç”¨æ¥å¤„ç†ä¸€äº›å…±æ€§çš„å·¥ä½œï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„æŠ½è±¡ç»“æ„ã€‚</p><h2 id="å®ç°">å®ç°</h2><p>å¥½äº†åˆ°ç°åœ¨æˆ‘ä»¬å·²ç»æ¸…æ¥šæœ€é‡è¦çš„ä¸‰ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»äº†ï¼Œæ¥ä¸‹æ¥æ˜¯å…³äº device å’Œ device_driver æ˜¯å¦‚ä½•åŒ¹é…ä¸Šçš„ï¼Œdevice å’Œ device_driver ä¸€ä¸ªæè¿°äº†è®¾å¤‡ä¸€ä¸ªæ˜¯æ‹¥æœ‰é©±åŠ¨è®¾å¤‡çš„æ–¹æ³•ï¼Œä½†æ˜¯ linux ä¸‹è®¾å¤‡éå¸¸å¤šï¼Œæ¯ä¸ªè®¾å¤‡éƒ½è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„é©±åŠ¨ç¨‹åºæ¥é©±åŠ¨ï¼Œä¸‹é¢è¯¦ç»†çœ‹ä¸‹ device å’Œ device_driver çš„å…³è”è¿‡ç¨‹ã€‚</p><h3 id="device-çš„æ³¨å†Œè¿‡ç¨‹">device çš„æ³¨å†Œè¿‡ç¨‹</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">device_register</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">{</span><br><span class="line">device_initialize(dev);</span><br><span class="line"><span class="keyword">return</span> device_add(dev);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL_GPL(device_register);</span><br></pre></td></tr></tbody></table></figure><p>åˆå§‹åŒ–è®¾å¤‡å¹¶å°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚å…¶ä¸­ device_initialize åˆå§‹åŒ– device ç»“æ„ä½“ï¼Œä¸»è¦æ˜¯ kobject_init åˆå§‹åŒ– kobj ç»“æ„ä½“ï¼Œå…¶ä»–å°±æ˜¯åˆå§‹åŒ–ä¸€äº›é”ã€é“¾è¡¨æŒ‡é’ˆä¹‹ç±»çš„ï¼Œé‡ç‚¹æ˜¯ device_add è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code> 1. åˆå§‹åŒ– device_private ç»“æ„ä½“ 2. ä½¿ç”¨ bus-&gt;dev_name + dev-&gt;id ä¸º dev-&gt;init_name è‡ªåŠ¨å‘½å 3. å¢åŠ  device å¼•ç”¨æ¬¡æ•° 4. å¦‚æœæ²¡æœ‰ classï¼Œåˆ™å­ç³»ç»Ÿä¸ºè®¾å¤‡æŒ‡å®šé»˜è®¤çš„ root è·¯å¾„ (bus-&gt;dev_root) 5. kobject åç§°åœ¨æ­¤å‡½æ•°ä¸­è®¾ç½®å¹¶æ·»åŠ åˆ° kobject å±‚æ¬¡ç»“æ„ä¸­ 6. é€šçŸ¥æ–°è®¾å¤‡åŠ å…¥ 7. ä¸º device åˆ›å»º sysfs æ–‡ä»¶ 8. å°† device æ·»åŠ åˆ° busï¼ˆå°† dev-&gt;p-&gt;knode_bus åŠ å…¥åˆ° us-&gt;p-&gt;klist_devices) 9. åˆ›å»º dev ç›®å½• 10. é€šçŸ¥å®¢æˆ·ç«¯æœ‰æ–°è®¾å¤‡æ·»åŠ  11. è°ƒç”¨æœ€é‡è¦çš„å‡½æ•°ä¸º device_probe_driver</code></pre><p>ä¸‹é¢ä¸»è¦ä»‹ç» bus_probe_device è¿™ä¸ªå‡½æ•°ï¼Œç”±äºå‡½æ•°è°ƒç”¨å±‚çº§è¾ƒå¤šï¼Œè¿™é‡Œä¸æ‰“ç®—å°†å‡½æ•°ä¸€ä¸€åˆ—å‡ºï¼Œè€Œæ˜¯æ¢³ç†å‡ºè°ƒç”¨å…³ç³»ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxMTY4ODc1N2Q5YzA4MDZlNGFlZmUzOS5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/DeviceRegister.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ match å‡½æ•°çš„å®ç°æ˜¯å…·ä½“çš„ bus å®ç°çš„å‡½æ•°ï¼Œä¾‹å¦‚ platform bus ä¼šå®ç°è‡ªå·±çš„ match å‡½æ•°ï¼Œåç»­ä¼šæœ‰æ–‡ç« è¿›è¡Œä»‹ç»ï¼Œå…³äº probe å‡½æ•°ï¼Œä¸€èˆ¬ bus ä¹Ÿä¼šå®ç°è‡ªå·±çš„ probe å‡½æ•°ï¼Œç„¶å bus ä¸‹çš„ probe å‡½æ•°ä¼šè°ƒç”¨ driver æ•°æ®ç»“æ„çš„ probe å‡½æ•°ã€‚</p><h3 id="driver-çš„æ³¨å†Œè¿‡ç¨‹">driver çš„æ³¨å†Œè¿‡ç¨‹</h3><p>driver çš„æ³¨å†Œæ˜¯é€šè¿‡ driver_register è¯¥å‡½æ•°å®Œæˆçš„ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»é˜…è¯»æºç ã€‚åŒæ ·å…³äº driver çš„æ³¨å†Œè¿™é‡Œä¹Ÿè´´ä¸€å¼ å›¾ï¼š<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxMTdjMmMzMGUzZTc0MDdkM2EwZjNhNy5wbmc=">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/DriverRegister.png"></p><p>driver å’Œ device çš„æ³¨å†Œç±»ä¼¼ï¼Œéƒ½ä¼šåœ¨è‡ªå·±æŒ‚è½½çš„ bus ä¸Šå»éå†å¯¹æ–¹çš„æ‰€æœ‰è®¾å¤‡æˆ–é©±åŠ¨ç„¶åè¿›è¡Œéå†åŒ¹é…ï¼Œå½“åŒ¹é…ä¸Šäº†å°†ä¸¤ä¸ªæ•°æ®ç»“æ„å…³è”ç„¶åè°ƒç”¨ driver çš„ probe å‡½æ•°ã€‚è€Œ driver çš„ probe å‡½æ•°ä¹Ÿå°±æ˜¯é©±åŠ¨ç¨‹åºçš„å…¥å£ï¼Œç”¨æˆ·éœ€è¦å®ç°çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªå‡½æ•°é‡Œå®ç°ã€‚</p><h3 id="bus-çš„æ³¨å†Œè¿‡ç¨‹">bus çš„æ³¨å†Œè¿‡ç¨‹</h3><p>ä¸Šé¢å·²ç»å°† device å’Œ driver ä»‹ç»å®Œäº†ï¼Œdevice å’Œ driver éƒ½å°†æ³¨å†Œåˆ° busï¼Œç„¶å bus ç®¡ç†ä¸¤ä¸ªé“¾è¡¨ä¸€ä¸ª device é“¾è¡¨ä¸€ä¸ª driver é“¾è¡¨ï¼Œç°åœ¨æˆ‘ä»¬å†çœ‹çœ‹ bus æ•°æ®æœ¬èº«çš„ä¸€æ³¨å†Œè¿‡ç¨‹ã€‚ bus_register å‡½æ•°å®Œæˆ bus çš„æ³¨å†Œï¼Œè¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code> 1. ä¸º subsys_private åˆ†é…å†…å­˜ç©ºé—´ 2. åˆå§‹åŒ– subsys_private ç»“æ„ä½“ï¼Œå¹¶å°† bus-&gt;p æŒ‡å‘è¿™å—å†…å­˜ 3. è®¾ç½® priv-&gt;subsys.kobj çš„ name ä¸º bus-&gt;name 4. åˆå§‹åŒ– subsys_private çš„ kobjã€ksetï¼Œktype ç»“æ„ä½“ 5. æ³¨å†Œ ksetï¼Œä¼šåœ¨ sysfs æ–‡ä»¶ç³»ç»Ÿä¸‹åˆ›å»ºç›®å½• 6. å‘ bus ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª uevent attribute 7. åˆ†åˆ«å‘å†…æ ¸æ·»åŠ  devices å’Œ device_drivers ksetï¼Œä¼šä½“ç°åœ¨ sysfs ä¸­ 8. åˆå§‹åŒ– subsys_private é‡Œçš„ mutexã€klist_devices å’Œ klist_drivers ç­‰å˜é‡ 9. åœ¨ bus ä¸‹æ·»åŠ  drivers_probe å’Œ drivers_autoprobe ä¸¤ä¸ª attributeï¼Œå¦‚/sys/bus/spi/drivers_probe å’Œ/sys/bus/spi/drivers_autoprobeï¼‰ï¼Œå…¶ä¸­ drivers_probe å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºä¸»åŠ¨å‡ºå‘æŒ‡å®š bus ä¸‹çš„ device_driver çš„ probe åŠ¨ä½œï¼Œè€Œ drivers_autoprobe æ§åˆ¶æ˜¯å¦åœ¨ device æˆ– device_driver æ·»åŠ åˆ°å†…æ ¸æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œ probe 10. è°ƒç”¨ bus_add_attrsï¼Œæ·»åŠ ç”± bus_attrs æŒ‡é’ˆå®šä¹‰çš„ bus çš„é»˜è®¤ attributeï¼Œè¿™äº› attributes æœ€ç»ˆä¼šä½“ç°åœ¨/sys/bus/xxx ç›®å½•ä¸‹</code></pre><p>bus çš„æ³¨å†ŒåŸºæœ¬ä¸Šæ˜¯å¯¹è‡ªå·±å†…éƒ¨çš„æ•°æ®åˆå§‹åŒ–ä»¥ä¾¿äºå…·ä½“çš„ bus ç»“æ„ä½“ä½¿ç”¨ï¼Œä¾‹å¦‚ platform æ€»çº¿è¿›è¡Œä½¿ç”¨ã€‚</p><h1 id="class">class</h1><p>class æ•°æ®ç»“æ„æ˜¯ä¸€ç§æŠ½è±¡ç»“æ„ï¼Œclass æ˜¯å°†ä¸€äº›å…±æ€§çš„å±æ€§æˆ–æ“ä½œæå–å‡ºæ¥å•ç‹¬æˆä¸ºä¸€ä¸ªæ•°æ®ç»“æ„ä»¥æé«˜ä»£ç å¤ç”¨ç‡å‡å°‘é‡å¤ä»£ç ã€‚å®˜æ–¹æ–‡æ¡£çš„æè¿°æ˜¯ï¼š</p><pre><code>A device class describes a type of device, like an audio or network device.</code></pre><p>ä¸‹é¢æ˜¯ class æ•°æ®ç»“æ„å†…å®¹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> {</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*name; <span class="comment">// class çš„åç§°</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span>*<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_attribute</span>*<span class="title">class_attrs</span>;</span> <span class="comment">// class çš„é»˜è®¤å±æ€§</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>**<span class="title">dev_groups</span>;</span> <span class="comment">// å±äºè¯¥ class çš„ device çš„é»˜è®¤å±æ€§</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>*<span class="title">dev_kobj</span>;</span> <span class="comment">// ä»£è¡¨è¯¥ class çš„å±‚çº§å…³ç³»</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*dev_uevent)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> kobj_uevent_env *env); <span class="comment">// å½“æœ‰è®¾å¤‡æ·»åŠ åˆ° class æˆ–ä» class ç§»é™¤æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="type">char</span> *(*devnode)(<span class="keyword">struct</span> device *dev, <span class="type">umode_t</span> *mode);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*class_release)(<span class="keyword">struct</span> class *class); <span class="comment">//class é”€æ¯æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="type">void</span> (*dev_release)(<span class="keyword">struct</span> device *dev); <span class="comment">//release ä¸€ä¸ª device</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*suspend)(<span class="keyword">struct</span> device *dev, <span class="type">pm_message_t</span> state); <span class="comment">//ä¼‘çœ æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="type">int</span> (*resume)(<span class="keyword">struct</span> device *dev); <span class="comment">//å”¤é†’æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="type">int</span> (*shutdown)(<span class="keyword">struct</span> device *dev); <span class="comment">//å…³æœºæ—¶è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_ns_type_operations</span> *<span class="title">ns_type</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">void</span> *(*namespace)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span> <span class="comment">//å±äºè¯¥ class çš„ device çš„é»˜è®¤ç”µæºç®¡ç†æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span> <span class="comment">//å­ç³»ç»Ÿï¼Œè·Ÿ bus ä¸‹çš„ç›¸åŒå«ä¹‰</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>å…¶å®è¿™é‡Œ class å°±æ˜¯ä¸€ä¸ªå¤šè®¾å¤‡å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨å°±æ˜¯æ–¹ä¾¿ç®¡ç†è®¾å¤‡çš„ï¼ˆå½“ç„¶ bus ä¹Ÿæ˜¯ç®¡ç†è®¾å¤‡çš„æ•°æ®ç»“æ„ï¼Œbus æ˜¯ç®¡ç†åŒä¸€æ€»çº¿ä¸Šçš„è®¾å¤‡å’Œè®¾å¤‡é©±åŠ¨çš„ï¼‰ï¼Œclass å°†è®¾å¤‡è¿›è¡Œåˆ†ç±»ç®¡ç†ï¼ˆå¦ä¸€ä¸ªç»´åº¦ï¼ŒåŒºåˆ«äº busï¼‰å¹¶æä¾› api æ–¹ä¾¿é©±åŠ¨å¼€å‘äººå‘˜è¿›è¡Œç®¡ç†è®¾å¤‡ã€‚</p><h1 id="uevent">Uevent</h1><p>Uevent æ˜¯ Kobject çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºåœ¨ Kobject çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¾‹å¦‚å¢åŠ ã€ç§»é™¤ç­‰ï¼Œé€šçŸ¥ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¶åˆ°è¿™æ ·çš„äº‹ä»¶åï¼Œä¼šåšç›¸åº”çš„å¤„ç†ã€‚è¯¥æœºåˆ¶é€šå¸¸æ˜¯ç”¨æ¥æ”¯æŒçƒ­æ‹”æ’è®¾å¤‡çš„ï¼Œä»è€ŒåŠ¨æ€çš„æ”¯æŒè¯¥è®¾å¤‡ã€‚</p><h2 id="å®ç°-1">å®ç°</h2><p>uevent ç›¸å…³æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwMjIwNzkxMjkwNmIyYTNmNDMx">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/uevent.png"></p><p>ä¸»è¦çš„å®ç°å‡½æ•°å°±æ˜¯ kobject_uevent å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_uevent</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">enum</span> kobject_action action)</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">return</span> kobject_uevent_env(kobj, action, <span class="literal">NULL</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è°ƒç”¨ kobject_uevent_env å‡½æ•°ï¼šè¯¥å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><pre><code> 1. æŸ¥æ‰¾ kobj æœ¬èº«æˆ–è€…å…¶ parent æ˜¯å¦ä»å±äºæŸä¸ª kset 2. è¯¥ kobject ä¸å±äºæŸä¸ª ksetï¼Œè¿”å›æŠ¥é”™ã€‚å¦‚æœä¸€ä¸ª kobject æ²¡æœ‰åŠ å…¥ ksetï¼Œæ˜¯ä¸å…è®¸ä¸ŠæŠ¥ uevent çš„ 3. æŸ¥çœ‹ kobj-&gt;uevent_suppress æ˜¯å¦è®¾ç½®ï¼Œå¦‚æœè®¾ç½®ï¼Œåˆ™å¿½ç•¥æ‰€æœ‰çš„ uevent ä¸ŠæŠ¥å¹¶è¿”å›ã€‚å¯ä»¥é€šè¿‡ Kobject çš„ uevent_suppress æ ‡å¿—ï¼Œç®¡æ§ Kobject çš„ uevent çš„ä¸ŠæŠ¥ 4. å¦‚æœæ‰€å±çš„ kset æœ‰ uevent_ops-&gt;filter å‡½æ•°ï¼Œåˆ™è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¿‡æ»¤æ­¤æ¬¡ä¸ŠæŠ¥ï¼Œkset å¯ä»¥é€šè¿‡ filter æ¥å£è¿‡æ»¤ä¸å¸Œæœ›ä¸ŠæŠ¥çš„ eventï¼Œä»è€Œè¾¾åˆ°æ•´ä½“çš„ç®¡ç†æ•ˆæœ 5. åˆ¤æ–­æ‰€å±çš„ kset æ˜¯å¦æœ‰åˆæ³•çš„åç§°ï¼ˆç§°ä½œ subsystemï¼Œå’Œå‰æœŸçš„å†…æ ¸ç‰ˆæœ¬æœ‰åŒºåˆ«ï¼‰ï¼Œå¦åˆ™ä¸å…è®¸ä¸ŠæŠ¥ uevent 6. åˆ†é…ä¸€ä¸ªç”¨äºæ­¤æ¬¡ä¸ŠæŠ¥çš„ã€å­˜å‚¨ç¯å¢ƒå˜é‡çš„ bufferï¼ˆç»“æœä¿å­˜åœ¨ env æŒ‡é’ˆä¸­ï¼‰ï¼Œå¹¶è·å¾—è¯¥ Kobject åœ¨ sysfs ä¸­è·¯å¾„ä¿¡æ¯ï¼ˆç”¨æˆ·ç©ºé—´è½¯ä»¶éœ€è¦ä¾æ®è¯¥è·¯å¾„ä¿¡æ¯åœ¨ sysfs ä¸­è®¿é—®å®ƒï¼‰ 7. è·å– kobject å®Œæ•´è·¯å¾„ 8. è°ƒç”¨ add_uevent_var æ¥å£ï¼Œå°† Actionã€è·¯å¾„ä¿¡æ¯ã€subsystem ç­‰ä¿¡æ¯ï¼Œæ·»åŠ åˆ° env æŒ‡é’ˆä¸­ 9. å¦‚æœä¼ å…¥çš„ envp_ext ä¸ç©ºï¼Œåˆ™è§£æä¼ å…¥çš„ç¯å¢ƒå˜é‡ä¸­ï¼ŒåŒæ ·è°ƒç”¨ add_uevent_var æ¥å£ï¼Œæ·»åŠ åˆ° env æŒ‡é’ˆä¸­ 10. å¦‚æœæ‰€å±çš„ kset å­˜åœ¨ uevent_ops-&gt;uevent æ¥å£ï¼Œè°ƒç”¨è¯¥æ¥å£ï¼Œæ·»åŠ  kset ç»Ÿä¸€çš„ç¯å¢ƒå˜é‡åˆ° env æŒ‡é’ˆ 11. åœ¨å¯¹è±¡ä¸­æ ‡è®°â€œæ·»åŠ â€å’Œâ€œåˆ é™¤â€äº‹ä»¶ï¼Œä»¥ç¡®ä¿åœ¨è‡ªåŠ¨æ¸…ç†æœŸé—´å‘ç”¨æˆ·ç©ºé—´å‘é€é€‚å½“çš„äº‹ä»¶ã€‚å¦‚æœå¯¹è±¡ç¡®å®å‘é€äº†â€œæ·»åŠ â€äº‹ä»¶ï¼Œåˆ™æ ¸å¿ƒå°†è‡ªåŠ¨ç”Ÿæˆâ€œåˆ é™¤â€ï¼Œå¦‚æœè°ƒç”¨è€…å°šæœªå®Œæˆ 12. ç”¨ add_uevent_var æ¥å£ï¼Œæ·»åŠ æ ¼å¼ä¸º"SEQNUM=%lluâ€çš„åºåˆ—å· 13. å¦‚æœå®šä¹‰äº†"CONFIG_NETâ€ï¼Œåˆ™ä½¿ç”¨ netlink å‘é€è¯¥ uevent 13. ä»¥ uevent_helperã€subsystem ä»¥åŠæ·»åŠ äº†æ ‡å‡†ç¯å¢ƒå˜é‡ï¼ˆHOME=/ï¼ŒPATH=/sbin:/bin:/usr/sbin:/usr/binï¼‰çš„ env æŒ‡é’ˆä¸ºå‚æ•° 14. è°ƒç”¨ kmod æ¨¡å—æä¾›çš„ call_usermodehelper å‡½æ•°ï¼Œä¸ŠæŠ¥ ueventã€‚å…¶ä¸­ uevent_helper çš„å†…å®¹æ˜¯ç”±å†…æ ¸é…ç½®é¡¹ CONFIG_UEVENT_HELPER_PATHï¼ˆä½äºã€‚/drivers/base/Kconfig) å†³å®šçš„ï¼ˆå¯å‚è€ƒ lib/kobject_uevent.c, line 32)ï¼Œè¯¥é…ç½®é¡¹æŒ‡å®šäº†ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºï¼ˆæˆ–è€…è„šæœ¬ï¼‰ï¼Œç”¨äºè§£æä¸ŠæŠ¥çš„ ueventï¼Œä¾‹å¦‚"/sbin/hotplugâ€ã€‚call_usermodehelper çš„ä½œç”¨ï¼Œå°±æ˜¯ fork ä¸€ä¸ªè¿›ç¨‹ï¼Œä»¥ uevent ä¸ºå‚æ•°ï¼Œæ‰§è¡Œ uevent_helper</code></pre><p>åœ¨ç³»ç»Ÿå¯åŠ¨åï¼Œå¤§éƒ¨åˆ†çš„è®¾å¤‡å·²ç» readyï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œé‡æ–°æŒ‡å®šä¸€ä¸ª uevent helperï¼Œä»¥ä¾¿æ£€æµ‹ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„çƒ­æ‹”æ’äº‹ä»¶ã€‚è¿™å¯ä»¥é€šè¿‡æŠŠ helper çš„è·¯å¾„å†™å…¥åˆ°"/sys/kernel/uevent_helperâ€æ–‡ä»¶ä¸­å®ç°ã€‚å®é™…ä¸Šï¼Œå†…æ ¸é€šè¿‡ sysfs æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼ï¼Œå°† uevent_helper æ•°ç»„å¼€æ”¾åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾›ç”¨æˆ·ç©ºé—´ç¨‹åºä¿®æ”¹è®¿é—®ï¼Œå…·ä½“å¯å‚è€ƒ"./kernel/sysfs.câ€ä¸­ç›¸åº”çš„ä»£ç ï¼Œè¿™é‡Œä¸å†è¯¦ç»†æè¿°ã€‚</p><h1 id="platfor-æ€»çº¿">platfor æ€»çº¿</h1><h2 id="platform-æ•°æ®ç»“æ„">platform æ•°æ®ç»“æ„</h2><p>platform æ•°æ®ç»“æ„åŒæ ·æ˜¯å¯¹ deviceã€device_driverã€bus æ•°æ®ç»“æ„çš„å†å°è£…ï¼Œæˆ‘å°† platform çš„æ•°æ®ç»“æ„åˆ—å‡ºæ¥å¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwOWE3ZDljMDg2NjUxM2VhMjgz">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/PlatformStruct.png"></p><h2 id="platform-æ€»çº¿å®ç°">platform æ€»çº¿å®ç°</h2><p>é¦–å…ˆè¿˜æ˜¯å°†æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»åˆ—å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwYzNmMzQ2ZmIwNmE5ZjEzMjI1">åŸå›¾<i class="fa fa-external-link-alt"></i></span> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Linux/Driver/PlatformStruct.png"></p><p>ä¸Šå›¾å°† platform æ€»çº¿çš„å®ç°æ¦‚è¦åˆ—ä¸¾å‡ºæ¥ï¼Œä¸‹é¢è¯¦ç»†çœ‹çœ‹ platform æ€»çº¿çš„å‡ ä¸ªé‡è¦å‡½æ•°ï¼š</p><ul><li><p>platform_probe: åœ¨ä¸Šé¢ä»‹ç» device_driver çš„æ—¶å€™ä»‹ç» register çš„æ—¶å€™è®²åˆ° probe å‡½æ•°çš„è°ƒç”¨æ—¶æœºï¼Œåœ¨ device_driver æ³¨å†Œçš„æ—¶å€™ä¼šæ‰§è¡Œæ€»çº¿çš„ probe å‡½æ•°ï¼Œå¯¹äº platform æ€»çº¿å°±æ˜¯ç”± platform æ€»çº¿å†è°ƒç”¨ device_driver çš„ probe å‡½æ•°</p></li><li><p>platform_match: è¿™ä¸ªå‡½æ•°æä¾›äº† 4 ç§åŒ¹é…è§„åˆ™ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ul><li>driver_override åŒ¹é…ï¼šè¿™ä¸ªæ˜¯æœ€ä¼˜å…ˆçš„åŒ¹é…å°† device çš„ driver_override å’Œ device_driver çš„ name è¿›è¡ŒåŒ¹é…</li><li>of_driver_match_device åŒ¹é…ï¼šè¿™ä¸ªæŠŠ device_driver çš„ of_match_table å’Œ device é‡Œçš„ of_node è¿›è¡ŒåŒ¹é…ï¼Œof_node ç”± dts é‡Œçš„ compatible å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒåŒ¹é…</li><li>acpi_driver_match_device åŒ¹é…ï¼šacpi åŒ¹é…è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼Œè¿™ä¸ªæ²¡è¯¦ç»†çœ‹</li><li>platform_match_id åŒ¹é…ï¼šé€šè¿‡ platform_driver-&gt;id_table-&gt;name å’Œ platform_device-&gt;name è¿›è¡ŒåŒ¹é…</li></ul></li><li><p>platform_pm_suspend: åœ¨æˆ‘ä»¬ç¼–å†™é©±åŠ¨çš„æ—¶å€™ä¼‘çœ å”¤é†’æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„æ“ä½œï¼Œé‚£ä¹ˆ platform æ€»çº¿å®ç°çš„ä¼‘çœ å‡½æ•°å°±æ˜¯ platform_pm_suspendï¼Œplatform æ€»çº¿çš„ suspend çš„å®ç°å°±æ˜¯è°ƒç”¨ device_driver çš„ suspend å‡½æ•°ï¼Œè·Ÿ probe å‡½æ•°ç±»ä¼¼</p></li></ul><h2 id="æ€»ç»“">æ€»ç»“</h2><p>è¿™é‡Œä¹Ÿè¯´æ˜äº† platform æ€»çº¿å¹¶æ²¡æœ‰æ“ä½œå…·ä½“å®é™…çš„ç¡¬ä»¶ï¼Œæ€»çº¿çš„å®ç°å°±æ˜¯è°ƒç”¨é©±åŠ¨çš„å…·ä½“å‡½æ•°ã€‚æœ‰äº†è¿™äº›æ€»çº¿æˆ‘ä»¬åœ¨å®é™…ç¼–å†™é©±åŠ¨çš„æ—¶å€™å°±éå¸¸æ–¹ä¾¿ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° device_driver ç»“æ„ä½“é‡Œçš„å…·ä½“å‡½æ•°ç„¶åå°†è¿™ä¸ªç»“æ„ä½“æ³¨å†Œåˆ° platform æ€»çº¿å°±å®Œäº‹äº†ï¼Œå…·ä½“å‡½æ•°çš„è°ƒç”¨æ—¶æœºç”±æ€»çº¿è´Ÿè´£ï¼Œä¸éœ€è¦é©±åŠ¨ç¼–å†™äººå‘˜ç¼–å†™ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9kZXZpY2VfbW9kZWw=">çªçªç§‘æŠ€-è®¾å¤‡é©±åŠ¨æ¨¡å‹<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvZGV2aWNlX21vZGVsL3VldmVudC5odG1s">çªçªç§‘æŠ€-Linux è®¾å¤‡æ¨¡å‹ (3)_Uevent<i class="fa fa-external-link-alt"></i></span><br>ã€Šlinux å†…æ ¸æ–‡æ¡£ã€‹<br>ã€Šlinux è®¾å¤‡é©±åŠ¨å¼€å‘ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Linux </category>
          
          <category> Driver </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Driver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>foc ç›¸å…³ç®—æ³•</title>
      <link href="/2020/Algorithm/focRelatedAlgorithms/"/>
      <url>/2020/Algorithm/focRelatedAlgorithms/</url>
      
        <content type="html"><![CDATA[<h1 id="mtpa">MTPA</h1><h2 id="ä¸ºä»€ä¹ˆè¦ç”¨-mtpa">ä¸ºä»€ä¹ˆè¦ç”¨ MTPA</h2><p>å½“ç”µæœºé‡‡ç”¨ id=0 çš„æ§åˆ¶ç­–ç•¥ï¼Œè¿™ç§æ§åˆ¶æ–¹æ³•å¿½ç•¥äº†ç£é˜»è½¬çŸ©çš„ä½œç”¨ï¼Œç”µç£è½¬é’œæ–¹ç¨‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\tau _e = \frac{3}{2}p[k_e \cdot i_q + (L_d - L_q)\cdot i_d \cdot i_q]\]</span></p><p>è½¬çŸ©åˆ†ä¸ºæ°¸ç£è½¬çŸ© Tr å’Œç£é˜»è½¬çŸ© Tmï¼Œè€Œ id=0 åªå‰©ä¸‹ Trã€‚è¿™ä¼šå¯¼è‡´ç”µæµçš„åˆ©ç”¨ç‡ä¸é«˜ï¼Œç³»ç»Ÿçš„æ•ˆç‡é™ä½ã€‚æ‰€ä»¥ id=0 çš„æ§åˆ¶æ¯”è¾ƒé€‚ç”¨äºéšæå¼ç”µæœºï¼ˆLd=Lqï¼‰ï¼Œè€Œå¯¹äºå‡¸æå¼ç”µæœºå¹¶ä¸æœ€ä¼˜ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è€ƒè™‘æ§åˆ¶ç­–ç•¥ã€‚</p><span id="more"></span><h2 id="æ¨å¯¼è¿‡ç¨‹">æ¨å¯¼è¿‡ç¨‹</h2><p>ç”µåŠ¨æœºç”µå‹æ–¹ç¨‹ï¼š</p><p><span class="math display">\[\begin{aligned}U_d = rI_d - L_qI_q\omega_e \\U_q = rI_q + k_E\omega_e + L_dI_d\omega_e\end{aligned}\]</span></p><p>é‚£ä¹ˆç”µåŠ¨æœºæ¶ˆè€—å¯¹æœ‰åŠŸåŠŸç‡ä¸ºï¼š</p><p><span class="math display">\[P = \frac{3}{2}(U_dI_d + U_qI_q)\]</span></p><p>å°†ç”µåŠ¨æœºæ–¹ç¨‹ä»£å…¥åŠŸç‡æ–¹ç¨‹å¾—ï¼š</p><p><span class="math display">\[P = \frac{3}{2} r (I_d^2 + I_q^2) + [k_EI_q + (L_d - L_q)I_dI_q]\omega_e\]</span></p><p>ç”µåŠ¨æœºçš„æœ‰åŠŸåŠŸç‡ä¸€éƒ¨åˆ†æ¶ˆè€—åœ¨ç»•é˜»ç”µé˜»ä¸Šå‘çƒ­ï¼Œå¦ä¸€éƒ¨åˆ†ç”¨äºè¾“å‡ºæœºæ¢°åŠŸç‡ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/mtpa.png"></p><p>ç”µåŠ¨æœºçš„æœºæ¢°åŠŸç‡ä¸ºï¼š</p><p><span class="math display">\[P_{mech} = \tau_e \omega_{mech}\]</span></p><p>æœºæ¢°è½¬é€Ÿä¸ç”µé¢‘ç‡ä¹‹é—´çš„å…³ç³»ä¸ºï¼š</p><p><span class="math display">\[\omega_e = p \omega_{mech}\]</span></p><p>æ‰€ä»¥ï¼š</p><p><span class="math display">\[\tau_e \omega_{mech} = \frac{3}{2} r (I_d^2 + I_q^2) + [k_EI_q + (L_d - L_q)I_dI_q] p \omega_{mech}\]</span></p><p>å¾—åˆ°ç”µç£è½¬é’œå…¬å¼ï¼š</p><p><span class="math display">\[\tau _e = \frac{3}{2}p[k_e \cdot i_q + (L_d - L_q)\cdot i_d \cdot i_q]\]</span></p><p>å¦‚æœç»•é˜»ä¸­ç”µæµå³°å€¼æ˜¯ I_s</p><p><span class="math display">\[I_s^2 = I_d^2 + I_q^2\]</span></p><p>å½“è¾“å‡ºç”µç£è½¬é’œä¸€å®šæ—¶ï¼š</p><p><span class="math display">\[I_q = \frac{\tau_e}{\frac{3}{2}p[(k_E) + (L_d - L_q)I_d]}\]</span></p><p>è”ç«‹ä¸Šä¸¤å¼å¾—ï¼š</p><p><span class="math display">\[I_s^2 = I_d^2 + \left ( \frac{\tau_e}{\frac{3}{2}p[(k_E) + (L_d - L_q)I_d]} \right )^2\]</span></p><p>ä¸Šå¼å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå…³äº<span class="math inline">\(I_d\)</span>çš„å‡½æ•°ï¼Œä¸Šå¼æœ‰æœ€å°å€¼ï¼Œå½“ç”µç£è½¬é’œä¸€å®šæ—¶ï¼Œæœ‰ä¸€ä¸ªæœ€å°å³°å€¼ç”µæµ<span class="math inline">\(I_s\)</span>ï¼Œå–<span class="math inline">\(I_s\)</span>æœ€å°æ—¶æœ‰ï¼š</p><p><span class="math display">\[\begin{aligned}\frac{\partial I_s^2}{\partial I_d} &amp;= 2I_d + 2I_q \frac{\tau_e}{\frac{3}{2}p} \frac{-(L_d - L_q)}{[k_E + (L_d - L_q)I_d]^2} \\&amp; = 2I_d + 2I_q \frac{\tau_e}{\frac{3}{2}p[k_E + (L_d - L_q)I_d]} \frac{-(L_d - L_q)}{[k_E + (L_d - L_q)I_d]} \\&amp; = 2I_d + 2I_q^2\frac{-(L_d - L_q)}{[k_E + (L_d - L_q)I_d]} = 0\end{aligned}\]</span></p><p>æ•´ç†å¾—ï¼š</p><p><span class="math display">\[(L_d - L_q)I_d^2 + k_EI_d - (L_d - L_q)I_q^2 = 0\]</span></p><p>æ±‚è§£<span class="math inline">\(I_d\)</span>å¾—åˆ°ï¼š</p><p><span class="math display">\[I_d = - \frac{k_E}{2(L_d - L_q)} \pm \sqrt{\left ( \frac{k_E}{2(L_d - L_q)} \right )^2 + I_q^2}\]</span></p><p>å¦‚æœ<span class="math inline">\(L_d &lt; L_q\)</span>æ—¶å½“ç”µç£è½¬é’œä¸€å®šæ—¶ç”µæµå³°å€¼<span class="math inline">\(I_s\)</span>æœ€å°ï¼š</p><p><span class="math display">\[I_d = - \frac{k_E}{2(L_d - L_q)} - \sqrt{\left ( \frac{k_E}{2(L_d - L_q)} \right )^2 + I_q^2}\]</span></p><h1 id="å¼±ç£æ§åˆ¶">å¼±ç£æ§åˆ¶</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><p>å¼±ç£æ§åˆ¶çš„è¿™ä¸ªæ€æƒ³æºè¿˜æ˜¯æ¥è‡ªä»–åŠ±ç›´æµç”µåŠ¨æœºçš„è°ƒç£æ§åˆ¶ã€‚å½“ä»–åŠ±ç›´æµç”µåŠ¨æœºç«¯ç”µå‹è¾¾åˆ°æœ€å¤§ç”µå‹æ—¶ï¼Œåªèƒ½é€šè¿‡è°ƒèŠ‚ç”µæœºçš„åŠ±ç£ç”µæµï¼Œè¿›è€Œæ”¹å˜åŠ±ç£ç£é€šï¼Œåœ¨ä¿è¯è¾“å‡ºç”µå‹æœ€å¤§å€¼ä¸å˜çš„æ¡ä»¶ä¸‹ï¼Œä½¿ç”µæœºèƒ½æ’åŠŸç‡è¿è¡Œäºæ›´é«˜çš„è½¬é€Ÿã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»–åŠ±ç›´æµç”µåŠ¨æœºå¯ä»¥é€šè¿‡é™ä½åŠ±ç£ç”µæµè¾¾åˆ°å¼±ç£æ‰©é€Ÿçš„ç›®çš„ã€‚å¯¹äº PMSM è€Œè¨€ï¼ŒåŠ±ç£ç£åŠ¨åŠ¿å› æ°¸ç£ä½“äº§ç”Ÿè€Œæ— æ³•è°ƒèŠ‚ï¼Œåªèƒ½é€šè¿‡è°ƒèŠ‚å®šå­ç”µæµï¼Œå³å¢åŠ å®šå­ç›´è½´å»ç£ç”µæµåˆ†é‡æ¥ç»´æŒé«˜é€Ÿè¿è¡Œæ—¶ç”µå‹çš„å¹³è¡¡ã€‚è¾¾åˆ°å¼±ç£æ‰©é€Ÿçš„ç›®çš„ã€‚</p><h2 id="æ¨å¯¼">æ¨å¯¼</h2><p>å¾ˆå¤šåº”ç”¨éœ€è¦é©¬è¾¾å·¥ä½œåœ¨é«˜äºé¢å®šé€Ÿåº¦çš„èŒƒå›´å†…ï¼Œè¿™é‡Œå°±éœ€è¦å¼±ç£æ§åˆ¶æ¥å®ç°ï¼Œç”µæµçš„ç”µå‹çº¦æŸæ¡ä»¶å¦‚ä¸‹ï¼š</p><p><span class="math display">\[(L_qI_q)^2 + (k_E + L_dI_d)^2 \leqslant \frac{U_{1-limit}^2}{\omega_e^2}\]</span></p><p>ç”µæµå¹…å€¼çº¦æŸæ¡ä»¶ï¼š</p><p><span class="math display">\[I_d^2 + I_q^2 \leqslant I_{s-limit}^2\]</span></p><p>MTPA ä¸‹æœ‰<span class="math inline">\(I_d\)</span>ï¼š</p><p><span class="math display">\[MTPA: I_d = \left\{\begin{matrix}- \frac{k_E}{2(L_d - L_q)} + sign(L_d - L_q) \sqrt{\left ( \frac{k_E}{2(L_d - L_q)} \right )^2 + I_q^2}, L_d \neq L_q\\ 0, L_d = L_q\end{matrix}\right.\]</span></p><p>å…¶ä¸­ï¼š</p><p><span class="math display">\[sign(x) = \left\{\begin{matrix}1, x &gt; 0\\ 0, x = 0\\ -1, x &lt; 0\end{matrix}\right.\]</span></p><p>å¼±ç£æƒ…å†µä¸‹æœ‰<span class="math inline">\(I_d\)</span>:</p><p><span class="math display">\[I_d = \left\{\begin{matrix}-\frac{k_E}{L_d}+ \frac{\sqrt{(\frac{U_{1-limit}}{\omega_e})^2 - (L_qI_q)^2}}{L_d}, \frac{U_{1-limit}}{\omega_e} \geq L_qI_q\\ n/a, \frac{U_{1-limit}}{\omega_e} &lt; L_qI_q\end{matrix}\right.\]</span></p><h1 id="ç”µæµå‰é¦ˆ">ç”µæµå‰é¦ˆ</h1><h2 id="å‰é¦ˆç†è®º">å‰é¦ˆç†è®º</h2><p>å‰é¦ˆæ§åˆ¶æ˜¯æŒ‰ç…§æ‰°åŠ¨é‡è¿›è¡Œè¡¥å¿éƒ½å¼€ç¯æ§åˆ¶ï¼Œå½“ç³»ç»Ÿå‡ºç°æ‰°åŠ¨æ—¶ï¼ŒæŒ‰ç…§æ‰°åŠ¨é‡å½“å¤§å°ç›´æ¥äº§ç”ŸçŸ«æ­£ä½œç”¨ã€‚ å‰é¦ˆæ§åˆ¶ç»“æ„å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/foc-pre-feedback.png"></p><p>å›¾ä¸­<span class="math inline">\(G_n(s)\)</span>æ˜¯è¢«æ§å¯¹è±¡æ‰°åŠ¨é€šé“çš„ä¼ é€’å‡½æ•°ï¼Œ<span class="math inline">\(D_n(s)\)</span>æ˜¯å‰é¦ˆæ§åˆ¶å™¨çš„ä¼ é€’å‡½æ•°ï¼Œ<span class="math inline">\(G(s)\)</span>ä¸ºè¢«æ§å¯¹è±¡æ§åˆ¶é€šé“ä¼ é€’å‡½æ•°ï¼Œnã€uã€y åˆ†åˆ«ä¸ºæ‰°åŠ¨é‡ã€æ§åˆ¶é‡å’Œè¾“å‡ºé‡ å‡å®šè¾“å…¥é‡ u1=0ï¼Œåˆ™æœ‰ï¼š</p><p><span class="math display">\[Y(s) = Y_1(s) + Y_2(s) = [D_n(s)G(s) + G_n(s)]N(s)\]</span></p><p>è‹¥ä½¿å‰é¦ˆæ§åˆ¶ä½œç”¨å®Œå…¨è¡¥å¿æ‰°åŠ¨ä½œç”¨ï¼Œåˆ™åº”ä½¿<span class="math inline">\(Y(s) = 0\)</span>å³ï¼š</p><p><span class="math display">\[D_n(s)G(s) + G_n(s) = 0\]</span></p><p>æ‰€ä»¥å‰é¦ˆæ§åˆ¶å™¨çš„ä¼ é€’å‡½æ•°ä¸ºï¼š</p><p><span class="math display">\[D_n(s) = - \frac{G_n(s)}{G(s)}\]</span></p><p>åœ¨å®é™…åº”ç”¨ä¸­ã€‚å› ä¸ºå‰é¦ˆæ§åˆ¶ä¸ºä¸€ä¸ªå¼€ç¯ç³»ç»Ÿã€‚å› æ­¤å¸¸å¸¸é‡‡ç”¨åé¦ˆ+å‰é¦ˆçš„å¤åˆæ§åˆ¶æ–¹å¼ã€‚</p><h2 id="ç”µæœºæ§åˆ¶ä¸­çš„å‰é¦ˆæ§åˆ¶">ç”µæœºæ§åˆ¶ä¸­çš„å‰é¦ˆæ§åˆ¶</h2><p>åœ¨ç”µæœºæ§åˆ¶ä¸­åŠ å…¥å‰é¦ˆæ§åˆ¶ï¼Œå…¶ç»“æ„æ¡†å›¾å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/foc-ff.png"></p><h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2><p>ã€Š2.ST MC SDK 5.x çŸ¢é‡æ§åˆ¶ç†è®ºåŸºç¡€ã€‹<br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yMzU3MjMxMw==">æ°¸ç£åŒæ­¥ç”µæœºä¹Ÿèƒ½å¼±ç£è°ƒé€Ÿ<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODgwMzE0MjU=">æ°¸ç£åŒæ­¥ç”µæœºå¼±ç£æ§åˆ¶<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83ODcwNTA4NA==">æ°¸ç£åŒæ­¥ç”µæœº-å¼±ç£<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Actuator </tag>
            
            <tag> FOC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FOC åŸç†</title>
      <link href="/2020/Algorithm/focPrinciple/"/>
      <url>/2020/Algorithm/focPrinciple/</url>
      
        <content type="html"><![CDATA[<h1 id="ç‰©ç†å­¦åŸºç¡€æ¦‚å¿µ">ç‰©ç†å­¦åŸºç¡€æ¦‚å¿µ</h1><h2 id="å·¦æ‰‹å®šåˆ™">å·¦æ‰‹å®šåˆ™</h2><p>å°†å·¦æ‰‹çš„é£ŸæŒ‡ï¼Œä¸­æŒ‡å’Œæ‹‡æŒ‡ä¼¸ç›´ï¼Œä½¿å…¶åœ¨ç©ºé—´å†…ç›¸äº’å‚ç›´ã€‚é£ŸæŒ‡æ–¹å‘ä»£è¡¨ç£åœºçš„æ–¹å‘ï¼ˆä» N çº§åˆ° S çº§ï¼‰ï¼Œä¸­æŒ‡ä»£è¡¨ç”µæµçš„æ–¹å‘ï¼ˆä»æ­£æåˆ°è´Ÿæï¼‰ï¼Œé‚£æ‹‡æŒ‡æ‰€æŒ‡çš„æ–¹å‘å°±æ˜¯å—åŠ›çš„æ–¹å‘ã€‚å¯ç”¨äºåˆ¤æ–­å®‰åŸ¹åŠ›ï¼ˆè¿åŠ¨å¯¼ä½“æ‰€å—åˆ°çš„åŠ›ï¼‰å’Œæ´›ä¼¦å…¹åŠ›ï¼ˆè¿åŠ¨ç”µè·æ‰€å—çš„åŠ›ï¼‰ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/leftHandRule.png"></p><h2 id="å³æ‰‹å®šåˆ™">å³æ‰‹å®šåˆ™</h2><p>ä¼¸å¼€å³æ‰‹ï¼Œä½¿æ‹‡æŒ‡ä¸å…¶ä½™å››ä¸ªæ‰‹æŒ‡å‚ç›´ï¼Œå¹¶ä¸”éƒ½ä¸æ‰‹æŒåœ¨åŒä¸€å¹³é¢å†…ï¼›è®©ç£æ„Ÿçº¿å‚ç›´äºæ‰‹å¿ƒè¿›å…¥ï¼Œå¹¶ä½¿æ‹‡æŒ‡æŒ‡å‘å¯¼çº¿è¿åŠ¨æ–¹å‘ï¼Œè¿™æ—¶å››æŒ‡æ‰€æŒ‡çš„æ–¹å‘å°±æ˜¯æ„Ÿåº”ç”µæµçš„æ–¹å‘ã€‚ç”¨äºåˆ¤æ–­å¯¼ä½“åœ¨åšåˆ‡å‰²ç£åœºæ—¶äº§ç”Ÿçš„ç”µæµæ–¹å‘ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/rightHandRule.jpg"></p><span id="more"></span><h2 id="å®‰åŸ¹å®šåˆ™å³æ‰‹èºæ—‹å®šåˆ™">å®‰åŸ¹å®šåˆ™ï¼ˆå³æ‰‹èºæ—‹å®šåˆ™ï¼‰</h2><p>ç”µç›´å¯¼çº¿ä¸­çš„å®‰åŸ¹å®šåˆ™ï¼ˆå®‰åŸ¹å®šåˆ™ä¸€ï¼‰ï¼šç”¨å³æ‰‹æ¡ä½é€šç”µç›´å¯¼çº¿ï¼Œè®©å¤§æ‹‡æŒ‡æŒ‡å‘ç›´å¯¼çº¿ä¸­ç”µæµæ–¹å‘ï¼Œé‚£ä¹ˆå››æŒ‡æŒ‡å‘å°±æ˜¯é€šç”µå¯¼çº¿å‘¨å›´ç£åœºçš„æ–¹å‘ï¼› é€šç”µèºçº¿ç®¡ä¸­çš„å®‰åŸ¹å®šåˆ™ï¼ˆå®‰åŸ¹å®šåˆ™äºŒï¼‰ï¼šç”¨å³æ‰‹æ¡ä½é€šç”µèºçº¿ç®¡ï¼Œè®©å››æŒ‡æŒ‡å‘ç”µæµçš„æ–¹å‘ï¼Œé‚£ä¹ˆå¤§æ‹‡æŒ‡æ‰€æŒ‡çš„é‚£ä¸€ç«¯æ˜¯é€šç”µèºçº¿ç®¡çš„ N æã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/AmperesRule.jpg"></p><h2 id="å®‰åŸ¹åŠ›å®šåˆ™">å®‰åŸ¹åŠ›å®šåˆ™</h2><p><strong>å®‰åŸ¹åŠ›ï¼š</strong> ä»¥ç”µæµå¼ºåº¦ä¸º I çš„é•¿åº¦ä¸º L çš„ç›´å¯¼çº¿ï¼Œç½®äºç£æ„Ÿåº”å¼ºåº¦ä¸º B çš„å‡åŒ€å¤–ç£åœºä¸­ï¼Œåˆ™å¯¼çº¿å—åˆ°çš„å®‰åŸ¹åŠ›çš„å¤§å°ä¸ºï¼š</p><p><span class="math display">\[F = IBLsin\alpha \]</span></p><p>å¼ä¸­Î±ä¸ºå¯¼çº¿ä¸­çš„ç”µæµæ–¹å‘ä¸ B æ–¹å‘ä¹‹é—´çš„å¤¹è§’ã€‚ è®¾å®šä¸¤æ¡ç»†ç›´ã€æ— é™é•¿ã€å›ºå®šçš„ã€ç›¸äº’å¹³è¡Œçš„è½½æµå¯¼çº¿ï¼Œåˆ™åœ¨è‡ªç”±ç©ºé—´å†…ï¼Œä»»æ„ä¸€æ¡å¯¼çº¿æ–½åŠ äºå¯¹æ–¹çš„æ¯å•ä½é•¿åº¦ä½œç”¨åŠ›<span class="math inline">\(f_m\)</span>æ˜¯ï¼š</p><p><span class="math display">\[f_m = \frac{\mu_0 I_1 I_2 }{2\pi r}\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(\mu_{0}\)</span> æ˜¯çœŸç©ºç£å¯¼ç‡ï¼Œ<span class="math inline">\(I_1,I_2\)</span> åˆ†åˆ«æ˜¯æµåŠ¨äºä¸¤æ¡å¯¼çº¿çš„ç”µæµï¼Œr æ˜¯ä¸¤æ¡å¯¼çº¿ä¹‹é—´çš„å‚ç›´è·ç¦»ã€‚é‡‡ç”¨å›½é™…å•ä½åˆ¶ï¼Œ<span class="math inline">\(\mu_{0}\)</span>å€¼å®šä¹‰ä¸ºï¼š</p><p><span class="math display">\[\mu _{0} = 4\pi \times 10^{-7}\]</span></p><h2 id="æ¯•å¥¥è¨ä¼å°”å®šå¾‹">æ¯•å¥¥â”€è¨ä¼å°”å®šå¾‹</h2><p>é•¿ç›´è½½æµå¯¼çº¿å‘¨å›´çš„ç£æ„Ÿåº”å¼ºåº¦å¤§å°ä¸è·ç¦»æˆåæ¯”ã€ä¸ç”µæµæˆæ­£æ¯”ã€‚</p><p><span class="math display">\[dB = \frac{\mu _0}{4\pi} \frac{Idl sin\theta }{r^2}\]</span></p><p>çœŸç©ºç£å¯¼ç‡ï¼š</p><p><span class="math display">\[\mu _0 = 4 \pi \times 10^{-7} N \cdot A^{-2}\]</span></p><p>è½½æµç›´å¯¼çº¿ã€åœ†å½¢è½½æµå¯¼çº¿ã€è½½æµå¯†ç»•ç›´èºçº¿ç®¡çš„ç£åœºéƒ½æ˜¯é€šè¿‡è¯¥å…¬å¼æ±‚å–ã€‚å…·ä½“ç»†èŠ‚å¯å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDIzNzYzODM=">æ¯•å¥¥â”€è¨ä¼å°”å®šå¾‹<i class="fa fa-external-link-alt"></i></span> åœ¨é€šç”µèºçº¿ç®¡ä¸­äº§ç”Ÿçš„ç£åœºå¼ºåº¦æ˜¯æ­£æ¯”ä¸å¯¼çº¿ä¸­çš„ç”µæµå’Œå¯¼çº¿åŒæ•°çš„ã€‚</p><h2 id="æ´›ä¼¦å…¹åŠ›">æ´›ä¼¦å…¹åŠ›</h2><p>åœ¨ç”µåŠ¨åŠ›å­¦é‡Œï¼Œè‹¥è€ƒè™‘ä¸€å¸¦ç”µç²’å­åœ¨ç”µç£åœºä¸­çš„å—åŠ›ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹çš„åŠ³ä»‘å…¹åŠ›å®šå¾‹è¡¨ç¤ºï¼š</p><p><span class="math display">\[F = q(E + v \times B)\]</span></p><p>è¿™é‡Œ F æ˜¯æ´›ä¼¦å…¹åŠ›ï¼Œq æ˜¯æ˜¯å¸¦ç”µç²’å­çš„ç”µè·é‡ï¼ŒE æ˜¯ç”µåœºï¼Œv æ˜¯å¸¦ç”µç²’å­çš„é€Ÿåº¦ï¼ŒB æ˜¯ç£åœºã€‚è¿™æ–¹ç¨‹å¼å³è¾¹æœ‰ä¸¤é¡¹ï¼Œç¬¬ä¸€é¡¹æ˜¯ç”µåœºåŠ›<span class="math inline">\(F_E = qE\)</span> ï¼Œç¬¬äºŒé¡¹æ˜¯ç£åœºåŠ›<span class="math inline">\(F_B = qv \times B\)</span>ã€‚</p><h1 id="ç›´æµç”µæœºåŸºæœ¬æ–¹ç¨‹">ç›´æµç”µæœºåŸºæœ¬æ–¹ç¨‹</h1><h2 id="ç”µæ¢ç»•ç»„çš„æ„Ÿåº”ç”µåŠ¨åŠ¿">ç”µæ¢ç»•ç»„çš„æ„Ÿåº”ç”µåŠ¨åŠ¿</h2><p>è‹¥ç”µæ¢å¯¼ä½“çš„æœ‰æ•ˆé•¿åº¦ä¸º lï¼Œå¯¼ä½“åˆ‡å‰²æ°”éš™ç£åœºçš„çº¿é€Ÿåº¦ä¸º vï¼Œåˆ™æ¯æ ¹å¯¼ä½“ä¸­çš„æ„Ÿåº”ç”µåŠ¨åŠ¿<span class="math inline">\(e_c\)</span>ä¸ºï¼š</p><p><span class="math display">\[e_c = b_{\sigma}lv\]</span></p><p>å¼ä¸­<span class="math inline">\(b_{\sigma}\)</span>ä¸ºå¯¼ä½“æ‰€åœ¨ä½ç½®å¤„çš„æ°”éš™ç£é€šå¯†åº¦ã€‚ï¼Œè‹¥ç”µæ¢ç»•ç»„çš„æ€»å¯¼ä½“æ•°ä¸º<span class="math inline">\(Z_a\)</span>æ¯æ¡æ”¯è·¯ä¸²è”å¯¼ä½“æ•°ç­‰äº<span class="math inline">\(\frac{Z_a}{2a}\)</span>åˆ™æ”¯è·¯ç”µåŠ¨åŠ¿<span class="math inline">\(E_a\)</span>ä¸ºï¼š</p><p><span class="math display">\[E_a = \sum_{1}^{\frac{Z_a}{2a}}b_{\delta }lv = lv\sum_{1}^{\frac{Z_a}{2a}}b_{\delta }(x_i)\]</span></p><p>å¼ä¸­å„ç‚¹æ°”éš™ç£é€šå¯†åº¦<span class="math inline">\(b_{\delta }(x_i)\)</span>äº’ä¸ç›¸åŒï¼Œæ‰€ä»¥æ¯æ ¹å¯¼ä½“çš„ç”µåŠ¨åŠ¿ä¹Ÿä¸ç›¸åŒï¼Œä¸ºç®€å•è®°ï¼Œå¼•å…¥å¹³å‡æ°”éš™ç£é€šå¯†åº¦<span class="math inline">\(B_{av}\)</span>ï¼Œè®°ï¼š</p><p><span class="math display">\[B_{av} \approx \frac{1}{\frac{Z_a}{2a}} \sum_{1}^{\frac{Z_a}{2a}}b_{\delta }(x_i)\]</span></p><p>åˆ™<span class="math inline">\(E_a\)</span>å¯ä»¥å†™ä¸ºï¼š</p><p><span class="math display">\[E_a = lv\frac{Z_a}{2a}B_{av}\]</span></p><p>è€ƒè™‘åˆ°çº¿é€Ÿåº¦<span class="math inline">\(v = 2p \tau \frac{n}{60}\)</span>, å…¶ä¸­<span class="math inline">\(\tau\)</span>ä¸ºæè·ï¼Œ$2$ä¸ºç”µæ¢å‘¨é•¿å°† v ä»£å…¥å¯ä»¥å¾—åˆ°ï¼š</p><p><span class="math display">\[E_a = 2\frac{pn}{60}\frac{Z_a}{2a}(B_{av}\tau l) = \frac{pZ_a}{60a}n\Phi = C_e n \Phi \]</span></p><p>å¼ä¸­<span class="math inline">\(\Phi\)</span>è¡¨ç¤ºæ¯æçš„æ€»ç£é€šé‡ï¼Œä»–ç­‰äºä¸€ä¸ªæä¸‹çš„å¹³å‡æ°”éš™ç£é€šå¯†åº¦<span class="math inline">\(B_av\)</span>ä¹˜ä»¥ä¸€ä¸ªæçš„é¢ç§¯<span class="math inline">\(l\tau\)</span>å³$= B_{av}l$, <span class="math inline">\(C_e\)</span>ç§°ä¸ºç”µåŠ¨åŠ¿å¸¸æ•°ï¼Œ<span class="math inline">\(C_e = \frac{p Z_a}{60a}\)</span> . è¿™å°±æ˜¯ç”µæ¢ç»•ç»„çš„ç”µåŠ¨åŠ¿æ–¹ç¨‹ã€‚å¯¹å‘ç”µæœºå’Œç”µåŠ¨æœºéƒ½é€‚ç”¨ã€‚</p><h2 id="ç”µæ¢çš„ç”µç£è½¬é’œ">ç”µæ¢çš„ç”µç£è½¬é’œ</h2><p>è®¾å¯¼ä½“ä¸­ç”µæµä¸º<span class="math inline">\(i_a\)</span>å¯¼ä½“æ‰€åœ¨ä½ç½®çš„æ°”éš™ç£é€šå¯†åº¦ä¸º<span class="math inline">\(b_{\delta}\)</span>, åˆ™ä½œç”¨åœ¨è¯¥å¯¼ä½“ä¸Šçš„ç”µç£è½¬é’œ<span class="math inline">\(T_c\)</span>ä¸ºï¼š</p><p><span class="math display">\[T_c = b_{\delta} l i_a \frac{D_a}{2}\]</span></p><p><span class="math inline">\(D_a\)</span>ä¸ºç”µæ¢å¤–å¾„ï¼Œç”±äºä¸€ä¸ªæä¸‹è½½æµå¯¼ä½“æ•°ä¸º<span class="math inline">\(\frac{Z_a}{2p}\)</span>ï¼Œæ‰€ä»¥ä½œç”¨åœ¨ä¸€ä¸ªæä¸‹è½½æµå¯¼ä½“ä¸Šçš„åˆæˆç”µç£è½¬é’œ<span class="math inline">\(T_p\)</span>åº”ä¸ºï¼š</p><p><span class="math display">\[T_p = li_a \frac{D_a}{2}\sum_{1}^{\frac{Z_a}{2p}}b_{\delta }(x_i) = (\frac{Z_a}{2p}B_{av})li_a\frac{D_a}{2}\]</span></p><p>å¼ä¸­<span class="math inline">\(B_{av}\)</span>ä¸ºæ°”éš™ç£é€šå¯†åº¦å¹³å‡å€¼ï¼Œä½œç”¨åœ¨æ•´ä¸ªç”µæ¢ä¸Šçš„ç”µç£è½¬é’œ<span class="math inline">\(T_e\)</span>åº”ä¸º<span class="math inline">\(T_p\)</span>ä¹˜ä»¥ 2p å³ï¼š</p><p><span class="math display">\[T_e = 2pT_p = Z_aB_{av}li_a \frac{D_a}{2}\]</span></p><p>è€ƒè™‘åˆ°<span class="math inline">\(\pi D_a = 2p\tau , \Phi = B_{av}l \tau\)</span>æ”¯è·¯ç”µæµ<span class="math inline">\(i_a = \frac{I_a}{2a}\)</span>, å…¶ä¸­<span class="math inline">\(I_a\)</span>ä¸ºç”µæ¢ç”µæµï¼Œå¯å¾—ï¼š</p><p><span class="math display">\[T_e = Z_aB_{av}l(\frac{I_a}{2a}) \frac{p \tau}{\pi} = \frac{p}{2\pi} \frac{Z_a}{a} \Phi  I_a = C_T \Phi  I_a\]</span></p><p>å¼ä¸­<span class="math inline">\(C_T\)</span>ä¸ºè½¬é’œå¸¸æ•°ï¼Œè¿™å°±æ˜¯ç›´æµç”µæœºçš„è½¬é’œå…¬å¼ã€‚å¯¹å‘ç”µæœºå’Œç”µåŠ¨æœºéƒ½é€‚ç”¨ã€‚</p><h1 id="å…­æ­¥é©±åŠ¨">å…­æ­¥é©±åŠ¨</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc-step1-2.jpg"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc-step3-4.jpg"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc-step5-6.jpg"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc-table.png"></p><p>é‡‡ç”¨åŠ¨å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc6step.gif"></p><p>BLDC çš„å…­æ­¥æ–¹æ³¢æ§åˆ¶å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQwMDA3NC9hcnRpY2xlL2RldGFpbHMvMTEyMTczNTE3">BLDC çš„å…­æ­¥æ–¹æ³¢æ§åˆ¶<i class="fa fa-external-link-alt"></i></span></p><p>BLDC å°±æ˜¯é€šè¿‡ä¸‰ç›¸è¿›è¡Œæ”¹å˜çº¿åœˆçš„ç”µæµæ–¹å‘æ¥æ”¹å˜ç£åœºæ–¹å‘ï¼Œä»è€Œå…å»ä½¿ç”¨æ¢å‘å™¨æ¥æé«˜ç”µæœºçš„æ€§èƒ½ï¼Œä»¥ä¸Šæ˜¯ bldc çš„å…­æ­¥æ§åˆ¶æ³•ï¼Œ ä½†æ˜¯è¿™ä¸ªæ§åˆ¶å¤ªç²—ç•¥äº†ï¼Œä¸èƒ½å®ç°å¯¹ç”µæœºçš„åŠ›çŸ©ï¼Œé€Ÿåº¦ä»¥åŠä½ç½®çš„é—­ç¯æ§åˆ¶ï¼Œä¸ºæ­¤å‰äººå¼€å‘äº†ä¸€äº›æ§åˆ¶ç®—æ³•ï¼Œæœ¬æ–‡åªä»‹ç» foc è¿™ä¸€ç§æ§åˆ¶ç®—æ³•ã€‚</p><h1 id="foc-ç®—æ³•">FOC ç®—æ³•</h1><h2 id="æ•´ä½“æ§åˆ¶æ¡†å›¾">æ•´ä½“æ§åˆ¶æ¡†å›¾</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/foc.jpg"></p><p>è¿™é‡Œå…ˆå°† FOC æ§åˆ¶æ¡†å›¾åˆ—å‡ºï¼Œåœ¨ä¸‹é¢å°†ä¼šä¸€ä¸ªæ¨¡å—ä¸€ä¸ªæ¨¡å—å½“ä»‹ç»ã€‚ ## clark å˜æ¢ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/clark.jpg"></p><p>åœ¨ä¸Šå›¾ä¸­ clark å˜æ¢æ˜¯å°†<span class="math inline">\(I_a I_b I_c\)</span>ä¸‰ç›¸ç”µæµå˜ä¸º<span class="math inline">\(I_{\alpha} I_{\beta}\)</span>ä¸¤é¡¹ç”µæµï¼Œåœ¨å®é™…çš„ä½¿ç”¨ä¸­éœ€è¦å¯¹ä¸‰ç›¸ç”µæµè¿›è¡Œé‡‡é›†ä»¥è·å¾—å®é™…ç”µæœºä¸­çš„ç”µæµï¼Œä½†æ˜¯ä¸‰ç›¸ç”µæµå‘ˆ 120 åº¦ç›¸ä½å·®åˆ†å¸ƒå¹¶ä¸å¤Ÿç›´è§‚è€Œä¸”æœ‰ä¿¡æ¯å†—ä½™ï¼Œæ ¹æ®åŸºå°”éœå¤«å®šå¾‹ï¼Œä¸‰ç›¸ç”µæµçŸ¢é‡å’Œåº”è¯¥ä¸º 0ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä¸¤é¡¹è¿›è¡Œè¡¨ç¤ºï¼Œæˆ‘ä»¬å¯¹ç›´è§’åæ ‡ç³»å¾ˆç†Ÿæ‚‰ï¼Œå› æ­¤è¿™é‡Œå°†ä¸‰ç›¸ç”µæµè½¬åŒ–ä¸ºç›´è§’ç³»çš„ä¸¤é¡¹åæ ‡ç³»çš„è¿‡ç¨‹å°±æ˜¯ clark å˜æ¢ï¼Œè¯¦ç»†å˜æ¢å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;I_{\alpha } = I_a - cos(\frac{\pi }{3})I_b - cos(\frac{2\pi }{3})I_c \\&amp;I_{\beta } = sin(\frac{\pi }{3})I_b - sin(\frac{\pi }{3})I_c\end{aligned}\]</span></p><p>å†™æˆçŸ©é˜µå½¢å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix} I_{\alpha }\\  I_{\beta } \end{bmatrix} = \begin{bmatrix} 1 &amp; -\frac{1}{2} &amp; -\frac{1}{2}\\ 0 &amp; \frac{\sqrt{3}}{2} &amp; -\frac{\sqrt{3}}{2} \end{bmatrix} \begin{bmatrix} I_a\\ I_b\\ I_c\end{bmatrix}\]</span></p><p>ä½†æ˜¯åˆ°è¿™é‡Œè¿˜æ²¡å®Œï¼Œæˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä½¿ç”¨çš„å…¬å¸å¹¶ä¸æ˜¯è¿™ä¸ªè€Œæ˜¯æœ‰ä¸€ä¸ªç³»æ•° k æ¥è°ƒæ•´ä¸ºç­‰å¹…å˜æ¢æˆ–ç­‰åŠŸç‡å˜æ¢ï¼Œå®é™…ä½¿ç”¨çš„å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix} I_{\alpha }\\  I_{\beta } \end{bmatrix} = k * \begin{bmatrix} 1 &amp; -\frac{1}{2} &amp; -\frac{1}{2}\\ 0 &amp; \frac{\sqrt{3}}{2} &amp; -\frac{\sqrt{3}}{2} \end{bmatrix} \begin{bmatrix} I_a\\ I_b\\ I_c\end{bmatrix}\]</span></p><p>åœ¨ç­‰å¹…å€¼å˜æ¢ä¸­<span class="math inline">\(k = \frac{2}{3}\)</span>å…·ä½“æ¨å¯¼å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/clark2-3.png"></p><p>ä»¥ç›¸ç”µå‹æ¥ä½œä¸ºæ¨å¯¼è€Œä¸æ˜¯ç›¸ç”µæµï¼Œè®¾<span class="math inline">\(V_m\)</span>æ˜¯ç›¸ç”µå‹å³°å€¼ï¼Œåˆ™ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_a = V_m * cos(\theta) \\&amp;U_b = V_m * cos(\theta - \frac{2\pi }{3}) \\&amp;U_c = V_m * cos(\theta + \frac{2\pi }{3}) \\&amp;U_a + U_b + U_c = 0\end{aligned}\]</span></p><p>è¿™é‡Œ<span class="math inline">\(\theta = 2\pi ft\)</span>å°†è¿™ä¸‰ç›¸ç”µå‹åˆæˆç©ºé—´ç”µå‹çŸ¢é‡<span class="math inline">\(U_t\)</span>ä¸ºï¼š</p><p><span class="math display">\[U_t = U_a + U_b * e^{\frac{2 \pi j}{3}} + U_c * e^{\frac{4 \pi j}{3}} = \frac{3}{2}V_m * e^{j\theta }\]</span></p><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºåˆæˆçš„ç”µå‹çŸ¢é‡æ˜¯åŸæ¥çš„<span class="math inline">\(\frac{3}{2}\)</span>, ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå¤šå‡ºæ¥ï¼Ÿï¼Ÿï¼Ÿ å› æ­¤å½“<span class="math inline">\(k = \frac{2}{3}\)</span>æ—¶åˆæˆçŸ¢é‡å°†ä¸å˜æ¢å‰ä¸€è‡´ï¼Œå°±æ˜¯ç­‰å¹…å€¼è½¬æ¢ï¼Œå°†<span class="math inline">\(k = \frac{2}{3}\)</span>ä»£å…¥å…ˆå‰å…¬å¼å¹¶åŒ–ç®€å¯ä»¥å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_{\alpha } = U_a \\&amp;U_{\beta } = \frac{1}{\sqrt{3}}(U_a + 2U_b)\end{aligned}\]</span></p><p>å¦ä¸€ç§å˜æ¢æ˜¯ç­‰åŠŸç‡å˜æ¢ï¼Œå½“<span class="math inline">\(k = \sqrt{\frac{2}{3}}\)</span>ä¸ºç­‰åŠŸç‡å˜æ¢ï¼Œè¯¦ç»†æ¨å¯¼è¿‡ç¨‹å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhaWRpMTk4OS9hcnRpY2xlL2RldGFpbHMvODk5MjYzMjQ=">Clark å˜æ¢åŠæ¯”ä¾‹ç³»æ•° 2/3 æ¨å¯¼è¿‡ç¨‹<i class="fa fa-external-link-alt"></i></span></p><h2 id="park-å˜æ¢">park å˜æ¢</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/park.gif"></p><p>dq åæ ‡ç³»æ˜¯å»ºç«‹åœ¨è½¬å­ä¸Šçš„ç›´è§’åæ ‡ç³»ï¼Œå…¶ä¸­ï¼š</p><p>d è½´æ–¹å‘ä¸è½¬å­ç£é“¾æ–¹å‘é‡åˆï¼Œåˆå«ç›´è½´ï¼› q è½´æ–¹å‘ä¸è½¬å­ç£é“¾æ–¹å‘å‚ç›´ï¼Œåˆå«äº¤è½´ï¼›</p><p>d è½´å’Œğ‘è½´ q è½´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼› <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/qd.png"></p><p>ç›¸å¯¹ä¸å®šå­æ¥è¯´æ˜¯æ—‹è½¬çš„åæ ‡ç³»ï¼Œåœ¨ dq åæ ‡ç³»ä¸‹<span class="math inline">\(i_d i_q\)</span>ä¸ºæ’å®šå€¼è€Œä¸å†æ˜¯æ­£å¼¦å€¼ã€‚park å˜æ¢çš„æœ¬è´¨æ˜¯é™æ­¢åæ ‡ç³»Î±Î²ä¹˜ä»¥ä¸€ä¸ªæ—‹è½¬çŸ©é˜µï¼Œä»è€Œå¾—åˆ° dq åæ ‡ç³»ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;i_d = i_{\alpha} * cos(\theta) + i_{\beta} * sin(\theta) \\&amp;i_q = -i_{\alpha} * sin(\theta) + i_{\beta} * cos(\theta)\end{aligned}\]</span></p><p>å†™æˆçŸ©é˜µå¼ä¸ºï¼š</p><p><span class="math display">\[\begin{bmatrix}i_d\\ i_q\end{bmatrix} = \begin{bmatrix}cos(\theta ) &amp; sin(\theta )\\ -sin(\theta ) &amp; cos(\theta )\end{bmatrix}\begin{bmatrix}i_{\alpha }\\ i_{\beta }\end{bmatrix}\]</span></p><p>é€šè¿‡ park å˜æ¢åå°†äº¤æµä¿¡å·è½¬å˜ä¸ºç›´æµä¿¡å·ï¼Œè¿™æ ·å°±æ–¹ä¾¿è¿›è¡Œä¿¡å·è°ƒèŠ‚ï¼Œåƒä½¿ç”¨ pid æ§åˆ¶å™¨å¯¹ç”µæœºä¿¡å·è¿›è¡Œæ§åˆ¶ã€‚</p><h2 id="park-åå˜æ¢">Park åå˜æ¢</h2><p>Park åå˜æ¢åˆå«ç›´äº¤å˜æ¢ï¼Œç”± dq è½´çš„ç›´æµé‡ï¼Œæœ€ç»ˆå˜æ¢åˆ°Î±Î²çš„äº¤æµé‡ï¼Œå…¶å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;i_{\alpha} = i_d * cos(\theta) - i_q * sin(\theta) \\&amp;i_{\alpha} = i_d * sin(\theta) + i_q * cos(\theta)\end{aligned}\]</span></p><p>å†™æˆçŸ©é˜µå½¢å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix}i_{\alpha }\\ i_{\beta }\end{bmatrix} = \begin{bmatrix}cos(\theta ) &amp; -sin(\theta )\\ sin(\theta ) &amp; cos(\theta )\end{bmatrix}\begin{bmatrix}i_d\\ i_q\end{bmatrix}\]</span></p><p>å› ä¸º svpwm ä½¿ç”¨çš„åæ ‡ç³»è¿˜æ˜¯Î±Î²åæ ‡ç³»ï¼Œåœ¨ç»è¿‡ park å˜æ¢åè¿›è¡Œè°ƒæ§ä¾‹å¦‚ä½¿ç”¨ pid æ§åˆ¶å™¨å¯¹å…¶ä¸­çš„å‚æ•°è¿›è¡Œè°ƒæ§åéœ€è¦å†ç»è¿‡å park å˜æ¢å›å»è¾“å…¥åˆ° svpwn æ¨¡å—ä¸­å»ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ park å˜æ¢æ˜¯éœ€è¦ç”µè§’åº¦ä¿¡æ¯çš„ï¼Œå› æ­¤è¿™é‡Œæ¶‰åŠæ— æ„Ÿå’Œæœ‰æ„Ÿä¸¤ç§ focï¼Œç”±äºæœ¬äººä¹Ÿæ²¡æœ‰ç ”ç©¶è¿‡æ— æ„Ÿ foc å› æ­¤è¿™é‡Œåªè®²ä¸‹æœ‰æ„Ÿ focã€‚æ‰€è°“æœ‰æ„Ÿå°±æ˜¯æœ‰ä¼ æ„Ÿå™¨ï¼Œé€šè¿‡ä¼ æ„Ÿå™¨è·å¾—ç”µæœºè½¬å­çš„ä½ç½®ï¼Œä¼ æ„Ÿå™¨ç§ç±»å¾ˆå¤šæœ‰å…‰ç”µå¼å’Œéœå°”ä¼ æ„Ÿå™¨å¼ï¼ŒæŒ‰ç…§è·å–è§’åº¦ç±»å‹å¯ä»¥åˆ†ä¸ºç»å¯¹å¼ç¼–ç å™¨å’Œç›¸å¯¹å¼ç¼–ç å™¨ï¼Œä½†æ— è®ºå“ªç§ä¼ æ„Ÿå™¨æœ€ç»ˆéƒ½æ˜¯è·å¾—ç”µæœºè½¬å­çš„ä½ç½®ï¼Œç„¶ååœ¨ park å˜æ¢çš„æ—¶å€™ç”¨äºå°†<span class="math inline">\(\alpha \beta\)</span>åæ ‡ç³»è½¬æ¢åˆ° dq åæ ‡ç³»ä¸‹ã€‚è¿™é‡Œä»¥å¸¸è§çš„éœå°”ä¼ æ„Ÿå™¨ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹ï¼Œéœå°”ä¼ æ„Ÿå™¨åˆåˆ†ä¸ºçº¿æ€§éœå°”ä¼ æ„Ÿå™¨å’Œå¼€å…³å‹éœå°”ä¼ æ„Ÿå™¨ï¼Œçº¿æ€§éœå°”ä¼ æ„Ÿå™¨å¯ä»¥è·å¾—æ›´ç²¾ç»†çš„è§’åº¦ä¿¡æ¯ï¼Œä¾‹å¦‚ ti çš„ DRV5055, è¿™ç§ä¼ æ„Ÿå™¨å¦‚æœæƒ³è¦è·å¾—è¾ƒå¥½çš„æ€§èƒ½ä¸€èˆ¬ä½¿ç”¨ä¸¤ä¸ªä¼ æ„Ÿå™¨å‘ˆ 90 åº¦è§’åº¦æ’åˆ—ï¼Œè¿™ç§ä¼ æ„Ÿå™¨ä½¿ç”¨å‰éœ€è¦è¿›è¡Œæ ¡å‡†ï¼Œå¯¹ç£åœºçš„æœ€å¤§å€¼å’Œæœ€å°å€¼è¿›è¡Œæ ¡å‡†æ›´ç²¾ç¡®çš„æ ¡å‡†æ˜¯å¯¹å…¶è¿›è¡Œå°ºåº¦å› å­çš„æ ¡å‡†è¿™ä¸ªä¸€èˆ¬ä¸éœ€è¦ï¼›å¦ä¸€ç§æ˜¯å¼€å…³å‹éœå°”ä¼ æ„Ÿå™¨ä¸€èˆ¬ä½¿ç”¨ 3 ä¸ªä¼ æ„Ÿå™¨å½¼æ­¤ä¹‹é—´å‘ˆ 60 åº¦æˆ– 120 åº¦æ’å¸ƒã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ç§é›†æˆå¼ä¼ æ„Ÿå™¨ï¼Œé€šè¿‡ iic æˆ– spi æ¥å£æ•°å­—è¾“å‡ºè§’åº¦ä¿¡æ¯ï¼Œä¾‹å¦‚ as5600ï¼Œtle5012b ç­‰ï¼Œè¿™ç§ä½¿ç”¨èµ·æ¥æ›´åŠ ç®€å•ï¼Œä¸éœ€è¦å¯¹ä¼ æ„Ÿå™¨è¿›è¡Œæ ¡å‡†åªéœ€è¦å¯¹ç”µè§’åº¦å’Œæœºæ¢°è§’åº¦è¿›è¡Œæ ¡å‡†å³å¯ã€‚ ä¸‹é¢ä»¥ drv5055 è¿™ç§çº¿æ€§éœå°”ä¼ æ„Ÿå™¨ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š drv5055 çº¿æ€§éœå°”ä¼ æ„Ÿå™¨è¾“å‡ºçš„æ˜¯æ¨¡æ‹Ÿä¿¡å·ï¼Œå¯ä»¥æ£€æµ‹ç£åœºå¼ºå¼±ä¿¡å·ï¼Œåœ¨ç”µæœºçš„è½¬å­ä¸Šéœ€è¦å®‰è£…ä¸€ä¸ªå¾„å‘å†²ç£çš„åœ†å½¢æˆ–åœ†ç¯å‹ç£é“ï¼Œç„¶åä¸¤ä¸ª drv5055 å‘ˆ 90 åº¦åˆ†å¸ƒåœ¨ç£é“çš„å¤–ç¯ä½ç½®ï¼Œå½“ç”µæœºè½¬è½¬ä¸€å‘¨ä¼ æ„Ÿå™¨å°†ç»å†å®Œæ•´çš„ä» N æåˆ° S æçš„ç£åœºä¿¡å·ï¼Œè¾“å‡ºä¸ºä¸€ä¸ªå‘¨æœŸçš„æ­£å¼¦æ›²çº¿ï¼Œä¸¤ä¸ªä¼ æ„Ÿå™¨è¾“å‡ºå¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/drv5055.png"></p><p>ä¸¤ä¸ªå‘ˆ 90 æ‘†æ”¾çš„ drv5055 ä¼ æ„Ÿå™¨åœ¨ç”µæœºè½¬å­æ—‹è½¬ä¸€å‘¨è¾“å‡ºçš„æ³¢å½¢å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™é‡Œä¸»è¦è¯´æ˜ä¸¤ç‚¹ï¼š</p><ul><li>ä½¿ç”¨å‘ˆ 90 åº¦æ‘†æ”¾çš„ä¸¤ä¸ªä¼ æ„Ÿå™¨çš„å¥½å¤„ï¼šå•ä¸ªä¼ æ„Ÿå™¨ä»¥ä¸Šå›¾<span class="math inline">\(B_x\)</span>ä¸ºä¾‹åœ¨æœ€å¤§å€¼å’Œæœ€å°å€¼çš„åœ°æ–¹æ–œç‡ä¸º 0 é™„è¿‘æ–œç‡ä¹Ÿéå¸¸å°ï¼Œåœ¨å€¼ä¸º 0 é™„è¿‘æ–œç‡æœ€å¤§ï¼Œå› æ­¤å½“è½¬å­åœ¨æå€¼å¤„å€¼å˜åŒ–ä¸æ˜æ˜¾ä¼šå®¹æ˜“å‡ºç°è¯¯å·®ï¼Œè€Œä¸¤ä¸ªå‘ˆ 90 åº¦æ‘†æ”¾çš„ä¼ æ„Ÿå™¨å°±åˆšå¥½å¼¥è¡¥äº†è¿™ä¸ªç¼ºç‚¹ã€‚</li><li>å…³äºä¼ æ„Ÿå™¨æ ¡å‡†ï¼Œä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªä¼ æ„Ÿå™¨çš„å¹…å€¼ä¸åŒï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¸åŒçš„ï¼Œä¸¤ä¸ªä¼ æ„Ÿå™¨ä¸å¯èƒ½åšçš„å®Œå…¨ä¸€æ ·è€Œä¸”å®‰è£…ä¹Ÿä¼šåˆåå·®ï¼Œå› æ­¤éœ€è¦å¯¹ä¼ æ„Ÿå™¨è¿›è¡Œæ ¡å‡†ï¼Œæ ¡å‡†æ–¹æ³•å°±æ˜¯å¯¹ä¸¤ä¸ªä¼ æ„Ÿå™¨è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œåˆ†åˆ«æ‰¾åˆ°ä¸¤ä¸ªä¼ æ„Ÿå™¨å¯¹æå€¼è¿›è€Œå°±ç¡®å®šäº†ä¸­å€¼ï¼ˆç†æƒ³æƒ…å†µä¸‹ä¸­å€¼ä¸º 0 ä½†å®é™…ä¸Šå¾€å¾€å­˜åœ¨åå·®ï¼‰å°†å…¶å½’ä¸€åŒ–åˆ° [-1, 1] è¿™ä¸ªå€¼åŸŸå†…å°±å®Œæˆäº†å¯¹ä¼ æ„Ÿå™¨å¯¹æ ¡å‡†ã€‚</li></ul><h2 id="svpwm">SVPWM</h2><h3 id="æ¦‚è¿°">æ¦‚è¿°</h3><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/bldc-driver.jpg"></p><p>SVPWM æ˜¯è¿‘å¹´å‘å±•çš„ä¸€ç§æ¯”è¾ƒæ–°é¢–çš„æ§åˆ¶æ–¹æ³•ï¼Œæ˜¯ç”±ä¸‰ç›¸åŠŸç‡é€†å˜å™¨çš„å…­ä¸ªåŠŸç‡å¼€å…³å…ƒä»¶ç»„æˆçš„ç‰¹å®šå¼€å…³æ¨¡å¼äº§ç”Ÿçš„è„‰å®½è°ƒåˆ¶æ³¢ï¼Œèƒ½å¤Ÿä½¿è¾“å‡ºç”µæµæ³¢å½¢å°½ å¯èƒ½æ¥è¿‘äºç†æƒ³çš„æ­£å¼¦æ³¢å½¢ã€‚ç©ºé—´ç”µå‹çŸ¢é‡ PWM ä¸ä¼ ç»Ÿçš„æ­£å¼¦ PWM ä¸åŒï¼Œå®ƒæ˜¯ä»ä¸‰ç›¸è¾“å‡ºç”µå‹çš„æ•´ä½“æ•ˆæœå‡ºå‘ï¼Œç€çœ¼äºå¦‚ä½•ä½¿ç”µæœºè·å¾—ç†æƒ³åœ†å½¢ç£é“¾è½¨è¿¹ã€‚ SVPWM æŠ€æœ¯ä¸ SPWM ç›¸æ¯”è¾ƒï¼Œç»•ç»„ç”µæµæ³¢å½¢çš„è°æ³¢ æˆåˆ†å°ï¼Œä½¿å¾—ç”µæœºè½¬çŸ©è„‰åŠ¨é™ä½ï¼Œæ—‹è½¬ç£åœºæ›´é€¼è¿‘åœ†å½¢ï¼Œè€Œä¸”ä½¿ç›´æµæ¯çº¿ç”µå‹çš„åˆ©ç”¨ç‡æœ‰äº†å¾ˆå¤§æé«˜ï¼Œä¸”æ›´æ˜“äºå®ç°æ•°å­—åŒ–ã€‚ä¸‹é¢å°†å¯¹è¯¥ç®—æ³•è¿›è¡Œè¯¦ç»†åˆ†æé˜è¿°ã€‚</p><h3 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h3><p>SVPWM çš„ç†è®ºåŸºç¡€æ˜¯å¹³å‡å€¼ç­‰æ•ˆåŸç†ï¼Œå³åœ¨ä¸€ä¸ªå¼€å…³å‘¨æœŸå†…é€šè¿‡å¯¹åŸºæœ¬ç”µå‹çŸ¢é‡åŠ ä»¥ç»„åˆï¼Œä½¿å…¶å¹³å‡å€¼ä¸ç»™å®šç”µå‹çŸ¢é‡ç›¸ç­‰ã€‚åœ¨æŸä¸ªæ—¶åˆ»ï¼Œç”µå‹çŸ¢é‡æ—‹è½¬åˆ°æŸä¸ªåŒºåŸŸä¸­ï¼Œå¯ç”±ç»„æˆè¿™ä¸ªåŒºåŸŸçš„ä¸¤ä¸ªç›¸é‚»çš„éé›¶çŸ¢é‡å’Œé›¶çŸ¢é‡åœ¨æ—¶é—´ä¸Šçš„ä¸åŒç»„åˆæ¥å¾—åˆ°ã€‚ä¸¤ä¸ªçŸ¢é‡çš„ä½œç”¨æ—¶é—´åœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸå†…åˆ†å¤šæ¬¡æ–½åŠ ï¼Œä»è€Œæ§åˆ¶å„ä¸ªç”µå‹çŸ¢é‡çš„ä½œç”¨æ—¶é—´ï¼Œä½¿ç”µå‹ç©ºé—´çŸ¢é‡æ¥è¿‘æŒ‰åœ†è½¨è¿¹æ—‹è½¬ï¼Œé€šè¿‡é€†å˜å™¨çš„ä¸åŒå¼€å…³çŠ¶æ€æ‰€äº§ç”Ÿçš„å®é™…ç£é€šå»é€¼è¿‘ç†æƒ³ç£é€šåœ†ï¼Œå¹¶ç”±ä¸¤è€…çš„æ¯”è¾ƒç»“æœæ¥å†³å®šé€†å˜å™¨çš„å¼€å…³çŠ¶æ€ï¼Œä»è€Œå½¢æˆ PWM æ³¢å½¢ã€‚ ç”±äºé€†å˜å™¨ä¸‰ç›¸æ¡¥è‡‚å…±æœ‰ 6 ä¸ªå¼€å…³ç®¡ï¼Œä¸ºäº†ç ”ç©¶å„ç›¸ä¸Šä¸‹æ¡¥è‡‚ä¸åŒå¼€å…³ç»„åˆæ—¶é€†å˜å™¨è¾“å‡ºçš„ ç©ºé—´ç”µå‹çŸ¢é‡ï¼Œç‰¹å®šä¹‰å¼€å…³å‡½æ•° Sx ( x = aã€bã€c) ä¸ºï¼š</p><p><span class="math display">\[S_x = \left\{\begin{matrix}1ï¼ˆä¸Šæ¡¥è‡‚å¯¼é€šï¼‰\\ 0ï¼ˆä¸‹æ¡¥è‡‚å¯¼é€šï¼‰\end{matrix}\right.\]</span></p><p>(Saã€Sbã€Sc) çš„å…¨éƒ¨å¯èƒ½ç»„åˆå…±æœ‰å…«ä¸ªï¼ŒåŒ…æ‹¬ 6 ä¸ªéé›¶çŸ¢é‡ Ul(001)ã€U2(010)ã€U3(011)ã€U4(100)ã€U5(101)ã€U6(110)ã€å’Œä¸¤ä¸ªé›¶çŸ¢é‡ U0(000)ã€U7(111)ï¼Œä¸‹é¢ä»¥å…¶ä¸­ä¸€ ç§å¼€å…³ç»„åˆä¸ºä¾‹åˆ†æï¼Œå‡è®¾ Sx ( x= aã€bã€c)= (100)ï¼Œ æ­¤æ—¶ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm100.png"></p><p><span class="math display">\[\begin{aligned}&amp;U_{ab} = U_{dc}, U_{bc} = 0, U_{ca} = -U_{dc} \\&amp;U_{aN} - U_{bN} = U_{dc},U_{aN} - U_{cN} = U_{dc} \\&amp;U_{aN} + U_{bN} + U_{cN} = 0\end{aligned}\]</span></p><p>æ±‚è§£ä¸Šè¿°æ–¹ç¨‹å¯å¾—ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_{aN} = \frac{2U_d}{3} \\&amp;U_{bN} = - \frac{U_d}{3} \\&amp;U_{cN} = - \frac{U_d}{3}\end{aligned}\]</span></p><p>åŒç†å¯è®¡ç®—å‡ºå…¶å®ƒå„ç§ç»„åˆä¸‹çš„ç©ºé—´ç”µå‹çŸ¢é‡ï¼Œåˆ—è¡¨å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-table.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm.png"></p><p>å…¶ä¸­éé›¶çŸ¢é‡çš„å¹…å€¼ç›¸åŒï¼ˆæ¨¡é•¿ä¸º <span class="math inline">\(\frac{2U_{dc}}{3}\)</span>ï¼‰ï¼Œç›¸é‚»çš„çŸ¢é‡é—´éš” 60Â°ï¼Œè€Œä¸¤ä¸ªé›¶çŸ¢é‡å¹…å€¼ä¸ºé›¶ï¼Œä½äºä¸­å¿ƒã€‚åœ¨æ¯ä¸€ä¸ªæ‰‡åŒºï¼Œé€‰æ‹©ç›¸é‚»çš„ä¸¤ä¸ªç”µå‹çŸ¢é‡ä»¥åŠé›¶çŸ¢é‡ï¼ŒæŒ‰ç…§ä¼ç§’å¹³è¡¡çš„åŸåˆ™æ¥åˆæˆæ¯ä¸ªæ‰‡åŒºå†…çš„ä»»æ„ç”µå‹çŸ¢é‡ï¼Œå³ï¼š</p><p><span class="math display">\[\int_{0}^{T}U_{ref} dt = \int_{0}^{T_x}U_x dt + \int_{T_x}^{T_x + T_y}U_y dt + \int_{T_x + T_y}^{T}U_0 dt\]</span></p><p>ç­‰æ•ˆä¸ä¸‹å¼ï¼š</p><p><span class="math display">\[U_{ref} * T = U_x * T_x + U_y * T_y + U_0 * T_0\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(U_{ref}\)</span> ä¸ºæœŸæœ›ç”µå‹çŸ¢é‡ï¼›T ä¸ºé‡‡æ ·å‘¨æœŸï¼›<span class="math inline">\(T_xã€T_yã€T_0\)</span> åˆ†åˆ«ä¸ºå¯¹åº”ä¸¤ä¸ªéé›¶ç”µå‹çŸ¢é‡ <span class="math inline">\(U_xã€U_y\)</span>å’Œé›¶ç”µå‹çŸ¢é‡<span class="math inline">\(U_0\)</span>åœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸçš„ä½œç”¨æ—¶é—´ï¼›å…¶ä¸­<span class="math inline">\(U_0\)</span>åŒ…æ‹¬äº†<span class="math inline">\(U_0\)</span>å’Œ<span class="math inline">\(U_7\)</span>ä¸¤ä¸ªé›¶çŸ¢é‡ã€‚ä¸Šå¼çš„æ„ä¹‰æ˜¯ï¼ŒçŸ¢é‡ <span class="math inline">\(U_{ref}\)</span> åœ¨ T æ—¶é—´å†…æ‰€äº§ç”Ÿçš„ç§¯åˆ†æ•ˆæœå€¼å’Œ <span class="math inline">\(U_xã€U_yã€U_0\)</span>åˆ†åˆ«åœ¨æ—¶é—´<span class="math inline">\(T_xã€T_yã€T_0\)</span>å†…äº§ç”Ÿçš„ç§¯åˆ†æ•ˆæœç›¸åŠ æ€»å’Œå€¼ç›¸åŒã€‚ç”±äºä¸‰ç›¸æ­£å¼¦æ³¢ç”µå‹åœ¨ç”µå‹ç©ºé—´å‘é‡ä¸­åˆæˆä¸€ä¸ªç­‰æ•ˆçš„æ—‹è½¬ç”µå‹ï¼Œå…¶æ—‹è½¬é€Ÿåº¦æ˜¯è¾“å…¥ç”µæºè§’é¢‘ç‡ï¼Œç­‰æ•ˆæ—‹è½¬ç”µå‹çš„è½¨è¿¹å°†æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºçš„åœ†å½¢ã€‚æ‰€ä»¥è¦äº§ç”Ÿä¸‰ç›¸æ­£å¼¦æ³¢ç”µå‹ï¼Œå¯ä»¥åˆ©ç”¨ä»¥ä¸Šç”µå‹å‘é‡åˆæˆçš„æŠ€æœ¯ï¼Œåœ¨ç”µå‹ç©ºé—´å‘é‡ä¸Šï¼Œå°†è®¾å®šçš„ç”µå‹å‘é‡ç”± U4(100) ä½ç½®å¼€å§‹ï¼Œæ¯ä¸€æ¬¡å¢åŠ ä¸€ä¸ªå°å¢é‡ï¼Œæ¯ä¸€ä¸ªå°å¢é‡è®¾å®šç”µå‹å‘é‡å¯ä»¥ç”¨è¯¥åŒºä¸­ç›¸é‚»çš„ä¸¤ä¸ªåŸºæœ¬éé›¶å‘é‡ä¸é›¶ç”µå‹å‘é‡äºˆä»¥åˆæˆï¼Œå¦‚æ­¤æ‰€å¾—åˆ°çš„è®¾å®šç”µå‹å‘é‡å°±ç­‰æ•ˆäºä¸€ä¸ªåœ¨ç”µå‹ç©ºé—´å‘é‡å¹³é¢ä¸Šå¹³æ»‘æ—‹è½¬çš„ç”µå‹ç©ºé—´å‘é‡ï¼Œä»è€Œè¾¾åˆ°ç”µå‹ç©ºé—´å‘é‡è„‰å®½è°ƒåˆ¶çš„ç›®çš„ã€‚</p><h3 id="æ¨å¯¼">æ¨å¯¼</h3><p>ä¸‰ç›¸ç”µå‹ç»™å®šæ‰€åˆæˆçš„ç”µå‹å‘é‡æ—‹è½¬è§’é€Ÿåº¦ä¸ºÏ‰=2Ï€fï¼Œæ—‹è½¬ä¸€å‘¨æ‰€éœ€çš„æ—¶é—´ä¸º T =1/f ï¼›è‹¥è½½æ³¢é¢‘ç‡æ˜¯ fsï¼Œåˆ™é¢‘ç‡æ¯”ä¸º R = fs / fã€‚è¿™æ ·å°†ç”µå‹æ—‹è½¬å¹³é¢ç­‰åˆ‡å‰²æˆ R ä¸ªå°å¢é‡ï¼Œäº¦ å³è®¾å®šç”µå‹å‘é‡æ¯æ¬¡å¢é‡çš„è§’åº¦æ˜¯ ï¼š</p><p><span class="math display">\[\gamma = \frac{2}{R} = \frac{2 \pi f}{fs} = \frac{2Ts}{T}\]</span></p><p>å‡è®¾æ¬²åˆæˆçš„ç”µå‹å‘é‡ <span class="math inline">\(U_{ref}\)</span> åœ¨ç¬¬â… åŒºä¸­ç¬¬ä¸€ä¸ªå¢é‡çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¬²ç”¨ U4ã€U6ã€U0 åŠ U7 åˆæˆï¼Œç”¨å¹³å‡å€¼ç­‰æ•ˆå¯å¾—ï¼š<span class="math inline">\(U_ref * Tz =U4 * T4 +U6 * T6\)</span> ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-1.png"></p><p>åœ¨ä¸¤ç›¸é™æ­¢å‚è€ƒåæ ‡ç³»ï¼ˆÎ±ï¼ŒÎ²ï¼‰ä¸­ï¼Œä»¤<span class="math inline">\(U_{ref}\)</span>å’Œ U4 é—´çš„å¤¹è§’æ˜¯Î¸ï¼Œç”±æ­£å¼¦å®šç†å¯å¾—ï¼š</p><p><span class="math display">\[\left | U_{ref} \right | cos(\theta ) = \frac{T_4}{T_s}\left | U_4 \right | + \frac{T_6}{T_s} \left | U_6 \right | cos(\frac{\pi }{3})\\\left | U_{ref} \right | sin(\theta ) =  \frac{T_6}{T_s} \left | U_6 \right | sin(\frac{\pi }{3})\]</span></p><p>å› ä¸º |U4 |=|U6|=2Udc/3 ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°å„çŸ¢é‡çš„çŠ¶æ€ä¿æŒæ—¶é—´ä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;T_4 = mT_s sin(\frac{\pi }{3} - \theta ) \\&amp;T_6 = mT_s sin(\theta )\end{aligned}\]</span></p><p>å¼ä¸­ m ä¸º SVPWM è°ƒåˆ¶ç³»æ•°ï¼ˆè°ƒåˆ¶æ¯”ï¼‰ï¼Œ <span class="math inline">\(m= \frac{\sqrt{3}\left | U_{ref} \right |}{U_{dc}}\)</span>ã€‚è€Œé›¶ç”µå‹å‘é‡æ‰€åˆ†é…çš„æ—¶é—´ä¸ºï¼šT7=T0=(TS-T4-T6 ) /2 æˆ–è€… T7 =(TS-T4-T6 ) å¾—åˆ°ä»¥ U4ã€U6ã€U7 åŠ U0 åˆæˆçš„ Uref çš„æ—¶é—´åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•äº§ç”Ÿå®é™…çš„è„‰å®½è°ƒåˆ¶æ³¢å½¢ã€‚åœ¨ SVPWM è°ƒåˆ¶æ–¹æ¡ˆä¸­ï¼Œé›¶çŸ¢é‡çš„é€‰æ‹©æ˜¯æœ€å…·çµæ´»æ€§çš„ï¼Œé€‚å½“é€‰æ‹©é›¶çŸ¢é‡ï¼Œå¯æœ€å¤§é™åº¦åœ°å‡å°‘å¼€å…³æ¬¡æ•°ï¼Œå°½å¯èƒ½é¿å…åœ¨è´Ÿè½½ç”µæµè¾ƒå¤§çš„æ—¶åˆ»çš„å¼€å…³åŠ¨ä½œï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘å¼€å…³æŸè€—ã€‚</p><h3 id="ä¸ƒæ®µå¼-svpwm">ä¸ƒæ®µå¼ SVPWM</h3><p>æˆ‘ä»¬ä»¥å‡å°‘å¼€å…³æ¬¡æ•°ä¸ºç›®æ ‡ï¼Œå°†åŸºæœ¬çŸ¢é‡ä½œç”¨é¡ºåºçš„åˆ†é…åŸåˆ™é€‰å®šä¸ºï¼šåœ¨æ¯æ¬¡å¼€å…³çŠ¶æ€è½¬æ¢æ—¶ï¼Œåªæ”¹å˜å…¶ä¸­ä¸€ç›¸çš„ å¼€å…³çŠ¶æ€ã€‚å¹¶ä¸”å¯¹é›¶çŸ¢é‡åœ¨æ—¶é—´ä¸Šè¿›è¡Œäº†å¹³å‡åˆ†é…ï¼Œä»¥ä½¿äº§ç”Ÿçš„ PWM å¯¹ç§°ï¼Œä»è€Œæœ‰æ•ˆåœ°é™ä½ PWM çš„è°æ³¢åˆ†é‡ã€‚å½“ U4(100) åˆ‡æ¢è‡³ U0(000) æ—¶ï¼Œåªéœ€æ”¹å˜ A ç›¸ä¸Šä¸‹ä¸€å¯¹åˆ‡æ¢å¼€å…³ï¼Œè‹¥ç”± U4(100) åˆ‡æ¢è‡³ U7(111) åˆ™éœ€æ”¹å˜ Bã€C ç›¸ä¸Šä¸‹ä¸¤å¯¹åˆ‡æ¢å¼€å…³ï¼Œå¢åŠ äº†ä¸€å€çš„åˆ‡æ¢æŸå¤±ã€‚å› æ­¤è¦æ”¹å˜ç”µå‹å‘é‡ U4(100)ã€U2(010)ã€ U1(001) çš„å¤§å°ï¼Œéœ€é…åˆé›¶ç”µå‹å‘é‡ U0(000)ï¼Œè€Œè¦æ”¹å˜ U6(110)ã€U3(011)ã€U5(100)ï¼Œ éœ€é…åˆé›¶ç”µå‹å‘é‡ U7(111)ã€‚è¿™æ ·é€šè¿‡åœ¨ä¸åŒåŒºé—´å†…å®‰æ’ä¸åŒçš„å¼€å…³åˆ‡æ¢é¡ºåºï¼Œ å°±å¯ä»¥è·å¾—å¯¹ç§°çš„è¾“å‡ºæ³¢å½¢ï¼Œå…¶å®ƒå„æ‰‡åŒºçš„å¼€å…³åˆ‡æ¢é¡ºåºå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-7.png"></p><p>ç°çš„å…ˆåé¡ºåºä¸º U0ã€U4ã€U6ã€U7ã€U6ã€U4ã€U0ï¼Œå„ç”µå‹å‘é‡çš„ä¸‰ç›¸æ³¢å½¢åˆ™ä¸ä¸Šè¡¨ä¸­çš„å¼€å…³è¡¨ç¤ºç¬¦å·ç›¸å¯¹åº”ã€‚å†ä¸‹ä¸€ä¸ª TS æ—¶æ®µï¼ŒUref çš„è§’åº¦å¢åŠ ä¸€ä¸ªÎ³ï¼Œåˆ©ç”¨å¼ä¸Šå¼å¯ä»¥é‡æ–°è®¡ç®—æ–°çš„ T0ã€T4ã€T6 åŠ T7 å€¼ï¼›è¿™æ ·æ¯ä¸€ä¸ªè½½æ³¢å‘¨æœŸ Ts å°±ä¼šåˆæˆä¸€ä¸ªæ–°çš„çŸ¢é‡ï¼Œéšç€Î¸çš„é€æ¸å¢å¤§ï¼Œ<span class="math inline">\(U_ref\)</span> å°†ä¾åºè¿›å…¥ç¬¬â… ã€â…¡ã€â…¢ã€â…£ã€â…¤ã€â…¥åŒºã€‚åœ¨ç”µå‹å‘é‡æ—‹è½¬ä¸€å‘¨æœŸåï¼Œå°±ä¼šäº§ç”Ÿ R ä¸ªåˆæˆçŸ¢é‡ã€‚</p><h3 id="åˆæˆçŸ¢é‡u_refæ‰€å¤„æ‰‡åŒº-n-çš„åˆ¤æ–­">åˆæˆçŸ¢é‡<span class="math inline">\(U_ref\)</span>æ‰€å¤„æ‰‡åŒº N çš„åˆ¤æ–­</h3><p>ç©ºé—´çŸ¢é‡è°ƒåˆ¶çš„ç¬¬ä¸€æ­¥æ˜¯åˆ¤æ–­ç”± UÎ±å’Œ UÎ²æ‰€å†³å®šçš„ç©ºé—´ç”µå‹çŸ¢é‡æ‰€å¤„çš„æ‰‡åŒºã€‚å‡å®šåˆæˆçš„ç”µå‹çŸ¢é‡è½åœ¨ç¬¬ I æ‰‡åŒºï¼Œå¯çŸ¥å…¶ç­‰ä»·æ¡ä»¶å¦‚ä¸‹ï¼š0Âº &lt; arctan(UÎ²/UÎ±) &lt; 60 Âº ä»¥ä¸Šç­‰ä»·æ¡ä»¶å†ç»“åˆçŸ¢é‡å›¾å‡ ä½•å…³ç³»åˆ†æï¼Œå¯ä»¥åˆ¤æ–­å‡ºåˆæˆç”µå‹çŸ¢é‡<span class="math inline">\(U_ref\)</span>è½åœ¨ç¬¬ X æ‰‡åŒºçš„å……åˆ†å¿…è¦æ¡ä»¶ï¼Œå¾—å‡ºä¸‹è¡¨ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-sector.png"></p><p>è‹¥è¿›ä¸€æ­¥åˆ†æä»¥ä¸Šçš„æ¡ä»¶ï¼Œæœ‰å¯çœ‹å‡ºå‚è€ƒç”µå‹çŸ¢é‡<span class="math inline">\(U_ref\)</span>æ‰€åœ¨çš„æ‰‡åŒºå®Œå…¨ç”±<span class="math inline">\(U_{\beta }, \sqrt{3}U_{\alpha } - U_{\beta }, -\sqrt{3}U_{\alpha } - U_{\beta }\)</span>ä¸‰å¼å†³å®šï¼Œå› æ­¤ä»¤ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_1 = U_{\beta} \\&amp;U_2 = \sqrt{3}U_{\alpha } - U_{\beta } \\&amp;U_3 = -\sqrt{3}U_{\alpha } - U_{\beta }\end{aligned}\]</span></p><p>å†å®šä¹‰ï¼Œè‹¥ U1&gt;0 ï¼Œåˆ™ A=1ï¼Œå¦åˆ™ A=0ï¼› è‹¥ U 2&gt;0 ï¼Œåˆ™ B=1ï¼Œå¦åˆ™ B=0ï¼›è‹¥ U3&gt;0 ï¼Œåˆ™ C=1ï¼Œå¦åˆ™ C=0ã€‚å¯ä»¥çœ‹å‡º Aï¼ŒBï¼ŒC ä¹‹é—´å…±æœ‰å…«ç§ç»„åˆï¼Œä½†ç”±åˆ¤æ–­æ‰‡åŒºçš„å…¬å¼å¯çŸ¥ Aï¼ŒBï¼ŒC ä¸ä¼šåŒæ—¶ä¸º 1 æˆ–åŒæ—¶ä¸º 0ï¼Œæ‰€ä»¥å®é™…çš„ç»„åˆæ˜¯å…­ç§ï¼ŒAï¼ŒBï¼ŒC ç»„åˆå–ä¸åŒçš„å€¼å¯¹ åº”ç€ä¸åŒçš„æ‰‡åŒºï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå› æ­¤å®Œå…¨å¯ä»¥ç”± Aï¼ŒBï¼ŒC çš„ç»„åˆåˆ¤æ–­æ‰€åœ¨çš„æ‰‡åŒºã€‚ä¸ºåŒºåˆ«å…­ç§çŠ¶æ€ï¼Œä»¤ N=4 * C + 2 * B + Aï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸‹è¡¨è®¡ç®—å‚è€ƒç”µå‹ çŸ¢é‡ Uref æ‰€åœ¨çš„æ‰‡åŒºã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-sectorx.png"></p><p>é‡‡ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œåªéœ€ç»è¿‡ç®€å•çš„åŠ å‡åŠé€»è¾‘è¿ç®—å³å¯ç¡®å®šæ‰€åœ¨çš„æ‰‡åŒºï¼Œå¯¹äºæé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œè¿›è¡Œä»¿çœŸéƒ½æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚</p><h3 id="åŸºæœ¬çŸ¢é‡ä½œç”¨æ—¶é—´è®¡ç®—">åŸºæœ¬çŸ¢é‡ä½œç”¨æ—¶é—´è®¡ç®—</h3><p>åœ¨ä¼ ç»Ÿ SVPWM ç®—æ³•ä¸­ç”¨åˆ°äº†ç©ºé—´è§’åº¦åŠä¸‰è§’å‡½æ•°ï¼Œä½¿å¾—ç›´æ¥è®¡ç®—åŸºæœ¬ç”µå‹çŸ¢é‡ä½œç”¨æ—¶é—´å˜å¾—ååˆ†å›°éš¾ã€‚å®é™…ä¸Šåªè¦å……åˆ†åˆ©ç”¨ UÎ± å’Œ UÎ² å°±å¯ä»¥ä½¿è®¡ç®—å¤§ä¸ºç®€åŒ–ã€‚ä»¥ Uref å¤„åœ¨ç¬¬â… æ‰‡åŒºæ—¶è¿›è¡Œåˆ†ææœ‰ï¼š</p><p><span class="math display">\[\begin{bmatrix}U_{\alpha }\\ U_{\beta }\end{bmatrix} = U_{ref}\begin{bmatrix}cos(\theta )\\ sin(\theta )\end{bmatrix} T_s = \frac{2}{3}U_{dc}\left ( \begin{bmatrix}1\\ 0\end{bmatrix} T_4 + \begin{bmatrix}cos(\frac{\pi }{3})\\ sin(\frac{\pi }{3})\end{bmatrix}T_6\right )\]</span></p><p>ç»è¿‡æ•´ç†åå¾—å‡ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_{\alpha } T_s = \frac{2}{3}U_{dc}(T_4 + \frac{1}{2}T_6) \\&amp;U_{\beta } T_s = \frac{2}{3}U_{dc}(\frac{\sqrt{3}}{2}T_6)\end{aligned}\]</span></p><p><span class="math display">\[\begin{aligned}&amp;T_4 = \frac{2U_{\alpha } T}{2U_{dc}} - \frac{1}{2}T_6 = \frac{2U_{\alpha } T_s}{2U_{dc}} - \frac{\sqrt{3}}{2}\frac{U_{\beta }T_s}{U_{dc}} = \frac{\sqrt{3}T_s}{U_{dc}}U_2 \\&amp;T_6 = \frac{\sqrt{3} U_{\beta }T_s}{U_{dc}} = \frac{\sqrt{3}T_s}{U_{dc}}U_1 \\&amp;T_7 = T_0 = \frac{T_s - T_4 - T_6}{2}\end{aligned}\]</span></p><p>åŒç†å¯æ±‚å¾—<span class="math inline">\(U_ref\)</span>åœ¨å…¶å®ƒæ‰‡åŒºä¸­å„çŸ¢é‡çš„ä½œç”¨æ—¶é—´ï¼Œç»“æœå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ç”±æ­¤å¯æ ¹æ®å‰å¼ä¸­çš„ U1 ã€U 2 ã€U3 åˆ¤æ–­åˆæˆçŸ¢é‡æ‰€åœ¨æ‰‡åŒºï¼Œç„¶åæŸ¥è¡¨å¾—å‡ºä¸¤éé›¶çŸ¢é‡çš„ä½œç”¨æ—¶é—´ï¼Œ æœ€åå¾—å‡ºä¸‰ç›¸ PWM æ³¢å ç©ºæ¯”ï¼Œä¸‹è¡¨å¯ä»¥ä½¿ SVPWM ç®—æ³•ç¼–ç¨‹ç®€æ˜“å®ç°ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-time1.png"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-time2.png"></p><p>å°† I æ‰‡åŒºçš„æ—¶é—´å›¾ç”»å‡ºæ¥å¦‚ä¸‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Algorithm/svpwm-time1sector.png"></p><h3 id="svpwm-ç‰©ç†å«ä¹‰">SVPWM ç‰©ç†å«ä¹‰</h3><p>SVPWM å®è´¨æ˜¯ä¸€ç§å¯¹åœ¨ä¸‰ç›¸æ­£å¼¦æ³¢ä¸­æ³¨å…¥äº†é›¶åºåˆ†é‡çš„è°ƒåˆ¶æ³¢è¿›è¡Œè§„åˆ™é‡‡æ ·çš„ä¸€ç§å˜å½¢ SPWMã€‚ä½† SVPWM çš„è°ƒåˆ¶è¿‡ç¨‹æ˜¯åœ¨ç©ºé—´ä¸­å®ç°çš„ï¼Œè€Œ SPWM æ˜¯åœ¨ ABC åæ ‡ç³»ä¸‹åˆ†ç›¸å®ç°çš„ï¼›SPWM çš„ç›¸ç”µå‹è°ƒåˆ¶æ³¢æ˜¯æ­£å¼¦æ³¢ï¼Œè€Œ SVPWM æ²¡æœ‰æ˜ç¡®çš„ç›¸ç”µå‹è°ƒåˆ¶æ³¢ï¼Œæ˜¯éšå«çš„ã€‚ä¸ºäº†æ­ç¤º SVPWM ä¸ SPWM çš„å†…åœ¨è”ç³»ï¼Œéœ€æ±‚å‡º SVPWM åœ¨ ABC åæ ‡ç³»ä¸Šçš„ç­‰æ•ˆè°ƒåˆ¶æ³¢æ–¹ç¨‹ï¼Œä¹Ÿå°±æ˜¯å°† SVPWM çš„éšå«è°ƒåˆ¶æ³¢æ˜¾åŒ–ã€‚ æˆ‘ä»¬çŸ¥é“äº†å„æ‰‡åŒºçš„çŸ¢é‡å‘é€é¡ºåºï¼š å¥‡æ•°åŒºä¾æ¬¡ä¸ºï¼šU 0 ï¼ŒU k ï¼ŒU k+1 ï¼ŒU 7 ï¼ŒU k+1 ï¼ŒU k ï¼ŒU 0 å¶æ•°åŒºä¾æ¬¡ä¸ºï¼šU 0 ï¼ŒU k+1 ï¼ŒU k ï¼ŒU 7 ï¼ŒU k ï¼ŒU k+1 ï¼ŒU 0 åˆ©ç”¨ç©ºé—´ç”µå‹çŸ¢é‡è¿‘ä¼¼åŸç†ï¼Œå¯æ€»ç»“å‡ºä¸‹å¼ï¼š</p><p><span class="math display">\[\begin{bmatrix}T_k\\ t_{k+1}\end{bmatrix} = \begin{bmatrix}sin(\frac{k\pi }{3}) &amp; -cos(\frac{k\pi }{3})\\ sin(\frac{(k -1) \pi }{3}) &amp; -cos(\frac{(k-1)\pi }{3})\end{bmatrix}\begin{bmatrix}cos(\theta )\\ sin(\theta )\end{bmatrix}\]</span></p><p>å¼ä¸­ m ä»ä¸º SVPWM è°ƒåˆ¶ç³»æ•°ï¼Œåˆ©ç”¨ä»¥ä¸Šå„å¼å°±å¯å¾—åˆ°åœ¨ç¬¬â… æ‰‡åŒºçš„å„ç›¸ç”µå‹å¹³å‡å€¼ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_a(\theta ) = \frac{U_{dc}}{T_s}(-\frac{T_0}{2} + \frac{T_4}{2} + \frac{T_6}{2} + \frac{T_7}{2} + \frac{T_7}{2} + \frac{T_6}{2} + \frac{T_4}{2} - \frac{T_0}{2} ) = \frac{\sqrt{3}}{2}\left | U_{ref} \right | cos(\theta - \frac{\pi }{6}) \\&amp;U_b(\theta ) = \frac{U_{dc}}{T_s}(-\frac{T_0}{2} + \frac{T_4}{2} + \frac{T_6}{2} + \frac{T_7}{2} + \frac{T_7}{2} + \frac{T_6}{2} + \frac{T_4}{2} - \frac{T_0}{2} ) = \frac{\sqrt{3}}{2}\left | U_{ref} \right | sin(\theta - \frac{\pi }{6}) \\&amp;U_c(\theta ) = \frac{U_{dc}}{T_s}(-\frac{T_0}{2} + \frac{T_4}{2} + \frac{T_6}{2} + \frac{T_7}{2} + \frac{T_7}{2} + \frac{T_6}{2} + \frac{T_4}{2} - \frac{T_0}{2} ) = -\frac{\sqrt{3}}{2}\left | U_{ref} \right | cos(\theta - \frac{\pi }{6})\end{aligned}\]</span></p><p>åŒæ ·å¯ä»¥æ¨å¯¼å‡ºå…¶å®ƒæ‰‡åŒºçš„è°ƒåˆ¶æ³¢å‡½æ•°ï¼Œå…¶ç›¸ç”µå‹è°ƒåˆ¶å‡½æ•°å¦‚ä¸‹ï¼š</p><p><span class="math display">\[U_a(\theta ) = \left\{\begin{matrix}\frac{\sqrt{3}}{2}\left | U_{ref} \right | cos(\theta - \frac{\pi }{6}) ---(0 \leqslant  \theta &lt; \frac{\pi }{3}, \pi \leqslant \theta &lt; \frac{4\pi }{3})\\ \frac{\sqrt{3}}{2}\left | U_{ref} \right | cos(\theta ) ---(\frac{\pi }{3}\leqslant \theta &lt; \frac{2\pi }{3}, \frac{4\pi }{3} \leqslant \theta &lt; \frac{5\pi }{3})\\ \frac{\sqrt{3}}{2}\left | U_{ref} \right | cos(\theta + \frac{\pi }{6}) ---(\frac{2\pi }{3} \leqslant  \theta &lt; \pi , \frac{5\pi }{3} \leqslant \theta &lt; 2\pi )\end{matrix}\right. \\U_b(\theta ) = U_a(\theta - \frac{2\pi }{3}) \\U_c(\theta ) = U_a(\theta - \frac{4\pi }{3})\]</span></p><p>å…¶çº¿ç”µå‹çš„è°ƒåˆ¶æ³¢å‡½æ•°ä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;U_{ab}(\theta) = U_a(\theta) - U_b(\theta) = \sqrt{3 } \left| U_{ref} \right |sin(\theta + \frac{\pi }{3}) \\&amp;U_{bc}(\theta ) = U_{ab}(\theta - \frac{2\pi }{3}) \\&amp;U_{ca}(\theta ) = U_{a}(\theta - \frac{4\pi }{3})\end{aligned}\]</span></p><p>ä»ç›¸ç”µå‹è°ƒåˆ¶æ³¢å‡½æ•°æ¥çœ‹ï¼Œè¾“å‡ºçš„æ˜¯ä¸è§„åˆ™çš„åˆ†æ®µå‡½æ•°ï¼Œä¸ºé©¬éæ³¢å½¢ã€‚å½“è°ƒåˆ¶æ³¢ä¸ºæ­£å¼¦æ³¢æ—¶ä¸º spwmï¼Œè°ƒåˆ¶æ³¢ä¸ºåœ¨ç†æƒ³æ­£å¼¦æ³¢åŸºç¡€ä¸ŠåŠ å…¥ä¸‰æ¬¡è°æ³¢æ³¨å…¥å°±æ˜¯ svpwmã€‚æ¯”å•çº¯æ­£å¼¦è°ƒåˆ¶æ³¢è¾“å‡ºçš„ SPWMï¼ŒSVPWM çš„ä¼˜ç‚¹ï¼š</p><ul><li>è°æ³¢ä¼˜åŒ–ç¨‹åº¦é«˜ï¼Œè½¬çŸ©è„‰åŠ¨å°ã€‚</li><li>é€šè¿‡å…±æ¨¡åˆ†é‡æ³¨å…¥ï¼Œç­‰æ•ˆåŸºæ³¢å¢å¤§ï¼Œç”µå‹åˆ©ç”¨ç‡æé«˜ã€‚</li></ul><h1 id="å¼€ç¯æ§åˆ¶">å¼€ç¯æ§åˆ¶</h1><p>å¯¹äºä¸€ä¸ªå®Œæ•´å½“ FOC æ§åˆ¶å™¨æ˜¯éœ€è¦ç”µæµé‡‡æ ·çš„ï¼Œåªæœ‰åœ¨æœ‰ç”µæµé‡‡æ ·çš„æƒ…å†µä¸‹æ‰å¯ä»¥è¿›è¡Œ clark å˜æ¢ï¼Œè€Œåœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿›è¡Œç”µæµé—­ç¯æ§åˆ¶ï¼Œå¯ä»¥é‡‡ç”¨å¼€ç¯æ§åˆ¶ç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰ç”µæµåé¦ˆçš„æƒ…å†µä¸‹è¯¥å¦‚ä½•è¿›è¡Œå¼€ç¯æ§åˆ¶å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥å°† clark å˜æ¢å’Œ park å˜æ¢çœç•¥æ‰ï¼Œç›´æ¥å¯¹ dq è½´å˜é‡è¿›è¡Œè°ƒæ§ï¼Œç„¶åç›´æ¥è¿›è¡Œå park å˜æ¢å›å»ï¼Œå†ç»è¿‡ svpwm æ¨¡å—è¾“å‡ºæœ€ç»ˆçš„ä¿¡å·ç»™åˆ°ç”µæœºã€‚è¿™é‡Œçš„å¼€ç¯æ§åˆ¶è·Ÿæœ‰æ„Ÿè¿˜æ˜¯æ— æ„Ÿæ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œè¿™é‡Œè®©ç„¶å¯ä»¥é‡‡ç”¨æœ‰æ„Ÿçš„å¼€ç¯æ§åˆ¶ï¼Œåªæ˜¯è¿™é‡Œå°±æ²¡æœ‰åŠæ³•åšç”µæµé—­ç¯æ§åˆ¶ï¼Œåªèƒ½åšåŠ›çŸ©ï¼Œé€Ÿåº¦å’Œä½ç½®é—­ç¯æ§åˆ¶ã€‚</p><h1 id="æ€»ç»“">æ€»ç»“</h1><p>å›åˆ°ä¸€å¼€å§‹çš„ FOC æ§åˆ¶æ€»ä½“æ¡†å›¾ï¼Œæ•´ä¸ª FOC æµç¨‹æ˜¯é€šè¿‡ç”µæµé‡‡æ ·è·å¾—ä¸‰ç›¸ç”µæµå€¼ï¼Œå¯¹ä¸‰ç›¸ç”µæµå€¼è¿›è¡Œ clark å˜æ¢åˆ°<span class="math inline">\(\alpha \beta\)</span>åæ ‡ç³»ä¸‹ï¼ˆä¸¤ç›¸ç›´è§’åæ ‡ç³»ï¼‰ï¼Œå†ç»è¿‡ park å˜æ¢ï¼Œå˜æ¢åˆ°è½¬å­çš„ dq åæ ‡ç³»ä¸‹ï¼Œåˆ°è¿™é‡Œäº¤æµä¿¡å·å·²ç»è½¬å˜ä¸ºç›´æµä¿¡å·ï¼Œç„¶åå¯¹è¿™ä¸ªç›´æµä¿¡å·è¿›è¡Œè°ƒèŠ‚ï¼Œä¸€èˆ¬é‡‡ç”¨ pid æ§åˆ¶å™¨è¿›è¡Œè°ƒèŠ‚ï¼Œå¯ä»¥è¿›è¡ŒåŠ›çŸ©ï¼Œé€Ÿåº¦å’Œä½ç½®é—­ç¯è°ƒèŠ‚ï¼Œå°†è°ƒèŠ‚åå¯¹ dq åæ ‡è½´æ•°æ®å†ç»è¿‡å park å˜æ¢å†ç»è¿‡ svpwm è¿ç®—åè¾“å‡º pwm ä¿¡å·åˆ°ç”µæœºï¼Œè¿™å°±æ˜¯å®Œæ•´å¯¹ foc æ§åˆ¶ç®—æ³•ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2><p><span class="exturl" data-url="aHR0cHM6Ly93d3cucGVuZ2t5LmNuL3lvbmdjaURKLzA0LXd1c2h1YVlDRERKLVlMMTEvd3VzaHVhWUNESi1ZTDExLmh0bWw=">äºŒç›¸å¯¼é€šæ˜Ÿå½¢ä¸‰ç›¸å…­çŠ¶æ€æ— åˆ·ç›´æµæ°¸ç£ç”µåŠ¨æœºå·¥ä½œåŸç†<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yOTM0NzA5MTI=">Clark å˜æ¢ä¸ Park å˜æ¢<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80Nzc2NjQ1Mg==">å¦‚ä½•æ·±å…¥ç†è§£ SVPWMï¼Ÿ<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzIzNTY3NzA3">ä¸‰ç›¸å¯¹ç§°ç”µæµé€šè¿‡å‘ dq åæ ‡è½´ä¸ŠæŠ•å½±å¾—åˆ°çš„ Idã€Iq ä¸é€šè¿‡ park å˜æ¢å¾—åˆ°çš„ Idã€Iq æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ä¹ˆï¼Ÿ<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDc2NTk4MjA=">æ·±å…¥æµ…å‡ºè®²è§£ FOC ç®—æ³•ä¸ SVPWM æŠ€æœ¯<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hkdWNvbGxpbnMvYXJ0aWNsZS9kZXRhaWxzLzc5MjYwMTc2">æ°¸ç£åŒæ­¥ç”µæœº (PMSM) çš„ FOC é—­ç¯æ§åˆ¶è¯¦è§£<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMTczNDczNTE=">å…‹æ‹‰å…‹ (Clark) å˜æ¢ä¸­ç­‰å¹…å€¼ (2/3) å’Œç­‰åŠŸç‡ (sqrt(2/3)) å˜æ¢çš„å…¬å¼æ¨å¯¼<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL2ZpbGUuZWxlY2ZhbnMuY29tL3dlYjEvTTAwLzdGL0Q0L3BJWUJBRndtOXZpQURITE5BQVNNUWE1ZlZuZzQ2Ny5wZGY=">SVPWM æŠ€æœ¯<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Motor </tag>
            
            <tag> Robot </tag>
            
            <tag> Actuator </tag>
            
            <tag> FOC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openshoe ç®—æ³•</title>
      <link href="/2020/Algorithm/openshoe/"/>
      <url>/2020/Algorithm/openshoe/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>openshoe æ˜¯ä¸€ç§é€šè¿‡æƒ¯æ€§æµ‹é‡å…ƒä»¶ (IMU) æ¥å¯¹è¿åŠ¨è¿›è¡Œç§¯åˆ†ä»¥å¾—åˆ°è·¯å¾„çš„æ§åˆ¶ç®—æ³•ã€‚ç®—æ³•çš„æ ¸å¿ƒæ˜¯ ZUPTï¼ˆé›¶é€Ÿåº¦æ›´æ–°ç®—æ³•ï¼‰ï¼Œåœ¨åªæœ‰ IMU æƒ¯æ€§æµ‹é‡å…ƒä»¶çš„æƒ…å†µä¸‹è·å¾—è·¯å¾„åªèƒ½é€šè¿‡å¯¹åŠ é€Ÿåº¦ç§¯åˆ†å¾—åˆ°é€Ÿåº¦ï¼Œå†å°†é€Ÿåº¦å¯¹æ—¶é—´è¿›è¡Œç§¯åˆ†å¾—åˆ°è·¯å¾„ï¼Œè¿™é‡Œå¦‚æœä¸èƒ½å¯¹ç§¯åˆ†å¾—åˆ°çš„é€Ÿåº¦è¿›è¡Œæœ‰æ•ˆçš„æ ¡æ­£é‚£ä¹ˆè¿™ä¸ªé€Ÿåº¦è¯¯å·®ä¼šæ—¶åˆ»å¯¹æ—¶é—´è¿›è¡Œç§¯åˆ†ï¼Œå¯¼è‡´è·¯å¾„å®Œå…¨å¤±æ•ˆï¼Œå› æ­¤å¿…é¡»é‡‡å–æœ‰æ•ˆæ‰‹æ®µåŠæ—¶å¯¹é€Ÿåº¦è¯¯å·®è¿›è¡Œæ ¡æ­£ä»¥å¾—åˆ°è¾ƒä¸ºå‡†ç¡®çš„è·¯å¾„ä¿¡æ¯ï¼ŒZUPT å°±æ˜¯ä¸€ç§åŸºäºæ£€æµ‹é›¶é€Ÿåº¦è¿›è¡Œè·¯å¾„ç§¯åˆ†æ ¡æ­£çš„ç®—æ³•ã€‚è¯¥ç®—æ³•çš„å…³é”®æ˜¯å¯¹é›¶é€Ÿåº¦çš„å‡†ç¡®æ£€æµ‹ã€‚</p><h1 id="é›¶é€Ÿåº¦æ£€æµ‹ç®—æ³•">é›¶é€Ÿåº¦æ£€æµ‹ç®—æ³•</h1><p>openshoe é‡‡ç”¨å¹¿ä¹‰ä¼¼ç„¶æ£€æµ‹ç®—æ³•å¯¹é›¶é€Ÿåº¦è¿›è¡Œæ£€æµ‹ï¼Œä»¥åˆ¤æ–­ IMU æ˜¯å¦å¤„äºé™æ­¢çŠ¶æ€ã€‚</p><h2 id="å¹¿ä¹‰ä¼¼ç„¶æ£€æµ‹åŸç†">å¹¿ä¹‰ä¼¼ç„¶æ£€æµ‹åŸç†</h2><p>è¦ç†è§£å¹¿ä¹‰ä¼¼ç„¶æ£€æµ‹åŸç†éœ€è¦å…ˆç†Ÿæ‚‰å‡ ä¸ªæ¦‚ç‡è®ºä¸­ç›¸å…³çš„æ¦‚å¿µï¼Œè¯¦ç»†å¦‚ä¸‹ï¼š</p><span id="more"></span><h3 id="æ¡ä»¶æ¦‚ç‡å…¬å¼">æ¡ä»¶æ¦‚ç‡å…¬å¼</h3><p>è®¾ A ä¸ B ä¸ºæ ·æœ¬ç©ºé—´ Î© ä¸­çš„ä¸¤ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­ P(B)&gt;0ã€‚é‚£ä¹ˆåœ¨äº‹ä»¶ B å‘ç”Ÿçš„æ¡ä»¶ä¸‹ï¼Œäº‹ä»¶ A å‘ç”Ÿçš„æ¡ä»¶æ¦‚ç‡ä¸ºï¼š</p><p><span class="math display">\[P(A|B) = \frac{P(AB)}{P(B)}\]</span></p><h3 id="è´å¶æ–¯å…¬å¼">è´å¶æ–¯å…¬å¼</h3><p><span class="math display">\[P(A|B) = \frac{P(B|A) P(A)}{P(B)}\]</span></p><p>å…¶ä¸­ A ä»¥åŠ B ä¸ºéšæœºäº‹ä»¶ï¼Œä¸” P(B) ä¸ä¸ºé›¶ã€‚P(A|B) æ˜¯æŒ‡åœ¨äº‹ä»¶ B å‘ç”Ÿçš„æƒ…å†µä¸‹äº‹ä»¶ A å‘ç”Ÿçš„æ¦‚ç‡ã€‚</p><h3 id="å…¨æ¦‚ç‡å…¬å¼">å…¨æ¦‚ç‡å…¬å¼</h3><p>è‹¥äº‹ä»¶ A1ï¼ŒA2ï¼Œâ€¦æ„æˆä¸€ä¸ªå®Œå¤‡äº‹ä»¶ç»„ä¸”éƒ½æœ‰æ­£æ¦‚ç‡ï¼Œåˆ™å¯¹ä»»æ„ä¸€ä¸ªäº‹ä»¶ Bï¼Œæœ‰å¦‚ä¸‹å…¬å¼æˆç«‹ï¼š</p><p><span class="math display">\[\begin{aligned}P(B)&amp;=P(BA1)+P(BA2)+...+P(BAn) \\&amp;=P(B|A1)P(A1) + P(B|A2)P(A2) + ... + P(B|An)P(An) \\&amp;=\sum_{i=1}^{n}P(A_i)P(B|A_i))\end{aligned}\]</span></p><h3 id="ä¼¼ç„¶å‡½æ•°">ä¼¼ç„¶å‡½æ•°</h3><p>ä¼¼ç„¶å‡½æ•°æ˜¯ä¸€ç§å…³äºç»Ÿè®¡æ¨¡å‹å‚æ•°çš„å‡½æ•°ã€‚ç»™å®šè¾“å‡º x æ—¶ï¼Œå…³äºå‚æ•°Î¸çš„ä¼¼ç„¶å‡½æ•°<span class="math inline">\(L(\theta|x)\)</span>ï¼ˆåœ¨æ•°å€¼ä¸Šï¼‰ç­‰äºç»™å®šå‚æ•°Î¸åå˜é‡ X çš„æ¦‚ç‡ï¼š</p><p><span class="math display">\[L(\theta |x) = P(X = x|\theta )\]</span></p><h3 id="æœ€å¤§ä¼¼ç„¶ä¼°è®¡">æœ€å¤§ä¼¼ç„¶ä¼°è®¡</h3><p>ç»™å®šä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒ<span class="math inline">\(D\)</span>ï¼Œå·²çŸ¥å…¶æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆè¿ç»­åˆ†å¸ƒï¼‰æˆ–æ¦‚ç‡è´¨é‡å‡½æ•°ï¼ˆç¦»æ•£åˆ†å¸ƒï¼‰ä¸º<span class="math inline">\(f_D\)</span>ï¼Œä»¥åŠä¸€ä¸ªåˆ†å¸ƒå‚æ•°<span class="math inline">\(\theta\)</span> ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªåˆ†å¸ƒä¸­æŠ½å‡ºä¸€ä¸ªå…·æœ‰<span class="math inline">\(n\)</span>ä¸ªå€¼çš„é‡‡æ ·<span class="math inline">\(X_1, X_2,\ldots, X_n\)</span>ï¼Œåˆ©ç”¨<span class="math inline">\(f_D\)</span>è®¡ç®—å‡ºå…¶ä¼¼ç„¶å‡½æ•°ï¼š</p><p><span class="math display">\[{\displaystyle (\theta \mid x_{1},\dots ,x_{n})=f_{\theta }(x_{1},\dots ,x_{n}).}\]</span></p><p>è‹¥ D æ˜¯ç¦»æ•£åˆ†å¸ƒï¼Œ<span class="math inline">\({\displaystyle f_{\theta }}\)</span>å³æ˜¯åœ¨å‚æ•°ä¸º<span class="math inline">\(\theta\)</span> æ—¶è§‚æµ‹åˆ°è¿™ä¸€é‡‡æ ·çš„æ¦‚ç‡ã€‚è‹¥å…¶æ˜¯è¿ç»­åˆ†å¸ƒï¼Œ<span class="math inline">\({\displaystyle f_{\theta }}\)</span>åˆ™ä¸º<span class="math inline">\(X_1, X_2,\ldots, X_n\)</span>è”åˆåˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°åœ¨è§‚æµ‹å€¼å¤„çš„å–å€¼ã€‚ä¸€æ—¦æˆ‘ä»¬è·å¾—<span class="math inline">\(X_1, X_2,\ldots, X_n\)</span>ï¼Œæˆ‘ä»¬å°±èƒ½æ±‚å¾—ä¸€ä¸ªå…³äº<span class="math inline">\(\theta\)</span> çš„ä¼°è®¡ã€‚æœ€å¤§ä¼¼ç„¶ä¼°è®¡ä¼šå¯»æ‰¾å…³äº<span class="math inline">\(\theta\)</span> çš„æœ€å¯èƒ½çš„å€¼ï¼ˆå³ï¼Œåœ¨æ‰€æœ‰å¯èƒ½çš„<span class="math inline">\(\theta\)</span> å–å€¼ä¸­ï¼Œå¯»æ‰¾ä¸€ä¸ªå€¼ä½¿è¿™ä¸ªé‡‡æ ·çš„â€œå¯èƒ½æ€§â€æœ€å¤§åŒ–ï¼‰ã€‚ä»æ•°å­¦ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<span class="math inline">\(\theta\)</span> çš„æ‰€æœ‰å¯èƒ½å–å€¼ä¸­å¯»æ‰¾ä¸€ä¸ªå€¼ä½¿å¾—ä¼¼ç„¶å‡½æ•°å–åˆ°æœ€å¤§å€¼ã€‚è¿™ä¸ªä½¿å¯èƒ½æ€§æœ€å¤§çš„<span class="math inline">\(\widehat{\theta}\)</span>å€¼å³ç§°ä¸º<span class="math inline">\(\theta\)</span> çš„æœ€å¤§ä¼¼ç„¶ä¼°è®¡ã€‚ç”±å®šä¹‰ï¼Œæœ€å¤§ä¼¼ç„¶ä¼°è®¡æ˜¯æ ·æœ¬çš„å‡½æ•°ã€‚</p><h3 id="ä¼¼ç„¶æ¯”æ£€æµ‹">ä¼¼ç„¶æ¯”æ£€æµ‹</h3><p>ä¼¼ç„¶æ¯”æ£€éªŒæ˜¯åˆ©ç”¨ä¼¼ç„¶å‡½æ•°æ¥æ£€æµ‹æŸä¸ªå‡è®¾æ˜¯å¦æœ‰æ•ˆçš„ä¸€ç§æ£€éªŒã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¦æ£€æµ‹æŸä¸ªé™„åŠ çš„å‚æ•°é™åˆ¶æ˜¯å¦æ˜¯æ­£ç¡®çš„ï¼Œå¯ä»¥å°†åŠ å…¥é™„åŠ é™åˆ¶æ¡ä»¶çš„è¾ƒå¤æ‚æ¨¡å‹çš„ä¼¼ç„¶å‡½æ•°æœ€å¤§å€¼ä¸ä¹‹å‰çš„è¾ƒç®€å•æ¨¡å‹çš„ä¼¼ç„¶å‡½æ•°æœ€å¤§å€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå‚æ•°é™åˆ¶æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆåŠ å…¥è¿™æ ·ä¸€ä¸ªå‚æ•°åº”å½“ä¸ä¼šé€ æˆä¼¼ç„¶å‡½æ•°æœ€å¤§å€¼çš„å¤§å¹…å˜åŠ¨ã€‚ä¸€èˆ¬ä½¿ç”¨ä¸¤è€…çš„æ¯”ä¾‹æ¥è¿›è¡Œæ¯”è¾ƒï¼Œè¿™ä¸ªæ¯”å€¼æ˜¯å¡æ–¹åˆ†é…ã€‚ è®¾<span class="math inline">\(L(x_{1:n}; Î¸)\)</span>ä¸ºä¼¼ç„¶å‡½æ•°ï¼Œ<span class="math inline">\(\theta_1 \theta_2 \in \Theta\)</span>, ä¸¤ä¸ªå‚æ•° <span class="math inline">\(Î¸_1,Î¸_2\)</span>ä¸‹ä¼¼ç„¶å‡½æ•°çš„æ¯”å€¼ç§°ä¸ºä¼¼ç„¶æ¯”ã€‚</p><p><span class="math display">\[LR = \frac{L(x_{1:n};\theta _1)}{L(x_{1:n};\theta _2)}\]</span></p><h2 id="ç®—æ³•å®ç°">ç®—æ³•å®ç°</h2><figure class="highlight matlab"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k=<span class="number">1</span>:N-W+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    ya_m=<span class="built_in">mean</span>(u(<span class="number">1</span>:<span class="number">3</span>,k:k+W<span class="number">-1</span>),<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> l=k:k+W<span class="number">-1</span></span><br><span class="line">        tmp=u(<span class="number">1</span>:<span class="number">3</span>,l)-g*ya_m/norm(ya_m);</span><br><span class="line">        T(k)=T(k)+u(<span class="number">4</span>:<span class="number">6</span>,l)'*u(<span class="number">4</span>:<span class="number">6</span>,l)/sigma2_g + tmp'*tmp/sigma2_a;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">T=T./W;</span><br></pre></td></tr></tbody></table></figure><p>æ—¢ç„¶è¿™é‡Œæ˜¯é‡‡ç”¨ä¼¼ç„¶æ¯”æ£€éªŒæ–¹æ³•ï¼Œè‡ªç„¶è¦æ¶‰åŠåˆ°ä¼¼ç„¶å‡½æ•°çš„å»ºç«‹ä¸çº¦æŸæ¡ä»¶çš„é€‰å–ï¼Œå¹¿ä¹‰ä¼¼ç„¶æ¯”æ˜¯å¯¹ä¼¼ç„¶æ¯”çš„æ‰©å±•åº”ç”¨ï¼Œä¸ä¾èµ–äºç»Ÿè®¡é‡çš„ç‰¹æ€§ï¼Œä¼¼ç„¶å‡½æ•°å’Œçº¦æŸéœ€è¦è¿›è¡Œè‡ªå·±å»ºæ¨¡ã€‚å¯¹äºé™€èºä»ªæ•°æ®çš„ä¼¼ç„¶å‡½æ•°å°±æ˜¯ä¸‰è½´é™€èºä»ªæ•°æ®çš„æ¨¡çš„å¹³æ–¹ï¼Œé™€èºä»ªæ²¡æœ‰é‡åŠ›åŠ é€Ÿåº¦åˆ†é‡çš„å½±å“å»ºæ¨¡æ¯”è¾ƒç®€å•ï¼Œå¯¹äºåŠ é€Ÿåº¦åˆ™æ˜¯å…ˆå°†åŸå§‹æ•°æ®è¿›è¡Œæ»‘åŠ¨å‡å€¼æ»¤æ³¢ï¼Œç„¶åå»æ¯ä¸ªæ•°æ®ä¸æ»‘åŠ¨å‡å€¼æ»¤æ³¢çš„æ®‹å·®çš„æ¨¡çš„å¹³æ–¹ä½œä¸ºä¼¼ç„¶å‡½æ•°ã€‚è€Œè¿™é‡Œçš„çº¦æŸå°±æ˜¯ IMU çš„çŠ¶æ€äº†ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­ IMU æ˜¯å¦æ˜¯é™æ­¢ï¼Œåˆ™çº¦æŸæ¡ä»¶å°±æ˜¯é™æ­¢ï¼Œï¼ˆIMU çš„å…¨çŠ¶æ€å¯èƒ½åŒ…æ‹¬ IMU çš„å„è½´å¹³ç§»åŠ æ—‹è½¬çš„ç»„åˆï¼‰å› æ­¤é‡‡æ ·å¹¿ä¹‰ä¼¼ç„¶æ¯”ç®—æ³•æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ±‚è§£çº¦æŸæ¡ä»¶æ˜¯å¦æˆç«‹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å·²çŸ¥çš„æ˜¯ IMU çš„ç»“æœï¼ˆçŠ¶æ€ï¼‰åæ±‚çº¦æŸæ¡ä»¶æ˜¯å¦æ˜¯é™æ­¢ã€‚ä»¥ä¸Šå°±æ˜¯è¿ç”¨å¹¿ä¹‰ä¼¼ç„¶æ¯”çš„å»ºæ¨¡è§£æå¯¹åº”çš„å®ç°å°±æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œæ±‚è§£æœªçŸ¥çº¦æŸçš„ä¼¼ç„¶å€¼ä¸å·²çŸ¥çº¦æŸï¼ˆIMU é™æ­¢ï¼‰ä¼¼ç„¶å€¼çš„æ¯”å€¼å³ä¼¼ç„¶æ¯”ï¼Œå¦‚æœæœªçŸ¥çº¦æŸçš„æ¡ä»¶ä¸å·²çŸ¥çº¦æŸï¼ˆIMU é™æ­¢ï¼‰çº¦æŸç›¸åŒåˆ™ä¼¼ç„¶æ¯”å°±å¾ˆå°æ¥è¿‘äº 1ï¼Œå¦åˆ™ä¼šå¾ˆå¤§ã€‚é€šè¿‡ä»¥ä¸Šæ–¹æ³•å¯ä»¥æ¯”è¾ƒå¥½çš„åˆ¤æ–­ IMU æ˜¯å¦å¤„äºé™æ­¢çŠ¶æ€ï¼Œå½“ç„¶ç»“æœçš„å¥½åå–å†³äº sigma2_g å’Œ sigma2_a è¿™ä¸¤ä¸ªçº¦æŸæ¡ä»¶ä¸º IMU é™æ­¢çš„ä¼¼ç„¶å€¼çš„é€‰å–ï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸èƒ½å¾ˆå¥½ä»£è¡¨é™æ­¢çŠ¶æ€ä¸‹ IMU çš„ç‰¹å¾åˆ™åˆ¤æ–­ä¼šå‡ºç°å¾ˆå¤§è¯¯å·®ã€‚</p><h1 id="kalman-æ»¤æ³¢æ±‚è§£-odometry">kalman æ»¤æ³¢æ±‚è§£ odometry</h1><h2 id="é¢„æµ‹é˜¶æ®µ">é¢„æµ‹é˜¶æ®µ</h2><h3 id="æ›´æ–°é‡Œç¨‹ä¿¡æ¯">æ›´æ–°é‡Œç¨‹ä¿¡æ¯</h3><p>é¦–å…ˆæ˜¯ IMU å§¿æ€æ›´æ–°ï¼Œopenshoe é‡‡ç”¨æ›´æ–°å››å…ƒæ•°çš„ç®—æ³•è¿›è¡Œå§¿æ€è§£ç®—ï¼Œ</p><p><span class="math display">\[q_k = \Omega (w_k dt) q_{k-1}\]</span></p><p><span class="math inline">\(\Omega\)</span>æ˜¯å››å…ƒæ•°æ›´æ–°çŸ©é˜µï¼Œ<span class="math inline">\(w_k\)</span>æ˜¯è§’é€Ÿåº¦ï¼Œdt æ˜¯é‡‡æ ·é—´éš”ã€‚ç®—æ³•å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">% u(4:6) ä¸ºé™€èºä»ªæ•°æ®</span><br><span class="line">w_tb=u(4:6);</span><br><span class="line"></span><br><span class="line">P=w_tb(1)*Ts;</span><br><span class="line">Q=w_tb(2)*Ts;</span><br><span class="line">R=w_tb(3)*Ts;</span><br><span class="line"></span><br><span class="line">OMEGA=zeros(4);</span><br><span class="line">OMEGA(1,1:4)=0.5*[0 R -Q P];</span><br><span class="line">OMEGA(2,1:4)=0.5*[-R 0 P Q];</span><br><span class="line">OMEGA(3,1:4)=0.5*[Q -P 0 R];</span><br><span class="line">OMEGA(4,1:4)=0.5*[-P -Q -R 0];</span><br><span class="line"></span><br><span class="line">v=norm(w_tb)*Ts;</span><br><span class="line"></span><br><span class="line">% å››å…ƒæ•°æ›´æ–°æ–¹ç¨‹</span><br><span class="line"><span class="keyword">if</span> v~=0</span><br><span class="line">    q=(cos(v/2)*eye(4)+2/v*sin(v/2)*OMEGA )*q;</span><br><span class="line">    q=q./norm(q);  %å››å…ƒæ•°å½’ä¸€åŒ–</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæ›´æ–°ä½ç½®å’Œé€Ÿåº¦ï¼š</p><p><span class="math display">\[p_k = p_{k-1} + v_{k-1} dt \\v_k = v_{k-1} + (q_{k-1}f_kq_{k-1}^{*} -g)dt\]</span></p><p><span class="math inline">\(p_k\)</span>ä»£è¡¨ k æ—¶åˆ»ä½ç½®ï¼Œ<span class="math inline">\(v_k\)</span>ä»£è¡¨ k æ—¶åˆ»é€Ÿåº¦<span class="math inline">\(f_k\)</span>ä¸ºç‰µå¼•åŠ›ï¼Œç®—æ³•å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">% Gravity vector</span><br><span class="line">g_t=[0 0 simdata.g]<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">% f_t æ˜¯æ—‹è½¬çŸ©é˜µ x acc å‘é‡ï¼Œå¾—åˆ°ç¬æ—¶åŠ é€Ÿåº¦é‡åœ¨ navigation coordinat åæ ‡ç³»ä¸‹çš„è¡¨ç¤º</span></span><br><span class="line"><span class="string">f_t=q2dcm(q)*u(1:3);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">% Subtract (add) the gravity, to obtain accelerations in navigation</span></span><br><span class="line"><span class="string">% coordinat system.</span></span><br><span class="line"><span class="string">acc_t=f_t+g_t;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">% State space model matrices</span></span><br><span class="line"><span class="string">A=eye(6);</span></span><br><span class="line"><span class="string">A(1,4)=Ts;</span></span><br><span class="line"><span class="string">A(2,5)=Ts;</span></span><br><span class="line"><span class="string">A(3,6)=Ts;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">B=[(Ts^2)/2*eye(3);Ts*eye(3)];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">% Update the position and velocity estimates.</span></span><br><span class="line"><span class="string">y(1:6)=A*x(1:6)+B*acc_t;</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥è¿‡ç¨‹ä¼šä¸æ–­æ›´æ–° IMU åœ¨ä¸–ç•Œåæ ‡ç³»ä¸‹çš„ä½ç½®ï¼Œé€Ÿåº¦å’Œå§¿æ€ä¿¡æ¯ã€‚æ¯ä¸€è½®æ•°æ®æ›´æ–°ä¸€æ¬¡ï¼Œå®ç°é‡Œç¨‹ä¿¡æ¯çš„æ›´æ–°ã€‚è¿™é‡Œè¯´æ˜ä¸€ä¸‹<span class="math inline">\(q_{k-1}f_kq_{k-1}^{*}\)</span>è¿™ä¸ªå…¬å¼ï¼Œè¿™æ˜¯å››å…ƒæ•°æ—‹è½¬å…¬å¼çš„è¡¨è¾¾ï¼Œè¡¨ç¤º<span class="math inline">\(f_k\)</span>æŒ‰ç…§<span class="math inline">\(q_k-1\)</span>è¿™ä¸ªå››å…ƒæ•°è¿›è¡Œæ—‹è½¬ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ç”¨ acc åŸå§‹æ•°æ®æŒ‰ç…§å½“å‰ IMU å§¿æ€è¿›è¡Œæ—‹è½¬å¾—åˆ°ä¸–ç•Œåæ ‡ç³»ä¸‹çš„å§¿æ€ï¼Œè€Œé€Ÿåº¦æ›´æ–°æ–¹ç¨‹å°±æ˜¯<span class="math inline">\(v = v_0 + at\)</span>è¿™ä¸ªæ–¹ç¨‹ã€‚</p><h3 id="æ›´æ–°çŠ¶æ€è½¬ç§»çŸ©é˜µ">æ›´æ–°çŠ¶æ€è½¬ç§»çŸ©é˜µ</h3><p>çŠ¶æ€è½¬ç§»çŸ©é˜µå…¶å®å°±æ˜¯å°†ä¸Šé¢çš„æ›´æ–°çŠ¶æ€æ–¹ç¨‹å†™æˆçŸ©é˜µçš„å½¢å¼ï¼Œå°†å…¶ä¸­çš„çŸ©é˜µç³»æ•°æå–å‡ºæ¥ï¼Œå¹¶åœ¨æ¯ä¸€æ¬¡å¾ªç¯ä¸­æ›´æ–°ã€‚ä¸‹é¢å…ˆå†™å‡ºä¸Šé¢çŠ¶æ€æ›´æ–°çš„çŸ©é˜µå½¢å¼ï¼š</p><p><span class="math display">\[\begin{bmatrix}p_k\\ v_k\\ q_k\end{bmatrix} = \begin{bmatrix}p_{k-1} + v_{k-1}dt\\ v_{k-1} + (q_{k-1}f_kq_{k-1}^{*}-g)dt\\ \Omega (w_kdt)q_{k-1}\end{bmatrix} = \begin{bmatrix}I &amp; Idt &amp; O\\ O &amp; I &amp; (q_{k-1}f_kq_{k-1}^{*}-g)q_{k-1}^{*}dt \\ O &amp; O &amp; \Omega (w_kdt)\end{bmatrix}\begin{bmatrix}p_{k-1}\\ v_{k-1}\\ p_{k-1}   \tag{1}\end{bmatrix}\]</span></p><p>è¿™é‡Œï¼š</p><p><span class="math display">\[F = \begin{bmatrix}I &amp; Idt &amp; O\\ O &amp; I &amp; (q_{k-1}f_kq_{k-1}^{*}-g)q_{k-1}^{*}dt \\ O &amp; O &amp; \Omega (w_kdt)\end{bmatrix}\]</span></p><p>å°±æ˜¯çŠ¶æ€è½¬ç§»çŸ©é˜µï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å…·ä½“çš„å®ç°ã€‚</p><figure class="highlight matlab"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Convert quaternion to a rotation matrix</span></span><br><span class="line">Rb2t=q2dcm(q);</span><br><span class="line"></span><br><span class="line"><span class="comment">% Transform measured force to force in</span></span><br><span class="line"><span class="comment">% the navigation coordinate system.</span></span><br><span class="line">f_t=Rb2t*u(<span class="number">1</span>:<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">% Create a ske symmetric matrix of the specific fore vector</span></span><br><span class="line">St=[<span class="number">0</span> -f_t(<span class="number">3</span>) f_t(<span class="number">2</span>); f_t(<span class="number">3</span>) <span class="number">0</span> -f_t(<span class="number">1</span>); -f_t(<span class="number">2</span>) f_t(<span class="number">1</span>) <span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">% Zero matrix</span></span><br><span class="line">O=<span class="built_in">zeros</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">% Identity matrix</span></span><br><span class="line">I=<span class="built_in">eye</span>(<span class="number">3</span>);</span><br><span class="line">...</span><br><span class="line">Fc=[O I O;</span><br><span class="line">    O O St;</span><br><span class="line">    O O O];</span><br><span class="line">    </span><br><span class="line"><span class="comment">% Noise gain matrix</span></span><br><span class="line">Gc=[O O; Rb2t O; O -Rb2t];</span><br><span class="line"></span><br><span class="line"><span class="comment">% Approximation of the discret time state transition matrices</span></span><br><span class="line">F=<span class="built_in">eye</span>(<span class="built_in">size</span>(Fc))+simdata.Ts*Fc;</span><br><span class="line">G=simdata.Ts*Gc;</span><br></pre></td></tr></tbody></table></figure><p>ä¸ºäº†æ›´æ¸…æ¥šçš„çœ‹åˆ°ç»“æœï¼Œè¿™é‡ŒæŠŠè¿™ä¸ªè½¬ç§»çŸ©é˜µå†™ä¸ºå…¬å¼å½¢å¼ï¼š</p><p><span class="math display">\[F = \begin{bmatrix}I &amp; O &amp; O\\ O &amp; I &amp; St * dt\\ O &amp; O &amp; I\end{bmatrix}\]</span></p><p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œå®ç°ä¸Šæœ‰ä¸€ç‚¹å·®å¼‚å°±æ˜¯è¿™ä¸ªçŠ¶æ€è½¬ç§»çŸ©é˜µå…¶å®æ˜¯ä¸åŒ…æ‹¬å››å…ƒæ•° q çš„æ›´æ–°é¡¹çš„ï¼Œè¿™é‡Œè¿™æ ·åšå…¶å®æ˜¯å¾ˆåˆç†çš„ï¼Œåœ¨æˆ‘ä»¬å½“å‰è¿™ä¸ªç³»ç»Ÿä¸­å››å…ƒæ•°çš„æ›´æ–°æ˜¯ä¸éœ€è¦è¿›è¡Œå¡å°”æ›¼æ»¤æ³¢çš„ï¼Œå…¶å®åœ¨å®ç°ä¸Šæˆ‘ä»¬ä¹Ÿçœ‹åˆ°è¿™é‡Œå¹¶ä¸æ˜¯é€šè¿‡æ•´ä¸ªçŠ¶æ€è½¬ç§»çŸ©é˜µç›´æ¥æ›´æ–°æ‰€æœ‰çŠ¶æ€çš„è€Œæ˜¯åˆ†æ‹†å°†æ¯ä¸ªçŠ¶æ€è¿›è¡Œæ›´æ–°ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å¯¹ä½ç½®å’Œé€Ÿåº¦è¿™ä¸¤ä¸ªé‡è¿›è¡Œæ»¤æ³¢ï¼Œå®é™…ä¸Šä¹Ÿä¹Ÿæ˜¯åªå¯¹è¿™ä¸¤ä¸ªçŠ¶æ€é‡è¿›è¡Œæ»¤æ³¢ï¼Œå› æ­¤è¿™é‡ŒçŠ¶æ€è½¬ç§»çŸ©é˜µåœ¨è·Ÿæ–°å‰å…ˆæ›´æ–°äº†å››å…ƒæ•° q ç„¶åå››å…ƒæ•°çš„æ›´æ–°<span class="math inline">\(q=q_{k-1}\)</span>å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„å½¢å¼ã€‚ åœ¨æ ‡å‡†å¡å°”æ›¼æ»¤æ³¢ä¸­è¿˜æœ‰ä¸€ä¸ªæ˜¯æµ‹é‡è½¬ç§»çŸ©é˜µï¼Œç”±äºæˆ‘ä»¬çš„ç³»ç»Ÿæ¨¡å‹ä¸­ç³»ç»ŸçŠ¶æ€é‡æ˜¯ä½ç½® p å’Œé€Ÿåº¦ v è¿™ä¸¤ä¸ªé‡éƒ½æ˜¯ä¸å¯æµ‹é‡çš„ï¼Œåªæœ‰é€Ÿåº¦ v æ˜¯é—´æ¥é€šè¿‡ ZUPT è¿›è¡Œä¼°è®¡çš„å› æ­¤æµ‹é‡è½¬ç§»çŸ©é˜µä¸ºï¼š</p><p><span class="math display">\[H = \begin{bmatrix}O &amp; I &amp; O\end{bmatrix}\]</span></p><p>è¿™é‡Œå…¶å®å¹¶ä¸éœ€è¦è¿›è¡Œä»€ä¹ˆè¿ç®—åœ¨å› æ­¤åœ¨å®ç°ä¸Šå°±çœç•¥äº†ã€‚ æ¥ç€æ˜¯å‰éªŒçŠ¶æ€åæ–¹å·®çŸ©é˜µçš„æ›´æ–°ï¼š</p><p><span class="math display">\[\hat{P}=F*\hat{P}*F'+G*Q*G'\tag{2}\]</span></p><p>å…¶ä¸­ G ä¸ºè¿‡ç¨‹å™ªå£°è½¬ç§»çŸ©é˜µï¼ŒQ ä¸ºè¿‡ç¨‹å™ªå£°ï¼ŒåŸå§‹å™ªå£°å°±æ˜¯åŠ é€Ÿåº¦è·Ÿé™€èºä»ªçš„å™ªå£°ï¼ŒQ åˆå€¼çš„é€‰å–æ˜¯æŒ‰ç…§åŠ é€Ÿåº¦å’Œé™€èºä»ªçš„å™ªå£°å¤§å°æ¥é€‰å–çš„ï¼Œç³»ç»Ÿä¸­é€‰å– 0.1 ä¸ªåŠ é€Ÿåº¦å’Œ 0.1 åº¦æ¯ç§’ä½œä¸ºåˆå§‹ç³»ç»Ÿè¯¯å·®å€¼ã€‚</p><h2 id="è§‚æµ‹é˜¶æ®µ">è§‚æµ‹é˜¶æ®µ</h2><p>å…ˆè¯´æ˜ä¸‹æ•´ä¸ªå¡å°”æ›¼æ»¤æ³¢çš„å»ºæ¨¡å½¢å¼ï¼Œç³»ç»Ÿçš„çŠ¶æ€å…±ä¸‰ä¸ªï¼Œä½ç½®ï¼Œé€Ÿåº¦å’Œå››å…ƒæ•°ï¼ˆå››å…ƒæ•°å¯ä»¥è½¬åŒ–ä¸ºæ¬§æ‹‰è§’ï¼‰å¡å°”æ›¼æ»¤æ³¢ä¸­æ›´æ–°ä¸¤ä¸ªç³»ç»Ÿé‡ä½ç½®å’Œé€Ÿåº¦ï¼ˆå¯¹é€Ÿåº¦è¿›è¡Œæ»¤æ³¢é—´æ¥æ›´æ–°åˆ°ä½ç½®ï¼‰ä¸Šæ–‡åˆ—å‡ºäº†çŠ¶æ€æ›´æ–°ç›¸å…³è¿‡ç¨‹ï¼Œåªæœ‰ä¸Šé¢çš„è¿‡ç¨‹ç³»ç»Ÿé€Ÿåº¦è¯¯å·®æ— æ³•è¢«æ¶ˆé™¤ï¼Œè€Œé€Ÿåº¦è¯¯å·®ä¼šæ— æ—¶æ— åˆ»çš„ç´¯åŠ åˆ°ä½ç½®ä¿¡æ¯ä¸Šï¼Œå¯¼è‡´ä½ç½®ä¿¡æ¯è¯¯å·®æ— é™æ‰©å¤§æœ€ç»ˆé‡Œç¨‹ä¿¡æ¯ä¸å¯ç”¨ã€‚è€Œè§‚æµ‹è¿‡ç¨‹å°±æ˜¯ä¸ºäº†æ¶ˆé™¤é€Ÿåº¦è¯¯å·®çš„ï¼Œè§‚æµ‹è¿‡ç¨‹åªå­˜åœ¨äºæ£€æµ‹åˆ°é€Ÿåº¦ä¸º 0ï¼ˆZUPT è¿”å› trueï¼‰æ—¶è¿›è¡Œè§‚æµ‹è¿‡ç¨‹çš„æ›´æ–°ã€‚ å¡å°”æ›¼ç³»æ•°çš„æ›´æ–°ï¼š</p><p><span class="math display">\[K = \frac{HP*H'}{H*P*H'+R}\tag{3}\]</span></p><p>H ä¸ºå•ä½çŸ©é˜µ R ä¸ºæµ‹é‡è¯¯å·®çŸ©é˜µéƒ½æ˜¯å›ºå®šçŸ©é˜µï¼Œåˆ†å­å’Œåˆ†æ¯åˆ†åˆ«ä»£è¡¨äº†å¯¹é¢„æµ‹å’Œè§‚æµ‹çš„ä¿¡ä»»åº¦ã€‚ ç°åœ¨æœ‰äº†å¡å°”æ›¼ç³»æ•° K å°±å¯ä»¥æŒ‰ç…§å¯¹é¢„æµ‹å’Œè§‚æµ‹çš„ä¿¡ä»»åº¦æ¥ä¿®æ­£è¯¯å·®äº†ï¼Œå¯¹äºé€Ÿåº¦è¯¯å·®çš„ä¿®æ­£æ¯”è¾ƒå¥½ç†è§£ï¼Œå½“å‰é€šè¿‡é™€èºä»ªç§¯åˆ†å¾—åˆ°çš„é€Ÿåº¦æ˜¯ä¸ä¸º 0 çš„ï¼Œè€Œæˆ‘ä»¬é€šè¿‡ ZUPT æ£€æµ‹å‡ºæ¥çš„é€Ÿåº¦å´ä¸º 0ï¼Œæˆ‘ä»¬æ ¹æ®å¡å°”æ›¼ç³»æ•°æ¥è¡¡é‡ä¸¤ä¸ªæ•°æ®çš„å¯ä¿¡ä»»ç¨‹åº¦ï¼Œç„¶åå°† K ä½œç”¨åˆ°ç°åœ¨çš„ç§¯åˆ†é€Ÿåº¦ä¸Šï¼š</p><p><span class="math display">\[v_{err} = -K * v \\v = v+v_{err}     \tag{4}\]</span></p><p>ç”¨è¿™ä¸ªæ¥ä¿®æ­£é€Ÿåº¦è¯¯å·®ã€‚å¹¶æ›´æ–°æµ‹é‡è¯¯å·®çŸ©é˜µ Rï¼Œæœ€åæ˜¯æ›´æ–°åéªŒåæ–¹å·®çŸ©é˜µ P:</p><p><span class="math display">\[P_k = (I-K*H)*\hat{P}_k \tag{5}\]</span></p><p>å…¶å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">K=(P*H<span class="string">')/(H*P*H'</span>+R);</span><br><span class="line">z=-x_h(4:6,k);</span><br><span class="line">        </span><br><span class="line">% Estimation of the perturbations <span class="keyword">in</span> the estimated navigation</span><br><span class="line">% states</span><br><span class="line">dx=K*z;</span><br><span class="line">% Correct the navigation state using the estimated perturbations. </span><br><span class="line">% (Subfunction located further down <span class="keyword">in</span> the file.)</span><br><span class="line">% ä½¿ç”¨è¯¯å·®ä¼°è®¡è¿›è¡Œæ ¡æ­£å§¿æ€ï¼Œx_h(:,k) æ ¡æ­£åçš„å§¿æ€ï¼Œquat æ ¡æ­£åå››å…ƒæ•°ï¼Œdx æ˜¯è¯¯å·®è¯„ä¼°</span><br><span class="line">[x_h(:,k) quat]=comp_internal_states(x_h(:,k),dx,quat);</span><br><span class="line">{</span><br><span class="line">    % Correct the state vector</span><br><span class="line">    x_out=x_in+dx;</span><br><span class="line"></span><br><span class="line">    % Correct the rotation matrics</span><br><span class="line">    % dx[7:9] åˆ†é‡ä»£è¡¨äº†æ—‹è½¬è¯¯å·®ä¼°è®¡ï¼ŒOMEGA åˆ™æ„é€ äº†æ—‹è½¬è¯¯å·®è½¬ç§»çŸ©é˜µï¼Œå¯¹æ—‹è½¬çŸ©é˜µ R è¿›è¡Œæ ¡æ­£</span><br><span class="line">    epsilon=dx(7:9);</span><br><span class="line">    OMEGA=[0 -epsilon(3) epsilon(2); epsilon(3) 0 -epsilon(1); -epsilon(2) epsilon(1) 0];</span><br><span class="line">    R=(eye(3)-OMEGA)*R;</span><br><span class="line">}</span><br><span class="line">% Update the filter state covariance matrix P.</span><br><span class="line">P=(Id-K*H)*P;</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·æ•´ä¸ªæ•°æ®å¡å°”æ›¼æ»¤æ³¢è¿‡ç¨‹å°±å®Œäº†ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ ZUPT æ£€æµ‹åˆ° 0 é€Ÿåº¦å‰åªæœ‰ä¸€ä¸ªé¢„æµ‹è¿‡ç¨‹ï¼Œå³åªæ›´æ–°ç³»ç»ŸçŠ¶æ€å’Œå‰éªŒç³»ç»Ÿåæ–¹å·®çŸ©é˜µï¼Œåœ¨ç³»ç»Ÿ ZUPT æ£€æµ‹åˆ° 0 é€Ÿåº¦æ—¶è¿›è¡Œä¸‹é¢çš„å¡å°”æ›¼ç³»æ•°ï¼Œè¯¯å·®æ ¡æ­£åŠåéªŒåæ–¹å·®çŸ©é˜µçš„æ›´æ–°ï¼Œå®ç°å¯¹ç³»ç»Ÿé€Ÿåº¦çš„æœ€ä¼˜è§£ç®—ã€‚æœ€ç»ˆçš„ç³»ç»ŸçŠ¶æ€çš„å‡†ç¡®æ€§ä¸»è¦å–å†³äº 0 é€Ÿçš„å‘ç”ŸåŠå‡†ç¡®çš„æ£€æµ‹ï¼Œåœ¨äººæ­¥è¡Œçš„åœºæ™¯ä¸‹ï¼Œæ¯ä¸€æ­¥éƒ½ä¼šæœ‰ä¸€ä¸ªåœé¡¿å¾ˆé€‚åˆç”¨æ¥æ£€æµ‹ 0 é€Ÿï¼Œåœ¨å‡†ç¡®æ£€æµ‹åˆ° 0 é€Ÿåé€Ÿåº¦è¯¯å·®è¢«æ¶ˆé™¤ï¼Œè¿™æ ·é€Ÿåº¦è¯¯å·®å¯ä»¥å®æ—¶å¾—åˆ°ä¿®æ­£è€Œä½ç½®è¯¯å·®ä»ç„¶ä¼šç´¯ç§¯ï¼Œä½†æ˜¯è¿™ä¸ªè¯¯å·®åªä¼šåœ¨è¿åŠ¨çŠ¶æ€ä¸‹ç´¯ç§¯ï¼Œå¯¹åº”ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºåˆæ•°æ®å¯ç”¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Robot </category>
          
          <category> Actuator </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Robot </tag>
            
            <tag> Actuator </tag>
            
            <tag> IMU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IMU è¯¯å·®æ¨¡å‹åŠæ ¡å‡†</title>
      <link href="/2020/Algorithm/imuCalibration/"/>
      <url>/2020/Algorithm/imuCalibration/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¼ æ„Ÿå™¨è¯¯å·®æ¨¡å‹">ä¼ æ„Ÿå™¨è¯¯å·®æ¨¡å‹</h1><p>å¯¹äºç†æƒ³çš„ IMU ä¸‰è½´åŠ é€Ÿåº¦è®¡ä¸¤ä¸¤æ­£äº¤ï¼Œæ„æˆä¸€ä¸ªæ­£äº¤çš„ä¸‰è½´ç›´è§’åæ ‡ç³»ï¼ŒåŠ é€Ÿåº¦è®¡æ¯ä¸€è½´å•ç‹¬æµ‹é‡è¯¥è½´çš„åŠ é€Ÿåº¦ï¼Œè€Œé™€èºä»ªåˆ™æµ‹é‡è¯¥è½´çš„è§’é€Ÿåº¦ã€‚åœ¨å®é™…çš„çœŸå® IMU ä¸­ç”±äºåˆ¶é€ å·¥è‰ºçš„è¯¯å·®ï¼Œä¸‰ä¸ªåæ ‡è½´ä¸å¯èƒ½å®Œå…¨ä¸¤ä¸¤æ­£äº¤ï¼ŒåŠ é€Ÿåº¦è®¡ä¸é™€èºä»ªçš„åæ ‡ç³»ä¹Ÿä¸ä¼šå®Œå…¨é‡åˆï¼Œå¹¶ä¸”å•ä¸ªä¼ æ„Ÿå™¨ä¹Ÿä¸æ˜¯å®Œå…¨ç²¾ç¡®çš„ã€‚åœ¨å®é™…å™¨ä»¶ä¸­å°†æ•°å­—è¾“å‡ºé‡è½¬åŒ–ä¸ºå®é™…ç‰©ç†é‡çš„ scale å‚æ•°åœ¨ä¸åŒè½´ä¸Šæ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯è®¾å¤‡ç”Ÿäº§å•†éƒ½ä¼šæä¾›ä¸€ä¸ªé»˜è®¤çš„ scale å‚æ•°ç”¨äºè½¬æ¢æ‰€æœ‰è½´çš„æ•°æ®ï¼Œè€Œä¸”æ•°å­—é‡çš„è¾“å‡ºè¿˜ä¼šå—åˆ°é›¶åï¼ˆä¼ æ„Ÿå™¨åœ¨é™æ­¢æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰å¾®å°é‡çš„è¾“å‡ºï¼‰çš„å½±å“ï¼Œè¿™äº›å°±æ˜¯é€ æˆ IMU ä¼ æ„Ÿå™¨çš„ç³»ç»Ÿè¯¯å·®ã€‚</p><p>æˆ‘ä»¬å–å®é™…å™¨ä»¶çš„åŠ é€Ÿåº¦è®¡åæ ‡ç³»ä¸º AF, é™€èºä»ªåæ ‡ç³»ä¸º GFï¼Œæ ¹æ® AF å’Œ GF åˆ†åˆ«å»ºç«‹å¯¹åº”çš„æ­£äº¤åæ ‡ç³» AOF å’Œ GOFï¼Œå…¶å»ºç«‹çº¦æŸä¸º</p><ul><li>AOF çš„ x è½´ä¸ AF çš„ x è½´é‡åˆã€‚</li><li>AOF çš„ y è½´ä½äº AF çš„ x ä¸ y è½´çš„å¹³é¢ä¸­ã€‚</li></ul><p>å¯¹äº GOF çš„å»ºç«‹çº¦æŸä¸ AOF çš„çº¦æŸç±»æ¯”å»ºç«‹ã€‚æœ€åå†å»ºç«‹ä¸€ä¸ªæ­£äº¤æœºä½“åæ ‡ç³» BFï¼ŒBF é€šå¸¸ä¸ AF å’Œ GF ä¹‹é—´æœ‰ä¸€ä¸ªå°è§’åº¦çš„åå·®ã€‚åœ¨éæ­£äº¤åæ ‡ç³»ï¼ˆAF æˆ– GFï¼‰ä¸­æµ‹é‡å¾—åˆ°çš„ç‰©ç†é‡<span class="math inline">\(s^S\)</span>å¯ä»¥è½¬æ¢åˆ°æœºä½“åæ ‡ç³» BF ä¸­å¾—åˆ°<span class="math inline">\(s^B\)</span>äºæ˜¯å¾—åˆ°ä¸‹å¼ï¼š</p><p><span class="math display">\[s^B = Ts^S, T = \begin{bmatrix}1 &amp; -\beta_{yz}  &amp; \beta_{zy} \\ \beta_{xz} &amp; 1 &amp; -\beta_{zx} \\ -\beta_{xy} &amp; \beta_{yx} &amp; 1 \end{bmatrix}   \tag{1}\]</span></p><p><span class="math inline">\(s^B å’Œ s^S\)</span> è¡¨ç¤ºåŠ é€Ÿåº¦æˆ–è§’é€Ÿåº¦åœ¨æœºä½“åæ ‡ç³» BF å’ŒåŠ é€Ÿåº¦åæ ‡ç³» AF æˆ–é™€èºä»ªåæ ‡ç³» GF ä¸‹æµ‹é‡è¡¨ç¤ºé‡ï¼Œ<span class="math inline">\(\beta_{ij}\)</span> è¡¨ç¤ºåŠ é€Ÿåº¦æˆ–é™€èºä»ªçš„ i è½´ç»•æœºä½“åæ ‡ç³» BF çš„ j è½´çš„æ—‹è½¬è§’åº¦ã€‚å¦‚å›¾äºŒæ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/imuErr.png"></p><span id="more"></span><p>å¦å¤– BF ä¸ AOF ä»¥åŠ BF ä¸ GOF åæ ‡ç³»ä¹‹é—´åªæœ‰çº¯ç²¹çš„æ—‹è½¬å…³ç³»ï¼Œæˆ‘ä»¬å‡è®¾ BF çš„ x è½´æ°å·§ä¸ AOF çš„ x è½´é‡åˆåœ¨è¿™ç§æƒ…å†µä¸‹<span class="math inline">\(\beta_{xz},\beta_{xy},\beta_{yx}\)</span>å˜ä¸º 0 å› æ­¤ä¸Šä¸€å¼å¯ä»¥å†™ä¸ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[a^O = T^aa^S, T^a = \begin{bmatrix}1 &amp; -\alpha_{yz} &amp; \alpha_{zy} \\ 0 &amp; 1 &amp; -\alpha_{zx} \\ 0 &amp; 0 &amp; 1\end{bmatrix}   \tag{2}\]</span></p><p>è¿™é‡Œ<span class="math inline">\(a^O\)</span>å’Œ<span class="math inline">\(a^S\)</span>è¡¨ç¤ºåŠ é€Ÿåº¦åœ¨ AOF å’Œ AF åæ ‡ç³»ä¸‹çš„è¡¨ç¤ºã€‚è¿™é‡Œå·²ç»æ”¹å˜äº†<span class="math inline">\(\beta\)</span>çš„å«ä¹‰ï¼Œç”¨<span class="math inline">\(\alpha\)</span>æ¥è¡¨ç¤ºåœ¨ AF ä¸ AOF çš„ x è½´é‡åˆçš„æƒ…å†µä¸‹ AF ä¸ AOF å„è½´ä¹‹é—´çš„æ—‹è½¬æƒ…å†µè€Œä¸å†æ˜¯ä¸æœºä½“åæ ‡ç³» BF ä¹‹é—´çš„æ—‹è½¬å…³ç³»äº†ã€‚ å¦‚å‰æ‰€è¿°ï¼Œé™€èºä»ªå¯ä»¥æŒ‰ç…§åŒæ ·çš„æ–¹å¼è¿›è¡Œå®šä¹‰ï¼Œ</p><p><span class="math display">\[w^O = T^gw^S, T^g = \begin{bmatrix}1 &amp; -\gamma_{yz} &amp; \gamma_{zy} \\ \gamma_{xz} &amp; 1 &amp; -\gamma_{zx} \\ -\gamma_{xy} &amp; \gamma_{yx}  &amp; 1\end{bmatrix}   \tag{3}\]</span></p><blockquote><p>æ³¨æ„åˆ°ç›®å‰ä¸ºæ­¢è¦é‡ç‚¹åŒºåˆ† 5 ä¸ªåæ ‡ç³»ï¼Œé¦–å…ˆæ˜¯åŠ é€Ÿåº¦è®¡åæ ‡ç³» AF å’Œé™€èºä»ªåæ ‡ç³» GF ç”±äºåˆ¶é€ å·¥è‰ºçš„åŸå› è¿™ä¸¤ä¸ªåæ ‡ç³»éƒ½ä¸æ˜¯æ­£äº¤çš„ï¼Œä¸”è¿™ä¸¤ä¸ªåæ ‡ç³»ä¹Ÿä¸é‡åˆï¼Œç„¶åæ ¹æ® AF å’Œ GF åˆ†åˆ›å»ºäº†ä¸¤ä¸ªæ­£äº¤åæ ‡ç³» AOF å’Œ GOFï¼Œå»ºç«‹çš„çº¦æŸå°±æ˜¯ä¸Šæ–‡ä¸­æåˆ°çš„ï¼Œæœ€ååˆå»ºç«‹äº†ä¸€ä¸ªæœºä½“åæ ‡ç³»ã€‚åé¢æˆ‘ä»¬å‡è®¾æœºä½“åæ ‡ç³»çš„ x è½´ä¸åŠ é€Ÿåº¦æ­£äº¤åæ ‡ç³» AOF çš„ x è½´é‡åˆäºæ˜¯å»ºç«‹äº†åŠ é€Ÿè®¡æ–¹ç¨‹ï¼ˆ1ï¼‰å’Œï¼ˆ2ï¼‰æœ€å BF ä¸ GOF çš„ x è½´ä¸é‡åˆå› æ­¤åªæœ‰ç¬¬ä¸€æ­¥å…¬å¼ï¼ˆ3ï¼‰æ²¡æœ‰åç»­çš„æ¨å¯¼ã€‚</p></blockquote><p>ç»¼ä¸ŠåŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªçš„è¯¯å·®éƒ½æ˜¯åŒ…å«ä¸¤éƒ¨åˆ†æ¯”ä¾‹è¯¯å·® scale å’Œ 0 åè¯¯å·® biasï¼Œæ¯”ä¾‹åå·® scale ç”¨å¦‚ä¸‹è¡¨ç¤ºï¼š</p><p><span class="math display">\[K^a = \begin{bmatrix}s_{a}^{x} &amp; 0 &amp; 0 \\ 0 &amp; s_{a}^{y} &amp; 0 \\ 0 &amp; 0 &amp; s_{a}^{z}\end{bmatrix}, K^g = \begin{bmatrix}s_{g}^{x} &amp; 0 &amp; 0 \\ 0 &amp; s_{g}^{y} &amp; 0 \\ 0 &amp; 0 &amp; s_{g}^{z}\end{bmatrix}   \tag{4}\]</span></p><p>ä¸¤ä¸ª bias å‘é‡ç”¨å¦‚ä¸‹è¡¨ç¤ºï¼š</p><p><span class="math display">\[b^a = \begin{bmatrix}b_{a}^{x}\\ b_{a}^{y}\\ b_{a}^{z}\end{bmatrix}, b^g = \begin{bmatrix}b_{g}^{x}\\ b_{g}^{y}\\ b_{g}^{z}\end{bmatrix}   \tag{5}\]</span></p><p>å®Œæ•´çš„åŠ é€Ÿåº¦è¯¯å·®æ¨¡å‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[a^O = T^aK^a(a^S + b^a + v^a)   \tag{6}\]</span></p><p>å®Œæ•´çš„è§’é€Ÿåº¦è¯¯å·®æ¨¡å‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[w^O = T^gK^g(w^S + b^g + v^g)   \tag{7}\]</span></p><p>å…¶ä¸­<span class="math inline">\(v^a\)</span>å’Œ<span class="math inline">\(v^g\)</span>ä¸æ˜¯ç³»ç»Ÿè¯¯å·®æ˜¯æµ‹é‡å™ªå£°ã€‚åˆ°æ­¤ IMU çš„è¯¯å·®æ¨¡å‹å°±è®²æ¸…æ¥šäº†ï¼Œåé¢ä¼šåŸºäºè¿™ä¸ªè¯¯å·®æ¨¡å‹è¿›è¡Œå»ºæ¨¡æ ¡å‡†ä¼ æ„Ÿå™¨ã€‚</p><h1 id="æ ¡å‡†æ¡†æ¶">æ ¡å‡†æ¡†æ¶</h1><p>ä¸ºäº†æ ¡å‡†åŠ é€Ÿåº¦è®¡æˆ‘ä»¬éœ€è¦ä¼°è®¡å¦‚ä¸‹æœªçŸ¥å‚æ•°ï¼š</p><p><span class="math display">\[\theta^{acc} = [\alpha_{yz},\alpha_{zy},\alpha_{zx},s_{a}^{x},s_{a}^{y},s_{a}^{z},b_{a}^{x},b_{a}^{y}b_{a}^{z}] \tag{8}\]</span></p><p>æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼š</p><p><span class="math display">\[a^O = h(a^S,\theta_{acc}) = T^aK^a(a^S + b^a)   \tag{9}\]</span></p><p>å®é™…ä¸Šæ˜¯å¿½ç•¥äº†æµ‹é‡å™ªå£°ã€‚åƒä¼ ç»Ÿçš„å¤šä½ç½®æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ç§»åŠ¨ IMU åˆ° M ä¸ªä¸åŒçš„ä¸´æ—¶ç¨³å®šçŠ¶æ€ï¼Œå¯ä»¥æå–åŠ é€Ÿåº¦å‘é‡<span class="math inline">\(a_{k}^S\)</span>ï¼ˆåœ¨éæ­£äº¤åæ ‡ç³» AF ä¸­ï¼‰è®¡ç®—åŠ é€Ÿåº¦è®¡åœ¨æ¯ä¸ªé™æ­¢çŠ¶æ€ä¸‹çš„å¹³å‡å€¼ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ä»·æ–¹ç¨‹æ¥ä¼°è®¡åŠ é€Ÿåº¦è®¡çš„å‚æ•°ï¼š</p><p><span class="math display">\[L(\theta_{acc}) =  \sum_{k=1}^{M}(||g||^2 - ||h(a_k^S,\theta_{acc})||^2)^2  \tag{10}\]</span></p><p><span class="math inline">\(||g||\)</span>æ˜¯çœŸå®çš„å½“åœ°é‡åŠ›åŠ é€Ÿåº¦è®¡ï¼Œå¯ä»¥æ ¹æ®å½“åœ°çš„ç»çº¬åº¦éå¸¸å®¹æ˜“çš„è·å–åˆ°ï¼Œæˆ‘ä»¬é‡‡ç”¨ Levenberg-Marquardt æ–¹æ³•æ¥æ±‚å–å½“ä»£ä»·å‡½æ•°çš„æœ€å°å€¼æ—¶çš„å‚æ•°ã€‚</p><p>ä¸ºäº†æ ¡å‡†é™€èºä»ªæˆ‘ä»¬å¯ä»¥åœ¨ IMU åˆå§‹çš„é™æ­¢é˜¶æ®µè¯»å–é™€èºä»ªæ•°æ®å¹¶å–å‡å€¼ï¼Œä½œä¸ºé™€èºä»ª biasã€‚ æˆ‘ä»¬å®šä¹‰<span class="math inline">\(\Psi\)</span>æ“ä½œï¼Œç”¨è¯»å–çš„é™€èºä»ªæ•°æ®<span class="math inline">\(w_i^S\)</span>å’Œé‡åŠ›å‘é‡<span class="math inline">\(u_{a,k-1}\)</span>ä½œä¸ºè¾“å…¥é˜Ÿåˆ—ï¼ˆé‡åŠ›å‘é‡æ˜¯ç»è¿‡ä¸Šé¢æ­¥éª¤æ ¡å‡†è¿‡çš„ï¼‰è¯¥æ“ä½œè¿”å›æœ€ç»ˆçš„é‡åŠ›å‘é‡<span class="math inline">\(u_{g,k}\)</span>ã€‚è¯¥æ“ä½œå¯ä»¥æ˜¯ä»»æ„ä¸€ä¸ªé€šè¿‡ä¸Šä¸€æ—¶åˆ»åŠ é€Ÿåº¦è®¡ä¸è§’é€Ÿåº¦è®¡èåˆåå¾—åˆ°å½“å‰é‡åŠ›å‘é‡çš„ç®—æ³•ã€‚</p><p><span class="math display">\[u_{g,k} = \Psi(w_i^S,u_{a,k-1}) \tag{11}\]</span></p><p>æˆ‘ä»¬éœ€è¦ä¼°è®¡çš„æœªçŸ¥é™€èºä»ªå‚æ•°å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\theta^{gyro} = [\gamma_{yz},\gamma_{zy},\gamma_{xz},\gamma_{zx},\gamma_{xy},\gamma_{yx},s_x^g,s_y^g,s_z^g] \tag{12}\]</span></p><p>åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å®šä¹‰ä»£ä»·å‡½æ•°ï¼š</p><p><span class="math display">\[L(\theta_{gyro}) = \sum_{k=2}^M||u_{a,k} - u_{g,k}||^2  \tag{13}\]</span></p><p>M æ˜¯é™æ€çŠ¶æ€è¯»å–æ•°æ®çš„æ•°é‡<span class="math inline">\(u_{a,k}\)</span>æ˜¯åŠ é€Ÿåº¦è®¡è®¡ç®—å¾—åˆ°çš„é‡åŠ›å‘é‡ï¼Œ<span class="math inline">\(u_{g,k}\)</span>æ˜¯é€šè¿‡ï¼ˆ13ï¼‰å¼è®¡ç®—å¾—åˆ°çš„ï¼Œæˆ‘ä»¬è¦è·å¾—<span class="math inline">\(\theta_{gyro}\)</span>çš„æœ€å°å€¼åŒæ ·é‡‡ç”¨ä¸Šé¢æåˆ°çš„ Levenberg-Marquardt æ–¹æ³•æ¥æ±‚å–ã€‚</p><h1 id="æ ¡å‡†è¿‡ç¨‹">æ ¡å‡†è¿‡ç¨‹</h1><h2 id="é™æ€æ£€æµ‹">é™æ€æ£€æµ‹</h2><p>å¦‚å‰é¢æ ¡å‡†æ¡†æ¶æ‰€è¿°ï¼Œæ ¡å‡† IMU éœ€è¦æ”¶é›†åŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªçš„åŸå§‹æ•°æ®ï¼Œé‡‡é›†çš„æ•°æ®åº”è¯¥åŒ…å« IMU åœ¨å„ä¸ªç¨³å®šçŠ¶æ€åŠå…¶é—´éš”çŠ¶æ€ä¸‹çš„æ•°æ®ã€‚ä¸ºäº†å‡å° bias å™ªå£°å¯¹ä¸Šé¢ä¸¤ä¸ªä»£ä»·å‡½æ•°çš„å½±å“éœ€è¦å…ˆå¯¹ 0 åè¿›è¡Œæ ¡å‡†ï¼Œåˆå§‹é˜¶æ®µéœ€è¦ä¸€æ®µæ—¶é—´çš„é™æ­¢ç”¨äºæ ¡å‡†é™€èºä»ªçš„ bias ä»¥åŠç”¨äºé™æ€æ£€æµ‹å‚è€ƒã€‚</p><p>æ ¡å‡†ç²¾åº¦å–å†³äºå¯¹é™æ­¢çŠ¶æ€åˆ¤æ–­çš„å‡†ç¡®æ€§ï¼Œæ ¡å‡†åŠ é€Ÿåº¦è®¡éœ€è¦åœ¨å‡ ä¸ªé™æ€çŠ¶æ€ä¸‹è¿›è¡Œè¿ç®—ï¼Œæ ¡å‡†é™€èºä»ªéœ€è¦é™æ€ä»¥åŠå„ä¸ªä¸åŒçŠ¶æ€çš„é™æ€ä¹‹é—´çš„è¿åŠ¨æ•°æ®ã€‚æ ¹æ®ç»éªŒå¯¹å®é™…çš„æ•°æ®é›†é‡‡ç”¨åŸºäºæ»¤æ³¢çš„ç®—å­æ•ˆæœä¼šè¾ƒå·®ï¼Œä¾‹å¦‚å‡†é™æ€æ£€æµ‹å™¨ï¼Œæ£€æµ‹é™æ­¢çŠ¶æ€é€šå¸¸ä¼šåŒ…å«ä¸€äº›å°çš„è¿åŠ¨ã€‚è€Œä¸”åŸºäºæ»¤æ³¢å™¨çš„ç®—æ³•é€šå¸¸ä¾èµ–æ»¤æ³¢å‚æ•°ï¼Œéœ€è¦å¯¹æ»¤æ³¢å‚æ•°è¿›è¡Œè°ƒæ•´ã€‚ æˆ‘ä»¬å»ºè®®é‡‡ç”¨åŸºäºæ–¹å·®çš„é™æ€æ£€æµ‹å™¨è¿ç®—ï¼Œä»–åˆ©ç”¨ä¸Šé¢çš„é™æ€æ£€æµ‹é—´éš”ã€‚æˆ‘ä»¬çš„æ£€æµ‹å™¨åŸºäº<span class="math inline">\(t_{wait}\)</span>æ—¶é—´é—´éš”è¿›è¡Œé‡‡é›†åŠ é€Ÿåº¦ä¿¡å·å¹¶è®¡ç®—æ–¹å·®å¤§å°ï¼š</p><p><span class="math display">\[\zeta(t) = \sqrt{[var_{t_w}(a_x^t)]^2 + [var_{t_w}(a_y^t)]^2 + [var_{t_w}(a_z^t)]^2}    \tag{14}\]</span></p><p>å…¶ä¸­<span class="math inline">\(var_{t_w}(a^t)\)</span>æ˜¯ä»¥æ—¶é—´ t ä¸ºä¸­å¿ƒæ¯éš”æ—¶é—´é—´éš”<span class="math inline">\(t_w\)</span>åŠ é€Ÿåº¦ä¿¡å·çš„æ–¹å·®å€¼ï¼Œæˆ‘ä»¬è¦å¯¹è¯¥çŠ¶æ€è¿›è¡Œåˆ†ç±»ä¸ºé™æ­¢è¿˜æ˜¯è¿åŠ¨åªéœ€è¦å¯¹<span class="math inline">\(\zeta(t)\)</span>è·Ÿä¸€ä¸ªé˜ˆå€¼è¿›è¡Œæ¯”è¾ƒå°±å¯ä»¥äº†ã€‚è¿™ä¸ªé˜ˆå€¼æˆ‘ä»¬å¯ä»¥é€‰å– IMU åœ¨åˆå§‹é™æ­¢çŠ¶æ€ä¸‹çš„å€¼<span class="math inline">\(\zeta(init)\)</span>ï¼Œä»è€Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨å‚æ•°çš„è°ƒæ•´ã€‚</p><h2 id="é¾™æ ¼åº“å¡”æ³•ç§¯åˆ†">é¾™æ ¼åº“å¡”æ³•ç§¯åˆ†</h2><p>åœ¨ä¸Šé¢çš„ 11 å¼ä¸­ï¼Œé€šè¿‡ k-1 æ—¶åˆ»çš„åŠ é€Ÿåº¦è®¡å¾—åˆ°çš„é‡åŠ›å‘é‡ä¸ k-1 åˆ° k æ—¶åˆ»çš„åŠ é€Ÿåº¦è¿›è¡Œè¿ç®—å¾—åˆ° k æ—¶åˆ»çš„é‡åŠ›å‘é‡ï¼Œè¿™é‡Œ k-1 å’Œ k æ˜¯ä¸¤ä¸ªç¨³å®šçŠ¶æ€ï¼Œå› æ­¤ k-1 å’Œ k ä¹‹é—´æœ‰ä¸€æ®µæ—¶é—´çš„è¿åŠ¨ï¼Œéœ€è¦å¯¹é™€èºä»ªæ•°æ®è¿›è¡Œç§¯åˆ†åˆ°åŠ é€Ÿåº¦è®¡çš„é‡åŠ›å‘é‡ä¸­å»ï¼Œåœ¨æˆ‘ä»¬çš„å®éªŒä¸­é‡‡ç”¨ 4 é˜¶é¾™æ ¼åº“å¡”ç§¯åˆ†æ³•ï¼ˆRK4nï¼‰æ¯”æ ‡å‡†çº¿æ€§ç§¯åˆ†ç²¾åº¦è¦é«˜ï¼Œä¸‹å¼ 15 ç”¨å¾®åˆ†æ–¹ç¨‹æ¥æè¿°å››å…ƒæ•°è¿åŠ¨æ–¹ç¨‹ï¼š</p><p><span class="math display">\[f(q,t) = \dot{q} = \frac{1}{2}\Omega(w(t))q \tag{15}\]</span></p><p>è¿™é‡Œ q æ˜¯ t-1 æ—¶åˆ»çš„é‡åŠ›å‘é‡çš„å››å…ƒæ•°è¡¨ç¤ºï¼Œè€Œ<span class="math inline">\(\Omega(w)\)</span>æ˜¯å°†è§’é€Ÿåº¦è½¬åŒ–ä¸ºæ–œå¯¹ç§°æ—‹è½¬çŸ©é˜µçš„æ“ä½œï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\Omega(w) = \begin{bmatrix}0 &amp; -w_x &amp; -w_y &amp; -w_z \\ w_x &amp; 0 &amp; w_z &amp; -w_y \\ w_y &amp; -w_z &amp; 0 &amp; w_x \\ w_z &amp; w_y &amp; -w_x &amp; 0\end{bmatrix}   \tag{16}\]</span></p><p>RK4n ç®—æ³•å¦‚ä¸‹ï¼š</p><p><span class="math display">\[q_{k+1} = q_k + \Delta t \frac{1}{6} (k_1 + 2k_2 + 2k_3 + k_4)  \tag{17}\]</span></p><p><span class="math display">\[k_i = f(q^{(i)},t_k + c_i\Delta t)  \tag{18}\]</span></p><p><span class="math display">\[q^{(i)} = q_k, for i = 1    \tag{19}\]</span></p><p><span class="math display">\[q^{(i)} = q_k + \Delta t \sum_{j=1}^{i-1}a_{ij}k_j, for i&gt;1     \tag{20}\]</span></p><p>æ‰€æœ‰éœ€è¦çš„ç³»æ•°<span class="math inline">\(c_i\)</span>å’Œ<span class="math inline">\(a_{ij}\)</span>ä¸ºï¼š</p><p><span class="math display">\[c_1 = 0, c_2 = \frac{1}{2}, c_3 =  \frac{1}{2},c_4 = 1, \\a_{21} = \frac{1}{2}, a_{31} = 0, a_{41} = 0,   \\a_{32} =  \frac{1}{2}, a_{42} = 0, a_{43} = 1.\]</span></p><p>æœ€åå¯¹äºæ¯ä¸€æ­¥æˆ‘ä»¬éœ€è¦å½’ä¸€åŒ–å››å…ƒæ•° qï¼š</p><p><span class="math display">\[q_{k+1} \rightarrow  \frac{q_{k+1}}{||q_{k+1}||}  \tag{21}\]</span></p><h2 id="é˜¿ä¼¦æ–¹å·®">é˜¿ä¼¦æ–¹å·®</h2><p>æˆ‘ä»¬ä½¿ç”¨è‰¾ä¼¦æ–¹å·®æ¥è¡¨ç¤ºé™€èºä»ªçš„éšæœºæ¼‚ç§»è¯¯å·®ï¼Œè¿™é‡Œç”¨<span class="math inline">\(\delta_a^2\)</span>æ¥è¡¡é‡è¿ç»­é—´éš”é™€èºä»ªæ•°æ®å¹³å‡å€¼ä¹‹é—´çš„æ–¹å·®ï¼š</p><p><span class="math display">\[\delta_a^2 = &lt;(x(\tilde{t},k) - x(\tilde{t},k-1))^2&gt;   \\=\frac{1}{2K}\sum_{k=1}^K(x(\tilde{t},k) - x(\tilde{t},k-1))^2   \tag{22}\]</span></p><p>å…¶ä¸­<span class="math inline">\(x(t,k)\)</span>æ˜¯ç¬¬ k ä¸ª<span class="math inline">\(\tilde{t}\)</span>æ—¶é—´é—´éš”é™€èºä»ªæ•°æ®çš„å‡å€¼ï¼ŒK æ˜¯æ‰€æœ‰æ—¶é—´çš„<span class="math inline">\(\tilde{t}\)</span>ä¸ªæ•°ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªè½´è®¡ç®—é˜¿ä¼¦æ–¹å·®ï¼Œå½“é˜¿ä¼¦æ–¹å·®æ”¶æ•›åˆ°å¾ˆå°çš„ä¸€ä¸ªå€¼æ—¶å°±è¡¨ç¤ºæ ¡å‡† ok äº†ï¼Œåœ¨åˆå§‹é˜¶æ®µæˆ‘ä»¬å°†å¯¹é™€èºä»ªæ•°æ®è¿›è¡Œæ±‚é˜¿ä¼¦æ–¹å·®è¿›è¡Œæ ¡å‡†ã€‚</p><h2 id="å®Œæˆæ ¡å‡†">å®Œæˆæ ¡å‡†</h2><p>ä¸ºäº†å¾—åˆ°è¾ƒå¥½çš„æ ¡å‡†ç»“æœè‡³å°‘éœ€è¦ 9 ç§ä¸åŒå§¿æ€çš„æ•°æ®ï¼Œå®éªŒè¡¨æ˜å§¿æ€æ•°è¶Šå¤šæ ¡å‡†ç»“æœè¶Šå¥½ã€‚</p><h1 id="é™„å½•">é™„å½•</h1><h2 id="levenberg-marquardt-ç®—æ³•">Levenberg-Marquardt ç®—æ³•</h2><h3 id="ç‰›é¡¿æ³•">ç‰›é¡¿æ³•</h3><p>ç‰›é¡¿æ³•ï¼ˆè‹±è¯­ï¼šNewton's methodï¼‰åˆç§°ä¸ºç‰›é¡¿-æ‹‰å¼—æ£®æ–¹æ³•ï¼ˆè‹±è¯­ï¼šNewton-Raphson methodï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§åœ¨å®æ•°åŸŸå’Œå¤æ•°åŸŸä¸Šè¿‘ä¼¼æ±‚è§£æ–¹ç¨‹çš„æ–¹æ³•ã€‚æ–¹æ³•ä½¿ç”¨å‡½æ•°<span class="math inline">\(f(x)\)</span>çš„æ³°å‹’çº§æ•°çš„å‰é¢å‡ é¡¹æ¥å¯»æ‰¾æ–¹ç¨‹<span class="math inline">\(f(x)=0\)</span>çš„æ ¹ã€‚ ç®—æ³•è¿‡ç¨‹ï¼š é¦–å…ˆé€‰æ‹©ä¸€ä¸ªæ¥è¿‘å‡½æ•°<span class="math inline">\(f(x)\)</span>é›¶ç‚¹çš„<span class="math inline">\(x_0\)</span>, è®¡ç®—ç›¸åº”çš„<span class="math inline">\(f(x_0)\)</span>å’Œåˆ‡çº¿æ–œç‡<span class="math inline">\({f}'(x_0)\)</span>ï¼Œç„¶åè®¡ç®—ç©¿è¿‡ç‚¹<span class="math inline">\((x_0,f(x_0))\)</span>å¹¶ä¸”æ–œç‡ä¸º<span class="math inline">\({f}'(x_0)\)</span>çš„ç›´çº¿å’Œ<span class="math inline">\(x\)</span>è½´çš„äº¤ç‚¹çš„<span class="math inline">\(x\)</span>åæ ‡ï¼Œä¹Ÿå°±æ˜¯æ±‚å¦‚ä¸‹æ–¹ç¨‹çš„è§£ï¼š</p><p><span class="math display">\[0 = (x - x_0)\cdot f'(x_0) + f(x_0)\]</span></p><p>æˆ‘ä»¬æ±‚è§£ xï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[0 = (x - x_0) + \frac{f(x_0)}{f'(x_0)}x - x_0 = - \frac{f(x_0)}{f'(x_0)}x = x_0 - \frac{f(x_0)}{f'(x_0)}\]</span></p><p>æˆ‘ä»¬å°†æ–°æ±‚å¾—çš„ç‚¹<span class="math inline">\(x\)</span>åæ ‡å‘½åä¸º<span class="math inline">\(x_1\)</span>ï¼Œé€šå¸¸<span class="math inline">\(x_1\)</span>ä¼šæ¯”<span class="math inline">\(x_0\)</span>æ›´æ¥è¿‘æ–¹ç¨‹<span class="math inline">\(f(x) = 0\)</span>çš„è§£ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<span class="math inline">\(x_1\)</span>å¼€å§‹ä¸‹ä¸€è½®çš„è¿­ä»£ï¼Œè¿­ä»£å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[x_{n+1} = x_n - \frac {f(x_n)}{f'(x_n)}\]</span></p><p>å¯¹äºå¤šç»´çš„æƒ…å†µï¼Œå¯¹<span class="math inline">\(f(x)\)</span>åœ¨<span class="math inline">\(x_0\)</span>å¤„è¿›è¡ŒäºŒé˜¶æ³°å‹’å±•å¼€ï¼š</p><p><span class="math display">\[f(x) = f(x_0) + \bigtriangledown f(x_0)^T(x - x_0) + \frac{1}{2}(x - x_0)^TH(x_0)(x - x_0)\]</span></p><p>è¿™é‡Œ<span class="math inline">\(\bigtriangledown f(x_0)\)</span>æ˜¯<span class="math inline">\(f(x)\)</span>çš„æ¢¯åº¦å‘é‡åœ¨ç‚¹<span class="math inline">\(x_0\)</span>å¤„çš„å€¼ï¼›<span class="math inline">\(H(x_0)\)</span>æ˜¯<span class="math inline">\(f(x)\)</span>çš„æµ·å¡çŸ©é˜µåœ¨ç‚¹<span class="math inline">\(x_0\)</span>å¤„çš„å€¼ï¼Œå‡½æ•°<span class="math inline">\(f(x)\)</span>æœ‰æå€¼çš„å¿…è¦æ¡ä»¶æ˜¯åœ¨æå€¼ç‚¹å¤„ä¸€é˜¶å¯¼æ•°ä¸º 0. åˆ©ç”¨æå°ç‚¹çš„å¿…è¦æ¡ä»¶<span class="math inline">\(\bigtriangledown f(x_k) = 0\)</span>æ¯æ¬¡è¿­ä»£ä»<span class="math inline">\(x_k\)</span>å¼€å§‹æ±‚ç›®æ ‡å‡½æ•°çš„æå°ç‚¹ï¼Œä½œä¸ºç¬¬<span class="math inline">\(k+1\)</span>æ¬¡è¿­ä»£å€¼<span class="math inline">\(x_{k+1}\)</span> å‡å¦‚<span class="math inline">\(x_{k+1}\)</span>æ»¡è¶³<span class="math inline">\(\bigtriangledown f(x_{k+1}) = 0\)</span>å¯¹<span class="math inline">\(\bigtriangledown f(x)\)</span>è¿›è¡Œæ³°å‹’å±•å¼€ï¼š</p><p><span class="math display">\[\bigtriangledown f(x) = \bigtriangledown f(x_k) + H(x_k)(x - x_k) \\\bigtriangledown f(x_k) + H(x_k)(x_{k+1} - x_k) = 0x_{k+1} = x_k - H(x_k)^{-1} \bigtriangledown f(x_k)\]</span></p><p>å¯ä»¥å†™ä¸ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[x_{k+1} = x_k - H_k^{-1}g_k\]</span></p><p>è¿™å°±æ˜¯ç‰›é¡¿æ³•çš„å¤šç»´å…¬å¼ï¼Œå…¶ä¸­<span class="math inline">\(g_k = \bigtriangledown f(x_k)\)</span></p><h3 id="é«˜æ–¯-ç‰›é¡¿æ³•">é«˜æ–¯-ç‰›é¡¿æ³•</h3><p>ç»™å®š m ä¸ªæ–¹ç¨‹<span class="math inline">\(\textbf{r} = (r_1,r_2,...r_m)\)</span>ï¼ˆé€šå¸¸å«åšæ®‹å·®æ–¹ç¨‹ï¼‰å’Œ n ä¸ªå˜é‡<span class="math inline">\(\beta = (\beta_1,\beta_2,...\beta_n)\)</span>, å…¶ä¸­<span class="math inline">\(m \geqslant n\)</span>, é«˜æ–¯-ç‰›é¡¿ç®—æ³•è¿­ä»£æ‰¾å‡ºä¸‹å¼å–æœ€å°å€¼æ—¶çš„æœ€ä¼˜å€¼ã€‚</p><p><span class="math display">\[s(\beta) = \sum_{i=1}^{m}r_i(\beta)^2\]</span></p><p>ä»ç»™å®šåˆå§‹å€¼<span class="math inline">\(\beta_0\)</span>å¼€å§‹ï¼Œé€šè¿‡ä¸‹å¼è¿›è¡Œè¿­ä»£å¯»æ‰¾<span class="math inline">\(s(\beta)\)</span>çš„æœ€å°å€¼ï¼š</p><p><span class="math display">\[\beta_{s+1} = \beta_{s} - (J_rJ_r)^{-1} J_r^T r \beta_s\]</span></p><p>è¿™é‡Œ<span class="math inline">\(r\)</span>å’Œ<span class="math inline">\(\beta\)</span>éƒ½æ˜¯åˆ—å‘é‡ï¼Œ<span class="math inline">\(J_r\)</span>Jacobian matrix ä¸ºï¼š</p><p><span class="math display">\[(J_r)_{ij} = \tfrac{\partial r_i \beta_s}{\partial \beta_j}\]</span></p><p>å…¶ä¸­ç¬¦å·<span class="math inline">\(^T\)</span>æ˜¯ matrix transpose. å¦‚æœ m=n åˆ™å¯ä»¥ç®€åŒ–ä¸ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\beta_{s+1} = \beta_{s} - (J_r)^{-1} r \beta_s\]</span></p><p>è¿™å°±æ˜¯ä¸€ç»´ç‰›é¡¿æ³•çš„ç›´æ¥æ¨å¹¿ã€‚ åœ¨æ•°æ®æ‹Ÿåˆä¸­ï¼Œç›®æ ‡æ˜¯æ‰¾åˆ°æœ€ä½³å‚æ•°<span class="math inline">\(\beta\)</span>ä½¿å¾—<span class="math inline">\(\beta\)</span>æ»¡è¶³ç»™å®šæ¨¡å‹<span class="math inline">\(y = f(x,\beta)\)</span>å¯ä»¥æœ€å¥½çš„ç¬¦åˆæ•°æ®ç‚¹<span class="math inline">\((x,y)\)</span>, æ–¹ç¨‹<span class="math inline">\(r\)</span>æ˜¯æ®‹å·®æ–¹ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[r_i(\beta) = y_i - f(x_i, \beta)\]</span></p><p>é«˜æ–¯-ç‰›é¡¿æ³•å¯ä»¥ç”¨å‡½æ•°<span class="math inline">\(f\)</span>çš„é›…å…‹æ¯”<span class="math inline">\(J_f\)</span>è¡¨ç¤ºï¼š</p><p><span class="math display">\[\beta_{s+1} = \beta_{s} - (J_fJ_f)^{-1} J_f^T r \beta_s\]</span></p><p>è¿™é‡Œ<span class="math inline">\((J_fJ_f)^{-1} J_f^T\)</span>æ˜¯<span class="math inline">\(J_f\)</span>çš„ä¼ªé€†ï¼ˆæ‘©å°”-å½­ç½—æ–¯é€†ï¼‰ã€‚</p><p>é«˜æ–¯-ç‰›é¡¿ç®—æ³•å°†é€šè¿‡è¿‘ä¼¼ä»ç‰›é¡¿æ–¹æ³•ä¼˜åŒ–å‡½æ•°ä¸­æ¨å¯¼è€Œæ¥ã€‚ç‰›é¡¿æ–¹æ³•æœ€å°åŒ–å‚æ•°å‡½æ•°<span class="math inline">\(s\)</span>çš„é€’å½’å…³ç³»<span class="math inline">\(\beta\)</span>ä¸ºï¼š</p><p><span class="math display">\[\beta_{s+1} = \beta_s - H^{-1}g\]</span> å…¶ä¸­<span class="math inline">\(g\)</span>è¡¨ç¤º<span class="math inline">\(S\)</span>æ¢¯åº¦å‘é‡ï¼Œ<span class="math inline">\(H\)</span>è¡¨ç¤º<span class="math inline">\(S\)</span>çš„æµ·å¡çŸ©é˜µ ( Hessian matrix). ç”±äº<span class="math inline">\(S =\sum_{i=1}^{m}r_i \frac{\partial r_i}{\partial \beta_j}\)</span>å…¶æ¢¯åº¦é€šè¿‡ä¸‹å¼ç»™å‡ºï¼š</p><p><span class="math display">\[g_{j}=2\sum _{i=1}^{m}r_{i}{\frac {\partial r_{i}}{\partial \beta _{j}}}\]</span></p><p>æµ·å¡çŸ©é˜µ<span class="math inline">\(H\)</span>çš„å…ƒç´ é€šè¿‡æ¢¯åº¦<span class="math inline">\(g_j\)</span>çš„ä¸åŒå…ƒç´ <span class="math inline">\(\beta_k\)</span>è®¡ç®—å¾—åˆ°ï¼š</p><p><span class="math display">\[H_{jk}=2\sum _{i=1}^{m}\left({\frac {\partial r_{i}}{\partial \beta _{j}}}{\frac {\partial r_{i}}{\partial \beta _{k}}}+r_{i}{\frac {\partial ^{2}r_{i}}{\partial \beta _{j}\partial \beta _{k}}}\right)\]</span></p><p>é«˜æ–¯-ç‰›é¡¿æ³•å¿½ç•¥äºŒé˜¶å°é¡¹ï¼Œæµ·å¡çŸ©é˜µ<span class="math inline">\(H\)</span>å¯ä»¥è¿‘ä¼¼å†™ä¸ºï¼š</p><p><span class="math display">\[H_{jk}\approx 2\sum _{i=1}^{m}J_{ij}J_{ik}\]</span></p><p>è¿™é‡Œ<span class="math inline">\(J_{ij}={\frac {\partial r_{i}}{\partial \beta _{j}}}\)</span>æ˜¯é›…å…‹æ¯”çŸ©é˜µ<span class="math inline">\(J_r\)</span>çš„ä¸€é¡¹ï¼Œæ¢¯åº¦å’Œæµ·å¡çŸ©é˜µå¯ä»¥é€šè¿‡å¦‚ä¸‹ç¬¦å·æ¥è¡¨ç¤ºï¼š</p><p><span class="math display">\[\mathbf {g} =2{\mathbf {J} _{\mathbf {r} }}^{\mathsf {T}}\mathbf {r} ,\quad \mathbf {H} \approx 2{\mathbf {J} _{\mathbf {r} }}^{\mathsf {T}}\mathbf {J_{r}} \]</span></p><p>å°†è¿™äº›è¡¨è¾¾å¼ä»£å…¥ä¸Šè¿°é€’å½’å…³ç³»ä¸­ä»¥è·å¾—è¿ç®—æ–¹ç¨‹å¼å°±å¾—åˆ°ï¼š</p><p><span class="math display">\[{\boldsymbol {\beta }}_{(s+1)}={\boldsymbol {\beta }}_{(s)}-\left(\mathbf {J_{r}} ^{\mathsf {T}}\mathbf {J_{r}} \right)^{-1}\mathbf {J_{r}} ^{\mathsf {T}}\mathbf {r} \left({\boldsymbol {\beta }}_{(s)}\right)\]</span></p><p>æ³¨æ„å¹¶éåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä¿è¯é«˜æ–¯-ç‰›é¡¿æ³•çš„æ”¶æ•›æ€§ï¼Œä¸‹å¼è¦èƒ½å¤Ÿå¾—åˆ°ä¿è¯æ‰å¯ä»¥ï¼š</p><p><span class="math display">\[\left|r_{i}{\frac {\partial ^{2}r_{i}}{\partial \beta _{j}\partial \beta _{k}}}\right|\ll \left|{\frac {\partial r_{i}}{\partial \beta _{j}}}{\frac {\partial r_{i}}{\partial \beta _{k}}}\right|\]</span></p><p>äºŒé˜¶å¯¼æ•°è¶³å¤Ÿå°å¯ä»¥è¢«å¿½ç•¥ï¼Œåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹éƒ½ä¼šæ”¶æ•›ï¼š</p><p>1.<span class="math inline">\(r_i\)</span>åœ¨é€‰å–å€¼é™„è¿‘è¦è¶³å¤Ÿå°ï¼Œè‡³å°‘åœ¨æœ€å°å€¼é™„è¿‘è¦è¶³å¤Ÿå°ã€‚ 2. å‡½æ•°åªæœ‰è½»åº¦çš„éçº¿æ€§ï¼Œå› æ­¤$ $åœ¨é€‰å–å€¼é™„è¿‘æ‰ä¼šè¶³å¤Ÿå°ã€‚</p><h3 id="levenberg-marquardt-ç®—æ³•-1">Levenberg-Marquardt ç®—æ³•</h3><p>è±æ–‡è´æ ¼ï¼é©¬å¤¸ç‰¹æ–¹æ³•ï¼ˆLevenbergâ€“Marquardt algorithmï¼‰èƒ½æä¾›æ•°éçº¿æ€§æœ€å°åŒ–ï¼ˆå±€éƒ¨æœ€å°ï¼‰çš„æ•°å€¼è§£ã€‚ã€ å’Œå…¶ä»–æœ€å°åŒ–ç®—æ³•ä¸€æ ·ï¼ŒLM ç®—æ³•ä¹Ÿæ˜¯é‡‡ç”¨è¿­ä»£è¿‡ç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è¦æä¾›ä¸€ä¸ªå‚æ•°<span class="math inline">\(\beta\)</span>çš„çŒœæµ‹å€¼ï¼Œåœ¨åªæœ‰ä¸€ä¸ªæœ€å°å€¼çš„æƒ…å†µä¸‹åˆå§‹çŒœæµ‹å‚æ•°ä¸º<span class="math inline">\({\boldsymbol {\beta }}^{\text{T}}={\begin{pmatrix}1,\ 1,\ \dots ,\ 1\end{pmatrix}}\)</span>ä¹Ÿå¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œåœ¨æœ‰å¤šä¸ªæå°å€¼çš„æƒ…å†µä¸‹ä»…å½“çŒœæµ‹å€¼ä»¥åŠæ¥è¿‘æœ€ç»ˆè§£æ—¶ï¼Œç®—æ³•æ‰ä¼šæ”¶æ•›åˆ°å…¨å±€æœ€å°å€¼ã€‚åœ¨æ¯ä¸€æ­¥è¿­ä»£ä¸­å‚æ•°å‘é‡<span class="math inline">\(\beta\)</span>ç”¨æ–°çš„è¯„ä¼°å€¼<span class="math inline">\(\beta + \delta\)</span>æ›¿ä»£ä¹‹å‰çš„å€¼ï¼Œä¸ºäº†ç¡®å®š<span class="math inline">\(\delta\)</span>å‡½æ•°<span class="math inline">\({\displaystyle f\left(x_{i},{\boldsymbol {\beta }}+{\boldsymbol {\delta }}\right)}\)</span>éœ€è¦è¿‘ä¼¼çº¿æ€§åŒ–ã€‚</p><p><span class="math display">\[f\left(x_{i},{\boldsymbol {\beta }}+{\boldsymbol {\delta }}\right)\approx f\left(x_{i},{\boldsymbol {\beta }}\right)+\mathbf {J} _{i}{\boldsymbol {\delta }}\]</span></p><p>å…¶ä¸­ï¼š</p><p><span class="math display">\[\mathbf {J} _{i}={\frac {\partial f\left(x_{i},{\boldsymbol {\beta }}\right)}{\partial {\boldsymbol {\beta }}}}\]</span></p><p>æ˜¯å‡½æ•°<span class="math inline">\(f\)</span>å¯¹å‚æ•°<span class="math inline">\(\beta\)</span>çš„æ¢¯åº¦ã€‚ <span class="math inline">\(s(\beta)\)</span> å¹³æ–¹åå·®ä¹‹å’Œåœ¨ <span class="math inline">\(f\)</span>å¯¹<span class="math inline">\(\beta\)</span> çš„æ¢¯åº¦ä¸º 0 æ—¶å–æœ€å°å€¼ï¼Œä¸Šé¢æ˜¯ <span class="math inline">\(f\left(x_{i},{\boldsymbol {\beta }}+{\boldsymbol {\delta }}\right)\)</span> çš„ä¸€é˜¶è¿‘ä¼¼ï¼Œåˆ™ï¼š</p><p><span class="math display">\[S\left({\boldsymbol {\beta }}+{\boldsymbol {\delta }}\right)\approx \sum _{i=1}^{m}\left[y_{i}-f\left(x_{i},{\boldsymbol {\beta }}\right)-\mathbf {J} _{i}{\boldsymbol {\delta }}\right]^{2}\]</span></p><p>æˆ–è€…ç”¨å‘é‡ç¬¦å·è¡¨ç¤ºï¼š</p><p><span class="math display">\[{\begin{aligned}S\left({\boldsymbol {\beta }}+{\boldsymbol {\delta }}\right)&amp;\approx \left\|\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)-\mathbf {J} {\boldsymbol {\delta }}\right\|^{2}\\&amp;=\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)-\mathbf {J} {\boldsymbol {\delta }}\right]^{\mathrm {T} }\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)-\mathbf {J} {\boldsymbol {\delta }}\right]\\&amp;=\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]^{\mathrm {T} }\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]-\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]^{\mathrm {T} }\mathbf {J} {\boldsymbol {\delta }}-\left(\mathbf {J} {\boldsymbol {\delta }}\right)^{\mathrm {T} }\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]+{\boldsymbol {\delta }}^{\mathrm {T} }\mathbf {J} ^{\mathrm {T} }\mathbf {J} {\boldsymbol {\delta }}\\&amp;=\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]^{\mathrm {T} }\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]-2\left[\mathbf {y} -\mathbf {f} \left({\boldsymbol {\beta }}\right)\right]^{\mathrm {T} }\mathbf {J} {\boldsymbol {\delta }}+{\boldsymbol {\delta }}^{\mathrm {T} }\mathbf {J} ^{\mathrm {T} }\mathbf {J} {\boldsymbol {\delta }}.\end{aligned}}\]</span></p><p>è¿™é‡Œæš‚æ—¶å…ˆä¸åšç†è®ºæ¨å¯¼äº†ï¼Œç›®å‰æ²¡æ‰¾åˆ°å¥½çš„æ¨å¯¼æ–¹æ³•ï¼Œç›´æ¥ä¸Šç»“è®ºå§ï¼Œ</p><p><span class="math display">\[(\mu \mathbf  {I}+(\mathbf  {J}^{T}\mathbf  {J})) \delta _{p}=\mathbf  {J}^{T}\epsilon_k\]</span></p><p>å°±æ˜¯è±æ–‡è´æ ¼ï¼é©¬å¤¸ç‰¹æ–¹æ³•ã€‚å¦‚æ­¤ä¸€æ¥ <span class="math inline">\(\mu\)</span> å¤§çš„æ—¶å€™è¿™ç§ç®—æ³•ä¼šæ¥è¿‘æœ€é€Ÿä¸‹é™æ³•ï¼Œå°çš„æ—¶å€™ä¼šæ¥è¿‘é«˜æ–¯-ç‰›é¡¿æ–¹æ³•ã€‚ä¸ºäº†ç¡®ä¿æ¯æ¬¡ <span class="math inline">\(\mathbf {\epsilon }\)</span> é•¿åº¦çš„å‡å°‘ï¼Œæˆ‘ä»¬è¿™ä¹ˆä½œï¼šå…ˆé‡‡ç”¨ä¸€ä¸ªå°çš„ <span class="math inline">\(\mu\)</span> ï¼Œå¦‚æœ <span class="math inline">\(\mathbf {\epsilon }\)</span> é•¿åº¦å˜å¤§å°±å¢åŠ  <span class="math inline">\(\mu\)</span> ã€‚è¿™ä¸ªç®—æ³•å½“ä»¥ä¸‹æŸäº›æ¡ä»¶è¾¾åˆ°æ—¶ç»“æŸè¿­ä»£ï¼š</p><ul><li>å¦‚æœå‘ç° <span class="math inline">\({\mathbf {\epsilon }}\)</span> é•¿åº¦å˜åŒ–å°äºç‰¹å®šçš„ç»™å®šå€¼å°±ç»“æŸã€‚</li><li>å‘ç° <span class="math inline">\({\mathbf {\delta _{p}}}\)</span> å˜åŒ–å°äºç‰¹å®šçš„ç»™å®šå€¼å°±ç»“æŸã€‚</li><li>åˆ°è¾¾äº†è¿­ä»£çš„ä¸Šé™è®¾å®šå°±ç»“æŸã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠA Robust and Easy to Implement Method for IMU Calibration without External Equipmentsã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Robot </tag>
            
            <tag> IMU </tag>
            
            <tag> EIS </tag>
            
            <tag> Image </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IMU å§¿æ€è§£ç®—</title>
      <link href="/2020/Algorithm/imuAttitudeCalculation/"/>
      <url>/2020/Algorithm/imuAttitudeCalculation/</url>
      
        <content type="html"><![CDATA[<h1 id="imu-é€šè¿‡åŠ é€Ÿåº¦è®¡è§£ç®—å§¿æ€è§’">IMU é€šè¿‡åŠ é€Ÿåº¦è®¡è§£ç®—å§¿æ€è§’</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/imuOrigin.png"></p><p>é€šè¿‡ä¸‰è§’å‡½æ•°å¯ä»¥å°†åŠ é€Ÿåº¦è®¡ä¸‰ä¸ªè½´çš„è§’é€Ÿåº¦è§£ç®—ä¸ºå§¿æ€è§’ï¼Œå…¶ä¸­ <span class="math inline">\(\alpha\)</span> , <span class="math inline">\(\beta\)</span> å’Œ <span class="math inline">\(\gamma\)</span>ï¼ˆ <span class="math inline">\(\gamma\)</span> æ˜¯ z è½´ä¸é‡åŠ›åŠ é€Ÿåº¦ä¹‹é—´çš„å¤¹è§’ï¼‰ä¸ä¸‰ä¸ªè½´ä¹‹é—´çš„å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;\beta = arcsin(\frac{a_x}{g}) \\&amp;\gamma  = arcsin(\frac{a_y}{g})\end{aligned}\]</span></p><p>å…¶ä¸­é‡åŠ›åŠ é€Ÿåº¦ $ g $ çš„å–å€¼ä½¿ç”¨ä¸‰è½´è§’é€Ÿåº¦çš„çŸ¢é‡å’Œå³ï¼š</p><p><span class="math display">\[g = \sqrt{a_x^{2} + a_y^{2} + a_z^{2}}\]</span></p><p>å°† g çš„å€¼å¸¦å…¥ä¸Šå¼å¯ä»¥å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;\beta = arctan(\frac{a_x}{\sqrt{a_y^{2} + a_z^{2}}}) \\&amp;\gamma  = arctan(\frac{a_y}{\sqrt{a_x^{2} + a_z^{2}}})\end{aligned}\]</span></p><p>å…¶ä¸­ Î± ä¸ºä¿¯ä»°è§’ pitchï¼ŒÎ² ä¸ºæ»šè½¬è§’ rollï¼Œå…¶ä¸­èˆªå‘è§’ yaw æ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡åŠ é€Ÿåº¦è®¡æ¥è®¡ç®—çš„ã€‚</p><span id="more"></span><h1 id="é™€èºä»ªç§¯åˆ†å¾—åˆ°è§’åº¦">é™€èºä»ªç§¯åˆ†å¾—åˆ°è§’åº¦</h1><p>é™€èºä»ªç§¯åˆ†æœ€ç›´æ¥çš„å°±æ˜¯å°†é™€èºä»ªè¾“å‡ºçš„è§’é€Ÿåº¦ä¸æ—¶é—´ç›¸ä¹˜åšç´¯åŠ å®ç°å¯¹è§’é€Ÿåº¦çš„ç§¯åˆ†å¾—åˆ°è§’åº¦ï¼Œæ•°æ®ç²¾åº¦è¾ƒé«˜ä½†æ˜¯æ¼‚ç§»å¾ˆä¸¥é‡ã€‚åœ¨ç§¯åˆ†ç®—æ³•ä¸Šå¸¸ç”¨é¾™æ ¼åº“å¡”æ³•è®¡ç®—ç§¯åˆ†ã€‚</p><h1 id="æ•°æ®èåˆ">æ•°æ®èåˆ</h1><h2 id="ä¸€é˜¶äº’è¡¥æ»¤æ³¢">ä¸€é˜¶äº’è¡¥æ»¤æ³¢</h2><h3 id="æ¨å¯¼">æ¨å¯¼</h3><p>è§’é€Ÿåº¦è®¡å’Œé™€èºä»ªéƒ½å¯ä»¥è§£ç®—å¾—åˆ°å§¿æ€è§’ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;z_1 = x + u \\&amp;z_2 = x + v\end{aligned}\]</span></p><p>å…¶ä¸­ <span class="math inline">\(z_1\)</span> å’Œ <span class="math inline">\(z_2\)</span> åˆ†åˆ«æ˜¯åŠ é€Ÿåº¦é€šè¿‡ä¸‰è§’å‡½æ•°è®¡ç®—å¾—åˆ°çš„æ¬§æ‹‰è§’å’Œé™€èºä»ªç§¯åˆ†å¾—åˆ°çš„æ¬§æ‹‰è§’ï¼Œ<span class="math inline">\(x\)</span> æ˜¯çœŸå®æ¬§æ‹‰è§’ï¼Œ<span class="math inline">\(u\)</span> å’Œ <span class="math inline">\(v\)</span> åˆ†åˆ«æ˜¯æµ‹é‡å™ªå£°ç¬¦åˆé«˜æ–¯å™ªå£°å…¶ä¸­ <span class="math inline">\(u\)</span> ä¸ºé«˜é¢‘å™ªå£° v æ˜¯ä½é¢‘å™ªå£°ã€‚<span class="math inline">\(x\)</span> çš„ä¼°è®¡å€¼ä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;\hat{x} = k_1 \times  z_1 + k_2 \times  z_2 \\&amp;k_1 + k_2 = 1\end{aligned}\]</span></p><p>å°† k1ã€k2 ç”¨ä¸€é˜¶æ»¤æ³¢ä¼ é€’å‡½æ•°è¡¨ç¤ºï¼š</p><p><span class="math display">\[\begin{aligned}&amp;k_1(s) = \frac{1}{fs + 1} \\&amp;k_2(s) = \frac{fs}{fs + 1}\end{aligned}\]</span></p><p>å…¶ä¸­ s æ˜¯æ‹‰æ™®æ‹‰æ–¯å˜æ¢çš„ s åŸŸå³é¢‘åŸŸï¼Œ<span class="math inline">\(\frac{1}{f}\)</span> æ˜¯æˆªæ­¢é¢‘ç‡ã€‚äºæ˜¯å¾—åˆ°ï¼š</p><p><span class="math display">\[\hat{x}(s) = k_1(s)z_1(s) + k_2(s)z_2(s) = \frac{1}{fs+1}z_1(s) + \frac{fs}{fs+1}z_2(s)\]</span></p><p>æ ¹æ®æ‹‰æ™®æ‹‰æ–¯å˜æ¢å¾®åˆ†å®šç†å˜æ¢å…¬å¼ï¼š</p><p><span class="math display">\[L[\frac{d^{n}f(t)}{dt^{n}}] = s^{n} F(s)\]</span></p><p>ç”¨æ‹‰æ™®æ‹‰æ–¯åå˜æ¢å›å»å¾—åˆ°ï¼š</p><p><span class="math display">\[f\dot{\hat{x}}(t) + \hat{x}(t) = z_1(t) + f\dot{\hat{z_2}}(t)\]</span></p><p>ç¦»æ•£åŒ–åå¾—åˆ°ï¼š</p><p><span class="math display">\[f\frac{\hat{x}(k) - \hat{x}(k-1)}{dt} + \hat{x}_k = z_1(k) + f\frac{\hat{z_2}(k) - \hat{z_2}(k-1)}{dt}\]</span></p><p>åŒ–ç®€æ•´ç†åå¾—ï¼š</p><p><span class="math display">\[\hat{x}(k) = \frac{f}{f+dt}[\hat{x}(k-1) + z_2(k) - z_2(k-1)] + \frac{dt}{f+dt}z_1(k)\]</span> å– <span class="math display">\[K=\frac{dt}{f+dt}\]</span></p><p>å¾—åˆ°ï¼š</p><p><span class="math display">\[\hat{x}(k) = (1-K)[\hat{x}(k-1) + z_2(k) - z_2(k-1)] + K z_1(k)\]</span></p><p>è¿™å°±æ˜¯ä¸€é˜¶äº’è¡¥æ»¤æ³¢çš„æœ€ç»ˆå…¬å¼ã€‚</p><p>å°†ä¸Šé¢æ¨å¯¼å‡ºçš„å…¬å¼å†™æˆä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @brief ä¸€é˜¶äº’è¡¥æ»¤æ³¢å™¨å•è½´</span><br><span class="line"> * @param acc_angle é€šè¿‡ä¸‰è§’å‡½æ•°è®¡ç®—åŠ é€Ÿåº¦è®¡çš„å€¼å¾—åˆ°çš„è§’åº¦å€¼</span><br><span class="line"> * @param gyro_rate é™€èºä»ªè¾“å‡ºçš„è§’é€Ÿåº¦å€¼</span><br><span class="line"> * @param K1 æ»¤æ³¢å™¨ç³»æ•°ï¼Œè¿œå°äº 1</span><br><span class="line"> * @<span class="built_in">return</span> è¿”å›èåˆåè§’åº¦å€¼</span><br><span class="line"> */</span><br><span class="line">static void firstOrderComplementaryFiltering(<span class="built_in">float</span> acc_angle, <span class="built_in">float</span> gyro_rate, <span class="built_in">float</span>* angle)</span><br><span class="line">{</span><br><span class="line">  *angle = K * acc_angle + (1 - K) * (*angle + gyro_rate * dt);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="è°ƒå‚">è°ƒå‚</h3><p>é™€èºä»ªé‡‡æ ·ç‡æ˜¯ 1kHZï¼Œdt ä¸º 0.001 åˆ™ç®—æ³•æ¶‰åŠçš„å‚æ•°åªæœ‰ä¸€ä¸ªå°±æ˜¯ K å‚æ•°ï¼Œå‡å¦‚å–æˆªæ­¢é¢‘ç‡ä¸º 100 çš„è¯ï¼š</p><p><span class="math display">\[K = \frac{dt}{f + dt} = \frac{0.001}{\frac{1}{100} + 0.001} \doteq 0.1\]</span></p><h2 id="kalman-æ»¤æ³¢">kalman æ»¤æ³¢</h2><h3 id="åŸç†">åŸç†</h3><p>å¡å°”æ›¼æ»¤æ³¢åŒ…æ‹¬é¢„æµ‹å’Œæ›´æ–°ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æ¨å¯¼ï¼š</p><h4 id="é¢„æµ‹è¿‡ç¨‹">é¢„æµ‹è¿‡ç¨‹</h4><p>é¢„æµ‹é˜¶æ®µä¸»è¦æ˜¯æ ¹æ®é™€èºä»ªæ•°æ®é¢„æµ‹è§’åº¦å€¼ï¼Œç³»ç»ŸçŠ¶æ€é‡æ˜¯è§’åº¦å€¼å’Œè§’é€Ÿåº¦åå·®ï¼Œè€Œä¸æ˜¯è§’åº¦å€¼å’Œè§’é€Ÿåº¦å€¼ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;\hat{x}(k|k-1) = \hat{x}(k-1|k-1) + (\acute{\theta} - \acute{\theta }_b) \bigtriangleup t + w_\theta \\&amp;\acute{\theta }_b(k|k-1) = \acute{\theta }_b(k-1|k-1) + w_{\acute{\theta }_b}  \\&amp;w(k) = \begin{bmatrix}w_{\theta } &amp;w_{\acute{\theta}_b}\end{bmatrix}\end{aligned}\]</span></p><p>å…¶ä¸­ <span class="math inline">\(\acute{\theta}_b\)</span> æ˜¯è§’åº¦åå·®ï¼Œ <span class="math inline">\(\acute{\theta }\)</span> æ˜¯è§’é€Ÿåº¦ï¼Œ <span class="math inline">\(w(k)\)</span> æ˜¯é¢„æµ‹è¿‡ç¨‹å™ªå£°ç¬¦åˆé«˜æ–¯å™ªå£°å†™æˆçŸ©é˜µçš„å½¢å¼ï¼š</p><p><span class="math display">\[\hat{x}(k|k-1) = F\hat{x}(k-1|k-1) + B\acute{\theta }(k) +W(K)  \tag{1} \\F = \begin{bmatrix}1 &amp; - \bigtriangleup t\\  0&amp;1 \end{bmatrix} \\B=\begin{bmatrix}\bigtriangleup T \\ 0\end{bmatrix}\]</span></p><p>å°†çŸ©é˜µå†™æˆå±•å¼€å½¢å¼ï¼š</p><p><span class="math display">\[\begin{bmatrix}\theta_k\\ \acute{\theta }_b\end{bmatrix} = \begin{bmatrix}1 &amp; -\bigtriangleup t\\  0&amp;1 \end{bmatrix}\begin{bmatrix}\theta_{k-1}\\ \acute{\theta }_{k-1}\end{bmatrix} + \begin{bmatrix}\bigtriangleup t\\ 0\end{bmatrix}\acute{\theta }_k + w_k\]</span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * kalman å…¬å¼ä¸€ã€è§’åº¦çš„å…ˆéªŒçŠ¶æ€ä¼°è®¡ x(k|k-1) = F * x(k-1|k-1) + B* u</span><br><span class="line"> * x ä¸ºè§’åº¦å’Œè§’é€Ÿåº¦çš„åˆ—å‘é‡ F=ï¼ˆ[1,-dt],</span><br><span class="line"> *                           [0, 1]ï¼‰</span><br><span class="line"> */</span><br><span class="line"> gyro_rate-=q_bias;</span><br><span class="line"> *angle+=gyro_rate * dt;</span><br></pre></td></tr></tbody></table></figure><p>åæ–¹å·®çŸ©é˜µçš„æ›´æ–°å¦‚ä¸‹ï¼š åæ–¹å·®çŸ©é˜µä¸ºå‘é‡$ \begin{bmatrix}_k\ _b\end{bmatrix}$çš„åæ–¹å·®çŸ©é˜µï¼Œè¯¥åæ–¹å·®çŸ©é˜µä¼šéšç€ç³»ç»Ÿå˜æ¢è€Œå˜æ¢ï¼Œå…¶åŸç†æ˜¯ä¸€ä¸ªçŸ©é˜µä½œç”¨åˆ°å‘é‡åçš„çŸ©é˜µåæ–¹å·®æ±‚æ³•ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;Cov(x) = \Sigma \\&amp;cov(Ax) = A\Sigma A^{T} \\cov(Ax)&amp; = E[(Ax - E[Ax])(Ax - E[Ax])^{T}] \\        &amp;= E[Ax -AE[x](Ax - AE[x])^{T}]  \\        &amp;= E(A(x-E[x])(x-E[x])^{T}A^{T}) \\        &amp;= AE[(X-E[x])(X-E[x])^{T}]A^{T} \\        &amp;= A\Sigma A^{T}\end{aligned}\]</span></p><p>æ•…åæ–¹å·®æ–¹ç¨‹ä¸ºï¼š</p><p><span class="math display">\[P_{expect}(K|K-1) = FP(K-1|K-1)F^{T} + Q_k  \tag{2}\]</span></p><p>è¿™ä¸ªæ–¹ç¨‹è¡¨è¾¾çš„æ˜¯æ–°çš„åæ–¹å·®ç”±ä¸Šä¸€æ¬¡çš„åæ–¹å·®é€šè¿‡çŸ©é˜µå˜æ¢è€Œæ¥ä¸”å†åŠ ä¸Šå¤–éƒ¨å¹²æ‰°ï¼Œè€Œåæ–¹å·®çŸ©é˜µè¡¨å¾çš„æ˜¯ä¸€ä¸ªè¯¯å·®èŒƒå›´ä¹Ÿå°±æ˜¯ä¸ç¡®å®šæ€§ï¼Œæ¯æ¬¡çš„ä¸ç¡®å®šæ€§ç”±ä¸Šä¸€æ¬¡çš„ä¸ç¡®å®šæ€§é€šè¿‡çŸ©é˜µå˜æ¢åŠ ä¸Šæ–°çš„ä¸ç¡®å®šæ€§è€Œæ¥ã€‚å°†çŸ©é˜µå†™ä¸ºå±•å¼€å½¢å¼å¹¶åŒ–ç®€å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{aligned}\begin{bmatrix}P_{00} &amp;P_{01} \\ P_{10}&amp; P_{11}\end{bmatrix}_{k|k-1} &amp;= \begin{bmatrix}1 &amp; -\bigtriangleup t\\  0&amp;1 \end{bmatrix}\begin{bmatrix}P_{00} &amp;P_{01} \\ P_{10}&amp; P_{11}\end{bmatrix}_{k-1|k-1}\begin{bmatrix}1 &amp; 0\\  -\bigtriangleup t&amp;1 \end{bmatrix} + \begin{bmatrix}Q_\theta  &amp; 0\\ 0&amp;Q_{\acute{\theta }} \end{bmatrix}\bigtriangleup t \\  &amp;=\begin{bmatrix}P_{00}-\bigtriangleup tP_{10} &amp;P_{01}-\bigtriangleup tP_{11} \\ P_{10}&amp;P_{11} \end{bmatrix}_{k-1|k-1}\begin{bmatrix}1 &amp; \\ 0-\bigtriangleup t &amp; 1\end{bmatrix} + \begin{bmatrix}Q_\theta  &amp; 0\\ 0&amp;Q_{\acute{\theta }} \end{bmatrix}\bigtriangleup t \\  &amp;=\begin{bmatrix}P_{00}-\bigtriangleup tP_{10}-\bigtriangleup t(P_{01}-\bigtriangleup tP_{11}) &amp;P_{01}-\bigtriangleup tP_{11} \\ P_{10}-\bigtriangleup tP_{11}&amp;P_{11} \end{bmatrix}_{k-1|k-1} + \begin{bmatrix}Q_\theta  &amp; 0\\ 0&amp;Q_{\acute{\theta }} \end{bmatrix}\bigtriangleup t \\  &amp;=\begin{bmatrix}P_{00}-\bigtriangleup tP_{10}-\bigtriangleup t(P_{01}-\bigtriangleup tP_{11}) +Q_\theta \bigtriangleup t&amp;P_{01}-\bigtriangleup tP_{11} \\ P_{10}-\bigtriangleup tP_{11}&amp;P_{11}+Q_{\acute{\theta }}\bigtriangleup t \end{bmatrix} \\  &amp;=\begin{bmatrix}P_{00}-\bigtriangleup t(\bigtriangleup tP_{11}-P_{10}-P_{01} +Q_\theta )&amp;P_{01}-\bigtriangleup tP_{11} \\ P_{10}-\bigtriangleup tP_{11}&amp;P_{11}+Q_{\acute{\theta }}\bigtriangleup t \end{bmatrix}\end{aligned}\]</span></p><p><span class="math inline">\(Q_k\)</span> æ˜¯è¿‡ç¨‹å™ªå£°åæ–¹å·®çŸ©é˜µï¼Œç”±äºåŠ é€Ÿåº¦è®¡çš„è¯¯å·®ä¸é™€èºä»ªä¹‹é—´çš„è¯¯å·®æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸å­˜åœ¨ç›¸å…³æ€§ï¼ˆå®é™…ä½¿ç”¨çš„æ—¶å€™è§’åº¦å€¼æ¯æ¬¡éƒ½æ˜¯ä½¿ç”¨ä¸Šæ¬¡çš„æœ€ä¼˜å€¼å› æ­¤ä¸¤è€…å®é™…æ˜¯æœ‰ä¸€å®šçš„ç›¸å…³æ€§çš„ï¼‰ï¼Œå› æ­¤è¯¥çŸ©é˜µæ˜¯ä¸€ä¸ªå¯¹ç§°çŸ©é˜µã€‚å…¶ä¸­é™€èºä»ªçš„è¯¯å·®ä¸ºç´¯ç§¯è¯¯å·®ï¼Œä¸æ—¶é—´<span class="math inline">\(\bigtriangleup t\)</span>æœ‰å…³ï¼Œå…¶è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[Q_k = \begin{bmatrix}Q_\theta &amp; 0\\ 0&amp; Q_{\acute{\theta }_b}\end{bmatrix}\bigtriangleup t \\\]</span></p><p>å…¶ä¸­ <span class="math inline">\(Q_{\acute{\theta }_b}\)</span> è¡¨å¾äº†é™€èºä»ªçš„æ¼‚ç§»è¯¯å·®ï¼Œ <span class="math inline">\(Q_\theta\)</span> è¡¨å¾äº†å§¿æ€è§’çš„è¯¯å·®ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * kalman å…¬å¼äºŒã€é¢„æµ‹åæ–¹å·®çŸ©é˜µ P(k|k-1) = F * P(k-1|k-1) * F<span class="string">' + Q(k)</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string"> P[0][0] += (Q_angle - P[0][1] - P[1][0] + P[1][1] * dt) * dt;</span></span><br><span class="line"><span class="string"> P[0][1] += (-P[1][1]) * dt;</span></span><br><span class="line"><span class="string"> P[1][0] += (-P[1][1]) * dt;</span></span><br><span class="line"><span class="string"> P[1][1] += Q_gyro * dt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="æ›´æ–°è¿‡ç¨‹">æ›´æ–°è¿‡ç¨‹</h4><p>è§‚æµ‹å€¼ <span class="math inline">\(z_k\)</span> ä¸ºï¼š</p><p><span class="math display">\[z_k = H * x_k + v_k\]</span></p><p>è¿™é‡Œ <span class="math inline">\(z_k\)</span> ä¸ºè§‚æµ‹å€¼ï¼Œæ˜¯é€šè¿‡åŠ é€Ÿåº¦è®¡è§£ç®—çš„å§¿æ€è§’ï¼Œ<span class="math inline">\(H\)</span> ä¸ºè§‚æµ‹çŸ©é˜µè¿™é‡Œåªèƒ½è·å–è§’åº¦å€¼ï¼Œä¸èƒ½ç›´æ¥è·å–è§’åº¦åå·®å€¼å› æ­¤ <span class="math inline">\(H=[\begin{bmatrix}1 &amp;0 \end{bmatrix}]\)</span>ï¼ˆå½“ç„¶å¦‚æœä½ å°†åŸå§‹çš„åŠ é€Ÿåº¦è®¡å€¼è¾“å…¥åˆ° kalman æ–¹ç¨‹é‡Œï¼Œè¿™é‡Œçš„ <span class="math inline">\(H\)</span> å°±æ˜¯ç”±åŠ é€Ÿåº¦å€¼åˆ°å§¿æ€è§’çš„å˜æ¢çŸ©é˜µï¼Œè¿™é‡Œæå‰å°†åŠ é€Ÿåº¦è§£ç®—ä¸ºå§¿æ€è§’åè¾“å…¥åˆ° kalman æ–¹ç¨‹ï¼‰ï¼Œ<span class="math inline">\(v_k\)</span> ä¸ºæµ‹é‡å™ªå£°ç¬¦åˆé«˜æ–¯åˆ†å¸ƒã€‚</p><p><span class="math display">\[z_k \sim N(0,R)\]</span></p><p>æœ¬ç³»ç»Ÿä¸­æµ‹é‡å€¼åªæœ‰ä¸€ä¸ªè§’é€Ÿåº¦å€¼ï¼Œå› æ­¤<span class="math inline">\(R\)</span>å¯ä»¥ç”¨ä¸€ä¸ªæ–¹å·®æ¥è¡¨ç¤ºã€‚è€ŒåŠ é€Ÿåº¦è®¡è§£ç®—å§¿æ€è§’æ˜¯ä¸æ—¶é—´æ— å…³çš„ï¼Œè¯¥è¯¯å·®ä¸ä¼šè¢«ç´¯åŠ åˆ°ç³»ç»Ÿå› æ­¤ <span class="math inline">\(v_k = v\)</span> , è¿™ä¸ªå€¼è®¾ç½®çš„æ¯”è¾ƒå¤§ä»£è¡¨æµ‹é‡å™ªå£°æ¯”è¾ƒå¤§ï¼Œåˆ™ç³»ç»Ÿç›¸ä¿¡é¢„æµ‹å€¼å¤§ä¸€äº›ï¼Œå¦‚æœè¿™ä¸ªå€¼è®¾ç½®çš„æ¯”è¾ƒå°ä»£è¡¨æµ‹é‡å™ªå£°å¾ˆå°ï¼Œç›¸ä¿¡æµ‹é‡å€¼å¤§ä¸€äº›åœ¨æœ¬ç³»ç»Ÿä¸­åŠ é€Ÿåº¦è®¡è§£ç®—çš„å§¿æ€è§’ä»£è¡¨æµ‹é‡å€¼ä¹Ÿå°±æ˜¯ç›¸ä¿¡åŠ é€Ÿåº¦å€¼å¤§ä¸€äº›ã€‚ è§‚æµ‹é‡ä¸é¢„æµ‹é‡ä¸€æ ·æœ‰ä¸€ä¸ªå¯¹ä¸ç¡®å®šæ€§çš„æ›´æ–°ï¼Œå°±æ˜¯é¢„æµ‹è¿‡ç¨‹çš„åæ–¹å·®ï¼Œæµ‹é‡è¿‡ç¨‹çš„åæ–¹å·®åŸºäºä¸Šä¸€æ¬¡çš„åæ–¹å·®æ¥è®¡ç®—ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[P_{measure}(k|k) = H*P(k|k-1)H^{T} + R\]</span></p><p>å°†å…¶å†™æˆçŸ©é˜µå±•å¼€å½¢å¼å¹¶åŒ–ç®€å¾—åˆ°å¦‚ä¸‹ï¼š</p><p><span class="math display">\[P_{measure}(k|k) =\begin{bmatrix}1 &amp;0 \end{bmatrix} * \begin{bmatrix}P_{00} &amp;P_{01} \\ P_{10} &amp;P_{11} \end{bmatrix}_{k|k-1} *\begin{bmatrix}1\\ 0\end{bmatrix} + R = P_{00 k|k-1} +R\]</span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * ä¸­é—´å˜é‡ E = H * P(k|k-1) H<span class="string">' + R</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string"> PCt_0 = C_0 * P[0][0];</span></span><br><span class="line"><span class="string"> PCt_1 = C_0 * P[1][0];</span></span><br><span class="line"><span class="string"> E = R_angle + C_0 * PCt_0;</span></span><br></pre></td></tr></tbody></table></figure><p>æµ‹é‡è¿‡ç¨‹çš„åæ–¹å·®ç»“æœå°±æ˜¯ä¸€ä¸ªæ•°å€¼ï¼ˆçœ‹åˆ°è¿™åº”è¯¥å¾ˆåº†å¹¸ä¸ç”¨å¯¹çŸ©é˜µè¿›è¡Œæ±‚é€†ï¼Œè¿™ä¸ªå‚æ•°å…¶å®å°±æ˜¯å¡å°”æ›¼å¢ç›Šé‡Œé¢æ±‚é€†çŸ©é˜µé‚£ä¸€é¡¹ï¼‰ï¼Œå…¶å®å°±æ˜¯æ–¹å·®å€¼ã€‚åˆ°è¿™é‡Œæœ‰ä¸¤ä¸ªåæ–¹å·®ï¼Œä¸€ä¸ªæ˜¯é¢„æµ‹è¿‡ç¨‹çš„åæ–¹å·®å¦ä¸€ä¸ªæ˜¯æµ‹é‡è¿‡ç¨‹çš„åæ–¹å·®ï¼Œä¸¤ä¸ªåæ–¹å·®ä»£è¡¨äº†ä¸¤ä¸ªæ•°æ®æºçš„å™ªå£°ï¼Œå“ªä¸ªå€¼å¤§ä»£è¡¨å“ªä¸ªè¿‡ç¨‹çš„å™ªå£°è¶Šå¤§ï¼Œå¯¹å…¶ä¿¡ä»»åº¦å°±ä¼šé™ä½ã€‚ ä¸‹é¢ç»ˆäºåˆ°äº†å¡å°”æ›¼å¢ç›Šçš„è®¡ç®—ï¼Œå…ˆçœ‹ä¸‹å¡å°”æ›¼å¢ç›Šå¼ ä»€ä¹ˆæ ·å­å§ï¼š</p><p><span class="math display">\[K = H_k*P_k*H^{T}_k (H_k*P_k*H^{T}_k + R)^{-1}\]</span></p><p>è¿™ä¸ªå…¬å¼çœ‹èµ·æ¥éå¸¸ä¸å‹å¥½ï¼Œå…¶å®å¡å°”æ›¼ç³»æ•°æ˜¯å°†ä¸Šé¢é€šè¿‡é¢„æµ‹å’Œæµ‹é‡å¾—åˆ°çš„ä¸¤ä¸ªé«˜æ–¯æ–¹ç¨‹ç›¸ä¹˜è€Œå¾—åˆ°çš„ã€‚å…·ä½“å¯ä»¥å‚è€ƒä»¥ä¸‹é“¾æ¥ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯ä¸­æ–‡ç¿»è¯‘ç‰ˆï¼š è‹±æ–‡åŸç‰ˆé“¾æ¥ <span class="exturl" data-url="aHR0cDovL3d3dy5iemFyZy5jb20vcC9ob3ctYS1rYWxtYW4tZmlsdGVyLXdvcmtzLWluLXBpY3R1cmVzLw==">How a Kalman filter works, in pictures<i class="fa fa-external-link-alt"></i></span> ä¸­æ–‡ç¿»è¯‘ç‰ˆï¼š<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA3MjA2NjEvYXJ0aWNsZS9kZXRhaWxzLzYzMjUzNTA5">è¯¦è§£å¡å°”æ›¼æ»¤æ³¢åŸç†<i class="fa fa-external-link-alt"></i></span> ä¸ºäº†è¿™é‡Œå…¬å¼çš„å®Œæ•´æ€§ï¼Œè¿˜æ˜¯å†³å®šæŠŠä¸ä¹‹ç›¸å…³çš„å†…å®¹æ¬è¿‡æ¥å§ï¼Œå¦‚ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/kalman.png"></p><p>è¿™å¼ å›¾æ˜¯åŸä½œè€…çš„å›¾ä½†æ˜¯æœ‰äº›ä¸å‡†ç¡®ï¼Œè“è‰²çš„èåˆåçš„æ›²çº¿åº”è¯¥æ˜¯æ›´é«˜çš„æ›²çº¿æ‰å¯¹ã€‚å°†çº¢è‰²å’Œç»¿è‰²ä¸¤ä¸ªé«˜æ–¯æ–¹ç¨‹ç›¸ä¹˜å¯ä»¥å¾—åˆ°è“è‰²æ›²çº¿ä»£è¡¨çš„é«˜æ–¯æ–¹ç¨‹ï¼Œè¿™å°±æ˜¯ä¼°è®¡çš„æœ€ä¼˜å€¼ã€‚å…ˆçœ‹ä¸€ç»´æ•°æ®ä¸‹çš„é«˜æ–¯æ–¹ç¨‹ç›¸ä¹˜çš„ç»“æœå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;{\mu }' = \mu_0 + \frac{\sigma_0 ^{2} (\mu_1 - \mu_0)}{\sigma_0 ^{2} + \sigma_1 ^{2}} \\&amp;{\sigma}'^{2} = \sigma_0^{2} - \frac{\sigma_0^{4}}{\sigma_0 ^{2} + \sigma_1 ^{2}}\end{aligned}\]</span></p><p>å–</p><p><span class="math display">\[k = \frac{\sigma_0^{2}}{\sigma_0 ^{2} + \sigma_1 ^{2}}\]</span></p><p>å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;{\mu }' = \mu_0 + k(\mu_1 - \mu_0) \\&amp;{\sigma}'^{2} = \sigma_0 ^{2} - k \sigma_0 ^{2}\end{aligned}\]</span></p><p>ç”¨ <span class="math inline">\(\Sigma\)</span> è¡¨ç¤ºåæ–¹å·®ï¼Œå†™æˆçŸ©é˜µçš„å½¢å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;K = \Sigma_0 (\Sigma_0 + \Sigma_1)^{-1} \\&amp;\vec{\mu'} = \vec{\mu_0} + K (\vec{\mu_1} - \vec{\mu_0}) \\&amp;{\Sigma}' = \Sigma_0 - K \Sigma_0\end{aligned}\]</span></p><p>å°†æˆ‘ä»¬å‰é¢æ¨å¯¼çš„é¢„æµ‹å’Œæµ‹é‡å¸¦å…¥åˆ°ä¸Šé¢çš„å…¬å¼å°±å¾—åˆ°ä¸‹é¢å¡å°”æ›¼æ»¤æ³¢çš„åä¸‰ä¸ªå…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;K = H_k * P_k * H^{T}_k (H_k * P_k * H^{T}_k + R)^{-1} \\&amp;H_k * \hat{x}_{k|k} = H_k * \hat{x}_{k|k-1} + K (z_k -  H_k * \hat{x}_{k|k-1}) \\&amp;H_k * {P}'_{k|k} * H^{T}_k = H_k * P_{k|k} * H^{T}_k - K * (H_k * P_{k|k} * H^{T}_k)\end{aligned}\]</span></p><p>å°†è¿™ä¸‰ä¸ªæ–¹ç¨‹è”ç³»èµ·æ¥åšè¿ç®—å¾—åˆ°å¦‚ä¸‹æ›´æ–°æ–¹ç¨‹ï¼š</p><p><span class="math display">\[K_k = P_{k|k-1}  * H^T * P^{-1}_{measure}(k|k)  \tag{3}\]</span></p><p>å°†å…¶å†™ä¸ºçŸ©é˜µå±•å¼€å½¢å¼å¹¶åŒ–ç®€å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{aligned}\begin{bmatrix}K_0\\ K_1\end{bmatrix}_k &amp;= \begin{bmatrix}P_{00} &amp;P_{01} \\ P_{10}&amp;P_{11} \end{bmatrix}_{k|k-1} * \begin{bmatrix}1\\ 0\end{bmatrix} * P^{-1}_{measure}(k|k) \\&amp;=\begin{bmatrix}P_{00}\\ P_{10}\end{bmatrix}_{k|k-1} * P^{-1}_{measure}(k|k)\end{aligned}\]</span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * kalman å…¬å¼ä¸‰ã€K = P(k|k-1) * H<span class="string">' / (H * P(k|k-1) H'</span> + R)</span><br><span class="line"> */</span><br><span class="line"> K_0 = PCt_0 / E;</span><br><span class="line"> K_1 = PCt_1 / E;</span><br></pre></td></tr></tbody></table></figure><p>åæ–¹å·®çš„æ›´æ–°ï¼š</p><p><span class="math display">\[P_{k|k} = (I - K_k* H_k)P_{k|k-1} \tag{4}\]</span></p><p>å°†çŸ©é˜µå†™ä¸ºå±•å¼€å½¢å¼å¹¶åŒ–ç®€å¾—åˆ°å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{aligned}\begin{bmatrix}P_{00} &amp; P_{01} \\ P_{10} &amp; P_{11}\end{bmatrix}_k &amp;= (\begin{bmatrix}1 &amp; 0\\ 0 &amp; 1\end{bmatrix} -\begin{bmatrix}K_0\\ K_1\end{bmatrix}_k * \begin{bmatrix}1 &amp; 0 \end{bmatrix}) * \begin{bmatrix}P_{00} &amp; P_{01} \\ P_{10} &amp; P_{11}\end{bmatrix}_{k-1} \\&amp;=(\begin{bmatrix}1 &amp; 0\\ 0 &amp; 1\end{bmatrix} -\begin{bmatrix}K_0 &amp;0 \\ K_1 &amp;0 \end{bmatrix}_k) * \begin{bmatrix}P_{00} &amp; P_{01} \\ P_{10} &amp; P_{11}\end{bmatrix}_{k-1} \\&amp;=\begin{bmatrix}P_{00} &amp; P_{01} \\ P_{10} &amp; P_{11}\end{bmatrix}_{k-1} - \begin{bmatrix}K_0P_{00} &amp;K_0P_{01} \\ K_1P_{00} &amp;K_1P_{01} \end{bmatrix}\end{aligned}\]</span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * kalman å…¬å¼å››ã€P(k|k) = (I - K * H) * P(k|k-1)</span><br><span class="line"> */</span><br><span class="line"> t_0 = PCt_0;</span><br><span class="line"> t_1 = C_0 * P[0][1];</span><br><span class="line"> P[0][0] -= K_0 * t_0;</span><br><span class="line"> P[0][1] -= K_0 * t_1;</span><br><span class="line"> P[1][0] -= K_1 * t_0;</span><br><span class="line"> P[1][1] -= K_1 * t_1;</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢æ˜¯æœ€ä¼˜ä¼°è®¡å€¼</p><p><span class="math display">\[\hat{x}_{k|k} = \hat{x}_{k|k-1} + K * (z_k  -  H_k * \hat{x}_{k|k-1})   \tag{5}\]</span></p><p>å†™æˆçŸ©é˜µçš„å±•å¼€å½¢å¼å¹¶åŒ–ç®€å¦‚ä¸‹ï¼š</p><p><span class="math display">\[\begin{bmatrix}\theta \\ \acute{\theta_b}\end{bmatrix}_{k|k} = \begin{bmatrix}\theta \\ \acute{\theta_b}\end{bmatrix}_{k|k-1} + \begin{bmatrix}K_0\\ K_1\end{bmatrix}_k * (z_k - \theta_{k|k-1})\]</span></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * ä¸­é—´å˜é‡ è§’åº¦æ®‹å·® z(k) - H * x(k)</span><br><span class="line"> * H = ([1,0])</span><br><span class="line"> */</span><br><span class="line"> angle_err = acc_angle - *angle;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * kalman å…¬å¼äº”ã€x(k|k) = x(k|k-1) + K * (z(k) - H * x(k))</span><br><span class="line"> */</span><br><span class="line"> *angle += K_0 * angle_err;</span><br><span class="line"> q_bias += K_1 * angle_err;</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šå°±æ˜¯å¡å°”æ›¼æ»¤æ³¢çš„é¢„æµ‹å’Œæ›´æ–°è¿‡ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬å‰é¢åœ¨è¯´å¡å°”æ›¼ç³»æ•°çš„æ—¶å€™æ˜¯å°†ä¸¤ä¸ªå¡å°”æ›¼æ–¹ç¨‹ç›¸ä¹˜å¾—åˆ°äº†æœ€ä¼˜è§£ï¼Œè¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯è¿™ç§æ–¹å¼å¾—åˆ°çš„å€¼æ˜¯ä¸æ˜¯åˆç†ï¼Œæˆ–è€…è¯´å¡å°”æ›¼æ»¤æ³¢æ˜¯ä¸æ˜¯æ— åä¼°è®¡çš„ï¼Œè¿™é‡Œè´´å‡ºç½‘ä¸Šçš„ä¸€ä¸ªæ¨å¯¼ï¼Œè‡ªè¡ŒæŸ¥çœ‹ã€‚<span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzMzMTU2ODMyOC9hbnN3ZXIvNzM1Mjg3NTU2">https://www.zhihu.com/question/331568328/answer/735287556<i class="fa fa-external-link-alt"></i></span></p><h3 id="è°ƒå‚-1">è°ƒå‚</h3><p>å¡å°”æ›¼ç³»æ•°<span class="math inline">\(K\)</span>è¡¨å¾äº†å¯¹é¢„æµ‹é‡å’Œæµ‹é‡é‡çš„ä¿¡ä»»ç¨‹åº¦ï¼Œå¦‚ä¸‹å¼ï¼š</p><p><span class="math display">\[\hat{x}_{k|k} = \hat{x}_{k|k-1} + K * (z_k  -  H_k * \hat{x}_{k|k-1})\]</span></p><p>è¿™ä¸ªå¼å­ä¸­ <span class="math inline">\(H_k\)</span> åªæ˜¯é€‰å–äº†è§’åº¦ä¿¡æ¯å»æ‰äº†åŠ é€Ÿåº¦å€¼ï¼Œæš‚æ—¶å¯ä»¥å¿½ç•¥æ‰ä¸çœ‹ï¼Œå½“ <span class="math inline">\(K\)</span> ä¸º <span class="math inline">\(0\)</span> æ—¶ï¼Œæœ€ä¼˜å€¼å®Œå…¨å–é¢„æµ‹å€¼å³å®Œå…¨ç›¸ä¿¡é¢„æµ‹å€¼æ˜¯çœŸå®å€¼ä¸ç›¸ä¿¡æµ‹é‡å€¼ï¼Œå½“<span class="math inline">\(K\)</span>å– 1 æ—¶æœ€ä¼˜å€¼å–<span class="math inline">\(z_k\)</span>æµ‹é‡å€¼ï¼Œåˆ™å®Œå…¨ç›¸ä¿¡æµ‹é‡å€¼è€Œä¸ç›¸ä¿¡é¢„æµ‹å€¼ã€‚<span class="math inline">\(K\)</span>è¶Šå¤§åˆ™è¶Šç›¸ä¿¡æµ‹é‡å€¼ï¼Œ<span class="math inline">\(K\)</span>è¶Šå°è¶Šç›¸ä¿¡é¢„æµ‹å€¼ã€‚<span class="math inline">\(K\)</span>çš„å€¼åŠ¨æ€è°ƒæ•´é¢„æµ‹å’Œæµ‹é‡ä¹‹é—´çš„æ¯”ä¾‹å› å­ã€‚å¯¹äºæˆ‘ä»¬çš„ç³»ç»Ÿä¸­ä¸€å¼€å§‹ç›¸ä¿¡é™€èºä»ªæ•°æ®å¤šä¸€äº›ï¼Œéšç€æ—¶é—´ä¸çŸ­ç´¯ç§¯åˆ™ç›¸ä¿¡åŠ é€Ÿåº¦è®¡æ•°æ®é€æ¸å¢å¤šï¼Œæœ€åä¼šæ”¶æ•›åˆ°ä¸€ä¸ªå›ºå®šçš„å€¼ã€‚ æ¥ä¸‹æ¥æ˜¯ç³»ç»Ÿé‡Œçš„å‡ ä¸ªå…³é”®å‚æ•° <span class="math inline">\(Q\)</span> å’Œ <span class="math inline">\(R\)</span>ï¼Œè¿™é‡Œè¯¦ç»†çœ‹ä¸‹å…·ä½“æ¯ä¸ªå‚æ•°è¯¥æ€ä¹ˆé€‰å–ï¼š å‚æ•° <span class="math inline">\(Q\)</span> çš„è§’åº¦è¯¯å·®çš„æ–¹å·® <span class="math inline">\(Q_{\theta }\)</span> ï¼Œè¯¥å‚æ•°æ˜¯é¢„æµ‹è§’åº¦çš„å™ªå£°ï¼Œé¢„æµ‹ä¸»è¦æ˜¯åŸºäºä¸Šä¸€æ¬¡çš„æœ€ä¼˜å€¼å¯¹é™€èºä»ªæ•°æ®è¿›è¡Œç§¯åˆ†å¾—åˆ°é¢„æµ‹å€¼ï¼Œè¯¥å€¼ä»£è¡¨äº†é™€èºä»ªçš„æ•´ä½“è¯¯å·®ï¼Œè°ƒè¯•å‚æ•°çš„æ—¶å€™è¯¥å€¼ä¸€èˆ¬è®¾çš„æ¯”è¾ƒå°ï¼Œå¯¹é™€èºä»ªçš„ä¿¡ä»»åº¦æ¯”è¾ƒå¤§ã€‚ è§’é€Ÿåº¦è¯¯å·® <span class="math inline">\(Q_{\acute{\theta }}\)</span> å°±æ˜¯é™€èºä»ªçš„æ¼‚ç§»æ–¹å·®ï¼Œè¿™ä¸ªå€¼ååº”çš„æ˜¯é™€èºä»ªæ¼‚ç§»çš„æ–¹å·®ï¼Œå³åœ¨æ¯æ¬¡çš„æ¼‚ç§»é‡éƒ½æ˜¯ç¬¦åˆé«˜æ–¯å™ªå£°çš„ï¼Œä½†æ˜¯è¿™ä¸ªå€¼è·Ÿç¯å¢ƒæ¸©åº¦ç­‰ç›¸å…³ï¼Œåœ¨ä¸åŒæ¸©åº¦ä¸‹æ¼‚ç§»å€¼æ˜¯ä¸åŒçš„å¯ä»¥å¯¹æ¸©åº¦æ¼‚ç§»è¿›è¡Œå¤šæ¬¡æµ‹é‡ä¿®æ­£ï¼Œè¿˜æœ‰è·Ÿé™€èºä»ªçš„è¿åŠ¨çŠ¶æ€æœ‰å…³ï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­é™€èºä»ªå›ºå®šåƒä¸€ä¸ªæ–¹å‘æ—‹è½¬ï¼Œåˆ™å¯ä»¥åœ¨é™€èºä»ªä»¥å›ºå®šè§’é€Ÿåº¦æ—‹è½¬ä¸‹æµ‹é‡è¯¥æ¼‚ç§»ã€‚æ•´ä½“ Q ä»£è¡¨çš„æ˜¯é¢„æµ‹å™ªå£°ã€‚ æµ‹é‡å™ªå£° <span class="math inline">\(R\)</span> æ˜¯ä»£è¡¨äº†å®é™…æ•°æ®ä¸æµ‹é‡å€¼ä¹‹é—´çš„è¯¯å·®ï¼Œä¼ æ„Ÿå™¨ä¸èƒ½ 100%è·å–åˆ°å®é™…ç‰©ç†é‡æ•°æ®æµ‹é‡ä¸€å®šæ˜¯æœ‰è¯¯å·®çš„ï¼Œè¯¥å€¼å¯ä»¥é€šè¿‡ IMU çš„ datasheet è·å–ç›¸å…³å‚æ•°ã€‚ä¾‹å¦‚ icm20602 çš„åŠ é€Ÿåº¦è¯¯å·®ä¸º <span class="math inline">\(100ug/\sqrt{hz}\)</span> åˆ™å¯¹äº 1kz çš„é‡‡æ ·ç‡åˆ™ä¸º <span class="math inline">\(100ug * \sqrt{1000}\)</span> , ä½†æ˜¯è¿™ä¸ªå€¼ä¸èƒ½ç›´æ¥ä½œä¸ºåŠ é€Ÿåº¦è®¡çš„è§‚æµ‹å™ªå£°ï¼Œè¿˜è¦çœ‹å…·ä½“åœºæ™¯ï¼ŒåŠ é€Ÿåº¦è®¡çš„å¹³ç§»è¿åŠ¨ä¼šäº§ç”ŸåŠ é€Ÿåº¦å€¼ï¼Œè€Œè¿™ä¸ªå€¼å¯¹è®¡ç®—è§’åº¦æ¥è®²å°±æ˜¯å™ªå£°ï¼Œæ‰€ä»¥å¯¹äºæœ¬ç³»ç»Ÿ <span class="math inline">\(R\)</span> ä¸ä»…ä»…æ˜¯ä¼ æ„Ÿå™¨æœ¬èº«è¯¯å·®ï¼ŒåŒæ—¶è¿˜åŒ…æ‹¬ IMU çš„å¹³ç§»è¿åŠ¨äº§ç”Ÿçš„è¯¯å·®ã€‚åœ¨ä¸€ä¸ªéå¸¸å¹³ç¨³çš„ç³»ç»Ÿä¸­åŠ é€Ÿåº¦è®¡çš„å„è½´å¹³ç§»åŠ é€Ÿåº¦éå¸¸å°ï¼Œç”šè‡³å¯ä»¥å¿½ç•¥ï¼Œæ­¤æ—¶åŠ é€Ÿåº¦è®¡çš„å™ªå£°æ˜¯éå¸¸å°çš„å¯ä»¥è¿‘ä¼¼ç­‰äºä¼ æ„Ÿå™¨æµ‹é‡å™ªå£°ï¼Œç›¸ååœ¨ä¸€ä¸ªéœ‡åŠ¨é¢‘ç‡å¾ˆé«˜çš„åœºæ™¯ä¸‹ï¼ŒåŠ é€Ÿåº¦è®¡çš„å¹³ç§»åŠ é€Ÿåº¦å°±éå¸¸å¤§ï¼Œè¿™ä¸ªæ—¶å€™<span class="math inline">\(R\)</span>çš„å–å€¼å°±åº”è¯¥æ¯”ä¼ æ„Ÿå™¨çš„æœ¬èº«è¯¯å·®å¤§å¾ˆå¤šã€‚æ‰‹å†Œä¸Šçš„è¯¯å·®å€¼ä»£è¡¨äº†æœ€ç†æƒ³æƒ…å†µä¸‹çš„è¯¯å·®ï¼Œå®é™…ç³»ç»Ÿä¸­åº”è¯¥æ ¹æ®å…·ä½“æƒ…å†µå»è°ƒæ•´è¿™ä¸ªå€¼ã€‚ æ•´ä½“è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œ<span class="math inline">\(R\)</span>å€¼çš„é€‰å–è·Ÿæ”¶æ•›é€Ÿåº¦ç›¸å…³ï¼Œè¯¥å€¼å–çš„å¾ˆå°åˆ™æ”¶æ•›é€Ÿåº¦è¶Šå¿«ï¼Œå› ä¸ºé•¿æœŸæ¥çœ‹æ»¤æ³¢çš„å€¼æ˜¯åƒåŠ é€Ÿåº¦è®¡çš„å€¼è¿›è¡Œæ”¶æ•›çš„ï¼Œå¯¹åŠ é€Ÿåº¦çš„ä¿¡ä»»åº¦è¶Šé«˜åˆ™æ”¶æ•›è¶Šå¿«åä¹‹åˆ™æ”¶æ•›è¶Šæ…¢ï¼Œä½†æ˜¯å¯¹åŠ é€Ÿåº¦è®¡çš„ä¿¡ä»»åº¦è¶Šé«˜å°±ä¼šå¯¼è‡´æ»¤æ³¢æ•ˆæœä¸å¥½æœ‰æ¯›åˆºï¼Œ<span class="math inline">\(Q\)</span>å’Œ<span class="math inline">\(R\)</span>çš„å€¼å…±åŒå†³å®šäº†æ»¤æ³¢æ•ˆæœã€‚åœ¨å®é™…çš„è°ƒå‚è¿‡ç¨‹ä¸­å°†åŠ é€Ÿåº¦è®¡çš„æ›²çº¿å’Œæ»¤æ³¢çš„æ›²çº¿åŒæ—¶è¾“å‡ºï¼Œå¯¹æ¯”ä¸¤æ¡æ›²çº¿çš„å…³ç³»å°±å¯ä»¥çœ‹åˆ°æ»¤æ³¢çš„å¹³æ»‘ç¨‹åº¦ä»¥åŠæ”¶æ•›é€Ÿåº¦äº†ã€‚å…·ä½“æ•ˆæœå¯ä»¥ä»¥ç¼“æ…¢æ—‹è½¬ IMUï¼Œå¿«é€Ÿæ—‹è½¬ IMUï¼Œä¸åšæ—‹è½¬è€Œå·¦å³æ™ƒåŠ¨ IMU æ¥çœ‹æ»¤æ³¢åçš„å€¼æ˜¯å¦æ˜¯æˆ‘ä»¬æœŸæœ›çš„ã€‚</p><h2 id="mahony-æ»¤æ³¢">mahony æ»¤æ³¢</h2><h3 id="é™€èºä»ªæ¨¡å‹">é™€èºä»ªæ¨¡å‹</h3><p><span class="math display">\[\omega = \hat{\omega} + b_g + n_g\]</span></p><p>è¿™é‡Œï¼Œ <span class="math inline">\(\omega\)</span> æ˜¯é™€èºä»ªæµ‹å¾—çš„è§’é€Ÿåº¦ï¼Œ <span class="math inline">\(\hat{\omega}\)</span> æ˜¯æˆ‘ä»¬å¸Œæœ›æ¢å¤çš„æ½œåœ¨ç†æƒ³è§’é€Ÿåº¦ï¼Œ <span class="math inline">\(b_g\)</span> é™€èºä»ªåå·®ä¼šéšæ—¶é—´å’Œæ¸©åº¦ç­‰å…¶ä»–å› ç´ è€Œå˜åŒ–ï¼Œ <span class="math inline">\(n_g\)</span>æ˜¯é™€èºä»ªé«˜æ–¯ç™½å™ªå£°ã€‚</p><h3 id="åŠ é€Ÿåº¦è®¡æ¨¡å‹">åŠ é€Ÿåº¦è®¡æ¨¡å‹</h3><p><span class="math display">\[a = R^{T}(\hat{a} - g) + b_a + n_a\]</span></p><p>è¿™é‡Œ<span class="math inline">\(a\)</span>æ˜¯åŠ é€Ÿåº¦æµ‹é‡å€¼ï¼Œ<span class="math inline">\(\hat{a}\)</span> æ˜¯åŠ é€Ÿåº¦çœŸå®å€¼ï¼Œ<span class="math inline">\(R\)</span>æ˜¯ä¼ æ„Ÿå™¨åœ¨ä¸–ç•Œåæ ‡ç³»ä¸‹çš„è½¬æ¢çŸ©é˜µï¼Œ<span class="math inline">\(g\)</span> æ˜¯é‡åŠ›åŠ é€Ÿåº¦ï¼Œ <span class="math inline">\(b_a\)</span> æ˜¯éšæ—¶é—´å’Œæ¸©åº¦ç­‰å…¶ä»–å› ç´ è€Œå˜åŒ–çš„ acc åå·®ï¼Œ <span class="math inline">\(n_a\)</span> æ˜¯ç™½è‰²é«˜æ–¯ acc å™ªå£°ã€‚</p><h3 id="mahony-ç®—æ³•æµç¨‹">Mahony ç®—æ³•æµç¨‹</h3><p>åœ¨å¼€å§‹è®¨è®º mahony æ»¤æ³¢å™¨å…¬å¼ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ­£å¼å®šä¹‰å°†è¦ä½¿ç”¨çš„åæ ‡è½´ã€‚è®© <span class="math inline">\(I,W,B\)</span> åˆ†åˆ«è¡¨ç¤ºæƒ¯æ€§ï¼Œä¸–ç•Œå’Œæœºä½“åæ ‡ç³»ã€‚é€šå¸¸ <span class="math inline">\(B\)</span> å’Œ <span class="math inline">\(I\)</span> æ˜¯ç›¸åŒçš„ã€‚ä¸‹æ ‡è¡¨ç¤ºæºåæ ‡ç³»ï¼Œä¸Šæ ‡è¡¨ç¤ºç›®çš„åæ ‡ç³»ã€‚ä¸‹å›¾æ˜¯ mahony æ»¤æ³¢å™¨çš„ä¸»è¦æµç¨‹ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/mahony.png"></p><h4 id="æ­¥éª¤ä¸€è·å–ä¼ æ„Ÿå™¨å€¼">æ­¥éª¤ä¸€ï¼šè·å–ä¼ æ„Ÿå™¨å€¼</h4><p>ä»ä¼ æ„Ÿå™¨è·å–é™€èºä»ªå’Œ acc æµ‹é‡å€¼ã€‚è®© <span class="math inline">\(I_{w_t}\)</span> å’Œ <span class="math inline">\(I_{a_t}\)</span> åˆ†åˆ«è¡¨ç¤ºé™€èºä»ªå’Œ acc æµ‹é‡å€¼ã€‚<span class="math inline">\(I_{\hat{a}_t}\)</span> è¡¨ç¤ºæ ‡å‡†åŒ–çš„ acc æµ‹é‡ã€‚ ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">recipNorm = invSqrt(ax * ax + ay * ay + az * az);</span><br><span class="line">ax *= recipNorm;</span><br><span class="line">ay *= recipNorm;</span><br><span class="line">az *= recipNorm;</span><br></pre></td></tr></tbody></table></figure><h4 id="æ­¥éª¤äºŒä½¿ç”¨-acc-æµ‹é‡è®¡ç®—è¯¯å·®">æ­¥éª¤äºŒï¼šä½¿ç”¨ acc æµ‹é‡è®¡ç®—è¯¯å·®</h4><p>æ ¹æ®å…ˆéªŒä¼°è®¡å€¼åˆ©ç”¨ acc è®¡ç®—è¯¯å·®ï¼š</p><p><span class="math display">\[\begin{aligned}&amp;v(\hat{_{I}^{W}\textrm{}q_{est}},t) = \begin{bmatrix}2(q_2q_4-q_1q_3)\\ 2(q_1q_2+q_3q_4)\\ (q_1^{2} - q_2^{2} - q_3^{2} + q_4^{2})\end{bmatrix} \\&amp;e_{t+1} = I_{\hat{a_{t+1}}} \times v(\hat{_{I}^{W}\textrm{}q_{est}},t) \\&amp;e_{i,t+1} = e_{i,t} + e_{t+1}\Delta t\end{aligned}\]</span></p><p><span class="math inline">\(\Delta t\)</span> æ˜¯é‡‡æ ·é—´éš”ï¼Œå³ t åˆ° t+1 çš„æ—¶é—´é—´éš”ã€‚çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ä¸€å¤´é›¾æ°´ï¼Œå½“æ—¶æˆ‘çœ‹åˆ°è¿™é‡Œæ˜¯å®Œå…¨æ²¡ææ‡‚è¿™æ˜¯ä»€ä¹ˆå•Šï¼Œæ²¡å…³ç³»ï¼Œè¿˜æœ‰æœ›ä¸åˆ°å°½å¤´çš„è·¯å­è¦èµ°å‘¢ï¼Œç»§ç»­ å…ˆæ”¾ä¸‹å‰é¢é‚£ä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼Œçœ‹ç‚¹ç®€å•çš„ä¸œè¥¿ï¼Œabout å¤æ•°å’Œå››å…ƒæ•° <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Image/imuCal.png"></p><p>å¦‚æœæœ‰ä¸€ä¸ªå¤æ•° <span class="math inline">\(z = a + bi\)</span>ï¼Œé‚£ä¹ˆ <span class="math inline">\(z\)</span> ä¸ä»»æ„ä¸€ä¸ªå¤æ•° <span class="math inline">\(c\)</span> ç›¸ä¹˜éƒ½ä¼šå°† <span class="math inline">\(c\)</span> é€†æ—¶é’ˆæ—‹è½¬ <span class="math inline">\(Î¸ = atan2(b, a)\)</span> åº¦ï¼Œå¹¶å°†å…¶ç¼©æ”¾ <span class="math inline">\(|z| = \sqrt{a^{2} + b^{2}}\)</span> å€ï¼å¦‚æœ <span class="math inline">\(|z| =1\)</span> é‚£ä¹ˆä¹…å®Œå…¨å˜æˆæ—‹è½¬äº†ï¼Œ<span class="math inline">\(z\)</span>ä¹Ÿå°±å˜æˆäº†æ—‹è½¬çŸ©é˜µå¦‚ä¸‹ï¼š</p><p><span class="math display">\[z = \begin{bmatrix}cos(\theta ) &amp;-sin(\theta) \\ sin(\theta)&amp; cos(\theta)\end{bmatrix}\]</span></p><p>åˆ™å¯¹åº”çš„æ—‹è½¬å…¬å¼ï¼ˆçŸ©é˜µå‹ï¼‰å¦‚ä¸‹ï¼š</p><p><span class="math display">\[{v}' = \begin{bmatrix}cos(\theta ) &amp;-sin(\theta) \\ sin(\theta)&amp; cos(\theta)\end{bmatrix} v\]</span></p><p>å…¶ä¸­ z å¯ä»¥ç”¨å¤æ•°å½¢å¼æ¥è¡¨ç¤ºå³<span class="math inline">\(z = x + yi\)</span>æ„é€ ä¸€ä¸ª<span class="math inline">\(z = cos(\theta) + sin(\theta)i\)</span>å¤æ•°ï¼Œåˆ™æ—‹è½¬å¯ä»¥è¡¨ç¤ºä¸º</p><p><span class="math display">\[{v}' = zv = (cos(\theta) + i sin(\theta))v\]</span></p><p>è¿™æ˜¯äºŒç»´çš„æƒ…å†µï¼Œæ¨å¹¿åˆ° 3D ç©ºé—´ä¸­ä»»æ„ä¸€ä¸ª <span class="math inline">\(v\)</span> æ²¿ç€å•ä½å‘é‡ <span class="math inline">\(u\)</span> æ—‹è½¬ <span class="math inline">\(Î¸\)</span> è§’åº¦ä¹‹åçš„ vâ€² ä¸ºï¼š</p><p><span class="math display">\[vâ€² = cos(Î¸)v + (1 âˆ’ cos(Î¸))(u Â· v)u + sin(Î¸)(u Ã— v)\]</span></p><p>æ¥ç€ç»™å‡ºå››å…ƒæ•°æ—‹è½¬å…¬å¼ä»»æ„å‘é‡ <span class="math inline">\(v\)</span> æ²¿ç€ä»¥å•ä½å‘é‡å®šä¹‰çš„æ—‹è½¬è½´ <span class="math inline">\(u\)</span> æ—‹è½¬ <span class="math inline">\(Î¸\)</span> åº¦ä¹‹åçš„ <span class="math inline">\(vâ€²\)</span> å¯ä»¥ä½¿ç”¨å››å…ƒæ•° ä¹˜æ³•æ¥è·å¾—ï¼ä»¤ <span class="math inline">\(v = [0, v]ï¼Œq = \begin{bmatrix}cos(\frac{1}{2}\theta ), sin(\frac{1}{2}\theta )u \end{bmatrix}\)</span>ï¼Œé‚£ä¹ˆï¼š</p><p><span class="math display">\[{v}' = qvq^{*} = qvq^{-1}\]</span></p><p>æ¢å¥è¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ <span class="math inline">\(q = [cos(Î¸), sin(Î¸)u]\)</span>ï¼Œé‚£ä¹ˆ <span class="math inline">\(vâ€² = qvq^{*}\)</span> å¯ä»¥å°† <span class="math inline">\(v\)</span> æ²¿ç€ <span class="math inline">\(u\)</span> æ—‹ è½¬ <span class="math inline">\(2Î¸\)</span> åº¦ã€‚å†™ä¸ºçŸ©é˜µå½¢å¼å¦‚ä¸‹ï¼š ä»»æ„å‘é‡ <span class="math inline">\(v\)</span> æ²¿ç€ä»¥å•ä½å‘é‡å®šä¹‰çš„æ—‹è½¬è½´ <span class="math inline">\(u\)</span> æ—‹è½¬ <span class="math inline">\(Î¸\)</span> è§’åº¦ä¹‹åçš„ <span class="math inline">\(vâ€²\)</span> å¯ä»¥ä½¿ç”¨çŸ©é˜µ ä¹˜æ³•æ¥è·å¾—ï¼ä»¤ <span class="math inline">\(a =cos(\frac{1}{2}\theta ), b = sin(\frac{1}{2}\theta )u_x, c = sin(\frac{1}{2}\theta )u_y, d = sin(\frac{1}{2}\theta )u_z\)</span> é‚£ä¹ˆï¼š</p><p><span class="math display">\[{v}' = \begin{bmatrix}1-2c^2-2d^2 &amp; 2bc - 2ad &amp; 2ac+2bd \\ 2bc+2ad &amp; 1-2b^2-2d^2  &amp;2cd - 2ab \\ 2bd-2ac &amp; 2ad+2cd  &amp; 1-2b^2-2c^2 \end{bmatrix}v\]</span></p><p>å…¶ä¸­è¿™é‡Œçš„å››å…ƒæ•°æ˜¯å½’ä¸€åŒ–å››å…ƒæ•°å³<span class="math inline">\(1 = q_1^2 + q_2^2 + q_3^2 + q_4^2\)</span>å¹¶ç”¨æ›´é€šç”¨çš„ç¬¦å·æ¥è¡¨ç¤ºåˆ™ä¸Šé¢å¼å­å¯ä»¥å†™ä¸ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[v = \begin{bmatrix}q_1^2 + q_2^2 -q_3^2 -q_4^2 &amp;2(q_2q_3 - q_1q_4)  &amp;2(q_2q_4 + q_1q_3) \\ 2(q_2q_3 + q_1q_4) &amp; q_1^2 - q_2^2 + q_3^2 -q_4^2  &amp; 2(q_3q_4 - q_1q_2) \\ 2(q_2q_4 - q_1q_3)&amp; 2(q_3q_4 + q_1q_2)  &amp; q_1^2 - q_2^2 -q_3^2 +q_4^2 \end{bmatrix}v\]</span></p><p>è¿™é‡Œå…¶å®æ˜¯çœç•¥äº†ç›¸å…³æ¨å¯¼ï¼Œå…¶ä¸­çš„è¯¦ç»†æ¨å¯¼è¿‡ç¨‹æˆ‘ä¼šåœ¨ä¸‹é¢ç»™å‡ºé“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨è¿™äº›å·²çŸ¥çš„ç»“è®ºï¼Œä¸ç„¶ä¸œè¥¿å¤ªå¤šï¼Œçœ‹ç€å¤ªç´¯ï¼ˆå…¶å®æ˜¯å†™èµ·æ¥å¤ªç´¯ï¼‰ã€‚åˆ°è¿™é‡Œå…¶å®åªæ˜¯åˆ—å‡ºäº†å››å…ƒæ•°çš„æ—‹è½¬å…¬å¼ï¼Œå¥½å›åˆ°å‰é¢ç¬¬äºŒæ­¥ä¸­æˆ‘ä»¬é‚£ä¸ªå…¬å¼æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Œä¸‹é¢çœ‹æœºä½“åæ ‡ç³»ä¸‹çš„é‡åŠ›è¡¨ç¤ºï¼Œå°†æœºä½“åæ ‡ç³»çš„ä¸‰è½´åˆ†é‡é€šè¿‡æ—‹è½¬çŸ©é˜µçš„æ—‹è½¬åå°±æ˜¯åœ°ç†åæ ‡ç³»ä¸‹çš„é‡åŠ›åˆ†é‡è¡¨ç¤ºã€‚è€Œæˆ‘ä»¬è¿™é‡Œçš„æ—‹è½¬çŸ©é˜µæ˜¯æ­£äº¤çŸ©é˜µå³ <span class="math inline">\(M*M^T = I\)</span>åˆ™æœ‰<span class="math inline">\(g = M*\hat{g}\)</span> åˆ™ <span class="math inline">\(\hat{g} = M^T * g\)</span> å±•å¼€äº†å†™å°±æ˜¯å¦‚ä¸‹å½¢å¼</p><p><span class="math display">\[\begin{aligned}\hat{g} &amp;= \begin{bmatrix}q_1^2 + q_2^2 -q_3^2 -q_4^2 &amp;2(q_2q_3 - q_1q_4)  &amp;2(q_2q_4 + q_1q_3) \\ 2(q_2q_3 + q_1q_4) &amp; q_1^2 - q_2^2 + q_3^2 -q_4^2  &amp; 2(q_3q_4 - q_1q_2) \\ 2(q_2q_4 - q_1q_3)&amp;2(q_3q_4 + q_1q_2)  &amp; q_1^2 - q_2^2 -q_3^2 +q_4^2 \end{bmatrix}' * \begin{bmatrix}0\\ 0\\ 1\end{bmatrix} \\&amp;=\begin{bmatrix}2(q_2q_4 - q_1q_3)\\  2(q_3q_4 + q_1q_2)\\ q_1^2 - q_2^2 -q_3^2 +q_4^2\end{bmatrix}\end{aligned}\]</span></p><p>è¿™å°±æ˜¯ä¸Šé¢æˆ‘ä»¬ç¬¬äºŒæ­¥ä¸­çš„å…¬å¼ï¼Œåœ¨è‡ªç„¶åæ ‡ç³»ä¸‹çš„æœºä½“ä¸‰è½´è¡¨ç¤ºã€‚å†™æˆä»£ç å°±æ˜¯å¦‚ä¸‹ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Estimated direction of gravity and vector perpendicular to magnetic flux</span><br><span class="line">halfvx = imu-&gt;q1 * imu-&gt;q3 - imu-&gt;q0 * imu-&gt;q2;</span><br><span class="line">halfvy = imu-&gt;q0 * imu-&gt;q1 + imu-&gt;q2 * imu-&gt;q3;</span><br><span class="line">//halfvz = imu-&gt;q0 * imu-&gt;q0 - 0.5f + imu-&gt;q3 * imu-&gt;q3;</span><br><span class="line">halfvz = imu-&gt;q0 * imu-&gt;q0 - imu-&gt;q1 * imu-&gt;q1 - imu-&gt;q2 * imu-&gt;q2 + imu-&gt;q3 * imu-&gt;q3;</span><br></pre></td></tr></tbody></table></figure> è¿™ç¬¬äºŒæ­¥è¿˜æ²¡å®Œï¼Œåé¢è¿˜ä¸¤ä¸ªå…¬å¼å‘¢ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªå…¬å¼<p></p><p><span class="math display">\[e_{t+1} = I_{\hat{a_{t+1}}} \times v(\hat{_{I}^{W}\textrm{}q_{est}},t)\]</span></p><p>è¿™ä¸€æ­¥å°†åŠ é€Ÿåº¦è®¡è·å–çš„æ•°æ®ä¸é™€èºä»ªå‡†ç¡®æ¥è®²æ˜¯é¢„æµ‹å€¼è¿›è¡Œå‰ä¹˜ï¼Œæ¥è¡¨ç¤ºé™€èºä»ªä¸åŠ é€Ÿåº¦è®¡çš„è¯¯å·®ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡å‰ä¹˜å¾—åˆ°è¯¯å·®å‘¢ï¼Œå…¶å®æ˜¯å­˜ç–‘çš„ï¼Œå‘é‡çš„å‰ä¹˜ç»“æœè·Ÿä¸¤ä¸ªå‘é‡çš„å¤¹è§’å’Œæ¨¡é•¿ç›¸å…³ï¼Œè¿™é‡Œ acc ä¸ gyro çš„æ•°æ®å¦‚æœæ˜¯ç›¸åŒçš„é‚£ä¹ˆä»–ä»¬ä¹‹é—´çš„å¤¹è§’ä¸º 0 åˆ™ <span class="math inline">\(sin(\theta) = 0\)</span> ä¸¤ä¸ªå‘é‡çš„å‰ç§¯ä¸º 0 å‘é‡ï¼Œè€Œ acc å’Œ gyro ä¸åŒåˆ™ä¸¤ä¸ªå‘é‡ä¸åŒä½†æ˜¯ç¬”è€…è®¤ä¸ºä¸¤è€…ä¸èƒ½è§†ä¸ºçº¿æ€§å…³ç³»ï¼Œå‰ä¹˜çš„å¤§å°å¯ä»¥ç”¨æ¥è¡¨ç¤º acc ä¸ gyro çš„è¯¯å·®å¤§å°ï¼Œè€Œè¿™ä¸ªè®¡ç®—æ°å¥½ç”¨äº pi è°ƒèŠ‚å™¨æ¥è°ƒèŠ‚ gyro çš„æ•°æ®ã€‚åˆ°ç°åœ¨è¯¯å·®ä¹Ÿå‡ºæ¥äº†ä¸¤ä¸ªå‘é‡çš„å‰ä¹˜ï¼Œå– <span class="math inline">\(z_1 = a + bi z_2 = c + di\)</span> åˆ™ä¸¤ä¸ªå‘é‡å‰ä¹˜ç»“æœä¸ºï¼š</p><p><span class="math display">\[\begin{aligned}z_1\times z_2 &amp;= \begin{bmatrix}a &amp;-b \\ b &amp; a\end{bmatrix}  \times \begin{bmatrix}c &amp;-d \\ d &amp; c\end{bmatrix} \\&amp;= \begin{bmatrix}ac-bd &amp;-(bc + ad) \\ bc + ad &amp; ac-bd\end{bmatrix}\end{aligned}\]</span></p><p>å†™ä¸ºä»£ç å°±æ˜¯ä¸‹é¢ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Error is <span class="built_in">sum</span> of cross product between estimated and measured direction of gravity</span><br><span class="line">halfex = (ay * halfvz - az * halfvy);</span><br><span class="line">halfey = (az * halfvx - ax * halfvz);</span><br><span class="line">halfez = (ax * halfvy - ay * halfvx);</span><br></pre></td></tr></tbody></table></figure> ç¬¬ä¸‰ä¸ªå…¬å¼å°±æ¯”è¾ƒç®€å•äº†å¯¹è¯¯å·®è¿›è¡Œç´¯è®¡ï¼Œè¿™é‡Œä»£ç è·Ÿä¸‹é¢ç¬¬ä¸‰æ­¥æ”¾åˆ°ä¸€èµ·ã€‚ç¬¬äºŒæ­¥å®Œã€‚..<p></p><h4 id="æ­¥éª¤ä¸‰å¯¹è¯¯å·®è¿›è¡Œ-pi-è°ƒèŠ‚å™¨è°ƒèŠ‚">æ­¥éª¤ä¸‰ï¼šå¯¹è¯¯å·®è¿›è¡Œ PI è°ƒèŠ‚å™¨è°ƒèŠ‚</h4><p><span class="math display">\[I{w_{t+1}} = I{w_{t+1}} + K_p * e_{t+1} K_i * e_{i,t+1}\]</span></p><p>è¿™ä¸ªå…¬å¼å¯¹äºæ¯”è¾ƒç†Ÿæ‚‰ pid ç®—æ³•çš„äººæ¥è®²åº”è¯¥æ˜¯è½»è€Œæ˜“ä¸¾çš„äº‹äº†å§ï¼Œå…³äº pid è°ƒèŠ‚è¿™é‡Œä¹Ÿä¸æ˜¯ä¸€ä¸¤å¥è¯å¯ä»¥è¯´çš„æ¸…æ¥šçš„ï¼Œåé¢ä¸“é—¨å†å†™ä¸€ç¯‡å…³äº pid è°ƒèŠ‚çš„æ–‡ç« å§ï¼Œåç»­ä¸€å®šä¼šç”¨åˆ°çš„ï¼Œè¿™é‡Œå…ˆå·ä¸‹æ‡’ï¼Œé€šä¿—ç‚¹å°†è¿™é‡Œå°±æ˜¯å¯¹è¯¯å·®è¿›è¡Œä¸€ä¸ªæ¯”ä¾‹æ‰©å¤§æˆ–ç¼©å°å³è¯¯å·®çš„ç§¯åˆ†ç´¯è®¡è¿ç®—ï¼Œè¿™ä¸ªé‡ä¼šç”¨äºè°ƒèŠ‚é™€èºä»ªçš„æ•°æ®ï¼Œä»¥çº æ­£é™€èºä»ªçš„ç´¯è®¡è¯¯å·®è®©é™€èºä»ªçš„æ•°æ®æœ€ç»ˆæ”¶æ•›äºåŠ é€Ÿåº¦è®¡æ•°æ®ã€‚ç…§ä¾‹è´´ä¸‹ä»£ç å¦‚ä¸‹ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// Compute and apply integral feedback <span class="keyword">if</span> enabled</span><br><span class="line"><span class="keyword">if</span>(twoKi &gt; 0.0f) {</span><br><span class="line">imu-&gt;integralFBx += twoKi * halfex * (1.0f / sampleFreq);// integral error scaled by Ki</span><br><span class="line">        imu-&gt;integralFBy += twoKi * halfey * (1.0f / sampleFreq);</span><br><span class="line">imu-&gt;integralFBz += twoKi * halfez * (1.0f / sampleFreq);</span><br><span class="line">gx += imu-&gt;integralFBx;// apply integral feedback</span><br><span class="line">gy += imu-&gt;integralFBy;</span><br><span class="line">gz += imu-&gt;integralFBz;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> {</span><br><span class="line">imu-&gt;integralFBx = 0.0f;// prevent integral windup</span><br><span class="line">imu-&gt;integralFBy = 0.0f;</span><br><span class="line">imu-&gt;integralFBz = 0.0f;</span><br><span class="line">}</span><br><span class="line">// Apply proportional feedback</span><br><span class="line">gx += twoKp * halfex;</span><br><span class="line">gy += twoKp * halfey;</span><br><span class="line">gz += twoKp * halfez;</span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="æ­¥éª¤å››å¯¹é™€èºä»ªæ•°æ®è¿›è¡Œç§¯åˆ†">æ­¥éª¤å››ï¼šå¯¹é™€èºä»ªæ•°æ®è¿›è¡Œç§¯åˆ†</h4><p>å‰é¢æˆ‘ä»¬å¯¹å§¿æ€è§’çš„å˜åŒ–é‡åŠ é€Ÿåº¦è¿›è¡Œ pi è°ƒèŠ‚å™¨çš„è°ƒèŠ‚åï¼ˆä½¿å…¶æ”¶æ•›äºåŠ é€Ÿåº¦è®¡è®¡ç®—çš„é‡åŠ›å‘é‡ï¼‰å°±å¯ä»¥è¿›è¡Œç§¯åˆ†äº†ï¼Œå…¶ç§¯åˆ†å°±æ¶‰åŠåˆ°å¾®åˆ†æ–¹ç¨‹çš„æ±‚è§£å’Œè¿ç®—ï¼Œä¸‹é¢ä¼šç»™å‡ºæ¨å¯¼æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>å››å…ƒæ•°å¾®åˆ†æ–¹ç¨‹ å®šä¹‰<span class="math inline">\(n\)</span>ä¸ºè‡ªç„¶åæ ‡ç³»ï¼Œ<span class="math inline">\(b\)</span>ä¸ºæœºä½“åæ ‡ç³»ï¼Œåˆ™<span class="math inline">\(n\)</span>ç³»åˆ°<span class="math inline">\(b\)</span>ç³»çš„æ—‹è½¬å››å…ƒæ•°ä¸ºï¼š</p><p><span class="math display">\[Q = cos( \frac{1}{2}\theta ) + sin(\frac{1}{2}\theta )u^n\]</span></p><p>å…¶ä¸­<span class="math inline">\(u^n\)</span>ä¸ºæ—‹è½¬è½´ï¼Œ$$ ä¸ºæ—‹è½¬è§’ã€‚ å°†å››å…ƒæ•° <span class="math inline">\(Q = cos(\frac{1}{2}\theta ) + sin(\frac{1}{2}\theta )u\)</span> å¯¹æ—¶é—´è¿›è¡Œå¾®åˆ†åˆ™ï¼š</p><p><span class="math display">\[Q  = cos(\frac{1}{2}\theta ) + sin(\frac{1}{2}\theta )u^n \\\frac{dQ}{dt} = -\frac{1}{2}sin(\frac{1}{2}\theta )\cdot \frac{d\theta }{dt} + \frac{du^n}{dt}\cdot sin(\frac{1}{2}\theta ) + u^n \cdot \frac{1}{2}cos(\frac{1}{2}\theta )\cdot \frac{d\theta }{dt}\]</span></p><p>å…¶ä¸­è¿™æ˜¯ä¸€ä¸ªæ—‹è½¬å››å…ƒæ•°ï¼Œå…¶æ—‹è½¬è½´æ˜¯å›ºå®šä¸å˜çš„ï¼Œå˜åŒ–çš„æ˜¯æ—‹è½¬è§’åº¦ï¼Œå› æ­¤ <span class="math inline">\(\frac{du^n}{dt} = 0\)</span> æ•…æœ‰ï¼š</p><p><span class="math display">\[\frac{dQ}{dt} = -\frac{1}{2}sin(\frac{1}{2}\theta ) \cdot \frac{d\theta }{dt} + u^n \cdot \frac{1}{2}cos(\frac{1}{2}\theta )\cdot \frac{d\theta }{dt}\]</span></p><p>ä¸¤è¾¹éƒ½ä¹˜ä»¥ <span class="math inline">\(\frac{1}{2} u^n \frac{d\theta }{dt}\)</span> å¾—ï¼š</p><p><span class="math display">\[\begin{aligned}\frac{1}{2} u^n \frac{d\theta }{dt} \otimes Q &amp;= \frac{1}{2} u^n \frac{d\theta }{dt} * (cos(\frac{\theta }{2}) + sin(\frac{\theta }{2}) u^n) \\&amp; = \frac{\dot{\theta }}{2}cos(\frac{\theta }{2})u^n + u^n \otimes  u^n \frac{\dot{\theta }}{2}sin(\frac{\theta }{2})r\end{aligned}\]</span></p><p>å…¶ä¸­ $u^n u^n = -1 $ å¾—ï¼š</p><p><span class="math display">\[\begin{aligned}\frac{1}{2} u^n \frac{d\theta }{dt} \otimes Q =  \frac{\dot{\theta }}{2}cos(\frac{\theta }{2})u^n - \frac{\dot{\theta }}{2}sin(\frac{\theta }{2})r\end{aligned}\]</span></p><p>è¿™ä¸ªç»“æœä¸ä¸Šé¢æ¨å¯¼çš„ <span class="math inline">\(\frac{dQ}{dt}\)</span> æ˜¯ä¸æ˜¯ä¸€æ ·çš„ï¼Œäºæ˜¯ <span class="math inline">\(\frac{dQ}{dt}\)</span> å¯ä»¥å†™ä¸ºå¦‚ä¸‹ï¼š</p><p><span class="math display">\[\frac{dQ}{dt} = \frac{1}{2} u^n \frac{d\theta }{dt} \otimes Q = \frac{1}{2} w_{nb}^{n}\otimes Q\]</span></p><p>å¼ä¸­ <span class="math inline">\(w_{nb}^{n}\)</span> æ˜¯è‡ªç„¶åæ ‡ç³»ä¸‹è§’é€Ÿåº¦ï¼Œè€Œ IMU è·å¾—çš„è§’é€Ÿåº¦æ˜¯æœºä½“åæ ‡ç³»ä¸‹çš„è§’é€Ÿåº¦ï¼Œå› æ­¤éœ€è¦è½¬æ¢ä¸€ä¸‹å¦‚ä¸‹ï¼š</p><p><span class="math display">\[r^n = Q  \otimes r^b  \otimes Q^*\]</span></p><p>å¸¦å…¥ä¸Šå¼å¾—ï¼š</p><p><span class="math display">\[\frac{dQ}{dt} = \frac{1}{2}  Q  \otimes w_{nb}^{b}  \otimes Q^* \otimes Q\]</span></p><p>å¯¹äºå•ä½å››å…ƒæ•°æœ‰ï¼š<span class="math inline">\(Q^* \otimes Q = 1\)</span> åˆ™ï¼š</p><p><span class="math display">\[\frac{dQ}{dt} =  \frac{1}{2}  Q  \otimes w_{nb}^b\]</span></p><p>å…¶ä¸­ <span class="math inline">\(w_{nb}^{b}\)</span> ä¸ºé™€èºä»ªæµ‹é‡æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p><p><span class="math display">\[w_{nb}^{b} = \begin{bmatrix}0\\ w_x\\ w_y\\ w_z\end{bmatrix}\]</span></p><p>ç”±å››å…ƒæ•°ä¹˜æ³•å…¬å¼å¯ä»¥å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{bmatrix}\dot{q_0}\\ \dot{q_1}\\ \dot{q_2}\\ \dot{q_3}\end{bmatrix} = \frac{1}{2}\begin{bmatrix}q_0 &amp; -q_1 &amp; -q_2 &amp; -q_3 \\q_1 &amp; q_0 &amp; -q_3 &amp; q_2 \\q_2 &amp; q_3 &amp; q_0 &amp; -q_1 \\q_3 &amp; -q_2 &amp; q_1 &amp; q_0\end{bmatrix} * \begin{bmatrix}{0}\\ w_x\\ {w_y}\\ {w_z}\end{bmatrix}\]</span></p><p>æˆ–è€…ï¼š</p><p><span class="math display">\[\begin{bmatrix}\dot{q_0}\\ \dot{q_1}\\ \dot{q_2}\\ \dot{q_3}\end{bmatrix} =  \frac{1}{2}\begin{bmatrix}0 &amp; -w_x &amp; -w_y&amp; -w_z \\w_x&amp; 0 &amp; w_z&amp; -w_y \\w_y&amp; -w_z&amp; 0 &amp; w_x \\w_z&amp; w_y&amp; -w_x&amp; 0\end{bmatrix} * \begin{bmatrix}{q_0}\\ q_1\\ {q_2}\\ {q_3}\end{bmatrix}\]</span></p><p>å‰©ä¸‹çš„å°±æ˜¯æ±‚è§£å››å…ƒæ•°å¾®åˆ†æ–¹ç¨‹äº†ï¼Œæ±‚è§£æ–¹æ³•æœ‰æ¬§æ‹‰æ–¹æ³•ã€æ¯•å¡ç®—æ³•ï¼Œé¾™æ ¼åº“å¡”æ³•ï¼Œå…¶ä¸­å¸¸ç”¨çš„æ˜¯é¾™æ ¼åº“å¡”æ³•æ±‚è§£ï¼Œé‡‡ç”¨ä¸€é˜¶é¾™æ ¼åº“å¡”æ³•è§£ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š ä¸€é˜¶é¾™æ ¼åº“å¡”å…¬å¼ <span class="math inline">\(y_{n+1} = y_n + h \cdot y^{'}\)</span> å…¶ä¸­ h ä¸ºæ­¥é•¿ï¼Œ$y^{'} $ ä¸ºæ–œç‡ã€‚åˆ™å¾®åˆ†æ–¹ç¨‹ $ = f(t,Q) $ å¯ä»¥å†™ä¸ºï¼š</p><p><span class="math display">\[Q(t+\triangle t) = Q(t) + \triangle t \frac{dQ}{dt}\]</span></p><p>æ•…å¯ä»¥å¾—åˆ°ï¼š</p><p><span class="math display">\[\begin{bmatrix}{q_0}\\ q_1\\ {q_2}\\ {q_3}\end{bmatrix}_{t+\triangle t } = \begin{bmatrix}{q_0}\\ q_1\\ {q_2}\\ {q_3}\end{bmatrix}_{t } + \frac{\triangle t }{2} * \begin{bmatrix}0 &amp; -w_x &amp; -w_y&amp; -w_z \\w_x&amp; 0 &amp; w_z&amp; -w_y \\w_y&amp; -w_z&amp; 0 &amp; w_x \\w_z&amp; w_y&amp; -w_x&amp; 0\end{bmatrix} * \begin{bmatrix}{q_0}\\ q_1\\ {q_2}\\ {q_3}\end{bmatrix}_{t}\]</span></p><p>å†™ä¸ºä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Integrate rate of change of quaternion</span><br><span class="line">gx *= (0.5f * (1.0f / sampleFreq));// pre-multiply common factors</span><br><span class="line">gy *= (0.5f * (1.0f / sampleFreq));</span><br><span class="line">gz *= (0.5f * (1.0f / sampleFreq));</span><br><span class="line">qa = q0;</span><br><span class="line">qb = q1;</span><br><span class="line">qc = q2;</span><br><span class="line">q0 += (-qb * gx - qc * gy - q3 * gz);</span><br><span class="line">q1 += (qa * gx + qc * gz - q3 * gy);</span><br><span class="line">q2 += (qa * gy - qb * gz + q3 * gx);</span><br><span class="line">q3 += (qa * gz + qb * gy - qc * gx);</span><br></pre></td></tr></tbody></table></figure><p>æœ€åå†å¯¹å››å…ƒæ•°è¿›è¡Œå½’ä¸€åŒ–ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Normalise quaternion</span><br><span class="line">recipNorm = invSqrt(q0 * q0 + q1 * q1 + q2 * q2 + q3 * q3);</span><br><span class="line">q0 *= recipNorm;</span><br><span class="line">q1 *= recipNorm;</span><br><span class="line">q2 *= recipNorm;</span><br><span class="line">q3 *= recipNorm;</span><br></pre></td></tr></tbody></table></figure><p>è‡³æ­¤æ‰€æœ‰ç†è®ºæ¨å¯¼éƒ½å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸åœçš„å¾ªç¯ä¸Šé¢çš„æ­¥éª¤å°±å¾—åˆ°äº†å››å…ƒæ•°ï¼Œå‰©ä¸‹çš„ä»»åŠ¡å°±æ˜¯å°†å››å…ƒæ•°è½¬ä¸ºæ¬§æ‹‰è§’äº†ï¼Œè¿™é‡Œè½¬æ¬§æ‹‰è§’é‡Œé¢ä¹Ÿæ˜¯æœ‰å‘çš„ï¼Œéœ€è¦è€ƒè™‘æ¬§æ‹‰è§’çš„å¥‡å¼‚æ€§ï¼Œåœ¨è½¬åŒ–çš„è¿‡ç¨‹ä¸­è¦æ³¨æ„å¯¹æ¬§æ‹‰è§’çš„å¥‡å¼‚æ€§è¿›è¡Œè€ƒè™‘å°±å¯ä»¥äº†ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p><span class="exturl" data-url="aHR0cDovL2ZpbGUuZWxlY2ZhbnMuY29tL3dlYjEvTTAwLzdGLzg5L280WUJBRndub0oyQUdkanBBQ0FYaDdKRS1fSTAwNS5wZGY=">http://file.elecfans.com/web1/M00/7F/89/o4YBAFwnoJ2AGdjpACAXh7JE-_I005.pdf<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9rcmFzamV0LmdpdGh1Yi5pby9xdWF0ZXJuaW9uL3F1YXRlcm5pb24ucGRm">https://krasjet.github.io/quaternion/quaternion.pdf<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDM2MjM4Nzk=">https://zhuanlan.zhihu.com/p/103623879<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NTY4MTgwNw==">https://zhuanlan.zhihu.com/p/55681807<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly94LWlvLmNvLnVrL29wZW4tc291cmNlLWltdS1hbmQtYWhycy1hbGdvcml0aG1zLw==">https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9uaXRpbmpzYW5rZXQuZ2l0aHViLmlvL3R1dG9yaWFscy9hdHRpdHVkZWVzdC9tYWhvbnk=">https://nitinjsanket.github.io/tutorials/attitudeest/mahony<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5iemFyZy5jb20vcC9ob3ctYS1rYWxtYW4tZmlsdGVyLXdvcmtzLWluLXBpY3R1cmVzLw==">http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Nhcmx5bGVMaXUvS2FsbWFuRmlsdGVy">https://github.com/CarlyleLiu/KalmanFilter<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Image </category>
          
          <category> Stabilization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Robot </tag>
            
            <tag> IMU </tag>
            
            <tag> EIS </tag>
            
            <tag> Image </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Buildroot å¸¸è§ç¼–è¯‘é”™è¯¯è®°å½•</title>
      <link href="/2019/Note/BuildrootCommonIssue/"/>
      <url>/2019/Note/BuildrootCommonIssue/</url>
      
        <content type="html"><![CDATA[<h1 id="openwrt-ç¼–è¯‘é”™è¯¯">openwrt ç¼–è¯‘é”™è¯¯</h1><p>you should not run configure as root (set FORCE_UNSAFE_CONFIGURE=1 in environment to bypass this check)</p><p>è§£å†³æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> FORCE_UNSAFE_CONFIGURE=<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h1 id="åˆ‡æ¢-gcc-ç‰ˆæœ¬">åˆ‡æ¢ gcc ç‰ˆæœ¬</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 20 --slave /usr/bin/g++ g++ /usr/bin/g++-9</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 30 --slave /usr/bin/g++ g++ /usr/bin/g++-11</span><br></pre></td></tr></tbody></table></figure><h1 id="buildroot-æŠ¥é”™">buildroot æŠ¥é”™ï¼š</h1><p>c-stack.c:55:26: error: missing binary operator before token</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å°† buildroot çš„ host-m4 ç‰ˆæœ¬å‡çº§ä¸€ä¸‹å°±å¯ä»¥ä½¿ç”¨</span><br><span class="line">A possible workaround is to configure buildroot to build host-m4 version 1.4.19 instead of 1.4.18, because it no longer uses SIGSTKSZ.</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹åï¼šm4.mk:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># m4</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line">M4_VERSION = 1.4.19</span><br><span class="line">M4_SOURCE = m4-$(M4_VERSION).tar.xz</span><br><span class="line">M4_SITE = $(BR2_GNU_MIRROR)/m4</span><br><span class="line">M4_LICENSE = GPL-3.0+</span><br><span class="line">M4_LICENSE_FILES = COPYING</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">eval</span> $(host-autotools-package))</span><br></pre></td></tr></tbody></table></figure><p>m4.hash:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Locally calculated after checking pgp signature</span></span><br><span class="line">sha256  63aede5c6d33b6d9b13511cd0be2cac046f2e70fd0a07aa9573a04a82783af96  m4-1.4.19.tar.xz</span><br><span class="line"><span class="comment"># License files, locally calculated</span></span><br><span class="line">sha256  3972dc9744f6499f0f9b2dbf76696f2ae7ad8af9b23dde66d6af86c9dfb36986  COPYING</span><br></pre></td></tr></tbody></table></figure><h1 id="æ ¹æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘æŠ¥é”™">æ ¹æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘æŠ¥é”™</h1><p>libfakeroot.c:99:40: error: â€˜_STAT_VER é—®é¢˜è§£å†³</p><p>ç”±äº fakeroot åˆ«äººä¿®å¤äº†ä¸€ä¸ª bugï¼ŒæŠŠ_STATA_VER åˆ æ‰äº†ï¼Œé‡æ–°æ‰“ä¸Šæœ€æ–°çš„è¡¥ä¸å³å¯ã€‚</p><h2 id="ä¸‹è½½æœ€æ–°è¡¥ä¸">ä¸‹è½½æœ€æ–°è¡¥ä¸</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXQuYnVzeWJveC5uZXQvYnVpbGRyb290L2NvbW1pdC8/aWQ9ZjQ1OTI1YTk1MTMxOGU5ZTUzYmVhZDgwYjM2M2UwMDQzMDFhZGM2Zg==">è®¿é—®è¿™ä¸ªé“¾æ¥<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXQuYnVzeWJveC5uZXQvYnVpbGRyb290L2NvbW1pdC8/aWQ9ZjQ1OTI1YTk1MTMxOGU5ZTUzYmVhZDgwYjM2M2UwMDQzMDFhZGM2Zg==">buildroot - Buildroot: Making Embedded Linux easy<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxBuild1.png"></p><p>è§£å‹è¿›å…¥å /package/fakeroot/ä¸‹ï¼Œå¤‡ä»½åŸæ¥è¡¥ä¸ï¼Œå¹¶æ›¿æ¢æˆç°åœ¨çš„ï¼ŒåŸæ¥è¡¥ä¸ç›®å½•</p><p><strong>usr/bin/ld: scripts/dtc/dtc-parser.tab.o:(.bss+0x10): multiple definition of â€˜yyllocâ€˜ï¼› scripts/dtc/d</strong></p><p>æ‰¾åˆ°å‡ºé”™çš„æºæ–‡ä»¶å¹¶åšå¦‚ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â€˜YYLTYPE yyllocâ€™ and change it to â€˜extern YYLTYPE yyllocâ€™</span><br></pre></td></tr></tbody></table></figure><p><strong>/usr/bin/ld: libsim.a(maverick.o):(.bss+0x60): multiple definition of `DSPregs';libsim.a(wrapper.o):(.bss+0x60): first defined here</strong></p><p>é—®é¢˜å·²ç»è§£å†³ï¼Œå‚è€ƒï¼š <span class="exturl" data-url="aHR0cHM6Ly9nbnV0b29sY2hhaW4tZ2Vycml0Lm9zY2kuaW8vci9jL2JpbnV0aWxzLWdkYi8lMmIvNzI2">https://gnutoolchain-gerrit.osci.io/r/c/binutils-gdb/%2b/726<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9nbnV0b29sY2hhaW4tZ2Vycml0Lm9zY2kuaW8vci9jL2JpbnV0aWxzLWdkYi8rLzcyNg==">https://gnutoolchain-gerrit.osci.io/r/c/binutils-gdb/+/726<i class="fa fa-external-link-alt"></i></span></p><p>æ·»åŠ  patch åé‡æ–°ç¼–è¯‘æ¨¡å—</p><h1 id="è§£å†³-python3-no-module-named-_sqlite3é”™è¯¯-å®‰è£…-sqlite3">è§£å†³ Python3 No module named '_sqlite3'é”™è¯¯ ## å®‰è£… sqlite3</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½å®‰è£…åŒ…ï¼šwget &lt;https://www.sqlite.org/2018/sqlite-autoconf-3240000.tar.gz&gt;</span><br><span class="line">è§£å‹ï¼štar -xvzf sqlite-autoconf-3240000.tar.gz</span><br><span class="line">è¿›å…¥ç›®å½•ï¼š<span class="built_in">cd</span> sqlite-autoconf-3240000/</span><br><span class="line">ç¼–è¯‘ï¼š./configure --prefix=/usr/local/sqlite</span><br><span class="line">å®‰è£… ï¼šmake -j4&amp;&amp;sudo make install</span><br></pre></td></tr></tbody></table></figure><h2 id="é‡æ–°å®‰è£…-python3">é‡æ–°å®‰è£… python3</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget &lt;https://www.python.org/ftp/python/3.8.8/Python-3.8.8.tgz&gt;</span><br><span class="line">tar xvf Python-3.8.8.tgz</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹ setup.py</span><br><span class="line">æŸ¥æ‰¾<span class="string">" sqlite_inc_paths"</span> æ–°å¢</span><br><span class="line"><span class="string">'/usr/local/sqlite/include'</span></span><br><span class="line"><span class="string">'/usr/local/sqlite/include/sqlite3'</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --enable-loadable-sqlite-extensions</span><br><span class="line">make &amp;&amp; sudo make install</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ‡æ¢-python3-ç‰ˆæœ¬">åˆ‡æ¢ python3 ç‰ˆæœ¬</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> /usr/bin/python</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/python3.8 /usr/bin/python</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> /usr/bin/python3</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/python3.8 /usr/bin/python3</span><br></pre></td></tr></tbody></table></figure><h2 id="warning-setlocale-lc_all-cannot-change-locale-en_us">warning: setlocale: LC_ALL: cannot change locale (en_US)</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get clean &amp;&amp; apt-get update &amp;&amp; apt-get install -y locales</span><br><span class="line">dpkg-reconfigure locales</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªæ—¶å€™åœ¨ Configuring localesï¼ˆé…ç½®åŒºåŸŸï¼‰ä¸‹æ–¹å°±çœ‹åˆ° en_US äº†ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œåªéœ€è¦æœ‰ en_US å°±è¡Œäº†ï¼Œå¹¶ä¸éœ€è¦å°†é»˜è®¤è®¾ç½®æ”¹æˆ en_USï¼›æŒ‰é”®ç›˜â†“ç®­å¤´å°†å…‰æ ‡ç§»åŠ¨åˆ° en_US.UTF-8 ä¸Šï¼Œç„¶åæŒ‰ TAB é”®å°†å…‰æ ‡ç§»åŠ¨åˆ° Ok æŒ‰é’®ä¸Šï¼Œå›è½¦ã€‚</p><p>æ‰§è¡Œ locale -a å‘½ä»¤æŸ¥çœ‹å·²ç»é…ç½®çš„åŒºåŸŸã€‚</p><h2 id="åˆ‡æ¢-python-ç‰ˆæœ¬">åˆ‡æ¢ python ç‰ˆæœ¬</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ whereis python</span><br><span class="line">$ <span class="built_in">rm</span> /usr/bin/python</span><br><span class="line">$ <span class="built_in">ln</span> -s /usr/bin/python3.10 /usr/bin/python</span><br></pre></td></tr></tbody></table></figure><h1 id="repo-æ›´æ–°ä»£ç æ˜¯æŠ¥é”™">repo æ›´æ–°ä»£ç æ˜¯æŠ¥é”™ï¼š</h1><p>ModuleNotFoundError: No module named â€˜formatterâ€˜**</p><p><span class="exturl" data-url="aHR0cHM6Ly9nZXJyaXQtcmV2aWV3Lmdvb2dsZXNvdXJjZS5jb20vYy9naXQtcmVwby8rLzMwMzI4Mg==">https://gerrit-review.googlesource.com/c/git-repo/+/303282<i class="fa fa-external-link-alt"></i></span></p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Buildroot</title>
      <link href="/2019/Note/Buildroot/"/>
      <url>/2019/Note/Buildroot/</url>
      
        <content type="html"><![CDATA[<h1 id="buildroot-é…ç½®">Buildroot é…ç½®</h1><h2 id="äº¤å‰ç¼–è¯‘å·¥å…·é“¾">äº¤å‰ç¼–è¯‘å·¥å…·é“¾</h2><p>Buildroot ä¸ºäº¤å‰ç¼–è¯‘å·¥å…·é“¾æä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>å†…éƒ¨å·¥å…·é“¾åç«¯ï¼Œåœ¨é…ç½®ç•Œé¢ä¸­è°ƒç”¨â€œBuildroot toolchainâ€</li><li>å¤–éƒ¨å·¥å…·é“¾åç«¯ï¼Œåœ¨é…ç½®ç•Œé¢ä¸­è°ƒç”¨â€œExternal toolchainâ€œï¼›æœ‰ä¸‰ç§æ–¹å¼æ¥ä½¿ç”¨å¤–éƒ¨å·¥å…·é“¾ï¼š<ul><li>è®© Buildroot åŸºäºé¢„å®šä¹‰çš„å¤–éƒ¨å·¥å…·é“¾ profile è‡ªåŠ¨ä¸‹è½½ã€å®‰è£…ã€‚åœ¨&nbsp;<code>Toolchain</code>&nbsp;ä¸­é€‰æ‹©å·²æœ‰çš„ profile å³å¯</li><li>ä¸º Buildroot æ‰‹åŠ¨æŒ‡å®šæå‰å®‰è£…å¥½çš„ã€é¢„å®šä¹‰äº† profile çš„å·¥å…·é“¾ã€‚åœ¨&nbsp;<code>Toolchain</code>&nbsp;ä¸­é€‰æ‹© profile åï¼Œåé€‰æ‰&nbsp;<code>Download toolchain automatically</code>&nbsp;å¹¶åœ¨&nbsp;<code>Toolchain path</code>&nbsp;ä¸­å¡«å†™å·²æœ‰å·¥å…·é“¾è·¯å¾„å³å¯</li><li>ä½¿ç”¨å®šåˆ¶çš„å¤–éƒ¨å·¥å…·é“¾ã€‚é€šå¸¸ç”¨äºä½¿ç”¨ crosstool-NG æˆ– Buildroot ç”Ÿæˆçš„å·²æœ‰å®šåˆ¶å·¥å…·é“¾ã€‚é€‰æ‹©&nbsp;<code>Toolchain</code>&nbsp;åˆ—è¡¨ä¸­çš„&nbsp;<code>Custom toolchain</code>&nbsp;ï¼Œç„¶åå¡«å†™&nbsp;<code>Toolchain path</code>,&nbsp;<code>Toolchain prefix</code>,&nbsp;<code>External toolchain C librrary</code>&nbsp;é€‰é¡¹ã€‚è‹¥å¤–éƒ¨å·¥å…·é“¾ä½¿ç”¨ glibc åº“ï¼Œåªéœ€è¦é€‰æ‹©å·¥å…·é“¾æ˜¯å¦æ”¯æŒ C++ ä»¥åŠæ˜¯å¦å†…å»º RPC æ”¯æŒå³å¯ã€‚å¦‚æœä½¿ç”¨ uClibc åº“ï¼Œåˆ™è¿˜æœ‰å®½å­—ç¬¦ã€æœ¬åœ°åŒ–ã€ç¨‹åº invocationã€çº¿ç¨‹æ”¯æŒç­‰é€‰é¡¹</li></ul></li></ul><p>Buildroot ä¸æ”¯æŒç”± OpenEmbeddedã€Yocto æ”¯æŒçš„å·¥å…·é“¾ï¼Œå› ä¸ºè¿™äº›å·¥å…·ç”Ÿæˆçš„å·¥å…·é“¾å¹¶ä¸æ˜¯å•çº¯çš„å·¥å…·é“¾â€”â€”å®ƒä»¬é™¤äº†ç¼–è¯‘å™¨ã€binutilsã€C/C++ åº“ä¹‹å¤–è¿˜åŠ äº†ä¸€å¤§å †é¢„ç¼–è¯‘çš„åº“å’Œç¨‹åºã€‚å› æ­¤ Buildroot å¹¶æ²¡æœ‰åŠæ³•å¯¼å…¥å®ƒä»¬çš„ sysroot ã€‚Buildroot ä¹Ÿä¸æ”¯æŒå‘è¡Œç‰ˆæä¾›çš„å·¥å…·é“¾ï¼Œè¿™äº›å·¥å…·é“¾åŒ…å«çš„ä¸œè¥¿ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æ— æ³•åŠ è½½åˆ°æ„å»ºç¯å¢ƒä¸­ã€‚</p><span id="more"></span><h2 id="dev-ç®¡ç†">/dev ç®¡ç†</h2><ul><li><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯â€œStatic using device tableâ€<br>è®¾å¤‡æ–‡ä»¶ä¼šè¢«æŒä¹…å­˜å‚¨åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆå³é‡æ–°å¯åŠ¨åå®ƒä»¬ä»ç„¶å­˜åœ¨ï¼‰ï¼Œå¹¶ä¸”åœ¨ç³»ç»Ÿæ·»åŠ æˆ–è€…ç§»é™¤ç¡¬ä»¶è®¾å¤‡æ—¶ï¼Œä¸èƒ½è‡ªåŠ¨åˆ›å»ºå’Œåˆ é™¤è¿™äº›è®¾å¤‡æ–‡ä»¶ã€‚</p></li><li><p>ç¬¬äºŒç§æ–¹å¼æ˜¯â€œDynamic using devtmpfs onlyâ€<br>ä½¿ç”¨ devtmpfs æ—¶éœ€è¦å¯ç”¨ä»¥ä¸‹å†…æ ¸é…ç½®é€‰é¡¹ï¼šCONFIG_DEVTMPFS å’Œ CONFIG_DEVTMPFS_MOUNTã€‚</p></li><li><p>ç¬¬ä¸‰ç§æ–¹å¼æ˜¯â€œDynamic using devtmpfs+mdevâ€<br>æ¯æ¬¡æ·»åŠ æˆ–ç§»é™¤è®¾å¤‡æ—¶ï¼Œå†…æ ¸éƒ½ä¼šè°ƒç”¨ mdevã€‚ç”±äºä½¿ç”¨/etc/mdev.conf é…ç½®æ–‡ä»¶ï¼Œå› æ­¤ mdev å¯ä»¥è¿›è¡Œç›¸å…³é…ç½®ï¼Œä¾‹å¦‚ç»™è®¾å¤‡æ–‡ä»¶è®¾ç½®ç‰¹å®šçš„æƒé™æˆ–æ‰€æœ‰æƒã€åœ¨è®¾å¤‡å‡ºç°æˆ–æ¶ˆå¤±æ—¶è°ƒç”¨è„šæœ¬æˆ–åº”ç”¨ç¨‹åºç­‰ç­‰</p></li><li><p>ç¬¬å››ç§æ–¹å¼æ˜¯â€œDynamic using devtmpfs+eudevâ€<br>eudev æ˜¯åå°è¿è¡Œçš„å®ˆæŠ¤ç¨‹åºï¼Œå½“ç³»ç»Ÿæ·»åŠ æˆ–è€…ç§»é™¤è®¾å¤‡æ—¶ï¼Œå†…æ ¸å°†ä¼šè°ƒç”¨å®ƒã€‚ä¸ mdev ç›¸æ¯”ï¼Œå®ƒæ˜¯é‡é‡çº§çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å…·æœ‰æ›´é«˜çš„çµæ´»æ€§ã€‚eudev æ˜¯ udev çš„ç‹¬ç«‹ç‰ˆæœ¬</p></li></ul><h2 id="åˆå§‹åŒ–ç³»ç»Ÿ">åˆå§‹åŒ–ç³»ç»Ÿ</h2><ul><li>ç¬¬ä¸€ç§æ˜¯â€œBusyBoxâ€ï¼šBusyBox init ç¨‹åºä¼šåœ¨å¯åŠ¨æ—¶å»è¯»å–/etc/inittab æ–‡ä»¶</li><li>ç¬¬äºŒç§æ˜¯â€œsystemVâ€ï¼šSysvinit åŒæ ·ä½¿ç”¨ inittab æ–‡ä»¶ï¼ˆå…¶è¯­æ³•ä¸ BusyBox ä¸­çš„è¯­æ³•ç•¥æœ‰ä¸åŒï¼‰</li><li>ç¬¬ä¸‰ç§æ˜¯â€œsystemdâ€ï¼šsystemd æ˜¯ç”¨äº Linux çš„æ–°ä¸€ä»£ init ç³»ç»Ÿã€‚å®ƒçš„åŠŸèƒ½è¿œè¿œè¶…è¿‡ä¼ ç»Ÿçš„ init ç¨‹åºï¼šå¼ºå¤§çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›ã€ä½¿ç”¨ socket å’Œ D-Bus æ¿€æ´»å¯åŠ¨æœåŠ¡ã€æŒ‰éœ€å¯åŠ¨å®ˆæŠ¤ç¨‹åºã€ä½¿ç”¨ Linux æ§åˆ¶ç»„è·Ÿè¸ªè¿›ç¨‹ã€æ”¯æŒå¯¹ç³»ç»ŸçŠ¶æ€è¿›è¡Œå¿«ç…§å’Œè¿˜åŸç­‰ç­‰ã€‚</li></ul><h1 id="ildrootä¸€èˆ¬ç”¨æ³•">ildrootä¸€èˆ¬ç”¨æ³•</h1><h2 id="ç›®å½•æ ‘å¤–æ„å»º">ç›®å½•æ ‘å¤–æ„å»º</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/build; make O=<span class="variable">$PWD</span> -C path/to/buildroot</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼šâ€œOâ€æŒ‡å®šçš„è·¯å¾„å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä½†å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™éœ€è¦æ³¨æ„ï¼Œå®ƒæ˜¯ç›¸å¯¹äº Buildroot çš„ä¸»ç›®å½•è€Œä¸æ˜¯å½“å‰å·¥ä½œç›®å½•ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line">CURRENT_DIR=$(<span class="built_in">cd</span> $(<span class="built_in">dirname</span> <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">make O=<span class="variable">${CURRENT_DIR}</span>/output -C ./Buildroot-2023.11/ stm32mp157_pro_ddr512m_systemV_core_defconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ„å»ºè½¯ä»¶åŒ…ä¾èµ–å…³ç³»å›¾</span></span><br><span class="line">make graph-depends</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ„å»ºæ—¶é—´å›¾</span></span><br><span class="line">make graph-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶è½¯ä»¶åŒ…å¯¹æ–‡ä»¶ç³»ç»Ÿå¤§å°è´¡çŒ®å›¾</span></span><br><span class="line">make graph-size</span><br></pre></td></tr></tbody></table></figure><h2 id="åœ¨å¼€å‘æœŸé—´ä½¿ç”¨-buildroot">åœ¨å¼€å‘æœŸé—´ä½¿ç”¨ Buildroot</h2><p>é—®é¢˜ï¼šç›´æ¥åœ¨ output/build/<package>-<version>ä¸­è¿›è¡Œä¿®æ”¹æ˜¯ä¸åˆé€‚çš„ï¼Œå› ä¸ºåœ¨â€œmake cleanâ€æ—¶ä¼šåˆ é™¤è¯¥ç›®å½•ã€‚</version></package></p><p>è§£å†³åŠæ³•ï¼šBuildroot é’ˆå¯¹æ­¤åœºæ™¯æä¾›äº†ä¸€ç§ç‰¹å®šçš„æœºåˆ¶ï¼š<pkg>_OVERRIDE_SRCDIR æœºåˆ¶ã€‚Buildroot ä¼šè¯»å– override æ–‡ä»¶ï¼Œè€Œè¯¥æ–‡ä»¶å¯ä»¥è®©ç”¨æˆ·å‘Šè¯‰ Buildroot æŸäº›è½¯ä»¶åŒ…çš„æºç ä½ç½®</pkg></p><p>override æ–‡ä»¶çš„é»˜è®¤ä½ç½®æ˜¯<span class="math inline">\((CONFIG_DIR)/local.mkï¼Œç”± BR2_PACKAGE_OVERRIDE_FILE é…ç½®é€‰é¡¹å®šä¹‰ã€‚\)</span>(CONFIG_DIR)æ˜¯ Buildroot ä¸­.config æ–‡ä»¶çš„ä½ç½®ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ï¼Œ<span class="exturl" data-url="aHR0cDovL2xvY2FsLm1r">local.mk<i class="fa fa-external-link-alt"></i></span> ä¸.config æ–‡ä»¶åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¿™æ„å‘³ç€ï¼š â€¢ åœ¨ç›®å½•æ ‘å†…æ„å»ºçš„ Buildroot æºç é¡¶çº§ç›®å½•ä¸­ï¼ˆå³ä¸ä½¿ç”¨â€œO=â€æ—¶ï¼‰ â€¢ åœ¨ç›®å½•æ ‘å¤–æ„å»ºçš„â€œOâ€å‚æ•°æŒ‡å®šçš„ç›®å½•ä¸­ï¼ˆå³ä½¿ç”¨â€œO=â€æ—¶ï¼‰ å¦‚æœéœ€è¦çš„ä½ç½®ä¸é»˜è®¤ä½ç½®ä¸åŒï¼Œåˆ™å¯ä»¥é€šè¿‡ BR2_PACKAGE_OVERRIDE_FILE é…ç½®é€‰é¡¹æŒ‡å®šè¯¥ä½ç½®ã€‚åœ¨è¯¥ override æ–‡ä»¶ä¸­ï¼ŒBuildroot å¸Œæœ›æ‰¾åˆ°ä»¥ä¸‹å½¢å¼çš„å‚æ•°è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;pkg1&gt;_OVERRIDE_SRCDIR = /path/to/pkg1/sources</span><br><span class="line">&lt;pkg2&gt;_OVERRIDE_SRCDIR = /path/to/pkg2/sources</span><br></pre></td></tr></tbody></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LINUX_OVERRIDE_SRCDIR = /home/bob/linux/</span><br><span class="line">BUSYBOX_OVERRIDE_SRCDIR = /home/bob/busybox/</span><br></pre></td></tr></tbody></table></figure><p>å½“ Buildroot å‘ç°æŒ‡å®šè½¯ä»¶åŒ…å·²ç»å®šä¹‰äº†<pkg>_OVERRIDE_SRCDIR æ—¶ï¼Œå®ƒå°†ä¸å†å°è¯•ä¸‹è½½ã€æå–å’Œä¿®è¡¥è½¯ä»¶åŒ…ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå®ƒå°†ç›´æ¥ä½¿ç”¨æŒ‡å®šç›®å½•ä¸­å¯ç”¨çš„æºä»£ç ï¼Œå¹¶ä¸”ä½¿ç”¨â€œmake cleanâ€æ—¶ä¸ä¼šåˆ é™¤è¯¥ç›®å½•ã€‚</pkg></p><p>æ­¤æœºåˆ¶æœ€å¥½ä¸ make <pkg>-rebuild å’Œ make <pkg>-reconfigure ç›®æ ‡ç»“åˆä½¿ç”¨ã€‚make <pkg>-rebuild all å°†ä½¿æºä»£ç ä»<pkg>_OVERRIDE_SRCDIR åŒæ­¥åˆ° output/build/<package>-customï¼ˆç”±äº rsyncï¼Œå®ƒä»…å¤åˆ¶ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼‰ï¼Œç„¶åé‡æ–°å¯åŠ¨è¯¥è½¯ä»¶åŒ…çš„æ„å»ºè¿‡ç¨‹ã€‚</package></pkg></pkg></pkg></pkg></p><p>åœ¨ä¸Šè¿° linux è½¯ä»¶åŒ…ç¤ºä¾‹ä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨/home/bob/linux ä¸­æ›´æ”¹æºä»£ç ï¼Œç„¶åè¿è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make linux-rebuild all</span><br></pre></td></tr></tbody></table></figure><h1 id="ç‰¹å®šé¡¹ç›®çš„å®šåˆ¶">ç‰¹å®šé¡¹ç›®çš„å®šåˆ¶</h1><p>...</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RTOS çš„è®¾è®¡</title>
      <link href="/2019/Program/rtosDesign/"/>
      <url>/2019/Program/rtosDesign/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½•ä¸ºå®æ—¶æ€§">ä½•ä¸ºå®æ—¶æ€§ï¼Ÿ</h1><p>RTOS çš„å®æ—¶æ€§è¯¥æ€ä¹ˆç†è§£å‘¢ï¼Ÿå¿«é€Ÿï¼Ÿç¡®å®šæ€§ï¼Ÿ</p><h2 id="ä»ä¸­æ–­æ§åˆ¶å™¨è§†è§’çœ‹å®æ—¶æ€§">ä»ä¸­æ–­æ§åˆ¶å™¨è§†è§’çœ‹å®æ—¶æ€§</h2><p>æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬éƒ½æ˜¯ Cortex-M è·‘ RTOSï¼ŒCortex-A å¾ˆå°‘è·‘ RTOSï¼Œä¸€èˆ¬éƒ½æ˜¯è·‘ Linuxã€Android è¿™äº›éå®æ—¶ç³»ç»Ÿã€‚å¦‚æœå•çº¯ä»é€Ÿåº¦æ¥çœ‹ A æ ¸åœ¨é«˜ä¸»é¢‘åŠ æŒä¸‹ä¸€å®šä¼šå…·æœ‰æ›´å¿«çš„é€Ÿåº¦æ‰å¯¹å‘€ï¼Œé‚£ M æ ¸çš„ç«äº‰åŠ›åœ¨å“ªé‡Œå‘¢ï¼Ÿå®é™…ä¸Šè¿™å°±æ˜¯ A æ ¸å’Œ M æ ¸åœ¨è®¾è®¡ä¸Šçš„ä¸¤ä¸ªä¸åŒæ–¹å‘çš„å–èˆã€‚</p><p>é¦–å…ˆæˆ‘ä»¬çœ‹ NVIC ä¸­æ–­æ§åˆ¶å™¨çš„è®¾è®¡ï¼š</p><ul><li>ä¸­æ–­å»¶è¿Ÿæ³¢åŠ¨å¾ˆå°ï¼šNVIC æ”¯æŒä¸­æ–­åµŒå¥—ï¼Œè¿™æ ·å³ä½¿å½“å‰ä¸­æ–­åœ¨å¤„ç†ä¸­ä¸”éå¸¸è€—æ—¶ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­æ¥å“åº”æ›´ç´§æ€¥çš„äº‹ä»¶ï¼Œè¿™æ ·ä¸­æ–­å»¶è¿Ÿå°±ä¸ä¾èµ–ä¸ä¸­æ–­å¤„ç†æ—¶é—´äº†ï¼Œä»è®¾è®¡ä¸Šä¿è¯äº†å»¶è¿Ÿçš„ç¡®å®šæ€§ã€‚</li><li>ä¸­æ–­å»¶è¿Ÿå°ï¼šNVIC åœ¨ä¸åŒçš„ä¸­æ–­ä¼šè·³è½¬åˆ°ä¸åŒåœ°å€è¿è¡Œï¼Œä¸”å¯ä»¥ç›´æ¥åœ¨ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä¸­æ–­ç¨‹åºï¼Œè¿™æ ·æ•´ä¸ª pipeline å¾ˆçŸ­ï¼Œä¸” NVIC è¿˜æ”¯æŒ<strong>å°¾é“¾</strong>è¿™ä¸ªæ¦‚å¿µè¿›ä¸€æ­¥é™ä½å»¶è¿Ÿï¼ˆå½“é«˜ä¼˜å…ˆçº§çš„ ISR æŠ¢å ä½ä¼˜å…ˆçº§ ISR æ—¶ï¼Œå¤„ç†å™¨ä¼šè·³è¿‡ä¸Šä¸‹æ–‡ä¿å­˜å’Œæ¢å¤ï¼Œç›´æ¥å¤„ç†ç¬¬äºŒä¸ª ISRï¼Œæ²¡æœ‰ä»»ä½•é¢å¤–çš„å¼€é”€ï¼‰ã€‚é€šå¸¸ NVIC ä¸­æ–­å“åº”æ—¶é—´åœ¨åå‡ åˆ°å‡ å ns ä¹‹é—´ã€‚</li></ul><p>NVIC ä¸­æ–­æ§åˆ¶å™¨åœ¨å®æ—¶æ€§ä¸Šæ˜¯æ»¡è¶³è¦æ±‚çš„ï¼Œå¿«é€Ÿå’Œç¡®å®šæ€§éƒ½æ»¡è¶³ï¼Œä½†æ˜¯ä»–ä¸é€‚åˆå¤„ç†å¤§é‡ä¸­æ–­ï¼Œå‡å¦‚æ¯ç§’è¦å¤„ç†æˆåƒä¸Šä¸‡ï¼ˆè¿™ä¸ªä¸­æ–­æ•°é‡å¯¹äº A æ ¸æ¥è®²æ˜¯å¾ˆå¸¸è§çš„ UACã€UVCï¼ŒDSP ç­‰ä¸€ä¸ªæ¨¡å—æ¯ç§’å¯èƒ½å°±æœ‰å‡ åƒä¸ªä¸­æ–­ï¼‰ä¸ªä¸­æ–­ï¼Œé‚£ä¹ˆå¯¹ NVIC æ¥è®²è¿™æ˜¯ç¾éš¾æ€§çš„ï¼Œå„ç§åµŒå¥—è®¾è®¡å„ç§æ€§èƒ½è¯„ä¼°ï¼Œé™¤æ­¤ä¹‹å¤–å¯¹äºå¤šæ ¸ç³»ç»Ÿ NVIC ä¹Ÿæ²¡æœ‰ä¸€å¥—å°†ä¸­æ–­åˆ†é…ç»™å„ä¸ª CPU æ ¸çš„æœºåˆ¶ï¼Œé‚£ä¹ˆå°±æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿æé«˜ä¸­æ–­å¤„ç†èƒ½åŠ›ã€‚è€Œ A æ ¸çš„ GIC æ§åˆ¶å™¨å°±æ˜¯ä¸ºè§£å†³è¿™äº›é—®é¢˜è€Œè®¾è®¡çš„ã€‚</p><p>Cortex-A æ ¸çš„ GIC ä¸­æ–­æ§åˆ¶å™¨è®¾è®¡å¾ˆå¤æ‚ï¼Œä½†æ˜¯ä¸æ”¯æŒä¸­æ–­åµŒå¥—ï¼Œç”± Distributorã€CPU interfaceã€Redistributorã€ITS ç»„æˆï¼ŒDistributor å…·æœ‰ä»²è£å’Œåˆ†å‘çš„ä½œç”¨ï¼Œä¼šå°†ä¸­æ–­å‘é€ç»™ Redistributorï¼ŒRedistributor å°†ä¸­æ–­å‘é€ç»™ CPU interfaceã€‚è¿™æ ·ç¬¬ä¸€è§£å†³äº†å¤šæ ¸é—®é¢˜ï¼Œå…¶æ¬¡ GIC æ²¡æœ‰ä¸­æ–­åµŒå¥—ï¼Œå½“ä¸­æ–­å‘ç”Ÿåè·³è½¬åˆ°ä¸€ä¸ªå›ºå®šåœ°å€ï¼Œç„¶ååˆ¤æ–­ä¸­æ–­æºè¿›è¡Œä¸‹ä¸€æ­¥è·³è½¬ï¼Œåœ¨ Linux ä¸­æ¥ä¸‹æ¥å°±ä¼šåˆ†ä¸ºä¸­æ–­ä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨æœºåˆ¶ï¼Œä¸ŠåŠéƒ¨åœ¨ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡å¿«é€Ÿå“åº”ç„¶åè¿”å›ï¼Œä»¥æ›´å¿«å¤„ç†å…¶ä»–ä¸­æ–­å…¼é¡¾å®æ—¶æ€§ã€‚ä¸­æ–­ä¸‹åŠéƒ¨ä¸ºäº†ä¸åŒçš„åº”ç”¨éœ€æ±‚è®¾è®¡äº† softirqã€taskletã€workqueueã€thread ç­‰æœºåˆ¶æ¥å®ç°å¤§é‡çš„ä¸­æ–­ä»»åŠ¡ï¼Œå…¼é¡¾é«˜æ€§èƒ½ã€‚GIC ä¸­æ–­æ§åˆ¶å™¨è§£å†³äº† NVIC çš„é—®é¢˜ä½†æ˜¯å´ä¸¢äº†ç¡¬å®æ—¶æ€§ã€‚</p><ul><li>ä¸­æ–­å»¶è¿Ÿæ¯”è¾ƒå¤§ï¼šä¸­æ–­å¤„ç†çš„ PipeLine æ¯”è¾ƒé•¿ï¼Œä¸­æ–­å“åº”å»¶è¿Ÿä¸€èˆ¬åœ¨ us çº§åˆ«ã€‚</li><li>ä¸­æ–­å»¶è¿Ÿæ³¢åŠ¨æ¯”è¾ƒå¤§ï¼šä¸­æ–­ä¸æ”¯æŒåµŒå¥—é‚£ä¹ˆå°±ä¸€å®šè¦ç­‰ä¸Šä¸€ä¸ªä¸­æ–­è¿”å›æ‰èƒ½å¾—åˆ°å¤„ç†ï¼Œè¿™ä¸ªå»¶è¿Ÿå°±ä¸å¯æ§äº†ã€‚</li></ul><p>ä»ä¸­æ–­æ§åˆ¶å™¨è§†è§’çœ‹å®æ—¶æ€§æ˜¯å¿«é€Ÿ+ç¡®å®šçš„ latencyã€‚</p><span id="more"></span><h2 id="ä»å†…å­˜ç®¡ç†è§’åº¦çœ‹å®æ—¶æ€§">ä»å†…å­˜ç®¡ç†è§’åº¦çœ‹å®æ—¶æ€§</h2><p>å¦‚æœå•çº¯é‡è°ƒåº¦å™¨çš„è§’åº¦çœ‹ï¼ŒLinux ä¸ä»…æœ‰ RT å®æ—¶è°ƒåº¦ç­–ç•¥ï¼Œè¿˜æœ‰ DeadLine è¿™ç§å¼ºå®æ—¶æ€§è°ƒåº¦ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´ Linux ç³»ç»Ÿåœ¨è°ƒåº¦ç®—æ³•ä¸Šæ˜¯å…·å¤‡å®æ—¶æ€§ï¼ˆè½¯å®æ—¶ï¼‰çš„ï¼Œä½†å®æ—¶æ€§ä¸ä»…ä»…å–å†³äºè°ƒåº¦å™¨è¿˜æœ‰å…¶ä»–å› ç´ çš„å½±å“ï¼Œå…¶ä¸­è™šæ‹Ÿå†…å­˜æœºåˆ¶å°±æ˜¯æä¸ºå…³é”®çš„å› ç´ ï¼Œä¸‹é¢æˆ‘ä»¬åšä¸‹è¯¦ç»†è¯´æ˜ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ Linux ä¸‹æœ‰ä¸€å¥—æä¸ºå¤æ‚çš„å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œç‰©ç†å†…å­˜ç”± Node-Zone-Section-Page é“¾ç®¡ç†ï¼Œè™šæ‹Ÿå†…å­˜ç”± slab-buddySystem-page-pagetable é“¾ç®¡ç†ï¼Œå½“å†…å­˜ä¸è¶³çš„æ—¶å€™å¯ä»¥é€šè¿‡ç›¸ä¼¼é¡µåˆå¹¶ï¼Œé¡µé¢è¿ç§»ã€é¡µé¢å›æ”¶ç­‰æœºåˆ¶å›æ”¶å†…å­˜ä½¿ç”¨ã€‚è€Œ RTOS ä¸€èˆ¬åªå®ç°ç®€å•çš„ memory poolã€‚è™šæ‹Ÿå†…å­˜æœºåˆ¶æœ‰éå¸¸å¤šçš„å¥½å¤„ï¼Œä½†æ˜¯ RTOS ä¸ºä»€ä¹ˆä¸å®ç° Linux ä¸‹è¿™å¥—è½¯ä»¶æœºåˆ¶å‘¢ï¼Œå› ä¸ºæ²¡æœ‰ MMUï¼Ÿå› ä¸ºèµ„æºå—é™ï¼Ÿå…¶å®ç°åœ¨ MCU é¢‘ç‡ä¹Ÿéƒ½è·‘åˆ°ä¸Š Ghz äº†ï¼Œä¹Ÿå¯ä»¥å¤–æŒ‚ DDRï¼Œé‚£ä¹ˆå¡ä¸ª MMU æ”¾è¿›å»ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ä¸ºä»€ä¹ˆéƒ½ä¸è¿™ä¹ˆåšå‘¢ï¼Ÿå…¶å®è¿™æ˜¯è·Ÿå®æ—¶æ€§ç›¸å…³çš„ï¼ŒCortex-M ç›¸è¾ƒäº A æ ¸çš„ä¸€ä¸ªä¼˜åŠ¿åœ¨äºå®æ—¶æ€§ï¼ˆç¡¬å®æ—¶æ€§ï¼‰ã€‚å¼•å…¥ MMU åç¡¬å®æ—¶æ€§æ— æ³•ä¿è¯ï¼Œæˆ‘ä»¬çœ‹ä¸‹ Linux ä¸‹çš„å†…å­˜ç®¡ç†å­˜åœ¨çš„é—®é¢˜å°±çŸ¥é“äº†ã€‚</p><p>åŠ å…¥ä½ åœ¨ Linux ä¸‹é‡‡ç”¨ DeadLine è°ƒåº¦å™¨ï¼Œè®¾è®¡å¥½äº†è°ƒåº¦å‘¨æœŸæ ¸ dead lineï¼Œè®©è°ƒåº¦å™¨ä¿è¯åœ¨æ¯ä¸ªå‘¨æœŸçš„ dead line æ—¶é—´å‰åˆ†é…ç»™ thread éœ€è¦çš„æ—¶é—´ç‰‡ã€‚ä½†æ˜¯ä½  thread ä¸­ä½¿ç”¨äº†ä¸€å— heap é‡Œåˆ†é…çš„å†…å­˜ï¼ŒLinux ä¸‹ç”³è¯·ä¸€å—å†…å­˜æ˜¯ç›´æ¥è¿”å›æˆåŠŸçš„ï¼Œè¿™ä¸ªæ—¶å€™åªå¾—åˆ°äº†è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶æ²¡æœ‰å®é™…çš„ç‰©ç†åœ°å€è¢«åˆ†é…ã€‚ç„¶åä½ å¼€å§‹å†™è¿™å—å†…å­˜ï¼Œç„¶åç³»ç»Ÿå‘ç°å¹¶æ²¡æœ‰å®é™…çš„ç‰©ç†å†…å­˜è¢«æ˜ å°„ï¼Œè¿™ä¸ªæ—¶å€™ç³»ç»Ÿé€šè¿‡è§¦å‘ç¼ºé¡µå¼‚å¸¸è¿›å…¥å¼‚å¸¸å¤„ç†ï¼Œä¸€æ—¦è§¦å‘ç¼ºé¡µå¼‚å¸¸ä¼šèµ°é¡µé¢åˆ†é…å™¨è¿™ä¸ªè·¯å¾„ï¼Œå¦‚æœç”³è¯·åˆ°é¡µé¢è¿˜å¥½ï¼Œå¦‚æœç”³è¯·ä¸åˆ°è¦èµ°æ…¢é€Ÿé€šé“ï¼Œé€šè¿‡å›æ”¶å†…å­˜ã€é¡µé¢åˆå¹¶ã€é¡µé¢è¿ç§»ç­‰æ“ä½œæ¥è…¾å‡ºå†…å­˜ï¼Œemmï¼Œè¿™ä¸ªæ“ä½œçš„è€—æ—¶æƒ…å†µå°±å®Œå…¨ä¸å¯æ§äº†ã€‚é‚£ä¹ˆè¿™ä¸ªæ“ä½œåœ¨ Deadline è°ƒåº¦å‘¨æœŸå†…å°±å¾ˆæœ‰å¯èƒ½æ— æ³•å®Œæˆã€‚</p><p>å½“ç„¶ä¹Ÿæœ‰è§£å†³åŠæ³•å°±æ˜¯ Reserved å†…å­˜ï¼Œè¿™å°±ç›¸å½“äºæ²¡æœ‰ä½¿ç”¨è™šæ‹Ÿå†…å­˜æœºåˆ¶äº†ã€‚</p><p>å› æ­¤ä½•ä¸ºå®æ—¶æ€§å‘¢ï¼Ÿä»å†…å­˜ç®¡ç†è§’åº¦çœ‹ç¡®å®šæ€§æ›´ä¸ºæ¥è¿‘ç­”æ¡ˆï¼Œäº‹å®ä¸Šç¡¬å®æ—¶æ€§åŒæ—¶éœ€è¦å¿«é€Ÿæ ¸ç¡®å®šæ€§æ¥ä¿è¯ã€‚</p><h1 id="task-è°ƒåº¦ä¸­å­˜åœ¨çš„é—®é¢˜">task è°ƒåº¦ä¸­å­˜åœ¨çš„é—®é¢˜</h1><h2 id="ä¼˜å…ˆçº§åè½¬">ä¼˜å…ˆçº§åè½¬</h2><p>ä½¿ç”¨å®æ—¶å†…æ ¸ï¼Œä¼˜å…ˆçº§åè½¬é—®é¢˜æ˜¯å®æ—¶ç³»ç»Ÿä¸­å‡ºç°å¾—æœ€å¤šçš„é—®é¢˜ã€‚ä¸‹å›¾è§£é‡Šä¼˜å…ˆçº§åè½¬æ˜¯å¦‚ä½•å‡ºç°çš„ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/prio_revert.png"></p><p>å¦‚å›¾ï¼Œtask çš„ä¼˜å…ˆçº§ä¸º task1 &gt; task2 &gt; task3ï¼š</p><ul><li>é˜¶æ®µä¸€ï¼štask1 å’Œ task2 å¤„äºä¼‘çœ æ€ï¼Œtask ç”³è¯·æŒæœ‰é”ã€‚</li><li>é˜¶æ®µäºŒï¼štask1 åˆ‡æ¢åˆ°è¿è¡Œæ€ï¼Œä¹Ÿè¦ç”³è¯·è¯¥é”ï¼Œå› ç”³è¯·ä¸åˆ°è€Œä¼‘çœ ã€‚</li><li>é˜¶æ®µä¸‰ï¼štask2 åˆ‡æ¢åˆ°è¿è¡Œæ€ï¼Œç”±äºä¼˜å…ˆçº§é«˜äº task3 è€Œå…ˆè¿è¡Œã€‚</li><li>é˜¶æ®µå››ï¼štask2 è¿è¡Œç»“æŸï¼Œtask3 è¿è¡Œï¼Œé‡Šæ”¾é”ã€ç„¶å task1 æ¢å¤è¿è¡Œæ€å¼€å§‹è¿è¡Œã€‚</li></ul><p>å®é™… task è¿è¡Œçš„ä¼˜å…ˆçº§ç›¸å½“äº task2 &gt; task1ï¼Œå‘ç”Ÿäº†ä¼˜å…ˆçº§åè½¬ã€‚</p><p>è§£å†³æªæ–½ï¼šåœ¨ task3 ä½¿ç”¨å…±äº«èµ„æºæ—¶ï¼Œæå‡ task3 çš„ä¼˜å…ˆçº§ï¼Œtask å®Œæˆæ—¶äºˆä»¥æ¢å¤ã€‚task3 çš„ä¼˜å…ˆçº§å¿…é¡»å‡è‡³æœ€é«˜ï¼Œé«˜äºå…è®¸ä½¿ç”¨è¯¥èµ„æºçš„ä»»ä½• task ä¼˜å…ˆçº§ã€‚</p><p>ç„¶è€Œæ”¹å˜ task çš„ä¼˜å…ˆçº§æ˜¯å¾ˆèŠ±æ—¶é—´çš„ã€‚å¦‚æœ task3 å¹¶æ²¡æœ‰å…ˆè¢« task2 å‰¥å¤º CPU ä½¿ç”¨æƒï¼ŒèŠ±å¾ˆå¤šæ—¶é—´åœ¨å…±äº«èµ„æºä½¿ç”¨å‰æå‡ task3 çš„ä¼˜å…ˆçº§ï¼Œç„¶ååˆåœ¨èµ„æºä½¿ç”¨åèŠ±æ—¶é—´æ¢å¤ task3 çš„ä¼˜å…ˆçº§ï¼Œåˆ™æ— å½¢ä¸­æµªè´¹äº†å¾ˆå¤š CPU æ—¶é—´ã€‚çœŸæ­£éœ€è¦çš„æ˜¯ï¼Œä¸ºé˜²æ­¢å‘ç”Ÿä¼˜å…ˆçº§åè½¬ï¼Œå†…æ ¸èƒ½è‡ªåŠ¨å˜æ¢ task çš„ä¼˜å…ˆçº§ï¼Œè¿™å«åšä¼˜å…ˆçº§ç»§æ‰¿ (Priority inheritance) ä½† ucos-â…¡ä¸æ”¯æŒä¼˜å…ˆçº§ç»§æ‰¿ã€‚</p><h2 id="æ­»é”">æ­»é”</h2><p>æ­»é”ä¹Ÿç§°ä½œæŠ±æ­»ï¼ŒæŒ‡ä¸¤ä¸ª task æ— é™æœŸåœ°äº’ç›¸ç­‰å¾…å¯¹æ–¹æ§åˆ¶ç€çš„èµ„æºã€‚è®¾ task T1 æ­£ç‹¬äº«èµ„æº R1,task T2 åœ¨ç‹¬äº«èµ„æº R2, è€Œæ­¤æ—¶ T1 åˆè¦ç‹¬äº« R2,T2 ä¹Ÿè¦ç‹¬äº« R1, äºæ˜¯å“ªä¸ª task éƒ½æ²¡æ³•ç»§ç»­æ‰§è¡Œäº†ï¼Œå‘ç”Ÿäº†æ­»é”ã€‚æœ€ç®€å•çš„é˜²æ­¢å‘ç”Ÿæ­»é”çš„æ–¹æ³•æ˜¯è®©æ¯ä¸ª task éƒ½ï¼š</p><ul><li>å…ˆå¾—åˆ°å…¨éƒ¨éœ€è¦çš„èµ„æºå†åšä¸‹ä¸€æ­¥çš„å·¥ä½œã€‚</li><li>ç”¨åŒæ ·çš„é¡ºåºå»ç”³è¯·å¤šä¸ªèµ„æºï¼Œé‡Šæ”¾èµ„æºæ—¶ä½¿ç”¨ç›¸åçš„é¡ºåºã€‚</li></ul><h1 id="rtos-å»¶æ—¶æŠ–åŠ¨">RTOS å»¶æ—¶æŠ–åŠ¨</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>å¯¹äºæ“ä½œç³»ç»Ÿæ¥è®²æ—¶é—´æ˜¯é¢—ç²’æ€§çš„ä¸æ˜¯è¿ç»­çš„ï¼ˆç‰©ç†ä¸–ç•Œä¹Ÿæ˜¯è¿™æ ·çš„ï¼‰ï¼Œå°±æ˜¯æ“ä½œç³»ç»Ÿæœ‰æœ€å°æ—¶é—´é¢—ç²’ï¼Œå‡å¦‚æ“ä½œç³»ç»Ÿçš„æ—¶é’Ÿæ»´ç­”æ˜¯ 1ms é‚£ä¹ˆæ“ä½œç³»ç»Ÿæ˜¯æ²¡åŠæ³•åŒºåˆ†å°äºè¿™ä¸ªæ—¶é—´çš„ï¼Œè¿™å°±æ˜¯æ“ä½œç³»ç»Ÿå»¶æ—¶æŠ–åŠ¨çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚æ“ä½œç³»ç»Ÿä¼šæŠŠ 999us åˆ° 1ms çš„è¿™ä¸ª 1us å½“ 1ms å¤„ç†ï¼Œå½“ç„¶ä¹Ÿä¼šå°† 1us åˆ° 1999us è¿™ä¸ªæ¥è¿‘ 2ms çš„æ—¶é—´å½“æˆ 1ms è®¡ç®—ï¼Œè¿™å°±é€ æˆäº†ä¸€å®šçš„å»¶æ—¶è¯¯å·®ï¼›å¦ä¸€ä¸ªå»¶æ—¶è¯¯å·®æ¥è‡ª task çš„è¿è¡Œï¼Œtask æ˜¯è½®è¯¢è¿è¡Œçš„ä¹Ÿå°±æ˜¯å»¶æ—¶ 1ms åæ—¶é—´åˆ°äº†ï¼Œä½†æ˜¯é«˜ä¼˜å…ˆçº§ task ä¼šå…ˆè¿è¡Œï¼Œä¹‹åå†å°† cpu æ§åˆ¶æƒè½¬äº¤ç»™è¯¥ taskï¼Œè¿™ä¸¤ä¸ªå»¶æ—¶å…±åŒæ„æˆäº†æ“ä½œç³»ç»Ÿçš„å»¶æ—¶æŠ–åŠ¨ã€‚å¯¹äºç²¾ç¡®çš„å»¶æ—¶éœ€è¦é‡‡ç”¨ç¡¬ä»¶å®šæ—¶å™¨å®ç°ï¼Œä½†æ˜¯å¯¹äºç²¾åº¦è¦æ±‚ä¸æ˜¯é‚£ä¹ˆé«˜åˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å»¶æ—¶æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œå…¶å»¶æ—¶è¯¯å·®åœ¨æ—¶é’Ÿé¢—ç²’çº§åˆ«éå¸¸å°ã€‚</p><h2 id="task-è°ƒåº¦æ—¶æœº">task è°ƒåº¦æ—¶æœº</h2><p>å‡è®¾æ—¶é’ŸèŠ‚æ‹æ˜¯ 1ms å‘ç”Ÿä¸€æ¬¡ï¼Œè¦æ±‚ task A å»¶æ—¶ä¸€ä¸ªæ—¶é’ŸèŠ‚æ‹ï¼Œä¸‹é¢ä¸‰ç§æƒ…å†µä½“ç°äº†å»¶æ—¶æŠ–åŠ¨çš„åŸå› ã€‚</p><ul><li>ç¬¬ä¸€ç§æƒ…å†µä¸‹æ‰§è¡Œå»¶æ—¶å‡½æ•°åä¸åˆ° 1ms å°±åˆ°æ¥æ—¶é’ŸèŠ‚æ‹è€Œå…¶ä»–é«˜ä¼˜å…ˆçº§ task åˆæ²¡æœ‰å¤šå°‘ task å¯ä»¥æ‰§è¡Œå¾ˆå¿«è½®åˆ° task A æ‰§è¡Œå› æ­¤ task A å®é™…å»¶æ—¶å°äº 1msã€‚</li><li>ç¬¬äºŒç§æƒ…å†µå½“è°ƒç”¨å»¶æ—¶å‡½æ•°åé«˜ä¼˜å…ˆçº§ task æ‰§è¡Œæ—¶é—´è¾ƒé•¿å¤§äºä¸Šä¸€æ¬¡æ—¶é’ŸèŠ‚æ‹åˆ°æ¥åˆ°è°ƒç”¨å»¶æ—¶ task çš„æ—¶é—´ï¼Œé‚£ä¹ˆå»¶æ—¶å°†å¤§äº 1msã€‚</li><li>ç¬¬ä¸‰ç§æƒ…å†µæ˜¯é«˜ä¼˜å…ˆçº§ task æ‰§è¡Œæ—¶é—´è¿‡é•¿è¶…è¿‡ä¸€ä¸ªæ—¶é’ŸèŠ‚æ‹ï¼Œé‚£ä¹ˆå®é™…å»¶æ—¶å¯èƒ½æ˜¯ 2msã€‚</li></ul><p>å› æ­¤ï¼Œé‡‡ç”¨æ“ä½œç³»ç»Ÿå»¶æ—¶æ˜¯ä¸å‡†ç¡®çš„ï¼Œä¸‹å›¾æ˜¯ task è°ƒåº¦æ—¶æœºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/rtos_latency_jiif.png"></p><p>å»¶æ—¶çš„å®é™…æ‰§è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œåœ¨æ¯ä¸€æ¬¡æ—¶é’Ÿå‘¨æœŸåˆ°æ¥å°†å‘ç”Ÿä¸€æ¬¡ä¸­æ–­ï¼Œè°ƒç”¨èŠ‚æ‹æœåŠ¡å‡½æ•° OSTimeTick()ï¼Œè¯¥å‡½æ•°ä¸»è¦çš„åŠŸèƒ½æ˜¯ç»™æ¯ä¸ª task æ§åˆ¶å— OS_TCB ä¸­çš„æ—¶é’Ÿå»¶æ—¶é¡¹ OSTCBDly å‡ä¸€ç›´åˆ°ç­‰äº 0ï¼Œåœ¨å‡åˆ° 0 ä¹‹å‰ task æ˜¯æŒ‚èµ·çš„ï¼Œè€Œå½“ task å»¶æ—¶å‡åˆ° 0 æ—¶ task ä¸ä¸€å®šæ˜¯å°±ç»ªæ€æœ€é«˜ä¼˜å…ˆçº§ taskï¼Œå› æ­¤ task ä¸ä¸€å®šç«‹å³å¾—åˆ°æ‰§è¡Œï¼Œè€Œäº§ç”Ÿå»¶æ—¶è¯¯å·®ã€‚å¦‚æœéœ€è¦ç²¾ç¡®çš„å»¶æ—¶å¯ä»¥é‡‡ç”¨å®šæ—¶å™¨å»¶æ—¶ï¼Œå®šæ—¶å™¨å»¶æ—¶äº§ç”Ÿçš„ä¸­æ–­ä¼˜å…ˆçº§æ›´é«˜éœ€è¦ç«‹å³å¤„ç†ã€‚</p><h1 id="åŒæ­¥">åŒæ­¥</h1><h2 id="ç”¨äºè¡Œä¸ºåŒæ­¥çš„é€šä¿¡æ‰‹æ®µ">ç”¨äºè¡Œä¸ºåŒæ­¥çš„é€šä¿¡æ‰‹æ®µ</h2><ul><li>äºŒå€¼ä¿¡å·é‡ï¼šäºŒå€¼ä¿¡å·é‡çš„ä½¿ç”¨èŒƒå›´æ˜¯ï¼šè¢«æ§åˆ¶æ–¹æ€»èƒ½å¤ŸåŠæ—¶å“åº”æ§åˆ¶æ–¹å‘å‡ºçš„ä¿¡å·ï¼Œå®Œæˆç›¸åº”å¤„ç† task, å¹¶åœ¨ä¸‹ä¸€æ¬¡ä¿¡å·æ¥åˆ°ä¹‹å‰è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</li><li>è®¡æ•°ä¿¡å·é‡ï¼šè®¡æ•°ä¿¡å·é‡çš„ä½¿ç”¨èŒƒå›´æ˜¯ï¼šè¢«æ§åˆ¶æ–¹ä¸èƒ½ä¿è¯åœ¨ä¸‹ä¸€æ¬¡ä¿¡å·åˆ°æ¥ä¹‹å‰å¤„ç†å®Œæœ¬æ¬¡æ§åˆ¶æ–¹å‘å‡ºçš„ä¿¡å·ï¼Œä½†æ€»ä½“ä¸Šå¯ä»¥å“åº”æ‰€æœ‰ä¿¡å·ã€‚</li><li>äº‹ä»¶æ ‡å¿—ç»„ï¼šâ€œäº‹ä»¶æ ‡å¿—ç»„â€å¯ä»¥å®ç°å¤šä¸ª taskï¼ˆåŒ…æ‹¬ ISR) ååŒæ§åˆ¶ä¸€ä¸ª task, å½“å„ä¸ªç›¸å…³ taskï¼ˆåŒ…æ‹¬ ISR) å…ˆåå‘å‡ºè‡ªå·±çš„ä¿¡å·åï¼ˆä½¿äº‹ä»¶æ ‡å¿—ç»„çš„å¯¹åº”æ ‡å¿—æœ‰æ•ˆï¼‰, é¢„å®šçš„é€»è¾‘è¿ç®—ç»“æœæœ‰æ•ˆï¼Œè§¦å‘è¢«æ§åˆ¶çš„ taskã€‚</li><li>æ¶ˆæ¯é‚®ç®±ï¼šç”±äºâ€œæ¶ˆæ¯é‚®ç®±â€é‡Œåªèƒ½å­˜æ”¾ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨ç”¨â€œæ¶ˆæ¯é‚®ç®±â€è¿›è¡ŒåŒæ­¥æ§åˆ¶æ—¶ï¼Œå¿…é¡»æ»¡è¶³ä¸€ä¸ªå‰æï¼šä»»ä½•æ—¶å€™æ¶ˆæ¯çš„ç”Ÿäº§é€Ÿåº¦éƒ½æ¯”æ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦æ…¢ï¼Œå³è¢«æ§åˆ¶ task æ€»æ˜¯åœ¨ç­‰å¾…æ¶ˆæ¯ã€‚è¿™å’ŒäºŒå€¼ä¿¡å·é‡çš„æƒ…å†µç±»ä¼¼ã€‚</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šâ€œæ¶ˆæ¯é˜Ÿåˆ—â€å¯ä»¥å­˜æ”¾å¤šä¸ªæ¶ˆæ¯ï¼Œèƒ½å¤Ÿæœ‰æ•ˆè§£å†³æ¶ˆæ¯çš„â€œä¸´æ—¶å †ç§¯â€é—®é¢˜ã€‚ä¸è®¡æ•°ä¿¡å·é‡çš„æƒ…å†µç±»ä¼¼ï¼Œâ€œæ¶ˆæ¯é˜Ÿåˆ—â€çš„ä½¿ç”¨ä»ç„¶éœ€è¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼šæ¶ˆæ¯çš„å¹³å‡ç”Ÿäº§æ—¶é—´æ¯”æ¶ˆæ¯çš„å¹³å‡æ¶ˆè´¹æ—¶é—´é•¿ï¼›å¦åˆ™ï¼Œå†é•¿çš„â€œæ¶ˆæ¯é˜Ÿåˆ—â€ä¹Ÿä¼šâ€œæº¢å‡ºâ€ã€‚</li></ul><p>å°†ä»¥ä¸Šé€šä¿¡æ‰‹æ®µç”¨äº task ä¹‹é—´çš„è¡Œä¸ºåŒæ­¥æ—¶éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥é€‰æ‹©ï¼š</p><ul><li>å½“åŒæ­¥è¿‡ç¨‹ä¸éœ€è¦ä¼ è¾“å…·ä½“å†…å®¹æ—¶ï¼Œå¯é€‰æ‹©ä¿¡å·é‡ç±»æ‰‹æ®µï¼ˆäºŒå€¼ä¿¡å·é‡ã€è®¡æ•°ä¿¡å·é‡å’Œäº‹ä»¶æ ‡å¿—ç»„ï¼‰ã€‚</li><li>å½“åŒæ­¥è¿‡ç¨‹éœ€è¦ä¼ è¾“å…·ä½“å†…å®¹æ—¶ï¼Œå¯é€‰æ‹©æ¶ˆæ¯ç±»æ‰‹æ®µï¼ˆæ¶ˆæ¯é‚®ç®±å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚</li><li>å½“æ»¡è¶³â€œä»»ä½•æ—¶å€™åŒæ­¥ä¿¡æ¯çš„ç”Ÿäº§é€Ÿåº¦éƒ½æ¯”åŒæ­¥ä¿¡æ¯çš„æ¶ˆè´¹é€Ÿåº¦æ…¢â€æ—¶ï¼Œå¯é€‰æ‹©ç®€å•çš„é€šä¿¡æ‰‹æ®µï¼ˆäºŒå€¼ä¿¡å·é‡ã€äº‹ä»¶æ ‡å¿—ç»„å’Œæ¶ˆæ¯é‚®ç®±ï¼‰ã€‚</li><li>å¯¹äºéå‘¨æœŸæ€§åŒæ­¥ä¿¡æ¯ï¼Œå½“ä¸èƒ½ä¿è¯â€œä»»ä½•æ—¶å€™åŒæ­¥ä¿¡æ¯çš„ç”Ÿäº§é€Ÿåº¦éƒ½æ¯”åŒæ­¥ä¿¡æ¯çš„æ¶ˆè´¹é€Ÿåº¦æ…¢â€æ—¶ï¼Œå¯é€‰æ‹©æœ‰ç¼“å†²åŠŸèƒ½çš„é€šä¿¡æ‰‹æ®µï¼ˆè®¡æ•°ä¿¡å·é‡å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚</li><li>å½“åŒæ­¥ä¿¡å·ä¸ºå¤šä¸ªä¿¡å·çš„é€»è¾‘è¿ç®—ç»“æœæ—¶ï¼Œé‡‡ç”¨äº‹ä»¶æ ‡å¿—ç»„ä½œä¸ºåŒæ­¥æ‰‹æ®µã€‚</li></ul><h2 id="æ•°æ®é€šä¿¡">æ•°æ®é€šä¿¡</h2><ul><li>å…¨å±€å˜é‡ä¸å†…å­˜æ•°æ®å—ï¼šåœ¨æ²¡æœ‰è¡Œä¸ºåŒæ­¥è¦æ±‚çš„å‰æä¸‹ï¼Œå½“ä¼ è¾“çš„æ•°æ®é‡ä¸å¤§æ—¶ï¼Œé‡‡ç”¨å…¨å±€å˜é‡å¹¶é…åˆå…³ä¸­æ–­çš„èµ„æºåŒæ­¥æ¹æ–½æ˜¯ä¸€ç§ç»æµã€æœ‰æ•ˆçš„æ–¹æ³•ã€‚</li><li>æ¶ˆæ¯é‚®ç®±ï¼šâ€œæ¶ˆæ¯é‚®ç®±â€å°±æ˜¯å…·æœ‰è¡Œä¸ºåŒæ­¥åŠŸèƒ½çš„é€šä¿¡æ‰‹æ®µï¼Œä¸å…·å¤‡ç¼“å­˜åŠŸèƒ½ï¼Œæ¶ˆè´¹å¿…é¡»åŠæ—¶ã€‚</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯é˜Ÿåˆ—â€æ˜¯å…·æœ‰è¡Œä¸ºåŒæ­¥åŠŸèƒ½å’Œç¼“å†²åŠŸèƒ½çš„æ•°æ®é€šä¿¡æ‰‹æ®µã€‚</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿ ucos-ii æ•™ç¨‹ã€‹<br>ã€Šå‘¨æ…ˆèˆª-åŸºäºåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿçš„ç¨‹åºè®¾è®¡æŠ€æœ¯ã€‹<br>ã€ŠåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»ŸÎ¼COS-II åŸç†åŠåº”ç”¨-ä»»å“²ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> RTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux Driver Tips</title>
      <link href="/2019/Note/LinuxDriverTips/"/>
      <url>/2019/Note/LinuxDriverTips/</url>
      
        <content type="html"><![CDATA[<h1 id="è·å–-ns-æ—¶é—´æˆ³å·²å¼ƒç”¨">è·å– ns æ—¶é—´æˆ³ï¼ˆå·²å¼ƒç”¨ï¼‰</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timekeeping32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">ts</span>;</span></span><br><span class="line">u64 ns;</span><br><span class="line"></span><br><span class="line">getnstimeofday(&amp;ts);</span><br><span class="line">ns = timespec_to_ns(&amp;ts);</span><br></pre></td></tr></tbody></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC9sYXRlc3QvY29yZS1hcGkvdGltZWtlZXBpbmcuaHRtbA==">ktime accessors â€” The Linux Kernel documentation<i class="fa fa-external-link-alt"></i></span></p><p>å¯ä»¥ä½¿ç”¨ ktime_get_ns() æ›¿ä»£ã€‚ å¦‚æœè¦è·å– us æ—¶é—´ä¼šæ¶‰åŠåˆ° 64bit é™¤æ³•é—®é¢˜ï¼Œä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: modpost: <span class="string">"__aeabi_uldivmod"</span> [common_drivers/drivers/usb/dwc_otg.ko] undefined!</span><br></pre></td></tr></tbody></table></figure><p>è°ƒç”¨ div_u64() å‡½æ•°ï¼Œéœ€è¦ include &lt;linux/math64.h&gt;</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u64tm = div_u64(ktime_get_raw_ns(),<span class="number">1000</span>);</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h1 id="dump-stack">Dump Stack</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ptrace.h&gt;</span></span></span><br><span class="line">dump_stack();</span><br></pre></td></tr></tbody></table></figure><h1 id="linux-ä¸­æ ¹æ®å‡½æ•°æŒ‡é’ˆæ‰“å°å‡½æ•°å">Linux ä¸­æ ¹æ®å‡½æ•°æŒ‡é’ˆæ‰“å°å‡½æ•°å</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(<span class="string">"func: %pS at address: %px\\n"</span>, func, func);</span><br></pre></td></tr></tbody></table></figure><h1 id="è°ƒæ•´çº¿ç¨‹ä¼˜å…ˆçº§">è°ƒæ•´çº¿ç¨‹ä¼˜å…ˆçº§</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/sched/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span> <span class="title">param</span> =</span> { .sched_priority = <span class="number">99</span> };</span><br><span class="line">thread_handle = kthread_run(thread_capture, audio_pcm, <span class="string">"dsp_cap"</span>);</span><br><span class="line">sched_setscheduler(thread_handle, SCHED_FIFO, &amp;param);</span><br></pre></td></tr></tbody></table></figure><h1 id="ä¿¡å·é‡">ä¿¡å·é‡</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">sema_init(&amp;sem, <span class="number">0</span>);</span><br><span class="line">up(&amp;sem);</span><br><span class="line">down_timeout(&amp;sem, usecs_to_jiffies(sleep_us))</span><br></pre></td></tr></tbody></table></figure><h1 id="timer">Timer</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tests</span>{</span></span><br><span class="line"><span class="type">int</span> my_numberï¼›</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">my_timer</span>ï¼›</span></span><br><span class="line"><span class="class">} <span class="title">my_data</span>;</span>  <span class="comment">//å£°æ˜å®šæ—¶å™¨å…¨å±€å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å®šæ—¶å™¨åˆ°æœŸæ‰§è¡Œçš„å‡½æ•°ï¼Œåœ¨æ­¤åªæœ‰æ˜¾ç¤ºçš„åŠŸèƒ½ï¼Œä¸åšä»»ä½•å¤„ç†</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_timer_function</span><span class="params">(<span class="keyword">struct</span> timer_list *t)</span><span class="comment">//è¿™é‡Œå‚æ•°æœ‰å˜åŒ–ï¼</span></span><br><span class="line">{</span><br><span class="line">    printk(<span class="string">"In the my_timer_function\\n"</span>);</span><br><span class="line">    printk(<span class="string">"the jiffies is :%ld\\n"</span>, jiffies);     <span class="comment">//æ˜¾ç¤ºå½“å‰çš„èŠ‚æ‹æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tests</span> *<span class="title">datas</span> =</span> from_timer(datas,t,my_timer);<span class="comment">//åœ¨è¿™é‡Œä» timer æ‰¾åˆ°åŒ…å«å…¶çš„ç»“æ„ä½“é¦–åœ°å€ï¼</span></span><br><span class="line">    printk(<span class="string">"my number is :%d\\n"</span>, tests-&gt;my_number);                                              </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __init <span class="title function_">setup_timer_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    printk(<span class="string">"my_timer will be created.\\n"</span>);</span><br><span class="line">    printk(<span class="string">"the jiffies is :%ld\\n"</span>, jiffies);      <span class="comment">//æ˜¾ç¤ºå½“å‰çš„èŠ‚æ‹æ•°</span></span><br><span class="line">    my_data.my_timer.expires = jiffies + <span class="number">1</span>*HZ;            <span class="comment">//HZ=250ï¼Œåˆå§‹åŒ–å­—æ®µ expires çš„å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å®šæ—¶å™¨å˜é‡çš„ function å’Œ data å­—æ®µ</span></span><br><span class="line">    timer_setup(&amp;my_data.my_timer, my_timer_function, <span class="number">0</span>);<span class="comment">//è®¾ç½®å®šæ—¶å™¨</span></span><br><span class="line">    add_timer(&amp;my_data.my_timer);     <span class="comment">//å°†å®šæ—¶å™¨å˜é‡åŠ å…¥åˆ°åˆé€‚çš„é“¾è¡¨ï¼Œæ¿€æ´»å®šæ—¶å™¨</span></span><br><span class="line">    printk(<span class="string">"my_timer init.\\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __exit <span class="title function_">setup_timer_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    printk(<span class="string">"Goodbye setup_timer\\n"</span>);</span><br><span class="line">    del_timer(&amp;my_data.my_timer);  <span class="comment">//åˆ é™¤å®šæ—¶å™¨å˜é‡</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">module_init(setup_timer_init);</span><br><span class="line">module_exit(setup_timer_exit);</span><br></pre></td></tr></tbody></table></figure><h1 id="module-param">module param</h1><h2 id="module_paraminsmod-ko-æ–‡ä»¶æ—¶ä¼ é€’å‚æ•°">module_param(insmod ko æ–‡ä»¶æ—¶ä¼ é€’å‚æ•°ï¼‰</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define MY_MAJOR 0x09</span></span><br><span class="line">static int global_val_test = MY_MAJOR;</span><br><span class="line">module_param(global_val_test, int, 0644);</span><br></pre></td></tr></tbody></table></figure><p>å†ç¼–è¯‘æ¨¡å—åï¼Œå† insmod åŠ è½½æ¨¡å—æ—¶å°±å¯ä»¥ä¼ å‚æ•°è¿›å»äº†ï¼Œå¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon hello_world]<span class="comment"># insmod first_hello.ko global_val_test=5</span></span><br><span class="line">[root@bogon hello_world]<span class="comment"># tail /var/log/messages</span></span><br><span class="line">May 26 14:20:08 localhost kernel: [63460.994397] global_val_test = 5</span><br><span class="line">May 26 14:20:08 localhost kernel: [63460.994409] hello world enter</span><br><span class="line">May 26 14:20:08 localhost kernel: global_val_test = 5</span><br><span class="line">May 26 14:20:08 localhost kernel: hello world enter</span><br></pre></td></tr></tbody></table></figure><p>åŒæ—¶ï¼Œåœ¨æ¨¡å—ç›®å½•ä¸‹ä¼šç”Ÿæˆ parameter ç›®å½•åŠå‚æ•°æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon hello_world]<span class="comment"># cat /sys/module/first_hello/</span></span><br><span class="line">coresize     holders/     initsize     initstate    notes/       parameters/  refcnt       rhelversion  sections/    srcversion   taint        uevent       version</span><br><span class="line">[root@bogon hello_world]<span class="comment"># ls -alt /sys/module/first_hello/parameters/</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 16384 May 26 14:54 global_val_test</span><br></pre></td></tr></tbody></table></figure><h2 id="module_parm_desc">MODULE_PARM_DESC</h2><p>MODULE_PARM_DESC æ˜¯ç”¨æ¥æè¿°é©±åŠ¨æ¨¡å—çš„å‚æ•°ä¿¡æ¯çš„ã€‚ ä¾‹å¦‚é©±åŠ¨å†…æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç ï¼šMODULE_PARM_DESC(stacfgpath, "Get path of sta cfg"); å‡è®¾ç¼–è¯‘ç”Ÿæˆçš„é©±åŠ¨æ–‡ä»¶ä¸º test.ko æˆ‘ä»¬ä½¿ç”¨ï¼šmodinfo test.ko</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#:modinfo test.ko</span></span><br><span class="line">filename:    /home/test/test.ko</span><br><span class="line">license:     GPL</span><br><span class="line">srcversion:  </span><br><span class="line">depends:</span><br><span class="line">retpoline:   Y</span><br><span class="line">name:        <span class="built_in">test</span></span><br><span class="line">vermagic:    4.15.0-129-generic SMP mod_unload</span><br><span class="line">parm:        stacfgpath:Get path of sta cfg (charp)</span><br></pre></td></tr></tbody></table></figure><p>MODULE_PARM_DESC å†…æè¿°çš„ä¿¡æ¯å°±ä¼šåœ¨ parm è¿™ä¸€è¡Œå‚æ•°æ˜¾ç¤ºå‡ºæ¥ï¼Œè¿™æ ·ç”¨æˆ·å°±çŸ¥é“è¦åŠ è½½è¿™ä¸ªé©±åŠ¨å¯ä»¥ä¼ å…¥å“ªäº›å‚æ•°äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker å¸¸ç”¨å‘½ä»¤</title>
      <link href="/2019/Note/DockerUsage/"/>
      <url>/2019/Note/DockerUsage/</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1><h2 id="è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å¹¶å¯åŠ¨-docker-ce">è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å¹¶å¯åŠ¨ Docker-CE</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="æ·»åŠ å½“å‰ç”¨æˆ·åˆ°-docker-ç”¨æˆ·ç»„å¯ä»¥ä¸ç”¨-sudo-è¿è¡Œ-docker">æ·»åŠ å½“å‰ç”¨æˆ·åˆ° docker ç”¨æˆ·ç»„ï¼Œå¯ä»¥ä¸ç”¨ sudo è¿è¡Œ docker</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è·å–-archlinux-é•œåƒ">è·å– archlinux é•œåƒ</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull base/archlinux</span><br></pre></td></tr></tbody></table></figure><h1 id="é•œåƒä½¿ç”¨">é•œåƒä½¿ç”¨</h1><h2 id="åˆ—å‡ºæ‰€æœ‰é•œåƒ">åˆ—å‡ºæ‰€æœ‰é•œåƒ</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image <span class="built_in">ls</span> -a</span><br></pre></td></tr></tbody></table></figure><h2 id="åˆ é™¤é•œåƒ">åˆ é™¤é•œåƒ</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image <span class="built_in">rm</span> image_id</span><br></pre></td></tr></tbody></table></figure><h1 id="å®¹å™¨ä½¿ç”¨">å®¹å™¨ä½¿ç”¨</h1><h2 id="æ–°å»ºå®¹å™¨å¹¶æŒ‚è½½æœ¬åœ°ç›®å½•"><strong>æ–°å»ºå®¹å™¨å¹¶æŒ‚è½½æœ¬åœ°ç›®å½•</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /home/carlyleliu/share/docker/ubuntu18:/share/ techliu/ubuntu /bin/bash</span><br><span class="line">docker run -it -v /home/carlyleliu/share/docker/ubuntu20:/share/ ubuntu /bin/bash</span><br><span class="line"></span><br><span class="line">docker run -it -v /home/carlyleliu/Workspace/Docker/ubuntu22:/share/ ubuntu:22.04 /bin/bash</span><br><span class="line"></span><br><span class="line">docker network create --subnet=172.18.0.0/16 docker_net</span><br><span class="line">docker run --net docker_net --ip 172.18.0.11 -p 2222:22 -it --name ubuntu -v /d/Docker/ubuntu:/share/ ubuntu /bin/bash</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="å¯åŠ¨å®¹å™¨"><strong>å¯åŠ¨å®¹å™¨</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start ubuntu</span><br></pre></td></tr></tbody></table></figure><h2 id="è¿›å…¥-shell"><strong>è¿›å…¥ shell</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach ubuntu</span><br></pre></td></tr></tbody></table></figure><h1 id="åˆ¶ä½œé•œåƒå¹¶ä¸Šä¼ ">åˆ¶ä½œé•œåƒå¹¶ä¸Šä¼ </h1><h2 id="åˆ¶ä½œé•œåƒ"><strong>åˆ¶ä½œé•œåƒ</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m <span class="string">"xxxx"</span> -a <span class="string">"techliu &lt;yyliushuai@gmail.com&gt;"</span> container_id repository_name</span><br></pre></td></tr></tbody></table></figure><h2 id="ç™»å½•"><strong>ç™»å½•</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸Šä¼ "><strong>ä¸Šä¼ </strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag ubuntu18:latest techliu/ubuntu:latest</span><br><span class="line">docker push techliu/ubuntu:latest</span><br></pre></td></tr></tbody></table></figure><h2 id="å…¼å®¹å¤šå¹³å°">å…¼å®¹å¤šå¹³å°</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build --platform linux/amd64,linux/arm64 --tag techliu/ubuntu:latest --push .</span><br></pre></td></tr></tbody></table></figure><h2 id="éªŒè¯"><strong>éªŒè¯</strong></h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect techliu/ubuntu</span><br></pre></td></tr></tbody></table></figure><h1 id="å®¹å™¨ä¸ä¸»æœºä¹‹é—´æ–‡ä»¶æ‹·è´">å®¹å™¨ä¸ä¸»æœºä¹‹é—´æ–‡ä»¶æ‹·è´</h1><h2 id="å®¹å™¨åˆ°ä¸»æœº">å®¹å™¨åˆ°ä¸»æœº</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> ubuntu20.04:/workspace/dir /host-dir</span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸»æœºåˆ°å®¹å™¨">ä¸»æœºåˆ°å®¹å™¨</h2><p><strong>è·å–ç¡®å®šå®¹å™¨ id</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></tbody></table></figure><p><strong>ç¡®å®šå®¹å™¨é•¿ id</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">'{{.ID}}'</span> ubuntu20.04</span><br></pre></td></tr></tbody></table></figure><p><strong>æ‹·è´æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span>  /host-dir docker-long-id:/workspace/docker-dir</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C/C++ Tips</title>
      <link href="/2019/Note/CPPTips/"/>
      <url>/2019/Note/CPPTips/</url>
      
        <content type="html"><![CDATA[<h1 id="c-tips">C Tips</h1><h2 id="åŒºåˆ«ä»¥ä¸‹å‡½æ•°">åŒºåˆ«ä»¥ä¸‹å‡½æ•°</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>* <span class="title function_">f</span><span class="params">()</span>;        <span class="comment">//f ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°è¿”å›å€¼ä¸ºæŒ‡å‘æ•´å½¢çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span> (*f)();      <span class="comment">//f ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="type">int</span>* f[];        <span class="comment">//f ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„å†…å®¹ä¸ºæŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span> (*f[])();    <span class="comment">//f ä¸ºæ•°ç»„ï¼Œæ•°ç»„çš„å†…å®¹ä¸ºæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span>*(*f[])();    <span class="comment">//f ä¸ºæ•°ç»„ï¼Œæ•°ç»„çš„å†…å®¹ä¸ºæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘æ•´å½¢çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">f</span><span class="params">()</span>[];       <span class="comment">//ä¸å­˜åœ¨</span></span><br><span class="line"><span class="type">int</span> f[]();       <span class="comment">//ä¸å­˜åœ¨</span></span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="å®å®šä¹‰">å®å®šä¹‰</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _SYSCALL_CONCAT(arg1, arg2) __SYSCALL_CONCAT(arg1, arg2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYSCALL_CONCAT(arg1, arg2) ___SYSCALL_CONCAT(arg1, arg2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___SYSCALL_CONCAT(arg1, arg2) arg1##arg2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SYSCALL_NARG(...) __SYSCALL_NARG(__VA_ARGS__, __SYSCALL_RSEQ_N())</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYSCALL_NARG(...) __SYSCALL_ARG_N(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYSCALL_ARG_N(_1, _2, _3, _4, _5, _6, _7, N, ...) N</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYSCALL_RSEQ_N() 6, 5, 4, 3, 2, 1, 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Z_SYSCALL_HANDLER(...) \\</span></span><br><span class="line"><span class="meta"> _SYSCALL_CONCAT(__SYSCALL_HANDLER, \\</span></span><br><span class="line"><span class="meta">   _SYSCALL_NARG(__VA_ARGS__))(__VA_ARGS__)</span></span><br></pre></td></tr></tbody></table></figure><h2 id="container_of-å®">container_of å®</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> container_of(ptr, type, member) ({ \\</span></span><br><span class="line"><span class="meta">const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \\</span></span><br><span class="line"><span class="meta">(type *)( (char *)__mptr - offsetof(type,member) );})</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥é€šè¿‡ç»“æ„ä½“ä¸­çš„ä¸€ä¸ªæˆå‘˜è·å¾—è¯¥ç»“æ„ä½“é¦–åœ°å€ã€‚ç²¾é«“åœ¨äºå®šä¹‰è¯¥ç»“æ„ä½“å¹¶å°†å…¶æ”¾åˆ° 0 åœ°å€å¤„é€šè¿‡å·²çŸ¥æˆå‘˜è·å¾—åç§»ä»è€Œè®¡ç®—å‡ºé¦–åœ°å€</p><h2 id="builtin_expect">__builtin_expect</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x) __builtin_expect((bool)!!(x), true)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect((bool)!!(x), false)</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªå®å®šä¹‰çš„ä½œç”¨æ˜¯ä¼˜åŒ–ä»£ç ï¼Œå‡å°‘æŒ‡ä»¤è·³è½¬æ¬¡æ•°ã€‚</p><p>åœ¨å®é™…ä½¿ç”¨ä¸­ä¾‹å¦‚</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="built_in">likely</span>( x ) ) {</span><br><span class="line">    ...</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">   ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å½“ x ä¸º true çš„åœºæ™¯è¾ƒå¤šæ—¶å¯ä»¥ä¼˜åŒ–ä»£ç å‡å°‘è·³è½¬æ¬¡æ•°ç›¸åå½“ x å€¾å‘äº false æ—¶ç”¨ unlikelyï¼Œè¿™ä¸ªä¸»è¦æ˜¯ cpu é¢„å–æŒ‡ç›¸å…³å†…å®¹ã€‚</p><h1 id="c-tips-1">C++ Tips</h1><h2 id="conversion-function">conversion function</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fraction</span>{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Fraction</span>(<span class="type">int</span> num,<span class="type">int</span> den = <span class="number">1</span>):</span><br><span class="line"><span class="built_in">m_numerator</span>(num),</span><br><span class="line"><span class="built_in">m_denominnator</span>(den)</span><br><span class="line">{}</span><br><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line"><span class="keyword">return</span> (<span class="type">double</span>)(m_numerator / m_denominnator);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> m_numerator;    <span class="comment">//åˆ†å­</span></span><br><span class="line"><span class="type">int</span> m_denominnator; <span class="comment">//åˆ†æ¯</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç”¨æ³•ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Fraction <span class="title">f</span><span class="params">(<span class="number">3</span>,<span class="number">5</span>)</span></span>;</span><br><span class="line"><span class="type">double</span> d = <span class="number">4</span> + f; <span class="comment">//è°ƒç”¨ double() å°† f è½¬æ¢ä¸º 0.6</span></span><br></pre></td></tr></tbody></table></figure><p>å®é™…ä¸Šåšï¼ˆï¼‰è¿ç®—ç¬¦çš„é‡è½½ã€‚</p><h2 id="explicit">explicit</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fraction</span>{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Fraction</span>(<span class="type">int</span> num,<span class="type">int</span> den = <span class="number">1</span>):</span><br><span class="line"><span class="built_in">m_numerator</span>(num),</span><br><span class="line"><span class="built_in">m_denominnator</span>(den)</span><br><span class="line">{}</span><br><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line"><span class="keyword">return</span> (<span class="type">double</span>)(m_numerator / m_denominnator);</span><br><span class="line">}</span><br><span class="line">Fraction <span class="keyword">operator</span>+(<span class="type">const</span> Fraction&amp; f){</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">Fraction</span>(...);</span><br><span class="line">} </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> m_numerator;    <span class="comment">//åˆ†å­</span></span><br><span class="line"><span class="type">int</span> m_denominnator; <span class="comment">//åˆ†æ¯</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç”¨æ³•ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Fraction <span class="title">f</span><span class="params">(<span class="number">3</span>,<span class="number">5</span>)</span></span>;</span><br><span class="line">Fraction d = f + <span class="number">4</span>; <span class="comment">//4: è°ƒç”¨ none-explicitctor å°† 4 è½¬åŒ–ä¸º Fraction(4,1) ç„¶åè°ƒç”¨ operator+</span></span><br><span class="line"><span class="comment">//f: å¯ä»¥å°† f è½¬åŒ–ä¸º double è¿™æ ·å°±æœ‰æ­§ä¹‰</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fraction</span>{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">Fraction</span><span class="params">(<span class="type">int</span> num,<span class="type">int</span> den = <span class="number">1</span>)</span>:</span></span><br><span class="line"><span class="function">m_numerator(num),</span></span><br><span class="line"><span class="function">m_denominnator(den)</span></span><br><span class="line"><span class="function">{</span>}</span><br><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line"><span class="keyword">return</span> (<span class="type">double</span>)(m_numerator / m_denominnator);</span><br><span class="line">}</span><br><span class="line">Fraction <span class="keyword">operator</span>+(<span class="type">const</span> Fraction&amp; f){</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">Fraction</span>(...);</span><br><span class="line">} </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> m_numerator;    <span class="comment">//åˆ†å­</span></span><br><span class="line"><span class="type">int</span> m_denominnator; <span class="comment">//åˆ†æ¯</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ · 4 å°±æ²¡åŠæ³•è½¬åŒ–ä¸º Fractor(4,1) äº†ï¼Œè¿™ä¸ªå…³é”®å­—åªå¯¹å•å‚æ•° class èµ·ä½œç”¨</p><h2 id="share_ptr">share_ptr</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Program1.png"></p><h2 id="iterator">iterator</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Program2.png"></p><h2 id="æ¨¡æ¿ç‰¹åŒ–å’Œåç‰¹åŒ–">æ¨¡æ¿ç‰¹åŒ–å’Œåç‰¹åŒ–</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç‰¹åŒ– */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">key</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hash</span> {};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hash</span>&lt;<span class="type">char</span>&gt; {</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">char</span> x)</span> <span class="type">const</span> </span>{<span class="keyword">return</span> x;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hash</span>&lt;<span class="type">int</span>&gt; {</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> x)</span> <span class="type">const</span> </span>{<span class="keyword">return</span> x;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hash</span>&lt;<span class="type">long</span>&gt; {</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">long</span> x)</span> <span class="type">const</span> </span>{<span class="keyword">return</span> x;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åç‰¹åŒ– */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span> Alloc=...&gt;</span><br><span class="line"><span class="keyword">class</span> vector {</span><br><span class="line">...</span><br><span class="line">};</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Alloc=...&gt;</span><br><span class="line"><span class="keyword">class</span> vector&lt;<span class="type">bool</span>,Alloc&gt; {</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="æ¨¡æ¿æ¨¡æ¿å‚æ•°">æ¨¡æ¿æ¨¡æ¿å‚æ•°</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T,  </span><br><span class="line">         <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;  </span><br><span class="line">             <span class="keyword">class</span> <span class="title class_">Container</span> </span><br><span class="line">    &gt; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XCls</span> </span><br><span class="line">{  </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"> Container&lt;T&gt; c; </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">XCls</span>() { </span><br><span class="line">...</span><br><span class="line">}</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h2 id="override">override</h2><p>æ´¾ç”Ÿç±»å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ä¸åŸºç±»ä¸­çš„è™šå‡½æ•°åå­—ç›¸åŒä½†æ˜¯å‚æ•°å´ä¸åŒï¼Œæˆ‘ä»¬æœ¬æ¥æƒ³ overwrite åŸºç±»ä¸­çš„è™šå‡½æ•°ï¼Œä½†æ˜¯å‚æ•°ä¸åŒå¹¶ä¸ä¼šæŠ¥é”™è€Œæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™ä¸ªé—®é¢˜ä¸€èˆ¬å¾ˆéš¾å‘ç°ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ overridr å…³é”®å­—æ¥è¿›è¡Œæ£€æŸ¥ã€‚</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">virture <span class="type">void</span> <span class="title">f1</span><span class="params">(<span class="type">int</span>)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function">virture <span class="type">void</span> <span class="title">f2</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f3</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> :<span class="keyword">public</span> A {</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(<span class="type">int</span>)</span> <span class="type">const</span> <span class="keyword">override</span></span>; <span class="comment">//æ­£ç¡® f1 ä¸åŸºç±»çš„ f1 åŒ¹é…</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(<span class="type">int</span>)</span> <span class="keyword">override</span></span>;       <span class="comment">//é”™è¯¯ï¼ŒA ä¸­æ²¡æœ‰ f2ï¼ˆintï¼‰</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f3</span><span class="params">()</span> <span class="keyword">override</span></span>;          <span class="comment">//é”™è¯¯ï¼Œf3() ä¸æ˜¯è™šå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f4</span><span class="params">()</span> <span class="keyword">override</span></span>;          <span class="comment">//é”™è¯¯ A ä¸­æ²¡æœ‰ f4() å‡½æ•°</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="final">final</h2><p>å®šä¹‰ä¸º final çš„å‡½æ•°ï¼Œä¹‹åæ´¾ç”Ÿç±»çš„ä»»ä½•è¦†ç›–è¯¥å‡½æ•°çš„è¡Œä¸ºéƒ½æ˜¯éæ³•çš„</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>: <span class="keyword">public</span> A {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(<span class="type">int</span>)</span> <span class="type">const</span> <span class="keyword">final</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span>: <span class="keyword">public</span> C {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(<span class="type">int</span>)</span> <span class="type">const</span></span>; <span class="comment">//é”™è¯¯ C ä¸­å·²ç»å°† f1 å£°æ˜ä¸º final äº†</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="stdremove_cv-stdremove_reference"><strong>std::remove_cv &amp; std::remove_reference</strong></h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// remove_cv example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">volatile</span> <span class="type">char</span> cvchar;</span><br><span class="line">  std::remove_cv&lt;cvchar&gt;::type a;       <span class="comment">// char a</span></span><br><span class="line">  std::remove_cv&lt;<span class="type">char</span>* <span class="type">const</span>&gt;::type b;  <span class="comment">// char* b</span></span><br><span class="line">  std::remove_cv&lt;<span class="type">const</span> <span class="type">char</span>*&gt;::type c;  <span class="comment">// const char* c (no changes)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (std::is_const&lt;<span class="keyword">decltype</span>(a)&gt;::value)</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"type of a is const"</span> &lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"type of a is not const"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (std::is_volatile&lt;<span class="keyword">decltype</span>(a)&gt;::value)</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"type of a is volatile"</span> &lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"type of a is not volatile"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Output:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> of a is not const</span><br><span class="line"><span class="built_in">type</span> of a is not volatile</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="stdfunction"><strong>std::function</strong></h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>     <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>   <span class="comment">// std::function, std::negate</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a function:</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">half</span><span class="params">(<span class="type">int</span> x)</span> </span>{<span class="keyword">return</span> x/<span class="number">2</span>;}</span><br><span class="line"></span><br><span class="line"><span class="comment">// a function object class:</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">third_t</span> {</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> x)</span> </span>{<span class="keyword">return</span> x/<span class="number">3</span>;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// a class with data members:</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyValue</span> {</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">fifth</span><span class="params">()</span> </span>{<span class="keyword">return</span> value/<span class="number">5</span>;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span> </span>{</span><br><span class="line">  std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; fn1 = half;                    <span class="comment">// function</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; fn2 = &amp;half;                   <span class="comment">// function pointer</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; fn3 = <span class="built_in">third_t</span>();               <span class="comment">// function object</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; fn4 = [](<span class="type">int</span> x){<span class="keyword">return</span> x/<span class="number">4</span>;};  <span class="comment">// lambda expression</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; fn5 = std::<span class="built_in">negate</span>&lt;<span class="type">int</span>&gt;();      <span class="comment">// standard function object</span></span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fn1(60): "</span> &lt;&lt; <span class="built_in">fn1</span>(<span class="number">60</span>) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fn2(60): "</span> &lt;&lt; <span class="built_in">fn2</span>(<span class="number">60</span>) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fn3(60): "</span> &lt;&lt; <span class="built_in">fn3</span>(<span class="number">60</span>) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fn4(60): "</span> &lt;&lt; <span class="built_in">fn4</span>(<span class="number">60</span>) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fn5(60): "</span> &lt;&lt; <span class="built_in">fn5</span>(<span class="number">60</span>) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stuff with members:</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(MyValue&amp;)&gt; value = &amp;MyValue::value;  <span class="comment">// pointer to data member</span></span><br><span class="line">  std::function&lt;<span class="type">int</span>(MyValue&amp;)&gt; fifth = &amp;MyValue::fifth;  <span class="comment">// pointer to member function</span></span><br><span class="line"></span><br><span class="line">  MyValue sixty {<span class="number">60</span>};</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">"value(sixty): "</span> &lt;&lt; <span class="built_in">value</span>(sixty) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"fifth(sixty): "</span> &lt;&lt; <span class="built_in">fifth</span>(sixty) &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Output:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fn1(60): 30</span><br><span class="line">fn2(60): 30</span><br><span class="line">fn3(60): 20</span><br><span class="line">fn4(60): 15</span><br><span class="line">fn5(60): -60</span><br><span class="line">value(sixty): 60</span><br><span class="line">fifth(sixty): 12</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="stdtype_index"><strong>std::type_index</strong></h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type_index example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>       <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span>       <span class="comment">// operator typeid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeindex&gt;</span>      <span class="comment">// std::type_index</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span>  <span class="comment">// std::unordered_map</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span>         <span class="comment">// std::string</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">C</span> {};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  std::unordered_map&lt;std::type_index,std::string&gt; mytypes;</span><br><span class="line"></span><br><span class="line">  mytypes[<span class="built_in">typeid</span>(<span class="type">int</span>)]=<span class="string">"Integer type"</span>;</span><br><span class="line">  mytypes[<span class="built_in">typeid</span>(<span class="type">double</span>)]=<span class="string">"Floating-point type"</span>;</span><br><span class="line">  mytypes[<span class="built_in">typeid</span>(C)]=<span class="string">"Custom class named C"</span>;</span><br><span class="line"></span><br><span class="line">  std::cout &lt;&lt; <span class="string">"int: "</span> &lt;&lt; mytypes[<span class="built_in">typeid</span>(<span class="type">int</span>)] &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"double: "</span> &lt;&lt; mytypes[<span class="built_in">typeid</span>(<span class="type">double</span>)] &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">"C: "</span> &lt;&lt; mytypes[<span class="built_in">typeid</span>(C)] &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Output:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int: Integer <span class="built_in">type</span></span><br><span class="line">double: Floating-point <span class="built_in">type</span></span><br><span class="line">C: Custom class named C</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="stdbind">std::bind</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bind example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>     <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>   <span class="comment">// std::bind</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a function: (also works with function object: std::divides&lt;double&gt; my_divide;)</span></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">my_divide</span> <span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span> </span>{<span class="keyword">return</span> x/y;}</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyPair</span> {</span><br><span class="line">  <span class="type">double</span> a,b;</span><br><span class="line">  <span class="function"><span class="type">double</span> <span class="title">multiply</span><span class="params">()</span> </span>{<span class="keyword">return</span> a*b;}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;    <span class="comment">// adds visibility of _1, _2, _3,...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// binding functions:</span></span><br><span class="line">  <span class="keyword">auto</span> fn_five = std::<span class="built_in">bind</span> (my_divide,<span class="number">10</span>,<span class="number">2</span>);               <span class="comment">// returns 10/2</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">fn_five</span>() &lt;&lt; <span class="string">'\\n'</span>;                          <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fn_half = std::<span class="built_in">bind</span> (my_divide,_1,<span class="number">2</span>);               <span class="comment">// returns x/2</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">fn_half</span>(<span class="number">10</span>) &lt;&lt; <span class="string">'\\n'</span>;                        <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fn_invert = std::<span class="built_in">bind</span> (my_divide,_2,_1);            <span class="comment">// returns y/x</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">fn_invert</span>(<span class="number">10</span>,<span class="number">2</span>) &lt;&lt; <span class="string">'\\n'</span>;                    <span class="comment">// 0.2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fn_rounding = std::<span class="built_in">bind</span>&lt;<span class="type">int</span>&gt; (my_divide,_1,_2);     <span class="comment">// returns int(x/y)</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">fn_rounding</span>(<span class="number">10</span>,<span class="number">3</span>) &lt;&lt; <span class="string">'\\n'</span>;                  <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">  MyPair ten_two {<span class="number">10</span>,<span class="number">2</span>};</span><br><span class="line"></span><br><span class="line">  <span class="comment">// binding members:</span></span><br><span class="line">  <span class="keyword">auto</span> bound_member_fn = std::<span class="built_in">bind</span> (&amp;MyPair::multiply,_1); <span class="comment">// returns x.multiply()</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">bound_member_fn</span>(ten_two) &lt;&lt; <span class="string">'\\n'</span>;           <span class="comment">// 20</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> bound_member_data = std::<span class="built_in">bind</span> (&amp;MyPair::a,ten_two); <span class="comment">// returns ten_two.a</span></span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">bound_member_data</span>() &lt;&lt; <span class="string">'\\n'</span>;                <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Output:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">0.2</span><br><span class="line">3</span><br><span class="line">20</span><br><span class="line">10</span><br></pre></td></tr></tbody></table></figure><h2 id="stdlock_guard">std::lock_guard</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock_guard example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>       <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>         <span class="comment">// std::thread</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>          <span class="comment">// std::mutex, std::lock_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span>      <span class="comment">// std::logic_error</span></span></span><br><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_even</span> <span class="params">(<span class="type">int</span> x)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (x%<span class="number">2</span>==<span class="number">0</span>) std::cout &lt;&lt; x &lt;&lt; <span class="string">" is even\\n"</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="built_in">throw</span> (std::<span class="built_in">logic_error</span>(<span class="string">"not even"</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_thread_id</span> <span class="params">(<span class="type">int</span> id)</span> </span>{</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// using a local lock_guard to lock mtx guarantees unlocking on destruction / exception:</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lck</span> <span class="params">(mtx)</span></span>;</span><br><span class="line">    <span class="built_in">print_even</span>(id);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">catch</span> (std::logic_error&amp;) {</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"[exception caught]\\n"</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  std::thread threads[<span class="number">10</span>];</span><br><span class="line">  <span class="comment">// spawn 10 threads:</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; ++i)</span><br><span class="line">    threads[i] = std::<span class="built_in">thread</span>(print_thread_id,i+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; th : threads) th.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Possible output:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[exception caught]</span><br><span class="line">2 is even</span><br><span class="line">[exception caught]</span><br><span class="line">4 is even</span><br><span class="line">[exception caught]</span><br><span class="line">6 is even</span><br><span class="line">[exception caught]</span><br><span class="line">8 is even</span><br><span class="line">[exception caught]</span><br><span class="line">10 is even</span><br></pre></td></tr></tbody></table></figure><h2 id="stdpromise">std::promise</h2><p><strong>std::promise å’Œ std::future ç”¨äºçº¿ç¨‹å¼‚æ­¥</strong></p><p>waitForSubmittedTasks å‡½æ•°å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼ŒflushedFuture.wait(); ä¼šä¼‘çœ ç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼ŒflushedPromise.set_value() ä¼šå¯¼è‡´å˜é‡ readyï¼Œåªæœ‰ ready äº†çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’ï¼Œç»“æŸå‡½æ•°ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void SharedExecutor::waitForSubmittedTasks() noexcept {</span><br><span class="line">    std::unique_lock&lt;std::mutex&gt; lock{m_queueMutex};</span><br><span class="line">    <span class="keyword">if</span> (m_threadRunning) {</span><br><span class="line">        // <span class="built_in">wait</span> <span class="keyword">for</span> thread to <span class="built_in">exit</span>.</span><br><span class="line">        std::promise&lt;void&gt; flushedPromise;</span><br><span class="line">        auto flushedFuture = flushedPromise.get_future();</span><br><span class="line">        m_queue.emplace_back([&amp;flushedPromise]() { flushedPromise.set_value(); });</span><br><span class="line"></span><br><span class="line">        lock.unlock();</span><br><span class="line">        flushedFuture.<span class="built_in">wait</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="stdcondition_variable"><strong>std::condition_variable</strong></h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// condition_variable example</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>           <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>             <span class="comment">// std::thread</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>              <span class="comment">// std::mutex, std::unique_lock</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// std::condition_variable</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::mutex mtx;</span><br><span class="line"><span class="built_in">std</span>::condition_variable cv;</span><br><span class="line"><span class="type">bool</span> ready = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_id</span> <span class="params">(<span class="type">int</span> id)</span> {</span><br><span class="line">  <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title function_">lck</span><span class="params">(mtx)</span>;</span><br><span class="line">  <span class="keyword">while</span> (!ready) cv.wait(lck);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread "</span> &lt;&lt; id &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">go</span><span class="params">()</span> {</span><br><span class="line">  <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title function_">lck</span><span class="params">(mtx)</span>;</span><br><span class="line">  ready = <span class="literal">true</span>;</span><br><span class="line">  cv.notify_all();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">{</span><br><span class="line">  <span class="built_in">std</span>::thread threads[<span class="number">10</span>];</span><br><span class="line">  <span class="comment">// spawn 10 threads:</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; ++i)</span><br><span class="line">    threads[i] = <span class="built_in">std</span>::thread(print_id,i);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"10 threads ready to race...\\n"</span>;</span><br><span class="line">  go();                       <span class="comment">// go!</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; th : threads) th.join();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>Possible output (thread order may vary):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">10 threads ready to race...</span><br><span class="line">thread 2</span><br><span class="line">thread 0</span><br><span class="line">thread 9</span><br><span class="line">thread 4</span><br><span class="line">thread 6</span><br><span class="line">thread 8</span><br><span class="line">thread 7</span><br><span class="line">thread 5</span><br><span class="line">thread 3</span><br><span class="line">thread 1</span><br></pre></td></tr></tbody></table></figure><h2 id="type_traits"><strong>type_traits</strong></h2><h2 id="ç©ºç±»çš„ä½œç”¨">ç©ºç±»çš„ä½œç”¨</h2><p>è¿˜æœ‰ä¸€ä¸ªå…³äºç©ºç±»çš„ç–‘é—®å°±æ˜¯ï¼ŒC++è¯­è¨€æœ‰å¿…è¦ä¿ç•™ç©ºç±»å—ï¼Ÿç©ºç±»å®ç°ç©ºå¯¹è±¡æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p><p>æœ‰ç”¨çš„ï¼Œå°¤å…¶æ˜¯åœ¨â€œæ³›å‹ç¼–ç¨‹â€ä¸­ï¼Œç©ºç±»ï¼ˆç»“æ„ï¼‰çš„ç”¨å¤„éå¸¸å¹¿ï¼š</p><p>åœ¨å…¶ä»–çš„æ–‡ç« ä¸­æåˆ°ï¼Œæˆ‘ä»¬åˆ©ç”¨ç±»å‹ï¼ˆé€šå¸¸æ˜¯ç©ºç±»ï¼‰æ¥åŒºåˆ«å¯¹å¾…ä¸åŒç±»å¯¹è±¡çš„å±æ€§ã€‚ï¼ˆå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡ä½¿ç”¨å¸¸æ•°æ¥åŒºåˆ†çš„ï¼Œä½†æ˜¯åŒºåˆ«æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½çŸ¥é“ï¼‰ã€‚</p><p>ä½¿ç”¨å¸¸æ•°æ¥åŒºåˆ†éœ€è¦ä½¿ç”¨ if else çš„è¿™ç§è¿è¡Œæ—¶æ¥ç¡®å®šæ‰§è¡Œçš„çº¿è·¯çš„æ–¹æ³•ï¼Œè€Œä½¿ç”¨å‡½æ•°é‡è½½çš„æ–¹æ³•ï¼Œåœ¨å‚æ•°ä¸­åŠ å…¥ä¸€ä¸ªç©ºç±»åŸŸä½œä¸ºåŒºåˆ†ä¸åŒçš„å‡½æ•°çš„æ–¹æ³•ï¼Œç¼–è¯‘çš„æ—¶å€™ç›´æ¥é€‰æ‹©ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™é€‰æ‹©ï¼Œè¿™æ˜¯éå¸¸æé«˜æ•ˆç‡çš„ã€‚</p><p>è¦çŸ¥é“ï¼Œä¸åŒçš„ç©ºç±»ï¼Œæ˜¯ä¸åŒçš„ã€‚ä»–ä»¬ä»£è¡¨ç€ä¸åŒçš„ç±»å‹ï¼ˆè™½ç„¶ä»–ä»¬ç»“æ„ä¸€æ ·ï¼‰ã€‚åœ¨ STL ä¸­ï¼Œä½¿ç”¨ç©ºç±»åŒºåˆ†ä¸åŒç±»å‹çš„æ ‡å¿—ï¼Œä»è€Œåœ¨ç¼–è¯‘çš„æ—¶å€™æ¥å¯¹ä¸åŒçš„ç±»è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„ä¼˜åŒ–æ˜¯éå¸¸å¸¸è§çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>archlinux(Manjaro) é…ç½®</title>
      <link href="/2019/Note/ArchLinuxConfig/"/>
      <url>/2019/Note/ArchLinuxConfig/</url>
      
        <content type="html"><![CDATA[<h1 id="è®¾ç½®å›½å†…æº">è®¾ç½®å›½å†…æº</h1><p>è®¾ç½®å®˜æ–¹é•œåƒæºï¼ˆåŒ…æ‹¬ coreï¼Œ extraï¼Œ communityï¼Œ multilib ï¼‰</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman-mirrors -i -c China -m rank</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åå‹¾é€‰ä½ éœ€è¦çš„é•œåƒæºï¼Œç¡®è®¤å³å¯ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syy //æ›´æ–°æ•°æ®æº</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h1 id="archlinux-å®‰è£…ä»£ç†">archlinux å®‰è£…ä»£ç†</h1><h2 id="shadowsocksr-å¹¶å¯ç”¨å¼ƒç”¨">shadowsocksr å¹¶å¯ç”¨ï¼ˆå¼ƒç”¨ï¼‰</h2><h3 id="å®‰è£…">å®‰è£…</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yaourt shadowsocksr</span><br></pre></td></tr></tbody></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶">ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/shadowsocksr/config.json</span><br><span class="line"><span class="string">"protocol"</span>: <span class="string">"auth_sha1_v4"</span>,</span><br><span class="line"><span class="string">"obfs"</span>:<span class="string">"http_simple"</span>,</span><br></pre></td></tr></tbody></table></figure><h3 id="å¯åŠ¨">å¯åŠ¨</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python ./.local/lib/python3.6/site-packages/shadowsocks/local.py -c /etc/shadowsocksr/config.json</span><br></pre></td></tr></tbody></table></figure><h2 id="v2raya">v2raya</h2><h3 id="åœ¨åº”ç”¨å•†åº—é‡Œä¸‹è½½-v2raya-è½¯ä»¶">åœ¨åº”ç”¨å•†åº—é‡Œä¸‹è½½ v2raya è½¯ä»¶</h3><h3 id="ç„¶åå¯åŠ¨-v2raya">ç„¶å<strong>å¯åŠ¨ v2rayA</strong>ï¼š</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start v2raya.service</span><br></pre></td></tr></tbody></table></figure><h3 id="è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨"><strong>è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ï¼š</strong></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> v2raya.service</span><br></pre></td></tr></tbody></table></figure><h1 id="å®‰è£…æœç‹—æ‹¼éŸ³è¾“å…¥æ³•"><strong>å®‰è£…æœç‹—æ‹¼éŸ³è¾“å…¥æ³•</strong></h1><h3 id="å®‰è£…-1">å®‰è£…</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx-im             <span class="comment"># å…¨éƒ¨å®‰è£…</span></span><br><span class="line">sudo pacman -S fcitx-configtool     <span class="comment"># å›¾å½¢åŒ–é…ç½®å·¥å…·</span></span><br><span class="line">yay -S fcitx-sogoupinyin</span><br></pre></td></tr></tbody></table></figure><h3 id="å®‰è£…å®Œæˆåæ–°å»ºå¹¶é…ç½®.xprofileæ·»åŠ å¦‚ä¸‹å†…å®¹">å®‰è£…å®Œæˆåï¼Œæ–°å»ºå¹¶é…ç½®~/.xprofileï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GTK_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">"@im=fcitx"</span></span><br></pre></td></tr></tbody></table></figure><h1 id="å¸¸ç”¨è½¯ä»¶">å¸¸ç”¨è½¯ä»¶</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VS Code ä»£ç ç¼–è¾‘å™¨</span></span><br><span class="line">yay -S visual-studio-code-bin </span><br><span class="line"></span><br><span class="line"><span class="comment"># Chrome æµè§ˆå™¨  </span></span><br><span class="line">sudo pacman -S google-chrome        </span><br><span class="line"></span><br><span class="line"><span class="comment"># konsole</span></span><br><span class="line">sudo pacman -S konsole</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… zsh å’Œ oh-my-zsh</span></span><br><span class="line">sh -c <span class="string">"<span class="subst">$(curl -fsSL &lt;https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh&gt;)</span>"</span></span><br><span class="line">chsh <span class="variable">${USER}</span></span><br><span class="line">/bin/zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># teamviewer</span></span><br><span class="line">pamac install teamviewer</span><br><span class="line">sudo teamviewer --daemon <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># wps</span></span><br><span class="line">yay -S wps-office</span><br><span class="line">yay -S ttf-wps-fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç½‘æ˜“äº‘éŸ³ä¹</span></span><br><span class="line">sudo pacman -S netease-cloud-music</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ·±åº¦æˆªå›¾</span></span><br><span class="line">sudo pacman -S deepin-screenshot</span><br><span class="line"></span><br><span class="line"><span class="comment"># wechat</span></span><br><span class="line">yay -S deepin-wine-wechat</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç¦æ˜• pdf é˜…è¯»å™¨</span></span><br><span class="line">yay -S foxitreader </span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… pycharm</span></span><br><span class="line">yay -S pycharm pycharm-jre </span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… tmux</span></span><br><span class="line">sudo pacman -S tmux</span><br><span class="line"></span><br><span class="line"><span class="comment"># nvim</span></span><br></pre></td></tr></tbody></table></figure><h1 id="æŒ‚è½½-8t-ç¡¬ç›˜">æŒ‚è½½ 8T ç¡¬ç›˜</h1><p>é¦–å…ˆä½¿ç”¨<code>fdisk -l</code>ç¡®å®šè¦å¯¹å“ªä¸ªç¡¬ç›˜è¿›è¡Œåˆ†åŒºï¼Œç¡®å®šè¯¥ç›˜çš„ç›˜ç¬¦ä¸º<code>/dev/sdaï¼Œ</code>ç£ç›˜çš„ç©ºé—´å¤§äº 2Tï¼Œä¸èƒ½ç”¨ç›´æ¥ç”¨<code>fdisk</code>åˆ†åŒºï¼Œåº”å½“ä½¿ç”¨<code>parted</code>åˆ›å»ºåˆ†åŒºã€‚</p><p>é€‰æ‹©è¦åˆ†åŒºçš„ç¡¬ç›˜ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parted /dev/sdb</span><br><span class="line"><span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ mklabel gpt å»ºç«‹ç£ç›˜æ ‡ç­¾</span></span><br><span class="line">mkpart primary 0% 100%</span><br><span class="line"></span><br><span class="line">quit</span><br></pre></td></tr></tbody></table></figure><p><strong>æ ¼å¼åŒ–åˆ†åŒº</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mnt</span><br><span class="line"><span class="built_in">mkdir</span> disk1</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 disk1</span><br><span class="line">sudo mount /dev/sda1 /mnt/disk1</span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>è‡ªåŠ¨æŒ‚è½½</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ uuid</span></span><br><span class="line">sudo blkid /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹/etc/fstab</span></span><br><span class="line">UUID=df69e7e4-3ad6-436d-a46d-00a3e90238a9 /mnt/disk1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext4 &nbsp;&nbsp;&nbsp;defaults 0 2</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å»ºç«‹è½¯é“¾æ¥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /mnt/disk1 ~/workspace</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹æƒé™</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R carlyleliu /mnt/disk1</span><br><span class="line">sudo <span class="built_in">chgrp</span> -R carlyleliu /mnt/disk1</span><br></pre></td></tr></tbody></table></figure><h1 id="zsh">zsh</h1><p>powerlevel10k å¾ˆé¦™</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 &lt;https://gitee.com/romkatv/powerlevel10k.git&gt; <span class="variable">${ZSH_CUSTOM:-<span class="variable">$HOME</span>/.oh-my-zsh/custom}</span>/themes/powerlevel10k</span><br></pre></td></tr></tbody></table></figure><p>ç„¶ååœ¨ã€‚zshrc ä¸­è®¾ç½®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZSH_THEME=<span class="string">"powerlevel10k/powerlevel10k"</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä½ æƒ³é‡æ–°é…ç½®<code>powerlevel10k</code>ï¼Œåªéœ€è¦è¿è¡Œ<code>p10k configure</code>å³å¯</p><h1 id="zerotier">Zerotier</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S zerotier-one</span><br><span class="line">systemctl start zerotier-one.service</span><br><span class="line">systemctl <span class="built_in">enable</span> zerotier-one.service</span><br><span class="line">sudo zerotier-cli <span class="built_in">join</span> 3efa5cb78a408bf4</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UML ç±»å›¾</title>
      <link href="/2019/Note/UML/"/>
      <url>/2019/Note/UML/</url>
      
        <content type="html"><![CDATA[<h1 id="uml-ç±»å›¾">UML ç±»å›¾</h1><h2 id="ç±»ç¤ºä¾‹">ç±»ç¤ºä¾‹</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> radius_;</span><br><span class="line">    Point center_;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setRadius</span><span class="params">(<span class="type">double</span> _radius)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setCenter</span><span class="params">(Point _center)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">getArea</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">getCircumfrence</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml1.png"></p><span id="more"></span><h1 id="åŸºæœ¬æ¦‚å¿µåŠæœ¯è¯­">åŸºæœ¬æ¦‚å¿µåŠæœ¯è¯­</h1><h2 id="å¯è§æ€§visibility">å¯è§æ€§ï¼ˆvisibilityï¼‰</h2><ul><li>- public</li><li>- private</li><li>- protected</li></ul><h2 id="å‚æ•°çš„æ–¹å‘parameter-direction">å‚æ•°çš„æ–¹å‘ï¼ˆparameter directionï¼‰</h2><ul><li>inï¼šç”¨äºè¾“å…¥çš„å‚æ•°ï¼Œget the value</li><li>outï¼šç”¨äºè¾“å‡ºçš„å‚æ•°ï¼Œ set the value</li><li>inoutï¼šæ—¢å¯ä½œä¸ºè¾“å…¥åˆå¯ä½œä¸ºè¾“å‡ºï¼Œ get the value and set the value</li></ul><h2 id="ç±»æˆå‘˜å˜é‡æˆ–è€…å‡½æ•°çš„ç±»å‹">ç±»æˆå‘˜ï¼ˆå˜é‡æˆ–è€…å‡½æ•°ï¼‰çš„ç±»å‹</h2><ul><li>é™æ€æˆå‘˜ï¼Œä¸‹åˆ’çº¿è¡¨ç¤º</li><li>çº¯è™šå‡½æ•°ï¼Œæ–œä½“</li></ul><h2 id="ç±»å…³ç³»">ç±»å…³ç³»</h2><ul><li>Assocation (knows a)</li><li>Dependency (uses a)</li><li>Composition (has a)</li><li>Aggregation (has a)</li><li>Inheritance (is a)</li><li>Class template</li></ul><h1 id="ç±»å…³ç³»è¯¦è§£">ç±»å…³ç³»è¯¦è§£</h1><h2 id="assocationå…³è”">assocationï¼ˆå…³è”ï¼‰</h2><p>ä¸€ä¸ªå¯¹è±¡çŸ¥é“å¦ä¸€ä¸ªå¯¹è±¡çš„å­˜åœ¨ï¼Œè¯¥å¯¹è±¡æŒæœ‰å¦ä¸€ä¸ªå¯¹è±¡çš„<strong>æŒ‡é’ˆ</strong>æˆ–è€…<strong>å¼•ç”¨</strong>ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml2.png"></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">X</span>(Y* _ptrY):<span class="built_in">ptrY_</span>(_ptrY) {}</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setY</span><span class="params">(Y *y)</span> </span>{ ptrY_ = y;}</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span> </span>{ ptrY_-&gt;<span class="built_in">foo</span>();}</span><br><span class="line"><span class="keyword">private</span>/<span class="keyword">public</span>:</span><br><span class="line">    Y* ptrY_;       <span class="comment">// X ç±»æŒæœ‰ Y çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯æ®æ­¤è°ƒç”¨ Y ä¸­çš„æˆå‘˜æ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="dependencyä¾èµ–">dependencyï¼ˆä¾èµ–ï¼‰</h2><p>å½“ç±» Y ä¸ç±» X å½¼æ­¤ç‹¬ç«‹ï¼Œè€Œç±» Y æ˜¯ç±» X æˆå‘˜å‡½æ•°çš„ä¸€ä¸ª<strong>å‚æ•°</strong>ï¼Œæˆ–è€… X ä¸­æˆå‘˜å‡½æ•°çš„ä¸€ä¸ª<strong>å±€éƒ¨å˜é‡</strong>ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml3.png"></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span></span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(Y y)</span> </span>{ ...; y.<span class="built_in">foo</span>(); }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(Y&amp; y)</span> </span>{ ...; y.<span class="built_in">foo</span>(); }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f3</span><span class="params">(Y* y)</span> </span>{ ...; y-&gt;<span class="built_in">foo</span>(); }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f4</span><span class="params">()</span> </span>{ ...; Y y; y.<span class="built_in">foo</span>(); }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f5</span><span class="params">()</span> </span>{ Y::<span class="built_in">staticFoo</span>();}</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="aggregationèšåˆ">Aggregationï¼ˆèšåˆï¼‰</h2><p>èšç±»å‘ç”Ÿçš„åœºæ™¯æ˜¯ï¼šä¸€ä¸ªç±»æ˜¯å¦ä¸€ä¸ªç±»çš„<strong>é›†åˆ</strong>æˆ–è€…<strong>å®¹å™¨</strong>ï¼Œä½†è¢«åŒ…å«çš„ç±»ä¸å®¹å™¨æœ¬èº«å¹¶ä¸å…·å¤‡ç›¸åŒçš„ç”Ÿå‘½æœŸï¼Œä¹Ÿå°±æ˜¯å®¹å™¨é”€æ¯æ—¶ï¼Œå…¶åŒ…å«çš„å†…å®¹æœªå¿…ã€‚å…³è”ï¼ˆassociationï¼‰ä¸èšåˆï¼ˆaggregationï¼‰çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå…³è”å…³ç³»ä¸å­˜åœ¨ä¸€ä¸ªæ˜ç¡®çš„å®¹å™¨åŒ…å«å¦å¤–ä¸€ä¸ªç±»ã€‚æ¯”å¦‚æ±½è½¦å’Œè½®èƒçš„å…³ç³»ï¼Œå°±æ˜¯ä¸€ç§èšåˆå…³ç³»ï¼Œæ±½è½¦åŒ…å«ç€è½®èƒçš„é›†åˆï¼Œæ±½è½¦çš„é”€æ¯ï¼Œè½®èƒä»ç„¶å¯ä»¥å­˜åœ¨ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml4.png"></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    vectr&lt;Shape*&gt; ptrShapes; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml5.png"></p><h2 id="compositionç»„åˆ">Compositionï¼ˆç»„åˆï¼‰</h2><p>ç»„åˆï¼ˆcompositionï¼‰æ˜¯èšåˆï¼ˆAggregationï¼‰çš„å¢å¼ºç‰ˆã€‚ç»„åˆå’Œèšåˆçš„æ ¹æœ¬ä¸åŒåœ¨äºç±»ä¸å…¶æ‰€æŒæœ‰å…ƒç´ çš„æ˜¯å¦å…·æœ‰<strong>ç›¸åŒçš„ç”Ÿå‘½æœŸ</strong>ï¼Œè¦æ±‚å¿…é¡»ç›¸åŒæ˜¯ä¸€ç§ç»„åˆå…³ç³»ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml6.png"></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">    Point center_;</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml7.png"></p><h2 id="ç»§æ‰¿æ³›åŒ–">ç»§æ‰¿ï¼ˆæ³›åŒ–ï¼‰</h2><p>ç±»é—´çš„ç»§æ‰¿å…³ç³»è¡¨è¾¾çš„æ˜¯ä¸€ç§ derived class B is a base class Aã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml8.png"></p><h2 id="ç±»æ¨¡æ¿">ç±»æ¨¡æ¿</h2><p>ç±»æ¨¡æ¿æ„å‘³ç€æ³›å‹ç±»ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml9.png"></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span></span><br><span class="line">{...};</span><br><span class="line"></span><br><span class="line">X&lt;Y&gt; a;</span><br></pre></td></tr></tbody></table></figure><h1 id="uml-æ—¶åºå›¾">UML æ—¶åºå›¾</h1><h2 id="æ—¶åºå›¾çš„å…ƒç´ ">æ—¶åºå›¾çš„å…ƒç´ </h2><h3 id="actorè§’è‰²">Actorï¼ˆè§’è‰²ï¼‰</h3><p>ç³»ç»Ÿè§’è‰²ï¼Œå¯ä»¥æ˜¯äººæˆ–è€…å…¶ä»–ç³»ç»Ÿï¼Œå­ç³»ç»Ÿã€‚ä»¥ä¸€ä¸ªå°äººå›¾æ ‡è¡¨ç¤ºã€‚</p><h3 id="objectå¯¹è±¡">Objectï¼ˆå¯¹è±¡ï¼‰</h3><p>å¯¹è±¡ä½äºæ—¶åºå›¾çš„é¡¶éƒ¨ï¼Œä»¥ä¸€ä¸ªçŸ©å½¢è¡¨ç¤ºã€‚å¯¹è±¡çš„å‘½åæ–¹å¼ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š</p><ul><li>ç¬¬ä¸€ç§æ–¹å¼åŒ…æ‹¬å¯¹è±¡åå’Œç±»å</li><li>ç¬¬äºŒä¸­æ–¹å¼åªæ˜¾ç¤ºç±»åä¸æ˜¾ç¤ºå¯¹è±¡åï¼Œå³è¡¨ç¤ºä»–æ˜¯ä¸€ä¸ªåŒ¿åå¯¹è±¡</li><li>ç¬¬ä¸‰ç§æ–¹å¼åªæ˜¾ç¤ºå¯¹è±¡åä¸æ˜¾ç¤ºç±»æ˜</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml10.png"></p><h3 id="lifelineç”Ÿå‘½çº¿">Lifelineï¼ˆç”Ÿå‘½çº¿ï¼‰</h3><p>ç”Ÿå‘½çº¿åœ¨é¡ºåºå›¾ä¸­è¡¨ç¤ºä¸ºä»å¯¹è±¡å›¾æ ‡å‘ä¸‹å»¶ä¼¸çš„ä¸€æ¡è™šçº¿ï¼Œè¡¨ç¤ºå¯¹è±¡å­˜åœ¨çš„æ—¶é—´ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml11.png"></p><h3 id="focus-of-controlæ§åˆ¶ç„¦ç‚¹">Focus of Controlï¼ˆæ§åˆ¶ç„¦ç‚¹ï¼‰</h3><p>æ§åˆ¶ç„¦ç‚¹æ˜¯é¡ºåºå›¾ä¸­è¡¨ç¤ºæ—¶é—´æ®µçš„ç¬¦å·ï¼Œåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…å¯¹è±¡å°†æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ç”¨å°çŸ©å½¢è¡¨ç¤ºï¼Œå¦‚ä¸‹å›¾ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml12.png"></p><h3 id="messageæ¶ˆæ¯">Messageï¼ˆæ¶ˆæ¯ï¼‰</h3><p>æ¶ˆæ¯ä¸€èˆ¬åˆ†ä¸ºåŒæ­¥æ¶ˆæ¯ï¼ˆSynchronous Messageï¼‰ï¼Œå¼‚æ­¥æ¶ˆæ¯ï¼ˆAsynchronous Messageï¼‰å’Œè¿”å›æ¶ˆæ¯ï¼ˆReturn Messageï¼‰. å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml13.png"></p><ul><li><strong>åŒæ­¥æ¶ˆæ¯=è°ƒç”¨æ¶ˆæ¯ï¼ˆSynchronous Messageï¼‰</strong></li></ul><p>æ¶ˆæ¯çš„å‘é€è€…æŠŠæ§åˆ¶ä¼ é€’ç»™æ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œç„¶ååœæ­¢æ´»åŠ¨ï¼Œç­‰å¾…æ¶ˆæ¯çš„æ¥æ”¶è€…æ”¾å¼ƒæˆ–è€…è¿”å›æ§åˆ¶ã€‚ç”¨æ¥è¡¨ç¤ºåŒæ­¥çš„æ„ä¹‰ã€‚</p><ul><li><strong>å¼‚æ­¥æ¶ˆæ¯ï¼ˆAsynchronous Messageï¼‰</strong></li></ul><p>æ¶ˆæ¯å‘é€è€…é€šè¿‡æ¶ˆæ¯æŠŠä¿¡å·ä¼ é€’ç»™æ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œç„¶åç»§ç»­è‡ªå·±çš„æ´»åŠ¨ï¼Œä¸ç­‰å¾…æ¥å—è€…è¿”å›æ¶ˆæ¯æˆ–è€…æ§åˆ¶ã€‚å¼‚æ­¥æ¶ˆæ¯çš„æ¥æ”¶è€…å’Œå‘é€è€…æ˜¯å¹¶å‘å·¥ä½œçš„ã€‚</p><ul><li><strong>è¿”å›æ¶ˆæ¯ï¼ˆReturn Messageï¼‰</strong></li></ul><p>è¿”å›æ¶ˆæ¯è¡¨ç¤ºä»è¿‡ç¨‹è°ƒç”¨è¿”å›</p><h3 id="self-messageè‡ªå…³è”æ¶ˆæ¯">Self-Messageï¼ˆè‡ªå…³è”æ¶ˆæ¯ï¼‰</h3><p>è¡¨ç¤ºæ–¹æ³•çš„è‡ªèº«è°ƒç”¨ä»¥åŠä¸€ä¸ªå¯¹è±¡å†…çš„ä¸€ä¸ªæ–¹æ³•è°ƒç”¨å¦å¤–ä¸€ä¸ªæ–¹æ³•ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml14.png"></p><h3 id="combined-fragmentsç»„åˆç‰‡æ®µ">Combined Fragmentsï¼ˆç»„åˆç‰‡æ®µï¼‰</h3><p>ç»„åˆç‰‡æ®µç”¨æ¥è§£å†³äº¤äº’æ‰§è¡Œçš„æ¡ä»¶å’Œæ–¹å¼ï¼Œå®ƒå…è®¸åœ¨åºåˆ—å›¾ä¸­ç›´æ¥è¡¨ç¤ºé€»è¾‘ç»„ä»¶ï¼Œç”¨äºé€šè¿‡æŒ‡å®šæ¡ä»¶æˆ–å­è¿›ç¨‹çš„åº”ç”¨åŒºåŸŸï¼Œä¸ºä»»ä½•ç”Ÿå‘½çº¿çš„ä»»ä½•éƒ¨åˆ†å®šä¹‰ç‰¹æ®Šæ¡ä»¶å’Œå­è¿›ç¨‹ã€‚ç»„åˆç‰‡æ®µå…±æœ‰ 13 ç§ï¼Œåç§°åŠå«ä¹‰å¦‚ä¸‹ï¼š</p><h2 id="ä¸€ä¸ªå®ä¾‹">ä¸€ä¸ªå®ä¾‹</h2><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/uml15.png"></p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GTest &amp; GMock</title>
      <link href="/2019/Note/GtestGmock/"/>
      <url>/2019/Note/GtestGmock/</url>
      
        <content type="html"><![CDATA[<h1 id="assert_-expect_">ASSERT_ &amp; EXPECT_</h1><h2 id="bool">Bool</h2><table><thead><tr class="header"><th>Fatal assertion</th><th>Nonfatal assertion</th><th>Verifies</th></tr></thead><tbody><tr class="odd"><td>ASSERT_TRUE(condition);</td><td>EXPECT_TRUE(condition);</td><td>condition is true</td></tr><tr class="even"><td>ASSERT_FALSE(condition);</td><td>EXPECT_FALSE(condition);</td><td>condition is false</td></tr></tbody></table><h2 id="value">Value</h2><table><thead><tr class="header"><th>Fatal assertion</th><th>Nonfatal assertion</th><th>Verifies</th></tr></thead><tbody><tr class="odd"><td>ASSERT_EQ(val1, val2);</td><td>EXPECT_EQ(val1, val2);</td><td>val1 == val2</td></tr><tr class="even"><td>ASSERT_NE(val1, val2);</td><td>EXPECT_NE(val1, val2);</td><td>val1 != val2</td></tr><tr class="odd"><td>ASSERT_LT(val1, val2);</td><td>EXPECT_LT(val1, val2);</td><td>val1 &lt; val2</td></tr><tr class="even"><td>ASSERT_LE(val1, val2);</td><td>EXPECT_LE(val1, val2);</td><td>val1 &lt;= val2</td></tr><tr class="odd"><td>ASSERT_GT(val1, val2);</td><td>EXPECT_GT(val1, val2);</td><td>val1 &gt; val2</td></tr><tr class="even"><td>ASSERT_GE(val1, val2);</td><td>EXPECT_GE(val1, val2);</td><td>val1 &gt;= val2</td></tr></tbody></table><h2 id="string">string</h2><table><colgroup><col style="width: 33%"><col style="width: 33%"><col style="width: 33%"></colgroup><thead><tr class="header"><th>Fatal assertion</th><th>Nonfatal assertion</th><th>Verifies</th></tr></thead><tbody><tr class="odd"><td>ASSERT_STREQ(str1,str2);</td><td>EXPECT_STREQ(str1,str2);</td><td>the two C strings have the same content</td></tr><tr class="even"><td>ASSERT_STRNE(str1,str2);</td><td>EXPECT_STRNE(str1,str2);</td><td>the two C strings have different contents</td></tr><tr class="odd"><td>ASSERT_STRCASEEQ(str1,str2);</td><td>EXPECT_STRCASEEQ(str1,str2);</td><td>the two C strings have the same content, ignoring case</td></tr><tr class="even"><td>ASSERT_STRCASENE(str1,str2);</td><td>EXPECT_STRCASENE(str1,str2);</td><td>the two C strings have different contents, ignoring case</td></tr></tbody></table><p><strong>æ³¨æ„ï¼šâ€œCASEâ€è¡¨æ˜å¿½ç•¥å¤§å°å†™ï¼Œä¸€ä¸ª NULL æŒ‡é’ˆå’Œç©ºå­—ç¬¦ä¸²ä¸ä¸€æ ·</strong></p><span id="more"></span><h1 id="test">TEST</h1><p>ä¸‹é¢ä»¥ googletest/samples ä¸­çš„ sample1_unittest.cc ä¸­çš„ demo ä¸ºä¾‹ï¼Œç®€å•ä»‹ç»ä¸‹ä¸€ä¸ªç®€å•è®¡ç®—é˜¶ä¹˜å‡½æ•° Factorial å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Factorial</span><span class="params">(<span class="type">int</span> n)</span> {</span><br><span class="line">  <span class="type">int</span> result = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) {</span><br><span class="line">    result *= i;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢ä¸‰ä¸ª TEST éƒ½æ˜¯å±äºåŒä¸€ä¸ª test suiteï¼Œå³ FactorialTest</span></span><br><span class="line"><span class="comment">// æ­£æ•°ä¸ºä¸€ç»„</span></span><br><span class="line">TEST(FactorialTest, Negative) {</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">-5</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">-1</span>));</span><br><span class="line">  EXPECT_GT(Factorial(<span class="number">-10</span>), <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line">TEST(FactorialTest, Zero) {</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">0</span>));</span><br><span class="line">}</span><br><span class="line"><span class="comment">// è´Ÿæ•°ä¸ºä¸€ç»„</span></span><br><span class="line">TEST(FactorialTest, Positive) {</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">1</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, Factorial(<span class="number">2</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">6</span>, Factorial(<span class="number">3</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">40320</span>, Factorial(<span class="number">8</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ sample1_unittest.cc çš„ main å‡½æ•°ä¸­ï¼Œæ·»åŠ  RUN_ALL_TESTS å‡½æ•°å³å¯ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> {</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Running main() from %s\\n"</span>, __FILE__);</span><br><span class="line">  testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">  <span class="keyword">return</span> RUN_ALL_TESTS();   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ TEST å®å‡½æ•°ä¸­ï¼Œä¹Ÿå¯ä»¥åƒä¸ªæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œå®šä¹‰å˜é‡ä¹‹ç±»çš„è¡Œä¸ºã€‚</p><p>æ¯”å¦‚åœ¨ sample2_unittest.cc ä¸­ï¼Œæµ‹è¯•ä¸€ä¸ªè‡ªå®šä¹‰ç±» MyString çš„å¤åˆ¶æ„é€ å‡½æ•°æ˜¯å¦è¡¨ç°æ­£å¸¸ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> kHelloString[] = <span class="string">"Hello, world!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ TEST å†…éƒ¨ï¼Œå®šä¹‰å˜é‡</span></span><br><span class="line">TEST(MyString, CopyConstructor) {</span><br><span class="line">  <span class="type">const</span> MyString <span class="title function_">s1</span><span class="params">(kHelloString)</span>;</span><br><span class="line">  <span class="type">const</span> MyString s2 = s1;</span><br><span class="line">  EXPECT_EQ(<span class="number">0</span>, <span class="built_in">strcmp</span>(s2.c_string(), kHelloString));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="test_f">TEST_F</h1><p>ä¸‹é¢ä»‹ç» gtest ä¸­æ›´ä¸ºé«˜çº§çš„åŠŸèƒ½ï¼štest fixtureï¼Œå¯¹åº”çš„å®å‡½æ•°æ˜¯ TEST_F(TestFixtureName, TestName)ã€‚</p><p>fixtureï¼Œå…¶è¯­ä¹‰æ˜¯å›ºå®šçš„è®¾æ–½ï¼Œè€Œ test fixture åœ¨ gtest ä¸­çš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸ª TEST éƒ½æ‰§è¡Œä¸€äº›åŒæ ·çš„æ“ä½œã€‚</p><p>æ¯”å¦‚ï¼Œè¦æµ‹è¯•ä¸€ä¸ªé˜Ÿåˆ— Queue çš„å„ä¸ªæ¥å£åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå› æ­¤å°±éœ€è¦å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ã€‚å¦‚æœä½¿ç”¨ä¸€ä¸ª TEST å‡½æ•°æµ‹è¯• Queue çš„ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰§è¡Œ TEST æ—¶ï¼Œéƒ½éœ€è¦åœ¨ TEST å®å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ª Queue å¯¹è±¡ï¼Œå¹¶å‘è¯¥å¯¹è±¡ä¸­æ·»åŠ å…ƒç´ ï¼Œå°±å¾ˆå†—ä½™ã€ç¹çã€‚</p><p>æ€ä¹ˆé¿å…è¿™éƒ¨åˆ†å†—ä½™çš„è¿‡ç¨‹ï¼Ÿ</p><p>TEST_F å°±æ˜¯å®Œæˆè¿™æ ·çš„äº‹æƒ…ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•° TestFixtureName æ˜¯ä¸ªç±»ï¼Œéœ€è¦ç»§æ‰¿ testing::Testï¼ŒåŒæ—¶æ ¹æ®éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªè™šå‡½æ•°ï¼š</p><ul><li>virtual void SetUp()ï¼šåœ¨ TEST_F ä¸­æµ‹è¯•æ¡ˆä¾‹ä¹‹å‰è¿è¡Œï¼›</li><li>virtual void TearDown()ï¼šåœ¨ TEST_F ä¹‹åè¿è¡Œã€‚</li></ul><p>å¯ä»¥ç±»æ¯”å¯¹è±¡çš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚è¿™æ ·ï¼ŒåŒä¸€ä¸ª TestFixtureName ä¸‹çš„æ¯ä¸ª TEST_F éƒ½ä¼šå…ˆæ‰§è¡Œ SetUpï¼Œæœ€åæ‰§è¡Œ TearDwomã€‚</p><p>æ­¤å¤–ï¼Œtesting::Test è¿˜æä¾›äº†ä¸¤ä¸ª static å‡½æ•°ï¼š</p><ul><li>static void SetUpTestSuite()ï¼šåœ¨ç¬¬ä¸€ä¸ª TEST ä¹‹å‰è¿è¡Œ</li><li>static void TearDownTestSuite()ï¼šåœ¨æœ€åä¸€ä¸ª TEST ä¹‹åè¿è¡Œ</li></ul><p>ä»¥ sample3-inl ä¸­å®ç°çš„ class Queue ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueueTestSmpl3</span> :</span> public testing::Test { <span class="comment">// ç»§æ‰¿äº† testing::Test</span></span><br><span class="line">protected:  </span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">void</span> <span class="title function_">SetUpTestSuite</span><span class="params">()</span> {</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"run before first case..."</span>&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  } </span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">void</span> <span class="title function_">TearDownTestSuite</span><span class="params">()</span> {</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"run after last case..."</span>&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">SetUp</span><span class="params">()</span> override {</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"enter into SetUp()"</span> &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    q1_.Enqueue(<span class="number">1</span>);</span><br><span class="line">    q2_.Enqueue(<span class="number">2</span>);</span><br><span class="line">    q2_.Enqueue(<span class="number">3</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">TearDown</span><span class="params">()</span> override {</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"exit from TearDown"</span> &lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> <span class="title function_">Double</span><span class="params">(<span class="type">int</span> n)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*n;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> <span class="title function_">MapTester</span><span class="params">(<span class="type">const</span> Queue&lt;<span class="type">int</span>&gt; * q)</span> {</span><br><span class="line">    <span class="type">const</span> Queue&lt;<span class="type">int</span>&gt; * <span class="type">const</span> new_q = q-&gt;Map(Double);</span><br><span class="line"></span><br><span class="line">    ASSERT_EQ(q-&gt;Size(), new_q-&gt;Size());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> QueueNode&lt;<span class="type">int</span>&gt;*n1 = q-&gt;Head(), *n2 = new_q-&gt;Head();</span><br><span class="line">         n1 != nullptr; n1 = n1-&gt;next(), n2 = n2-&gt;next()) {</span><br><span class="line">      EXPECT_EQ(<span class="number">2</span> * n1-&gt;element(), n2-&gt;element());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    delete new_q;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  Queue&lt;<span class="type">int</span>&gt; q0_;</span><br><span class="line">  Queue&lt;<span class="type">int</span>&gt; q1_;</span><br><span class="line">  Queue&lt;<span class="type">int</span>&gt; q2_;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹é¢æ˜¯ sample3_unittest.cc ä¸­çš„ TEST_Fï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in sample3_unittest.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests the default c'tor.</span></span><br><span class="line">TEST_F(QueueTestSmpl3, DefaultConstructor) {</span><br><span class="line">  <span class="comment">// !!! åœ¨ TEST_F ä¸­å¯ä»¥ä½¿ç”¨ QueueTestSmpl3 çš„æˆå‘˜å˜é‡ã€æˆå‘˜å‡½æ•° </span></span><br><span class="line">  EXPECT_EQ(<span class="number">0u</span>, q0_.Size());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests Dequeue().</span></span><br><span class="line">TEST_F(QueueTestSmpl3, Dequeue) {</span><br><span class="line">  <span class="type">int</span> * n = q0_.Dequeue();</span><br><span class="line">  EXPECT_TRUE(n == nullptr);</span><br><span class="line"></span><br><span class="line">  n = q1_.Dequeue();</span><br><span class="line">  ASSERT_TRUE(n != nullptr);</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, *n);</span><br><span class="line">  EXPECT_EQ(<span class="number">0u</span>, q1_.Size());</span><br><span class="line">  delete n;</span><br><span class="line"></span><br><span class="line">  n = q2_.Dequeue();</span><br><span class="line">  ASSERT_TRUE(n != nullptr);</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, *n);</span><br><span class="line">  EXPECT_EQ(<span class="number">1u</span>, q2_.Size());</span><br><span class="line">  delete n;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests the Queue::Map() function.</span></span><br><span class="line">TEST_F(QueueTestSmpl3, Map) {</span><br><span class="line">  MapTester(&amp;q0_);</span><br><span class="line">  MapTester(&amp;q1_);</span><br><span class="line">  MapTester(&amp;q2_);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ TEST_F(QueueTestSmpl3, DefaultConstructor) ä¸ºä¾‹ï¼Œå†å…·ä½“è®²è§£ä¸‹ TEST_F çš„è¿è¡Œæµç¨‹ï¼š</p><ul><li>gtest æ„é€ ä¸€ä¸ª QueueTestSmpl3 å¯¹è±¡ t1ï¼›</li><li>t1.setUp åˆå§‹`t1</li><li>ç¬¬ä¸€ä¸ª TEST_F å³ DefaultConstructor å¼€å§‹è¿è¡Œå¹¶ç»“æŸ</li><li>t1.TearDwon è¿è¡Œï¼Œç”¨äºæ¸…ç†å·¥ä½œ</li></ul><h1 id="expect_call">EXPECT_CALL</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPECT_CALL(mock_object, method(matcher))</span><br><span class="line">.Times(cardinality)</span><br><span class="line">.WillOnce(action)</span><br><span class="line">.WillRepeatedly(action);</span><br></pre></td></tr></tbody></table></figure><ul><li>ç¬¬ä¸€è¡Œä¸­ (matcher) æ˜¯å¯æœ‰å¯æ— çš„ï¼Œåªæœ‰å­˜åœ¨å‡½æ•°åŒåé‡è½½çš„æƒ…å†µä¸‹ï¼Œ(matcher) æ‰æ˜¯å¿…é¡»çš„ï¼Œç”¨äºåŒ¹é…å…¥å‚æ ¼å¼</li><li>ç¬¬äºŒè¡Œä¹Ÿæ˜¯å¯æœ‰å¯æ— çš„ï¼Œcardinality è¡¨ç¤ºå‡½æ•°åº”è¯¥è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚å¸¸è§çš„æœ‰ï¼šTimes(n) åº”è¯¥è¢«è°ƒç”¨ n æ¬¡ï¼›Times(::testing::AtLeast(n)) è‡³å°‘åº”è¯¥è¢«è°ƒç”¨ n æ¬¡</li><li>ç¬¬ä¸‰è¡Œå’Œç¬¬å››è¡Œï¼Œè¡¨ç¤ºåšä¸€æ¬¡æˆ–é‡å¤åš actionã€‚å¸¸è§çš„ action æœ‰ï¼š:testing::Return(n) è¡¨ç¤ºè¿”å›ä¸€ä¸ªæ•°å­—</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPECT_CALL(mock_if_impl, some_func)</span><br><span class="line">    .Times(::testing::AtLeast(<span class="number">1</span>))</span><br><span class="line">    .WillOnce(::testing::Return(<span class="literal">true</span>));</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>QCC518x å¼€å‘ç¯å¢ƒæ­å»º</title>
      <link href="/2019/Note/QCC518x/"/>
      <url>/2019/Note/QCC518x/</url>
      
        <content type="html"><![CDATA[<h1 id="è½¯ä»¶å®‰è£…">è½¯ä»¶å®‰è£…</h1><p>éœ€è¦å®‰è£… visual studio c++ 2010 redistributable</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWljcm9zb2Z0LmNvbS9lbi11cy9kb3dubG9hZC9kZXRhaWxzLmFzcHg/aWQ9MjY5OTk=">Microsoft Visual C++ 2010 Service Pack 1 Redistributable Package MFC Security Update<i class="fa fa-external-link-alt"></i></span></p><h1 id="ç¼–è¯‘å‡ºé”™è·¯å¾„">ç¼–è¯‘å‡ºé”™ï¼ˆè·¯å¾„ï¼‰</h1><p>éœ€è¦å°† sdk å°½é‡æ”¾åˆ°æ ¹ç›®å½•ä¸‹ï¼Œè·¯å¾„åä¸è¦å¤ªé•¿ä¸ç„¶ä¼šå‡ºç°ç¼–è¯‘å‡ºé”™çš„é—®é¢˜ã€‚</p><span id="more"></span><h1 id="python-è„šæœ¬å¯¹-ascii-è§£æå‡ºé”™">python è„šæœ¬å¯¹ ascii è§£æå‡ºé”™</h1><p>ä¿®æ”¹ C:_Toolkit_1.2.15.35_x64[build.py](http://build.py)</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Copyright (c) 2016 - 2021 Qualcomm Technologies International, Ltd</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract build system option from command line</span></span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    reload(sys)</span><br><span class="line">    sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br><span class="line">    index = argv.index(<span class="string">'--build_system'</span>, <span class="number">1</span>)</span><br><span class="line">    build_system = argv[index+<span class="number">1</span>]</span><br><span class="line"><span class="keyword">except</span> (ValueError, IndexError):</span><br><span class="line">    <span class="comment"># Extract build system option from environment</span></span><br><span class="line">    <span class="keyword">from</span> os <span class="keyword">import</span> environ</span><br><span class="line">    build_system = environ.get(<span class="string">'__BUILD_SYSTEM__'</span>, <span class="string">'make'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> build_system == <span class="string">'scons'</span>:</span><br><span class="line">    <span class="keyword">from</span> maker.build_scons <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">from</span> builder.build <span class="keyword">import</span> *</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹ C:_Toolkit_1.2.15.35_x64[ubuild.py](http://ubuild.py)</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Qcc518x.png"></p><p>åœ¨ 173 è¡Œä¹‹å‰æ·»åŠ ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¶èµ›å®</title>
      <link href="/2019/Literature/Yesaining/"/>
      <url>/2019/Literature/Yesaining/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸æƒ‹æƒœä¸å‘¼å”¤æˆ‘ä¹Ÿä¸å•¼å“­å¶èµ›å®">ğŸ˜—ä¸æƒ‹æƒœï¼Œä¸å‘¼å”¤ï¼Œæˆ‘ä¹Ÿä¸å•¼å“­ï¼ˆå¶èµ›å®ï¼‰</h1><p>ä¸æƒ‹æƒœï¼Œä¸å‘¼å”¤ï¼Œæˆ‘ä¹Ÿä¸å•¼å“­ï¼Œ</p><p>ä¸€åˆ‡å°†é€å»â€¦â€¦å¦‚è‹¹æœèŠ±ä¸›çš„è–„é›¾</p><span id="more"></span><p>é‡‘é»„çš„è½å¶å †æ»¡æˆ‘å¿ƒé—´â€”â€”</p><p>æˆ‘å·²ç»å†ä¸æ˜¯é’æ˜¥å°‘å¹´ã€‚</p><p>å¿ƒå„¿å•Šï¼Œä½ å·²å¼€å§‹æ‚„æ‚„å†·å´ï¼Œ</p><p>å¦‚ä»Šå†ä¸ä¼šé‚£æ ·åœ°è·³è·ƒï¼š</p><p>è¿™ç™½æ¡¦çš„å›¾æ¡ˆç»‡æˆçš„å®¶å›­ï¼Œ</p><p>å†ä¸èƒ½å¸å¼•æˆ‘èµ¤è„šç•™è¿ã€‚</p><p>æµæµªè€…çš„æ¿€æƒ…å“ªï¼è¶Šæ¥è¶Šä¸è§ä½ ï¼Œ</p><p>ä¿ƒä½¿æˆ‘è½»è½»åå‡ºç«çƒ­çš„è¨€è¯­ã€‚</p><p>å•Šï¼Œæˆ‘çš„ç™½ç™½æµé€çš„åå¹´ï¼</p><p>è¿¸å‘çš„æ†æ¨å’Œå¥”æ”¾çš„æƒ…æ„Ÿï¼</p><p>å¦‚ä»Šæˆ‘å·²å€¦äºæœŸå¾…æœªæ¥ï¼Œ</p><p>ç”Ÿæ´»å‘€ï¼Œéš¾é“ä½ æ˜¯ä¸€åœºå¹»æ¢¦ï¼Ÿ</p><p>ä»¿ä½›æˆ‘æ›¾åœ¨å–§é—¹çš„æ˜¥æ™¨</p><p>åœ¨ç«ç‘°è‰²çš„éªé©¬ä¸Šå°½æƒ…é©°éª‹ã€‚</p><p>æ§­æ ‘çš„é»„å¶è½åœ°æ— å£°ï¼Œ</p><p>ä¸–äººéƒ½å¿…å°†è…æœ½æ— è¸ªâ€¦â€¦</p><p>å¤©ä¸‹çš„ä¼—ç”Ÿå•Šï¼Œä½ ä»¬ç”Ÿç”Ÿä¸æ¯ï¼Œ</p><p>æˆ‘æ„¿ä½ æ°¸è¿œç¾å¥½ã€ç¹è£ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ucos ç›¸å…³å®ç°</title>
      <link href="/2019/Program/ucosDesign/"/>
      <url>/2019/Program/ucosDesign/</url>
      
        <content type="html"><![CDATA[<h1 id="ucos-ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•">ucos ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•</h1><h2 id="ä¿è¯è°ƒåº¦å»¶è¿Ÿçš„ç¡®å®šæ€§">ä¿è¯è°ƒåº¦å»¶è¿Ÿçš„ç¡®å®šæ€§</h2><p>æ™®é€šæŸ¥è¡¨æ³•ä¼šä»å¤´å¼€å§‹éå†æ•°ç»„ï¼Œè¿™æ ·å°±ç»ªæ€æœ€é«˜ä¼˜å…ˆçº§çš„ task ä¼šæ¯”å°±ç»ªæ€ä¼˜å…ˆçº§ä½çš„ task å…ˆè¢«æŸ¥æ‰¾åˆ°ï¼Œé€ æˆä¸åŒä¼˜å…ˆçº§ task åœ¨è°ƒåº¦ä¸ŠèŠ±è´¹æ—¶é—´ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¿™è¿èƒŒäº†å®æ—¶æ€§çš„åŸåˆ™ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/RTOS_Sche_issue.png"></p><span id="more"></span><h2 id="ucos-è°ƒåº¦åŸç†">ucos è°ƒåº¦åŸç†</h2><p>ä¸ºäº†ç¡®ä¿è°ƒåº¦å»¶è¿Ÿä¸€è‡´æ€§ï¼Œucos é‡‡ç”¨äº†ç©ºé—´æ¢å–æ—¶é—´çš„ç®—æ³•åœ¨ç›¸åŒæ—¶é—´é‡ŒæŸ¥æ‰¾åˆ°ä¸åŒä¼˜å…ˆçº§ taskï¼Œå…·ä½“ç®—æ³•å¦‚ä¸‹ã€‚ æ•´ä¸ªç®—æ³•ç”±ä¸¤ä¸ªå˜é‡ã€ä¸¤ä¸ªè¡¨æ ¼å’Œä¸‰ä¸ªç¨‹åºç»„æˆï¼šä¸¤ä¸ªå˜é‡æ˜¯ OSRdyGrp å’Œ OSRdyTbl[]; ä¸¤ä¸ªè¡¨æ ¼æ˜¯ä½æ©ç è¡¨ OSMapTbl[] å’Œä¼˜å…ˆçº§åˆ¤å®šè¡¨ OSUnMap[]ï¼Œä¸‰ä¸ªç¨‹åºåˆ†åˆ«æ˜¯ä½¿ task è¿›å…¥å°±ç»ªã€è„±ç¦»å°±ç»ªã€å¯»æ‰¾å°±ç»ªæ€æœ€é«˜ä¼˜å…ˆçº§ taskã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/prio_table.jpg"> <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/os_map_tbl.jpg"></p><p>ä½¿ task è¿›å…¥å°±ç»ªæ€çš„ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å°† prio ä¼˜å…ˆçº§æ”¾å…¥å°±ç»ªæ€ä¼˜å…ˆçº§è¡¨ä¸­ */</span></span><br><span class="line">OSRdyGrp = OSMapTbl[prio&gt;&gt;<span class="number">3</span>];               <span class="comment">//è®¾ç½®å°±ç»ªæ€ä¼˜å…ˆçº§ç»„æ ‡å¿—</span></span><br><span class="line">OSRdyTbl[prio&gt;&gt;<span class="number">3</span>] |= OSMapTbl[prio&amp;<span class="number">0x07</span>];   <span class="comment">//è®¾ç½®å°±ç»ªæ€ä¼˜å…ˆçº§ç»„å†…çš„ä½æ ‡å¿—</span></span><br></pre></td></tr></tbody></table></figure><p>å°±æ˜¯å°† OSRdyTbl ç›¸åº”å…ƒç´ çš„ç›¸åº”ä½ç½®ä½ï¼Œä½¿ task è„±ç¦»å°±ç»ªçŠ¶æ€å°±æ˜¯å°†ç›¸åº”ä½ç½®é›¶ï¼Œç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å°† prio ä¼˜å…ˆçº§ä»å°±ç»ªæ€ä¼˜å…ˆçº§è¡¨ä¸­åˆ é™¤ */</span></span><br><span class="line"><span class="keyword">if</span>(OSRdyTbl[prio&gt;&gt;<span class="number">3</span>] &amp;=~OSMapTbl[prio &amp; <span class="number">0x07</span>]) == <span class="number">0</span>)</span><br><span class="line">    OSRdyGrp &amp;=~ OSMapTbl[prio&gt;&gt;<span class="number">3</span>];</span><br></pre></td></tr></tbody></table></figure><p>å˜é‡ OSRdyGrp çš„æ¯ä¸€ä½å°±ä»£è¡¨ä¸€ä¸ªç»„ã€‚</p><h2 id="æŸ¥æ‰¾æœ€é«˜ä¼˜å…ˆçº§-task">æŸ¥æ‰¾æœ€é«˜ä¼˜å…ˆçº§ task</h2><p>task ä¼˜å…ˆçº§è®¡ç®—å…¬å¼ <span class="math inline">\(prio=y*8+x\)</span> ï¼Œå…¶ä¸­ y=OSRdyGrp æœ€é«˜ä¼˜å…ˆçº§çš„ task åœ¨ OSRdyGrp çš„æœ€ä½ä¸ä¸º 0 çš„ä½çš„é‚£ä¸ªç»„ï¼Œåœ¨è¿™ä¸ªç»„é‡Œä¼˜å…ˆçº§æœ€é«˜çš„ task åœ¨ç»„å†…æœ€ä½ä¸ä¸º 0 çš„ä½ï¼Œå› æ­¤å¯»æ‰¾æœ€é«˜ä¼˜å…ˆçº§ task å°±ç›¸å½“äºå¯»æ‰¾è¿™ä¸¤ä¸ªå˜é‡é‡Œæœ€ä½ä¸ä¸º 0 çš„ä½ã€‚æ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡ OSUnMapTbl[] æ•°ç»„æ¥æŸ¥æ‰¾æœ€ä½ä½ä¸ä¸º 0 çš„ä½çš„æ•°ç»„ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">INT8U <span class="type">const</span> OSUnMapTbl[<span class="number">256</span>] = {</span><br><span class="line">    <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x00 to 0x0F */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x10 to 0x1F */</span></span><br><span class="line">    <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x20 to 0x2F */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x30 to 0x3F */</span></span><br><span class="line">    <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x40 to 0x4F */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x50 to 0x5F */</span></span><br><span class="line">    <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x60 to 0x6F */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x70 to 0x7F */</span></span><br><span class="line">    <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x80 to 0x8F */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0x90 to 0x9F */</span></span><br><span class="line">    <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0xA0 to 0xAF */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0xB0 to 0xBF */</span></span><br><span class="line">    <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0xC0 to 0xCF */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0xD0 to 0xDF */</span></span><br><span class="line">    <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="comment">/* 0xE0 to 0xEF */</span></span><br><span class="line">    <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>  <span class="comment">/* 0xF0 to 0xFF */</span></span><br><span class="line">}ï¼›</span><br></pre></td></tr></tbody></table></figure><p>è¿™ä¸ªè¡¨æ ¼é‡Œçš„æ•°æ®å¾ˆå¥‡æ€ªï¼Œå¥½åƒæ²¡ä»€ä¹ˆè§„å¾‹ï¼Œå…¶å®è¿™äº›æ•°æ®æ˜¯ 0x00-0xff è¿™äº›æ•°æ®ä¸­æœ€ä½ä½ä¸ä¸º 0 çš„ä½æ•°è¯¦ç»†å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x00 ==00000000b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit0ï¼›</span><br><span class="line">0x01 ==00000001b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit0ï¼›</span><br><span class="line">0x02 ==00000010b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit1ï¼›</span><br><span class="line">0x03 ==00000011b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit0ï¼›</span><br><span class="line">0x04 ==00000100b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit2ï¼›</span><br><span class="line">0x05 ==00000101b æœ€ä½ä½ä¸º 1 çš„ä½æ•°ä¸º bit0ï¼›</span><br></pre></td></tr></tbody></table></figure><p>ä»¥æ­¤ç±»æ¨å°±å¾—åˆ° OSUnMapTbl è¡¨æ ¼ã€‚æœ€é«˜ä¼˜å…ˆçº§ task å°±æ˜¯åœ¨ä¼˜å…ˆçº§ç»„å’Œä½é‡Œæ‰¾åˆ°æœ€ä½ä½ä¸ä¸º 0 çš„ä½å¹¶ç»„åˆä½ä¸€ä¸ªå®Œæ•´çš„ä¼˜å…ˆçº§ï¼Œè®¡ç®—å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è®¡ç®—å°±ç»ªæ€æœ€é«˜ä¼˜å…ˆçº§ */</span></span><br><span class="line">y&nbsp;= OSUnMapTbl[OSRdyGrp];</span><br><span class="line">x = OSUnMapTbl[OSRdyTbl[y]];</span><br><span class="line">OSPrioHighRdy = (INT8U)((y &lt;&lt; <span class="number">3</span>) + x);</span><br></pre></td></tr></tbody></table></figure><p>è¿™å°±æ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•ï¼Œå¯ä»¥ä¿éšœå¯»æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ task çš„æ—¶é—´ç›¸åŒã€‚</p><h2 id="è°ƒåº¦è¿‡ç¨‹">è°ƒåº¦è¿‡ç¨‹</h2><p>æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½å°±æ˜¯å¤š task è¿è¡Œï¼Œè€Œå¤š task è¿è¡Œå®è´¨ä¸Šæ˜¯è½®è¯¢å ç”¨ CPUã€‚task çš„è°ƒåº¦å°±æ˜¯åˆ©ç”¨ä¸­æ–­æ¥è¿›è¡Œ task ä¹‹é—´çš„åˆ‡æ¢ï¼Œå‘¨æœŸæ€§è¿›å…¥ä¸­æ–­å‡½æ•°ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ task è¿è¡Œå°±æ˜¯æ“ä½œç³»ç»Ÿçš„ task è°ƒåº¦ç®—æ³•ã€‚è°ƒåº¦ç®—æ³•æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€é¡¹æ ¸å¿ƒåŠŸèƒ½ï¼Œucos æ“ä½œç³»ç»Ÿæ˜¯åŸºäºä¼˜å…ˆçº§çš„å¯å‰¥å¤ºå†…æ ¸è°ƒåº¦ï¼Œå³ task çš„è°ƒåº¦åŸºäº task çš„ä¼˜å…ˆçº§ï¼ŒåŒæ—¶é«˜ä¼˜å…ˆçº§ task å¯ä»¥æŠ¢å ä½ä¼˜å…ˆçº§ task è¿è¡Œï¼Œå› æ­¤ï¼Œæ¯ä¸ª task åœ¨è¿è¡Œå®Œéœ€è¦ä¸€ä¸ªå»¶æ—¶ä»¥å°† cpu èµ„æºè®©ç»™å…¶ä»–ä½ä¼˜å…ˆçº§ taskã€‚ucos çš„ task è°ƒåº¦åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯ task çº§çš„è°ƒåº¦ç”±å‡½æ•° OS_SChed() å‡½æ•°å®Œæˆï¼Œå¦ä¸€ç§æ˜¯ä¸­æ–­çº§çš„è°ƒåº¦ç”±å‡½æ•° OSIntExt() å‡½æ•°å®Œæˆï¼Œæœ¬æ–‡åªåˆ†æ task çº§è°ƒåº¦ï¼š</p><h3 id="os_sched-å‡½æ•°">OS_Sched å‡½æ•°ï¼š</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>  <span class="title function_">OS_Sched</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR  cpu_sr = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    OS_ENTER_CRITICAL();</span><br><span class="line">    <span class="keyword">if</span> (OSIntNesting == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (OSLockNesting == <span class="number">0</span>) {</span><br><span class="line">            OS_SchedNew();</span><br><span class="line">            <span class="keyword">if</span> (OSPrioHighRdy != OSPrioCur) {</span><br><span class="line">                OSTCBHighRdy = OSTCBPrioTbl[OSPrioHighRdy];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> OS_TASK_PROFILE_EN &gt; 0</span></span><br><span class="line">                OSTCBHighRdy-&gt;OSTCBCtxSwCtr++;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                OSCtxSwCtr++;</span><br><span class="line">                OS_TASK_SW();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    OS_EXIT_CRITICAL();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å‡½æ•°ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><ul><li><p>å®šä¹‰å…³ä¸­æ–­æ–¹å¼ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">OS_CPU_SR cpu_sr = <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>å®šä¹‰ç¬¬ä¸‰ç§æ–¹æ³•å¼€å…³ä¸­æ–­ï¼Œè¿™é‡Œæ’å…¥è®²è§£ä¸€ä¸‹ os å¼€å…³ä¸­æ–­çš„ä¸‰ç§æ–¹å¼ï¼Œ</p><ul><li>ç¬¬ä¸€ç§æ˜¯åˆ©ç”¨ cpu è‡ªå¸¦çš„æ€»ä¸­æ–­å¯„å­˜å™¨æ¥å®ç°å¼€å…³å…¨å±€ä¸­æ–­ï¼Œä¼˜ç‚¹æ˜¯å®ç°æ–¹ä¾¿ç¼ºç‚¹æ˜¯æ€»ä¸­æ–­æœ‰å¯èƒ½åŸæœ¬å°±æ˜¯å…³ç€çš„ï¼Œåœ¨è°ƒç”¨å®Œä¼šå°†å…¨å±€ä¸­æ–­æ‰“å¼€ã€‚</li><li>ç¬¬äºŒç§å¼€å…³å…¨å±€ä¸­æ–­çš„æ–¹å¼æ˜¯åˆ©ç”¨å †æ ˆä¿å­˜ä¸­æ–­çš„çŠ¶æ€ï¼Œå…³ä¸­æ–­åæ¢å¤ä¹‹å‰çš„ä¸­æ–­çŠ¶æ€ï¼Œè§£å†³äº†ç¬¬ä¸€ç§ä¸­æ–­çš„å¼Šç«¯ã€‚</li><li>ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡ cpu_sr æ¥ä¿å­˜ PSW å†å…³ä¸­æ–­ä¹‹åå†æ¢å¤ cpu_sr åˆ° PSW ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ä¸­ã€‚</li></ul></li><li><p>å…³ä¸­æ–­ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_ENTER_CRITICAL();</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>åˆ¤æ–­æ˜¯å¦åœ¨ä¸­æ–­é‡Œæˆ–è°ƒåº¦å™¨æ˜¯å¦ä¸Šé”ï¼Œæ˜¯å°±æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (OSIntNesting == <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">if</span> (OSLockNesting == <span class="number">0</span>) {</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>åˆ¤æ–­å½“å‰ task æ˜¯å¦æ˜¯å°±ç»ªçš„æœ€é«˜ä¼˜å…ˆçº§ task ä»¥å‡å°‘ task è°ƒåº¦å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (OSPrioHighRdy != OSPrioCur)</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>å°†å‡†å¤‡å°±ç»ªçš„æœ€é«˜ä¼˜å…ˆçº§ task æŒ‡å‘è¯¥è¯¥ task çš„ task æ§åˆ¶å—ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSTCBHighRdy = OSTCBPrioTbl[OSPrioHighRdy];</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>task åˆ‡æ¢ç»Ÿè®¡è®¡æ•°å™¨åŠ ä¸€ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSCtxSwCtr++;</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>task åˆ‡æ¢ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_TASK_SW();</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>å¼€ä¸­æ–­ï¼š</p><p></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OS_EXIT_CRITICAL();</span><br></pre></td></tr></tbody></table></figure><p></p></li></ul><h3 id="os_task_sw-å‡½æ•°">OS_TASK_SW å‡½æ•°</h3><p>ä¸‹é¢ä»‹ç» OS_TASK_SW() å‡½æ•°ï¼Œtask çº§è°ƒåº¦å…¶å®å°±æ˜¯è®¤ä¸ºæ¨¡æ‹Ÿä¸€æ¬¡ä¸­æ–­åˆ†ä¸¤æ­¥è¿›è¡Œï¼Œç¬¬ä¸€æ­¥æ˜¯å°†è¢«æŒ‚èµ· task çš„ CPU å¯„å­˜å™¨å‹å…¥å †æ ˆï¼Œç¬¬äºŒæ­¥æ˜¯å°†å‡†å¤‡å°±ç»ªçš„æœ€é«˜ä¼˜å…ˆçº§ task çš„å¯„å­˜å™¨ä» task å †æ ˆä¸­æ¢å¤åˆ°å¯„å­˜å™¨ä¸­ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OSCtxSw</span><br><span class="line">LDR R0, =NVIC_INT_CTRL ; Trigger the PendSV exception (causes context switch)</span><br><span class="line">LDR R1, =NVIC_PENDSVSET</span><br><span class="line">STR R1, [R0]</span><br><span class="line">BX LR</span><br></pre></td></tr></tbody></table></figure><p>OS_TASK_SW() æ˜¯ä¸€ä¸ªå®å®šä¹‰ä»–å®é™…ä¸Šæ˜¯ OSCtxSw æ±‡ç¼–ä»£ç çš„å®å®šä¹‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NVIC_INT_CTRL EQU 0xE000ED04</span><br><span class="line"></span><br><span class="line">NVIC_PENDSVSET EQU 0x10000000</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ®µæ±‡ç¼–ä»£ç æ˜¯ä¸ºäº†è§¦å‘ PendSV å¼‚å¸¸ï¼Œè¿›å…¥å¼‚å¸¸æŒ‡ä»¤ä»£ç å»æ‰§è¡Œï¼Œé€šè¿‡æŸ¥è¯¢æˆ‘ä»¬å‘ç°è·³è½¬åˆ° OS_CPU_PendSVHandler å¤„æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">OS_CPU_PendSVHandler</span><br><span class="line">CPSID I ; Prevent interruption during context switch</span><br><span class="line">MRS R0, PSP ; PSP is process stack pointer</span><br><span class="line">CBZ R0, OS_CPU_PendSVHandler_nosave ; Skip register save the first time</span><br><span class="line"></span><br><span class="line">SUBS R0, R0, #0x20 ; Save remaining regs r4-11 on process stack</span><br><span class="line">STM R0, {R4-R11}</span><br><span class="line"></span><br><span class="line">LDR R1, =OSTCBCur ; OSTCBCur-&gt;OSTCBStkPtr = SP;</span><br><span class="line">LDR R1, [R1]</span><br><span class="line">STR R0, [R1] ; R0 is SP of process being switched out; At this point, entire context of process has been saved</span><br><span class="line">OS_CPU_PendSVHandler_nosave</span><br><span class="line">PUSH {R14} ; Save LR exc_return value</span><br><span class="line">LDR R0, =OSTaskSwHook ; OSTaskSwHook();</span><br><span class="line">BLX R0</span><br><span class="line">POP {R14}</span><br><span class="line"></span><br><span class="line">LDR R0, =OSPrioCur ; OSPrioCur = OSPrioHighRdy;</span><br><span class="line">LDR R1, =OSPrioHighRdy</span><br><span class="line">LDRB R2, [R1]</span><br><span class="line">STRB R2, [R0]</span><br><span class="line"></span><br><span class="line">LDR R0, =OSTCBCur ; OSTCBCur = OSTCBHighRdy;</span><br><span class="line">LDR R1, =OSTCBHighRdy</span><br><span class="line">LDR R2, [R1]</span><br><span class="line">STR R2, [R0]</span><br><span class="line"></span><br><span class="line">LDR R0, [R2] ; R0 is new process SP; SP = OSTCBHighRdy-&gt;OSTCBStkPtr;</span><br><span class="line">LDM R0, {R4-R11} ; Restore r4-11 from new process stack</span><br><span class="line">ADDS R0, R0, #0x20</span><br><span class="line">MSR PSP, R0 ; Load PSP with new process SP</span><br><span class="line">ORR LR, LR, #0x04 ; Ensure exception return uses process stack</span><br><span class="line">CPSIE I</span><br><span class="line">BX LR ; Exception return will restore remaining context</span><br><span class="line">END</span><br></pre></td></tr></tbody></table></figure><p>æ€»ç»“èµ·æ¥å°±æ˜¯å°†å½“å‰å¯„å­˜å™¨ä¿å­˜åˆ°å½“å‰æŸ¥è¯¢å †æ ˆä¸­ã€‚</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSTCPHightRdy-&gt;OSTCBsTKpTR</span><br></pre></td></tr></tbody></table></figure><p>è·å–åˆ°å°±ç»ªæ€æœ€é«˜ä¼˜å…ˆçº§ task çš„ SP å¹¶å°†å…¶æ¢å¤åˆ° CPU SP å¯„å­˜å™¨ä¸­ï¼Œå°†å…¶ä»–å¯„å­˜å™¨å¼¹å‡ºæ‰§è¡Œä¸­æ–­è¿”å›ï¼Œå½“å‰å¯„å­˜å™¨ç¯å¢ƒ spï¼Œpc ç­‰å°±æ˜¯è¦åˆ‡æ¢ task çš„ç¯å¢ƒå€¼ï¼Œè¿è¡Œä»£ç å°±æ˜¯åˆ‡æ¢åçš„ taskï¼Œæ“ä½œç³»ç»Ÿå®ç°äº† task è°ƒåº¦ã€‚</p><h1 id="åŒæ­¥çš„å®ç°">åŒæ­¥çš„å®ç°</h1><p>åŒæ­¥çš„æ‰‹æ®µæœ‰å¾ˆå¤šè¿™é‡Œä»¥äº‹ä»¶æ§åˆ¶å—åŠå…¶å¤„ç†å‡½æ•°ä¸ºä¾‹æ¥è¯´æ˜ï¼Œå…¶ä»–åŒæ­¥æ‰‹æ®µå®ç°åŸç†æ˜¯ç›¸åŒçš„åªæ˜¯æ ¹æ®ä¸åŒçš„éœ€æ±‚åšäº†å“åº”çš„è®¾è®¡ã€‚</p><h2 id="äº‹ä»¶æ§åˆ¶å—">äº‹ä»¶æ§åˆ¶å—</h2><p>äº‹ä»¶åŒæ­¥å’Œèµ„æºåŒæ­¥éƒ½æ˜¯é€šè¿‡äº‹ä»¶æ§åˆ¶å— ECB ç»“æ„æ¥ç®¡ç†çš„ï¼Œå¯¹äºäº‹ä»¶æˆ–è€…èµ„æºçš„è¯·æ±‚æˆ–è€…é‡Šæ”¾ä¼´éšç€ task çš„æŒ‚èµ·å’Œæ¢å¤ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">os_event</span> {</span></span><br><span class="line">    INT8U    OSEventType;                    <span class="comment">/*äº‹ä»¶ç±»å‹ Type of event control block (see OS_EVENT_TYPE_xxxx)    */</span></span><br><span class="line">    <span class="type">void</span>    *OSEventPtr;                     <span class="comment">/*æŒ‡å‘æ¶ˆæ¯æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—çš„æŒ‡é’ˆ Pointer to message or queue structure     */</span></span><br><span class="line">    INT16U   OSEventCnt;                     <span class="comment">/*è®¡æ•°å™¨ Semaphore Count (not used if other EVENT type)          */</span></span><br><span class="line">    OS_PRIO  OSEventGrp;                     <span class="comment">/*ç­‰å¾… task æ‰€åœ¨çš„ç»„ Group corresponding to tasks waiting for event to occur */</span></span><br><span class="line">    OS_PRIO  OSEventTbl[OS_EVENT_TBL_SIZE];  <span class="comment">/*ç­‰å¾… task åˆ—è¡¨ List of tasks waiting for event to occur                */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> OS_EVENT_NAME_EN &gt; 0u</span></span><br><span class="line">    INT8U   *OSEventName;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">} OS_EVENT;</span><br></pre></td></tr></tbody></table></figure><ul><li>OSEventPtr æŒ‡é’ˆï¼Œåªæœ‰åœ¨æ‰€å®šä¹‰çš„äº‹ä»¶æ˜¯é‚®ç®±æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—æ—¶æ‰ä½¿ç”¨ã€‚å½“æ‰€å®šä¹‰çš„äº‹ä»¶æ˜¯é‚®ç®±æ—¶ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªæ¶ˆæ¯ï¼Œè€Œå½“æ‰€å®šä¹‰çš„äº‹ä»¶æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</li><li>OSEventTbl[] å’Œ OSEventGrp å¾ˆåƒå‰é¢è®²åˆ°çš„ OSRdyTbl[] å’Œ OSRdyGrpï¼Œåªä¸è¿‡å‰ä¸¤è€…åŒ…å«çš„æ˜¯ç­‰å¾…æŸäº‹ä»¶çš„ taskï¼Œè€Œåä¸¤è€…åŒ…å«çš„æ˜¯ç³»ç»Ÿä¸­å¤„äºå°±ç»ªçŠ¶æ€çš„ taskã€‚</li><li>OSEventCnt å½“äº‹ä»¶æ˜¯ä¸€ä¸ªä¿¡å·é‡æ—¶ï¼Œ.OSEventCnt æ˜¯ç”¨äºä¿¡å·é‡çš„è®¡æ•°å™¨ã€‚</li><li>OSEventType å®šä¹‰äº†äº‹ä»¶çš„å…·ä½“ç±»å‹ã€‚å®ƒå¯ä»¥æ˜¯ä¿¡å·é‡ï¼ˆOS_EVENT_SEMï¼‰ã€é‚®ç®±ï¼ˆOS_EVENT_TYPE_MBOXï¼‰æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆOS_EVENT_TYPE_Qï¼‰ä¸­çš„ä¸€ç§ã€‚ç”¨æˆ·è¦æ ¹æ®è¯¥åŸŸçš„å…·ä½“å€¼æ¥è°ƒç”¨ç›¸åº”çš„ç³»ç»Ÿå‡½æ•°ï¼Œä»¥ä¿è¯å¯¹å…¶è¿›è¡Œçš„æ“ä½œçš„æ­£ç¡®æ€§ã€‚</li></ul><p>å¯¹äºç­‰å¾…äº‹ä»¶ä»»åŠ¡çš„è®°å½•ï¼ŒuC/OS-II åˆä½¿ç”¨äº†ä¸ä»»åŠ¡å°±ç»ªè¡¨ç±»ä¼¼çš„ä½å›¾ï¼Œå³å®šä¹‰äº†ä¸€ä¸ª UINT8 ç±»å‹çš„æ•°ç»„ OSEventTbl[] æ¥ä½œä¸ºç­‰å¾…äº‹ä»¶ä»»åŠ¡çš„è®°å½•è¡¨ï¼Œå³ç­‰å¾…ä»»åŠ¡è¡¨ã€‚</p><p>ç­‰å¾…ä»»åŠ¡è¡¨ä»ç„¶ä»¥ä»»åŠ¡çš„ä¼˜å…ˆçº§åˆ«ä¸ºé¡ºåºä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå¹¶ç”¨è¯¥ä½ä¸º 1 æ¥è¡¨ç¤ºè¿™ä¸€ä½å¯¹åº”çš„ä»»åŠ¡ä¸ºäº‹ä»¶çš„ç­‰å¾…ä»»åŠ¡ï¼Œå¦åˆ™ä¸æ˜¯ç­‰å¾…ä»»åŠ¡ã€‚åŒæ ·ï¼Œä¸ºäº†åŠ å¿«å¯¹è¯¥è¡¨çš„è®¿é—®é€Ÿåº¦ï¼Œä¹Ÿå®šä¹‰äº†ä¸€ä¸ª UINT8 ç±»å‹çš„å˜é‡ OSEventGrp æ¥è¡¨ç¤ºç­‰å¾…ä»»åŠ¡è¡¨ä¸­çš„ä»»åŠ¡ç»„ã€‚ç­‰å¾…ä»»åŠ¡è¡¨ OSEventTbl[] ä¸å˜é‡ OSEventGrp çš„ç¤ºæ„å›¾å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/RTOS_ECB.png"></p><p>è‡³äºç­‰å¾…ä»»åŠ¡çš„ç­‰å¾…æ—¶é™ï¼Œåˆ™è®°å½•åœ¨ç­‰å¾…ä»»åŠ¡çš„ä»»åŠ¡æ§åˆ¶å— TCB çš„æˆå‘˜ OSTCBDIy ä¸­å¹¶åœ¨æ¯ä¸ªæ—¶é’ŸèŠ‚æ‹ä¸­æ–­æœåŠ¡ç¨‹åºä¸­å¯¹è¯¥æ•°æ®è¿›è¡Œç»´æŠ¤ã€‚æ¯å½“æœ‰ä»»åŠ¡çš„ç­‰å¾…æ—¶é™åˆ°æ—¶ï¼Œå°†è¯¥åŠ¡ä»ç­‰å¾…ä»»åŠ¡è¡¨ä¸­åˆ é™¤ï¼Œå¹¶ä½¿å®ƒè¿›å…¥å°±ç»ªçŠ¶æ€ã€‚</p><h2 id="ç©ºäº‹ä»¶æ§åˆ¶å—é“¾è¡¨">ç©ºäº‹ä»¶æ§åˆ¶å—é“¾è¡¨</h2><p>åœ¨Î¼C/OS-II åˆå§‹åŒ–æ—¶ï¼Œç³»ç»Ÿåœ¨åˆå§‹åŒ–å‡½æ•° OSnit() ä¸­åˆ›å»º OS_MAX_EVEINTS ä¸ªç©ºäº‹ä»¶æ§åˆ¶å—å¹¶å€Ÿç”¨æˆå‘˜ OSEventPtr ä½œä¸ºé“¾æ¥æŒ‡é’ˆï¼ŒæŠŠè¿™äº›ç©ºäº‹ä»¶æ§åˆ¶å—é“¾æ¥æˆä¸€ä¸ªå¦‚å›¾ 5-11 æ‰€ç¤ºçš„å•å‘é“¾è¡¨ã€‚ç”±äºé“¾è¡¨ä¸­çš„æ‰€æœ‰æ§åˆ¶å«åšç©ºäº‹ä»¶æ§åˆ¶å—ä¸”å°šæœªä¸å…·ä½“äº‹ä»¶ç›¸å…³è”ï¼Œå› æ­¤è¯¥é“¾è¡¨å«ç©ºäº‹ä»¶æ§åˆ¶å—é“¾è¡¨ã€‚ä»¥åï¼Œæ¯å½“åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä»é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶æ§åˆ¶å—ï¼Œå¹¶å¯¹äº‹ä»¶æ§åˆ¶å—è¿›è¡Œåˆå§‹åŒ–ä»¥æè¿°è¯¥äº‹ä»¶ã€‚è€Œå½“ç”¨ç¨‹åºåˆ é™¤ä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œå°±ä¼šå°†è¯¥äº‹ä»¶æ§åˆ¶å—å½’è¿˜ç»™ç©ºäº‹ä»¶æ§åˆ¶å—é“¾è¡¨ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/RTOS/rtos_event_list.png"></p><h2 id="æ“ä½œå‡½æ•°">æ“ä½œå‡½æ•°</h2><p>å½“ task è¯·æ±‚ä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆOS_EventTaskWait()ï¼‰ï¼Œè€Œè¯¥äº‹ä»¶æ­£å¥½è¢«å¦ä¸€ä¸ª task æŒæœ‰ï¼Œé‚£ä¹ˆå½“å‰ task å°±ä¼šæŒ‚èµ·æ”¾åˆ° OSEventTbl å’Œ OSEventGrp é‡Œã€‚åœ¨æŒæœ‰äº‹ä»¶çš„ task é‡Šæ”¾äº‹ä»¶çš„æ—¶å€™ä¼šå†å°†è¯·æ±‚è¯¥äº‹ä»¶çš„ task å”¤é†’ (OS_EventTaskRdy())ã€‚ä»è€Œå®ç°ä¸¤ä¸ª task ä¹‹é—´çš„åŒæ­¥ï¼ˆäº‹ä»¶æˆ–èµ„æºï¼‰ã€‚</p><p>å…¶ä»–ä¿¡å·é‡ã€äº’æ–¥ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ¶ˆæ¯é‚®ç®±ç­‰å®ç°åŸç†æ˜¯ç›¸åŒçš„ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€åˆ—å‡ºäº†ã€‚</p><h1 id="ç»Ÿè®¡-task">ç»Ÿè®¡ task</h1><p>ucos è®¡ç®— CPU åˆ©ç”¨ç‡çš„å®ç°æ–¹æ³•æ˜¯ï¼š</p><ul><li>åœ¨è¿è¡Œ task ä¹‹å‰è®¡ç®—å‡ºç©ºé—² task è¿è¡Œçš„æœ€å¤§é€Ÿç‡ OSIdleCtrMaxã€‚</li><li>æ±‚å‡º task è¿è¡Œæ—¶ç©ºé—² task è®¡æ•°å™¨çš„è®¡æ•°é€Ÿç‡ OSIdleCtrã€‚</li><li>åˆ©ç”¨å…¬å¼æ±‚å‡º CPU åˆ©ç”¨ç‡å°±æ˜¯ OSIdleCtr/OSIdleCtrMax * 100%ã€‚</li></ul><p>å°±æ˜¯é€šè¿‡è®¡ç®— cpu è¿›å…¥ç©ºé—² task çš„æ¯”ä¾‹æ¥æ¨ç®—å‡º cpu åˆ©ç”¨ç‡ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OSCPUUsage   = (INT8U)(<span class="number">100L</span> - OSIdleCtrRun / OSIdleCtrMax);</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿ ucos-ii æ•™ç¨‹ã€‹<br>ã€Šå‘¨æ…ˆèˆª-åŸºäºåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿçš„ç¨‹åºè®¾è®¡æŠ€æœ¯ã€‹<br>ã€ŠåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»ŸÎ¼COS-IIåŸç†åŠåº”ç”¨-ä»»å“²ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> RTOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RTOS </tag>
            
            <tag> ucos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‹è¯-å…¶ä»–</title>
      <link href="/2019/Literature/SongciOther/"/>
      <url>/2019/Literature/SongciOther/</url>
      
        <content type="html"><![CDATA[<h1 id="é•¿ç›¸æ€æ±´æ°´æµ">é•¿ç›¸æ€Â·æ±´æ°´æµ</h1><p>ç™½å±…æ˜“</p><p>æ±´æ°´æµï¼Œæ³—æ°´æµï¼Œæµåˆ°ç“œå·å¤æ¸¡å¤´ã€‚å´å±±ç‚¹ç‚¹æ„ã€‚</p><p>æ€æ‚ æ‚ ï¼Œæ¨æ‚ æ‚ ï¼Œæ¨åˆ°å½’æ—¶æ–¹å§‹ä¼‘ã€‚æœˆæ˜äººå€šæ¥¼ã€‚</p><span id="more"></span><h1 id="æµªæ·˜æ²™å€Ÿé—®æ±Ÿæ½®ä¸æµ·æ°´">æµªæ·˜æ²™Â·å€Ÿé—®æ±Ÿæ½®ä¸æµ·æ°´</h1><p>ç™½å±…æ˜“</p><p>å€Ÿé—®æ±Ÿæ½®ä¸æµ·æ°´ï¼Œä½•ä¼¼å›æƒ…ä¸å¦¾å¿ƒï¼Ÿ</p><p>ç›¸æ¨ä¸å¦‚æ½®æœ‰ä¿¡ï¼Œç›¸æ€å§‹è§‰æµ·éæ·±ã€‚</p><h1 id="èŠ±éèŠ±">èŠ±éèŠ±</h1><p>ç™½å±…æ˜“</p><p>èŠ±éèŠ±ï¼Œé›¾éé›¾ã€‚</p><p>å¤œåŠæ¥ï¼Œå¤©æ˜å»ã€‚</p><p>æ¥å¦‚æ˜¥æ¢¦å‡ å¤šæ—¶ï¼Ÿ</p><p>å»ä¼¼æœäº‘æ— è§…å¤„ã€‚</p><h1 id="å¿†æ±Ÿå—æ±Ÿå—å¥½">å¿†æ±Ÿå—Â·æ±Ÿå—å¥½</h1><p>ç™½å±…æ˜“</p><p>æ±Ÿå—å¥½ï¼Œé£æ™¯æ—§æ›¾è°™ã€‚æ—¥å‡ºæ±ŸèŠ±çº¢èƒœç«ï¼Œæ˜¥æ¥æ±Ÿæ°´ç»¿å¦‚è“ã€‚èƒ½ä¸å¿†æ±Ÿå—ï¼Ÿ</p><h1 id="åäºŒæœˆäºŒæ—¥å¤œæ¢¦æ¸¸æ²ˆæ°å›­äº­">åäºŒæœˆäºŒæ—¥å¤œæ¢¦æ¸¸æ²ˆæ°å›­äº­</h1><p>é™†æ¸¸</p><p>åŸå—å°é™Œåˆé€¢æ˜¥ï¼Œåªè§æ¢…èŠ±ä¸è§äººã€‚</p><p>ç‰éª¨ä¹…æˆæ³‰ä¸‹åœŸï¼Œå¢¨ç—•çŠ¹é”å£é—´å°˜ã€‚</p><h1 id="åœç®—å­å’æ¢…">åœç®—å­Â·å’æ¢…</h1><p>é™†æ¸¸</p><p>é©¿å¤–æ–­æ¡¥è¾¹ï¼Œå¯‚å¯å¼€æ— ä¸»ã€‚å·²æ˜¯é»„æ˜ç‹¬è‡ªæ„ï¼Œæ›´è‘—é£å’Œé›¨ã€‚</p><p>æ— æ„è‹¦äº‰æ˜¥ï¼Œä¸€ä»»ç¾¤èŠ³å¦’ã€‚é›¶è½æˆæ³¥ç¢¾ä½œå°˜ï¼Œåªæœ‰é¦™å¦‚æ•…ã€‚</p><h1 id="è¯‰è¡·æƒ…å½“å¹´ä¸‡é‡Œè§…å°ä¾¯">è¯‰è¡·æƒ…Â·å½“å¹´ä¸‡é‡Œè§…å°ä¾¯</h1><p>é™†æ¸¸</p><p>å½“å¹´ä¸‡é‡Œè§…å°ä¾¯ï¼ŒåŒ¹é©¬æˆæ¢å·ã€‚å…³æ²³æ¢¦æ–­ä½•å¤„ï¼Ÿå°˜æš—æ—§è²‚è£˜ã€‚</p><p>èƒ¡æœªç­ï¼Œé¬“å…ˆç§‹ï¼Œæ³ªç©ºæµã€‚æ­¤ç”Ÿè°æ–™ï¼Œå¿ƒåœ¨å¤©å±±ï¼Œèº«è€æ²§æ´²ã€‚</p><h1 id="é¹Šæ¡¥ä»™åç¯çºµåš">é¹Šæ¡¥ä»™Â·åç¯çºµåš</h1><p>é™†æ¸¸</p><p>åç¯çºµåšï¼Œé›•éé©°å°„ï¼Œè°è®°å½“å¹´è±ªä¸¾ã€‚é…’å¾’ä¸€åŠå–å°ä¾¯ï¼Œç‹¬å»ä½œã€æ±Ÿè¾¹æ¸”çˆ¶ã€‚</p><p>è½»èˆŸå…«å°ºï¼Œä½ç¯·ä¸‰æ‰‡ï¼Œå æ–­è‹¹æ´²çƒŸé›¨ã€‚é•œæ¹–å…ƒè‡ªå±é—²äººï¼Œåˆä½•å¿…ã€å›æ©èµä¸ã€‚</p><h1 id="å¤œæ¸¸å®«è®°æ¢¦å¯„å¸ˆä¼¯æµ‘">å¤œæ¸¸å®«Â·è®°æ¢¦å¯„å¸ˆä¼¯æµ‘</h1><p>é™†æ¸¸</p><p>é›ªæ™“æ¸…ç¬³ä¹±èµ·ã€‚æ¢¦æ¸¸å¤„ã€ä¸çŸ¥ä½•åœ°ã€‚é“éª‘æ— å£°æœ›ä¼¼æ°´ã€‚æƒ³å…³æ²³ï¼Œé›é—¨è¥¿ï¼Œé’æµ·é™…ã€‚</p><p>ç¡è§‰å¯’ç¯é‡Œã€‚æ¼å£°æ–­ã€æœˆæ–œçª—çº¸ã€‚è‡ªè®¸å°ä¾¯åœ¨ä¸‡é‡Œã€‚æœ‰è°çŸ¥ï¼Œé¬“è™½æ®‹ï¼Œå¿ƒæœªæ­»ã€‚</p><h1 id="é’—å¤´å‡¤çº¢é…¥æ‰‹">é’—å¤´å‡¤Â·çº¢é…¥æ‰‹</h1><p>é™†æ¸¸</p><p>çº¢é…¥æ‰‹ï¼Œé»„ç¸¢é…’ï¼Œæ»¡åŸæ˜¥è‰²å®«å¢™æŸ³ã€‚ä¸œé£æ¶ï¼Œæ¬¢æƒ…è–„ã€‚ä¸€æ€€æ„ç»ªï¼Œå‡ å¹´ç¦»ç´¢ã€‚é”™ã€é”™ã€é”™ã€‚</p><p>æ˜¥å¦‚æ—§ï¼Œäººç©ºç˜¦ï¼Œæ³ªç—•çº¢æµ¥é²›ç»¡é€ã€‚æ¡ƒèŠ±è½ï¼Œé—²æ± é˜ã€‚å±±ç›Ÿè™½åœ¨ï¼Œé”¦ä¹¦éš¾æ‰˜ã€‚è«ã€è«ã€è«ï¼</p><h1 id="ç§‹æ³¢åªšä¸ƒæœˆåå…­æ—¥æ™šç™»é«˜å…´äº­æœ›é•¿å®‰å—å±±">ç§‹æ³¢åªšÂ·ä¸ƒæœˆåå…­æ—¥æ™šç™»é«˜å…´äº­æœ›é•¿å®‰å—å±±</h1><p>é™†æ¸¸</p><p>ç§‹åˆ°è¾¹åŸè§’å£°å“€ï¼Œçƒ½ç«ç…§é«˜å°ã€‚æ‚²æ­Œå‡»ç­‘ï¼Œå‡­é«˜é…¹é…’ï¼Œæ­¤å…´æ‚ å“‰ã€‚</p><p>å¤šæƒ…è°ä¼¼å—å±±æœˆï¼Œç‰¹åœ°æš®äº‘å¼€ã€‚çæ¡¥çƒŸæŸ³ï¼Œæ›²æ±Ÿæ± é¦†ï¼Œåº”å¾…äººæ¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¾›å¼ƒç–¾</title>
      <link href="/2019/Literature/Xinqiji/"/>
      <url>/2019/Literature/Xinqiji/</url>
      
        <content type="html"><![CDATA[<h1 id="è¥¿æ±Ÿæœˆé£å…´">è¥¿æ±ŸæœˆÂ·é£å…´</h1><p>é†‰é‡Œä¸”è´ªæ¬¢ç¬‘ï¼Œè¦æ„é‚£å¾—å·¥å¤«ã€‚</p><p>è¿‘æ¥å§‹è§‰å¤äººä¹¦ã€‚ä¿¡è‘—å…¨æ— æ˜¯å¤„ã€‚</p><p>æ˜¨å¤œæ¾è¾¹é†‰å€’ï¼Œé—®æ¾æˆ‘é†‰ä½•å¦‚ã€‚</p><p>åªç–‘æ¾åŠ¨è¦æ¥æ‰¶ã€‚ä»¥æ‰‹æ¨æ¾æ›°å»ã€‚</p><span id="more"></span><h1 id="æ¸…å¹³ä¹ç‹¬å®¿åšå±±ç‹æ°åºµ">æ¸…å¹³ä¹Â·ç‹¬å®¿åšå±±ç‹æ°åºµ</h1><p>ç»•åºŠé¥¥é¼ ï¼Œè™è ç¿»ç¯èˆã€‚å±‹ä¸Šæ¾é£å¹æ€¥é›¨ï¼Œç ´çº¸çª—é—´è‡ªè¯­ã€‚</p><p>å¹³ç”Ÿå¡åŒ—æ±Ÿå—ï¼Œå½’æ¥åå‘è‹é¢œã€‚å¸ƒè¢«ç§‹å®µæ¢¦è§‰ï¼Œçœ¼å‰ä¸‡é‡Œæ±Ÿå±±ã€‚</p><h1 id="è¥¿æ±Ÿæœˆå¤œè¡Œé»„æ²™é“ä¸­">è¥¿æ±ŸæœˆÂ·å¤œè¡Œé»„æ²™é“ä¸­</h1><p>æ˜æœˆåˆ«ææƒŠé¹Šï¼Œæ¸…é£åŠå¤œé¸£è‰ã€‚ç¨»èŠ±é¦™é‡Œè¯´ä¸°å¹´ï¼Œå¬å–è›™å£°ä¸€ç‰‡ã€‚</p><p>ä¸ƒå…«ä¸ªæ˜Ÿå¤©å¤–ï¼Œä¸¤ä¸‰ç‚¹é›¨å±±å‰ã€‚æ—§æ—¶èŒ…åº—ç¤¾æ—è¾¹ï¼Œè·¯è½¬æºªæ¡¥å¿½è§ã€‚</p><h1 id="è´ºæ–°éƒåˆ«èŒ‚å˜‰åäºŒå¼Ÿ">è´ºæ–°éƒÂ·åˆ«èŒ‚å˜‰åäºŒå¼Ÿ</h1><p>åˆ«èŒ‚å˜‰åäºŒå¼Ÿã€‚é¹ˆé´‚ã€æœé¹ƒå®ä¸¤ç§ï¼Œè§ã€Šç¦»éªšè¡¥æ³¨ã€‹</p><p>ç»¿æ ‘å¬é¹ˆé´‚ã€‚æ›´é‚£å ªã€é¹§é¸ªå£°ä½ï¼Œæœé¹ƒå£°åˆ‡ã€‚å•¼åˆ°æ˜¥å½’æ— å¯»å¤„ï¼Œè‹¦æ¨èŠ³è²éƒ½æ­‡ã€‚ç®—æœªæŠµã€äººé—´ç¦»åˆ«ã€‚é©¬ä¸Šçµç¶å…³å¡é»‘ï¼Œæ›´é•¿é—¨ã€ç¿ è¾‡è¾é‡‘é˜™ã€‚çœ‹ç‡•ç‡•ï¼Œé€å½’å¦¾ã€‚</p><p>å°†å†›ç™¾æˆ˜èº«åè£‚ã€‚å‘æ²³æ¢ã€å›å¤´ä¸‡é‡Œï¼Œæ•…äººé•¿ç»ã€‚æ˜“æ°´è§è§è¥¿é£å†·ï¼Œæ»¡åº§è¡£å† ä¼¼é›ªã€‚æ­£å£®å£«ã€æ‚²æ­Œæœªå½»ã€‚å•¼é¸Ÿè¿˜çŸ¥å¦‚è®¸æ¨ï¼Œæ–™ä¸å•¼æ¸…æ³ªé•¿å•¼è¡€ã€‚è°å…±æˆ‘ï¼Œé†‰æ˜æœˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— çº¿ç›¸å…³æ¦‚å¿µ</title>
      <link href="/2019/Note/WirelessSummery/"/>
      <url>/2019/Note/WirelessSummery/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Linuxwire1.png"></p><h1 id="é¢‘è°±åˆ’åˆ†">é¢‘è°±åˆ’åˆ†</h1><ul><li>IEEE 802.11b/g æ ‡å‡†å·¥ä½œåœ¨ 2.4G é¢‘æ®µï¼Œé¢‘ç‡èŒƒå›´ä¸º 2.400â€”2.4835GHzï¼Œå…± 83.5M å¸¦å®½</li><li>åˆ’åˆ†ä¸º 14 ä¸ªå­ä¿¡é“</li><li>æ¯ä¸ªå­ä¿¡é“å®½åº¦ä¸º 22MHz</li><li>ç›¸é‚»ä¿¡é“çš„ä¸­å¿ƒé¢‘ç‚¹é—´éš” 5MHz</li><li>ç›¸é‚»çš„å¤šä¸ªä¿¡é“å­˜åœ¨é¢‘ç‡é‡å ï¼ˆå¦‚ 1 ä¿¡é“ä¸ 2ã€3ã€4ã€5 ä¿¡é“æœ‰é¢‘ç‡é‡å ï¼‰</li><li>æ•´ä¸ªé¢‘æ®µå†…åªæœ‰ 3 ä¸ªï¼ˆ1ã€6ã€11ï¼‰äº’ä¸å¹²æ‰°ä¿¡é“</li></ul><span id="more"></span><h1 id="æ¥æ”¶çµæ•åº¦">æ¥æ”¶çµæ•åº¦</h1><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Linuxwire2.png"></p><h1 id="ä¿¡é“åˆ’åˆ†">ä¿¡é“åˆ’åˆ†</h1><p>2.4G ä¿¡é“ä¸­å›½åˆ’åˆ† 802.11b å’Œ 802.11g çš„å·¥ä½œé¢‘æ®µåœ¨ 2.4GHzï¼ˆ2.4GHz-2.4835GHzï¼‰ï¼Œå…¶å¯ç”¨å¸¦å®½ä¸º 83.5MHzï¼Œä¸­å›½åˆ’åˆ†ä¸º 13 ä¸ªä¿¡é“ï¼Œæ¯ä¸ªä¿¡é“å¸¦å®½ä¸º 22MHz</p><p>åŒ—ç¾/FCC 2.412-2.461GHz(11 ä¿¡é“ï¼‰ æ¬§æ´²/ETSI 2.412-2.472GHz(13 ä¿¡é“ï¼‰ æ—¥æœ¬/ARIB 2.412-2.(14 ä¿¡é“ï¼‰</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/Linuxwire3.png"></p><h1 id="ssid-å’Œ-bssid">SSID å’Œ BSSID</h1><h2 id="åŸºæœ¬æœåŠ¡é›†bss">åŸºæœ¬æœåŠ¡é›†ï¼ˆBSSï¼‰</h2><p>åŸºæœ¬æœåŠ¡é›†æ˜¯ 802.11 LAN çš„åŸºæœ¬ç»„æˆæ¨¡å—ã€‚èƒ½äº’ç›¸è¿›è¡Œæ— çº¿é€šä¿¡çš„ STA å¯ä»¥ç»„æˆä¸€ä¸ª BSSï¼ˆBasic Service Setï¼‰ ã€‚å¦‚æœä¸€ä¸ªç«™ç§»å‡º BSS çš„è¦†ç›–èŒƒå›´ï¼Œå®ƒå°†ä¸èƒ½å†ä¸ BSS çš„å…¶å®ƒæˆå‘˜é€šä¿¡ã€‚</p><h2 id="æ‰©å±•æœåŠ¡é›†ess">æ‰©å±•æœåŠ¡é›†ï¼ˆESSï¼‰</h2><p>å¤šä¸ª BSS å¯ä»¥æ„æˆä¸€ä¸ªæ‰©å±•ç½‘ç»œï¼Œç§°ä¸ºæ‰©å±•æœåŠ¡é›†ï¼ˆESSï¼‰ç½‘ç»œï¼Œä¸€ä¸ª ESS ç½‘ç»œå†…éƒ¨çš„ STA å¯ä»¥äº’ç›¸é€šä¿¡ï¼Œæ˜¯é‡‡ç”¨ç›¸åŒçš„ SSID çš„å¤šä¸ª BSS å½¢æˆçš„æ›´å¤§è§„æ¨¡çš„è™šæ‹Ÿ BSSã€‚è¿æ¥ BSS çš„ç»„ä»¶ç§°ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆDistribution Systemï¼ŒDSï¼‰ã€‚</p><h2 id="ssid">SSID</h2><p>æœåŠ¡é›†çš„æ ‡è¯†ï¼Œåœ¨åŒä¸€ SS å†…çš„æ‰€æœ‰ STA å’Œ AP å¿…é¡»å…·æœ‰ç›¸åŒçš„ SSIDï¼Œå¦åˆ™æ— æ³•è¿›è¡Œé€šä¿¡ã€‚</p><p>SSID æ˜¯ä¸€ä¸ª ESS çš„ç½‘ç»œæ ‡è¯†ï¼ˆå¦‚ï¼šTP_Link_1201)ï¼ŒBSSID æ˜¯ä¸€ä¸ª BSS çš„æ ‡è¯†ï¼ŒBSSID å®é™…ä¸Šå°±æ˜¯ AP çš„ MAC åœ°å€ï¼Œç”¨æ¥æ ‡è¯† AP ç®¡ç†çš„ BSSï¼Œåœ¨åŒä¸€ä¸ª AP å†… BSSID å’Œ SSID ä¸€ä¸€æ˜ å°„ã€‚åœ¨ä¸€ä¸ª ESS å†… SSID æ˜¯ç›¸åŒçš„ï¼Œä½†å¯¹äº ESS å†…çš„æ¯ä¸ª AP ä¸ä¹‹å¯¹åº”çš„ BSSID æ˜¯ä¸ç›¸åŒçš„ã€‚å¦‚æœä¸€ä¸ª AP å¯ä»¥åŒæ—¶æ”¯æŒå¤šä¸ª SSID çš„è¯ï¼Œåˆ™ AP ä¼šåˆ†é…ä¸åŒçš„ BSSID æ¥å¯¹åº”è¿™äº› SSIDã€‚</p><p>BSSID(MAC)&lt;----&gt;SSID</p><h1 id="ap-ç§ç±»">AP ç§ç±»</h1><p>FAT AP å’Œ FIT AP æ¯”è¾ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><h1 id="æ— çº¿æ¥å…¥è¿‡ç¨‹">æ— çº¿æ¥å…¥è¿‡ç¨‹</h1><p>æ— çº¿æ¥å…¥è¿‡ç¨‹ STAï¼ˆå·¥ä½œç«™ï¼‰å¯åŠ¨åˆå§‹åŒ–ã€å¼€å§‹æ­£å¼ä½¿ç”¨ AP ä¼ é€æ•°æ®å¸§å‰ï¼Œè¦ç»è¿‡ä¸‰ä¸ªé˜¶æ®µæ‰èƒ½å¤Ÿæ¥å…¥ï¼ˆ802.11MAC å±‚è´Ÿè´£å®¢æˆ·ç«¯ä¸ AP ä¹‹é—´çš„é€šè®¯ï¼ŒåŠŸèƒ½åŒ…æ‹¬æ‰«æã€æ¥å…¥ã€è®¤è¯ã€åŠ å¯†ã€æ¼«æ¸¸å’ŒåŒæ­¥ç­‰åŠŸèƒ½ï¼‰ï¼š</p><ul><li>æ‰«æé˜¶æ®µï¼ˆSCANï¼‰</li><li>è®¤è¯é˜¶æ®µ (Authentication)</li><li>å…³è”ï¼ˆAssociationï¼‰</li></ul><h2 id="scanning">Scanning</h2><p>802.11 MAC ä½¿ç”¨ Scanning æ¥æœç´¢ APï¼ŒSTA æœç´¢å¹¶è¿æ¥ä¸€ä¸ª APï¼Œå½“ STA æ¼«æ¸¸æ—¶å¯»æ‰¾è¿æ¥ä¸€ä¸ªæ–°çš„ APï¼ŒSTA ä¼šåœ¨åœ¨æ¯ä¸ªå¯ç”¨çš„ä¿¡é“ä¸Šè¿›è¡Œæœç´¢ã€‚</p><h3 id="passive-scanningç‰¹ç‚¹æ‰¾åˆ°æ—¶é—´è¾ƒé•¿ä½†-sta-èŠ‚ç”µ">Passive Scanningï¼ˆç‰¹ç‚¹ï¼šæ‰¾åˆ°æ—¶é—´è¾ƒé•¿ï¼Œä½† STA èŠ‚ç”µï¼‰</h3><p>é€šè¿‡ä¾¦å¬ AP å®šæœŸå‘é€çš„ Beacon å¸§æ¥å‘ç°ç½‘ç»œï¼Œè¯¥å¸§æä¾›äº† AP åŠæ‰€åœ¨ BSS ç›¸å…³ä¿¡æ¯ï¼šâ€œæˆ‘åœ¨è¿™é‡Œâ€â€¦</p><h3 id="active-scanning-ç‰¹ç‚¹èƒ½è¿…é€Ÿæ‰¾åˆ°">Active Scanning ï¼ˆç‰¹ç‚¹ï¼šèƒ½è¿…é€Ÿæ‰¾åˆ°ï¼‰</h3><p>STA ä¾æ¬¡åœ¨ 13 ä¸ªä¿¡é“å‘å‡º Probe Request å¸§ï¼Œå¯»æ‰¾ä¸ STA æ‰€å±æœ‰ç›¸åŒ SSID çš„ AP, è‹¥æ‰¾ä¸åˆ°ç›¸åŒ SSID çš„ APï¼Œåˆ™ä¸€ç›´æ‰«æä¸‹å»ã€‚.</p><h2 id="authentication">Authentication</h2><p>å½“ STA æ‰¾åˆ°ä¸å…¶æœ‰ç›¸åŒ SSID çš„ APï¼Œåœ¨ SSID åŒ¹é…çš„ AP ä¸­ï¼Œæ ¹æ®æ”¶åˆ°çš„ AP ä¿¡å·å¼ºåº¦ï¼Œé€‰æ‹©ä¸€ä¸ªä¿¡å·æœ€å¼ºçš„ APï¼Œç„¶åè¿›å…¥è®¤è¯é˜¶æ®µã€‚åªæœ‰èº«ä»½è®¤è¯é€šè¿‡çš„ç«™ç‚¹æ‰èƒ½è¿›è¡Œæ— çº¿æ¥å…¥è®¿é—®ã€‚AP æä¾›å¦‚ä¸‹è®¤è¯æ–¹æ³•ï¼š</p><ul><li>å¼€æ”¾ç³»ç»Ÿèº«ä»½è®¤è¯ (open-system authentication)</li><li>å…±äº«å¯†é’¥è®¤è¯ (shared-key authentication)</li><li>WPA PSK è®¤è¯ï¼ˆPre-shared keyï¼‰</li><li>802.1X EAP è®¤è¯</li></ul><h2 id="association">Association</h2><p>å½“ AP å‘ STA è¿”å›è®¤è¯å“åº”ä¿¡æ¯ï¼Œèº«ä»½è®¤è¯è·å¾—é€šè¿‡åï¼Œè¿›å…¥å…³è”é˜¶æ®µã€‚</p><ul><li>STA å‘ AP å‘é€å…³è”è¯·æ±‚</li><li>AP å‘ STA è¿”å›å…³è”å“åº”</li></ul><p>è‡³æ­¤ï¼Œæ¥å…¥è¿‡ç¨‹æ‰å®Œæˆï¼ŒSTA åˆå§‹åŒ–å®Œæ¯•ï¼Œå¯ä»¥å¼€å§‹å‘ AP ä¼ é€æ•°æ®å¸§ã€‚</p><h2 id="è®¤è¯å’Œå…³è”è¿‡ç¨‹">è®¤è¯å’Œå…³è”è¿‡ç¨‹</h2><p>...</p><h2 id="æ¼«æ¸¸è¿‡ç¨‹">æ¼«æ¸¸è¿‡ç¨‹</h2><p>...</p><h1 id="ç›¸å…³å‘½ä»¤">ç›¸å…³å‘½ä»¤</h1><ul><li><strong>swconfig</strong></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swconfig list</span><br><span class="line">swconfig dev switch0 show | grep <span class="built_in">link</span></span><br></pre></td></tr></tbody></table></figure><ul><li><strong>iwpriv å‘½ä»¤</strong></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iwpriv ra0 get_mac_table æŸ¥çœ‹è¿æ¥ç”¨æˆ·</span><br><span class="line"></span><br><span class="line">è®¾ç½®ç™½åå•ï¼š</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> AccessPolicy=1</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> ACLAddEntry=<span class="string">"64:a2:f9:25:4e:32"</span> è¯¥ç”¨æˆ·è¢«åŠ å…¥ç™½åå•</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> ACLShowAll=1</span><br><span class="line">è®¾ç½®ä¸ºé»‘åå•</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> AccessPolicy=2  ä¹‹å‰çš„ç™½åå•ç”¨æˆ·ä¼šå˜ä¸ºé»‘åå•ç”¨æˆ·</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> ACLShowAll=1</span><br><span class="line">æ¸…é™¤åˆ—è¡¨</span><br><span class="line">iwpriv ra0 <span class="built_in">set</span> ACLClearAll=1</span><br></pre></td></tr></tbody></table></figure><ul><li><strong>vnstat</strong></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnstat -l æŸ¥çœ‹æµé‡</span><br></pre></td></tr></tbody></table></figure><h1 id="dns">dns</h1><h2 id="resolv.conf.auto">resolv.conf.auto</h2><p>æ¥æºï¼šç”± netifd ç”Ÿæˆï¼Œ netifd åœ¨æ¯æ¬¡ wan å£ up äº‹ä»¶æ—¶ï¼Œé‡å†™è¯¥æ–‡ä»¶ã€‚ ä½œç”¨ï¼šå½“ wan å£æœ‰åŒ…è¯·æ±‚ dns æ—¶ï¼Œ foward åˆ°è¯¥åœ°å€ä¸Šï¼Œä»è¯¥å¤„è·å– dnsã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‹è½¼</title>
      <link href="/2019/Literature/SuShi/"/>
      <url>/2019/Literature/SuShi/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸´æ±Ÿä»™">ä¸´æ±Ÿä»™</h1><p>å¤œé¥®ä¸œå¡é†’å¤é†‰ï¼Œå½’æ¥ä»¿ä½›ä¸‰æ›´ã€‚å®¶ç«¥é¼»æ¯å·²é›·é¸£ã€‚æ•²é—¨éƒ½ä¸åº”ï¼Œå€šæ–å¬æ±Ÿå£°ã€‚</p><p>é•¿æ¨æ­¤èº«éæˆ‘æœ‰ï¼Œä½•æ—¶å¿˜å´è¥è¥ï¼Ÿå¤œé˜‘é£é™ç¸ çº¹å¹³ã€‚å°èˆŸä»æ­¤é€ï¼Œæ±Ÿæµ·å¯„ä½™ç”Ÿã€‚</p><span id="more"></span><h1 id="è¥¿æ±Ÿæœˆä¸–äº‹ä¸€åœºå¤§æ¢¦">è¥¿æ±ŸæœˆÂ·ä¸–äº‹ä¸€åœºå¤§æ¢¦</h1><p>ä¸–äº‹ä¸€åœºå¤§æ¢¦ï¼Œäººç”Ÿå‡ åº¦ç§‹å‡‰ï¼Ÿå¤œæ¥é£å¶å·²é¸£å»Šã€‚çœ‹å–çœ‰å¤´é¬“ä¸Šã€‚</p><p>é…’è´±å¸¸æ„å®¢å°‘ï¼Œæœˆæ˜å¤šè¢«äº‘å¦¨ã€‚ä¸­ç§‹è°ä¸å…±å­¤å…‰ã€‚æŠŠç›å‡„ç„¶åŒ—æœ›ã€‚</p><h1 id="æ±ŸåŸå­ä¹™å¯æ­£æœˆäºŒåæ—¥å¤œè®°æ¢¦">æ±ŸåŸå­Â·ä¹™å¯æ­£æœˆäºŒåæ—¥å¤œè®°æ¢¦</h1><p>åå¹´ç”Ÿæ­»ä¸¤èŒ«èŒ«ï¼Œä¸æ€é‡ï¼Œè‡ªéš¾å¿˜ã€‚</p><p>åƒé‡Œå­¤åŸï¼Œæ— å¤„è¯å‡„å‡‰ã€‚</p><p>çºµä½¿ç›¸é€¢åº”ä¸è¯†ï¼Œå°˜æ»¡é¢ï¼Œé¬“å¦‚éœœã€‚</p><p>å¤œæ¥å¹½æ¢¦å¿½è¿˜ä¹¡ï¼Œå°è½©çª—ï¼Œæ­£æ¢³å¦†ã€‚</p><p>ç›¸é¡¾æ— è¨€ï¼ŒæƒŸæœ‰æ³ªåƒè¡Œã€‚</p><p>æ–™å¾—å¹´å¹´è‚ æ–­å¤„ï¼Œæ˜æœˆå¤œï¼ŒçŸ­æ¾å†ˆã€‚</p><h1 id="å¿µå¥´å¨‡èµ¤å£æ€€å¤">å¿µå¥´å¨‡Â·èµ¤å£æ€€å¤</h1><p>å¤§æ±Ÿä¸œå»ï¼Œæµªæ·˜å°½ï¼Œåƒå¤é£æµäººç‰©ã€‚</p><p>æ•…å’è¥¿è¾¹ï¼Œäººé“æ˜¯ï¼Œä¸‰å›½å‘¨éƒèµ¤å£ã€‚</p><p>ä¹±çŸ³ç©¿ç©ºï¼ŒæƒŠæ¶›æ‹å²¸ï¼Œå·èµ·åƒå †é›ªã€‚</p><p>æ±Ÿå±±å¦‚ç”»ï¼Œä¸€æ—¶å¤šå°‘è±ªæ°ã€‚</p><p>é¥æƒ³å…¬ç‘¾å½“å¹´ï¼Œå°ä¹”åˆå«äº†ï¼Œé›„å§¿è‹±å‘ã€‚</p><p>ç¾½æ‰‡çº¶å·¾ï¼Œè°ˆç¬‘é—´ï¼Œæ¨¯æ©¹ç°é£çƒŸç­ã€‚</p><p>æ•…å›½ç¥æ¸¸ï¼Œå¤šæƒ…åº”ç¬‘æˆ‘ï¼Œæ—©ç”Ÿåå‘ã€‚</p><p>äººç”Ÿå¦‚æ¢¦ï¼Œä¸€å°Šè¿˜é…¹æ±Ÿæœˆã€‚</p><h1 id="æ°´é¾™åŸæ¬¡éŸµç« è´¨å¤«æ¨èŠ±è¯">æ°´é¾™åŸÂ·æ¬¡éŸµç« è´¨å¤«æ¨èŠ±è¯</h1><p>ä¼¼èŠ±è¿˜ä¼¼éèŠ±ï¼Œä¹Ÿæ— äººæƒœä»æ•™å ã€‚æŠ›å®¶å‚è·¯ï¼Œæ€é‡å´æ˜¯ï¼Œæ— æƒ…æœ‰æ€ã€‚è¦æŸæŸ”è‚ ï¼Œå›°é…£å¨‡çœ¼ï¼Œæ¬²å¼€è¿˜é—­ã€‚æ¢¦éšé£ä¸‡é‡Œï¼Œå¯»éƒå»å¤„ï¼Œåˆè¿˜è¢«ã€èºå‘¼èµ·ã€‚</p><p>ä¸æ¨æ­¤èŠ±é£å°½ï¼Œæ¨è¥¿å›­ã€è½çº¢éš¾ç¼€ã€‚æ™“æ¥é›¨è¿‡ï¼Œé—è¸ªä½•åœ¨ï¼Ÿä¸€æ± èç¢ã€‚æ˜¥è‰²ä¸‰åˆ†ï¼ŒäºŒåˆ†å°˜åœŸï¼Œä¸€åˆ†æµæ°´ã€‚ç»†çœ‹æ¥ï¼Œä¸æ˜¯æ¨èŠ±ï¼Œç‚¹ç‚¹æ˜¯ç¦»äººæ³ªã€‚</p><h1 id="æ°´è°ƒæ­Œå¤´æ˜æœˆå‡ æ—¶æœ‰">æ°´è°ƒæ­Œå¤´Â·æ˜æœˆå‡ æ—¶æœ‰</h1><p>ä¸™è¾°ä¸­ç§‹ï¼Œæ¬¢é¥®è¾¾æ—¦ï¼Œå¤§é†‰ï¼Œä½œæ­¤ç¯‡ï¼Œå…¼æ€€å­ç”±ã€‚</p><p>æ˜æœˆå‡ æ—¶æœ‰ï¼ŸæŠŠé…’é—®é’å¤©ã€‚ä¸çŸ¥å¤©ä¸Šå®«é˜™ï¼Œä»Šå¤•æ˜¯ä½•å¹´ã€‚æˆ‘æ¬²ä¹˜é£å½’å»ï¼Œåˆæç¼æ¥¼ç‰å®‡ï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚èµ·èˆå¼„æ¸…å½±ï¼Œä½•ä¼¼åœ¨äººé—´ï¼Ÿ</p><p>è½¬æœ±é˜ï¼Œä½ç»®æˆ·ï¼Œç…§æ— çœ ã€‚ä¸åº”æœ‰æ¨ï¼Œä½•äº‹é•¿å‘åˆ«æ—¶åœ†ï¼Ÿäººæœ‰æ‚²æ¬¢ç¦»åˆï¼Œæœˆæœ‰é˜´æ™´åœ†ç¼ºï¼Œæ­¤äº‹å¤éš¾å…¨ã€‚ä½†æ„¿äººé•¿ä¹…ï¼Œåƒé‡Œå…±å©µå¨Ÿã€‚</p><h1 id="è¶æ‹èŠ±æ˜¥æ™¯">è¶æ‹èŠ±Â·æ˜¥æ™¯</h1><p>èŠ±è¤ªæ®‹çº¢é’æå°ã€‚ç‡•å­é£æ—¶ï¼Œç»¿æ°´äººå®¶ç»•ã€‚æä¸ŠæŸ³ç»µå¹åˆå°‘ã€‚å¤©æ¶¯ä½•å¤„æ— èŠ³è‰ï¼</p><p>å¢™é‡Œç§‹åƒå¢™å¤–é“ã€‚å¢™å¤–è¡Œäººï¼Œå¢™é‡Œä½³äººç¬‘ã€‚ç¬‘æ¸ä¸é—»å£°æ¸æ‚„ã€‚å¤šæƒ…å´è¢«æ— æƒ…æ¼ã€‚</p><h1 id="å®šé£æ³¢è«å¬ç©¿æ—æ‰“å¶å£°">å®šé£æ³¢Â·è«å¬ç©¿æ—æ‰“å¶å£°</h1><p>ä¸‰æœˆä¸ƒæ—¥ï¼Œæ²™æ¹–é“ä¸­é‡é›¨ã€‚é›¨å…·å…ˆå»ï¼ŒåŒè¡Œçš†ç‹¼ç‹ˆï¼Œä½™ç‹¬ä¸è§‰ï¼Œå·²è€Œé‚æ™´ï¼Œæ•…ä½œæ­¤è¯ã€‚</p><p>è«å¬ç©¿æ—æ‰“å¶å£°ï¼Œä½•å¦¨åŸå•¸ä¸”å¾è¡Œã€‚ç«¹æ–èŠ’é‹è½»èƒœé©¬ï¼Œè°æ€•ï¼Ÿä¸€è“‘çƒŸé›¨ä»»å¹³ç”Ÿã€‚</p><p>æ–™å³­æ˜¥é£å¹é…’é†’ï¼Œå¾®å†·ï¼Œå±±å¤´æ–œç…§å´ç›¸è¿ã€‚å›é¦–å‘æ¥è§ç‘Ÿå¤„ï¼Œå½’å»ï¼Œä¹Ÿæ— é£é›¨ä¹Ÿæ— æ™´ã€‚</p><h1 id="æ±ŸåŸå­å¯†å·å‡ºçŒ">æ±ŸåŸå­Â·å¯†å·å‡ºçŒ</h1><p>è€å¤«èŠå‘å°‘å¹´ç‹‚ï¼Œå·¦ç‰µé»„ï¼Œå³æ“è‹ï¼Œé”¦å¸½è²‚è£˜ï¼Œåƒéª‘å·å¹³å†ˆã€‚ä¸ºæŠ¥å€¾åŸéšå¤ªå®ˆï¼Œäº²å°„è™ï¼Œçœ‹å­™éƒã€‚</p><p>é…’é…£èƒ¸èƒ†å°šå¼€å¼ ï¼Œé¬“å¾®éœœï¼Œåˆä½•å¦¨ï¼æŒèŠ‚äº‘ä¸­ï¼Œä½•æ—¥é£å†¯å”ï¼Ÿä¼šæŒ½é›•å¼“å¦‚æ»¡æœˆï¼Œè¥¿åŒ—æœ›ï¼Œå°„å¤©ç‹¼ã€‚</p><h1 id="æ°¸é‡ä¹å½­åŸå¤œå®¿ç‡•å­æ¥¼">æ°¸é‡ä¹Â·å½­åŸå¤œå®¿ç‡•å­æ¥¼</h1><p>å½­åŸå¤œå®¿ç‡•å­æ¥¼ï¼Œæ¢¦ç›¼ç›¼ï¼Œå› ä½œæ­¤è¯ã€‚</p><p>æ˜æœˆå¦‚éœœï¼Œå¥½é£å¦‚æ°´ï¼Œæ¸…æ™¯æ— é™ã€‚æ›²æ¸¯è·³é±¼ï¼Œåœ†è·æ³»éœ²ï¼Œå¯‚å¯æ— äººè§ã€‚ç´å¦‚ä¸‰é¼“ï¼Œé“¿ç„¶ä¸€å¶ï¼Œé»¯é»¯æ¢¦äº‘æƒŠæ–­ã€‚å¤œèŒ«èŒ«ï¼Œé‡å¯»æ— å¤„ï¼Œè§‰æ¥å°å›­è¡Œéã€‚</p><p>å¤©æ¶¯å€¦å®¢ï¼Œå±±ä¸­å½’è·¯ï¼Œæœ›æ–­æ•…å›­å¿ƒçœ¼ã€‚ç‡•å­æ¥¼ç©ºï¼Œä½³äººä½•åœ¨ï¼Œç©ºé”æ¥¼ä¸­ç‡•ã€‚å¤ä»Šå¦‚æ¢¦ï¼Œä½•æ›¾æ¢¦è§‰ï¼Œä½†æœ‰æ—§æ¬¢æ–°æ€¨ã€‚å¼‚æ—¶å¯¹ï¼Œé»„æ¥¼å¤œæ™¯ï¼Œä¸ºä½™æµ©å¹ã€‚</p><h1 id="æµ£æºªæ²™æ¸¸è•²æ°´æ¸…æ³‰å¯º">æµ£æºªæ²™Â·æ¸¸è•²æ°´æ¸…æ³‰å¯º</h1><p>æ¸¸è•²æ°´æ¸…æ³‰å¯ºï¼Œå¯ºä¸´å…°æºªï¼Œæºªæ°´è¥¿æµã€‚</p><p>å±±ä¸‹å…°èŠ½çŸ­æµ¸æºªï¼Œæ¾é—´æ²™è·¯å‡€æ— æ³¥ï¼Œæ½‡æ½‡æš®é›¨å­è§„å•¼ã€‚</p><p>è°é“äººç”Ÿæ— å†å°‘ï¼Ÿé—¨å‰æµæ°´å°šèƒ½è¥¿ï¼ä¼‘å°†ç™½å‘å”±é»„é¸¡ã€‚</p><h1 id="åœç®—å­é»„å·å®šæ…§é™¢å¯“å±…ä½œ">åœç®—å­Â·é»„å·å®šæ…§é™¢å¯“å±…ä½œ</h1><p>ç¼ºæœˆæŒ‚ç–æ¡ï¼Œæ¼æ–­äººåˆé™ã€‚æ—¶è§å¹½äººç‹¬å¾€æ¥ï¼Œç¼¥ç¼ˆå­¤é¸¿å½±ã€‚</p><p>æƒŠèµ·å´å›å¤´ï¼Œæœ‰æ¨æ— äººçœã€‚æ‹£å°½å¯’æä¸è‚¯æ –ï¼Œå¯‚å¯æ²™æ´²å†·ã€‚</p><h1 id="å®šé£æ³¢å—æµ·å½’èµ ç‹å®šå›½ä¾äººå¯“å¨˜">å®šé£æ³¢Â·å—æµ·å½’èµ ç‹å®šå›½ä¾äººå¯“å¨˜</h1><p>å¸¸ç¾¡äººé—´ç¢ç‰éƒï¼Œå¤©åº”ä¹ä¸ç‚¹é…¥å¨˜ã€‚å°½é“æ¸…æ­Œä¼ çš“é½¿ï¼Œé£èµ·ï¼Œé›ªé£ç‚æµ·å˜æ¸…å‡‰ã€‚</p><p>ä¸‡é‡Œå½’æ¥é¢œæ„ˆå°‘ï¼Œå¾®ç¬‘ï¼Œç¬‘æ—¶çŠ¹å¸¦å²­æ¢…é¦™ã€‚è¯•é—®å²­å—åº”ä¸å¥½ï¼Œå´é“ï¼šæ­¤å¿ƒå®‰å¤„æ˜¯å¾ä¹¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å¯åŠ¨ä¼˜åŒ–</title>
      <link href="/2019/Debug/LinuxSystemStartOptimization/"/>
      <url>/2019/Debug/LinuxSystemStartOptimization/</url>
      
        <content type="html"><![CDATA[<h1 id="å¯åŠ¨æµç¨‹">å¯åŠ¨æµç¨‹</h1><p>Linux ç³»ç»Ÿå½“å‰çš„å¯åŠ¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brom --&gt; boot0 --&gt; (monitor/secure os) --&gt; uboot --&gt; rootfs --&gt; app</span><br></pre></td></tr></tbody></table></figure><p>brom å›ºåŒ–åœ¨ IC å†…éƒ¨ï¼ŒèŠ¯ç‰‡å‡ºå‚åå°±æ— æ³•æ›´æ”¹ã€‚åç»­å°†ä» boot0 å¼€å§‹åˆ†é˜¶æ®µä»‹ç»å¯åŠ¨ä¼˜åŒ–çš„æ–¹æ³•ã€‚</p><p>å¯¹äºæŸäº›æ–¹æ¡ˆï¼Œä¼šå­˜åœ¨ monitor æˆ– secure osï¼Œè¿™ä¸¤è€…è€—æ—¶å¾ˆçŸ­ï¼Œç•¥è¿‡ã€‚</p><span id="more"></span><p>ä¸‹æ–‡æ¶‰åŠåˆ°ä¸€äº›é…ç½®æ–‡ä»¶ï¼Œæå‰åœ¨æ­¤è¯´æ˜ã€‚</p><p>env é…ç½®æ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sdk/device/config/chips/&lt;chip&gt;/configs/&lt;board&gt;/linux/env-&lt;kernel-version&gt;.cfg <span class="comment">#ä¼˜å…ˆçº§é«˜</span></span><br><span class="line">sdk/device/config/chips/&lt;chip&gt;/configs/default/env.cfg <span class="comment">#ä¼˜å…ˆçº§ä½</span></span><br><span class="line">sdk/target/allwinner/&lt;board&gt;/configs/env-&lt;kernel-version&gt;.cfg <span class="comment">#æ—§ SDK</span></span><br></pre></td></tr></tbody></table></figure><p>sys_config.fex è·¯å¾„ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdk/device/config/chips/&lt;chip&gt;/configs/&lt;board&gt;/sys_config.fex <span class="comment">#æ–° SDK</span></span><br><span class="line">sdk/target/allwinner/&lt;board&gt;/configs/sys_config.fex <span class="comment">#æ—§ SDK</span></span><br></pre></td></tr></tbody></table></figure><h1 id="æµ‹é‡æ–¹æ³•">æµ‹é‡æ–¹æ³•</h1><h2 id="printk-time">printk time</h2><p>æ‰“å¼€ kernel é…ç½®ï¼Œä½¿èƒ½å¦‚ä¸‹é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel hacking ---&gt;</span><br><span class="line">    [*] Show timing information on printks</span><br></pre></td></tr></tbody></table></figure><p>å°†ä¼šåœ¨å†…æ ¸çš„ log å‰åŠ å…¥æ—¶é—´æˆ³ã€‚</p><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•ä¸»è¦ç”¨æ¥æµ‹é‡å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­å„ä¸ªé˜¶æ®µçš„è€—æ—¶ã€‚</p><h2 id="initcall_debug">initcall_debug</h2><p>ä¿®æ”¹ env æ–‡ä»¶ï¼Œåœ¨ kernel çš„ cmdline ä¸­åŠ å…¥å‚æ•°ï¼Œ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ  initcall_debug å˜é‡</span></span><br><span class="line">initcall_debug=1</span><br><span class="line"><span class="comment"># å°† initcall_debug=${initcall_debug} åŠ å…¥ setargs_xxx ä¸­ï¼Œå¦‚ setargs_nandï¼Œ setargs_mmcï¼Œ</span></span><br><span class="line">setargs_norï¼Œ setatgs_nand_ubi ç­‰ï¼Œ</span><br><span class="line">setargs_nand=setenv bootargs console=<span class="variable">${console}</span> earlyprintk=<span class="variable">${earlyprintk}</span> root=<span class="variable">${nand_root</span></span><br><span class="line"><span class="variable">}</span> initcall_debug=<span class="variable">${initcall_debug}</span> init=<span class="variable">${init}</span></span><br></pre></td></tr></tbody></table></figure><p>å¼€å¯ä¹‹åï¼Œå¯åŠ¨ä¸­ä¼šæ‰“å°æ¯ä¸ª initcall å‡½æ•°è°ƒç”¨åŠå…¶è€—æ—¶ã€‚</p><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•ä¸»è¦ç”¨æ¥æµ‹é‡å†…æ ¸ initcall çš„è€—æ—¶ã€‚</p><p>ä¸€èˆ¬éœ€åŒæ—¶é…ç½®ä¸Šå†…æ ¸ç¬¦å·è¡¨ï¼Œå³ kallsyms é€‰é¡¹ï¼Œä»¥æ‰“å°å‡½æ•°åã€‚</p><h2 id="bootgraph">bootgraph</h2><p>åœ¨å†…æ ¸æºç ä¸­è‡ªå¸¦äº†ä¸€ä¸ªå·¥å…· (scripts/bootgraph.pl) å¯ç”¨äºåˆ†æå¯åŠ¨æ—¶é—´ã€‚</p><ul><li>kernel ç¼–è¯‘æ—¶éœ€è¦åŒ…å« CONFIG_PRINTK_TIME é€‰é¡¹</li><li>åœ¨ kernel cmdline åŠ ä¸Š"initcall_debug=1"</li><li>åœ¨ç³»ç»Ÿå¯åŠ¨å®Œæ¯•åæ‰§è¡Œ"dmesg | perl $(Kernel_DIR)/scripts/bootgraph.pl &gt; output.svg"</li><li>ä½¿ç”¨ SVG æµè§ˆå™¨ï¼ˆæ¯”å¦‚ Inkscapeï¼Œ Gimpï¼Œ Firefox ç­‰ï¼‰æ¥æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶ output.svg</li></ul><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•ä¸»è¦ç”¨æ¥æµ‹é‡å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­å„ä¸ªé˜¶æ®µçš„è€—æ—¶ã€‚</p><h2 id="bootchart">bootchart</h2><p>bootchart æ˜¯ä¸€ä¸ªç”¨äº linux å¯åŠ¨è¿‡ç¨‹æ€§èƒ½åˆ†æçš„å¼€æºè½¯ä»¶å·¥å…·ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹è‡ªåŠ¨æ”¶é›† CPU å ç”¨ç‡ã€è¿›ç¨‹ç­‰ä¿¡æ¯ï¼Œå¹¶ä»¥å›¾å½¢æ–¹å¼æ˜¾ç¤ºåˆ†æç»“æœï¼Œå¯ç”¨ä½œæŒ‡å¯¼ä¼˜åŒ–ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹</p><ul><li>ä¿®æ”¹ kernel cmdlineã€‚ä¿®æ”¹ env é…ç½®æ–‡ä»¶ ï¼ˆè·¯å¾„è§ä¸Šæ–‡è¯´æ˜ï¼‰ï¼Œå°†å…¶ä¸­çš„ init ä¿®æ”¹ä¸º"init=/sbin/bootchartdâ€</li><li>æ”¶é›†ä¿¡æ¯ã€‚ bootchartd ä¼šä»/proc/statï¼Œ /proc/diskstatï¼Œ /proc/[pid]/stat ä¸­é‡‡é›†ä¿¡æ¯ï¼Œç»è¿‡å¤„ç†åä¿å­˜ä¸º bootchart.tgz æ–‡ä»¶</li><li>è½¬æ¢å›¾ç‰‡ã€‚åœ¨ PC ä¸Šé€šè¿‡ pybootchartgui.py å·¥å…·å°† bootchart.tgz è½¬æ¢ä¸º bootchart.pngï¼Œæ–¹ä¾¿åˆ†æ</li></ul><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•ä¸»è¦ç”¨æ¥æµ‹é‡æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåˆ°ä¸»åº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹ä¸­çš„è€—æ—¶ã€‚</p><h2 id="gpio-ç¤ºæ³¢å™¨">gpio + ç¤ºæ³¢å™¨</h2><p>åœ¨é€‚å½“çš„åœ°æ–¹åŠ å…¥æ“ä½œ gpio çš„ä»£ç ï¼Œé€šè¿‡ç¤ºæ³¢å™¨æŠ“å–æ³¢å½¢å¾—åˆ°å„é˜¶æ®µè€—æ—¶ã€‚</p><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•å¯ç”¨æ¥æµ‹é‡æ•´ä¸ªå¯åŠ¨ä¸­å„é˜¶æ®µçš„è€—æ—¶ã€‚</p><h2 id="grabserial">grabserial</h2><p>Grabserial æ˜¯ Tim Bird ç”¨ python å†™çš„ä¸€ä¸ªæŠ“å–ä¸²å£çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½å¤Ÿä¸ºæ”¶åˆ°çš„æ¯ä¸€è¡Œä¿¡æ¯æ·»åŠ ä¸Šæ—¶é—´æˆ³ã€‚å¯ä»å¦‚ä¸‹è·¯å¾„ä¸‹è½½ä½¿ç”¨ï¼š <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RiaXJkMjBkL2dyYWJzZXJpYWw=">https://github.com/tbird20d/grabserial<i class="fa fa-external-link-alt"></i></span></p><p>ä»‹ç»æ–‡æ¡£ï¼š <span class="exturl" data-url="aHR0cDovL2VsaW51eC5vcmcvR3JhYnNlcmlhbA==">http://elinux.org/Grabserial<i class="fa fa-external-link-alt"></i></span></p><p>å¸¸è§çš„ç”¨æ³•ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grabserial -v -S -d /dev/ttyUSB0 -e 30 -t</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœè¦åœ¨æŸä¸ªå­—ç¬¦ä¸²é‡ç½®æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨-m å‚æ•°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grabserial -v -S -d /dev/ttyUSB0 -e 30 -t -m <span class="string">"Starting kernel"</span></span><br></pre></td></tr></tbody></table></figure><ul><li>-v æ˜¾ç¤ºå‚æ•°ç­‰ä¿¡æ¯</li><li>-s è·³è¿‡å¯¹ä¸²å£çš„æ£€æŸ¥</li><li>-d æŒ‡å®šä¸²å£ï¼Œå¦‚ä¸Šè¿°ä¸ºæŒ‡å®š /dev/ttyUSB0 ä¸ºæ“ä½œçš„ä¸²å£</li><li>-e å‚æ•°æŒ‡å®šæ—¶é—´ï¼Œå¦‚ä¸Šè¿°å‘½ä»¤è¡¨ç¤ºæŠ“å– 30s çš„ä¸²å£è®°å½•</li><li>-t è¡¨ç¤ºåŠ ä¸Šæ—¶é—´æˆ³</li><li>-m åŒ¹é…åˆ°æŒ‡å®šå­—ç¬¦ä¸²å°±é‡ç½®æ—¶é—´æˆ³çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ä» 0 å¼€å§‹</li></ul><p>æ›´å¤šé…ç½®å¯ä»¥ä½¿ç”¨ -h å‚æ•°æŸ¥çœ‹å¸®åŠ©ã€‚</p><p>ğŸ’¡ æ³¨ï¼šæ­¤æ–¹æ³•å¯ç”¨æ¥æµ‹é‡æ•´ä¸ªå¯åŠ¨ä¸­å„é˜¶æ®µçš„è€—æ—¶ã€‚</p><h1 id="ä¼˜åŒ–æ–¹æ³•">ä¼˜åŒ–æ–¹æ³•</h1><p>ğŸ’¡ æ³¨ï¼šæœ¬èŠ‚æä¾›ä¸€äº›ä¼˜åŒ–æ–¹æ³•ä»¥ä¾›å‚è€ƒï¼Œå¹¶éæ‰€æœ‰éƒ½åœ¨ sdk ä¸Šé›†æˆï¼Œä¸»è¦åŸå› æœ‰ï¼š</p><ul><li>ä¼˜åŒ–æ²¡æœ‰æ­¢å¢ƒã€‚éœ€è¦æ ¹æ®ç›®æ ‡æ¥é€‰æ‹©ä¼˜åŒ–æ–¹æ³•ï¼Œç»¼åˆè€ƒè™‘ä¼˜åŒ–æ•ˆæœä¸ä¼˜åŒ–éš¾åº¦</li><li>ä¼˜åŒ–éœ€è¦å…·æœ‰é’ˆå¯¹æ€§ã€‚ç”±äºå„æ–¹æ¡ˆ CPU ä¸ªæ•°åŠé¢‘ç‡ã€ flash ç±»å‹åŠå¤§å°ã€ kernel/rootfs å‹ç¼©ç±»å‹ä¸å°ºå¯¸ã€æ‰€éœ€åŠŸèƒ½ã€ä¸»åº”ç”¨ç­‰çš„ä¸åŒï¼Œéœ€è¦é’ˆå¯¹æ€§çš„è¿›è¡Œä¼˜åŒ–</li></ul><h2 id="boot0-å¯åŠ¨ä¼˜åŒ–">boot0 å¯åŠ¨ä¼˜åŒ–</h2><p>boot0 è¿è¡Œåœ¨ SRAMï¼Œä¸»è¦åŠŸèƒ½æ˜¯å¯¹ DRAM è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶å°† uboot åŠ è½½è‡³ DRAMã€‚ å¯¹äºå®‰å…¨æ–¹æ¡ˆæ¥è¯´ï¼Œ boot0 è¿˜ä¼šå¯¹ ubootã€ monitorã€ secure-os ç­‰è¿›è¡Œç­¾åæ ¡éªŒã€‚</p><p>boot0 å¯ä¼˜åŒ–çš„åœ°æ–¹ä¸å¤šï¼Œå¯ä»¥åšçš„æ˜¯ï¼š</p><ul><li>å…³é—­ä¸²å£è¾“å‡ºã€‚</li><li>å‡å°‘æ£€æµ‹æŒ‰é”®å’Œæ£€æµ‹ä¸²å£çš„ç­‰å¾…æ—¶é—´ã€‚</li><li>åŠ è½½ uboot çš„æ—¶å€™ï¼Œä¸è¦å…ˆåŠ è½½åæ¬è¿ï¼Œç›´æ¥åŠ è½½åˆ° uboot çš„è¿è¡Œåœ°å€</li></ul><p>å¯¹äº spinor çš„æ–¹æ¡ˆï¼Œè¿˜å¯ä»¥ç›´æ¥ä» boot0 å¯åŠ¨ï¼Œåªéœ€è¦åœ¨ boot0 ä¸­åŠ è½½å¥½ kernel å’Œ dtbï¼Œä¸éœ€è¦ç»è¿‡ uboot ï¼Œç„¶åç›´æ¥è·³è½¬åˆ° kernel è¿è¡Œï¼Œå¯èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚å¦‚æœé‡‡ç”¨ boot0 å¯åŠ¨ OSï¼Œåˆ™ boot0 è¯»å–æ•°æ®é‡è¾ƒå¤§ï¼Œå…¶ flash é©±åŠ¨ä¹Ÿéœ€è¦è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æé«˜æ—¶é’Ÿï¼Œå¼€å¯åŒçº¿/å››çº¿/DMA/Cache ç­‰ã€‚</p><h2 id="uboot-å¯åŠ¨ä¼˜åŒ–">uboot å¯åŠ¨ä¼˜åŒ–</h2><p>uboot ä¸»è¦åŠŸèƒ½æ˜¯å¼•å¯¼å†…æ ¸ã€é‡äº§å‡çº§ã€ç”µæºç®¡ç†ã€å¼€æœºéŸ³ä¹/logoã€ fastboot åˆ·æœºç­‰ã€‚</p><ul><li><p>å®Œå…¨å»æ‰ ubootï¼š<br>uboot çš„åŒ…å«å¾ˆå¤šé‡è¦åŠŸèƒ½ï¼Œé€šå¸¸ä¼šä¿ç•™ã€‚æŸäº›æƒ…å†µå¯ä»¥å»æ‰ï¼Œç›´æ¥ä» boot0 åŠ è½½å†…æ ¸å¹¶å¯åŠ¨ï¼Œå¯èŠ‚çœä¸€äº›æ—¶é—´</p></li><li><p>é¿å… burnkey çš„å½±å“ï¼š<br>å¯¹äºå¯ç”¨äº† burnkey æ”¯æŒï¼Œä¸”è¿˜æ²¡ä½¿ç”¨ DragonSN å·¥å…·å°† key çƒ§å½•è¿›å»çš„æ¿å­ï¼Œæ¯æ¬¡å¯åŠ¨åˆ° uboot éƒ½ä¼šå°è¯•è·Ÿ PC ç«¯å·¥å…·äº¤äº’äº§ç”Ÿå¦‚ä¸‹ logï¼Œå¸¦æ¥å»¶æ—¶</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[1.334]usb burn from boot</span><br><span class="line">...</span><br><span class="line">[1.400]usb prepare ok</span><br><span class="line">usb sof ok</span><br><span class="line">[1.662]usb probe ok</span><br><span class="line">[1.664]usb setup ok</span><br><span class="line">...</span><br><span class="line">[4.698]do_burn_from_boot usb : have no handshake</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœäº§å“ä¸éœ€è¦ burnkeyï¼Œå¯å°† sys_config.fex ä¸­çš„ [target] ä¸‹ burn_key è®¾ç½®ä¸º 0ã€‚</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[target]</span><br><span class="line">burn_key = 0</span><br></pre></td></tr></tbody></table></figure><p></p><p>æˆ–è€…ä½¿ç”¨ DragonSN å·¥å…·ï¼Œçƒ§å½•ä¸€æ¬¡ keyï¼Œå¹¶è®¾ç½®çƒ§å½•æ ‡å¿—ï¼Œä»¥ä½¿åç»­å¯åŠ¨å¯è·³è¿‡æ£€æµ‹ã€‚</p></li><li><p>æé«˜ CPU ä»¥åŠ flash è¯»å–é¢‘ç‡ï¼š<br>å¯è®¾ç½® sys_config.fex ä¸­çš„ [target] ä¸‹ boot_clock æ¥ä¿®æ”¹ uboot è¿è¡Œæ—¶ CPU é¢‘ç‡ ï¼ˆæ³¨ï¼šä¸èƒ½è¶…è¿‡ SPEC æœ€å¤§é¢‘ç‡ï¼‰</p><p>å¯¹äº spinor/spinandï¼Œä½¿ç”¨è¾ƒé«˜çš„æ—¶é’Ÿé¢‘ç‡ï¼ˆä¸€èˆ¬æ˜¯ 100Mï¼‰ï¼Œä½¿ç”¨å››çº¿æ¨¡å¼æˆ–è€…åŒçº¿æ¨¡å¼ï¼ˆçœ‹ç¡¬ä»¶æ˜¯å¦æ”¯æŒï¼‰ï¼Œæé«˜åŠ è½½é€Ÿåº¦</p></li><li><p>å…³é—­ä¸²å£è¾“å‡º<br>å¯å°† sys_config.fex ä¸­çš„ [platform] ä¸‹ debug_mode è®¾ç½®ä¸º 0 æ¥å…³é—­ uboot å’Œ boot0 ä¸²å£è¾“å‡ºã€‚</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[platform]</span><br><span class="line">debug_mode = 0</span><br></pre></td></tr></tbody></table></figure><p></p><p>é…ç½®æ­¤é¡¹åï¼Œå¦‚æœè¿˜æœ‰å°‘é‡è¾“å‡ºï¼Œæœ‰ä¸¤ä¸ªå¯èƒ½çš„åŸå› ï¼š</p><ul><li>ç¬¬ä¸€æ˜¯è¿™äº›è¾“å‡ºæ˜¯åœ¨è¯»å– sys_config.fex ç¦æ­¢ä¸²å£è¾“å‡ºæµç¨‹ä¹‹å‰äº§ç”Ÿ</li><li>ç¬¬äºŒæ˜¯å› ä¸ºæºç ä¸­ç›´æ¥ä½¿ç”¨äº† puts è€Œæ²¡æœ‰ä½¿ç”¨ printf</li></ul><p>å¯¹äºè¿™ä¸¤è€…æƒ…å†µï¼Œéœ€è¦ä¿®æ”¹æºç æ¥å®Œå…¨å…³é—­ä¸²å£è¾“å‡ºã€‚</p></li><li><p>ä¿®æ”¹ kernel åŠ è½½ä½ç½®ï¼š<br>å¦‚æœ uboot å°†å†…æ ¸åŠ è½½åˆ° DRAM çš„åœ°å€ä¸å†…æ ¸ä¸­ load address ä¸åŒ¹é…ï¼Œå°±éœ€è¦å°†å†…æ ¸ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ï¼Œè¿™æ ·ä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´ã€‚å› æ­¤ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ uboot åŠ è½½å†…æ ¸ä¸ºæ­£ç¡®çš„åœ°å€ã€‚å…·ä½“æ˜¯ä¿®æ”¹ env æ–‡ä»¶ ï¼ˆè·¯å¾„è§ä¸Šæ–‡ï¼‰ çš„ boot_normal ä¸ boot_recovery å˜é‡ã€‚éœ€è¦æ ¹æ®ä¸åŒçš„å†…æ ¸é•œåƒæ ¼å¼æ¥è®¾ç½®ä¸åŒçš„å€¼ã€‚</p><p>å‡è®¾ kernel çš„ load address ä¸º 0x40008000ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ uImageï¼Œä¹Ÿå°±æ˜¯åœ¨ kernel çš„é•œåƒå‰åŠ äº† 64 å­—èŠ‚ï¼Œæ‰€ä»¥ uboot åº”è¯¥å°† kernel åŠ è½½åˆ° 0x40008000 - 0x40 = 0x40007fc0ã€‚</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#uImage/raw</span></span><br><span class="line">boot_normal=sunxi_flash <span class="built_in">read</span> 40007fc0 <span class="variable">${boot_partition}</span>;bootm 40007fc0</span><br><span class="line">boot_recovery=sunxi_flash <span class="built_in">read</span> 40007fc0 recovery;bootm 40007fc0</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœä½¿ç”¨çš„æ˜¯ boot.imgï¼Œå³ android çš„ kernel æ ¼å¼ï¼Œå…¶å¤´éƒ¨å¤§å°ä¸º 0x800ï¼Œæ‰€ä»¥ uboot åº”è¯¥å°† kernel åŠ è½½ åˆ° 0x40008000 - 0x800 = 40007800ã€‚</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#boot.img/raw</span></span><br><span class="line">boot_normal=sunxi_flash <span class="built_in">read</span> 40007800 <span class="variable">${boot_partition}</span>;bootm 40007800</span><br><span class="line">boot_recovery=sunxi_flash <span class="built_in">read</span> 40007800 recovery;bootm 40007800</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœ uboot åŠ è½½ kernel åœ°å€ä¸ load address ä¸åŒ¹é…ï¼Œ uboot è¿‡ç¨‹ä¸­ä¸²å£è¾“å‡ºå¯èƒ½ä¼šæœ‰ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loading Kernel Image ... OK</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœæ˜¯åŒ¹é…çš„ï¼Œ uboot è¿‡ç¨‹ä¸­ä¸²å£è¾“å‡ºå¯èƒ½ä¼šæœ‰ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XIP Kernel Image ... OK</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>ä¿®æ”¹ kernel åŠ è½½å¤§å°ï¼š<br>æœ€æ–°ä»£ç ä¼šæ ¹æ® uImage/boot.img çš„å¤´éƒ¨ä¿¡æ¯ï¼Œåªè¯»å–å¿…è¦çš„å¤§å°ï¼Œå¯å¿½ç•¥æ­¤ä¼˜åŒ–é¡¹ã€‚ å¯¹äºæ—§ä»£ç ï¼Œ uboot åœ¨åŠ è½½å†…æ ¸çš„æ—¶å€™ï¼Œæœ‰äº›æƒ…å†µä¼šç›´æ¥å°†æ•´ä¸ªåˆ†åŒºè¯»å–å‡ºæ¥ã€‚</p><p>å°±æ˜¯è¯´å‡å¦‚å†…æ ¸åªæœ‰ 2Mï¼Œè€Œåˆ†åŒºåˆ†äº† 4M çš„è¯ï¼Œ uboot å°±ä¼šè¯»å– 4Mã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†åˆ†åŒºå¤§å°è®¾ç½®å¾—åˆšå¥½å®¹çº³ ä¸‹å†…æ ¸ï¼Œè¿™æ ·å¯é¿å… uboot åœ¨åŠ è½½å†…æ ¸çš„æ—¶å€™æµªè´¹æ—¶é—´ã€‚</p><p>å¯ä¿®æ”¹ sys_partition*.fex ä¸­ boot åˆ†åŒºçš„å¤§å°ã€‚ uboot å…·ä½“è¯»å‡ºå¤šå°‘ï¼Œé€šå¸¸ä¼šæœ‰ log ä¿¡æ¯ï¼Œå¯åŒçœŸæ­£å†…æ ¸é•œåƒçš„ size è¿›è¡Œæ¯”è¾ƒã€‚</p></li><li><p>å…³é—­ kernel æ ¡éªŒï¼š<br>uboot åŠ è½½äº†å†…æ ¸ä»¥åï¼Œé»˜è®¤ä¼šå¯¹å†…æ ¸è¿›è¡Œæ ¡éªŒï¼Œå¯ä»¥åœ¨ä¸²å£è¾“å‡ºä¸­çœ‹åˆ°ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Verifying Checksum ... OK</span><br></pre></td></tr></tbody></table></figure><p></p><p>å¦‚æœä¸æƒ³æ ¡éªŒå¯ä»¥å»æ‰ï¼Œç›®å‰çš„æƒ…å†µæ˜¯å¯ä»¥å‡å°‘å‡ åæ¯«ç§’ ï¼ˆä¸åŒå¹³å°ï¼Œä¸åŒå†…æ ¸å¤§å°ï¼Œæ—¶é—´ä¸åŒï¼‰çš„å¯åŠ¨æ—¶é—´ã€‚</p></li><li><p>uboot é‡å®šä½ï¼š<br>ç›®å‰çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ uboot åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè¿›è¡Œä¸€æ¬¡é‡å®šä½ï¼Œå¯ä»¥åœ¨ä¸²å£ä¸­æ‰“å°å‡ºè¿™ä¸ªå€¼ï¼Œç„¶åä¿®æ”¹ uboot çš„åŠ è½½åœ° å€ä½¿å¾— boot0 å°† uboot åŠ è½½è¿› DRAM çš„æ—¶å€™å°±ç›´æ¥åŠ è½½åˆ°è¿™ä¸ªåœ°å€ã€‚</p><p>ä¿®æ”¹æ–‡ä»¶ sdk/lichee/brandy<em>/u-boot</em>/include/configs/sun_iw_p*.h ä¸­çš„</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_SYS_TEXT_BASE (0x40900000)</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>ä½†è¿™ä¸ªæ–¹æ³•æœ‰ä¸ªå¼Šç«¯ï¼Œå¦‚æœåç»­ä¿®æ”¹äº† uboot çš„ä»£ç ï¼Œåˆ™å¯èƒ½éœ€è¦é‡æ–°è®¾ç½®ã€‚</p><p>ç›®å‰è¿™ä¸ªæ“ä½œè€—æ—¶å¾ˆå°‘ï¼ˆæŸå¹³å°æµ‹å¾—åå‡ æ¯«ç§’ï¼‰ï¼Œä¸å¿…è¦çš„è¯ä¸å»ºè®®åšè¿™ä¸ªä¿®æ”¹</p></li><li><p>è£å‰ª ubootï¼š<br>å³ä½¿æµç¨‹æ²¡æœ‰ç®€åŒ–ï¼Œ uboot ä½“ç§¯çš„å‡å°ä¹Ÿå¯å‡å°‘åŠ è½½ uboot çš„æ—¶é—´ã€‚ ä¾æ®å…·ä½“æƒ…å†µï¼Œå¯å¯¹ uboot ä¸éœ€è¦çš„åŠŸèƒ½çš„æ¨¡å—è¿›è¡Œè£å‰ªï¼Œé¿å…äº†å¯åŠ¨ä¸­æ‰§è¡Œä¸å¿…è¦çš„æµç¨‹ï¼Œå¯å‡å°‘ uboot åŠ è½½æ—¶é—´ã€‚</p></li><li><p>å¼€å¯ logo åŠéŸ³ä¹ï¼š<br>å¯å°è¯•åœ¨ uboot ä¸­å¼€å¯å¼€æœº logo/éŸ³ä¹ï¼Œå°½å¿«æ’­å‡ºç¬¬ä¸€å¸§/å£°ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚ æ­¤æ“ä½œä¼šå»¶ç¼“åˆ°è¾¾ OS/APP çš„æ—¶é—´ï¼Œä½†å¦‚æœäº§å“å®šä¹‰/ç”¨æˆ·ä½“éªŒæ˜¯ä»¥ç¬¬ä¸€å¸§/å£°ä¸ºå‡†çš„è¯ï¼Œåˆ™æœ‰è¾ƒå¤§ä»·å€¼ã€‚</p></li></ul><h2 id="kernel-å¯åŠ¨ä¼˜åŒ–">kernel å¯åŠ¨ä¼˜åŒ–</h2><p>é€šå¸¸æ¥è¯´ï¼Œå†…æ ¸å¯åŠ¨è€—æ—¶è¾ƒå¤šï¼Œéœ€è¦æ›´æ·±å…¥çš„ä¼˜åŒ–ã€‚</p><h3 id="kernel-å‹ç¼©æ–¹å¼">kernel å‹ç¼©æ–¹å¼</h3><p>æ¯”è¾ƒä¸åŒå‹ç¼©æ–¹å¼çš„å¯åŠ¨æ—¶é—´å’Œ flash å ç”¨æƒ…å†µï¼Œé€‰æ‹©ä¸€ç§ç¬¦åˆå®é™…æƒ…å†µçš„ã€‚æ­¤å¤„ç»™å‡ºæŸæ¬¡æµ‹è¯•ç»“æœä¾›å‚è€ƒã€‚å®é™…ä¼˜åŒ–çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°æµ‹è¯•ï¼Œæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ã€‚</p><table><thead><tr class="header"><th>å‹ç¼©æ–¹å¼</th><th>å†…æ ¸å¤§å°ï¼ˆMï¼‰</th><th>åŠ è½½æ—¶é—´ï¼ˆsï¼‰</th><th>è§£å‹æ—¶é—´ï¼ˆsï¼‰</th><th>æ€»æ—¶é—´ï¼ˆsï¼‰</th></tr></thead><tbody><tr class="odd"><td>LZO</td><td>2.4</td><td>0.38</td><td>0.23</td><td>0.61</td></tr><tr class="even"><td>GZIP</td><td>1.9</td><td>0.35</td><td>0.44</td><td>0.79</td></tr><tr class="odd"><td>XZ</td><td>1.5</td><td>0.25</td><td>2.17</td><td>2.42</td></tr></tbody></table><h3 id="åŠ è½½ä½ç½®">åŠ è½½ä½ç½®</h3><p>å†…æ ¸é•œåƒå¯ä»¥ç”± kernel è‡ªè§£å‹ï¼Œä¹Ÿæœ‰ uboot è¿›è¡Œè§£å‹çš„æƒ…å†µã€‚</p><p>å¯¹äº kernel è‡ªè§£å‹çš„æƒ…å†µï¼Œå¦‚æœå‹ç¼©è¿‡çš„ kernel ä¸è§£å‹åçš„ kernel åœ°å€å†²çªï¼Œåˆ™ä¼šå…ˆæŠŠè‡ªå·±å¤åˆ¶åˆ°å®‰å…¨çš„åœ°æ–¹ï¼Œç„¶åå†è§£å‹ï¼Œé˜²æ­¢è‡ªæˆ‘è¦†ç›–ã€‚è¿™å°±éœ€è¦è€—è´¹å¤åˆ¶çš„æ—¶é—´ã€‚</p><p>æ¯”å¦‚å¯¹äºè¿è¡Œåœ°å€ä¸º 0x80008000 çš„å†…æ ¸æ¥è¯´ï¼Œ bootloader å¯ä»¥å°†å…¶åŠ è½½åˆ° 0x81008000ï¼Œå½“ç„¶å…¶ä»–ä½ç½®ä¹Ÿå¯ä»¥ã€‚</p><h3 id="å†…æ ¸è£å‰ª">å†…æ ¸è£å‰ª</h3><p>è£å‰ªå†…æ ¸ï¼Œå¸¦æ¥çš„åŠ é€Ÿæ˜¯ä¸¤ä¸ªæ–¹é¢çš„ã€‚ä¸€æ˜¯ä½“ç§¯å˜å°ï¼ŒåŠ è½½è§£å‹è€—æ—¶å‡å°‘ï¼›äºŒæ˜¯å†…æ ¸å¯åŠ¨æ—¶åˆå§‹åŒ–å†…å®¹å˜å°‘ã€‚</p><p>è£å‰ªè¦æ ¹æ®äº§å“çš„å®é™…æƒ…å†µæ¥ï¼Œå°†ä¸éœ€è¦çš„åŠŸèƒ½åŠæ¨¡å—éƒ½å»æ‰ã€‚å…·ä½“æ˜¯æ‰§è¡Œ"make kernel_menuconfig"ï¼Œå…³é—­ä¸éœ€è¦çš„é€‰é¡¹ã€‚</p><h3 id="é¢„è®¾ç½®-lpj-æ•°å€¼">é¢„è®¾ç½® lpj æ•°å€¼</h3><p>LPJ ä¹Ÿå°±æ˜¯ loops_per_jiffyï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä¼šè®¡ç®—ä¸€æ¬¡ï¼Œä½†å¦‚æœæ²¡æœ‰åšä¿®æ”¹çš„è¯ï¼Œè¿™ä¸ªå€¼æ¯æ¬¡å¯åŠ¨ç®—å‡ºæ¥éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥ç›´æ¥æä¾›æ•°å€¼è·³è¿‡è®¡ç®—ã€‚</p><p>å¦‚ä¸‹ log æ‰€ç¤ºï¼Œæœ‰ skippedï¼Œ lpj ç”± timer è®¡ç®—å¾—æ¥ï¼Œä¸éœ€è¦å†æ ¡å‡† calibrate äº†ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ 0.019918] Calibrating delay loop (skipped), value calculated using timer frequency..</span><br><span class="line">48.00 BogoMIPS (lpj=240000)</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰ skippedï¼Œåˆ™å¯ä»¥åœ¨ cmdline ä¸­æ·»åŠ  lpj=XXX è¿›è¡Œé¢„è®¾ã€‚</p><h3 id="initcall-ä¼˜åŒ–">initcall ä¼˜åŒ–</h3><p>åœ¨ cmdline ä¸­è®¾ç½® initcall_debug=1ï¼Œå³å¯æ‰“å°è·Ÿè¸ªæ‰€æœ‰å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨ initcall çš„é¡ºåºä»¥åŠè€—æ—¶ã€‚</p><p>å…·ä½“ä¿®æ”¹ env é…ç½®æ–‡ä»¶ï¼ˆè·¯å¾„è§ä¸Šæ–‡ï¼‰ï¼Œæ–°å¢ä¸€è¡Œ"initcall_debug=1"ï¼Œå¹¶åœ¨"setargs_*"ååŠ å…¥"initcall_debug=${initcall_debug}"ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setargs_nand=setenv bootargs console=<span class="variable">${console}</span> console=tty0 root=<span class="variable">${nand_root}</span> init=<span class="variable">${init}</span></span><br><span class="line">loglevel=<span class="variable">${loglevel}</span> partitions=<span class="variable">${partitions}</span> initcall_debug=<span class="variable">${initcall_debug}</span></span><br></pre></td></tr></tbody></table></figure><p>åŠ å…¥åï¼Œå†…æ ¸å¯åŠ¨æ—¶å°±ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹çš„æ‰“å°ï¼Œå¯¹äºè€—æ—¶è¾ƒå¤šçš„ initcallï¼Œå¯è¿›è¡Œæ·±å…¥ä¼˜åŒ–ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ 0.021772] initcall sunxi_pinctrl_init+0x0/0x44 returned 0 after 9765 usecs</span><br><span class="line">[ 0.067694] initcall param_sysfs_init+0x0/0x198 returned 0 after 29296 usecs</span><br><span class="line">[ 0.070240] initcall genhd_device_init+0x0/0x88 returned 0 after 9765 usecs</span><br><span class="line">[ 0.080405] initcall init_scsi+0x0/0x90 returned 0 after 9765 usecs</span><br><span class="line">[ 0.090384] initcall mmc_init+0x0/0x84 returned 0 after 9765 usecs</span><br></pre></td></tr></tbody></table></figure><h3 id="å†…æ ¸-initcall-module-å¹¶è¡Œ">å†…æ ¸ initcall module å¹¶è¡Œ</h3><p>å†…æ ¸ initcall æœ‰å¾ˆå¤šçº§åˆ«ï¼Œå…¶ä¸­å¯åŠ¨ä¸­æœ€è€—æ—¶çš„å°±æ˜¯å„ module çš„ initcallï¼Œé’ˆå¯¹å¤šæ ¸æ–¹æ¡ˆï¼Œå¯ä»¥è€ƒè™‘å°† module initcall å¹¶è¡Œæ‰§è¡Œæ¥èŠ‚çœæ—¶é—´ã€‚</p><p>ç›®å‰å†…æ ¸ do_initcalls æ˜¯ä¸€ä¸ªä¸€ä¸ªæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œï¼Œå¯ä»¥ä¿®æ”¹æˆæ–°å»ºå†…æ ¸çº¿ç¨‹æ¥æ‰§è¡Œã€‚</p><p>ğŸ’¡ æ³¨ï¼šå½“å‰ sdk è¿˜æœªåŠ å…¥è¯¥ä¼˜åŒ–ã€‚</p><h3 id="å‡å°‘-ptytty-ä¸ªæ•°">å‡å°‘ pty/tty ä¸ªæ•°</h3><p>åŠ å…¥ initcall æ‰“å°ä¹‹åï¼Œéƒ¨åˆ†å¹³å°å‘ç° pty/tty init è€—æ—¶å¾ˆå¤šï¼Œå¯å‡å°‘ä¸ªæ•°æ¥ç¼©çŸ­ init æ—¶é—´ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">initcall pty_init+0x0/0x3c4 returned 0 after 239627 usecs</span><br><span class="line">initcall chr_dev_init+0x0/0xdc returned 0 after 36581 usecs</span><br></pre></td></tr></tbody></table></figure><h3 id="å†…æ ¸-module">å†…æ ¸ module</h3><p>éœ€è¦è€ƒè™‘å¯åŠ¨é€Ÿåº¦çš„ç•Œå®šï¼Œå¯¹äºå†…æ ¸ module çš„ä¼˜åŒ–ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>å¯¹äºå¿…é¡»è¦åŠ è½½çš„æ¨¡å—ï¼Œç›´æ¥ç¼–è¯‘è¿›å†…æ ¸</li><li>å¯¹äºä¸æ€¥éœ€çš„åŠŸèƒ½ï¼Œå¯ä»¥ç¼–è¯‘æˆæ¨¡å—</li></ul><p>æ¯”å¦‚æŸä¸ªåº”ç”¨ï¼Œä¼šå¼€å¯ä¸»ç•Œé¢è”ç½‘ï¼Œå¯åŠ¨é€Ÿåº¦ä»¥å‡ºç°ä¸»ç•Œé¢ä¸ºå‡†ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘å°† disp ç¼–å…¥å†…æ ¸ï¼Œ wifi ç¼–è¯‘æˆæ¨¡å—ï¼Œåç»­éœ€è¦æ—¶å†åŠ¨æ€åŠ è½½</p><h3 id="deferred-initcalls">Deferred Initcalls</h3><p>ä»‹ç»é¡µé¢åŠ patchï¼š <span class="exturl" data-url="aHR0cDovL2VsaW51eC5vcmcvRGVmZXJyZWRfSW5pdGNhbGxz">http://elinux.org/Deferred_Initcalls<i class="fa fa-external-link-alt"></i></span></p><p>æ‰“ä¸Šè¿™ä¸ª patch ä¹‹åï¼Œå¯ä»¥æ ‡è®°ä¸€äº› initcall ä¸º Deferred_Initcallã€‚è¿™äº›è¢«æ ‡è®°çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ä¸ä¼šè¢«è°ƒç”¨</p><p>è¿›å…¥æ–‡ä»¶ç³»ç»Ÿåï¼Œåœ¨åˆé€‚çš„æ—¶é—´ï¼Œæ¯”å¦‚å¯åŠ¨ä¸»åº”ç”¨ä¹‹åï¼Œå†é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼Œå¯åŠ¨è¿™äº›æ¨è¿Ÿäº†çš„è°ƒç”¨ï¼Œå½»åº•å®Œæˆåˆå§‹åŒ–ã€‚</p><h2 id="rootfs-å¯åŠ¨ä¼˜åŒ–">rootfs å¯åŠ¨ä¼˜åŒ–</h2><p>rootfs å¯åŠ¨ä¼˜åŒ–ä¸»è¦æ˜¯ä¼˜åŒ– rootfs çš„æŒ‚è½½åˆ° init è¿›ç¨‹æ‰§è¡Œã€‚</p><h3 id="initramfs">initramfs</h3><p>initramfs æ˜¯ä¸€ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œä¼šå ç”¨è¾ƒå¤š DRAMã€‚</p><p>éƒ¨åˆ†äº§å“å¯èƒ½ä¼šç”¨åˆ° initramfs æ¥è¿‡æ¸¡åˆ° rootfsï¼Œå…¶ä¼˜åŒ–æ€è·¯å¤§ä½“ä¸ rootfs ç±»ä¼¼ã€‚å¯å‚è€ƒæœ¬èŠ‚åç»­çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚</p><h3 id="rootfs-ç±»å‹ä»¥åŠå‹ç¼©">rootfs ç±»å‹ä»¥åŠå‹ç¼©</h3><p>å­˜å‚¨ä»‹è´¨ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå‹ç¼©æ–¹å¼å¯¹ rootfs æŒ‚è½½æœ‰å¾ˆå¤§å½±å“ã€‚</p><p>æ­¤å¤„ç»™å‡ºæŸæ¬¡æµ‹è¯•ç»“æœä¾›å‚è€ƒã€‚å®é™…ä¼˜åŒ–çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°æµ‹è¯•ï¼Œæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©</p><table><thead><tr class="header"><th>ç±»å‹</th><th>å‹ç¼©</th><th>ä»‹è´¨</th><th>æ€»æ—¶é—´ï¼ˆsï¼‰</th></tr></thead><tbody><tr class="odd"><td>squashfs</td><td>gzip</td><td>emmc</td><td>0.12</td></tr><tr class="even"><td>squashfs</td><td>xz</td><td>emmc</td><td>0.27</td></tr><tr class="odd"><td>squashfs</td><td>xz</td><td>nand</td><td>0.26</td></tr><tr class="even"><td>ext4</td><td>-</td><td>emmc</td><td>0.12</td></tr></tbody></table><h3 id="rootfs-è£å‰ª">rootfs è£å‰ª</h3><p>æ–‡ä»¶ç³»ç»Ÿè¶Šå°ï¼ŒåŠ è½½é€Ÿåº¦è¶Šå¿«ã€‚è£å‰ªçš„ä¸»è¦æ€è·¯æ˜¯ï¼šåˆ æ¢å‹ï¼Œå³åˆ é™¤æ²¡æœ‰ç”¨åˆ°çš„ï¼Œç”¨å°çš„æ¢å¤§çš„ï¼Œé€‰æ‹©åˆé€‚çš„å‹ç¼©æ–¹å¼</p><h3 id="æŒ‡å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹">æŒ‡å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹</h3><p>å†…æ ¸åœ¨æŒ‚è½½ rootfs æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ª try æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„è¿‡ç¨‹ã€‚å¯ä»¥åœ¨ cmdline ç›´æ¥æŒ‡å®šï¼ŒèŠ‚çœæ—¶é—´ã€‚</p><p>å…·ä½“æ˜¯åœ¨ cmdline ä¸­æ·»åŠ "rootfstype=<type>"ï¼Œå…¶ä¸­ type ä¸ºæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå¦‚ ext4ã€ squashfs ç­‰ã€‚</type></p><h3 id="é™æ€åˆ›å»º-dev-èŠ‚ç‚¹">é™æ€åˆ›å»º dev èŠ‚ç‚¹</h3><p>å¯¹äº dev ä¸‹é¢çš„èŠ‚ç‚¹ï¼Œäº‹å…ˆæ ¹æ®å®é™…æƒ…å†µåˆ›å»ºå¥½ï¼Œè€Œä¸æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨ååŠ¨æ€ç”Ÿæˆï¼Œç†è®ºä¸Šä¹Ÿå¯ä»¥èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚</p><h3 id="rootfs-æ‹†åˆ†">rootfs æ‹†åˆ†</h3><p>å¯ä»¥å°† rootfs æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªå°çš„æ–‡ä»¶ç³»ç»Ÿå…ˆæŒ‚è½½æ‰§è¡Œï¼Œå¤§çš„æ–‡ä»¶ç³»ç»Ÿæ ¹æ®éœ€è¦åŠ¨æ€æŒ‚è½½</p><h2 id="ä¸»åº”ç”¨ç¨‹åºå¯åŠ¨ä¼˜åŒ–">ä¸»åº”ç”¨ç¨‹åºå¯åŠ¨ä¼˜åŒ–</h2><p>ä¸»åº”ç”¨ç¨‹åºä¸»è¦æ˜¯ç”±å®¢æˆ·å¼€å‘ï¼Œå› æ­¤ä¸»å¯¼ä¼˜åŒ–çš„è¿˜æ˜¯å®¢æˆ·ï¼Œè¿™é‡Œæä¸€äº›ä¼˜åŒ–æªæ–½ï¼š</p><ul><li>æå‡è¿è¡Œé¡ºåºã€‚å°†åº”ç”¨ç¨‹åºæ”¾åœ¨ init å¾ˆå‰é¢æ‰§è¡Œ</li><li>åŠ¨æ€/é™æ€é“¾æ¥</li><li>ç¼–è¯‘é€‰é¡¹</li><li>æš‚æ—¶ä¸ä½¿ç”¨çš„åº“é‡‡ç”¨ dlopen æ–¹å¼</li><li>åº”ç”¨ç¨‹åºæ‹†åˆ†</li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>[1] <span class="exturl" data-url="aHR0cHM6Ly9lbGludXgub3JnL0Jvb3RfVGltZQ==">https://elinux.org/Boot_Time<i class="fa fa-external-link-alt"></i></span><br>[2] <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmJsYWNrZmluLnVjbGludXgub3JnL2Rva3UucGhwP2lkPWZhc3RfYm9vdF9leGFtcGxl">https://docs.blackfin.uclinux.org/doku.php?id=fast_boot_example<i class="fa fa-external-link-alt"></i></span><br>[3] <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RiaXJkMjBkL2dyYWJzZXJpYWw=">https://github.com/tbird20d/grabserial<i class="fa fa-external-link-alt"></i></span><br>[4] <span class="exturl" data-url="aHR0cDovL3d3dy5ib290Y2hhcnQub3Jn">http://www.bootchart.org<i class="fa fa-external-link-alt"></i></span><br>[5] A Framework for Optimization of the Boot Time on Embedded Linux Environment with Raspberry Pi Platform<br>ã€Šå…¨å¿—SDKæ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Performance </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ææ¸…ç…§</title>
      <link href="/2019/Literature/LiQingzhao/"/>
      <url>/2019/Literature/LiQingzhao/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€å‰ªæ¢…çº¢è—•é¦™æ®‹ç‰ç°Ÿç§‹">ä¸€å‰ªæ¢…Â·çº¢è—•é¦™æ®‹ç‰ç°Ÿç§‹</h1><p>çº¢è—•é¦™æ®‹ç‰ç°Ÿç§‹ã€‚è½»è§£ç½—è£³ï¼Œç‹¬ä¸Šå…°èˆŸã€‚äº‘ä¸­è°å¯„é”¦ä¹¦æ¥ï¼Œé›å­—å›æ—¶ï¼Œæœˆæ»¡è¥¿æ¥¼ã€‚</p><p>èŠ±è‡ªé£˜é›¶æ°´è‡ªæµã€‚ä¸€ç§ç›¸æ€ï¼Œä¸¤å¤„é—²æ„ã€‚æ­¤æƒ…æ— è®¡å¯æ¶ˆé™¤ï¼Œæ‰ä¸‹çœ‰å¤´ï¼Œå´ä¸Šå¿ƒå¤´ã€‚</p><span id="more"></span><h1 id="å¦‚æ¢¦ä»¤å¸¸è®°æºªäº­æ—¥æš®">å¦‚æ¢¦ä»¤Â·å¸¸è®°æºªäº­æ—¥æš®</h1><p>å¸¸è®°æºªäº­æ—¥æš®ï¼Œæ²‰é†‰ä¸çŸ¥å½’è·¯ã€‚</p><p>å…´å°½æ™šå›èˆŸï¼Œè¯¯å…¥è—•èŠ±æ·±å¤„ã€‚</p><p>äº‰æ¸¡ï¼Œäº‰æ¸¡ï¼ŒæƒŠèµ·ä¸€æ»©é¸¥é¹­ã€‚</p><h1 id="å¦‚æ¢¦ä»¤æ˜¨å¤œé›¨ç–é£éª¤">å¦‚æ¢¦ä»¤Â·æ˜¨å¤œé›¨ç–é£éª¤</h1><p>æ˜¨å¤œé›¨ç–é£éª¤ï¼Œæµ“ç¡ä¸æ¶ˆæ®‹é…’ã€‚</p><p>è¯•é—®å·å¸˜äººï¼Œå´é“æµ·æ£ ä¾æ—§ã€‚</p><p>çŸ¥å¦ï¼ŒçŸ¥å¦ï¼Ÿåº”æ˜¯ç»¿è‚¥çº¢ç˜¦ã€‚</p><h1 id="é†‰èŠ±é˜´è–„é›¾æµ“äº‘æ„æ°¸æ˜¼">é†‰èŠ±é˜´Â·è–„é›¾æµ“äº‘æ„æ°¸æ˜¼</h1><p>è–„é›¾æµ“äº‘æ„æ°¸æ˜¼ï¼Œç‘è„‘æ¶ˆé‡‘å…½ã€‚ä½³èŠ‚åˆé‡é˜³ï¼Œç‰æ•çº±æ©±ï¼ŒåŠå¤œå‡‰åˆé€ã€‚</p><p>ä¸œç¯±æŠŠé…’é»„æ˜åï¼Œæœ‰æš—é¦™ç›ˆè¢–ã€‚è«é“ä¸é”€é­‚ï¼Œå¸˜å·è¥¿é£ï¼Œäººæ¯”é»„èŠ±ç˜¦ã€‚</p><h1 id="å—æ­Œå­å¤©ä¸Šæ˜Ÿæ²³è½¬">å—æ­Œå­Â·å¤©ä¸Šæ˜Ÿæ²³è½¬</h1><p>å¤©ä¸Šæ˜Ÿæ²³è½¬ï¼Œäººé—´å¸˜å¹•å‚ã€‚å‡‰ç”Ÿæ•ç°Ÿæ³ªç—•æ»‹ã€‚èµ·è§£ç½—è¡£èŠé—®ã€å¤œä½•å…¶ã€‚</p><p>ç¿ è´´è²è“¬å°ï¼Œé‡‘é”€è—•å¶ç¨€ã€‚æ—§æ—¶å¤©æ°”æ—§æ—¶è¡£ã€‚åªæœ‰æƒ…æ€€ä¸ä¼¼ã€æ—§å®¶æ—¶ã€‚</p><h1 id="ç‚¹ç»›å”‡è¹´ç½¢ç§‹åƒ">ç‚¹ç»›å”‡Â·è¹´ç½¢ç§‹åƒ</h1><p>è¹´ç½¢ç§‹åƒï¼Œèµ·æ¥æ…µæ•´çº¤çº¤æ‰‹ã€‚éœ²æµ“èŠ±ç˜¦ï¼Œè–„æ±—è½»è¡£é€ã€‚</p><p>è§å®¢å…¥æ¥ï¼Œè¢œåˆ¬é‡‘é’—æºœã€‚å’Œç¾èµ°ï¼Œå€šé—¨å›é¦–ï¼Œå´æŠŠé’æ¢…å—…ã€‚</p><h1 id="æ¸…å¹³ä¹å¹´å¹´é›ªé‡Œ">æ¸…å¹³ä¹Â·å¹´å¹´é›ªé‡Œ</h1><p>å¹´å¹´é›ªé‡Œï¼Œå¸¸æ’æ¢…èŠ±é†‰ã€‚æŒ¼å°½æ¢…èŠ±æ— å¥½æ„ï¼Œèµ¢å¾—æ»¡è¡£æ¸…æ³ªã€‚</p><p>ä»Šå¹´æµ·è§’å¤©æ¶¯ï¼Œè§è§ä¸¤é¬“ç”Ÿåã€‚çœ‹å–æ™šæ¥é£åŠ¿ï¼Œæ•…åº”éš¾çœ‹æ¢…èŠ±ã€‚</p><h1 id="æ­¦é™µæ˜¥æ˜¥æ™š">æ­¦é™µæ˜¥Â·æ˜¥æ™š</h1><p>é£ä½å°˜é¦™èŠ±å·²å°½ï¼Œæ—¥æ™šå€¦æ¢³å¤´ã€‚ç‰©æ˜¯äººéäº‹äº‹ä¼‘ï¼Œæ¬²è¯­æ³ªå…ˆæµã€‚</p><p>é—»è¯´åŒæºªæ˜¥å°šå¥½ï¼Œä¹Ÿæ‹Ÿæ³›è½»èˆŸã€‚åªæåŒæºªèˆ´è‰‹èˆŸï¼Œè½½ä¸åŠ¨è®¸å¤šæ„ã€‚</p><h1 id="å£°å£°æ…¢å¯»å¯»è§…è§…">å£°å£°æ…¢Â·å¯»å¯»è§…è§…</h1><p>å¯»å¯»è§…è§…ï¼Œå†·å†·æ¸…æ¸…ï¼Œå‡„å‡„æƒ¨æƒ¨æˆšæˆšã€‚ä¹æš–è¿˜å¯’æ—¶å€™ï¼Œæœ€éš¾å°†æ¯ã€‚ä¸‰æ¯ä¸¤ç›æ·¡é…’ï¼Œæ€æ•Œä»–ã€æ™šæ¥é£æ€¥ï¼Ÿé›è¿‡ä¹Ÿï¼Œæ­£ä¼¤å¿ƒï¼Œå´æ˜¯æ—§æ—¶ç›¸è¯†ã€‚</p><p>æ»¡åœ°é»„èŠ±å †ç§¯ã€‚æ†”æ‚´æŸï¼Œå¦‚ä»Šæœ‰è°å ªæ‘˜ï¼Ÿå®ˆç€çª—å„¿ï¼Œç‹¬è‡ªæ€ç”Ÿå¾—é»‘ï¼Ÿæ¢§æ¡æ›´å…¼ç»†é›¨ï¼Œåˆ°é»„æ˜ã€ç‚¹ç‚¹æ»´æ»´ã€‚è¿™æ¬¡ç¬¬ï¼Œæ€ä¸€ä¸ªæ„å­—äº†å¾—ï¼</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŒ—å²›çš„è¯—</title>
      <link href="/2019/Literature/NorthIsland/"/>
      <url>/2019/Literature/NorthIsland/</url>
      
        <content type="html"><![CDATA[<h1 id="åŒ—å²›çš„é•¿è¯—ç™½æ—¥æ¢¦çš„ç¬¬å››èŠ‚">ğŸ˜­åŒ—å²›çš„é•¿è¯—ã€Šç™½æ—¥æ¢¦ã€‹çš„ç¬¬å››èŠ‚</h1><p>ä½ æ²¡æœ‰å¦‚æœŸå½’æ¥</p><p>è€Œè¿™æ­£æ˜¯ç¦»åˆ«çš„æ„ä¹‰</p><span id="more"></span><p>ä¸€æ¬¡çˆ±çš„æ—…è¡Œ</p><p>æœ‰æ—¶å€™å°±è±¡æŠ½çƒŸé‚£æ ·</p><p>ç®€å•</p><p>åœ°ä¸‹å®¤ç©ºå®ˆç€ä½ </p><p>å†…å¿ƒçš„ç™½é“¶</p><p>æ°´ä»™èŠ±åœ¨æš—ä¸­ç¿ç„¶å¼€æ”¾</p><p>ä½ å¬å‡­æ‰€æœ‰çš„åå¤©æ°”</p><p>å‘æ€’ã€å“­å–Š</p><p>ä¹æ±‚ä½ æ‰“å¼€çª—æˆ·</p><p>ä¹¦é¡µç¿»å¼€</p><p>æ‰€æœ‰çš„æ–‡å­—å››æ•£</p><p>åªç•™ä¸‹ä¸€ä¸ªæ•°å­—</p><p>--æˆ‘çš„åº§ä½å·ç </p><p>é è¿‘çª—æˆ·</p><p>æœ¬æ¬¡åˆ—è½¦çš„ç»ˆç‚¹æ˜¯ä½ </p><h1 id="è¿‡èŠ‚åŒ—å²›">ğŸ˜§è¿‡èŠ‚ï¼ˆåŒ—å²›ï¼‰</h1><p>æ¯’è›‡ç‚«è€€å£ä¸­çš„é’‰å­</p><p>å¤§åœ°æœ‰è‘—æ¯’è›‡</p><p>ååƒé¸Ÿè›‹çš„å¯‚é™</p><p>æ‰€æœ‰é’Ÿè¡¨</p><p>åœæ­¢åœ¨æ— æ¢¦çš„æ—¶åˆ»</p><p>ä¸°æ”¶èšæ•›ç€</p><p>ç”°é‡æ­»åçš„ç¬‘å®¹</p><p>ä»æ°´é“¶çš„é•œå­</p><p>å½±åƒæˆåŒçš„äººä»¬</p><p>ä¹˜å®¶åº­çš„è½®å­</p><p>å»é›†å¸‚</p><p>ä¸€ä½æœ¬åœ°è‹±é›„</p><p>åœ¨åºŸå¼ƒçš„åœè½¦åœºä¸Š</p><p>å”±æ­Œ</p><p>ç»ç’ƒæ™´æœ—</p><p>æ¡”å­è¾‰ç…Œ</p><h1 id="å›ç­”åŒ—å²›">ğŸ˜¶â€ğŸŒ«ï¸å›ç­”ï¼ˆåŒ—å²›ï¼‰</h1><p>å‘é„™æ˜¯å‘é„™è€…çš„é€šè¡Œè¯ï¼Œ</p><p>é«˜å°šæ˜¯é«˜å°šè€…çš„å¢“å¿—é“­ï¼Œ</p><p>çœ‹å§ï¼Œåœ¨é‚£é•€é‡‘çš„å¤©ç©ºä¸­ï¼Œ</p><p>é£˜æ»¡äº†æ­»è€…å¼¯æ›²çš„å€’å½±ã€‚</p><p>å†°å·çºªè¿‡å»äº†ï¼Œ</p><p>ä¸ºä»€ä¹ˆåˆ°å¤„éƒ½æ˜¯å†°å‡Œï¼Ÿ</p><p>å¥½æœ›è§’å‘ç°äº†ï¼Œ</p><p>ä¸ºä»€ä¹ˆæ­»æµ·é‡Œåƒå¸†ç›¸ç«ï¼Ÿ</p><p>æˆ‘æ¥åˆ°è¿™ä¸ªä¸–ç•Œä¸Šï¼Œ</p><p>åªå¸¦ç€çº¸ã€ç»³ç´¢å’Œèº«å½±ï¼Œ</p><p>ä¸ºäº†åœ¨å®¡åˆ¤å‰ï¼Œ</p><p>å®£è¯»é‚£äº›è¢«åˆ¤å†³çš„å£°éŸ³ã€‚</p><p>å‘Šè¯‰ä½ å§ï¼Œä¸–ç•Œ</p><p>æˆ‘â€”â€”ä¸â€”â€”ç›¸â€”â€”ä¿¡ï¼</p><p>çºµä½¿ä½ è„šä¸‹æœ‰ä¸€åƒåæŒ‘æˆ˜è€…ï¼Œ</p><p>é‚£å°±æŠŠæˆ‘ç®—ä½œç¬¬ä¸€åƒé›¶ä¸€åã€‚</p><p>æˆ‘ä¸ç›¸ä¿¡å¤©æ˜¯è“çš„ï¼Œ</p><p>æˆ‘ä¸ç›¸ä¿¡é›·çš„å›å£°ï¼Œ</p><p>æˆ‘ä¸ç›¸ä¿¡æ¢¦æ˜¯å‡çš„ï¼Œ</p><p>æˆ‘ä¸ç›¸ä¿¡æ­»æ— æŠ¥åº”ã€‚</p><p>å¦‚æœæµ·æ´‹æ³¨å®šè¦å†³å ¤ï¼Œ</p><p>å°±è®©æ‰€æœ‰çš„è‹¦æ°´éƒ½æ³¨å…¥æˆ‘å¿ƒä¸­ï¼Œ</p><p>å¦‚æœé™†åœ°æ³¨å®šè¦ä¸Šå‡ï¼Œ</p><p>å°±è®©äººç±»é‡æ–°é€‰æ‹©ç”Ÿå­˜çš„å³°é¡¶ã€‚</p><p>æ–°çš„è½¬æœºå’Œé—ªé—ªæ˜Ÿæ–—ï¼Œ</p><p>æ­£åœ¨ç¼€æ»¡æ²¡æœ‰é®æ‹¦çš„å¤©ç©ºã€‚</p><p>é‚£æ˜¯äº”åƒå¹´çš„è±¡å½¢æ–‡å­—ï¼Œ</p><p>é‚£æ˜¯æœªæ¥äººä»¬å‡è§†çš„çœ¼ç›ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Literature Appreciation </category>
          
          <category> Poetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Poetry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ç³»ç»Ÿè£å‰ª</title>
      <link href="/2019/Debug/LinuxSystemCropping/"/>
      <url>/2019/Debug/LinuxSystemCropping/</url>
      
        <content type="html"><![CDATA[<h1 id="ç³»ç»Ÿè£å‰ªç®€ä»‹">ç³»ç»Ÿè£å‰ªç®€ä»‹</h1><p>å›ºä»¶ä¸­é€šå¸¸åŒ…å« boot0ã€ ubootã€ kernelã€ rootfs ç­‰é•œåƒã€‚åŸºäºç»éªŒï¼Œå„ä¸ªé•œåƒå°ºå¯¸çš„é‡çº§å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr class="header"><th>Image</th><th>size</th></tr></thead><tbody><tr class="odd"><td>boot0</td><td>&lt; 100k</td></tr><tr class="even"><td>uboot</td><td>&lt; 1M</td></tr><tr class="odd"><td>kernel</td><td>3-15M</td></tr><tr class="even"><td>rootfs</td><td>&gt; 4M</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ° boot0ã€ ubootã€ kernelã€ rootfs çš„å°ºå¯¸æ˜¯ä¾æ¬¡å¢å¤§çš„ã€‚å¯¹äºå¤§å°ºå¯¸çš„è£å‰ªæ•ˆæœå¾€å¾€æ¯”å°å°ºå¯¸çš„è£å‰ªæ•ˆæœæ˜æ˜¾ï¼Œæ¯”å¦‚ rootfs è£å‰ª 1M å¯èƒ½å¾ˆå®¹æ˜“ï¼Œå¯¹äº uboot æ¥è¯´ï¼Œåˆ™éå¸¸å›°éš¾ã€‚å› æ­¤ï¼Œåç»­ä¸»è¦ä»‹ç» kernel ä»¥åŠ rootfs çš„è£å‰ªã€‚</p><span id="more"></span><h2 id="boot0-è£å‰ª">boot0 è£å‰ª</h2><p>ç”±äº boot0 å¾ˆå°ï¼Œé€šå¸¸æ¥è¯´ boot0 ä»£ç ä¹Ÿä¸å¼€æºï¼Œå› æ­¤ç•¥è¿‡ã€‚</p><h2 id="uboot-è£å‰ª">uboot è£å‰ª</h2><p>uboot ä»£ç ä½äº sdk/vendor/brandy<em>/u-boot </em>ç›®å½•ä¸‹ï¼Œä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§è£å‰ªæ€è·¯ï¼š</p><ul><li>ä¿®æ”¹ uboot é…ç½®æ–‡ä»¶ï¼Œåˆ å‡ä¸éœ€è¦çš„é…ç½®ã€‚ uboot é…ç½®æ–‡ä»¶é€šå¸¸ä½äºæºç ä¸‹ include/configs/${CHIP}.h æˆ–è€… configs/${CHIP}_*_defconfig</li><li>åˆ é™¤ä¸éœ€è¦çš„ uboot å‘½ä»¤</li></ul><h2 id="å†…æ ¸è£å‰ª">å†…æ ¸è£å‰ª</h2><p>é€šå¸¸å…³äº Linux å†…æ ¸è£å‰ªä¸»è¦æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>åˆ é™¤ä¸ä½¿ç”¨çš„åŠŸèƒ½ã€‚å¦‚ç¬¦å·è¡¨ã€æ‰“å°ã€è°ƒè¯•ç­‰åŠŸèƒ½</li><li>åˆ é™¤ä¸ä½¿ç”¨çš„é©±åŠ¨</li><li>ä¿®æ”¹å†…æ ¸æºä»£ç </li><li>å†…æ ¸å‹ç¼©</li></ul><h3 id="åˆ é™¤ä¸ä½¿ç”¨çš„åŠŸèƒ½">åˆ é™¤ä¸ä½¿ç”¨çš„åŠŸèƒ½</h3><p>æ ¹æ®è‡ªå·±çš„åŠŸèƒ½éœ€æ±‚è¿›è¡Œå¼€å¯æˆ–å…³é—­å¯¹åº”æ¨¡å—åŠŸèƒ½ã€‚</p><h3 id="åˆ é™¤ä¸ä½¿ç”¨çš„é©±åŠ¨">åˆ é™¤ä¸ä½¿ç”¨çš„é©±åŠ¨</h3><p>æ–¹æ¡ˆæ˜ç¡®ä¹‹åï¼Œæ‰€éœ€çš„å†…æ ¸é©±åŠ¨ä¹Ÿæ˜ç¡®äº†ã€‚å¯ä»¥æ‰§è¡Œ make kernel_menuconfigï¼Œå°†æ²¡æœ‰ç”¨åˆ°çš„é©±åŠ¨å…³é—­ã€‚</p><h3 id="ä¿®æ”¹å†…æ ¸æºä»£ç ">ä¿®æ”¹å†…æ ¸æºä»£ç </h3><p>å†…æ ¸æºç åºå¤§ï¼Œç›´æ¥ä¿®æ”¹å¾€å¾€éš¾åº¦å¾ˆå¤§ï¼Œå¯å€ŸåŠ©ç›¸å…³å·¥å…·æ¥è¯„ä¼°æ¨¡å—ä»¥åŠç¬¦å·çš„å¤§å°ï¼Œç„¶åè¿›è¡Œé’ˆå¯¹æ€§çš„è£å‰ªã€‚</p><ul><li>size å·¥å…·</li></ul><p>size å‘½ä»¤å¯æŸ¥çœ‹å†…æ ¸é•œåƒçš„ textã€ dataã€ bss ç­‰æ®µçš„å¤§å°ã€‚å¦‚æ‰§è¡Œ"size vmlinux"ï¼Œå°†ä¼šå¾—åˆ°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text data bss dec hex filename</span><br><span class="line">5818117 1378944 168972 7366033 706591 vmlinux</span><br></pre></td></tr></tbody></table></figure><ul><li>nm å‘½ä»¤</li></ul><p>nm å‘½ä»¤å¯æŸ¥çœ‹å†…æ ¸æ¨¡å—ä¸­å„ä¸ªç¬¦å·çš„å°ºå¯¸ã€‚å¦‚æ‰§è¡Œ"nm --size -r vmlinux | head -10"ï¼Œå¯å¾—åˆ°ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">000b0000 D pwrsv_lgc_tab</span><br><span class="line">00004ad8 T hidinput_connect</span><br><span class="line">00004000 b __log_buf</span><br><span class="line">00003fb4 T __blockdev_direct_IO</span><br><span class="line">00002ba4 t machines</span><br><span class="line">000026a0 b g_fbi</span><br><span class="line">00002120 t test_atomics</span><br><span class="line">00002000 b page_address_maps</span><br><span class="line">00002000 d nmi_print_seq</span><br><span class="line">00002000 D init_thread_union</span><br></pre></td></tr></tbody></table></figure><p>è¯´æ˜ï¼Œä¸€å…±æœ‰ä¸‰åˆ—æ•°æ®ï¼Œåˆ†åˆ«è¡¨ç¤ºå¤§å°ã€ç¬¦å·ç±»å‹ã€ç¬¦å·åã€‚å…¶ä¸­ç¬¦å·ç±»å‹ï¼š</p><ul><li>b/B - ç¬¦å·ä½äº bss æ®µ</li><li>t/T - ç¬¦å·ä½äº text æ®µ</li><li>d/D - ç¬¦å·ä½äº data æ®µ</li></ul><p>å¦‚æœæŸäº›å‡½æ•°æˆ–è€…å…¨å±€å˜é‡å ç”¨è¾ƒå¤§ï¼Œå¯ä»¥è¿›è¡Œé’ˆå¯¹æ€§çš„ä¼˜åŒ–ã€‚</p><h2 id="æ–‡ä»¶ç³»ç»Ÿè£å‰ª">æ–‡ä»¶ç³»ç»Ÿè£å‰ª</h2><p>å¯¹äºæ–‡ä»¶ç³»ç»Ÿè£å‰ªæ¥è¯´ï¼Œä¸»è¦æ€è·¯æ˜¯åˆ ã€æ¢ã€å‹ã€‚</p><ul><li>åˆ ï¼Œåˆ é™¤ä¸éœ€è¦çš„å†…å®¹ã€‚å¦‚å¸®åŠ©æ–‡æ¡£ã€æ²¡ç”¨åˆ°çš„åº“ã€è°ƒè¯•ç¨‹åºç­‰</li><li>æ¢ï¼Œä½¿ç”¨å°å°ºå¯¸çš„å®ç°æ›¿æ¢å¤§å°ºå¯¸çš„å®ç°ã€‚å¦‚ä½¿ç”¨ musl libc åº“æ›¿æ¢ glibc åº“ç­‰</li><li>å‹ï¼Œä½¿ç”¨åˆé€‚çš„å‹ç¼©ç®—æ³•</li></ul><h3 id="åº”ç”¨ç¨‹åºåŠå†—ä½™æ–‡ä»¶è£å‰ª">åº”ç”¨ç¨‹åºåŠå†—ä½™æ–‡ä»¶è£å‰ª</h3><p>åœ¨ä¸å½±å“æ•´ä½“åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œä¸€äº›åº”ç”¨ç¨‹åºæˆ–å†—ä½™æ–‡ä»¶å¾€å¾€å¯ä»¥åˆ é™¤ï¼š</p><ul><li>è°ƒè¯•å·¥å…·ã€‚æ¯”å¦‚ tcpdumpã€ mpstatã€ strace ç­‰ç­‰</li><li>æ€§èƒ½æµ‹è¯•å·¥å…·ã€‚æ¯”å¦‚ lmbenchã€ sysstatã€ tiobench ç­‰ç­‰</li><li>å†—ä½™æ–‡ä»¶ã€‚å¸®åŠ©æ–‡æ¡£ã€è¾…åŠ©ç¨‹åºã€é…ç½®æ–‡ä»¶å’Œæ•°æ®æ¨¡å—ç­‰ï¼Œåˆæ¯”å¦‚å¾ˆå¤šåº”ç”¨æœ‰ç›¸åŒçš„å…±èƒ½ï¼Œåªç•™å…¶ä¸€</li><li>é‡‡ç”¨å…·æœ‰é€šç”¨åŠŸèƒ½çš„æ›¿ä»£è½¯ä»¶åŒ…ã€‚ Linux ä¸Šæœ‰è®¸å¤šå…·æœ‰ç›¸ä¼¼åŠŸèƒ½çš„è½¯ä»¶åŒ…ï¼Œå¯ä»¥é€‰æ‹©å…¶ä¸­å å­˜å‚¨ç©ºé—´è¾ƒå°çš„è½¯ä»¶åŒ…å¹¶ç§»æ¤åˆ°åµŒå…¥å¼è®¾å¤‡ä¸Š</li><li>èµ„æºæ–‡ä»¶ã€‚ä¸€äº›éŸ³è§†é¢‘ä»¥åŠ UI èµ„æºå¾€å¾€å ç”¨å¾ˆå¤§ç©ºé—´ï¼Œå¦‚æœæ²¡æœ‰ç”¨åˆ°ï¼Œä¹Ÿéœ€è¦åˆ é™¤</li></ul><h3 id="åº“çš„è£å‰ª">åº“çš„è£å‰ª</h3><p>å…³äºåº“çš„è£å‰ªä¸»è¦æœ‰ä¸¤ä¸ªæ€è·¯ï¼š</p><ul><li>ä½¿ç”¨è¾ƒå°çš„ C åº“ï¼Œå¦‚ musl libcï¼Œ uclibc ç­‰æ¥æ›¿æ¢ glibc</li><li>åˆ é™¤æ²¡æœ‰ç”¨åˆ°çš„åº“</li></ul><h3 id="åˆ é™¤æ²¡ç”¨åˆ°çš„åº“">åˆ é™¤æ²¡ç”¨åˆ°çš„åº“</h3><p>åµŒå…¥å¼äº§å“é€šå¸¸åº”ç”¨ç¨‹åºæœ‰é™ï¼Œå› æ­¤å¯èƒ½å­˜åœ¨å¾ˆå¤šåº“ä¸ä¼šè¢«ç”¨åˆ°ï¼Œå¯ä»¥è¿›è¡Œåˆ é™¤ã€‚å½“å‰ Tina ç¯å¢ƒæä¾›äº†ä¸€ç§åˆ é™¤æ–¹æ³•ï¼Œæ‰§è¡Œ make menuconfigï¼Œæ‰“å¼€å¦‚ä¸‹é€‰é¡¹</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Tina Configuration</span><br><span class="line">    Target Images ---&gt;</span><br><span class="line">        [*] downsize the root filesystem or initramfs</span><br></pre></td></tr></tbody></table></figure><p>æ‰“å¼€ä¹‹åï¼Œåœ¨ç”Ÿæˆ rootfs/initramfs ä¹‹å‰ä¼šå¯¹å…¶ä¸­æ²¡æœ‰ç”¨åˆ°çš„åº“è¿›è¡Œåˆ é™¤ã€‚</p><p>å…·ä½“å¯å‚è€ƒ scripts/reduce-rootfs-size.sh æ–‡ä»¶ï¼Œå…¶ä¸»è¦æ€è·¯æ˜¯ï¼š</p><ul><li>åˆ†æ rootfs ä¸‹çš„åº”ç”¨ç¨‹åºæ‰€ä¾èµ–çš„åº“</li><li>åˆ†æ â€œåº”ç”¨ç¨‹åºä¾èµ–åº“â€ æ‰€ä¾èµ–çš„åº“ï¼Œä¸€ç›´é€’å½’ä¸‹å»ï¼Œç›´åˆ°å®Œå…¨æ‰¾å‡ºæ‰€æœ‰ä¾èµ–çš„åº“</li><li>æ ¹æ®ä¸Šè¿°æŸ¥æ‰¾ç»“æœï¼Œåˆ é™¤æ²¡æœ‰è¢«ä¾èµ–çš„åº“</li></ul><h3 id="åº”ç”¨ç¨‹åºä¸åº“-strip">åº”ç”¨ç¨‹åºä¸åº“ strip</h3><p>strip ä¼šå»æ‰åº”ç”¨ç¨‹åºä¸åº“çš„ç¬¦å·ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯ï¼Œå¤§å¤§å‡å°‘ç©ºé—´å ç”¨ã€‚</p><p>å½“å‰ Tina ç¯å¢ƒä¸‹é»˜è®¤å¼€å¯äº† strip åŠŸèƒ½ï¼Œå¦‚æœæ²¡å¼€å¯ï¼Œè¯·ç¡®ä¿å¼€å¯ä»¥å‡å°‘ç©ºé—´å ç”¨ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Tina Configuration</span><br><span class="line">    Global build settings ---&gt;</span><br><span class="line">        Binary stripping method (strip) ---&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="æ–‡ä»¶ç³»ç»Ÿå‹ç¼©">æ–‡ä»¶ç³»ç»Ÿå‹ç¼©</h3><p>æœ‰äº›æ–‡ä»¶ç³»ç»Ÿæ”¯æŒå‹ç¼©ï¼Œæœ‰äº›ä¸æ”¯æŒã€‚æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ squahfsã€ ext4ã€ jfss2 ä¸‰ç§æ–‡ä»¶ç³»ç»Ÿã€‚å…·ä½“å¯æ‰§è¡Œ make menuconfig è¿›è¡Œé€‰æ‹©ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Tina Configuration</span><br><span class="line">   Target Images ---&gt;</span><br><span class="line">   *** Root filesystem images ***</span><br><span class="line">       [ ] ext4 ----</span><br><span class="line">       [ ] jffs2</span><br><span class="line">       [*] squashfs ---&gt;</span><br></pre></td></tr></tbody></table></figure><p>å¸¸è§çš„å‹ç¼©æœ‰ lzopï¼Œ gzipï¼Œ xz ç­‰ï¼Œå‹ç¼©ç‡æœ€é«˜çš„æ˜¯ xzã€‚ä½†æ˜¯ xz å‹ç¼©è§£å‹æœ€æ…¢ï¼Œéå¸¸å½±å“å¯åŠ¨é€Ÿåº¦ã€‚å®é™…åœ¨é€‰æ‹©å‹ç¼©æ–¹å¼æ—¶åº”ç»¼åˆè€ƒè™‘</p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>[1] <span class="exturl" data-url="aHR0cHM6Ly9lbGludXgub3JnL0tlcm5lbF9TaXplX1R1bmluZ19HdWlkZQ==">https://elinux.org/Kernel_Size_Tuning_Guide<i class="fa fa-external-link-alt"></i></span><br>[2] Karim Yaghmour. Building Embedded Linux Systems [M]<br>[3] Michael Opdenacker. Embedded Linux size reduction techniques<br>[4] <span class="exturl" data-url="aHR0cHM6Ly90aW55Lndpa2kua2VybmVsLm9yZw==">https://tiny.wiki.kernel.org<i class="fa fa-external-link-alt"></i></span><br>ã€Šå…¨å¿—SDKæ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Performance </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨æˆ·ç©ºé—´ backtrace</title>
      <link href="/2019/Note/UserapaceBacktrace/"/>
      <url>/2019/Note/UserapaceBacktrace/</url>
      
        <content type="html"><![CDATA[<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;execinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FRAMES 10</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc1</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc2</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc3</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printCallers</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> layers = <span class="number">0</span>, i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> ** symbols = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">void</span> * frames[MAX_FRAMES];</span><br><span class="line">    <span class="built_in">memset</span>(frames, <span class="number">0</span>, <span class="keyword">sizeof</span>(frames));</span><br><span class="line">    layers = backtrace(frames, MAX_FRAMES);</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;layers; i++) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Layer %d: %p\\n"</span>, i, frames[i]);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"------------------\\n"</span>);</span><br><span class="line">    </span><br><span class="line">    symbols = backtrace_symbols(frames, layers);</span><br><span class="line">    <span class="keyword">if</span> (symbols) {</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;layers; i++) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"SYMBOL layer %d: %s\\n"</span>, i, symbols[i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">free</span>(symbols);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to parse function names\\n"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc1</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> b = a + <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span> result = myfunc2(b);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc2</span><span class="params">(<span class="type">int</span> b)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> c = b * <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> result = c + myfunc3(c);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">myfunc3</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">{</span><br><span class="line">    printCallers();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    result = myfunc1(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result = %d\\n"</span>, result);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><ul><li>backtrace</li></ul><p>backtrace æœ‰ 2 ä¸ªå‚æ•°ï¼Œç¬¬ 1 ä¸ªå‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ª void * ç±»å‹çš„æ•°ç»„ï¼Œå°†æ¥æ‰€æœ‰çš„ frame ä¿¡æ¯éƒ½ä¼šå­˜åœ¨è¿™ä¸ªæ•°ç»„é‡Œï¼›ç¬¬ 2 ä¸ªå‚æ•° size çš„å«ä¹‰æ˜¯æŒ‡æ˜è¯¥æ•°ç»„çš„å¤§å°ã€‚æ¯”å¦‚ï¼Œæ•°ç»„å¤§å°ä¸º 5ï¼Œè€Œå®é™… frames æœ‰ 10 å±‚ï¼Œåˆ™åªå­˜å‚¨æœ€æ–°çš„ 5 ä¸ª frames; backtrace çš„è¿”å›å€¼çš„å«ä¹‰æ˜¯ç©¶ç«Ÿè¿”å›äº†å¤šå°‘å±‚çš„ framesï¼Œæ¯”å¦‚ï¼Œsize æŒ‡å®šä¸º 10ï¼Œè€Œ frames åªæœ‰ 5 å±‚ï¼Œåˆ™è¿”å› 5ï¼› è‹¥ size æŒ‡å®šä¸º 5ï¼Œè€Œ frames æœ‰ 10 å±‚ï¼Œåˆ™ä¹Ÿè¿”å› 5.</p><ul><li><p>backtrace_symbols</p><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥è§£ææ¯ä¸ª frame ä¸­çš„å‡½æ•°åœ°å€ä»£è¡¨çš„å‡½æ•°åç§°æ˜¯ä»€ä¹ˆã€‚å®ƒå¿…é¡»è¦åœ¨è¿è¡Œå®Œäº†ä¸Šé¢çš„ backtrace å‡½æ•°ä¹‹åæ‰èƒ½ç”¨ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå®ƒçš„ç¬¬ 1 ä¸ªå‚æ•°å°±æ˜¯è¢«ä¸Šé¢çš„ backtrace å‡½æ•°å¡«å……äº†çš„é‚£ä¸ª void * æ•°ç»„ã€‚è€Œå®ƒçš„ç¬¬ 2 ä¸ªå‚æ•°æŒ‡çš„æ˜¯è¦è§£æè¯¥ buffer æ•°ç»„ä¸­çš„å‡ ä¸ªå…ƒç´ ã€‚</p><ul><li>å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª char *æ•°ç»„ï¼Œä»£è¡¨å‡½æ•°åæ•°ç»„ï¼Œä½†æ˜¯è¿”å›çš„è¿™ä¸ª char ** å¿…é¡»è¦è¢«è°ƒç”¨è€… free æ‰ï¼Œè€Œè¯¥ char * æ•°ç»„å†…çš„æ¯ä¸ª char * æ˜¯ä¸èƒ½è¢« free çš„</li><li>å‡ºé”™æƒ…å†µä¸‹è¿”å› NULL</li><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯¥å‡½æ•°è§£æä¸å‡ºå‡½æ•°åï¼›åªæœ‰åœ¨ç¼–è¯‘çš„æ—¶å€™åŠ äº† â€œ-rdynamicâ€ é€‰é¡¹ï¼Œå°†æ¥è¿è¡Œæ—¶æ‰èƒ½è§£æå‡ºå‡½æ•°å</li></ul></li><li><p>backtrace_symbols_fd</p></li></ul><p>è¯¥å‡½æ•°å’Œ backtrace_symbols ç±»ä¼¼ï¼Œéƒ½æ˜¯æŠŠå‡½æ•°åœ°å€è§£ææˆå‡½æ•°åç§°ã€‚ä¸åŒç‚¹åœ¨äºï¼Œå®ƒä¸ä¼šè¿”å›ä»»ä½•ä¸œè¥¿ï¼Œè€Œæ˜¯æŠŠè§£æå‡ºçš„å‡½æ•°åç§°å†™è¿›ç¬¬ 3 ä¸ªå‚æ•°ï¼Œå³ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><ul><li>å…¶ä»–<ul><li>ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ¯”å¦‚ â€œ-O3â€, â€œ-O2â€ ç­‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨å±‚æ¬¡ä¸¢å¤±</li><li>inline å‡½æ•°æ²¡æœ‰ stack frame ï¼Œå› æ­¤ä¸ä¼šè¢«æ‰“å°å‡ºæ¥</li><li>ail-call ä¼˜åŒ–ä¹Ÿä¼šå¯¼è‡´å‡½æ•°åç§°çš„æ‰“å°ä¸¢å¤±</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux æ€§èƒ½åˆ†æ</title>
      <link href="/2019/Debug/LinuxPerf/"/>
      <url>/2019/Debug/LinuxPerf/</url>
      
        <content type="html"><![CDATA[<h1 id="cpu-ä½¿ç”¨åˆ†æ">cpu ä½¿ç”¨åˆ†æ</h1><h2 id="top-å‘½ä»¤">top å‘½ä»¤</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procps-ng-top -H -p 899 -w 120</span><br></pre></td></tr></tbody></table></figure><ul><li>-H æ˜¯çº¿ç¨‹æ¨¡å¼</li><li>-p æŒ‡å®šè¿›ç¨‹ id</li><li>-w æŒ‡å®šæ˜¾ç¤ºå®½åº¦ï¼ˆåˆ—æ•°ï¼‰</li><li>-d æŒ‡å®šå»¶æ—¶ ï¼Œå±å¹•æ›´æ–°é—´éš”</li></ul><p>shift+p æŒ‰ç…§ cpu ä½¿ç”¨ç‡å¯¹çº¿ç¨‹æ’åºã€‚å¦‚ä¸‹æ˜¯ä¸€ä¸ªå®ä¾‹ï¼š</p><span id="more"></span><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">procps-ng-top - 10:11:13 up  1:00,  0 <span class="built_in">users</span>,  load average: 3.90, 4.10, 3.89</span><br><span class="line">Threads:  81 total,   0 running,  81 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  :  46.6/30.7   77[|||||||||||||||||||||||||||||||||||||||||            ]</span><br><span class="line">GiB Mem : 84.5/0.239    [                                                     ]</span><br><span class="line">GiB Swap:  0.0/0.000    [                                                     ]</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES %CPU %MEM     TIME+ S COMMAND             </span><br><span class="line">  915 root      20   0  191.4m 174.1m 13.7 71.2   8:33.07 S VIChnDMS            </span><br><span class="line">  890 root      20   0  191.4m 174.1m 10.9 71.2   6:11.33 S isp_yhread          </span><br><span class="line">  869 root      20   0  191.4m 174.1m  9.7 71.2   5:36.66 S app                 </span><br><span class="line"> 1163 root      20   0  191.4m 174.1m  4.0 71.2   2:32.27 S AEncComp            </span><br><span class="line"> 1158 root      20   0  191.4m 174.1m  3.4 71.2   2:16.15 S RecSink[0]          </span><br><span class="line"> 1145 root     -21   0  191.4m 174.1m  2.3 71.2   1:01.76 S VEncComp            </span><br><span class="line"> 1154 root      20   0  191.4m 174.1m  1.7 71.2   1:15.99 S MuxerComp           </span><br><span class="line"> 1170 root      20   0  191.4m 174.1m  1.7 71.2   0:55.57 S RecSink[0]          </span><br><span class="line"> 1146 root     -21   0  191.4m 174.1m  1.7 71.2   1:16.99 S VEncComp            </span><br><span class="line"> 1139 root      20   0  191.4m 174.6m  1.1 71.4   0:23.14 S CDX_VRender         </span><br><span class="line"> 1166 root      20   0  191.4m 174.1m  1.1 71.2   0:49.78 S MuxerComp           </span><br><span class="line"> 1155 root      20   0  191.4m 174.1m  1.1 71.2   0:53.52 S RecSink[0]          </span><br><span class="line"> 1134 root      20   0  191.4m 174.6m  1.1 71.4   0:28.99 S CDX_VRender         </span><br><span class="line"> 1161 root      20   0  191.4m 174.1m  1.1 71.2   0:48.20 S recordThread        </span><br><span class="line"> 1141 root     -21   0  191.4m 174.1m  1.1 71.2   0:45.83 D VEncComp            </span><br><span class="line">  926 root      20   0  191.4m 174.1m  1.1 71.2   0:42.77 S app                 </span><br><span class="line">  885 root      20   0  191.4m 174.1m  0.6 71.2   0:27.83 S VIChnPreview</span><br></pre></td></tr></tbody></table></figure><p><strong>ç¬¬ä¸€è¡Œä»»åŠ¡é˜Ÿåˆ—ä¿¡æ¯ï¼š</strong></p><ul><li><em>10:11:13</em> - å½“å‰æ—¶é—´<br></li><li><em>up 1:00</em> - ç³»ç»Ÿå·²ç»è¿è¡Œ 1 å°æ—¶<br></li><li><em>0 users</em> - å½“å‰ç³»ç»Ÿæœ‰ 0 ä¸ªç”¨æˆ·ç™»å½•<br></li><li><em>load average: 3.90, 4.10, 3.89</em> - load average åé¢çš„ä¸‰ä¸ªæ•°åˆ†åˆ«æ˜¯ 1 åˆ†é’Ÿã€5 åˆ†é’Ÿã€15 åˆ†é’Ÿçš„è´Ÿè½½æƒ…å†µã€‚</li></ul><p>load average æ•°æ®æ˜¯æ¯éš” 5 ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡æ´»è·ƒçš„è¿›ç¨‹æ•°ï¼Œç„¶åæŒ‰ç‰¹å®šç®—æ³•è®¡ç®—å‡ºçš„æ•°å€¼ã€‚å¦‚æœè¿™ä¸ªæ•°é™¤ä»¥é€»è¾‘ CPU çš„æ•°é‡ï¼Œç»“æœé«˜äº 5 çš„æ—¶å€™å°±è¡¨æ˜ç³»ç»Ÿåœ¨è¶…è´Ÿè·è¿è½¬äº†ã€‚</p><p><strong>ç¬¬äºŒè¡Œ Tasks æˆ– Thread ä¿¡æ¯ï¼š</strong><br>Threads: 81 total - çº¿ç¨‹æ€»æ•° 81 ä¸ª</p><ul><li>0 running - å½“å‰æ²¡æœ‰çº¿ç¨‹åœ¨è¿è¡Œ</li><li>81 sleeping - 81 ä¸ªçº¿ç¨‹åœ¨ç¡çœ </li><li>0 stopped -stoped çŠ¶æ€çš„çº¿ç¨‹ä¸º 0 ä¸ª</li><li>0 zombie - zombie çŠ¶æ€ï¼ˆåƒµå°¸ï¼‰çš„æœ‰ 0 ä¸ª</li></ul><p><strong>ç¬¬ä¸‰è¡Œ cpu çŠ¶æ€ä¿¡æ¯ï¼š</strong><br>%Cpu0 46.6/30.7 å½“å‰ cpu0 çš„ç”¨æˆ·æ€çº¿ç¨‹å  cpu46.6%ï¼Œå†…æ ¸æ€å  cpu30.7% å¦‚æœåœ¨ pc ä¸Šè¿è¡Œå¯èƒ½æ˜¯å¦‚ä¸‹ä¿¡æ¯</p><p><strong>Cpu(s): 5.9%us, 3.4%sy, 0.0%ni, 90.4%id, 0.0%wa, 0.0%hi, 0.2%si, 0.0%st</strong></p><ul><li>5.9%us&nbsp;â€”&nbsp;ç”¨æˆ·ç©ºé—´å ç”¨ CPU çš„ç™¾åˆ†æ¯”ã€‚</li><li>3.4%&nbsp;sy&nbsp;â€”&nbsp;å†…æ ¸ç©ºé—´å ç”¨ CPU çš„ç™¾åˆ†æ¯”ã€‚</li><li>0.0%&nbsp;ni&nbsp;â€”&nbsp;æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨ CPU çš„ç™¾åˆ†æ¯”</li><li>90.4%&nbsp;id&nbsp;â€”&nbsp;ç©ºé—² CPU ç™¾åˆ†æ¯”</li><li>0.0%&nbsp;wa&nbsp;â€”&nbsp;IO ç­‰å¾…å ç”¨ CPU çš„ç™¾åˆ†æ¯”</li><li>0.0%&nbsp;hi&nbsp;â€”&nbsp;ç¡¬ä¸­æ–­ï¼ˆHardware&nbsp;IRQï¼‰å ç”¨ CPU çš„ç™¾åˆ†æ¯”</li><li>0.2%&nbsp;si&nbsp;â€”&nbsp;è½¯ä¸­æ–­ï¼ˆSoftware&nbsp;Interruptsï¼‰å ç”¨ CPU çš„ç™¾åˆ†æ¯”</li></ul><p><strong>ç¬¬å››è¡Œå†…å­˜çŠ¶æ€ä¿¡æ¯ï¼š</strong><br>GiB Mem : 84.5/0.239 - ç”¨æˆ·æ€å å†…å­˜ 84.5%ï¼Œå†…æ ¸æ€å å†…å­˜ 0.239%</p><p>å¦‚æœæ˜¯ pc ä¸Šå¯èƒ½æ˜¯å¦‚ä¸‹ä¿¡æ¯</p><p><strong>Mem: 32949016k total, 14411180k used, 18537836k free, 169884k buffers</strong></p><ul><li>32949016k&nbsp;total&nbsp;â€”&nbsp;ç‰©ç†å†…å­˜æ€»é‡ï¼ˆ32GBï¼‰</li><li>14411180k&nbsp;used&nbsp;â€”&nbsp;ä½¿ç”¨ä¸­çš„å†…å­˜æ€»é‡ï¼ˆ14GBï¼‰</li><li>18537836k&nbsp;free&nbsp;â€”&nbsp;ç©ºé—²å†…å­˜æ€»é‡ï¼ˆ18GBï¼‰</li><li>169884k&nbsp;buffers&nbsp;â€”&nbsp;ç¼“å­˜çš„å†…å­˜é‡&nbsp;ï¼ˆ169Mï¼‰</li></ul><p><strong>ç¬¬äº”è¡Œ swap äº¤æ¢åˆ†åŒºä¿¡æ¯ï¼š</strong></p><ul><li>GiB Swap: 0.0/0.000 - å½“å‰ç³»ç»Ÿæ²¡æœ‰ä½¿ç”¨äº¤æ¢åˆ†åŒº</li><li>å¦‚æœæ˜¯ pc åˆ™å¯èƒ½æ˜¯å¦‚ä¸‹ä¿¡æ¯</li></ul><p><strong>Swap: 32764556k total, 0k used, 32764556k free, 3612636k cached</strong></p><ul><li>32764556k&nbsp;total&nbsp;â€”&nbsp;äº¤æ¢åŒºæ€»é‡ï¼ˆ32GBï¼‰</li><li>0k&nbsp;used&nbsp;â€”&nbsp;ä½¿ç”¨çš„äº¤æ¢åŒºæ€»é‡ï¼ˆ0Kï¼‰</li><li>32764556k&nbsp;free&nbsp;â€”&nbsp;ç©ºé—²äº¤æ¢åŒºæ€»é‡ï¼ˆ32GBï¼‰</li><li>3612636k&nbsp;cached&nbsp;â€”&nbsp;ç¼“å†²çš„äº¤æ¢åŒºæ€»é‡ï¼ˆ3.6GBï¼‰</li></ul><p><strong>ç¬¬å…­è¡Œç©ºè¡Œï¼š</strong></p><p><strong>ç¬¬ä¸ƒè¡Œå„è¿›ç¨‹æˆ–çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼š</strong></p><ul><li>PID&nbsp;â€”&nbsp;è¿›ç¨‹ id</li><li>USER&nbsp;â€”&nbsp;è¿›ç¨‹æ‰€æœ‰è€…</li><li>PR&nbsp;â€”&nbsp;è¿›ç¨‹ä¼˜å…ˆçº§</li><li>NI&nbsp;â€”&nbsp;nice å€¼ã€‚è´Ÿå€¼è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ï¼Œæ­£å€¼è¡¨ç¤ºä½ä¼˜å…ˆçº§</li><li>VIRT&nbsp;â€”&nbsp;è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜æ€»é‡ï¼Œå•ä½ kbã€‚VIRT=SWAP+RES</li><li>RES&nbsp;â€”&nbsp;è¿›ç¨‹ä½¿ç”¨çš„ã€æœªè¢«æ¢å‡ºçš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½ kbã€‚RES=CODE+DATA</li><li>SHR&nbsp;â€”&nbsp;å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½ kb</li><li>S&nbsp;â€”&nbsp;è¿›ç¨‹çŠ¶æ€ã€‚D=ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€&nbsp;R=è¿è¡Œ&nbsp;S=ç¡çœ &nbsp;T=è·Ÿè¸ª/åœæ­¢&nbsp;Z=åƒµå°¸è¿›ç¨‹</li><li>%CPU&nbsp;â€”&nbsp;ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨çš„ CPU æ—¶é—´å ç”¨ç™¾åˆ†æ¯”</li><li>%MEM&nbsp;â€”&nbsp;è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”</li><li>TIME+&nbsp;â€”&nbsp;è¿›ç¨‹ä½¿ç”¨çš„ CPU æ—¶é—´æ€»è®¡ï¼Œå•ä½ 1/100 ç§’</li><li>COMMAND&nbsp;â€”&nbsp;è¿›ç¨‹åç§°ï¼ˆå‘½ä»¤å/å‘½ä»¤è¡Œï¼‰</li></ul><h2 id="perf-å·¥å…·">perf å·¥å…·</h2><p>æŸ¥çœ‹æ¶ˆè€— cpu æ¯”è¾ƒé«˜çš„å†…æ ¸å‡½æ•°æˆ–è€…è¿›ç¨‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pert top</span><br></pre></td></tr></tbody></table></figure><p>åˆ—å‡º perf æ”¯æŒçš„äº‹ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf list</span><br></pre></td></tr></tbody></table></figure><p>ç»Ÿè®¡ profiling è¿›ç¨‹çš„å„ç§ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf <span class="built_in">stat</span></span><br></pre></td></tr></tbody></table></figure><p>profiling è¿›ç¨‹çš„æ•°æ®ï¼Œç”Ÿæˆ xx.data æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf record</span><br></pre></td></tr></tbody></table></figure><p>è¯»å– xx.data æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf report</span><br></pre></td></tr></tbody></table></figure><h1 id="gdb">GDB</h1><h2 id="æ‰“å‡ºç¨‹åºå´©æºƒçš„è°ƒç”¨æ ˆ">æ‰“å‡ºç¨‹åºå´©æºƒçš„è°ƒç”¨æ ˆ</h2><ul><li><p>é€‰ä¸­ gdb å·¥å…·ï¼š<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig --&gt;</span><br><span class="line">    Development --&gt;</span><br><span class="line">        &lt;*&gt; gdb------------------- GNU Debugger</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>é…ç½® coredumpï¼š<br>ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ç»ˆæ­¢æˆ–å´©æºƒï¼Œæ“ä½œç³»ç»Ÿä¼šä¿å­˜ä¸€ä¸ªæ–‡ä»¶åˆ°æœ¬åœ°ç›®å½•ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ coredump æ–‡ä»¶ï¼Œé€‰ä¸­å·¥å…·ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make kernel menuconfigï¼Œé€‰ä¸­ä»¥ä¸‹é…ç½®ã€‚</span><br><span class="line">Userspace binary formats --&gt;</span><br><span class="line">    [*]Enable core dump support</span><br></pre></td></tr></tbody></table></figure><p></p><p>é…ç½®ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited //å¯¹äº§ç”Ÿçš„ coredump æ–‡ä»¶å¤§å°ä¸åšé™åˆ¶</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/tmp/core-%e-%p-%t"</span> &gt; /proc/sys/kernel/core_pattern //äº§ç”Ÿçš„æ–‡ä»¶å¸¦æœ‰å´©æºƒçš„ç¨‹åºåç§°ä»¥åŠè¿›ç¨‹ <span class="built_in">id</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>è¿è¡Œ app<br>è¿è¡Œ app çš„æ—¶å€™ä¼šåœ¨/tmp ç›®å½•ä¸‹ç”Ÿæˆ corexxxxx æ–‡ä»¶ã€‚</p></li><li><p>è·å–ç¨‹åºå´©æºƒçš„è°ƒç”¨æ ˆ<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb /usr/bin/app /tmp/corexxxx</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç„¶åæ‰§è¡Œ bt å°±ä¼šæ‰“å‡ºå‡½æ•°è°ƒç”¨æ ˆã€‚</p></li></ul><h2 id="å…¶ä»–å‘½ä»¤">å…¶ä»–å‘½ä»¤</h2><p>frameã€xã€infoã€disassemble ...</p><h2 id="äº¤å‰è°ƒè¯•">äº¤å‰è°ƒè¯•</h2><p>æœ‰æ—¶ flash ç©ºé—´å¤§å°ä¸è¶³ä»¥è£…ä¸‹ gdbï¼Œè¿™æ—¶éœ€è¦åœ¨ pc ä¸Šä½¿ç”¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­çš„ gdb è°ƒè¯•ï¼Œè¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç¼–è¯‘å®Œçš„å›ºä»¶ä¿å­˜å¥½ app çš„ bin æ–‡ä»¶ï¼Œå¸¦ç¬¦å·è¡¨çš„é‚£ä¸ª</li><li>å½“åº”ç”¨æŒ‚æ‰åä»æœºå™¨é‡Œå–å‡º core æ–‡ä»¶ï¼Œæ”¾å…¥ pc ä¸Š</li><li>æ‰§è¡Œ arm-xxxx-gdb app core-file</li><li><p>è®¾ç½® sysroot è·¯å¾„ set sysroot /home/workspace/project/out/project/staging_dir/target/rootfs å¾—åˆ°å¦‚ä¸‹ï¼Œè¯´æ˜è®¾ç½®æˆåŠŸï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/lib/libstdc  ++.so.6...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ libasound.so.2...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/libz.    so.1...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ eyesee-mpp/libcdx_base.so...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ eyesee-mpp/libcdx_parser.so...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ eyesee-mpp/libcdx_stream.so...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ eyesee-mpp/libcdx_common.so...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/lib/libgcc_s.    so.1...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/lib/ ld-musl-armhf.so.1...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ts/  input.so...done.</span><br><span class="line">Reading symbols from /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs/usr/lib/ libts.so.0...done.</span><br></pre></td></tr></tbody></table></figure><p></p></li><li>æ‰§è¡Œ bt å‘½ä»¤ï¼Œä¼šæ‰“å‡ºå´©æºƒæ—¶çš„å‡½æ•°è°ƒç”¨æ ˆã€‚</li><li>frame n&nbsp;å‘½ä»¤è¡¨ç¤ºåœ¨ GDB ä¸‹åˆ‡æ¢åˆ°ç¼–å·ä¸º&nbsp;<em>n</em>&nbsp;çš„æ ˆå¸§ (<em>n</em>&nbsp;è¡¨ç¤ºä¸€ä¸ªæ­£æ•´æ•°ï¼‰ã€‚ä¾‹å¦‚ï¼Œframe 4&nbsp;å°†åˆ‡æ¢åˆ°æ ˆçš„ç¬¬ 5 å±‚ã€‚åˆ‡æ¢å®Œåï¼Œå¦‚æœæƒ³æŸ¥çœ‹å½“å‰æ ˆå¸§çš„ç¼–å·ã€å‡½æ•°åã€å‡½æ•°å‚æ•°å€¼ã€å‡½æ•°æ‰€åœ¨æ–‡ä»¶åŠè¡Œå·ã€å‡½æ•°æ‰§è¡Œåˆ°çš„è¯­å¥ç­‰ä¿¡æ¯ï¼Œå¯ç›´æ¥ä½¿ç”¨&nbsp;<code>frame</code>&nbsp;å‘½ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</li><li><p>info å‘½ä»¤æŸ¥çœ‹å½“å‰æ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å‡½æ•°åœ°å€ã€è°ƒç”¨å‡½æ•°çš„åœ°å€ã€è¢«è°ƒç”¨å‡½æ•°çš„åœ°å€ã€å½“å‰å‡½æ•°ç”±å“ªç§ç¼–ç¨‹è¯­è¨€ç¼–å†™ã€å‡½æ•°å‚æ•°åœ°å€åŠå½¢å‚å€¼ã€å±€éƒ¨å˜é‡çš„åœ°å€ç­‰ </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> PATH=/home/user/workspace/sdk/prebuilt/gcc/linux-x86/arm/toolchain-sunxi-musl/    toolchain/bin</span><br><span class="line"><span class="built_in">set</span> sysroot /home/user/workspace/sdk/out/vendor/staging_dir/target/rootfs</span><br></pre></td></tr></tbody></table></figure><p></p></li></ul><h1 id="å†…å­˜æŸ¥çœ‹">å†…å­˜æŸ¥çœ‹</h1><p>å†…å­˜ç¢ç‰‡åŒ–æŸ¥çœ‹å·¥å…·</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/buddyinfo</span><br><span class="line">Node 0, zone   Normal    115    148     72     34      1      0      1      0      1      0      0</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå…¨å¿—SDKæ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Performance </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…å­˜ä¼˜åŒ–</title>
      <link href="/2019/Debug/LinuxMemoryOptimization/"/>
      <url>/2019/Debug/LinuxMemoryOptimization/</url>
      
        <content type="html"><![CDATA[<h1 id="å†…å­˜ä½¿ç”¨æƒ…å†µåˆ†æ">å†…å­˜ä½¿ç”¨æƒ…å†µåˆ†æ</h1><h2 id="dram-å¤§å°">DRAM å¤§å°</h2><p>ç¡¬ä»¶ä¸Š DDR ç¡®å®šä¹‹åï¼Œ DRAM å¤§å°å°±å·²ç»ç¡®å®šã€‚</p><p>uboot ä¼šæ ¹æ® DRAM é©±åŠ¨æä¾›çš„æ¥å£è·å– DRAM çš„å¤§å°ï¼Œç„¶åä¿®æ”¹ dts ä¸­çš„ memory èŠ‚ç‚¹ï¼ŒLinux å¯åŠ¨æ—¶è§£æ dts è·å– DRAM çš„å¤§å°ã€‚ uboot å¯åŠ¨ log ä¸­ä¼šæ‰“å° dram çš„å¤§å°ã€‚æ¯”å¦‚ R329 æ–¹æ¡ˆ uboot å¯åŠ¨æ—¶ä¼šæœ‰å¦‚ä¸‹ logï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[01.300]DRAM: 128 MiB</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># hexdump -C /sys/firmware/devicetree/base/memory@40000000/reg</span></span><br><span class="line">00000000 00 00 00 00 40 00 00 00 00 00 00 00 08 00 00 00 |....@...........|</span><br><span class="line">00000010</span><br></pre></td></tr></tbody></table></figure><p></p><p>ä¹Ÿå¯ä»¥è·å– dram çš„èµ·å§‹åœ°å€ä¸å¤§å°ã€‚å¦‚ä¸‹é¢ R329 ä¾‹å­æ‰€ç¤ºï¼Œå…¶ä¸­ 0x40000000 ä¸ºèµ·å§‹åœ°å€ï¼Œ 0x08000000 ä¸º dram çš„ size.</p><span id="more"></span><h2 id="ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ">ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ</h2><h3 id="free-å‘½ä»¤">free å‘½ä»¤</h3><p>è¿›å…¥ Linux ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œ free å‘½ä»¤å¯è·å¾—å½“å‰ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚æ¯”å¦‚ R329 æ–¹æ¡ˆï¼ŒæŸæ¬¡æ‰§è¡Œ free å‘½ä»¤çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># free</span></span><br><span class="line">total used free shared buffers cached</span><br><span class="line">Mem: 110592 79960 30632 36 9172 22860</span><br><span class="line">-/+ buffers/cache: 47928 62664</span><br><span class="line">Swap: 0 0 0</span><br></pre></td></tr></tbody></table></figure><p>free å‘½ä»¤è¾“å‡ºè¯´æ˜å¦‚ä¸‹ï¼š</p><h4 id="ç¬¬ä¸€è¡Œ-memå½“å‰ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µ">ç¬¬ä¸€è¡Œ Memï¼Œå½“å‰ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µ</h4><ul><li>totalï¼š Linux å†…æ ¸å¯æ”¯é…çš„å†…å­˜</li><li>usedï¼šç³»ç»Ÿå·²ä½¿ç”¨çš„å†…å­˜</li><li>freeï¼šç³»ç»Ÿå°šæœªä½¿ç”¨çš„å†…å­˜</li><li>sharedï¼šå…±äº«å†…å­˜ä»¥åŠ tmpfsã€ devtmpfs æ‰€å ç”¨çš„å†…å­˜ã€‚å…±äº«å†…å­˜æŒ‡ä½¿ç”¨ shmgetã€shm_openã€ mmap ç­‰æ¥å£åˆ›å»ºçš„å…±äº«å†…å­˜</li><li>buffersï¼š Buffers è¡¨ç¤ºå—è®¾å¤‡ block device æ‰€å ç”¨çš„ç¼“å­˜é¡µï¼ŒåŒ…æ‹¬ç›´æ¥è¯»å†™å—è®¾å¤‡ã€ä»¥åŠæ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ® metadata ç­‰</li><li>cachedï¼š Cache é‡ŒåŒ…æ‹¬æ‰€æœ‰ä¸æ–‡ä»¶å¯¹åº”çš„å†…å­˜é¡µã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶ä¸å†ä¸è¿›ç¨‹å…³è”ï¼Œè¯¥æ–‡ä»¶ä¸ä¼šç«‹å³å›æ”¶ï¼Œæ­¤æ—¶ä»ç„¶åŒ…å«åœ¨ Cached ä¸­ï¼›æ­¤å¤–ï¼Œ Cached ä¸­è¿˜åŒ…å« tmpfs ä¸­çš„æ–‡ä»¶ä»¥åŠ shmem ç­‰</li></ul><h4 id="ç¬¬äºŒè¡Œ">ç¬¬äºŒè¡Œ</h4><p>-/+ buffers/cacheï¼Œå‡å·è¡¨ç¤ºç¬¬ä¸€è¡Œ used å†…å­˜å‡å» buffers ä¸ cached å†…å­˜ï¼Œå³ Mem_used - Mem_buffers - Mem_cachedï¼› åŠ å·è¡¨ç¤ºç¬¬ä¸€è¡Œ free å†…å­˜åŠ ä¸Š buffers ä¸ cached å†…å­˜ï¼Œå³ Mem_free + Mem_buffers + Mem_cachedã€‚ä»åº”ç”¨ç¨‹åºçš„è§’åº¦çœ‹ï¼Œ buffers å’Œ cached æ˜¯æ½œåœ¨å¯ç”¨çš„å†…å­˜ã€‚</p><h4 id="ç¬¬ä¸‰è¡Œ-swapäº¤æ¢åˆ†åŒºçš„ä½¿ç”¨æƒ…å†µ">ç¬¬ä¸‰è¡Œ Swapï¼Œäº¤æ¢åˆ†åŒºçš„ä½¿ç”¨æƒ…å†µ</h4><p>Tina äº§å“ä¸Šä½¿ç”¨ flash ä½œä¸ºå­˜å‚¨å™¨ï¼Œè¯»å†™æ¬¡æ•°æ˜¯æœ‰é™çš„ï¼Œè€Œ swap åˆ†åŒºç‰¹ç‚¹æ˜¯ä¼šè¢«é¢‘ç¹åœ°è¯»å†™ï¼Œå¯¼è‡´ flash å¯¿å‘½å˜çŸ­ï¼Œå› æ­¤ tina ä¸Šæ²¡æœ‰åˆ›å»º swap åˆ†åŒºã€‚</p><ul><li>total: äº¤æ¢åˆ†åŒºæ€»å¤§å°</li><li>used: å·²ä½¿ç”¨çš„äº¤æ¢åˆ†åŒºå¤§å°</li><li>free: ç©ºé—²çš„äº¤æ¢åˆ†åŒºå¤§å°</li></ul><h3 id="procmeminfo-èŠ‚ç‚¹">/proc/meminfo èŠ‚ç‚¹</h3><p>å®é™…ä¸Š free å‘½ä»¤ä¿¡æ¯æ¥æºæ˜¯ä»/proc/meminfo èŠ‚ç‚¹ã€‚æ¯”å¦‚ R329 æ–¹æ¡ˆï¼ŒæŸæ¬¡æ‰§è¡Œ cat /proc/meminfo å‘½ä»¤çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># cat /proc/meminfo</span></span><br><span class="line">MemTotal: 110592 kB</span><br><span class="line">MemFree: 30380 kB</span><br><span class="line">MemAvailable: 62044 kB</span><br><span class="line">Buffers: 9276 kB</span><br><span class="line">Cached: 22872 kB</span><br><span class="line">SwapCached: 0 kB</span><br><span class="line">Active: 17580 kB</span><br><span class="line">Inactive: 16336 kB</span><br><span class="line">Active(anon): 1780 kB</span><br><span class="line">Inactive(anon): 24 kB</span><br><span class="line">Active(file): 15800 kB</span><br><span class="line">Inactive(file): 16312 kB</span><br><span class="line">Unevictable: 0 kB</span><br><span class="line">Mlocked: 0 kB</span><br><span class="line">SwapTotal: 0 kB</span><br><span class="line">SwapFree: 0 kB</span><br><span class="line">Dirty: 0 kB</span><br><span class="line">Writeback: 0 kB</span><br><span class="line">AnonPages: 1800 kB</span><br><span class="line">Mapped: 3324 kB</span><br><span class="line">Shmem: 36 kB</span><br><span class="line">Slab: 13536 kB</span><br><span class="line">SReclaimable: 4224 kB</span><br><span class="line">SUnreclaim: 9312 kB</span><br><span class="line">KernelStack: 1232 kB</span><br><span class="line">PageTables: 200 kB</span><br><span class="line">NFS_Unstable: 0 kB</span><br><span class="line">Bounce: 0 kB</span><br><span class="line">WritebackTmp: 0 kB</span><br><span class="line">CommitLimit: 55296 kB</span><br><span class="line">Committed_AS: 29116 kB</span><br><span class="line">VmallocTotal: 263061440 kB</span><br><span class="line">VmallocUsed: 0 kB</span><br><span class="line">VmallocChunk: 0 kB</span><br><span class="line">CmaTotal: 24576 kB</span><br><span class="line">CmaFree: 2684 kB</span><br></pre></td></tr></tbody></table></figure><p>ç›¸å…³è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li>MemTotalã€ MemFreeã€ Buffersã€ Cachedã€ Shmemï¼Œå³ free å‘½ä»¤ç¬¬ä¸€è¡Œã€‚</li><li>MemAvailableï¼šä½¿ç”¨ MemFree, Active(file), Inactive(file), SReclaimable å’Œ/proc/zoneinfo ä¸­çš„ low watermark æ ¹æ®ç‰¹å®šç®—æ³•è®¡ç®—å¾—å‡ºï¼Œæ˜¯ä¸€ä¸ªä¼°å€¼ï¼Œå¹¶ä¸ç²¾ç¡®ã€‚å¯ç”¨æ¥è¯„ä¼°åº”ç”¨ç¨‹åºå±‚é¢å¯ç”¨çš„å†…å­˜ã€‚</li><li>Active/Inactiveï¼š Active è¡¨ç¤ºæœ€è¿‘ä½¿ç”¨çš„å†…å­˜ï¼Œå›æ”¶çš„ä¼˜å…ˆçº§ä½ï¼› Inactive è¡¨ç¤ºæœ€è¿‘è¾ƒå°‘ä½¿ç”¨çš„å†…å­˜ï¼Œå›æ”¶çš„ä¼˜å…ˆçº§é«˜ã€‚å¯ç»†åˆ†ä¸º Active/Inactive åŒ¿åé¡µä¸æ–‡ä»¶é¡µã€‚æ‰€è°“æ–‡ä»¶é¡µï¼Œå°±æ˜¯ä¸æ–‡ä»¶å¯¹åº”çš„å†…å­˜é¡µï¼Œå¦‚è¿›ç¨‹çš„ä»£ç ã€æ˜ å°„çš„æ–‡ä»¶éƒ½å±äºæ–‡ä»¶é¡µï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œè¿™éƒ¨åˆ†çš„å†…å­˜å¯ä»¥å†™å›åˆ°å­˜å‚¨å™¨ä¸­ï¼›ä¸ä¹‹å¯¹åº”çš„å°±å±äºåŒ¿åé¡µï¼Œå³æ²¡æœ‰ä¸å…·ä½“æ–‡ä»¶å¯¹åº”çš„é¡µï¼Œå¦‚è¿›ç¨‹çš„å †æ ˆç­‰ï¼Œå†…å­˜ä¸è¶³æ—¶ï¼Œå¦‚æœå­˜åœ¨ swap åˆ†åŒºï¼Œå¯ä»¥å°†åŒ¿åé¡µå†™å…¥åˆ°äº¤æ¢åˆ†åŒºï¼Œå¦‚æœæ²¡æœ‰ swap åˆ†åŒºï¼Œåˆ™åªèƒ½å¸¸é©»å†…å­˜ä¸­ã€‚</li><li>AnonPagesï¼šåŒ¿åé¡µã€‚</li><li>Mappedï¼šè®¾å¤‡æˆ–æ–‡ä»¶æ˜ å°„çš„å¤§å°ã€‚æ¯”å¦‚å…±äº«å†…å­˜ã€åŠ¨æ€åº“ã€ mmap çš„æ–‡ä»¶ç­‰éƒ½ç»Ÿè®¡åœ¨è¯¥å†…å­˜ä¸­ã€‚</li><li>slab/SReclaimable/SUnreclaimï¼šå†…æ ¸ slab ä½¿ç”¨çš„å†…å­˜ï¼ŒåŒ…å«å¯å›æ”¶ä¸ä¸å¯å›æ”¶éƒ¨åˆ†ã€‚</li><li>KernelStackï¼šå†…æ ¸æ ˆå¤§å°ã€‚</li><li>PageTablesï¼šé¡µè¡¨çš„å¤§å°ï¼ˆç”¨äºå°†è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ï¼‰ï¼Œå†…å­˜åˆ†é…è¶Šå¤šï¼Œæ­¤å—å†…å­˜å°±ä¼šå¢å¤§ã€‚</li><li>CommitLimit/Committed_ASï¼š overcommit çš„é˜ˆå€¼/å·²ç»ç”³è¯·çš„å†…å­˜å¤§å°ï¼ˆä¸æ˜¯å·²åˆ†é…ï¼‰ã€‚ Overcommit æ˜¯ Linux ä¸€ç§å†…å­˜ç”³è¯·å¤„ç†æ–¹å¼ï¼Œä¸ºäº†è·‘æ›´å¤šæ›´å¤§çš„ç¨‹åºï¼Œå¤§éƒ¨åˆ†ç”³è¯·å†…å­˜çš„è¯·æ±‚éƒ½å›å¤ â€œyesâ€ï¼Œæ€»ç”³è¯·çš„å†…å­˜å¤§äºæ€»ç‰©ç†å†…å­˜ã€‚</li><li>VmallocTotal/VmallocUsed/VmallocChunkï¼š vmalloc åŒº åŸŸ å¤§ å°/vmalloc åŒº åŸŸ ä½¿ ç”¨å¤§å°/vmalloc åŒºåŸŸä¸­æœ€å¤§å¯ç”¨çš„è¿ç»­åŒºå—å¤§å°ã€‚è¿™éƒ¨åˆ†åœ¨æ–°ç‰ˆæœ¬å†…æ ¸ä¸Šç§»é™¤äº†ã€‚</li><li>CmaTotal/CmaFreeï¼šæ€» CMA å†…å­˜/ç©ºé—² CMA å†…å­˜ã€‚</li></ul><h2 id="ä¿ç•™å†…å­˜">ä¿ç•™å†…å­˜</h2><p>R329 DRAM å¤§å°ä¸º 128Mï¼Œè€Œ free å‘½ä»¤ä¸­æ˜¾ç¤ºç³»ç»Ÿå¯æ”¯é…æ€»å†…å­˜åªæœ‰ 110592KB=108Mï¼Œä¸ºä»€ä¹ˆï¼Ÿ è¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šä¿ç•™å†…å­˜ï¼ˆReserved Memoryï¼‰ã€‚ä¿ç•™å†…å­˜æ˜¯æŒ‡æŠŠç³»ç»Ÿä¸­çš„ä¸€éƒ¨åˆ†å†…å­˜ä¿ç•™èµ·æ¥ç”¨ä½œç‰¹æ®Šç”¨é€”ï¼Œè¿™éƒ¨åˆ†å†…å­˜é€šå¸¸ä¸ä¼šè¢«é‡Šæ”¾ï¼Œä¹Ÿä¸ä¼šè¢«è½¬ç§»åˆ°äº¤æ¢åˆ†åŒºã€‚</p><p>è¿›å…¥æ§åˆ¶å°ï¼Œæ‰§è¡Œ cat /sys/kernel/debug/memblock/reserved å¯ä»¥æŸ¥çœ‹ reserved memory ä½¿ç”¨æƒ…å†µï¼šå½“å‰ R329 reserved memory ä½¿ç”¨æƒ…å†µå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># cat /sys/kernel/debug/memblock/reserved</span></span><br><span class="line">0: 0x0000000040080000..0x00000000408a3fff, size:8336K</span><br><span class="line">1: 0x00000000408a5000..0x00000000408a5fff, size:4K</span><br><span class="line">2: 0x0000000041700000..0x000000004171767f, size:93K</span><br><span class="line">3: 0x0000000041800000..0x00000000420fffff, size:9216K</span><br><span class="line">4: 0x0000000045000000..0x00000000467fffff, size:24576K</span><br><span class="line">5: 0x0000000046d86000..0x0000000046f85fff, size:2048K</span><br><span class="line">6: 0x0000000047f29e00..0x0000000047f59e5f, size:192K</span><br><span class="line">7: 0x0000000047f59e80..0x0000000047f59edf, size:0K</span><br><span class="line">8: 0x0000000047f59f00..0x0000000047f8400f, size:168K</span><br><span class="line">9: 0x0000000047f84080..0x0000000047f84087, size:0K</span><br><span class="line">10: 0x0000000047f84100..0x0000000047f84107, size:0K</span><br><span class="line">11: 0x0000000047f85180..0x0000000047fff2e6, size:488K</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>åœ¨å†…æ ¸ cmdline åŠ ä¸Š memblock=debug bootmem_debug=1 å‚æ•°ï¼Œåœ¨å†…æ ¸å¯åŠ¨æ—¶ï¼Œä¼šæ‰“å°ä¸Šè¿° reserved memory è¯¦ç»†ä¿¡æ¯ã€‚ç”±äºå†…å®¹å¤ªå¤šï¼Œè¿™é‡Œä¸å±•ç¤ºäº†ã€‚</p><p>ç»åˆ†æå¯¹æ¯”ï¼Œå½“å‰ R329 reserved memory ä¸»è¦åŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>0: 0x0000000040080000..0x00000000408a3fff, size:8336K<br>å†…æ ¸ä»£ç æ®µã€æ•°æ®æ®µã€‚è¯¦ç»†åŒ…æ‹¬ textï¼Œ initï¼Œ dataï¼Œ bss å››æ®µï¼Œå…¶ä¸­ init åœ¨å†…æ ¸å¯åŠ¨å®Œæˆåä¼šè¢«é‡Šæ”¾ã€‚</p></li><li><p>1: 0x00000000408a5000..0x00000000408a5fff, size:4K<br>ç•¥</p></li><li><p>2: 0x0000000041700000..0x000000004171767f, size:93K<br>DTB å ç”¨å†…å­˜</p></li><li><p>3: 0x0000000041800000..0x00000000420fffff, size:9216K<br>TEE å†…å­˜ï¼ˆå…± 8Mï¼ŒåŒ…æ‹¬ SHM 2Mï¼Œ ATF 1Mï¼Œ OS 1Mï¼Œ TA 4Mï¼‰ã€‚DSP å†…å­˜ï¼ˆå…± 1Mï¼‰ã€‚</p></li><li><p>4: 0x0000000045000000..0x00000000467fffff, size:24576K<br>CMA å†…å­˜ï¼Œå…± 24Mï¼Œåœ¨ cmdline ä¸­é€šè¿‡ cma=24M é…ç½®è€Œæ¥ã€‚åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œ CMA å†…å­˜ä¼šå…¨éƒ¨å¯¼å…¥ä¼™ä¼´ç³»ç»Ÿï¼ˆå…·ä½“æ˜¯é€šè¿‡ cma_init_reserved_areas å‡½æ•°æ¥å®ç°ï¼‰ï¼Œæ‰€ä»¥å†…æ ¸æ˜¯å¯ä»¥æ”¯é… CMA å†…å­˜çš„</p></li><li><p>5: 0x0000000046d86000..0x0000000046f85fff, size:2048K<br>æ‰€æœ‰ struct page ç»“æ„ä½“çš„æ€»å¤§å°ã€‚ struct page ç»“æ„ä½“ç”¨æ¥æè¿°ç‰©ç†ä¸Šçš„é¡µå¸§ã€‚å½“å‰ R329 ä¸Šé…ç½®ä¸€ä¸ªé¡µçš„å¤§å°ä¸º 4Kï¼Œå› æ­¤æ€»å…±æœ‰ 128M / 4K = 32768 ä¸ªé¡µï¼Œè€Œ sizeof(struct page) çš„å€¼ä¸º 64Bï¼Œå› æ­¤è¿™ä¸€å—å…± 32768 * 64 = 2048 KBã€‚æ³¨ï¼š aarch64 å†…æ ¸ sizeof(struct page) çš„å€¼ä¸º 64Bï¼Œ arm32 å†…æ ¸ sizeof(struct page) çš„å€¼ä¸º 32Bã€‚</p></li><li><p>6: 0x0000000047f29e00..0x0000000047f59e5f, size:192K<br>ä¸»è¦æ˜¯ vfs cacheï¼ŒåŒ…æ‹¬ Dentry å’Œ Inode çš„ hash tableï¼Œå­˜æ”¾æœ€è¿‘è®¿é—®çš„ Dentry å’Œ Inode èŠ‚ç‚¹ï¼ŒåŠ é€Ÿå¯¹è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ã€‚</p></li><li><p>8: 0x0000000047f59f00..0x0000000047f8400f, size:168K<br>ä¸»è¦æ˜¯ per-cpu å˜é‡å ç”¨çš„å†…å­˜ã€‚</p></li><li><p>11: 0x0000000047f85180..0x0000000047fff2e6, size:488K<br>ä¸»è¦æ˜¯è§£æ dtb ç”Ÿæˆ struct device_node ç»“æ„ä½“æ‰€ç”¨çš„å†…å­˜ã€‚</p></li></ul><h2 id="buffers-cached">buffers &amp; cached</h2><p>free å‘½ä»¤ç¬¬äºŒè¡Œä¸ºä»€ä¹ˆè¦-/+ buffers/cacheï¼Ÿ buffers ä¸ cached å†…å­˜éƒ½å±äºç©ºé—²å†…å­˜ä¹ˆï¼Ÿ</p><p>Linux ä¸ºåŠ é€Ÿ IO è®¿é—®é€Ÿåº¦ï¼Œä¼šä½¿ç”¨ç©ºé—²å†…å­˜æ¥ç¼“å­˜æ–‡ä»¶ä»¥åŠå…ƒæ•°æ®ç­‰å†…å®¹ï¼Œè¿™å°±æ˜¯ buffers å’Œ cached å†…å­˜ã€‚å½“å†…å­˜ä¸è¶³æ—¶ï¼Œè¿™äº›å†…å­˜ä¼šè¢«å›æ”¶ï¼Œä¾›å†…æ ¸ä¸åº”ç”¨ä½¿ç”¨ã€‚æ‰€ä»¥ buffer ä¸ cache å®é™…ä¸Šæ˜¯å·²ç»ä½¿ç”¨äº†çš„å†…å­˜ï¼Œç”±äºå¯ä»¥å›æ”¶ï¼Œå±äºæ½œåœ¨çš„ç©ºé—²å†…å­˜ã€‚ä½†æ˜¯å¹¶éæ‰€æœ‰çš„ buffer å’Œ cache éƒ½å¯ä»¥å›æ”¶ï¼Œæ¯”å¦‚ï¼š</p><ul><li>å¦‚æœæœ‰æŸä¸ªè¿›ç¨‹è®¿é—®å—è®¾å¤‡æˆ–è€…æ™®é€šæ–‡ä»¶ï¼Œå°±éœ€è¦ buffers å’Œ cached ç©ºé—´ï¼Œè¿™éƒ¨åˆ†å°±ä¸èƒ½é‡Šæ”¾ã€‚</li><li>sharedã€ tmpfs ä¹ŸåŒ…å«åœ¨ cached ç©ºé—´ä¸­ã€‚</li></ul><h2 id="ç³»ç»Ÿä½¿ç”¨çš„å†…å­˜">ç³»ç»Ÿä½¿ç”¨çš„å†…å­˜</h2><p>free å‘½ä»¤çš„ç»“æœå±•ç¤ºç³»ç»Ÿå·²ç»ä½¿ç”¨äº† 47928KB çš„å†…å­˜ï¼Œéƒ½ç”¨åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿ</p><h3 id="è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜">è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜</h3><p>æ–°å¢ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨äº†å“ªäº›å†…å­˜ï¼Ÿ é¦–å…ˆï¼Œè®¿é—®æ–‡ä»¶ç³»ç»ŸåŠ è½½è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€åº“ç­‰ï¼Œå¯¼è‡´ buffer/cache å¢å¤§ï¼›å…¶æ¬¡ï¼Œè¿›ç¨‹æœ¬èº«åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œæ—¶éœ€è¦æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ä¿¡æ¯ï¼ˆç”¨ mm_struct ç»“æ„ä½“æ¥è¡¨ç¤ºï¼ŒåŒ…å«ä»£ç æ®µã€æ•°æ®æ®µã€ç”¨æˆ·æ ˆç­‰åœ°å€ç©ºé—´æè¿°ï¼‰ï¼›å†æ¬¡ï¼Œå†…æ ¸ä¼šä¸ºè¿›ç¨‹åˆ›å»ºè¿›ç¨‹æè¿°ç¬¦ï¼ˆtask_structï¼‰ã€å†…å­˜æè¿°ç¬¦ï¼ˆmm_structï¼‰ç­‰ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†è¿›ç¨‹ï¼›æ­¤å¤–ï¼Œè¿›ç¨‹è¿˜æœ‰å¯¹åº”çš„å†…æ ¸æ ˆï¼Œå½“è¿›ç¨‹é™·å…¥å†…æ ¸æ—¶éœ€è¦å†…æ ¸æ ˆæ¥æ”¯æŒå†…æ ¸å‡½æ•°è°ƒç”¨ç­‰ç­‰ã€‚ æˆ‘ä»¬å¸¸è¯´çš„è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜ï¼ŒæŒ‡çš„æ˜¯åœ¨ç”¨æˆ·ç©ºé—´æ‰€ä½¿ç”¨çš„å†…å­˜ã€‚ å…³äºç”¨æˆ·è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨ï¼Œæ¶‰åŠå‡ ä¸ªé€šç”¨æ¦‚å¿µï¼š</p><ul><li>VSSï¼š Virtual Set Size ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼ˆåŒ…å«å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰</li><li>RSSï¼š Resident Set Size å®é™…ä½¿ç”¨ç‰©ç†å†…å­˜ï¼ˆåŒ…å«å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰</li><li>PSSï¼š Proportional Set Size å®é™…ä½¿ç”¨çš„ç‰©ç†å†…å­˜ï¼ˆæ¯”ä¾‹åˆ†é…å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰</li><li>USSï¼š Unique Set Size è¿›ç¨‹ç‹¬è‡ªå ç”¨çš„ç‰©ç†å†…å­˜ï¼ˆä¸åŒ…å«å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼š VSS &gt;= RSS &gt;= PSS &gt;= USS</p><p>åœ¨/proc/<pid>/smaps èŠ‚ç‚¹ä¸­åŒ…å«äº†è¿›ç¨‹çš„æ¯ä¸€ä¸ªå†…å­˜æ˜ å°„çš„ç»Ÿè®¡å€¼ï¼ŒåŒ…å«äº† PSSã€ RSS ç­‰ä¿¡æ¯ã€‚ æ‰€ä»¥å¯¹/proc/<pid>/smaps èŠ‚ç‚¹ä¸­æ‰€æœ‰çš„ PSS è¿›è¡Œç´¯åŠ ï¼Œå³å¯ç»Ÿè®¡å‡ºæ‰€æœ‰è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´æ‰€ä½¿ç”¨çš„å†…å­˜ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</pid></pid></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep ^Pss /proc/[0-9]*/smaps | awk <span class="string">'{total+=$2}; END {print total}'</span></span><br></pre></td></tr></tbody></table></figure><p>æŸ¥çœ‹ rss ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/`pidof ***app`/status | grep RSS</span><br></pre></td></tr></tbody></table></figure><p>æ­¤å¤–è¿˜æœ‰ ramparser ç»Ÿè®¡å·¥å…·ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Tina:/proc/684<span class="comment">#  ramparser -a | grep Total</span></span><br><span class="line">Mem      Total = 256 Mb   (Free 7.39 Mb, Available 7.75 Mb)</span><br><span class="line">Mem Used Total = 235.96 Mb</span><br><span class="line">Mem Used Total = Kernel used total(21.21Mb) + pss total(100.72Mb) +</span><br></pre></td></tr></tbody></table></figure><h3 id="æ€»ä½¿ç”¨å†…å­˜">æ€»ä½¿ç”¨å†…å­˜</h3><p>å•ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¶‰åŠåˆ°äº†å¾ˆå¤šç§ç±»çš„å†…å­˜ä½¿ç”¨ï¼Œå®Œå…¨ç»Ÿè®¡èµ·æ¥ä¸å¤ªç°å®ã€‚ä¸ºç»Ÿè®¡ç³»ç»Ÿæ€»ä½¿ç”¨å†…å­˜ï¼Œå¯å°†å…¶åˆ’åˆ†ä¸ºç”¨æˆ·ç©ºé—´ä½¿ç”¨å†…å­˜ä¸å†…æ ¸ä½¿ç”¨å†…å­˜ã€‚ ç”¨æˆ·ç©ºé—´ä½¿ç”¨çš„å†…å­˜ = Buffers + Cached + AnonPagesã€‚ å†…æ ¸ä½¿ç”¨çš„å†…å­˜ = Slab + PageTable + KernelStack + CmaUsed + Vmalloc + Xã€‚</p><p>å…¶ä¸­ï¼Œ</p><ul><li>CmaUsed = CmaTotal - CmaFreeã€‚</li><li>Vmalloc è¡¨ç¤º/proc/vmallocinfo ä¸­çš„ vmalloc åˆ†é…çš„å†…å­˜ï¼ŒåŒ…å«äº†å†…æ ¸æ¨¡å—ä½¿ç”¨çš„å†…å­˜ã€‚è®¡ç®—æ–¹æ³•ä¸º grep vmalloc /proc/vmallocinfo | awk '{total+=$2}; END {print total}'ã€‚</li><li>X è¡¨ç¤ºç›´æ¥é€šè¿‡ alloc_pages/get_free_page åˆ†é…çš„å†…å­˜ï¼Œè¿™éƒ¨åˆ†å†…å­˜æœªçº³å…¥ç»Ÿè®¡ï¼Œå±äºå†…å­˜é»‘æ´ã€‚</li></ul><h1 id="å†…å­˜ä¼˜åŒ–">å†…å­˜ä¼˜åŒ–</h1><p>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>ä¿ç•™å†…å­˜ä¼˜åŒ–</li><li>å†…æ ¸ä½¿ç”¨å†…å­˜ä¼˜åŒ–</li><li>ç”¨æˆ·ç©ºé—´ä½¿ç”¨å†…å­˜ä¼˜åŒ–</li></ul><h2 id="ä¿ç•™å†…å­˜ä¼˜åŒ–">ä¿ç•™å†…å­˜ä¼˜åŒ–</h2><h3 id="å†…æ ¸é™æ€å†…å­˜ä¼˜åŒ–">å†…æ ¸é™æ€å†…å­˜ä¼˜åŒ–</h3><p>å†…æ ¸é™æ€å†…å­˜åŒ…æ‹¬å†…æ ¸ä»£ç æ®µæ•°æ®æ®µã€‚ä¼˜åŒ–æ–¹æ³•ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§ï¼š å…³é—­ä¸éœ€è¦çš„æ¨¡å—ï¼Œå…³é—­æ¨¡å—ä¸‹ä¸éœ€è¦çš„åŠŸèƒ½</p><ul><li><p>åœ¨å†…æ ¸æ ¹ç›®å½•ï¼Œæ‰§è¡Œã€‚/scripts/ksize vmlinux å„ä¸ªæ¨¡å—çš„ä»£ç æ®µæ•°æ®æ®µçš„ç»Ÿè®¡ä¿¡æ¯ï¼š </p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">Linux Kernel (vmlinux)                                      total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">vmlinux                                                   6471329 |    4315221    2013884     142224</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers                                                   2899612 |    2032098     819710      47804</span><br><span class="line">net                                                        753530 |     721792      23658       8080</span><br><span class="line">fs                                                         664960 |     642997       3151      18812</span><br><span class="line">kernel                                                     543470 |     467211      34187      42072</span><br><span class="line">mm                                                         314765 |     288517       6932      19316</span><br><span class="line">crypto                                                     254117 |     196774      57271         72</span><br><span class="line">sound                                                      193477 |     188029       3852       1596</span><br><span class="line">lib                                                        156575 |     154010        236       2329</span><br><span class="line">block                                                      151072 |     147441       2399       1232</span><br><span class="line">ipc                                                         30522 |      29794        724          4</span><br><span class="line">init                                                        25199 |      10990      14145         64</span><br><span class="line">security                                                     4780 |       4756          8         16</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                       5992079 |    4884409     966273     141397</span><br><span class="line">delta                                                      479250 |    -569188    1047611        827</span><br><span class="line"></span><br><span class="line">drivers                                                     total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers/built-in.o                                        2899612 |    2032098     819710      47804</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers/video                                             1012684 |     244524     739328      28832</span><br><span class="line">drivers/usb                                                247516 |     235586       8306       3624</span><br><span class="line">drivers/mtd                                                180132 |     171969       5455       2708</span><br><span class="line">drivers/media                                              171917 |     167120       3313       1484</span><br><span class="line">drivers/base                                               168782 |     164886       3264        632</span><br><span class="line">drivers/mmc                                                150962 |     149050       1716        196</span><br><span class="line">drivers/tty                                                 92952 |      89978       1070       1904</span><br><span class="line">drivers/clk                                                 71921 |      55673      15584        664</span><br><span class="line">drivers/hid                                                 69921 |      66181       3728         12</span><br><span class="line">drivers/regulator                                           60558 |      58806       1612        140</span><br><span class="line">drivers/char                                                59195 |      54555       3640       1000</span><br><span class="line">drivers/input                                               57220 |      54728       2348        144</span><br><span class="line">drivers/pinctrl                                             56336 |      49295       6957         84</span><br><span class="line">drivers/spi                                                 46753 |      45264       1485          4</span><br><span class="line">drivers/cpufreq                                             46675 |      41339       1088       4248</span><br><span class="line">drivers/i2c                                                 46201 |      45552        597         52</span><br><span class="line">drivers/of                                                  36229 |      35370        371        488</span><br><span class="line">drivers/thermal                                             30927 |      28822       2029         76</span><br><span class="line">drivers/gpio                                                30829 |      30392        404         33</span><br><span class="line">drivers/staging                                             27577 |      27104        449         24</span><br><span class="line">drivers/power                                               24587 |      22547       1708        332</span><br><span class="line">drivers/iommu                                               23637 |      23029        544         64</span><br><span class="line">drivers/rtc                                                 21690 |      21150        384        156</span><br><span class="line">drivers/mfd                                                 21408 |      14180       7220          8</span><br><span class="line">drivers/iio                                                 18761 |      18545        160         56</span><br><span class="line">drivers/dma                                                 18404 |      17998        310         96</span><br><span class="line">drivers/pwm                                                 17398 |      16766        456        176</span><br><span class="line">drivers/irqchip                                             15919 |      13483       2340         96</span><br><span class="line">drivers/dma-buf                                             14119 |      14064         23         32</span><br><span class="line">drivers/soc                                                 12843 |      11375       1332        136</span><br><span class="line">drivers/watchdog                                            10668 |      10174        449         45</span><br><span class="line">drivers/clocksource                                          9076 |       8380        592        104</span><br><span class="line">drivers/bus                                                  6536 |       5762        738         36</span><br><span class="line">drivers/hwmon                                                5226 |       5054        144         28</span><br><span class="line">drivers/misc                                                 4730 |       4358        360         12</span><br><span class="line">drivers/reset                                                3838 |       3718        120          0</span><br><span class="line">drivers/firmware                                             3587 |       3527          4         56</span><br><span class="line">drivers/net                                                  1479 |       1431         48          0</span><br><span class="line">drivers/mpp                                                   350 |        334          8          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                       2899543 |    2032069     819684      47790</span><br><span class="line">delta                                                          69 |         29         26         14</span><br><span class="line"></span><br><span class="line">net                                                         total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">net/built-in.o                                             753530 |     721792      23658       8080</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">net/ipv4                                                   343777 |     327407      12726       3644</span><br><span class="line">net/core                                                   231660 |     222656       7276       1728</span><br><span class="line">net/xfrm                                                    50407 |      48727       1292        388</span><br><span class="line">net/unix                                                    27015 |      24614        344       2057</span><br><span class="line">net/packet                                                  26639 |      26370        269          0</span><br><span class="line">net/netlink                                                 25701 |      25138        423        140</span><br><span class="line">net/key                                                     20676 |      20372        300          4</span><br><span class="line">net/*.o                                                     15735 |      15307        376         52</span><br><span class="line">net/sched                                                    8093 |       7528        565          0</span><br><span class="line">net/ethernet                                                 2443 |       2403         40          0</span><br><span class="line">net/ipv6                                                     1263 |       1227         28          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        753409 |     721749      23639       8021</span><br><span class="line">delta                                                         121 |         43         19         59</span><br><span class="line"></span><br><span class="line">fs                                                          total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">fs/built-in.o                                              664960 |     642997       3151      18812</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">fs/*.o                                                     351463 |     339657       1550      10256</span><br><span class="line">fs/proc                                                     83517 |      78968        361       4188</span><br><span class="line">fs/jffs2                                                    79570 |      79278        136        156</span><br><span class="line">fs/fat                                                      51402 |      51230        144         28</span><br><span class="line">fs/kernfs                                                   21130 |      16955         75       4100</span><br><span class="line">fs/configfs                                                 19069 |      18820        237         12</span><br><span class="line">fs/squashfs                                                 19013 |      18965         44          4</span><br><span class="line">fs/debugfs                                                  15752 |      15688         52         12</span><br><span class="line">fs/nls                                                      11112 |      10996        116          0</span><br><span class="line">fs/sysfs                                                     7133 |       7086         39          8</span><br><span class="line">fs/devpts                                                    3299 |       2938        353          8</span><br><span class="line">fs/ramfs                                                     1840 |       1796         40          4</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        664300 |     642377       3147      18776</span><br><span class="line">delta                                                         660 |        620          4         36</span><br><span class="line"></span><br><span class="line">kernel                                                      total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">kernel/built-in.o                                          543470 |     467211      34187      42072</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">kernel/*.o                                                 228463 |     209842      11969       6652</span><br><span class="line">kernel/time                                                 94112 |      83229       6691       4192</span><br><span class="line">kernel/printk                                               54979 |      18467       8424      28088</span><br><span class="line">kernel/sched                                                47388 |      43798       3446        144</span><br><span class="line">kernel/irq                                                  43205 |      40313        812       2080</span><br><span class="line">kernel/rcu                                                  31236 |      29275       1932         29</span><br><span class="line">kernel/power                                                18951 |      17575        828        548</span><br><span class="line">kernel/locking                                              16625 |      16616          5          4</span><br><span class="line">kernel/bpf                                                   8404 |       8048         64        292</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        543363 |     467163      34171      42029</span><br><span class="line">delta                                                         107 |         48         16         43</span><br><span class="line"></span><br><span class="line">sound                                                       total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">sound/built-in.o                                           193477 |     188029       3852       1596</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">sound/soc                                                  101278 |      98458       2688        132</span><br><span class="line">sound/core                                                  91802 |      89198       1148       1456</span><br><span class="line">sound/*.o                                                     586 |        558         20          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        193666 |     188214       3856       1596</span><br><span class="line">delta                                                        -189 |       -185         -4          0</span><br><span class="line"></span><br><span class="line">lib                                                         total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">lib/built-in.o                                             156575 |     154010        236       2329</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">lib/*.o                                                    192773 |     192059        644         70</span><br><span class="line">lib/zlib_deflate                                            16704 |      14364         60       2280</span><br><span class="line">lib/zlib_inflate                                            11187 |      11187          0          0</span><br><span class="line">lib/xz                                                       8199 |       8163         36          0</span><br><span class="line">lib/lzo                                                      2551 |       2551          0          0</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        231414 |     228324        740       2350</span><br><span class="line">delta                                                      -74839 |     -74314       -504        -21</span><br><span class="line"></span><br><span class="line">block                                                       total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">block/built-in.o                                           151072 |     147441       2399       1232</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">block/*.o                                                  143829 |     140218       2383       1228</span><br><span class="line">block/partitions                                             7227 |       7207         16          4</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        151056 |     147425       2399       1232</span><br><span class="line">delta                                                          16 |         16          0          0</span><br></pre></td></tr></tbody></table></figure><p></p></li><li>å…³é—­å†…æ ¸è°ƒè¯•åŠŸèƒ½</li><li>å¼€å¯ CONFIG_CC_OPTIMIZE_FOR_SIZE å®ï¼Œä½¿èƒ½-Os ç¼–è¯‘å‚æ•°</li><li><p>æ’æŸ¥å†…æ ¸å ç”¨ç©ºé—´å¤§çš„ç¬¦å·</p></li></ul><p>æ‰§è¡Œ nm --size -r vmlinuxï¼Œå¯ä»¥åˆ—å‡ºæ‰€æœ‰ç¬¦å·å ç”¨çš„å†…å­˜</p><ul><li>å¼€å¯ CONFIG_THUMB2_AVOID_R_ARM_THM_JUMP11 å’Œ CONFIG_THUMB2_KERNELã€‚æ³¨ï¼šä¼šå¸¦æ¥æ€§èƒ½æŸå¤±ï¼Œå…·ä½“æŸå¤±æ ¹æ®å®é™…å¹³å°å…¸å‹åº”ç”¨åœºæ™¯è¿›è¡Œæµ‹è¯•</li></ul><h3 id="dtb-å†…å­˜ä¼˜åŒ–">DTB å†…å­˜ä¼˜åŒ–</h3><p>Tina å†…æ ¸ä¸­æä¾›çš„ DTS ä¸€èˆ¬æ¥è¯´æ¯”è¾ƒå…¨é¢ï¼Œå¯¹äºç‰¹å®šçš„æ–¹æ¡ˆï¼Œå¾€å¾€ç”¨ä¸äº†é‚£ä¹ˆå¤šï¼Œå¯ä»¥é’ˆå¯¹æ€§çš„åˆ é™¤ä¸€äº›èŠ‚ç‚¹ã€‚</p><h3 id="tee-å†…å­˜ä¼˜åŒ–">TEE å†…å­˜ä¼˜åŒ–</h3><p>Tina ä¸­ä¸€äº›å¹³å°ï¼Œä¼šé»˜è®¤é…ç½®ä¸€äº› TEE ä¿ç•™å†…å­˜ã€‚å¯¹äºç‰¹å®šæ–¹æ¡ˆæ¥è¯´ï¼Œå¾ˆæœ‰å¯èƒ½ç”¨ä¸äº†é‚£ä¹ˆå¤šå†…å­˜ã€‚ TEE é»˜è®¤ä¿ç•™é…ç½®ä¸ bl31.binã€ optee-${CHIP}.bin æ˜¯é…å¥—çš„ï¼Œå› æ­¤ä¿®æ”¹æ—¶éœ€è¦æ³¨æ„æ­¥æ›´æ–°ã€‚ æ¯”å¦‚ R329 é»˜è®¤é…ç½®äº† 8M å†…å­˜ï¼ˆSHM 2M,ATF 1M,OS 1M,TA 4Mï¼‰ï¼Œä½†æ˜¯å¯¹äºéå®‰å…¨æ–¹æ¡ˆæ¥è¯´ï¼Œåªéœ€è¦ä¿ç•™ ATF å°±å¤Ÿäº†ï¼›å¯¹äºä¸ä½¿ç”¨ TA çš„å®‰å…¨æ–¹æ¡ˆï¼Œåªéœ€è¦ä¿ç•™ ATF ä¸ OS çš„å†…å­˜å°±å¯ä»¥äº†ã€‚</p><h2 id="å†…æ ¸ä½¿ç”¨å†…å­˜ä¼˜åŒ–">å†…æ ¸ä½¿ç”¨å†…å­˜ä¼˜åŒ–</h2><p>å†…æ ¸ä½¿ç”¨çš„å†…å­˜åŒ…æ‹¬ Slabã€ PageTableã€ KernelStackã€ CmaUsedã€Vmalloc ç­‰</p><h2 id="slab-ä¼˜åŒ–">Slab ä¼˜åŒ–</h2><p>ç›®å‰ Tina ä¸Šå¤§éƒ¨åˆ†æ–¹æ¡ˆé»˜è®¤é€‰ç”¨çš„æ˜¯ SLUB åˆ†é…å™¨</p><ul><li>å…³é—­ slab è°ƒè¯•å® COFNIG_SLUB_DEBUG ä¸ CONFIG_SLABINFO</li><li>å°è¯•ä½¿ç”¨é’ˆå¯¹å¾®å°çš„åµŒå…¥å¼ç³»ç»Ÿçš„ SLOB</li></ul><h2 id="å†…æ ¸æ¨¡å—ä¼˜åŒ–">å†…æ ¸æ¨¡å—ä¼˜åŒ–</h2><ul><li>ä¸è¦å¼€æœºå…¨éƒ¨åŠ è½½ï¼Œå®æ—¶åŠ è½½ï¼Œå®æ—¶å¸è½½</li><li>å°†å†…æ ¸æ¨¡å—ç¼–è¯‘åˆ°å†…æ ¸é•œåƒä¸­</li></ul><h2 id="ç”¨æˆ·ç©ºé—´ä½¿ç”¨å†…å­˜ä¼˜åŒ–">ç”¨æˆ·ç©ºé—´ä½¿ç”¨å†…å­˜ä¼˜åŒ–</h2><ul><li>ä½¿ç”¨æ›´å°çš„ C åº“</li><li>ä½¿ç”¨ size ä¼˜åŒ–çš„ç¼–è¯‘é€‰é¡¹ï¼Œæ¯”å¦‚-Osï¼Œ -mthumb ç­‰</li><li>å°† tmpfs ä¸‹å¤§æ–‡ä»¶ä¿æŒåˆ° flash ä¸Š</li><li>å¯¹äº 64 ä½ CPUï¼Œå¯ä»¥ä½¿ç”¨ 32 ä½çš„ rootfs</li><li>ä½¿ç”¨æ›´å°çš„åº“æˆ–åº”ç”¨ç¨‹åºã€‚æ¯”å¦‚ä½¿ç”¨ mbedtlsï¼Œè€Œä¸æ˜¯ openssl</li><li>å‡å°‘å®ˆæŠ¤è¿›ç¨‹æ•°é‡ï¼Œå®æ—¶è¿è¡Œ/å…³é—­ç‰¹å®šç¨‹åº</li><li>å°†åªè¢«ä¸€æ¬¡ä¾èµ–çš„åŠ¨æ€åº“è½¬åŒ–ä¸ºåŠ¨æ€åº“ï¼›ä½¿ç”¨ dlopen æ¥æ§åˆ¶åŠ¨æ€åº“çš„ç”Ÿå­˜å‘¨æœŸ</li><li>ä¼˜åŒ–ç¨‹åºæºç </li></ul><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€Šå…¨å¿—SDKæ–‡æ¡£ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Technology Blog </category>
          
          <category> Programming </category>
          
          <category> Performance </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Programming </tag>
            
            <tag> Debug </tag>
            
            <tag> Linux </tag>
            
            <tag> Performance </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leaktrace ä½¿ç”¨æ–¹æ³•</title>
      <link href="/2019/Note/LeakTracer/"/>
      <url>/2019/Note/LeakTracer/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>LeakTracer æ˜¯åœ¨æ£€æŸ¥ C++ ç¨‹åºå†…å­˜æ³„æ¼æ—¶ç¼–å†™çš„ä¸€ä¸ªå°å·¥å…·ã€‚æˆ‘æ— æ³•è®© dmalloc æ˜¾ç¤ºæˆ‘æƒ³è¦çš„å†…å®¹ï¼Œæˆ‘åªçœ‹åˆ°äº†æåˆ°çš„ __builtin_return_address gcc-extensionã€‚</p><p>è¦ä½¿ç”¨ LeakTracerï¼Œè¯·ä½¿ç”¨æä¾›çš„ LeakCheck è„šæœ¬è¿è¡Œæ‚¨çš„ç¨‹åºã€‚å®ƒä½¿ç”¨ LD_PRELOAD ç‰¹æ€§åœ¨ä½ çš„å‡½æ•°ä¹‹ä¸Šâ€œè¦†ç›–â€ä¸€äº›å‡½æ•°ï¼ˆä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼‰ã€‚å¦‚æœæ‚¨çš„å¹³å°ä¸æ”¯æŒ LD_PRELOADï¼Œæ‚¨å¯ä»¥å°† LeakTracer.o å¯¹è±¡æ–‡ä»¶æ·»åŠ åˆ° Makefile ä¸­çš„å¯¹è±¡å¹¶è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºã€‚</p><p>LeakTracer åˆ©ç”¨ gdb å»è¾“å‡ºå‘ç”Ÿå†…å­˜æ³„éœ²æ‰€å‘ç”Ÿçš„ä½ç½®ï¼Œå®ƒæ˜¯é€šè¿‡ override operator new, operator delete, operator malloc, operator free æ¥å®ç°æ£€æµ‹ã€‚</p><span id="more"></span><h1 id="ç”¨æ³•">ç”¨æ³•</h1><h2 id="åŠ è½½-leaktracer-åº“çš„-3-ç§æ–¹æ³•"><strong>åŠ è½½ leaktracer åº“çš„ 3 ç§æ–¹æ³•ï¼š</strong></h2><ul><li>å°†æ‚¨çš„ç¨‹åºé“¾æ¥åˆ° libleaktracer.a</li><li>å°†æ‚¨çš„ç¨‹åºé“¾æ¥åˆ° <span class="exturl" data-url="aHR0cDovL2xpYmxlYWt0cmFjZXIuc28v">libleaktracer.so<i class="fa fa-external-link-alt"></i></span>ã€‚æ‚¨éœ€è¦å°† -lleaktracer é€‰é¡¹ä½œä¸ºé“¾æ¥å‘½ä»¤çš„ç¬¬ä¸€ä¸ªé€‰é¡¹</li><li>ä½¿ç”¨ LD_PRELOAD ç¯å¢ƒå˜é‡ä»¥ç¡®ä¿å®ƒåœ¨ä»»ä½•å…¶ä»–åº“ä¹‹å‰åŠ è½½</li></ul><h2 id="å°†-leaktracer-æ·»åŠ åˆ°ç¨‹åºä¸­"><strong>å°† leaktracer æ·»åŠ åˆ°ç¨‹åºä¸­ï¼š</strong></h2><ul><li>æ·»åŠ å¤´æ–‡ä»¶ MemoryTrace.hpp</li><li>æ·»åŠ  leaktracer::MemoryTrace::GetInstance().startMonitoringAllThreads() å‡½æ•°ï¼Œä½œä¸ºèµ·å§‹æ£€æµ‹ä½ç½®</li><li>æ·»åŠ  leaktracer::MemoryTrace::GetInstance().writeLeaksToFile("/mnt/extsd/leaks.out") å‡½æ•°ï¼Œä½œä¸ºç»“æŸä½ç½®ï¼Œç”Ÿæˆæ£€æµ‹æŠ¥å‘Š</li><li>ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ -funwind-tables ç”Ÿæˆ backtrace ä¿¡æ¯è¡¨ï¼Œæ·»åŠ -rdynamic</li><li>é“¾æ¥é€‰é¡¹ä¸­æ·»åŠ -Wl,-Bstatic -lleaktracer é™æ€é“¾æ¥ libleaktracerï¼Œæœ€å¥½åŠ ä¸Š-g3ï¼Œå¤„ç†æŠ¥å‘Šæ—¶å¯ä»¥æ˜¾ç¤ºå¯¹åº”çš„ä»£ç </li><li>ç¼–è¯‘åä¿å­˜ç”Ÿæˆçš„ bin æ–‡ä»¶ï¼Œå¤‡ç”¨</li></ul><h2 id="ç”ŸæˆæŠ¥å‘ŠåŠå¤„ç†"><strong>ç”ŸæˆæŠ¥å‘ŠåŠå¤„ç†ï¼š</strong></h2><h3 id="ç”Ÿæˆçš„æŠ¥å‘Šä¸­ä¸€è¡Œä¿¡æ¯å¦‚ä¸‹">ç”Ÿæˆçš„æŠ¥å‘Šä¸­ä¸€è¡Œä¿¡æ¯å¦‚ä¸‹ï¼š</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># LeakTracer report diff_utc_mono=<span class="number">1588164717.365890</span></span><br><span class="line">leak, time=<span class="number">1434.190531</span>, stack=<span class="number">0x7f05d63801d5</span> <span class="number">0x7f05d638e594</span> <span class="number">0x7f05d638d8f8</span> <span class="number">0x7f05d638c28d</span> <span class="number">0x7f05d6382738</span>, size=<span class="number">1024</span>, data=***********************************************...</span><br><span class="line">leak, time=<span class="number">1444.194638</span>, stack=<span class="number">0x7f05d70f9c58</span> <span class="number">0x4027f5</span> <span class="number">0x7f05d6333830</span> <span class="number">0x402369</span>, size=<span class="number">100</span>, data=.<span class="string">"%...............................................</span></span><br><span class="line"><span class="string">leak, time=1434.190625, stack=0x4024d7 0x7f05d6333830 0x402369, size=100, data=..................................................</span></span><br><span class="line"><span class="string">leak, time=1444.194222, stack=0x7f05d70f9a5c 0x4027f0 0x7f05d6333830 0x402369, size=100, data=. %...............................................</span></span><br><span class="line"><span class="string">leak, time=1434.190651, stack=0x402500 0x7f05d6333830 0x402369, size=100,</span></span><br></pre></td></tr></tbody></table></figure><ul><li>leakï¼šä»£è¡¨å†…å­˜æ³„éœ²</li><li>timeï¼šä»£è¡¨è°ƒç”¨åˆ†é…å†…å­˜å‡½æ•°çš„æ—¶é—´ï¼ˆå¼€æœºåˆ°å½“å‰çš„æ—¶é—´ï¼‰</li><li>stackï¼šè°ƒç”¨æ ˆ</li><li>sizeï¼šæ³„éœ²çš„å†…å­˜å¤§å°</li><li>dataï¼šç”³è¯·æ—¶å†…å­˜ä¸­çš„æ•°æ®</li></ul><p>æ˜æ˜¾å¯ä»¥çœ‹åˆ°è°ƒç”¨æ ˆï¼Œcallstack å…¨æ˜¯åœ°å€ï¼Œæˆ‘ä»¬ä»¥ä½¿ç”¨ helpers æ–‡ä»¶å¤¹ä¸­çš„ leak-analyze-addr2lineï¼Œleak-analyze-gdb äºŒä¸ªå·¥å…·è¿›è¡Œè§£æã€‚æˆ–è€…å€ŸåŠ© gdbã€objdump æˆ– map æ–‡ä»¶ç­‰æ‰‹æ®µå¾—åˆ°è¯¥æ³„éœ²æºçš„çœŸæ­£æ–‡ä»¶/è¡Œå·æˆ–å‡½æ•°èŒƒå›´ã€‚</p><h3 id="æŠ¥å‘Šå¤„ç†">æŠ¥å‘Šå¤„ç†</h3><ul><li><p>ä½¿ç”¨ addr2line å¤„ç† leaks.outï¼Œç”Ÿæˆå¯è¯»çš„è°ƒç”¨æ ˆï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leak-analyze-addr2line {bin} leaks.out &gt; leaks.addr2line.txt</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç”Ÿæˆçš„æŠ¥å‘Šç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./helpers/leak-analyze-addr2line memleak_test_so leaks.out </span><br><span class="line">Processing <span class="string">"leaks.out"</span> log <span class="keyword">for</span> <span class="string">"memleak_test_so"</span></span><br><span class="line">Matching addresses to <span class="string">"memleak_test_so"</span></span><br><span class="line">found <span class="number">49</span> <span class="built_in">leak</span>(s)</span><br><span class="line"><span class="number">100</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1444.194222</span>), from following call stack:</span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">110</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br><span class="line"><span class="number">400</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1444.194550</span>), from following call stack:</span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">110</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br><span class="line"><span class="number">328</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1434.190960</span>), from following call stack:</span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">83</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br></pre></td></tr></tbody></table></figure><p></p><p>è§£æï¼š49 ä¸ªé‡å¤è°ƒç”¨ï¼Œæ³„éœ² 100 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªæ³„æ¼ç‚¹åœ¨ leaks.out ä¸­çš„æ—¶é—´æ˜¯ 06219.879013ï¼Œè°ƒç”¨æ ˆä»ä¸‹ å¾€ä¸Šçœ‹ã€‚</p></li><li><p>ä½¿ç”¨ gdb å¤„ç† leaks.outï¼Œç”Ÿæˆå¯è¯»çš„è°ƒç”¨æ ˆåŠæºç å¯¹åº”ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">leak-analyze-gdb {bin} leaks.out &gt; leaks.gdb.txt</span><br></pre></td></tr></tbody></table></figure><p></p><p>ç”Ÿæˆçš„æŠ¥å‘Šç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ./helpers/leak-analyze-gdb memleak_test_so  leaks.out </span><br><span class="line">found <span class="number">49</span> <span class="built_in">leak</span>(s)</span><br><span class="line">(gdb) Reading symbols from memleak_test_so...done.</span><br><span class="line"><span class="number">16</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1434.190803</span>), from following call stack:</span><br><span class="line">main + <span class="number">364</span> in section .text</span><br><span class="line"><span class="number">0x4025e4</span> <span class="function">is in <span class="title">main</span><span class="params">()</span> <span class="params">(memleak_test.cpp:<span class="number">80</span>)</span>.</span></span><br><span class="line"><span class="function">80new_delete_test *p_new_class_no_free </span>=  <span class="keyword">new</span> new_delete_test;</span><br><span class="line">No symbol matches <span class="number">0x7f05d6333830</span>.</span><br><span class="line">_start + <span class="number">41</span> in section .text</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1444.194798</span>), from following call stack:</span><br><span class="line">No symbol matches <span class="number">0x7f05d70f9cee</span>.</span><br><span class="line">main + <span class="number">893</span> in section .text</span><br><span class="line"><span class="number">0x4027f5</span> <span class="function">is in <span class="title">main</span><span class="params">()</span> <span class="params">(memleak_test.cpp:<span class="number">111</span>)</span>.</span></span><br><span class="line"><span class="function">111leaktracer::<span class="title">MemoryTrace::GetInstance</span><span class="params">()</span>.<span class="title">stopAllMonitoring</span><span class="params">()</span></span>;</span><br><span class="line">No symbol matches <span class="number">0x7f05d6333830</span>.</span><br></pre></td></tr></tbody></table></figure><p></p><p>æ— è®ºæ˜¯ leak-analyze-addr2lineï¼Œleak-analyze-gdb äºŒä¸ªå·¥å…·è¿›è¡Œè§£æã€‚æˆ–è€…å€ŸåŠ© gdbã€objdump æˆ– map æ–‡ä»¶ç­‰æ‰‹æ®µ å¾—åˆ°è¯¥æ³„éœ²æºçš„çœŸæ­£æ–‡ä»¶/è¡Œå·æˆ–å‡½æ•°èŒƒå›´ã€‚å…¶ä¸­éƒ½ä¼šç¢°ä¸Šå„ç§åº“å¼•ç”¨ç­‰é—®é¢˜å¯¼è‡´ï¼Ÿï¼Ÿï¼Ÿã€‚éƒ½ä¼šå¾ˆéº»çƒ¦ï¼Œç„¶è€Œ leaktracer æä¾›äº†ç›¸å…³æºç ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ leaktracer è¿›è¡Œæ”¹é€ æˆç¬¦åˆæˆ‘ä»¬çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚</p></li></ul><h1 id="å®šåˆ¶">å®šåˆ¶</h1><p>é€šè¿‡ä¸Šè¿°æ–‡ç« æˆ‘ä»¬å¯ä»¥è½»æ¾ç†è§£ leaktracer ä½¿ç”¨ä¸ leaktracer è®¾è®¡ä¸å®ç°ã€‚åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šç¢°åˆ°ä¸€äº›å°é—®é¢˜ã€‚éœ€è¦å¯¹ leaktracer è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ã€‚ä»¥ä¸‹çš„å®šåˆ¶åŒ–è¯·æ ¹æ®å„è‡ªé¡¹ç›®å®é™…éœ€æ±‚é…Œæƒ…è¿›è¡Œä¿®æ”¹ã€‚</p><ul><li><p><strong>callstack æ·±åº¦é—®é¢˜</strong><br>callstack æ·±åº¦é»˜è®¤åªæœ‰ 5 ä¸ªã€‚</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ALLOCATION_STACK_DEPTH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOCATION_STACK_DEPTH 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å› æ­¤å½“ callstack æ·±åº¦è¾ƒå¤§æ—¶æ— æ³•æ˜¾ç¤ºè¯¦ç»†çš„è°ƒç”¨å…³ç³»ã€‚å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack=<span class="number">0x7f05d63801d5</span> <span class="number">0x7f05d638e594</span> <span class="number">0x7f05d638d8f8</span> <span class="number">0x7f05d638c28d</span> <span class="number">0x7f05d6382738</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>å°†é»˜è®¤ callstack æ·±åº¦ 5 ä¿®æ”¹ä¸ºè¾ƒå¤§å€¼ï¼Œæœ¬æ–‡æ˜¯ 50ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¯¹æ•´ä¸ªæƒ…å†µå½±å“ä¸å¤§</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ALLOCATION_STACK_DEPTH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOCATION_STACK_DEPTH 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p><strong>callstatck åœ°å€é—®é¢˜</strong><br>æ— è®ºæ˜¯ leak-analyze-addr2lineï¼Œleak-analyze-gdb äºŒä¸ªå·¥å…·è¿›è¡Œè§£æã€‚æˆ–è€…å€ŸåŠ© gdbã€objdump æˆ– map æ–‡ä»¶ç­‰æ‰‹æ®µ å¾—åˆ°è¯¥æ³„éœ²æºçš„çœŸæ­£æ–‡ä»¶/è¡Œå·æˆ–å‡½æ•°èŒƒå›´ã€‚å› å¤šä¸ªåŠ¨æ€åº“åŠå…¶ä»–åŸå› ï¼Œæˆ–å¤šæˆ–å°‘éƒ½ä¼šç¢°ä¸Šå„ç§åº“å¼•ç”¨ç­‰é—®é¢˜å¯¼ è‡´ï¼Ÿï¼Ÿï¼Ÿã€‚ä¼šå¾ˆéº»çƒ¦</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ./helpers/leak-analyze-addr2line memleak_test_so leaks.out </span><br><span class="line">Processing <span class="string">"leaks.out"</span> log <span class="keyword">for</span> <span class="string">"memleak_test_so"</span></span><br><span class="line">Matching addresses to <span class="string">"memleak_test_so"</span></span><br><span class="line">found <span class="number">49</span> <span class="built_in">leak</span>(s)</span><br><span class="line"><span class="number">100</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1444.194222</span>), from following call stack:</span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">110</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br><span class="line"><span class="number">400</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1444.194550</span>), from following call stack:</span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">110</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br><span class="line"><span class="number">328</span> bytes lost in <span class="number">1</span> <span class="built_in">blocks</span> (one of them allocated at <span class="number">1434.190960</span>), from following call stack:</span><br><span class="line">/home/cll/<span class="number">99</span>_temp/memory_leak/leaktracer/memleak_way1/memleak_test.cpp:<span class="number">83</span></span><br><span class="line">??:<span class="number">0</span></span><br><span class="line">??:?</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p><strong>æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨æ— æ³•ç”Ÿæˆæ–‡ä»¶é—®é¢˜</strong><br>ä½¿ç”¨ void writeLeaksToFile(const char* reportFileName); æ¥å£ç”Ÿæˆæ–‡ä»¶æ—¶ï¼Œè‹¥æ–‡ä»¶å¤¹è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™ä¼šç”Ÿæˆæ–‡ä»¶å¤±è´¥ã€‚ç„¶è€Œå®é™…åœ¨è¾ƒå¤§å·¥ç¨‹ä¸­ä½¿ç”¨æ—¶ï¼Œå‡ä¼šå°†å†…å­˜æ³„éœ²æ–‡ä»¶ç»Ÿä¸€åˆ°æŸä¸ªæŒ‡å®šè·¯å¾„ã€‚å¯èƒ½å­˜åœ¨æ–‡ä»¶å¤¹è·¯å¾„ä¸å­˜åœ¨çš„æƒ…å†µã€‚</p></li><li><p>æœªå†…å­˜æ³„éœ²ç¡®ç”Ÿæˆæ–‡ä»¶é—®é¢˜<br>åœ¨è¾ƒå¤§å·¥ç¨‹ä¸­ä½¿ç”¨æ—¶ï¼Œè¿›ç¨‹æ•°è¾ƒå¤šã€‚è‹¥æœªå†…å­˜æ³„éœ²ç¡®äº§ç”Ÿæ–‡ä»¶ï¼Œå¯¹ UI äº¤äº’åŠç›´è§‚ä¸Šæ€»æœ‰äº›ä¸åè°ƒã€‚</p></li><li><p>è§£å†³åŠæ³•å‚è€ƒ https://github.com/carlyleliu/LeakTracer/commit/49513580316bf998796b19ae7587b1a3e32bbfac</p></li></ul><h1 id="åŸç†">åŸç†</h1><h2 id="leaktracer-ä¸»è¦çš„è®¾è®¡æ€è·¯ä¸º">leaktracer ä¸»è¦çš„è®¾è®¡æ€è·¯ä¸ºï¼š</h2><ul><li>å®ç°ä¸€ç»„å†…å­˜çš„åˆ†é…/é‡Šæ”¾å‡½æ•°ï¼Œè¿™ç»„å‡½æ•°çš„å‡½æ•°åŸå‹ä¸ç³»ç»Ÿçš„é‚£ä¸€ç»„å®Œå…¨ä¸€æ ·ï¼Œè®©è¢« trace çš„ library å¯¹äºå†…å­˜çš„åˆ†é…/é‡Šæ”¾å‡½æ•°çš„è°ƒç”¨éƒ½é“¾æ¥åˆ°è‡ªå·±å®ç°çš„è¿™ä¸€ç»„å‡½æ•°ä¸­ä»¥ override æ‰ç³»ç»Ÿçš„é‚£ç»„å†…å­˜/åˆ†é…é‡Šæ”¾å‡½æ•°ï¼›</li><li>è‡ªå·±å®ç°çš„è¿™ç»„å‡½æ•°ä¸­çš„å†…å­˜åˆ†é…å‡½æ•°è®°å½•åˆ†é…ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åˆ†é…çš„å†…å­˜çš„å¤§å°ï¼Œcallstack ç­‰ï¼Œå¹¶è°ƒç”¨ç³»ç»Ÿæœ¬æ¥çš„å†…å­˜åˆ†é…å‡½æ•°å»åˆ†é…å†…å­˜ï¼›</li><li>è‡ªå·±å®ç°çš„è¿™ç»„å‡½æ•°ä¸­çš„å†…å­˜é‡Šæ”¾å‡½æ•°åˆ™é”€æ¯å†…å­˜åˆ†é…çš„ç›¸å…³è®°å½•ï¼Œå¹¶ä½¿ç”¨ç³»ç»Ÿçš„å†…å­˜é‡Šæ”¾å‡½æ•°çœŸæ­£çš„é‡Šæ”¾å†…å­˜ï¼›</li><li>åœ¨ trace ç»“æŸæ—¶ï¼Œéå†æ‰€æœ‰ä¿å­˜çš„å†…å­˜åˆ†é…è®°å½•çš„ä¿¡æ¯ï¼Œå¹¶æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜è¿›æ–‡ä»¶ä»¥ä¾›è¿›ä¸€æ­¥çš„åˆ†æ</li></ul><h2 id="override-ç³»ç»Ÿå†…å­˜åˆ†é…é‡Šæ”¾å‡½æ•°">override ç³»ç»Ÿå†…å­˜åˆ†é…/é‡Šæ”¾å‡½æ•°</h2><p>LeakTracer å®ç°çš„ç”¨äº override ç³»ç»Ÿå†…å­˜åˆ†é…/é‡Šæ”¾å‡½æ•°çš„é‚£ç»„å‡½æ•°åœ¨ AllocationHandlers.cpp ä¸­å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c++</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[] <span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span> <span class="params">(<span class="type">void</span> *p)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[]</span></span><br><span class="line"><span class="function">c</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span></span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// LeakTracer</span></span><br><span class="line"><span class="comment">// Contribution to original project by Erwin S. Andreasen</span></span><br><span class="line"><span class="comment">// site: &lt;http://www.andreasen.org/LeakTracer/&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Added by Michael Gopshtein, 2006</span></span><br><span class="line"><span class="comment">// mgopshtein@gmail.com</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Any comments/suggestions are welcome</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"MemoryTrace.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"LeakTracer_l.hpp"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span>* (*lt_malloc)(<span class="type">size_t</span> size);</span><br><span class="line"><span class="built_in">void</span>  (*lt_free)(<span class="type">void</span>* ptr);</span><br><span class="line"><span class="type">void</span>* (*lt_realloc)(<span class="type">void</span> *ptr, <span class="type">size_t</span> size);</span><br><span class="line"><span class="type">void</span>* (*lt_calloc)(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[] (<span class="type">size_t</span> size) {</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span> <span class="params">(<span class="type">void</span> *p)</span> </span>{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(p, <span class="literal">false</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(p);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[] (<span class="type">void</span> *p) {</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(p, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(p);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** -- libc memory operators -- **/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/* malloc</span></span><br><span class="line"><span class="comment"> * in some malloc implementation, there is a recursive call to malloc</span></span><br><span class="line"><span class="comment"> * (for instance, in uClibc 0.9.29 malloc-standard )</span></span><br><span class="line"><span class="comment"> * we use a InternalMonitoringDisablerThreadUp that use a tls variable to prevent several registration</span></span><br><span class="line"><span class="comment"> * during the same malloc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line">p = <span class="built_in">LT_MALLOC</span>(size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(ptr, <span class="literal">false</span>);</span><br><span class="line"><span class="built_in">LT_FREE</span>(ptr);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">realloc</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"> </span><br><span class="line">p = <span class="built_in">LT_REALLOC</span>(ptr, size);</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (p != ptr)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (ptr)</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerRelease</span>(ptr, <span class="literal">false</span>);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerReallocation</span>(p, size, <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">Setup</span>();</span><br><span class="line"> </span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line">p = <span class="built_in">LT_CALLOC</span>(nmemb, size);</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">leaktracer::MemoryTrace::<span class="built_in">GetInstance</span>().<span class="built_in">registerAllocation</span>(p, nmemb*size, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><p>å†…å­˜åˆ†é…å‡½æ•°è®°å½•åˆ†é…ç›¸å…³çš„ä¿¡æ¯</p><p>inline void registerAllocation(void *p, size_t size, bool is_array); è®°å½•æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç›¸å…³ä¿¡æ¯</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers new memory allocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting "new" calls */</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** registers memory reallocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting realloc calls */</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>inline void registerReallocation(void *p, size_t size, bool is_array); è®°å½•æ¯ä¸€æ¬¡å†…å­˜åˆ†é…çš„ç›¸å…³ä¿¡ æ¯ï¼Œé™ realloc</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers memory reallocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting realloc calls */</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// adds all relevant info regarding current allocation to map</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">MemoryTrace::registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="type">allocation_info_t</span> *info = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">AllMonitoringIsDisabled</span>() &amp;&amp; (__monitoringAllThreads || <span class="built_in">getThreadOptions</span>().    monitoringAllocations) &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="function">MutexLock <span class="title">lock</span><span class="params">(__allocations_mutex)</span></span>;</span><br><span class="line">info = __allocations.<span class="built_in">insert</span>(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line">info-&gt;size = size;</span><br><span class="line">info-&gt;isArray = is_array;</span><br><span class="line"><span class="built_in">storeTimestamp</span>(info-&gt;timestamp);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"> <span class="comment">// we store the stack without locking __allocations_mutex</span></span><br><span class="line"><span class="comment">// it should be safe enough</span></span><br><span class="line"><span class="comment">// prevent a deadlock between backtrave function who are now using advanced dl_iterate_phdr     function</span></span><br><span class="line"> <span class="comment">// and dl_* function which uses malloc functions</span></span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="built_in">storeAllocationStack</span>(info-&gt;allocStack);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) {</span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// adds all relevant info regarding current allocation to map</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">MemoryTrace::registerReallocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">AllMonitoringIsDisabled</span>() &amp;&amp; (__monitoringAllThreads || <span class="built_in">getThreadOptions</span>().    monitoringAllocations) &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="function">MutexLock <span class="title">lock</span><span class="params">(__allocations_mutex)</span></span>;</span><br><span class="line"><span class="type">allocation_info_t</span> *info = __allocations.<span class="built_in">find</span>(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line">info-&gt;size = size;</span><br><span class="line">info-&gt;isArray = is_array;</span><br><span class="line"><span class="built_in">storeAllocationStack</span>(info-&gt;allocStack);</span><br><span class="line"><span class="built_in">storeTimestamp</span>(info-&gt;timestamp);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) {</span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>å†…å­˜é‡Šæ”¾å‡½æ•°åˆ™é”€æ¯å†…å­˜åˆ†é…çš„ç›¸å…³è®°å½•</p><p>inline void registerReallocation(void *p, size_t size, bool is_array); è®°å½•æ¯ä¸€æ¬¡å†…å­˜é‡Šæ”¾çš„ç›¸å…³ä¿¡æ¯</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** registers new memory allocation, should be called by the</span></span><br><span class="line"><span class="comment"> *  function intercepting "new" calls */</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">registerAllocation</span><span class="params">(<span class="type">void</span> *p, <span class="type">size_t</span> size, <span class="type">bool</span> is_array)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// removes allocation's info from the map</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">MemoryTrace::registerRelease</span><span class="params">(<span class="type">void</span> *p, <span class="type">bool</span> is_array)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">AllMonitoringIsDisabled</span>() &amp;&amp; __monitoringReleases &amp;&amp; p != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="function">MutexLock <span class="title">lock</span><span class="params">(__allocations_mutex)</span></span>;</span><br><span class="line"><span class="type">allocation_info_t</span> *info = __allocations.<span class="built_in">find</span>(p);</span><br><span class="line"><span class="keyword">if</span> (info != <span class="literal">NULL</span>) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;isArray != is_array) {</span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"><span class="comment">// WARNING</span></span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">}</span><br><span class="line">__allocations.<span class="built_in">release</span>(p);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>éå†æ‰€æœ‰ä¿å­˜çš„å†…å­˜åˆ†é…è®°å½•çš„ä¿¡æ¯ï¼Œå¹¶æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜</p><p>void writeLeaksToFile(const char* reportFileName); ä¿å­˜å†…å­˜åˆ†é…è®°å½•ä¿¡æ¯åˆ°æ–‡ä»¶ã€‚</p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** writes report with all memory leaks */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writeLeaksToFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* reportFileName)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writes all memory leaks to given stream</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemoryTrace::writeLeaksToFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* reportFilename)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="function">MutexLock <span class="title">lock</span><span class="params">(__allocations_mutex)</span></span>;</span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadUp</span>();</span><br><span class="line"></span><br><span class="line">std::ofstream oleaks;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">isFolderExist</span>(reportFilename)) {</span><br><span class="line"><span class="built_in">createDirectory</span>(reportFilename);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (__allocations.<span class="built_in">empty</span>()) {</span><br><span class="line"><span class="keyword">return</span>; <span class="comment">//no memory leak, not need to create leak file</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">oleaks.<span class="built_in">open</span>(reportFilename, std::ios_base::out);</span><br><span class="line"><span class="keyword">if</span> (oleaks.<span class="built_in">is_open</span>())</span><br><span class="line">{</span><br><span class="line"><span class="built_in">writeLeaksPrivate</span>(oleaks);</span><br><span class="line">oleaks.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">std::cerr &lt;&lt; <span class="string">"Failed to write to \\"</span><span class="string">" &lt;&lt; reportFilename &lt;&lt; "</span>\\<span class="string">"\\n"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">InternalMonitoringDisablerThreadDown</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>éå†è‡ªå®šä¹‰ MapMemoryInfo ä¸­æ‰€æœ‰å…ƒç´ </p><p></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writes all memory leaks to given stream</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemoryTrace::writeLeaksPrivate</span><span class="params">(std::ostream &amp;out)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> mono, utc, diff;</span><br><span class="line"><span class="type">allocation_info_t</span> *info;</span><br><span class="line"><span class="type">void</span> *p;</span><br><span class="line"><span class="type">double</span> d;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> precision = <span class="number">6</span>;</span><br><span class="line"><span class="type">int</span> maxsecwidth;</span><br><span class="line"></span><br><span class="line"><span class="built_in">clock_gettime</span>(CLOCK_REALTIME, &amp;utc);</span><br><span class="line"><span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;mono);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (utc.tv_nsec &gt; mono.tv_nsec) {</span><br><span class="line">diff.tv_nsec = utc.tv_nsec - mono.tv_nsec;</span><br><span class="line">diff.tv_sec = utc.tv_sec - mono.tv_sec;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">diff.tv_nsec = <span class="number">1000000000</span> - (mono.tv_nsec - utc.tv_nsec);</span><br><span class="line">diff.tv_sec = utc.tv_sec - mono.tv_sec <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">maxsecwidth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(mono.tv_sec &gt; <span class="number">0</span>) {</span><br><span class="line">mono.tv_sec = mono.tv_sec/<span class="number">10</span>;</span><br><span class="line">maxsecwidth++;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (maxsecwidth == <span class="number">0</span>) maxsecwidth=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">out &lt;&lt; <span class="string">"# LeakTracer report"</span>;</span><br><span class="line">d = diff.tv_sec + (((<span class="type">double</span>)diff.tv_nsec)/<span class="number">1000000000</span>);</span><br><span class="line">out &lt;&lt; <span class="string">" diff_utc_mono="</span> &lt;&lt; std::fixed &lt;&lt; std::left &lt;&lt; std::<span class="built_in">setprecision</span>(precision) &lt;&lt; d ;</span><br><span class="line">out &lt;&lt; <span class="string">"\\n"</span>;</span><br><span class="line"></span><br><span class="line">__allocations.<span class="built_in">beginIteration</span>();</span><br><span class="line"><span class="keyword">while</span> (__allocations.<span class="built_in">getNextPair</span>(&amp;info, &amp;p)) {</span><br><span class="line">d = info-&gt;timestamp.tv_sec + (((<span class="type">double</span>)info-&gt;timestamp.tv_nsec)/<span class="number">1000000000</span>);</span><br><span class="line">out &lt;&lt; <span class="string">"leak, "</span>;</span><br><span class="line">out &lt;&lt; <span class="string">"time="</span>  &lt;&lt; std::fixed &lt;&lt; std::right &lt;&lt; std::<span class="built_in">setprecision</span>(precision) &lt;&lt;  std::<span class="built_in">setfill</span>(<span class="string">'0'</span>) &lt;&lt; std::<span class="built_in">setw</span>(maxsecwidth+<span class="number">1</span>+precision) &lt;&lt; d &lt;&lt; <span class="string">", "</span>; <span class="comment">// setw(16) ?</span></span><br><span class="line">out &lt;&lt; <span class="string">"stack="</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> BACKTRACE_SYMBOLS_USED</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i_depth = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i_depth = <span class="number">0</span>; i_depth &lt; ALLOCATION_STACK_DEPTH; i_depth++) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;allocStack[i_depth] == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (i_depth &gt; <span class="number">0</span>) out &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">out &lt;&lt; info-&gt;allocStack[i_depth];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line"><span class="type">char</span> **trace_symbols = (<span class="type">char</span> **)<span class="built_in">backtrace_symbols</span> (info-&gt;allocStack, i_depth);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> != trace_symbols) {</span><br><span class="line"><span class="type">size_t</span> name_size = <span class="number">64</span>;</span><br><span class="line"><span class="type">char</span> *name = (<span class="type">char</span>*)<span class="built_in">malloc</span>(name_size);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> j = <span class="number">0</span>; j &lt; i_depth; j++) {</span><br><span class="line"><span class="type">char</span> *begin_name = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> *begin_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> *end_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">char</span> *p = trace_symbols[j]; *p; ++p) {</span><br><span class="line"><span class="keyword">if</span> (*p == <span class="string">'('</span>) {</span><br><span class="line">begin_name = p;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (*p == <span class="string">'+'</span> &amp;&amp; begin_name) {</span><br><span class="line">begin_offset = p;</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (*p == <span class="string">')'</span> &amp;&amp; begin_offset) {</span><br><span class="line">end_offset = p;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (begin_name &amp;&amp; begin_offset &amp;&amp; end_offset ) {</span><br><span class="line">*begin_name++ = <span class="string">'\\0'</span>;</span><br><span class="line">*begin_offset++ = <span class="string">'\\0'</span>;</span><br><span class="line">*end_offset = <span class="string">'\\0'</span>;</span><br><span class="line"><span class="type">int</span> status = <span class="number">-4</span>;</span><br><span class="line"><span class="type">char</span> *ret = abi::__cxa_demangle(begin_name, name, &amp;name_size, &amp;status);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> == status) {</span><br><span class="line">name = ret;</span><br><span class="line">out &lt;&lt; trace_symbols[j] &lt;&lt; <span class="string">":"</span> &lt;&lt; name &lt;&lt; <span class="string">"+"</span> &lt;&lt; begin_offset;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">out &lt;&lt; trace_symbols[j] &lt;&lt; <span class="string">":"</span> &lt;&lt; begin_name &lt;&lt; <span class="string">"()+"</span> &lt;&lt; begin_offset;</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">out &lt;&lt; trace_symbols[j];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">free</span>(trace_symbols);</span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; ALLOCATION_STACK_DEPTH; i++) {</span><br><span class="line"><span class="keyword">if</span> (info-&gt;allocStack[i] == <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (i &gt; <span class="number">0</span>) out &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">out &lt;&lt; info-&gt;allocStack[i];</span><br><span class="line">}</span><br><span class="line">out &lt;&lt; <span class="string">", "</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">out &lt;&lt; <span class="string">"size="</span> &lt;&lt; info-&gt;size &lt;&lt; <span class="string">", "</span>;</span><br><span class="line"></span><br><span class="line">out &lt;&lt; <span class="string">"data="</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *data = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span> *&gt;(p);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; PRINTED_DATA_BUFFER_SIZE &amp;&amp; i &lt; info-&gt;size; i++)</span><br><span class="line">out &lt;&lt; (<span class="built_in">isprint</span>(data[i]) ? data[i] : <span class="string">'.'</span>);</span><br><span class="line">out &lt;&lt; <span class="string">'\\n'</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li></ul><p>æ•´ä½“æ¥çœ‹ LeakTracer çš„è®¾è®¡ä¸å®ç°éƒ½å¹¶ä¸å¤æ‚ï¼Œå› è€Œèƒ½å¤Ÿ trace çš„ memory issue ä¹Ÿå°±æœ‰é™ã€‚æ¯”å¦‚ï¼ŒLeakTracer å°±æ— æ³• trace å¤šæ¬¡é‡Šæ”¾ç­‰é—®é¢˜ã€‚ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç ç¼–å†™æ›´å¼ºå¤§çš„å†…å­˜ç›¸å…³çš„ trace å·¥å…·ã€‚</p><p>ğŸ’¡ æ³¨æ„ï¼šå¯¹äºåº”ç”¨ï¼Œæ— è®ºæ˜¯é™æ€é“¾æ¥æˆ–åŠ¨æ€é“¾æ¥çš„åº“ï¼Œè‹¥æƒ³èƒ½å¤Ÿç”Ÿæˆ callstackï¼Œéƒ½éœ€è¦æ·»åŠ -funwind-tables é‡æ–°ç¼–è¯‘ä¸€æ¬¡ leak-analyze-addr2line å’Œ leak-analyze-gdb åœ¨ libleaktracer.tar.gz ä¸­ï¼Œéœ€è¦å°†å…¶ä¸­çš„ addr2line å’Œ gdb æ”¹æˆäº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­çš„ arm-xxx-addr2line å’Œ arm-xxx-gdbã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux åº”ç”¨ç¼–ç¨‹</title>
      <link href="/2019/Note/LinuxApplicationPrograms/"/>
      <url>/2019/Note/LinuxApplicationPrograms/</url>
      
        <content type="html"><![CDATA[<h1 id="æ–‡ä»¶-io">æ–‡ä»¶ IO</h1><p>ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO1.png"></p><p>å†…æ ¸çš„ sys_openã€sys_read åšäº†ä»€ä¹ˆï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO2.png"></p><span id="more"></span><h1 id="framebuffer-åº”ç”¨ç¼–ç¨‹">Framebuffer åº”ç”¨ç¼–ç¨‹</h1><h2 id="lcd-æ“ä½œåŸç†">LCD æ“ä½œåŸç†</h2><p>åœ¨ Linux ç³»ç»Ÿä¸­é€šè¿‡ Framebuffer é©±åŠ¨ç¨‹åºæ¥æ§åˆ¶ LCDã€‚Frame æ˜¯å¸§çš„æ„æ€ï¼Œbuffer æ˜¯ç¼“å†²çš„æ„æ€ï¼Œè¿™æ„å‘³ç€ Framebuffer å°±æ˜¯ä¸€å—å†…å­˜ï¼Œé‡Œé¢ä¿å­˜ç€ä¸€å¸§å›¾åƒã€‚Framebuffer ä¸­ä¿å­˜ç€ä¸€å¸§å›¾åƒçš„æ¯ä¸€ä¸ªåƒç´ é¢œè‰²å€¼ï¼Œå‡è®¾ LCD çš„åˆ†è¾¨ç‡æ˜¯ 1024x768ï¼Œæ¯ä¸€ä¸ªåƒç´ çš„é¢œè‰²ç”¨ 32 ä½æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆ Framebuffer çš„å¤§å°å°±æ˜¯ï¼š1024x768x32/8=3145728 å­—èŠ‚ã€‚</p><p>ç®€å•ä»‹ç» LCD çš„æ“ä½œåŸç†ï¼š</p><ul><li>é©±åŠ¨ç¨‹åºè®¾ç½®å¥½ LCD æ§åˆ¶å™¨ï¼šæ ¹æ® LCD çš„å‚æ•°è®¾ç½® LCD æ§åˆ¶å™¨çš„æ—¶åºã€ä¿¡å·ææ€§ï¼›æ ¹æ® LCD åˆ†è¾¨ç‡ã€BPP åˆ†é… Framebuffer</li><li>APP ä½¿ç”¨ ioctl è·å¾— LCD åˆ†è¾¨ç‡ã€BPP</li><li>APP é€šè¿‡ mmap æ˜ å°„ Framebufferï¼Œåœ¨ Framebuffer ä¸­å†™å…¥æ•°æ®</li></ul><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO3.png"></p><p>å‡è®¾éœ€è¦è®¾ç½® LCD ä¸­åæ ‡ (x,y) å¤„åƒç´ çš„é¢œè‰²ï¼Œé¦–è¦è¦æ‰¾åˆ°è¿™ä¸ªåƒç´ å¯¹åº”çš„å†…å­˜ï¼Œç„¶åæ ¹æ®å®ƒçš„ BPP å€¼è®¾ç½®é¢œè‰²ã€‚å‡è®¾ fb_base æ˜¯ APP æ‰§è¡Œ mmap åå¾—åˆ°çš„ Framebuffer åœ°å€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO4.png"></p><p>å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼ç®—å‡º (x,y) åæ ‡å¤„åƒç´ å¯¹åº”çš„ Framebuffer åœ°å€ï¼š(xï¼Œy) åƒç´ èµ·å§‹åœ°å€=fb_base+(xres*bpp/8)_y + x_bpp/8</p><p>æœ€åä¸€ä¸ªè¦è§£å†³çš„é—®é¢˜å°±æ˜¯åƒç´ çš„é¢œè‰²æ€ä¹ˆè¡¨ç¤ºï¼Ÿå®ƒæ˜¯ç”¨ RGB ä¸‰åŸè‰²ï¼ˆçº¢ã€ç»¿ã€è“ï¼‰æ¥è¡¨ç¤ºçš„ï¼Œåœ¨ä¸åŒçš„ BPP æ ¼å¼ä¸­ï¼Œç”¨ä¸åŒçš„ä½æ¥åˆ†åˆ«è¡¨ç¤º Rã€Gã€Bï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO5.png"></p><p>å¯¹äº 32BPPï¼Œä¸€èˆ¬åªè®¾ç½®å…¶ä¸­çš„ä½ 24 ä½ï¼Œé«˜ 8 ä½è¡¨ç¤ºé€æ˜åº¦ï¼Œä¸€èˆ¬çš„ LCD éƒ½ä¸æ”¯æŒã€‚</p><p>å¯¹äº 24BPPï¼Œç¡¬ä»¶ä¸Šä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œåœ¨ Framebuffer ä¸­ä¹Ÿæ˜¯ç”¨ 32 ä½æ¥è¡¨ç¤ºï¼Œæ•ˆæœè·Ÿ 32BPP æ˜¯ä¸€æ ·çš„ã€‚</p><p>å¯¹äº 16BPPï¼Œå¸¸ç”¨çš„æ˜¯ RGB565ï¼›å¾ˆå°‘çš„åœºåˆä¼šç”¨åˆ° RGB555ï¼Œè¿™å¯ä»¥é€šè¿‡ ioctl è¯»å–é©±åŠ¨ç¨‹åºä¸­çš„ RGB ä½åç§»æ¥ç¡®å®šä½¿ç”¨å“ªä¸€ç§æ ¼å¼ã€‚</p><h1 id="æ–‡å­—æ˜¾ç¤º">æ–‡å­—æ˜¾ç¤º</h1><h2 id="å­—ç¬¦çš„ç¼–ç æ–¹å¼åŒºåˆ†ç¼–ç å’Œå­—ä½“">å­—ç¬¦çš„ç¼–ç æ–¹å¼ï¼ˆåŒºåˆ†ç¼–ç å’Œå­—ä½“ï¼‰</h2><p>åœ¨è®¡ç®—æœºä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°çš„å­—ç¬¦â€œAâ€å¯èƒ½é•¿è¿™æ ·ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO6.png"></p><p>ä¹Ÿå¯èƒ½é•¿è¿™æ ·ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO7.png"></p><p>å¯¹äºåŒä¸€ä¸ª TXT æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä½ åœ¨ Notepad ä¸Šé€‰æ‹©ä¸åŒå­—ä½“æ—¶ï¼Œå­—ç¬¦æ˜¾ç¤ºçš„å½¢çŠ¶ä¸ä¸€æ ·ã€‚</p><p>æ‰€ä»¥ TXT æ–‡ä»¶ä¸­ä¿å­˜çš„æ˜¯å­—ç¬¦çš„æ ¸å¿ƒï¼šå®ƒçš„ç¼–ç å€¼ã€‚è€Œ Notepad ä¸Šæ˜¾ç¤ºæ—¶ï¼Œè¿™äº›å­—ç¬¦å¯¹åº”ä»€ä¹ˆæ ·çš„å½¢çŠ¶æ€ï¼Œè¿™æ˜¯ç”±å­—ç¬¦æ–‡ä»¶å†³å®šçš„ã€‚ç¼–ç å€¼ï¼Œå­—ä½“æ˜¯ä¸¤ä¸ªä¸ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ A çš„ç¼–ç å€¼æ˜¯ 0x41ï¼Œä½†æ˜¯åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥æ—¶å¯ä»¥ä½¿ç”¨ä¸åŒçš„å½¢çŠ¶ã€‚</p><h3 id="ascii">ASCII</h3><p>æ˜¯â€œAmerican Standard Code for Information Interchangeâ€çš„ç¼©å†™ï¼Œç¾å›½ä¿¡æ¯äº¤æ¢æ ‡å‡†ä»£ç ã€‚ <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO8.png"></p><h3 id="ansi">ANSI</h3><p>ä½¿ç”¨è®°äº‹æœ¬ä¿å­˜æ–‡ä»¶æ—¶ï¼Œå¯ä»¥é€‰æ‹©â€œANSIâ€ç¼–ç ï¼Œå´æ²¡æœ‰â€œASCIIâ€ï¼Œå„ä¸‹å›¾æ‰€ç¤ºã€‚æ€ä¹ˆå›äº‹ï¼Ÿ</p><p>ASNI æ˜¯ ASCII çš„æ‰©å±•ï¼Œå‘ä¸‹åŒ…å« ASCIIã€‚å¯¹äº ASCII å­—ç¬¦ä»ä»¥ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œå¯¹äºé ASCII å­—ç¬¦åˆ™ä½¿ç”¨ 2 å­—èŠ‚æ¥è¡¨ç¤ºã€‚å¹¶æ²¡æœ‰å›ºå®šçš„ ASNI ç¼–ç ï¼Œå®ƒè·Ÿâ€œæœ¬åœ°åŒ–â€(locale) å¯†åˆ‡ç›¸å…³ã€‚æ¯”å¦‚åœ¨ä¸­å›½å¤§é™†åœ°åŒºï¼ŒANSI çš„é»˜è®¤ç¼–ç æ˜¯ GB2312ï¼›åœ¨æ¸¯æ¾³å°åœ°åŒºé»˜è®¤ç¼–ç æ˜¯ BIG5ã€‚ä»¥æ•°å€¼â€œ0xd0d6â€ä¸ºä¾‹ï¼Œå¯¹äº GB2312 ç¼–ç å®ƒè¡¨ç¤ºâ€œä¸­â€ï¼›å¯¹äº BIG5 ç¼–ç å®ƒè¡¨ç¤ºâ€œç¬¢â€ã€‚æ‰€ä»¥å¯¹äº ANSI ç¼–ç çš„ TXT æ–‡ä»¶ï¼Œå¦‚æœä½ æ‰“å¼€å®ƒå‘ç°ä¹±ç ï¼Œé‚£ä¹ˆè¿˜å¾—å†æ¬¡ç»†åˆ†å®ƒçš„å…·ä½“ç¼–ç ã€‚</p><p>è¿™ä»…ä»…æ˜¯åœ¨ä¸­å›½åœ°åŒºå°±å‡ºç°è¿™äº›ä¸å…¼å®¹çš„é—®é¢˜ã€‚å¯¹äºä¸åŒå›½å®¶ï¼Œå®ƒä»¬é»˜è®¤çš„ ANSI ç¼–ç å„ä¸ç›¸åŒï¼Œæ‰€ä»¥åŒä¸€ä¸ª TXT æ–‡ä»¶åœ¨ä¸åŒå›½å®¶å°±å¾ˆæœ‰å¯èƒ½å‡ºç°ä¹±ç ã€‚</p><p>æ ¹æœ¬çš„åŸç†åœ¨äºæ²¡æœ‰â€œç»Ÿä¸€çš„ç¼–ç â€ï¼Œé‚£è§£å†³æ–¹æ³•è‡ªç„¶å°±æ˜¯ä½¿ç”¨â€œç»Ÿä¸€çš„ç¼–ç â€ï¼šUNICODEã€‚</p><h3 id="unicode">UNICODE</h3><p>åœ¨ ANSI æ ‡å‡†ä¸­ï¼Œå¾ˆå¤šç§æ–‡å­—éƒ½æœ‰è‡ªå·±çš„ç¼–ç æ ‡å‡†ï¼Œæ±‰å­—ç®€ä½“å­—æœ‰ GB2312ã€ç¹ä½“å­—æœ‰ BIG5ï¼Œè¿™éš¾å…åŒä¸€ä¸ªæ•°å€¼å¯¹åº”ä¸åŒå­—ç¬¦ã€‚æ¯”å¦‚æ•°å€¼â€œ0xd0d6â€ï¼Œå¯¹äº GB2312 ç¼–ç å®ƒè¡¨ç¤ºâ€œä¸­â€ï¼›å¯¹äº BIG5 ç¼–ç å®ƒè¡¨ç¤ºâ€œç¬¢â€ã€‚è¿™é€ æˆäº†ä½¿ç”¨ ANSI ç¼–ç ä¿å­˜çš„æ–‡ä»¶ï¼Œä¸é€‚åˆè·¨åœ°åŒºäº¤æµã€‚</p><p>UNICODE ç¼–ç å°±æ˜¯è§£å†³è¿™ç±»é—®é¢˜ï¼šå¯¹äºåœ°çƒä¸Šä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼Œéƒ½ç»™å®ƒä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼ã€‚</p><p>UNICODE ä»ç„¶å‘ä¸‹å…¼å®¹ ASCIIï¼Œä½†æ˜¯å¯¹äºå…¶ä»–å­—ç¬¦ä¼šæœ‰å¯¹åº”çš„æ•°å€¼ï¼Œæ¯”å¦‚å¯¹äºâ€œä¸­â€ã€â€œç¬¢â€ï¼Œå®ƒä»¬çš„æ•°å€¼åˆ†åˆ«æ˜¯ï¼š0x4e2dã€0x7b22</p><p>UNICODE ä¸­çš„æ•°å€¼èŒƒå›´æ˜¯ 0x0000 è‡³ 0x10FFFFï¼Œæœ‰ 1,114,111 å³ 100 å¤šä¸‡ä¸ªæ•°å€¼ï¼Œå¯ä»¥è¡¨ç¤º 100 å¤šä¸‡ä¸ªå­—ç¬¦ï¼Œè¶³å¤Ÿåœ°çƒäººä½¿ç”¨äº†ã€‚</p><ul><li>UNICODE ç¼–ç å®ç°</li></ul><p>æ‰€è°“ç¼–ç å®ç°ï¼Œå°±æ˜¯å¯¹äºä¸€ä¸ªæ•°å€¼ï¼Œæ€ä¹ˆè¡¨ç¤ºå®ƒã€‚è¿™å¾ˆå¥‡æ€ªï¼Œæ•°å€¼è¿˜èƒ½æ€ä¹ˆè¡¨ç¤ºï¼Ÿæ¯”å¦‚â€œä¸­â€çš„ UNICODE å€¼æ˜¯ 0x4e2dï¼Œåœ¨ TXT æ–‡ä»¶ä¸­æ€ä¹ˆè¡¨ç¤º 0x4e2dï¼Ÿç›´æ¥å†™å…¥ 0x4e2dï¼Ÿä¸è¡Œï¼</p><p>æ¯”å¦‚åœ¨ TXT æ–‡ä»¶ä¸­å†™å…¥ 2 å­—èŠ‚æ•°æ®â€œ0x2d 0x4eâ€ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¡¨ç¤ºâ€œä¸­â€å­—å—ï¼Ÿä¸èƒ½ï¼å®ƒä»¬å¯¹åº” ASCII å­—ç¬¦â€œ-Nâ€ã€‚</p><p>é—®é¢˜çš„å…³é”®åœ¨äºï¼šæ€ä¹ˆæ–­å­—ã€‚åœ¨ TXT æ–‡ä»¶ä¸­ï¼Œ2 å­—èŠ‚æ•°æ®â€œ0x2d 0x4eâ€æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“çœ‹å¾…ï¼Œè¿˜æ˜¯æ‹†æˆ 2 éƒ¨åˆ†çœ‹å¾…ï¼Ÿ</p><p>æ‰€ä»¥ï¼Œéœ€è¦ç”¨ä¸€å®šçš„æŠ€å·§æ¥è¡¨ç¤ºæ•°å€¼ï¼Œè¿™å°±å¯¹åº”ä¸åŒçš„ç¼–ç å®ç°ã€‚</p><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼š</p><ul><li>ASCII ç¼–ç ä¸­ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œåªç”¨åˆ°å…¶ä¸­çš„ 7 ä½ï¼Œæœ€é«˜ä½æ’ä¸º 0</li><li>ANSI ç¼–ç ä¸­ï¼Œå¯¹äº ASCII å­—ç¬¦ä»ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤º (BIT7 æ˜¯ 0)ï¼Œå¯¹äºé ASCII å­—ç¬¦ä¸€èˆ¬ä½¿ç”¨ 2 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œé ASCII å­—ç¬¦çš„æ•°å€¼ BIT7 éƒ½æ˜¯ 1</li><li>UNICODEï¼šè¿™å°±æœ‰ç‚¹å¤æ‚äº†ï¼Œä¸‹é¢ä¸€ä¸€è®²è§£</li></ul><p>å…ˆç”¨è®°äº‹æœ¬æ–°å»º 3 ä¸ªæ–‡ä»¶ï¼šutf-16_le.txtã€utf-16_be.txtã€utf-8.txtã€bom_utf-8.txtï¼Œé‡Œé¢çš„å†…å®¹éƒ½æ˜¯â€œab ä¸­â€ï¼Œä¿å­˜æ—¶ç¼–ç åˆ†åˆ«é€‰æ‹©â€œUTF-16 LEâ€ã€â€œUTF-16 BEâ€ã€â€œUTF-8â€ã€â€œå¸¦æœ‰ BOM çš„ UTF-8â€ï¼Œä¸‹å›¾æ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO9.png"> æ€ä¹ˆè¡¨ç¤ºä¸€ä¸ª UNICODE æ•°å€¼ï¼Ÿ</p><ul><li>ä½¿ç”¨ 3 ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ª UNICODE</li></ul><p>ä¸ï¼Œå¤ªæµªè´¹ã€‚</p><p>UNICODE çš„æœ€å¤§å€¼æ˜¯ 0x10FFFFï¼Œé‚£ä½¿ç”¨ 3 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ª UNICODE æ•°å€¼ï¼Ÿè¿™å½“ç„¶æ˜¯å¾ˆçœäº‹çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼šé€ æˆæµªè´¹ï¼Œæ¯”å¦‚å­—ç¬¦ A çš„ UNICOCDE å€¼æ˜¯ 0x41ï¼Œéš¾é“ä¹Ÿç”¨â€œ0x41 0x00 0x00â€è¿™ 3 ä¸ªå­—èŠ‚æ¥è¡¨ç¤º</p><ul><li>UCS-2 Little endian/UTF-16 LE</li></ul><p>æ¯ä¸ª UNICODE å€¼ç”¨ 3 å­—èŠ‚æ¥è¡¨ç¤ºæœ‰ç‚¹æµªè´¹ï¼Œé‚£åªç”¨ 2 å­—èŠ‚å‘¢ï¼Ÿå®ƒå¯ä»¥è¡¨ç¤º 2^16=65536 ä¸ªå­—ç¬¦ï¼Œå…¨ä¸–ç•Œå¸¸ç”¨çš„å­—ç¬¦éƒ½å¯ä»¥è¡¨ç¤ºäº†ã€‚</p><p>Little endian è¡¨ç¤ºå°å­—èŠ‚åºï¼Œæ•°å€¼ä¸­æƒé‡ä½çš„å­—èŠ‚æ”¾åœ¨å‰é¢ï¼Œæ¯”å¦‚å­—ç¬¦â€œA ä¸­â€åœ¨ TXT æ–‡ä»¶ä¸­çš„æ•°å€¼å¦‚ä¸‹ï¼Œå…¶ä¸­çš„â€œAâ€ä½¿ç”¨â€œ0x41 0x00â€ä¸¤å­—èŠ‚è¡¨ç¤ºï¼›â€œä¸­â€ä½¿ç”¨â€œ0x2d 0x4eâ€ä¸¤å­—èŠ‚è¡¨ç¤ºã€‚æ–‡ä»¶å¼€å¤´çš„â€œ0xff 0xfeâ€è¡¨ç¤ºâ€œUTF-16 LEâ€ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO10.png"></p><ul><li>UCS-2 Big endian/UTF-16 BE</li></ul><p>Big endian è¡¨ç¤ºå¤§å­—èŠ‚åºï¼Œæ•°å€¼ä¸­æƒé‡ä½çš„å­—èŠ‚æ”¾åœ¨åé¢ï¼Œæ¯”å¦‚å­—ç¬¦â€œab ä¸­â€åœ¨ TXT æ–‡ä»¶ä¸­çš„æ•°å€¼å¦‚ä¸‹ï¼Œå…¶ä¸­çš„â€œAâ€ä½¿ç”¨â€œ0x00 0x41â€ä¸¤å­—èŠ‚è¡¨ç¤ºï¼›â€œä¸­â€ä½¿ç”¨â€œ0x4e 0x2dâ€ä¸¤å­—èŠ‚è¡¨ç¤ºã€‚æ–‡ä»¶å¼€å¤´çš„â€œ0xfe 0xffâ€è¡¨ç¤ºâ€œUTF-16 BEâ€ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO11.png"></p><ul><li>UTF8</li></ul><p>åœ¨ä¸Šé¢ 2 ç§æ–¹æ³•ä¸­ï¼Œæ¯ä¸€ä¸ª UNICODE ä½¿ç”¨ 2 å­—èŠ‚æ¥è¡¨ç¤ºï¼Œè¿™æœ‰ 3 ä¸ªç¼ºç‚¹ï¼šè¡¨ç¤ºçš„å­—ç¬¦æ•°é‡æœ‰é™ã€å¯¹äº ASCII å­—ç¬¦æœ‰ç©ºé—´æµªè´¹ã€å¦‚æœæ–‡ä»¶ä¸­æœ‰æŸä¸ªå­—èŠ‚ä¸¢å¤±ï¼Œè¿™ä¼šä½¿å¾—åé¢æ‰€æœ‰å­—ç¬¦éƒ½å› ä¸ºé”™ä½è€Œæ— æ³•æ˜¾ç¤ºã€‚</p><p>ä½¿ç”¨ UTF8 å¯ä»¥è§£å†³ä¸Šè¿°æ‰€æœ‰é—®é¢˜ã€‚UTF8 æ˜¯å˜é•¿çš„ç¼–ç æ–¹æ³•ï¼Œæœ‰ 2 ç§ UTF8 æ ¼å¼çš„æ–‡ä»¶ï¼šå¸¦æœ‰å¤´éƒ¨ã€ä¸å¸¦å¤´éƒ¨ã€‚å…ˆä¸¾ä¾‹ï¼Œçœ‹ä¸‹å›¾ï¼š <img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO12.png"></p><p>å¯¹äºå…¶ä¸­çš„ ASCII å­—ç¬¦ï¼Œåœ¨ UTF8 æ–‡ä»¶ä¸­ç›´æ¥ç”¨å…¶ ASCII ç æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­çš„ 0x61 è¡¨ç¤ºå­—ç¬¦ aã€0x62 è¡¨ç¤ºå­—ç¬¦ bã€‚ä¸Šå›¾ä¸­çš„ 3 ä¸ªå­—èŠ‚â€œ0xe4 0xb8 0xadâ€è¡¨ç¤ºçš„æ•°å€¼æ˜¯ 0x4e2dï¼Œå¯¹åº”â€œä¸­â€çš„ UNICODE ç ã€‚</p><p>å¯¹äºé ASCII å­—ç¬¦ï¼Œä½¿ç”¨å˜é•¿çš„ç¼–ç ï¼šæ¯ä¸€ä¸ªå­—èŠ‚çš„é«˜ä½éƒ½è‡ªå¸¦é•¿åº¦ä¿¡æ¯ã€‚è¯·çœ‹ä¸‹å›¾</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO13.png"></p><p>ä¸Šå›¾ä¸­ï¼Œ0xe4 çš„äºŒè¿›åˆ¶æ˜¯â€œ11100100â€ï¼Œé«˜ä½æœ‰ 3 ä¸ª 1ï¼Œè¡¨ç¤ºä»å½“å‰å­—èŠ‚èµ·æœ‰ 3 å­—èŠ‚å‚ä¸è¡¨ç¤º UNICODEï¼›</p><p>0xb8 çš„äºŒè¿›åˆ¶æ˜¯â€œ10111000â€ï¼Œé«˜ä½æœ‰ 1 ä¸ª 1ï¼Œè¡¨ç¤ºä»å½“å‰å­—èŠ‚èµ·æœ‰ 1 å­—èŠ‚å‚ä¸è¡¨ç¤º UNICODEï¼›</p><p>0xad çš„äºŒè¿›åˆ¶æ˜¯â€œ10101101â€ï¼Œé«˜ä½æœ‰ 1 ä¸ª 1ï¼Œè¡¨ç¤ºä»å½“å‰å­—èŠ‚èµ·æœ‰ 1 å­—èŠ‚å‚ä¸è¡¨ç¤º UNICODEï¼›</p><p>é™¤å»é«˜ä½çš„â€œ1110â€ã€â€œ10â€ã€â€œ10â€åï¼Œå‰©ä¸‹çš„äºŒè¿›åˆ¶æ•°ç»„åˆèµ·æ¥å¾—åˆ°â€œ01001110001101â€ï¼Œå®ƒå°±æ˜¯ 0x4e2dï¼Œå³â€œä¸­â€çš„ UNICODE å€¼ã€‚</p><p>ä½¿ç”¨ UTF8 ç¼–ç æ—¶ï¼Œå³ä½¿ TXT æ–‡ä»¶ä¸­ä¸¢å¤±äº†æŸäº›æ•°æ®ï¼Œä¹Ÿåªä¼šå½±å“åˆ°å½“å‰å­—ç¬¦çš„æ˜¾ç¤ºï¼Œåé¢çš„å­—ç¬¦ä¸å—å½±å“</p><h2 id="ascii-å­—ç¬¦çš„ç‚¹é˜µæ˜¾ç¤º">ASCII å­—ç¬¦çš„ç‚¹é˜µæ˜¾ç¤º</h2><p>è¦åœ¨ LCD ä¸­æ˜¾ç¤ºä¸€ä¸ª ASCII å­—ç¬¦ï¼Œå³è‹±æ–‡å­—æ¯è¿™äº›å­—ç¬¦ï¼Œé¦–å…ˆæ˜¯è¦æ‰¾åˆ°å­—ç¬¦å¯¹åº”çš„ç‚¹é˜µã€‚åœ¨ Linux å†…æ ¸æºç ä¸­æœ‰è¿™ä¸ªæ–‡ä»¶ï¼šlib_8x16.cï¼Œé‡Œé¢ä»¥æ•°ç»„å½¢å¼ä¿å­˜å„ä¸ªå­—ç¬¦çš„ç‚¹é˜µï¼Œæ¯”å¦‚ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO14.png"></p><p>æ•°ç»„é‡Œçš„æ•°å­—æ˜¯å¦‚ä½•è¡¨ç¤ºç‚¹é˜µçš„ï¼Ÿä»¥å­—ç¬¦ A ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO15.png"></p><p>ä¸Šå›¾å·¦ä¾§æœ‰ 16 è¡Œæ•°å€¼ï¼Œæ¯è¡Œ 1 ä¸ªå­—èŠ‚ã€‚æ¯ä¸€ä¸ªèŠ‚å¯¹åº”å³ä¾§ä¸€è¡Œä¸­ 8 ä¸ªåƒç´ ï¼šåƒç´ ä»å³è¾¹æ•°èµ·ï¼Œbit0 å¯¹åº”ç¬¬ 0 ä¸ªåƒç´ ï¼Œbit1 å¯¹åº”ç¬¬ 1 ä¸ªåƒç´ ï¼Œâ€¦â€¦ï¼Œbit7 å¯¹åº”ç¬¬ 7 ä¸ªåƒç´ ã€‚æŸä½çš„å€¼ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºå¯¹åº”çš„åƒç´ è¦è¢«ç‚¹äº®ï¼›å€¼ä¸º 0 æ—¶è¡¨ç¤ºå¯¹åº”çš„åƒç´ è¦ç†„ç­ã€‚</p><p>æ‰€ä»¥è¦æ˜¾ç¤ºæŸä¸ªå­—ç¬¦æ—¶ï¼Œæ ¹æ®å®ƒçš„ ASCII ç åœ¨ fontdata_8x16 æ•°ç»„ä¸­æ‰¾åˆ°å®ƒçš„ç‚¹é˜µï¼Œç„¶åå–å‡ºè¿™ 16 ä¸ªå­—èŠ‚å»æç”» 16 è¡Œåƒç´ ã€‚</p><p>æ¯”å¦‚å­—ç¬¦ A çš„ ASCII å€¼æ˜¯ 0x41ï¼Œé‚£ä¹ˆä» fontdata_8x16[0x41*16] å¼€å§‹å–å…¶ç‚¹é˜µæ•°æ®ã€‚</p><h3 id="çŸ¢é‡å­—ä½“å¼•å…¥">çŸ¢é‡å­—ä½“å¼•å…¥</h3><p>ä½¿ç”¨ç‚¹é˜µå­—åº“æ˜¾ç¤ºè‹±æ–‡å­—æ¯ã€æ±‰å­—æ—¶ï¼Œå¤§å°å›ºå®šï¼Œå¦‚æœæ”¾å¤§ç¼©å°åˆ™ä¼šæ¨¡ç³Šç”šè‡³æœ‰é”¯é½¿å‡ºç°ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•ç”¨çŸ¢é‡å­—ä½“ã€‚</p><p>çŸ¢é‡å­—ä½“å½¢æˆåˆ†ä¸‰æ­¥ï¼š</p><ul><li>ç¡®å®šå…³é”®ç‚¹</li><li>ä½¿ç”¨æ•°å­¦æ›²çº¿ï¼ˆè´å¡å°”æ›²çº¿ï¼‰è¿æ¥å¤´é”®ç‚¹</li><li>å¡«å……é—­åˆåŒºçº¿å†…éƒ¨ç©ºé—´</li></ul><p>ä»€ä¹ˆæ˜¯å…³é”®ç‚¹ï¼Ÿä»¥å­—æ¯â€œAâ€ä¸ºä¾‹ï¼Œå®ƒçš„çš„å…³é”®ç‚¹å¦‚ä¸‹å›¾ä¸­çš„é»„è‰²æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO16.png"></p><p>å¦‚æœéœ€è¦æ”¾å¤§æˆ–è€…ç¼©å°å­—ä½“ï¼Œå…³é”®ç‚¹çš„ç›¸å¯¹ä½ç½®æ˜¯ä¸å˜çš„ï¼Œåªè¦æ•°å­¦æ›²çº¿å¹³æ»‘ï¼Œå­—ä½“å°±ä¸ä¼šå˜å½¢ã€‚</p><h3 id="freetype-ä»‹ç»">Freetype ä»‹ç»</h3><p>Freetype æ˜¯å¼€æºçš„å­—ä½“å¼•æ“åº“ï¼Œå®ƒæä¾›ç»Ÿä¸€çš„æ¥å£æ¥è®¿é—®å¤šç§å­—ä½“æ ¼å¼æ–‡ä»¶ï¼Œä»è€Œå®ç°çŸ¢é‡å­—ä½“æ˜¾ç¤ºã€‚æˆ‘ä»¬åªéœ€è¦ç§»æ¤è¿™ä¸ªå­—ä½“å¼•æ“ï¼Œè°ƒç”¨å¯¹åº”çš„ API æ¥å£ï¼Œæä¾›å­—ä½“æ–‡ä»¶ï¼Œå°±å¯ä»¥è®© freetype åº“å¸®æˆ‘ä»¬å–å‡ºå…³é”®ç‚¹ã€å®ç°é—­åˆæ›²çº¿ï¼Œå¡«å……é¢œè‰²ï¼Œè¾¾åˆ°æ˜¾ç¤ºçŸ¢é‡å­—ä½“çš„ç›®çš„ã€‚</p><p>å…³é”®ç‚¹ (glyph) å­˜åœ¨å­—ä½“æ–‡ä»¶ä¸­ï¼ŒWindows ä½¿ç”¨çš„å­—ä½“æ–‡ä»¶åœ¨ c:ç›®å½•ä¸‹ï¼Œæ‰©å±•åä¸º TTF çš„éƒ½æ˜¯çŸ¢é‡å­—åº“ï¼Œæœ¬æ¬¡ä½¿ç”¨å®éªŒä½¿ç”¨çš„æ˜¯æ–°å®‹å­—ä½“ simsun.ttcã€‚</p><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ï¼Œæ€ä¹ˆåœ¨å­—ä½“æ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å…³é”®ç‚¹ï¼Ÿ</p><p>é¦–å…ˆè¦ç¡®å®šè¯¥å­—ç¬¦çš„ç¼–ç å€¼ï¼šæ¯”å¦‚ ASCII ç ã€GB2312 ç ã€UNICODE ç ã€‚å¦‚æœå­—ä½“æ–‡ä»¶æ”¯æŒæŸç§ç¼–ç æ ¼å¼ (charset)ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ç±»ç¼–ç å€¼å»æ‰¾åˆ°è¯¥å­—ç¬¦çš„å…³é”®ç‚¹ (glyph)ã€‚æœ‰äº›å­—ä½“æ–‡ä»¶æ”¯æŒå¤šç§ç¼–ç æ ¼å¼ (charset)ï¼Œè¿™åœ¨æ–‡ä»¶ä¸­è¢«ç§°ä¸º charmapsï¼ˆæ³¨æ„ï¼šè¿™ä¸ªå•è¯æ˜¯å¤æ•°ï¼Œæ„å‘³ç€å¯èƒ½æ”¯æŒå¤šç§ charset)ã€‚</p><p>ä»¥ simsun.ttc ä¸ºå€¼ï¼Œè¯¥å­—ä½“æ–‡ä»¶çš„æ ¼å¦‚ä¸‹ï¼šå¤´éƒ¨å«æœ‰ charmapsï¼Œå¯ä»¥ä½¿ç”¨æŸç§ç¼–ç å€¼å» charmaps ä¸­æ‰¾åˆ°å®ƒå¯¹åº”çš„å…³é”®ç‚¹ã€‚ä¸‹å›¾ä¸­çš„â€œAã€Bã€ä¸­ã€å›½ã€éŸ¦â€ç­‰åªæ˜¯ glyph çš„ç¤ºæ„å›¾ï¼Œè¡¨ç¤ºå…³é”®ç‚¹ã€‚</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO17.png"></p><p>Charmaps è¡¨ç¤ºå­—ç¬¦æ˜ å°„è¡¨ï¼Œå­—ä½“æ–‡ä»¶å¯èƒ½æ”¯æŒå“ªä¸€äº›ç¼–ç ï¼ŒGB2312ã€UNICODEã€BIG5 æˆ–å…¶ä»–ã€‚å¦‚æœå­—ä½“æ–‡ä»¶æ”¯æŒè¯¥ç¼–ç ï¼Œä½¿ç”¨ç¼–ç å€¼é€šè¿‡ charmap å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ glyphï¼Œä¸€èˆ¬è€Œè¨€éƒ½æ”¯æŒ UNICODE ç ã€‚</p><p>æœ‰äº†ä»¥ä¸ŠåŸºç¡€ï¼Œä¸€ä¸ªæ–‡å­—çš„æ˜¾ç¤ºè¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ul><li>ç»™å®šä¸€ä¸ªå­—ç¬¦å¯ä»¥ç¡®å®šå®ƒçš„ç¼–ç å€¼ (ASCIIã€UNICODEã€GB2312)</li><li>è®¾ç½®å­—ä½“å¤§å°</li><li>æ ¹æ®ç¼–ç å€¼ï¼Œä»æ–‡ä»¶å¤´éƒ¨ä¸­é€šè¿‡ charmap æ‰¾åˆ°å¯¹åº”çš„å…³é”®ç‚¹ (glyph)ï¼Œå®ƒä¼šæ ¹æ®å­—ä½“å¤§å°è°ƒæ•´å…³é”®ç‚¹</li><li>æŠŠå…³é”®ç‚¹è½¬æ¢ä¸ºä½å›¾ç‚¹é˜µ</li><li>åœ¨ LCD ä¸Šæ˜¾ç¤ºå‡ºæ¥</li></ul><p>ä½¿ç”¨ï¼š</p><ul><li>åˆå§‹åŒ–ï¼šFT_InitFreetype</li><li>åŠ è½½ï¼ˆæ‰“å¼€ï¼‰å­—ä½“ Faceï¼šFT_New_Face</li><li>è®¾ç½®å­—ä½“å¤§å°ï¼šFT_Set_Char_Sizes æˆ– FT_Set_Pixel_Sizes</li><li>é€‰æ‹© charmapï¼šFT_Select_Charmap</li><li>æ ¹æ®ç¼–ç å€¼ charcode æ‰¾åˆ° glyph_indexï¼šglyph_index = FT_Get_Char_Indexï¼ˆfaceï¼Œcharcodeï¼‰</li><li>æ ¹æ® glyph_index å–å‡º glyphï¼šFT_Load_Glyphï¼ˆfaceï¼Œglyph_indexï¼‰</li><li>è½¬ä¸ºä½å›¾ï¼šFT_Render_Glyph</li><li>ç§»åŠ¨æˆ–æ—‹è½¬ï¼šFT_Set_Transform</li><li>æœ€åæ˜¾ç¤ºå‡ºæ¥</li></ul><p>ä¸Šé¢çš„â‘¤â‘¥â‘¦å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‡½æ•°ä»£æ›¿ï¼šFT_Load_Char(face, charcode, FT_LOAD_RENDER)ï¼Œå®ƒå°±å¯ä»¥å¾—åˆ°ä½å›¾ã€‚</p><h1 id="è¾“å…¥ç³»ç»Ÿåº”ç”¨ç¼–ç¨‹">è¾“å…¥ç³»ç»Ÿåº”ç”¨ç¼–ç¨‹</h1><h2 id="è¾“å…¥ç³»ç»Ÿæ¡†æ¶åŠè°ƒè¯•">è¾“å…¥ç³»ç»Ÿæ¡†æ¶åŠè°ƒè¯•</h2><h3 id="æ¡†æ¶æ¦‚è¿°">æ¡†æ¶æ¦‚è¿°</h3><p>è¾“å…¥ç³»ç»Ÿæ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO18.png"></p><p>å‡è®¾ç”¨æˆ·ç¨‹åºç›´æ¥è®¿é—®/dev/input/event0 è®¾å¤‡èŠ‚ç‚¹ï¼Œæˆ–è€…ä½¿ç”¨ tslib è®¿é—®è®¾å¤‡èŠ‚ç‚¹ï¼Œæ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>APP å‘èµ·è¯»æ“ä½œï¼Œè‹¥æ— æ•°æ®åˆ™ä¼‘çœ ï¼›</li><li>ç”¨æˆ·æ“ä½œè®¾å¤‡ï¼Œç¡¬ä»¶ä¸Šäº§ç”Ÿä¸­æ–­ï¼›</li><li><p>è¾“å…¥ç³»ç»Ÿé©±åŠ¨å±‚å¯¹åº”çš„é©±åŠ¨ç¨‹åºå¤„ç†ä¸­æ–­ï¼š<br>è¯»å–åˆ°æ•°æ®ï¼Œè½¬æ¢ä¸ºæ ‡å‡†çš„è¾“å…¥äº‹ä»¶ï¼Œå‘æ ¸å¿ƒå±‚æ±‡æŠ¥ã€‚ æ‰€è°“è¾“å…¥äº‹ä»¶å°±æ˜¯ä¸€ä¸ªâ€œstruct input_eventâ€ç»“æ„ä½“ã€‚</p></li><li><p>æ ¸å¿ƒå±‚å¯ä»¥å†³å®šæŠŠè¾“å…¥äº‹ä»¶è½¬å‘ç»™ä¸Šé¢å“ªä¸ª handler æ¥å¤„ç†ï¼š<br>ä» handler çš„åå­—æ¥çœ‹ï¼Œå®ƒå°±æ˜¯ç”¨æ¥å¤„è¾“å…¥æ“ä½œçš„ã€‚æœ‰å¤šç§ handlerï¼Œæ¯”å¦‚ï¼ševdev_handlerã€kbd_handlerã€ joydev_handler ç­‰ç­‰ã€‚</p><p>æœ€å¸¸ç”¨çš„æ˜¯ evdev_handlerï¼šå®ƒåªæ˜¯æŠŠ input_event ç»“æ„ä½“ä¿å­˜åœ¨å†…æ ¸ buffer ç­‰ï¼ŒAPP æ¥è¯»å–æ—¶å°±åŸåŸæœ¬æœ¬åœ°è¿”å›ã€‚å®ƒ æ”¯æŒå¤šä¸ª APP åŒæ—¶è®¿é—®è¾“å…¥è®¾å¤‡ï¼Œæ¯ä¸ª APP éƒ½å¯ä»¥è·å¾—åŒä¸€ä»½è¾“å…¥äº‹ä»¶ã€‚</p><p>å½“ APP æ­£åœ¨ç­‰å¾…æ•°æ®æ—¶ï¼Œevdev_handler ä¼šæŠŠå®ƒå”¤é†’ï¼Œè¿™æ · APP å°±å¯ä»¥è¿”å›æ•°æ®ã€‚</p></li><li><p>APP å¯¹è¾“å…¥äº‹ä»¶çš„å¤„ç†ï¼š<br>APP è·å¾—æ•°æ®çš„æ–¹æ³•æœ‰ 2 ç§ï¼šç›´æ¥è®¿é—®è®¾å¤‡èŠ‚ç‚¹ï¼ˆæ¯”å¦‚/dev/input/event0,1,2,...)ï¼Œæˆ–è€…é€šè¿‡ tslibã€libinput è¿™ç±»åº“æ¥é—´æ¥è®¿é—®è®¾å¤‡èŠ‚ç‚¹ã€‚è¿™äº›åº“ç®€åŒ–äº†å¯¹æ•°æ®çš„å¤„ç†ã€‚</p></li></ul><h3 id="ç¼–å†™-app-éœ€è¦æŒæ¡çš„çŸ¥è¯†">ç¼–å†™ APP éœ€è¦æŒæ¡çš„çŸ¥è¯†</h3><h4 id="å†…æ ¸ä¸­æ€ä¹ˆè¡¨ç¤ºä¸€ä¸ªè¾“å…¥è®¾å¤‡">å†…æ ¸ä¸­æ€ä¹ˆè¡¨ç¤ºä¸€ä¸ªè¾“å…¥è®¾å¤‡ï¼Ÿ</h4><p>ä½¿ç”¨ input_dev ç»“æ„ä½“æ¥è¡¨ç¤ºè¾“å…¥è®¾å¤‡ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO19.png"></p><h4 id="app-å¯ä»¥å¾—åˆ°ä»€ä¹ˆæ•°æ®">APP å¯ä»¥å¾—åˆ°ä»€ä¹ˆæ•°æ®ï¼Ÿ</h4><p>å¯ä»¥å¾—åˆ°ä¸€ç³»åˆ—çš„è¾“å…¥äº‹ä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªä¸€ä¸ªâ€œstruct input_eventâ€ï¼Œå®ƒå®šä¹‰å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO20.png"></p><p>æ¯ä¸ªè¾“å…¥äº‹ä»¶ input_event ä¸­éƒ½å«æœ‰å‘ç”Ÿæ—¶é—´ï¼štimeval è¡¨ç¤ºçš„æ˜¯â€œè‡ªç³»ç»Ÿå¯åŠ¨ä»¥æ¥è¿‡äº†å¤šå°‘æ—¶é—´â€ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå«æœ‰â€œtv_secã€tv_usecâ€ä¸¤é¡¹ï¼ˆå³ç§’ã€å¾®ç§’ï¼‰ã€‚</p><p>è¾“å…¥äº‹ä»¶ input_event ä¸­æ›´é‡è¦çš„æ˜¯ï¼štypeï¼ˆå“ªç±»äº‹ä»¶ï¼‰ã€codeï¼ˆå“ªä¸ªäº‹ä»¶ï¼‰ã€valueï¼ˆäº‹ä»¶å€¼ï¼‰ï¼Œç»†è®²å¦‚ä¸‹ï¼š</p><ul><li><p>typeï¼šè¡¨ç¤ºå“ªç±»äº‹ä»¶<br>æ¯”å¦‚ EV_KEY è¡¨ç¤ºæŒ‰é”®ç±»ã€EV_REL è¡¨ç¤ºç›¸å¯¹ä½ç§»ï¼ˆæ¯”å¦‚é¼ æ ‡ï¼‰ï¼ŒEV_ABS è¡¨ç¤ºç»å¯¹ä½ç½®ï¼ˆæ¯”å¦‚è§¦æ‘¸å±ï¼‰ã€‚æœ‰è¿™å‡ ç±»äº‹ä»¶ï¼ˆå‚è€ƒ Linux å†…æ ¸å¤´æ–‡ä»¶ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO21.png"></p></li><li><p>codeï¼šè¡¨ç¤ºè¯¥ç±»äº‹ä»¶ä¸‹çš„å“ªä¸€ä¸ªäº‹ä»¶<br>æ¯”å¦‚å¯¹äº EV_KEYï¼ˆæŒ‰é”®ï¼‰ç±»äº‹ä»¶ï¼Œå®ƒè¡¨ç¤ºé”®ç›˜ã€‚é”®ç›˜ä¸Šæœ‰å¾ˆå¤šæŒ‰é”®ï¼Œæ¯”å¦‚æ•°å­—é”® 1ã€2ã€3ï¼Œå­—æ¯é”® Aã€Bã€C é‡Œç­‰ã€‚æ‰€ä»¥å¯ä»¥ æœ‰è¿™äº›äº‹ä»¶ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/%20LinuxIO22.png"></p><p>å¯¹äºè§¦æ‘¸å±ï¼Œå®ƒæä¾›çš„æ˜¯ç»å¯¹ä½ç½®ä¿¡æ¯ï¼Œæœ‰ X æ–¹å‘ã€Y æ–¹å‘ï¼Œè¿˜æœ‰å‹åŠ›å€¼ã€‚æ‰€ä»¥ code å€¼æœ‰è¿™äº›ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO23.png"></p></li><li><p>valueï¼šè¡¨ç¤ºäº‹ä»¶å€¼<br>å¯¹äºæŒ‰é”®ï¼Œå®ƒçš„ value å¯ä»¥æ˜¯ 0ï¼ˆè¡¨ç¤ºæŒ‰é”®è¢«æŒ‰ä¸‹ï¼‰ã€1ï¼ˆè¡¨ç¤ºæŒ‰é”®è¢«æ¾å¼€ï¼‰ã€2ï¼ˆè¡¨ç¤ºé•¿æŒ‰ï¼‰ï¼› å¯¹äºè§¦æ‘¸å±ï¼Œå®ƒçš„ value å°±æ˜¯åæ ‡å€¼ã€å‹åŠ›å€¼ã€‚</p></li><li><p>äº‹ä»¶ä¹‹é—´çš„ç•Œçº¿<br>APP è¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªè§¦æ‘¸å±çš„ä¸€ä¸ªè§¦ç‚¹ä¼šä¸ŠæŠ¥ Xã€Y ä½ç½®ä¿¡æ¯ï¼Œä¹Ÿå¯èƒ½ä¼šä¸ŠæŠ¥å‹åŠ›å€¼ã€‚</p><p>APP æ€ä¹ˆçŸ¥é“å®ƒå·²ç»è¯»åˆ°äº†å®Œæ•´çš„æ•°æ®ï¼Ÿ</p><p>é©±åŠ¨ç¨‹åºä¸ŠæŠ¥å®Œä¸€ç³»åˆ—çš„æ•°æ®åï¼Œä¼šä¸ŠæŠ¥ä¸€ä¸ªâ€œåŒæ­¥äº‹ä»¶â€ï¼Œè¡¨ç¤ºæ•°æ®ä¸ŠæŠ¥å®Œæ¯•ã€‚APP è¯»åˆ°â€œåŒæ­¥äº‹ä»¶â€æ—¶ï¼Œå°±çŸ¥é“å·²ç»è¯» å®Œäº†å½“å‰çš„æ•°æ®ã€‚</p><p>åŒæ­¥äº‹ä»¶ä¹Ÿæ˜¯ä¸€ä¸ª input_event ç»“æ„ä½“ï¼Œå®ƒçš„ typeã€codeã€value ä¸‰é¡¹éƒ½æ˜¯ 0ã€‚</p></li></ul><h4 id="è¾“å…¥å­ç³»ç»Ÿæ”¯æŒå®Œæ•´çš„-api-æ“ä½œ">è¾“å…¥å­ç³»ç»Ÿæ”¯æŒå®Œæ•´çš„ API æ“ä½œ</h4><p>æ”¯æŒè¿™äº›æœºåˆ¶ï¼šé˜»å¡ã€éé˜»å¡ã€POLL/SELECTã€å¼‚æ­¥é€šçŸ¥ã€‚</p><h3 id="è°ƒè¯•æŠ€å·§">è°ƒè¯•æŠ€å·§</h3><h4 id="ç¡®å®šè®¾å¤‡ä¿¡æ¯">ç¡®å®šè®¾å¤‡ä¿¡æ¯</h4><p>è¾“å…¥è®¾å¤‡çš„è®¾å¤‡èŠ‚ç‚¹åä¸º/dev/input/eventXï¼ˆä¹Ÿå¯èƒ½æ˜¯/dev/eventXï¼ŒX è¡¨ç¤º 0ã€1ã€2 ç­‰æ•°å­—ï¼‰ã€‚</p><p>æ€ä¹ˆçŸ¥é“è¿™äº›è®¾å¤‡èŠ‚ç‚¹å¯¹åº”ä»€ä¹ˆç¡¬ä»¶å‘¢ï¼Ÿå¯ä»¥åœ¨æ¿å­ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/bus/input/devices</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ¡æŒ‡ä»¤çš„å«ä¹‰å°±æ˜¯è·å–ä¸ event å¯¹åº”çš„ç›¸å…³è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO24.png"></p><p>é‚£ä¹ˆè¿™é‡Œçš„ Iã€Nã€Pã€Sã€Uã€Hã€B å¯¹åº”çš„æ¯ä¸€è¡Œæ˜¯ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ</p><ul><li><p>I:id of the deviceï¼ˆè®¾å¤‡ ID)<br>è¯¥å‚æ•°ç”±ç»“æ„ä½“ struct input_id æ¥è¿›è¡Œæè¿°ï¼Œé©±åŠ¨ç¨‹åºä¸­ä¼šå®šä¹‰è¿™æ ·çš„ç»“æ„ä½“ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO25.png"></p></li><li>N:name of the device è®¾å¤‡åç§°</li><li>P:physical path to the device in the system hierarchy ç³»ç»Ÿå±‚æ¬¡ç»“æ„ä¸­è®¾å¤‡çš„ç‰©ç†è·¯å¾„</li><li>S:sysfs path ä½äº sys æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„</li><li>U:unique identification code for the device(if device has it) è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ç </li><li>H:list of input handles associated with the device ä¸è®¾å¤‡å…³è”çš„è¾“å…¥å¥æŸ„åˆ—è¡¨</li><li><p>B:bitmapsï¼ˆä½å›¾ï¼‰</p></li></ul><p>PROP:device properties and quirksï¼ˆè®¾å¤‡å±æ€§ï¼‰ EV:types of events supported by the deviceï¼ˆè®¾å¤‡æ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼‰ KEY:keys/buttons this device hasï¼ˆæ­¤è®¾å¤‡å…·æœ‰çš„é”®/æŒ‰é’®ï¼‰ MSC:miscellaneous events supported by the deviceï¼ˆè®¾å¤‡æ”¯æŒçš„å…¶ä»–äº‹ä»¶ï¼‰ LED:leds present on the deviceï¼ˆè®¾å¤‡ä¸Šçš„æŒ‡ç¤ºç¯ï¼‰</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ B ä½å›¾ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­â€œB: EV=bâ€ç”¨æ¥è¡¨ç¤ºè¯¥è®¾å¤‡æ”¯æŒå“ªç±»è¾“å…¥äº‹ä»¶ã€‚b çš„äºŒè¿›åˆ¶æ˜¯ 1011ï¼Œbit0ã€1ã€3 ä¸º 1ï¼Œè¡¨ç¤ºè¯¥è®¾å¤‡æ”¯æŒ 0ã€1ã€3 è¿™ä¸‰ç±»äº‹ä»¶ï¼Œå³ EV_SYNã€EV_KEYã€EV_ABSã€‚</p><p>å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œâ€œB: ABS=2658000 3â€å¦‚ä½•ç†è§£ï¼Ÿ</p><p>å®ƒè¡¨ç¤ºè¯¥è®¾å¤‡æ”¯æŒ EV_ABS è¿™ä¸€ç±»äº‹ä»¶ä¸­çš„å“ªä¸€äº›äº‹ä»¶ã€‚è¿™æ˜¯ 2 ä¸ª 32 ä½çš„æ•°å­—ï¼š0x2658000ã€0x3ï¼Œé«˜ä½åœ¨å‰ä½ä½åœ¨åï¼Œç»„æˆä¸€ä¸ª 64 ä½çš„æ•°å­—ï¼šâ€œ0x2658000,00000003â€ï¼Œæ•°å€¼ä¸º 1 çš„ä½æœ‰ï¼š0ã€1ã€47ã€48ã€50ã€53ã€54ï¼Œå³ï¼š0ã€1ã€0x2fã€0x30ã€0x32ã€0x35ã€0x36ï¼Œå¯¹åº”ä»¥ä¸‹è¿™äº›å®ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO26.png"></p><p>å³è¿™æ¬¾è¾“å…¥è®¾å¤‡æ”¯æŒä¸Šè¿°çš„ ABS_Xã€ABS_Yã€ABS_MT_SLOTã€ABS_MT_TOUCH_MAJORã€ABS_MT_WIDTH_MAJORã€ABS_MT_POSITION_Xã€ABS_MT_POSITION_Y è¿™äº›ç»å¯¹ä½ç½®äº‹ä»¶</p><h4 id="ä½¿ç”¨å‘½ä»¤è¯»å–æ•°æ®">ä½¿ç”¨å‘½ä»¤è¯»å–æ•°æ®</h4><p>è°ƒè¯•è¾“å…¥ç³»ç»Ÿæ—¶ï¼Œç›´æ¥æ‰§è¡Œç±»ä¼¼ä¸‹é¢çš„å‘½ä»¤ï¼Œç„¶åæ“ä½œå¯¹åº”çš„è¾“å…¥è®¾å¤‡å³å¯è¯»å‡ºæ•°æ®ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump /dev/input/event0</span><br></pre></td></tr></tbody></table></figure><p>åœ¨å¼€å‘æ¿ä¸Šæ‰§è¡Œä¸Šè¿°å‘½ä»¤ä¹‹åï¼Œç‚¹å‡»æŒ‰é”®æˆ–æ˜¯ç‚¹å‡»è§¦æ‘¸å±ï¼Œå°±ä¼šæ‰“å°ä»¥ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO27.png"></p><p>ä¸Šå›¾ä¸­çš„ type ä¸º 3ï¼Œå¯¹åº” EV_ABSï¼›code ä¸º 0x35 å¯¹åº” ABS_MT_POSITION_Xï¼›code ä¸º 0x36 å¯¹åº” ABS_MT_POSITION_Yã€‚ä¸Šå›¾ä¸­è¿˜å‘ç°æœ‰ 2 ä¸ªåŒæ­¥äº‹ä»¶ï¼šå®ƒçš„ typeã€codeã€value éƒ½ä¸º 0ã€‚è¡¨ç¤ºç”µå®¹å±ä¸ŠæŠ¥äº† 2 æ¬¡å®Œæ•´çš„æ•°æ®ã€‚</p><h2 id="ä¸ä½¿ç”¨åº“çš„åº”ç”¨ç¨‹åºç¤ºä¾‹">ä¸ä½¿ç”¨åº“çš„åº”ç”¨ç¨‹åºç¤ºä¾‹</h2><h3 id="è¾“å…¥ç³»ç»Ÿæ”¯æŒå®Œæ•´çš„-api-æ“ä½œ">è¾“å…¥ç³»ç»Ÿæ”¯æŒå®Œæ•´çš„ API æ“ä½œ</h3><p>æ”¯æŒè¿™äº›æœºåˆ¶ï¼šé˜»å¡ã€éé˜»å¡ã€POLL/SELECTã€å¼‚æ­¥é€šçŸ¥ã€‚</p><h3 id="app-è®¿é—®ç¡¬ä»¶çš„-4-ç§æ–¹å¼å¦ˆå¦ˆæ€ä¹ˆçŸ¥é“å­©å­é†’äº†">APP è®¿é—®ç¡¬ä»¶çš„ 4 ç§æ–¹å¼ï¼šå¦ˆå¦ˆæ€ä¹ˆçŸ¥é“å­©å­é†’äº†</h3><ul><li><p>æŸ¥è¯¢æ–¹å¼<br>APP è°ƒç”¨ open å‡½æ•°æ—¶ï¼Œä¼ å…¥â€œO_NONBLOCKâ€è¡¨ç¤ºâ€œéé˜»å¡â€ã€‚</p><p>APP è°ƒç”¨ read å‡½æ•°è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœé©±åŠ¨ç¨‹åºä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆ APP çš„ read å‡½æ•°ä¼šè¿”å›æ•°æ®ï¼Œå¦åˆ™ä¹Ÿä¼šç«‹åˆ»è¿”å›é”™è¯¯ã€‚</p></li><li><p>ä¼‘çœ -å”¤é†’æ–¹å¼<br>APP è°ƒç”¨ open å‡½æ•°æ—¶ï¼Œä¸è¦ä¼ å…¥â€œO_NONBLOCKâ€ã€‚</p><p>APP è°ƒç”¨ read å‡½æ•°è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœé©±åŠ¨ç¨‹åºä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆ APP çš„ read å‡½æ•°ä¼šè¿”å›æ•°æ®ï¼›å¦åˆ™ APP å°±ä¼šåœ¨å†…æ ¸æ€ä¼‘çœ ï¼Œå½“æœ‰æ•°æ®æ—¶é©±åŠ¨ç¨‹åºä¼šæŠŠ APP å”¤é†’ï¼Œread å‡½æ•°æ¢å¤æ‰§è¡Œå¹¶è¿”å›æ•°æ®ç»™ APPã€‚</p></li><li><p>POLL/SELECT æ–¹å¼<br>POLL æœºåˆ¶ã€SELECT æœºåˆ¶æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªæ˜¯ APP æ¥å£å‡½æ•°ä¸ä¸€æ ·ã€‚</p><p>ç®€å•åœ°è¯´ï¼Œå®ƒä»¬å°±æ˜¯â€œå®šä¸ªé—¹é’Ÿâ€ï¼šåœ¨è°ƒç”¨ pollã€select å‡½æ•°æ—¶å¯ä»¥ä¼ å…¥â€œè¶…æ—¶æ—¶é—´â€ã€‚åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œæ¡ä»¶åˆé€‚æ—¶ï¼ˆæ¯”å¦‚æœ‰æ•°æ®å¯è¯»ã€æœ‰ç©ºé—´å¯å†™ï¼‰å°±ä¼šç«‹åˆ»è¿”å›ï¼Œå¦åˆ™ç­‰åˆ°â€œè¶…æ—¶æ—¶é—´â€ç»“æŸæ—¶è¿”å›é”™è¯¯ã€‚</p><p>ç”¨æ³•å¦‚ä¸‹ã€‚</p><p>APP å…ˆè°ƒç”¨ open å‡½æ•°æ—¶ã€‚</p><p>APP ä¸æ˜¯ç›´æ¥è°ƒç”¨ read å‡½æ•°ï¼Œè€Œæ˜¯å…ˆè°ƒç”¨ poll æˆ– select å‡½æ•°ï¼Œè¿™ 2 ä¸ªå‡½æ•°ä¸­å¯ä»¥ä¼ å…¥â€œè¶…æ—¶æ—¶é—´â€ã€‚å®ƒä»¬çš„ä½œç”¨æ˜¯ï¼šå¦‚æœ é©±åŠ¨ç¨‹åºä¸­æœ‰æ•°æ®ï¼Œåˆ™ç«‹åˆ»è¿”å›ï¼›å¦åˆ™å°±ä¼‘çœ ã€‚åœ¨ä¼‘çœ æœŸé—´ï¼Œå¦‚æœæœ‰äººæ“ä½œäº†ç¡¬ä»¶ï¼Œé©±åŠ¨ç¨‹åºè·å¾—æ•°æ®åå°±ä¼šæŠŠ APP å”¤ é†’ï¼Œå¯¼è‡´ poll æˆ– select ç«‹åˆ»è¿”å›ï¼›å¦‚æœåœ¨â€œè¶…æ—¶æ—¶é—´â€å†…æ— äººæ“ä½œç¡¬ä»¶ï¼Œåˆ™æ—¶é—´åˆ°å poll æˆ– select å‡½æ•°ä¹Ÿä¼šè¿”å›ã€‚APP å¯ ä»¥æ ¹æ®å‡½æ•°çš„è¿”å›å€¼åˆ¤æ–­è¿”å›åŸå› ï¼šæœ‰æ•°æ®ï¼Ÿæ— æ•°æ®è¶…æ—¶è¿”å›ï¼Ÿ</p><p>APP æ ¹æ® poll æˆ– select çš„è¿”å›å€¼åˆ¤æ–­æœ‰æ•°æ®ä¹‹åï¼Œå°±è°ƒç”¨ read å‡½æ•°è¯»å–æ•°æ®æ—¶ï¼Œè¿™æ—¶å°±ä¼šç«‹åˆ»è·å¾—æ•°æ®ã€‚</p><p>poll/select å‡½æ•°å¯ä»¥ç›‘æµ‹å¤šä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ç›‘æµ‹å¤šç§äº‹ä»¶ï¼šåœ¨è°ƒç”¨ poll å‡½æ•°æ—¶ï¼Œè¦æŒ‡æ˜ï¼š</p><ul><li><p>ä½ è¦ç›‘æµ‹å“ªä¸€ä¸ªæ–‡ä»¶ï¼šå“ªä¸€ä¸ª fd</p></li><li><p>ä½ æƒ³ç›‘æµ‹è¿™ä¸ªæ–‡ä»¶çš„å“ªç§äº‹ä»¶ï¼šæ˜¯ POLLINã€è¿˜æ˜¯ POLLOUT</p></li></ul><p>æœ€åï¼Œåœ¨ poll å‡½æ•°è¿”å›æ—¶ï¼Œè¦åˆ¤æ–­çŠ¶æ€ã€‚</p></li><li><p>å¼‚æ­¥é€šçŸ¥æ–¹å¼<br>æ‰€è°“å¼‚æ­¥é€šçŸ¥ï¼Œå°±æ˜¯ APP å¯ä»¥å¿™è‡ªå·±çš„äº‹ï¼Œå½“é©±åŠ¨ç¨‹åºç”¨æ•°æ®æ—¶å®ƒä¼šä¸»åŠ¨ç»™ APP å‘ä¿¡å·ï¼Œè¿™ä¼šå¯¼è‡´ APP æ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°ã€‚</p></li></ul><h2 id="tslib">tslib</h2><h3 id="tslib-æ¡†æ¶åˆ†æ">tslib æ¡†æ¶åˆ†æ</h3><p>tslib çš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO30.png"></p><p>æ ¸å¿ƒåœ¨äºâ€œpluginsâ€ç›®å½•é‡Œçš„â€œæ’ä»¶â€ï¼Œæˆ–ç§°ä¸ºâ€œmoduleâ€ã€‚è¿™ä¸ªç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ª moduleï¼Œæ¯ä¸ª module éƒ½æä¾› 2 ä¸ªå‡½æ•°ï¼šreadã€read_mtï¼Œå‰è€…ç”¨äºè¯»å–å•ç‚¹è§¦æ‘¸å±çš„æ•°æ®ï¼Œåè€…ç”¨äºè¯»å–å¤šç‚¹è§¦æ‘¸å±çš„æ•°æ®</p><p>è¦åˆ†æ tslib çš„æ¡†æ¶ï¼Œå…ˆçœ‹çœ‹ç¤ºä¾‹ç¨‹åºæ€ä¹ˆä½¿ç”¨ï¼Œæˆ‘ä»¬å‚è€ƒ ts_test.c å’Œ ts_test_mt.cï¼Œå‰è€…ç”¨äºä¸€èˆ¬è§¦æ‘¸å±ï¼ˆæ¯”å¦‚ç”µé˜»å±ã€å•ç‚¹ç”µå®¹å±ï¼‰ï¼Œåè€…ç”¨äºå¤šç‚¹è§¦æ‘¸å±ã€‚</p><p>ä¸€ä¸ªå›¾å°±å¯ä»¥å¼„æ¸…æ¥š tslib çš„æ¡†æ¶ï¼š</p><p><img src="https://raw.githubusercontent.com/carlyleliu/ImageHosting/main/TechnologyBlog/Note/LinuxIO31.png"></p><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠéŸ¦ä¸œå±±è€å¸ˆè¯¾ç¨‹ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kalibr</title>
      <link href="/2019/Note/kalibr/"/>
      <url>/2019/Note/kalibr/</url>
      
        <content type="html"><![CDATA[<h1 id="å®‰è£…">å®‰è£…</h1><h2 id="ros-å®‰è£…">ros å®‰è£…</h2><p>è®¾ç½® sources.list:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'echo "deb &lt;http://packages.ros.org/ros/ubuntu&gt; $(lsb_release -sc) main" &gt; /etc/apt/sources.list.d/ros-latest.list'</span></span><br></pre></td></tr></tbody></table></figure><p>è®¾ç½® keys:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-key adv --keyserver <span class="string">'hkp://keyserver.ubuntu.com:80'</span> --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654</span><br></pre></td></tr></tbody></table></figure><p>å®‰è£…ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ros-kinetic-desktop-full</span><br></pre></td></tr></tbody></table></figure><p>è®¾ç½®ç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"source /opt/ros/kinetic/setup.bash"</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">or</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"source /opt/ros/kinetic/setup.zsh"</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></tbody></table></figure><p>å®‰è£…ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-rosdep python-rosinstall python-rosinstall-generator python-wstool build-essential</span><br></pre></td></tr></tbody></table></figure><p>åˆå§‹åŒ– rosdep:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-rosdep</span><br><span class="line">sudo rosdep init</span><br><span class="line">rosdep update</span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="ç¼–è¯‘å®‰è£…-calibr">ç¼–è¯‘å®‰è£… calibr</h2><p>å®‰è£…ä¾èµ–ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-setuptools python-rosinstall ipython libeigen3-dev libboost-all-dev doxygen libopencv-dev ros-indigo-vision-opencv ros-indigo-image-transport-plugins ros-indigo-cmake-modules python-software-properties software-properties-common libpoco-dev python-matplotlib python-scipy python-git python-pip ipython libtbb-dev libblas-dev liblapack-dev python-catkin-tools libv4l-dev</span><br><span class="line"></span><br><span class="line">sudo pip install python-igraph --upgrade</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»º catkin å·¥ä½œç©ºé—´ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/kalibr_workspace/src</span><br><span class="line"><span class="built_in">cd</span> ~/kalibr_workspace</span><br><span class="line"><span class="built_in">source</span> /opt/ros/kinect/setup.bash</span><br><span class="line">catkin init</span><br><span class="line">catkin config --extend /opt/ros/kinect</span><br><span class="line">catkin config --merge-devel <span class="comment"># Necessary for catkin_tools &gt;= 0.4.</span></span><br><span class="line">catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release</span><br></pre></td></tr></tbody></table></figure><p>clone æºç ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/kalibr_workspace/src</span><br><span class="line">git <span class="built_in">clone</span> &lt;https://github.com/ethz-asl/Kalibr.git&gt;</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/kalibr_workspace</span><br><span class="line">catkin build -DCMAKE_BUILD_TYPE=Release -j4</span><br></pre></td></tr></tbody></table></figure><p>è®¾ç½®ç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/kalibr_workspace/devel/setup.bash</span><br></pre></td></tr></tbody></table></figure><h1 id="æ ¡å‡†">æ ¡å‡†</h1><h2 id="å¤šç›¸æœºæ ¡å‡†">å¤šç›¸æœºæ ¡å‡†</h2><p>å‡†å¤‡æ•°æ®é›†ï¼šåœ¨ dataset-dir ç›®å½•ä¸‹åˆ›å»º cam0ã€cam1... ç›®å½•ï¼Œå°†æ¯ä¸ªæ‘„åƒå¤´çš„æ•°æ®åˆ†åˆ«æ”¾åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_bagcreater --folder dataset-dir/ --output-bag output.bag</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œæ ¡å‡†å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_cameras --target april_6x6.yaml --bag output.bag --models pinhole-equi pinhole-equi --topics /cam0/image_raw /cam1/image_raw</span><br></pre></td></tr></tbody></table></figure><h2 id="ç›¸æœº-imu-æ ¡å‡†">ç›¸æœº-IMU æ ¡å‡†</h2><p>å‡†å¤‡æ•°æ®é›†ï¼šåœ¨ dataset-dir ç›®å½•ä¸‹åˆ›å»º cam0ã€cam1... ç›®å½•ï¼Œå°†æ¯ä¸ªæ‘„åƒå¤´çš„æ•°æ®åˆ†åˆ«æ”¾åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œå‡†å¤‡ imu æ•°æ®ä»¥ csv æ–‡ä»¶æ ¼å¼æ”¾å…¥ dataset-dir ç›®å½•ä¸‹ä»¥ imu0.csv ä¸ºæ–‡ä»¶åï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_bagcreater --folder dataset-dir/ --output-bag output.bag</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œæ ¡å‡†å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kalibr_calibrate_imu_camera --target april_6x6.yaml --cam camchain.yaml --imu imu_adis16448.yaml --bag output.bag --bag-from-to 5 45</span><br></pre></td></tr></tbody></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V0aHotYXNsL2thbGlici93aWtp">https://github.com/ethz-asl/kalibr/wiki<i class="fa fa-external-link-alt"></i></span></p><p>ğŸ’¡<br>1ã€csv æ–‡ä»¶é‡Œä¸èƒ½æœ‰ç©ºæ ¼ï¼Œæ—¶é—´å‚æ•°ä»¥ ns ä¸ºå•ä½å…± 19 ä½æ•°<br>2ã€ç›¸æœºå½•åƒä¸è¦æœ‰é•œåƒï¼Œå¦åˆ™ä¼šæ£€æµ‹ä¸åˆ°è§’ç‚¹</p><h2 id="å‡ºé”™">å‡ºé”™</h2><p>ğŸ’¡ æç¤ºï¼šâ€œSpline Coefficient Buffer Exceeded. Set larger buffer margins â€ åœ¨æ ‡å®šå‘½ä»¤æœ€åæ·»åŠ  --timeoffset-padding 0.1</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ffmpeg å¸¸ç”¨å‘½ä»¤</title>
      <link href="/2019/Note/ffmpegUsage/"/>
      <url>/2019/Note/ffmpegUsage/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆå¹¶æ–‡ä»¶">åˆå¹¶æ–‡ä»¶</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i <span class="string">"concat:file_name1.ts | file_name2.ts"</span> -c copy_out.ts</span><br></pre></td></tr></tbody></table></figure><h1 id="åœ¨è§†é¢‘æ–‡ä»¶ä¸­æå–å›¾ç‰‡">åœ¨è§†é¢‘æ–‡ä»¶ä¸­æå–å›¾ç‰‡</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i output.ts <span class="string">'%d.png'</span></span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h1 id="h264-è½¬-yuv">H264 è½¬ yuv</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i SampleEis2Venc.H264 -pix_fmt nv12 -vcodec rawvideo -an SampleRaw.yuv</span><br></pre></td></tr></tbody></table></figure><h1 id="å•å¼ å›¾ç‰‡ç”Ÿæˆ-h264-è§†é¢‘">å•å¼ å›¾ç‰‡ç”Ÿæˆ H264 è§†é¢‘</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -ss 0 -t 16 -f lavfi -i color=c=0x000000:s=1920x1080:r=25  -i test.jpg -filter_complex  <span class="string">"[1:v]scale=1920:1080[v1];[0:v][v1]overlay=0:0[outv]"</span> -map [outv] -c:v libx264 SampleRaw.H264 -y</span><br></pre></td></tr></tbody></table></figure><h1 id="æ¨ªå‘æ‹¼æ¥ä¸¤ä¸ªè§†é¢‘">æ¨ªå‘æ‹¼æ¥ä¸¤ä¸ªè§†é¢‘</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out1.mp4 -i out2.mp4 -filter_complex <span class="string">"[0:v]pad=iw*2:ih*1[a];[a][1:v]overlay=w"</span> out.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># pad æ˜¯å°†åˆæˆçš„è§†é¢‘å®½é«˜ï¼Œè¿™é‡Œ iw ä»£è¡¨ç¬¬ä¸€ä¸ªè§†é¢‘çš„å®½ï¼Œiw*2 ä»£è¡¨åˆæˆåçš„è§†é¢‘å®½åº¦åŠ å€ï¼Œih ä¸ºç¬¬ä¸€ä¸ªè§†é¢‘çš„é«˜ï¼Œåˆæˆçš„ä¸¤ä¸ªè§†é¢‘æœ€å¥½åˆ†è¾¨ç‡ä¸€è‡´ã€‚overlay æ˜¯è¦†ç›–ï¼Œ[a][1:v]overlay=wï¼Œåé¢ä»£è¡¨æ˜¯è¦†ç›–ä½ç½® w:0</span></span><br></pre></td></tr></tbody></table></figure><h1 id="ç«–å±æ‹¼æ¥ä¸¤ä¸ªè§†é¢‘">ç«–å±æ‹¼æ¥ä¸¤ä¸ªè§†é¢‘</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out1.mp4 -i out2.mp4 -filter_complex <span class="string">"[0:v]pad=iw:ih*2[a];[a][1:v]overlay=0:h"</span> out.mp4</span><br></pre></td></tr></tbody></table></figure><h1 id="æ¨ªå‘æ‹¼æ¥ä¸‰ä¸ªè§†é¢‘">æ¨ªå‘æ‹¼æ¥ä¸‰ä¸ªè§†é¢‘</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out1.mp4 -i out2.mp4 -i out3.mp4 -filter_complex <span class="string">"[0:v]pad=iw*3:ih*1[a];[a][1:v]overlay=w[b];[b][2:v]overlay=2.0*w"</span> out.mp4</span><br></pre></td></tr></tbody></table></figure><h1 id="ç«–å‘æ‹¼æ¥ä¸‰ä¸ªè§†é¢‘">ç«–å‘æ‹¼æ¥ä¸‰ä¸ªè§†é¢‘</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out1.mp4 -i out2.mp4 -i out3.mp4 -filter_complex <span class="string">"[0:v]pad=iw:ih*3[a];[a][1:v]overlay=0:h[b];[b][2:v]overlay=0:2.0*h"</span> out.mp4</span><br></pre></td></tr></tbody></table></figure><h1 id="å››ä¸ªè§†é¢‘-2x2-æ’åˆ—æ‹¼æ¥">å››ä¸ªè§†é¢‘ 2x2 æ’åˆ—æ‹¼æ¥</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out1.mp4 -i out2.mp4 -i out3.mp4 -i out4.mp4 -filter_complex <span class="string">"[0:v]pad=iw*2:ih*2[a];[a][1:v]overlay=w[b];[b][2:v]overlay=0:h[c];[c][3:v]overlay=w:h"</span> out.mp4</span><br></pre></td></tr></tbody></table></figure><h1 id="mp3-è½¬-wav">MP3 è½¬ WAV</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.mp3 -f s16le -acodec pcm_s16le -ac 2 -ar 48000 output.wav</span><br></pre></td></tr></tbody></table></figure><ul><li>-acodec pcm_s16le pcm_s16le 16bits ç¼–ç å™¨</li><li>-f s16le ä¿å­˜ä¸º 16bits pcm æ ¼å¼</li><li>-ac 2 åŒå£°é“</li><li>-ar 48000 48000 é‡‡æ ·ç‡</li></ul><h1 id="video-æå–éŸ³é¢‘æ–‡ä»¶">Video æå–éŸ³é¢‘æ–‡ä»¶</h1><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i video.rmvb -f wav -ar <span class="number">48000</span> audio.wav</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Makefile è¯­æ³•</title>
      <link href="/2019/Note/MakefileSummery/"/>
      <url>/2019/Note/MakefileSummery/</url>
      
        <content type="html"><![CDATA[<h1 id="makefile-è§„åˆ™">Makefile è§„åˆ™</h1><p>ä¸€ä¸ªç®€å•çš„ Makefile æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ—çš„â€œè§„åˆ™â€ï¼Œå…¶æ ·å¼å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡ (target)â€¦: ä¾èµ– (prerequiries)â€¦&lt;tab&gt;å‘½ä»¤ (command)</span><br></pre></td></tr></tbody></table></figure><ul><li>ç›®æ ‡ (target) é€šå¸¸æ˜¯è¦ç”Ÿæˆçš„æ–‡ä»¶çš„åç§°ï¼Œå¯ä»¥æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ– OBJ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ‰§è¡Œçš„åŠ¨ä½œåç§°ï¼Œè¯¸å¦‚`cleanâ€™ã€‚</li><li>ä¾èµ–æ˜¯ç”¨æ¥äº§ç”Ÿç›®æ ‡çš„ææ–™ï¼ˆæ¯”å¦‚æºæ–‡ä»¶ï¼‰ï¼Œä¸€ä¸ªç›®æ ‡ç»å¸¸æœ‰å‡ ä¸ªä¾èµ–ã€‚</li><li>å‘½ä»¤æ˜¯ç”Ÿæˆç›®æ ‡æ—¶æ‰§è¡Œçš„åŠ¨ä½œï¼Œä¸€ä¸ªè§„åˆ™å¯ä»¥å«æœ‰å‡ ä¸ªå‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤å ä¸€è¡Œã€‚ æ³¨æ„ï¼šæ¯ä¸ªå‘½ä»¤è¡Œå‰é¢å¿…é¡»æ˜¯ä¸€ä¸ª Tab å­—ç¬¦ï¼Œå³å‘½ä»¤è¡Œç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ Tabã€‚</li></ul><p>é€šå¸¸ï¼Œå¦‚æœä¸€ä¸ªä¾èµ–å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±éœ€è¦è§„åˆ™è°ƒç”¨å‘½ä»¤ä»¥æ›´æ–°æˆ–åˆ›å»ºç›®æ ‡ã€‚ä½†æ˜¯å¹¶éæ‰€æœ‰çš„ç›®æ ‡éƒ½æœ‰ä¾èµ–ï¼Œä¾‹å¦‚ï¼Œç›®æ ‡â€œclernâ€çš„ä½œç”¨æ˜¯æ¸…é™¤æ–‡ä»¶ï¼Œå®ƒæ²¡æœ‰ä¾èµ–ã€‚ è§„åˆ™ä¸€èˆ¬æ˜¯ç”¨äºè§£é‡Šæ€æ ·å’Œä½•æ—¶é‡å»ºç›®æ ‡ã€‚</p><p>make é¦–å…ˆè°ƒç”¨å‘½ä»¤å¤„ç†ä¾èµ–ï¼Œè¿›è€Œæ‰èƒ½åˆ›å»ºæˆ–æ›´æ–°ç›®æ ‡ã€‚å½“ç„¶ï¼Œä¸€ä¸ªè§„åˆ™ä¹Ÿå¯ä»¥æ˜¯ç”¨äºè§£é‡Šæ€æ ·å’Œä½•æ—¶æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼Œå³æ‰“å°æç¤ºä¿¡æ¯ã€‚ä¸€ä¸ª Makefile æ–‡ä»¶å¯ä»¥åŒ…å«è§„åˆ™ä»¥å¤–çš„å…¶ä»–æ–‡æœ¬ï¼Œä½†ä¸€ä¸ªç®€å•çš„ Makefile æ–‡ä»¶ä»…ä»…éœ€è¦åŒ…å«è§„åˆ™ã€‚è™½ç„¶çœŸæ­£çš„è§„åˆ™æ¯”è¿™é‡Œå±•ç¤ºçš„ä¾‹å­å¤æ‚ï¼Œä½†æ ¼å¼æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>å¯¹äºä¸Šé¢çš„ Makefileï¼Œæ‰§è¡Œâ€œmakeâ€å‘½ä»¤æ—¶ï¼Œä»…å½“ hello.c æ–‡ä»¶æ¯” hello æ–‡ä»¶æ–°æ—¶æ‰ä¼šæ‰§è¡Œå‘½ä»¤â€œarm-linux-gcc â€“o hello hello.câ€ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ helloï¼›å¦‚æœè¿˜æ²¡æœ‰ hello æ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿä¼šæ‰§è¡Œã€‚ è¿è¡Œâ€œmake cleanâ€æ—¶ï¼Œç”±äºç›®æ ‡ clean æ²¡æœ‰ä¾èµ–ï¼Œå®ƒçš„å‘½ä»¤â€œrm -f helloâ€å°†è¢«å¼ºåˆ¶æ‰§è¡Œã€‚</p><span id="more"></span><h1 id="å˜é‡">å˜é‡</h1><h2 id="å³æ—¶å˜é‡å»¶æ—¶å˜é‡">å³æ—¶å˜é‡ã€å»¶æ—¶å˜é‡</h2><p>å˜é‡çš„å®šä¹‰è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A  =  xxx    // å»¶æ—¶å˜é‡ï¼Œå®ƒçš„å€¼åœ¨ä½¿ç”¨æ—¶æ‰å±•å¼€ã€æ‰ç¡®å®š</span><br><span class="line">B  ?= xxx    // å»¶æ—¶å˜é‡ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å®šä¹‰æ—¶èµ‹å€¼æ‰æˆåŠŸï¼›å¦‚æœæ›¾å®šä¹‰è¿‡ï¼Œæ­¤èµ‹å€¼æ— æ•ˆ</span><br><span class="line">C  := xxx    // ç«‹å³å˜é‡</span><br><span class="line">D  += yyy    // å¦‚æœ D åœ¨å‰é¢æ˜¯å»¶æ—¶å˜é‡ï¼Œé‚£ä¹ˆç°åœ¨å®ƒè¿˜æ˜¯å»¶æ—¶å˜é‡ï¼›</span><br><span class="line">// å¦‚æœ D åœ¨å‰é¢æ˜¯ç«‹å³å˜é‡ï¼Œé‚£ä¹ˆç°åœ¨å®ƒè¿˜æ˜¯ç«‹å³å˜é‡</span><br></pre></td></tr></tbody></table></figure><h2 id="å˜é‡çš„å¯¼å‡º-export">å˜é‡çš„å¯¼å‡º (export)</h2><p>åœ¨ç¼–è¯‘ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä¼šä¸æ–­åœ°ä½¿ç”¨â€œmake -C dirâ€åˆ‡æ¢åˆ°å…¶ä»–ç›®å½•ï¼Œæ‰§è¡Œå…¶ä»–ç›®å½•é‡Œçš„ Makefileã€‚å¦‚æœæƒ³è®©æŸä¸ªå˜é‡çš„å€¼åœ¨æ‰€æœ‰ç›®å½•ä¸­éƒ½å¯è§ï¼Œè¦æŠŠå®ƒ export å‡ºæ¥ã€‚ æ¯”å¦‚â€œCC = $(CROSS_COMPILE)gccâ€ï¼Œè¿™ä¸ª CC å˜é‡è¡¨ç¤ºç¼–è¯‘å™¨ï¼Œåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½æ˜¯ä¸€æ ·çš„ã€‚å®šä¹‰å®ƒä¹‹åï¼Œè¦ä½¿ç”¨â€œexport CCâ€æŠŠå®ƒå¯¼å‡ºæ¥ã€‚</p><h2 id="makefile-ä¸­å¯ä»¥ä½¿ç”¨-shell-å‘½ä»¤">Makefile ä¸­å¯ä»¥ä½¿ç”¨ shell å‘½ä»¤</h2><p>æ¯”å¦‚ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOPDIR := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™æ˜¯ä¸ªç«‹å³å˜é‡ï¼ŒTOPDIR ç­‰äº shell å‘½ä»¤ pwd çš„ç»“æœã€‚</p><h1 id="makefile-æ–‡ä»¶é‡Œçš„èµ‹å€¼æ–¹æ³•">Makefile æ–‡ä»¶é‡Œçš„èµ‹å€¼æ–¹æ³•</h1><p>å˜é‡çš„å®šä¹‰è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">immediate = deferred</span><br><span class="line">immediate ?= deferred</span><br><span class="line">immediate := immediate</span><br><span class="line">immediate += deferred or immediatedefine </span><br><span class="line">immediatedeferredendef</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ GNU make ä¸­å¯¹å˜é‡çš„èµ‹å€¼æœ‰ä¸¤ç§æ–¹å¼ï¼šå»¶æ—¶å˜é‡ã€ç«‹å³å˜é‡ã€‚åŒºåˆ«åœ¨äºå®ƒä»¬çš„å®šä¹‰æ–¹å¼å’Œæ‰©å±•æ—¶çš„æ–¹å¼ä¸åŒï¼Œå‰è€…åœ¨è¿™ä¸ªå˜é‡ä½¿ç”¨æ—¶æ‰æ‰©å±•å¼€ï¼Œæ„å³å½“çœŸæ­£ä½¿ç”¨æ—¶è¿™ä¸ªå˜é‡çš„å€¼æ‰ç¡®å®šï¼›åè€…åœ¨å®šä¹‰æ—¶å®ƒçš„å€¼å°±å·²ç»ç¡®å®šäº†ã€‚ä½¿ç”¨=, ?=å®šä¹‰æˆ–ä½¿ç”¨ define æŒ‡ä»¤å®šä¹‰çš„å˜é‡æ˜¯å»¶æ—¶å˜é‡ï¼›ä½¿ç”¨ï¼š=å®šä¹‰çš„å˜é‡æ˜¯ç«‹å³å˜é‡ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ?=ä»…ä»…åœ¨å˜é‡è¿˜æ²¡æœ‰å®šä¹‰çš„æƒ…å†µä¸‹æœ‰æ•ˆï¼Œå³ï¼Ÿ=è¢«ç”¨æ¥å®šä¹‰ç¬¬ä¸€æ¬¡å‡ºç°çš„å»¶æ—¶å˜é‡ã€‚ å¯¹äºé™„åŠ æ“ä½œç¬¦+=ï¼Œå³è¾¹å˜é‡å¦‚æœåœ¨å‰é¢ä½¿ç”¨ï¼ˆ:=ï¼‰å®šä¹‰ä¸ºç«‹å³å˜é‡åˆ™å®ƒä¹Ÿæ˜¯ç«‹å³å˜é‡ï¼Œå¦åˆ™å‡ä¸ºå»¶æ—¶å˜é‡ã€‚</p><h1 id="ç›®æ ‡">ç›®æ ‡</h1><h2 id="åœ¨-makefile-ä¸­æ€ä¹ˆæ”¾ç½®ç¬¬-1-ä¸ªç›®æ ‡">åœ¨ Makefile ä¸­æ€ä¹ˆæ”¾ç½®ç¬¬ 1 ä¸ªç›®æ ‡</h2><p>æ‰§è¡Œ make å‘½ä»¤æ—¶å¦‚æœä¸æŒ‡å®šç›®æ ‡ï¼Œé‚£ä¹ˆå®ƒé»˜è®¤æ˜¯å»ç”Ÿæˆç¬¬ 1 ä¸ªç›®æ ‡ã€‚ æ‰€ä»¥â€œç¬¬ 1 ä¸ªç›®æ ‡â€ï¼Œä½ç½®å¾ˆé‡è¦ã€‚æœ‰æ—¶å€™ä¸å¤ªæ–¹ä¾¿æŠŠç¬¬ 1 ä¸ªç›®æ ‡å®Œæ•´åœ°æ”¾åœ¨æ–‡ä»¶å‰é¢ï¼Œè¿™æ—¶å¯ä»¥åœ¨æ–‡ä»¶çš„å‰é¢ç›´æ¥æ”¾ç½®ç›®æ ‡ï¼Œåœ¨åé¢å†å®Œå–„å®ƒçš„ä¾èµ–ä¸å‘½ä»¤ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">First_target:   // è¿™å¥è¯æ”¾åœ¨å‰é¢ï¼ï¼ï¼ï¼  </span></span><br><span class="line">// å…¶ä»–ä»£ç ï¼Œæ¯”å¦‚ <span class="keyword">include</span> å…¶ä»–æ–‡ä»¶å¾—åˆ°åé¢çš„ xxx å˜é‡</span><br><span class="line">First_target : <span class="variable">$(xxx)</span>   <span class="variable">$(yyy)</span>   // åœ¨æ–‡ä»¶çš„åé¢å†æ¥å®Œå–„    </span><br><span class="line">command</span><br></pre></td></tr></tbody></table></figure><h2 id="å‡æƒ³ç›®æ ‡">å‡æƒ³ç›®æ ‡</h2><p>æˆ‘ä»¬çš„ Makefile ä¸­æœ‰è¿™æ ·çš„ç›®æ ‡ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean:    rm -f $(shell find -name "*.o")    rm -f <span class="variable">$(TARGET)</span></span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœå½“å‰ç›®å½•ä¸‹æ°å¥½æœ‰åä¸ºâ€œcleanâ€çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆæ‰§è¡Œâ€œmake cleanâ€æ—¶å®ƒå°±ä¸ä¼šæ‰§è¡Œé‚£äº›åˆ é™¤å‘½ä»¤ã€‚ è¿™æ—¶æˆ‘ä»¬éœ€è¦æŠŠâ€œcleanâ€è¿™ä¸ªç›®æ ‡ï¼Œè®¾ç½®ä¸ºâ€œå‡æƒ³ç›®æ ‡â€ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ‰§è¡Œâ€œmake cleanâ€æ—¶é‚£äº›åˆ é™¤å‘½ä»¤è‚¯å®šå¯ä»¥å¾—åˆ°æ‰§è¡Œã€‚ ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æŠŠâ€œcleanâ€è®¾ç½®ä¸ºå‡æƒ³ç›®æ ‡ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : clean</span><br></pre></td></tr></tbody></table></figure><h1 id="makefile-å¸¸ç”¨å‡½æ•°">Makefile å¸¸ç”¨å‡½æ•°</h1><h2 id="å­—ç¬¦ä¸²æ›¿æ¢å’Œåˆ†æå‡½æ•°">å­—ç¬¦ä¸²æ›¿æ¢å’Œåˆ†æå‡½æ•°</h2><p><strong>$(subst from,to,text)</strong></p><p>åœ¨æ–‡æœ¬ text ä¸­ä½¿ç”¨ to æ›¿æ¢æ¯ä¸€å¤„`fromâ€™ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">subst</span> ee,EE,feet on the street)</span> <span class="comment">#ç»“æœä¸ºâ€˜fEEt on the streetâ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(patsubst pattern,replacement,text)</strong></p><p>å¯»æ‰¾ textâ€™ä¸­ç¬¦åˆæ ¼å¼ patternâ€™çš„å­—ï¼Œç”¨ replacementâ€™æ›¿æ¢å®ƒä»¬ã€‚patternâ€™å’Œ replacementâ€™ä¸­å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash <span class="variable">$(<span class="built_in">patsubst</span> %.c,%.o,x.c.c bar.c)</span> <span class="comment">#ç»“æœä¸ºï¼šx.c.o bar.o</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(strip string)</strong></p><p>å»æ‰å‰å¯¼å’Œç»“å°¾ç©ºæ ¼ï¼Œå¹¶å°†ä¸­é—´çš„å¤šä¸ªç©ºæ ¼å‹ç¼©ä¸ºå•ä¸ªç©ºæ ¼ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">strip</span> a   b c )</span> <span class="comment">#ç»“æœä¸º`a b câ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(findstring find,in)</strong></p><p>åœ¨å­—ç¬¦ä¸² in ä¸­æœå¯» findï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›å€¼æ˜¯`findâ€™ï¼Œå¦åˆ™è¿”å›å€¼ä¸ºç©ºã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">findstring</span> a,a b c)</span> <span class="comment">#äº§ç”Ÿ a$(findstring a,b c)   #äº§ç”Ÿç©º</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(filter patternâ€¦,text)</strong></p><p>è¿”å›åœ¨ textâ€™ä¸­ç”±ç©ºæ ¼éš”å¼€ä¸”åŒ¹é…æ ¼å¼ patternâ€¦â€™çš„å­—ï¼Œå»é™¤ä¸ç¬¦åˆæ ¼å¼ pattern...â€™çš„å­—ã€‚ eg: <code>bash $(filter %.c %.s, foo.c bar.c baz.s ugh.h) #ç»“æœä¸º foo.c bar.c baz.sâ€™</code></p><p><strong>$(filter-out patternâ€¦,text)</strong></p><p>è¿”å›åœ¨ textâ€™ä¸­ç”±ç©ºæ ¼éš”å¼€ä¸”ä¸åŒ¹é…æ ¼å¼ patternâ€¦â€™çš„å­—ï¼Œå»é™¤ç¬¦åˆæ ¼å¼ pattern...â€™çš„å­—ã€‚å®ƒæ˜¯å‡½æ•° filter çš„åå‡½æ•°ã€‚ eg:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(filter %.c %.s,foo.c bar.c baz.s ugh.h) <span class="comment">#ç»“æœä¸º ugh.h </span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(sort list)</strong></p><p>å°†â€˜listâ€™ä¸­çš„å­—æŒ‰å­—æ¯é¡ºåºæ’åºï¼Œå¹¶å»æ‰é‡å¤çš„å­—ã€‚è¾“å‡ºç”±å•ä¸ªç©ºæ ¼éš”å¼€çš„å­—çš„åˆ—è¡¨ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">sort</span> foo bar lose)</span> <span class="comment"># è¿”å›å€¼æ˜¯â€˜bar foo loseâ€™</span></span><br></pre></td></tr></tbody></table></figure><h2 id="æ–‡ä»¶åå‡½æ•°">æ–‡ä»¶åå‡½æ•°</h2><p><strong>$(dir namesâ€¦)</strong></p><p>æŠ½å–â€˜namesâ€¦â€™ä¸­æ¯ä¸€ä¸ªæ–‡ä»¶åçš„è·¯å¾„éƒ¨åˆ†ï¼Œæ–‡ä»¶åçš„è·¯å¾„éƒ¨åˆ†åŒ…æ‹¬ä»æ–‡ä»¶åçš„é¦–å­—ç¬¦åˆ°æœ€åä¸€ä¸ªæ–œæ ï¼ˆå«æ–œæ ï¼‰ä¹‹å‰çš„ä¸€åˆ‡å­—ç¬¦ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">dir</span> src/foo.c hacks)</span> <span class="comment"># ç»“æœä¸ºâ€˜src/ ./â€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(notdir namesâ€¦)</strong></p><p>æŠ½å–â€˜namesâ€¦â€™ä¸­æ¯ä¸€ä¸ªæ–‡ä»¶åä¸­é™¤è·¯å¾„éƒ¨åˆ†å¤–ä¸€åˆ‡å­—ç¬¦ï¼ˆçœŸæ­£çš„æ–‡ä»¶åï¼‰ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">notdir</span> src/foo.c hacks)</span> <span class="comment">#ç»“æœä¸ºâ€˜foo.c hacksâ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(suffix namesâ€¦)</strong></p><p>æŠ½å–â€˜namesâ€¦â€™ä¸­æ¯ä¸€ä¸ªæ–‡ä»¶åçš„åç¼€ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">suffix</span> src/foo.c src-1.0/bar.c hacks)</span> <span class="comment"># ç»“æœä¸ºâ€˜.c .câ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(basename namesâ€¦)</strong></p><p>æŠ½å–â€˜namesâ€¦â€™ä¸­æ¯ä¸€ä¸ªæ–‡ä»¶åä¸­é™¤åç¼€å¤–ä¸€åˆ‡å­—ç¬¦ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">basename</span> src/foo.c src-1.0/bar hacks)</span> <span class="comment">#ç»“æœä¸ºâ€˜src/foo src-1.0/bar hacksâ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(addsuffix suffix,namesâ€¦)</strong></p><p>å‚æ•°â€˜namesâ€¦â€™æ˜¯ä¸€ç³»åˆ—çš„æ–‡ä»¶åï¼Œæ–‡ä»¶åä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€ï¼›suffix æ˜¯ä¸€ä¸ªåç¼€åã€‚å°† suffixï¼ˆåç¼€ï¼‰çš„å€¼é™„åŠ åœ¨æ¯ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶åçš„åé¢ï¼Œå®Œæˆåå°†æ–‡ä»¶åä¸²è”èµ·æ¥ï¼Œå®ƒä»¬ä¹‹é—´ç”¨å•ä¸ªç©ºæ ¼éš”å¼€ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">addsuffix</span> .c,foo bar)</span> <span class="comment"># ç»“æœä¸ºâ€˜foo.c bar.câ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(addprefix prefix,namesâ€¦)</strong></p><p>å‚æ•°â€˜namesâ€™æ˜¯ä¸€ç³»åˆ—çš„æ–‡ä»¶åï¼Œæ–‡ä»¶åä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€ï¼›prefix æ˜¯ä¸€ä¸ªå‰ç¼€åã€‚å°† preffixï¼ˆå‰ç¼€ï¼‰çš„å€¼é™„åŠ åœ¨æ¯ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶åçš„å‰é¢ï¼Œå®Œæˆåå°†æ–‡ä»¶åä¸²è”èµ·æ¥ï¼Œå®ƒä»¬ä¹‹é—´ç”¨å•ä¸ªç©ºæ ¼éš”å¼€ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">addprefix</span> src/,foo bar)</span> <span class="comment"># ç»“æœä¸ºâ€˜src/foo src/barâ€™</span></span><br></pre></td></tr></tbody></table></figure><p><strong>$(wildcard pattern)</strong></p><p>å‚æ•°â€˜patternâ€™æ˜¯ä¸€ä¸ªæ–‡ä»¶åæ ¼å¼ï¼ŒåŒ…å«æœ‰é€šé…ç¬¦ï¼ˆé€šé…ç¬¦å’Œ shell ä¸­çš„ç”¨æ³•ä¸€æ ·ï¼‰ã€‚å‡½æ•° wildcard çš„ç»“æœæ˜¯ä¸€åˆ—å’Œæ ¼å¼åŒ¹é…çš„ä¸”çœŸå®å­˜åœ¨çš„æ–‡ä»¶çš„åç§°ï¼Œæ–‡ä»¶åä¹‹é—´ç”¨ä¸€ä¸ªç©ºæ ¼éš”å¼€ã€‚ eg: è‹¥å½“å‰ç›®å½•ä¸‹æœ‰æ–‡ä»¶ 1.cã€2.cã€1.hã€2.hï¼Œåˆ™ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c_src := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span> <span class="comment">#ç»“æœä¸ºâ€˜1.c 2.câ€™</span></span><br></pre></td></tr></tbody></table></figure><h2 id="å…¶ä»–å‡½æ•°">å…¶ä»–å‡½æ•°</h2><p><strong>$(foreach var,list,text)</strong></p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯ for each var in list, change it to textã€‚å¯¹ list ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå–å‡ºæ¥èµ‹ç»™ varï¼Œç„¶åæŠŠ var æ”¹ä¸º text æ‰€æè¿°çš„å½¢å¼ã€‚ eg:</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objs := a.o b.odep_files := <span class="variable">$(<span class="built_in">foreach</span>  f,  <span class="variable">$(objs)</span>,  .<span class="variable">$(f)</span>.d)</span>  // æœ€ç»ˆ dep_files := .a.o.d .b.o.d</span><br></pre></td></tr></tbody></table></figure><p><strong>$(if condition,then-part[,else-part])</strong></p><p>å…ˆæŠŠç¬¬ä¸€ä¸ªå‚æ•°â€˜conditionâ€™çš„å‰å¯¼ç©ºæ ¼ã€ç»“å°¾ç©ºæ ¼å»æ‰ï¼Œç„¶åæ‰©å±•ã€‚å¦‚æœæ‰©å±•ä¸ºéç©ºå­—ç¬¦ä¸²ï¼Œåˆ™æ¡ä»¶â€˜conditionâ€™ä¸ºâ€˜çœŸâ€™ï¼›å¦‚æœæ‰©å±•ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™æ¡ä»¶â€˜conditionâ€™ä¸ºâ€˜å‡â€™ã€‚ å¦‚æœæ¡ä»¶â€˜conditionâ€™ä¸ºâ€˜çœŸâ€™, é‚£ä¹ˆè®¡ç®—ç¬¬äºŒä¸ªå‚æ•°â€˜then-partâ€™çš„å€¼ï¼Œå¹¶å°†è¯¥å€¼ä½œä¸ºæ•´ä¸ªå‡½æ•° if çš„å€¼ã€‚ å¦‚æœæ¡ä»¶â€˜conditionâ€™ä¸ºâ€˜å‡â€™, å¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°å­˜åœ¨ï¼Œåˆ™è®¡ç®—ç¬¬ä¸‰ä¸ªå‚æ•°â€˜else-partâ€™çš„å€¼ï¼Œå¹¶å°†è¯¥å€¼ä½œä¸ºæ•´ä¸ªå‡½æ•° if çš„å€¼ï¼›å¦‚æœç¬¬ä¸‰ä¸ªå‚æ•°ä¸å­˜åœ¨ï¼Œå‡½æ•° if å°†ä»€ä¹ˆä¹Ÿä¸è®¡ç®—ï¼Œè¿”å›ç©ºå€¼ã€‚</p><p><strong>(<em>originvariable</em>)</strong></p><p>å˜é‡â€˜<em>variable</em>â€™æ˜¯ä¸€ä¸ªæŸ¥è¯¢å˜é‡çš„åç§°_ï¼Œä¸æ˜¯å¯¹è¯¥å˜é‡çš„å¼•ç”¨ã€‚æ‰€ä»¥ä¸èƒ½é‡‡ç”¨â€˜â€™å’Œåœ†æ‹¬å·çš„æ ¼å¼ä¹¦å†™è¯¥å˜é‡ï¼Œå½“ç„¶ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨éå¸¸é‡çš„æ–‡ä»¶åï¼Œå¯ä»¥åœ¨æ–‡ä»¶åä¸­ä½¿ç”¨å˜é‡å¼•ç”¨ã€‚</p><p>å‡½æ•° origin çš„ç»“æœæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²å˜é‡æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">'undefined'             ï¼šå¦‚æœå˜é‡â€˜variableâ€™ä»æ²¡æœ‰å®šä¹‰ï¼›</span><br><span class="line">â€˜default'               ï¼šå˜é‡â€˜variableâ€™æ˜¯ç¼ºçœå®šä¹‰ï¼›</span><br><span class="line">â€˜environment'           ï¼šå˜é‡â€˜variableâ€™ä½œä¸ºç¯å¢ƒå˜é‡å®šä¹‰ï¼Œé€‰é¡¹â€˜-eâ€™æ²¡æœ‰æ‰“å¼€ï¼›</span><br><span class="line">â€˜environment <span class="keyword">override</span>'  ï¼šå˜é‡â€˜variableâ€™ä½œä¸ºç¯å¢ƒå˜é‡å®šä¹‰ï¼Œé€‰é¡¹â€˜-eâ€™å·²æ‰“å¼€ï¼›</span><br><span class="line">â€˜file'                  ï¼šå˜é‡â€˜variableâ€™åœ¨ Makefile ä¸­å®šä¹‰ï¼›</span><br><span class="line">â€˜command line'          ï¼šå˜é‡â€˜variableâ€™åœ¨å‘½ä»¤è¡Œä¸­å®šä¹‰ï¼›</span><br><span class="line">â€˜<span class="keyword">override</span>'              ï¼šå˜é‡â€˜variableâ€™åœ¨ Makefile ä¸­ç”¨ <span class="keyword">override</span> æŒ‡ä»¤å®šä¹‰ï¼›</span><br><span class="line">â€˜automatic'             ï¼šå˜é‡â€˜variableâ€™æ˜¯è‡ªåŠ¨å˜é‡</span><br></pre></td></tr></tbody></table></figure><p><strong>$(shell command arguments)</strong></p><p>å‡½æ•° shell æ˜¯ make ä¸å¤–éƒ¨ç¯å¢ƒçš„é€šè®¯å·¥å…·ã€‚å‡½æ•° shell çš„æ‰§è¡Œç»“æœå’Œåœ¨æ§åˆ¶å°ä¸Šæ‰§è¡Œâ€˜command argumentsâ€™çš„ç»“æœç›¸ä¼¼ã€‚ä¸è¿‡å¦‚æœâ€˜command argumentsâ€™çš„ç»“æœå«æœ‰æ¢è¡Œç¬¦ï¼ˆå’Œå›è½¦ç¬¦ï¼‰ï¼Œåˆ™åœ¨å‡½æ•° shell çš„è¿”å›ç»“æœä¸­å°†æŠŠå®ƒä»¬å¤„ç†ä¸ºå•ä¸ªç©ºæ ¼ï¼Œè‹¥è¿”å›ç»“æœæœ€åæ˜¯æ¢è¡Œç¬¦ï¼ˆå’Œå›è½¦ç¬¦ï¼‰åˆ™è¢«å»æ‰ã€‚ æ¯”å¦‚å½“å‰ç›®å½•ä¸‹æœ‰æ–‡ä»¶ 1.cã€2.cã€1.hã€2.hï¼Œåˆ™ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c_src := <span class="variable">$(<span class="built_in">shell</span> ls *.c)</span> <span class="comment"># ç»“æœä¸ºâ€˜1.c 2.câ€™</span></span><br></pre></td></tr></tbody></table></figure><h1 id="make-å‘½ä»¤çš„ä½¿ç”¨">make å‘½ä»¤çš„ä½¿ç”¨</h1><p>æ‰§è¡Œ make å‘½ä»¤æ—¶ï¼Œå®ƒä¼šå»å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾åä¸ºâ€œMakefileâ€çš„æ–‡ä»¶ï¼Œå¹¶æ ¹æ®å®ƒçš„æŒ‡ç¤ºå»æ‰§è¡Œæ“ä½œï¼Œç”Ÿæˆç¬¬ä¸€ä¸ªç›®æ ‡ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€œ-fâ€é€‰é¡¹æŒ‡å®šæ–‡ä»¶ï¼Œä¸å†ä½¿ç”¨åä¸ºâ€œMakefileâ€çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make  -f  Makefile.build </span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€œ-Câ€é€‰é¡¹æŒ‡å®šç›®å½•ï¼Œåˆ‡æ¢åˆ°å…¶ä»–ç›®å½•é‡Œå»ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C  a/  -f  Makefile.build</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å¯ä»¥æŒ‡å®šç›®æ ‡ï¼Œä¸å†é»˜è®¤ç”Ÿæˆç¬¬ä¸€ä¸ªç›®æ ‡ï¼š</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C  a/  -f  Makefile.build   other_target</span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠéŸ¦ä¸œå±±è€å¸ˆçš„è¯¾ç¨‹åŠä¹¦ç±ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¼–è¯‘æµç¨‹</title>
      <link href="/2019/Note/CompilePipe/"/>
      <url>/2019/Note/CompilePipe/</url>
      
        <content type="html"><![CDATA[<h1 id="gcc-ç¼–è¯‘æµç¨‹">gcc ç¼–è¯‘æµç¨‹</h1><p>ä¸€ä¸ª C/C++æ–‡ä»¶è¦ç»è¿‡é¢„å¤„ç† (preprocessing)ã€ç¼–è¯‘ (compilation)ã€æ±‡ç¼– (assembly) å’Œé“¾æ¥ (linking) ç­‰ 4 æ­¥æ‰èƒ½å˜æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h2 id="é¢„å¤„ç†">é¢„å¤„ç†</h2><p>C/C++æºæ–‡ä»¶ä¸­ï¼Œä»¥â€œ#â€å¼€å¤´çš„å‘½ä»¤è¢«ç§°ä¸ºé¢„å¤„ç†å‘½ä»¤ï¼Œå¦‚åŒ…å«å‘½ä»¤â€œ#includeâ€ã€å®å®šä¹‰å‘½ä»¤â€œ#defineâ€ã€æ¡ä»¶ç¼–è¯‘å‘½ä»¤â€œ#ifâ€ã€â€œ#ifdefâ€ç­‰ã€‚é¢„å¤„ç†å°±æ˜¯å°†è¦åŒ…å« (include) çš„æ–‡ä»¶æ’å…¥åŸæ–‡ä»¶ä¸­ã€å°†å®å®šä¹‰å±•å¼€ã€æ ¹æ®æ¡ä»¶ç¼–è¯‘å‘½ä»¤é€‰æ‹©è¦ä½¿ç”¨çš„ä»£ç ï¼Œæœ€åå°†è¿™äº›ä¸œè¥¿è¾“å‡ºåˆ°ä¸€ä¸ªâ€œ.iâ€æ–‡ä»¶ä¸­ç­‰å¾…è¿›ä¸€æ­¥å¤„ç†ã€‚</p><h2 id="ç¼–è¯‘">ç¼–è¯‘</h2><p>ç¼–è¯‘å°±æ˜¯æŠŠ C/C++ä»£ç ï¼ˆæ¯”å¦‚ä¸Šè¿°çš„â€œ.iâ€æ–‡ä»¶ï¼‰â€œç¿»è¯‘â€æˆæ±‡ç¼–ä»£ç ï¼Œæ‰€ç”¨åˆ°çš„å·¥å…·ä¸º cc1ï¼ˆå®ƒçš„åå­—å°±æ˜¯ cc1ï¼Œx86 æœ‰è‡ªå·±çš„ cc1 å‘½ä»¤ï¼ŒARM æ¿ä¹Ÿæœ‰è‡ªå·±çš„ cc1 å‘½ä»¤ï¼‰ã€‚</p><h2 id="æ±‡ç¼–">æ±‡ç¼–</h2><p>æ±‡ç¼–å°±æ˜¯å°†ç¬¬äºŒæ­¥è¾“å‡ºçš„æ±‡ç¼–ä»£ç ç¿»è¯‘æˆç¬¦åˆä¸€å®šæ ¼å¼çš„æœºå™¨ä»£ç ï¼Œåœ¨ Linux ç³»ç»Ÿä¸Šä¸€èˆ¬è¡¨ç°ä¸º ELF ç›®æ ‡æ–‡ä»¶ (OBJ æ–‡ä»¶ï¼‰ï¼Œç”¨åˆ°çš„å·¥å…·ä¸º asã€‚x86 æœ‰è‡ªå·±çš„ as å‘½ä»¤ï¼ŒARM ç‰ˆä¹Ÿæœ‰è‡ªå·±çš„ as å‘½ä»¤ï¼Œä¹Ÿå¯èƒ½æ˜¯ xxxx-asï¼ˆæ¯”å¦‚ arm-linux-asï¼‰ã€‚</p><h2 id="é“¾æ¥">é“¾æ¥</h2><p>é“¾æ¥å°±æ˜¯å°†ä¸Šæ­¥ç”Ÿæˆçš„ OBJ æ–‡ä»¶å’Œç³»ç»Ÿåº“çš„ OBJ æ–‡ä»¶ã€åº“æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œæœ€ç»ˆç”Ÿæˆäº†å¯ä»¥åœ¨ç‰¹å®šå¹³å°è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨åˆ°çš„å·¥å…·ä¸º ld æˆ– collect2ã€‚</p><p>ç¼–è¯‘ç¨‹åºæ—¶ï¼ŒåŠ ä¸Š-v é€‰é¡¹å°±å¯ä»¥çœ‹åˆ°è¿™å‡ ä¸ªæ­¥éª¤</p><span id="more"></span><h1 id="gcc-å¸¸ç”¨ç¼–è¯‘é€‰é¡¹">gcc å¸¸ç”¨ç¼–è¯‘é€‰é¡¹</h1><ul><li>E é¢„å¤„ç†ï¼Œå¼€å‘è¿‡ç¨‹ä¸­æƒ³å¿«é€Ÿç¡®å®šæŸä¸ªå®å¯ä»¥ä½¿ç”¨â€œ-E -dMâ€</li><li>c æŠŠé¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–éƒ½åšäº†ï¼Œä½†æ˜¯ä¸é“¾æ¥</li><li>o æŒ‡å®šè¾“å‡ºæ–‡ä»¶</li><li>I æŒ‡å®šå¤´æ–‡ä»¶ç›®å½•</li><li>L æŒ‡å®šé“¾æ¥æ—¶åº“æ–‡ä»¶ç›®å½•</li><li>l æŒ‡å®šé“¾æ¥å“ªä¸€ä¸ªåº“æ–‡ä»¶</li></ul><h1 id="gcc-æ€»ä½“é€‰é¡¹-overall-option">GCC æ€»ä½“é€‰é¡¹ (Overall Option)</h1><ul><li><p><strong>-c</strong><br>é¢„å¤„ç†ã€ç¼–è¯‘å’Œæ±‡ç¼–æºæ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä½œé“¾æ¥ï¼Œç¼–è¯‘å™¨æ ¹æ®æºæ–‡ä»¶ç”Ÿæˆ OBJ æ–‡ä»¶ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼ŒGCC é€šè¿‡ç”¨ã€‚o'æ›¿æ¢æºæ–‡ä»¶åçš„åç¼€ã€‚câ€™ï¼Œ.i'ï¼Œ.sâ€™ç­‰ï¼Œäº§ç”Ÿ OBJ æ–‡ä»¶åã€‚å¯ä»¥ä½¿ç”¨-o é€‰é¡¹é€‰æ‹©å…¶ä»–åå­—ã€‚GCC å¿½ç•¥-c é€‰é¡¹åé¢ä»»ä½•æ— æ³•è¯†åˆ«çš„è¾“å…¥æ–‡ä»¶ã€‚</p></li><li><p><strong>S</strong><br>ç¼–è¯‘åå³åœæ­¢ï¼Œä¸è¿›è¡Œæ±‡ç¼–ã€‚å¯¹äºæ¯ä¸ªè¾“å…¥çš„éæ±‡ç¼–è¯­è¨€æ–‡ä»¶ï¼Œè¾“å‡ºç»“æœæ˜¯æ±‡ç¼–è¯­è¨€æ–‡ä»¶ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼ŒGCC é€šè¿‡ç”¨ã€‚s æ›¿æ¢æºæ–‡ä»¶ååç¼€ã€‚cï¼Œ`.iâ€™ç­‰ç­‰ï¼Œäº§ç”Ÿæ±‡ç¼–æ–‡ä»¶åã€‚å¯ä»¥ä½¿ç”¨-o é€‰é¡¹é€‰æ‹©å…¶ä»–åå­—ã€‚GCC å¿½ç•¥ä»»ä½•ä¸éœ€è¦æ±‡ç¼–çš„è¾“å…¥æ–‡ä»¶ã€‚</p></li><li><p><strong>E</strong><br>é¢„å¤„ç†åå³åœæ­¢ï¼Œä¸è¿›è¡Œç¼–è¯‘ã€‚é¢„å¤„ç†åçš„ä»£ç é€å¾€æ ‡å‡†è¾“å‡ºã€‚</p></li><li><p><strong>-o file</strong><br>æŒ‡å®šè¾“å‡ºæ–‡ä»¶ä¸º fileã€‚æ— è®ºæ˜¯é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–è¿˜æ˜¯é“¾æ¥ï¼Œè¿™ä¸ªé€‰é¡¹éƒ½å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨-o é€‰é¡¹ï¼Œé»˜è®¤çš„è¾“å‡ºç»“æœæ˜¯ï¼šå¯æ‰§è¡Œæ–‡ä»¶ä¸º a.outï¼›ä¿®æ”¹è¾“å…¥æ–‡ä»¶çš„åç§°æ˜¯ source.suffix'ï¼Œåˆ™å®ƒçš„ OBJ æ–‡ä»¶æ˜¯ source.oâ€™ï¼Œæ±‡ç¼–æ–‡ä»¶æ˜¯ `source.sâ€™ï¼Œè€Œé¢„å¤„ç†åçš„ C æºä»£ç é€å¾€æ ‡å‡†è¾“å‡ºã€‚</p></li><li><p><strong>v</strong><br>æ˜¾ç¤ºåˆ¶ä½œ GCC å·¥å…·è‡ªèº«æ—¶çš„é…ç½®å‘½ä»¤ï¼›åŒæ—¶æ˜¾ç¤ºç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºã€é¢„å¤„ç†å™¨ã€ç¼–è¯‘å™¨çš„ç‰ˆæœ¬å·ã€‚</p></li></ul><h1 id="è­¦å‘Šé€‰é¡¹-warning-option">è­¦å‘Šé€‰é¡¹ (Warning Option)</h1><ul><li><strong>-Wall</strong><br>è¿™ä¸ªé€‰é¡¹åŸºæœ¬æ‰“å¼€äº†æ‰€æœ‰éœ€è¦æ³¨æ„çš„è­¦å‘Šä¿¡æ¯ï¼Œæ¯”å¦‚æ²¡æœ‰æŒ‡å®šç±»å‹çš„å£°æ˜ã€åœ¨å£°æ˜ä¹‹å‰å°±ä½¿ç”¨çš„å‡½æ•°ã€å±€éƒ¨å˜é‡é™¤äº†å£°æ˜å°±æ²¡å†ä½¿ç”¨ç­‰ã€‚</li></ul><h1 id="è°ƒè¯•é€‰é¡¹-debugging-option">è°ƒè¯•é€‰é¡¹ (Debugging Option)</h1><ul><li><p><strong>-g</strong><br>ä»¥æ“ä½œç³»ç»Ÿçš„æœ¬åœ°æ ¼å¼ (stabsï¼ŒCOFFï¼ŒXCOFFï¼Œæˆ– DWARF) äº§ç”Ÿè°ƒè¯•ä¿¡æ¯ï¼ŒGDB èƒ½å¤Ÿä½¿ç”¨è¿™äº›è°ƒè¯•ä¿¡æ¯ã€‚åœ¨å¤§å¤šæ•°ä½¿ç”¨ stabs æ ¼å¼çš„ç³»ç»Ÿä¸Šï¼Œ-g'é€‰é¡¹åŠ å…¥åªæœ‰ GDB æ‰ä½¿ç”¨çš„é¢å¤–è°ƒè¯•ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„é€‰é¡¹æ¥ç”Ÿæˆé¢å¤–çš„ä¿¡æ¯ï¼š-gstabs+â€˜ï¼Œ-gstabs'ï¼Œ-gxcoff+â€™ï¼Œ-gxcoff'ï¼Œ-gdwarf+â€˜æˆ–`-gdwarfâ€™ï¼Œå…·ä½“ç”¨æ³•è¯·è¯»è€…å‚è€ƒ GCC æ‰‹å†Œã€‚</p></li><li><p><strong>-O0</strong><br>ä¸ä¼˜åŒ–ã€‚</p></li><li><p><strong>-O æˆ–-O1</strong><br>ä¼˜åŒ–ï¼šå¯¹äºå¤§å‡½æ•°ï¼Œä¼˜åŒ–ç¼–è¯‘çš„è¿‡ç¨‹å°†å ç”¨ç¨å¾®å¤šçš„æ—¶é—´å’Œç›¸å½“å¤§çš„å†…å­˜ã€‚ä¸ä½¿ç”¨-O'æˆ–-O1â€™é€‰é¡¹çš„ç›®çš„æ˜¯å‡å°‘ç¼–è¯‘çš„å¼€é”€ï¼Œä½¿ç¼–è¯‘ç»“æœèƒ½å¤Ÿè°ƒè¯•ã€è¯­å¥æ˜¯ç‹¬ç«‹çš„ï¼šå¦‚æœåœ¨ä¸¤æ¡è¯­å¥ä¹‹é—´ç”¨æ–­ç‚¹ä¸­æ­¢ç¨‹åºï¼Œå¯ä»¥å¯¹ä»»ä½•å˜é‡é‡æ–°èµ‹å€¼ï¼Œæˆ–è€…åœ¨å‡½æ•°ä½“å†…æŠŠç¨‹åºè®¡æ•°å™¨æŒ‡åˆ°å…¶ä»–è¯­å¥ï¼Œä»¥åŠä»æºç¨‹åºä¸­ç²¾ç¡®åœ°è·å–ä½ æ‰€æœŸå¾…çš„ç»“æœã€‚ ä¸ä½¿ç”¨-O'æˆ–-O1â€™é€‰é¡¹æ—¶ï¼Œåªæœ‰å£°æ˜äº† register çš„å˜é‡æ‰åˆ†é…ä½¿ç”¨å¯„å­˜å™¨ã€‚ ä½¿ç”¨äº†-O'æˆ–-O1â€™é€‰é¡¹ï¼Œç¼–è¯‘å™¨ä¼šè¯•å›¾å‡å°‘ç›®æ ‡ç çš„å¤§å°å’Œæ‰§è¡Œæ—¶é—´ã€‚å¦‚æœæŒ‡å®šäº†-O'æˆ–-O1â€™é€‰é¡¹ï¼Œ-fthread-jumps'å’Œ-fdefer-popâ€™é€‰é¡¹å°†è¢«æ‰“å¼€ã€‚åœ¨æœ‰ delay slot çš„æœºå™¨ä¸Šï¼Œ-fdelayed-branch'é€‰é¡¹å°†è¢«æ‰“å¼€ã€‚åœ¨å³ä½¿æ²¡æœ‰å¸§æŒ‡é’ˆ (frame pointer) ä¹Ÿæ”¯æŒè°ƒè¯•çš„æœºå™¨ä¸Šï¼Œ-fomit-frame-pointerâ€™é€‰é¡¹å°†è¢«æ‰“å¼€ã€‚æŸäº›æœºå™¨ä¸Šè¿˜å¯èƒ½ä¼šæ‰“å¼€å…¶ä»–é€‰é¡¹ã€‚</p></li><li><p><strong>O2</strong><br>å¤šä¼˜åŒ–ä¸€äº›ã€‚é™¤äº†æ¶‰åŠç©ºé—´å’Œé€Ÿåº¦äº¤æ¢çš„ä¼˜åŒ–é€‰é¡¹ï¼Œæ‰§è¡Œå‡ ä¹æ‰€æœ‰çš„ä¼˜åŒ–å·¥ä½œã€‚ä¾‹å¦‚ä¸è¿›è¡Œå¾ªç¯å±•å¼€ (loop unrolling) å’Œå‡½æ•°å†…åµŒ (inlining)ã€‚å’Œ-O'æˆ–-O1â€™é€‰é¡¹æ¯”è¾ƒï¼Œè¿™ä¸ªé€‰é¡¹æ—¢å¢åŠ äº†ç¼–è¯‘æ—¶é—´ï¼Œä¹Ÿæé«˜äº†ç”Ÿæˆä»£ç çš„è¿è¡Œæ•ˆæœã€‚</p></li><li><p><strong>O3</strong><br>ä¼˜åŒ–çš„æ›´å¤šã€‚é™¤äº†æ‰“å¼€-O2 æ‰€åšçš„ä¸€åˆ‡ï¼Œå®ƒè¿˜æ‰“å¼€äº†-finline-functions é€‰é¡¹ã€‚</p></li></ul><h1 id="é“¾æ¥å™¨é€‰é¡¹-linker-option">é“¾æ¥å™¨é€‰é¡¹ (Linker Option)</h1><ul><li><p><strong>-object-file-name</strong><br>å¦‚æœæŸäº›æ–‡ä»¶æ²¡æœ‰ç‰¹åˆ«æ˜ç¡®çš„åç¼€ (a special recognized suffix)ï¼ŒGCC å°±è®¤ä¸ºä»–ä»¬æ˜¯ OBJ æ–‡ä»¶æˆ–åº“æ–‡ä»¶ï¼ˆæ ¹æ®æ–‡ä»¶å†…å®¹ï¼Œé“¾æ¥å™¨èƒ½å¤ŸåŒºåˆ† OBJ æ–‡ä»¶å’Œåº“æ–‡ä»¶ï¼‰ã€‚å¦‚æœ GCC æ‰§è¡Œé“¾æ¥æ“ä½œï¼Œè¿™äº› OBJ æ–‡ä»¶å°†æˆä¸ºé“¾æ¥å™¨çš„è¾“å…¥æ–‡ä»¶ã€‚</p></li><li><p><strong>-llibrary</strong><br>é“¾æ¥åä¸º library çš„åº“æ–‡ä»¶ã€‚ é“¾æ¥å™¨åœ¨æ ‡å‡†æœç´¢ç›®å½•ä¸­å¯»æ‰¾è¿™ä¸ªåº“æ–‡ä»¶ï¼Œåº“æ–‡ä»¶çš„çœŸæ­£åå­—æ˜¯ liblibrary.a'ã€‚æœç´¢ç›®å½•é™¤äº†ä¸€äº›ç³»ç»Ÿæ ‡å‡†ç›®å½•å¤–ï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·ä»¥-Lâ€™é€‰é¡¹æŒ‡å®šçš„è·¯å¾„ã€‚ä¸€èˆ¬è¯´æ¥ç”¨è¿™ä¸ªæ–¹æ³•æ‰¾åˆ°çš„æ–‡ä»¶æ˜¯åº“æ–‡ä»¶â”€â”€å³ç”± OBJ æ–‡ä»¶ç»„æˆçš„å½’æ¡£æ–‡ä»¶ (archive file)ã€‚é“¾æ¥å™¨å¤„ç†å½’æ¡£æ–‡ä»¶çš„æ–¹æ³•æ˜¯ï¼šæ‰«æå½’æ¡£æ–‡ä»¶ï¼Œå¯»æ‰¾æŸäº›æˆå‘˜ï¼Œè¿™äº›æˆå‘˜çš„ç¬¦å·ç›®å‰å·²è¢«å¼•ç”¨ï¼Œä¸è¿‡è¿˜æ²¡æœ‰è¢«å®šä¹‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœé“¾æ¥å™¨æ‰¾åˆ°æ™®é€šçš„ OBJ æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åº“æ–‡ä»¶ï¼Œå°±æŠŠè¿™ä¸ª OBJ æ–‡ä»¶æŒ‰å¹³å¸¸æ–¹å¼é“¾æ¥è¿›æ¥ã€‚æŒ‡å®š-l'é€‰é¡¹å’ŒæŒ‡å®šæ–‡ä»¶åçš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼Œ-l é€‰é¡¹ç”¨ lib å’Œã€‚a æŠŠ library åŒ…è£¹èµ·æ¥ï¼Œè€Œä¸”æœç´¢ä¸€äº›ç›®å½•ã€‚</p></li><li><p><strong>-nostartfiles</strong><br>ä¸é“¾æ¥ç³»ç»Ÿæ ‡å‡†å¯åŠ¨æ–‡ä»¶ï¼Œè€Œæ ‡å‡†åº“æ–‡ä»¶ä»ç„¶æ­£å¸¸ä½¿ç”¨ã€‚</p></li><li><p><strong>-nostdlib</strong><br>ä¸é“¾æ¥ç³»ç»Ÿæ ‡å‡†å¯åŠ¨æ–‡ä»¶å’Œæ ‡å‡†åº“æ–‡ä»¶ï¼ŒåªæŠŠæŒ‡å®šçš„æ–‡ä»¶ä¼ é€’ç»™é“¾æ¥å™¨ã€‚è¿™ä¸ªé€‰é¡¹å¸¸ç”¨äºç¼–è¯‘å†…æ ¸ã€bootloader ç­‰ç¨‹åºï¼Œå®ƒä»¬ä¸éœ€è¦å¯åŠ¨æ–‡ä»¶ã€æ ‡å‡†åº“æ–‡ä»¶ã€‚</p></li><li><p><strong>-static</strong><br>åœ¨æ”¯æŒåŠ¨æ€é“¾æ¥ (dynamic linking) çš„ç³»ç»Ÿä¸Šï¼Œé˜»æ­¢é“¾æ¥å…±äº«åº“ï¼Œå½“ä¸ä½¿ç”¨-static ç¼–è¯‘æ–‡ä»¶æ—¶ï¼Œç¨‹åºæ‰§è¡Œå‰è¦é“¾æ¥å…±äº«åº“æ–‡ä»¶ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†å…±äº«åº“æ–‡ä»¶æ”¾å…¥æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p></li><li><p><strong>-shared</strong><br>ç”Ÿæˆä¸€ä¸ªå…±äº« OBJ æ–‡ä»¶ï¼Œå®ƒå¯ä»¥å’Œå…¶ä»– OBJ æ–‡ä»¶é“¾æ¥äº§ç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ã€‚åªæœ‰éƒ¨åˆ†ç³»ç»Ÿæ”¯æŒè¯¥é€‰é¡¹ã€‚ å½“ä¸æƒ³ä»¥æºä»£ç å‘å¸ƒç¨‹åºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨-shared é€‰é¡¹ç”Ÿæˆåº“æ–‡ä»¶ï¼Œæ¯”å¦‚å¯¹äº options ç¨‹åºï¼Œå¯ä»¥å¦‚ä¸‹åˆ¶ä½œåº“æ–‡ä»¶ï¼š</p><p></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -o sub.o sub.c</span><br><span class="line">gcc -shared -o libsub.so sub.o</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p><strong>-Xlinker option</strong><br>æŠŠé€‰é¡¹ option ä¼ é€’ç»™é“¾æ¥å™¨ã€‚å¯ä»¥ç”¨æ¥ä¼ é€’ç³»ç»Ÿç‰¹å®šçš„é“¾æ¥é€‰é¡¹ï¼ŒGCC æ— æ³•è¯†åˆ«è¿™äº›é€‰é¡¹ã€‚å¦‚æœéœ€è¦ä¼ é€’æºå¸¦å‚æ•°çš„é€‰é¡¹ï¼Œå¿…é¡»ä½¿ç”¨ä¸¤æ¬¡-Xlinker'ï¼Œä¸€æ¬¡ä¼ é€’é€‰é¡¹ï¼Œå¦ä¸€æ¬¡ä¼ é€’å…¶å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¼ é€’-assert definitionsâ€™ï¼Œè¦æˆ-Xlinker -assert -Xlinker definitions'ï¼Œè€Œä¸èƒ½å†™æˆ-Xlinker â€œ-assert definitionsâ€â€™ï¼Œå› ä¸ºè¿™æ ·ä¼šæŠŠæ•´ä¸ªå­—ç¬¦ä¸²å½“åšä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯é“¾æ¥å™¨æœŸå¾…çš„ã€‚</p></li><li><p><strong>-Wl, option</strong><br>æŠŠé€‰é¡¹ option ä¼ é€’ç»™é“¾æ¥å™¨ã€‚å¦‚æœ option ä¸­å«æœ‰é€—å·ï¼Œå°±åœ¨é€—å·å¤„åˆ†å‰²æˆå¤šä¸ªé€‰é¡¹ã€‚é“¾æ¥å™¨é€šå¸¸æ˜¯é€šè¿‡ gccã€arm-linux-gcc ç­‰å‘½ä»¤é—´æ¥å¯åŠ¨çš„ï¼Œè¦å‘å®ƒä¼ å…¥å‚æ•°æ—¶ï¼Œå‚æ•°å‰é¢åŠ ä¸Š`-Wl,â€™ã€‚</p></li><li><p><strong>-u symbol</strong><br>ä½¿é“¾æ¥å™¨è®¤ä¸ºå–æ¶ˆäº† symbol çš„ç¬¦å·å®šä¹‰ï¼Œä»è€Œé“¾æ¥åº“æ¨¡å—ä»¥å–å¾—å®šä¹‰ã€‚å¯ä»¥ä½¿ç”¨å¤šä¸ª `-uâ€™é€‰é¡¹ï¼Œå„è‡ªè·Ÿä¸Šä¸åŒçš„ç¬¦å·ï¼Œä½¿å¾—é“¾æ¥å™¨è°ƒå…¥é™„åŠ çš„åº“æ¨¡å—ã€‚</p></li></ul><h1 id="ç›®å½•é€‰é¡¹-directory-option">ç›®å½•é€‰é¡¹ (Directory Option)</h1><ul><li><p><strong>-Idir</strong><br>åœ¨å¤´æ–‡ä»¶çš„æœç´¢è·¯å¾„åˆ—è¡¨ä¸­æ·»åŠ  dir ç›®å½•ã€‚ å¤´æ–‡ä»¶çš„æœç´¢æ–¹æ³•ä¸ºï¼šå¦‚æœä»¥â€œ#include &lt; &gt;â€åŒ…å«æ–‡ä»¶ï¼Œåˆ™åªåœ¨æ ‡å‡†åº“ç›®å½•å¼€å§‹æœç´¢ï¼ˆåŒ…æ‹¬ä½¿ç”¨-Idir é€‰é¡¹å®šä¹‰çš„ç›®å½•ï¼‰ï¼›å¦‚æœä»¥â€œ#include â€œâ€åŒ…å«æ–‡ä»¶ï¼Œåˆ™å…ˆä»ç”¨æˆ·çš„å·¥ä½œç›®å½•å¼€å§‹æœç´¢ï¼Œå†æœç´¢æ ‡å‡†åº“ç›®å½•ã€‚</p></li><li><p><strong>-I-</strong><br>ä»»ä½•åœ¨-I-'å‰é¢ç”¨-Iâ€™é€‰é¡¹æŒ‡å®šçš„æœç´¢è·¯å¾„åªé€‚ç”¨äº#include "file"'è¿™ç§æƒ…å†µï¼›å®ƒä»¬ä¸èƒ½ç”¨æ¥æœç´¢#include â€™åŒ…å«çš„å¤´æ–‡ä»¶ã€‚å¦‚æœç”¨-I'é€‰é¡¹æŒ‡å®šçš„æœç´¢è·¯å¾„ä½äº-I-â€™é€‰é¡¹åé¢ï¼Œå°±å¯ä»¥åœ¨è¿™äº›è·¯å¾„ä¸­æœç´¢æ‰€æœ‰çš„#include'æŒ‡ä»¤ï¼ˆä¸€èˆ¬è¯´æ¥-I é€‰é¡¹å°±æ˜¯è¿™ä¹ˆç”¨çš„ï¼‰ã€‚è¿˜æœ‰ï¼Œ-I-â€™é€‰é¡¹èƒ½å¤Ÿé˜»æ­¢å½“å‰ç›®å½•ï¼ˆå­˜æ”¾å½“å‰è¾“å…¥æ–‡ä»¶çš„åœ°æ–¹ï¼‰æˆä¸ºæœç´¢#include "file"'çš„ç¬¬ä¸€é€‰æ‹©ã€‚-I-â€™ä¸å½±å“ä½¿ç”¨ç³»ç»Ÿæ ‡å‡†ç›®å½•ï¼Œå› æ­¤ï¼Œ-I-'å’Œ-nostdincâ€™æ˜¯ä¸åŒçš„é€‰é¡¹ã€‚</p></li><li><p><strong>-Ldir</strong><br>åœ¨`-lâ€™é€‰é¡¹çš„æœç´¢è·¯å¾„åˆ—è¡¨ä¸­æ·»åŠ  dir ç›®å½•ã€‚æŒ‡å®šåº“æ–‡ä»¶è·¯å¾„ã€‚</p></li><li><p><strong>-Bprefix</strong><br>è¿™ä¸ªé€‰é¡¹æŒ‡å‡ºåœ¨ä½•å¤„å¯»æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåº“æ–‡ä»¶ï¼Œä»¥åŠç¼–è¯‘å™¨è‡ªå·±çš„æ•°æ®æ–‡ä»¶ã€‚ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºéœ€è¦ä½¿ç”¨æŸäº›å·¥å…·ï¼Œæ¯”å¦‚ï¼šcppï¼Œcc1â€™ ï¼ˆæˆ– C++çš„ cc1plus')ï¼Œasâ€™å’Œ ld'ã€‚å®ƒæŠŠ prefix å½“ä½œæ¬²æ‰§è¡Œçš„å·¥å…·çš„å‰ç¼€ï¼Œè¿™ä¸ªå‰ç¼€å¯ä»¥ç”¨æ¥æŒ‡å®šç›®å½•ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¿®æ”¹å·¥å…·åå­—ã€‚ å¯¹äºè¦è¿è¡Œçš„å·¥å…·ï¼Œç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºé¦–å…ˆè¯•ç€åŠ ä¸Š-Bâ€™å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œæˆ–æ²¡æœ‰æŒ‡å®š-B'é€‰é¡¹ï¼Œç¼–è¯‘å™¨æ¥ç€ä¼šè¯•éªŒä¸¤ä¸ªæ ‡å‡†å‰ç¼€/usr/lib/gcc/â€™å’Œ/usr/local/lib/gcc-lib/'ã€‚å¦‚æœä»ç„¶æ²¡èƒ½å¤Ÿæ‰¾åˆ°æ‰€éœ€æ–‡ä»¶ï¼Œç¼–è¯‘å™¨å°±åœ¨ PATHâ€™ç¯å¢ƒå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­å¯»æ‰¾æ²¡åŠ ä»»ä½•å‰ç¼€çš„æ–‡ä»¶åã€‚å¦‚æœæœ‰éœ€è¦ï¼Œè¿è¡Œæ—¶ (run-time) æ”¯æŒæ–‡ä»¶ libgcc.a'ä¹Ÿåœ¨-Bâ€™å‰ç¼€çš„æœç´¢èŒƒå›´ä¹‹å†…ã€‚å¦‚æœè¿™é‡Œæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±åœ¨ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªæ ‡å‡†å‰ç¼€ä¸­å¯»æ‰¾ï¼Œä»…æ­¤è€Œå·²ã€‚å¦‚æœä¸Šè¿°æ–¹æ³•æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå°±ä¸é“¾æ¥å®ƒäº†ã€‚å¤šæ•°æƒ…å†µçš„å¤šæ•°æœºå™¨ä¸Šï¼Œlibgcc.a'å¹¶éå¿…ä¸å¯å°‘ã€‚ å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ GCC_EXEC_PREFIX è·å¾—è¿‘ä¼¼çš„æ•ˆæœï¼›å¦‚æœå®šä¹‰äº†è¿™ä¸ªå˜é‡ï¼Œå…¶å€¼å°±å’Œä¸Šé¢è¯´çš„ä¸€æ ·è¢«ç”¨ä½œå‰ç¼€ã€‚å¦‚æœåŒæ—¶æŒ‡å®šäº†-Bâ€™é€‰é¡¹å’Œ GCC_EXEC_PREFIX å˜é‡ï¼Œç¼–è¯‘å™¨é¦–å…ˆä½¿ç”¨`-Bâ€™é€‰é¡¹ï¼Œç„¶åæ‰å°è¯•ç¯å¢ƒå˜é‡å€¼ã€‚</p></li><li><p><strong>-ld/objdump/objcopy é€‰é¡¹</strong></p></li></ul><h1 id="åˆ¶ä½œä½¿ç”¨åŠ¨æ€åº“">åˆ¶ä½œä½¿ç”¨åŠ¨æ€åº“</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -o main.o  main.c</span><br><span class="line">gcc -c -o sub.o   sub.c</span><br><span class="line">gcc -shared  -o libsub.so  sub.o  sub2.o  sub3.o <span class="comment">#ï¼ˆå¯ä»¥ä½¿ç”¨å¤šä¸ªã€‚o ç”ŸæˆåŠ¨æ€åº“ï¼‰</span></span><br><span class="line">gcc -o <span class="built_in">test</span> main.o  -lsub  -L /libsub.so/æ‰€åœ¨ç›®å½•/</span><br></pre></td></tr></tbody></table></figure><h1 id="åˆ¶ä½œä½¿ç”¨é™æ€åº“">åˆ¶ä½œä½¿ç”¨é™æ€åº“</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -o main.o  main.c</span><br><span class="line">gcc -c -o sub.o   sub.c</span><br><span class="line">ar  crs  libsub.a  sub.o  sub2.o  sub3.o <span class="comment">#ï¼ˆå¯ä»¥ä½¿ç”¨å¤šä¸ªã€‚o ç”Ÿæˆé™æ€åº“ï¼‰</span></span><br><span class="line">gcc  -o  <span class="built_in">test</span>  main.o  libsub.a  <span class="comment">#ï¼ˆå¦‚æœã€‚a ä¸åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œéœ€è¦æŒ‡å®šå®ƒçš„ç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„ï¼‰</span></span><br></pre></td></tr></tbody></table></figure><h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠéŸ¦ä¸œå±±è€å¸ˆçš„è¯¾ç¨‹åŠä¹¦ç±ã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git å¸¸ç”¨å‘½ä»¤</title>
      <link href="/2019/Note/gitUsage/"/>
      <url>/2019/Note/gitUsage/</url>
      
        <content type="html"><![CDATA[<h1 id="å¸¸ç”¨">å¸¸ç”¨</h1><h2 id="git-ä¸ä¸Šæ¸¸-ä¿æŒåŒæ­¥">git ä¸ä¸Šæ¸¸ ä¿æŒåŒæ­¥</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git remote add src-zephyr &lt;https://github.com/zephyrproject-rtos/zephyr&gt;</span><br><span class="line">git pull src-zephyr master</span><br><span class="line">git push</span><br></pre></td></tr></tbody></table></figure><h2 id="git-åˆå¹¶åˆ†æ”¯">git åˆå¹¶åˆ†æ”¯</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git revert</span><br><span class="line">git pull --rebase origin</span><br><span class="line">git pull --rebase origin release-v1.0</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæœ‰å†²çªï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status <span class="comment"># æŸ¥çœ‹å†²çªæ–‡ä»¶å¹¶è§£å†³å†²çª</span></span><br><span class="line">git add <span class="comment"># æäº¤è§£å†³å†²çªåçš„æ–‡ä»¶</span></span><br><span class="line">git rebase --<span class="built_in">continue</span> <span class="comment"># å®Œæˆ</span></span><br></pre></td></tr></tbody></table></figure><span id="more"></span><h2 id="å…å¯†æ“ä½œ">å…å¯†æ“ä½œ</h2><h3 id="æ–¹æ³•ä¸€"><strong>æ–¹æ³•ä¸€</strong></h3><p>è¿›å…¥ç”¨æˆ·ä¸»ç›®å½•ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~</span><br></pre></td></tr></tbody></table></figure><p>å»ºç«‹æ–‡ä»¶ .git-credentialsï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">touch</span> .git-credentia</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¾‘æ–‡ä»¶ .git-credentialsï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi .git-credentials</span><br></pre></td></tr></tbody></table></figure><p>æ·»åŠ è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;https://username:password@gitlab.com&gt;</span><br></pre></td></tr></tbody></table></figure><p>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global credential.helper store</span><br></pre></td></tr></tbody></table></figure><h3 id="æ–¹æ³•äºŒ"><strong>æ–¹æ³•äºŒ</strong></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global credential.helper store</span><br><span class="line">$ git pull /git push</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ä¸€æ¬¡éœ€è¦è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œä»¥åå°±ä¸ç”¨äº†ï¼ˆæœ¬è´¨ä¸ŠåŒä¸Šï¼Œä¼šåœ¨ç”¨æˆ·ç›®å½•ä¸‹åˆ›å»ºã€‚git-credential æ–‡ä»¶å¹¶å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥è¯¥æ–‡ä»¶ï¼‰</p><h2 id="git-æ’¤é”€ä¿®æ”¹">git æ’¤é”€ä¿®æ”¹</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout [file]</span><br><span class="line">git checkout .</span><br></pre></td></tr></tbody></table></figure><h2 id="git-æ’¤é”€-add">git æ’¤é”€ add</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset [file]</span><br><span class="line">git reset <span class="comment"># å–æ¶ˆæ‰€æœ‰æ›´æ”¹</span></span><br></pre></td></tr></tbody></table></figure><h2 id="git-æ’¤é”€-commit">git æ’¤é”€ commit</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --soft HEAD^ <span class="comment"># ä¸åˆ é™¤å·¥ä½œç©ºé—´æ”¹åŠ¨ä»£ç ï¼Œæ’¤é”€ commitï¼Œä¸æ’¤é”€ git add .</span></span><br><span class="line">git reset --mixed HEAD^ <span class="comment"># ä¸åˆ é™¤å·¥ä½œç©ºé—´æ”¹åŠ¨ä»£ç ï¼Œæ’¤é”€ commitï¼Œå¹¶ä¸”æ’¤é”€ git add . æ“ä½œ </span></span><br><span class="line">git reset HEAD^ <span class="comment"># åŒ git reset --mixed HEAD^ä¸€æ ·</span></span><br><span class="line">git reset --hard HEAD^ <span class="comment"># åˆ é™¤å·¥ä½œç©ºé—´æ”¹åŠ¨ä»£ç ï¼Œæ’¤é”€ commitï¼Œæ’¤é”€ git add .</span></span><br></pre></td></tr></tbody></table></figure><h2 id="åˆå¹¶å¤šæ¡-commit">åˆå¹¶å¤šæ¡ commit</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i HEAD~3</span><br></pre></td></tr></tbody></table></figure><h1 id="å…³äº-ssh-key">å…³äº ssh-key</h1><p><strong>åˆ›å»º key</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C <span class="string">"something"</span></span><br></pre></td></tr></tbody></table></figure><p>-t æŒ‡å®šå¯†é’¥ç±»å‹ï¼Œé»˜è®¤æ˜¯ rsa -C è®¾ç½®æ³¨é‡Šæ–‡å­—ï¼Œæ¯”å¦‚é‚®ç®±</p><p>è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸¤ä¸ªç§˜é’¥æ–‡ä»¶å°† id_rsa.pub æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ° github æˆ– gitlab å°±å¯ä»¥é€šè¿‡ ssh ä¼ è¾“æ–‡ä»¶ å¯¹äº http åè®®ä¼ è¾“éœ€è¦ä¿®æ”¹ã€‚git ç›®å½•ä¸‹ config æ–‡ä»¶æ ¼å¼ä¸º</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;http://username:password@github.com&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>git ä¸èƒ½ clone ä»£ç ï¼Œè¯ä¹¦é—®é¢˜</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global http.sslverify <span class="literal">true</span></span><br><span class="line">$ git config --global http.sslCAPath /etc/pki/tls/certs</span><br></pre></td></tr></tbody></table></figure><h1 id="å…¶ä»–">å…¶ä»–</h1><p>Git æ ‡ç­¾ï¼š ä¸€ä¸ªè½»é‡æ ‡ç­¾å¾ˆåƒä¸€ä¸ªä¸ä¼šæ”¹å˜çš„åˆ†æ”¯ - å®ƒåªæ˜¯ä¸€ä¸ªç‰¹å®šæäº¤çš„å¼•ç”¨ã€‚ é™„æ³¨æ ‡ç­¾æ˜¯å­˜å‚¨åœ¨ Git æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå®Œæ•´å¯¹è±¡ã€‚å®ƒä»¬æ˜¯å¯ä»¥è¢«æ ¡éªŒçš„ï¼›å…¶ä¸­åŒ…å«æ‰“æ ‡ç­¾è€…çš„åå­—ã€ç”µå­é‚®ä»¶åœ°å€ã€æ—¥æœŸæ—¶é—´ï¼›è¿˜æœ‰ä¸€ä¸ªæ ‡ç­¾ä¿¡æ¯ã€‚</p><h2 id="åˆ›å»ºæ ‡ç­¾-é™„æ³¨æ ‡ç­¾">åˆ›å»ºæ ‡ç­¾ï¼š é™„æ³¨æ ‡ç­¾</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a v1.4 -m <span class="string">'my version 1.4'</span></span><br></pre></td></tr></tbody></table></figure><p>è½»é‡æ ‡ç­¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag v1.4-lw</span><br></pre></td></tr></tbody></table></figure><p>åæœŸæ‰“æ ‡ç­¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a v1.29fceb02 (29fceb02 æ˜¯ä¸€æ¬¡æäº¤çš„æ ¡éªŒï¼‰</span><br></pre></td></tr></tbody></table></figure><p>å…±äº«æ ‡ç­¾ å°†æ ‡ç­¾æäº¤åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin v1.5</span><br></pre></td></tr></tbody></table></figure><p>ä¸€æ¬¡æ€§æ¨é€å¾ˆå¤šæ ‡ç­¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin --tags</span><br></pre></td></tr></tbody></table></figure><p>Git åˆ«å é€šè¿‡ git config æ–‡ä»¶æ¥è½»æ¾åœ°ä¸ºæ¯ä¸€ä¸ªå‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«åã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.ci commit</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ„å‘³ç€ï¼Œå½“è¦è¾“å…¥ git commit æ—¶ï¼Œåªéœ€è¦è¾“å…¥ git ciã€‚</p><p>æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ä»£ç†ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy</span><br></pre></td></tr></tbody></table></figure><p>å–æ¶ˆä»£ç†ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ä»£ç†</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy <span class="string">'socks5://127.0.0.1:7891'</span></span><br><span class="line">git config --global https.proxy <span class="string">'socks5://127.0.0.1:7891'</span></span><br></pre></td></tr></tbody></table></figure><h1 id="git-æäº¤è§„èŒƒ">git æäº¤è§„èŒƒ</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">feat: æ–°åŠŸèƒ½ï¼ˆfeatureï¼‰</span><br><span class="line">fix: ä¿®è¡¥ bug</span><br><span class="line">docs: æ–‡æ¡£ï¼ˆdocumentationï¼‰</span><br><span class="line">style: æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œçš„å˜åŠ¨ï¼‰</span><br><span class="line">refactor: é‡æ„ï¼ˆå³ä¸æ˜¯æ–°å¢åŠŸèƒ½ï¼Œä¹Ÿä¸æ˜¯ä¿®æ”¹ bug çš„ä»£ç å˜åŠ¨ï¼‰</span><br><span class="line">chore: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨</span><br><span class="line">revert: æ’¤é”€ï¼Œç‰ˆæœ¬å›é€€</span><br><span class="line">perf: æ€§èƒ½ä¼˜åŒ–</span><br><span class="line"><span class="built_in">test</span>ï¼šæµ‹è¯•</span><br><span class="line">improvement: æ”¹è¿›</span><br><span class="line">build: æ‰“åŒ…</span><br><span class="line">ci: æŒç»­é›†æˆ</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Note </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Matrix - CarlyleLiu‘s Blog</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CarlyleLiu’s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://carlyleliu.vip/page/14/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="CarlyleLiu’s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Matrix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://carlyleliu.vip/page/14/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Matrix',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-08-31 01:10:55'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Matrix</h1><div id="site_social_icons"><a class="social-icon" href="https://github.com/carlyleliu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverCCF/" title="Linux 驱动之 CCF 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;9478" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 CCF 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverCCF/" title="Linux 驱动之 CCF 子系统">Linux 驱动之 CCF 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-05T08:39:19.000Z" title="发表于 2020-10-05 16:39:19">2020-10-05</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">概述
CCF 主要用于系统 clock 的管理等操作。clk 的种类说明： 
如上图所示，时钟源大概可分为如下几种：

提供基础时钟源的晶振（可分为有源晶振、无源晶振两种）
用于倍频的锁相环
用于分频的 divider
用于多路时钟源选择的 mux
用于时钟使能的与门电路等

而在 CCF 子系统的抽象中，这五种均抽象为 clk，但是针对这 5 种类型的时钟也提供了单独的时钟注册函数（也就是对 clk_register 函数的封装，并针对不同的时钟类型定义了不同的结构体）。
在 CCF 子系统中，针对硬件时钟的操作接口，也抽象了对应的结构体 struct clk_ops，包含时钟的使能接口、时钟频率的修改接口等等。而针对上述所说的不同种类的时钟源，其并不需要实现所有 struct clk_ops 中定义的接口。针对“时钟使能的与门电路”而言，仅需要实现 enabel、disable、is_enable 接口即可；针对多路时钟源选择的 mux 而言，则需要实现父时钟源的设置及获取的接口 set_parent、get_parent 等；对于倍频、分频而言，则需要实现时钟频率相关的接口 se ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverInput/" title="Linux 驱动之 Input 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;5152" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 Input 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverInput/" title="Linux 驱动之 Input 子系统">Linux 驱动之 Input 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-30T04:00:55.000Z" title="发表于 2020-09-30 12:00:55">2020-09-30</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">概述
按键输入、键盘、鼠标、触摸屏等等这些都属于输入设备，按键和键盘就是代表按键信息，鼠标和触摸屏代表坐标信息，因此在应用层的处理就不同。为此 input 子系统分为 input 驱动层、 input 核心层、 input 事件处理层，最终给用户空间提供可访问的设备节点，input 子系统框架如图 所示： 

驱动层：输入设备的具体驱动程序，比如按键驱动程序，向内核层报告输入内容。
核心层：承上启下，为驱动层提供输入设备注册和操作接口。通知事件层对输入事件进行处理。
事件层：主要和用户空间进行交互。


数据结构
Input 子系统实现的数据结构如下：原图 

input_dev:
input_dev 结构体用于描述一个 input 设备，例如按键、鼠标、键盘等，我们编写设备驱动主要就是构造这个结构体。该结构体包含设备类型，消息类型，事件 code 等信息。该数据结构在内核里会挂载到一个全局链表 input_dev_list，所有注册的 input 设备都会挂载到该链表中
input_handler:
input_handler 用于表示一个 input 事件，用于上报 input 事 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverRegmap/" title="Linux 驱动之 Regmap 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;69" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 Regmap 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverRegmap/" title="Linux 驱动之 Regmap 子系统">Linux 驱动之 Regmap 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-11T18:20:00.000Z" title="发表于 2020-09-12 02:20:00">2020-09-12</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">概述
内核版本 3.1 中引入了 Regmap API，用于统一内核开发人员访问 SPI/IIC 设备的方式，无论是 SPI 设备还是 IIC 设备，只需要初始化，配置 Regmap 就可以通过 Regmap 读写设备。Regmap 子系统主要提供如下两种功能：

第一是为 IIC/SPI/MMIO 等提供统一的访问接口，linux 中大量的 iic 和 spi 设备就可以通过统一的接口进行访问尤其对于那些同时支持 iic 和 spi 接口的设备。
第二是提供缓存访问机制用于加速设备访问设备，对于支持缓存的设备这将大大加快设备的当问速度。

下面看一下 Regmapz 子系统在驱动中的位置，如下：原图 

数据结构
regmap 子系统的实现比较简单，数据结构也是很简单的，整体结构如下：原图 

regmap_bus:
regmap_bus 数据结构用于对具体的 bus 进行封装，例如对 IIC 或 SPI 总线进行封装，这些 bus 下可以挂载很多设备，他们都从属于一个总线那么就有很多共性操作，对这个结构的封装就用 regmap_bus 结构。该结构主要提供同步读写、异步读写、格式化 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverPinctrl/" title="Linux 驱动之 Pinctrl 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;5321" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 Pinctrl 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverPinctrl/" title="Linux 驱动之 Pinctrl 子系统">Linux 驱动之 Pinctrl 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-08T08:55:52.000Z" title="发表于 2020-09-08 16:55:52">2020-09-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">Pinctrl 概述
关于 pinctrl 主要可以归结为两类设置，其中一类是功能选择，即一组 gpio 是用于 iic 还是 uart 还是就作为普通 gpio 来用，另一类是 gpio 的特性配置，即上拉、下拉、驱动能力和速率的配置。而 pinctrl 主要负责这两类配置的管理工作。总结起来 pinctrl 主要完成以下三种功能：

引脚枚举与命名 (Enumerating and naming)
引脚复用 (Multiplexing)：比如用作 GPIO、I2C 或其他功能
引脚配置 (Configuration)：比如上拉、下来、open drain、驱动强度等


dts 配置
以全志平台的写法如下（虚构的）：
123456789101112131415uart0_pins: uart0-pins {    pins = "PA4", "PA5";    function = "uart0";};uart0_sleep_pins: uart0-pins {    pins = "PA4", "PA5";    function = "gpio";};...&amp;uart0 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverGPIO/" title="Linux 驱动之 GPIO 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;8719" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 GPIO 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverGPIO/" title="Linux 驱动之 GPIO 子系统">Linux 驱动之 GPIO 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-05T08:22:26.000Z" title="发表于 2020-09-05 16:22:26">2020-09-05</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">GPIO 概述
以前学习 stm32 的时候看到手册里有关于 gpio 的电路图，如下： 

保护二极体：
IO 引脚上下两边两个二极体用于防止引脚外部过高、过低的电压输入。当引脚电压高于 VDD 时，上方的二极体导通；当引脚电压低于 VSS 时，下方的二极体导通，防止不正常电压引入晶片导致晶片烧毁
P-MOS 管和 N-MOS 管：
由 P-MOS 管和 N-MOS 管组成的单元电路使得 GPIO 具有“推挽输出”和“开漏输出”的模式
TTL 肖特基触发器：
信号经过触发器后，模拟信号转化为 0 和 1 的数字信号。但是，当 GPIO 引脚作为 ADC 采集电压的输入通道时，用其“模拟输入”功能，此时信号不再经过触发器进行 TTL 电平转换。ADC 外设要采集到的原始的模拟信号


STM32 的 GPIO 支持 4 种输入模式（浮空输入、上拉输入、下拉输入、模拟输入）和 4 种输出模式（开漏输出、开漏复用输出、推挽输出、推挽复用输出）

浮空输入模式： 
上拉输入模式： 
下拉输入模式： 
模拟输入模式： 
开漏输出模式： 

开漏输出模式下，通过设定位设定/清除寄存器或者输出寄存 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverSPI/" title="Linux 驱动之 SPI 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;1545" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 SPI 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverSPI/" title="Linux 驱动之 SPI 子系统">Linux 驱动之 SPI 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-04T23:55:31.000Z" title="发表于 2020-09-05 07:55:31">2020-09-05</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">Linux SPI 驱动框架
对于 SPI 的驱动框架与 I2C 是大致一致的，也分为两层，控制器驱动程序层叫 spi_controller ，主要提供 transfer 函数，进行 spi 协议的收发。
另一层是设备驱动层，基于 spi_bus_type，在 driver 里则使用 spi_read、spi_writer 等函数，最终也会调用到 controller-&gt;transfer 函数进行发送接收。

数据结构
整体数据结构如下：原图


spi_controller 结构体用于描述一个 spi 控制器，可以类比 iic 的 i2c_adapt。
spi_device 结构体用于描述一个 spi 设备，可以类比于 i2c_client 结构体。

spi_device 结构里有个 mode 很重要下面是其详细描述，SPI 模式主要有两个特征：

CPOL：这是时钟极性：

0：初始时钟状态为低电平，第一个时钟边沿是上升沿

1：初始时钟状态为高电平，第一个时钟边沿是下降沿

CPHA：这是时钟相位，选择在哪个边沿采样数据：

0：数据在下降沿锁存，输出在上升沿改变

1： ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverPWM/" title="Linux 驱动之 PWM"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;2402" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 PWM"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverPWM/" title="Linux 驱动之 PWM">Linux 驱动之 PWM</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-02T08:45:17.000Z" title="发表于 2020-09-02 16:45:17">2020-09-02</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">PWM 概述


Ton：信号高电平持续时间
Toff：信号底电平持续时间
Period： 完整 pwm 周期
Duty cycle：pwm 信号周期内保持为 ON 的时间百分比


Linux 下 PWM 驱动
数据结构
pwm 的数据结构如下图所示：原图 

pwm_chip 结构体用于抽象 soc 的 pwm 控制器
pwm_device 用来抽象设备
pwm_state 表示 pwm 设备的周期、占空比、极性等信息
pwm ops 结构体提供一系列回调函数。这些回调函数的操作对象是具体的 pwm device

实现
pwm 驱动分为 consumer 和 provider。其中 consumer 提供接口如下：
123static inline int pwm_config(struct pwm_device *pwm, int duty_ns, int period_ns) //配置 pwm device 的频率、占空比。static inline int pwm_enable(struct pwm_device *pwm)                          ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverIIC/" title="Linux 驱动之 IIC 子系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;3631" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 IIC 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverIIC/" title="Linux 驱动之 IIC 子系统">Linux 驱动之 IIC 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-29T08:27:44.000Z" title="发表于 2020-08-29 16:27:44">2020-08-29</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">IIC 协议
写操作
流程如下：

主芯片要发出一个 start 信号
然后发出一个设备地址（用来确定是往哪一个芯片写数据），方向（读/写，0 表示写，1 表示读）
从设备回应（用来确定这个设备是否存在），然后就可以传输数据
主设备发送一个字节数据给从设备，并等待回应
每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成），然后再传输下一个数据
数据发送完之后，主芯片就会发送一个停止信号

下图：白色背景表示"主→从"，灰色背景表示"从→主" 

读操作
流程如下：

主芯片要发出一个 start 信号
然后发出一个设备地址（用来确定是往哪一个芯片写数据），方向（读/写，0 表示写，1 表示读）
从设备回应（用来确定这个设备是否存在），然后就可以传输数据
从设备发送一个字节数据给主设备，并等待回应
每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成），然后再传输下一个数据
数据发送完之后，主芯片就会发送一个停止信号

下图：白色背景表示"主→从"，灰色背景表示"从→主" 
IIC 信号
IIC 协议中数据传输的单位是字节，也就是 8 位。但是要用到 9 个时钟：前 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverDeviceTree/" title="Linux 驱动之设备树"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;2059" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之设备树"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverDeviceTree/" title="Linux 驱动之设备树">Linux 驱动之设备树</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-25T06:56:11.000Z" title="发表于 2020-08-25 14:56:11">2020-08-25</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">dtb 数据解析
内核启动阶段获得 dtb 位置指针
以 arm64 为例，内核启动如下：
1234567891011__HEAD_head:#ifdef CONFIG_EFI	add	x13, x18, #0x16	b	stext#else	b	stext				// branch to kernel start, magic	.long	0				// reserved#endif...
在开启 UEFI 支持时，add x13, x18, #0x16 这个 code 实际上是为了满足 EFI 格式的”MZ”头。如果使用 UEFI 来启动 kernel, 会识别出来并走 UEFI 启动的流程，如果是普通的启动过程如使用 uboot 的 booti 进行引导，那么第一条指令就是一条 dummy 指令，第二条就跳转到 stext 运行了。

x0 寄存器保存的是 dtb 里 blob 块的物理地址，x0 寄存器内容由 uboot 设置，uboot 将 dtb 地址传递给内核，跳转到 stext，如下：
123456789101112131415161718192021222324ENT ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverFileSystem/" title="Linux 驱动之文件系统"><img class="post-bg" src="https://img.paulzzh.com/touhou/random&amp;2054" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之文件系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverFileSystem/" title="Linux 驱动之文件系统">Linux 驱动之文件系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-08T04:25:58.000Z" title="发表于 2020-08-08 12:25:58">2020-08-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">seq_file
概述
seq_file 只是在普通文件 read 中加入了内核缓冲的功能，从而实现顺序多次遍历读取大数据量的简单接口，seq_file 一般只提供只读接口。
123456struct seq_operations {	void * (*start) (struct seq_file *m, loff_t *pos);	void (*stop) (struct seq_file *m, void *v);	void * (*next) (struct seq_file *m, void *v, loff_t *pos);	int (*show) (struct seq_file *m, void *v);};

核心功能
seq_file 接口可通过 &lt;linux/seq_file.h&gt; 获得。 seq_file 包含三个方面：

An iterator interface which lets a virtual file implementation step through the objects it is presenting
Some utili ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/13/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/#content-inner">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/#content-inner">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/#content-inner">18</a><a class="extend next" rel="next" href="/page/15/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiu’s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/carlyleliu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm"><img src="https://img.paulzzh.com/touhou/random&amp;1663" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Encryption Algorithm"/></a><div class="content"><a class="title" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm">Encryption Algorithm</a><time datetime="2024-08-23T12:22:04.000Z" title="发表于 2024-08-23 20:22:04">2024-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/SecureBoot/" title="Secure Boot"><img src="https://img.paulzzh.com/touhou/random&amp;8361" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Secure Boot"/></a><div class="content"><a class="title" href="/2024/Embedded/SecureBoot/" title="Secure Boot">Secure Boot</a><time datetime="2024-08-19T02:22:04.000Z" title="发表于 2024-08-19 10:22:04">2024-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程"><img src="https://img.paulzzh.com/touhou/random&amp;2582" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 软件交互流程"/></a><div class="content"><a class="title" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程">TEE 软件交互流程</a><time datetime="2024-08-17T02:22:04.000Z" title="发表于 2024-08-17 10:22:04">2024-08-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/RPMB/" title="RPMB 简介"><img src="https://img.paulzzh.com/touhou/random&amp;6746" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RPMB 简介"/></a><div class="content"><a class="title" href="/2024/Embedded/RPMB/" title="RPMB 简介">RPMB 简介</a><time datetime="2024-08-15T02:22:04.000Z" title="发表于 2024-08-15 10:22:04">2024-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理"><img src="https://img.paulzzh.com/touhou/random&amp;709" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 实现原理"/></a><div class="content"><a class="title" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理">TEE 实现原理</a><time datetime="2024-08-14T02:22:04.000Z" title="发表于 2024-08-14 10:22:04">2024-08-14</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            <a class="card-more-btn" href="/categories/" title="查看更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/"><span class="card-category-list-name">Literature Appreciation</span><span class="card-category-list-count">6</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/Poetry/"><span class="card-category-list-name">Poetry</span><span class="card-category-list-count">6</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Note/"><span class="card-category-list-name">Note</span><span class="card-category-list-count">18</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/"><span class="card-category-list-name">Science Thought</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/Math/"><span class="card-category-list-name">Math</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/"><span class="card-category-list-name">Share</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/Tools/"><span class="card-category-list-name">Tools</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Technology-Blog/"><span class="card-category-list-name">Technology Blog</span><span class="card-category-list-count">144</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/IMU/" style="font-size: 1.14em; color: #999b9d">IMU</a> <a href="/tags/Image/" style="font-size: 1.43em; color: #99a6b9">Image</a> <a href="/tags/Note/" style="font-size: 1.39em; color: #99a5b4">Note</a> <a href="/tags/Interrupt/" style="font-size: 1.23em; color: #999ea6">Interrupt</a> <a href="/tags/Memory/" style="font-size: 1.32em; color: #99a2ae">Memory</a> <a href="/tags/Tools/" style="font-size: 1.17em; color: #999c9f">Tools</a> <a href="/tags/Linear-Algebra/" style="font-size: 1.17em; color: #999c9f">Linear Algebra</a> <a href="/tags/Design-Patters/" style="font-size: 1.1em; color: #999">Design Patters</a> <a href="/tags/ALSA/" style="font-size: 1.26em; color: #999fa8">ALSA</a> <a href="/tags/Links-Libraries/" style="font-size: 1.19em; color: #999da1">Links Libraries</a> <a href="/tags/USB/" style="font-size: 1.34em; color: #99a3b0">USB</a> <a href="/tags/Performance/" style="font-size: 1.1em; color: #999">Performance</a> <a href="/tags/3A/" style="font-size: 1.14em; color: #999b9d">3A</a> <a href="/tags/Sync/" style="font-size: 1.17em; color: #999c9f">Sync</a> <a href="/tags/ISP/" style="font-size: 1.37em; color: #99a4b2">ISP</a> <a href="/tags/Actuator/" style="font-size: 1.23em; color: #999ea6">Actuator</a> <a href="/tags/ARM64/" style="font-size: 1.1em; color: #999">ARM64</a> <a href="/tags/Motor/" style="font-size: 1.21em; color: #999da4">Motor</a> <a href="/tags/Sensor/" style="font-size: 1.12em; color: #999a9b">Sensor</a> <a href="/tags/Odriver/" style="font-size: 1.14em; color: #999b9d">Odriver</a> <a href="/tags/Driver/" style="font-size: 1.41em; color: #99a5b7">Driver</a> <a href="/tags/UAC/" style="font-size: 1.28em; color: #99a0aa">UAC</a> <a href="/tags/RTOS/" style="font-size: 1.12em; color: #999a9b">RTOS</a> <a href="/tags/C/" style="font-size: 1.3em; color: #99a1ac">C++</a> <a href="/tags/ucos/" style="font-size: 1.1em; color: #999">ucos</a> <a href="/tags/FileSystem/" style="font-size: 1.17em; color: #999c9f">FileSystem</a> <a href="/tags/Debug/" style="font-size: 1.3em; color: #99a1ac">Debug</a> <a href="/tags/Linux/" style="font-size: 1.5em; color: #99a9bf">Linux</a> <a href="/tags/Task/" style="font-size: 1.23em; color: #999ea6">Task</a> <a href="/tags/Lens/" style="font-size: 1.17em; color: #999c9f">Lens</a> <a href="/tags/Poetry/" style="font-size: 1.21em; color: #999da4">Poetry</a> <a href="/tags/Programming/" style="font-size: 1.46em; color: #99a7bb">Programming</a> <a href="/tags/FOC/" style="font-size: 1.14em; color: #999b9d">FOC</a> <a href="/tags/Audio/" style="font-size: 1.26em; color: #999fa8">Audio</a> <a href="/tags/Refactor/" style="font-size: 1.14em; color: #999b9d">Refactor</a> <a href="/tags/EIS/" style="font-size: 1.12em; color: #999a9b">EIS</a> <a href="/tags/Kernel/" style="font-size: 1.48em; color: #99a8bd">Kernel</a> <a href="/tags/Robot/" style="font-size: 1.26em; color: #999fa8">Robot</a> <a href="/tags/TEE/" style="font-size: 1.19em; color: #999da1">TEE</a> <a href="/tags/Math/" style="font-size: 1.17em; color: #999c9f">Math</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><span class="card-archive-list-count">6</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">176</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2024-08-30T17:10:54.558Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By CarlyleLiu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
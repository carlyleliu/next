<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Matrix - CarlyleLiu‘s Blog</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CarlyleLiu’s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://carlyleliu.vip/page/15/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="CarlyleLiu’s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Matrix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://carlyleliu.vip/page/15/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Matrix',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-08-26 22:27:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Matrix</h1><div id="site-subtitle"><span id="subtitle"></span></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverSPI/" title="Linux 驱动之 SPI 子系统"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?1576" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 SPI 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverSPI/" title="Linux 驱动之 SPI 子系统">Linux 驱动之 SPI 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-04T23:55:31.000Z" title="发表于 2020-09-05 07:55:31">2020-09-05</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">Linux SPI 驱动框架
对于 SPI 的驱动框架与 I2C 是大致一致的，也分为两层，控制器驱动程序层叫 spi_controller ，主要提供 transfer 函数，进行 spi 协议的收发。
另一层是设备驱动层，基于 spi_bus_type，在 driver 里则使用 spi_read、spi_writer 等函数，最终也会调用到 controller-&gt;transfer 函数进行发送接收。

数据结构
整体数据结构如下：原图


spi_controller 结构体用于描述一个 spi 控制器，可以类比 iic 的 i2c_adapt。
spi_device 结构体用于描述一个 spi 设备，可以类比于 i2c_client 结构体。

spi_device 结构里有个 mode 很重要下面是其详细描述，SPI 模式主要有两个特征：

CPOL：这是时钟极性：

0：初始时钟状态为低电平，第一个时钟边沿是上升沿

1：初始时钟状态为高电平，第一个时钟边沿是下降沿

CPHA：这是时钟相位，选择在哪个边沿采样数据：

0：数据在下降沿锁存，输出在上升沿改变

1： ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverPWM/" title="Linux 驱动之 PWM"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?5753" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 PWM"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverPWM/" title="Linux 驱动之 PWM">Linux 驱动之 PWM</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-09-02T08:45:17.000Z" title="发表于 2020-09-02 16:45:17">2020-09-02</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">PWM 概述


Ton：信号高电平持续时间
Toff：信号底电平持续时间
Period： 完整 pwm 周期
Duty cycle：pwm 信号周期内保持为 ON 的时间百分比


Linux 下 PWM 驱动
数据结构
pwm 的数据结构如下图所示：原图 

pwm_chip 结构体用于抽象 soc 的 pwm 控制器
pwm_device 用来抽象设备
pwm_state 表示 pwm 设备的周期、占空比、极性等信息
pwm ops 结构体提供一系列回调函数。这些回调函数的操作对象是具体的 pwm device

实现
pwm 驱动分为 consumer 和 provider。其中 consumer 提供接口如下：
123static inline int pwm_config(struct pwm_device *pwm, int duty_ns, int period_ns) //配置 pwm device 的频率、占空比。static inline int pwm_enable(struct pwm_device *pwm)                          ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverIIC/" title="Linux 驱动之 IIC 子系统"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?6195" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 IIC 子系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverIIC/" title="Linux 驱动之 IIC 子系统">Linux 驱动之 IIC 子系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-29T08:27:44.000Z" title="发表于 2020-08-29 16:27:44">2020-08-29</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">IIC 协议
写操作
流程如下：

主芯片要发出一个 start 信号
然后发出一个设备地址（用来确定是往哪一个芯片写数据），方向（读/写，0 表示写，1 表示读）
从设备回应（用来确定这个设备是否存在），然后就可以传输数据
主设备发送一个字节数据给从设备，并等待回应
每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成），然后再传输下一个数据
数据发送完之后，主芯片就会发送一个停止信号

下图：白色背景表示"主→从"，灰色背景表示"从→主" 

读操作
流程如下：

主芯片要发出一个 start 信号
然后发出一个设备地址（用来确定是往哪一个芯片写数据），方向（读/写，0 表示写，1 表示读）
从设备回应（用来确定这个设备是否存在），然后就可以传输数据
从设备发送一个字节数据给主设备，并等待回应
每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成），然后再传输下一个数据
数据发送完之后，主芯片就会发送一个停止信号

下图：白色背景表示"主→从"，灰色背景表示"从→主" 
IIC 信号
IIC 协议中数据传输的单位是字节，也就是 8 位。但是要用到 9 个时钟：前 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverDeviceTree/" title="Linux 驱动之设备树"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?8866" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之设备树"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverDeviceTree/" title="Linux 驱动之设备树">Linux 驱动之设备树</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-25T06:56:11.000Z" title="发表于 2020-08-25 14:56:11">2020-08-25</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">dtb 数据解析
内核启动阶段获得 dtb 位置指针
以 arm64 为例，内核启动如下：
1234567891011__HEAD_head:#ifdef CONFIG_EFI	add	x13, x18, #0x16	b	stext#else	b	stext				// branch to kernel start, magic	.long	0				// reserved#endif...
在开启 UEFI 支持时，add x13, x18, #0x16 这个 code 实际上是为了满足 EFI 格式的”MZ”头。如果使用 UEFI 来启动 kernel, 会识别出来并走 UEFI 启动的流程，如果是普通的启动过程如使用 uboot 的 booti 进行引导，那么第一条指令就是一条 dummy 指令，第二条就跳转到 stext 运行了。

x0 寄存器保存的是 dtb 里 blob 块的物理地址，x0 寄存器内容由 uboot 设置，uboot 将 dtb 地址传递给内核，跳转到 stext，如下：
123456789101112131415161718192021222324ENT ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2020/LinuxDriver/LinuxDriverFileSystem/" title="Linux 驱动之文件系统"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?4225" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之文件系统"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverFileSystem/" title="Linux 驱动之文件系统">Linux 驱动之文件系统</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-08T04:25:58.000Z" title="发表于 2020-08-08 12:25:58">2020-08-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">seq_file
概述
seq_file 只是在普通文件 read 中加入了内核缓冲的功能，从而实现顺序多次遍历读取大数据量的简单接口，seq_file 一般只提供只读接口。
123456struct seq_operations {	void * (*start) (struct seq_file *m, loff_t *pos);	void (*stop) (struct seq_file *m, void *v);	void * (*next) (struct seq_file *m, void *v, loff_t *pos);	int (*show) (struct seq_file *m, void *v);};

核心功能
seq_file 接口可通过 &lt;linux/seq_file.h&gt; 获得。 seq_file 包含三个方面：

An iterator interface which lets a virtual file implementation step through the objects it is presenting
Some utili ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2020/LinuxDriver/LinuxDriverDeviceModule/" title="Linux 驱动之设备驱动模型"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?5408" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之设备驱动模型"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/LinuxDriver/LinuxDriverDeviceModule/" title="Linux 驱动之设备驱动模型">Linux 驱动之设备驱动模型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-08-07T06:52:33.000Z" title="发表于 2020-08-07 14:52:33">2020-08-07</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="content">kobject
概述

Kobjects 有一个 name 和一个引用计数，还具有父指针（允许将对象排列成层次结构）
ktype 是嵌入在 kobject 结构体中的对象。 每个 kobject 结构都需要一个相应的 ktype。 ktype 控制 kobject 在创建和销毁时的行为
kset 是一组 kobjects(kset 本身包含一个 kobject), 这些 kobject 可以拥有相同的 ktype，kset 也是 sysfs 中的一个子目录。Ksets 可以支持 kobjects 的“热插拔”（uevent 事件）


kobject 的数据结构和实现
下图展示了 kobject、ktype 和 kset 三者数据结构之间的关系：原图 

sysfs_ops: show 是回调函数，在读取具有该 kobj_type 的所有属性时调用他。缓冲区长度始终是 PAGE_SIZE，在成功时返回写入缓冲区的数据大小，失败返回错误码。写入的时候调用 store 函数，其参数 buf 最大为 PAGE_SIZE，成功返回写入数据大小，失败返回错误码
uevent_ops: 是此 ks ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2019/Note/BuildrootCommonIssue/" title="Buildroot 常见编译错误记录"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?124" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Buildroot 常见编译错误记录"></a></div><div class="recent-post-info"><a class="article-title" href="/2019/Note/BuildrootCommonIssue/" title="Buildroot 常见编译错误记录">Buildroot 常见编译错误记录</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2019-12-21T18:22:04.000Z" title="发表于 2019-12-22 02:22:04">2019-12-22</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Note/">Note</a></span></div><div class="content">openwrt 编译错误
you should not run configure as root (set FORCE_UNSAFE_CONFIGURE=1 in environment to bypass this check)
解决方法：
1export FORCE_UNSAFE_CONFIGURE=1

切换 gcc 版本
12sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 20 --slave /usr/bin/g++ g++ /usr/bin/g++-9sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 30 --slave /usr/bin/g++ g++ /usr/bin/g++-11
buildroot 报错：
c-stack.c:55:26: error: missing binary operator before token
12将 buildroot 的 host-m4 版本升级一下就可以使用 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2019/Note/Buildroot/" title="Buildroot"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?8328" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Buildroot"></a></div><div class="recent-post-info"><a class="article-title" href="/2019/Note/Buildroot/" title="Buildroot">Buildroot</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2019-10-21T18:22:04.000Z" title="发表于 2019-10-22 02:22:04">2019-10-22</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Note/">Note</a></span></div><div class="content">Buildroot 配置
交叉编译工具链
Buildroot 为交叉编译工具链提供两种解决方案：

内部工具链后端，在配置界面中调用“Buildroot toolchain”
外部工具链后端，在配置界面中调用“External toolchain“；有三种方式来使用外部工具链：

让 Buildroot 基于预定义的外部工具链 profile 自动下载、安装。在&nbsp;Toolchain&nbsp;中选择已有的 profile 即可
为 Buildroot 手动指定提前安装好的、预定义了 profile 的工具链。在&nbsp;Toolchain&nbsp;中选择 profile 后，反选掉&nbsp;Download toolchain automatically&nbsp;并在&nbsp;Toolchain path&nbsp;中填写已有工具链路径即可
使用定制的外部工具链。通常用于使用 crosstool-NG 或 Buildroot 生成的已有定制工具链。选择&nbsp;Toolchain&nbsp;列表中的&nbsp;Custom toolchain&nbsp;，然后填写 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2019/Program/rtosDesign/" title="RTOS 的设计"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?4423" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTOS 的设计"></a></div><div class="recent-post-info"><a class="article-title" href="/2019/Program/rtosDesign/" title="RTOS 的设计">RTOS 的设计</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2019-10-14T15:36:21.000Z" title="发表于 2019-10-14 23:36:21">2019-10-14</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/RTOS/">RTOS</a></span></div><div class="content">何为实时性？
RTOS 的实时性该怎么理解呢？快速？确定性？
从中断控制器视角看实时性
我们知道一般都是 Cortex-M 跑 RTOS，Cortex-A 很少跑 RTOS，一般都是跑 Linux、Android 这些非实时系统。如果单纯从速度来看 A 核在高主频加持下一定会具有更快的速度才对呀，那 M 核的竞争力在哪里呢？实际上这就是 A 核和 M 核在设计上的两个不同方向的取舍。
首先我们看 NVIC 中断控制器的设计：

中断延迟波动很小：NVIC 支持中断嵌套，这样即使当前中断在处理中且非常耗时也没关系，因为可以通过高优先级的中断来响应更紧急的事件，这样中断延迟就不依赖与中断处理时间了，从设计上保证了延迟的确定性。
中断延迟小：NVIC 在不同的中断会跳转到不同地址运行，且可以直接在硬中断上下文中执行中断程序，这样整个 pipeline 很短，且 NVIC 还支持尾链这个概念进一步降低延迟（当高优先级的 ISR 抢占低优先级 ISR 时，处理器会跳过上下文保存和恢复，直接处理第二个 ISR，没有任何额外的开销）。通常 NVIC 中断响应时间在十几到几十 ns 之间。

NVIC ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2019/Note/LinuxDriverTips/" title="Linux Driver Tips"><img class="post-bg" src="https://api.btstu.cn/sjbz/api.php?2827" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux Driver Tips"></a></div><div class="recent-post-info"><a class="article-title" href="/2019/Note/LinuxDriverTips/" title="Linux Driver Tips">Linux Driver Tips</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2019-10-14T04:22:04.000Z" title="发表于 2019-10-14 12:22:04">2019-10-14</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Note/">Note</a></span></div><div class="content">获取 ns 时间戳（已弃用）
1234567#include &lt;linux/timekeeping32.h&gt;struct timespec ts;u64 ns;getnstimeofday(&amp;ts);ns = timespec_to_ns(&amp;ts);
ktime accessors — The Linux Kernel documentation
可以使用 ktime_get_ns() 替代。 如果要获取 us 时间会涉及到 64bit 除法问题，会遇到如下问题：
1ERROR: modpost: "__aeabi_uldivmod" [common_drivers/drivers/usb/dwc_otg.ko] undefined!
调用 div_u64() 函数，需要 include &lt;linux/math64.h&gt;
1u64	tm = div_u64(ktime_get_raw_ns(),1000);

Dump Stack
12#include &lt;asm/ptrace.h&gt;dump_stack();
Linux 中根据函数指针 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/14/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/#content-inner">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/#content-inner">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/#content-inner">18</a><a class="extend next" rel="next" href="/page/16/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiu’s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/carlyleliu"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/Algorithm/odriverSpeed/" title="Odriver 之测速"><img src="https://api.btstu.cn/sjbz/api.php?8493" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Odriver 之测速"/></a><div class="content"><a class="title" href="/2024/Algorithm/odriverSpeed/" title="Odriver 之测速">Odriver 之测速</a><time datetime="2024-08-26T13:05:19.824Z" title="发表于 2024-08-26 21:05:19">2024-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Algorithm/openshoe/" title="openshoe 算法"><img src="https://api.btstu.cn/sjbz/api.php?3372" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="openshoe 算法"/></a><div class="content"><a class="title" href="/2024/Algorithm/openshoe/" title="openshoe 算法">openshoe 算法</a><time datetime="2024-08-26T13:05:19.824Z" title="发表于 2024-08-26 21:05:19">2024-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Algorithm/odriverSVM/" title="odriver 之 SVM"><img src="https://api.btstu.cn/sjbz/api.php?8519" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="odriver 之 SVM"/></a><div class="content"><a class="title" href="/2024/Algorithm/odriverSVM/" title="odriver 之 SVM">odriver 之 SVM</a><time datetime="2024-08-26T13:05:19.814Z" title="发表于 2024-08-26 21:05:19">2024-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Algorithm/focRelatedAlgorithms/" title="foc 相关算法"><img src="https://api.btstu.cn/sjbz/api.php?1132" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="foc 相关算法"/></a><div class="content"><a class="title" href="/2024/Algorithm/focRelatedAlgorithms/" title="foc 相关算法">foc 相关算法</a><time datetime="2024-08-26T13:05:19.804Z" title="发表于 2024-08-26 21:05:19">2024-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Algorithm/imuAttitudeCalculation/" title="IMU 姿态解算"><img src="https://api.btstu.cn/sjbz/api.php?1761" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IMU 姿态解算"/></a><div class="content"><a class="title" href="/2024/Algorithm/imuAttitudeCalculation/" title="IMU 姿态解算">IMU 姿态解算</a><time datetime="2024-08-26T13:05:19.804Z" title="发表于 2024-08-26 21:05:19">2024-08-26</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            <a class="card-more-btn" href="/categories/" title="查看更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/"><span class="card-category-list-name">Literature Appreciation</span><span class="card-category-list-count">6</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/Poetry/"><span class="card-category-list-name">Poetry</span><span class="card-category-list-count">6</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Note/"><span class="card-category-list-name">Note</span><span class="card-category-list-count">18</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/"><span class="card-category-list-name">Science Thought</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/Math/"><span class="card-category-list-name">Math</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/"><span class="card-category-list-name">Share</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/Tools/"><span class="card-category-list-name">Tools</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Technology-Blog/"><span class="card-category-list-name">Technology Blog</span><span class="card-category-list-count">144</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Robot/" style="font-size: 1.26em; color: #999fa8">Robot</a> <a href="/tags/C/" style="font-size: 1.3em; color: #99a1ac">C++</a> <a href="/tags/IMU/" style="font-size: 1.14em; color: #999b9d">IMU</a> <a href="/tags/Kernel/" style="font-size: 1.48em; color: #99a8bd">Kernel</a> <a href="/tags/ARM64/" style="font-size: 1.1em; color: #999">ARM64</a> <a href="/tags/Design-Patters/" style="font-size: 1.1em; color: #999">Design Patters</a> <a href="/tags/Actuator/" style="font-size: 1.23em; color: #999ea6">Actuator</a> <a href="/tags/Debug/" style="font-size: 1.3em; color: #99a1ac">Debug</a> <a href="/tags/Motor/" style="font-size: 1.21em; color: #999da4">Motor</a> <a href="/tags/Odriver/" style="font-size: 1.14em; color: #999b9d">Odriver</a> <a href="/tags/Linear-Algebra/" style="font-size: 1.17em; color: #999c9f">Linear Algebra</a> <a href="/tags/3A/" style="font-size: 1.14em; color: #999b9d">3A</a> <a href="/tags/ALSA/" style="font-size: 1.26em; color: #999fa8">ALSA</a> <a href="/tags/Links-Libraries/" style="font-size: 1.19em; color: #999da1">Links Libraries</a> <a href="/tags/Sensor/" style="font-size: 1.12em; color: #999a9b">Sensor</a> <a href="/tags/Sync/" style="font-size: 1.17em; color: #999c9f">Sync</a> <a href="/tags/Linux/" style="font-size: 1.5em; color: #99a9bf">Linux</a> <a href="/tags/ucos/" style="font-size: 1.1em; color: #999">ucos</a> <a href="/tags/Stabilization/" style="font-size: 1.23em; color: #999ea6">Stabilization</a> <a href="/tags/Lens/" style="font-size: 1.17em; color: #999c9f">Lens</a> <a href="/tags/Image/" style="font-size: 1.43em; color: #99a6b9">Image</a> <a href="/tags/Note/" style="font-size: 1.39em; color: #99a5b4">Note</a> <a href="/tags/Math/" style="font-size: 1.17em; color: #999c9f">Math</a> <a href="/tags/Interrupt/" style="font-size: 1.23em; color: #999ea6">Interrupt</a> <a href="/tags/UAC/" style="font-size: 1.28em; color: #99a0aa">UAC</a> <a href="/tags/Memory/" style="font-size: 1.32em; color: #99a2ae">Memory</a> <a href="/tags/Tools/" style="font-size: 1.17em; color: #999c9f">Tools</a> <a href="/tags/FOC/" style="font-size: 1.14em; color: #999b9d">FOC</a> <a href="/tags/Performance/" style="font-size: 1.1em; color: #999">Performance</a> <a href="/tags/Driver/" style="font-size: 1.41em; color: #99a5b7">Driver</a> <a href="/tags/ISP/" style="font-size: 1.37em; color: #99a4b2">ISP</a> <a href="/tags/FileSystem/" style="font-size: 1.17em; color: #999c9f">FileSystem</a> <a href="/tags/EIS/" style="font-size: 1.12em; color: #999a9b">EIS</a> <a href="/tags/TEE/" style="font-size: 1.19em; color: #999da1">TEE</a> <a href="/tags/Task/" style="font-size: 1.23em; color: #999ea6">Task</a> <a href="/tags/Audio/" style="font-size: 1.26em; color: #999fa8">Audio</a> <a href="/tags/Programming/" style="font-size: 1.46em; color: #99a7bb">Programming</a> <a href="/tags/Poetry/" style="font-size: 1.21em; color: #999da4">Poetry</a> <a href="/tags/Refactor/" style="font-size: 1.14em; color: #999b9d">Refactor</a> <a href="/tags/USB/" style="font-size: 1.34em; color: #99a3b0">USB</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><span class="card-archive-list-count">13</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><span class="card-archive-list-count">6</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">176</div></div><div class="webinfo-item"><div class="item-name">已运行时间 :</div><div class="item-count" id="runtimeshow" data-publishDate="2018-08-06T16:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2024-08-26T14:27:56.102Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By CarlyleLiu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js@2.1.0/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  if (true) {
    typedJSFn.init(["自小刺头深草里 &#44; 而今渐觉出蓬蒿","时人不识凌云木 &#44; 直待凌云始道高"])
  } else {
    document.getElementById("subtitle").textContent = "自小刺头深草里 &#44; 而今渐觉出蓬蒿"
  }
}
typedJSFn.run(subtitleType)</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
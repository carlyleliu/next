<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Matrix - CarlyleLiu‘s Blog</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CarlyleLiu’s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://carlyleliu.vip/page/3/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="CarlyleLiu’s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Matrix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://carlyleliu.vip/page/3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Matrix',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-08-26 21:52:24'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Matrix</h1><div id="site-subtitle"><span id="subtitle"></span></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2024/LinuxDriver/LinuxAudioALSAVCardLatency/" title="Linux 驱动之 ALSA（九）虚拟声卡 Latency"><img class="post-bg" src="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture?2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（九）虚拟声卡 Latency"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAVCardLatency/" title="Linux 驱动之 ALSA（九）虚拟声卡 Latency">Linux 驱动之 ALSA（九）虚拟声卡 Latency</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-28T14:42:52.000Z" title="发表于 2024-02-28 22:42:52">2024-02-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">测试方法

两块板子之间通过 I2S 通信，其中一块板子配置为 Slave 另一块板子为 Master
Master 板端执行 arecord | aplay 或者 gstream 命令 12arecord -Dhw:2,0 -r 44100 -c 8 -f S32_LE | aplay -Dhw:2,0 -c 8 -r 44100 -f S32_LEgst-launch-1.0 alsasrc device=device_input_split ! alsasink device=device_output sync=false
Slave 通过 aplay 播放一段 wav 文件
通过示波器抓取 Master 板的 I2S 输入和输出端的波形间隔来测量虚拟声卡的 Latency


DataStream

上图就是 arecord | aplay（没有使用插件） 整个虚拟声卡的数据流，其中延迟最大的部分就是红色框中的缓存。
走 USB 通路的 latency： 
增大 Buffer Size 为什么会增大 latency？
aplay 通过调用 snd_pcm_write 写数据给 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/LinuxKernel/LinuxKernelDebugVM/" title="Linux 内核调试（三）VM 参数调试"><img class="post-bg" src="http://pic.tsmp4.net/api/yingshi/img.php?2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 内核调试（三）VM 参数调试"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxKernel/LinuxKernelDebugVM/" title="Linux 内核调试（三）VM 参数调试">Linux 内核调试（三）VM 参数调试</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-27T14:38:04.000Z" title="发表于 2024-02-27 22:38:04">2024-02-27</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Linux/Kernel/">Kernel</a></span></div><div class="content">vm 参数说明
Currently, these files are in /proc/sys/vm: 


admin_reserve_kbytes：系统中应为用户保留的可用内存量。
默认 (3% of free pages, 8MB)。这应该足以让 admin 登录并终止进程。这个值的设置，最好保证系统足够运行 sshd or login + bash (or some other shell) + top (or ps, kill, etc.)
block_dump：当设置为非零值时，block_dump 启用块 I/O 调试。
compact_memory：压缩内存。
仅当设置 CONFIG_COMPACTION 时可用。 当写入 1 时，所有区域都会被压缩，以便可以更好的提供连续内存。 这在分配大页面时可能很重要，尽管进程也会根据需要直接压缩内存。
compact_unevictable_allowed：压缩时检查 lru。
dirty_background_bytes：如果 dirty 页大于这个值，内核后台线程开始工作，将 dirty 内存写回到 flash。
dirty ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/LinuxDriver/LinuxAudioALSAPlugin/" title="Linux 驱动之 ALSA（八）Alsa Plugin"><img class="post-bg" src="http://pic.tsmp4.net/api/fengjing/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（八）Alsa Plugin"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAPlugin/" title="Linux 驱动之 ALSA（八）Alsa Plugin">Linux 驱动之 ALSA（八）Alsa Plugin</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-26T14:42:52.000Z" title="发表于 2024-02-26 22:42:52">2024-02-26</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">PCM (digital audio) plugins
PCM plugins extends functionality and features of PCM devices. The plugins take care about various sample conversions, sample copying among channels and so on.

Plugin: hw
This plugin communicates directly with the ALSA kernel driver. It is a raw communication without any conversions. The emulation of mmap access can be optionally enabled, but expect worse latency in the case.
The nonblock option specifies whether the device is opened in a non-blocking manner. Note th ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/LinuxDriver/LinuxAudioALSACreateSoundCard/" title="Linux 驱动之 ALSA（六）声卡创建流程"><img class="post-bg" src="http://pic.tsmp4.net/api/nvsheng/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（六）声卡创建流程"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSACreateSoundCard/" title="Linux 驱动之 ALSA（六）声卡创建流程">Linux 驱动之 ALSA（六）声卡创建流程</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-17T04:42:52.000Z" title="发表于 2024-02-17 12:42:52">2024-02-17</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">数据结构
原图 


snd_card: 是最顶层数据结构，通过链表挂载该 sound card 的所有设备 snd_device。
snd_pcm: 挂在 snd_card 下面的一个 snd_device。
snd_pcm_str: 代表 playback stream 和 capture stream。
snd_pcm_substream: 是 pcm 中间层的核心，绝大部分任务都是在 substream 中处理，尤其是他的 ops（snd_pcm_ops）字段，许多 user 空间的应用程序通过 alsa-lib 对驱动程序的请求都是由该结构中的函数处理。它的 runtime 字段则指向 snd_pcm_runtime 结构，snd_pcm_runtime 记录这 substream 的一些重要的软件和硬件运行环境和参数。
snd_pcm_ops: 创建声卡需要提供的回调。
snd_pcm_runtime: 运行时参数，包括 sample rate、channel、format 等参数，以及 buffer 相关信息。
snd_pcm_harward: 硬件相关参数，创建声卡需要 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/LinuxDriver/LinuxAudioALSAXRUN/" title="Linux 驱动之 ALSA（七）XRUN"><img class="post-bg" src="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（七）XRUN"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAXRUN/" title="Linux 驱动之 ALSA（七）XRUN">Linux 驱动之 ALSA（七）XRUN</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-17T04:42:52.000Z" title="发表于 2024-02-17 12:42:52">2024-02-17</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">XRUN 是缓冲区不足或溢出，X 代表不足或溢出。在这两种情况下，都表明系统速度不够快，未能及时处理来自 ALSA 音频缓冲区的数据，因此丢失了一些数据。当我们以非常小的缓冲区大小运行时，声卡应该非常快地处理传入缓冲区的数据，否则就溢出 overrun 了。有些芯片无法适应较小的缓冲区大小，因此我们必须增加缓冲区长度以减轻声音芯片的工作量。通常，xruns 可以听到爆裂声或爆裂声。


在录音例子中，如果应用程序读取数据不够快，循环缓存区将会被新的数据覆盖。这种数据的丢失被称为"over run" 在回放例子中，如果应用程序写入数据到缓存区中的速度不够快，缓存区将会"饿死"。这样的错误被称为"under run"

/Proc
ALSA 提供了一种通过 proc 记录和调试 xrun 的方法：
123Device Drivers  ---&gt;  &lt;*&gt; Sound card support  ---&gt;  &lt;*&gt;   Advanced Linux Sound Architecture  ---&gt; [*]   Sound Proc FS Suppor ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/LinuxDriver/LinuxAudioALSAMachineDriver/" title="Linux 驱动之 ALSA（五）Machine 驱动"><img class="post-bg" src="http://pic.tsmp4.net/api/nvsheng/img.php?2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（五）Machine 驱动"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAMachineDriver/" title="Linux 驱动之 ALSA（五）Machine 驱动">Linux 驱动之 ALSA（五）Machine 驱动</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-02-06T04:42:52.000Z" title="发表于 2024-02-06 12:42:52">2024-02-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">ASoC 架构的设计方式是平台和编解码器类驱动程序必须绑定在一起才能构建音频设备。这种绑定可以在所谓的机器驱动程序或设备树中完成，每一个机器驱动程序和设备树都是与特定机器相关的。也就是说，机器驱动程序针对特定系统，并且不同的板卡需要不同的机器驱动程序。

Machine 驱动程序开发流程
一般来说，机器驱动程序的职责包括以下内容

使用适当的 CPU 和编解码器 DAI 填充 struct snd_soc_dai_link 结构体
物理编解码器时钟设置（如果有的话）和编解码器初始化主/从配置（如果有的话）
定义 DAPM widget 以路由物理编解码器内部并根据需要完成 DAPM 路径
根据需要将运行时采样频率传播到各个编解码器驱动程序

鉴于此，机器类驱动程序的开发可执行以下流程。

编解码器驱动程序注册组件驱动程序、DAI 驱动程序以及它们的操作函数
平台驱动程序注册组件驱动程序、PCM 驱动程序、CPU DAI 驱动程序和它们的操作函数，并根据需要设置回放和采集操作
机器层在编解码器和 CPU 之间创建 DAI 链接并注册声卡和 PCM 设备

现在我们已经了解了机器类驱动程序 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/LinuxDriver/LinuxAudioALSAPlatformDriver/" title="Linux 驱动之 ALSA（四）Platform 驱动"><img class="post-bg" src="http://pic.tsmp4.net/api/yingshi/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（四）Platform 驱动"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAPlatformDriver/" title="Linux 驱动之 ALSA（四）Platform 驱动">Linux 驱动之 ALSA（四）Platform 驱动</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-01-26T14:42:52.000Z" title="发表于 2024-01-26 22:42:52">2024-01-26</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">平台驱动程序可以注册 PCM 驱动程序、CPU DAI 驱动程序及其操作函数，为 PCM 组件预分配缓冲区，并根据需要设置回放和采集操作。换言之，平台驱动程序包含该平台的音频引擎和音频接口驱动程序（如 I2S、AC97 和 PCM）。
平台驱动程序以构成平台的 SoC 为目标。它涉及平台的 DMA（即音频数据在 SoC 中的每个块之间如何传输）和 CPU DAI（即 CPU 向编解码器发送音频数据的路径或 CPU 从编解码器获得音频数据的路径）。
平台驱动程序有两个重要的数据结构体：structsnd_soc_component_driver 和 structsnd_soc_dai_driver。前者负责 DMA 数据管理，后者负责 DAI 的参数配置。当然，前文在讨论编解码器类驱动程序时已经描述过这两种数据结构体，因此，本节将仅介绍与平台代码相关的附加概念。

CPU DAI 驱动程序
在平台侧，大部分工作都可以由 core 完成，尤其是与 DMA 相关的工作。因此，CPU DAI 驱动程序通常只提供组件驱动程序结构中的接口名称，而让 core 完成其余的工作。以下是 STM SPD ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/LinuxDriver/LinuxAudioALSAEncClassInstance/" title="Linux 驱动之 ALSA（三）编解码器类驱动实例"><img class="post-bg" src="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（三）编解码器类驱动实例"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAEncClassInstance/" title="Linux 驱动之 ALSA（三）编解码器类驱动实例">Linux 驱动之 ALSA（三）编解码器类驱动实例</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-01-16T14:42:52.000Z" title="发表于 2024-01-16 22:42:52">2024-01-16</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">这里以 Wolfson 公司的编解码芯片 WM8960 为例来说明上篇介绍的相关内容。 


定义 widget 所需的 DAPM Kcontrol
1234567891011121314static const struct snd_kcontrol_new wm8960_loutput_mixer[] = {    SOC_DAPM_SINGLE("PCM Playback Switch", WM8960_LOUTMIX, 8, 1, 0),    SOC_DAPM_SINGLE("LINPUT3 Switch", WM8960_LOUTMIX, 7, 1, 0),    SOC_DAPM_SINGLE("Boost Bypass Switch", WM8960_BYPASS1, 7, 1, 0),};static const struct snd_kcontrol_new wm8960_routput_mixer[] = {    SOC_DAPM_SINGLE("PCM Playback Switch", WM8960_ROUTMIX, 8, 1, 0),    SOC_DAP ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/LinuxDriver/LinuxAudioALSAEncClass/" title="Linux 驱动之 ALSA（二）编解码器类驱动相关概念"><img class="post-bg" src="http://pic.tsmp4.net/api/yingshi/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（二）编解码器类驱动相关概念"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSAEncClass/" title="Linux 驱动之 ALSA（二）编解码器类驱动相关概念">Linux 驱动之 ALSA（二）编解码器类驱动相关概念</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-01-15T22:42:52.000Z" title="发表于 2024-01-16 06:42:52">2024-01-16</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">编解码器类驱动程序是最基本的，他实现的代码应该利用编解码器设备并公开其硬件属性，以便 amixer 等用户空间工具可以使用它。
由于驱动程序针对特定的编解码器，因此它应该包含音频控制、音频接口功能、编解码器 DAPM 定义和 I/O 功能，每个编解码器必须满足：

通过定义 DAI 和 PCM 配置来提供与其他模块的接口
提供编解码器控制 I/O hook（使用 I2C、SPI 的 API）
根据用户空间的需要，公开其他内核控件（Kernel control，Kcontrol）以动态控制模块行为
定义 DAPM widget，为动态电源切换建立 DAPM 路由，并提供 DAC 数字静音控制（option）


Component
包含编解码器的路由、widget、控件金额一组编解码器相关函数回调指针，以及一个或多个 dai 驱动。
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/LinuxDriver/LinuxAudioALSASummer/" title="Linux 驱动之 ALSA（一）概述"><img class="post-bg" src="http://pic.tsmp4.net/api/yingshi/img.php?3" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 驱动之 ALSA（一）概述"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/LinuxDriver/LinuxAudioALSASummer/" title="Linux 驱动之 ALSA（一）概述">Linux 驱动之 ALSA（一）概述</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-01-05T22:42:52.000Z" title="发表于 2024-01-06 06:42:52">2024-01-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Technology-Blog/Audio/">Audio</a></span></div><div class="content">ASOC
ALSA 是为桌面计算机而设计的，没有考虑嵌入式设备的限制，在处理嵌入式设备时会产生很多问题，包括但不限于如下：

编解码器和 CPU 之间的耦合太强，导致代码移植困难。
没有处理用户音频相关行为通知的标准方法，在移动场景中，用户的相关音频操作很频繁。
在最初的 ALSA 设置中没有考虑 PM 机制。

ASOC 就是为了解决以上问题而产生的。ALSA（ALSA system on chip， ASOC）层的目的是为嵌入式处理器和各种编解码器提供更好的 ALSA 支持。ASOC 具有以下优势：

独立的编解码器驱动程序。
更方便的配置 CPU 和编解码器动态音频电源管理（dynamic audio power management， DAPM）之间的音频数据接口。
减少弹出和点击操作，并增加与平台相关的控件。


为了实现上述功能，ASoC 将嵌入式音频系统划分为 3 个可重用的组件驱动程序，即机器类（machine class）、平台类（platform class）和编解码器类（codec）。其中，平台类和编解码器类是跨平台（cross-platform）的，而机器类是板 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/#content-inner">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/#content-inner">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/#content-inner">18</a><a class="extend next" rel="next" href="/page/4/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiu’s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/carlyleliu"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm"><img src="http://pic.tsmp4.net/api/nvsheng/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Encryption Algorithm"/></a><div class="content"><a class="title" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm">Encryption Algorithm</a><time datetime="2024-08-23T12:22:04.000Z" title="发表于 2024-08-23 20:22:04">2024-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/SecureBoot/" title="Secure Boot"><img src="http://pic.tsmp4.net/api/fengjing/img.php?2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Secure Boot"/></a><div class="content"><a class="title" href="/2024/Embedded/SecureBoot/" title="Secure Boot">Secure Boot</a><time datetime="2024-08-19T02:22:04.000Z" title="发表于 2024-08-19 10:22:04">2024-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程"><img src="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture?2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 软件交互流程"/></a><div class="content"><a class="title" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程">TEE 软件交互流程</a><time datetime="2024-08-17T02:22:04.000Z" title="发表于 2024-08-17 10:22:04">2024-08-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/RPMB/" title="RPMB 简介"><img src="http://pic.tsmp4.net/api/yingshi/img.php?1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RPMB 简介"/></a><div class="content"><a class="title" href="/2024/Embedded/RPMB/" title="RPMB 简介">RPMB 简介</a><time datetime="2024-08-15T02:22:04.000Z" title="发表于 2024-08-15 10:22:04">2024-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理"><img src="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture?3" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 实现原理"/></a><div class="content"><a class="title" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理">TEE 实现原理</a><time datetime="2024-08-14T02:22:04.000Z" title="发表于 2024-08-14 10:22:04">2024-08-14</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            <a class="card-more-btn" href="/categories/" title="查看更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/"><span class="card-category-list-name">Literature Appreciation</span><span class="card-category-list-count">6</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Literature-Appreciation/Poetry/"><span class="card-category-list-name">Poetry</span><span class="card-category-list-count">6</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Note/"><span class="card-category-list-name">Note</span><span class="card-category-list-count">18</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/"><span class="card-category-list-name">Science Thought</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Science-Thought/Math/"><span class="card-category-list-name">Math</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/"><span class="card-category-list-name">Share</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Share/Tools/"><span class="card-category-list-name">Tools</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Technology-Blog/"><span class="card-category-list-name">Technology Blog</span><span class="card-category-list-count">144</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Sensor/" style="font-size: 1.12em; color: #999a9b">Sensor</a> <a href="/tags/Poetry/" style="font-size: 1.21em; color: #999da4">Poetry</a> <a href="/tags/Driver/" style="font-size: 1.41em; color: #99a5b7">Driver</a> <a href="/tags/Stabilization/" style="font-size: 1.23em; color: #999ea6">Stabilization</a> <a href="/tags/TEE/" style="font-size: 1.19em; color: #999da1">TEE</a> <a href="/tags/Refactor/" style="font-size: 1.14em; color: #999b9d">Refactor</a> <a href="/tags/Linear-Algebra/" style="font-size: 1.17em; color: #999c9f">Linear Algebra</a> <a href="/tags/Actuator/" style="font-size: 1.23em; color: #999ea6">Actuator</a> <a href="/tags/Performance/" style="font-size: 1.1em; color: #999">Performance</a> <a href="/tags/Kernel/" style="font-size: 1.48em; color: #99a8bd">Kernel</a> <a href="/tags/ARM64/" style="font-size: 1.1em; color: #999">ARM64</a> <a href="/tags/Motor/" style="font-size: 1.21em; color: #999da4">Motor</a> <a href="/tags/ucos/" style="font-size: 1.1em; color: #999">ucos</a> <a href="/tags/Design-Patters/" style="font-size: 1.1em; color: #999">Design Patters</a> <a href="/tags/ALSA/" style="font-size: 1.26em; color: #999fa8">ALSA</a> <a href="/tags/FOC/" style="font-size: 1.14em; color: #999b9d">FOC</a> <a href="/tags/Robot/" style="font-size: 1.26em; color: #999fa8">Robot</a> <a href="/tags/Memory/" style="font-size: 1.32em; color: #99a2ae">Memory</a> <a href="/tags/Sync/" style="font-size: 1.17em; color: #999c9f">Sync</a> <a href="/tags/EIS/" style="font-size: 1.12em; color: #999a9b">EIS</a> <a href="/tags/Task/" style="font-size: 1.23em; color: #999ea6">Task</a> <a href="/tags/Lens/" style="font-size: 1.17em; color: #999c9f">Lens</a> <a href="/tags/USB/" style="font-size: 1.34em; color: #99a3b0">USB</a> <a href="/tags/Linux/" style="font-size: 1.5em; color: #99a9bf">Linux</a> <a href="/tags/Interrupt/" style="font-size: 1.23em; color: #999ea6">Interrupt</a> <a href="/tags/IMU/" style="font-size: 1.14em; color: #999b9d">IMU</a> <a href="/tags/UAC/" style="font-size: 1.28em; color: #99a0aa">UAC</a> <a href="/tags/Note/" style="font-size: 1.39em; color: #99a5b4">Note</a> <a href="/tags/Math/" style="font-size: 1.17em; color: #999c9f">Math</a> <a href="/tags/Links-Libraries/" style="font-size: 1.19em; color: #999da1">Links Libraries</a> <a href="/tags/ISP/" style="font-size: 1.37em; color: #99a4b2">ISP</a> <a href="/tags/Tools/" style="font-size: 1.17em; color: #999c9f">Tools</a> <a href="/tags/Debug/" style="font-size: 1.3em; color: #99a1ac">Debug</a> <a href="/tags/C/" style="font-size: 1.3em; color: #99a1ac">C++</a> <a href="/tags/Programming/" style="font-size: 1.46em; color: #99a7bb">Programming</a> <a href="/tags/3A/" style="font-size: 1.14em; color: #999b9d">3A</a> <a href="/tags/Image/" style="font-size: 1.43em; color: #99a6b9">Image</a> <a href="/tags/FileSystem/" style="font-size: 1.17em; color: #999c9f">FileSystem</a> <a href="/tags/RTOS/" style="font-size: 1.12em; color: #999a9b">RTOS</a> <a href="/tags/Audio/" style="font-size: 1.26em; color: #999fa8">Audio</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><span class="card-archive-list-count">6</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">176</div></div><div class="webinfo-item"><div class="item-name">已运行时间 :</div><div class="item-count" id="runtimeshow" data-publishDate="2018-08-06T16:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2024-08-26T13:52:23.703Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By CarlyleLiu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js@2.1.0/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  if (true) {
    typedJSFn.init(["自小刺头深草里 &#44; 而今渐觉出蓬蒿","时人不识凌云木 &#44; 直待凌云始道高"])
  } else {
    document.getElementById("subtitle").textContent = "自小刺头深草里 &#44; 而今渐觉出蓬蒿"
  }
}
typedJSFn.run(subtitleType)</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
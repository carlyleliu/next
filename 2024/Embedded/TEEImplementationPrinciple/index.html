<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>TEE 实现原理 | Matrix</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TrustZone  如何区分当前访问状态是安全状态下的访问还是非安全状态下的访问？ CPU发出的地址都是虚拟地址，需要经过页表转换才能得到物理地址，其中在pte页表中低12bit（针对4k大小的页表）为控制位，用来控制页表的访问属性，也就是说在页表建立的时候就确定了访问状态是安全状态还是非安全状态，其pte低12bit如下：">
<meta property="og:type" content="article">
<meta property="og:title" content="TEE 实现原理">
<meta property="og:url" content="http://carlyleliu.vip/2024/Embedded/TEEImplementationPrinciple/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="TrustZone  如何区分当前访问状态是安全状态下的访问还是非安全状态下的访问？ CPU发出的地址都是虚拟地址，需要经过页表转换才能得到物理地址，其中在pte页表中低12bit（针对4k大小的页表）为控制位，用来控制页表的访问属性，也就是说在页表建立的时候就确定了访问状态是安全状态还是非安全状态，其pte低12bit如下：">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-08-14T02:22:04.000Z">
<meta property="article:modified_time" content="2024-08-28T17:08:46.306Z">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="TEE">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://carlyleliu.vip/2024/Embedded/TEEImplementationPrinciple/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TEE 实现原理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-29 01:08:46'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TEE 实现原理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-14T02:22:04.000Z" title="发表于 2024-08-14 10:22:04">2024-08-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-28T17:08:46.306Z" title="更新于 2024-08-29 01:08:46">2024-08-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/TEE/">TEE</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TEE 实现原理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="trustzone">TrustZone</h1>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee1.png"></p>
<h2 id="如何区分当前访问状态是安全状态下的访问还是非安全状态下的访问">如何区分当前访问状态是安全状态下的访问还是非安全状态下的访问？</h2>
<p>CPU发出的地址都是虚拟地址，需要经过页表转换才能得到物理地址，其中在pte页表中低12bit（针对4k大小的页表）为控制位，用来控制页表的访问属性，也就是说在页表建立的时候就确定了访问状态是安全状态还是非安全状态，其pte低12bit如下：</p>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee2.png"></p>
<span id="more"></span>
<p>这里的bit 5 NS bit（Non-secure bit）：用来指定访问的内存地址是安全映射的还是非安全映射的。</p>
<p>只有当ARM核处于安全状态（NS bit=0）时发送到系统总线（AXI）上的读写操作才会被识别为安全读写操作，对应TEE侧的数据资源才能被访问。反之，当ARM核处于非安全状态（NS bit=1）时，ARM核发送到系统总线上的读写操作请求会被作为非安全读写操作，<strong>安全组件会根据对资源的访问权限配置来决定是否响应该访问请求</strong>。</p>
<p>💡 NS bit的设置是通过SMC指令触发异常进入EL3安全监视器中设置的，即Normal World通过SMC调用进入Security World，将NS bit置0，Security World通过SMC指令进入Normal World，安全监视器将NS bit置1</p>
<h2 id="如何划分安全区域和非安全区域以及如何拦截非安全状态下的安全地址访问">如何划分安全区域和非安全区域以及如何拦截非安全状态下的安全地址访问？</h2>
<h3 id="ddrtzasc">DDR（TZASC）：</h3>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee3.png"></p>
<p>TrustZone地址空间控制组件（TrustZone Address Space Controller，TZASC）是AXI总线上的一个主设备，<strong>TZASC能够将从设备全部的地址空间分割成一系列的不同地址范围</strong>。在安全状态下， 通过编程TZASC能够将这一系列分割后的地址区域设定成安全空间或者是非安全空间。被配置成安全属性的区域将会拒绝非安全的访问请求。</p>
<p>使用TZASC主要是将一个AXI从设备分割成几个安全设备，例如off-Soc、DRAM等。ARM的动态内存控制器（Dynamic Memory Controller，DMC） 并不支持安全和非安全分区的功能。如果将DMC接到TZASC上，就能实现DRAM支持安全区域和非安全区域访问的功能。需要注意的是，<strong>TZASC组件只支持存储映射设备对安全和非安全区域的划分与扩展</strong>，但不支持对块设备（如EMMC、NAND flash 等）的安全和非安全区域的划分与扩展</p>
<p>一个完整的系统必然会有片外RAM，对片外 RAM的隔离是通过TZASC组件实现的，ARM本身的DMC可以将DRAM分割成不同的区域，这些区域是没有安全和非安全分类。将DMC与TZASC相连 后再挂到总线上，通过对TZASC组件进行编程可以将DRAM划分成安全区域和非安全区域。当主设备 访问DRAM时，除需要提供物理地址之外，还会发送PROT信号。TZASC组件首先会判定主设备需要访问的DARM地址是属于安全区域还是非安全区域，然后再结合接收到的PROT信号来判定该次访问是否有效。如果PROT信号为非安全访问操作， 且访问的DRAM地址属于安全区域，则TZASC就不会响应这次访问操作，这样就能实现DRAM中安全区域和非安全区域的隔离。</p>
<h3 id="sram和romtzma">SRAM和ROM（TZMA）：</h3>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee4.png"></p>
<p>TrustZone内存适配器组件（TrustZone Memory Adapter，TZMA）允许对片上静态内存（on-SoC Static Memory）或者片上ROM进行安全区域和非安全区域的划分（仅有安全访问可以配置TZASC的寄存器）。TZMA支持最大2MB空间的片上静态RAM的划分，可以将2MB空间划分成两个部 分，高地址部分为非安全区域，低地址部分为安全区域，两个区域必须按照4KB进行对齐。分区的具体大小通过TZMA的输入信号R0SIZE来控制，该信号来自TZPC的输出信号TZPCR0SIZE。即通过编程TZPC可以动态地配置片上静态RAM或者ROM的大小。</p>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee5.png"></p>
<h3 id="外设地址apb-to-axi桥">外设地址（APB-to-AXI桥）：</h3>
<p>TrustZone同样能够保护外围设备的安全，例如：中断控制、时钟、I/O设备，因此Trust-Zone架构还 能用来解决更加广泛的安全问题。比如一个安全中断控制器和安全时钟允许一个非中断的安全任务来监控系统，能够为DRM提供可靠的时钟，能够为用户提供一个安全的输入设备从而保证用户密码数据不会被恶意软件窃取。</p>
<p>AMBA3规范包含了一个低门数、低带宽的外设总线，被称作外设总线（Advanced Peripheral Bus，APB），APB通过AXI-to-APB桥连接到系统总线上。而APB总线并不具有安全状态位，<strong>为实现 APB外设与TrustZone技术相兼容，APB-to-AXI桥将负责管理APB总线上设备的安全</strong>。APB-to-AXI桥会拒绝不匹配的安全事务设置，并且不会将该事务请求发送给外设。</p>
<p>TrustZone保护控制器组件（TrustZone Protection Controller，TZPC）是用来设定 TZPC DECPORT信号和TZPC R0SIZE等相关控制信号的。<strong>这些信号用来告知APB-to-AXI对应的外设是安全设备还是非安全设备，而TZPCR0SIZE信号用来控制TZMA对片上RAM或片上ROM安全区域大小的划分</strong>。</p>
<p>TZPC包含三组通用寄存器 TZPCDECPROT[2：0]，每组通用寄存器可以产生8 种TZPCDECPROT信号，也就是TZPC最多可以将 24个外设设定成安全外设。TZPC组件还包含一个TZPCROSIZE寄存器，该寄存器用来为TZMA提供分区大小信息。TZPC组件的接口示意如图所示</p>
<h2 id="axi-访问流程">AXI 访问流程</h2>
<p>cpu发出了虚拟地址访问，这个地址要经过AXI总线到达外设地址，但是这个地址访问仍然是没有安全状态的，<strong>TZASC或者TZMA或者APB-to-AXI桥</strong>是如何判断访问级别的呢？</p>
<p>TrustZone技术通过对总线进行扩展增加安全位读写信号线来实现。除了对总线进行扩展还需要对MMU、Cache、TLB以及其他组件进行扩展都是增加了安全bit。</p>
<p><strong>AXI总线上安全状态位的扩展</strong></p>
<p>AXI写数据的过程如下图所示： <img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee6.png"></p>
<p>地址通道携带描述被传输数据性质的控制信息。</p>
<p>读数据的过程如下图所示： <img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee7.png"></p>
<p>每一个通道都拥有自己的VALID与READY信号用于实现握手，其中VALID信号表示通道的地址、数据或控制信息已经可用，而READY信号则表示接收方已准备好接收信息。</p>
<p><strong>AXI信号描述</strong></p>
<p>写地址通道信号：</p>
<table>
<thead>
<tr class="header">
<th>信号名</th>
<th>来源</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AWID</td>
<td>主设备</td>
<td>写地址ID，该信号用于标识写地址组</td>
</tr>
<tr class="even">
<td>AWADDR</td>
<td>主设备</td>
<td>写地址，写突发操作中第一次数据传输的地址</td>
</tr>
<tr class="odd">
<td>AWLEN</td>
<td>主设备</td>
<td>突发长度，这个字段标识每次突发传输的传输次数</td>
</tr>
<tr class="even">
<td>AWSIZE</td>
<td>主设备</td>
<td>突发大小，这个字段表示每次突发传输的大小</td>
</tr>
<tr class="odd">
<td>AWBURST</td>
<td>主设备</td>
<td>突发类型，包括突发类型和突发大小信息，该字段决定了每次突发传输时地址的计算方法</td>
</tr>
<tr class="even">
<td>AWLOCK</td>
<td>主设备</td>
<td>锁定类型，提供关于传输时原子特性的额外信息</td>
</tr>
<tr class="odd">
<td>AWCACHE</td>
<td>主设备</td>
<td>存储器类型</td>
</tr>
<tr class="even">
<td>AWPROT</td>
<td>主设备</td>
<td>保护类型</td>
</tr>
<tr class="odd">
<td>AWQOS</td>
<td>主设备</td>
<td>服务质量，即每次写传输的QoS标识符，仅AXI4支持</td>
</tr>
<tr class="even">
<td>AWREGION</td>
<td>主设备</td>
<td>区域标识符，允许一个从设备的单个物理接口用作多个逻辑接口，仅AXI4支持</td>
</tr>
<tr class="odd">
<td>AWUSER</td>
<td>主设备</td>
<td>用户定义信号，可选</td>
</tr>
<tr class="even">
<td>AWVALID</td>
<td>主设备</td>
<td>主设备给出的地址和相关控制信号有效</td>
</tr>
<tr class="odd">
<td>AWREADY</td>
<td>从设备</td>
<td>从设备已准备好接收地址和相关的控制信号</td>
</tr>
</tbody>
</table>
<p><strong>读地址通道信号：</strong></p>
<table>
<thead>
<tr class="header">
<th>信号名</th>
<th>来源</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ARID</td>
<td>主设备</td>
<td>读地址ID，该信号用于标识读地址组</td>
</tr>
<tr class="even">
<td>ARADDR</td>
<td>主设备</td>
<td>读地址，读突发操作中第一次数据传输的地址</td>
</tr>
<tr class="odd">
<td>ARLEN</td>
<td>主设备</td>
<td>突发长度，这个字段标识每次突发传输的传输次数</td>
</tr>
<tr class="even">
<td>ARSIZE</td>
<td>主设备</td>
<td>突发大小，这个字段表示每次突发传输的大小</td>
</tr>
<tr class="odd">
<td>ARBURST</td>
<td>主设备</td>
<td>突发类型，包括突发类型和突发大小信息，该字段决定了每次突发传输时地址的计算方法</td>
</tr>
<tr class="even">
<td>ARLOCK</td>
<td>主设备</td>
<td>锁定类型，提供关于传输时原子特性的额外信息</td>
</tr>
<tr class="odd">
<td>ARCACHE</td>
<td>主设备</td>
<td>存储器类型</td>
</tr>
<tr class="even">
<td>ARPROT</td>
<td>主设备</td>
<td>保护类型</td>
</tr>
<tr class="odd">
<td>ARQOS</td>
<td>主设备</td>
<td>服务质量，即每次读传输的QoS标识符，仅AXI4支持</td>
</tr>
<tr class="even">
<td>ARREGION</td>
<td>主设备</td>
<td>区域标识符，允许一个从设备的单个物理接口用作多个逻辑接口，仅AXI4支持</td>
</tr>
<tr class="odd">
<td>ARUSER</td>
<td>主设备</td>
<td>用户定义信号，可选</td>
</tr>
<tr class="even">
<td>ARVALID</td>
<td>主设备</td>
<td>主设备给出的地址和相关控制信号有效</td>
</tr>
<tr class="odd">
<td>ARREADY</td>
<td>从设备</td>
<td>从设备已准备好接收地址和相关的控制信号</td>
</tr>
</tbody>
</table>
<p>以上只列出了部分<strong>读地址通道信号和写地址通道信号。</strong></p>
<p>而我们关心的是AWPROT和ARPROT信号。</p>
<ul>
<li>ARPROT[2:0]定义了读访问的访问权限。</li>
<li>AWPROT[2:0]定义了写访问的访问权限。</li>
</ul>
<p>其中，信号定义如下：</p>
<table>
<thead>
<tr class="header">
<th>AxPROT</th>
<th>值</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>[0]</td>
<td>0/1</td>
<td>非特权访问/特权访问</td>
</tr>
<tr class="even">
<td>[1]</td>
<td>0/1</td>
<td>安全访问/不安全访问</td>
</tr>
<tr class="odd">
<td>[2]</td>
<td>0/1</td>
<td>数据访问/指令访问</td>
</tr>
</tbody>
</table>
<p>这里又多了一个特权访问和非特权访问？官方手册是这么描述的：</p>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee8.png"></p>
<p>AXI提供特权访问还是非特权访问的信息，但是具体怎么用，看各控制器的设计了。没有查到更多信息，暂时先不管这个特权访问了。</p>
<p>详细可参考： https://www.lzrnote.cn/2021/10/08/axi总线总结/</p>
<p>http://www.gstitt.ece.ufl.edu/courses/fall15/eel4720_5721/labs/refs/AXI4_specification.pdf</p>
<h1 id="atfarm-trusted-firmware">ATF（ARM Trusted Firmware）</h1>
<p>该固件统一了ARM底层接口标准，如电源状态控制接口（Power Status Control Interface，PSCI）、安全启 动需求（Trusted Board Boot Requirements， TBBR）、安全世界状态（SWS）与正常世界状态 （NWS）切换的安全监控模式调用（secure monitor call，smc）操作等。ATF旨在将ARM底层的操作统一使代码能够重用和便于移植。</p>
<h2 id="atf启动流程">ATF启动流程：</h2>
<p>ATF的源代码共分为bl1、bl2、bl31、bl32、 bl33部分，其中bl1、bl2、bl31部分属于固定的固件，bl32和bl33分别用于加载TEE OS和REE侧的镜像。整个加载过程可配置成安全启动的方式，每一个镜像文件在被加载之前都会验证镜像文件的电子签名是否合法。 <img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee9.png"></p>
<h2 id="atf主要完成的功能如下">ATF主要完成的功能如下：</h2>
<ul>
<li>初始化安全世界状态运行环境、异常向量、 控制寄存器、中断控制器、配置平台的中断。</li>
<li>初始化ARM通用中断控制器（General Interrupt Controller，GIC）2.0版本和3.0版本的驱动初始化。</li>
<li>执行ARM系统IP的标准初始化操作以及安全扩展组件的基本配置。</li>
<li>安全监控模式调用（Secure Monitor Call， SMC）请求的逻辑处理代码（Monitor模式/EL3）。</li>
<li>实现可信板级引导功能，对引导过程中加载的镜像文件进行电子签名检查。</li>
<li>支持自有固件的引导，开发者可根据具体需求将自有固件添加到ATF的引导流程中。</li>
</ul>
<p>Trusted Firmware提供了满足ARM安全规格的参考代码，包括TBBR(Trusted Board&nbsp; Boot Requirements)和SMCC。 <img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee10.png"></p>
<p>SMC Dispatcher：处理非安全世界的SMC请求，决定哪些SMC由Trusted Firmware在EL3处理，哪些转发给TEE进行处理。</p>
<p>Trusted Firmware处理PSCI任务、或者SOC相关工作。一个典型的基于TrustZone系统软件调用栈关系图：</p>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee11.png"></p>
<ul>
<li>安全世界的Trusted OS提供一系列安全服务，比如key管理或DRM。非安全世界应用需要使用这些服务，但是又无法直接使用。通过使用一些库中API来获取这些能力，比如libDRM.so。</li>
<li>这些库和Trusted service之间通信往往通过message queue或者Mailbox。他们之间通信所用内存往往被称为WSM(World Shared Memory)。这些内存必须能够被Trusted service和库访问，这就意味着这些内存是非安全内存。</li>
<li>应用通过库发送一个请求到Mailbox或message queue，然后触发内核中TrustZone驱动。</li>
<li>TrustZone驱动负责和TEE部分交互，包括为message queue申请内存和注册这些内存。由于安全和非安全运行在两个虚拟地址空间，所以无法通过虚拟地址进行通信。</li>
<li>TrustZone驱动通过调用SMC进入安全状态，控制权通过EL3的Secure Monitor传递到TEE中的TEEOS。TEEOS从message queue内存中获取内容由Trusted service进行处理。
<ul>
<li><strong>Trusting the message</strong>：由于message是从非安全世界传递的，所以需要安全世界对这些内容进行一些认证。</li>
<li><strong>Scheduling</strong>：对于PSCI类型快速处理并且不频繁请求，进入EL3处理完成后退出到非安全状态。对于一些需要TOS处理的任务，不能被非安全中断打断，避免造成安全服务不可用。</li>
<li><strong>OP-TEE</strong>：OP-TEE内核运行在S.EL1，可信应用运行在S.EL0。</li>
</ul></li>
</ul>
<p><img src="https://lsky.carlyleliu.vip/ImageHosting/TechnologyBlog/TEE/tee12.png"></p>
<h1 id="op-tee">OP-TEE</h1>
<p>OP-TEE 是依靠 Arm TrustZone 技术作为底层硬件隔离机制而实现的一种TEE OS。</p>
<h2 id="tee-os功能">TEE OS功能</h2>
<ul>
<li>进程管理</li>
<li>内存管理</li>
<li>安全存储
<ul>
<li>RPMB File System</li>
<li>REE File System</li>
</ul></li>
<li>加密引擎
<ul>
<li>对称加密（AES，DES）</li>
<li>非对称加密（RSA，ECC）</li>
<li>摘要（MD5，HASH，HMAC）</li>
</ul></li>
<li>软件隔离
<ul>
<li>进程隔离</li>
<li>内存隔离</li>
<li>数据隔离</li>
</ul></li>
<li>真随机数</li>
<li>安全时钟</li>
<li>硬件秘钥及派生</li>
<li>...</li>
</ul>
<h2 id="tee应用">TEE应用</h2>
<ul>
<li>DRM
<ul>
<li>Widevine</li>
<li>PlayReady</li>
<li>Netflix</li>
</ul></li>
<li>CAS
<ul>
<li>Nagra</li>
<li>Verimatrix</li>
<li>Irdeto</li>
<li>NSK</li>
<li>VO</li>
</ul></li>
<li>秘钥烧录</li>
<li>无线显示</li>
<li>生物识别</li>
<li>移动支付</li>
<li>飞控系统</li>
<li>重置保护</li>
<li>...</li>
</ul>
<h1 id="参考文献">参考文献</h1>
<p><a target="_blank" rel="noopener" href="https://github.com/carloscn/blog/blob/master/README.md">https://github.com/carloscn/blog/blob/master/README.md</a><br>
<a target="_blank" rel="noopener" href="https://www.secrss.com/articles/14187">物联网终端应用TEE的一些思考</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/TEE/">TEE</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/Embedded/RPMB/" title="RPMB 简介"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RPMB 简介</div></div></a></div><div class="next-post pull-right"><a href="/2024/Tools/HexoNextUsage/" title="Blog 搭建"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Blog 搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-23</div><div class="title">Encryption Algorithm</div></div></a></div><div><a href="/2024/Embedded/RPMB/" title="RPMB 简介"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-15</div><div class="title">RPMB 简介</div></div></a></div><div><a href="/2024/Embedded/SecureBoot/" title="Secure Boot"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-19</div><div class="title">Secure Boot</div></div></a></div><div><a href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-17</div><div class="title">TEE 软件交互流程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiu’s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">176</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/carlyleliu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#trustzone"><span class="toc-number">1.</span> <span class="toc-text">TrustZone</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86%E5%BD%93%E5%89%8D%E8%AE%BF%E9%97%AE%E7%8A%B6%E6%80%81%E6%98%AF%E5%AE%89%E5%85%A8%E7%8A%B6%E6%80%81%E4%B8%8B%E7%9A%84%E8%AE%BF%E9%97%AE%E8%BF%98%E6%98%AF%E9%9D%9E%E5%AE%89%E5%85%A8%E7%8A%B6%E6%80%81%E4%B8%8B%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="toc-number">1.1.</span> <span class="toc-text">如何区分当前访问状态是安全状态下的访问还是非安全状态下的访问？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%92%E5%88%86%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F%E5%92%8C%E9%9D%9E%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E6%8B%A6%E6%88%AA%E9%9D%9E%E5%AE%89%E5%85%A8%E7%8A%B6%E6%80%81%E4%B8%8B%E7%9A%84%E5%AE%89%E5%85%A8%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.</span> <span class="toc-text">如何划分安全区域和非安全区域以及如何拦截非安全状态下的安全地址访问？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ddrtzasc"><span class="toc-number">1.2.1.</span> <span class="toc-text">DDR（TZASC）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sram%E5%92%8Cromtzma"><span class="toc-number">1.2.2.</span> <span class="toc-text">SRAM和ROM（TZMA）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E8%AE%BE%E5%9C%B0%E5%9D%80apb-to-axi%E6%A1%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">外设地址（APB-to-AXI桥）：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#axi-%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">AXI 访问流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#atfarm-trusted-firmware"><span class="toc-number">2.</span> <span class="toc-text">ATF（ARM Trusted Firmware）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#atf%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">ATF启动流程：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#atf%E4%B8%BB%E8%A6%81%E5%AE%8C%E6%88%90%E7%9A%84%E5%8A%9F%E8%83%BD%E5%A6%82%E4%B8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">ATF主要完成的功能如下：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#op-tee"><span class="toc-number">3.</span> <span class="toc-text">OP-TEE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tee-os%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.</span> <span class="toc-text">TEE OS功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tee%E5%BA%94%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">TEE应用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">4.</span> <span class="toc-text">参考文献</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Encryption Algorithm"/></a><div class="content"><a class="title" href="/2024/Embedded/EncryptionAlgorithm/" title="Encryption Algorithm">Encryption Algorithm</a><time datetime="2024-08-23T12:22:04.000Z" title="发表于 2024-08-23 20:22:04">2024-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/SecureBoot/" title="Secure Boot"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Secure Boot"/></a><div class="content"><a class="title" href="/2024/Embedded/SecureBoot/" title="Secure Boot">Secure Boot</a><time datetime="2024-08-19T02:22:04.000Z" title="发表于 2024-08-19 10:22:04">2024-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 软件交互流程"/></a><div class="content"><a class="title" href="/2024/Embedded/TEESoftPipeLine/" title="TEE 软件交互流程">TEE 软件交互流程</a><time datetime="2024-08-17T02:22:04.000Z" title="发表于 2024-08-17 10:22:04">2024-08-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/RPMB/" title="RPMB 简介"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RPMB 简介"/></a><div class="content"><a class="title" href="/2024/Embedded/RPMB/" title="RPMB 简介">RPMB 简介</a><time datetime="2024-08-15T02:22:04.000Z" title="发表于 2024-08-15 10:22:04">2024-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TEE 实现原理"/></a><div class="content"><a class="title" href="/2024/Embedded/TEEImplementationPrinciple/" title="TEE 实现原理">TEE 实现原理</a><time datetime="2024-08-14T02:22:04.000Z" title="发表于 2024-08-14 10:22:04">2024-08-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By CarlyleLiu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>